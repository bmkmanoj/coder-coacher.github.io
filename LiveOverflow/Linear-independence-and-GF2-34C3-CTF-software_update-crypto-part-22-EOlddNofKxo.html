<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Linear independence and GF(2) - 34C3 CTF software_update (crypto) part 2/2 | Coder Coacher - Coaching Coders</title><meta content="Linear independence and GF(2) - 34C3 CTF software_update (crypto) part 2/2 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/LiveOverflow/">LiveOverflow</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Linear independence and GF(2) - 34C3 CTF software_update (crypto) part 2/2</b></h2><h5 class="post__date">2018-03-16</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/EOlddNofKxo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">we are going to solve a crypto challenge
with some cool math I think it's an
awesome example of linear algebra apply
to some real-world security problems the
story about this challenge is that we
have a firmware update that will only be
applied if verified and works by hashing
files and folders with sha-256 and X
Orange those hashes together the
resulting XOR result is then checked
against a signature if you want to hear
more about how we explore different
attack ideas you can check out part 1
but in this part I just want to focus on
the mathematical solution and try to
provide an intuitive understanding for
the linear algebra involved and I'm also
sorry to all the mathematicians out
there if I butcher some terminology I'm
a math noob
okay so to understand the solution I
have to introduce two concepts one is
about linear independence and how linear
independent vectors in some vector space
can match to any point and the second
concept will be Galois fields or finite
fields specifically the GF to the field
of only two elements if you didn't learn
this kind of math for example in
university or you are still too young
then these terms sound crazy but I want
to mention them because while it sounds
crazy I think it's really easy to
understand once I explained it so let's
start with linear independence of
vectors if you are not familiar with
vectors just ignore the term and just
see how we are using it they are
basically just arrows so imagine a
one-dimensional space so just a line of
numbers and I give you a one-dimensional
vector now a vector is like an arrow so
this vector starts at zero it points to
two with the scalar or just a regular
number we can multiply that vector to
move that arrow around for example two
times the vector will point to four and
four times the vector will point to 8
and minus three times this vector will
point to minus six easy and as you know
multiplication is just fancy addition
four times the vector we just add the
vector to itself four times so you see
that with this one vector we multiply it
with some value we can make it point to
every number in that one dimensional
space now let's look at this in
two-dimensional space just a flat
surface we add another axis now let's
take one vector for example one one now
a vector will have two values x and y
now this is an arrow that points to this
point 1 1 again we can multiply a scalar
or just add subtract this vector many
times and we can move around where
points tool with 2 times this vector we
point to 2 2 with 5 times we point to 5
5 and with -3 times this vector will
point to
- three - three but you see that we
can't add or subtract and reach every
value on our plane we only ever can
reach any point on this line so let's
introduce a second vector three three
now this one points to three three and
again we can add or subtract it we can
even combine our two vectors but we are
still limited to this line you might
also have noticed that we could
basically create this vector by taking
our first vector of three times these
two vectors are linearly dependent but
if we get a vector that is linearly
independent that is not laying on the
same line for example 1 0 now we can't
reach this point with only the first
vector and vice versa the new vector
can't reach a point of the second vector
except of course 0 but we can now use
them together to get any point on this
two-dimensional field for example to
reach the point 3 5 we can take the
first vector 5 times now we are at 5 5
and then we take the second vector and
subtract it 2 times and now we reached
3/5 and so with two independent vectors
we can get to any point of the
two-dimensional field and this also
works with three dimensions if you have
three linear independent vectors in this
three dimensional space you can get to
any point you want by adding or
subtracting them that makes sense right
just think about it for a second and
imagine in your head how you can combine
three different arrows in a three
dimensional space and reach any point in
there and of course it also works in
four or five or higher dimensional space
in four dimensions we need four linear
independent vectors and in five
dimensional space we need five linear
independent vectors and so on of course
you can't really visualize that anymore
but you can just write them down as
vectors and play around with adding and
subtracting them from another to reach
any point you want amazing right but if
you have very large vectors it's a bit
cumbersome by hand
select the vectors you want to add or
subtract to reach certain points that's
where you get into linear algebra you
just put all these vectors as columns
into a matrix here's the point you want
to reach and then you can solve this but
we don't have to do this by hand we can
let the computers do that for us okay so
what the heck does this have to do with
this challenge we get there
patients so now let's introduce the
second concept finite field is already a
fancy sounding name but there's a much
nicer name for it
Galois field that's a nice French name
right okay so when you one at all tell
your girlfriend or your boyfriend or
your mother whoever you want to impress
what you did today in it's the
university you say I learned about
Galois fears okay specifically we want
to have a look at GF Galois field
- it sounds so cool but it's really dumb
but clever basically throw away any
numbers you know and just keep two zero
and one and you live now in a world
where only zero and one exists the
binary world no 2 no 3 only 0 and 1 now
let's think about how addition could
look like in this world zero plus zero
could be zero that makes sense
0 plus 1 could be 1 that makes sense too
so that's 1 plus 0 that's also 1 but 1
plus 1 is a bit weird because in our
world there is nothing larger than 1
and so we are imprisoned in this world
and if we try to leave here to find the
larger number we just wrap around in our
world and arrive at the start again like
the game snake and as a computer
scientist do you notice something what
is this this is X or addition in the
finite field of two elements G of 2 is
equivalent to the logical XOR operation
ding-ding-ding-ding does it ring a bell
so when we XOR for example 2 bytes each
by it has 8 bits 8 ones or zeros for
example hex 55 in ASCII the capital
you it would be 0 1 0 1 0 1 0 1 and if
we XOR that with d9 in binary 1 1 0 1 1
0 0 1 we get 1 0 0 0 1 1 0 0 or hex 8c
so these bytes could also be understood
as a vector it's an 8 dimensional vector
with 8 elements either 0 or 1 they are
vectors in an 8 dimensional GF 2 vector
space each vector has 8 bits and a bit
exists only in a world of 0 or 1 a bit
can never be - it's always 0 or 1 and we
just learned that XOR and GF 2 is like
addition so now we just added two
vectors together and got another point
in that vector space and this means a
sha-256 hash has 256 bits and can be
understood as a 256 dimensional vector
in a Galois field 2 vector space and the
first concept we learned about was that
if we have enough linear independent
vectors we can add or subtract them to
reach any point in that space so if we
had 256 linear independent vectors 256
linear independent shot one of 56 hashes
we could reach any point in the 1256
dimensional space and the point we want
to reach is a 256 bit vector or better
to say the final XOR result of the
hashes that is already valid and signed
so if we can create these 256 linear
independent vectors we should be able to
combine them by addition or as you know
now XOR to Kraft any XOR result that we
want in mathematical terms we just have
to solve this matrix equation of the 256
independent vectors with the vector that
we want any XOR result that we want and
actually that is very simple hashes are
basically random data random bits they
are a random vector and it's very
unlikely that such a random vector is
linear dependent but you can also very
easily test
so let's start by creating 256 linear
independent bit vectors or vectors
operating in GF 2 to do this I'm using
sage which is basically a tool to
perform mathematical calculations sage
scripts are basically patent the code
gets transformed into Python script and
then is executed also as explained in
part 1 I did not come up with this the
solution and the code I show was written
by Ben offs from our CTF team just so
that you don't get the wrong impression
that I am some kind of wizard he is so
we can start with a loop to find these
independent vectors we know how the
hedges are generated by the firmware
installer check out part 1 if you forgot
so we basically we do the same here now
we generate a file name from just
counting numbers and append the knob ID
and then pass it to something that will
return the 256 bit vector for it the
make vector function takes the file name
generates the sha-256 hash and then goes
over each byte of that hash for each
byte it extracts the single bits it does
that by a lookup table of bits that was
generated at the start of the program
long story short that function will just
return the vector with all 12 56 bits of
the hash now that we have the vector
that represents the hash for this file
we can create a matrix of all the
possible vectors defined over the
gallows field to G of 2 and then we can
check the rank of the matrix in linear
algebra the rank of a matrix is the
dimension of the vector space generated
by its columns this corresponds to the
maximum number of linearly independent
columns of the matrix so if the new
vector increases the rank of the matrix
so increases the number of linear
independent columns of the matrix then
we can keep that one and we just
remember all the vectors and found names
that are good and we can also print if a
vector wouldn't be linear independent if
we run that now it takes a moment from
Sage to get going and then we print out
all the file names that produces linear
independent vectors and you can see
after the first one 256 we didn't even
get one that was
linear dependent next we have to define
the point in our 256 dimensional vector
space that we want to reach by combining
our vectors to do that we have to read
the current valid XOR result the one
that is signed and then we do our
modifications of the pre copy Python
script to spawn a shell and then we get
the new invalid XOR result if we XOR
those two we get our target goal if we
can somehow craft this XOR result with
our files basically find which vectors
we have to combine to reach that point
in space then they could be exhorted
with the now invalid XOR result to
produce the valid assigned result and we
take the result now and define a goal
vector and then we can take the matrix
of all our vectors and say that we want
to solve the systems of equations for
the goal vector to the right
basically just solve the matrix equation
and the resulting vector will tell us
which vector we take and not take well
we have a 1 we take it where we have a 0
we don't take it or to be more
mathematical we multiply the first
vector with 1 and add it we multiply the
second vector with 1 and add it and we
take the third vector and multiply it
with 0 and add it and so forth so we can
now loop over this resulting vector and
wherever we have a 1 we print the name
of the file we have to create in order
to craft the corresponding XOR result
and if we do all of that we can create
the new zip update file with all those
chosen files and that would have a
modified pre copy screw but a valid
signature and so we can connect again to
the service and send our modified update
zip it gets unpacked the signal checked
and the pre copy script is executed and
this should have now spawned a shell on
the server that we can use to look
around and in the end read out the flag
boom soft isn't that amazing
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>