<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>The Heap: How do use-after-free exploits work? - bin 0x16 | Coder Coacher - Coaching Coders</title><meta content="The Heap: How do use-after-free exploits work? - bin 0x16 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/LiveOverflow/">LiveOverflow</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>The Heap: How do use-after-free exploits work? - bin 0x16</b></h2><h5 class="post__date">2016-10-28</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ZHghwsTRyzQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">a very common issue that we still
constantly encounter is shown in heap
level two of exploited exercises calm
this is a classic use after free
vulnerability let's try to understand
the code first we have here a big while
loop inside of main in each round it
prints the variable off which is a
pointer to an object of this earth
struck up here and off has the
attributes name which is the string up
to 32 characters and an integer and the
other variable that is printed is a char
pointer service which can point to a
string and memory so both of these are
addresses pointers then we read a line
from standard input maximum 128 bytes so
this is a secure F gets read no buffer
overflow afterwards we have a couple of
ifs that check if the input line is one
of the following commands either auth
reset servers or login let's execute the
program as well and then let's talk
about each command when we first start
the program both the auth and the
service pointer are null
now we wait for input let's have a look
at the auth command when we type off it
will allocate the size of Earth so that
should be theoretically 32 by it for the
name plus 4 byte for the integer then
the whole allocated memory is
overwritten with zeroes this makes sense
because if on the heap data is
constantly allocated and freed then a
newly allocated area can have all data
in there a free does not zero out the
memory so here it zeros out on
allocation afterwards the length of the
input line is checked so it doesn't
exceed the 32 bytes available in the
auth struct for the name and if that is
safe the characters after the auth
command are copied the name of the
author object let's try that let's
authenticate as admin cool as you can
see the variable auth contains no an
address this is where the auth object is
on the heap now the last command is
logged in which checks if the integer of
the author object is not 0
and if that's the case we successfully
logged in otherwise if it's zero then it
tells us to enter a password though in
this case there is not much more
functionality than that but just imagine
that you are trying to log in as admin
without knowing the password so somehow
our goal is to set the integer to a
value and then we are authenticated at
the moment it seems impossible because
the integer auth is never set anywhere
but we have learned from the beginning
that there are bugs that allow us to
modify variables another command here is
reset which will free the auth object on
the heap and this is actually where the
issue is you notice when we reset the
login process it frees the auth object
but as you can see the auth bearable is
not reset to zero it still contains the
pointer into the heap where the object
was before and when we for example login
now it will check the name attribute of
that object well it hasn't changed so we
are still on earth attenti kated but the
login command will use the variable auth
after we just freed it use after free
get it now the last command here is
servers which will perform a STR dub a
string the application of the characters
after the service command so for example
we can specify that we want to use the
hex service and now we also have an
address in the service variable in
strangely it's the same one as auth
dense weird so what does a start-up do
let's read the main page SCR dub returns
a pointer to a new string which is a
duplicate of the string s the memory of
the new string is obtained with malloc
and can be freed with free ah so it's
just a convenient function that
allocates the length of the string we
pass to it and copies it there so it
will also call mehleb and thus allocate
stuff on the heap and you can already
guess why service got the same address
as off because auth was freed there was
free space and service got the free
space there let's look at this in gdb
first we set the assembler syntax to
Intel and then we disassemble main let's
first run it and use auth once so we
performed at least one melot then press
control-c and check the address of the
heap with info
mappings now we can print 20 words from
the heap with examine also because this
application is still all the symbols and
stuff inside of the binary gdb also
knows that auth is from the type struct
auth which we can print pretty again and
we can see here the string name and the
authentica we can do the same for the
service string now let's create a break
point before the printf and with command
we can then type what gdb commands shall
be executed when we hit this break point
we can use echo to print some strings to
make it look more pretty but first we
want to print the heap we echo a line we
want to print the auth variable another
line and the service variable at the end
we continue automatically and finish the
command sequence with end now
let's rerun this binary ok at first we
get some memory errors because the heap
doesn't exist yet so let's allocate our
first value by authenticating with auth
as admin also let's disable Gd B's
pagination so we always print everything
it don't get that type return to
continue dialog set pagination off now
we can see here our heap like we
expected we have a junk with our string
name admin but something is weird why is
the length of the chunk only hex one
zero that is only eight bytes after you
subtract the 8 by chunkiness shouldn't
it be like 32 byte name plus the integer
what's going on
well this is not that important for a
solution but this is what happens if
you're right shitty code and name
everything off the struct is called auth
the struct auth pointer is called auth
the integer in here is called off and
when the program mark calculated the
size of Earth and calculate the size of
the variable auth not the struct off
thus it's only 4 byte but meh logo
lighted to 8 bytes gosh people please
name your variables better this is how
backs and security issues are created
anyhow let's ignore that for now earlier
we are wondering how the free works so
let's free the auth object with reset
and pay attention to what changes ok law
basically nothing changed except that
the first word of the chunk data got
replaced with 0 that's because the first
word in a free chunk is defi
as a previous free chunk address because
free junks are in a linked list but we
don't have another free chunk in the
list thus it's not so really not much
happened other than the málaga
algorithm knows that the free heap
starts again at the beginning and it
doesn't care if there are still leftover
values on the heap as long as the
metadata like the previous address
pointer are correct does it only change
that particular value anyhow we can now
see that auth objects still exist with
the pointer into the heap here but the
name is now empty with nulls and the
integers still no but let's use servers
to allocate a string on the heap let's
allocate just some recognizable
characters like AAA node only 3/8
because the code is shitty and it also
takes a space before the ace here on the
heap we can see that the string got
allocated and we see that the name of
the auth object has now some different
values
now let's allocate a new string with
service bbbb and another one with ccc we
see the heap slowly filling up and huh
what's that suddenly the Authenticator
has a huge value that's because it
points into the heap where the CCC is
stored and if we now log in then we get
the message that we are already logged
in awesome I have to say this level is
so horribly broken as I mentioned before
the code is so shitty that it allocates
the wrong size for the auth object the
space is too small I show you let's
restart it and earth again as admin now
simply enter a long service string and
boom we also overrode the integer and we
get the locked-in message so we didn't
have to free the auth object with reset
to solve it but I wanted to introduce
the term use after free and it was also
kind of the intended challenge</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>