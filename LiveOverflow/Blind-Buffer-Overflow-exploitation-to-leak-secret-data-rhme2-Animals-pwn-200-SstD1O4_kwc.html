<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Blind Buffer Overflow exploitation to leak secret data - rhme2 Animals (pwn 200) | Coder Coacher - Coaching Coders</title><meta content="Blind Buffer Overflow exploitation to leak secret data - rhme2 Animals (pwn 200) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/LiveOverflow/">LiveOverflow</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Blind Buffer Overflow exploitation to leak secret data - rhme2 Animals (pwn 200)</b></h2><h5 class="post__date">2017-05-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/SstD1O4_kwc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">let's do another trip to the United
Exploitation country we already visited
the casino enter photo manager so let's
continue this road and head to the
animals this is a two hundred point
exploitation challenge and it doesn't
provide us anything to reverse engineer
so we must be able to blindly exploit
this the description reads after decades
of research we finally managed to
catalogue all the animals on the planet
Earth including very rare pictures
oftentimes the text can contain hints
but this one is so short in generic it
probably doesn't really include anything
so let's load the challenge onto the
board and get started
let's could you check out the
functionality receiver a menu and a
prompt where we can enter character the
menu items indicate that you can enter
a/c to print a cat or a d2 for this dog
or an M to print a mouse we can also try
to enter some more characters like a
right cat well it still just prints what
the first character said it's
interesting that you can enter more
characters and get the whole string so
we could definitely try and see what
happens when we enter more characters
you might already notice some odd
behavior but let's not get ahead of also
this was my mistake I first made when I
approached this challenge let's do this
systematically I decided to use a
whiteboard to visualize what goes on in
my head as well as to document each
discovery especially with splined
challenges like this you need to build a
good mental model of the program running
there and taking notes is crucial so I
start with writing down what I know
there are these three different
characters in the menu M C and D so I
wonder is there maybe a hidden menu
option let's find out let's write some
code that tries out every character and
we look at the response by now you
already know this code this just sets up
the serial connection at the board and
some helper functions so first we read
until we get the menu enter prompt so we
can send a character and it makes sense
to put this into a loop so now we print
the last output construct our payload
which is just one character and entered
into the menu then we read the result
and try the next character when we try
to run it it doesn't find serial I
forgot to enter the virtual environment
if you do any Python programming make
sure to check out virtual end so now it
works and it tries every character but
it's a lot of output I think it's better
if you remove all of the new lines and
also show the raw bytes with wrapper now
it's easy to spot stuff when you now
look through here we notice that some
characters for example the percentage
sign are turned into null byte there are
a couple of them no idea if it's
important in some way or not but let's
make sure to note this down it's
important to not ignore oddities like
this but
besides that we didn't find any secret
menu option so let's think of something
else we could try how we're trying our
different lengths of input let's modify
our code to test that so instead of
using the loop number as the character
we use it to change the length of the
input we just try it with some ace when
we run it we can observe multiple things
first of all the input seems to be kept
at like 59 or 60 characters our input
keeps growing but the output step so
let's take note of that
the first short length happened
obviously very quickly so if you look
there again more closely we notice that
with the 11th character we screw with
something and suddenly leak a lot of
bytes let's write it down so it's very
interesting what is so special at this
last character position we can write
some code to explore that further let's
enter a couple of C's and then play with
the exact value and here's a very
interesting result you see we always
enter a bunch of fees but it only prints
the amount of bytes we specify so no
bytes will print nothing and three will
print three characters and so when we
get to the high byte values like actual
s key characters we obviously click 30
your Moabites doesn't leak up to 255
bytes so there's a limit but we can
write this down we can change from 11
charge dumps memory to that the 11 straw
controls the output length so now we
know that we have to speak range of
memory we can write 2 and certain
positions can contain important
information so for example the 11th
character is the print length and to
take nodes we can enter the byte that we
leak into this long array all of the
ASCII character number 7 X 3 7 prints
the maximum amount of output so now we
wonder what could other positions in
this memory here mean when we fast the
input length we use the character 8 so
I'm wondering what if you use another
character that actually prints a picture
like see the cat so modify the code
slightly and then let's see what happens
and very quickly the cat disappears and
if you do the same thing for dog the dog
picture disappears a little bit later so
you can write down how many characters
it takes to reach a point where a
particular picture is not shown anymore
it's very interesting what could we
possibly overwrite in memory that causes
this behavior look at the memory relief
and mark the apparently interesting
offset it's clear that these sprites
must mean something this might have
something to do with cat
so let's modify the code is 3 bytes I
know are the correct value but replace
the first one to try different bytes but
it doesn't do anything it seems like
there's only one correct value that
leads to printing the cat in retrospect
is probably like a stack cookie we must
use that one particular value so let's
move on to the next byte do the same
thing and this time it does print the
cat more often it's a bit weird I have a
strong feeling that this as part of an
address but I don't know let's move on
to the third part
Oh holy crap this is clearly moving the
cat around so that is definitely part of
the address or offset into memory where
the cat is stored also it's very
interesting to see some weird characters
before and afterwards it's not just a
zero including not just random garbage
so that's something we shouldn't ignore
but we still get didn't get a big
breakthrough now if you look at the leak
memory dump you will notice that the dog
and mouse seem to have four interesting
bites while the cat only has three maybe
the first bite of the cat just happens
to be zero but actually it has also
those four bites ignore some of the
notes here I was just to close some
random ideas anyway let's try the fourth
bite
whoa this output is damn interesting
this is gold if you look very closely
you notice that these weird characters
have indeed a pattern doesn't this look
like the dog the shape is here just the
wrong characters and this looks like the
mouse this really stinks like XOR the
pattern is here just the characters have
to be transformed into something else
so let's write a simple Python script
that tries out different XOR keys
applies them to this lead character
output and printed and when we now look
through the possible outputs we find a
clear text Mouse so to recap we have a
big chunk of memory and at certain
offsets we know there is some kind of
information regarding the animal
pictures at least the to last by its
effect where we read from memory we were
able to extract an XOR picture from the
mouse by changing the bytes of what
correspondent to the cat so we clearly
control here the location of memory read
at the output is XOR so now we have a
first series shot at getting the flag
let's modify our loop to iterate over
all two byte values then we take the
leak memory output pass it to a function
that brute forces all possible keys and
our assumption is that some memory
location will contain the flag just
export so if you find the word flag in
any of the decrypted memory leaks we win
make sense right so let's try that
oh man I just first make your mistake I
meant to root for the third and fourth
by it but if you look closely I proved
for the second and third obviously that
didn't work so after fixing that and
some other minor mistakes I let it run
and it pretty much immediately outputs
the flag let's hand it in and collect
our 200 points
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>