<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Adapting the 32bit exploit to 64bit for format4 - bin 0x27 | Coder Coacher - Coaching Coders</title><meta content="Adapting the 32bit exploit to 64bit for format4 - bin 0x27 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/LiveOverflow/">LiveOverflow</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Adapting the 32bit exploit to 64bit for format4 - bin 0x27</b></h2><h5 class="post__date">2017-12-15</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/_lO_rwaK_pY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">let's have a look at formant level four
from exploited exercises protostar on a
current Ubuntu machine and this time I
thought instead of building the complete
exploit from the ground up we take the
old exploit that we developed for the
32-bit Linux image and see if it still
works probably it won't work but then we
debug it and slowly make it work on this
64-bit Ubuntu
okay so here is the source code again we
have a 512 byte large buffer on the
stack which is used to read data from a
standard input
but it only reads up to 512 bytes so
there is no buffer overflow but then
this buffer is passed directly to printf
so we have a format string exploit our
goal is it to redirect code execution to
the hello function notice how here after
the printf we find an exit
well that was intentionally placed here
because exodus part of Lipsy so there
will be a global offset table entry for
it which we can overwrite then when we
call exit here our overwritten function
would be executed instead so it's
actually a pretty straightforward formal
string exploit just right to the exit G
ot entry the address of hello and you
are done hello and the G ot table have
fixed addresses and are not affected by
a SLR at least on this Ubuntu version
because of the default compiler options
I received several comments that wrote
that on their system they default to P
ie so they are the g OT address and the
functions will be affected by a SLR and
then I don't think these simple cases
are exploitable anymore we would require
a little bit more complex examples with
more interactions where we first can
leak values to defeat a SLR but we will
slowly get there over time let's not
rush too quickly into these topics so we
compile this now on our bone to machine
and we get the old exploit code man this
was episode hex 13 August 2016 holy
that is a long time ago when I started I
thought I would have very quickly a
complete series on all the basics and we
still haven't reached drop in a SLR god
dammit anyway let's copy that Python
code looks good now I write it into a
file XP and then we can start gdb with
format for and execute it
run and then we pipe in the xpl as input
to the program we print a lot of
characters that looks good but we get a
sec fault we are attempting to write the
value in our 15 hex 8 4 before to the
address in our ax and our ax is
obviously wrong hex 5 8 is X so this is
the percentage end part of the exploit
hex 8 4 B 4 is the amount of characters
already printed and it tried to write to
the fourth value and that turned out to
be not the address anymore so two things
first of all obviously the amount of
characters that we are writing with
percentage n are wrong we don't even
know yet what we want to write and most
importantly we are not writing to the
address we have specified in the exploit
now with the format string offset we hit
our padding okay so let's use this
opportunity and get the correct
addresses first we need the address of
the exit G ot entry we do this by
looking where it is called then we
simply disassemble the few instructions
that jump to the G ot entry that's the
PLT the residual linkage table and here
it references the exit G ot entry you
can see it will jump to whatever address
is written there so we have to overwrite
this with the address of hello and
here's the address of hello you can see
again that only the last 2 bytes of the
current exit geo T entry and our desired
hello address are different which means
we only have to overwrite those last 2
bytes so let's place these two new
addresses in our exploit code and we can
also throw away the old format modifiers
and instead we just add a bunch of
percentage P to find our new stack
offset so we write it again to a file
start gdb and type the file in as input
mmm no real output just like an 8 and a
backtick where are the addresses we leak
with percentage P these are the small
things that can be really frustrating
and this actually happened to me when I
was preparing this episode I was going
crazy trying to understand what the heck
is happening and just executing it over
and over again hope with the computer
would do something else I'm debugging it
to break before the printf and see that
my input is passed to printf but no
output goddamnit work but it will not if
it's not doing what I wanted to do I
made a mistake I'm the problem
I need to calm down take a step back and
try to figure out a way to figure out my
stupid mistakes so what exactly is the
output we get I piped the exploit output
into hex dump and see that it stops
after three characters and that is our
address but cut off the other addresses
and the format string is missing but
when I then also did the hex dump of the
exploit I noticed the obvious mistake
the adverse has a null byte and printf
stops at Inova eight strings are null
terminated goddamn I'm so dumb this was
not an issue for the 32-bit exploit
because there our addresses had also
four bytes and thus no null byte now on
64-bit the default address is only three
bytes so our next step is we move the
addresses at the end of our exploit they
still get placed on the stack with the
null bytes F gets will read no bytes
just the printf format vulnerability
part must not have an orbit when we move
it to the end we want it to be at a
fixed location so we add padding to our
format string and then make sure we have
enough space for the two addresses at
the end we are on 64 bits so we have 2
times 8 bytes so we need 16 characters
looks good so we tried it input into
format for looks good we print values
now and I can't find our addresses let's
actually have a lot more percentage P
how about a hundred that fits easily in
the 512 bytes okay so where are they
here they are but that doesn't look good
they should be too
individual values but it's pretty clear
what happened we forgot to also encode
the addresses for 64-bit struct Peck I
pecks an integer in four bytes but we
wanted packed in eight bytes so let's
try it again
here they are this looks good now let's
find the offset we can just count how
much to the end and then subtract from
100 so it offsets 68 we should find the
address and yes indeed there it is so
now we just have to print the correct
amount of characters to write the two
bytes actually we don't need to of
rights we should be able to do that in
one so we add another format string with
a padding of the amount of characters we
want to write that would be hex 676
minus the characters we already printed
before so basically minus 8 and then we
should also remove the space before the
percentage end there would be another
character printed so it should work no
right segmentation fault
damn so when I was recording all of this
I really thought it should work right
away but then I get a segmentation fault
really confused me and that would be
again something I could obsess about why
did that happen but after I stopped
recording and literally started to write
down what I just did in the script I
realized my mistake when I wrote down
percentage and I realized I wrote a
whole integer but I meant to write only
2 bytes so I would have required
percentage agent you should able to
verify this with gdb let's check it out
yes there this sec fault at address 6 &amp;amp;
6
we've wrote a whole integer so we all
wrote the higher bytes that were already
sorted in geo T so let's change it to H
n to write half a word or whatever that
means it writes 2 bytes and that worked
code execution redirected you win you
see the export is different from the
original 32-bit version required quite
some changes but it also kind of still
the same thing definitely not a hard
challenge on a modern system as long as
you don't compile it
pa
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>