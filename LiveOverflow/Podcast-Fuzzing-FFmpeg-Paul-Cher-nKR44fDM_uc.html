<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[Podcast] Fuzzing FFmpeg - Paul Cher | Coder Coacher - Coaching Coders</title><meta content="[Podcast] Fuzzing FFmpeg - Paul Cher - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/LiveOverflow/">LiveOverflow</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>[Podcast] Fuzzing FFmpeg - Paul Cher</b></h2><h5 class="post__date">2017-06-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/nKR44fDM_uc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">welcome to the first episode of the life
overflow IT security podcast focusing on
IT security research and the researchers
behind it as you know I have a youtube
channel where I make videos for example
to show how binary exploitation works
buffer overflows use after freeze and so
forth and I think the video format works
out quite well and in the same way how I
saw people looking for a really
technical YouTube channel I see people
looking for technical podcasts and there
are some really nice security podcasts
but as a podcast listener myself they
were not quite what I was looking for
just think contemplating for a while now
how I could make a useful technical
podcast and record some tests myself but
I didn't really like it but then Paul a
security researcher from the Moscow
State University wrote me an email with
subject let's make a video and he wanted
to talk about how he and his friend a
male learner found several owner
abilities in ffmpeg and how they
exploited it in this video we'll be
coming but we also had a really nice
conversation just talking about the
process of getting there and while we
were talking I realized this is the kind
of podcast I would listen to so this is
an experiment first time doing something
like this it will likely evolve as I
learn more about podcasting so I'm
really looking forward to feedback
please write me an email to Life
overflow at gmail.com so let's get
started
ffmpeg is an open source project that
creates libraries and tools to handle a
huge amount of different multimedia
files for example you can convert videos
extract JPEGs from videos cut audio
files create a time-lapse from pictures
and it supports many different file
formats and if mtech is used by a lot of
applications that do something with
audio or video and paul and his friend
email found several new vulnerabilities
in it but before we start how they did
it let's meet Paul first he's a student
at the Moscow State University or maybe
I should say he was he just got his
spatulas today just today I have became
a graduated Beckler unlike me he seems
to be a student who gets really obsessed
with something so much that he sits in
class and wants to use the time to learn
more about exploitation when I sit on
collections I'm trying to do some binary
exploitation challenges because I'm not
that much interested in the materials
that and instead I'm trying to spend my
time as much efficient as possible to
get better at what I'm interested in so
he clearly knows what he wants now but
there wasn't always the case so
basically he didn't know that I would be
so much interested in binary
exploitation even two years ago because
I started my path as web application
hacker and I was like very interested in
it I think three years ago or yeah three
years ago I have joined the bushwhackers
ETF team at my university and I was like
really happy with it because there were
so much interesting stuff that was going
on here we did the city as some our
teachers were getting new courses in at
the university that were about the web
hacking but later I decided that I want
to know everything about the information
security I want to know about the
cryptography I want to know about the
binary exploitation reverse engineering
and so on so as I'm getting deeper and
deeper
at the reverse engineering and binary
exploitation I am becoming more and more
interested in it and first I did it at
some CTS adjust the binary exploitation
because motivation for me was that at
the time our team was able to solve like
every web challenge that was on the
stairs but we weren't able to solve
exploitation challenges which makes us a
little bit worse but it's not so for now
because there are a lot of people that
came to our security laboratory came to
our team that do a lot of binary
exploration and some of them are doing
it's even much much better than me and I
still think that this is the CTF are
basically the good way to improve the
good point to start your way and but
this is not this should not continue for
long enough because when you start doing
the like Winery exploitation in steps
you have to show something to the world
that you're not just a city a player you
have to show that you're like a
researcher that you are doing it for
something so this was a good chance for
me to show that well the binary
exploration is working the stack canary
does not prevent of all the bugs all
these kind of stuff
so I find that making a good research is
actually my goal like my life goal so
making the world more secure finding
more and more interesting bugs improving
in the real world binary exploitation
and this is my like light go
we had an interesting point here so he
used CTF security capture-the-flag
competitions to learn more about
exploitation and he also recommends it
as a good starting point but he also
said that at some point you should move
on to some real-world research and this
ffmpeg research was his way into the
real world for me this was this research
was a chance to do something real for
this world I hope it worked out but why
ffmpeg I know it's a very complex
software and it probably has still won
abilities but a lot of research has been
done on ffmpeg it sounds like a really
scary beast speaking about the target
and how we managed to discover this one
and raved from malroux corporation was
first from us who managed to discover
that ffmpeg is representing interest for
a researcher so he was working as a
back-end developer at that time at the
cloud so after noticing how many parts
and how complexities how many web
applications intending to use the ffmpeg
as third-party software for processing
the image and video on the server side
he just knew that it has to be goddamn
vulnerable and he was right because it
resulted that he found many
vulnerabilities in ffmpeg and they have
suffered to do a giant update on this
one they weren't like binary
vulnerabilities but they were logical
ones so for me and my friend Emil it was
a motivation to continue this research
and maybe find new bugs including the
memory corruption bugs
I think this worked out because we found
something new and we successfully
exploitative okay so maybe a MPEG still
has some vulnerabilities but was that
just luck or how do you approach this
now as you know the ffmpeg has many
interesting part
and the codecs were already so fast for
many CPU years by the researches from
Google and I think they are continuing
to cause it and it might be not possible
to find the vulnerability in the ffmpeg
codec so Google started fuzzing ffmpeg
like three years ago in 2014 or even
earlier when Ginn Vulcano cold wind and
material chick managed to discover like
thousands of vulnerabilities using their
own father so how do you deal with the
fact it sounds really hard to find more
stuff when we have faced this problem we
decided that we could make two things
about this
we could make fuzzing another way and
fuzzing where nobody has caused ffmpeg
ever so we managed to do them both and
it's worked out because we found some
univille neural bilities that were not
discovered okay so this makes sense fast
a different part and fast my
intelligently realizing that sounds like
a good motivation it doesn't sound as
daunting anymore yeah yeah it was a kind
of motivation to look in a different way
in the ffmpeg and we knew that we
couldn't discover vulnerabilities in the
codecs because they were so much
fathered for many CPU years but we
really knew that there are some other
interesting parts that they likely
didn't manage to fuzz correctly or maybe
not even correctly but they didn't
manage to fully fund these parts so we
decided to look it up now they have a
rough plan but how do you actually go
about this how do you find logic
vulnerabilities do you have to read
source code and do you look at previous
example vulnerability to get an idea of
how they might look like well I'm not
that good at discovering logic
vulnerabilities in a title tag but M L
did
cover a lot of these vulnerabilities and
basically he have reading a lot of
source code and he have been reading
another researches on the ffmpeg
vulnerabilities there not so many of
them but some that allowed him to
understand the complexity of these
vulnerabilities and where he could find
them but Paul also mentioned fuzzing but
a lot of researchers have fast ffmpeg
before so how do you identify what to
fuss okay so well we didn't need exactly
which part we wanted to look up and
analyze so we decided that we are not
going to look at the codecs but we
decided to look at the protocols of the
protocols that ffmpeg using to
communicate with some other applications
or maybe even users so this quite
managed to work out because the
protocols inside ffmpeg were no fun at
all and we even managed to discover some
vulnerabilities just by looking into
their source code protocols so codecs
are the part that basically implements
the algorithms to for example handle
their compressed audio or video file
formats but protocols are a different
part of an MPEG that communicates via
network with something else
I imagine this could be something like
streaming from a URL you don't look at
the decoding of the video stream but
generally how the transport protocol
underneath is working and you figured
that out by reading code yeah well
basically it's war we managed to read
some parts of the source code and it was
quite enough for us to understand that
reading the source code of codecs is not
very clever idea in terms of
vulnerability discovery and it was like
very hard and we have to look some other
place and we immediately found that the
protocols is a good target and on the
next day we have already discovered
symbol
abilities in the format stuff and the
protocol stuff okay they found already
issues just by looking at the source
code of some of the protocols I guess
it's pretty clear that that is an area
where fuzzing could yield a lot yeah we
first firstly we looked at the protocols
and then after that we tried to look
into the vulnerabilities that were
already discovered in this part and we
found a lot of civvies and a lot of
vulnerabilities that were discovered in
other parts of a thumbtack like codecs
we didn't manage to discover any world
villages that connected with the network
usage or something like that so choosing
the target ffmpeg and finding a part
that was not yet extensively analyzed
the protocols didn't seem like a big
challenge yeah basically the real
challenge was with the fuzzing and the
exploitation because we didn't have too
much of an issue with the choosing our
target we just figured out that we found
part which wasn't very good analyzed in
terms of vulnerability discovery and we
decided to get our hands on it
Wow okay interesting I would have
thought that figuring out a good target
it's already pretty difficult but I
guess they did the research on all drone
abilities really well so they were
confident that the protocols area is a
good target so how do you find out what
abilities did you just look up CVEs yeah
the main source is of course the Mitra
which is recording this it easy you
could look it up and see the description
of the vulnerabilities and the second
source that we used is actually the log
of the github that you could actually
look up one man in this github using
grep and this is the only man in ffmpeg
developer team who only think that he is
doing he is reviewing their security
patches and committing them so you could
just basically grab his name and find
which
choose ffmpeg had recently huh that is
clever looking at this one developer who
commits the security pets to figure out
which areas got a lot of fixes
let's quickly recap ffmpeg is an
interesting target because it's used by
a lot of applications because of this
researchers have been looking and
fudging ffmpeg for many years like Paul
mentioned the codecs were fast
extensively but they figured out that
another part the network protocol
implementations were not fast at all and
there were already some packs they
discovered by hand so basically the mill
has already discovered one vulnerability
an HTTP protocol by his own hands what
we wanted to do is to get the puzzle
working for all of the protocols so we
wanted it to be able to find the
vulnerability where we have discovered
by our own hands and we wanted to make
it find other vulnerabilities in the
protocols this is good advice here if
you can find already a vulnerability you
can use it to verify that your father
can find the kind of bugs you are
looking for so what kind of father did
you use AFL American fuzzy lab is a very
popular choice nowadays but that this
makes sense for networking because AFL
only uses files as input yeah yeah
basically we have used FL as the father
because it is really clever and it is
very interesting father which had
already a lot of vulnerabilities and I
really admire my Kowalewski for writing
this this is really a great idea on
passing we use FL we are overloaded the
network operations inside the ffmpeg
source code and this helped us to
discover some vulnerabilities we managed
to further some protocols that were not
previously found and this is like we
found that in a unique way and certainly
we were certain that this part was not
fault by anybody else that's cool I was
wondering how you would files all the
different protocols it's insidious to
implement it but because AFL uses
genetic algorithms to automatically
discover and cover as many code paths
possible if L can automatically find how
the protocol works we have kind of seen
that in a very popular article called
pulling JPEGs out of thin air
where AFL fast jpg library and
automatically crafted valid image files
with the complex file format yeah IFL
could find there automatically if the
protocols are like really different and
we decided that we would do as good as
possible examples so the FL has some
base to start filing each protocol so
the vulnerability discovery was much
faster because of this because AFL is a
genetic algorithm you have to start
somewhere and so they gave AFL some
example data how the protocol looks like
and with that AFL has a good start on
discovering more code thoughts and get
good coverage but there's still one open
question how do you make AFL fat
networking because it is a file-based
putter Paul already used the word
overloading for the network operations
so what does he mean by that
yeah well this is like very interesting
question because yeah we did manage to
fund it in some interesting way they're
really they're very challenging tasks
when you start fighting the network
operations and basically like how ftp
protocol works firstly you communicate
by FTP protocol with the server and to
actually transmit the file it opens that
another port which you have to connect
and it will be translated over another
TCP session so this is like very
interesting question how you are going
to fuzz operations like this but yeah it
was it was very simple for us
surprisingly simple because we decided
that we would overload the operations in
the ffmpeg in some complex way that it
will partly
until some marker it would actually read
using the
read or receive functions and the after
marker it will be the another read or
receive session so in this way you could
add this marker into the AFL dictionary
and you could break the network
communication into some like packets oh
that's clever so they basically
implemented their own socket receive and
send functions and they would not
actually do networking operations their
code reads a big file at the beginning
which contains markers to divide the one
file in multiple received chunks so when
ffmpeg calls the first receive the code
would return the data up to the first
marker and with the second receive they
would provide the next chunk until the
next marker so that's really clever
this way you made the protocols possible
with files yeah well so basically yeah
it's just overloading the not just
overloading basically it was rewriting
the raid and receive functions so they
will work with markers and emulating the
blocking non-blocking grid so this is
the kind of new way in the emulating the
network operations here that's such a
good idea is this something new you came
up with or did you hear about this from
somewhere else now we actually heard
about the Prinny which is tool to the
overloading than network operations but
we decided to write our own network
operations over loader and I think this
works maybe a little bit better when the
tool which guys from the shellfish CTF
team came out with I think you could
find actually this tool in their github
so I think our approach made it was a
little bit better just a little bit
let's do a quick recap so you have a
target and you know the interesting part
now you have to implement the fuzzing
they chose AFL because it's a really
great father but they had to add some
modifications to ffmpeg in order to
simulate network traffic through a file
because AFL will use files as input and
this file contains markers that divide
one file into multiple networking
operations but when all of this is
running you should finally see some
crashes coming in yeah looking into the
crashes is really interesting because
you have already found an segmentation
fault or maybe it is a crash which just
corrupts the memory and you managed to
find that it corrupts the memory using
the address init Iser maybe this is the
one thing we didn't mention in our talk
about the fuzzing that almost used their
address sanitizer because even if you
have their performance issues with that
like it is the program becomes free time
slower if it runs with the address
analyzer still you will discovered
mobile vulnerabilities then if you fast
just without address entitled looking
for generic segmentation fault so yeah
at this point we have discovered some
crashes and we were ready to look into
them but I think that this is not quite
interesting because when you have
already discovered the crash the main
idea for you is just to understand why
there is an asana report or while there
is a segmentation fold it's not much big
of a deal because it's kind of easy part
to find in the so a bug in the source
code when you have already a
segmentation fault for me it's kind of
easy part he mentioned something
important here I said the address
sanitizer it's especially useful when
looking for heat-based
arrows you can imagine that when you
have a slide out of bound read you might
just read and now zeros in memory and
oftentimes there's coded checks for now
and nothing happens no crash but if
there were values
if you specifically groom the heap so
that there are values it would crash an
address sanitizer helps you with it it
fills a lot of memory areas with
different values and some other features
to help you provoke segmentation faults
and so forth this way it's easy to find
issues that you might have not found
before and this instrumentation does
slow down your execution but like he
says it's really worth it
but I'm wondering does this complex
setup of modified ffmpeg code with your
network overloading address sanitizer
and AFL instrumentation lead to false
positives all bugs we discover using
fuzzing were fully exploitable bugs and
novel positives at all
maybe there is able to find the bugs
that don't don't the might not lead to
the exploitation or and code execution
but there's two bugs off by one on the
heat maybe which are not exploitable but
there's still bugs and I have never seen
that a Sun would generate a false
positive report okay that sounds really
good so now you have found actual
crashes that could be exploitable
we were quickly able to analyze them and
to start analyzing how we would write
and exploit for this one
now I would love to talk about the
details of exploitation but it actually
doesn't make too much sense with only
audio Paul offered to walk me through
the exploits and show me the interesting
code part so we will make a video about
that
so keep an eye out on the YouTube live
overflow channel but before we finish
this podcast I completely forgot to ask
how many people were actually involved
in this research in this particular
research there were two feet on me and
Emil I was basically doing the binary
exploitation and like bugs discovery I
have read like tons of ffmpeg code
trying to discover some bugs and email
he just can do everything he is good as
everything he is good at finding logic
bars he is good at fighting he's good at
exploiting bugs and particularly in this
research there were just two of us but
globally we have maybe four or five
members that from time to time to
analyze the ffmpeg source code and try
to bring some new bugs because this is
kind of interesting do you have any
advice for people who would like to get
into research
my recommendation is for you is doing
everything on purpose because it is so
much important to know what you are
doing this certain thing for because
later you would know that when it comes
down to the CTF and research you really
have to know that it is improving you it
is accelerating you in terms of your
education and knowledge so there's
everything on purpose and you will find
yourself very happy about your security
stuff
thank you so much Paul and the others
for sharing your research with us
I would like to thank you for inviting
me thank you very good conversation
finally I am I was able to speak to
somebody about the research we did Paul
is really nice he even thanks me for
inviting him but it should make it clear
all the credit belongs to him because he
is the one who reached out to me so
thank you for that I also really enjoyed
this conversation
and I'm looking forward to learn more
about the exploitation details
this marks the end of the first live
overflow podcast episode it was really
interesting to me and I hope you enjoyed
it as well like I said in the beginning
I would love to get some feedback on
this episode at live overflow at
gmail.com make sure to follow and
subscribe on Twitter reddit or YouTube
thanks
the music comes from other ozz Edie's
net thank you for making free music
subscribe to the level flow youtube
channel</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>