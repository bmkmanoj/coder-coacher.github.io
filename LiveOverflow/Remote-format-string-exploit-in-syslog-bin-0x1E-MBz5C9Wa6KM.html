<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Remote format string exploit in syslog() - bin 0x1E | Coder Coacher - Coaching Coders</title><meta content="Remote format string exploit in syslog() - bin 0x1E - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/LiveOverflow/">LiveOverflow</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Remote format string exploit in syslog() - bin 0x1E</b></h2><h5 class="post__date">2016-12-16</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/MBz5C9Wa6KM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">format string vulnerability that can be
exploited remotely over the past few
videos we have learned how to talk to
these programs over a TCP network
connection and how to debug them so we
are all set to go
like all previous challenges the program
is running as a network daemon in this
case on poor to none at four so we can
use net cat to connect to the service
which displays a final one prompt but
when we enter something we don't see
anything hmm also because we already
know it would be about a format string
vulnerability we can try to inject some
characters such as percentage X but
again nothing happens we could also try
cousin s because if you remember it will
take values on the stack as the address
location of a string thus if values on
the stack do not point into valid memory
the program should crash which would be
another indication of a format string
vulnerability but know also doesn't do
anything we could also try to send a
very long string just to see if there is
a buffer overflow that would crash a
program but also doesn't work you can
see that the prompt got returned now
multiple times which is an indication
that the program always reads a limited
amount of characters and you send so
many at once that the read loop was able
to read many times so I guess it's time
to have a look at the source code main
calls to functions after setting up all
the networking stuff the first one is
get IP port and the second one is parser
get IP port cause the function get pier
name so let's see what that is about
get pier name returns the address of the
pier connected to the socket socket D in
the buffer pointer to buy address we can
see that it also defines a struct soft
address in which apparently will then
contain the source IP address and source
port by the client that connected to the
socket you can also look up how the
struct exactly looks like on the main
page for IP so it will basically contain
the port number and the IP address and
the IP address
is a 32-bit integer an S printf will
write this construct string into
hostname which is a global variable okay
so once this function is complete the
code will call parser and parser will
print the final one prompt we already
know then it uses F gets to read 128
bytes into the line buffer after that it
uses trim which looks for the first
occurrence of a new line or line feed
and replaces it with a 0 basically
cutting the string at these positions
then it will check if the string you
entered starts with username or login ah
so there are special commands for that
prompt if you enter username it kinda
expects additional data after it because
it string copies anything after the
username part into the global variable
username if you would use the command
login it would check if the specified
user name before if not it tells you you
follow a wrong protocol but if you
specify the username before it will call
lock it with a pointer into the string
after login because it expects a
password there the password is not used
and log it it's just a mock up for the
challenge but in there it uses a buffer
and writes to it with SN printf
basically creating a line for a log
entry that says that there was a log in
attempt from a certain client for a
specific user with a certain password
and then the string logged in the system
log then this function returns will
print logon failed
armed with this knowledge we can try to
use the prompt again and it does what we
expect now this faith look in attempt
should have been logged in the syslog so
let's check it out
note you have to be rude to read that
file so tale to only get the last few
lines of dialogue syslog and there it is
final one log in attempt from the source
IP and source port as live overflow with
the password ok but where the heck is
our format string vulnerability there is
no printf where we control the format
parameter why am I so hasty we don't
even fully understand the code yet do we
we read this code with sir
some shion's without questioning if they
are true the meaning of hacking if
anything is about understanding
computers on a deeper level
but there's one function where we got
lazy and brushed over because we assumed
it does its job if you take anything
away from the stuff I create then it
shall be don't be satisfied with what
you think you know challenge your
beliefs
okay well that rant was a bit over
playing it but we did not look into this
new function we encountered syslog I
guess what I'm saying is when you solve
these simple challenges you reach a
point where you think you know every
dangerous function but it's not true so
don't get lazy and read the main page if
you look at the main page of syslog we
will see that the second parameter is a
format parameter syslog generates a log
message which will be distributed to
syslog D this is love demon the priority
argument is formed by a ring the
facility in the level values explint the
remaining arguments are format as in
printf sis lock works like printf and
buff in lock it is the format parameter
and buff will simply contain the
username and password we entered and
thus we can inject format characters
let's try it let's login with percentage
x stuff
logon failed check the source lock and
there it is the brackets you can see the
leaked values from the stack perfect now
we have identified the bug and from
earlier format string exploit videos we
learnt that a good strategy is to
override an address in the global offset
table with another function like system
to execute commands let's think about
what function would be convenient to
overwrite I think the STR and compare is
a cool function because we control the
first parameter the line and system uses
the first parameter for the string to
execute stuff so if we replace string
and compare with system we can simply
type in a line and execute a shell
command
okay so let's construct our exploit we
import what might be important and set
up the remote soccer connection like we
are used to and maybe we trade a new
function called read until which
very useful in these kind of remote
service chambers so read until shall
fill up a buffer with singer character
reads until the buffer contains the
magic string specified by read until and
then we can simply write read until the
final one prompt and then we can do our
stuff so first we specify user name read
until next prompt and we specify the
login password and read again until the
next prompt another trick I use is the
function raw input which is actually to
read input from the user in Python but
it's very convenient to kind of pause
the script until we hit Enter so when we
execute this now we connect to the
service and then we wait until we had
enter in the script when we now check
the running processes for final one we
see - if you remember the one is a
parent daemon and the new one with the
higher process ID as the spawn child
that is handing our client connection so
we can attach gdb to that process and
start collecting addresses of important
symbols so first let's figure out the
errors of str and comparing the global
offset table with info functions and
search term we can find the function
trampoline in the PLT quickly we can
disassemble those instructions and we
quickly see that it jumps to the address
stored here and this points into the
global off the table and we'll obviously
contain the real address to string and
compare and epsy so that's our target
address we want to override next is the
address of system system as part of
let's see and we can quickly get the
address of it here no usually Lipsy is
randomized due to a SLR nowadays but on
this old linux system or embedded
devices it still works this way on a
real modern system you will first have
two league addresses from memory in
order to calculate offsets and break SLR
okay so we have our target and we have
the address that we want to write to
awesome the resulting log message will
contain your source IP and port which
might vary in length coming from
localhost will be different than coming
from a remote host so we should add this
into our exploit to be reliable the
challenge used get peer name to get the
IP and port of its peer so we can use
the equivalent to get our own name
with get sock name now we also know the
source IP and port and can write code to
adapt accordingly also I'm sorry the
code is really awful to read this way I
don't know why I never bothered to turn
on syntax code highlighting so here we
go
let's have a look again at the logged
line from earlier these characters here
are the at the end looks suspiciously
like a ski when we convert them we see
that spell login from and so forth so
let's do this again with some
recognizable characters to find the
username and there it is
so it took roughly 14 pups of the stag
to reach the username with the AAA
you can see that the ace don't perfectly
aligned they even might shift around
because of the length of the IP and port
thus first step is to make this constant
by adapting the amount of aides such
that afterwards it will be known aligned
offset so in this case the hostname was
15 characters long and and one more a
would have filled up and aligned the
memory so let's think about what the
shortest and longest host name could be
shortest would be 9 long as 21 because
we prefer multiples of 4 to be 32-bit
aligned we decide to pair to 24
characters and as we take the length of
the host name subtracted from 24 and
then we know how many ace we need let's
try this again with some percentage X in
the username and we must not forget the
new line at the end of our inputs
Oh doesn't work what did we do wrong
we forgot to use the name in log in
command still doesn't work
Oh the line can only be 128 bytes long
but we send a lot more with those 28
percent of X and so on for C so many
small things can go wrong and slow you
down
now we get to log and failed and looking
into the syslog and searching for the
B's we see that goddamnit we forgot to
add the pairing with the ACE okay there
we go
the bees are not perfectly aligned
awesome now it doesn't matter what IP or
port you have it will always be exactly
there and we can count the words on the
stack to get to the offset 17 so now we
can move on and use a signal percentage
X with the dollar notation to refer to
the seventeenth parameter the
seventeenth value on the stack so for
example we can now place the address of
the global offset table entry for strm
compared here into the string and then
use percentage n to write to that
address so now we only need to figure
out how big of a padding we need to
write these the values we want if that
confuses you re-watch the old format
string stuff so before we run it now add
another raw input so that the script
doesn't exit when we run it attached to
it with gdb and observe the GRT entry
for str and compare we see that after
the look in attempt they've got all
written our goal is the lower part of
the system address which is fffb zero so
now we can calculate the correct number
and characters we need to print and this
is basically how the process now works
we write with percentage end to the
address check the number calculate how
much is missing or how much we are
overshooting correct the number of
characters we print and repeat until we
have constructed the full address for
system there is super annoying
it's fiddly and takes some time but once
you've got it it's prequel
so now I got the offset right and the
address is all written with the address
of system now we can add the talent left
Rick with interact to our program and
theoretically at this point all cost who
SERN compare would cause system instead
and if you look into the colon think
about it simply writing something on the
prompt should result in command
execution so let's try it we get a
prompt and now we can type commands if
we are in a real shell every loop the
program reads our line calls as they are
encouraged in reality system and
executes our commands and again we can
copy the exploit to our Windows machine
change the IP address to the VM and then
get a remote shell awesome</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>