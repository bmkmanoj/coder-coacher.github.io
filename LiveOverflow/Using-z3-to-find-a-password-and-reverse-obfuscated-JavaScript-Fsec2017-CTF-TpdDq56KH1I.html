<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Using z3 to find a password and reverse obfuscated JavaScript - Fsec2017 CTF | Coder Coacher - Coaching Coders</title><meta content="Using z3 to find a password and reverse obfuscated JavaScript - Fsec2017 CTF - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/LiveOverflow/">LiveOverflow</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Using z3 to find a password and reverse obfuscated JavaScript - Fsec2017 CTF</b></h2><h5 class="post__date">2017-10-13</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/TpdDq56KH1I" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so recently I was invited to give a talk
at eff SEC in Croatia and I met some of
you and there was awesome during the
conference there was also a CTF I think
other chumps were actually created by
Miroslav stamp are the author of SQL map
also let's try something new for this
video let's see if we can mix challenge
right up and storytelling let me know if
it sucks or if it makes it more fun to
watch
web 150 hard times JavaScript plus form
equal challenger let's have a look at it
so there's a simple form for a password
and a button to check it but when you
enter anything nothing happens and when
you open the developer tools you
immediately trigger a debugger
breakpoint it looks very similar to the
anti debugging mechanism of the pop
under stuff we had a look at we can also
go one up in the caustic and see that
the JavaScript code is office committed
those functions return the actual
identifier for example debugger by the
way it was my first time in Croatia and
I really liked it if sick was held in
virus tchen and the town was really
pretty and especially the building of
the conference was this old theater and
was just a gorgeous location look at
these rooms
Toni mere the main organizer also wanted
to take a picture of me and as much as I
enjoy the conferences I do need my alone
time and so I looked for a quiet place
and worked on the challenge as a next
step we can download the HTML and look
at it locally so the code is obviously
not formatted actually I spent quite
some time making it pretty and defeating
the anti debugging statement but I skip
all of that because at some point I
realized there's a much easier way so
for the forum button there is an onclick
handler defined there a button click
function so this chunk here is this
function so whatever we are looking for
it should be here let's beautify that
part so immediately you can find some
functions that implement simple
operations to obfuscate more of the code
this can be easily reversed we can use
the developer toolbar to evaluate those
other functions for us the debugger
statement pause the script but we can
still use the console so this first
string for example was 3 2 0 1 4 in this
function down here results in the
congratulation string then we have this
big while loop with different cases
inside the switch case depends on G and
G comes from here let's check what this
year stands for this is the function
split and this was our first string form
there so this just splits the string 3 2
0 1 4 ok so we have a loop that executes
these operations in a sequence so it was
just alpha skating the order a little
bit case 0 2 &amp;amp; 3 just initialize local
variables with zero we can also clean up
case 1 a little bit in the same way we
did before just evaluate those functions
with the developer console and so this
function is a for loop over the length
of a and a is the password input so this
loops over each character of our
password it sums up all the ASCII values
in E and XOR every value in F also D is
set based on some calculations of the
Java use so this is definitely part of
the password check some values are
calculated based on the input string and
probably later checked like I said I was
invited to F SEC to give a talk I spoke
about some CTF stuff the taka tree
called the soil will shared once it's
edited I also used the opportunity
during lightning talks and threw
together a few slides to promote the
streaming and video community sorry if I
forgot somebody I literally only had a
few minutes to prepare the main part of
the challenge is this big if case here
so we should probably clean that one up
next it's a bit tedious but fairly
straightforward just always look up what
something evaluates to and make some
nodes or replace it let me fast forward
that so you can see how slowly the rules
for the password check appear and I also
renamed the password char code add into
PW with brackets because that's Python
syntax and I'm more comfortable to read
it you know the goal for me right now is
not to have running JavaScript code but
just to understand the algorithm and I
want to get rid of anything that I find
distracting so I can focus on what's
important okay cool so first of all you
can see here e F and T compared to a
constant those who are calculated based
on our input characters then we compare
a lot of different characters in the
password with each other so for example
the first character ASCII value - the
second one has to be 4 and if all those
cases are true we have here an
and everything is correct okay that's it
we just have to find the password now
that fits those conditions let's do an
example we just had this one case where
the first character ASCII value minus
the second character has to be four and
the first check here with the Reg X make
sure that only those characters are
allowed for the password so we can
quickly check all options we have we
just write two loops over the alphabet
subtract the ASCII value and if it's
four we print the tool and it turns out
there's only one valid case so we
already know our password must start
with pl we can also see that character
at offset D and E have to be the same or
two and eight and seven and B we also
know that the character at position C
has to be equal to the length shifted by
two that could be useful to figure out
what are valid lengths of the password
we can again write a loop so the
password can be 12 17 19 or 20
characters long and appending on which
length we use we already know the value
of the 12th character when you keep
doing that and lower the search space
you still end up with a huge amount of
possible password combinations and
actually the D variable is the hardest
one to reverse in such a way so you can
write the brute-force algorithm that
takes these restrictions into account
you can really optimize that but I
didn't want to do that and I was hoping
I could use z3 for that set 3 or any
other Sat solver are the go-to tools for
problems like that and a lot of
challenges are really easy with it so we
set three you can just specify a few
conditions and rules like we just found
and then ask what input satisfies those
rules and then there are fancy
algorithms that can solve such an
equation system and provide possible
inputs but the larger the rules are the
longer it takes it might even become
impossible to do in a short time so for
example obviously you can't use it to
reverse a sha hash with it and the D
variable is such a condition which
quickly explodes into a huge equation
actually the challenge also told me
afterwards that he tried to make it such
that it's infeasible to do with set
three and that you have to create your
own custom optimized brute-force
algorithm but I thought I'd try a
combination mostly because I was lazy so
I thought I could let say three generate
valid password that fulfil some
conditions at least the easy ones and
then brute force the difficult
conditions like D so here's my set three
code let's jump right to the rules as
you can see not much is different the
rules are like we saw them in JavaScript
but for example the rule we looked at
earlier with the first - second
character equal to four
I removed because only one combination
PL is valid thus the rule is unnecessary
and we can already make those fixed here
I have a helper function that takes in a
character and tells set three that the
character has to be one of those values
and we apply that to each character of
the password the main function itself
also takes in the length of the password
and generate the set three bit vectors
dynamically with this length and at the
bottom we have a typical set three
snipper to check if it's even solvable
and then we generate some valid
passwords we print the password we found
and also calculate D for it and check if
it's what we expect that's basically the
brute force part because that three
can't easily solve that for us and then
we add the password we just found as a
rule to not appear again then sell three
we'll find another valid password that
is not one of the previous ones and we
check again if it satisfies the D
constant so when we run it we get a lot
of valid passwords but none fit D but
you can already see that the password
could start with play there would be a
valid word so we can take a guess and
add more constraints saying that the
password has to start with play and then
it could be play underscore or play Ying
and so forth and I just start playing
around with this and see if I can
generate meaningful valid passwords and
after a little bit I've narrowed it down
so much that actually one password is
found that matches D and this is the
valid password playing and losing
also a Tony Muir taught me that I think
some of his students ask if I'm playing
the conference CTF and suspected me of
hoarding flags because I was not winning
what I thought they watch my videos and
see how much I struggle what the
I'm not some CTF machine I don't know
how to solve all of these challenges
either I know a ten minute video
write-up looks impressive but obviously
it takes me hours when I actually look
at it the first time though I hope I
make that clear in my videos I really
don't want to pretend I'm some kind of
hacking God you should check out the
reason pub on the livestream because
there you can see how terrible and slow
I really am just wanted to mention that
anyway thanks again for having me f SEC
it was great food was good and hopefully
we meet again another time
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>