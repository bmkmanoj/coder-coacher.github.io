<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Monster Apps: Meatscope + Polymon (Polymer Summit 2016) | Coder Coacher - Coaching Coders</title><meta content="Monster Apps: Meatscope + Polymon (Polymer Summit 2016) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Google-Chrome-Developers/">Google Chrome Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Monster Apps: Meatscope + Polymon (Polymer Summit 2016)</b></h2><h5 class="post__date">2016-10-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/2_5X-mQdLXc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello everybody I'm Chris Joel I built
Polly mana meet scope and today we're
going to talk about monster apps so a
few months back the polymer team flew to
sydney to hang out some of the chrome
developers who like to work upside down
and you may have known this about
Australians I didn't really know it but
Australians are really great
collaborators they love to collaborate I
would get tired of collaborating and I
would turn around and these guys would
be but you know looking at me
expectantly acting like we were going to
collaborate some more and I just really
couldn't take it I have to admit that a
certain point I had collaborated so much
that things just crossed the threshold
and I don't know things got a little
fuzzy and then
Chris Chris Chris please
watch out when you collaborate it's it's
dangerous so as I sank into the darkness
into the cool Sydney coastline that
evening I had a few moments to reflect
what I've been doing with my life had I
gotten so caught up in this
collaboration that I'd forgotten why I
got into web development to begin with I
wanted to change the world I wanted to
build apps that would touch people's
lives that would make the world a better
place thanks to this moment of
introspection I had the inspiration I
needed selfie gifts the internet needs
selfie gifts I mean everybody loves
selfie gifts they combine the two best
things on the Internet selfies and gifts
so I did the next thing that any
self-respecting web developer would do I
went out and I built a web app okay
actually the first thing i did was i
registered a really cool domain name i
called it meets cope registered meet
scope camera in case you didn't know you
can get a camera domain then the next
thing I did was I went and built a web
app but when I first got started I
wasn't really sure if this was something
I could even do I mean I needed to get
access to a camera I needed to process
image data from that camera I needed to
store that image data in my web app was
this stuff that could even be done I
mean this is supposed to be a phone app
can phones even do this on the web well
this is a story about how the web
platform had my back and how I use the
web platform to deliver selfie gifts to
everyone so we start with the media
capture and streams API this is a really
cool API that's available in pretty much
every browser that lets you access input
from camera input from microphone and
record it or display to the user well
okay it's not quite available in every
single browser but
come back to that in a minute so what
does it look like it's a really great
API it's got all these great promise
ified methods its most of them are
hanging off of navigator media devices
here you can see I'm calling enumerate
devices and this is basically a promise
promise fight API that gives me a list
of all of the input devices available to
the user and here you can see I'm
actually filtering by a device lock kind
that matches some kind of video string
and this is how I get my list of cameras
another really useful method in this API
is get user media so using getusermedia
I can select in a fuzzy way or a precise
way exactly what I want access to and it
returns a promise that resolves with a
stream of input from that device here
I'm specifically requesting access to
one camera and when you put it together
with the HTML video element you get
something cool you essentially get a
video element that's displaying stuff
coming out of a camera on your device
now the HTML video element is cool for
two reasons one it lets your users see
exactly what's going on what you're
taking image images of the other reason
why it's really cool is you can pair it
with canvas draw it to a canvas and get
image that out of it so here I'm taking
a canvas I'm measuring the width and the
height of the video I'm drawing the
video to the canvas and then i'm using a
method called draw image drawimage is a
little misleading it says draw image but
you can actually pass a handful of other
elements to the draw image method and
also the dimensions the width and height
and then voila there's pixel data all
right here's a demo so on the bottom
right I've got a html5 video element
that's showing stuff for my webcam and
in the back I have a canvas so if I need
to make my selfie face I can go like
this and you guys can stare at that for
a few minutes
and so what are we doing here we're
using the web flap web platform to
capture image data from the webcam and
if you're lazy like me and you like web
components I've wrapped a lot of this up
in a series of web components I call
meet scope elements so from top to
bottom I've got meet scope devices which
basically accesses the enumerated
devices method and filters for all the
cameras and reveals one of the cameras
as selected camera I'm binding that to
meet scope user media which takes in a
device and then spits out a stream and
then the stream gets bound to me to go
video and meets ago video just displays
whatever's in that stream in a full
bleed video on the device or in some
smaller container if you prefer so the
next thing I needed was a given coder
and thanks to the vibrant JavaScript
ecosystem there's like a million gif
encoders but I picked this one it's
really great pretty simple to use it
looks something like this I create a new
instance of a gif I can configure it a
little bit and then for all of the
frames that I've captured for my gif I
added into the gift using the add frame
method and then I call gift render
pretty simple and in order to actually
make a gif you have to record multiple
frames and then add them in in sequence
so it looks something like this here
I've got several canvases next to each
other and each one has recorded some
picture of me doing something one and
then you know you add them all together
and it makes it look like I'm going like
so each frame when i'm recording a gift
i do something like this i draw the
video to a canvas context and then I
push the image data from the canvas
context onto a frames array this turn
out to be really really bad basically
during a very sensitive time in my user
experience when I was trying to record
gif image data I was spending 50
milliseconds just reading out of a
canvas you can see that most of the time
is spent at the bottom there where I'm
calling get image data so that was bad
but the worst thing was at the very end
you see at this red box on the left was
me recording the gift on the right is 40
seconds I spent
rendering the gift and this was all
happening on the main thread this was
actually on desktop what went in my
first pass and frankly it was totally
unusable it's like you record the gift
you drop a bunch of frames and then your
user has to sit around for 40 seconds
waiting for a bad gift to render and and
meanwhile they can't even use the app
because the main thread is blocked so
what do we do how do we make this better
Mitya I don't know why that keeps
happening so I started to think about
you know what could I do to optimize
this whole experience of recording gifts
and the first thing I thought of was you
know when I get the final gish I've
scaled it down pretty significantly
compared to the source data so what if I
could do that in advance instead of
trying to pass a bunch of big image data
down to a gif encoder and have it do the
scaling itself it turns out that the
canvas 2d context is able to do this for
us the draw image a method will allow
you to pass target dimensions for
drawing the video so here I am doing the
same thing I did before except i'm
passing in the scale dimensions that i
want to draw onto the canvas now this is
nice because it means i want to go to
read the image that off the canvas i'm
going to be reading far fewer bytes than
i was before but i still thought i could
do a little bit better every single time
i was recording a frame I was actually
doing something like this I was writing
stuff to a canvas and I was reading it
back then writing it and then reading it
back could I do better than that uh well
as a matter of fact I came up with a
nice strategy that I think balanced you
know reading and writing pretty well so
it looks something like this
so what's going on here is this the same
demos before I just have one canvas and
I have one video input and as i'm
recording frames each time i increment a
counter and i know i need to draw the
next frame a little bit offset from the
first one and it creates kind of a
filmstrip effect now the results of this
was pretty awesome this thing really
wants me to print literally a hundred
times better so remember before it was
about 15 milliseconds per frame now it's
half a millisecond per frame because i'm
not actually reading any of that canvas
data anymore this is so much better
because it means i'm not going to be
dropping frames while I'm recording a
gift also I had this problem still right
I'm I get to the very end of the
recording and it still takes almost a
minute for me to get my rendered gif the
trick here is you really have to keep
work off the main thread it's not okay
for you to lock up your user experience
for almost a minute just to you know do
some heavy-duty work so how do we take
care of this well turns out the platform
has another solution for us web workers
so most of you probably know what web
workers are how do we use them here here
I'm creating a new web worker this is
just a basic web worker and I'm passing
in my gif encoding library and then I'm
creating a message channel I like
message channels because they're kind of
like a two-way walkie-talkie between the
main thread and the worker thread I pass
the port from the message channel into
the worker and then I listen for
messages on that port so that i can do
communication now if that looks a little
verbose the platform actually has a
really cool kind of worker called shared
worker shared where Kurt basically works
the same way as a normal worker with a
few exceptions so shared worker when you
create a new instance of it if an
instance has already been created it
will share the same worker thread with
the new instantiate ER of a shared
worker also shared worker comes with a
message channel kind of built in so when
you get your worker instance it already
has a port that you can communicate to
the worker with now shared worker isn't
available everywhere and in fact it's
possibly on the chopping block for the
web platform
but it's a pretty nice class to use and
if you like it like I do we built a
class called common worker for app
storage which works almost exactly the
same way a shared worker so you can
create a common worker you'll get a
worker instance back you'll have a port
that you can use to talk to the worker
and excuse me and it also shares the
property of shared worker where it only
creates one worker thread for every no
matter how many common worker instances
you've created now inside the worker
what we do is we import our gif encoder
we listen for messages on the port that
we get from the client every time the
client is tan Chee it's a new common
worker we encode our gift and then we
post the gift back to the main thread
it's that simple this was an awesome
improvement moving stuff off the main
thread meant i went from 40 seconds of
encode time down to about 100
milliseconds now if you look at that and
say well 100 milliseconds is actually
still quite a bit of work it turns out
there are some hard limitations to what
you can do with HTML canvas if you get a
bunch of image data out of a
sufficiently large canvas you're going
to incur some cost but I'll take 100
milliseconds over 40 milliseconds any
day over sorry 40 seconds any day of the
week it's also worth noting that there
are standards at work to get work or
sorry canvas that you can use off of the
main thread so look forward to that
coming up in the web platform soon so
this is an example of what i got from
all of my performance optimizations here
i am recording multiple gifts one after
another each time i record a gif i start
another one and those gifts go and they
encode off of the main thread and
meanwhile the main thread is nice
running 60 frames per second
everything's good so your users when
they're recording they're very important
selfie gifts can end up with results
like print dialog know this
so I have my selfie yes but what do I do
with them I mean I don't want to just
throw them away well it turns out
there's an element for that at Google
i/o 2016 we released a bunch of
experimental elements that we call app
storage so f storage is kind of based on
this idea that spawned out of firebase
elements where we saw the value of
creating declarative elements that give
you access to storage layers all right
so what do they look like roughly they
look like this we have documents and we
have queries documents referenced
specific blobs of data by ID queries let
you construct ordered limited queries so
that you can get lists of data and
iterate over them off storage elements
let you synchronize storage and state in
your app within the app and also between
your app and the cloud if that's
something that you want but not
necessarily and today we have two bodies
of app storage elements that you can use
many of you are probably familiar with
polymer fire there's an awesome talk by
Michael bleh bleh earlier today some of
you might not be familiar with the fact
that we have a series of app storage
elements built around pouch DB so i
really like a pouch TV a lot it's nice
because it lets me have access to index
DB which is a piece of the web platform
that is available whether your online or
offline it's a database that's right
there in your browser and I really like
to use the web platform so I ended up
choosing pouch DB for meat scope now
what is using pouch TV even look like
well in JavaScript it's something like
this you create a new instance of pouch
TB and pass in a name for your database
and anytime you want to store data in it
I mean that's really all you have to do
any time you want to store data in it
you just call DB put and pass in some
object and you get to store that and
pouch TV in index DB in your browser and
you can see in this example I'm actually
storing binary data because index TV can
store binary data which means I could
just throw all of my gifts into pouch DB
now I just want to stop a talk about how
some this is all right its twenty
sixteen I have a database in my browser
I can store structured objects I can
store binary data I can just throw this
stuff into pouch DB and forget about I
mean it has virtually unlimited space so
this was really exciting for me but what
does it look like to use it in practice
with polymer so here's pouch DB query
here you can see i'm specifying that my
databases meet scope I am create I'm
crafting a selector and sorting and
specifying fields that I want and then
what I get as a result is gifts now
gifts is just an array of rose I can
pass that into a dom repeat iterate over
it and just spit out my gifts it's
really that easy and if I want to
interact with a document directly I have
a pouch TV document so I'm binding it to
a specific document with just some
random doc ID and the result is I get
gift out of the data property and with
gif I can just make changes and buy a
two-way data binding all of those
changes are going to transparently
reflect in the storage layer so you know
a bit about selfie gifts it's time to
take a selfie
all right I'm gonna need your help for
this everybody say web components all
right so just so you guys can see we've
got my phone here it's encoding the gif
over there in the top left but just to
prove that I'm not full of hot air I'm
gonna take another selfie yeah good up
here on stage all right right there's
the gift that we recorded and it's
frozen well you guys get the idea
and enough about selfie gifts let's talk
about important things like coffee so a
few months back Justin from the polymer
team and I were sitting in a coffee shop
and you know we were looking ahead to
the polymer summit we were like a little
anxious because you know polymer 2 point
0 was you know coming about and we
weren't sure what we were going to talk
about and we had a conversation that
went something like this Justin's like
hey we should build a really cool app
for our users at the polymer summit to
show off how cool the web platform is
and like get them engaged get them
interacting with the team members don't
you think that'd be cool and I was like
yeah yeah yeah let's build a video game
that's a great idea you have so many
good ideas Justin and then just was like
no I you only have like three months
games are hard what about like a survey
or something something where they can
like pull it out and then like interact
with each other somehow I don't know and
I was like hey guys guys Justin wants to
build a video game tell him about it
Justin it's gonna be awesome and Justin
didn't really respond to that he just
sort of disappeared so anyway that was
the conversation that spawn meets go
we're sorry Polly mon and most of you
are familiar with Paul Iman now Polly
maan is a location-based monster
catching game with player versus player
battles now I just want to stop for a
second and say awesome this is on the
web platform you can build this on the
web platform please build things like
this on the web platform yes clap that's
awesome
so Justin had something about you know
he had a good intuition about this like
building a game is not easy it can take
millions of dollars to build really cool
video games and often they go over
budget and over time how was I going to
really prove that this was a thing like
I had to have a really great Minimum
Viable Product and I had to have it fast
otherwise this was probably not feasible
for the polymer summit timeline I mean
this was August it was mid August when
we started doing this and so I needed to
come up with a cool way to get people
interacting with each other I need to be
able to rely on the web platform to do
it so I looked a little bit into
physical web now physical web is cool
and all but you know maybe it's a little
too cool to cutting-edge not everybody
has access to it I also looked a little
bit at web bluetooth so what bluetooth
is a series of awesome new api's that
are landing and i wanted to be able to
scan Bluetooth beacons from JavaScript
and get access to all of them so I could
see what Paulie monomer nearby
unfortunately those AP eyes are kind of
still in flight and did you guys know
that there's like a web NFC API I didn't
know about this but it sounds really
cool I'd love to be able to catch a poly
Mont just by tapping my phone to
somebody else's phone that's not really
there yet nice stop for a second I
thought you know what Scott Jensen would
do Scott Jensen would use a QR code yeah
so everybody loves QR codes as we all
know and I thought everybody can scan QR
codes so let's just use QR codes this
would be great and wait a second I want
to use the web platform didn't I build a
series of components for accessing the
camera and processing image data on the
camera I think there's something to this
maybe I'll just take the meat scope
elements and pair them with I don't know
a QR code reader library thing and all
of a sudden I've got a QR code scanner
on the device and we're sorry in the web
platform and within a couple of days I
actually had a demo that looked like
this this is a very early version oh
yeah Hey look there's a poem on yeah
check that out let's cool now look
there's me and I cafe oh yeah QR code
awesome all right okay you can clap in
my prototype to this awesome thanks so
remember this I said we'd come back to
this so unfortunately you cannot access
the web cam directly in Safari they just
have not implemented the user media API
I encourage you all to go to the WebKit
bug tracker and star the bug to
implement this API because it's awesome
and fun to use but I still needed to
access Safari and a few weeks into the
project Monica came to me and she was
like I got it I know how you're going to
do it I know how you're going to get
access to the web cam on Safari it turns
out that there is an input element that
you can use to get access to the web cam
you just structure an input element like
this type equals file capture equals
camera except image / star and iOS will
helpfully show a little dialogue any
time the user clicks on it to take a
picture with a camera and voila we have
the ability to scan QR codes in a
browser that does not even support the
user media API and this is the demo that
resulted
so here I am no well no webcam image but
look at that I can take a photo oh yeah
now many of you have come up to me and
scanned my QR code with safari and you
know it's not perfect but i'll tell you
what progressive enhancement is not
about perfection it's about making sure
that every single browser has the
ability to experience the app you the
way you intended and if it works I think
that that's a good thing better than not
being able to do it at all yeah so this
is my obligatory purple slide otherwise
known as the laziest slide in my deck
how many of you guys and girls know what
purple means I know y'all are lying
because you didn't laugh at my lazy joke
but this is basically what first paint
looked like around about the time that
Polly Mon became feature complete it was
about 1.2 5 seconds in on desktop now
this isn't really great i mean it's ok
but frankly I wasn't doing any kind of
purply optimizations and there was
probably a lot of head room for
improvement so what did I do this is
roughly what polymn on looks like at the
top level I have a poly Mon app
component and inside of there I have a
series of routes this is just a few of
them but you can see I have a start
route I have a map route and I have a
poly decks route and for those of you
who have used polymn on you know that
the on the start route and on the map
route you see the start page and the map
at the same time here i have the
elements that correspond to those routes
so i have a start screen i have a map
screen I have a poly deck screen and so
these the activeness of these screens
corresponds to whether or not the routes
match so what I started to do was I
decorated my appt routes with
declarative information about what
element definitions needed to be loaded
in order for those routes to be visible
so I added some data attributes here you
can see I'm
loading the polymn on Start screen and
the map screen every time the Start
screen is active oh boy that's getting
old and then and then on the map screen
I have something very similar but since
the map screen does have two shirts the
start screen at the same time I can just
load the map screen by itself and that's
just an example of a few of the routes
on my app and then I built this thing
called the polymn on lazy loader which
sounds fancy but it's really not all it
does is it observes changes to route and
then it matches those changes against
the apparatus that I've also
declaratively added as children to the
polymn on lazy loader and each time the
rap matches it loads the data fragments
if they haven't been loaded before now
just as a lesson for everybody about how
important it is to do code splitting and
lazy loading I got my first paint I'm
down to two hundred seventy five minutes
I can suggest by doing this just by lazy
loading all the different parts of the
app this is really important it's one
second of time that you just save
somebody on desktop but probably several
seconds of time on mobile for now thanks
a lot for checking out my talk this is
monster apps I'm Chris Joel work on the
polymer team it's again we get the on
I on Twitter</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>