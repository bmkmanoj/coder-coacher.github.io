<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>On-stage: Building a WebRTC app | Coder Coacher - Coaching Coders</title><meta content="On-stage: Building a WebRTC app - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Google-Chrome-Developers/">Google Chrome Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>On-stage: Building a WebRTC app</b></h2><h5 class="post__date">2015-09-13</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/TLXmB2TZyZE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">yeah yeah so I'm Tim panting current
business card says protocol droid which
is what I actually like doing
implementing protocols but also
explaining the kind of human cyborg
interaction thing of translating from
geek to to real-life and back again
I'm steely glint on Twitter feel free to
tweet at me if you've got questions and
stuff so but I wanted to kind of kick
back with some recent news you know fear
got got their Jeep hacked because they
thought they had a VPN when they kind of
didn't and they didn't authenticate who
was talking to it correctly and they
didn't have a the right level of
firewall this these guys have got a
sniper rifle which for reasons are
completely I mean I'm too British to
understand has Wi-Fi enabled gun sights
and it can be hacked by the Wi-Fi so
that bizarrely if you change the gravity
constant you can make the things aim
wrong and hit the wrong target
and again this guy this is brilliant
right this guy has a hacked version of
the AR Drone
which when it sees another a AR Drone it
coops it and makes it follow it so it's
basically a it's a viral sub viral set
of AR drones and basically again because
this is open Wi-Fi with no
authentication nest earlier this week
was down along with Dropbox so that your
dis even if your baby cam was in the
same room on the same Wi-Fi as your
handset you still couldn't talk to it
because it went through a server in Utah
or wherever they host their service this
is a big thing in Britain these guys had
the information Commissioner which is a
branch of government in the UK issued a
letter to all webcam many manufacturers
telling them not to release webcams that
use passwords and if they if they must
use passwords then they must disable the
webcam until the password has been
changed to a strong one so that's that's
the regulator starting to get involved
in internet security just kind of fun
and these guys so the f
same thing here the FDA have withdrawn a
pump an insulin pump I think because it
could be hacked over the whole Hospital
Network there wasn't properly fouled or
authenticated so I meant my message here
is that security isn't what it was you
know the old thing of knocking on the
postern gate of the castle and being
challenged for a password it doesn't
work in the new world right we've been
stuck in that in that security mode for
too long and it doesn't work anymore
now ideal protocol for the internet of
everything would be you know we're
standard protocol obviously it would be
secure it would have a wide deployment
it would be peer-to-peer with natural
versal so that it didn't matter if you
were on 3G or 4G or whatever you know or
on your Wi-Fi it would be real-time
because you need you know baby monitors
and rope pumps you don't want to delay
this stuff you would want strong
identity management so you can control
who's accessing the brakes in your car
and you want it to be mobile capable
because most of the time at least one
endpoint it's going to be a smartphone
the other one's probably going to be a
device but you want that and it won't
the bottom line in the summary of all
this is it's got to be focused on the
user it's got to be around what the user
needs so you look at that and you think
well the RTC web protocol it goes over
the wire has the following attributes
it's standardized it's secure it's
widely deployed it's peer-to-peer it's
got real it's obviously real-time the
identity thing not so much but there are
you know people are working on it it's
getting there and it's mobile capable
and possibly on smaller things so and
it's user centric so maybe there's
something we could do that so what I
decided to do for this this demo is to
build something that is real-time
authenticated peer-to-peer can make
communication between a small device and
a web RTC browser and obviously using
the data channel unless obviously not
using any passwords anyway because let's
face it we all hate passwords
so the components we're going to need
for this is where to see data channel
app in the smartphone we're about to see
data channel app in an embedded device
where what you see service so that they
can meet up and some sort of pairing so
that they know who they're talking to
and that that relationship is well
established so what we're going to use
is Chrome for Android well actually
because of the AAV thing I'm going to do
it on the Mac but it could perfectly
well be on Android or indeed it could be
a cocoa pod or whatever you know it's
standard web RTC basically I'm already
gonna run a lightweight stack on the
device I've written a very simple
WebSocket message hub just because I can
and it's on github there if you want it
and actually all of the html5 for the
examples are in that git repository as
well and I'm gonna use QR code pairing
just actually kind of fun because it
uses getusermedia so it's even more
WebRTC ish and I'm going to use a
duckling protocol so described by Ross
Anderson in the 90s he's a prophet of
computer science at Cambridge Cambridge
UK and basically what it models is the
idea that a device trusts the first
thing it sees so I mean this is
supposedly true of duckling I don't know
if it actually is but that you know
duckling recognizes its mother because
that's the first thing it saw when it
came out of the shell and so actually we
flipped this a relationship round
because most small devices don't have
cameras and most smartphones do so
actually we turn it around we have the
the device showing the QR code and the
smartphone seeing it scanning it and
making a call and then that only happens
once at the kind of hatching stage when
you first switch a device on when you
unpack it from the Amazon package or
whatever and at that point it becomes
your device and you claim ownership
so now I'm going to attempt to demo what
that looks like for users now this
screen is more resolution than I
expected so let's make it a bit bigger
and like that okay right so quite the
effect I had in mind so to riff off the
original remark about yo pet this is the
the app I wrote for last year but we've
added with added pairing because I
basically last year I totally avoided
the whole issue of how do you pair up
two devices so I figured this this year
I probably better fix that so the idea
is you have your pet has has an app on
their tablet which you put in front of
their cage or wherever and so the model
is you first when you first get this
this app you study that and it shows a
QR code it says please show this to your
your handset or in this case your room
actually it's Latin quite quickly so I'm
going to or show it to your your in this
case your your browser in your desktop
and you show the two to each other and a
few seconds later it sets up a quick
test call and then you're paired from
that point on these two devices will not
speak to anybody else like they know
about their pairing relationship from
then on and then the net result of that
is that I can put this down over here
and place a video call to it
with any luck and yes we have a video
call so I mean that doesn't sound like a
big deal but actually it's nice that I
didn't do any answer on that I didn't
accept it I didn't have to check it log
in check in no passwords were exchanged
let's switch that off and and you know
there are some other features like you
need to be able to forget the tablet and
whatever else
right so you've seen what the QR code
exchange looks like now I need to get my
browser back so QR code exchange is
actually a pretty simple you know
experience for the user so next thing
yes is the code now I wonder if this is
going to work probably not actually is
the code for the mm Hey oh yes I do know
how to do this I'm just going to show
you the a tiny bit of code for the
exchange of as a mode for this you
present a mode there we go that's what
we're doing well there we go right so
this is a it's little web RTC rendezvous
service runs in server it's actually
written in scarlet which I really like
it's great for the kind of central
services things and basically all it
does is it takes it takes a WebSocket
when you connect to it to a WebSocket
you and you a certain identity in this
case that whatever was actually in your
QR code on one end and the equivalent on
the other you certain identity and then
when a message comes in this device just
basically passes it out to the correct
the correct device within within the
mesh so it's basically a message passing
thing looks at there to address and
sends it it takes doesn't try and
validate anything it just passes them
around there's no kind of no there's
actually no management in there it's
just a message bus
yeah no it should be escape but it isn't
I fell for that earlier when I tried it
right so that's finger Smith again
that's actually in that github
repository you're welcome to improve it
please
so the question interesting question is
what do we use as an address what was in
that QR code you know web RTC has no
intrinsic identity built in and that was
a design decision and when I wholly
approve of but it doesn't have an
identity in there so I mean you know the
obvious thing to do is to use a random
key and if you look at something like
XMPP in the anonymous mode the server
generates a random key you know random
hold a random token which you could then
use or you can do what you know what's
available in in Twilio Andrus poke where
the client site can generate an identity
and assert a daily and just say I am
Fred that's fine and and that's what
we're exchanging in the QR code we've
taken the second approach that they're
the endpoint claims and identity a
random identity in this case but
persistent over the life of the of the
app exchange over the QR code attaching
and stored locally and reused for life
and what I mean life I mean in this case
it might be the life of the well the
tablet actually or an e-rate however
long you've got the app installed on the
tablet so now full disclosure this is
such a good idea I filed a patent on it
so if anybody who can it wants to blank
their their eyes and ears at this point
feel free so there's this fingerprint
thing loafing around in the SDP it looks
kind of random maybe we could do
something with it it's a it's actually
the hash on the x.509 certificate used
in the detail s exchange can you use it
as an address well actually yes and if
you do then all sorts of fun crypto
properties drop out for free basically
you don't have to trust the signaling
server anymore I'm going to give a talk
at the
Illinois Institute of Technology in
Chicago at three weeks time well I'll
talk about basic the whole talk is about
that they wouldn't let me do that here
so so but it basically lets the duckling
tell that Mommy is calling and ignores
everybody else all the other dogs so
another little bit of JavaScript walk
through here because I'm supposed to do
code you see so so localhost M right so
this is what we're going to see in a
minute but for the moment let's just
look at the source okay so so this is
here we go classic JavaScript you and
end up reading it backwards so the at
the end we have this on document ready
function and basically what this does is
it uses a little library I written
called ipsa Rama which goes off and
tries to find out what the fingerprint
is for the current device and and then
so it can then use it and assert it so
it does this by wherever it's gone
somewhere indenting is gone wrong so it
does this by hi how's it going oh yes of
course it does this by using another
library so it uses the ipsa rama library
I wonder if it's all yes excellent so it
does this by using its aroma library
memory it's a library does is who am i
basically does a fake generates a fake
offer so it generates an offer which is
thing at a throw away and it then it
passes that offer to a library which
actually I wrote with a friend of mine
neal stratford whilst we were working at
troppo build phone OSTP which parses a
which parses the STP into a decently
shaped JSON object and then you can go
and dig in the JSON objects and
the fingerprint out now we're though RTC
I no longer need to do that I can go and
ask the object but for the moment so you
see here this is what we call a phone a
library with the description and we pull
out a fingerprint by digging down into
the STP contents fingerprint print it's
it's it's not horrendously ugly but
they're actually the phone at STP
libraries not beautiful anyway so having
done that you you have the fingerprint
you establish your WebSocket connection
to in this case finger Smith and you say
right I'm connected and I am this
identity which is you know safe - not
exactly random bytes so back to the
presentation hopefully so generate dummy
offer use phony dot St PJs to pass that
dummy offer extract the fingerprint
thanks to drop over from making that
open source if sarama set stuff data
channel via finger smith and we have to
use generate certificate and index DB to
make sure that that certificate is
consistently used throughout the life
throughout my use of this app and Chrome
the default behavior at the moment is
that but I understand from the
conversation earlier that that will not
low will will soon cease to be the case
we'll have to use the generate
certificate and index DB on both
platforms which is fine because that's
the standard so on the device side I
have a set of choices about what I can
use in terms of what the platform is so
I mean an obvious choice would be to use
JavaScript and then so I'd probably take
their web RTC code dump compile it on to
my little Linux platform or cross
compile it on to my little Linux for
them and then wrap it in node and use
that and that's possible but there's an
awful lot of stuff there I don't need
like video codecs and things the other
approach would be to take an existing C
or C++ library like like janus from the
meet echo guys and and and a
and cut out the stuff I don't need
because they were a server-based and I
actually want to run this on a tiny end
point or I couldn't kind of do something
foolish and do it in Java and DIY so you
know those of you who know me will gues
exactly what I did which is I did at the
Java way fortunately there's lots of
helpful stuff out there my friend Emil
has has wrote a very nice ice for J
stack so the ice stuff sorted out and
that does turn and stun and I'm happy
with that the bouncy castle guys wrote
DTLS stack which actually troppo funded
so that's great that's out there they've
been now bought my Cisco so not too bad
unfortunately there isn't an open-source
SCTP stack in Java so I have to write
one so now down on the BeagleBone now
you think about you think about the
bigger bonus like the American version
of there of the Raspberry Pi it's a
little arm device
I think it's 600 megahertz half a gig of
memory and a little bit of flash it's
actually a slightly nicer platform than
the PI and it runs runs runs a
reasonable Linux so now back to the this
webpage Oh No
first we have to set the PI running so
on the isn't a PI on the BeagleBone
we're going to start a Java library my
my big Java library let me try and make
that a bit bigger for you right so this
is this should now there we go
now you need to see this really there
you go so this is a this is a BeagleBone
and it's now running it's drawn a QR
code and if I hold it close enough we'll
recognize it and then we can press
connect
and now we see my totally unoxidized
Java hopefully it gets an offer any
second now there we go
and hopefully it sends back an answer
with any of that yeah looking good and
now it's done the isotope transaction is
starting at CTP and look it's running
it's echoing my packet my my DTLS
packets now there are a couple of
interesting things to say about that
about why you would bother to do that
when you've got a perfectly good
WebSocket server there are two really
good reasons one of them going to show
you now if I can remember how there we
go that's one which is that we've got
even on a on a relatively slow device
and Ribera mine it's writing to this
with a serial port so it's doing stuff
slowly got a round-trip time of like 30
milliseconds be hard to do that with the
server out in the cloud and back to a
small device so it's like you know
there's a the round-trip time is is
short and and there's a stack of
optimization I could do to make that
shorter and then the other thing is I
can with any luck
hmm I can't see this well if I could
find the window it's running in I could
kill the WebSocket server but I can't
actually find it and it would still work
point being that it's not going through
the WebSockets and so that would still
continue to work however so that's you
know mm-hmm data channel running on a
small device right back to the story so
I know there's an argument basically
which says actually you're cheating
right a bigger bonus is a you know it's
a credit card size that's and it's it's
got half a half a gig around you know
that's not a real device real devices
are armed nines with 300 megahertz and
and 64 mega of memory and I would
counter that by pointing out that what
Intel think an IOT device looks like is
this right this is the Intel Edison and
it's a dual-core x86 architecture dual
500 megahertz with a gig of memory right
so actually you look not too far in the
future you could expect to find this in
your thermostat but I understand that
there will be platforms where that's not
appropriate so I give in I went out and
bought myself a toy I bought myself a
Lego ev3 now the ev3 is exactly that
spec it's a 300 megahertz arm nine
running Linux and some clown
cuz it's open source right so some clown
rebuilt the OS so that it took all the
Lego stuff out and it's a you run of
plain Linux and then some other clown
and I just admire of the open source
community through this whens and put a
Java API on it so all of these things
right all of these devices on here these
sensors and these motors actually have
Java API stew them and that I'm afraid
to me that's utterly irresistible right
so now so this
mmm-hmm and I put him on there he'll run
away and fall off so I need to put in
there and well nothing will happen for
several minutes because I have some
typing to do but right so now let's stop
the BeagleBone because that's a
distraction and let's make the let's
make so this is I mean you know this
just bizarre right I'm logging into my
my electronic dog here and and like this
is this is absolute if ago no password
right anyway fortunately it's on closed
Wi-Fi right so actually speaking of
closed Wi-Fi I think we might need to be
a bit closer
right so I need to kill I need to kill
the current menuing system that's
running on there because we don't want
any menus we don't do menus right so
with any like that screens gone
excellent right now this is the bit
where actually I lost Billy but he's not
here I asked Billy to stand around and
Phil for me because this takes ages but
it's fine you stay there and I'll just
blab
so starting Java on a 300 megahertz arm
and pulling in the DTLS crypto library
takes a few seconds and then pulling in
the WebSocket library takes a little
longer and then running over the keys
running the hash over the keys so that
it knows what the certificate is took a
little longer and now it's going to go
and try and talk to the WebSocket server
I think we'll get there I mean this is
all available for optimization I had
this working first got this working
earlier this week and I first got it
laia bleah working yesterday and I say
reliably but it may not actually turn
out that way so it should now be just
about to talk to the WebSocket server
come on there we go so we ran out on the
WebSocket we're doing that so now we
need to talk to it so unsurprisingly
they're very similar user interface oh
I've just made a tactical error so
you've got a QR code down there now for
two reasons one of which is that it's
over there and this is here and actually
because the camera on here doesn't like
the lighting I'm going to cheat I took a
picture of the QR code earlier
now it's fine I took a picture of the QR
code earlier because I knew that it's
not the problem is that that screen
isn't backlit and it actually is it a
lot of reflection of it as you will see
from the picture actually so with any
luck I hold this in the right place
we will come on you can do it the other
thing is if I get there we go got it
right so we now have the QR code
exchanged and we now start talking to it
now this actually also takes a little
while there we go or forgone answer
coming back gathering candidates it goes
out to return server I should be annoyed
but I mean hey it'll work which is the
important thing
so DTLS packets are going we have sent a
certificate but we haven't got one back
yet and that's timed out oh that's
looking good yes we now have a data
channel running and which means that at
least in theory I should be able to
drive this thing
and I can actually see where I'm going I
need need to put a camera on it right
turn right a bit there we go very gone
too far a bit Oh anyway so my lego
building skills aren't quite what they
should be but yeah I think this there's
a whole API for how fast you want to
accelerate but I didn't have time anyway
so the point being that I have a DTLS
exchange with anyway whatever and no
passwords were harmed in this in this
you know in this exchange so
oh yeah the demo right so by using
WebRTC data channel we have used a
standardized secure widely deployed
peer-to-peer real time strong identity
management to a mobile small device you
and it's Wow
fairly user century so like the big
takeaway messages web RTC
isn't just for video calls there are
other things you can do with it and
particularly the data channel can solve
interesting problems in the internet of
everything space so that's me</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>