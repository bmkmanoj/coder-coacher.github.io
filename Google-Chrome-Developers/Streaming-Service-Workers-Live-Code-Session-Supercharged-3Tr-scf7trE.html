<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Streaming Service Workers: Live Code Session - Supercharged | Coder Coacher - Coaching Coders</title><meta content="Streaming Service Workers: Live Code Session - Supercharged - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Google-Chrome-Developers/">Google Chrome Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Streaming Service Workers: Live Code Session - Supercharged</b></h2><h5 class="post__date">2017-07-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/3Tr-scf7trE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">it is 2:30 p.m. and that means it is
time for supercharged
hi I'm Surma oh you want me to say my
name look I've never done this before
looking have you not noticed a different
person standing here today that is a
very long name hi I'm Jake and today
we're gonna do some streaming service
worker Q the jazz
so Jake welcome I'm actually excited
about this because to me it feels a
little bit like like an upgrade because
not only do you know sorcerer core you
actually kind of designed them and you
have hair that's true
well a little bit it's a slice are you
just easing into someone with more and
more hair and eventually yeah like
eventually I'm gonna have I'm gonna have
afro and it's it's gonna get really
interesting
so we already said in the teaser that
we're gonna do or you're gonna do a blog
with a streaming service worker yes so
what I mean
I know streams I know Service Worker but
when you say streaming service work or
what exactly
okay so service workers are streaming by
default like if you if you do like a
fetch and you pass the response back to
the page or if you get something from
the cache that all streams they you know
it means that the page will start
receiving bits of the response while the
service work is still busy so something
put the end of the page doesn't need to
arrive for the first parts to appear on
screen yeah absolutely and this is like
really useful like if you've got a long
page like yeah even something like a
news article it means that you only have
to receive the top and you can start
reading it even though they still
downloading the rest of the article so
but when you say so I gotta streaming by
default then why is what you're doing in
any kind difficult or putting on a live
stream well okay so what we're going to
do is we're going to make a single
stream that's built up of different
streams like so we're going to take some
stuff from the cache and some stuff on
the network we're going to merge it
together in one stream and serve that up
and that will mean that we can get on
screen really quickly with the cache
stuff that's important because usually
we want to we're telling people over and
over like the time to first paint or
first mistltein is super important like
if you're on screen quickly and keep
these are busy with just consuming most
on a block especially with the content
while the rest spins up in the
background then it's a super good user
experience yeah and it improves the
perception of performance as well and
also gives you an opportunity to kind of
you know if the stuff from the cache
arrives and the network stops taking a
while
gives you the opportunity to kind of put
messages up there going yeah we're still
trying okay yeah now that sort of thing
which again it's better UX right yeah so
I mean with you being here it makes
sense that you do the coding today and
that means that I will be mmm-ah as one
person usually does
on the Super Show livestream I want to
hug you the chat so everybody hi welcome
if you have questions any time just put
them in the chat I'll try to keep up
with whatever you say and incorporate it
and distract Jake whenever I can make
him stumble make him do mistakes because
that's what you want to see you right so
I'd say let's just get into it and see
where are we starting off because I
think I don't I'm gonna do from scratch
are we gonna take like a starting point
well so a lot of serviceworker articles
I've seen they do start from scratch but
I think like most of us we have sites
already so that's a good point actually
yeah so I want you to kind of start with
something and show how you could add a
serviceworker to it without detecting
how the psychology works yeah why don't
you walk us through it I guess right
okay so on my screen right now is what
looks like my blog although I recreated
its hashtag shameless self plug yeah
it's a self plug it's also my personal
brand but it's it's an existing site it
says this is how it works and we're
gonna be able to add a service worker to
it now I wanted it to be something that
was kind of more site like the app and
also something that would benefit from
streaming so something with articles as
well and since you know it doesn't have
any of the kind of legal problems of
showing an actual news website or
something so yeah so this is it you can
sort of click it to articles and go
around I guess the important bit is how
its implemented yeah so if we dive into
the code here this is a node.js project
built on top of Express which we have
used before like I think whenever we did
any kind of back and work with node I
think we have used node in the express
in the past hmm so it shouldn't be
everyone should at least like know
roughly what the API is I'm just going
to make that assumption here well but
yeah my blog in real life is actually
built on top of Django and Python by
fault like let's let's stick to
JavaScript yeah they've got yeah
also my Python is a lot worse than my
JavaScript and we're about to find out
how bad my JavaScript actually is so
most of the interesting details so I've
got this post folder which is get a
directory for each post I see it there
and so we have like a meta jason with
like sort of Tyco or our case summary
description
so basically reminds me a little bit of
bit of pages in Jekyll but they have the
matter
in the top on the top of the file while
you put them in a separate file here
which yeah I actually kind of prefer
well so and this is all server generated
but it could be done as a static build
as well yeah having a server here means
it's easier to see quick changes it's
not that make sense yeah so we can see
where a post is is built so that this
routes JavaScript and this is where all
the routes are the important one that
we're going to look at is this one so
this is the routes for an article so you
can see here it's it's built of like we
get the number how the typical block and
half whole thing exactly whether we're
dragged X or whatever that's not even
the proper it is reg X isn't it ha well
it's the one express users almost the
rhythm you can capture parts of the
thing and put them in a variable yep so
that's so that's the name of the thing
we're capturing and then that stood at
the red X for I see a number four times
and then the slug is a slug a word
that's used outside of like Django I yes
I definitely it's it's in Jekyll as well
Hugo uses it as well maybe they started
it but it's by now it's a de-facto
technical term even though I still think
it's fun to say so yeah and then it's
just going and picking up those files if
it doesn't find them at little frog 404
okay cool picks up later on and then
it's gonna pass all of the details it
finds into a templating engine the
content is password marked which is a
markdown yes sir and that will appear on
the page the templating system I'm using
his nunchucks oh that is an
implementation of an originally Python
templating language isn't it so you can
see I'm going so Cottenham chuck's oh
well in Python it's ninja so I'm coming
from Django templating languages because
you're really really lazy aren't you it
is actually true like if you're lazy
you're gonna automate whatever you can
automate so and that's what we can see
here so sorry this is a post and it's
just all of the stuff coming out there
and yeah
and that works so in its current state
you're doing the the app shall stir
on the server you probably have like a
header or footer yes and that is being
stitched together on the server side in
an entire page is being shipped yeah so
this is the base here and like biscuit
biscuit base look you need a new set of
catchphrases now you've got someone else
here so yeah you've got these blocks
here and you can replace those blocks
another template I see and that's how it
works
so if we're gonna add a service worker
to this project well indeed any project
step one has to be get your caching
fixed get it oh yeah wrecked and I try
to skip that for this I thought well I'm
not gonna I don't have to talk about
lots of like normal HTTP caching yeah
I'll just hack around it and as I kind
of realized that I'm writing so much
code working around bad caching I should
follow my own advice list will get okay
it was actually really good advice it
would cost we keep seeing websites that
use caching trying to work around
caching or rather than fixing it yeah
and try to do is we like cache busting
whenever you have to do cache busting
that is a smell like you probably just
need to adjust your caching headers in
the first place absolutely yeah and so
that's what I did I know that's kind of
pre-prepared because a lot of sites have
this sorted already so we can see that
the CSS there the picture of me it all
has a version number there in in the URL
so you know that's all taken care of the
CSS what anything with a version number
in the URL is cache control for a year
whereas everything else with static URLs
like the actual HTML itself is cache
control no cache that makes sense so
actually I think we have the microchip
coming up on this on this topic as well
so keep your eyes on the trail which
also means you should totally subscribe
to this channel so if you know when
these videos come out so professional I
know right good so the first time I'm
doing this like and subscribe excellent
in case you're wondering the code is
also it's the code gonna be on github
later can we do put it in our John now
so yeah the the bits we are writing
today or the Jake is writing today I
gonna put it in the typical UI elements
apples repository that we have for
supercharged episodes I'm going to link
to it in the description so you can find
that later and follow along if you want
like reiterate what we've been doing so
shall we add a service
worker to this project yes yes let's do
give you 20 seconds ya can encode while
on camera that's questioning because I
can't code in real life so maybe the
camera will help so I'm gonna create a
territory here you have the first
question actually and it's something
that has some stank whenever I watch you
work is something been driving me mad
hmmm does Jake know that you can press
command alt I to open dev tools no I
never do that
I always go for the right-click I been
driven mad by this as well before he
always clicks my type with one finger
alright if you're gonna start with the
serviceworker yes yes so and i'm just
apparently it's actually written from
scratch which I already can't type look
at this well to be fair you still have
lot more typos in your quota until
you're actually worse than Paul okay
fair so so it's not that I'm bad at
spelling it's that I have race
conditions in my fingers from my brain
so there we go excellent okay so now I
know this isn't going to work
right because I haven't created a routes
for it yet so I'm going to do that now
oh so you don't have like you have
noticed the static middleware it's not
involved at all so I do use a static
middleware but the static auto static
files are the ones that are getting the
version number added they're not
offending Lee yeah so I've got a static
folder here and then the builds a build
system that there is it's kind of going
in sort of renaming on and that allows
you just sort like an exploration it of
like a year on it because if the file
changes the name will change and that
means it won't have a clash and an
important detail is that you don't want
to do that with the serviceworker you
want your serviceworker to be no cache
because like the browser is going to go
to that same URL where it previously got
the service work out to look for updates
so you don't be revision in it every
browser has like will recheck after 24
hours this no matter what the caching
header is but sometimes that it's
already too long because sometimes a
person might be stuck on the old version
of the souther cover 24 hours yeah if
you break your site you don't it to be
broken for a day
so yeah so I always use no cash so I'm
going to stop right here
Jas and there we go see already getting
a lot of things wrong right so I want to
serve up that final so I'm going to
create an input I'm going to use stream
straightaway we're gonna drag it there
for that so and I'm going to get the
directory name go up one level because
we're currently in this server directory
are you gonna do any processing on the
serviceworker file why don't youwait why
don't youwait alright like I've got I've
got some notes and the only reason as I
always do response dot send file ah yes
which is a lazy way but I feel like if
you're gonna do this and then you
probably want to do some processing at
some point that is true so I and yes so
I'm doing sort of streaming stuff now
because that will become useful later on
well so I should just be able to pipe
like that and just to be clear I don't
know what he's doing today I have not
seen whatever he's gonna do with only he
knows
well I wouldn't even go that far maybe
he does so yeah we now have like our
service worker all connected up so we
should get to actually do something yes
you would actually have to include it
yes we'll do that as well yes we do that
first why not I mean it's interesting
because I when I first learned Service
Worker I was like can I do console logs
will I see them it's a different thread
right it's like independent but it turns
out as we will probably see in a couple
of seconds that you can do console logs
and see them in dev tools spoilers I
mean it
imagine how developers feel if they
couldn't console.log yeah personally I
don't ever use a debugger but I use
console logs and I actually have a lot
of beef with the name debugger because
it doesn't actually debug the only thing
it does it it makes it slows everything
down so you can watch a creation fall
apart over a long time so you can find
up with a who the culprit is and it
turns out the culprit is always yourself
absolutely you might as well just
replace with its you you
so what I've done here is just in the
the base template which is used by all
of the pages I just put a little script
tape on there that's what's aggressive
enhancement I think yes also with the if
statement to four browsers that don't
support serviceworker that's that's
there to catch those so yeah we should
now be able to see in the console ah
interesting yes okay so scripts don't
have strict mime type checking yeah by
default module scripts do and service
workers do as well and I haven't
actually set up a a mine type for that
so back in the old roots I am going to
set the content type of editor so
basically it says work available but
you've just straight up declined if it
doesn't have application slash
JavaScript as its content type header
absolutely oh well it needs to be one of
the valid JavaScript mine types but yes
so the idea is it's it's a security
measure because we don't want like if
you have an XSS we don't want someone to
sort of be able to admit you know taking
one of the things they made a text or a
post or something and to be able to
register that as a serviceworker
so yeah we can see now we have we got a
console log console log excellent is
that suppose you want something more
than that
that's book offline yet the console log
will amazing but so far that's it
okay you want something working off like
a let's let's do that so we're so it's
working you get a fetch event for every
request for one of your pages but also
for every request from those pages yeah
so I'm going to I've recently read some
of your code and I I for some reason it
is totally ingrained in my muscle memory
to always type self dot add event
listener and self dog skip waiting
whatever it is that it's not necessary
self is basically the equivalent of
window on the main thread everything it
is defined on self a window will just be
available without typing out self or
window and I find that developers myself
including entirely inconsistent on when
they put like you know what the start
and when they don't so what I'm doing
here is I'm just going to respond with
fetching the thing that the browser's
asked for so yeah that will be just kind
of transparent to do the normal thing
but I'm going to catch it in case it
doesn't work okay offline would be one
of those cases and I'm going to create a
new response and just say thank you is
offline ah so when it fails the cat Chan
LOH will trigger yes well it's had just
returned with your reflect exactly so
now we have basically it just made the
blog work offline yes kind of well
there's one thing that we need to sort
of watch out for so we can see so this
is the serviceworker that failed because
of the the mime type so yeah just get
rid of that this is the serviceworker
that work they're using now now if i
refresh the page what's going to happen
is that new serviceworker that we just
added is going to come in
yeah it's going to be waiting to
activate so service workers by default
they don't get rid of the old version
while while it's still in use yeah and
it's still in use by this page why is
that though like why can't this take
over so another thing that as developers
we don't really like handle very often
is the idea that we can have like three
different versions of our app running at
once
just imagine what what apps I guess
write in multiple tabs where one's been
open for a while you open a new one
that's kind of using a new stuff people
have opened so many tabs that you can't
even see the favicons anymore have icons
and then you just open a new version
because you forgot it's already open
somewhere else
well yeah when I get to the point where
it starts looking like a table of
elements yes that's when I abandon I
decided to just close them all if I
don't know what they are well I really
miss them not really well the answer is
usually yes but so I'm gonna skip the
waiting phase on here and we'll be doing
that with code shortly but now we should
have a site that works offline
so if I click offline on there and
refresh the page since he was offline
there you go
perfect ship it we don't do you want I
want more well they're not streaming yet
I mean it is kind of streaming but not
really not really streaming at that is
first we have to hold up that promise at
least I call this episode done so right
I guess we should do an offline page
that's like within the style of the
lines maybe has some design to it
something like that's good so I'm going
to create that I'm going to create page
let's have a look so just in the
templates here I'm going to create
offline I'm just one of the things I've
already got this is the the template for
the post that I'm stealing the title of
the page it's gonna be offline all of
this header stuff like the meta
properties don't need that a title just
like you are offline excellent and the
content we can just say like please go
online please go back how do we want the
user to solve this like try refreshing
while around there we go which is going
to be especially amusing if they're
actually on desktop when they do this
because they're hitting refresh and
waving their phone around all that their
captive portal yeah so this is I'm not
going to create a route for this because
this doesn't need to sit at a constant
URL this can be a static asset that's
what yeah okay I go along to the
terrible build system I ended up making
for this project which almost certainly
should have been built or webpack or
something instead but I thought it would
be simpler to build it myself
okay that's probably the most Jake thing
you could have done
oh it's so much of my time I shouldn't
have done it so yes I'm going to add
offline dot HTML I'm going to send it
into the static Rev path with all of the
other relevant assets and I'm going to
render out a templates and it's the
offline one so when I save that well
hopefully cuz the server is going to
restart when it sees that code changing
and if everything is worked we should
say yes so we've got like offline HTML
there so maybe we can see that it's good
they've got all of the called a nice
markup and everything cool excellent so
so we can see it in the browser you're
lazy what you would remember that what
is it
six
right okay so let's see sir oh look
history Oh clearly done this before
right and and that is a much better
offline page then but we can currently
only access it online which doesn't feel
quite right defeats the purpose just a
tiny bit so what I'm gonna do is we're
going to take this page offline music
yeah sure but not just the page itself
we've got these other assets as well so
we've got the page we've got Nate the
CSS we've got this picture of me that
should be available offline I guess and
these social icons as well I personally
would be very happy if I could look at
your face while offline well you can you
know me that's something we can just do
in the same room together okay so I'm
going to we need to cache this page so
go back into the gang it's gonna
straight-up hard code the assets that
you're gonna cache or are you gonna like
analyze the mark-up mmm I guess I'm no
no no you're right because you this is
the problem we're going to have because
if I hard code all of those assets yeah
then I'm gonna have to change them every
time we make a small change true because
the revisions are change as well right
yes exactly so what i'm doing here is
event wait until which is it so the
install event this runs the the first
time the browser sees this version of
the the serviceworker
okay and it's our opportunity to get
everything sort of ready before this
sort of starts actually controlling
pages so cuz I'm from the future
I'm going to use an async function here
so what we want to do here is get hold
of a cache so we have a question are we
going to use any tools like sw-precache
or work box no no and the reason is
pretty simple because this is not about
how to use library this is about we want
to show how these libraries actually
work what they are actually doing under
the hood so you understand the concepts
more and then it actually is easier to
use these libraries because you
understand what they're doing and how
you can debug the things they're
supposed to be doing versus what they're
actually
yes and also as I said Jake actually is
one of the spec authors of serviceworker
so it would be a waste opportune you do
not actually talk about the low-level it
the actual API halves of the core itself
and using a library instead but these
libraries definitely have a place so I
encourage you to check them out and make
a decision for yourself if you want to
for production go this wouldn't write
yourself or rely on a library that is up
for you to decide yeah absolutely
yeah I say I just wanted to go you know
as level as possible with your stuff but
yeah we now hit the point that you were
talking about of like how do I get those
Urals and when I originally was playing
with this kind of deciding how to do it
and actually how I did it on my blog is
I just used the templating engine that I
had sitting there oh oh so beta itself
is the product of running through a
template engine you can add the
revisions dynamically but what happened
was it messes with all of the syntax
highlighting the linter is like oh yeah
I've been there
this is bad I saw actually you would
writing JavaScript PHP yes I just did
that yesterday and I'm generating
JavaScript with PHP and that is also
just in terms of syntax highlighting and
like templating and template strings and
JavaScript it just gets weird to keep
track of what is a JavaScript variable
what is a PHP variable can get really
really confusing so a kind of solution
around how my notes are falling on the
floor but how could I buy any continue
loud would be small Frank quickly if I
didn't notice no one noticed so I'm
going to use static module No so this is
a module by sub stack also did
browserify yeah oh okay so browser e5
was beta I think one of the first
projects to make to convert packages
with a note ecosystem to run in the
browser yes because note would use
require and it doesn't exist on the web
platform and so it would need to like
somehow handle that and that was the
project browser if I I think yes and I
think module kind of has has parts of
that going on because you can you can
pipe a JavaScript thing through it yeah
and you can sort of modify parts of the
of the JavaScript and quite AD well I
think it's quite a nice usable way so
I do static to cache and I just just for
demo say comes can help or hello now
once I do that these modules are
available inside my JavaScript okay
right so because I don't like typing
very much I'm going to copy that
so enough at the top here I'm going to
do const to cache and i can use good old
require statements so if i've not messed
it up
why should be able to do here right and
we can see that whole require statement
has been replaced with also 80 in lines
absolutely that is nice okay it's my
love it's like if you're doing something
more involved and i think i web pack and
things sort of do this better but if
you're just wanting to make small
changes to you know you don't want to
bring in the whole of web back in i
think this is a really nice small way of
doing it and that reminds me something
we've preached probably every time and
haven't done yet is this is not
production ready code oh yeah we are
gonna write something that works
you're gonna write something that is
hopefully understandable and i should
say we it's Jake this time it's
something that you can read and
understand concepts a probably that
shouldn't be pushed straight to
production there's lots of polish lots
of lots of safety measures that we're
probably gonna skip on to keep the code
terse and readable yeah and I actually
one of the the things I'm doing here is
like going processing this JavaScript on
every request as part of express is one
of the things that would not do in
production you would if you did that on
the server you would at least cache it
so you're not doing it every time or it
would be part of your build script and
and static modules compatible with all
of that source stuff you can use gulp or
or whatever to process but right we
don't want to just output hello we want
to output like all of the stuff we want
to cache so let's do that then someone's
going to create an array of the things I
want to cache so okay let's go for so
these are going to be the file names
with out the revision right because what
I can do then is map it across as I've
got like the thing which did all of the
revision
keeps a hash of all of those things that
it did so I should just be able to do if
you're looking for the ref package that
Jake is giving you can't find it because
he wrote it because why wouldn't he
it's gonna be in the repository later if
you're wondering how are you did it's
probably just tedious to write not
necessarily very complex I imagine it
was yeah it was one of those things that
I felt like when I was half if you're
writing and say I should not have done
this I should have just yeah because it
sounds deceptively simple just you know
hash the contents and put it put it in
the name but I've been there when you
have like cyclic inclusions or whatever
it gets really weird and and I didn't
solve those problems so like yeah if you
want to solve it properly I would say
definitely use webpack yeah there's also
gulp Rev call prep replace yeah that's
program for the most the older project
has been doing it for a while we're just
add these kind of revision hashes to the
name and Django has their own and I
think Rails has their own as well for
doing the same sort of stuff so we can
see that that's us being output so you
know I gotta do the same for the rest so
basically you're gonna add a list of
assets that you know we are gonna need
anyway to be off line the veteran
probably the very minimal set yeah it's
just that just the stuff that appeared
in the network panel when we looked at
that offline page okay and then the
revisions gonna be edit then we can just
use the vanilla add all cache command to
just have them all be cached and be
available offline absolutely so we can
see that now like all of those NS I can
you actually call the picture Meade or
JPEG well you know it's not Jake doe
JPEG it's not avatar it's me no one else
is going to work on the code base of my
site so itself no it's I'm gonna confuse
anyone okay so yeah we now have that
variable there and as you can say can
just like yeah
off we go that is actually pretty cool I
did not know about this more you I like
it I love it but we need to use it like
we've sort of we've cached all these
assets but we've not told the browser
and they've gotten so straight to fetch
and therefore astray to network when the
request comes in
absolutely so I'm going to do another
async function because I
all of them so yeah respond with and
wait until they take a promise and with
install if the promise rejects then it
will throw that Service Worker ways like
how this failed and with responder if we
want to eventually return a response
object so async functions are a nice way
of being able to do that and it
functions it's just so much easier to
think about these things so I'm going to
do cache response here caches match
let's go for event docs request so here
I'm just saying hey do you have anything
in the cache for this thing that's been
requested so and if something because
it'll it'll be null if it doesn't find
anything so which is fall which is
something that I always have to remind
myself of because sometimes I expect it
to throw em or treat to reject the
promise but that is probably just for an
actual error and there's something that
being cassius with an error is like kind
of like an expected outcome which is why
it's returning null instead of throwing
but I tell you what does throw and
that's fetch vegetable throw yeah yes
because if it's a complete failure to
fetch so it's yeah it will it'll throw
it's a promise sort of reject in async
functions that that becomes a throw so
so somebody asked how does that type
code actually work I have not used pipes
before those are as far as I know the
the old stream implementations of note
so note had streams before the web
platform did yeah and they had this
concept of streams that you could pipe
into each other I mean the web platform
now has a similar stream but the API is
a little bit different in terms of
piping yes but if you want to know more
about those look of the note
documentation on there streams just
Google for node and streams then you
should probably make that you go yeah
readable stream writable stream and
transform stream that's all in the in
the node Docs okay so yeah it's just
kind of it's piping those things
together but rather than passing the
whole free thing it can pass little
chunks of it along and sort of process
it in little parts that's kind of really
nice and memory efficient so I've kind
of hit a little stumbling block because
here so I'm trying to fetch the thing
and if that fails I want to return with
that offline HTML yeah that makes sense
but the best I know of the URL is
offline de-aged oh you don't have the
hash once again don't have the revision
so this is where like the static module
stuff is he even more useful so what I'm
going to do here is create static so
you're just using as a glorious so you
can keep it some text hiding while just
using it more or less as a templating
engine yeah that's great isn't it I mean
this is well Paul would say it works so
ya know so here yeah I've created a
function Rev get which is just going to
sort of pass the other thing is like
yield give me the revision version so I
can just do here Rev get equals require
you don't have to call all of these
modules static at first I just do to
kind of saw when I look at the code I
kind of know which stuff is coming from
like the static build system rather than
stuff that's going to be left there
interesting question mmm-hmm why return
a weight fetch and not just return fetch
that is a good point very small neurons
yes because if we return fetch then what
it's going to do is it's going to pass
the promise back yeah even if the
promise rejects we wouldn't know if
fetch had thrown or not it would just be
a promise that it rejects but we want to
be aware of a rejection because we want
to catch it with a try-catch so we can
handle it so that's why it's return to
weight which looks a little bit odd but
you get used to it fairly quickly yes so
now if i refresh the page right we can
see the sort of static revision there
the offline thing is there that's let's
I'm both amazed and disgusted by your
use of static module well it's better
than PHP template isn't it so so let's
have a look now so the the serviceworker
should have updated because I've
reloaded page okay so we're it's still
waiting to activate here yeah like I
said that if you've got multiple
versions of your app running especially
if you're dealing with data you can end
up with the old version and new version
clashing and creating problems we don't
actually have that here because it's
just a simple site yeah so what I'm just
going to say here is skip or waiting
just call that as a function see I I
would want to write itself skip waiting
but it's totally unnecessary you can
just ask is waiting saving those bytes
so
we can see the installing one sort of
takes over instantly and what should
happen if I go offline it hit the
refresh button right I mean kinda so
work we're halfway there
so what has gone wrong
interpreted style sheets but transferred
with mime type text HTML well do we
actually block style sheets and then I
don't have the right mind type I thought
we I think it could be yeah I mean let's
look at the network panel if the files
are I mean yeah so there is an all dot
CSS being successfully received that is
a serviceworker trying to fetch it right
yes yes so oh that's interesting so it's
it's trying to do that it's not finding
it and it's falling back to the offline
page even for the CSS so everything is
returning that that oh yeah yeah we
although I'd want that so if we go
online with this what happens here at
work so the URL is correct so it
suggests that something is going on
either with the caching or with the
matching so yeah so we got a cache
response but we just threw it away
yeah yeah I found it didn't return it
that's fine
oh ok I was getting nervous that you
still online so it doesn't count yes I'm
still still online everything says if I
go offline now it should work oh that is
much better good
oh and so like we're panicking mittelos
a little bit panicking I got there see
he has a cheat sheet but even then I've
got like error throwing sweats going on
okay so we've got this this whole
offline thing working now so that's
that's pretty good how many browser
support the async operator I think we're
actually in a really good state I think
all the current stable versions support
it off the major browsers yes let me
know a quickly check can I use on the
side but I feel like if you don't have
to go too far back a sink no is it oh
wait
racing functions it's everything except
Internet Explorer yeah
so at edge does 15 since since the most
recent version 15
ie 11 which is the last version version
of an explorer does not and all the
other browsers with the current version
actually do yes so I would encourage you
all to embrace it and use it makes all
especially with soccer it makes the code
much more easy to think about and to
juggle the things in your head right
okay so let's let's have a look at how
we're doing with this stuff because one
of the things that I'm not happy with
right now is that we're opening this
static cache right and that means like
when we're updating the version of that
it we're just gonna be writing into the
same cache which is not so great
yeah and so that means that the newer
thing is going to school might be over
writing things it might be messing with
stuff so what we normally do is
something I sometimes struggle to I I
always keep reinventing in my head if
you install in the serviceworker do you
want to redownload do you want to see
what's in the old cache and manually
carryover and all these questions that
you get do we create a new cache or just
reuse the old one I mean it can get
weird in between states let's see what
what you're doing this time in this
version right so you can see on the
screen here I am
I made a version one yeah so and I'm
going to sort of add static version so
and that's going to be my cache name but
you want to require the version thing
because when it change it yeah so so
what I'm going to do here is say yeah
so updating this version number time and
time again that's going to be like
there's gonna be a real pain to do right
so yes
we want some we want to automate that
somehow so over in the the routes file
I'm going to generate a version number
automatically so what I'm going to do is
like I need a version number that's kind
of all of the it represents what's
unique about that sort of this worker
and it just so happens that we have a
way of doing that and that's with the
URLs yeah okay so this one I do now
so you can talk a bit while you can
describe what I'm doing and no he's
typing a Const variable again no so and
all decrypting wow that's actually a
standard node modules yes yeah always
stop touching because it says crypto and
Kryptos basically you never want to roll
your own so always rely on available
implementations for these especially if
it's actually security relevant which I
guess in this case it is not really but
yes so let's let's have a look yes it's
it's not roll your own crypto it's all
there already in an ugly so what I'm
going to do now is create a hash
question on the side what is the maximum
size in kilobytes or whatever that a
sorcerer can cache and that's actually
it's a very hand wavy answer I'm afraid
and it depends on I think the mate and
maybe you have to correct me here but I
think the most recent answer I have is
it is a fraction of your available space
on your hard disk yes yes it is so it
the what the service working cache is
part of like did sort of general what
can the browser cache yeah so you get a
kind of shared space for index DB the
cache API local storage all these sort
of stuff so right here is so I've
created a hash now it's md5 let's not be
too scared of that you know it's it's
it's just it's not for security reasons
it's not security or I learned even
though md5 is being discouraged for
hashing the contents and having a
somewhat unique identifier is perfectly
fine yes and so what I'm going to do
here is go through all of the URLs that
I'm caching so for each and let's go for
a URL and sort of hash dot update so
this is going to add all of those things
into their URL so this is you know
adding each URL into the hash ok and now
I'm going to create a version um from
that which is the hash dot digest and I
take in the hex of that and that can be
the version number for the serviceworker
also creating a version number depends
on your on the ascetic files that you're
hashing they contain a hash that means
that your version number will change
even if only the version of one of the
dependencies change yes I'm sweating
quite a lot it's warm in here isn't it
it's it's it always is you have to
imagine we have some lights because
otherwise it would be fairly dark
here but I guess I've gotten you stirred
at this point we can keep the the camera
on the screen so you can't actually
dying here right so I'm going to do a
static version here and what I'm gonna
pass through here is so the reason
you're doing this just to reiterate that
I get it right is you want the version
of your serviceworker to change whenever
one of your select file change because
you want the serviceworker to redownload
all the files in that case absolutely
absolutely okay so so the problem would
be if we didn't change the serviceworker
fall I think they'd always still do the
byte equivalence check it is byte
equivalent yes and that's what it's like
I've always been and that's kind of I
swear things will stay at any terms of
that so so this is a nice way of making
sure that all of that byte so if you
have it installed it's gonna try to
redownload it the next time you visit I
guess and compare the code of the
serviceworker fell the main size like a
phone if they are byte equivalent maybe
the exact same file nothing is going to
happen if the dependencies have changed
your certificate wouldn't know about it
all right that's why we want to make
sure that our service worker code
changes at some points if our
dependencies change and that's why this
we basically use the hashes of our
dependencies in the version number so we
can make sure every change not only of a
certificate file but all the
dependencies will trigger a redownload
of all the necessary data
absolutely so now we can sort of see
here inside the serviceworker file layer
we've got that version ID there and
that's going to be used in this the the
cache name and that's going to carry
forward into the into the serviceworker
itself so now if we load the page that
new service worker is going to come in
and I'm going to refresh the caches here
I did see yeah I did not know that we
had a right click refresh because I
always reopen dev tools exactly close
and reopen it yeah I didn't know that I
was wow I learned something today
right amazing but you can see there's a
problem here right like we've got the
the static cache name has got this sort
of long hash at the end of it which is
what we want but the old cache is still
there so I'm going to go over into the
serviceworker code again and we're going
to fix that so I had event listener
so we're gonna use the activate vent so
install is basically the sir circa file
has just been downloaded and you can
hook into this event and run some code
to make yourself so set yourself up
yes activate is once you're done
installing in the source workers
actually about to take over
responsibility for all the requests off
your sites that is where activate comes
in right yeah so at this point we know
that the old service worker is gone
so we're in a good position where we can
actually start deleting all of its stuff
that it needs I see
so let's have a look I'm gonna do keys
so what I want to do is look through all
of the caches that are there delete the
ones that we don't need so if I do the
weights keys here we go so that's all of
those now sorry list of all the caches
that are currently yes available in your
caches API absolutely so I'm going to go
through each one it's right over them
and if I find one that is so if key
doesn't equal the cache name that we're
going for so basically you're cleaning
up after the old service worker you are
the new one you know what name your
cache has and that means all the other
old caches can be removed because you
are already done installing yourself
absolutely ok I understand okay so yeah
you can see that initiative its what I'm
not expecting just gonna get rid of it
and so hopefully now if we reload the
page we should have a new one and the
two other ones should be gone that would
be expecting right yes so if we go into
here and I knows what's happened
excellent
so yeah things things are looking
correct in the right shape it does look
correct yes so that means that you know
when we add a file to the cache it's
going to create a new cache for that
like static with a sort of new hash at
the end and then it's going to delete
the old one once this one says ok we got
two questions one of them go why use a
weight on cache keys is that async yes
it is yes it is because the keys is part
of a debt stolen disk right yeah so
anything that's stored on disk we want
to make sure it's not going to be
blocking acing my closet IO operations
on the disk are tend to be very slow and
at least in in terms of web time budgets
that we have so
we based I think actually almost all
serviceworker api za racing just so we
can has attributed to defer work a
little bit until the browser has time to
actually get to it absolutely absolutely
so we kind of we've got a nice sort of
streaming well it's you know it's not
streaming yet but we've got this nice
offline page and we're controlling our
caches now but this is the point where
we want to start thinking about the
streaming stuff right yeah because right
now it's still just entire pages being
cached yes actually not even cache but
yeah yes if we think about the the pages
that we've got we can see sort of the
you know this column here is always the
same yeah so we could we could cache
that and we've also got the header along
the top here this is static as was very
complex blank block yeah that tiny bit
there well you know there's also the
Jake article wrote you know that's where
absolutely so it would be nice to
deliver that before the network so
that's something that I want to try and
do here so we can you know deliver that
bit and then start streaming the network
stuff through a pattern that you might
have heard of to do this is called app
shell yeah so app shell I'm gonna try to
explain it and you tell me if I'm right
all right all right um basically in the
most primitive form you have your header
bits and you have your foot a bit and
then you have your content in the middle
but that means that you never have to
actually redownload the header and the
footer I can just get the content in the
middle and swap that out for the new
content yes and if you do that on the
server side it's AB cell if you do it on
the client side then it's basically SP a
single page app kind of routing thing
absolutely so if you take a look at this
example here we can see that the it's
got this little gap of where the content
would be yeah and a typical way to do
app shell would be to like to cash this
display this and then let JavaScript go
and sort of fetch all of the content so
while the fetch is still going on we are
on like a very slow network or network
with very long delays mmm the user would
already see this and be reassured that
actually something is happening at the
network is working and something's being
loaded but it just takes a little bit
longer and that's why this why the
streaming sorcerer is such a good user
experience because you can see something
happening on screen for free right and
yeah and the actual model the problem
with it is that people like
if javascript is handling that fetch it
needs to download that whole article and
then have JavaScript putted it and
that's that's where things get slow and
I have a demo of that it if we get to a
position where we can do this one they
kind of correctly we can compare it to
the traditional app shell model okay so
the first thing I guess I need to do
this is I need an endpoint that gets me
just this sent of it because if we want
to do app shell
we don't want to redownload the header
that's the whole point so either way to
get just the middle bit absolutely so
I'm going to create a template for that
so down in my template system here I'm
going to create a new file and that's
going to be post Inc I'll do an JK I'm
not very good at naming things I don't
know why I design ap it sort of the
hardest problem in so I'm just going to
copy what we have for the host template
here and the things we don't need is we
don't need this extends but we don't
need any of this head of stuff in fact
we don't really need the the main
content here I'm just going to move that
out so this this is the only bit we need
so now we just need to kind of come up
with routes for that so if you render
that template there's basically the
entire header it's missing we have no
header or footer it's just gonna be the
mark-up by itself is gonna probably
gonna look really good because it's not
going to be styles there's gonna be you
know no layout whatsoever but once put
into the context of our header and
footer it is gonna look great yes like
just as it's supposed to be well we'll
see I'll take great we'll see if we can
get there
that's so here in there in the routing
system again what I'm going to do is I'm
going to I could create a whole separate
route for these includes but I'm kind of
cheating a little bit and what I'm going
to do is put a little include bit at the
end there and the red X for this is
going to be the word include and so it's
literally can only be that and it is
optional and check out these hacks so I
love it already the template name is
going to be request params dots included
and if that's there we're going to use
post Inc otherwise I'm going to use okay
and that's pretty neat I mean so you
switch depending on what the inputs are
the include
option is present in the request URL or
not your switch or the template is being
rendered absolutely so okay I mean
assuming it works right yes
so the good news is no errors on server
so far this is the normal pages I'm fine
and if I go to include styling if we
look at k2 command alt you let's say
command alt and you gotta teach you some
shortcuts so you can actually view the
source and you can see it goes start
straight with a diff it's like this all
the other stuff it's missing and now we
if we put that in between the header and
the footer we will be back at the
original page yes so yeah so now we just
need to kind of do the rest we need that
the kind of start and end that we want
to you know the thing to wrap it all up
around so we need to create a template
also for the shell though the kind of
the inverse of that the this page but
with that bit missing so that do it as
well and it's very similar to before I'm
just going to call it let's call it
shell or even spell it right and let's
have a look now so I'm going to take the
post again it's a nice thing now view
from report everything else except yeah
it's a bit exactly we're gonna come up
with a title of loading because this is
going to be sort of displayed initially
I see we don't need all of this head of
stuff and this main content we can get
rid of it because that's the post we
don't we don't have that to display yet
and this is where we're going to put all
of this stuff okay there we go for the
people doing a little bit later hi this
is a super shots live stream and we are
doing streaming service server which
basically allow you to stream your
responses to the client meaning you will
be on screen much faster and give your
users a way better experience without
having to do any sort of tricky because
usually the network does it for free but
once you have a source paper in the
middle it is easy to fall back to easy
habits and remove that feature of the
web which is streaming yes so if they
like what we did with the offline page I
need to put this shell into the static
yeah cash
so you know here we are in that little
bill system again I've copied the line
and I could just even with the cursor
I like multi cursor I do it as well but
the problem is it's like it's not
actually what we want because I what I
want to do is I want to start and I want
the end right now it's both right and
right now it's both
so I love this so I'm already afraid of
what you're gonna do this is so let's
let's take the actual content of the
show okay so it's there and the slice
point is going to be content go here oh
look look it's there look look so we're
gonna split on that that's fine
development this house comment that I
thought was just like you know to guide
you is actually now going to become a
programmatic instruction of where to
split the shell into header and footer
bits because why not why wouldn't you do
that so here we go we've got shell
starts and so what I'm going to do is
see shell shell dot us nice and I'm
gonna take the shell dot index of and
it's going to be off that slice point so
that's actually going to give us the end
so I want 0 there as well and I should
be able to copy that and I see end and
just remove that there and if everything
works then we can see that we've got
your isn't you add the length of slice
point right comments ship to production
because it's a waste of bytes so what
Sam is talking about is like in the end
there it's got this this comment sitting
there so let's get rid of that here we
go
plus slice oh yeah it's nice pointer dot
and now feel much better
are you happy now yes and we can see
that I saw that update and there you go
perfect that's the perfect okay so now
we just need to start to read cache
these so now so we'd
than we have in the cell circuit and
then we can actually start stitching
things together absolutely cool so if we
want to add extra things to cash in the
serviceworker
we're doing that in routes right now so
I'm going to continue to do that so
let's go to shell starts and shell and
there we go I always like to just double
check that this is actually working
Jess and we can see yep so we can see
those things there cool that's all
working so that means now because
they're in that list they're gonna get
downloaded on it so soccer installed we
have them available the cache and we can
use them to now do that's gonna be
written see we can do the server-side
rendering in in the server yes yes it's
kind of it's a serviceworker when
service worker side rendering that's a
thing that's that's a finger okay so
this is going to require a little bit
more code in over in our serviceworker
the first thing we want to do is kind of
identify those pages that were actually
yes this streaming thing with because we
don't want to put like images in between
our headers and footers right right
so and the easiest way to and this is
one of the things where things like it's
serviceworker toolbox and all of that
sort of stuff come in really handy but
we're not using them so we are purposely
reinventing the wheel a little bit
because you can't appreciate what these
probe work these projects do for you
until you have done it yourself
absolutely and so I passed the URL out
here using the URL constructor which is
kind of part of the web platform and has
been for ages and that will give us
access to all of the different parts of
the URL so what I'm going to do here is
before we're gonna treat the rest of
this code here is are sort of the
general case yeah that's how we're gonna
handle everything
I always feel because I see when I write
so circa I do the same thing I often do
a new URL to get an actual parsed
version yes why don't we why is that a
part of the API um because all of Uncas
trans said no I I think it's more of a I
mean it is work that can be safe they
don't need to do it and then it can get
the developer so I kinda can see that I
just I see myself doing it so often I
was wondering so an affine castrum wrote
the the
expec yeah and so but he has a good
point actually that all everywhere else
through the web platform we only give
the URLs a string because for window dot
location our soft obligation okay which
is a little bit of a special case to be
honest yeah I think so it's it's
consistency and you always have to
actually do it yourself anyway so yes so
the first thing I'm going to do is like
I said the the service worker gets fetch
events for requests the page makes yeah
and that includes requests to of origins
as well that's actually super
interesting because you can cache
requests and responses to another origin
you just can't inspect them right
correct yes I mean if the request yeah
you don't get extra uses course everyone
uses cause it's brilliant it's they have
a security if the web works so I'm doing
an origin check here Simon yeah
everything that is your origin yes Megan
is compare it straight to location
dollar okay but then I'm going to have a
look at the path name so your path name
there we go I want to see if this looks
like one of our articles I'm gonna use
red X because because you already had
somewhat of a red X in your back end
where I was like you want four digits
for the year and then some title yes
so I'm going to do that I can never
remember with red X which way around the
symbols are is it and then yes I'll
start and then excellent you don't want
those either way around else it never
matches so it starts with a slash and
then it is as you said well we could we
could say PP specific it's four digits
exactly four digits I don't expect my
blog to be around once we take over to
five digits on the go or have blog posts
from pre year thousand what will what
will the world be like then and then the
rest of it is just anything that is not
a slash okay I love rackets I mean
that's totally readable right that's
that's yeah yeah go tomorrow get this
and be like I get it I got it yeah so if
that happens I'm going to defer to into
a function like that's a whole stream
article there we go
I'm gonna pass in the event and URL
so and this is the function were gonna
write sort of deep lady that's just the
stitching of the app shell it's the bird
I was yes absolutely that but let's I
mean we've been writing a bit of code we
haven't tested it for a while so and the
site node Andrew Betts hi he has a
question um event dot wait until when to
use it any rules of thumb and yeah
didn't what is your take on that
so you use event wait until whenever
you're doing asynchronous work and this
is this tells in some cases it's the
return value is meaningful so like in
install if the the promise rejects then
that tells a service worker this
installed failed right something went
bad either we failed to catch some
things or like there was an error thrown
or something and the browser will see
that as an indication of like I'm not
gonna use this service work which it's
probably good because if you have to
work on like a broken basis to bootstrap
your page your installation should go
flawlessly otherwise it's better to be
like absolutely it's not yeah and that's
not a good reason to use like unique
cache names when you're updating because
you don't want to kind of do half and
install it botch it and you've already
messed around with some of the stuff
that the current versions using so
whereas with activate wait until is just
a signal that you're doing work yeah and
then it will the browser will prevent
fetch events coming through until you've
done that work a fetch it also has event
dot wait until it is a way to say look
I've sent the response by hey I'm doing
some extra work as well and that's
actually interesting because you can say
event respond with and already have your
response ready and then have to do more
work after the response is already given
out so try to get to correspond with as
fast and as early as possible to have to
get that out of the way so the client
the actual browser can continue working
and then continue with updating the
cache or whatever you want to do in the
background
absolutely absolutely use that in a
minute as well but first I just want to
make sure that all of the this stuff is
working so starts there so I'm going to
use a feature of serviceworker here of
our dev tools called update on reload
this is where my favorites in music
because currently we fresh the page and
then it looks for
an update to the serviceworker yeah it
finds it it installs it and then you
have to hit refresh again so you
actually get code running through that
new serviceworker this here means it
shortcuts that it just takes one refresh
it finds a new service so you should
have to reload it checks the seller get
downloads installs it what he had to
real another time type to actually
activate well this is just throw the way
the Altos are gonna be follow reload
download the new one and it's that one
gets installed absolutely so now we
should be able to just hit refresh and
that new service worker comes in that's
fine this is what we expect but if I go
to this article it says this is an
article excellent I mean it's it's
something of an overstatement it's mean
how much techs do you want in your
article but that what that does is it
confirms that were correctly identifying
that your throat reg X the cryptic one
is actually correct and we can see that
the includes it's not capturing those is
just what the the overall article page
so right this is where we want to start
doing the actual magic of tying all of
these streams together so what I'm going
to do is gather all of the parts that
we're going to join together
so do caches dot match gets and Static
so the first thing is the shell start
I'm using Rev get the first thing we
want to send back is the header because
we know it's always going to be the same
and we know we have it in cash yes
doesn't you need to worry about the
actual content right now we can already
start streaming that bit because that's
the the sort of generic part so that's
all working fine and we're going to do
the end as well but in between those two
bits we want to send the actual content
down yeah so I want to fetch and I can't
just fetch the URL here because that
would be for the full article page or
what I want to fetch is the include part
right so and that is probably where it
comes in that you just put something on
the end because you can just take the
request URL and add slash include well
I'm gonna be a little bit safer than
that oh look at you
yeah well because for instance if there
was a query string at the end like a
search string as the web platform calls
it
just adding include to the end of their
that could start breaking things so you
can see here I've done new URL URL that
kind of clones it so I've got a copy and
what I can do here is do pass name plus
equals include so now that is going to
add it to the end of that that URL there
so I can just fetch that and that should
work but now this is the part we want to
sort of tie all of those together yeah
so each of these responses from the
cache from and from the network are by
themselves individually streaming hmm
but usually I remember when I did first
when I first wrote this kind of service
worker I would just turn them into a
text blog concatenate writes sent them
back and that is not streaming because
that would mean I would have to wait for
the fetch to finish before I would start
sending the header right and if you do
that you're gonna have that whole
problem where you're having to buffer
the entire response before anything
comes through and that's that's no good
so what I'm going to do is so we want a
writable endpoint that we can sort of
feed all three of these to that will
turn it into one readable point so
because you know with a response you can
give it a readable stream like this here
instead of a string you know I'm happy
in that so what I'm going to do now is
I'm going to create a for loop where we
can sort of go around each of those
parts but first I need to create this
that's readable and this writable object
and there's going to be a great feature
in the web platform that can do this for
us so I can do a readable writable and
that's equals new transform stream now a
transform stream is think it's going to
take like parts like things in and took
something else out
it's sort of changing transforming the
response in some way but if you don't
provide any of those details
it just takes stuff into the writable
and pipes it out of the readable bad
news is we don't have that on the
platform yet so we're going to have to
sort of hack our way around it and I'm
not gonna write that now I have a hack
prepares thank you just this is an
identity tree so you know I don't I just
do this for the whole thing is this I
have a project register it's almost
gonna stitch together see you learned a
lot today hope you pay so the thing I
think it is absolutely legit to
copy/paste in that bit because it is
part of the part of the specified
platform just browsers having 2000
around to implement or actually the spec
is not completely finished as far as I'm
aware yeah they're still working on that
but we think where it's going to be
landed in chrome in the next few months
so like okay time some time before the
end of the year we'll wait and see
but this polyfill is doing here it's
creating a readable stream and a
writable stream and we can see here sort
of inside the right school when it
receives some data it's just passing it
to the so it's literally just like
whatever you receive put it out on the
other side it's actually yes yes and
that makes our code like so much easier
to write because now we're responding
with our readable stream but we're not
putting anything into it yeah okay
so this is where we need to actually
start creating that and so we want to do
a little bit of asynchronous work so to
events dot or wait until oh I see I was
wondering if you forgot to make this
function async but you're actually doing
an anonymous async function inside yes
and so while we're doing all of the
streaming work this is instructing the
browser like hey don't close the
serviceworker
we've still got important things going
on you need to let us handle this so
what I'm going to do is go through that
array that we've made all of those parts
okay cool let's call it parts because
that would be a better name so now I've
got each of those yeah you chose and I'm
going to get a response object from each
couldn't you use for oh wait yeah so
that's interesting
so there's a new thing appearing the
platform which I don't think we have in
chrome yet we don't Oh then examine
never might me I thought but yeah you're
right we could we could do with that and
that will process the the promise so for
your iterating over an array of promises
because both caches don't match and
fetch return a promise and with four
await it wouldn't for what iterate over
the array and give it the promises for
away it would give you whatever the
promise resolves to anyway yes wait with
a looping until that prominent is
currently that is the next one has
resolved
yes so yeah I'll check if we have it
well we definitely all have it in stable
and that's what I'm using I want you to
use canary but it turns out that this
morning all of the network throttling
and offline stuff is broken in Canary oh
that's cool so like like a peasant I've
had to go back table I know it's
terrible what a nuisance so okay so
we've got this response now for each of
these parts and what I'm going to do is
response dot a body which is the stream
of the response and I'm going to pipe it
to the rewritable and so that is your
pipe call that we have seen earlier in
the note environment it's yes similar
yes it's not the same but it's very
similar yeah so it's a it's
differentiated in web streams we have
pipe through and pipe - yeah which is
kind of whether you're dealing with a
transform stream or whether you're
dealing with a writable and I need to
await that because it's we're going to
let that happen and now by default when
you pipe something like a readable
stream to a rival stream once it's
complete it closes the right writable it
says I'm done now you are done as well
we can all go home it's a game but we
don't want that to happen here because
we want to write to all three all
rightie parts so there's an option here
called prevent close to prevent clothing
yep which I'm burying a well-named
option lovely nicely named but once
we're here we actually do want to close
it I mean you could do fancy things with
the loop where you detective it's the
last one I can do it I think that's it
is arguably more explicit I think it's
fine so yeah so here I'm going to do a
writer and get right from right a bull
get right thank you
I knew that didn't sound right it's a
writer will get writer and this is
holding a lock on the stream so we can
do stuff with it after all the piping is
done and then I'm just going to call
close so that means yeah okay so we now
that would mean that the response no the
writable should consist of the header
then the content and the footer yes to
the browser it would look like it is one
document yeah as far as the browser's
paws is concerned it is
receiving one response like the whole
thing about it being three parts that is
entirely inside the serviceworker
okay now uh hi just spotted a bug I've
still got transformed stream there so
let's change that for identity transform
streams can actually transform it can
hook in code and do some transformations
addenda stream is that what we said like
just whatever you get just don't do
anything pipe it back out yes and the
default for a transform stream will
behave like an identity stream okay so
so just to recap we are taking the
header which you have in the cache yes
we are taking the content which you are
fetching life from the network which
could be a little bit delayed or not and
we are taking the footer from the cache
again which are three individual
responses and these responses are now
being stitched together so that to the
browser it is one document but even if
the actual content is delayed we still
starting to send the header straight
from the cache and the good thing about
that is that we would actually see
something on screen even if our network
is being weird about sending or has
problems with actually getting it fast
enough to have like a fluent delivery
for the whole thing yes at this point we
can actually try and see if this works
or not yeah that's the moment of truth a
so let's let's have a look so we've got
identity stream we've got all of our
parts here it's all looking correct I
mean if you can just look at JavaScript
and say it's correct it was actually
actually impressive well I can't I tell
you what we should do we need a way to
sort of know that if this is working so
in the shell where it normally says
check our spot wrote it streamed no
that's that's working so it means if we
reload the page with also servers will
say Road if the circuit is actually
doing its job in between the road at the
top in the green box to turn into a
streamed and it did amazing look at that
that's amazing I'm so glad that worked
so yeah so what this is ah okay there's
a problem is your eagle-eyed spotted I
have seen the problem the problem what
so what we can see here is like what
used to be unicode well used to unicode
is man
yeah okay so this is a problem
sounds like you stripped a little too
many of the meta headers maybe that is
exactly it does the response here
there's no response headers at all being
what we really want is something oh
sorry why just did there is a shift
reload a command shift reload yeah that
passes the sellers record it was bypass
it's not just passes it bypasses the
sauce worker so what I can do here is
have a look at this so this is the
content header I'm normally sending so
I'm going to like I mean you could also
put it in your header and say meta
charset utf-8 right yes I could do that
but you know fine Jake but it's it it
seems good to have some proper headers
yeah right now we're not even telling it
it's HTML it's just coincidence that's
what the browser will interpret it as so
here I'm just going to do content type
and there we go and what should happen
so if I I'm gonna keep the okay I'm riad
so we're gonna get the new so I'll go
straight away so you should see it
straight away
I'm streaming we have the right content
encoding so we just built a streaming
sucker didn't we yes or you did yes we
did
it's yeah it's and I think that's all
we'd OH
there's one thing that we need to fix
and this is a problem that I I think we
need a better solution for in the web
platform okay and that's that we've got
this it still says loading up here as
the title for the page true Oh a
changing title that used to be all the
rage in the 90 would have like little
animations going on so and that is the
solution that we're going to use here so
it's just here in the article include
I'm just going to do a script oh it is
adorable and hacky it would be nice if
we could have multiple title elements
and that one would replace the other and
it would sort of updates you know with
whatever the last title elements it sees
is but what I can do here is just let's
let's go for meta titles this is coming
from the scripting the templating engine
and Jake Archibald calm
and so now that it's updating niceness
it's got a question it's not anything
like incremental cash update like
dipping or something like that
there is not but it's something that you
could build yourself inside the Service
Worker so you could be sort of fetching
stuff yeah that you could you know it's
a tell the server I have this version of
this asset or it has this hash or
whatever and then the server can go oh
yeah I know the history of all of this
stuff here is just the diff to apply
whether that's it's something that's
going to be useful in long tonight yeah
I yeah I don't know so just as the final
proof of this can you do this with
network throttling so we can see that
the shell appears right away but the
content gets dreamed it I thought you'd
never ask
and I think that's that's kind what we
should end on and have a look at what
the app shell compares to yeah this this
is the idea of content with with
JavaScript so let's let's put the
throttling all the way down to GPRS
because you know it makes it a little
slowest off the slowest well well it's
offline slower or is that just broken
it's nothing still something now we're
getting to a philosophical in here I
think so I've turned update on reload
off so it's not going to talk oh yeah
and I should just be able to the page so
you can see that was actually really
cool to see it and if you didn't make it
did you have screenshots enabled
screenshots are in a kind of can revisit
what we just saw namely that I think in
a matter of a fraction of a second we
had something on screen namely the shell
yes
like straight away from the solar course
and here's the header so we can have a
look here and you can see that so here's
the sort of paint time-shifting like so
kind of 65 milliseconds we got that yeah
paint of that top bit of content and if
we move along to where is the next paint
sort of around here so yeah that is at
one second that's when we actually start
getting the article content that's
coming from the network and that's the
bit that's being throttled okay and so
that's you know so yeah I'm gonna rely
on you to remember those numbers that's
about one second for a vanity audience
to remember this for Oh excellent okay
so if everyone can remember that stuff
what I'm going to do is I'm going to see
if I can remember
get because you see I've done a lot of
coding - get at ah with that work would
that be also files that haven't been
added to be indexed I do not let let's
let's let's do this I think so and I'm
just going to call this attempt commit
because we wouldn't you why not oh yeah
I haven't added my name or an ID so it's
now I need to do check out and app shell
excellence right let's work now the
service we started so let's refresh the
page so so this is now just I should
turn the throttling off because it's let
it update that Service Worker
so we should see that yeah that's fine
okay so for refresh the page it says I
AB hold some content excellent so that's
the proof there but it's it's actually
changed so now we can compare this and
this is that so the difference here is
it's loading in the shell all at once
yeah and then it's going to that
javascript is going to pick up all the
content from the same include and then
it's going to insert it into the page
say we should compare this obviously to
this it's over the same network speed
otherwise it wouldn't be a fair
comparison
absolutely so we've got GPRS on again
all the same sort of cache settings and
we can load it now so yeah you can
already see the difference there was
enough time for us to look up to the
camera and look confused why we're
looking at an empty app shell and yes
still going so if you have some kind of
single page app this kind of streaming
service worker worker can make the
experience of opening and loading
insights so much better yeah so we've
seen we got the first renders yeah that
was still quick yeah but the the final
render there was kind of like three
seconds or three four seconds in which
is and this is obviously not a full blog
post I think it's just some text if you
have a longer blog post with some media
assets or whatever it can it can get
worse absolutely we simply longer
articles I've got on this it took goes
up to like eight seconds whereas the
streaming one is always there yeah
much straightaway and it's also slower
because because you dumped all of that
HTML like right at the end that's the
point it discovers all of the images and
stuff it needs so those downloads start
also delayed yeah it is basically a win
all around so I mean that is how you do
I guess a streaming service worker and
just to be clear it's actually kind of
cool you just did that in stable usually
we are very prone to being on canary
with a web platform flag enabled and
doing all the leading edge stuff but
this works in chrome stay on actually
works in Firefox as well unfortunately
not they don't have streams yet that
mean so that's the that's their blocking
thing Safari doesn't have serviceworker
yes yes so if they could just you know
change some code yeah talk to you like
oh can we just soon I hope we will see
on a platform where everybody has
serviceworker and streams and we can do
these kind of performance tricks much
more often so as I said we're going to
put this piece of code that Jake wrote
gonna put it up on our github repository
yeah thank you so much everyone who came
by and talked to us in the chat and ask
questions I hope you learned something
and Thank You Jake for taking on the
challenge I think it amazing thank you
and with that have a good Thursday and
see you next time bye bye
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>