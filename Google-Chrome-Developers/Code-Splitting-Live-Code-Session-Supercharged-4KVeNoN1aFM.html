<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Code Splitting: Live Code Session - Supercharged | Coder Coacher - Coaching Coders</title><meta content="Code Splitting: Live Code Session - Supercharged - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Google-Chrome-Developers/">Google Chrome Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Code Splitting: Live Code Session - Supercharged</b></h2><h5 class="post__date">2017-06-22</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/4KVeNoN1aFM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">cool oh cool spinning yeah well it's
nice to be back first of all I think
that's the first thing to say in it it's
been a while it has been a while thank
you for joining us if you are joining us
if you're watching this after the fact
then it's nice to have you do that too I
guess but nonetheless we are back we are
going to do code splitting you're doing
the coding I am I'm going to be on the
live chat which again if you're watching
this after the live stream I mean the
live chats not gonna be there so what
are you missing out on I don't know
we're gonna find out so there's lots of
people already saying hello so I look
like to you amazing so nice to see you
all there right code splitting seriously
joking aside what are we talking about
today
all right so I guess I should start with
showing where we're going to start with
so I grabbed our old route or example
code where we have a little website with
like four subsections that you can
navigate to and we have like little nice
transitions and all these things and I
updated a little bit to use the new year
six module goodness okay so these are
like the import statements right exactly
so that probably needs to be a little
bit bigger yes I should zoom into dev
tools that's let's do it like this yeah
I think I caps locked okay so if we
gonna reload we see that it's loading
the view the ruler and the app and if we
navigate it's going to load some
additional code so that's like lots of
code being handled you've already got
the the very first question which is is
there a serviceworker there's not okay
so we had a serviceworker BIF we built a
serviceworker at CES I think for this
website as well I removed it for this
example
okay because it's most just going to
interfere and that today and most you
want to talk about the buzzword that is
code splitting
really it is actually a bit of it yeah
so we code splitting and root base
chunking oh yeah
very very much intertwined they belong
together but yeah because my
understanding is that code splitting is
you're gonna send like one big bundle
and the code splitting is you don't need
to send one big bundle you can actually
break it down into other bits and pieces
and then the rule based chunking is what
are those pieces yeah so with codes with
the thing is when you write your code
with module
and you don't bundle them then you
pretty much did the code spinning
because you never bundled in the first
place but most website just do a big
bundle i bundled everything up with like
roll-up or able or anything all of them
just like NJ and to have like their
index.html their styles and fjs or
whatever it has all the logic all the
JavaScript okay
yeah but the point is that if you open a
website you don't need all the
JavaScript you just need a JavaScript
for that specific view and that's how
you should split your code as here you
going okay right so let's take a look at
the code can we yeah sure cuz I I want
to see what you've actually done what
you say so be clear I've not seen any of
this code yet so I I'm with you I I'm
learning as we go so if if you have seen
the episode but we wrote the ruler it
will remember that we have a header
partial where we have you know the
header the the start of the body with an
F we have footer partial which is fairly
non exciting and then in between the
header and the footer we stuff the
content wherever you're navigating yes
so for example the landing page there's
going to be the our SC view custom
element which is the current view and
the JavaScript that is needed to boot up
that view I see you got type equals
module yes so this is what you're saying
that you're now switch this out for the
es2015 modules so all the code I'm
writing today is going to run in Canary
because I'm using the modules you will
need canary and a flag right and the
experimental web platform flags and you
can in Safari you can use it with
instance table isn't it it is modules
are unstable in Safari and then far soso
our custom elements so this might
actually just work without anything in
Safari who knows well I haven't tried
that no we should find out and this is a
good point to mention this is not going
to be production code but this is more
important than ever before today yes so
actually one of the questions before we
start the live stream is are you writing
this code splitting stuff from scratch
will you be using webpack and the
answers we wanted to get into the nuts
and bolts of what the code splitting is
doing like to demystify yeah once I was
putting how do you do it so yes I am
gonna write it from scratch but what's
going to fall at the end it's not
something that is completely generic
and that you can just throw at your code
base no and there are plenty of tools
already out there that do code splitting
what we want
get up is if for some reason you weren't
using one of those tools you might want
to but you might also just want to know
how this stuff happens and how yeah well
the rough ideas the concepts behind it
they like to think we are education
let's we should get into some coding yes
let's let's start so as I said I have
these views all these views load
different modules to the about loads the
about GS the contact sub contact
subsection loads the contact Jess and
these files in turn import whatever they
need so the contact has access to the
database to be honest the database file
is empty it's just to have some sort of
dependency okay so you got yeah so you
got these so you've got a one-to-one map
so load contact has got contact Jas yes
so one of the questions that somebody's
already asking is that that type equals
module versus type equals text
JavaScript we kind of jump straight over
and said we're using the es2015 modules
I think it's application deck slash
JavaScript yeah but I might be both in
any case yeah whichever way you go the
person here is asking what does that
type equals module mean what so that is
actually super interesting so when you
use modules you have to set type equals
modules because otherwise an import
statement is going to be a syntactic
error yeah so all this these imports and
exports keywords are only available in a
module context okay and this is how you
start a module context it has another
implication name that this script tag is
going to be deferred by default so
deferred by default means that if you've
got multiple of these same modules in in
Odyssey maybe you've got you know five
yeah if we had like like four of them
yep then okay for then you know they're
going to execute in order well it but at
the end of the the loading of the page
right yeah so basically they acknowledge
that the default behavior of script X
running right away and blocking
everything else was a mistake so the new
type module means do it at the end okay
and browsers who don't have support for
modules will just ignore the script tag
entirely because of the title equals
module okay so there is your your hook
into progressive enhancement and that's
why the spec also has no module so if I
want to have a version of this file
we've got all these individual imports
and exports statements then you might
choose to make a full bundle of
everything where you might actually do
something like the code splitting and
you put no module on it so so browsers
with module support are gonna ignore
this yep and browse us without Moodle
support are gonna ignore this and so it
so you have control over which file
loads exact which browser loads exactly
what kind of code gotcha okay so
hopefully that answers that question
let's have a look then so you're saying
each one of those like contact J's has a
bunch of import statements which then
potentially has other imports so that's
four four four loads in the
miscellaneous I have miss KS the miss
Dutchess depends on database and video
encoder and video encoder depends on mp4
J's you can like command click on know
oh if u is that because you've got a
strange I think it was absolute pass and
they're not actually no go by to go into
the the HTML for me all the HTML much
come on click on that Oh
mmm going something wrong oh okay I
didn't know that though I'll figure out
what it is that's exciting
okay so basically I'm we have multiple
ways where the user could come to this
website on his first with visit they
could land on home they could last on
misc and have to load a certain number
of modules because this this page the
misko's depends on the what was it on
SUV us shooter app database video
encoder and mp4 yes yes like this entire
tree of dependencies yeah I'm not
specific to that section but then some
of those going to be shared like a sea
of us everything you it's going to
depend on these because every view is a
view so it's going to need the view the
router and the app chess which is our
and then you've got other specific stuff
to that section that comes after that
okay so now to the for about the
buzzwords we already have done code
splitting in a way because we have been
doing modules and haven't bundled them
so we are only loading the code that we
need when we go to a certain website yes
but what we can do is we can now do the
route based chunking where we package
together things that are needed
everywhere in one common J's file to get
more yeah which isn't common jeaious
like the modules no but it's like the
common modules doc Jeff head hurts
right okay was wording okay like shared
a yes or
or this is used everywhere Jas yeah
that's probably the best name obviously
naming is is hard fo let's let's let's
start yeah
alright let's get into so I'm gonna
write this an NPM script that does this
an NPM script like in note script why
because I don't I don't want to use
webpack because webpack or does
everything okay so you want okay so I
think is an NPM script basically we're
just doing your own okay so what you say
okay but you're not doing like a babel
plug-in or any no we are gonna use babel
but the thing that does the chunking is
a script that we invoke okay alright so
I have an empty file which is called
bilge as here do I still have the thing
I don't know no okay you can hit enter
does it no it's not into the top top
time it tougher stop no press stop I
think this is something else though yeah
you see I just type some good what I
mean what how do you set this up my
friend
it's all very strange let's let's move
on okay so my entire build is going to
be one function and it's going to be an
async function because we are going to
have I Oh operations and therefore we
going to have to await output and input
and so and so you just invoke this
function and and this is a pretty common
pattern I keep using in my daily life
but one thing that you have to think
about is that if an ace async function
the returns rejected promise all throws
an error you need to catch that so if I
throw an error in here like this and run
the script and the wrong that's good
eater Google Chrome there by the way
Google github.com slash Google Chrome
slash UI element samples is the github
repo where repo repo well we are going
to have this code later on and all the
codes from our previous episodes as well
yes absolutely so you can find them all
there and have a look around
Wow what did you do that or not was too
close Wow uh code splitting is the
episode and now if I do built Jess
you're gonna see this let me zoom this
in unhandled projection because I'm
throwing in my main function so this is
something whenever you use async
function that you need to think about
what I usually do is yeah so any sinc
function basically says this is
returning a promise so if you throw
inside that promise it does what it says
it's a rejected promise and we didn't
handle the rejection
therefore error message and also we
don't see a stacked right or anything
which is not really helpful so I'm just
going to dot catch it which is the error
handler for a promise and gonna do
console dot error and now something
tricky with error top stack which will
print the actual stack stories or where
my OS thrown so now we have error
handling done which is cool so
somebody's already saying is there any
point to code splitting is it a
necessary feature of the web yes I think
is the short answer otherwise otherwise
we wouldn't be here doing this the the
honest answer is that even if you best
way to put it you don't want to be
sending down loads and loads and loads
of JavaScript okay
the chances are when somebody hits the
thing that you've built there's only one
or two actions that they can probably do
in most apps is like opening a file or
you know just one sort of interacting
one site now one thing that they
probably want to do and you want to
prioritize that code so you might end up
with like a Meg or half a mega
JavaScript which is still a lot and you
know don't get me wrong I'd much prefer
it if there was less code but the idea
is that this is about prioritization and
splitting your code into discrete chunks
that you want to ship down it means that
the browser has to do less downloading
initially it has to be less always good
parsing less execution any compiling
type work that it does under the hood as
well so all these things also bundling
one big bundle is just super cache
inefficient because any little change to
any of the original files will
invalidate the entire cached bundle and
then you have to redownload this these
1.5 megabytes of JavaScript so code
splitting is very necessary and mostly
achievable by not bundling in the first
place and then you can do the smarter
bundling by doing yeah because they
because the corresponding other bit is
that you don't bundle ever anything and
you have hundreds and hundreds of
modules and that might seem like a good
idea but you've just got to be cautious
about whether you're making the best use
of the network there and this is where
where the route based chunking is
smarter because like we could just do a
run bundle purview but
then that means a bundle for the About
section and the bundle for home would
both contain our custom elements which
is not necessary so that's why we
extract those in a third module which is
the shared everybody uses these
dependencies modules so these have can
get downloaded once and reused so the
free downloading them every time so
please that answer the question right
let's get back to the code all right so
I'm gonna write down so much chat from
us today
I know code let's okay let's let's write
down how this is roughly going to look
like the first thing that we need top
down like it I know right the first
thing we need is we need to know what
are the end points or the entry points
to our website so so this is because
these are the routes right yeah so we
need just need to somehow get those
wherever that's I'm going to implement
these functions that is just we have a
way to think about this once we have
these entry points we are going to
figure out entry points dot map because
it's a list of enterprise and for each
entry point builds dependent let's go
full screen dependency tree for this
entry point right so now we have a
penalty street so these are the modules
that need to exist for that particular
entry point and that it's just like
leaving the tree like for home these are
the dependencies for about these are the
dependency then we can find out the
common dependencies find common depths
from the depth trees I really wish it
was as simple as writing out I know
right like this is not data so now we
have to come dependencies and then we
can build the shared j/s which will be
or let's just call it bundle which is
going to bundle the common dependencies
right turn it into a bundle and then we
are going to entry points for each entry
point re-write hmm Oh entry point with
the common dependence because basically
we are removing these common
dependencies from there
important yes I think with one common
shared module with all of those in okay
yeah I think I say we because I think
this is this is pretty much what route
based chunking is yeah and let's start
with I guess you gonna have to do one by
one right extract the entry point yeah
so I'm gonna do this and then I'm going
to console.log and three points because
I want to know if my function does the
right thing
so the first thing that we need to do is
we need to figure out how to get the
entry points and I thought I would go
back to the 90s for this because what
this website has is a site map so if you
remember site maps those are used by
search engines to figure out which pages
to crawl if you have in the root of your
domain you can save sitemap XML I
remember I think I think I actually have
one and my sorry there you just list
what the pages are and I have the route
about contact and miscellaneous and
we're just gonna use this because you
know yeah sure why not
so this is going to be an async function
because we're doing file operations so
if you've not done async/await and it's
brand-new to you then have a search
around you'll find at least one article
I think by Jake who's it goes into some
details on what it is how it works and
so on this it makes stuff so much easy
yeah it allows you basically to use
promise based async not surprising but
promise based code as though it's
synchronous code is that the the long
and the short of it it makes yeah stuff
like this file operations networking IO
is just easier to reason about when you
don't have the it used to be called back
hell now it was promised hell and I
think async/await is a really good and
convenient solution to all of this okay
all right so the first thing that we
need to do is um site map string is we
need to read a file so read file app
sitemap XML show XML so now everybody
who's done some note will know that you
need the FS module the file system but
file system operations use the old call
back syntax and not promises and we are
using node 8 and that means we can
change
because what they added is promised the
thigh from the youth so Mario so what's
the German for promise if I fetch but I
see fit ceiling I love it I
we should act fresh but they she fits
you home
brilliant yes brilliant alright and what
what can people might not get it so it's
no no no no leave it leave it leave it
leave it
yeah so I mean we can always change
before it goes to the github but for now
I actually wanted that promise if I oh
ok so what this does is it takes any
function that conforms to the standard
note function l but the last parameter
is a callback that takes error or the
results yes and turns it into the same
function call that returns a promise ok
so we can do is we can call give it FS
file re read file read file and this
constant will now behave exactly the
same but we're trying to promise so we
can do we can just call await here and
that should work and then we can go
sitemap string is sitemap string to
string because it is will going to be a
buffer you jiff eight and just for
testing I'm going to return sitemap
string and see if it works while we're
here yeah in that code you have the the
curly oh oh of course it's look kind of
oh yeah just call it promise if I I saw
it's nice my fault isn't it promise if I
let's Kerr this word promise if eyes I'd
you know I can pronounce the German but
I can't type the English word there you
go
there we go okay okay they're reading
the citement that's cool right okay so
you got that back as a string though
right now it's the string and now
obviously this is XML so we'll have to
parse XML so I'm going to use the good
old XML to JSON we now need to install
that with or view I've already installed
NPM because I don't want to rely on NPM
install actually being quick so Kay and
and the best part is even though it's an
it's an outer module because it conforms
to the structure we can actually use it
on here as well
so I there's a question about the the
curly braces around promised if I did I
say that out loud
no okay s because we reach the book just
as you yeah I was about to ask so the
curly braces there around promised if
I'd John explained it yes that is called
destructuring basically the require util
returns an object that has multiple so
what we could do this is the same year
here we store the entire object which is
the module to export absorber it's the
same as if we call this youthful and
then went util dot promise of thigh and
did something with it
yeah but with destructuring you can
basically selectively import which is
more similar to the es6 import yeah you
say i only want this one thing from that
entire object so please just get
together i'll get and then pull that one
property out and give me that back as
this in this case promise if i yeah so
let's do this sitemap a weight paris xml
sitemap string and let's return that and
that should hopefully be some kind of
structure yeah so it says object object
object but I mean it since there are
four those and then there's four URLs
I'm gonna take it on faith that you
actually you got this so now the only
thing we need to do to extract the entry
points is we are going to go to a
sitemap dot URL set
dot URL so that's that okay and then
we're gonna map those and go chance each
one of those objects yeah because like
we have four URL children this is an
array of your else and each of us has a
location dot lock and so if we turn that
looks gross do this should then uh I
mean that looks nicer though and now the
last thing I want to do is like strip
off the domain name and so you have a
URL now I actually need your L okay so
you're gonna pause that URL that you got
back and do something and you your L
your L path name okay so that just gives
you the slash about slash contact slash
something of that tada
and these are our entry points to the
entire page uh and that is basically our
first step down I want to do
a little in between stead where I turn
these into the sections because as I've
said in the code if I say about I could
I have the about dot HTML and the about
dodging so I just want to work on the
name about not only about dot HTML
because we're going to work on the
JavaScript and not on the HTML file not
sure follow you but keep typing code
because I find that easier and so entry
points dot map is an entry point and I
want to now enter another module which
is going to be the path so we can do
simple I want path that base name of
entry point and I want to path dot X
name entry points and this section ok
says yes you're correct look almost I
mean it looks very good
the only thing that we need to do tick
tick and then map entry points if entry
points it's empty then we use index
otherwise whose entry point got it so
you just make sure that M to one of the
start tada so these are four sections
that we need to process so we're making
the assumption which again in a
generalized production setting you
wouldn't make this assumption is that
each one of these sections in the
sitemap that XML maps to a dot J s
equivalent so yeah like about slash
about this as an about dice or our tests
yes I I'm not for everyone else just if
you're just joining us first of Lee
welcome hello we are in the process of
talking about code splitting and route
based chunking what's replaced chunking
in German Lewton bleeders clump tonight
okay we were just apologizing yeah
okay okay the idea of being that rather
than just saying you know God foreknew
is one of these tools and save webpack
will be I think probably the one that
most people go to which is great for
production absolutely you want to use
the best possible tools for production
we wanted to kind of demystify and
explain some of the principles behind
the tooling itself so what we've decided
to do is just talk about if we
with a sitemap.xml and our previous
sample with server-side rendering
starting with a site with a bunch of
JavaScript that it's importing some of
which is shared between the various
sections of the site and so which is
unique to each section how do we split
the code what would we actually do if we
were going to do code splitting on our
own without one of these tools so that's
where we're at
android-based something a rebase junkie
and we're going from there so in the
middle of basically reading through the
sitemap XML and the only done with that
part we've done with that part so we now
know there are entry points yeah we have
a basically our edge place for the
JavaScript files that we know we're
going to go they are misc
index about contact and misc which is
yeah I just read you uncommitted debit
there we are those are the sections
great okay all right so let's work with
sections instead of entry points so
we're going to go with section section
section and this is the first time we're
going to encounter Babel so the first
thing that we need is we need our code
so we're going to read file app static
section J s ok so now actually that's
not quite true because I always run into
this issue with node where I with a wage
you head would have to put parentheses
and to string in one line and I don't
think it's very readable so I'd like to
break it down into lines we do the
string conversion afterwards so now we
have sure the code in a string and
that's gonna get interesting because
we're going to write an babel plugin so
yeah cell phone this is constable
require babel core the cause what we
need and our plugin okay is plugins are
most of the time I mean there's multiple
variants of plugins available in the
only one I'm familiar with with is ast
transforms where you can transform the
abstract syntax tree that Babel gives
you and the way it is implement is that
you can implement a visitor pattern some
of you may have had at a Nunis you need
some of you may have not as Vistal i
think you want an eye on that I might I
might at all let me know alright so and
this visitor object can contain function
or methods rather for any kind of token
type so that when the one we care about
is an import declaration so I feel like
it's worth pointing out an ast is an
abstract syntax tree which is once your
code has been paused and tokenized and
pars and everything else you get this
tree which is indicates all the
different so you have a program at the
top you have an array of instructions
and instruction is like parameters and
all those kinds of functions name
parenthesis parameters and so what Babel
would typically do would be it would
read through your es2015 ish type type
code because yes because there varies
right but it reads your code and it
turns into this AST and then through
bunch of plugins it will transform that
code into what we spit out on the other
side and so now one of these plugins
we're going to make one of these plugins
that's going to sit between the code
that we started with which as you said
does actually run in Canary with the
flag switched on yeah we want to do
something that would transform it a
little bit more so we what we do is we
create one of these you say these
plug-in which has this visitor button
which basically means you kind of
register these callbacks you spot and
you say please call me whenever you find
in importantly Croatian yeah you can
also do funks like a string literal
which would you get called whenever
there's something in double quotes or
single quotes like we don't want that we
only care about in so if your location
is documentation on how to create these
plugins right and I recommend the
handbook that we are going to have a
link in the description and where you
learn how to write plugins so there you
go
so we're in the middle of just basically
going we know that we want whatever
whenever we see an import declaration we
want to do something with them which is
in this case we want to build a
dependency tree again the declaration as
a parameter okay and what we really care
about is the imported file which and I
have to admit I just memorize its
declaration note dot source tell you
sure actually we could do we could just
print this out to see that it works
imported file and then we go on a babel
transform on our code and our options
take a list of plugins and the only
plug-in is our plugin go in this can go
actually we can
keep it it doesn't really matter
we're going to return something here
later so let's see if this works
yeah you see basing it now went through
all the files a little instruction in
the output but we can see that all the
imports that are import at some point
one way or the other we get calls this
is this is a really great case of you
building on standing on the shoulders of
James is really nice right is kind of
going I don't want to build it and
abstract syntax tree myself I don't want
to fiddle with regular expressions
trying to parse Java this is this is
tried and tested code this is great code
you know we can we can make use of it as
you say we just hit that input statement
and we can just kind of what imports are
we actually seeing here so this is
really cool okay and and what we want to
do really is we want to collect the
dependencies so I'm gonna do an array
mmm stateful yeah a little bit I'm not
sorry no not even a little bit umm and
I'm gonna push that dependency when our
imported I'm gonna push the imported
file onto our dependency list and a
dependency list is what I'm going to
return and now that means that our depth
trees should now be an array which
should look pretty similar to what you
just did it is a promise that is true so
I am gonna am a weight promised at all
okay and now boom so now we have an
array of arrays this is the home road
where we only depend on three this is
the miscellaneous route where we depend
on for but if it take a closer look you
will see that the mp4 sorry counting and
but the mp4 j/s is missing because we
are not actually looking at the
dependencies of our dependencies you're
not going down the entire tree so this
is just the first level this is the
first level of dependencies okay so we
fix that is that possible yes we can
yeah so back to our basic what we just
need to do is we just need just need to
call and this fuck this so we kind of
recursively call it yeah we see an
important a little bit tricky so because
we now have to do another IO operation
which is a sink but Babel is inherently
synchronous
Oh so something you can do is just to an
anonymous asynchronous function that you
invoke immediately to kind of you know
do it a sink and then in here you do not
that'll true Const code is I'm glad you
know what you're doing because right now
I'm watching this going I mean it's a
complete mystery to make imported file
so you doing in in this acing fun you're
going to read the imported file and then
call our plugin recursively so reading
that sure and we're doing that I get the
year okay uh-huh
interesting ah do you not have to wait
anything on that function that you're
calling immediately no okay all right I
think this is fine should we find out
yes let's find out but I would each but
now we have one problem which we can fix
ooh ooh
this is good I can plug my side project
so sir my github dot io / under - the
thing is that we are now have be putting
more arrays into arrays so we want to
flatten it yes okay because we don't
care all we care about is getting a kind
of a top-level list of here Oh Liam all
these tendencies and there is no default
flatten on an array in node or
JavaScript and so you can go to my
project which is called under - where
you all this little like useful
functions are there for your just across
whether just copy/paste what you need
yeah so if we need flatten you're just
going to go with a a it's gonna copy
that look at that I'm going to paste it
down here or should why wouldn't you and
then I'm gonna fly on the depths we're
gonna flatten a weight promised at all I
don't know what you're doing that but
okay because they're still promises it
so definitely when you said it was
easier to read the async/await code hmm
see I was wondering whether that oh yeah
this is sneaky I think is it yeah okay
listen as I said Babel is synchronous so
this async function is going to get
actually executed after all the
synchronous code is done because it's a
micro task
okay so we need to put
something onto dependencies right away
so I'm not gonna that's what I was going
after I was thinking I was thinking you
need to do something that says there's
something coming in here that will need
to be processed later or actually we are
going to return away this is so much
cleaner dependence dependency tree now
this makes much more sense doesn't it no
no no what are you doing so do you not
need to pass that something um yeah what
we're going to do is we're going to pass
the imported file but that we needs we
need to turn this into a file so oh so
you need to call that with the initials
so we're going to put this here instead
this is a file we're going to read that
file now have a function that returns
all dependencies are the file we can
just and then recursively goes down and
finds the relation okay should we see if
that works
I'm a little bit wary burn do that is
correct because it is a slash static
path we need to ok cur it to my app
folder where all these it has on yeah
right now do you have mp4 now so because
now we're actually cutting down yes we
have the dependencies of the
dependencies which in theory could have
the defense's it depends it will go down
all the way it's all the way down okay
all right now this is actually step two
done we have built a function that
builds a repository yes it recurs it
down so now we can go on to the next
step and talk about figure figuring out
what the common dependencies are oh no I
feel like this is you know what's should
be how would you do it um I mean mmm
interest right yeah so find common
dependencies from our DEP trees how
would I then if you if you literally
think about the trees mmm thank you all
you really want to do is just find notes
that appear in all of these trees yes so
what we going to do is are you going to
do like an N squared e type thing where
you take a node and look
I don't even care what the runtime is
because this is not production ready
come on I suppose you since you don't
find it the worst case would be and
squared I think so so I'm going to
flatten the tree into a set and then for
each item in the set I'm going to check
if it's it here in all the trees and if
so keep it I think code will be better
to visually I know where he's going
which is just as well so we're gonna do
a new set yes you JavaScript sets now
because then we don't need to worry
about filtering or duplicates set does
this for us yes if it's in the set like
so depth trees for each which is one
depth tree supports looks like a one the
one that's for home one that's for about
one looking for contact one that's for
men
each of the debt tree has for each has a
dependency and depth set at depth that's
it
so the folk the folks are on the the
chat hello again folks on chat and I'm
really enjoying watching all the chatter
go by and there's a lot of people kind
of picking up the fight we're going for
four sets I think some people are first
time they're seeing them so that's
that's really excited really fast
they're very good really useful
primitive to play around with so and for
this kind of situation they are actually
quite useful as well it's just easy to
grasp like oh it's a set there will be
no duplicates because that's how a set
is defined you can't have the same thing
twice in a sec yeah yeah and we just
want to have a list of all the pens that
appear that's a set can you can you not
can you not make a set from an array can
you not like I might let me just check
first if this works okay this looks like
all the dependent I mean for this neural
dependencies it's not a big deal I'm
probably for most projects unless you've
got thousands of dependencies this would
be micro optimization so you carry on
carrying on it was just me being curious
and so now we have a set and what we
want to do is we want to turn that into
an array and then filter on it because
we want to filter out the things that do
not appear in every tree okay so for
each dependency we want to check if for
every depth tree
Deb tree includes the pennant does not
include this dependency let's let's do
this explicitly because otherwise it's
gonna get too noisy no you want to just
you want you want every tree to include
this dependency do you know you want to
filter out the ones that ah night not
now I'm actually not quite sure let's
let's try both yes you're right we want
to keep the ones that are in every
dependency tree that's why that's why we
call them the common dependencies I
think I have to go thank you for coming
so as you can see now we have a set of
dependency that appear on every entry
point and that is correct which is
amazing yeah and this is actually five
lines which sometimes some it amazes me
that you can express things are harder
to explain with words in like snappy
snap snap code and do you know what
these smoothys newer they're not new new
but they are newer definitely operations
for one of the better so I suppose
methods on the arrays and so on are
hugely significant I think filter fine
find index Map Reduce like these are all
introduced I still use reduce a lot but
I still feel tricky using it like I feel
like I'm not actually easily conveying
what I'm trying to do i life like before
like promise change change like a change
other promises you reduce the chase so
say i feel smart doing it and that's
usually not a good thing no it shouldn't
cause it's about a few months you look
back going what what was family thinking
exactly yeah okay we now have common
dependencies figured out so now let's
bundle these common dependencies into
one module okay right
so what are we going to do we are going
to write that function that is what
we're going to do we're going to write
the bundle function function bundle and
bundle is going to take a piece of code
and this is interesting because that is
you're doing I'm just going to quickly
generate some quick and dirty code
because that's just I think it's easier
to do okay
so hence the if you're just joining us
we're making our own code splitter
because why not because we wanted to
just talk
other kind of things that go into code
splitting and it's not a production code
we always want to be very clear on that
in what I'm doing super judge this is
very much about us of sharing a journey
and a process and an idea or concepts
and sometimes the code you know is it's
a good starting point for something that
you might end up doing in production but
certainly something like this we are if
you want to put a lot of work you can
productionize this yeah but there's
still work to be done there and there
are existing tools that already do this
so yeah yeah well beyond tools well
explore tools tests of tools yeah rather
than reinventing the wheel is usually
should be avoided unless you want to
learn about wheels which is exactly what
we're here for
so yes carry on so I'm just going to
console.log the old code that the code
that we are generating just to see it
I'm actually doing the right thing and
uncomment you out so I'm cold
Oh cold there you go that's just the old
code it's the old cold gets me every
year okay so this is a um that is what I
actually to do is I wanted to join this
with our guideline so we should now have
like pretty much an empty file that just
has three imports so this is now the
file that we want to roll up basically
okay so we are going to write our own
little roll up real quickly um sure
why we're just going to import all these
files that um we need um okay sure and
we can do that by the babel plugin whoo
more babel plugins so we're just going
to copy and paste the old stuff and for
each so we're going to have like new
code is an empty array and for each
imported file we are going to let me
think for a bit let's remove this so
we're going to read that no we're not
going to because we're going to go
recursive again so we are going to
bundle a wait read file app important
file and tell me what you're doing here
okay I'm gonna clean it okay because I
don't understand it so
this this plugin for Babel is going to
take a file and whenever it encounters
an import it's going to remove this
import with declaration don't remove
which remove that import and then inline
that imported file but before doing it
has to do again the recursive thing wait
right so if the thing that is going to
replace house imports it needs to
replace those calls itself okay all
right okay so what if you have a new
code array the top do you need to do
something with that
that sugar declaration to remember but
presumably want a new code this is what
we want to push so when I push it in and
now we do so we're going to have to do
something new so because before we just
ran Babel and as I said Babel does code
transform but we totally ignored the
output beforehand well we take it and do
something no we take we take the code we
do a transform and then we ignore the
results okay which we now actually need
because now we want to have the code and
is without the import so you d string
again together the I'm getting to it
code and now we push that onto the array
as well and then we return the weight
promise dot all new code I'm going to
flatten it and we're going to join it
with new lights Wow
so there's a lot going on in there and
before you go and run that so the reason
you're doing promise that all around new
code is because some of it will be a
value a literal value but some of it
will be a promise like the the call into
bundle again so you've got a set of or
an array of some literal values some
strings essentially and then some
promises so what we're doing is we're
saying wait till at least all the
promises inside that that'll get
resolved then we'll have an array of
literal values at that point which we
can then so you're waiting on that
happening then you're flattening an e
because you've got that recursive you
kind of thing going on so you flatten
all that down and then your lesson array
of strings and then you join those with
new lines so the least it's tidy yes
ok so let's try and see what happens
share J s if we print this with a
console new
new is we're missing a I'll because I
made no it says it says it's well yeah
because weight is gone and let's see
what happens I hope it is just your
codes not defined which line 39 now
somebody's asking what if the imports
are circular oh this one old code so yes
I heard the question and I'm I'm gonna
ignore it
so are you are you basically implying at
this point that we are not considering
circular we are not considering so gleep
n which is what I assumed we weren't as
well but again this is another reason
why you'd use like another to roll up
has figured that out and we're peg as
well we I mean I I have an idea of how
you could do it if you were to use
bundle you would probably have something
like already imported dependencies as a
array and skip the ones if it reappears
it's a it's a graph theory type moment
where you yeah I visited this node don't
revisit this node so I like this is
usually we try to keep it you know that
people can follow along and I thought
about it and I purposely did ignore it
because it was just go out of the scope
but we're ignoring it I think so
something that so as you can see we now
have whenever there's a corporate here
this was a separate file so now we have
concatenated multiple files into one
yeah which is cool so now the only thing
we need to do is write that file so I'm
gonna wait oh now whew we need another
one because now we need right file what
did I do
I don't know I pressed a magic shortcut
so write file and then down here we can
write file which is going to be app
static I'm lazy I'm just going to say
all generate files start with an
underscore okay
because why not share Jess and let's go
back here let's run it again should be
nothing and then in app static shared
boom okay and now for the final step of
this journey
we have to rewrite our entry points
because right now yes we generated share
J s but nobody's using it yeah everybody
still back at the original set of
imports that they had so every time we
presumably find those imports together
we should be able to replace those with
that what you've got here in that shared
J s so a sync function it's going to be
a sync because we have to write files
there's going to be i/o it's going to be
ASIC okay that's a logic I usually go
through in my head I think we have for
example the fine comment Deb's was not a
sync because we're just working on the
tree is already there no reason to make
it a synchronous rewrite you're going to
rewrite actually not entry points you're
working on sections section section we
take a section and we take the common
dependencies because what we're gonna do
is we're gonna write a third Babel
plug-in Wow use all open yeah um so
that's also thing you probably normally
wouldn't do that but I not an expert in
Babel I just threw Babel plugins
together and do three passes it's not
efficient but networks about it conveys
the concept okay did I say it's all
production ready code we may have
covered that all right so what we're
going to do is we're going to go through
all our sections each one by each
individually okay and basic remove all
the imports that are already in the shed
on yes and then we're going to prepend
an import for the shared bundle and that
should work and let's figure that out
all right so I'm gonna do something I've
done before I'm going to copy my plug-in
if nothing else this is I think showing
why some of these tools exist right
because it's hard because writing some
of this code is you know it's pretty
pretty challenging yeah you know and
yeah the cool thing is this one it's
actually one of the best the easiest
plugins so what I can do is if common
depent dependencies includes imported
file then remove it and that's it so
okay so we have two dependencies the
common defenses is a list
monitor okay so like the SC view Gaius
so you're saying if this file contains
that one get rid of it because we should
know that it's a common dependence
because we've already figured that out
earlier so we can be safe to remove it
okay so now we're going to actually run
the plugin again we're going to
transform our old code we're going to
need to read the code first I forgot
about that
so Const old code is a weight read file
app static section gasps somebody's
caught the bug for you constant ported
file includes imported file thank you
that was a quick turnaround oh no right
yeah thank you very much for that I was
a shitty good bug fix we are reading the
code I did though I'd have to do the
thing again old code is old code to
string also not very optimized I'm
reading the same file I think the third
time now which usually yeah but okay we
are removing all the imports this will
be the code without the importer in the
shared Morial okay so we are going to
now we need to prepend our we are gonna
that means you know let's let's let it
again let's make it a let so we can know
then we can say code is imp know let's
do string difference we can I'm gonna
need the single quotes static shared
guess what I call it right yes share
jazz up here and I'm gon prepend the old
code you can kind of give it a new line
I'm nice like lat and then we're gonna
wait right file app static section okay
see now rewriting the about jst
underscore because on my generate files
start with an underscore okay right so
code and this we're going to have to
wait promise door why because each of
the rewrite functions will return a
promise until the writing action is done
generally to map it then
and say that is correct look at you hey
you know occasionally I have my uses so
this should not output anything but we
should have app static about DOJ's about
Jess which just imports share J's which
is correct yeah and there was it misc
that had that little the to fill okay so
yeah so it's doing its job it's doing
exactly little bit hard to read because
so that's the two imports but you've got
that shared jeaious at the top which is
the ones that are shared obviously yeah
and then the the two that are specific
to that section so we've done we've
effectively done we figured out what's
common for that in its own file was
that's that shared Jess that was
flattened right yes so that's all been
flattened somebody pointed out as well
that we don't do anything about sort of
conflicting variables or whatever across
those exactly we also don't support the
import sub object from whenever you have
these guys imports this would already
break so yeah it is production ready no
no no sometimes you say right but
hopefully you are getting the idea
you're seeing you know to be fair you
are seeing like async/await we're seeing
promise if i we are what else we got in
here we obviously Babel plugins there's
loads of stuff that's in here yeah of
course you know there's all sorts of
interesting techniques and ways of
thinking about these problems when you
even if you just try some of this stuff
yourself and I do recommend sometimes
doing the top-down approach which I did
you do you write down a sketch of the
calls you want to make in what order
what data you need to move from A to B
to get to your goal and then you go down
the rabbit hole I naturally am a person
who starts starting with the individual
puzzle pieces and then tries to build a
house and then until I have built number
of funds I'm never going to use and this
way it's easier to walk towards ago
asunder - isn't it for example um but
nonetheless so even even though we're
pointing out yes it's not production
area ready yes there's lots of edge
cases that it doesn't handle hopefully
you are seeing some of the ideas and the
concepts that are at least would be
behind a professional tool and you can
see why people
I've spent so much time and energy to
put these high-quality tools together in
the first place I mean there's basically
only one thing left for us to do know
which is showing that it actually works
now at the moment your your HTML refers
to the non generated version on general
I have to do now is to go through this
HTML on add an underscore really and
that should make us flip over to the new
generated versions that have route based
chunking okay so I'm going to go to
canary I'm going to go to the Reuter I'm
going to open dev tools and I'm going to
look at the network panel
okay guys want to see so we should see
JJ s should we know yes so let's see yes
we got to see the index chess and the
share J s which is all the index file
really needs and if we go to
miscellaneous we should see the Indus
miscellaneous jazz the share chess
database video and mp4 yes in this case
it only loaded the ones who are not
already there but you can see we've
switched pages and share Jess wasn't
reload but this is a nice feature of the
modules right yeah the modules are
automatically kind of handling this idea
I've already got this input why would I
get this a second time yeah but we've
made the most of that single import now
because in that single import the shared
one is actually a lot of code so it's
it's sitting somewhere in between I have
an individual import for every single
part of my app which could give you
hundreds if not thousands of imports
versus also it can get really bad in
terms of loading time because the
browser won't know what to fetch next
before receiving the first one and think
oh there's more attendance ease I need
to go out the networks and grab those
and then I don't know my lips are really
expensive so what we're saying here I
suppose is that on the one hand you
could have this big bundle which is what
we allowed of sites we are doing today
and this is where we've come from on
HTTP one in particular you'd bless
everything into a pas and that's it and
it serves every single part of your app
and sometimes there's a huge we know
that people have a lot of functionality
they're trying to pack in today to their
stuff so that's the old way if you like
the you could go completely the
the direction be like I've got thousands
of imports but that can be as you say
some on touring development and local
host sets fine yeah but in production
that is gonna like tank you're loading
and what this is doing is it's bringing
us back into that sort of mid ground is
a spectrum it's not always black and
white exactly and it's going to really
depend on your context as to how far you
can push this and obviously you know
while we're doing this today
specifically for our particular app you
want to investigate ways to do some of
the stuff in your in your own code for
your own something we haven't done that
it's something you could add on top is
the soap that another buzzword is
tree-shaking we remove the bits of code
that never get used from your modules
because sometimes that was the buzzword
dance that I was just doing that oh yeah
we have a buzzword dance now apparently
sometimes some projects even though they
are already in modules still have here's
all our formatting functions in one
module but you only use one of them and
tree-shaking is the process of removing
all the code that never gets called in -
and again if you think this was a bit
challenging look into that that is tree
shaking is that I think is news out
there isn't it so yeah cool that's
pretty much everything I wanted to talk
about today awesome so with that said
thank you very much to everybody who's
been joining us on the live stream and
in the chat thank you so much
we've had a blast edge really nice to be
back and I guess till next time
I've been Paul and I'm sama this was
supercharged see you later
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>