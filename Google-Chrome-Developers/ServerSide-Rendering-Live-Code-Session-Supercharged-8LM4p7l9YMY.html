<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Server-Side Rendering: Live Code Session - Supercharged | Coder Coacher - Coaching Coders</title><meta content="Server-Side Rendering: Live Code Session - Supercharged - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Google-Chrome-Developers/">Google Chrome Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Server-Side Rendering: Live Code Session - Supercharged</b></h2><h5 class="post__date">2016-09-15</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/8LM4p7l9YMY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello and welcome to the supercharged
livestream i'm Surma and i'm jake and
today we got to do server size
serviceworkers see paul couldn't make it
to the office cuz the british train
system so i thought we could have a
whole episode entirely devoted to serve
this one oh maybe I made of it well what
are you doing here oh because because
you were late I thought we could do this
entire thing all about service workers
no no you keep doing this you keep
trying to take over can we have one
thing around here that it's not about
you and service workers okay show of
hands who wants this episode to be about
service workers fine
well that's that's rid of him then so
sorry about my tardiness on the show not
Frontale quick umm yeah so what we doing
what we do we are actually going to do
server-side rendering and you're going
to do it with you and not with Jake
there was a lot of confusion on Twitter
well I can very enjoy whoops yeah anyway
um but I did make it and that's fine um
I'm I'm not doing the coding today
you're doing the coding yeah it's a bit
of a switch around I'm going to be on
hand to answer questions and talk to the
folks and I can already see we've got
lots of comments coming millions of
people so ready hello to everybody in
the chats thank you for joining us I
would love to have you here so I do you
know feel free to keep chatting away and
well if you can't you can make Paul
interrupt me so that I do more mistakes
my goal for today is is try to do less
typos than you do and I'm pretty sure
I'm gonna fail I mean although you do
set the bar pretty high
oh but this is my revenge I mean I mean
I'm gonna be very supportive throughout
so right so if I cry ring Surfside
rendering okay what are you doing
service like running yeah I should
probably explain because of this word
has been all those three words two words
if you will - just those words have been
thrown around a lot um and I feel like
there's not a very consistent
understanding on what it actually means
and so I'm trying to go to capital in a
few words so I was like rendering is
what you want to do if you have a single
page app
if you think back to the first rule that
we did we actually used a little title
web server I think you wrote that
whatever you requested you would get
back the index.html so we crested slash
about or just home or slash contact we
would always get the same index.html
which means in that site there wouldn't
be the content that you actually wanted
to read so you would have to wait for
the JavaScript to spin up ad to analyze
the path that has been requested and to
swatch swap out the content in the Dom
with our actual content and then we
switched it up to the advanced router
which did actually have individual pages
for like about contact misc whatever it
was and then and then we pulled those in
like that would mean that whenever you
change something in the layout that you
would have to do the edits in all of
these individual pages so presumably
that's what we're trying to figure out
today so like Reming basically still is
always delivered the index.html
but already inject the content before
serving it to the user so you render the
Dom on the server-side that is why it's
called this way and send it to the user
so the content is already there without
the JavaScript needing to run at all
yeah and then hydration happens where
the Java prints up and takes care of all
the dynamic parts so let's go get our
hands dirty and write some code I'm
gonna start with something so we're
gonna write note on the back end we're
gonna write a note web server that does
the server-side rendering so I'm gonna
make this a script with copyright Harris
so that we can run JavaScript
uh just with executing the script um I
thought for this so I have in the folder
here I have an app folder where
basically our advanced through the code
is another thing that we wrote two
sessions ago I think it's exactly the
same no not much anything has been done
and for this one I decide that I want to
use Express Express is just a little bit
of convenience about notes native web
server so that we have a simple simple
web server and use it by creating an
Express app and this tab object is
really going to do all the routes so you
didn't install
yeah I have the modules in here with
Express and all the other things I plan
to be using I'll explain as I go along
okay actually using okay so we want to
start with something
we're just going to write a web server
that is just straight web server but
does nothing else so what we can do
there is we want to say that our app
uses middleware that is called static so
what this line does is just says to
express just serve this folder the app
folder a static content group which set
up web server and then we're going to
use notes HTP server create server that
serves our app and we make it listen on
8080 and you've got this all committed
in your head well note is at lettuce
what not excels it right very simple
code that you can well Bravo well done
very good so let's do this who doesn't
love a bit of Chimel inch modding my
legs like the plus X now it makes it
executable right okay why did that line
at the top so yes it's actually I think
this hopefully you can't find module
Express well that's good to know right
that's not that's like the only module I
forgot your salsa no let's do some good
old npm install because oh that means
you have to do the install dance while
we wait for it to go well but wasn't
already done because it's not that big
oh I was only partway through the
install dance see how he does have a
very elaborate install dance finite so
we got a question here why not use
import Express from Express why are you
doing the old sort of require rather
than anything newer so the thing is that
modules for me are still a little bit
iffy
it's just something especially on the
NPM side it doesn't feel as right I'm
not even sure if Note 4 which is autumn
you already supports the import syntax
and the x oakley would need i'm able in
between i don't know and also imports
are declarative and not imperative and
sometimes you do want to have like I did
here you do want to have the impressive
way okay like grab this directive then
do this thing with exactly so for now
I'm just sticking to require until the
entire JavaScript ecosystem sorts out
how to do modules and it's just for me
to keep me sane okay so what's the start
is actually working there's no error at
least that's good so if you go to
localhost there is okay or good oh no
this is actually
little cramped um oh can you do the oh
there we go oh I can feel the tension as
you're trying - no don't do I get it
right
okay okay instead of selecting them all
as well by accident yeah it's good so I
want to see the protocol as well
oh you don't ruin it why don't you
submit that tools a bit they could do oh
I could hate to be one point one yeah
okay oh there you go just oh yeah he's
up uh we got this and now what I wanted
to do is you wanted to I wanted to put
this to hb2 because you know this is the
future and we should do this but for
that we need TLS certificates so because
I forgot to download it I will go to
Google Chrome simple hb2 server because
not only is it simple hb2 server but it
will also allow us to generate
certificates I'm just going to download
the Durban version you're not going to
go to you which should be here there we
go and let me go download simple boom
boom and now we have a certificate which
we can use and I'm going to show you how
exactly so we need a so what you just
you basically so for anybody who's not
seen this before
you built a simple bit like the Python
simple server but it's the it's in
building go and it adds it's an HTTP to
server so it has to be running on HTTP
so you got a self-signed certificate
that you've made it makes on the fly for
you and then you're basically you're
treating it wherever you run it from
whichever folder you right from treat
that is the folder that you're serving
exactly okay so and I just used it for
they able to generate a certificate
because using the UK open SSL
command-line tools is so painful with
the original motivation to write simple
82 server to not have to do that
annually and so are you using for right
you want the certificate and now you're
going to use them here exactly so what
we two can do exactly is that we are
going to use require FS
and do FS breed file sync we're going to
do synchronous because I'm dirty like
that and we're going to use the key and
the search read file sync search em and
now we should be able to do is just to
turn over to HP s and add the options
parameter to our create server and now
it should actually be HBS so let's try
that
no error it's good we can close this
let's add this and we get this which is
basically because it's a self-signed
certificate chrome is going to say you
know that this is not actually secure
line it is it is secure in terms of
encryption but not authenticity yes I'm
sure that we actually talking to the
right server but since you're on
localhost we have the option to say you
know I know what I'm doing let's proceed
and as you can see we have HBS with a
red flag because as that it's not
authentic but it works so now we're
still serving on HTTP 1 yes all right
yeah because I just switched JPS now
ideally what I would like to do is using
a to be to however Express currently
doesn't work with PHP module' because
the 82 and p.m. module is still very
much in development what we can use
however is the speedy module huh which
interestingly enough does actually serve
a to be - you just don't have the option
to push so it is a valid 82 server and
since you're not going to pushing today
no I understand every stuck but you
can't just it's just gonna work like
this ah ha ha that's safe spinning oh
yeah let's restart it just to make sure
hmm this is interesting mmm options yeah
it worked on TLS let's let's just give
HP to a try just to make I'm not sure if
I have it installed actually I have it
installed apparently let's try it Oh
something very strange is going on isn't
already strange hmm why didn't try
different port entirely yeah let's try a
different part let's try 8081 let's
restart that go to here ooh interesting
that is interesting right so the
question is why do we not get HTTP - so
we are reading the certificate I mean
there's not much code where I could do
something wrong no no there isn't
I'm passing in the options I'm passing
in the app hey well do you know what I
feel better that it's not just me no
house their house the boss what I
expected I expected - I am also in this
right folder right as far as I can see
ya there speedy everything I mean it did
the very least it should be speedy she
write it there it should be some meeting
 anyway should be speedy huh I'm
just gonna skip over this for now okay
welcome back - yeah look I get back so
let's stick with HD one who suggesting
it might be the caching but I did I did
do a heart refresh yeah I saw I saw you
do that too
oh that's because I have it now you do
you go back to a CIT
oh that's because I still have the
options in there ah did it that actually
that's let's say with ABS just to make
mr. right line let's start the server
again and put the HBS back in there it
is working let's stick with this yeah so
every start the browser I like this
people are basically saying switch it
off the clock hey I'm gonna give this a
way and I like the people I mean we all
like to do that so I'm gonna reset the
server yeah I'm going to kill this I'm
gonna restart chrome open dev tools
on the network tab and go to HBS
localhost:8080 one now it doesn't like
you okay let's just go so right now what
we are doing this should all be working
we can go to our different website at
our different subsections and it loads
because we're just doing aesthetics
server mm-hmm what we actually want to
do though is we want to add special
handling whenever an HTML file is
requested because this is where we do
our server-side rendering mmm so what
we're going to use is app dot gets
saying whenever this I get requests for
and now we're going to use regular
expressions well I'm gonna try to make
this understandable okay so what we want
to do is what do I do the I on there
because case insensitive okay like a
sedative so I'm gonna be that person
because I think oh this yeah yeah
because that's you know it's reading
somebody else's regular expressions is
it can be very painful and okay and and
this is probably not going to be pretty
also because I'm just talking about it
this is our production code it's not
going to end up being a production ready
web server or production ready back-end
I'm not going to pay a lot of attention
to being to do any like IO optimizations
or to do very efficient server-side
caching or these kind of things this is
mostly to show how to implement
server-side rendering it's about a
technique not about a specific high
performance implementation in this
regard yeah I'll be going to half
performance in mind because this is why
we're doing this and this is super
strong right what we do all right so
let's think about this when do we
actually want to handle a request that
is either when the path is being
requested ends with a slash or with this
the or for especially if it has a slash
something that is not a slash with a
slash at the end all right do not sow or
index.html right Wow
that's already tremendously readable so
um so what we're going for here is so
you could ask for like slash home just
slash slash home slash or slash home
slash index today exactly okay so that's
what we're trying to capture so if you
come up with any of those three
otherwise we're going to fall through to
the static exactly so all the funds are
there are gonna be served just as as we
know and this is what I love mode for
because we have function so what I'm
gonna do for now is I'm just gonna check
it is actually working and just send
like a test string hi good bit on brown
but whatever okay fine okay so I'm gonna
use supercharged boy let's reach out the
server I hope no syntax error which is
good so if we just go here supercharged
sigh okay if you're gonna go to about
supercharge ty if I go to about in xhtml
supercharged hi and presumably if we do
like static but we have for sure we have
app we have static app j/s okay so this
should now full through two okay so
that's the static hosting that we yes
before okay that's all I wanted to show
the middleware of the static mode of
Express is really nice because in the
response they take care of doing
sensible defaults like default cache
control default adding an e-tag doing
the last modified okay so let's talk
about this very briefly because I know
this is this is a bit of a kind of a
hidden gem I suppose like when you
understand about these headers life can
be a lot more straightforward I've seen
people for example using a serviceworker
and then trying to like cache bust and
do all things because the the headers
are fundamentally they're fighting with
their headers exactly headers right well
sometimes is okay because for example
and get up pages you don't have any
control over the headers that they use
so you might have to resort to these
things but usually if you have any
control of your back-end which for
example on its three hosting you do fix
your headers
yes because caching is part of hvg and
the entire ecosystem so good caching
headers over so much and to at least
give yourself property tax so that
caching works for your clients and you
reduce bandwidth that they use on the
website so somebody's basically saying
here the e tags they've never really
understood what the point is okay etag
so why don't we take a moment explain
let's do eat or eat X are pretty great
basically what they mean is that if when
you receive a document from a server it
gets an e tag and that etag is a
guarantee that it is will only change if
the contents of the files have changed
which is why most server implementations
use some kind of checksum like sha-1 or
sha 250 md5 whatever you know generate
these attacks what the client can then
do put these files into its cache and
when the user goes back and request the
same file somewhere in the future it can
put an if if non-match header in the
request and add the e-tag so the server
knows which version the user has
available locally and if the server sees
hey I have the same version here that
the user already has the server responds
with a 304 hmm meaning not modified and
you save the user re downloading the
entire contents ok and what this is
actually kind of it there's also weak
attacks which are you violated this is
begin to the W / does that stop us sons
for a week now wait attack okay which is
defined as the e-tag only changes if the
semantics of the documents change but
they're not necessarily byte equivalent
what does that even mean exactly analyst
foul Ray has never encountered them in
the wild
excite but you're saying that this is
what person expressed uses them by
default but my still does byte different
attacks I guess so what it means
basically is they only have an effect if
you're not doing range requests okay
because they are not byte equivalent
necessarily you can do range requests or
use part of it for a cache but as long
as the whole document you can use the
one you have if the e tags are
equivalent I wouldn't worry about it too
much we're going to cover our own
attacks later boom I think exciting
exciting
indeed so we are now in control of
delivering our own HTML files so let's
before you go any further if you've just
joined us we are doing some server-side
rendering today we are taking the
advanced routes that we did a few
episodes ago and instead of kind of
having a completely static set up for
the HTML files we're actually building
them on the fly in the server soma has
got some JavaScript code up and running
which is just at the moment sending us
out some HTTP basically and we have
somebody remarked that you have managed
to create a regular expression that work
the first time around which is
impressive and I would agree I watched
all time you know I was like I mean
that's unintelligible grinding it it
really is look at that in a few ways and
that you'll be absolutely terrified but
all the same well done so we basically
we've got this situation now where if we
have requested slash slash section slash
as in slash home slash or slash home
slash index that HTML we will serve via
this chunk of code on the channel and
then everything else is going to fall
through to our static hosting exactly
because there's not something Express
the the order in which you declare your
handlers or the steps is important
because Express goes through them from
top to bottom okay all right so now we
have a handler that we have to implement
and the reason I did this is because
let's look at our index.html the
original one which you might remember or
it might not
the thing is that between this
index.html the index.html and slash
about the one in slash contact they are
all pretty much the same except in the
SD SC view elements that we wrote the
actual for example this one home has
contents while the other ones are
declared as remote because we we are not
on the page right now but everything
above and below is the same for all
pages so let's split those apart and
this exactly I'm going to do so this one
is what I'm going to call the header
let's expand them so people can see
where I'm actually going
server-side rendering app and this is
going to be the header header partial
HTML and let's go to the rest and call
this D or come on don't always slow me
out of the folder there we go the footer
partial HTML so now we have plug the
file in header and footer and the actual
index.html will not contain much more
than this and I will add something here
which will I will explain later all
right so the actual index.html which
just has the countenance relevant for
this page is just one line in this case
because it's just one element I already
prepared this for the other sub page so
the about index.html also has just one
line same for contact just the content
for that actual subsection and the rest
has been split apart in header and
footer and what we're going to do now is
we're basically going to assemble the
header the actual content and the footer
in our Handler and I'm going to
introduce something new which is we have
been using the node filesystem model to
read files but the thing is that note
currently and they said they won't do
this anytime soon in the future
they don't use promises and reading
multiple files with a callback based API
makes my head explode and that's why
there's a module called modernized or MZ
which has wrappers around all these
basic api's from node and turns them
into promise based api's so we can do
now basically is we can do promise dot
all okay so you're doing three requests
and long for the header exactly so I'm
going to do app
header partial HTML coupe I'm gonna do
this is really depressing you're not
making typos Oh fine carry on app and
now we're going to need something here
which we're going to talk about in a
second which is index.html the actual
content of the section we want to load
and we're gonna read the app see the
typo yay I leave is just a pity typo
isn't it
maybe okay so we have to sort out what
we're actually adding and this is where
the regex comes in because I have put
parentheses about the thing that will be
the section we want to load and Express
being a nice guy we can actually go and
say the item that you want to load is I
think it's this let's let's check this
let's just send back our item so what I
did here is I'm sure I think it is
harems on the request of a good con
change the parenthesized parts of a red
X and it's going to set it back to see
if it actually works
so let's restart the server let's let
our screen into where is my Chrome there
we go this is a bit too small so if I go
here we shouldn't see much but if I go
here yeah we have about like at what
contact we have contact exactly what we
want so we know one question that's come
in is the routing that we have here yes
actively is it's different to the
front-end code that we had totally and
today where are we going to cover off
using the same routing or are we
completely avoiding that from yo cool
out the code that you wrote in the
advanced one was a disaster no that's
what use it uh
it's mostly gonna remain untouched we're
gonna do a little bit of treating later
maybe if we get to it I have an idea
that I want to try out new but for now
we're just gonna do the delivery part I
mean if we get this done it might be
interesting to talk about writing
JavaScript works in the front end in the
back and maybe even in the serviceworker
which is the try some morphic javascript
which is a great
that people came up with and but it's
for the future for now let's start rice
and that's that must be server side
client side and service worker based
routing yes which you know eventually
may be terrific so we figured out what
our item is so we can just put this in
get this great template expression so
I'll just put item here and what we're
going to do next is we now have an array
of files so in case you don't know read
file returns buffer objects we have one
buffers we want strings so what we're
going to do is we're gonna map over all
our files and say just string and say
this is utf-8 encoded and now we have an
array of strings and have an array of
buffers so easy it is so easy and what
we're gonna do in my pub I'm gonna call
me out on any owner yes we have enough
strings so now we can do response send
files join like this and because we're
good we're also gonna catch our errors
so if any any of these fails because for
example if any of these files don't
exist the promised at all will not
resolve but reject and now we can handle
that in the catch part of our promise
chain and say our response should have a
status of 500 for now and send the error
to straight okay so we're actually
enabling which usually and one-off code
doesn't happen
no that is pretty cool so it doesn't in
mind as we may have noticed
so let's restart our web server and
let's do curl because we haven't done
curl yet actually you know what let's do
curl
we're gonna use - Kay - I so you want to
see the headers but we also going to use
- Kay that means ignore certificate
errors because as remember we're still
serving over TLS with a self-centered
certificate and curl is going to reject
unless we give it - Kay as an option
some of you know that stuff off by heart
as well
I've done so much curl that I actually
know these didn't
um hey Sarah that's undefined Oh what is
it undefined
that's not nice item items the params 0
because if it's undefined we're gonna
use just an industry okay
the easy fix right let's restart the
server do another curl there we go so we
have reassembled the entire file because
you can see the header and the footer
however if you take a closer look you
will see that we have 5 SC views because
our header has all the remote views and
then we basically reiterate the home
view with the actual content which you
know it pro I don't even know if your
call handles this so you know don't do
it don't do it
I want to see break that's gonna break
let me open the console for for more fun
in in the error Department oh thanks pal
it's just broken it's just nice there's
my man error this is broken and just it
just yeah let's look at the code I
should be yet so as you can see here I
can I should zoom in zoom in a little
bit we have 5 SC views which is not what
we want so let's fix that and and one
typical thing or one easy way to fix it
is to turn our partials into templates
as we can use with a template engine you
know and my timer engine of choice in
this regard is because because I know
pretty well is handlebars okay it's
pretty common so what I'm going to do is
I'm gonna require in handlebars
handlebars require a little bars so
question here yes is it normal to end up
with routing in three places or is that
a no no um currently I would say it is
pretty normal
I'm assuming that something like twice
or more at least isomorphic you can use
in the front end and your serviceworker
is going to become a pretty common
practice so this is I think there's a
distinction here between just having the
routing altogether yeah so when you do
progressive enhancement you're gonna
build routing on the server side like
this anyway right yeah I'm just gonna do
well you got actually have api's and
content delivery all these kind of
things in you have right and then you
are probably going to progressively
enhance into some routing on the client
anyway and then if you progressive
enhance to have a serviceworker you're
gonna have routing in there something at
least you and you might do a
pass-through actually you're just kind
of going well you know unless you're
building Street on the fly in the
serviceworker for example which is don't
say that I will come back in the room if
I say streams too loudly that's Jake by
the way is safe I think nothing so far
some proof wall okay don't mess me who
anyway okay so it's probably pretty
normal and whether it's actually the
same code the isomorphic isomorphic
thing the person I'm not a big believer
and try some more because even though
I'm writing note right now that about
the only language you can use on the
back end there's like go peyten
HP come on yeah there's gonna say it
singly there's Java they're server pages
though and you can share javascript code
with a PHP back-end unless you're doing
really weird things and technically
there's still cgi-bin
that that is at yes please don't okay so
um I interrupted you I just imported
required handlebars and not embrace
you're just going to do is I'm going to
take all my files and for each file I'm
gonna say handlebars compile this as a
template and execute it with the request
as the context so that means that inside
our header content and footer we have
access to everything in the request
object but simply the item I'm just
gonna add item as a new object to our
request so that we have this inside our
context so I'm turning all the files
into shrinks compiling them with
handlebars executing them and then
reassembling the website what we going
to do now is we are going to I would
like to use handlebars
if but the problem is that handlebars if
only checks for truthy of faulty values
it doesn't actually evaluate expressions
what I would like to do is if if item
is equal to home then I would like to
skip this but this doesn't this is not
actually in this case it would be empty
because home is the default
that's um but handlebars can do so that
I'm going to write my own helper which
means if not equal this doesn't exist
yet we're going to write it
okay so let's if not equal so we have
one of these for every single section
exactly so we're going to see if this is
for about if you're just joining us
Surma and I are doing some server-side
rendering today we are taking the
advanced Russa from the previous
episodes and we are basically making it
rather having a bunch of static files
we're now actually putting in some
JavaScript to generate these files on
the fly and we're in the middle of that
process you're currently basically
making our templates and making the HTML
sort of dynamic so that it can be built
on the fly by the JavaScript that we
have and well observed thank you very
much I am actually here for the duration
and of course you can join us you can
ask your questions and there are some
some brilliant remarks already coming in
I unfortunately Jake is still shouting
serviceworker every other you can't you
second but it's um is well I hear it I
mean I read it and I hear it and that's
it's a big problem all the same do fire
in your questions and your comments and
we'll carry on on this one so you've got
handlebars you're making these damn yes
so now we we just you oh so we just used
if not equal even though it doesn't
exist so let's better make it in this so
there's a register helper call if not
exist and this is where handlebars turns
into black magic because it just gives
you as many parameters as the helper
takes and a magic options element at the
end what we're going to do here is we're
going to check if a is not equal to B we
are gonna options function this now this
is just something I have to admit I
memorize this because what what this
does is the options object contains the
function that will generate
the string that is in between our
mustache braces in the markov code and
this is just the context that we passed
in originally it's going to be the
request object basically what we're
doing is we're only going to render the
things in between our if not equals
blocks if a does not equal B which is
what we wanted to say what if not equal
so fingers crossed if this actually
works or not I'm going to restart my
server I'm gonna expect syntax errors
there aren't any oh yeah big show yeah
so let's restart this it's actually look
big isn't it that looks oh it looks like
it's actually corrects you come straight
to the contact section we can click
again that it gets let's look at the
code and as you can see we only have 4
SC views and the one that is actually
live is missing from the remote ones
okay so so it shift our goal of only
rendering certain parts depending on
what page we are currently on so that
means we basically just as she achieved
or a server-side rendering we are
injecting the content that is actually
requested before any JavaScript on the
client side runs and yet we're more or
less just delivering the same page over
and over our header and our footer so
what would you do in terms of say
caching this because if you build these
pages all the time what would you
actually do to say for example not have
to rebuild these every for every
individual visit you know let's do that
let's let's build good caching headers
so we're gonna before we sent the file
we just assembled our content so this
cut this content very well holds the
actual bytes that we are about to send
down to the client what we could do is
you could use these contents to actually
calculate a hash value of the contents
and use that as an e-tag so let's do
that
ah luckily mr. Lazarus node has crypto
he know in the last episode I asked you
what the German was for for CSS yeah
what would what would be an appropriate
is there an is there an appropriate kind
of German term for service high crime
rate yeah so like rendering I guess
could be called the vias Antigua for lag
Knowles fuel which is exactly we're
doing right now in case you're German
you know exactly what I just said
that's an again like always I've got no
tense of either remembering or
pronouncing it correctly but it just
sounds so cool well I'm still gonna call
it server-side rendering oh yeah when I
have more German let us know and I'll
make sure it happens hmm so we have the
contents and what we're going to now is
we're gonna calculate a hash and the
hash is going to be crypto a create hash
maybe actually let's let's lose note and
say crypto is require crypto and then
crypto create hash tag completion for
the win okay and we're going to use
sha-256 because that is a decently good
do some indentation we're gonna append
content
it's called update because you can
incremental e add data to a hash and
have it hash it over time if you just
have segments sy the function was called
update which I find a little bit
confusing and then in the end we want to
have a digest as a hex value so that
basic gives us a string of encodes the
hash value with a hex format and what we
can do now since we have the hash we can
go here and say um num num num respond
set set us a call that sets the headers
of our response we can just give it a
dictionary and in this dictionary we can
say for one we want to set the e-tag
which is our hash and because while we
were edit we can also set a proper cache
control
public no cash and this is something I
want to talk about because cash control
is such a complex beast I've been trying
to wrap my head around it and there's so
many facets to this entire thing it has
it can do so much that I just memorized
basically two things that I'm ever going
to use the cash control it can do like
private caches intermediate properties
you have control over everything but
most of the time you just want public no
cash and it sounds wrong but it's not so
something I used before when I didn't
know what I was doing was m-must
revalidate because that sounds right to
me right
so you're saying is that this should go
out they should try and get it from the
server again
before you know before and exactly so I
want the client to send a request to the
server using the cash checkers like if
not match or if modified since to see it
should always reevaluate the server if
the cached version is still fresh still
up to date okay
however must revalidate doesn't do that
because what must be valid actually
means is once the resource expires it
should be reverted it so what you would
actually have to educate about is max
age zero meaning it expires
immediately after reception it should
always regret it and as it turns out max
h0 and must revalidate there's a short
version which is called no cache so even
though it says look so even though it
says no cash caching is actually still
happening but with a validation round
trade okay um so we've got a quite a
question from somebody basically asking
whether the code will be visible
somewhere after the session and the of
course as always we're going to put it
on to our github repository we're gonna
link it up in the video description I
guess yeah um it's on our Google Chrome
Oh or can get up and everything's going
to be in there
yes it always has been with all other
yeah it goes narrow kind of umbrella
it's github.com slash Google Chrome
slash UI element UI - element - samples
we will link it you can find it
based off previous episodes it's always
in the description
and this code will got that bit of a
funny name UI element samples this isn't
really UI work today but I hope you'll
differently and then evolved so your no
cash was basically there to do the max
age zero must revalidate exactly
squishes down to no cash it's kind of a
shorthand version exact it's just a
shorthand really boolean so let's see if
I did this right I'm gonna kill the
server restart it
still no no era which is eerie like I
don't trust it no ah let's use curl and
actually I'm going to use capital I
which means only show me the headers
okay I don't care about the content
right now and actually let's start with
static fjs which is a file as we test
before that is delivered by the
middleware so we should have the
somewhat weird weak etag we're sure
enough will you and now let's request
something that is delivered by our own
function and we should have a really
long etag a sha-256 hash which we do so
then we also get your public no cash
there's only so that means that when
assembling our the header the content
and the footer we will recalculate this
hash every time and the user will only
read out it if they own don't have a
cached already perfect which is really
nice so now we have caching ideally
probably we would write a little bit
more complex code to not recalculate the
hash value every time but these are the
kind of things when I say this is not
production code this is more about right
and you'd probably you know consider a
CDN and other kind of intermediate
caches and so forth to make sure that
you know things only hit your server
when they absolutely have to but for the
purposes of today it was showing and if
this does come up on the chat sometimes
we aren't always going to jump to a
final solution that may be something a
prefabricated one and the reason is not
because we don't like them often they do
a very very good job but it's this is
our opportunity to kind of show the
underpinnings if you like the kind of
essentially the essentials the the
engine inside so that where it's about
their principles more than the code so I
think that both cannot be a pin
you have to know the base is that
certain frameworks are build upon to be
able to fix it I don't do what you want
for what's which usually if you use
favorites you will have run into the
problem that something is not doing the
same thing you would like it to do maybe
you go somewhere and they say you know
what we all we do is write Python and
you think I don't know I'm used to
writing in JavaScript and node what do I
do well if you know the kinds of things
the kind of headers you should be
setting the kind of ways you might be
it's more a case of plugging things
together rather than anything else so
that's kind of it's what you do word is
how you do it there you go
all right called me on this alright so
technically we just get server-side
rendering which is really really cool so
if we go here they should all be working
as it is before and we're actually
assembling these pages on the fly
however something that might be a little
little weird let me kind of disabled
cache
that's a zealot cache because I see that
we get three or fours which is not
modified which is good right that's what
we want exactly we want it but in this
case I wanted to point out that if we
don't have caching enabled that if the
site downloads contact it actually
downloads the entire site even though
again header and footer are pretty much
the same right and if you look at the
only current we actually need from
contact is the single line so we're
actually pretty being pretty wasteful
meaning download when the user switches
to another tab so that a little bit more
context here I think is that we're in
the JavaScript code we actually we
download the full document don't we
let's look at the header so yeah we
basically will say the route is this one
or not actually when we go to about the
SD View requests this website from the
server the entire thing and puts it into
the Dom put pulls out the particle needs
and switches out there but it takes the
app download the whole document and then
query selected out only that I wouldn't
so you're saying what we should be doing
is just just send down that little bit
yeah okay since we're going to throw
away the rest anyway go go on the server
side do it do it yourself
ah look at our index.html text in our at
our well index.html route I guess we
could do something really sneaky what we
could do is we could sue add support for
a cleric parameter okay so right now if
we do something like this you will get
the entire site oh we look at the entire
site what would be nice is that if we
add something like partial that we only
get the bits that are actually relevant
for our server side F our client-side
JavaScript so I'm going to do is I'm
going to check if partial is in the
request query dictionary and now add
logic so as you can see here we have a
lot of files that are being read but if
we have partial we actually only want to
read typos we only want to read this
file
oh my copy pasting is off the charts
today still better than mine so we're
gonna use let for once we're gonna get
low because you're gonna change it if we
have partials you're just going to read
one files if we don't we want to read
all the files boom
okay so you don't yes for partial will
only give you the little bit in the
middle if you don't know you will give
you the header the middle and the bottom
okay so let's a promise all files which
sometimes might be an area with just one
item in there and sometimes with three
somebody is asking what is the actual
benefit of server-side rendering ah you
know experience mostly and I I think I
touched on it earlier at the beginning I
guess if we didn't do this and we didn't
do like rendering out all the pages
ahead of time and saving them as
individual files the user would have to
wait for the JavaScript to spin up
mm-hmm so you would download all the
JavaScript build the page on the client
and then inject that HTML and usually in
between there's also request to the
server to get the actual data that the
user wants to see or you have to
maintain multiple copies of the same
index.html which is also which is
probably more developer experience but
also there's very error-prone because
the second you you do something wrong
everything can break apart so yeah one
of the superpowers of the web as well is
really worth pointing out is its ability
to stream if you look at a large
documents yeah if you look at a large
document on the web and it's like
several megabytes large it can still
render after the first few kilobytes
have arrived because it has hopefully
potentially for some inline Styles it's
got enough to get something up on screen
if you're gated on your JavaScript you
have to wait till it's like an entire
kind of bulk download is finished before
you can get anything on screen and so
having something that where the server
can immediately respond by going like
here's some HTML and ideally some inline
styles or whatever get that up on screen
and when the JavaScript and everything
else is ready then you can progressively
enhance into other things that's good if
JavaScript breaks which is something
that can happen on realizing I was just
on a vacation Indonesia where Internet
is noticeably slower than what we're
used to here you really feel a
difference of website do care about
delivering the right content on the very
first response for the site that need
javascript and everything to so get
started basically performance and
resilience are at least two answers
performance we're doing it on
supercharged gonna carry on carry on I
will
all right so we have files files and
we're gonna do the rest stays the same
so if it's just one file we're still
gonna turn it into a string we're still
going to compile with handle balls bars
even though nothing is gonna happen
there and then we're gonna create a hash
set the head rest and sent them back so
all the the pipe line stays exactly the
same we just added one if to handle
partials so let's see with curl if it's
actually doing what I want so I'm gonna
reset so index are us you got one
oh it's not assorted outside strictmode
now didn't you say to me earlier I'm
pretty sure that yes 20 I know I think
that's the case apparently apparently
you need to put in yes terribly I think
in new versions of note you don't need
to maybe I was on note 5 here no 0 5 6
or 4 so yeah I think that let's give
this a try again that's a good start I
can live with that
ok so now you can do you so let's start
that's the old version still work where
we get the entire document yeah yeah
doesn't and let's add partial and we
just get a single line which is awesome
and also it has a different attack
because it's a different document which
is good so let's go let's actually go
into your code and get to patch up your
code this is so exciting oh we talked
about is I write flawless code I it
let's look it is the Rooter the rue
turned into death I'm not gonna help you
now I'm a notes the view you takes care
of actually loading the data for itself
because you know that's actually
sensible design oh oh good saved it
alright so somewhere in here we should
have the XML HP this is the onload event
that there we go so what you do is you
call you just use data which is I think
the part of the URL that we've just
navigated to and the only thing we have
to do really is to append partial
I don't trust this so I add a partial it
means that now our client side code
should only load the data it needs to
refresh the views let's go back to the
browser let's go back to home and
refresh and because we have the preload
headers we already loaded the different
I mean I can go here it should still
work so everything looks right it is
good so it's still working and let's
take a look at what about actually load
it somebody is asking if you can when
you get a moment can you disable
JavaScript and just show the benefit of
Surfside rendering when this is done we
just switch off JavaScript right and
then it will just show that the links
actually work without well yeah cuz
they'll just yes medieval yeah okay so
he Ike nope like let's reload let's go
back to home let's reload height console
I'm going to click on about we load it
about partial and that means in response
be only loading a single line of markup
instead of the entire document which is
yay waiting for us so we're going to
save a lot of data so now let's do that
since we this seems to be working fine
we disable JavaScript home refresh okay
click around about contact me see this
there's no animation because we have no
Java through the dusky but still work
she's still getting to this this is the
this is progressive enhancements
enhancement done right because even with
our JavaScript that the site is actually
fully functional winning this is really
really good and then we just enabled
JavaScript again we reload our website
and we get our nice switchy
animations so in the end we just want a
back-end in about 70 lines I want to
give this one more try okay I just want
one I'm gonna actually IVF in speedy on
speedy the entire time and we saw an HP
one right yeah I I have no idea what's
going on here
I'm going to blame node for okay um that
seems like a thing if you want to know
why this didn't work follow me on
Twitter
that's Roma and I will figure this out
because this is bugging me yeah well
it's the only issue honey how the early
doors and you recover beautifully
I must say are there any other questions
on yeah how is the chat doing chats
doing brilliant there been so many great
remarks so many so many brilliant chats
in have been really enjoying I see why
you do this this is this is really we've
already really good from that we have
real nice people out there in the chat
yeah um so I guess what we know you say
we've got 70 lines of JavaScript we
going to push it up to the github repo
so that you can have a look around and
we'll probably add maybe a few comments
and hear that and I am absolute and I'm
gonna get you to move that regular
expression out from there that's rude
yeah I'm gonna clean that one up because
it's just that it's just it makes your
eyes bleed and nobody knows not good
it's really even the comment doesn't
help all right
okay we're done I think we're done
wow we got we got so fat rendering in in
under an hour
perfect okay well in that case I guess
all that remains is for me to say thank
you to everybody who's joined us on the
live stream don't forget that you can
subscribe you can follow us on Twitter
I'm at arrow twist and at the soorma and
we will catch you probably in the teal
DW teal tootin till I'll do one like she
does TL DW it was TW yeah I'm got it
right this time
well done me normally when they record
those videos it takes me a lot of takes
to get them the slightest thing right
it's a bit like my my typing it's a it
leaves a lot to be desired
it's his life on that exciting note
we'll catch you next time thanks for
watching
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>