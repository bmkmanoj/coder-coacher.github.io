<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Firebase Messaging -- Polycasts #59 | Coder Coacher - Coaching Coders</title><meta content="Firebase Messaging -- Polycasts #59 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Google-Chrome-Developers/">Google Chrome Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Firebase Messaging -- Polycasts #59</b></h2><h5 class="post__date">2016-12-14</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/AAZyQ4Ymkpc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey buddy what's up it's Rob Dodson
welcome back to the show so today we're
going to be continuing our series on
polymer and firebase by using the
firebase messaging elements that allows
us to add push notifications to our
polymer plus firebase app so to get
started with firebase messaging follow
me over here to my laptop and I've gone
to beta web components org this is our
amazing new web components catalog and I
just went ahead and looked for firebase
messaging they'll take me to the polymer
fire repo and once you're here you want
to make sure to go over to the sidebar
here where it lists all the elements
that fall under polymer fire and click
on firebase messaging now we can see the
doc specific to this element so there's
a few things that we need to do to get
up and running with firebase messaging
and I often forget these steps so I'm
going to try and do them first so I
don't forget this time the first one we
want to do is go down here to where it
says that we need a web app manifest and
we need this GCM sender ID so there is a
specific number that it has listed here
you know like 1 0 3 9 5 whatever
whatever whatever we have to use that
exact number in our web app manifest
because that is the sender ID for I
think Google Cloud messaging service or
whatever which is what we have to use to
send push notifications using firebase
so I'm going to go over to Visual Studio
code I've got this project that I've
already started when I create a new file
called manifest.json an inside of here
I'm going to paste just that one key you
might already have a manifest JSON for
your project you might already have a
few other things inside of there that's
cool just make sure that you include
this one key somewhere in your manifest
and then over in my index file I'm just
going to write a link tag and the rel is
going to be manifest and the href is
going to be manifest dot JSON okay just
like that the next thing we need to do
is we need to get some magical keys from
our firebase project I'm going to go
over to my firebase console this is my
project that I've already set up and I
can click on this little gear here kind
of my project settings and there's a tab
right here for cloud messaging so I'll
bump that up a little bit a little
easier to see okay so there's a couple
key
on this page I'm going to just go ahead
and take the server key and copy that to
my clipboard because I'm going to need
that later
and I also need this sender ID so this
is my firebase specific sender ID this
one is specific to my project so it's
different from that GCM sender ID that
we were just working with so I'm going
to copy this one go back to my project
and I'm going to find my firebase app
element which is somewhere in here here
we go and I believe we need to make sure
to add to this one messaging sender ID
and set it to that firebase specific e
that we just copied out over there okay
we've got that part set up now we're
ready to actually start adding firebase
messaging to our project we're gonna get
back to the server key a little bit
later but now we're actually ready to
start dropping some of these elements in
so I'll go back to the docs for polymer
fire and what's really nice is the
sample code here is pretty good so we
can just sort of follow it directly so I
want to grab this firebase messaging
element right here just copy that code
and what I'm going to build is basically
like a little toggle switch so I'm gonna
hit the toggle switch it'll ask them for
permission to send them notifications
they'll say yes it'll take that token
that's generated by that permission
grant it'll save that to firebase and
it'll also kind of give us an indicator
that we can then go ahead and send them
a notification and then we're going to
do that using some curl magic to create
that element I'm going to in my public
directory just like a new file called my
- subscription dot HTML and I'm going to
just start up by importing a few
firebase elements that we need we know
that we're going to need so we'll do
this from polymer fire we're going to
need firebase off we're going to need
firebase document any firebase messaging
and messaging and one more element that
we're going to need is a paper toggle
button so I haven't installed that yet
but it will just you just a second so
paper toggle button right switch over to
the terminal so we'll do our install
save polymer elements slash paper toggle
button so I'll go out and fetch it I've
already got it installed in my project
so should be good to go
switching back over to be
scription element that we were writing
just going to use a little code snippet
here to stub things out so let's say my
subscription cool
so in our template we can now just start
kind of like copy and pasting some of
the code that we saw in the fire based
messaging Docs so I'll just drop in the
fire based messaging element right here
then we go alright so what this is going
to do is it's going to create an element
that has an ID of messaging well we'll
use that later to access it in
JavaScript it's going to have a token
attribute which is just going to expose
to the rest of sort of the the elements
inside of this thing that we're building
and then when it receives a message it's
going to try and call this handle
message method which will implement a
little bit later the other thing we need
to do is just verify that we have a user
so I'm going to just drop in a firebase
off element paste this puppy in there
cool cool
all right so we use this in the past two
episodes we're kind of treating firebase
off almost like a model representing the
state of the user and in this case we
just want to get that user value out of
firebase off so once the user is signed
in we can use that value to then write
to specific parts of that users database
in this case we're going to use it to
save the token that firebase messaging
generates when the user grants it
permission so to do that we will drop in
a firebase document paste this puppy in
here alright so what we're going to do
with this document is firebase document
works very similar to firebase query
which I think we used in the last
episode firebase query you used to write
to the firebase database when you're
working with array like data so you know
a big collection of things like the to
dues in our to-do list
firebase document is useful when you
want to write to like a very specific
object so we're not pushing you know a
bunch of array like data we're just
writing like a specific value to some
field so in this case we're going to say
we want to write to slash users slash
user UID so this will be specific to the
user that's signed in and we're going to
give them the sort of token sub property
we're going to write to that field the
data that will fulfill that value is
going to come from this one-way token
binding which will be generated by
firebase messaging
basically what we're doing is we're
saying when the user grants firebase
messaging permission it's going to
generate a token we're going to save
that to the database and that's really
useful because in the future when you
want to send somebody a notification
you know you're going to check to see
okay is this user you know have they
approved a you know the permission to
send notifications yes or no do we have
a token if so let's use that to then
send them that notification all right I
want to set up a little bit of code to
actually you know ask the user for
permission here and this is we're going
to use that paper toggle button so it's
got a little bit that will paste in here
alright so we got a paper toggle button
with an ID of subscribe and whenever the
user taps it we're going to call this
toggle subscription method and then
we're going to figure out sort of you
know whether this thing should be
checked or not checked based on if the
user has already generated a token this
is like kind of a quick and dirty way to
do things I would actually probably
recommend if you're building them like a
more of a production app you sort of
have a separate property where you're
keeping track of whether or not the user
is subscribed but in this case you know
since we just want to get something up
and running we can use this approach and
then underneath where the paper toggle
button ask the user to subscribe I'm
actually just going to create a couple
paragraph tags to log the value of the
token and we're going to need that later
on when we use curl to actually send a
notification but normally you would just
store this in your database and you
would work with it server-side but in
our case we're going to use it so we can
we can curl against it okay so I need to
implement this toggle subscription
method so that the user can do the whole
permission off grant thing so if we go
over and we look at the documentation
for polymer fire they've actually given
us basically all the code that we're
going to need to stub out there we're
just going to copy this chunk right here
I'll walk you through what's happening
after we implement it so we'll say
toggle subscription is function and
we'll paste that in alright so what is
happening here so we're saying alright
find this dot dollar signed up messaging
so again that's polymers way of
referring to an element by its ID so
this is referring to our firebase
messaging element right here so we're
saying take that element call its
request permission method that's going
to then ask the user hey is it cool to
send you notifications and it's going to
return a promise and you know if that
promise of fills and we know that
permission was granted if that promise
fails for whatever reason then we know
that permission was denied this is also
a good place for instance if you wanted
to you could like differentiate
you know the users subscribed or not
subscribe and store sort of a separate
value in your database just you know
stuff like a flag is subscribed or not
you can do that inside of these handlers
but in our case we're just going to
prompt the user and once they say yes
then our fire based messaging element it
will get a token just sort of magically
that's how its internals work that will
fulfill to this firebase document
element so it'll write it to our
database and we'll actually be able to
go check the database to verify that
everything is working as expected the
last thing that I want to do here is
implement this handle message method so
this is going to run whenever we receive
a notification from the server so in our
case because we're working on kind of
quick and dirty I'm actually not going
to do very much with this but you could
normally do is you know display like a
toast or some sort of notification like
in the desktop site to the user but I'm
just going to console.log that a message
was received and we will just log out
the arguments which should give us like
the sort of like a data object showing
us the content of that notification the
cool thing though is if you were on a
mobile device like mobile Chrome this
would actually this notification as it
came in would just show up in the users
system tray automatically you don't even
really need to do any code to make that
happen which is pretty awesome
the last thing actually that we need to
do is we need to create a serviceworker
that can work with firebase messaging
and sort of receive those push
notifications even if the user is not
currently looking at this application as
their active tab so if we go and we look
at our documentation it tells us that we
should have a firebase messaging swgs
file so create that new file and the
contents of that file are linked to from
these fcm documentation here we go I've
copied this code from earlier but
basically what we're doing is we're
importing the firebase app javascript
file or importing firebase Messaging
JavaScript we need both of these little
libraries so that our service worker can
properly work with firebase services and
then we just call this one method
initialize app we give it our message
sender ID which if you remember we
copied out of our our project console
earlier and then we just have this
messaging property where we're just
saying for our base dot messaging that
just kind of like kick things off and
gets things
running I think at this point we might
be good to go and actually ready to test
this thing fingers crossed that this
works on the first try so I'm going to
run firebase serve that'll start up a
little local project so we'll go over to
a project here all right fresh the page
cool hmm let's see I think we're missing
something here
oh it's helpful if we include the
subscription element in the rest of our
project so go back to my app make sure
that we have imported my subscription my
subscription man I'm totally I know I'm
not spelling this thing right somewhere
but I'm going to power on see what see
what happens so I'll drop in my
subscription element right okay fresh
the page yes okay we have a paper toggle
button here so the user clicks the
checkbox it asks them hey can I get your
permission we say aha and that's going
to give us this big elaborate token
remember if we go back and look at the
my subscription element when the user
receives their token I'm just sort of
like writing it to the page so we can
use it to curl so I'm going to copy all
this text here kind of runs off to the
side there so grab all of that there we
go get all of that and let's see if we
look at our firebase console we can
actually see in the database that our
user has been established they have a
token that has been written to the
database for them which is kind of nice
and so the last thing I'm going to do is
I'm just going to use curl to simulate
sending this user a message now normally
you would probably do this work on your
server-side based on like some user
action you know but we're just going to
do it here from our console just to test
that everything works and I've saved
already this notification file because
there's a fair bit of code that we have
to write to make this work and I'm going
to post all this code on github
afterwards so you don't have to try and
like memorize all this or copy it down
by hand we're going to use curl and
we're going to here I'll close the
sidebar to make this little bit easier
okay so going to use curl we're going to
pass a header with our authorization key
so remember earlier a gap kind of like
two keys out of my firebase console I'll
go back and so you can see here so let's
see we go to our project settings
got a cloud messaging so there's two
keys here this is really long server key
and there was our cinder ID so I need
this really long server key and I'm
going to pass that as my authorization
key in this sort of curl header so that
is this first part here super long super
long goes on forever there we go so we
need that you have another header for
the content type we're just going to say
it's application JSON I'm patch to the D
flag to tell we're going to pass it some
data and the data that we're sending
sorry this is like a little hard to read
but the data that we're sending is an
object with a two value and the two
value is going to be our users token so
that really really long string here so
that helps identify their device if I
recall correctly so got to make sure
that we're sending it to the right
device so go all the way to the end
paste in that token right yep double
check that's right yep and then we send
them a notification object so this can
have a title field it can you know we'll
just say hello world and a body object
will just say this is a notification and
a last piece that we pass is this sort
of like address - fcm so we're going to
grab all of this we're going to go to
our console have a new tab here paste
that in run it so we should get
something that looks like this where it
says you know success one so far so good
go back to our project we can see here
in our terminal now I will here I'll
boost this up so it's really clear that
we've got a message received
so remember we were console logging our
message message has been received I'm
going to look at the object look at the
message a notification and can see there
is the content for our notification so
yeah if you want to tell your user like
hey you won some amazing contest you
1,000 free inflatable ducks you can do
that using that object so that is the
basics of setting up notifications using
a polymer fire again it's a fair number
of steps but honestly compared to doing
all this yourself in JavaScript it's is
a much much much easier approach so I
highly recommend everyone try it out if
you have any questions about what we did
today as always can leave them for me
down in the comments or you can hit me
up on a social network of your choosing
at hashtag ask Palmer as always thank
you so much for watching I'll see you
next time
hey folks what's up it is Rob thank you
so much for watching this episode if
you'd like to see some more we got some
over there and the playlist and as
always you can click the little
subscribe button to keep getting content
every time we push it up to the channel
again thank you so much for watching</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>