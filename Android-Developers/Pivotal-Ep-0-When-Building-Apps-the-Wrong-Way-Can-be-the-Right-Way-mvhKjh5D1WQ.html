<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Pivotal Ep 0: When Building Apps the Wrong Way Can be the Right Way | Coder Coacher - Coaching Coders</title><meta content="Pivotal Ep 0: When Building Apps the Wrong Way Can be the Right Way - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Android-Developers/">Android Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Pivotal Ep 0: When Building Apps the Wrong Way Can be the Right Way</b></h2><h5 class="post__date">2016-02-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/mvhKjh5D1WQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">one hoping to learn something new I'll
dive right in and start hacking
something together using my intuition
and Stack Overflow I want to invest a
couple of hours getting a feel for how
things work without worrying too much
about the right way to do it so if all I
want to do is build an Android app that
will automatically turn on my internet
connected lights when I get close to my
house do I really need to use fragments
services and intent receivers for me
step one is getting something to work a
proof of concept that what I want to do
is even possible its throwaway code that
generally no one will ever see but it'll
get me excited enough to sit down and
invest the time required to build
something real developing real apps for
mobile is complicated so as a developer
advocate I worry that we spend so much
time encouraging beginners to develop
the right way that folks like me will
get frustrated before they experience
the thrill of getting something cool to
work so before looking at why we can't
simply do everything within a single
activity let's go ahead and build a
prototype that does exactly that
so got the mainactivity this is going to
be our main form we've got nothing in
here at the moment so this is our base
layout we have text hello world so we
can keep this this textview because this
is what we're going to stick our
location results so that we can see what
happens as we're getting location
updates we want to give it an ID so
we're going to call this location text
so now we're able to get access to it
and we can change the text we don't want
that to be with hello world we want this
to show our location so I'm just going
to set this to none received so let's
find let's find a button drag that on
here I'm going to put it underneath will
change the text here to location on and
we're going to grab a another button put
it next to the first button
I call this one location off fact I'm
going to drop it underneath
so now we have a really simple layout
which is going to let us turn the
location manager on and off so we're
going to need to make sure both of these
buttons have IDs as well so that we can
get access to them and that D is button
on this one is going to be button off
and we're going to change that text ID
as well so that it's consistent with the
others this will be text edit location
now we are flip back to the main
activity
you
and we know that we have an off button
and we have an edit text
yeah we're also going to want location
manager so we're going to use to get
location updates location manager and
then we're going to want to use the on
button to enable our location updates
so we'll assign a new onclicklistener
and request location updates from their
using and the location manager
you
and then we will have like to turn off
the location let's know so do the same
thing for the off button
all right well first we know this is a
textview not an edit text
let's go ahead and create these values
meantime it's going to be ten seconds
distance one meter now for a provider
we're going to use the location manager
again get best provider criteria which
is enabled in fact we're going to go
ahead and move that in here
you
really the only thing that matters here
is whether it's coarse or fine
we're course is going to be what course
is going to give you a better battery
life and fine is going to give you a
higher accuracy really you're just
choosing between using the GPS or using
the Wi-Fi all right so now what we need
is a listener you could do that in line
as well but we're going to do that out
here
so at this point we're going to need to
have our text view
have a scope that we can actually access
here so let's bring it outside of our on
create and on location changed we're
going to set our location text
eventually we're going to want to update
this for now we just want to see it
updating as the location changes come in
if our location provider is disabled
we'll want to update the text to say as
much now in the real world you're going
to want to do something there which is
most likely find a different location
provider to use this is usually the GPS
got turned off for some reason
but again through our purposes we just
want to be able to see what is happening
so if we come down here we can see
something is underlined in red so what's
going on here now we need to get the
right access permissions to be able to
get fine location so let's do that add
permissions for fine location all right
so what we're seeing here is so what
we're seeing here is actually the new
permission model for M where we need to
ask for that flight location at the time
at which it's requested let's make this
a little bit more readable all right so
this is going to check to make sure we
have permission whether it be fine or
coarse depending on what kind of
activity provider we are requesting in
this case it's going to be fine but we
may change that and this is going to
handle both of those cases now what it's
suggesting we do here is if that isn't
the case that we call request
permissions another then pop up a dialog
asking the user if they are going to
allow us to use it so we're going to
need to override this method if the user
does allow us to the permission to use a
location
you
now here we're gonna want to enable our
location updates updates
which of course doesn't yet exist so
let's put that in here as well which
means we're going to want to call it
here of course that means we need to
move our location manager to a different
scope let's put them up here as well
you
now I'm going to take their advice I'm
going to call request permission here
you
now I'm gonna move this down here as
well
meantime in distance needs to get moved
also
this gets us far enough that we're able
to see whether or not our location call
works so when we fire up the emulator
and see what that looks like
you
let's start by turning a location on
so this is the permission I say allow so
just go with location and let's send it
so you can see the updates coming
through that location off and nothing
happens
now of course for our testing we really
like to see all of these instantly so
why don't we go back into our code and
change the update rates this should get
us all updates all the time so now I'm
going to tidy up a little bit and move a
few things around
my real goal here is just to separate
all the boilerplate code like listeners
click handlers and permission checks
from my app and business logic
this separation is also going to make it
easier for me later I'm going to need to
move and refactor it and pull it out of
this monolithic activity into the
appropriate services and intent
receivers
ideally I want to be able to see all the
code I'm going to be adjusting and
changing regularly on the same screen
now we know the next thing which we need
to do so we know that we're going to
want to react to the location changing
because the ultimate goal here is once
we get within a certain distance of our
house used to turn on the lights so
we're going to need at least one more
method which is going to turn on the
lights and we're going to call that here
you
okay so we need to find out whether we
are
set distance so we'll probably want to
have ways to set all of that in our UI
but for now let's just go and make some
statics so we're going to need to know
how far our current location is from our
home location
so we can do that by saying location dot
distance 2 and we can say here home
location which means we're going to need
to have a home location so let's do that
let's cheat do that manually explicitly
set the latitude and longitude right
neither of these exist
oops neither these exist I'm going to
interrupt myself here to point something
out you may have noticed that I'm
setting the longitude twice and never
setting the latitude that's something I
didn't notice at the time and it's going
to cause me problems later I'm gonna go
with Google's home location which I will
grab
so we have a distance which is the
distance from your current location to
the home location if it's less than the
turn-on distance which we've set to ten
meters then toggle the lights on which
is happening down here so we know that
we're going to want to turn the lights
on and often that this is going to be a
command over the interwebs we can't
actually are not allowed to access the
internet on the main thread so we're
going to have to move it into a
background thread so we're going to do
that by creating an async task which
create some simple handlers for us to
make this life a little bit easier again
like I said not the right approach to
this much better ways using services but
this is an easy way for us to get
started a sync task lets you move a task
into the background optionally reporting
progress while it's being executed and
then synchronizing with the UI thread
when that task is complete we can choose
to pass parameters and optionally return
a value from the background task here
we're going to use void to specify that
we don't want to use any parameters or
return any values I don't have an API or
s call to make that happen but let's
have a look we want to be able to have a
way of finding out that this is actually
happening why don't we return a boolean
all right so now we're gonna get a
return from the background task telling
us whether we've turned the lights on or
off I'm going to want to override on
post execute which is what gets called
once the background task has finished
and here we get the boolean returned to
us and okay we'll use a toast here
because this is now synchronized to the
UI threads so the on post execute is
synchronized to UI thread so we can do
things like this
all right let's have a look at what that
looks like on the emulator so why don't
we just go ahead and paste in the
specific Latin long for home know what
we're expecting to happen is I hit Send
and we should get a toast that tells us
that we have turn the lights on that
blank look corresponds to something on
the inside that looks a lot like this
notice that the lat/long value has
changed but I was expecting a toast and
there isn't one you and I know that's
because I set the home location
longitude to its latitude and it's
latitude to zero at the time I didn't
know if the problem was my asynchronous
code the toast or something related to
the distance from home calculation
I knew the lat/long coming in was
correct so I decided to update the UI to
show my current distance from Home
Instead that would be useful for
debugging and give me a clue as to what
was going wrong so now that we have all
of this rather than displaying the
latitude longitude which doesn't really
make me anything I mean we know what
that does now so what we're gonna do
instead is update our text string to
show the distance so we can see as we're
getting closer because that's really the
critical part that we want to have now
okay so we're getting a distance now
perfect
eventually I try plugging in the values
for my home location at the Googleplex
and the distance result is not what I
expected
so now I know the problem is the
distance calculation I spent several
minutes going down some blind alleys I'm
pretty convinced I'm transposing lats
and long somewhere but eventually I see
what's right in front of me
all right so you can see I sit back
latitude and longitude to the same value
and now we are much closer much closer
to our house in fact less than a meter
away which you'd hope given that it's
the the right value but wait it's that
face again I know my distance is right
but there's still no toast now I'm
annoyed what I said some breakpoints and
step through this a couple of times
looks like I'm getting the right values
at the right times the right code is
getting executed but still no toast
maybe I can't call a toast from within
an async task maybe I'm sending in the
wrong context to the toast
eventually I decide to take a look at
why the little red light bulb is
highlighting my code and and of course
you're going to want to show your toast
you
all right so there you go that all works
as you would expect it to so we've got
an app that's a pretty reasonable proof
of concept that it's at least possible
to do what we want automatically turn on
our internet connected lights when we
get close to home this screencast
represents about two hours of real time
coding most of what's being trimmed is
me thinking or going down wrong alleys
when debugging waiting for emulators to
spin up or trying to remember which API
calls I should be making now if you're
an experienced Android developer you're
probably getting ready to throw
something through your screen right
about now and if you've done even a
little Android training you're either
angry or confused and rightly so while
this code will technically work it does
a lot more wrong than it does right
which is why you typically don't show
people your throwaway prototype as you
can see from these red circles each
representing code that either doesn't
belong in an activity or has been
replaced with a new and better API both
not much of what we've written is going
to be kept and that's ignoring even
basic things like how to handle activity
life cycle events and potentially
leaking memory through allocation
listener and async task implementations
now turning this into a real app is
where the complexity comes in later
videos in the pivotal series will dive
into each of these issues in detail but
let's take a quick look at what a better
structure might look like for starters
in a lot of other platform paradigms
that main form is cinema synonymous with
the app itself that's not the case in
Android the only thing that should be in
the activity is the UI anything else
like requesting and receiving location
updates or making Internet API calls
needs to be moved elsewhere so a better
architecture is to have an activity for
the UI combined with services to provide
tasks when the UI isn't visible and an
intent receiver to react to context
changes even if the app isn't running
ideally this app will be almost entirely
autonomous you do need a night UI to
turn it on to set a home location and
the rest will then be automatic you
don't need to use fragments here but
encapsulating that UI logic into
fragments will make it easier to build
up more complex UI navigation patterns
later apps without visible activities
get killed by the
runtime so if we want to get continuous
location updates when another app is in
the foreground you'll need a service to
keep it alive within that service we can
either trigger the constant location
updates as we did in a prototype or we
can be more efficient and use the
geofencing API as available from Google
Play services rather than constantly
calculating the distance from home using
that API we may not even need this
service the light control API calls
absolutely need to be in a service all
Internet lookups need to be moved out of
activities and using a service will
ensure it can complete before the app is
killed finally we want to move a
location listener out of the activity
and listen for location change intense
from within its own intent receiver
class which will register in the
manifest we do this so that even if the
app has been killed by the runtime we
will still receive location updates the
app will actually be started
specifically so that it can receive
these location change intents and then
they can start the lighting service if
that's necessary so after a couple of
hours we have a working prototype and
the first pass of a more robust
architecture a good starting point to
start hacking away in earnest it's
important to understand the right way to
build apps but that shouldn't get in the
way of hacking and slashing your way to
a proof-of-concept before you begin in
earnest if you found this interesting
keep an eye out for my new show pivotal
where I'll be screencasting the process
of creating and upgrading a full
location and context based app using the
best practices and patterns that I
started describing here</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>