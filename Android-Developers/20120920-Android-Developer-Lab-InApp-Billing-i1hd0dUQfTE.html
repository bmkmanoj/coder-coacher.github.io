<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>2012-09-20 Android Developer Lab+ - In-App Billing | Coder Coacher - Coaching Coders</title><meta content="2012-09-20 Android Developer Lab+ - In-App Billing - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Android-Developers/">Android Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>2012-09-20 Android Developer Lab+ - In-App Billing</b></h2><h5 class="post__date">2012-09-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/i1hd0dUQfTE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right welcome everyone thank you for
joining us for another Android developer
lab plus yeah we didn't run the episode
last week but we are here today and
today's topic is actually not Billy
before I go ahead with introducing the
topic let's see who else has joined us
live so firstly I knew it hi guys i am a
little then I'm based out of Hyderabad
hi um i am tony chen i am i'm based off
of hong kong and i am an cacao and i'm
coming to you live from see me so let's
get started with this the first section
we have is news and Chinese won't you
introduce it sure so the first Neil we
have out this week is can we jump to the
next one please sure yep so we have a
new peak view number four for the our
Android developer tools are there is no
new feature but there are a lot of bug
fixes in this release the second news I
want to talk about is uh we we now
published the the app template
documentation so I think we need to jump
to the next the next two bullets to show
the short link so so basically are we
introduced earlier something called
application templates also is a is a
tool for developer to to easily get
started by building Android applications
and then we want to share this after
with developer so that you can be your
own templates and so we we have some
template guidelines on format
in order to be alone and is covered in
one of a Google+ post by our colleague
Roman Nurik and the shredding is here so
the third news are we I want to I wanted
to mention is we're going to have an
event in Hong Kong is a GE g google
developer group event in hong kong
coming up on the 24th is in the evening
in in the Kowloon side of Hong Kong in
the indoor center so the details are you
can find in in this short link and we we
have I and then I will be there and also
anchor and and yung felix we three of us
will be speaking on on andhra living in
different topics are so hopefully if you
are in hong kong or your your base in
hong kong we look forward to seeing you
on 24 thanks thanks honey so yeah we are
looking forward to meeting those
developers in Hong Kong last week or
earlier this week we've got to need some
developers in Korea and that was a
really great experience so we're looking
forward to seeing more in more
developers burning myself so at today's
topic as I mentioned is in a building so
in-app billing is something we
introduced a last year and it's really
taken the market by storm back then it
was called android market but it's
proven to be a very successful business
model for a lot of apps so you know it's
really enabled with the freemium model
where the app itself is free and your
users can get a taste for the type of
experience or utility that your app
provides and then they can choose to pay
pay for more of whatever it is that
you're selling in your app so don't just
think about it from a games point of
view it's also a great
migration path to convert breezes to
paid users so the old model of offering
a light version of pro version it's
still valid but really in our building
makes it even even better because you
don't need to have two different app
listings you can have a single one users
can pay for the one upgrade and continue
their experience from within your app
itself often when you upgrade from a
like to throw the user has to go and
download the pro version end up with two
different versions of your app on on
their device and you have to do some
extra work to you know convert whatever
data you had from the free version
divert into the paid version so in that
building really enables that that paid
model very well so today we wanted to
talk about well how do you go about
implementing in that building and then
we would love to hear some questions so
just an overview with in-app billing is
there's really two types of items that
you can have one of managed items and
these are typically things that you only
buy once and we'll talk about the
details of these we have an unmanaged
items as well now when it comes to the
implementation side of it there's
actually you can do it an in-app billing
implementation that's entirely client
side or you can have a version of it
where you've got some of that data
stored on your server and we're going to
look at how about that process varies
between the two and what advantages in
distance you can have so managed items
these are typically as i mentioned items
that you only buy once so if you have a
book or an app that's like a book might
have some episodic content where you
provide chapter one of of that app or
that content for free and then users can
pay that unlock chapter 2 and then
chapter 3 and so on and in the case of
game it might not be chapped as it could
be leveled it could be characters and so
on and so forth and now one of the
features that we have ended up giving is
that your client your app and actually
asked to replay transactions and this
sort of thing is useful for users that
kind of install the app on multiple
vices and you want to make sure those
purchases transfer across but you know
there can be times where if you found
some some greater is in your logic where
for some reason that that transaction
even though it was successful your app
hasn't picked it up you've got this
option to replay transactions and
restore the user specific so managed
items are really great they called many
diamond because we we allow you to be
able to replay them we track them for
you server-side the next side the next
type of items are onion any guidance and
these are not typically the type of
items that you only consume or purchase
once so in the case of a game it might
be some in game points so you want to
allow the user to purchase these coin
packs more than once or it could be
potions you know whatever in the case of
an act or a service that you're
providing you could also do something
like charge do you ask the user to pay X
amount of money every month or every
year today I wouldn't actually using
that billing for for that recurring
payment because we actually have
subscription billing which is very
similar to inactivity but it
automatically sort of recurs for your
refreshes so subscription billing is a
separate topic but i guess the end this
slide is talking about unmated items now
because they are unknown guided it means
that we as in Google Play don't manage
them for you you can't ask to have them
replay so you need to keep track of this
this state information yourself this is
where some of that server-side
implementation may actually help you
alright so let's out go to the next
slide this here is a flowchart and what
we want to what we want to show you is
kind of flow that you get from your
application and how those requests and
responses work so the top half of your
of the screen is in the Google Play
server and then everything below that
dotted line is really the device itself
now for in-app billing is there's two
critical components one is your act the
other part is the Google Play fine and
we're going to see how the Google Play
client is really involved here so what
happens is in terms of
how we secure this data we actually have
a your app will have a public key that
you generate the place over has the
private key now from you from your app
what you do is use your billing service
to make a billing request and what app
is actually when you make that billing
request it's making it locally on the
device to start with it goes to the
Google Play client the Google Play to
client then actually forwards on that
building because to the Google Play
server where it's processed and the
users have an opportunity to you know
say hey I want to pay for it using this
credit card or you know if they've
bought a Nexus 7 they might have some
credit left over so they may choose that
purchasing option but anyway so it's
process to the Google Play server side
and then we get a response that signed
by the Google Play server with that
private key we talked about that
response is passed back to the Google
Play client which in turn passes the
response back your app to your billing
receiver component you then use that
public key to decrypt that message and
process it how you want so that's
basically telling you hey you know the
purchase succeeded or occasionally may
even tell you things like the purchase
failed and there are a number of failure
states that you do need to take care of
for example the users credit card may
not have had the funds or the amount of
purchase may have been defined or
whatever reason we have extensive
documentation on those scenarios that
you need to support on
developer.android.com but this is the
client version and you can see it it's
fairly straightforward when we look at
it step by step let's now talk about a
version of this where we introduced your
own server so you see now we have two
dotted lines so I love the topmost
dotted line we have the Google Play
server and in the middle there in
between the two dotted line is the
device and we have the Google Play fine
and your app and then below the dotted
line we have your server now you'll
notice that the public key is no longer
sitting in your app itself with now
sitting on your server let's help where
we're going to use it but let's now look
at the flow of how this part of it works
the app will make the the bidding
request which gets forwarded on to the
moon placer lock the Google Play server
will respond and sign up with the
private key and then that sign response
will actually be passed back to your app
to its billing receiving but so far it's
actually the same that client-side
version this is where it differs your
app will then take that whatever
credentials it has and pass it to your
server including that that sort of
signed response so let's do a deep dive
into what that that part of it is the
your app is it your server side so what
happens is your server takes those
credentials and returns back a section
poking through your client it's
obviously utilized that public heat or
will do so but we take that session
token' into your app your app then
request content with that session token
now you know you should follow the best
practices around new section poke them
make sure they expire after so for so
long and you know but the point of this
token is it's really hard coded between
your app in your server it should really
be used to set up a session every time
the client contacts to server so once
you pass that back content with the with
that session token you can then your
your server can then return to content
now this is that scenario with the
unmagnetized you can do it this way if
you want to track information server
side now of course this is going to work
for device because presumably when you
add those credentials we're getting some
information from from your app now on
the server you may choose to have your
own user accounts on your tracking them
so that when the users fire up your app
they're basically saying hey I'm signing
in as Bob and my password is password
123 and then your servers able to track
which for that particular identity what
items man unmanned items have been
focused and then that way you can your
store safely
so that's the best a server version of
not really so when you're developing
this you probably want to do a lot of
our sample testing or prototyping so
what we've implemented are some test
ideas in a reserve that you can use to
simulate different scenarios so this is
a good way to actually verify the code
if using automated unit tests you can
use these product IDs when you make the
request so that you get responses back
straightaway and they're you know
they're simulating the response request
response to it it's not actually going
to hear go through all those steps that
we talked about the during development
you use this but there comes a time when
you want to actually test with real
purchases so there are a few more steps
that you need to do when you're testing
real purchases but you need to go into
your publisher site and register some
test accounts now these texts accounts
are typically any other Google account
so let's say I'm the developer and I'm
sitting here on them saying hey look we
need to we need to add our testers and
Tony a nun you of them I on my casters I
would go and grab their in another dress
register it on the publisher site but
that when users when I even Tony making
requests it knows that me the test
accounts and I'll tell you why it
becomes important what we then need to
do is that go and upload our APK to the
Play Store but leave it in an
unpublished thick because right now
we're testing it right we don't want to
publish it and make it available to the
world then what we do is go and add our
products you know the in-app purchases
that we have we're going to go and add
those to the publisher site and here is
a very important part you need to go and
publish those items there and then so
don't leave those items in an
unpublished or draft state because
otherwise you your app won't be able to
find it we will say hey I didn't
recognize this particular item lady and
it's perfectly safe to publish these
items because your app has still not
been published so nobody else will be
able to make those purchases
in fact and this is where those texts
accounts are important only those texts
accounts and the publisher account will
be able to make those purchases because
the app is still on the publisher items
you can leave your app on public so once
we've added our excuse or our appt our
product with what we would do is install
our app on a real device you can't use
the emulator the emulator doesn't have
the google play store on all right and
remember we as we said earlier you need
to Google Play client to to actually go
and make these purchases now for those
test accounts that we call for that they
have to be the finely divided and
primary account on each of those devices
with the testing one by primary account
ideally what you want to be primary
account the notion of the primary
account has become a little bit fuzzier
they're typically it's the first account
that you added you a droid device now if
you've got some testing devices in there
some other accounts on there what you
will need to do is do a factory reset
and then go and add those particular
point test accounts that you registered
step 1 then those test accounts can go
on mu 0 apk and make purchases now these
are going to be real purchases right the
way you're going to go through the whole
process of actually building those
credit cards when you make these
purchases so on the publisher site you
need to go and manually refund those
registers when you're finished testing
that part is really important if you
don't go ahead and refined their test
purchases you can rack up pretty large
bills so we it is your responsibility to
go and manually refund those why the
publisher set so that's it during the
testing phase you're actually exercising
the full end-to-end purchase mechanism
and we're actually getting responses and
we're making requests to the new play
point and getting them back from the
Google Play server as well so you really
simulating real world situations Mulder
I don't want this more thing to add them
on testing as a so recently we have a
some issue with uh with testing account
set up for for for billing testing and
it was an issue on our end and they gave
some developer impressions actually they
cannot test a building with with good
test account so but it's actually it was
a issue earlier and that should be fixed
now so so testing went a second should
be should be working now okay right now
that's a good point on um yeah this was
something over the last couple of weeks
but we believe it's sleeping resolved if
you had some issues and it should be
fixed now if it isn't please do laser
personnel yeah okay ah so that's that's
a really high level overview of the not
billing and we today wanted to just
introduce the concept we know when you
developers are using though and that in
that building has been very successful
in blue the plate and we think that the
more developers should adopt the use of
in-app purchases or in-app billing
because it does at the end of the day
provide a really nice into experience so
with that let's take some questions we
don't actually have anyone live on the
Hangout today so if there's people that
can post on it on the three the hangouts
on air Fred that's on Google+ stream
that would be great and it's not like to
move to do the moderator now I would
just like to add something to to the
presentation here some developers have
asked me about support in different
countries for in-app bidding and because
we use the same water infrastructure
behind the scenes it's pretty much the
same support as a seller support for
paid apps so that's one of the
considerations for it up today ok you
want to bring up the moderator thread
yes so the first question there is and
this is from Ian orange California
the first question is I'd like to use
in-app billing for donations is this an
appropriate use of would you recommend
using an external system Tony would you
like to take that up Tony we cannot hear
you
sorry so for in-app billing for donation
so we don't have any like a special
policy to defend developer using in-app
billing for donation but one thing you
need to keep in mind is so for donation
using google wallet is it just like
regular how you use Google Checkout wall
and in the past life or doing a photo
nation you have to be a verified valid a
nonprofit organization in other words
it's a 501 C 3 or 501 C 6 organization
so we have a we have a process to verify
these organization and as long as you
satisfy this disappointing reader than
then you can you can use enabling for
donation okay thanks study the second
question is most this from Romania and
the question is most of my clients are
requesting a calendar component into
their applications so far I was using a
custom calendar component from a github
user I was wondering if you uh sorry I
was wondering if you're thinking to
reduce a standard widget which will
support this functionality we do not
have a UI widget for calendar building
that you could embed but starting I
think ICS we do have a calendar provider
which you can query to get the calendar
data and kind of use the widget to put
that on your application yeah so
anything more you guys would like to add
no um I guess the the calendar widget
that we provide for users today and it's
part of the AOSP as an android open
source project so you can certainly go
and have a look at the curve for that
that widget today and see if you want to
build
something similar to that yourself
thanks thanks uncle also if if you're
using a pre ICS device or writing for
pre ICS devices there is there is a
calendar API that's part of the Google
API client I really and people also get
calendar user character data from there
once you authorize using or so okay
let's move to the next question which is
again from Romania hello trying to
remove a dialog when coming from back to
front talks gives me an illegal state
exception cannot perform this action
after on save instance state can you
help me on this matter so this this
seems like a lifecycle issue I not have
any specific answer I do not understand
what you're trying to do so maybe if you
have some code trying to remove a dialog
so is this a fragment dialogue or a
regular progress dialog guys do you have
any you have any inputs from from memory
this sort of issue because it is
definitely a lifecycle issue and it's
because some certain code is being
invoked out of sequence basically you're
relying on I'm trying to remember what
the details are because there's several
ways to end up in this that I think
you're trying to rely on the state of
certain it could be a fragment and yeah
so so high from what I remember like the
this this exception tends to happen in
two places one is if if someone trying
to to to do things in the in a sync task
and or trying to update to a Fremen
transaction when when when when using
the async task or using loaders because
some because some of this operation can
be can still happen actually even the
activity go go out of the screen so so
and pastor the safe instance date and
the framework is very conservative
trying to prevent these kind of the
state happen even in reality most of the
time your activity is still in not in
that state so um I guess I guess the
solution or I think we you really need
to look into whether whether is property
to update the UI actually in those
scenario and because the things could
happen actually after after this after
the activity cut recycle or pastor save
instance date so you you have to see
whether it makes sense actually trying
to do some of these UI updates and one
way to to to avoid the exception but
poor not necessarily the best solution
is to have a flat to keep track of what
state you're in and and and if you if if
your if your stage is not actually
invest in that's in that state you just
you can do the fragment transaction or
things otherwise or just skip it because
you don't you're not actually your
activity is not actually on the UI
anymore so what thanks Danny so yeah
just look for a life cycle method before
unsafe instance probably on pause or
somewhere and you can place your code
for removing the dialogue there
depending on whether it's a progress or
fragment dialogue you may need to do a
fragment transaction psychic I think
that's it we that that's all the
questions we hadn't moderated so yeah
that that kind of
bring us to the end of this hangout guys
you have anything more to it yeah just
one last thing next week's hangout will
just for next week we were changing the
day of the week that we're doing it so
only next week we're going to do it on
tuesday tourney and i will as we
mentioned we're going to be in hong kong
on monday we're also going to become
from on tuesday so we'll be running the
hang out together in the same location
for once from hong kong on tuesday so
stay tuned we'll make the post the new
time and a moderator link for you as
soon as we can so do that and again if
you are if you happen to be in hong kong
at that under 24 please join us too to
the GTG even at night under 20 under 24
so anchor and I and come Felix we will
be there and we're happy to meet with
you guys and talk about Android or
anything Google ok well thanks everyone
for joining and we will catch you next
time thanks bye bye</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>