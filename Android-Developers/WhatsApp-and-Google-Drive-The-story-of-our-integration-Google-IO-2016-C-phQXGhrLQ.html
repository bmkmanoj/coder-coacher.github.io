<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>WhatsApp and Google Drive: The story of our integration - Google I/O 2016 | Coder Coacher - Coaching Coders</title><meta content="WhatsApp and Google Drive: The story of our integration - Google I/O 2016 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Android-Developers/">Android Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>WhatsApp and Google Drive: The story of our integration - Google I/O 2016</b></h2><h5 class="post__date">2016-06-03</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/C-phQXGhrLQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">well welcome to Google i/o 2016 it is so
great to have you all with us here today
my name is Mike Procopio I'm a software
engineering manager on the Google Drive
API team and my name is Randall Safa I'm
a product manager at what's up
so what we're here to talk to you about
today is a feature we built into
whatsapp for Android which lets you
backup and restore your messages from
Google Drive and we're here to tell you
a little about how that went and how
that came together and some of the
challenges we had with that ok so kind
of a high-level overview of where we're
going here today we'll take a look at
messaging in general right and as well
as the space where mobile devices are
starting to proliferate significantly
and usage is really hit an inflection
point a combined with the with cloud
storage and Google Drive in general
we'll take a close look at how this
works including some technical details
from both the product and engineering
standpoint along the way we did face
several challenges we'll we'll look at
some of those what they were both from
the product and engineer extent points
as well take a taking a closer look at
the drive API and then followed by a
live demo so borrowing from Sundar's
keynote yesterday we truly are in the
moment of mobile Mobile is seeing
massive adoption across the world there
are 3 billion connected users and we are
seeing over 50% of search queries coming
from mobile some notes from sundar x' of
the CEO of Google sundar x' founders
letter from 2016 the mobile phone more
and more is the remote control of our
lives and we're using these devices in
ways that we didn't even think we're
possible as a few as a few years a few
years ago just advanced for me
so also from sundar think about it's not
just messaging and communications it's
content generation its media generation
more and more we're using these phones
to take pictures there was a tipping
point when when cameras started to show
up on phones where the barrier to entry
to actually taking a photo or ten photos
which month is much less than it used to
be right so take a series of ten photos
sundar had noted that and it's not hard
to see how we arrive at this number we
could end up with a trillion photos
taken across the world this year if that
seems when you start thinking about it
that's maybe a billion people taking a
thousand photos a year if I'm doing my
math rights that's like two or three
photos a day that's not a lot I take
that many selfies in one day so I'm
clearly part of the problem here yes
yeah this they're just a little slow so
when we think about messaging what we're
really thinking about is connecting
people around the world right in the
most fundamental way you can do that is
by letting them text each other and
we've been doing that for years and
years but the messaging space has
evolved we now let people do much more
than texting we let them you know send
photos and videos we let them you know
call each other over VoIP and we let
them do this on a wide variety of
platforms right obviously and with the
goal of connecting people around the
world part of that goal means allowing
everyone who has any kind of a phone
really talk to one another so what does
this look like in the whatsapp world
well how many people here by the way
I've ever used whatsapp or our whatsapp
user okay great
so you are a very small fraction of our
total user base we've got over a billion
people across the globe using whatsapp
it's about one in seven of it's about
one in seven people on earth using
whatsapp regularly it's a pretty high
number
we've got about 75% of those users on
Android and the rest of them are using
one of our other supported platforms
which include iPhone Windows Phone and
some older OS is like blackberry or some
older Nokia platforms that we developed
for to give you an idea of how engaged
those billion users are they send a lot
of messages it's about 42 billion
messages sent per day so really when
we're thinking about whatsapp we're
thinking about a product at scale
of course whatsapp is more than just
texting it includes sending photos and
videos voice messages location messages
contacts and most recently we let you
now send documents on whatsapp so you
can pick a document from your phone you
pick one from Google Drive or another
source pretty cool media actually
represents a pretty significant portion
of the messages that get sent per day
we've got 1.8 billion photos sent per
day on whatsapp and we've got 250
million videos sent per day it's a
really high usage in terms of media
there we are Thanks so complementing
client devices and client applications
like whatsapp we also have cloud storage
so data in the cloud is all about safe
and storing what's important to you and
an important part of this is the the
ability to access your data from
wherever you're at so increasingly that
means mobile devices once things are in
the cloud sharing and collaboration
becomes easy and naturally expressed in
particularly sharing collaboration
around teams and so more and more we
live in the cloud and more and more
we're doing things via our mobile
devices double click there we are so
Google Drive is a cloud storage system
that is focused on both enterprise and
consumer users it's a safe place for all
of your files it can store any different
any type of file that you have including
some things that we may not usually
associate as being file like so yes you
know photos media documents spreadsheets
text file CSVs but also things like maps
insights and diagrams things like that
importantly you can view it and
increasingly interact with it not just
view but actually rich edit from
anywhere across all sorts of client
devices sharing with others is a key
part of the the value that Google Drive
delivers and then finally as we will see
a little bit later which is important to
our integration there is a large
third-party app ecosystem with open and
mature api's double tap come on
Thanks
so our joint mission then is to work
together to preserve the memories of a
billion users so why did we do this in
the first place well fundamentally
whatsapp doesn't store your messages and
what I mean by that is what Seth doesn't
store your messages on our servers
really your chat history lives on your
device so all the messages you're
sending the media you're sending it's
all stored on your device and not
somewhere else so given that that's the
case
it's important that if you switch
devices or you lose your phone or you
upgrade phones you have the ability to
preserve all the chat history that you
have so we thought for our Android users
the best way to do that would be to use
Google Drive and there's two reasons for
that first turns out most Android users
have a Google account already signed
into on their phone so this means that a
user can opt into this feature without
having to create a new account of some
kind or authenticate to another service
so it's really frictionless in that way
so we're really trying to build a simple
mechanism for users second is Android
devices have really good support for the
drive API which means as a user who
wants to backup your stuff to Google
Drive you don't need to install
additional software right most of the
stuff lives in Google Play services so
it's ready to go as I mentioned before
we're really talking about integration
at scale which mike is going to talk a
lot about a little bit later now in
terms of how this actually works in the
product we want to walk you through some
of the challenges we had and also some
of the decisions we made in terms of how
to design this user experience so our
backups are opt-in what this means is
that we need a user to actually turn on
Google Drive backups and we obviously
want a way to do this that is really
obvious to the user right we want them
to know the feature actually exists in
the first place so we designed a full
screen activity that prompts users to
opt in to Google Drive backups and we
present them with this activity on a
time interval it's about once every few
months it's a little you know we we ask
them kind of up front when they're using
the app and we back off to once every
few months by the way the reason we do a
time based approach as opposed to saying
hey maybe we'll ask a user when they
update the app is because we update our
app frequently
right so that gets annoying so you don't
want this to become noise you want it to
be meaningful to the user first thing we
ask them is to select a backup frequency
daily weekly or monthly and the reason
we actually do this is while our backups
are incremental there's one part of the
backup it's a small part of the backup
that actually gets backed up fresh every
single time a backup is done so by
dialing back the backup frequency
choosing a less frequent backup cycle
you can actually save some data some
bandwidth and importantly a lot of
whatsapp users are very conscious of the
data usage that they're using because
data around the world is much more
expensive right so we're trying to build
controls for our users that allow them
to really say how much data they want to
use and be able to preserve that if
necessary we ask them to connect to
Google account most Android users have
just one on their phones we
automatically choose that one when they
connect the Google account you just get
presented with a system level prompt
asking you to connect Google Drive to
whatsapp it's a permission prompt and
the last thing we let users do is decide
whether they want to backup videos or
not the reason we do this is because
videos actually represent a pretty large
portion of the overall backup size or
they can so on average between a user
who backups videos and one who chooses
not to do it there's about 300 megabyte
saving on average so you can really if
you don't have much Google Drive storage
or you don't really want to expend the
bandwidth to back that up you can choose
to not include the video if you want
okay so I opted into backups I got my
stuff backed up now how do you actually
get that data right so I switch phones
or my phone you know drops in a toilet
something like that I get a new phone
how do you actually get all your chats
back well we app basically ask you to do
this at registration time right you
install whatsapp tell us what your phone
number is and then we look for a backup
when we find a backup and the user
decides to restore it the restore
happens in two stages first we restore
your chats and what I mean by that is
really just the chat database which is
kind of mostly just text messages
doesn't include any media so that's a
smaller portion of the backup right and
we do this synchronously so we don't let
the user into the app until this
finishes there's a reason for that when
the user actually ends up in the app we
want them to see all their chats right
away right otherwise they're going to
think something my
what might have gone wrong we lost some
of their data or something like that so
we restore the chat database
synchronously
however with media because that
represents such a large portion of the
overall backup size we do that
asynchronously so we let you into the
app and if you look at the bottom
screenshot here we basically restore the
media in the background and we kind of
tell you that at the top of your chat
list this means the user doesn't have to
sit around waiting for a huge backup to
restore potentially right and if they
have slow Network or they're you know
doing this over cellular for some reason
that way there in the app ready to go in
their media will restore we actually
restore your most recent media first
right which makes sense because you you
know you're most likely to see that in
your chat history and we're always
monitoring network conditions right so
you know we pause the restore if you're
if you drop off Wi-Fi or if your battery
gets low or things like that I'll make
one comment about the UI here we
actually designed some animations and
the restore process and the reason we
thought this was actually important was
so that the user has an extra indication
that progress is happening right so the
dots animate in the top screenshot or
those two arrows animate in the bottom
screenshot letting the user know
something's going on when the restore is
paused or something's not happening we
actually stop those animations so just
reinforce in the UI
to the user what's actually going on and
from there you get your chats back and
you're ready to go
okay so we've had a pretty clear look
from the on the product side for how
this works both in terms of backup and
restore flows which are the two main
flows in this integration let's back up
a little bit and from a backup from a
higher level view and check out the
architectural overview for how the
overall system works so like all good
architecture diagrams first off these
these colors I spent a lot of time on so
I hope that they work all good
architecture diagrams start with the
storage server storage services on the
bottom the kind of the clients at the
top and that's what we have here right
so notice the drive clients and whatsapp
client on the top the very bottom you
have both whatsapp and Google Drive
back-end server technologies so on dry
side we'll see this a few times in this
integration there's two key services
involved in accept in managing files
right
there's the service that handles binary
file content so the actual content of
the file and then all of the metadata
which is stored separately and optimized
differently because it's a different
kind of use case so things like title
and mime type of course there's a
business logic on top of that and a good
caching layer probably many caching
layers the solution to all known
computer science problems and quite a
few bugs actually caused quite a few
bugs one of the key things about the
slide that that influences our
integration is this unified first party
and third party drive API that's a
section in the middle and that's the
team that I'm fortunate to work on and
what this is is the programmatic entry
point into drive you know traditional
API one of the key takeaways of this is
at the same set of api's the exact same
end points in the exact same server
infrastructure serves both first party
drive clients like Drive on the web Mac
PC Android iOS Chrome OS and the entire
third party ecosystem including whatsapp
so what this means is there's anything
you can do with a first party app you
can do with a third party app - a few
specific exceptions around security and
so the according to the diagram whatsapp
client has their lightweight wrapper
around Drive api's they're calling the
exact same set of endpoints that we do
so when the user opts in the backup
files will become uploaded via the entry
points and the drive API go through
several layers of caching and then
finally end up in our storage servers
we're still
or is the similar pat on the way back
out thank you
let's take a look specifically at what a
back up flow looks like because this is
a pretty brilliant engineering piece on
behalf of the whatsapp team what's that
product and engineering team so at the
end of the day we're making API calls
against the drive API that that's the
methods that you see here on the left
traditional create read update delete
crud restful api sorts of methods that
you should probably look at these may
look familiar so first we're gonna look
for backups that's what this list is
about right we're actually querying by
title we're looking for both the main
folder that indicates the backup as
present as well as the media folder
every backup has a file map which
contains links to it contains a list of
the IDS of the files stored in Drive
that could that matched the the media on
the device so we're basically looking
for that once we find it we read it in
and then we begin the backup and what
this means is doing a differential
comparison between what's on the device
and what was on the existing file map so
it's basically a diff because one of the
important things is we don't want to
reach up load things we've already
upload bandwidth conservation is
critical for this use case finally so
we'll start uploading media items we'll
upload the message database and we'll
upload the new file map and then
something very important happens this
fourth line from the bottom this
properties insert call up to this point
the network connection could fail the
phone could disappear and the users
backup would still be intact this is a
really sound defense-in-depth robust
engineering on behalf of the whatsapp
client because it means that only when
we finally make this switch to the new
file map updating a pointer basically do
we actually is the new backup in place
finally we'll do some cleanup and
deleting the old files any items that
are not on the device that we're in
Drive are also cleaned up restore flow
is comparatively simple doubt reads tend
to be a little easier than writes we
look for a backup if a backup is present
we can prompt the user as we'll see in
our demo we'll get the contents of the
file map to actually find the IDS and
then we'll begin background restoration
of the user's media in the background
and then
user can begin using whatsapp right away
so quick technical details I have a
slide here Randall has one as well as
far as HTTP libraries we use HTTP oral
connection on most modern devices this
integration drive backup is supported
fairly on I think gingerbread and but
for older devices we will use the Apache
HTTP library authentication is typically
a very tricky area but on Android
fundamentally what it comes down to is
using OAuth 2 where you can get a token
which is available built in Android API
s and then finally you have to pass that
token and a restful api call as part of
a header and then finally rate-limiting
is important both in terms of client and
server things can fail on the server you
know transient error is that kind of a
thing so the client has robust
retry with exponential back-off
implemented few other technical details
so we actually use the HTTP API for
Google Drive rather than the drive Java
SDK the reason we do this is the SDK is
kind of big and I was pushing us up
against our 64k method limit so we
decided to go with the HTTP API it's
also a little bit more flexible in terms
of how we could design some of the calls
that we were making I also want to
mention the backup window right when do
we actually backup and we do this to
optimize we choose a backup window that
optimizes for whether the person's phone
is going to be charged and connected to
Wi-Fi so we think usually that this
happens at night right when you're
sleeping
so you charge your phone at night if
you're at home you probably have Wi-Fi
so we kind of optimize for that
condition so we basically say we pick a
four hour window it's something but I
think it's like 2:00 and 6:00 a.m.
between 2:00 and 6:00 a.m. and we
basically for a given user randomize
when they'll back up the reason we
choose a random time for the user to
backup it so that we don't really bring
down Google servers by having a bunch of
people you know wake up at 2:00 a.m.
have their phones wake up at 2:00 a.m.
take a backup off right this would this
would be pretty bad so we kind of choose
a random window that helps us really get
where we want and of course we're always
looking for Network conditions battery
etc right so we won't take a backup off
if your phone's battery is low we won't
kick one off if you're not in the right
network condition but once
you are in those proper conditions we'll
just start the back up right so if I am
asleep at night my phone is dead by the
time I get to work in the morning and
plug my phone into the charger we'll
just kick the backup off for that day at
that time so we're kind of flexible
actually in that way so where are we at
today so we fully rolled the feature out
in January of this year took a several
months to actually roll it out
completely and we're going to talk about
the rollout process a little bit later
as I mentioned before we got over a
billion people on whatsapp 75% of them
are an Android and of our Android users
we have about 40% of them opted in to
Google Drive backups today so pretty
good numbers that will likely continue
to increase over time as people get
prompted as I mentioned once every few
months
good well I know we make it look easy
but the truth is there were a lot of
challenges along the way and we're gonna
take kind of a very transparent
behind-the-scenes look at what some of
these some of these were so first and
foremost with an integration like
whatsapp we think scale how can we
accommodate an integration this size
with a billion users with daily daily
backups backing up new content as its
generated how do we absorb the initial
backup data that's on the user device
when they're when they're opted in right
because that's a large kind of initial
upload and then once that's finished
it's more of a natural thing multiplied
by a billion users and things start to
you know times an opt-in rate and things
start to get very interesting quickly
large-scale can mean a lot of different
things users and we're talking a billion
times the opt-in rate that's measured in
hundreds of millions of users Drive API
queries per second you know if you have
that many users making backing up at
night you're talking queries into the
hundreds of thousands of uploads per
second which is pretty intense for any
any service you know that's that's
that's that takes a lot it requires a
lot of instances of Drive server
backends at the end of the day drive and
the API and all the backends it is a
server we're listening for requests on a
socket and any given JVM any given task
or instance can only handle so many and
so what do we do we just start spinning
up lots of these instances to kind of
handle all the requests as they come in
and load balancing and and and kind of
comes into play they're also not just in
terms of this server production
engineering but the storage capacity
matters both in terms of size of the
items stored which matters when we're
writing file content to the the binary
kind of service as well as number of raw
number of items so for all of these
reasons this is a super large-scale
integration that takes a lot of very
careful planning in particular when we
talk about capacity planning we're
talking about provisioning and the
conversation went a little bit like this
somebody heard that we were working on a
whatsapp thing they called it and they
asked me how big it was it was like
pretty big and so at Google we think
pretty big they're like oh it's like a
Gmail we can handle that
no it might be bigger and at that point
people start to get a little nervous
because if you don't properly
provision you're going to take down
truly take down and overwhelm active
servers that are trying to fill requests
from other people so provisioning an
estimation is critical especially for an
integration of this size so we need to
estimate it well how can we do that two
general approaches this kind of give a
quick overview of how we do this in
practice you can model it right you can
model it from first principles so you
have a theoretical way to do estimates
total of number number of users times
opt-in rate number of files that every
person has number of files that each
user generates over time on a daily
basis different types require different
resources for example videos get
transcoded into multiple formats for
playback on different platforms so
they'll impact us in different ways so
that's your model and like all good
models there some saying about this
there they're there they're useful to
varying degree what we find to be a
little more reliable in this case is
empirical observation so we do a trial
rollout with what saps beta users they
have an excellent beta program and then
we say that's a portion of the overall
user base let's multiply it by that
scalar factor in our case these two
roughly agreed and so that gave us a
good confidence that this is how how
these are the resources that we need to
provision so want to talk a little bit
about bandwidth reduction as I mentioned
whatsapp users we have users all around
the world right and so we're really
interested in making sure that we're
using only the amount of data that we
need to use making sure that's efficient
and trying to speed things up right
trying to make backups quick restores
quick so one of the primary ways we do
this is backups are incremental right
for the most part so this means that if
I backed up a photo one day I don't need
to go and back that up the next time I
go ahead and kick off a backup make
sense one of the other ways we do this
is we actually have byte level resumes
for uploads and downloads of every file
so if I'm uploading a photo and the
connection drops and for some reason I
don't finish it I can actually just
resume at the byte level that upload
right really efficient to do that dosnt
so this especially comes in handy with
larger media files if you think about a
video that might be
see megabytes this type of thing
actually comes in handy
we also optimized a lot of our API calls
we do batch deletes who removed files
right so a user goes and deletes a bunch
of photos from a whatsapp chat the next
day when we do the backup we're going to
need to delete those files on a Google
Drive so we patched those up and do it
and when we're fetching files at the
time of restore we actually fetch the
metadata for those files simultaneously
right so we don't have to make
sequential API calls in order to
actually do that the last thing I'll say
is when we're actually fetching the
metadata for files we only look at the
fields that we really mean there are I
think dozens and dozens of them and we
actually only look at about a handful
right so we're actually optimizing how
we're actually reading the metadata so
that we can again optimize the API call
for efficiency all right another
challenge is it has to be fast and it
has to work we call that performance
reliability we have a saying fast as our
favorite feature speed matters we are a
service right we're designed to fulfill
requests from all sorts of applications
often where a user is waiting speed
actually counts for backup is it's a
little bit different it's unintended so
typically the between the hours of 2:00
and 6:00 a.m. and a backup window
sequential upload is okay speed is not
as critical but at the same time we do
want to be fast we because every while
if we're slow the device is still on
we're using Wi-Fi or using connectivity
that translates to battery so we want to
be as lean as possible even on the
server even for an unattended use case
restores attended the user is waiting
they've as we've seen the demo where
we're restoring our items they're in the
background maybe the user is waiting for
that that content to be restored so it's
important to be fast one way we can get
around this is to parallelized downloads
it turns out that pulling bites from
concurrent streams works pretty well
scales well and doesn't chew up any more
CPU than you would expect from linear
and you get the expected almost
theoretical theoretically optimal
speed-up in terms of user a perceived
latency so fast is great but if it
doesn't work at all then basically it
took an infinite amount of time right so
we have to actually answer the request
reliability is important this is hard
for backup this is hard for writes right
because you're writing to multiple
systems you're dealing with you know
four or five megabyte files you're
buffering things you're chunking you're
opening up upload sessions you're
finalizing them you're writing the
metadata one once that's done you're
doing post processing post processing we
have to do this super reliably what does
a reliable mean well that I mean that's
a varying degree but in general if you
are talking about for example only one
in a hundred thousand or one in a
million requests failing in that kind of
range that's pretty good because for the
requests that do fail a simple retry
will certain who likely clear it up and
users will have will generally have no
idea so for knives for example is a kind
of a reasonable target and it's quite a
feat when you're talking about writing
data at that scale so despite all our
best efforts for reliability things
actually do go wrong and this is
actually a you know handling errors is
actually both an engineering challenge
as well as a user experience challenge
here's why when something goes wrong you
don't want to constantly tell the user
that something is wrong right otherwise
they start to think your service is
reliable this is especially true for
things that happen that where we can
recover gracefully from them so I'll
give you an example let's say the users
phone isn't on in the backup window
right so their phone is off at night we
you know realize we can't perform a
backup at 2:00 a.m. we'll just wait and
defer the backup until later in the day
when the proper conditions are met same
is true for network sometimes we get
miscellaneous server errors right like
error like fight like err 500 that we
don't really know exactly what's going
on
so we just kind of wait we try the
backup again if it works it works if it
doesn't we're still kind of silent about
it and I'll tell you when we're not so
we have a class of errors where it
actually so that's a class of errors
that sort of we can recover silently
from but we've also got this class of
errors would that require user action in
order to recover from so a great example
of this is authentication let's say you
go and change your Google password right
you forget to update it on
Android device well at this point we
can't actually authenticate into Google
Drive in order to backup so we actually
tell the user immediately for that type
of an error to go resolve this issue
because we know that no matter how many
times we're gonna try this backup it's
never gonna work unless the user does
something about it
another good class another good type of
error that have another type of error
that happens in this category is storage
issues right let's say you run out of
Google Drive quota where your phone runs
out of storage those types of things
again we tell the user explicitly please
go fix this thing so for the errors that
we can kind we think we can recover
gracefully from what we do is we keep
trying and we don't tell the user this
backup hasn't occurred for several days
right so say I have daily backup set one
day the backup doesn't work we just kind
of wait we try it the next day if it
works it works great we kind of if by I
think like the fourth or fifth day at
that point will tell the user something
maybe he's not going on but really we're
trying to just do this graceful in the
the balance we're really trying to
strike of course is you don't want to
annoy the user into thinking this thing
isn't working but also you want the user
to actually be able to back their stuff
up because even losing one two three
four days of messages could be pretty
painful sometimes right hurts to lose
that data
okay let's talk a little bit about
rollout we're gonna cover this in detail
so how did we roll this out well we
distribute what's happened two ways
we've got an apk download that we
distribute on our website and we have
also distributed through the Play Store
obviously a vast majority of our users
get it from the Play Store what this
means however is that you can actually
test things test updates with the
website population so that it because
the population is small and you can kind
of actually use that almost like a beta
testing pool so we started there and we
did this as a percentage rollout so we
said hey we'll roll this out to 5% of
our website users and then ramp that up
and then we did a percentage roll out
for our Play Store users percentage
rollouts really important obviously
because we don't want to just turn this
on all at once we want to find the bugs
that we have in the client we want to
make sure the server's can handle it all
those types of things right so we
monitored this very closely because
again we're dealing with user data this
stuff is precious you don't want to
screw it up
of course even when you're doing your
percentage rollout one thing to keep in
mind is that there are there is a
natural user upgrade cycle right so say
we ship you know a version of whatsapp
with Google Drive in it we enable it for
5% of users not everyone's on that build
yet so they're gonna upgrade over time
so actually in absolute numbers the 5%
grows right so keep that in mind that's
another interesting thing that we have
to deal with towards the end of the
rollout cycle we shifted from a
percentage roll out to a regional roll
out Mike's gonna tell you why we did
that and a little bit and of course just
some you know critical things that we
did client monitoring was really
important so we were constantly
monitoring success rates for backups and
restores we were constantly monitoring
you know if a backup was failing what
type of error were we seeing and this
led us find bugs and make optimizations
along the way to make all of this more
reliable on Mike's side they were
obviously doing a lot of server
monitoring to make sure we didn't bring
down Google servers which we mostly
didn't and communication is key right so
actually our teams communicated
frequently every time there was a client
change that we thought would affect the
way the server would respond we were
communicated that and we still do that
today so communication really good when
you're dealing with this type of thing
okay so let's let's take a look at what
the rollout actually looked like and it
will speed things up here a little bit
this is an actual graph of queries to
the drive API from whatsapp so you kind
of see on the Left we had our preview
rollout where we're kind of testing
things out to see how how things are
scaling everything was working great
from that were able to understand how
much provisioning we need so there's
kind of a quiet period while we allocate
the resources plan the rollout and then
we start gradually bumping three bumping
things up a couple of percent three
percent at a time we wait for that and
we see how things behave then at some
point we were ready to do daily rollouts
and that's a session in the middle not a
whole lot of sleeping right now during
this phase three percent a day until it
was basically done there was an
interesting point that we'll talk about
here where we had to pause the rollout
for for some reason for some regions
we'll take a look why and then after the
New Year we resumed it and then towards
the end we kind of had this natural
linear s growth at full roll
next slide so one quick look we for one
of the more interesting things that
happened in the rollout so data centers
and services there are lots of data
centers around the world they are not
uniformly distributed and what that
means is is that you have kind of local
data centers where file uploads will go
but also at Google and many places not
all servers or services will run in
every data center seems like it's fine
you can you just bounce the traffic back
and forth but it turns out to be
interesting in the in the following
scenario so broadly speaking here you
know we have data centers on various
continents there's a data center that
accepts upload kind of in the west of
the Pacific and there's a data center
east of the Pacific that drive runs in
and particularly metadata storage layer
what was happening was we were uploading
the data into the local data center that
was no it's great super low latency it
was good post processing around
checksums had to be done a drive because
check sums are part of the metadata to
do that we needed to do calculated
checksum you need the file content drive
did not run in the local data server
that a data center rather that the file
upload service ran and so what was
happening was Drive was pulling all of
the bytes across the Pacific from that
data center I mean ultimately were
shipping bytes in a pipe right across an
ocean that pipe is very very much
limited it's expensive to use and if you
saturate it things like YouTube could
start to be impacted so we had to pause
our rollout for the regions that were
impacted and here is what we did the
solution to this was to what we pause
the rollout we moved the post processing
and drive in particular the checksumming
into the same data centers associated
with the regional uploads right so then
all the post processing was done we
didn't have to transfer you know
petabytes upon bed petabytes back and
forth and everybody was happy we were
able to gradually resume the rollout
that was that was a very interesting
kind of scenario quick look at the API
and ecosystem I think we're doing pretty
well here on time a lot of time for a
demo here so the drive API has has been
around for almost 10 years now
slide for me and it very powerful and
expressive it can do a lot of things
that you would expect around file
management uploads and downloads of
course applicable to our use case
revisions listening for changes on a
file or a folder or drive wide full
programmatic management of sharing and
permissions applicable to to this
integration of the use of custom
third-party properties push
notifications and as we noted before the
first party drive clients so drive on
web and Android iOS everything all use
the same set of api's so we have a rich
third-party ecosystem because we've had
open API since 2008 this is part of our
platform this is not an afterthought
embracing the developer community is
part of our mo our DNA our vision it is
something that we are paying very much a
lot of close attention to so apps that
do everything imaginable have popped up
in the past almost decade the fact
seeing editing rendering syncing and
backup data protection data validation
data integrity enterprise use cases
document workflows games music players
anything you can think of has probably
probably been done in this ecosystem so
this is an example of what some of the
apps look like right now in the Chrome
Web Store the variety of apps is
reflective of increasing number of
Android apps embracing Drive api's for
varying degrees including storage and
backup like the whatsapp news case all
right here is a graph of drive API
growth and one of the key things to take
away here is that we want to embrace the
third-party community what that means is
we understand that scale is important we
know how to scale and we understand that
your apps meet to scale as well so
whatever quota you need we are able to
grant we are watching this very
carefully more provisioning along the
way and you can see we have a nice kind
of linear growth that we're planning for
on an ongoing basis and as long as it
continues roughly linearly people are
generally generally happy here so this
looks great last 300 days on that
all right demo time do ya I think I
think we have a perfect amount of time
here so we wanted to demo the end-to-end
flow what could possibly go wrong as we
like to say we can switch over here so
what we'll do is we'll Randall and I
have a conversation going if that's
showing up there yep we're gonna take a
selfie we're gonna back it up we're
gonna clear the data on the device and
then attempt a restore using Google i/o
Wi-Fi because we like to live
dangerously okay but here we go 50/50
shot
exactly all right what are we doing what
are we getting smiling respecting a pose
excellent
all right yo maybe just an emoji there
just for good measure
all right so there it is
showing up there looks good all right so
to trigger manual backup thanks yeah
user can backup at any time to trigger
you know I for I have mine set up to
that update backed up every night chats
and chat backup we can also backup
manually so first we look at the we
create a local backup we're going to
query drive to figure out what what
things are there what things are on the
device and do that kind of differential
computation we figure it out we upload
the new photo that's happening very
fairly quickly which is great when
that's done remember as we saw before we
update the pointer to the new file map
which basically says this demo this
backup is alive and ready to go that's
what's happening now it's done in and
out in 15 or 20 seconds so that's also
the incremental backup happening right
there as you see how quick it's actually
going right just a minor amount of data
has changed in between so let's go ahead
and clear things off of the off of the
device so first off what we can do and
I'll show you like the coolest little
there we are
yep
that'll get us into storage clear off
the data and the cash from the local
device and then importantly we also need
to go into the actual built-in storage
manner manager here on Android which was
a neat little thing that I found under
storage and USB you scroll down there's
this cool little thing Explorer here
this is a natural built-in Android file
manager so we go to whatsapp whatsapp
store this media on the SD card and I
can actually go ahead and clear that
they say what we're doing is we're
simulating what would happen if someone
got a new phone right like they're not
gonna really have any data on their
phone yet they're not gonna have
whatsapp installed so all these things
don't really exist right so what happens
in the world when you get a new phone so
you install whatsapp you're back at
registration we're gonna ask you for
your phone number first so we are
officially now in a kind of a zero state
cleared off everything as Randall said
will uninstall it and then I actually
have a local version of it right here
under downloads let's have apk so we'll
install it locally again and that should
trigger the restore flow once that
installs so what that'll do is it'll
it'll you op opting-in the user will be
prompted to be able to restore their
their items when it's ready
this happens after account setup and
verification which is based on your
phone number and then then the key thing
to note about restore is that it
although all the media is actually
restored in the background anything else
you want to say about this this flow
I'll show you right now is where we do
this is part of the process one thing to
keep in mind when we look for backups
and registration it kind of requires the
Google account being on the device so we
have some logic for you know letting a
user know like hey maybe you don't have
a Google account on your phone if you
backed up previously why don't you go
ahead and sign in so you can actually
restore it we also only give you one
opportunity to restore that's at install
time the reason is is because it creates
a lot of complexity to do it later in
terms of how you merge chat databases
and do all those types of things so we
just kind of give you the opportunity
upfront restore it it's just much more
reliable to do it that way
I set up my account it was automatically
verified by a SMS you can see the
notification there and then here as
Randall dis noted we look for a backup
and we found a backup we have the
opportunity to restore from the cloud so
importantly we're also showing the use
of the size of this we say like this is
how much we're actually going to
download so when Mike actually hits
restore what we're doing is how would I
mentioned before we're restoring the
chat database first we do this
synchronously so these are your messages
we let you know hey 6000 of them are
restored and we actually tell the user
your media will be restored in the
background so when Mike actually comes
into what's app you're gonna see
something at the top of the chat list
that says restoring media and that's
gonna kick off you know getting all your
photos your videos etc which again are
the biggest part of a users backup
typically you can see that right there
as I mentioned before we restored the
most recent media first so if you
actually go into our chat you'll
probably see the photo that Mike sent
already restored right so we optimized
for recent messages which obviously
makes sense you want to see that stuff
up front and that's our demo cool thank
you everyone for your attention for
being here today
we really appreciate it having a chance
to kind of give you a behind-the-scenes
look here</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>