<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>20. Ecommerce Website Tutorial : PayPal IPN PHP Instant Payment Notification Script | Coder Coacher - Coaching Coders</title><meta content="20. Ecommerce Website Tutorial : PayPal IPN PHP Instant Payment Notification Script - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Adam-Khoury/">Adam Khoury</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>20. Ecommerce Website Tutorial : PayPal IPN PHP Instant Payment Notification Script</b></h2><h5 class="post__date">2011-01-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/XxlLIHodXBA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello and welcome to part 20 and the
final part of the e-commerce website
building lesson series part 20 leaves
you with an IP n script that I will
supply you with that I wrote using my
blood and sweat and tears alright so for
you to have a cool little system there's
one more thing I have to put in cart top
PHP this variable is going to let your
ipn script know what the person checked
out for which Product ID and how many of
that Product ID they checked out for
this way we can cross-reference the
amounts in the database to make sure
that they paid the right amount for what
they had supposedly checked out for so
the first thing we'll do is go down here
where we're rendering out the PP
checkout button under the for each loop
and I'm going to put a line break there
I'm going to add one more variable
that's going to be sent and it's going
to be named of custom which you can
cross-reference that list that I gave
you in part 19 of this video series I
gave you guys a couple of links in that
list is the custom variable that you can
research it just lets you pretty much
send a custom variable whatever you want
and I'm going to send a variable called
product ID array so let's take product
ID array and we have to initialize that
up top above the for each loop right
here with all these other initialized
variables so let's get that one in now
to assemble that variable is pretty
simple you go into the for each loop and
let's put it right here under dynamic
checkout button assembly there we go
to create the product array variable so
the product array variable is going to
be I'll show you what it will look like
it's going to look something like this
so the first product they buy is ID of 6
the second product they bought is ID of
8 third product they bought is ID of 3
so string would look like this 6 and
then the quantity and then a comma then
product ID of 8 the quantity for that
and a comma then the product ID 3 the
quantity for that and
that's what that string is going to look
like so the product idea of eight if
they had five of those quantity would be
five so you can see there's the ID - and
then the quantity and a comma delimiter
pair so that's what it's going to wind
up looking like this Product ID array
we're going to need that in a my ipn
script to do the price checking
automatically so your ipn script will be
sent a custom variable because you're
sending that custom variable to paypal
initially so it's going to send it back
now remember to make these variables in
this script correct for your site and
you have to create these pages paypal
cancel that can be just a static page
that says you have canceled your
transaction continue shopping it doesn't
have to be anything special or magical
just a page that says you cancelled your
transaction and then check how complete
that can be just a static page that says
thank you for your order
now here's little hint you can get PDT
variables from paypal post it to that
page by setting this rme variable to two
so once you set a return this is the
page that they'll land on when they come
back you can get PDT variables from
paypal automagically on that page just
by assigning this artim variable to two
so if you wanted to say thank you John
Smith for your order
grab it event you can get all those
personal variables back from paypal but
I'm not going to be showing you that
because this is part 20 we're done I'm
just going to show you the ipn script
that way all of these variables come
back to your back-end system for each
transaction so say you want to do things
like give people instant downloads or
things like that you'll be open to do
those sort of things with ipn script
alright so now let's discuss the paypal
ipn script now before I explain this ipn
script you should now be able to
download it along with all of the other
files I place the source code link in
the
turn of this video you can get all of my
code now from the entire tutorial series
if you need it now this is not the first
PHP ipn script ever written in fact if
you just go to google and you type into
the search bar paypal PHP IP and example
the first result is PayPal X the CMS
paypal comm and you see here's the
paypal api's IP n PDT and this is the
payment data transfer variables that I
was talking to you about for the return
URL if you ever want to implement those
but instant payment notification is the
one we want we want to see an example of
ASP ColdFusion Java Perl PHP we want to
see the PHP example so there you go so
PayPal themselves shows you a nice PHP
example and a whole bunch of other
examples I just wanted to show you that
because there are there's got to be
thousands of different I PHP ipn script
examples that you can get the one I'm
showing you here I just happen to custom
write for our tutorial series so it
might benefit you to look this one over
and use this one and I'll also have you
note that I have not tested this I just
kind of wrote it out from what I think
it should do with our little custom
system so this script works with our
system here in a custom fashion but I
coded it without testing it so if it
fails it's up to you to make the
programming meet the logic but what it's
intended to happen in it is after this
video I'm moving on to other material
not looking back at this series we've
gone good and deep here so if this
script doesn't work like I said I
haven't tested it I just wrote it out
for how I think it should work if it
happens to not work that way just make
PHP do it PHP can do anything so all you
have to do is have a plan and then
attack it with PHP knock out every
little piece of the programming you need
as it comes your way okay here's how it
works
Shopper checks out at the PayPal gateway
right when they check out and make the
payment PayPal is going to send
variables behind the scenes to this ipn
script waiting
on your server when those variables come
and hit this script we're going to
gather them all up we're going to send
them back to PayPal we're going to kind
of bounce them right back to PayPal
PayPal is going to gather them up there
again verify everything and bounce it
back to us now let me explain the code
this first section is if the server
requests method is not equal to post
then we make the script die because we
have to make sure there's posted
variables coming to the script that we
can bounce back to PayPal for
verification okay in the next part we
initialize the request variable and add
CMD key value pair the CMD key value
pair is needed for the paypal callback
paypal is going to be looking for the
CMD variable and its value here that's
the first set of many key value pairs
you're going to stack into this request
variable so in this for each loop what
you're doing here is you're gathering
the array of variables the whole array
of posted variables coming into the
script and each one is a key value pair
and we run URL encode and strip slashes
on each value then into the request
variable we stack each one as a as a URL
encoded variable with key value pairs
separated by the and time that's what's
going to get bounced back to paypal and
that happens in this section of code
right here now in all of the ipn scripts
that I write I like to use curl so you
can see I have a little note here it
says now post all that back to PayPal
server using curl and validate
everything with paypal and here I put we
will use curl instead of PHP for this
for a more universal universally
operable script F sock open and the F
functions in PHP sometimes have issues
on some environments so here you'll see
a curl posting mechanism so you can send
variables using curl instead of PHP F
sock open and other functions that may
not be available to the person
programming the store and using ipn
script on certain servers and for those
of you interested you might want to know
about PayPal sandbox PayPal also has a
testing environment called the sandbox
where you can run your ipn scripts test
everything
just like it was a real operating store
you can do the real checkout process
there it doesn't use real bank accounts
it uses dummy bank accounts and dummy
people but you can test your actual
store in the sandbox environment I just
like testing live if it works live I run
it alright so at the end of line 28
there that's where it's finished posting
to PayPal and curl gets a result back so
once that results is back we can check
that the result verifies right here now
what I'm doing here and this line of
code is not very important at all I'm
just taking the and symbol out of each
key value pair and replacing it with a
line break that way it will be rendered
more like a list since we're done
sending that to PayPal we can do
anything we want with this request
variable which is stacked with all the
variables that are being posted to the
script which are a whole bunch so here
we check that the result verifies let me
expand that so you can see it so you're
checking to see if the curl result is
verified or not if it is verified you
can put in the request variable list the
very bottom it will render in this
PayPal verified okay if it's not
verified you put it in the bottom of the
request variable list data not verified
from PayPal and you mail yourself all
that information along with the request
list so the request list and this little
message here will arrive in your email
inbox you have to make sure it's very
important that you change all of these
you at your email comm to your PayPal
business email address so anywhere in
this ipn script where you might see you
at your email dark I'll change that to
your PayPal business email address it's
very important and you'll get this
message if something goes wrong if
everything is ok the script will
continue to execute if things are
verified in PayPal which they should be
if things are operating normally
ok let's collapse that backup now we
check these four things before
processing the transaction and you can
handle them any way you wish the first
thing is make sure the business email
returned is your business email because
in the posted variables that are coming
to this ipn script there's going to be a
business email variable you want to make
sure that you
that's your business email and I have
this script for these these checks one
two and three four you can see I have
the checks the scripts laid out a little
examples of how you can check things
number two is you make sure that the
transactions payment status is set to
completed number three is make sure
there are no duplicate transaction IDs
going into the database then before is
you make sure the payment amount matches
what you charge for items so that's how
you defeat price jacking so here's check
one check two check three and check for
so check number one is make sure the
business email is yours that's how you
do that right there
gather the posted receiver email then
you write out if perceive our email is
not equal to you add your email comm or
whatever your business email is then you
exit this script before you do that you
email yourself a little message so check
number two is make sure the transactions
payment status is completed so you
gather the posted variable here payment
status so PayPal will send you this
variable and we'll have a value and it
should be completed for most normal
transactions and I have no code in there
because you can figure out that on your
own by doing research I've noticed that
there's a couple of different reasons
why a transaction would come back is not
completed but it would still get posted
into the database if you let it but if
you want to exit the script here you
want to send yourself and mail whatever
about it I'm going to let you research
that further let you guys discuss it on
YouTube you know whatever you think is
best if you're going to give people
instant downloads to the software or
something you definitely want to make
sure that's completed they pay by e
check it takes a few days without the
process and it won't be cleared so you
could get an IP n an IP n message from
PayPal saying that you had a transaction
somebody paid for something but the
payment status this variable is set to
not completed yet if it's not set to
completed you can do a certain thing
here if you want to handle it handle it
any way you like you can also get in
touch with PayPal and ask them how you
should handle it they would have the
best
actually and I know somebody's probably
pretty knowledgeable that might be
watching this and they'll tell you how
to handle it all right whatever let's go
to let's collapse that one back up now
for check number three and check number
four make sure there's no duplicate
transaction IDs and make sure the
payment amount matches to be price
jacking number three and four we have to
connect to the database before we do
that so you run require once connect to
MySQL dot PHP since connect to MySQL dot
PHP is in the same living in the same
directory as this file so if you here
I'll go to file open so you see in store
scripts my underscore IP n which is the
script that we're working on now and
here's the connect to MySQL in the same
folder so that's how I'm referring to it
very simple so right there I'm
connecting to the database so check
number three you grab the posted
transaction ID from this transaction for
this IP n message you query the database
you select ID transactions where
transaction ID equals this transaction
limit one so you're just checking to see
if this this transaction ID already
exists in the database if it does then
you want to mail yourself that there's
something wrong because there's a
duplicate transaction ID trying to get
posted to the system and it's not
supposed to ok so the last check before
we sink this transaction information
into our database is you have to check
to make sure the price matches and
defeat price jacking so I wrote some
code here and this is the only part of
the script I haven't tested and if it
doesn't work you'll have to figure out
how to rewrite it to work the way we're
intending it to so basically what we're
doing is grabbing that product ID string
that was coming from the cart dot PHP
script in the custom variable so that
right in the beginning of this video we
assembled that custom variable remember
and what that was was the product ID
string and it's quantities each product
ID had a - next to it and the quantity
the number amount of how many and then a
comma and then the next one next one
so we take that product ID string and we
are trim the comma off of the end
because it's going to have one extra
trailing comma on the end and you really
don't want that there so we remove that
last comma off the end of the string
then we explode the string and make it
an array query all the prices out add
them up and make sure they match up the
payment gross amount so we make a new
variable called ID string array and it's
going to be an array that is made up of
the explosion the product ID string
using comma as delimiter delimiter means
like a break point we can use the commas
as a break point and strating make an
official array out of it and that will
be in this variable here I started a
full amount variable put a default value
of zero and in the for each loop is when
that full amount variable is going to
get compounded to get the full amount of
what what the whole cart purchase should
be so here is the for each loop so what
you're doing is you're taking that ID
string array that we set up here taking
that array you're busting it down as key
value pairs so for each key value pair
within the array it's going to run one
pass through this for each loop now here
we're going to use another explode
function to break the - remember each
item ID has a - next to it and then the
quantity number we're going to take the
item ID and the quantity number and make
a little tiny array out of that by
breaking it at the - so we're using the
- as a delimiter here to break those two
things apart and then you have product
ID separate and product quantity
separate by accessing the index number
of that little array for the first item
the first item would definitely have an
index of zero and that would be your
product ID the second item in that array
would definitely be the quantity and
that would have an index of one in that
array so once you get the product ID you
can query the database for that product
ID here and you have the product
quantity so that way when you get the
price out for that Product ID you can
multiply it by the quantity it's very
slick path this is custom-made for you
and you can thank me later
so the SQL query reads select price
from products we're ID equals this
product ID coming through the loop once
you gather the product price in the wild
loop here right outside the while loop
you can do your little multiplication
equation so product price is equal to
product price times product quantity so
if they bought two black hats it would
take it and multiply the ten dollars
that the Hat cost times two and each
product price would be compounded and
added to this pole amount variable using
this line here full amount is equal to
full amount plus product price so each
product that's in the in the array is
going to compound in this full amount
variable then you can finally run number
format on the full amount variable to
make sure it has all the zeros it should
have after the decimal point and you
grab the MC gross or the payment growth
that's coming from posted paper our
variables so after all that's over you
have a full amount variable and a gross
amount variable this is the one gross
amount to the one that's being posted
from PayPal full amount is the one you
just ever so cleverly gathered to the
database with this little loop-de-loop
so you gather the full amount then you
can take the gross amount and finally
evaluate those two if full amount is not
equal to gross amount then you might
have a price check something something
screwy's going on you want to exit the
script and not process things or you
want to do whatever you want any way you
want to handle that but just make sure
before you go crazy that this
programming is correct and you're
getting the full amount correctly so
when you test a check out on your site
those should definitely match if they
don't match and you've done a normal
check out yourself on your site
those don't match then you know it's
something wrong with my programming and
somebody's got to fix it because I'm not
fixing it part twenty I'm done even if
it doesn't work I don't care I haven't
tested it I'm not going to test it and
you can code that you know ten twelve
different ways but the logic is very
stiff you want to get the full amount of
what the checkout should be you want to
gather that information from your
database and compare that to what PayPal
is saying the person checked out for
it's very simple
no matter if my code fails for you or
not that's the logic to approach with
your programming alright so if they make
it past all four checks finally put
things into the database now here's some
homework for you where I put examples of
assigning local variables from the
posted variables so you can put the
posted variables into local PHP
variables that way you can more easily
insert things into your database using
this query here and I've set up this
query to match exact for your table if
your table matches my table
you know the transaction table that we
created in the very beginning the
viewers matches mine this query set up
to rock and roll for you all the
variables are there all you got to do is
gather your posted variables into local
variables to match all of these guys
here because I only did a few just to
show you how it's going to work so
that's part of your homework right there
and that's the end of the script after
you insert this into the database this
transaction you close the MySQL query
and you mail yourself normal IP end
result yay money that means everything
processed correctly this is a normal
transaction it went into the database
and you have money you gotta send
somebody something in the mail now you
got to ship somebody something or let
them download some software or whatever
okay so I've enjoyed my time with you
guys you have your hands on the source
code now if you happen to need it and
we're all done remember if things go
wrong if you find bugs in the system at
all tackle them I'm not going to look at
this anymore I'm done my hands are clean
bye bye</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>