<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>NYC MongoDB User Group - What's in the Trello | Coder Coacher - Coaching Coders</title><meta content="NYC MongoDB User Group - What's in the Trello - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/MongoDB/">MongoDB</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>NYC MongoDB User Group - What's in the Trello</b></h2><h5 class="post__date">2012-01-24</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/BUlQmXg0VDc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">with the travel team I'm Brett is
Valentin I'm breath this is Bobby and
Daniel and Justin and we stand in front
of projectors so cello is a single page
app for organizing projects and to do
lists and all kinds of things people
keep finding new applications for it
we're going to give overviews of
different parts of it the way that we're
going to structure this is Bobby and
Justin the trailer design team are going
to give an intro to Trella just in case
you haven't seen it and then talk about
some of the design principles and what
happens on the client side then Daniel
the chef in it is going to give an
overview one of the problems we use
nodejs and a lot of JavaScript on the
client side and so we use an async
library and coffee script to keep to
keep that in order and he's going to
give a short presentation on some of the
ways we do that then i'll give an
architectural overview of Trello and we
will close up with MongoDB blunders on
the high seas all of the stuff which we
in are now you could say have screwed up
with mom could TV so over to Bobby and
sorry to Justin person okay so I'm just
gonna do a quick walkthrough of Trello
here just to show you guys what it is
and help to put some context around what
we talked about for the rest of the time
here we started with three design
principles that you just yeah like it on
every button so y ellos ya hello testing
just sort of bring a little closer big
ladder okay we started with three major
design principles with Trella one we
wanted it to be entirely single page app
so you'll notice as I'm doing things
never religious the page we wanted it to
be work on all devices conversely from
tablets to phones to browsers so the
design is responsive it changes
continuously and I'll show that and the
third is everything happens in real time
so anything I do hear somebody else
we're looking at the same board it would
just happen instantly on their device so
we use Trello intro we use boards to
represent projects so I'm going to go to
a demo board here and every
board is essentially a list of lists and
those lists can be anything from
representing a workflow to representing
people's statuses basically anything you
can imagine saveri flexible just to show
what I was talking about before you can
see as I resize the window tri-level
change itself to better fit the device
so like this would be the view you would
see on a phone you see something like
this on a tablet and we're not full
computer here you can add oops I'm sorry
a little weird to use a mouse at a
90-degree angle here here we go cards
are put into lists to represent tasks
that you're working on so I can very
easily add some cards here and these are
things that maybe I would be doing if i
wanted to assign somebody to a task i
simply drag them over to that task and
they are now assigned to it if cards
tasks change status or move along the
workflow you just drag them and you can
move them easily across the list it's
obviously inspired by combine boards if
anybody use them are familiar with them
but we've designed it in a way that it's
not exclusive to the conv agile
methodology we've tried to apply that
universally across all kinds of projects
when you open up a car there's all kinds
of stuff that's back here there's
checklists voting due dates labels a
whole bunch of stuff that keeps all your
materials relate to that task associated
with that task and then i'm going to try
something here my internet connection
that very good on my phone but if i do
stuff on my phone like checkoff
checklist items it should go there we go
to the browser so everything that's
happening in real time using web sockets
and Brett and Dana will talk about that
a bit so I'm going to leave it off to
Bobby here to tell you a little bit more
about the specifics of how the front
emblem front end implementation is done
oh I'm Bobby and talk a little bit about
how to solve it together at least on the
client side and so everything is held
together with backbone chaos
you don't know it's a client-side MVC
framework and it allows us to basically
just in like messages to the server come
back and then all the logic for the
rendering of the page happens in the
browser so we can spine i bind to
specific events so you know members
change if I wanted to remove Justin here
sorry fell and we've got an event that
binds to like that Dom element and send
a message back to the server and it rear
enders um backbone no story one red
based on that change um so you can see
that that's used everywhere so um you
know somebody changes somebody you'll
see the actions um update what else we
use mustache for templating and mustache
is like a totally logical asst
templating language which we love keeps
all the logic and views and it's like
just fewer points of failure um it's all
in one place so it's easier to debug
that way um and then we also have like a
sort of a style guide or user a library
of reusable components that we use so
this board is kind of it something but
like you know the page layout elements
all are part of this library that we can
use and um hooking into backbone is
really easy we can just say like
dialogue duck show and pass it a view
and it'll you know load up the card view
we've got here um and then so we're also
using CoffeeScript and on the client
side as well and it compiles down into
JavaScript and then we can cat it so
it's all one single file in minimize it
we're also using less for CSS helps
dealing with colors and mix-ins and make
CSS a lot more readable and nice and
we're also putting our data URI for our
images for spreading on to a data URI
that goes into the CSS
also keeps paged pagelets down that way
and then we're serving that all up from
cloud front which is just a lot faster
faster a low latency that's it you don't
really probably didn't come here to hear
about client side rendering stuff my god
there you go I'm going to pass it on to
Daniel so I'm actually one of the
developers on the cello team let's see
I'll start with a little bit of the
background so we went and we knew we
wanted to make a synchronous happen we
wanted to have lots of people connected
or serve at the same time so we went for
we chose to go the node and so because
of that choice to end up writing a lot
of our stuff are almost all of our stuff
in that JavaScript now one thing that is
different about node and writing things
in javascript is instead of our calls
for example to the database being a
synchronous like when we make a call to
get for example a board out of the
database instead of the code blocking on
that line and waiting until the database
is actually loaded I rather the board's
action unloaded as might happen if
you're in the shell for example in long
ago you execute a command and it just
kind of blocks until that thing's
actually finished the code you have to
actually provide a call back so we make
a call and you give it a function that
you want to have called after the things
completed that it's kind of fundamental
idea of a timed asynchronous stuff so
given the dance the way it works we end
up having a lot of code that looks like
this let's see if I can make this bigger
there we go now this event I actually
don't let me go these max alrighty we
splitting up having a lot of code that
looks like what we see down here where
we make a call to the database we give
it some part of a query they want to
find in this case we want to find the
member that's associated with this
scheme an ID that came in the query
object and we pass it a function that is
a
the thing that we want to executed after
the database is gone and fetched that
member out of the database so this
particular call it's something similar
to what we might do in in Trello which
is to load a whole bunch of information
about a person in this case we're
loading their member record we're
loading all the boards associated with
their member of other organizations all
their cards eventually we'll load all
the actions there's lots of different
collections that were query for loading
lots of different things the way is
because the way this is laid out this
code actually does not start executing
until after this previous query is
completed and that's good because you'll
notice that the query that it's
executing actually depends on the result
of of this one up here if it's start
executing before this this bit of data
wouldn't be ready yet it wouldn't
actually be able to form a query now the
downside of this is you'll notice that
the organizations that we're loading
don't actually get started until after
the board's already been loaded despite
the fact that it doesn't actually depend
on the board having a sixth of having
been loaded successfully anyway we ended
up with a lot of code like this which is
basically these big nested function
calls and it's good because by the time
this finally gets down here we know for
sure that all these things have
completed but it's bad because you'll
notice that we have two error handling
at every stage every time at the check
to see if there's an error and it's just
kind of messy it's hard to deal with
just even in your editor having code
that kind of just tabs out and out
forever so I observed that we were
having this problem and I told Brad
after noticing that like Wonder brought
a bunch of functions in parallel and
writing code like this or something
similar to that I talked about hey I can
like write something that will
accomplish this and will look a lot
nicer so I wrote a love function called
like run in parallel and it would do
like all this error handling everything
I thought was really great I showed to
Brett I bread said oh that's cool but
that sounds very similar to what this
library that I looked at does which is
called a sink and in fact he observed
that if you took my run and parallel
function
to call it running parallel just replace
with a sink parallel which was something
provided by the library I actually
worked of so I and so one of the reasons
I like a sink is that it works exactly
the way I think it should work which is
cool it makes sense to me so anyway this
is code that's messy a notice it's
inefficient that this board call takes a
long time this organization call takes a
long time if those queries are slow for
some reason the run back to back of the
time to actually finish this whole thing
you know it's added even though those
things really could have gone in
parallel in fact I've gone ahead and
attempted to draw the dependency tree
here you can't load a board until you
get the memory also can't load
organizations till you have a member I
can't live cards and type of a board and
you can load actions until guide loaded
everything and ideally we want to run
each of these queries exactly when they
when everything prerequisite to them has
actually been satisfied and that's
actually one of the things that the
async provides they have a function
called a sink to auto that takes credits
kind of thing I'm going to show it to
you and so I want him to be using a sink
and number 2 i'm actually using
CoffeeScript which makes they sink look
really cool rather makes the code look
really cool this is an example of how
this would look one using a sink and two
in CoffeeScript you'll notice kind of
the things I was talking about how yeah
we can't run board until we run members
all right she'll notice I have a call in
here because this is called a sink auto
a sink auto goes and it takes a kind of
a hash and you'll notice this is similar
to a lot of the other languages
coffeescript allows you to drop lots of
the punctuation that you might otherwise
have to put in so this is actually
calling a sonado it's giving it a hash
you'll see boards the way this it's
called is a hash you pass an array and
by specifying member as an element in
the array that says don't call this code
until members actually been done you can
imagine if you were trying to write
something like this yourself using plain
old JavaScript you uh you might have a
bunch of different things happen and
they all have a shared call back and
make
the callback would mark the thing being
done and then when it was done you would
go and check to see if all the prereqs
that's in my bed for something else
that's that's what I think does again it
works way you want you would expect it
to so notice the adores depends on
members actually as soon as this is
loaded both these things will be fired
to both these queries we're running a
parallel cards weights on boards and
then eventually gets all the way down
here you'll notice some other nice
things about copies script for example
right here this is it's kind of a its
object you structure again it's kind of
also a little syntactic shortcut that
they have what happens is as all the
pure exit steps are satisfied the
subsequent steps get called the second
parameter that goes these things as a
collection of all the results that have
already been computed so in this case
this thing is being called with with the
hash that has a key on it called member
and so this takes that member can you
the value out of it and assigns it to
the variable member standing here i get
2 i'm able to use it now CoffeeScript
and how familiar guys are with that I'd
actually it's not a real language per se
it's kind of a convenient way to write
to write JavaScript and it actually
translates directly into JavaScript
we're debugging the code we actually are
looking at something that looks like
this which is the corresponding
JavaScript you'll notice i think i was
talking about that d structuring that
thing what a actually expanded to was a
function that takes an arg in a sense of
a variable member and it makes member
equal to our gut member so instead of
having to write all that code myself
just able to write a short version of it
which is pretty cool a sink I like a lot
because it takes you know i'm writing
asynchronous code and it takes care of a
lot of the very common patterns you want
to do they have all the same kind of
things you'd want to do on a raised
synchronously they have ways to do a
synchronously so there's for example in
a sink for each or an async map we r dot
parallel or dot series kind of
everything you could think of
I think this has internet I'll go really
quickly to the page for this on github
and we in fact use many things from
github github is certainly are our
friend here anyway so you'll see an
example of many of the calls that they
provide that work really nicely with
asynchronous stuff I didn't mention it
before but that error handling that I
had to do it every single step well if
any of these steps fail it'll
immediately jump out into the air
handler here so i just had to write
their handling one time which is really
nice yeah so that that is copy script it
makes this JavaScript look like Wow look
like this and that runs a lot better
than that so that's it so that's the
let's review the client and for that
aggression into why we think why we
think coffee script and public fifth and
a sink are awesome if you happen to be
writing asynchronous JavaScript code
which seems to choose to be going pretty
frequently with MongoDB it's becoming
the architecture of nodejs and mongodb
and maybe a rest like that's becoming
kind of mainstream right what it really
wasn't when we started so I'm going to
get an architectural overview the like
too long didn't listen like they're in
tune me out here's the summary okay the
oh I'm not going to the wrong page so
I'm going to pull under my summary okay
summary is okay so it's a single page
app the MVC on the client is backbone
jas it communicates over Ajax and web
sockets to an oj s server which uses
MongoDB for persistence and Redis for
ephemeral beta and pub sub so if you
have something important for us the time
then gonna call me okay here we go I'm
reinis prezzie for this because it's
cool okay here's a huge drawing which we
won't be able to read of the whole
architecture but we're going to zoom in
all kinds of parts of it really really
zoom in in a couple of places so even
sure eyes are bad you'll be able to see
this Bobby talked about all the all the
sources of our client basically the
client consists of two files all about
jazz and all CSS which we live in the
CDA I mean I'm really
petrello you I we're not like rendering
a bunch of HTML on the server and
sending it down that's that's the whole
app right aside from the server which
takes care of persistence propagation
upon gaining events to other clients and
validation out you know security making
sure you're not doing things around a
lot of you so we compile the CSS the
CoffeeScript we move together the
mustache templates and we packaged up
all of our lives and we squish them into
these old objects and this all about CSS
and throw them up on cloud front like
Bobby said we chose to go with the CDN
here we don't really like help sourcing
stuff in general but we were comfortable
putting a bunch of static files on cloud
front to be served by a CDN let's say
there's a problem with cloud front well
it shouldn't be a huge deal for us to
start serving our own static file again
in the meantime we get this really low
latency we get really low latency and
all part of all kinds of parts of the
globe exceptions right now the Congo not
very good with with pod funnest as we
can tell and actually some parts of
China and we haven't so we just have
people contacting us about that okay
well try to make it way friendlier when
cloud front doesn't work because we're
probably not going to fix plot front
anyway the client jeaious and CSS gets
sent down that's about 230 k right now
so not small but not huge either so we
can have the app up and running a you
know it all code dalma client in you
know half a second maybe so not not
blindingly fast but not too bad
considering that after that there's no
more loads and no more page transitions
and we get the benefit of caching on
future loads so until we ship a new
version of the client you don't have to
load that stuff again which is in line
in this CSS so there's actually a large
sprite that we have
I was supposed to say that you reminded
me um yeah anyway so oh that's weird
sorry my little outlines look a little
different here freaks me out okay so
once all that's done on the client
backbone.js can get busy in parallel we
have kicked off a data load if we can we
kick off a data load to get all of the
the objects all the models for the
objects we're going to render on this
page and so once that data load is
completed and those two files are down
backbone.js takes over while we talked
about it a little bit um back 10 days if
you start playing with it don't freak
out about the controllers okay the
controllers control which page you're on
and the views are really more like the
controllers that you're used to they
serve both the functions of a view is it
wouldn't rail which I think goes like
most people are familiar with and also
the controller all right the views let's
see can you see where I'm pointing or is
it better to I'm just going to be just
stick you lighting at the screen if I
don't do this so the idea is we get all
of these models down from the server and
we throw them all on a client side
bottle cash that's actually not part of
that button that's something that we
built to make things a little bit easier
dealing with these models on the client
side once I get the models in the cache
the controller kicks off the view render
now he's in backbone generate globs of
HTML from models and then watch wash and
then provide a way for the models to
watch the Dom chunks and the Dom chunks
to watch the models so like bobby was
saying you know we wire up particular
classes in the Dom so that when you
click on the vote button you vote method
gets called on the view and that has a
habit of a model which in turn sinks
itself up with the server and by the
same token when something comes down
from from the push channel as an update
the we just update the model in the
cache the view is watching the model and
it chooses whether or not to re-render
to rerender its HTML chunk now this is
where there's a little bit of an art to
it right you don't want to
you don't want to rerender your entire
board page and Trello for instance
somebody changes the title of the board
so you have to be a little bit careful
with what you when you choose to
rerender there are some new libraries
that are coming out that claim to solve
this problem I think ember claims did it
just with that really well so if
anybody's single page app won't and has
tried that out then I'd be really
interested hear about your experiences
with that anyway backbone works this is
one thing part this little bit fiddly
now let's talk about what happens in
communication with the server all of the
actual actions you're doing just go over
straight up Ajax requests the push
channel is kind of interesting so if i
say WebSockets who knows what I'm
talking about okay all right people are
familiar with WebSockets it's an upgrade
on HTTP it allows us to send messages
from the client to the server and the
server to the client it in via push so
the server to client part of this is is
particularly interesting to us because
we want it we want to publish updates
immediately like under a second under
half a second it's really fast and
that's because we can keep this
connection open however websockets
aren't available everywhere yet right
and most like the latest version of the
most modest about most modest was modern
browsers they are a Chrome Safari
Firefox but he doesn't have them we were
like all right we probably have to
support one IE version because we didn't
think we'd get away with not frankly um
so uh so we tried the down level
transports are we use socket i/o I don't
know if you look familiar with that one
that one attempts to fake out web
sockets throw a bunch of down level
transports like flash sockets and comic
polling and we actually didn't like most
of the down level transports because
they were flicking in one way or another
or I think let's see flash sockets
screwed up our scroll bars like all
kinds of crazy stuff would happen but
the WebSocket seems solid um but even
then we weren't willing to bet but back
then we're talking about like nine
months ago the WebSockets standard was
not solidified in fact everyone was
arguing about it so we weren't going to
bet like one of the key parts of our
application on web sockets so we use
like the most
old-school polling framework that we
could come up with we wrote we just Ajax
polls the client keeps track of what the
latest version of an object it knows
about is and then every two seconds when
you're active in every ten seconds when
you're not it just sends a pole all
right last up down i know that is 237
you got you got a new one you got a new
one you got a new one and then when it
does it sends the messages down just as
it would over the web socket so that
means we have to have a server that can
handle a lot of very very tiny requests
so we got node right no Jas when we were
considering using node.js for this
project for real one of the other coders
at fog came into my office I was like
man I don't know all I really know about
no JSE's they can serve like thousands
and thousands of hello world that's the
only benchmark i've seed right so it
turns out when you want to serve a lot
of polling requests that's really a lot
like serving a whole bunch of hello
world's right these requests are not
doing much it's a tiny request comes the
server server says hey do you have
permission to look at this okay you have
permission to look at it has anything
changed that's a very quick Redis check
it's really close to a hello world so
we've got this this cool non-blocking
server they can serve thousands and
thousands of these over SSL every second
and that's good so that turned out to be
that turned out to be another nice thing
we were already wanting to use node.js
because it can hold all the open web
sockets for us without having a problem
without us having to bring in another
component to do that with more
traditional servers would probably have
problems with to make soda j/s like on
the client coffeescript we started out
we were all in JavaScript until May and
then we experimental II well we were on
JavaScript we knew that coffee script
and we thought it sounded cool but I was
frankly terrified about about debugging
in a different target language debugging
the JavaScript and then having to relate
that back to the CoffeeScript code is
not a problem it is not a problem that
the mental mapping is so simple because
they because the translation so clean
and this is something that coffee
scripts creator has been very adamant
about the JavaScript has to look like
the JavaScript you would
written if you weren't writing in
CoffeeScript so it turns out that
there's really very little cognitive
load in in performing that mapping so
you can just like coffee script and not
worry about it so we ported a couple
files experimentally we loved it and
then we spent like a week putting the
entire app over and it's been awesome so
too so right so coffee script on the on
the server as well we use a few
libraries that we like a lot cluster for
managing multiple nodejs processes
Express and connect for all of the like
standard web tech that you're used to
routes all that stuff from Sinatra
inspired and connect which is a lower
level library that expresses socket i/o
but Sokka do gets an asterisk because
socket i/o has some serious problems at
scale we are letting you very heavily
hacked version and we're only running
WebSockets we're not using any of the
down level transports like i said before
so if you want to fool around with
WebSockets Sakai is a great place to go
if you want to if you want to run them
at scale then be careful I don't wanna
like but it because it's going to be
great in two months or something right
but right now there are substantial
problems at scale and we hacked it and
when we wouldn't have been able to use
the hacks we were using if we wanted the
down level transports when not everybody
has this luxury of not having to support
those the show Redis ephemeral data we
don't even persist Redis to disk if we
lose everything at Redis it is fine we
in fact we use it with an option called
all keys LRU ever is you guys are no
sequel people write your old download
Redis there they hands yeah definitely
okay go right data structures are very
very cool incredibly fast our Redis sits
around we abuse Redis we use it for or
we try to use Redis right and it
consumes like six percent of one and one
cpu on one server box it's ridiculous ok
redis is great we use node Redis it's
sort of the de facto standard on on
nodejs and we use hi rehta switch is a
driver
which is a sea driver but i think the
native no driver is fine too if you
don't wanna deal with that it's also our
pups up framework like I said so when
something needs to be propagated out to
all of our other server processes
ordinary something needs to be
propagated out server processes Daniel
does something on a board and needs to
propagate it out to me then we have read
of slaves running on each of our server
machines and all of our processes all of
our server processes subscribe to those
and then MongoDB why we're all here
tonight we we use an odm called Mongoose
to manage our schema it's cool it's
pretty lightweight we had some problems
with it nine months ago and the
maintainer helped us out a lot was great
no valgo DB native actually same story
but i think so we're using these at
scale with no problems right now and
mongodb we kind of came to MongoDB in an
interesting way you guys know Stack
Overflow stack exchange so they're our
sister company they live upstairs we
lunch with them some vodka columns have
gone over there I was talking to their
dev lead was a belong one day at
lunch and he was talking about how even
though they use like sequel server
they've denormalize a lot of their data
even though they cannot get into that
data using their database and do
anything with it they still choose to
keep it to normalized for performance
their performance crazy and you can see
it in their site it's really really
really fast so that kind of pull is over
towards a you know a no sequel because
you know here we can keep everything
denormalized and we've got the power we
can build indexes on sub document this
is great right and we've enjoyed that a
lot the performance is shocking our
assistant mins started running Mongo
stat finally and Topher hey man you know
that it's actually processing few
thousand queries per second and you're
not that many users yet is this
intentional they're like well how's it
go before my eyes feel like though it's
fine like twenty five percent of one
cpu it's doing great what then we
totally intended it so yeah it's allowed
us to push back a lot of performance
work and focus on features where we
might have had that to go in and
actually figure out our performance
problems were able to push that back
several times so that's been great is
that can I kind of go into blunders now
okay um we have screwed things up Sirica
here and I'm not now I'm gonna yeah why
not fit so we have fouled things up
through naivete a lot with MongoDB we
have we have screwed this up every way
you could uh steamin if you wanna jump
in here Daniel you know just any time
you just you just come over and grab the
mic if you wanna you know tell us the um
so schema design was the first I think
we made the over denormalization mistake
like even more than everybody else did I
think at one point every board was a
document every card was a sub document
of a board and every action on a car was
a sub document of the action and we're
thinking yeah then like this is fine we
got 16 megs right did Warren peece in
that or something we're never going to
hit it but had we done multiplication on
the size of an action it would have been
obvious to us that we're going to blow
through in a few months in fact it was
fortunate it was our board that
eventually hit the limit at the 16 Meg
limit so that was unfortunate and you
know before that we learned something
about you know not bringing back the
entire sub collection but it was um yeah
that was scary and I think we actually
we actually had one other design that
that over denormalized so we managed to
make that mistake twice not once but
twice so folks if you have something
that grows without bound do not embed it
you wanted that but maybe someone on the
internet will hear this and not um
freebsd when we started on which are
done Trello or excessive mancine was
really understaffed we had they didn't
have the resources to do what they
needed to do so they asked us there like
right can you guys help us out here just
rolling freebsd okay to trundle yourself
on freebsd if you can
because that's going to save us a lot of
work that's where all of our tools are
we're not gonna have to run a
heterogeneous environment it'll be much
better for us so we did you know we got
no didn't quite work but we patched it
mom the DV there was a board and worked
fine and we launched and we were on a
few freebsd servers and everything was
kind of okay and then the moment he
crashes and we have you know we have a
terrible terrible outage and you know we
work around it we figure okay it's when
this query runs when this other queries
running so we can work around that and
we were back up and running and we felt
a bug against MongoDB and I think we
were in conversation with Elliott and we
were like again I'm on the freebsd
please you're not running Mongo on
freebsd in production are you know why
do you ask um but we were and and you
know this is this is a lesson about kind
of paying more attention to community we
were into so many new open source
projects that we didn't know anything
about that we weren't really paying
attention to the communities and any of
them and had we you know maybe discuss
this with someone else who was running
money the introduction they might have
said hey you know I don't think anybody
else is really doing this you should
probably just run this on Linux for the
time being um and we would have but
anyway we're running on Linux now so and
FreeBSD other than a couple of bugs it's
actually in the spider monkey port was
it was the problem other than a couple
of Boggs carried us through until we
could get over to get the manga TV boxes
and in fact everything over to Linux
we're running everything on Linux now
and really that's the home project we
were having trouble with pretty much
everything on freebsd and it's just a
matter of who's anyone else running this
thing you know with a lot of with a lot
of customers on that OS and for an app
server really a lot of times no write an
app server DB server network appliances
yes but for up for all the rest of it
you know linux just seems safer because
it's what everybody else is doing we had
another another issue with staying up
today with the project when mom goes to
shift we managed to crash on that bug
where if you were querying a collection
and building index on at the same time
mungo would crash we're going to crash
on that they knew about the bug they had
deployed the fix we weren't
close enough attention to what was going
on so we're trying to do better job that
you know the fix had been out for four
days I think been like mom go to hadn't
been on for that long and we managed to
have a pretty serious outage outage on
that one well you'll like this one
because it's a addition so we have a 24
gig machine that and right now we're
actually transitioning from our like
experimental architecture to our real
architecture and getting dedicated
mommy-to-be server boxes but you'll like
this 680 lights of node.js processes 2
gigabytes of Redis mungo reporting its
residents eyes as 5 gigabytes so we're
up to 13 right 24 gig machine and our
indexes are just about eight gigs but
that's not so bad right I mean we've got
five gigs for the working set but then
we did a zero downtime restart of node
and I don't know how much you know about
how cluster does a zero downtime around
a restart but it brings up a bunch more
processes to handle the load before it
kills the old processes so we started
using 16 more memory kicked the indexes
out of ram and everything was horrible
for about 10 minutes I think we had a 10
minute outage at right at midday because
well because of my failure to do
addition also you know without a couple
of problems with just how permissive
MongoDB is it's great but man you can
really just blow your fingers off with
this thing right I think it did you
create the index in question yeah yeah I
think yeah so Daniel was trying to build
a sparse index and managed to build and
index on the key sparse and everything
was miserably miserably slow and you can
do that right like well nobody has that
key in this collection but yeah you want
the index no problem right um you can do
it in this case it didn't I don't think
it hurt us that bad but things were
really slow on search for a little while
so that's it that's our that's our
presentation on Trello and now we'll
take if we have time to a sign of
questions Francesca do we have time for
questions ok we'll take questions
questions for anybody
oh gee why didn't we have more about
MongoDB it's awesome what up you're
going to put it like facebook facebook
integration integration we're talking
about that today Tim maybe ah yeah I
think I think so we look circuit and I
think we will be I think we'll get more
beneficial used to put this into the
face of because Facebook providing data
before you want you could you this for
their own organizations hmm yeah we're
definitely thinking about it facebook
and twitter social media type stuff for
for signups and providing your friends
off of that because I mean honor the
people companies use it but we also use
it to another house bold it's really
cool a guy i got been aborted like the
other day about belgian beers he wanted
to try its cool people are using for all
kinds of things teachers minutes or
classrooms it's really kind of actually
the horizontal fools we wanted it to be
500 evil planning their weddings use
kiss apparently it's awesome and any
other questions on anything uh yeah I
have a question actually how do you
definitely like analytics work with it
or anything that like you're gathering
any other stats about you see or
something
lettings general staff usage of Trello
yes yes yes we are um then you won't
talk about that a little more yeah so
the steps that we're doing at this point
or are not particularly advanced but we
do go ahead and track things like how
often people are active for example have
one of things actually really like about
mondo is that everyone's file we'll
think up like a really cool to know some
statistic and I can actually just go to
write the code that would compute that
like paste it into the shell manga or
just right there Mongo and run something
across the database and get the
statistics so it's nice yeah right now
most of what we track is just you just
at usage stats although sometimes we
want to know like Oh what kind of people
are what boards people making or what
kind of things are being making boards
for it we can do this they just hand
scans all the tables looks at the words
and like counts up how many times
different words we use so i did that i
saw there's wedding was really high yeah
I got some people using the court
looking at your schema or your queries
before why work why didn't you have for
instance why didn't the boards have a
set of the members rather than only
being able to get to the board by first
crew member so in fact the boards in
practice do actually have a set of the
members um we so we did we overdue
normalize this bread said and put data
all over the place that we didn't need
to we scale that back we do actually for
example members orgs and boards they're
part of Ford's and all the members that
are on them same thing for words so we
could have as you set down a query that
would have I would have found all the
boards without having to load the number
document first it didn't make the
examples compelling so
oh yeah yes so what kind of architecture
you need to be to his heart's replicas
has around save our kitchen ready
probably speaking what's your
belligerence date right now we're now we
just have a master and two slaves and
we're moving to moving the replica sets
as soon as the sweet new servers come in
um yeah so like I said you have to talk
about you give back those patches or you
have like in most cases yes that's the
problem with the socket i/o patches is
they turn off three quarters of what's
at i/o does and so we are kind of money
will door a couple actually there then
we have queued up to to go to the client
for some things that I found while
testing reconnect so there are a couple
feet up to go there and in just in one
case it in this one case of getting it
to run at scale we just it is too brutal
to submit back there they're aware
there's a thread on it and they're aware
of what we've done and and what we think
and how we think it could be fixed but
our stuff can be submitted back and it's
not really compelling for us to go back
and fix it how we we think it should be
fixed but you know I think the the
creator of us off at i/o whose name I
have never heard pronounced so I'm not
going to try but a year alright I didn't
try anyway I he's super bowl and he's
working he's actually working on
something called web socket i/o and
engine i/o which sound like they're kind
of supposed to replace the current
socket I was hard to tell but yeah he's
he's awesome in that stuff will rock
videos so what's your data set size for
the boards and everything what kind of
data size are you
ah let's see 30 gigs last I knew eight
gigs of indexes as a couple of days ago
the huge collection is actions and if
the indexes on actions like my actions
is eight gigs and then the indexes on
actions are five gates plus and that's
because we're indexing like everything
in there because you need to be able to
because you know almost we're going to
over to normalize again you know actions
look good we don't store attachments
either yes I yeah we've Creek is
made the mistake of storing attachments
in a database before we will no longer
do that we use Amazon ec2 for that and
we're moving to Moodle of us for example
oh just focus on three years buddy seat
sit we use s3 Tiger yes and storage nice
I have any other questions on do that
another one oh good um so the next one
was you talked a little bit about how
you wound up with a no sequel solution
but not about how you selected mongo DB
per se was there a was there a shootout
yeah take that one yeah oh it was so
easy to get started with it's awesome
the tools were there and it was just so
you know the community is great I mean
just 17 17 people here right the
community is great it's so easy to get
started with so you know we're looking
you know react and Sandra others and
this was just like this works and fasts
graybles excuse this seems like it
worked and no reason to look back uh
well as always reasons tonight we're
back hmm I wonder what they do in him
but I do a reason right all right right
we like it in videos how's that cool
thanks everybody</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>