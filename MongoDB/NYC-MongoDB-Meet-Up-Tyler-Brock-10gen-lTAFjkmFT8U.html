<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>NYC MongoDB Meet Up - Tyler Brock, 10gen | Coder Coacher - Coaching Coders</title><meta content="NYC MongoDB Meet Up - Tyler Brock, 10gen - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/MongoDB/">MongoDB</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>NYC MongoDB Meet Up - Tyler Brock, 10gen</b></h2><h5 class="post__date">2012-02-29</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/lTAFjkmFT8U" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">my name is Tyler and I am a software
engineer tanjong and today we're going
to talk about Mongo's new aggregation
framework can you guys hear me okay all
right cool all right so 2.1 is out now
and the reason i'm giving this
presentation is so that you guys can
hear about all these new features and
and get excited about it and just be
aware that you know it is unstable we do
Weber number our versions like Linux
kernels so you know it's an odd number
it's unstable and the even numbers are
stable so you know we're releasing it
now so you can try it and play with it
but it won't be you know production
ready until 2.2 so just be aware of that
all right so new aggregation framework
why do we need a new aggregation
framework well what we're using now is
MapReduce and MapReduce is kind of a big
hammer it's used to perform these
complex analytics tasks but you know
people also use it and in MongoDB it's
typically used for totally in an
averaging as well so you know it should
be easily easier to do simple
aggregations you shouldn't need to write
JavaScript we spent 10 John spend an
enormous amount of time developing this
database that works with a document
model shouldn't it make sense that yeah
so it's comfortable to work within your
program language and then and then we
have this right you're writing some
Python code and then all of a sudden in
the Python code you have JavaScript
right and it's it's it's hard to debug
for one it's not you know gets syntax
highlighting and it's and it's just just
in there and it feels unnatural right so
you know a way to express this in a
cleaner fashion would be great and also
avoid if we could be as a bonus the
overhead of running it through the
JavaScript engine so what we came up
with is the new aggregation framework
it's declarative you can describe the
operations that are going on using JSON
it's implemented in C++ so it's
much higher performance than JavaScript
it allows you to evaluate expressions so
return computed values due date the
rhythm to take that sort of thing and it
truly is a framework so we can add new
operations easily if we want to so this
is pretty good so it works by creating a
pipeline pipeline you can imagine as a
series of operations so members of a
collection or past at the top of this
pipe and it passed through all these
pipeline operators which are you know
sections of the pipe if you want to
think of it that way and at the end the
documents that are produced come out the
bottom it says you know conceptually
it's a lot like UNIX pipes so if you're
reading data out of a file with cat
right your piping the output of one
program into the input of another right
this is it's conceptually similar to
that concept so so how do you use it the
aggregation command looks like this
looks like other commands you run in
MongoDB you call run or you invoke run
command on a database and the first
argument is aggregate you pass in the
name of the collection and then the
second argument is pipeline and this is
your sequence of operations I prefer to
use this other helper method which you
can call on a collection and so when you
call this one on a collection we call a
great on a collection the the collection
name is implied so you don't need to
include that in the cult a grade and the
pipeline you don't need to specify them
as an array you can just pass them in
his arguments and it actually puts them
in array for you which is really nice i
like conceptualizing it or visualizing
it this way because kind of looks like a
pipe right you're you're putting feeding
documents in the top of this thing and
applying these operations one by one and
they're coming out the end right so it's
a little a little nicer to think about
it that way and I'm going to actually as
we described some of the operations you
can apply in the pipeline I'm going to
not include the actual call to aggregate
but I'll put it back in later when we
tie it all together at the end so
alright so documents go in the top of
this pipe and come out the bottom where
are some things you can do in sections
of this pipe right there's some old
favorites and conceptually I'll explain
why they're old favorites and there's
some new new stuff you can do some match
match right match seems like a new word
you haven't heard that one before but
it's actually it's actually just like
the first field that you pass defined so
you know if if you take as an example
document i have up there hopefully you
guys can all read it but i have two
examples of match expressions that you
could pass into the pipeline at the
bottom there so one is very simple right
it's a match authors that have the name
bob and the second one is a little more
complex but not that much more complex
match page views that are greater than
50 in less than 90 pretty simple right
it's a and the way it works so if the
part of the pipeline that's a match
documents go in and then when they come
out if this expression evaluates to true
right they come out the other end if
they don't they don't come out the other
end pretty simple you consider it like a
filter almost sort very simple as well
these all begin with a dollar sign by
the way but sort you specify the keys
just like you would an index so you know
sort by name and then by age descending
pretty simple and then limit and skip
usually want to use these after you
sorted the documents but pretty pretty
self-explanatory if you put five
documents in you limit ten document
saying you limit 5 you only get five out
same to skip only you'll get the last
five out right all right so let's talk
about the nuance project so project
could reshape a document it's kind of
similar to that second field second
argument that you pass defined right
where you can say oh I want this field
but I don't want this other one it's a
lot more powerful than I'll show you why
and in addition to being able to remove
and move around the elements in the
document you can also generate computed
values so this is really valuable and
I'll show you examples of all of these
so here's one where we include next food
fields there's two modes to this one is
the inclusive mode the other one is the
exclusion boat so the top one here is an
inclusive mode right so we want title
and we want author and we want the
authors of all the comments pretty
straightforward and second one is
exclusive mode you know we want
everything but title and but the author
if the fuel doesn't exist it just won't
put it in the output document so one
thing to note about this is that ID is
included by default just like just like
how the this argument would work in find
you can pass ID underscore id0 to the
inclusive mode if you don't want it so
just something to be aware of this is an
example of a computer field right so
saying alright we want title we also
want this new field that we're creating
dr. page views and and to make this dr.
page views field we're going to add 10
to whatever page views was something to
note about this any any any new fields
that you create will be at the end of
the document so the aggregation pipeline
respects the ordering of the original
documents so any fields that were
originally in the document come first
and then all the fields that you create
in the order that you create them in the
pipeline so be aware of that all right
so some other examples of computer
fields you can add two fields together
you can provide a value for a missing
field you can nest those two things so
you can say hey let's add this field to
this one if it exists feel too if it
exists or field three if that one
doesn't exist you can do date field
extraction so
year-month-day cetera and you can also
performed at arithmetic so you know jay
is January first you know what was it 23
days ago or what's the difference
between how many days are between these
two dates that sort of thing okay you
can also move you can also move things
around in the documents this is pretty
pretty nifty you can say the first
example is a rename actually so paint I
want page views to be page underscore
views and I want upgrade to equal this
this this value in the nested the nested
document other so we're going to pull it
pull it up right pull it up into the top
level of the document so now this field
upgrade has this this other field that
was nested inside other right this field
foo that was nested inside other so it's
pretty cool will so there say about this
all right so you can also push fields
down you can create a new field stats
and put this page views key in there and
say that's equal to page views alright
so something to note I don't know if
anyone's picked up on this but all the
all the fields I'm referencing start
with dollar sign right and that's the
only reason we're doing that is because
it's hard for Mongo can't tell the
difference between a string literal and
when you're referencing a value so
putting the dollar signs there says hey
there's a value there's a key called
page views go get the value from there
instead of saying hey I want the string
page views so whenever you provide a
value in that aggregation framework if
it's a value that's coming from another
field you have to prefix it with a
dollar sign all right so here's another
new one unwind this one's really sweet
you can have a document like the one
we're looking at right now that you
typically find on a blog a couple of art
this collection is actually called
articles so it'd be an article on this
blog and it and so if we were to unwind
the tags field of this document it would
actually produce three new documents
that have all the same fields except for
tags tags would have one of the tags in
the array
so we get three documents that look like
this they have all the other fields and
then the first one have tags fun
secondly have tags good throwing to have
awesome right because those are the
three tags in there so it kind of like
explodes it out right unwinds this array
so let's do a more complicated example
right let's put two of these together
let's use project and unwind so let's
take these articles as articles
collection and let's project out the
author of the title and tags fields if
they exist and then unwind on tags all
right so notice IDs in there right that
gets included by default title author
and tags are in there as well but only
one tag / document right we unwound it
so this isn't powerful just yet right
but it's pretty it's pretty cool you can
see kind of where this is going with
grouping which I'll explain now it
becomes really powerful so grew right
this is the last one of the pipeline
operators it's an aggregation expression
so some of the expressions you can use
with it are some average push right is
for example so let's so the format of it
would look like this right so you you
say you want a group dollar sign group
and then you provide the key that you
want to group on in this i underscore ID
so you say underscore ID colon the field
I want a group own and notice again it
has dollar sign in front of it so we're
going to groupon author in this case
right then you provide a new field name
for four it's going to create groups out
of out of all the for all the authors
going to create groups for all the
authors that's going to create field
names in those groups that have this
aggregate aggregate function applied to
them so let's do a more concrete example
right so let's group author and let's
put this let's put it let's put a let's
put a value in their views per author
that's the sum of the page views for
that particular author your Zolt would
look like this we'd have ID of the
author and then it would have the field
that we specified with with those
numbers computed by this aggregate
function sum and into some we're passing
pageviews so it's some in all the pages
up
some other things you can do like min
max right those make sense to use your
sorted average push add to set right so
let's pull it all together let's so
let's do an example that has a lot of
these a lot of these concepts so here's
another article right and the articles
have tags in them what if we want it to
find get a list of tags and all the
articles and all the authors who wrote
about those tags right so this
collection of articles has authors you
know Bob and then tags for this article
right we're going to flip it around and
make it so that we have a list of tags
and then all the altars that wrote about
them you do that like this you'd say
when I aggregate I want to do a
projection first I want to project
author and tags I want to unwind this
tag array and then group the tags and
for each of the authors that is written
about one of those tags add it to a set
and so add to set if you're familiar
with using Mongo is will not allow
duplicates to be added to the array so
it'll make an array of these authors
that doesn't have dupes in it so the
result will look something like this
you'd have you no tags each you know
individual tags and then the authors who
wrote about each of those tags all right
so let's talk about some usage tips all
right so all right I like like select
and sequel right you want to push match
as far up the pipeline as possible
because the less documents that are
going through the rest of the pipeline
the faster it'll go makes sense right
and right now I maybe you guys can help
me dunno if the query optimizer actually
moves it to the front or if that hasn't
been implemented yet
okay so yeah try to move match to the
front as as far as possible i think in
the future there are plans to have the
query optimizer do that for you but you
know if it detects that you're putting
it later on and it could be moved to the
top and you know in terms of driver
support you know the initial version
will be implemented as command so when
if you're using this with 210 you're
using like the Ruby driver using the
Python driver you'll just do a command
on a database and you'll have to use the
you know the longer version of it where
you actually say aggregate this
collection and then the pipeline is this
array but that's how it's going to work
for now and then we'll build in helper
functions as time goes by and something
to be aware of is there is a result size
limit right so I didn't talk about what
the output document looks like at all
the output document actually looks like
this document that has two keys results
and okay results is an array of
documents from that were output from the
pipeline and okay is either one which
means it was a success or some other
number which means it's definitely not a
success so something bad happened and so
beer we're all right so all the output
documents are inside of another document
so the output limit size is obviously
going to be 16 megs right we're also
going to add support for an out
parameter out pipeline expression that
lets you lets you out put it to a
collection i believe i don't know if
that works like I believe it might work
in an intermediary fashion so you can
output to a collection in the middle of
the pipeline and then like read back
from it is that is that true or not
okay so maybe that's not true
right and it works like tea or something
like that right and so shorting support
to write initial the initial release
will support shardene and so the way
that works is Mongo s looks at the
pipeline pipeline and breaks the
pipeline apart so it looks finds the
first group or sort and says alright
everything that's up to that first group
resort we're going to do on the Mongo DS
and then we're going to bring it back to
the Mongo s and do the group the rest of
the things after group or sort the
initial group resort on the Mongo ass
that makes sense if you think about it
right because in order to group anything
or sort anything you need to be able to
look at the whole collection right
because it could always be another
document that comes later that belongs
at the top of the collection if you're
sorting right or if you're grouping
right there could always be you know you
don't know how many things there could
always be another member of that first
group right so you need to be able to
see all the documents before you can
group resort it doesn't mean there might
be some does it does it pre sort and
then just merge them on the Mongo s if
it's sorting do you know maybe not
right right okay and so the other cool
thing about this right is that the the
match operator right the match operator
works like fine and so can use indexes
as well right and so that's been
MapReduce hasn't been able to use
indexes but you know the match parameter
can so that will greatly speed up you
know some of the operations you would do
with this is supposed to map produce and
if you're using match with something
like a shark key then it will distribute
it to only the shards that have the data
you want so can do clever things that's
pretty much it i was going to show you
so this is an example of like some
common sequel queries i just put this in
the slide deck so you guys could look at
it but common sequel queries you can
translate to the new aggregate
aggregation framework and i don't know
if you guys can read it but something
interesting is that using ID null
basically can let you puts everything in
one big group so you can count you can
do like a sum over all the documents in
the collection and also you can do is a
distinct by just saying group and then
pass an ID in of the thing you want two
of the key you want to find distinct
values for so that's some interesting
stuff you can do but it's pretty much do
you guys have any questions or I can go
back and we can look at some of the the
quarries if you guys want want to what's
going on sorry how does this stack up
against the MapReduce in terms of block
terms of blocking
well better better is that the answer
Mary read operations
that's what a truck
promise
yes it's in the output document
two small questions one is in the surf
select life span you have as their
support for things that they look like
operator which has more of a regular or
semi- good thing there's bomb ah
Thursday believe that is there a way to
do that like that makes me but it works
and it also the young you didn't
actually give an example of inserts and
deletes so that's sort of similar when
you same sort of like to text well you
know the aggregation framework doesn't
really do it's not really for inserts
and deletes for creating knowing
aggregation of documents it's not you
know you've got like the crud operations
right to create read update delete this
is like this is something different it's
a different category right it's like
it's not for operating on single
documents is for operating on you know a
collection right and getting information
out of that aggregation as a whole so
you know and I know you can update
multiple documents but you know in
general right you don't look at all of
them together unless you're doing an
aggregation so it's more it's more of a
read operation because you know a way to
get partial results like don'twe to give
all the heart hear that sound get into
data
so I know so it's my way I mean just
make me some i think i would sense but
in some applications you might want to
just get some you know i get for the
time up and says this is what I got 5
right um like a like a operation time
out yeah but I mean you have the
cabinet's but moving average for example
I you don't get all the documents but
you get a set up you know some of them
it might be good enough where you say so
there was there's talk of implementing
something no red never heard of single
was also all the aggregation some
documents returnest session of documents
that gives me
excitement we do generators how many
other words you actually pick yeah so
you're gonna give you know this is my
fifth degree senators other what
evidence has given up for me I don't
have enough space of designs that would
have been possible but it would require
a lot of extra server-side state you
need to hold open an extra cursor on the
fish are what happens if you don't do
the next to everybody it's just a real
this turns out to be a lot easier
influence okay so make people want it
now
I'm sorry
I can't hear what you're saying it all
home suck what's up but we explain okay
Victor right yes on the project sticking
with Richard batter documents or going
with really small ones oh you know less
data that has to go through the pipeline
the faster we'll go but you know if you
need those fields then then you know
project them but if you don't then yeah
it makes sense to exclude the ones that
you're not using right less data's has
to go through this thing and more you
could have fit more in that output
document right that's 16 mega limit you
can fit more documents in there right so
some query so say I didn't enjoy you
know I use that signal to Kenan pipeline
go into my other Edward you can't yet so
there was talk of this like out-out
pipeline expression right and that would
output documents to a collection and
then I don't know if that would work
with I thought it was going to work like
a tea where you could like tea out into
a collection then read read back into
the pipeline but I don't know if we're
going to implement that at any point or
even if I should be talking about all
right so so right right sure is there
any way to doesn't data sort of nowhere
no did you mean like in the output
document or something i can say
something saying this i should be
together in cash oh um I don't think so
now what kind of cash is like in the
front yeah this so what would you want
to know what I would all out essentially
if I'm talking about an addict function
that takes five minutes to wrong because
of the data set size very right on their
companies your kids it right all i want
to maybe split it up you know especially
to come on 16 dec definite limit right
right let it up and do a diplomatic
Laurel chatter do some not fool
ourselves but house tonight
doubtless validated
Wright picks on cv8 your own I guess
right yeah the day you mentioned a date
bump those are like be will appear into
a date to me yeah I mean typically
people did it in people people did it in
you know MapReduce right because you
could just write JavaScript to do that
but it was still kind of a pain to use
and it wasn't you know being able to
express it in JSON is very useful right
because you can just use it as one of
these one of these steps in the
aggregation pipeline and just say hey
like you know make this feel that has
like the month right or the day of the
week or whatever it might be so people
were able to do it before but it's not
something you could like express with
with JSON right in the MongoDB framework
so those exist now this like when you're
doing like a where you're like when
you're a fine can you hear peer into the
date days 500 years x where's that
limited just
oh you you can you can match it you can
match on a date but you can't like you
can do you could do like a range query
with like two other dates right that you
build you build two dates and you say
like does it match or you can build a
new date and say does it match this date
right so you could do it I don't know if
that's allowed
define what everything you can do as a
filter and aggregation
it was a theory but that's not a
commenta 42 wanted column it up either
so for instance either he's asking cali
available fine can we use it and
practice true is correct why do things
like finding anything with the day's
date stupid right Brett so but you are
at a set of functions their date for you
there yes right now available tonight
that's right so do you exhibit aggregate
hey guys ory Nelson 69
yeah must have to be done
to now and to too much actually the
explain fortune-telling is one thing yah
there's a couple optimizations
exactly oh man it's all in sheriff
I all the stuff we talked about today
except for out is already in there and
21 because I've been playing with it a
fair amount so it's it's a that stuff is
already in there so if you guys want to
give it a whirl and you know let us know
it's what's not working and what's
working what we can do differently you
know we'd love to hear your input too so
yeah pretty nice sport rocks or some
sort of like nature libraries
um I not I think I know what you're
getting up but and the answer to like
can you use these like stored procedures
like in and in a query no but like but
you can store there's Abby's on type for
JavaScript code and you can store
javascript in there but it's it's not
you know it's not it's not able to be
used in the query and even then right
even if you could store javascript in
inside a document you'd have to use
you're going still going through the
JavaScript engine again right and that
slows it down I make my own like
interlibrary their API that I can
actually call my own strong yeah
yeah you you probably could be really
yeah what's up this ones that you want
to just do any mining to think over the
8 on a Tuesday right I really important
need for that because i have like taco
dudes it and i'll put that would be
really important i would want something
about that bill event that's example yes
there's things at the store buckle I
mean there are many
as acts but
for their date information all the way
breasts timestamp as well as mainstream
for numbers great thanks
so you can actually solve that problem
today can't necessarily solve an awful
look where that fill up my sequel
database have store across and so that's
my friend will probably get there
eventually
the question of the five thousand things
do go back to the projection
exclusion sure
ok
is one ok
the end of the first field the first
yeah the first one determines whether
its inclusion or exclusion yep the only
one you can mix is when it's an
inclusionary mode is that even a word
where where you can add id0 in there as
well that's the only one you can mix so
you could say underscore id0 and it will
include that anymore but that's the only
that's the only case I guess that's it
right cool thanks</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>