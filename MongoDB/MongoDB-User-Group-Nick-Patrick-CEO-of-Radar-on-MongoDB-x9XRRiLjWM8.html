<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[MongoDB User Group] Nick Patrick (CEO of Radar) on MongoDB | Coder Coacher - Coaching Coders</title><meta content="[MongoDB User Group] Nick Patrick (CEO of Radar) on MongoDB - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/MongoDB/">MongoDB</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>[MongoDB User Group] Nick Patrick (CEO of Radar) on MongoDB</b></h2><h5 class="post__date">2017-06-14</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/x9XRRiLjWM8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so my name is Nick I'm the CEO and
co-founder of radar and as Jay Wright as
Jay said I'll be talking to guys about
our MongoDB implementation so two big
topics covered a one is what is radar
I'll give you guys a demo and tell you a
bit about what we're building the second
part is why and how do we use MongoDB so
let's start with what is radar so we
call ourselves the location platform for
mobile apps and our mission is to help
companies collect analyze and act on
location data basically if you're
building an app and you want to know
where your users are we aim to make that
really easy my co-founder and I met at
Foursquare back in 2012 so we've been
thinking about location for a while we
launched a few months ago we have a few
hundred developers that have signed up
and they're using radar to process
millions of locations per day so we're
really excited about the traction that
we're seeing so far so why is location
interesting what is the opportunity here
the best apps are using location to
build better products so think about a
couple examples
Starbucks is using location to power
order ahead and show you places that are
nearby Foursquare if you guys use
Foursquare is using location to know
when you walk into a place and they'll
serve you interesting content there
uber is obviously using location to
estimate arrival times manage supply and
demand and if you think about apps like
WeChat you can within a single app look
up a place to go to dinner see how busy
it is there order a car to take you
there see it coming to you when you walk
in the restaurant the menu will pop up
so great apps like these are using
location in creative ways to increase
revenue increase engagement improve
operations we feel like most apps will
be doing this in the near future
the problem is this stuff is really
still too hard to build so take a
seemingly simple example let's say we're
building a travel app and we want to
send a push notification when a user
lands at an airport in a new city seems
like a relatively simple problem to
solve when you start to unpack it you
realize there's lots of moving pieces so
the first part is you need to build
background location tracking on iOS and
Android there are cross platform
differences between between the two
platforms which I'll talk about you want
to do this in an accurate way but also
in a battery
whay takes lots of trial and error to
get this right second part is you need
to acquire place data for geofences so
you want to do opens airports or cities
you need to get that data set it up and
that can pick some time to do well if
you want to know if a user is traveling
you know some apps user will tell you
where they live and so you can infer if
they're traveling based on how far they
are from home but if not you could
potentially store sensor data history
for the user and cluster it and learn
where they live and where they work but
that takes some time to do well and then
all this stuff you need to test and
maintain right so lots of trial and
error to get this right with every
operating system release comes new
features around location services new
limitations Android Oh for example which
is coming out in a few months
places all sorts of new interesting
limitations on background location long
story short all this adds up to months
of engineering time if you want to do
this well it's just a total pain in the
ass and the same applies to other use
cases as well not just travel apps but
social apps dating apps food apps and on
the enterprise side on demand apps and
delivery apps and if you think about
other similar technical challenges there
are generally great full stack solutions
available to developers so you think
about payments they're stripe you think
about analytics there's companies like
amplitude or Mixpanel you think about
crash reporting you just pop into fabric
and turn on crashlytics the same really
can't be said for location there are
tools out there but they aren't truly
great full stack developer tools and
that's what we're trying to build with
radar so our goal is to make location
really simple we want to let developers
add location context and tracking to
their apps with less than ten lines of
code there's three different aspects to
our products the person's geo fences so
geo fences are regions or places you
want to monitor
we basically offer 10x better geofencing
than what you can get out of the box
with native solutions I'll talk a lot
more about that later on and how we use
MongoDB to power a lot of that stuff a
second part of the product is what we
call insights radar can over time learn
where a user lives where user works we
can tell you if the user is currently at
work or at home or traveling
we call that our incites product and you
can combine that with with geo fences as
I'll show you in a second the third
piece to our product which is in private
beta right now but we're going to be
launching relatively soon we call Places
and so without setting up any geo fences
we can tell you with a certain degree of
confidence which place a user is at and
we integrate with Facebook Places and
Google Places to power that so all this
put together lets you do things like
let's say you want to check if the user
is at an airport and traveling this is
basically the use case we talked about
before five lines of code you can call
track once get the users current
location see if they're out of place see
if you have insights for the user see if
the place has the category of airport
see if they're traveling that's it
you're done so you want to do something
when a user visits a Starbucks in the
background with stop detection again you
just pop the Android SDK and set up your
receiver listen for events see if the
event is of the type place entry and
check to see if it's of the chain
Starbucks that's a couple lines of code
say you want to set up a web hook that
will listen for the user exiting their
home you just add a web hook and radar
check the event type you can pull the
user ID from the event and do whatever
you want with with that or maybe you're
building a delivery app and you want to
dynamically create geo fences whenever a
delivery is scheduled again you can just
here API pass in whatever metadata you
want and set up a geofence so again
we're aiming to make location simple let
you power this stuff in a couple lines
of code and we're aiming to build a
platform that kind of elegantly spans a
bunch of different use cases across
consumer and enterprise so we talked
about travel but shopping apps food apps
on demand apps whatever you want I'll
show you guys a really quick demo you
may notice the branding is slightly
different in this slide deck than what
you see on the site right now I was
hoping to get this rebranding live
before I gave this talk but it's not
quite ready yet
because we'll see that in the next
couple days but basically really quickly
this is the radar dashboard you would
see if you're a developer using our
platform we show you how many users
you're tracking per month and how many
geo fences are active per month this is
actually just a personal test org that
my co-founder I use quite a bit you can
see I've created a geofence for MongoDB
HQ it's probably unnecessarily large but
there it is I can specify the metadata
for the fence when I create it like a
tag which is like a group ID and we call
external ID which it's an idea that
could map to something in your system so
the delivery use case we talked about
you might set tag to deliberate and you
might set external ID to your delivery
ID but these can be circles or they can
be polygons so if I type in Soho you can
see I have a geofence for the
neighborhood Soho this is a polygon it's
tagged neighborhood and create geo
fences via the dashboard via the API or
I can bulk import them from my own place
database every user that you're tracking
will show up in the dashboard as well we
have names and descriptions for the
users but you don't have to send us any
PII you just have to send us a stable
unique ID this is actual real data for
me so I can click here you can see my
current location is that that blue
marker right there we've also learned
where I live and work just by
unsupervised learning of my my sensor
data over time this is pretty good I
work at a co-working space called
workbench and Union Square we can learn
this for any user over time and tell you
the degree of confidence for that as
well and then finally we send you a
stream of events so these are things
like geofence entry events geofence exit
events but also entered home exited home
entered office exited office we can tell
you if the user starts traveling and we
can also predict the users place if you
have that feature turned on so here was
my entry event to Mongo HQ again I can
set up a web hook and receive this
server-side or I can receive this
client-side I was doing a bunch of
testing earlier with an Android phone
and walked over to Barnes &amp;amp; Noble and
you can square you can see this here I
can click and drill into the place
details and see the categories of the
place and what the chain is and again
this is stuff you can add to your apps
in just a couple lines of code so that's
the super quick demo now let's talk
about Bongo so really two things that I
wanted to die
- and then we can can do QA the first
thing is is how we use geospatial
queries and indexes to power a lot of
the geospatial stuff that we do and also
why we chose Mongo for that the second
thing that I wanted to touch on is how
Mongo is a natural fit with a JavaScript
heavy stack and before I jump into this
section just to give you guys an idea of
what our stack does look like this is a
super simplified view but up top you
have different clients you have our iOS
and Android SDK to talk to our API you
have any API clients the customers build
it's a restful api
everything is JSON so javascript our web
app is react more JavaScript our API
servers and workers our node more
JavaScript we use mongoose which is an
ORM for interacting with Mongo in node
and then MongoDB is our database for our
application there's some other stuff
going on here but that's what's what's
relevant to what we're going to talk
about today so first let's talk about
geospatial queries and indexes and you
may be asking like why do this stuff on
the server at all there's some pretty
robust geospatial capabilities on the
client you think about iOS for example
they have a framework called region
monitoring which is is geofencing
Android has has something similar so why
even do this on the server at all there
are some limitations to what you can do
client side that we aim to overcome with
with our platform so quantum limitations
is iOS has a 20 geofence limit Android
has a 100 geofence limit you want to
monitor more regions
you basically have to devise a system to
swap geofences in and out as the user
moves around it's a kind of anomie ask
but something you can do on iOS there's
no notion of stop detection or dwell
events so on Android you can listen for
entries dwells and exits on iOS there's
no notion of that so iOS will tell you
when a user enters a region but they
won't tell you the user is stayed in a
region for any amount of time you can't
monitor polygons geofences just circle
geo fences
they're only accurate down to about 100
meters and it's push not pull and what I
mean by that is the operating system
will push geofence entries and exits to
you but there's no easy way to say it
tell me which geofence is the user is in
right now and so we chose to basically
make our SDK really lightweight it wakes
up when the user starts moving around
and sends lat/longs to radar and we do
all of our geofencing and event
generation server side using Mongo which
I'll talk to you about in a second but
this lets us bypass those geofence
limits that we talked about it lets us
store the state for the user whether
that's you know what geofences they're
in and when they entered them or the
user's location history so that we can
do stop detection and dwell events we
support circular and polygon geofences
it's as accurate as the device can
report so we take lat/longs in with an
accuracy
sort of assigned by the device and we
can we can do geofences as small as 30
meters in practice based on what the
device can give us and its push end pull
so we can you know if the users current
geo fences and the geo fences they were
in to get entry and exit events we can
also write geospatial queries to figure
out which regions the user is at at at
any given time so I'll show you what
that looks like in a second just to sort
of understand our schema first we have
three main objects in our system geo
fences users and events this is a
obviously super simplified view of our
geofence schema but each geofence
document has an ID and then it has a
geometry which is a polygon for those of
you who haven't used geospatial features
in MongoDB before this is geo JSON
format so it's a sort of a standard
format to express polygons or points in
JSON format basically just an array
which represents a ring of coordinates
for the shape of the polygon users also
have an ID we represent their current
location as a point also in geo JSON we
saw an array of the users current geo
fences so it's their geofence IDs and we
also store a basically a list of or a
map of the times at which user entered
each geo fence and this lets us do
things like like stop detection and so
this is a really natural way I think to
express where user is with geofences
there currently and when they entered
them it's all a single document it
doesn't need to be spread out across
different tables and you can use this in
conjunction with geospatial query
operators and geospatial indexes which
I'll talk about in a second last object
is an event which has an ID it has a
type like user entered geofence it maps
to the user in geofence of the event
corresponds to and we also store the
location for which the event was was
triggered
so the geospatial query operators that
we use our near which will basically
return documents that are near the
specified point or polygon within which
we'll return documents that are within
the specified polygon and intersects
which will return documents that
intersect with a specified point or
polygon and you can use the geospatial
index to make all of these super
performant so what does this actually
look like in practice let's say we want
to figure out which geo fences the user
is near what you're looking at here by
the way is JavaScript so as I mentioned
we use mongoose as our ORM our lair for
interacting with Mongo the queries look
similar but you're basically calling
find on our geo fence model and you're
getting the error if any and an array of
geofence documents out we can say hey
let's let's call find on our geo fence
model and say let's find geo fences near
the users location with the max distance
of 10 kilometers super easy super
expressive we can do something with that
list of geo fences for example sync it
down to the client to overcome some of
those geo fence limits that we talked
about before let's say we want to find
which geo fences the user is in right
now again we just do a find on our geo
fence collection and we look for geo
fences where the geometry intersects
with the users current location really
straightforward really expressive let's
say we want to figure out if the user
entered or exited any geo fences same
query because we're storing a list of
the users current geo fences we can
basically do a diff and figure out which
geo fences user and turn or exited we
can do some more advanced geospatial
calculations if we want we can do stop
detection when the end of it is just a
super simple expressive way to
figure out what geofences user is in and
whether they've entered or exited any
and by designing the system this way it
lets us overcome all of the client-side
limitations that we talked about and we
were able to get up and running with
this very quickly I want to just briefly
touch on why MongoDB over post G is for
those of you who know post GIS or don't
know
it's basically an extender on top of
post grass that adds geospatial features
we like the fact that geospatial
features are built into MongoDB it's not
an extender it's sort of a core part of
what Mongo does and what Mongo is you
like that a lot of the advanced features
of post GIS are just sort of overkill
for our use cases and I think for most
sort of modern applications
the stuff that I highlighted in the
previous few slides gives us what we
need it's really natural it's easy to
use it's very expressive and there's
these two reasons well there's also
everything in the next section that I'm
about to talk about which is just that
Mongo is a really natural fit with a
JavaScript heavy stack so again our
stack is you know an API where where
objects are JSON web app which has react
JavaScript API servers and workers which
are node it's JavaScript Mongo
represents documents and JSON slash
piece on friendly with JavaScript so
what does this mean it's a really
natural way using using JSON it's really
natural way to model users geofences and
events I think it's sort of more natural
than modeling them as rows in a
relational database so I'll show you in
a second
transforming those documents to API
responses requires minimal application
logic I'll show you what that looks like
in practice in a second geospatial data
is represented as geo JSON throughout
all parts of our stacks so in the
database in our application layer and
I'll explain how we manipulate that and
also in our API we want developers
working with geospatial data coming back
from the radar API to have a sort of
standard format and they can easily plug
into other systems so geo JSON is is a
great fit for that and the cool thing is
you know as we think about growing our
team JavaScript developers can work
across all parts of our stack so
obviously there's domain-specific
knowledge when it comes to
you know best practices for Mongo or
react or whatever but it's very familiar
to folks regardless of what part of our
stack they're working on this is what it
looks like to take a user document and
transform it into an API response you
know the document the database has an ID
it has an organization which which in
our system represents the the customer
that the user corresponds to as a
location basically to send it out
through the API we pass it through a
pipeline step and sanitize it we change
the IDS to strings we remove the
internal fields like organization and
that's it so the way documents are
stored in our database is actually very
similar to the way they come back in the
API it's just easy to wrap your head
around then keeps our application layer
simple I've shown you a bunch of Geo
JSON already but again geospatial data
is represented as geo JSON in our
database in our application layer in the
API take a look it's a really standard
format easy to understand easy to use
and in our application layer and also on
our web dashboard we make use of geo
JSON heavily so some great libraries for
you guys to check out one is turf which
is put out by the folks at map box
it's basically a JavaScript library for
all sorts of geospatial calculations
they take geo JSON data in they spit geo
JSON data out so it's very natural to
just sort of plug everything together we
use Google Maps for visualizations in
our dashboard part of the reason we
chose Google Maps over map box is just
because they have great place data built
built into the maps which helps our
customers sort of orient themselves
around the places that they're
monitoring but part of the part of the
map box toolkit and something that we're
sort of using separately with Google
Maps is this library called super
cluster which lets you really perform it
client-side clustering of geospatial
data so this is a customer that and this
is actual real data from a customer that
has about 50,000 users kind of in the
Northeast and we're able to use super
cluster again with data that just comes
out of the DB out of the API throw it
into this framework cluster it display
it on the map never changes formats it's
it's always geo JSON
so that's basically it we'll do some Q&amp;amp;A
but just to recap we covered what is
radar hopefully my description made
sense why we use and love MongoDB and it
particularly we highlighted how we use
geospatial queries and indexes to do
geofencing server-side why that's great
how Mongo is really natural fit with our
stack which is very JavaScript heavy
hopefully that was clear and interesting
that's it thank you guys
yes we have time for some Q&amp;amp;A yeah yes
sir yeah so the question is do we
encrypt information do we keep it yep
and I guess in general just talking
about privacy so obviously with location
data privacy is super important I think
I mentioned this early in the
presentation I think one thing is worth
highlighting is we don't take any PII
into our system right all you do is send
us a stable user ID and that's it
so if I were to for example impersonate
a customer and log into their account I
could see a bunch of location data but I
wouldn't know who this person was
necessarily right the answer is yeah we
do encrypt it and an our API is HTTPS we
store this in a smart way it's not
encrypted at rest like the location data
per se but again just to highlight no
PII being sent and privacy is super
important to us so for that answers a
question was there a second part to it
yeah so we do store historical data to
do things like cluster it and figure out
where a user lives or works again it's
anonymized right so it's like we're
storing the user's name or email address
with this it's all just sort of tied to
that stable user ID that that you give
us that's the question
cool yeah so the question is how do we
throttle and reduce the noise especially
as our traffic grows it's an interesting
question from sort of an internal
perspective right how do we build a
system that scales and doesn't fall over
if we're installed on tens of millions
of devices someday and hopefully we are
in the near future we also want to think
about this in terms of the client-side
implication
of being on all the time and collecting
a lot of data right so what's important
is to do this in a battery efficient way
and not kill the users phone by staying
awake and using GPS all the time so we
try to be judicious with how we wake up
the SDK when we wake up the SDK when we
grab a lot long from location services
or when we do a Wi-Fi scan or a
Bluetooth scan to get that ambient
sensor data we try to be really smart
about waking up getting it quickly going
back to sleep and only grabbing it every
minute or two right so it's not like
we're getting constantly streamed data
all the time from every single device
we're batching it we're being smart
about when we're collecting it and we're
also only collecting it when the user is
moving around right so if the user is at
the office or at home or they're not
walking around or driving around the SDK
just just goes to sleep
cool blending thank you guys thanks
appreciate your time yeah all right guys
thanks</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>