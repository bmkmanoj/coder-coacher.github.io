<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>NYC MongoDB User Group - Mongeez at SecondMarket | Coder Coacher - Coaching Coders</title><meta content="NYC MongoDB User Group - Mongeez at SecondMarket - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/MongoDB/">MongoDB</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>NYC MongoDB User Group - Mongeez at SecondMarket</b></h2><h5 class="post__date">2012-01-24</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/-MCmBsVM28Q" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">we're going to talk to you tonight a
little bit about add a tool that we
developed an open source for ourselves
or we needed it for ourselves when we
decided to open sources and it's called
monkeys and we call it monkeys because I
friend who's Portuguese and I talk was
good the geese thing worked well with
mom so that's just a side note pretty
well so just to get some background
where do we use MongoDB I'm not sure how
many you know second marker buoy and we
are we're a tech startup that deals
investing in alternative assets and and
so we trade things like an private
company stock bankruptcy kings so just
diverse asset classes and and one of the
main reasons we wanted to use MongoDB is
that we actually store or diverse
diverse asset class in the schema three
in a scheme of free collection so in a
traditional database be able or forty
different asset classes and variations
of those we will have to have either 40
database tables or one database table
that we just will become humongous and
ironically and and with then be kind of
a little bit of a nightmare is
maintained so the fact that we can have
a single collection where all our
diverse asset classes stored numbers
pretty attractive to us the second thing
we do is we store all our notifications
new stories and events so on second
market you can actually follow a company
and you then have news feeds brought
into your string to give you some
information and it's to help you to make
decisions on what you want to invest in
that company more for example so we have
this is actually our largest collection
we have something like you know several
million documents it's on again it's not
huge but it's it's a significant and so
one of the things that we did a little
bit like the previous speakers we kind
of messed up our document structure a
little bit so we started to encounter
series dependency management issues and
so we had an immature document structure
probably over normalized and I used to
change it off when we are adding new ass
new variations of assets and and we
serve running into problems because we
need to ensure that document structural
changes were sent with the code changes
so for example if we change our
structure of our organization or an acid
dog document and we have 10 different QA
environments and you know several
staging environments and production so
it was a pain in the ass to booth put a
frank to make sure that when we deploy
new code that the actual correct version
of the database was in the same
environment so that is where monkeys
came from and and so so basically what
problems are solved for us it allows you
to change your document structure and
your code in unison but the real power
comes when you can propagate these
together across your different
development test and production
environments so how how does it do this
and so what we do is we maintain all
structural MongoDB changes and an XML
document so basically this is something
like what we do and we have a mongo
changelog and it has changed sets and it
contains scripts which are just standard
JavaScript Mongo Mongo scripts and and
every time you make a change you
basically add a new chain so I think
anybody who's familiar with liquid base
will recognize this ski mask its icon on
very similar and so you basically will
add new change set you give it a name
and an ID sorry and you you know you can
say an author as well and and that
contains your scripts the change set
itself contains one or more Center Bongo
script so as you can see in this we got
to this particular script that
highlights I have to organizational
inserts and and you know so you can have
multiple scripts and then you can also
have multiple files and change their
files and Link these anomalies or XML so
what we typically do for example is we
have the monkeys of XML file as a link
to
every change set and we typically have a
new change set per iteration it was a
very dramatic ax to start we would have
an awful lot of changes we kind of
managed to maintain or changes a little
bit better recently so and so what you
do then is you basically make your code
changes and your monkeys changes and
check into your source control system
together and then you link this to your
startup and application your application
startup so basically when your
application starts the first thing it
does is it looks at the monkey scripts
and it executes what it needs to do and
hope you do this you can link you can do
directly in the code you can so if I
just run through this it's a you
basically create new instance of monkeys
the class you tell us where the file the
monkeys or XML Foilers you tell us where
the Mongo instances and you just hit
process and that will run through and
the scripts and or you can do it via
sprint so in this example we have your
standard spring configuration you tell
you define your monkey URL you tell up
where your databases and you instantiate
your model class and here we have we are
we have a thing called execute enabled
equals value true what that means is
execute on startup you can have that
false and it won't execute on startup
you can execute it somewhere else or
smaller time we just have the DV name
and without the path to the movies
directional so what's happening under
the hood how does this work and I
particularly like this graphic of little
dodgy and so basically what happens is
the first time Mongoose runs in any
environment it creates a new collection
and in your database call monkeys okay
and home publishing service like they
execute this is the first time I'll
change center executors and is each
change that is executed is recorded in
the monkeys connection atomically which
means you can run this in a clustered
environment and and so you then has a
record of the script set of the
executors the next time you make a
change and the next time you make a
change to your scripts and you do a
redeployment it looks at this collection
it seems what scripts have been executed
it doesn't execute those and then it
will execute your new scripts that you
value them so what this means is when
you'd apply to your any environment so
in one QA environment i could add apply
a two weeks ago it might have you know
the first 15 changesets executors and
there's been seven hours it
automatically takes care of this so we
know never have a problem whether they
want version of a database of Mongol is
on any environment it's just
automatically taking care of us so it's
been pretty powerful and pretty useful
and so actually lexicon plugin these
laptop and give a demo so you know we're
not just talking crap we're going to
start with a single class so we use more
fear that way for connecting tomorrow so
we'd start with a single class of
represents an asset and has all its
information that requires in in that
class and then we're going to add three
extra classes subclasses of asses and
that has the broken it has the changes
in it is more and a different structure
I guess and we're going to see how
monkeys helps us the product so once it
this alexis is the initial database yeah
just sorry for my english unrelated so
this is the database that I have I have
so this collection represents an asset
and here I have three different asset
types types of assets in that collection
one is common stock another one is
functions and preferred stocks they
different looking that think ticker
expiration date dividend in the root
system would have more field suggest an
example the class name field is for more
fair on the rest just fields and this is
how the classic white looks like its job
application trans in GT de pinga example
spring MVC and the response is Jason so
right now this annotation tells that the
collection name is desert this is Agee
this is a fabulous and other fields
these are streams so very simple cause
but see I want to move these fields
please use in 20 causes productions
profit profit common stock let's say in
the next iteration I want to create more
classes with more fields however let's
say I want to create bonds so
so first courses per common stock tech
stands for my suit this is more
validation it's in the same collection
looks wrong
oh cool
it
in preferred stock
let me show you the database again so
I'm introducing new classes right now
the class name assassin here so i need
to change value of that field also there
is a small type when this value it's one
F and double r and they want to let's
say want to make asset type and status
in ops in java and i want to make them
care at all so I'm going to move
activation date and oceans cross you're
going to need to talk into that
microphone a little
get to a certain 4g juice on them
Oh
can you hold the milk
so basically what we're doing is we're
changing the definition of the asset to
having instead of having one generic
asset class we're going to have three
specific extending from the Assam and
that means that we have to change it up
in structure so Lexi's adding togethers
and satyrs and moving the data around in
the code getting rid itself of your need
trust also games and we're changing
these are from strings into actual
emails so quite a number of changes
happening in getting rid of the
unnecessary get ourselves so blvd main
task has become a base class and and
here are three classes are now extending
it actually I just realize that they
didn't show the application in the
beginning how it works it was lady up
the devil but let's assume that when it
starts it just shows me all assets that
they have in my database once I fix the
application or forget that so right now
I have the tacit and they have these
three classes that extended the invasion
collection next I change it strings to
he knows
so this is bringing this application
this is the main context xml file in
this direction well I have this monkeys
defined here is the where that monkeys
file is homemade ginger send that file
43 means iteration number was Philippe
so these are changes I want among right
now and one last change I want to win a
massive type in the back because this
field belongs to asset to do this its
massive typing
the two
once a wrong this application teach
should fail I it should think because
class names are not correct field names
a lot Fred here is the exact from arts
the government exception morphy right
now tries to create instances of that
asset because so we are we haven't run
the scripture doesn't work now try to
fix it I go to the dogs also the change
for school so this makes that it's going
to run on startup I have more flat
affiant here and it depends on monkeys
so any servicing it out that I have in
my application will take note that only
after that monkeys will be created
through the sauce it implements this
interface in this matter Oh magic pets
around the vacation again I should
tribute or objects over the database
yeah so this was my database gosh road
again
so no last names has correct classes i
renamed as a type in the type i fix it
then type it here in application world
sorry the demo was not as i expected it
to be but their vacation is simple
monkeys who was DeVos boost to give up
i'm going to do that example here too if
anyone is interested a good profession
and not its careers we create we turn we
create the monkeys change that file
monkeys are xml that's partly that's
what we look for okay so trusting
through the monkeys arsenal alrighty I
don't see one eyes it is it in generated
automatically or the integrated monkeys
are x value creating you actually that's
where you list your change sir files and
that's their you put path into the
monkeys that xml later in the class are
in d spring and integration so that's a
reversion for ya know like what there's
more like
yeah so the question is is does monkeys
know what revision the databases out yes
so every time we M sorry and sorry so
every time we execute a script it is an
adaptive monkeys collection so the
monkeys collection that we store is
specifically for monkeys itself and it
knows what is the latest version that is
being wrong it doesn't run it so it so
let's say there's 15 collections are 15
documents identify the first 15
chainsets it won't run those are low you
up run subsequent so every environment
had knows what it's gotta execute and
fortunately if you have to do it
yourself to be honest with you right so
monkeys doesn't handle rollbacks and so
it's a backup I think scenario
fortunately in the we've been using
football year we haven't had to do that
yet and it's not it's not like that ruby
on rails set those and an automatic roll
back and it's not trying to achieve that
at the moment unless somebody wants to
add it that's why it's open source any
other questions and okay so I'm sorry
hey like what's a years
sorry Cydonia why did you need a
separate separate tables well you don't
you don't have to say you can have you
could have all your assets in one huge
table but we are like we deal in
bankruptcy tapes and let's a private
company stock and they're just there is
no overlap of the day or whatsoever and
so you could put them into one table and
the fields are so different that it's
just them just this big big definition
or the alternative which is probably
most likely what we would have done is
have a table for each other haven't we
might try and make it so that we have 10
different definitions of NASA only i but
every time we would have to make a
change to announce a class a week or
there's so many the business wants to
collect some extra data we have to
change the structure of the databases
and who uses traditional see believers
and thanks a lot and so as I same and my
body is Portuguese and I thought I just
love that some we call them keys a short
and it's also you know it's a British
name for a dude so instead of saying hey
dude you say a keys so you know ten in
fact like geeks you know kind of keys up
so that's what I don't mind if I thought
it was making it easy well actually that
was where yours monk easy what's the
first version 11 we cut it back good
point hey so we we talked about this son
actually today we don't know a lot of
times quite frankly because it's we've
used it as you can see we're on
iteration 483 with this right now and
and we haven't had a huge need there is
one or two things that we might do for
example we don't take and we don't do a
digest of the structure of the document
are off so for example if I just go back
here somebody I let's go back yeah so
somebody because this script has been
and executed
you know change that one once it's
executed somebody can go back in and
edit that and think that it's going to
be executed again but it's not it's not
going to be executed again by taking you
digest we could at least alert the user
that you've edited something that's not
being changed but we're just pretty
pretty cautious where are all the
combinations in the car thank you there
is yeah so we actually have a little bit
of documentation and if you we're
together this mummys dog and there's a
small gay dog Wiggy and I think Alexei
Alexei is actually going to add the
example that we have tonight in there as
well to show people how to use them all
right so like everybody else in New York
City we're hiring and thank you for your
time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>