<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Moving Lanyrd.com: Changing Database &amp; Datacenter | Coder Coacher - Coaching Coders</title><meta content="Moving Lanyrd.com: Changing Database &amp; Datacenter - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/InfoQ/">InfoQ</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Moving Lanyrd.com: Changing Database &amp; Datacenter</b></h2><h5 class="post__date">2014-05-07</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/TAbf6OjXbDM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so last top of the night now API is our
well and good but my favorite things by
the night with is a good ops Tory and
this is one of those now Simon has kind
of ruined my reveal here I'll do it
anyway the challenge is to move from my
sequel to post greys and also fredo us
the SoftLayer the story behind this is
kind of long and convoluted but
basically there is sort of I'll explain
in a second to different situations that
came up roughly the same time as that
landed that meant that both these moves
made a lot of sense for us so let's go
through them now first of all my sequel
well it is a problem generally it's my
personal opinion but why in particular
is basically a problem first of all
thing and the big push for us here is
that adding columns is slow now scale
the time adding column on our biggest
thing was about 15 20 minutes so having
for Collins was over an hour that's not
really acceptable for a site where you
like Matlock's a table like you know say
that this is our core table links users
to what events they're going to which is
a big part of lanyard if that table is
locked the site basically can't run for
an hour so that's unacceptable and if
everybody scale it takes a lot longer to
run some musicians it can take sometimes
multiple days what we do it's sort of
using pakona so it's to run in the
background but Lani we did have the
option data integrity bicycle is quite
Paul it has foreign key support just
it's not amazing foreign key support it
doesn't have certain things like
asserting check constraints and
asserting so type some foreign keys and
that kind of stuff and you can sort of
slip Knowles into columns they shouldn't
be there and it corrupts very easily all
manner of naughty things there's a whole
other tool by itself has a very limited
set of data types now my sequel has
strings it has dates doesn't have times
as updates just had dates it has a few
other things purchase has a raise posts
a day two time zones POSIX have IP
address field types has whole manner of
rich tones of fields with their own
indexing their own fast lookup functions
lower the stuff you want and yes that's
unlike the key thing here is that adding
columns of slow this is the main thing
to us to move after I think I think one
change took two hours of swiping that
read only mode something showed you
earlier we're like okay this is kind of
a bit much now what do we do there are
many many other option reasons this is
the whole tool by itself if you're in
Budapest in two weeks time I'm giving
that talk there but this is not bad talk
so the second problem here is a WS now
AWS is kind of a trade-off it's more
expensive than most service by itself
but the wonderful idealistic goal is
that you like this graph you have a
lovely sort of peaking right now this is
this ascent to your netflix this is the
evening this is the middle of the
morning no one no one watch a TV here
everyone watches TV here right that's
fantastic so what you do is you have it
d'oeuvre as you add more than one goes
up you scale down they drops down again
and you save money in this gap here
where you're not running servant that
that's your money saving now
unfortunately LAN is demand that's much
more like this so sort of it sit there
is there is definitely a curve there but
we had a quite a lot of international
sort of usage of the site was quite a
flat curve and most of our mom was on a
yearly basis there's a there's a big
peak around sort of spring and autumn
and a dip in winter and so we didn't
really have that reason to like you know
the ops work involved a scale servers
that point it's so fragile and so
difficult it just wasn't worth the
investment for us so what we're doing
we're paying hourly rates for what we
should be eating like in theory will be
set there's money here actually we're
just paying a more expensive hourly rate
on this continuous scale another another
small reason that disk i/o is very slow
on virtualized servers this has improved
a bit since but it's still pretty bad
it's one of the slowest things usually
do you need ten times or worse slower
and so this kind of feed into this sort
of this world the spectrum of hosting
there are many different kinds of
hosting they kind of run on this thing
from very immediately costing sort of
very fixed and generic solutions like
AWS a cloud provider all the way down to
building your own Dave Center which is a
ridiculous proposal but we don't don't
ever do that unless your google and he
like costs from the decades are like
well we need to get we'd get generator
the waiting list generators is a year CD
factor that into the thing we need to
get the builders in like it becomes a
ridiculous
effect and so somewhere on this scale
and you're pretty move up and down as
your company grows and shrinks you'll
sit so but I think you know my personal
website sits here because it's a good
balance between you know I'm a single
person i have not very much I'm not
confident much funds they want some
customization landed was over here we
jumped down 2 steps to decatur servers
and so what sort of what you've got the
cloud providers it is wonderful like you
know servers are fully available they
spit up Matt rapidly but they're kind of
expensive and down here it takes an hour
to get a server and but you can pick the
memory you can pick the disk types and
they're a lot cheaper on sort of the
overall monthly scale and so that's all
that then you know doing at the same
time like one of these moves is already
crowd like moving from icicle to
postgres is already a crazy idea
combining your they're moving across an
entire continent at the same time and
changing the kind of hosting you're
running seems a bit ridiculous but there
are good reasons why we did this through
the mean key reasons are that both of
these need timing we only mode now
read-only mode isn't down time it's a
lot better than that but it's still not
full site functionality there's still
issues with it you're not logged in you
can't attend and track a new events you
can't create event so it's not a
platform or to be in and at this point
we're telling about six seven hours and
we only mode in the past two months and
so we were kind of worried we do have to
make too much more of it both of them
involved copying the whole dataset which
is so the reason behind read-only mode
like both of these moving data center
and also moving your database involve
freezing the database and time mutating
it somehow they moving across constants
or changing the fall out of it and then
reloading it and so they kind of said
that's not only the interleave very
nicely both of these concepts sort of as
you'll see in the plan later on can be
done sort of in step with each other in
a way that they use fractionally more
time than an individual one you get so
much more done so the key trick here I
harder the two things is converting my
table to postgres now this the stylist
product was kind of like an idealistic
goal like I would love to convert my
table to post goes it be amazing how
would you do that like they're very
different databases they have different
Colin types different formats different
everything is different bout them they
both run sequel that's about the same
and even then the seagull doesn't really
match properly and so your key thing
here is you start with my sequel
excellent place to start if you're
getting away from it you then dump that
in-house crows compatible format now I
think at some point in the past this was
post was compatible it hasn't been
freely two-decade so you get you get
this farts it's kind of it's not my
sequel but it's not post because I
that's kind of a middle ground that the
quoting is wrong the functions are all
names wrongly but it is a star and so
that what we have their nips second step
which is what we wrote inside lanyard is
a scripted file conversion takes this
dump file turns into a separate dump
file and what this is doing this is
fixing quoting this is fixing sort of
super syntax and small minor variations
of things but it's generally a very
quick mapping like you know this I think
was a sort of tens of gigabytes file and
being mapped into similar size that
conversion took about ten minutes it
started off being around I think it was
an eight-hour conversion and sort of
optimized it down I talked about that in
a minute but working out how we could
save time when I conversion and getting
it to be a much more efficient
conversion then you take that single
file can be called a moving five sizes
too you load it over the network in to
post grades so this especially PG dump
over ssh which actually is more
efficient than transferring and loading
at the same time because this is disk
bound this is network bound they kind of
cancel out and so this is streaming from
AWS into softlayer at this point loading
it in but the key thing here is that
this schema here is not our final schema
now one of the differences between
Michael and postcards Django in
particular is the types of columns we
just saw things to example then my
sequel a boolean is thought as a tinyint
one in post-credits thought as a boolean
type that's a type cast that those are
expensive and initially this this
scripted file conversion here was doing
those in memory would see okay I know
this table is going to convert billions
whatever so I'm going to examine every
line the single file take that line in
pars the fields out change the value be
true false and write it out again that's
what took eight hours convert a sort of
a moment of happiness hit me whereas the
postgres Club conversion built in and
it's a lot faster than my code is
written by people know they're doing
and so what happens here is there's a
second step here where we take our this
scheme which looks basically is a direct
mapping of my sequel schemer and then
add in our better types with type costs
and so this is about 15 minutes ish this
is about I'd say 30 minutes ish and this
is tens about ten minutes like this this
is the really really quickly post which
is very good at doing typecast it turns
out and all things are similar in
Terminator thing and the nice thing is I
did all this work so you don't have to
if you have aught to do this the
converter is available at github in this
URL it is deliberately unmaintained
because i cannot maintain a crazy idea
like this are very long there are some
pact has been pulled in but it's it is
at its basis and mad idea and so those
don't really could take very well to
being maintained but it's there it works
I know several friends have used it
since it's worked perfectly fine for
them so it's something to consider but
overall like you that's pardon me but
what how'd the move go as a practice
like there's a timeline here there's a
lot of organization Natalie in
particular is very good at sort of
setting timelines and organizing things
and getting us all working properly
which is fantastic but the key thing is
the day before that some things do like
don't forget don't just so today is fine
it's all tomorrow all the works tomorrow
you need to make sure your servers are
ready key thing otherwise you'll wake up
like panic and also sit make your DNS
TTL nice and low now not everything
honors DNS TTL which is the sort of
expiry time for DNS record but a lot of
things do and five minutes 200 seconds
is to the lowest you can generally sell
it so that's a good place that's the
start that's all good go sleep have a
nice sleep hasn't been nice not to ever
wake up go so the key thing is landed is
in what was in the UK and so we have the
advantages at the morning in the UK is
when all of you guys america asleep it's
great and so 9 a.m. in the morning is
the best time to move stuff because
everyone hears asleep our loads visit at
its lowest point and so at that point
put the sign to read only mode you know
fit that feature flag chance they're all
good and then once that started we
started a leysomme conversion that's
profit flow chart showed you earlier
sort of the first leg of it there that's
all good then when the convergence
finished then start loading that convert
data across the network into
new database and no we're not sitting
around this time we also making sure the
new services but with the right Crohn's
all the files have been moved / properly
all sort of background stuff but that's
what easy committed this big task here
once that load is finished we then make
sure the stops working correctly so this
is the whole team browsing around
checking them we sort of pins that new
dns place and making sure was working
correctly and once the once I sure it's
working fine and this is the point of no
return you switch the dns and you point
the load balancers on the old cluster to
the new cluster thus even if your dns is
updated that still works it's a bit
slower but you're still getting all the
people with bad DNS providers the new
version side just drops in via amazon
and then point of no return is to exit
we'd only mode once you come out
read-only mode you'll databases of your
old new site of diverge and you cannot
ever motor them again you can roll back
in a dire situation which i never did I
force I remember you can roll back but
you cannot merge and so you'll be very
sure we think of that last point that
okay we've moved it's all fine this is
the future and then turn it on and yeah
so you know this is a tricky process
it's kind of sort of tight tightens the
muscles while my say and so with that in
mind there's a lot of dry runs here I
ran the database conversion I think
eight times and I five of those at least
had errors and particularly the quoting
of strings I think postcodes uses single
quotes and Michael use double quotes
you'll flip them over and any double
quotes inside the strings flip them over
and then it gets very complicated and
then unicode came into the fat call to
the factor and all that was had to be
dealt with but I think after the first
five times had a good clean run added
three more of a good luck and then we
did two whole dry runs the whole move
sort of making these servers come over
testing the site everything but that
last segment you saw there and it's this
kind of thing that gives you confidence
that you sit down that last day in a
launch go you know me and Tom one of our
the sort of engineer stops people we've
sat down with sure of this we're
confident about this we can do this and
like it's very important to have
confidence especially when you know the
entire sites livelihood is on the line
here like if you roll back already
strongly that's not only a PR disaster
but you could lose data in that process
it's very important get it right what
did we learn first of all it'll wait
well hey this is a very rare ending to
an OP don't importance out it's very
important not everything went perfectly
it was a bit slow might like and there
were a few hiccups we forgot a few
things we caught them all before that
last launch that's a big scoop text
document I tried to find but couldn't
unfortunately the show here I've sort of
all the checklist points we went through
and all the different things we did key
thing is server load drops now our new
softlayer servers we're more powerful
have that nice quick disk access as well
and so our server load dropped in the
graphic violent like this not as much we
would have liked considering the servers
are a bit more powerful but it was a
drop at least and the rest of that load
was some other part of our process and
we can love that later day and the
server costs were harmed which we knew
we knew this going in like one of the
main reasons for this move awaiting it
was like i sat down worked out AWS cost
this much soft like us this much this is
like half the cost that is a very big
part of getting Simon come aboard is
like like this is we can do this now we
can save this much money per month and
that was a very important thing and you
know in a startup that money you know
that kept the money counts you can do
more work with it you can have more
servers now we had a lot more Headroom
on our serving structure for things like
big events or south bites always
overwhelms landed every year another fun
thing is the SSDs which we moved all of
databases on to are not a panacea they
don't solve your problems they are very
helpful they certainly improved a
response time but not amazingly the kind
of disk access a database does often
won't be compatible with these and also
postgres is by default because it's
actually intelligent tuned for hard
drive is slow seek time we can dive into
the postcode configuration file and say
hello post grades your drive has zero
seek time go and it optimize it screwy
plans for that new hard drive instead
and so it's much better at planning out
and saying okay actually hitting this
index isn't as costly as hitting this
thing a memory and rearrange itself and
when we did that we've sort of nice bit
extra drop in our post coast time as
that was quite nice and also and kind of
the five most important point here move
before it's too late if you want to make
this move you can't do it advent white
scale he's not in any kind of reasonable
sense lanyard was around the 70 80
gigabyte gigabyte range at this point we
moved that in about an hour that seems
fine for a site of our size
any bigger in itself becoming a problem
so if you're considering this or setting
some other move like different paper
technology the earlier you do it sort of
the easier and cheaper it will be but of
course you had to divert new features
and as a startup that lamb is
differently there's always that race
between we need to make the site better
we need to add new features when you
keep going as scaling and so that's
always a tricky one the balance out but
this kind of task especially is so much
easier if you do it earlier on when I
take a smaller thank you
yes</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>