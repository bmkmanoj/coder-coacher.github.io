<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Building Twitter with Grails in 60 Minutes | Coder Coacher - Coaching Coders</title><meta content="Building Twitter with Grails in 60 Minutes - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/InfoQ/">InfoQ</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Building Twitter with Grails in 60 Minutes</b></h2><h5 class="post__date">2013-08-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/pmT1zg8Cie4" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">good afternoon everyone my name is Jeff
Brown and I work for pivotal pivotal is
the organization behind groovy and
grails and a whole bunch of other
technologies but I'm going to be talking
pretty much about grills particular
today my email address is Jay brown at
gold pivotal com
you can find me on Twitter at Jeff Scott
Brown if you have any questions at all
that that I can help you with after
we're done today please let me know and
I'm happy to help you with with anything
that I can so just to get started a
quick show of hands how many of you have
done anything at all with Grails yeah a
few very good so I'm gonna provide just
a little bit of history about the
framework and a little bit of overview
and then we're gonna jump quickly into
into an application and play with play
with some source code normally this is a
90 minute session and the difference
between 60 and 90 minutes is maybe more
than you might think in a 90 minute
session normally we can build build this
whole application that I'm going to talk
about from scratch and that's really
tough to do in 60 minutes so instead of
building the whole thing from scratch
I've got a good bit of code written and
we'll just pop that up and look at it
and make some small changes to it so I
think we should be in good shape too to
get through all of this in 60 minutes so
let's get started
so Grails is a full-stack framework for
building web applications for the JVM in
particular for the JVM if you're
targeting any other platform Grails is
Grails it's not going to help you with
that Grails leverages a whole bunch of
existing technologies to make up that
that full stack so inside of Grails is
an ORM tool and inside of Grails
is a runtime environment a server
container for you to pull your
application inside grils is a dependency
injection container a logging framework
all that stuff that makes up a build
tool all that stuff that makes up the
full stack framework most of that or at
least much of that is implemented
by some other tool right we didn't write
our own dependency injection container
for grills we use spring for doing
dependency injection and we didn't talk
we didn't write really a full ORM tool
from the beginning we built the thing on
top of hibernate and we didn't write our
own build tool we took advantage of a
technology called Gantt so Grails is
really made up it's this full stack
framework that is made up of a bunch of
best-of-breed technologies for solving
those kinds of problems right the kinds
of problems that show up in lots of web
applications so we'll talk a little bit
more about some of those details in just
a bit
Grails features a plug-in system that's
a really important part of the whole
Grails story if you're going to do
Grails application development the
plug-in system is an important part of
that process you're going to want to
take advantage of a lot of plugins that
are out there you may end up writing
some of your own plugins and a lot of
the cool stuff that we're gonna look at
today in this this little kind of simple
Twitter clone that we're going to going
to gonna dig into a lot of this the cool
stuff in that application has to do with
behavior and functionality provided by
plugins so just note for now note that
the plug-in system is a really important
part of the Grails framework and I'm
going to talk more about that when we
when we start looking at some code so
this is a list of some of the big
players in that list of best-of-breed
technologies that I mentioned just a
while ago right so groovy is this really
powerful dynamic programming language
for the JVM and Grails uses groovy all
over the place we use groovy for for
lots and lots of things of course Java
is as part of the story here all of this
is built on top of the JVM
we use spring for dependency injection
and transaction management and we use
spring for a lot of things spring is
really a core piece of the Grails
framework Grails is built built on top
of spring we bundle a version of Tomcat
with with Grails so when you install
Grails you've got a version of Tomcat
there you wouldn't use that that
particular copy to deploy your
production applications but in your
development environment there's a simple
command you type Grails space run app
and what that does is it fires up an
instance of Tomcat you don't you don't
have to know anything at all about
Tomcat you don't even have to know that
it is Tomcat but that's what's there
you type Grails run app and Tomcat has
started up your application is built and
deployed to that Tomcat and you can
start interacting with it in the browser
and we'll do some of that in just a bit
but that's bundled with a framework
that's not something you have to
configure on your own before you can
take advantage of that Grylls includes
this RM layer called Gorham G ORM ORM is
really a tough problem to solve so the
framework doesn't provide a full ORM
solution what the framework provides is
really really powerful and flexible and
expressive layer called Gorham on top of
some other persistence engines and
initially we built this on top of
hibernate write hibernate is a really
powerful really flexible and really
popular or EMM tool for the JVM if
you're writing Java applications that
talk to a relational database there's a
there's a pretty good chance that you're
using hibernate to do that right
hibernate is for a long time has been
kind of the de facto standard ORM tool
for the JVM so we built Gorem on top of
on top of hibernate and then later on
something that happened is we really
fully decoupled Gorm from from hibernate
and with recent versions of Grails and
it's been this way for for quite a while
now you can pull hibernate out and plug
in some other persistence engine so
we've got there are a whole bunch of
ghorm plugins there's the hibernate
plugin that we provide there is there's
a MongoDB plugin there's a cassandra
plugin and if you invent a new datastore
this weekend and want to write a ghorm
implementation of that you could do that
right so we're set up now where we've
got ghorm which is this Orem abstraction
layer provided by the by the framework
and it's pluggable so you can plug in
lots of different persistent persistence
engines underneath the the gorram layer
generally when you're writing
persistence code in your Grails
application you're not writing hibernate
for example hibernate is the default
persistence engine but you're not
writing hibernate code you're writing
Gorm code
in grills the the hibernate plug-in that
you would be using by default converts
all that Gorm code into all the tedious
hibernate bits so hibernate is used to
talk to the database but generally your
application code is SCORM code not
hibernate code you can poke down a layer
below and get into the hibernate stuff
directly if you like if you wanted to
interact with the session factory for
example there's a really really simple
way to do that but for the most part
that you don't have to do that you end
up writing just warm code and one of the
nice things about that is then you can
pull hibernate out and replace it with
MongoDB if that makes sense for your
application and for the most part your
application code stays exactly the same
because you weren't writing hibernate
code you were writing ghorm code and
ghorm there's an implementation for gorm
that knows how to talk to MongoDB for
example so we'll look at some of that
when we when we dig into the application
source code site mesh is another piece
of technology here we use site mesh for
page layout and page decoration the idea
here is that Grails is this full stack
framework and it leverages a whole bunch
of other technologies to make that
address these common problems that that
show up in lots and lots of web
applications so this is kind of a visual
representation of how all this is laid
out all of this is is built on top of
the JVM right and that layer of
Technology there where you see site mesh
and spring and hibernate there's a bunch
of other things there there are those
three and log4j and there are a whole
bunch of technologies that Grails builds
on top of so Girls is built on top of
all that stuff and groovy is kind of a
thread that we use to tie all of that
together right so when you build a
Grails application you're probably going
to be taking advantage of spring and
you're probably at least by default
going to be taking advantage of
hibernate but you never have to write
you never have to write any spring code
and you never have to write any
hibernate code you can when that makes
sense but there's you can get an awfully
long way down the road of taking
advantage of those technologies without
having to interact with them directly
Grails
kind of managed this all out of that for
you right this is a small subset of a
lot of the kind of big name companies
that have been using Grails for a long
time
Netflix LinkedIn you can see the list
there so there are lots and lots of big
enterprise serious enterprises out there
that have been have been using the
framework for really for a long time now
I mentioned before that the plug-in
system is a really important part of the
whole Grails story and this this graph
is a couple years old but the point is
is correct so in 2008 there were about
150 plugins in our public plugin portal
and then in 2011 there were something
like 600 and if we looked at the portal
today we'd say there's something like
900 right so there are nine hundred and
something plugins in our portal and
there are plugins to do all kinds of
stuff stuff that shows up in in lots of
web applications so for example if
you're building a Grails application and
you want your Grails application to use
CAPTCHAs there's no reason for you to
have to write all that and solve that
problem yourself there are several
CAPTCHA plugins out in our repositories
you can install one of those plugins and
then take advantage of it and and you
end up not having to solve the CAPTCHA
thing yourself right you're using a
plug-in and solve that problem for you
and now you get to spend more of your
time and more of your effort solving
your business problem and not solving
these these common web application
problems so there are CAPTCHA plugins
there are security plugins and there are
caching plug there are plugins for all
of these problems that show up in lots
of web applications and you want to take
advantage of those like I said this this
graph is out of date if we extended this
out to 2013 we'd see that the the trend
is basically continued there they're
over 900 plugins in the portal right now
so before we press on and get any code
any comments or questions about the
framework at a high level at this point
no thoughts all right very good let's
get to the fun bits so I'm gonna jump
into the IDE here and like I said
instead of starting completely from
scratch we've got some code in place
that we're going to use as a starting
point the first thing I want to do is
just start the application up and
interact with it so we can get a sense
for what the application does right now
and then we'll back away from that and
look at some of the source code and get
it get a sense for what it takes to do
some of these things
in an integrals application so what
we've built is a really simple and
trivial kind of Twitter clone so we'll
see that I'm going to be able to once
the container is up and running and it
is up and running right now so we can
now we can open a browser and send
requests to this URL and we have a
pretty lightweight simple Twitter clone
here I don't want to do this in the IDE
I'm gonna go open a real browser and do
it out here all right so we're
interacting with the Grails application
right now so like I said what we're
gonna do is is step through some
functionality in the app really quickly
and then we'll back up and look at the
technical details of how some of this
happen all right so the system supports
authentication and it turns out it did
that with very very little code we'll
see what that what it took to make this
the the security part of this happen but
there's very very little code in our
application that relates to
authentication so I'm gonna log in as
Jeff like it says there my password is
password if you try to log into my real
Twitter account my password is not
password that will not work all right so
here is our Twitter interface it's the
first time I've logged in so there's no
data we don't we don't see anything
interesting so I'm gonna update my
Twitter status I'm gonna say that I met
Jack Scott's right and click update
status so here's my first Twitter post
is I'm at Jack's conf I'm still at
Jack's conf right there's a another post
on my Twitter timeline so I can I can
keep posting messages and they'll show
up in my timeline here and I'm not gonna
go through the process of doing this but
if we if we answered more than 10 we're
only gonna see the most recent 10 there
we'll look at the code the relevant code
for that just a bit all right
so Jeff is logged in he's posted some
messages to his Twitter account and that
that's the state that the system is in
so I'm gonna log out and log back in as
someone else I'll log in as Graham and
we see his time line is empty there's
nothing down at the bottom there I'll
type Graham's first post right so now
his time line is being populated he's
got one thing in his time line and we'll
log back out and log back in as me
and my timeline is in the same state it
was in before right we see I'm in Jack's
camp I'm still a Jack's count all right
so that that's all the interacting with
the application we need to do for now so
let's just review what we can do so we
can log in as a user I can post some
messages as that user I can log out and
then I can repeat the process I can log
in as a different user and post them so
all those those statuses are stored in a
database right now one thing we can't do
is follow other people right there's
nothing in the application to support
that yet we're gonna add that it'll be
really really simple but we can't do
that so really all I can do with the
application at this point is post map
post messages and view my own messages
that's all I can do that's not terribly
interesting so far alright notice down
at the bottom that list of status
messages there you see several details
you see Jeff Brown said something and
then you see a date right so there's
three pieces of information there
there's a person that's whoever posted
the message there's the message and a
date and time that that message was
posted let's go look at some source code
and start talking about some Grails
features that relate to all of that so
in my Grails application I've got a
domain class and a domain class is a
special kind of artifact that Grails
treats domain classes differently than
other classes one of the things that
Grails does with all of your domain
classes is it naps them to the database
right so this class has been mapped to
the relational database that our that
our application is using the class this
is the entire source code right here so
I've defined a class called status a
status has three properties it has a
message it has an author and it has a
deep created right when it was created
the message is just a string right it's
whatever you typed in the user interface
the author is of type person we're gonna
look at that class in just a second so
stand by on that and date created is
Java dot util that deep
alright so every status has three
properties those three properties
correspond to stuff that's being
displayed at the bottom of the page over
there and this is the source code for
that domain class so this is a groovy
class it's in a file called status
groovy that's all
groobie code I don't need semicolons all
that code is is perfectly valid let's
look at the code that gets executed when
I type something in here that says this
is my latest update and click update
status I want to look at the code behind
that button what happens when I click
update status so from the users
perspective what's happening is a new
status message is being created and my
timeline down at the bottom is
automatically updated with with that
information so every time I fill out
that form and click update status one of
these things is being created and
persisted to the database all right so
let's look at the code that makes that
happen so we've got a controller called
status controller and it's the only
control up the only relevant control
whether we need to talk about right now
and inside of the status controller is
this action right here called update
status and that code is being executed
so lines 20 through 24 there that code
is being executed each time I fill out
the form and click Submit this is the
code that we want to evaluate really the
interesting part of this at this point
is line 20 so that says status service
dot update status and we're passing a
message as an argument the message
that's that's passed into our controller
action here is whatever the user has
typed in to the form so if we go back to
the browser and view the source on this
page what we'll see is that there is a
form an input field right here that's
not the right one this one down here
there's a text area whose name is
message right text area name equals
message ID equals message is what that
says so the name of that text area is
message when this form gets submitted
Grails will do some interesting things
with with the request parameters on your
behalf so the form is submitting to this
controller action right here the update
status controller action and there's a
parameter we've declared a parameter
called message and what Grails will do
with that is
we'll look at the variable name message
and when this controller action gets
invoked Grails will look to see if
there's a request parameter with that
name and if there is the value of that
request parameter is passed in here so
we don't see any code here that's
dealing with request parameters or
servlet stuff or anything Grails is
managing all of that for us all we had
to do was to declare a parameter called
message and if I wanted other pieces of
data to be passed in here was it int
number of something right so with that
if there was a request parameter called
number of something Grails will
automatically pass the value of that
request parameter into this controller
action so you don't have to write any
anything that interacts with the request
parameters directly you can but you
don't have to right if all you if the
only reason you're interacting with the
request parameters is to go grab
particular values you can eliminate that
and let the framework pass the values
into your controller action for you
another way you could do this is you
could say message equals params dot that
message right we could get rid of this
now Grails is not going to pass anything
in to our controller action the
controller action doesn't accept any
arguments but now we've got this code
that's explicitly or directly
interacting with the params object right
params is a map that includes all the
request parameters so now I'm
interacting with with that thing
directly that's not terrible but we can
eliminate that by letting the framework
know what pieces of information we need
and we express that in the form of
arguments to the controller action right
questions about that so good all right
all right so whatever the user typed in
to the form field is being passed into
the update status action here and line
20 is really the interesting bit that
we're going to focus on and that is so
it's invoking a method called update
status on status service so let's take a
look at what status service is on line
10 there we've got a property named
status service declared in this
controller and if we scroll around all
over this controller you would see that
there is no code anyplace that
initializes status service so it looks
like status service
should be no right but it turns out that
that grills is going to initialize that
for us I briefly mentioned when we
talked a little bit about this status
domain class earlier grills does special
things with domain classes right it maps
them to the relational database and adds
a bunch of special methods to them that
we'll talk about some of those in just a
bit but a domain class is a special kind
of artifact to the framework there are
other kinds of special artifacts that
mean different things to the framework
and one of them is our service classes
so if we look out here under services in
our application I've got a couple of
services already created one of them is
called status service that's the source
code we're looking at now we're gonna
talk about all this this top part in
just a bit but inside of this status
service class is a method called update
status nowhere in our application is
there any code that creates an instance
of this class so as the application
develop developer we created this class
called its status service and put it in
a particular place in the directory
structure and that told the framework
that this is a special class this is a
service class so a service class means
something special to the framework one
of the things that will happen to this
class automatically without you having
to write any code is Grails will create
an instance of this class and put it
into the spring application context and
the bean name in the spring application
context will be the class name
lowercased right so the bean name is
going to be status service with a
lowercase s upfront so in the
application in the spring application
context there will automatically be an
instance of this class you don't do
anything to make that happen Grails will
do that for you and then in addition to
that all Grails artifacts are
automatically subjected to dependency
injection dependency injection by name
one of the consequences of that is if I
declare a property in a controller for
example called status service like we've
got on line 10 there if there's a bean
in the application context with that
name Grails will do the dependency
injection for us so we don't have any
code that creates a status service we
don't have any code that initializes
this reference declared on line 10 but
before our application code gets
executed all
stuff has happened write a status
service object that's been created it's
been put in the context it's been
injected into this controller and the
controller can directly interact with it
right so down here on line 20 the
controller is invoking this update
status method on a thing that we never
initialized but the framework
initialized it for us right to make
sense right all right so what we're
doing there on line 20 is invoking
update status on that object and passing
message as an argument
remember that message is the string that
the user typed into the end of the form
there so let's look at that update
status method so line 26 is creating a
new status object
remember status is this thing we looked
at over here right a status has a
message an author and a date created
message author and date created the
service is creating one of those on line
26 and initializing the message property
only the message property is being
initialized on line 26 so the other two
properties are uninitialized so far and
that is the date created is not
initialized and the author the person
who posted this message has not been
initialized the author's initialized on
the next line right 26 line 26 says
status dot author equals lookup current
person and lookup current person is
retrieving some information from the
security plug-in to figure out who's
logged in I don't want to get distracted
with that bit right now what I want to
notice is that by the time the thing is
saved to the database when line 28
executes status that the message of the
status has been initialized and the
author has been initialized but the date
created has not been initialized right
nope late we don't see any code here
that's assigning a value to date created
so we might want to do something like
this we might say status that they'd
created equals new date right we wanted
to be right now right that's what time
the message was posted but we don't need
that we don't need that code it turns
out that date created is a special
property name that means something to
gorm so when Gorm objects are persisted
to the database if there's a property in
the domain class called date created and
it's type as a date
Gorem automatically initializes that
thing and that that's a common thing
right often
you have a time stamp or a date
associated with an object and you want
that to automatically be initialized
with with a value that represents
whatever time that object was created so
instead of every Grails application that
wants that behavior having to repeat
that logic over and over and over again
the ORM tool solves that for you right
so if you declare a property in a domain
class called date created it will
automatically be initialized you'll
never need to in fact you shouldn't ever
initialize that property the or the ORM
tool will initialize that property for
you right so our status service updates
status method creates a status object
initializes the message initializes the
author and saves the status object
so when line 28 executes that object is
persisted to the database right so we're
invoking the save method on the status
object the status object is an instance
of the status class if we go look at the
status class there is no save method
here right there there's no if there
were save method it might look something
like this right save and then some code
in here to talk to the database but we
didn't have to write that code that code
exists but we didn't have to write it
one of the things that Grails does to
all domain classes is it adds a method
to every one of them called save and the
save method does whatever it takes to
persist that object to the database so
if we're using hibernate the save method
will do one thing and if we're using
Mongo the save method will do another
thing and if we're using Cassandra the
save method will do a different thing
but all of this code all of our
application code stays exactly the same
so we pull out the hibernate plug-in and
and push in the Mongo DB plug-in and all
of this it still works
right we don't have hibernate queries to
address we don't the Orem abstraction
layer is managing all of that for us
makes sense questions or comments about
any event yes sir yes so how do you
express that a class is a domain class
as opposed to a service or some other
artifact type it's a good question so in
your Grails application let's take a
look at what the file system looks like
for our Grail set right down here there
we go Grails Twitter is the one where
after on the on the file system is a
directory called Grails - app and below
Grails - app are some folders like
controllers and domain and services and
tag Lib those directories they have to
have those names those are names that
mean something to the framework they're
automatically created when you create
when you create a Grails application and
so all over the place Grails leverages
this really powerful idea of convention
over configuration convention over
configuration if you follow a convention
that takes the place of what would
otherwise be a configuration burden so
typically when you write a java
application say that it's going to use
hibernate you've got to configure
hibernate to know about your domain
classes you have to tell it about all of
your entities right it's what hibernate
refers to them as so you don't want to
map every class in the JVM to the
database that's crazy that would
wouldn't work you don't want to do that
right you want to map a subset of your
classes to the database and you have to
tell hibernate about that and one way to
do that is to write hibernate XML files
and use their syntax and do all of that
another way to do that is to annotate
your classes with that entity and do
that thing but somehow you have to tell
hibernate about which of your classes
should be mapped to the database the
same is true inside of Grails but the
technique is different right though the
way you express that something is a
domain class in Grails is you declare it
under this domain directory right so at
the top of your project is a folder
called Grails - app / domain and if you
declare a class under that directory
it's a domain class that's it there's no
configuration file there's no
annotations there's no XML if you
declare a class under the domain
directory it's a domain class so that
class will have a save method added to
it that class will you know everything
that Grails stuffs the domain classes it
will do to every single class under the
domain directory so the way that you
express that a class is a domain class
is you declare it under the domain
directory and similar rules apply to all
the other artifact types right so our
status service is declared under this
Grails app services directory and the
class name ends in service so if you
declare a class under Grails app service
and the class name ends in service it's
a service and there's a whole bunch of
special stuff that it happens to
services right the question was is it
possible to override the save is that
what you said
it is possible so groovy makes it groovy
is a dynamic programming language and
there's that means a lot of things one
of the things you can do with dynamic
languages like groovy that you cannot do
with statically type languages like like
Java is you can add methods to classes
at runtime and you can change the
behavior of classes at runtime and it's
really a pretty simple thing to do it
turns out that you can replace the save
method if you want but there are good
reasons not to do that for a method like
save in particular if your application
is using plugins that are relying on a
certain behavior of that save method you
might be complicating things there so
the bottom line is if you wanted to
replace the save method you could but
you probably don't want to do that
whatever it is that you're going to do
in your version of the save method you
should probably call it something else
like save fast or save slow or whatever
you can add a new method that's not save
it's called something else and your
method does whatever you like and then
the official or the original safe method
is there and you're just not using it so
you can replace the save method but you
probably don't want to do that all right
so our service class here creates an
instance of the class populates its
properties saves the thing to the
database and all of that stuff that I
just described happens right date
created it's automatically initialized
with right now so when we look back at
my timeline we see that each of those
things has a timestamp associated with
them the first one was created it's 5:16
516 519 so forth alright let's let's add
a piece of functionality to our
application so I am going to have
Twitter we got here we want to yeah so
let me look at let's take a look at that
person class remember that a status has
a property of type person right the the
so every status has a message they
created
and an author the author is of type
person here is our person class and the
person class has a number of properties
in it has a real name like Jeff Brown
has a user name like J Brown has a
password that is whatever my password is
and then some boolean attributes that
control whether this account is enabled
or locked or aspired or whatever all of
that is this was generated for us by a
security plug-in that I installed into
the application before we started today
so I don't want to get too far down the
security path but this class represents
a user that can authenticate into the
system so when I fill out the login form
and I type in Jeff and put in my
password the system is looking in the
database for an instance of this class
that matches the username and password
that I entered all right so a person has
a real name and user name and password
and some other attributes line 12 is
what I want to talk about right now so
has many and the person class is a
domain class right the users are
persisted in the database so line 12
declares a property called has many and
the value assigned to that has many is a
map right so groovy has a literal syntax
for defining Maps and the way that works
is you can say so like map some map
equals name jsb town I live in st. Louis
zip is right so the way the the syntax
for maps work in groovy is inside of
square brackets you can have these comma
separated list of key value pairs so
that's a key value pair right the key is
name and the value is GaSb
the key is town and the value is STL
right so the the map that's declared on
line 12 has just one entry in it the key
is the word followed that could be
anything we just called it followed and
the value is a type it's a class right
so what we're expressing there really a
whole bunch of stuff happens because of
line 12 right has many means something
special to Gorm if you declare a has
many property in a domain class and
initialize it with a map like this a
bunch of special stuff is going to
happen one of the things that's going to
happen is Gorham will add a property to
this class
with this name right followed the key in
the map and that property will be a set
and it will be a set of those things
right the thing that's the value in the
map that's associated with followed so I
could add another thing here I could say
let's say we had a city domain class so
I could add another entry to this map
and now a person has a followed
collection and a person has a town's
collection and the town's collection
would basically be this alright so you
can put as many entries in that map as
you like so we're gonna go back to what
we started with which was just one entry
in the map so what that entry is about
is every person we want people to be
able to follow other people in Twitter
right so in the database we somehow need
to model all of that so we've already
got stuff in place to persist person
objects and we want to associate them
with each other somehow and that's what
this followed property is about so every
person has a set called followed and we
can populate that with other person
objects so when Jeff posts and messages
and grand posts and messages if Jeff is
following Graham I want to see Graham's
messages in the timeline right that
makes sense so we don't need to declare
line 14 that that happens line 14
happens because of line 12 so the has
many causes that property to be added to
this to this class all right in our
application there's a form for searching
for other users up here at the top right
and if i type in graham here and click
search for you' i stop the application
but what would happen if i started the
application back up when i fill out that
form i should see a list of all the
person objects that match the criteria
that i entered and to make that happen
i'm going to add just really just one
line of code to the person class and
that is this line so i've added line 13
line 13 says static searchable equals
and then there's some data there that
describes provide some details for what
i want to
be able to search for person objects so
I only want to be able to search for
real names so if I send a request into
the search engine that will talk a
little bit about in more detail just a
second but if I send a request into the
search engine that says find me all the
records that match Jeff what I'm
expressing on line 13 there is I only
want to search the real name property
that's this property right now so if
someone's password is Jeff I don't want
to match that and if their user name
happens to be Jeff we're not going to
match that we only want to search for we
only want to search across the real name
column in the database if you will so
let's get our application back up and
running and that's all the code in the
whole application there's no other code
related to searching that I had in place
before the only code that we're gonna
have to provide and related to searching
is line 13 and we get some really
sophisticated really powerful search
capabilities and we'll talk about where
that's coming from in just a second all
right so our applications back up and
running will do it here to our status
controller and I'll log in is Jeff
password Jeff won Jeff - all right so
I've got a couple of statuses a couple
of statuses posted there I've got Jeff
one blank when I click Submit twice and
then I've got Jeff - if I go up here in
the search box and type Graham and click
enter we get it's a lame user interface
right but I get a list of all the people
in the database that match that search
criteria there's only one write up so if
there were a whole bunch of graham's
we'd see a list that included included
all of them this is a list of all the
records in the database that match that
search criteria and whatever complexity
is involved in executing that search
there's complicated indexing and all
kinds of crazy performance stuff going
on I didn't have to write any of that
all I had to do is express that the real
name property of person objects are
searchable right and the way I did that
with was with line 13 in my Grails
application under the the conn folder
there'll be a file called
to config and this is where you
configure some of the things about about
your build one of the things that I've
expressed in my build config is that
this project has a compile time
dependency on version 0.6 that three of
a plug-in called searchable right we see
there a number of other plugins that
we're using there as well the searchable
plugin is the plugin that's providing
all the the search capability right the
searchable plug-in will look through all
of your domain classes and try to find
this searchable property and if the
searchable property is there the
searchable plug-in will take that domain
class and configure it in with all the
complicated search capability provided
by the searchable plugin so there's
nothing in the core of Grails that does
search for you there's nothing in our
application code here in the Twitter
application code that does searching so
what we did was installed the searchable
plugin and express some metadata about
what I want to be indexed by the search
engine and now I get search capabilities
in my application yes so I think the
question was is so when I execute a
search am i searching for all real name
properties so right now the person class
has a real name property what if there
was a real name property in some other
class would we be searching those
columns as well as that's question yeah
so let's take a look at that so when you
execute a search how do how do we know
what we're how would you know what what
is actually going to be searched if we
look at the controller action well let's
take a look at the view that generates
this page that'll help us that'll help
us get there so let's go look at Grails
app slash views and then it's seeing
that here we go
grills app slash views slash status
index
all right back to the browser for just a
minute I want to go back and look at
this page so the page that initiates the
search is this is the page that
initiates the search there are two forms
on this page this form up top that
allows you to execute searches and
there's another form down here that
allows you to update your statuses all
right so we want to look at that top
form and this is that form so this form
if you look at line 10 there it says G :
form controller equals searchable name
equals user search form this is what
when this form is submitted the form is
going to submit to a controller called
searchable and we don't have a
searchable controller in our application
the only controller in our application
is the status controller but the
searchable plugin provides a searchable
controller so when we fill out this form
and clips click search we're executing
code provided by the plug-in what we
didn't we don't have a searchable
controller but there's a searchable
controller provided by the plug-in and
that controller allows you to specify
information like what are your query
parameters and the way to specify your
query parameters is to send in a request
parameter called Q and turns out that
our text field has a parameter called Q
right so we're doing just the simplest
thing here but it turns out that the
plug-in provides capability to allow you
to specify things like which classes do
you want to search across you get to
Express declaratively in your domain
classes which properties in those
classes get searched the way this is
written right now where we're not
specifying anything other than the
search criteria so when we execute a
search everything that's indexed is
going to be searched it turns out that
the only thing that's indexed in our
application is the real name property of
person objects but if we wanted to get
do more sophisticated searching stuff we
could do that it just turns out that our
application is using is doing only the
most simple thing yeah yes so if in our
status class if we had a property that
was searchable which we don't but if we
did have so if message was searchable
here that the way that our search form
is written right now we'd be searching
for persons that have a real name that
matched Jeff as well as statuses that
have a message that
that's Jeff the way that it's written
right now that's what would happen
everything that's indexed is being
searched it just turns out the only
thing we've indexed for this simple
example is the real name property and
person objects alright so back to our
application when I click search for
users we get a list of all the people
that matched our search criteria and I
want to click follow here to express
that Jeff wants to follow Graham
all right so Jeff has posted two things
Jeff's gonna post a third thing and Jeff
is following Graham right now rather
than logout I'm going to start up a
different browser so I can have Jeff and
Graham logged in concurrently so this is
Jeff back here and over here I'm gonna
log in as Graham so in Firefox
we are Graham alright so Graham doesn't
have any status messages posted all
right I'm gonna post Graham 1 and Graham
2 right
the only things that show up down here
are Graham's messages not Jeff's
messages only Graham's messages and if I
go back here to Jeff's messages and
refresh this page we still don't see any
Graham messages even though I expressed
that I wanted to that I wanted to follow
Graham all right so let's look at the
code look and see what it would take to
make that work what I want to happen is
if Jeff is following Graham then when
Jeff's timeline will include Jeff's
messages as well as Graham's messages so
let's let's take a look at that so we
talked about the followed property on
line 12 line 12 is expressing that every
person has a set of other person objects
that they're following and if we go back
to our status controller and look right
here
this method right here the follow method
is what got invoked when I searched for
Graham and then click the follow link
this this happened and what that's doing
is populating that set I'm not going to
go I don't want to get distracted with
that code right now but what's happening
when we invoke that follow method on
line 28 is the gram grams person object
is being added to the followed list for
Jeff right so the two are Jeff now has
another person object in
that set called followed if we go look
at the status service we'll see that
there that's I want the time line
service not the status service the time
line service is what's actually sending
the query to the database to retrieve
all the stuff that's going to be
displayed at the bottom of that of the
main page in the application so get time
line for user is it's what's responsible
for retrieving all the messages that are
displayed at the bottom of that page so
what line 17 is doing there is
retrieving a person object from the
database so user name is going to be
whoever the currently authenticated user
is so if I'm logged in as Jeff username
is going to be Jay Brown right that's
going to retrieve the Jeff Brown object
the Jay Brown object from the database
and then I want to send another query to
the database to retrieve all the
messages that I want to display on
Jeff's page status is our domain class
remember that status is the thing that
has an author and date created and a
message we're invoking a method on the
static on the Status class we're looking
a static method on the Status class
called where any and there is no where
any method in our class but somehow
that'll work and that somehow is Gorm
we'll add a method called where any to
all of your domain classes and what you
get to do with that method is you can
invoke the method and pass a closure as
an argument the closure is just a block
of code here so that closure is being
passed as an argument to where any and
inside the closure you can have almost
arbitrary groovy code and the compiler
the Grails compiler is going to evaluate
all this code and turn that into
database stuff right so you don't see
anything there that looks like a sequel
statement or anything that looks like
that it has anything to do with the
database but Grails is going to turn
that into database stuff what this says
so every status has an author and every
author has a user name so what this says
is find all the status objects in the
database that have an author whose user
name is equal to this right so PTR is
going to be mean
it's the currently authenticated user so
PTR dot user name is J Brown what line
19 is saying is this query should return
all of the status messages posted by me
right but that that's just groovy code
there there's no database code there's
no sequel code there's no hql code we're
just writing groovy code to express our
criteria for our query what line 20 says
is if this person if they're currently
authenticated user is following someone
else then include in their in the search
results any status object whose author
is in this list PE are not followed it's
a set it's not a list so what this query
should return is all of my messages and
all the messages posted by folks that
folks that I follow all right that makes
sense I want to order these results by
date created descending so I want the
most recent yeah most recent at the top
and then they get older as you go down
and as time goes on my Twitter timeline
might have thousands or millions of
status messages I don't want to retrieve
a million status messages from the
database so when I execute actually
execute the query on line 22 there what
the list method will do is it will
return all the objects that match this
criteria but I don't really want all of
them I want all of them with a max of 10
I don't want any more than 10 results to
be returned from this query and that's
what that's what mine 22 is expressing
here I'm saying execute this query send
the the SQL to the database and return
no more than 10 objects so what this is
going to return is a bunch of status
objects and those are going to be all of
the status objects posted by me or by
any of the people that I followed
they'll be sorted by date created in
descending order and we're only going to
get the most recent 10 right and that's
what's showing up at the bottom of the
the main page in our application so
let's start up start the application
back up Grylls Twitter
right any questions or comments about
that query there yep very good being
able to express your query in code
instead of strings turns out to be a
powerful and flexible thing that you'll
take advantage of I had two versions of
the application running there and I need
to kill them and by the way I started
doing all of this inside of the IDE the
IDE that I'm using is the groovy and
grails tool suite it's also called GG TS
that which is built on top of eclipse
so it's eclipse with a whole bunch of
special spring and groovy tooling
installed into it
G TTS is free if you're going to do
Grails development G GTS is a fantastic
environment to do that yeah so the
server is doing the query right you
can't execute the query in the browser
the data is not in the browser yes so
the question is is that closure
executing for is the query being sent to
the database we get back all the objects
and then filter them by executing this
closure is that what you're asking and
that's not what happened if that is what
happened that would be almost unusable
that'd be bad a whole bunch of really
sophisticated cool stuff is happening at
compile time to turn that into the
necessary code to send a query to the
database and that query includes a where
clause that expresses all the stuff
that's described in your code there so
it would be really bad if what that did
was retrieved every status object from
the database and then filtered them that
would be no reason to have such a
feature but that's not what's happening
does that make sense yep
all right Jeff Wong I'm going to post a
post a couple of messages here Jeff one
and Jeff two right so there's my
timeline Jeff one and Jeff two will go
over here and log back in as as Graham
in different browser so we'll have a
different session and so forth Graham
and we'll say grab one and Graham two
all right so now Jeff and Graham each
have a couple of messages posted on
their timelines they're not seeing each
other's messages
let's over here as Jeff I'm gonna search
for Graham and I'm gonna express that I
want to follow him and now we're seeing
Graham's messages on my timeline which
is what we wanted
we'll say Jeff 3 and Jeff 4 and I'll
introduce a problem now so right now
things look ok I'm seeing all my
messages and I'm seeing all the messages
of the people that I follow right
Graham's the only person that I follow
right now we go over here and Graham
posts another message Graham 3 I come
back here and refresh this page we don't
say I just refreshed that page we don't
see Graham 3 so let's figure out what's
going on there and that's going to allow
us to add one more feature to our
application which is what we've got time
for is just one more thing so the
problem what's happening is this get
time line for user method is being
cached right we're using a cacheable
plugin the cash flow plugin is really
cool stuff we could spend a long time
talking about that and we just don't
have time to get into it just know that
by putting this annotation on this
method I'm taking advantage of some
really sophisticated caching stuff
offered by the cash flow plugin so now
every time I retrieve my timeline we're
not necessarily going to the database we
might be retrieving that stuff from a
cache which is good all right so get
timeline for user is cached so I
retrieve all my messages and they're put
in the cache and they're rendered on the
page when I update a message when I post
a new message one of the things that
happens is if we look at our timeline
service where is all it's the status
service we want one of the things that
happens each time I update a status this
is the code that creates the new status
is line 29 is invoking a method called
clear timeline cache for user and what
clear timeline cache for user is doing
is emptying my timeline cache right so
I've got a bunch of statuses in the
database I retrieve them they go in the
cache they get rendered on the page the
next time I retrieve them they're
already in the cache so we don't have to
go
to the database but if I post a new
message to the system I need to clear
that cache right I don't want to get the
cache doesn't have the new message
so the code we just looked at makes that
happen we need something else that will
do the same thing when one of the people
that I follow posts a message right the
reason we're not seeing Graham's message
on in the browser right now is my cache
is out of date I can refresh this all
day and Graham's message will never show
up notice we do not see Graham 3 here
but as soon as I post another message of
my own Graham 3 showed up right because
when I posted my own message my clash
was cleared so the next time I retrieved
the timeline we got not only my new
message but we got the message that
Graham had posted so the problem is that
when when I post a message my cache is
being cleared properly but when someone
else post a message that I follow my
cache is now stale that's no good we
can't so we need to clear the cache when
one of the people that I follow posts a
post a message but now we're starting to
wander into stuff that could potentially
take a long time right if i if I'm if
I'm following a thousand people when
when one of those people post a request
all of everyone that they follow needs
to have their caches cleared that could
take a long time so now you don't want
to do that in line as part of that
request processing right when Graham
post a message we want to get a response
to him as quickly as possible what we
don't want to happen is for Graham to
post a new message and then we're gonna
spend one and a half seconds clearing
out everybody's cache who follows Graham
right that's not good we need to clear
all their caches but we don't want to do
that in line there we want to get a
response back to him right away so we
can do that
a synchronously right we can do the
status clear of the the cache clearing
sort of out-of-band right so Graham post
a message we put his message in the
database we send an asynchronous message
to go clear all those caches of people
who follow Graham but then immediately
get him a response and then somehow
process those clear the cache requests
later and the code to make that happen
can be as little as something like this
so in my status class I've just
a couple of things I've declared a
property called JMS service we've got a
plug-in installed into my application
that is the JMS plug-in and the JMS
plug-in provides a service called JMS
service and the JMS service does a bunch
of stuff and we're gonna look at just
one thing that that service might be
able to do for us so that thing that
reference that's declared on line 10
will automatically be initialized by
Grails for the same reason the other
service we talked about earlier was
initialized so this is going to be an
instance of some class provided by the
JMS plug-in and what line 12 here says
is post a message AMS message to this
queue right Grails Twitter dot status
and this is the value of the message so
we're putting a message on a JMS queue
and the value of the message is simply
my username it's whoever just posted
this message right and if we go look at
our status service we'll see that the
status service expresses that it wants
to expose itself using JMS and that's
what line 10 does it turns out that we
don't have to know very much at all
about JMS to put all this together we're
not there was really no JMS code here
but we're taking advantage of a lot of
sophisticated powerful stuff that JMS
has to offer
but the JMS plug-in is taking care of
all the complicated stuff what I have to
do as an application developer is write
a service and express that I want to
expose it using JMS which is what I'm
doing on line 10 there and there's a way
that you can configure the plug-in so
you can call this method whatever you
like but by default then the method has
to be called on message and that's the
way that the plug-in will notify this
JMS listener of new messages so every
time a message is posted to the status
queue this thing this listener is
automatically going to be notified we're
not the we've are we've seen all the JMS
code we have to write to make that
happen but we're taking advantage of
really powerful JMS engine so what this
code is doing ever every time this
method gets invoked what we're doing is
we're sending a query to the database to
retrieve all the people that follow
username write new message username is
the name of whoever posted just posted a
message we want to go find everyone who
follows that person
and then clear all of their timelines
which is what's happening on the next
couple of wines there but this is
happening out of being right this is not
part of any request right a request came
in with a new message we created a new
status object put it in the database put
a request on a JMS queue to do some work
and then carry it out and finish the
request and then at some point the JMS
queue processing will happen
this code gets executed and now that the
servers out there clearing all these
these timelines that need to be all
these caches that need to be cleared but
if this takes a second we're not tying
up that request for a second and we're
taking advantage of asynchronous
messaging offered by JMS but we don't
have to write really any JMS code we
wrote a service and expressed on line 10
that I want this service to be exposed
by a JMS and then over here from this is
the end that produces the message I'm
taking advantage of this JMS service
provided by the JMS plugin and you have
to read the documentation and know how
to interact with that thing but what
we're doing is we're calling send and
passing two pieces of data the first is
the queue name the second is the message
so we really didn't write any JMS code
but as i've said several times we're
taking advantage of for what JMS has to
offer there right so we've seen
obviously I've had to go through all
this really really quickly but we're
taking advantage of some pretty
sophisticated stuff Jam we're taking
advantage of Jam mass we're taking
advantage of some really sophisticated
stuff provided by the searchable plugin
we've got the whole hibernate
abstraction there's a lot of really
really cool stuff going on in our
application a lot of powerful and
sometimes complicated stuff going on in
our application but all that complexity
is being managed for us by the framework
or plugins in different situations right
so the Grails application code stays
stays very very simple right so as I
said obviously I know that I went
through all that really really quickly
the idea is just provide a sense for the
kinds of things that the framework helps
make simple in your application so any
questions or comments about any of them
we've got about two minutes and then I'm
happy to talk to you as long as you like
but any questions right now
none all right very good thank you all
very much if there's anything at all
that I can help you with let me know as
I said my email address is Jay brown at
NGO pivotal com Twitter is Jeff Scott
Brown and thank you very much and enjoy
the rest of the show</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>