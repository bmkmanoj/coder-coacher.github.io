<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Tutorial: Android Internals -  Building a Custom ROM, Pt. 1 of 2 | Coder Coacher - Coaching Coders</title><meta content="Tutorial: Android Internals -  Building a Custom ROM, Pt. 1 of 2 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/InfoQ/">InfoQ</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Tutorial: Android Internals -  Building a Custom ROM, Pt. 1 of 2</b></h2><h5 class="post__date">2011-03-03</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/1_H4AlQaNa0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay so what we're going to talk about
next is basically building a custom ROM
right so we're now talking about the
entire platform right so so far before
this we were talking about calling
applications going to interact with the
low-level stuff now we're going to look
at the entire platform and so in context
of that so this is roughly what we're
going to talk about so what it takes to
build the source write your homework
that you guys did for homework I'm going
to explain that a little bit and what
we're going to go through the source
code and explain what is in the source
code so that you know what kind of files
are where if you wanted to modify
something so you have an idea what
you're modifying then we're going to
we're going to modify the source but
we're going to do it sort of in stages
we're going to do the simplest thing
first and then we're going to add more
features you know first we're going to
add an application yeah next we're going
to add and well we're not really going
to add the native library but we're
going to talk about that in a native
library all right next we're going to
talk about changing the startup process
right like what if you want it your
application to start up first or not
start at all or some other system
service not to start to replace the
system service that sort of stuff right
then we're going to talk a little bit
about permissions I think somebody was
asking about permissions as well so
we're going to talk a little bit about
that and finally we're going to talk
about modifying the framework one of the
frameworks right what would it take to
modify a framework
so which frameworks are you guys
supporting so it's telephony what else
location Wi-Fi GPS surface surface
Fingal finger sensors so you're
supporting for a bunch of them right
okay so we're going to talk about some
of them
maybe we'll pick one and we'll talk
about it in more detail we'll see a
couple examples
and what about the colonel for first
thing thing I wanted to kind of get out
of the way is that you know colonel
itself is is a separate project right so
colonel is not really part of Android
but what I mean by colonel I mean the
colonel colonel the core of it right so
that's not necessarily part of Android
Open Source Project that's a separate
project altogether right and we are
building on top of the kernel but kernel
for the most purposes you can just
consider it to be the standard Linux
kernel all right it's not it's not quite
standard there are some changes but for
the most our purposes we're just going
to consider it just a standard Linux
kernel and then build on top of that
right any questions about the kernel
again so let's talk about getting the
source so to get a source you basically
go to source Android comm right that's
what the source comes from let's see
that we have access to that site how we
do right so this is whether this is
where everything comes regarding the
platform so if you're developing
applications you go to developer and red
commie few developing platform you go to
source Android calm okay so you would
then typically go to source ok and then
you would typically go and click on get
getting the source okay we talked a
little bit about this yesterday right
No all right so like I said first of all
you would need to set up your machine
it's got to be either a Linux machine or
a Mac machine it cannot be win this
machine this is not possible in Windows
ok because the tools are not available
so what we have you some of you guys use
you are using my 64-bit machine some of
you are using my 32-bit machine there
are quite a few differences between the
two so basically up until for you where
we're using Java 5 ok so for the longest
time Android it require Java 5 which is
a very old job
it's about 6 years old something like
that ok from now on from Gingerbread
we're using Java 6 so that makes a big
difference right in preparing the
virtual machine and all that so in
Gingerbread also requires a 32-bit so
that's sort of the differences well ok
so I'm using I'm going to run it on OS
10 because that's just my platform
so I've configured all this ok next is
we installed Reaper right so we download
that tool we initialized Reaper right we
initialized it we did a repo sync sort
of repo net but before we did we then do
the three point it because this will
just get a latest code you may not want
to get the latest code because sometimes
it's you know in my experience I get
broken code if I got it could have been
undocumented setup but it was a broken
code nonetheless so if you want to check
out something from from a branch that's
different than a master branch then you
basically specify the branch by
specifying - beam so those of you on
tell it to boot you have Froyo for - B
branch right doesn't mean 64 you have
gingerbread okay next we did ripple sing
okay and got a source code oh by the way
how long did it take you to the other
APIs think it shouldn't I mean it's it's
it is a it does take a while if it's a
from scratch because you're downloading
about 2.6 gigabytes worth of files
there's a lot of files okay
but I already you know some already cut
since up the pre downloaded so should
not take that long because you already
had a bunch of source in the virtual
machine depending on virtual machine
yeah so next what you did is once we
download the source code we did the
following steps we moved into the
directory throw you're all gingerbread
we sourced built in this E&amp;amp;V set up we
did lunch and did we did make okay
so that's desert the steps the result of
that is that you got a you guys got a
directory I'll show in the virtual
machine so you guys get a good actor II
like this right so gingerbread or Froy
and it's got a bunch of stuff in here
okay can can um find that directory
right and if you don't you can just grab
the source code that they gave you right
so what we want to do next is we want
let me show you I'm going to show you
that in here because I have it on my Mac
like this it's the same kind of same
same stuff just so we'll easier for me
to just to explain it so what you're
going to do is look through the source
code a little bit so we're now we talked
about these steps right we're going to
now talk about what is which folder and
you kind of have it outlined here as
well in the in the notes so let's take a
look at this so basically Bionic does
anybody remember with Bionic is yeah
it's the see library right so that's a
see library that was developed for
Android so that's that's basically where
it's at so you can see that there's a
lip cielab DL ed math standard C++
headers and so on right so that's Bionic
probably not too interesting to us this
is the bootable disks so boot loader
disk loader disk installer and recovery
disk this is a build system so this is
where all the make stuff is make files
right so that distance to be sort of the
complex part of the system right so what
we have here is we have the build system
now a build system is going to go a pick
a specific target specific board and
specific product so in other words it's
a multi-dimensional sort of built right
when you say when you when you do a make
your your configure your building a
specific target for specific
architecture and
specific product right let me show you a
couple of documents that are useful in
uh in uh source.android.com there's this
tab here called coding this is what a
build system is somewhat explained okay
so these are the various layers that you
can put on top of D into the build
system so you can specify what kind of
product you're building in other words
what locale is it for is it for a
Chinese market Japanese market European
market American market right so that
would be the you know you can specify
that what kind of devices it is it the
device with with a keyboard or with
dollar keyboard right what kind of board
is it is it you know what's the what
kind of information you have on the
board and a board for some reason the
board information is nicknamed after
fish so that's why it's a sub dream
trout goldfish goldfish stands for
amulet so when you see goldfish that
usually means the emulator okay and
finally what kind of architecture we are
building for so that's the kind of stuff
we can configure in terms of layers
right so building the platform you
basically you did choose combo or lunch
right to make it or you can do like this
probably generic user probably generic
edge right so this this is basically
going to tell it what kind of product we
want to build right and in you know
there are different setups for user
versus edge it usually has to do with
the system settings like somebody was
asking about system properties so some
of those are differently configured if
you want a engineering build Versailles
user build things like ADB maybe is
disabled or enabled it depends it
depends on what kind of build you're
doing and clean cleans your directory
make clobber is going to clean up all
the
bombo's right speeding up the rebuild
you can basically say export use cash to
to perform to basically produce some of
the built stuff because the build you're
going to find can run quite slowly right
so so that's that's what happens with a
build kernel itself so that's the
building kernel you know what happens
with that kernel itself is shipped as a
pre-built module so we actually have it
as a compiled module okay if you want to
build your own you can you can get check
it out you can get a get it but I get
right so building the kernel these are
the differences some of the system
property differences for example between
versions right so-and-so is the default
flavor right and that same is doing make
inch right and it's going to install all
those modules and it's going to do the
following
so basically security is going to be
zero debug debuggable is going to be
true and kernel Android check J&amp;amp;I it's
going to be one and adb is going to be
enabled those are some settings right
user right so this is the final release
this is if you're shipping it on a
device so secure is going to be true
debuggable false ad be disabled this is
once you're ready to put it on a device
and ship it right user debug is the same
as user just lost debug as well right so
we probably you know this isn't it's
easy to change later on so that we
probably want to do engineering build
right because we want to cab all the
information right so that's that's
basically what what happens and so you
can configure a new product so this is
the configuring a new product page and
I'll show you that in a second as soon
as it loads up I guess our network is
slow or it doesn't you know it doesn't
help that I'm uploading all the movie
files up to a server so okay
so you can configure things that are
specific to a vendor right so so if you
want for example something specific to
welcome we can make a directory called
you know vendor and then welcome and
then within that we can specify our own
products and create our own make files
right so we can make vendor qualcomm
products and then create for example end
or release or user that sort of stuff
and then in that make file we can
provide we can overwrite the information
about the product the product and the
device right so for example if you have
a specific device you can change that
here right and then so you can specify
the targets you can configure the board
like so remember it's a multi-layer
build build system right so you can
configure the product but you can also
configure different boards right for
example are you using are you going to
have support for for audio drivers or
not right you may have a board that
doesn't have audio drivers right are you
going to have support for a four on
radio right or not so this is basically
how we're specifying the path for the
radio this is using the radio driver or
at least the library right so those are
overlays on top of that right
what kind of kernel if what kind of
kernel we're going to use for that
particular device right so it's going to
look like this right to welcome right
board it's going to be a specific board
then products you may have end-user
final and that sort of stuff right so
these are optional make false you guys
already have this somewhere with some
other team right there's another team
that does this for you okay but so so
you know you may may or may not care
what happens but that's what happens
these are the various settings for
products right product name is basically
this
name right that's going to appear in
about the phone right so that's the
product name right that's you know if I
go here home let me zoom out menu right
settings it's the last one to BA the
phone right then so model number version
baseband version kernel kernel version
builds build number right SDK and 2.3
test keys right so this tells you you
can see but this tells you what built it
was built on right so so that's that
product model that's the model name so
that's the model number is as decay
right lockhouse right so look house is
basically what we're supporting so for
example you may say okay this version of
the phone is supporting English in
burden German Spanish and French in
Canada okay so you can specify the
language in languages product packages
you can specify the list of calendar
calendars that can see a list of
applications that you're going to
include because not every build has to
include all the applications devices now
so this is the industrial design of the
device it done so dream is HTC it's one
of the HTC phones right and so on
manufacturer brand right our product
overwrites so these are your key value
pairs for a sis probes right public key
for over-the-air updates right policies
package overlays contributor files in
tags right so this this is what a
product may look like when it's
I'm done so far following yeah so so
right now we're talking about the build
we're still here right we're just
talking about the build or in other
words we are talking about here so see
built target board so when you said
lunch and you said let's see if I go so
let me control see okay so this is my ad
be here okay let me do it this I'm going
to go to my book to my volume
gingerbread right that's what my
gingerbread is installed you guys did
something like this you did source and
you did built env setup right this was
the part of the homework right BAM
that loads the various vendor setups
right so this is for example loading the
device for including files for Samsung
for HTC and so on okay now we did lunch
and lunch if you didn't do lunch one it
would ask you what do you want to build
okay so here's what we are saying I'm
saying I want to build generic
engineering for passion user debug full
crossbow use the debug so basically if I
say for passion that's going to include
so see this full passion that's going to
include this this vendor setup okay
right and if I pick this one it's going
to include this vendor setup right so so
that is that's basically what that does
right yeah so if I say check a generic
engineering so you can just press I
guess you can press one okay so now
we'll just happen is it configured my
platform right make sense so this
information that you've been seeing so
here's what happened it basically went
here and
said it's going to take judging a
generic which is right here right so the
board is going to be generic okay and
the release is going to be and engine
Eric engineering right so it's going to
be the generic and right so it's going
to clothe that is going to it's going to
include those packages right so that's
for the product and for the for this one
is going to include that boards so
that's it's going to use this board
config for example to to decide on on
the type of web board where we're going
to use and it's going to use this
generic here to decide what we're going
to include right okay so that's what
product name device brand right that's
what that information goes make sense so
so that's that's that's our setup and
this is that file that we this is that
file that we ran to to set up the the
environment open with text mate you see
I don't want to do this okay so this is
the file that we used to for lunch right
so this basically sets up a bunch of
variables right okay so so that's going
to do that on it also adds couple may
not make stuff make from the top of the
tree make modules in the current
subdirectory more just in the supplied
directories so these are some helper
functions that that we're going to make
make system things that we're also going
to be using later on just so you know
okay so so that's basically the
environment that we set up
okay so so any questions on this so far
the build system how it works how how it
includes various parts so that's about
it that's basically how this bit gets
built again so I'm going to close this
we're going to talk about we're going to
move Donda and down this list yeah and
then we're gonna make some we'll make
some changes to this later on just so
you know but just for now I'm gonna
leave it as is so that's built cts cts
is stands for stands for compatibility
test suite okay so what CTS basically is
is a way to test if your Android system
meets requirements to be an Android
system right so this is basically
androids
answer to the issue of fragmentation
right you might have heard how androids
good is getting fragmented you know what
are we going to do about that there are
these different Android versions and
which one is really an Android and so on
and so on so the answer to that was to
basically create a set of tests and
those tests live here under
compatibility right right and it
basically it's a way for you to test if
your device your new ROM is truly an
Android device right so for example you
know I worked with putting Android in
for example a car right like for a
dashboard right or into a photocopier or
into a set or box right so that those
are custom versions of Android but
they're not what you would expect right
like in a car you can't touch that stuff
right it's just to show you that it
doesn't have for example torch ended on
the dashboard right and you can't really
download applications while you're
driving that would be dangerous right
see a lot of people don't even know it's
centered right
so would that pass compatibility
probably not right because compatibility
also says which are the mini minimum
applications you must have and so on and
so on so that's what compatibility is
okay so it's a set of tests all right so
so that's what CTS is here next what we
have is Dalek so this is the Dalek
virtual machine is right here yeah well
the virtual machine is right here the
the compiler is right here and so on and
some this is the libraries for it
etc so that's that's dalvik the bucolic
code now so when you um you guys are not
poor reporting to a new architecture all
together any chance are you putting
Android to a new architecture like to
say MIPS architecture or something
nothing like that okay so if you were to
port right I mean on one hand you have
to recompile all the C code right that's
easy
well that's recompiling all the c-curve
and providing drivers and so on now
second part would be to get Barbic to
work so that you can run all the dalvik
code because half of the code is dalvik
its java basically compiled right so
that would mean pouring dalvik to that
new platform and that work sort of comes
in come in two flavors there's the
standard C and C C version which should
be easy to port it's not going to be
optimized but it's going to work right
and then there's the optimized version
for arm and I believe x86 but I'm not
sure yeah that's darling these are some
develop development reference files okay
nothing very interesting us device
devices this is where the device
specific things are right so so for
example remember how we included the HTC
passion there was a four
I believe this was this was what was
included when we did one trade so that's
what that file is right so this is the
file that was included for example for
for lunch right so that specifies that
this is for passion' devices full
passion for passion and red for passion
right so that's kind of how HTC does it
and then this is how it further included
some some make files okay so that's
passion Jin so that's for HTC Samsung
has its own this is a sample if you were
going to do your own right if you're
creating your own device these are these
are some common things so GPS for
example configuration for let's see
let's see how to open this up so other
textmate so this is a config information
for example for a-- for various gps data
right yeah so so that does is a common
properties right so and then we have
some specific ones
so that's devices now after device is
one of the very important ones is
external so external is simply
everything that comes from outside of
android project but it's brought into
android project right so these are
essentially these end up being your
library system libraries a lot of these
things end up in system lab directory
right you know I'm talking about system
lab directory remember so that's where
for example Apache web server right here
zip Chrome let's see what else is
familiar here JPEG diff j-unit support
openness
Oh pink PPP qmu this is for the emulator
rate sequel white filesystem z lib and
so on and some skeered for them for your
surface rate 2d graphics um is a surface
type so all that stuff is basically here
in the external external package right
so if you get a third-party library if
you get your own library you wanted to
put it somewhere this would be a good
place to put it
okay next we have frameworks so
frameworks is where all the other
frameworks
go that ended it provides so this would
be libraries this would be framers so
this is a very important place because
there's a lot of very good stuff in here
right so for example if you're looking
at media stuff well there's frameworks
base media so all the media related
things are here we're going to talk
about it later on right if you're
looking at graphics so there's your
graphic support if you're looking at
location which we're going to look at
next
there's a support for location and so on
and some okay so this is where a lot of
those things go the frameworks next we
have Carter and this is where a car is
Hart a specific Hardware specific things
go right so a lot of these things here
are meant to abstract the actual
physical cover so that's why we have let
card water skier right so that's the
basically the abstraction layer this may
sound familiar right here come GPS right
cue Commedia stage fright right and DMM
core and mm video in GPS so any of this
any of this familiar
right on so so that's basically the
hardware stuff lip core so this is some
core libraries NDK here's your ND cake
here's your NDK built that's where it
comes from right all right so these are
this is your entire NDK here there's
your tool chains right arm Lennox army
ABI and arm x86 right I mean on x86
that's that's your indicate then we have
SDK is right here okay so these are the
various SDK tools right so remember
remember we looked at trace view that's
what trace your code is right for
instance so so that's basically that
those are basically some of the
important packages packages subdirectory
is where all the things that deter
bundled with the application are right
so for example apps are here so the apps
that get included into the project are
here right so these are your
applications that go into your device so
you put them in packages apps right and
some wallpapers any content providers
any keyboards that sub goes into here
right pre-built these things that are
pre-built so for example Linux kernel
like I said is just a prebuilt module
that ships with Android right so that's
where that stuff goes alright so that's
that's where for example various kernel
components go and so on those are
pre-built modules
as the key system is where a lot of
system related things go well we're
going to talk about it later but system
core for example is where some of the
configuration about user IDs and such go
right in it RC goes here okay that
system now so this is the source code
you downloaded okay you guys got the
source code you who ran make you did
know we could make on it and it worked
up successfully
nobody had a successful make okay you
made before okay on not on the virtual
machine but somewhere else yeah on a
virtual machine on a different person
okay okay and why did it fail on this
one okay she suddenly was missing it
okay then okay that's fine so so
basically okay so that is the that's
basically how we're all this stuff goes
before it's built now when you when you
build it successful this is what happens
you get a directory called out okay and
out is then it has a subject good for
targets so for different targets it's
going to have different subjects product
generic is going to be for generic a
version of our target right so next let
me see let me show you like this so
basically what happens is once you do a
build we are going to create all these
sub directories so this directory here
system that is the same directory as on
the file system of a device
okay so that good accurate system is
this is if I go onto adb shell CD system
LS that is the same directory that is
that director it's on the device right
that's the system now on system I get
before it gets installed in the emulator
it gets you know created into an image
so this is the system image system the
time Chifa so that's the file that we
are going to be using for the emulator
so that is remember I said yesterday
that's the final output of us building a
platform it's system the timetable any
questions me so far okay so what we
talked about so far is we talked about
Bionic we talked about build dalvik
development devices external Famer card
we're out packaging pre-built
as the cane system yeah now let's do a
little let's do a little experiment so
what I want to do is create a little
application okay and have that
application installed into the device
right so what I would like to do is I
would like to be able to when I load up
a device I would like to have some kind
of application in here that is like it's
going to be one of these icons and it's
going to be an application that's built
into the device okay so on so let's do
on let's create a new one and we've been
talking about location today right so
here's what I'm thinking let's create
the little application that's simply
going to print out our current location
okay you know the example that we have
where am i we can do that application
okay
all right so you guys can do this as
well and then we're going to plug it
into the platform then we're going to
create a new platform rebuilt it and see
if it still if everything is there
okay so here's uh here's what we're
going to do I guess I need my Eclipse
after all this is going to be a very
simple up application so I'm going to
say Eclipse new Android project okay and
I'm going to call it location demo okay
location them is the name of my
application right so as decay 2.2 it's
actually I'm building it for three point
or 400 for Gingerbread so I'm going to
go with the gingerbread you you guys can
go with the with fryi
right application name is going to be
location demo package is going to be com
example location activity location
activity and minimum SDK I'll put nine
so this one really truly requires the
latest greatest Android right so first
good so we now have our hello world
right location damn right it's just like
hello world and just like hello world
there are a couple of files that were
important right there's the layout file
and then there's the D activity the Java
file right crystal just so you guys can
see in the monitor I'm going to turn
this a color too I'm going to reverse
the color you don't have to do this just
because I have
a poor a sorry not monitor but projector
you guys can't see it so I'm going to
add something here Android style theme
light okay so that is basically going to
help make my application look like this
so black on white as opposed to white on
black just for contrast so what I'm
going to do is I'm going to modify this
user interface just a little bit okay so
I'm going to do a do let's think about
this I'm going to leave yeah well we'll
just do the world's simplest we're going
to keep it super super simple right so
what we're going to do is just change
add an ID to this piece of text so that
we can find it just like we did for
Fibonacci right so I'm going to say
control space Android ID okay equals and
then give it some kind of ID so I'm
going to say add plus ID slash out
that's going to be our output okay and
the default text I'm going to remove
there's just no default text I'm going
to make it just a little bigger my text
so I'm going to say I'm just going to
say and roll it so let me see text size
oops
text size I'm going to just because it's
so you guys can see else put 30 SP
that's the unit okay that just to make
to make the tags big right so you can
see in the back okay this is the world's
simplest user interface we just have one
label one piece of text where we can
output something right so far so good
okay so now in in the Java file just
like before I'm going to define text
view text I'll call it out organize
imports um well we're going to have
we're going to work with location so I'm
also going to define my location manager
location manager and I'm going to define
location location and then also organize
import so I'm just defining a couple of
variables I I do control shift oh that's
why you guys don't see it but you know
this all got the imported in here right
the XML yeah okay so basically the only
thing that is important is this that's
it nothing else is important this file
so add plus ID slash out
I'm just want to make a tiny little note
here so remember don't do this but if I
if I had some default text like Android
I'm going to remove this this is just
for to show you so if I get some default
text and I said wait waiting for
location for example and if you look at
it here everything looks good right yeah
and as a matter of fact if I run this
it's going to run okay
however if you is when you try to
install an application into Android
source like this it's not going to work
because it's much more strict about
things like this
so what's the problem with this it's not
internationalized right I would have to
put this into my strings.xml then refer
back to it right so I'm not going to do
that but but you know that's I just kind
of wanted to point that out right so I
always have to do it properly
where is that I'm going to remove that
just so it doesn't comply okay so uh
southern got this so far so this part
yeah okay so now we're going to we're
going to initialize couple things so
basically our out is going to be just
like before a textview and then control
space you say find view by ID r dot ID
should be there dot and then out okay so
that whoops that finds our text are all
output so you can print stuff out right
so far so good on that okay so now that
we have the D out figured out we can we
also want to figure out our location
manager okay
so location manager is do you remember
that line that I said it's the only
important line that we have so remember
when you're looking at where my example
page like 181 I think so
so location manager is going to be a
location manager right and then again
similar thing to a space
I mean control space and then say get
system service okay and then on this
list find the system service that is
called location service uh-huh there it
is so you don't have to do a lot of
typing okay so now we could actually use
the location but I'm not going to do it
from oncreate I'm rather going to put it
into onstart because I want to be able
to restart my application to see if
there's a change so as opposed to
putting it all in oncreate like we did
before this time is going to go at
override and then I'm going to say
public void on start and then super dot
on start whenever you override these you
get a call the super so you kind of have
to do it okay now I can do something
useful you can also use source
override implement methods right like we
did before remember
okay
so what we're going to do here is I'm
going to basically say I'm going to find
the location so location is going to be
location manager dot get last-known
location
so what we need to give it is we need to
give it a provider we need to tell it
which provider we're going to use right
so what we could do is we could define
provider is a constant so that I don't
have to type it all here so I'll say
provider here but then I'm going to
define it as a constant I'll say static
final string provider and it's going to
be location manager dot GPS provider for
instance all right so that's how it
saves me some typing here right so we're
going to work with GPS so far so good
okay so now now that we have the
location so we will check you know if we
have a location so if location is not
now right then we will do something with
that location so we could do now out dot
append just like we did before and we
can print something out so I can say
string dot format right and I can say
backslash n percent is it f right for
float right percent F so I can see a lot
latitude neck solution long percent tuff
something like that and then for
arguments I'll say location dot get
latitude comma location dot get
longitude right
let's see so what am I missing some
column format yeah so that's for example
my you know location you can add more
stuff right we can add bearing and and
and all that other stuff but let's let's
try something simple right now people if
location is now I will simply say else
out dot append location not yet
available or known something like that
right
you
so far so good on this okay so this is
now our um this is now our application
you know and everything compiles so and
presumably it works so you haven't even
tried it
there's one thing that we are missing
and that we need for a location and
that's we need a permission for location
so open up your manifest coil right and
let's click on permissions and let's add
two permissions so to two uses
permissions one is going to be access
location fine access fine location okay
and the other one is going to be access
course location so we technically just
need fine because that's for GPS okay
but this is for network right so again I
mean I mean a manifest file so our
manifest file open manifest file click
on permissions tab okay click on add and
choose users permission not permission
okay but users permission and add these
two permission access fine and access
course I am adding course just in case
later on we want to play with a
different provider you know just to see
how it works but technically we don't
need it
this is just some printout you can you
can come up with any any printout but
location you know we get the location
and if we actually got a valid location
so it's not now we print out a latitude
and longitude of that location that's it
and though
it's a double it doesn't really matter
you can add as many of these as you want
right so I'm just kind of adding a
couple of properties right and so so is
that I'm giving this make sense what
we're doing yeah okay so we now had it
not normally you would run this on the
emulator and BAM installed right that's
what we normally do but we're not going
to do that because doing that would mean
that we are we're basically installing
it as a user that would mean that it
would go into slash user slash app okay
that's not our goal now our goal now is
to install this permanently into a
custom image okay got it so we want to
create a new Android image operating
system image right so here's what you're
going to do so we we have that we need
to put that pack that source code into
packages apps folder okay because
remember that's where custom
applications go so it's in - in packages
apps folder this is where all the system
applications go okay now as opposed to
copy pasting it I'm going to create a
symbolic link so I'm simply going to do
this I'm going to go I'm going to CD
into packages apps and say Ln my
workspace right call them and I'm going
to find a location demo okay and I'm
going to link it in here make sense
that's that's that's part one
so now if I do LS you know the old
assistant look there's there's audio
Bluetooth browser calculator location
BAM right so we added a new new
application into our gingerbread or you
know fryer right distribution got it
okay second next we need to create a
make file for it so the make system is
quite different in then D in Eclipse
before in Eclipse you guys just click on
save and bam everything's compiled and
made and all that stuff right
well now it's different it doesn't work
that way okay so you we gotta create a
make file so we need a file called
Android m'kay so you can do it in
eclipse so you can right click on on
your project right or you can do it in
VI or whatever you guys prefer
I'm going to do it here I'm going to
right click on my project and say new
file but do it in the root of your
project right I'm going to say the file
name is Android m'kay job is going to be
like that Android dot m'kay BAM there it
is right well it's an empty file so
where do we how do we figure out the
files how did this file right so on
remember I was showing you where to get
this documentation I said pouring this
is where the make system is explained
let me go back like this
come on okay so this is where the build
system is explained and all that they
also include something called the cook
book right so you can just find your
recipe and there is my recipe building a
simple apk that's what you're doing
we're building a very simple apk so I'm
going to copy paste this BAM so again I
went into so source Android comm pouring
the build cookbook that's one way second
way is to just to take it from another
similar application right so you I could
have copied it from alarm clock or
something right
but I'm going to copy it from here yeah
so cannot taste comments like okay so
I'm going to fix this make this my make
file right remove the spaces and I'm
going to change just one thing package
name so package name now is what
location demo that's right so that's our
location demo that's going to call all
the subdirectories build all that stuff
and off we go now eclipse can pass it as
well but when we're simply using as a
matter of fact what I'm going to do is
this I'm going to turn off build
automatically because we're not using
Eclipse build system right now okay
because I don't want it to compile
because now we're compiling it you know
I may want to kampala just to check that
there's actually working you know
because it's faster just to compile this
one little project here in Eclipse but
ultimately we're compiling it into the
platform so we got to create to make
false system so this is this is the make
file did you guys get this one and run
copied it online now
so you caught a pasty to change one word
after word because it was Lok all
something now it's location okay so we
did that
oh we now need to add this to a to a
make file to tell it to included so we
need to basically add add change the
product package product packages
variable remember product packages is
where you specify what gets included so
remember make system we set build target
product and then somewhere in there so
in your build target product okay see
how they're all these different versions
well if you want to include it in all
I'm just going to go with core okay so
I'm going to open up core okay and I'm
just going to add it in here this is my
cord this is including everything right
product name product device and so on
and some some of you are asking what you
can figure out that system properties so
here's some alarm alert you know
notification sound and song okay so I'm
going to include it here in this list of
applications same place where like you
know phone is and all this stuff so I'm
going to say location demo and I add it
to the make file okay now I'll let you
guys work on do that in the meantime
what I'm going to do isn't going to go
back to my home the gingerbread
directory okay
and simply going to say make and hope
for the best right so now that's running
a make and that's that's that's what
we're building right that's our setting
so again I just added to my core
which is in your built target product
and then for for example you could add
it to like generic or or some other
subjects all right but it just depends
on what what you want to accomplish I'm
including it now in all my products on
my builds so this is now building ok and
this should be fairly quick now it's no
because it's just repackaging everything
it's going to recompile it and repackage
it it's probably going to fail actually
first time around I think it's going to
fail now and then we're going to see why
right also if we don't change code up
make it's not going to not in this case
not for applications so it's actually
necessary you do have to change to added
two to one or two you need to add it to
this to this yes but just putting it
into packages just doing this is not
going to include it yes for other
folders to twelve later on when we're
going to change framework and that will
actually search all the make falls but
this is not going to good ok so yes it's
not going to do it in this case by the
way they didn't do a make so let me let
me do this I'm going to actually go
packages apps okay and I'm going to go
many a location demo I'm going to do a
make here or I'm going to do mmm instead
right to make sup from here that's what
runs the local make right so so did
packages apps on now this failed right
why
why did it fail anybody so the make
system is different like I said right so
what happens with the normal on in
Eclipse in Eclipse we are remember our
generated files these are the files that
are automatically generated so our file
is actually here but this is a different
make system then this makes system that
does this so actually to get rid of all
this stuff because otherwise it's going
to say whoa it dis make is going to
create our somewhere else and now we
have two R's so that's why it's
complaining so what I need to do I need
to either not use eclipse at all or I
can use Eclipse but make sure that you
do source that you do a project turn off
build automatically and then clean I'm
going to clean this project right so I'm
going to get rid of this is it get rid
of it project clean huh keeps
regenerating it okay so I'm going to do
it in from command line so this is my
project right now I'm going to RM okay
- RF I'm going to get rid of ghent and
bin because I don't need them anymore
right
damn gone so now if you do mmm okay
let's see okay so now it did it did it
did install it so now it built it built
a new apk and it put it in the output
directory out target product generic
system a block right so now if I go CD a
couple directories back right and to
make let's see if that's I may have to
drill into the intermediary faults
because I'm not sure if it's going to
know that that one change but we'll find
out
so let me see in the art directory so
out
so current day is February 24 my last
system image was February 21 so it's old
okay so we need to see if this actually
changes okay nothing to do so it didn't
change it okay so what I'm going to do
is I'm going to I'm going to force it
this one can actually remove some of the
stuff so I'm going to delete this file
in this file to force it to to remove so
I'm going to just delete them and now
I'm going to top make so that's now
going to make that because basically
just needs to repackage it so you can
just get rid of your system image okay
and that should do it
okay so here it is so it's basically
repackaging so it's creating a new
intermediary's immediate files and
that's our new system to time G file
okay that's pretty quick right rebuild
and if I verify here there's my new
system IMG and it's built today right in
the time is 10:41 p.m. 10:41 p.m. so
it's a match match right so far so good
okay so how do we how do we run this
how do we flash this onto the hard drive
of the phone huh yeah except we are
going to do it on the emulator right so
at the end I'm going to kill my emulator
I'm going to now run it from a
command-line right and say emulator -
abd I showed you this before right we do
this before right I'm also going to
scale it down to the top so that we can
fit in my screen right so this is just
so that it fits my screen so don't worry
about that
but here's the key I'm now going to all
because remember this is now going to go
to that directory dot Android / AVD / my
phone and it's going to look at where to
find the system image and it's going to
go and typically let me start it it's
going to look at the system image of the
platform but here's what we're going to
do we're going to say - system okay
we're going to override that and I'll
say out target product generic system
system dot IMG okay and one more that I
need to do which I didn't know before
that they had to put the RAM disk as
well we need to overwrite so I'll target
product generic Ram disk oMG okay and
I'm going to start this so I'm basically
to a different R and disc and a
different and different system image
okay because before it would go to a VD
and it would look at DVD and it would
say you know you know open up such a
such file right let me before it would
do this it would it would go to dot
android adb my phone dot ABD config
right and it would say oh okay the
system directory is in platforms Android
nine images right which is basically it
will do LS let me show you to look at
file my my SDK so Android my Android SDK
Mac and it would go into platform
subdirectory right so that's what it
would do before so it would go and point
to this image this is the one that ships
with a standard Android that we download
online but we're now overriding that
we're saying nanana go and use our
custom build system okay so that's
building hopefully it's going to do it I
don't know I'll find out
all right so it's coming up okay so
there's my there's my phone yeah so I'm
going to unlock it
and let's take a look what's inside okay
so I'm going to go to applications BAM
okay and do we see location demo there
it is right so there's a location demo
yeah and if I open it location alone it
doesn't know the location right good
obviously don't get GPS and so on oh
that's fine that's by design so but what
I wanted to show you is that now if I
look at let me um I'm going to open the
DMS if CD DMS doesn't know about it
alright so if you guys depend on eclipse
you can stock right so what's the
solution to that adb kill server adb
start server so hopefully that fixes it
but he puts the connection tells Eclipse
hey there it is BAM okay filesystem come
on give me the filesystem be there so no
I remember we talked about the
filesystem and we said typically the
user applications once you install are
installed here so there's our Qualcomm
hello there's our Fibonacci there's our
logging client logging service right
but location is not in here right so in
other words it's it's going to be we
wanted to install it as a system service
these are the system services and
they're at this location them it's
installed as a system service okay you
cannot uninstall it it's on the
read-only file system make sense
okay so so so just to kind of like recap
so what we did is we created an
application and we put it in locations
packages apps directory we actually
linked it right
we created a mix all for it we added it
to a build you must you actually do this
you have to add it to one off you don't
have to do it in four and you probably
don't want to do it in core but you got
to do it to one of the this property
basically needs to list it okay and you
actually have to do mmm in in this
directory so you mM it and then you make
it to repackage the systems OMG so okay
so that's that so far so good on that
what's the difference between system
applications and user-defined
applications well technically nothing
but all applications are created equal
right that's the whole point of Android
right you all system application is not
any superior then then a user
application right so remember garlic
while you don't remember in iPhone for
example certain applications like Safari
browser or iCal or mail they are
superior you cannot replace them right
in Android you can replace every
application right so so that's the whole
point right but I don't mean sometimes
replace doesn't really mean replace it
because we now put this in a on our
application is now stored on a read-only
file system so you cannot really get rid
of it so there's technically not a lot
of difference other than it's gonna read
only file system so if you want to
include certain applications that may
you may have an application that you
want to start at boot and always have it
run like a service maybe a tracking
service or something security service
whatever it is right so if you if you
put it in a user directory in a user
file system user can actually get rid of
this if you put it in this file system
user cannot
get rid of it so that would be one
difference yeah any other questions on
this
okay so let's take a short break and
then what we're going to do afterwards
is we're going to modify the framework
now we have an application let's see how
this application talks to the other
parts of the system okay that's the plan</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>