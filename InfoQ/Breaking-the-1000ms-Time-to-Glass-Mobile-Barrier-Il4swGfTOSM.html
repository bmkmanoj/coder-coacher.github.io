<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Breaking the 1000ms Time to Glass Mobile Barrier | Coder Coacher - Coaching Coders</title><meta content="Breaking the 1000ms Time to Glass Mobile Barrier - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/InfoQ/">InfoQ</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Breaking the 1000ms Time to Glass Mobile Barrier</b></h2><h5 class="post__date">2013-03-26</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Il4swGfTOSM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">here build mobile apps or mobile
websites yeah I hear this mobile thing
is kind of a big thing so what I want to
talk about today is building faster
mobile websites and faster it's kind of
a biggest term right we could share a
lot of tips we could talk about a lot of
techniques so what I thought we would do
here is actually take kind of put some
constraints on the problem the first
constraint is and maybe even as a
thought experiment what would it take to
build a mobile website to render in one
second that renders in one second
all right that's first and second we
want we want it to be actually visible
within one second so by setting that
constraint we can actually work
backwards organs instead of just
enumerate all the techniques for how we
can make our sites fast we can actually
start looking from the ground up like
what how long does the network take how
long does a browser take and what what
does that give you and what kind of
leeway do you have so we're gonna look
at network performance we're gonna look
at how the browser renders the page and
then we're gonna try and piece it all
back together so let's get right in
first of all before we even get into the
technical part of it part of this
presentation I always like to talk about
why we care about this in the first
place right like why do we want to make
stuff fast it certainly feels nice when
something is fast and when it's
responsive but we actually have very
good data to show that it also
translates into revenue and engagement
with your applications and all the rest
so I'll share a couple of examples with
you this is an experiment that we did at
Google actually a few years ago and the
experiment was basically what happens if
we actually make search slower we
intentionally made the search slower for
for a group of users and we picked and
we put them into different buckets we
said well we're gonna slow you down by
50 milliseconds this room by 200
milliseconds and we're gonna observe the
changes in your behavior right and
further we will also delay it in kind of
different ways for some users we will
delay the rendering of the search
results for some of the users will delay
rendering of the header and basically
we're just trying to figure out like how
do we totally the users change their
behavior and what we found was that the
impact on the daily
is actually one down and the moment we
slow down the pages so once we added 200
to 400 milliseconds which is not a lot
of time when you think about it the
number of daily searches went down by
anywhere from 0.5 to 0.3% now that may
not seem like such a big deal but trust
me when you work at Google scale when
your search volume goes down by 0.3%
there's a lot of alarm bells going off
in the building so but that's not not
only Google actually Bing did the same
study in parallel and what they found
was they actually were more aggressive
they actually delayed some of their
pages by two seconds and what they found
was that when they did this the revenue
per user dropped by four percent four
point three percent which is massive
right if you think about it that's if
nothing else there's not many features
they can add to your pages or to your
applications that will increase your
revenue but four point three percent so
this is this is definitely significant
and further this is not only for big
sites this is not for Google search and
Bing and others this is true universally
so at Orbitz a great company that does
ROM analytics real user measurement they
collated this data across a couple of
billion data points from their customers
and what they were interested in was as
the page load time increases how does
the behavior of the users change and you
can see here that there's a pretty good
correlation which is to say for every
second that the page takes longer
there's an increase in the bounce rate
of your visitors so basically we have
hard proof that shows that performance
matters for the bottom line so it's not
just a feel-good thing right like I
would I loved optimizing things that's
you know I woke up getting excited about
that but there's also a very good
business case for this sort of thing and
actually let me just go back for one
second one mention one more thing about
Google what we discovered was we ran
this experiment for I think three or
four weeks and then we turned it off
right because we don't want to slow down
your experience unnecessarily and they
an interesting thing happened people
that were in these slower buckets didn't
immediately go back to their previous
behavior they basically learned the slow
behavior of the site and it's Okuma
proximately two or three months to go
back to the old behavior so - starts
searching more frequently or more often
so we learn these behaviors
we basically train our users to expect
you know slow experiences so that in
itself is an interesting insight so with
that right hopefully that at least
motivates the use case for performance
how are we doing today we ran some
studies at Google and I'll show you some
numbers for the specific kind of
geographic regions and medians and means
but first there's some pretty good
constants that are out there there's
been a number of studies that are
basically repeated these same results or
got the same results I should say we're
a regardless of what medium you're
talking about whether it's a desktop app
or a web app or something else anything
that's below hundred milliseconds in
terms of reaction time like you click a
button and you expect something to
happen if it's within 100 milliseconds
it feels instant right now I know that
there's some like hardcore gamers in
this crowd and you're like dude I can
tell you the difference between 35
milliseconds and 45 milliseconds
alright and that's true but for web
browsing that's not that's not really an
issue below 100 milliseconds it feels
instant somewhere between 100 to 300
milliseconds that's kind of like a
sticky button it's it's not quite slow
but it feels kind of weird like
something just happened somewhere
between up to one second you're still
engaged a fully engaged in the task that
you're doing but it feels sluggish and
after one second basically the user
switches context it's the difference
between you click a button and you get
immediate feedback so you click a button
and you're and you're waiting and then
you're like oh yeah I gotta send an
email to Bob and I should talk to Suzy
and what was I doing again and that's it
right
so the one second barrier is a very
important trash hold you should stay
below that because I don't that at very
least keeps the user focused on your
application and helping them get the job
done so that's why we picked one second
specifically for this task now here are
some aggregate numbers we ran this study
with Google Analytics which is installed
on a significant fraction of the web
when we collect the performance data and
this is data as of I think April of last
year so maybe a year old data and what
we found was that first of all mobile
not surprisingly is slower for a variety
of reasons and most
about some of these some of these in a
second but notice that the median time
on mobile is about five seconds right so
this is this is a far cry from the one
second goal that we want to have like
five seconds is is a long time and you
know the mean is even worse and you can
actually look at the distribution at the
bottom and by the way I'll share the
slides later and you can guys encourage
you guys to follow the links at the
bottom of the slides I have a lot of
references they can go through later so
it's not looking good to be honest right
five seconds we are getting better
though and I put the star here for
mobile and when talking about four point
eight seconds because this is actually
optimistic and the reason I say this
this is optimistic is because we
gathered data using navigation timing
which is a new w3c standard which means
that it's only implemented in the latest
browsers and if you have the latest
browser chances are you have the newest
phone if you have the newest phone
you're probably in the latest Network so
basically there's a population bias
there right it's like it's this room
because all of you guys have the latest
gadgets that's not true universally in
fact it's a lot slower so I would guess
that if you double this number we
probably wouldn't be too far off so
that's the state of art and the next
question is well why does it take five
seconds to load a median page like
that's kind of crazy
right so a great another great project
is HTTP archive HT archive.org which
crawls the web and/or it crawls the most
popular destinations on the web I should
say and instead of actually gathering
the content it looks at how these page
is constructed like how many CSS files
you have how many images what was the
size of those images and it provides us
some historical data for measuring how
the web is built so we can see here is
this is actually for mobile sites
specifically an average page mobile page
today is approximately 700 kilobytes and
it consists of 60 requests so this is
CSS files JavaScript etc right and if
you look at the actual make up of the
page approximately 500 kilobytes out of
that some 100 kilobytes is and images so
that in itself is a very important
realization if you're not optimizing
your images today that is perhaps the
number one thing that you can do even if
nothing else just go back home today
check that you're optimizing images
correctly whatever that means
and I say whatever that means because
you know oftentimes we optimize for
example a PNG file and remove some
metadata and we're like hey we're done
and the problem was the problem though
is that this file should have been saved
as a JPEG file instead and there's a
difference of hundreds of kilobytes in
there right so make sure you're picking
the right image format to begin with I
can't tell you the number of three
megabyte PNG files I've found on the web
which you know one saved as a JPEG are
like 250 kilobytes so images are
important and of course the second
biggest one is JavaScript and then only
after that do we have HTML and the funny
thing is you know you look at this look
an average page consists of six HTML
pages what I frames right so you're
including content you're including ads
or including other things you're pulling
in all the stuff so we're actually an
average page today's consumer consists
of 60 different resources which is very
very big and another interest
interesting stat that kind of floored me
the first time I read it was that for a
lot of users mobile is actually the
primary and the only way to access the
web in fact you know if you look at the
bottom here for United States a quarter
of mobile users for a quarter of mobile
users it is their only way to access the
web right so I say that floored me
because I tend to think of the mobile
phone it's kind of like a secondary
thing right like I want to go I need to
check something quickly but I can always
go back to my laptop and do the the real
work if you will well that's that's not
true for a significant fraction of our
users right and it makes you think in a
different way when you construct your
mobile application as well like you
shouldn't be hiding content with the
assumption that somebody will go back to
a desktop computer and then have the
full experience right you need to
provide the full experience on mobile so
all this is good and of course you know
there's ads everywhere
you can't yeah you can not see a
billboard that sounds like 4G fastest
thing ever
it'll save the world you should upgrade
today and this is really not a problem
right like pages are getting bigger so
what I'll just upgrade to 4G
everything's cool well not so fast
so
this is a report that FCC has done for a
couple of years and this is not for
mobile you should say this is
specifically for United States and what
they wanted to measure was what is the
latency of different connection types
within the United States
so specifically they gather the panel of
people and they they gave you a device
and that you would deploy in your home
and they do a deploy a device at the ISP
so the intent was to measure kind of
that last mile latency this is not from
your computer to the destination or some
server this is just to your ISP and they
wanted to measure the latency so the end
results were basically if you have fiber
today that's about 18 milliseconds if
you have dsl that's 43 milliseconds and
cables somewhere in between now why am i
mentioning this well if you think about
it 43 milliseconds that's just between
you your house and whoever's your your
ISP is right and then you have to go to
the actual server and fetch all this
content 43 milliseconds in terms of like
light light time is like going from San
Francisco to New York all right except
here you're probably going tens of miles
so this latency is actually a real
bottleneck on the Web today for web
browsing but all of that kind of pales
in comparison when you look at mobile
because you know the first time I saw
the the numbers for for wire it was like
wow this is a lot a lot higher than I
thought that then I started digging
through the mobile carrier technical fa
Q's and I walked away in horror
basically what they're saying is and
this is an exact snippet from one of the
networks right so for for sprint 4G you
should expect 3 to 6 megabits of
download speed which is good that's you
know that's great but the average
latency is 150 milliseconds so that's
like going to from here to London and
back right and that's just to your
mobile carrier and remember we want to
render everything within 200
milliseconds right and this and what
we're saying here is like you expect on
average just do like send a pack at 150
milliseconds just to the carrier so you
got 50 milliseconds left to render
everything and you know do all the rest
not a good deal and that's on 4G on 3G
you should expect
three 400 milliseconds of latency so
this is like half a second just to send
a packet out right so we have our
one-second budget we can send the packet
get it back and we're already half and
we spent already already spent half the
budget so you know here are some numbers
comparing a couple of different carriers
in the United States basically they're
identical right different carriers use
slightly different goal posts just to be
safe but you can assume that on a 3G
network you're gonna be somewhere in the
250 milliseconds age that's kind of your
packet time on 4G the numbers get better
you know 100 milliseconds or less on
some of the newer networks but
nonetheless this this means that latency
is a very big problem on the mobile web
the other big problem that I don't think
many people are aware of today at least
in the web building the mobile web apps
space is battery life this is certainly
a big big problem and something that a
lot of people optimize for when they're
building native apps but on a mobile web
we don't tend to think about it
the problem with battery life on mobile
is that your radio is the second most
expensive device or unit if you will on
the phone so the first is of course the
screen right but the screen is off most
of the time like you're it's in your
pocket the screen is off the radio needs
to give you this premise of on being
always-on right like you always want to
be reachable so we every but we can't do
that we need to turn off the radio as
aggressively as we can but it is because
it is very very expensive to keep it
active
so what this entails is this kind of
economy of control and user playing
latencies so this is definitely getting
into the weeds of how the mobile
networks work if you're curious about
this I have a very good resource for you
at the very end
slick see pages of it but very quickly
I'll describe what control and user play
the user playing Layton sees me in a
nutshell
when you have your mobile phone if you
want to send something you don't just
send it you say hey carrier I would like
to send some data and the carrier
listens that
okay use this transmit power on this
channel at this time and you have this
amount of time to send your data you
negotiate this kind of back and forth a
little bit then you have your resource
assignment and then you actually send
data right this is what's known as
control play latency so you can't just
wake up and say hey I got like a request
to send first you got to talk to the
tower the tower needs to permit you to
do that and this negotiation takes time
so that's what we mean by this by this
control play latency then once you have
the actual assignment you need to send
data to the tower itself and that also
takes time and the reason I mentioned
this is you know this is completely
transparent to us especially as web
developers we never get to interact at
this level but it imposes some very
serious latencies and guessing I'm
guessing I'm kind of blocking these
numbers here so in in 4G this first part
right here can take up 200 milliseconds
so this is just from the moment that the
user for example clicks on a button or a
link
it may take 100 milliseconds just to
negotiate that you want to send
something then you actually need to send
the packet and then once you have this
assignment it'll take approximately 50
milliseconds for each new packet to go
from from your device just in the radio
tower then from the radio tower it needs
to traverse the mobile carrier network
which is that 200 milliseconds that
they're that they're assigning to that
number and then you need to go to your
server so you know this is pretty
complicated and in 3 G's this gets
actually even worse this first step of
negotiating a connection can take up to
two and a half seconds so this I the
reason I put this entire slide here is
probably just because of this a lot of
times I hear people saying or developers
saying that designing for the mobile web
is very hard the latencies are so
variable I can't predict anything and it
is true that the the variability is very
high but it's usually explained by this
which is if your radio has been idle or
it's been off for a while the first time
you need to send a packet of data
there's this startup cost if you will
that only occurs when the connection
needs to be established so why does this
matter
well it matters because when I click on
a button on my 3G connection right
to like navigate to something it'll take
up to two and a half seconds just to
send the first packet and that is
significant time if you think about it
from it like a UX point of view right
like two and a half seconds you should
be taking that into account when you're
designing your mobile application so the
UI needs to adjust and then after all of
that the devices also has a very active
power management system which has
actually managed by it by the tower so
for example this is the LTE this is a 4G
case in 4G and we already described the
case of going from idle to active right
so in my phone is idle I decided to send
some data I need to go to the active
mode which will take 260 milliseconds
then I you know I send all of my
requests and then my phone is once again
idling maybe maybe I'm reading the page
as I'm idling after 100 milliseconds the
tower actually tells you hey you go into
low-power state because you need to
preserve power so you go into the state
and let's say at this moment you
actually click on a different link you
need to really kind of redo the
negotiation go back to active state the
good news is this may take a little bit
less time so 50 milliseconds ok but
let's say that you you're actually idle
right so you you wait 100 milliseconds
you're idle you wait another hundred
milliseconds you go into a deeper sleep
if you will where you're only listening
periodically
and then after about 10 seconds you
actually go back to idle mode so if
you're building a mobile website you you
fetch a page or your user visits your
page and that you fetch all the content
they're reading the page they take more
than 10 seconds the radio is already
idle so you have to you'll have to incur
that upgrade cost again which may be 100
milliseconds to two and a half seconds
right this is something that you should
keep in mind and once once you're aware
of this you can actually design your
round that you can actually structure
your application in a way that you know
that this is going to happen very very
similar thing in 3G I'm not going to go
through this in detail but basically
they have you know a couple of different
states and once again you know for those
that are curious about this I have a
good resource for you I just want to
show this here because
this first upgrade takes up to two
seconds yeah all right so like where's
this guy going with all this this is
just this is weird so having said that
right there's a couple of things that I
want you to take away from everything
we've covered so far latency is highly
variable on mobile networks you can
account for some of it 4G networks will
definitely help but 4G networks are
it'll take a while to deploy them
actually we all probably everybody in
this room already is on a 4G connection
the reality is is that 4G or actually 3G
will be with us for another decade at
least another decade when you talk to
the carriers they will all tell you that
the existing 3G networks will be here
they'll be in supporting role and in
fact you'll be migrating from 4G to 3G
all the time for the next decade it
takes a lot of resources to deploy these
new networks carriers have already
invested a lot of money into an existing
3G networks so you know this is a 4G is
not what you won't solve all things and
all of the usual optimizations that you
apply on desktop web things like reusing
connections downloading resources in
bulk I think this is actually something
that is underappreciated
mobile networks are optimized for bulk
transfers not for small transfers where
you were you're very cautious and you
say well let me fetch this one thing and
then determine that if I should fetch it
another thing it's like no they want you
to fetch as much as you can and then
turn off the radio because I'm gonna
preserve battery power and they're
optimized for that so let's leave the
kind of the network stack aside and
actually look at the browser now what
does it take to render a page and I
think a lot of the stuff should be very
familiar to you guys but I think it's
still worth to review this we talked
about the network you know we fetch some
bytes the browser has this resource
loader which basically says okay I need
this HTML page I need the CSS files and
then it starts parsing the the HTML file
itself and roughly what happens here is
you know we get some bytes off the wire
which are actually you know some some
set of characters we start converting
these characters as soon
as we get them so we don't wait to get
the entire HTML page if you send us the
first five packets you know first 10
bytes of your HTML we will immediately
start parsing it and trying to figure
out ok he's asking for a CSS file right
here and here's an image tag so let's
you know start fetching that as quickly
as we can so that's helpful because you
know if depending on how your
application server is structured you
should be flushing the important content
all the time and a good example of this
then that'll have to share is Google
search so one trick that we do with
Google search is you send us a search
query all right let's let's say you have
a blank page you send us a search query
we get the first packet of that query we
don't even look at what the query is
we're like great I got a query here's
the header for the h2 for the search
page alright and then once you get the
bytes for the header and the page is
already being rendered in a browser and
then we start looking at your actual
career and like ok so you're asking
about html5 let us dispatch the queries
and kind of fill in the content as well
as it comes so that itself actually
speeds up the loading experience in your
browser but quite a bit so that's the
technique that you can also leverage in
your own application it required it
definitely requires some careful
architecture of your application server
but it can do wonders if you do it well
so in any case we construct kind of this
true we start constructing the Dom tree
right something that we interact with
all the time here JavaScript and all the
rest and one thing that's often
forgotten is to get something visible on
the screen you don't just need the Dom
tree or the HTML you also need the CSS
and in fact those two are coupled we
can't paint something to the screen
until we have all of the style
information because otherwise if you
were to paint it without the Styles you
would get this like ugly layout all
right and then we would flash it with
the updated layout that's not a good
experience so basically we're stuck like
we need we need the HTML and we need the
CSS and we need them as quickly as
possible
and in theory these two things can be
constructed in parallel right and then
we get we get this render tree and we
kind of print it to the screen or paint
it to the screen I should say so far so
good this is this is the great case the
problem is we have this thing called
JavaScript
it's nothing but pain so here's an
example all right I have a very simple
html5 page it's a valid html5 page I
should say as well we're just I think is
awesome and approximately at the ball on
the bottom here I have how the parser
actually ceases right so we see the HTML
tag or actually we don't even see the
HTML tag but we kind of inject it on
there we don't see the head tag but the
parser it injects that in there this is
all for the first time ever in html5
we've actually like we have a hard
specification for how these bytes should
be interpreted into the street which is
great so we see this text also makes ml5
page and then we get to the script tag
and we're like wait a second we need to
stop the world we can't proceed we can't
in fact look at this link tag here
because the script tag could overwrite
what comes next
right and what happens here is this when
you have a script one of the great
features or bugs depending on how you
look at it and in our implementation of
JavaScript and then and the Dom is that
JavaScript can write directly into the
into the HTML itself so you could do
something as crazy as like have a script
that writes another script in line right
and we don't know we have no idea what's
coming next so we say ok we have to stop
the world fetch this javascript execute
it do whatever it tells us and then and
only then can we proceed moving forward
right and in the meantime you should be
thinking wait so to render something I
need the CSS as well but the CSS is
coming after this so guess what we're
not painting anything to the screen
while you're waiting for this right so
we just created this really nasty
dependency chain which is not good so
one of the ways you work around us and
I'm sure you guys have seen this pattern
everywhere is asynchronous scripts right
no performance talk is complete without
a mention of use asynchronous script or
usually synchronous scripts this is a
pattern that's being popularized by
Google Analytics it's available
everywhere but basically if you have
tags like this in your code go fix it
right go use something like this because
this will actually block rendering maybe
this is not applicable for every single
script but it is certainly the pattern
you should be using wherever and
whenever possible
so basically what it actually ends up
looking like is you have the Dom tree
you have the style rules and you have
JavaScript in between and the nasty kind
of relationship there is that JavaScript
can modify the Dom but it can also query
the CSS right because from JavaScript
you can say what by the way what is the
style of this element right so there's
this dependency in there and what it
means is rendering is blocked on CSS we
already said that but JavaScript can
query CSS as well so we have this
dependency chain right so JavaScript can
block the Dom construction javascript
can block an CSS rendering is blocked in
CSS therefore you know if you want to
make fast sites not just mobile sites
any sites you need to get the CSS down
to the client as quickly as possible I
mean it means removing everything out of
the path out of the rendering path and
making sure that you get that CSS down
as quickly as you can
including inlining inlining CSS Styles
right in the header of your of your page
so something we use on Google search and
in many other products right and I'm not
saying that you should be in lining all
of your CSS there's an important
distinction there you should be in
lining the critical it'll say above the
fold CSS so you can get something
visible on the screen and then you can
fill in the content later and welcome
back to this in a second and you know
scripts scripts cause a lot of problems
in terms of rendering all right so we
talked about the browser we talked about
the network in gory details and let's
try and actually pull it all together so
this scary beast right here is comes
from the w3c navigation timing
specification and if you guys are not
familiar with it what this each one of
these labels here is actually a timer
that is tracked by your browser that you
can access whenever the page is loaded
and roughly speaking you know there's a
lot of tags in here or a lot of labels
it captures three things user
connectivity things like how long did
the TCP connection take along the DNS
lookup take what was their server
response time to browser execution
stamps as well so you could say well how
long did it take for me to execute all
of my scripts on the onload handler you
have all of this instrumentation in your
browser today and the way you access it
may be a little bit small if you should
just pop up your JavaScript console and
you type in performance dot timing it
will give you a JavaScript object back
with all of these time stamps and
microsecond granularity like you know
we're serious about performance when
we're measuring stuff in microseconds so
this is available in all these browsers
there's a lot of good analytics packages
that will track this for you so if
you're not using a real user measurement
which is what this is all about right
this is gathering data from real
browsers visiting your site which is
very important there's a difference
between synthetic testing and real user
measurement testing and synthetic
testing you're saying look I have let's
say 10 servers around the world one in
Tokyo one in San Francisco one in New
York and I'm gonna get those servers to
ping me and tell me what my response
time is which is useful that's a good
baseline but what you want to gather is
real performance data from your users
for all you know a lot of your users are
using really old 3G phones and that's
good to know
right so you will capture that
performance data and you can analyze it
against your actual goals your
benchmarks so that data will give you
all of these timings that I'm going to
talk about here but you know in short
let's try and connect the pieces for one
HTML request right this is you typing in
Bloomberg comm you're hit enter there's
a bunch of things that need to happen to
fetch that page first we need to figure
out what where does this Bloomberg comm
thing live we need to look up the IP IP
address all right so that's gonna take
some time and then we need to do a TCP
connection do the handshake which is
another round-trip time then we need to
send the actual a spear request and by
the way by this point in time we've
already you know could be 500
milliseconds have passed then we send HT
requests then you process your actual
page give us the HTML and then we
deliver it to the client and the size of
that page will determine how long you
know this bar is so some of these don't
need to happen all the time of course
right if you already know what the
DNS resolution is we don't do it if we
can reuse the same connection we will
also reuse it and the browser will do
all this for you but on the first
request chances are the user will have
to go through each one of these steps so
let's do some math in that's kind of
hard to see so this line in the control
plane is what I described earlier right
your phone is idle and all of a sudden
you're heading enter to to load this
page on let's say on 3G this could take
anywhere from two hundred to two and a
half seconds 200 milliseconds to two and
a half seconds I should say right next
we need to perform the DNS lookup TCP
connection time and the reason I'm
saying it's it's a minimum of 200
milliseconds because this is what the
carriers are telling us this is how long
it's going to take us within our own
network to surrender this page so you
kind of go through all of this and at
the bottom you say okay so I started
with a one-second budget right like we
want to get a page visible on the screen
within one second what does that leave
us
well in the worst case we already burnt
all of our budget because you know like
this thing alone would have would have
killed it but in the better case you
know maybe the phone has already been
active we have about 400 milliseconds
left to get something visible on the
screen with 4G things get a little bit
more interesting and or much better I
should say not just more interesting
because we can actually reliably more or
less get a budget of about 500
milliseconds right for for all all the
other work and remember this is for one
HTTP request
I remember what we were saying at the
beginning an average page is 60 requests
so just repeat the 60 times right and
you get to five seconds no our goal is
to actually get the page visible on the
screen so what will it take all right
like our pages are not single requests
but maybe this should be or maybe
there's an in-between right maybe
there's certain things maybe there are
certain techniques that we can use to
inline the correct stuff if you all and
get the page visible and then fill in
the necessary content afterwards so
let's do some reverse math here let's
say we have a 400 millisecond budget so
I'm kind of splitting the difference
between
3G and 4G and I'm saying you know a lot
of users will be using both we won't be
switching to 4G overnight so 400
milliseconds right we still have them
talking about server response time so
you need to take that account into
account and I'm gonna claim that this
should be under 100 milliseconds if you
really want to meet this goal it should
be under 100 milliseconds which is
aggressive admittedly next is we haven't
actually accounted for the client
rendering time like we've shipped all
the bytes but the browser still needs to
do all the work to layout the page you
know paint to pixels transfer them from
the GPU to your screen all this work so
reserve about 100 milliseconds for that
to write that's just kind of the cost of
rendering a page so really what we're
left is about 200 milliseconds this is
200 milliseconds to perform all of the
JavaScript if you have any for that
first page and maybe maybe if you're on
4G you can dispatch like a requests in
there right to fetch some additional
contents to render the first page so not
much budget right basically we're saying
one HTML request and then maybe one more
for for some other asset so it's just a
quick summary right the hard fact most
of the most of our one-second budget is
just network latency overhead so just
take half of it off the table and
because that's that's what it is
you need to make your servers fast so
100 milliseconds or less you need to
allocate some time for the browser never
forget this right another good practice
you have is to always set a budget
always set a performance budget whether
that's a one-second budget or if you're
building for example you trying to build
smooth animations in your application
trying to deliver 60 frames per second
all right you do the math and say ok to
do 60 frames per second I have 16
milliseconds to render each and every
frame so as long as I fit all my work
with a 16 milliseconds I'm good right
not really because the browser also
needs to do its work right you're not
the only one doing things in a browser
so really have at most 10 milliseconds
if you want to meet that budget so never
forget the overhead of the browser
itself and the implications of all of
this is that really we can't afford
make additional requests or not many
requests we have to inline the most
important stuff if you will and that
most important stuff is CSS for the
reasons that I described earlier right
we need the CSS to paint something to
the screen so you need to identify what
is the critical CSS for the specific
page and the critical CSS is like the
stuff that's above default it's the
first thing the user sees we can fill in
the rest later and to the extent
possible eliminate and move JavaScript
downstream right it is true that you
know we're increasingly using JavaScript
frameworks to build the actual page
itself like it's the JavaScript that's
laying out the divs and spans and all
the rest that's gonna be hard to achieve
with something like this but a
significant fraction the majority
actually have the mobile web today it's
using javascript to enhance things
things like add on click handlers and
add social widgets and all this kind of
stuff all of which can be safely
deferred until you until you paint
something to the screen and then you do
that so you know a very simple than a
toy example admittedly but just to
illustrate the point right here's a very
simple page we have our style sheet at
the top so first of all the order is
correct here right so in the previous
example I showed you I had my script
above the style sheet which is
definitely not not what you want to do
so we're fetching the CSS and we're
fetching application GS so far so good
right this is pretty much as clean as it
gets the implication of everything we've
talked about is that really if you want
to render in under one second you need
to inline the CSS you need to take that
file and you need to figure out what are
the most important bits that's what
we're doing at the top and then here
either eliminate this JavaScript or
figure out how you can defer it and then
at the bottom here you can see what I'm
doing is I'm saying after this onload
happened after I have painted something
then go out and fetch things go load
your analytics scripts go load your
social widgets go load whatever you need
yeah question
so the question is there's been some
recommendations about using local
storage so you can grab files you know
stick them into local storage and then
what is the cost of doing that so the
answer there is it actually varies quite
a bit by the browser and the platform so
for example on on Windows Windows has
its own system level kind of prefetching
architecture which will prefetch
necessary bytes which makes access to
local storage actually very fast which
is not true for example on Linux and OS
X and different browsers use different
prefetching techniques for this thing so
the short answer is the the performance
can actually vary quite a bit it can be
up to a hundred milliseconds just to
open the local storage file but that is
certainly a technique that you could use
right the other thing I guess is I'm not
saying that you shouldn't be using the
browser cache here right what I'm saying
is you need to figure out what is the
critical CSS and remember that you you
may still have enough time to do like
one one request and I'm what I'm saying
here is that requests should probably be
the CSS and that should live in your
cache and you probably shouldn't worry
about putting in your local storage
although that is certainly technique
that you can explore right okay so Ron
you know defer stylesheets defer
javascript defer all everything you can
get something visible and then
progressively fill in this content and
you know this is all good in theory how
you actually go about doing this and
admittedly there's not a lot of great
tools out there to help you with this
task but there are a few and I think
they're actually they go a long way so
the first one and the one that I'm most
familiar with it is if you look in your
chrome dev tools if you go into the
audits panel one of the audits is the
web page performance this is a very kind
of little-known tip if you run the web
performance test it'll actually tell you
that
hey on this specific page here all the
CSS files that you've loaded but I
looked at all
the cells that you're using and 61% of
those cells are not being applied here
right so you're just kind of you put
everything into your CSS and you're like
it doesn't matter right like it's all
CSS and this is in fact a good case I
know that on my own site for some pages
it's 90 percent or 95 percent not being
used because it's a very simple page but
I've kind of put everything into one
thing so not only that but we can
actually open up any one of these files
and I'll tell you the exact selectors
that are not being used right so if
nothing else you can open this page kind
of look at your own landing page on your
home page and figure out the specific
chunks and just kind of pull them out
you can also do this programmatically
you can actually write a script that
will walk the structure of your page
query which styles are being applied and
then kind of extracted that way and one
of the projects that we have at Google
called Page Speed we have an open source
implementation called mod PageSpeed for
Apache we're actually experimenting with
us right now
we're actually trying to build a filter
that will automatically if you will
it'll load the page we will traverse the
Dom we'll figure out what are the
critical assets or the critical CSS
styles we will weaken the data back to
the server kind of accumulate this data
for a little while and then start
inlining the critical CSS this is kind
of crazy crazy stuff but we have
indications early indications that this
is actually going to work so hopefully
we can automate a lot of this stuff but
if not you know there's some tools there
the other cool little tool that I don't
think many people are aware of is we
have this thing called the critical path
Explorer and I'll show you at the very
end kind of a quick example of this but
the difference here is you don't don't
worry about the you know reading the
specific names of each one of these
assets basically I'm looking at Guardian
Co UK and here's the water full
waterfall graph for that page right like
tens and tens of resources being fetched
kind of see the stepladder and the idea
behind critical path is okay great
that's what it takes to render the full
page but what are the critical assets
that we need to render something on the
screen period right some of the stuff
that we load that is not applied above
the screen etc and that's what this tool
will extract you click a button and it
transforms that page or that view into
this view
right so you very quickly can see okay
I'm depending like here's my smell page
which depends on this javascript file
and it's fetches the CSS so here's a
quick example hopefully you guys can see
that so we have we fetched the HTML and
actually that purple bar there actually
indicates that there is 300 millisecond
read returned
yeah redirect and you know if you're
trying to build a page that is rendering
within one second redirects are
obviously an anti-pattern right so I'll
just leave that out there after that we
can actually start iterating and
actually I'll point out another thing
I'll be frank and I'll say that this
tool is still under active development
the actual UI for this I think is
terrible but we'll make it better I
promise what this little thing tells you
is this is where the Dom content loaded
Dom content loaded event fires so what
this tells you is that we're not
deferring or this page Guardian is not
deferring any assets whatsoever all
right so it's gonna take way more than
one second but here's an example right
you can actually hover all over all of
these and it'll tell you that okay so
we're loading jQuery min after that we
have some show ads GS which then writes
the Google ads script inside so kind of
this nested old pattern and this is
terrible for performance right because
we're kind of we're nesting scripts
inside other scripts and then after all
of that we have some long-running
JavaScript I don't even know what it is
I didn't dig into it but it takes on the
order of 60 or 70 milliseconds so this
view in itself is very very powerful
because that allows you to see like sure
there's dozens and dozens resources but
what are the critical ones on my page
and your goal is to eliminate as many of
those as you can or move them out beyond
that event of the first paint so you
know I could have a guest started with
the slide and we could have been done 45
minutes ago one request in line the
critical Styles hopefully have motivated
why and
why that's important and deferred the
rest all right and this is this actually
sounds the first time I've kind of went
to this exercise I was very skeptical
because it seems very hard to do and
practice it turns out that more for most
pages the kind of the critical path is
not that complicated
right you're fetching dozens of
resources but there's only so many files
that are actually important and what you
need to do is figure out how to defer
the rest and kind of maybe shuffle the
structure of your page a little bit so
it's not all that bad
so with that I'll I'll take some
questions if we have time I'll mention
two things the slides should be there
bitly mobile barrier and I am currently
working on this book with a Reilly
called high performance browser
networking so if you if you really want
to dive into how the mobile radio works
and all the rest it's actually available
online for free it's still in early
development so you know there's typos
and all the rest if anything I would
appreciate your feedback but it's online
and free so check it out and I'd love
your feedback on it</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>