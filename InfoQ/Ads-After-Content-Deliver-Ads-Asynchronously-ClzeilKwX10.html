<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Ads After Content! Deliver Ads Asynchronously | Coder Coacher - Coaching Coders</title><meta content="Ads After Content! Deliver Ads Asynchronously - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/InfoQ/">InfoQ</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Ads After Content! Deliver Ads Asynchronously</b></h2><h5 class="post__date">2012-11-01</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ClzeilKwX10" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thank you guys so much for being here
this is actually the most important talk
of the day and it's not just because
we're all going to go drinking
afterwards but because this talk is
about saving lives in a single month
collectively internet users are waiting
about 10,000 years just for pages to
load that's a lot of lifetime's now I
know we've we've this is an html5
conference we've beaten the load times
dead horse to death but what no one
talks about in the hallways out there
and in these rooms is who's really
responsible for about half of those
10,000 years that internet users waste
every month and that's the little banner
ad at the top of your page that's right
the synchronous add that has to load
before anything that the user really
came for is going to arrive on the page
this is a talk about saving lives so in
a moment I'm going to show you a short
documentary it's actually really short
so short this does not really time for
character development so I'm going to go
ahead and and introduce our characters
it's a tale of two ads so we have a
synchronous ad and an asynchronous ad
now we've called them synchronous and
asynchronous to actually describe their
discuss their true identities because
what you're about to hear is not pretty
so let me ask you guys which one do you
think is the good guy we got a
synchronous anyone else well it's
actually a trick question because all
ads are evil I'm not just evil because
they spam our users they're evil for the
absolute worst reason anything on a web
page can be evil and that's that they
make a hell of a lot of requests
internet requests so let me let me show
you
so this is this is a snippet that you'll
put on your page here 44 double clicking
I'll read that I'm just kidding you put
that on your page and this document dot
write here that's like a macro a macro
that expands at runtime it like blows up
like a like a helium bomb and it
produces all this all that stuff goes
into your web page and that's okay it's
just HTML right but if we do a search
for SRC equals we end up with about 20
to network requests from that one ad
once again this is a talk about saving
lives and I'm going to show you how to
do that now do you guys know what a what
a synchronous ad is if I say synchronous
ad or we all know what our synchronous
script is right on the in the HTML is
just a script tag you guys with me on
that yeah so a synchronous add scripts
scripts can document dot write other
scripts and they can document dot write
anything as they as they do their macro
their macaronis
a synchronous ad says the browser as it
the browser is parsing the Dom it says
stop stop everything you're doing right
now I need to Nate to make 22 network
requests and load 12 remote scripts in
cereal before you show the user anything
I I was really surprised when I found
out about this i mean i come from a UI
background where you know we're taught
about how to to load scripts
asynchronously and insert them into the
Dom like good network citizens but no
one talks about these these these
scripts these ads that are using
document right all right let's go to the
documentary
alright the internet in here is actually
really speedy which is which is working
against me so here's a documentary ready
so we have our two characters to ads
walk into a browser
okay so as you can see I mean this is
really fast internet the ad on the left
has to load before we can see the
content on the left
and that's it that's a documentary let's
go behind the scenes though and see
what's going on so this is our
synchronous page
these are HTML
so here we have our ad we document dot
write inside the div here and then we
have our content so far so good now what
we're loading here in the slideshow this
is artistic these are the artistic
gymnast medal winners from the past
olympics let's see let's see where they
turned out in this competition
all right there they are they're kind of
mediocre here and a half way down see
what we came in above them oh look
double-click got the gold all right now
let's look at the other character the
async page first of all where did our
artistic gymnast come in this time oh
look at that their first this is what
the user came to see and this is what
you're giving them right away how do we
do this well the short answer is Magic a
lot of magic the long answer will come
and that's what the rest of this talk is
about so here's our ad where did the
document right go at the bottom of the
page we're loading this special library
called post grab which is a form of
asynchronous document right that's right
asynchronous document dot write and then
we're writing to our ad the same HTML
that we document wrote on the
synchronous page
alright so we all know that load times
matter not not just load times but
writing asynchronous also lets us do
something that we can't with regular
document dot write we can refresh an ad
so say we have the slideshow here we
haven't L at the top and then we have
laurence fishburne oh and a new ad and
that's not this isn't an iframe
who's our ad let's do that again it's
actually rewriting the down there but
the ad is just using document dot write
we didn't change anything we didn't go
to the ad server and say hey listen you
gotta change your document dot write for
for document create element appendchild
so we know all these numbers we know
that load times matter we know that this
is something we need to do we need to
make ads a sink it's the way of the
future a lot of big names are interested
in making ads async including Google all
of our clients at crux people like wiki
on New York Times Wall Street Journal
Reuters are all interested in this
problem so wait so why doesn't everyone
just do it that's a that's a good
question the problem is document that
right are you are most people here
familiar with how document dot write
works the fact that it has to be in the
page I see a lot of people nodding
awesome so
a few people tried or started to a
couple years ago try and make override
document dot write and come up with an
implementation that was a synchronous
and there's been a lot of improvement
since two years ago I'm going to I'm
going to talk to tell you about this
document dot write and show you some of
the sum of its idiosyncrasies then I'm
going to talk about a few approaches to
making it a synchronous and finally I'm
going to talk about some products that
use those approaches and the pros and
cons of each so you'll have something to
go home and save lives with
ah
add a lot of fun writing these little
these little helper programs that I'm
going to use to demo some of this stuff
HTML turning HTML into the Dom I mean
that's pretty straightforward right you
you see a tag there so there should be
an element if there are things in inside
the tag those those become child nodes
in the Dom I mean it's pretty
straightforward I'm here to tell you in
the next five minutes that it's not it's
HTML HTML is kind of like the matrix the
matrix before Neil takes the red pill
everything kind of looks washed out
black and white the Dom however DOM is
like the matrix on the red pill and
we're going to see just how far the
rabbit hole goes here so this looks
normal
we know about tbody elements kind of
these implicit elements that crop up
what if we ask it to do something
ridiculous so I don't know if I've made
it clear but on the left is HTML on the
right is what it would produce if we
document that right what's in here all
right sometimes we forget to close
things and we're naughty this looks fine
that the the dollar gets close to closes
it for us but what happens if we start
writing outside here again the I element
is almost echoed and if there are
attributes they get echo too now not all
browsers behave like this this is the
more modern ones if you take something
like this which is complete I guess they
call it tag soup it's improperly nested
tags modern browsers will produce a tree
that looks sane where if you're my child
then I'm your parent and I have multiple
children IE actually tries to be or i7 I
ate actually tries to be tries to
represent this in the in the DOM and
actually creates Dom soup so just
because I'm your parent doesn't mean
that you're my child for example so in
this case p could have I as a child but
I has B's parent as a parent anyways
what lat why is this important
I'm trying to instill a problem in
instilling you and understanding of the
problem and why it's hard we're not
we're not all the way there yet so that
when I show you the solution you guys
are going to be like oh wow thanks Derek
let's do a simple doc right here
so if you document that write something
inside a script the script is actually
if the script is in line it actually
gets executed right then and there you
have to be careful if you're going to
emulate document all right you have to
get this nesting right even more
interesting if you load a remote script
the the writer actually delays the
continuation until after the script is
loaded now remote all remote j/s does is
is it writes this div remote so if I
were to
if i were to document dot write a remote
script and then try and use it down here
some function like remote it wouldn't
exist yet thank God because if if the
JavaScript thread actually pause for the
script to load then you know if the page
would freeze up so the script is allowed
to exit
in this example we we note that document
rate is actually actually happens
immediately so here we're going to write
a div with ID give one and then
immediately we can set its injured enter
HTML into something interesting and
creative and ads actually do this a lot
they'll document write a div and then
just to have a place to hang things
it'll start a pending setting inner HTML
and creating the visual representation
of the ad in the dumb
alright so now for the solutions the
first there are two parts to the problem
of document dot write one is getting the
flow right and by flow I mean you know a
script can call document dot write and
document dot write can create script
tags and everything if you document dot
write a script tag everything after that
document dot write has to be delayed
until the script executes so you have to
get this this nesting this tree of
scripts and rights you have to get it
right that's the problem of flow once
you once you get that right then you
just have a sequence of static HTML HTML
that doesn't contain any scripts because
you've evaluated all the scripts you can
throw away scripts once a once they
execute they're not really needed in the
Dom so the next problem that of putting
these rights having the rights append
things to the DOM is actually the
hardest problem and the reason is for
that is just that the way the parser
works is so complicated it's hard to to
emulate it programmatically but people
have tried including crux our first two
iterations of an async writer were
parser based and what I mean by parser
based is
as a right comes in there's some HTML
you parse it into tokens say you know
here's a start tag say it's a div so I'm
going to create a div and put in the Dom
and then before I see before that tag
closes I see a paragraph tag so I'm
going to create a paragraph element and
make that a child of the div using a pen
child that works fine until it doesn't
and we really found that there were too
many ways I could go wrong so there have
an example on the left of the parser and
Dom approach it works really well for
doing things immediately as you can see
we document that wrote this and
immediately added inner HTML and boom it
worked like a charm but the way that
this writer decides to nest Dom nodes is
dependent on a parser that's written in
JavaScript so we get stuff like this it
gets that right you know it's not I'm
not telling I'm expecting those Peas to
be side by side because peas are self
closing but overhear the DOM is telling
us that the div closes the P tag
document.write document dot write is the
the final has the final say on this
because that's what advertisers are
expecting document that right to do but
this posture but plus Dom approach is
doing something completely different and
that's why ads break
for this in this example of the partial
plus dom approach is ghost writer 11.6
so we found the parser press + dom
approach to be it just too hard too hard
to rewrite what the browser does when it
loads an HTML page now the first thing
people thought of I mean what would what
would you guys think of if you had some
HTML and you need to convert it into
into the Dom that's that could you speak
up make it well formed okay but you
actually we don't have control over that
it's the it's the ad engine that's
giving us some JavaScript and they're
they're terrible programmers
enter HTML yes that's that's what I
think that's what jQuery uses when you
when you pass it some HTML and say hey
put this put this in the Dom enter HTML
is amazing because it's asynchronous you
don't have to interrupt anything to to
use it and it does exactly what document
dot write would do so remember we've
gotten rid of the scripts already we're
just concerned with writing things that
don't contain scripts any marks we
figured out the flow
your HTML is perfect except for for one
thing it only works for the first right
the other 130 or however many your ad
makes won't work and the reason for that
so this is really the first naive
approach let's let's just do plus equals
we want our paragraph to contain an eye
element right now let's look at the
inner edge actually let's just look at
the div and it doesn't it didn't do what
we wanted and the reason is that inner
HTML is kind of final let's let's let's
set the inner HTML and once again to
your paragraph so if you look at our
inner HTML it's already closed it for us
so plus equals isn't going to work for
doing multiple writes on on top of that
some of the note here is that if if say
we had that pixel in our ad this is
trying to pick up trying to load this
pixel that say notified the ad server
when the impression had impressed the
user and then we try to you know append
to that
our I elements that actually it actually
lose the the image again and that's
because as we know it's programmers plus
equals is a get a plus and then a set so
you're you're wiping out the DOM and
reconstructing it this just will not do
so the next generation of document right
emulators right capture comes to mind
cube it's open tag they said well listen
we're just going to buffer everything
and at the very end we'll just do in an
inner HTML and that that gets the
structure perfectly that's it that's
exactly what you want from a structure
point of view the problem is that in
here we're going to have an inner H
innerhtml writer
problem is it doesn't get doesn't get
this right second
doesn't get it doesn't write immediately
right because it's buffering it's
waiting till the end so all the
documents all rights have finished
because it knows that afterwards i'm
going to i'm going to be dark i'm going
to keep document that writing other
stuff
it knows that I'm going to keep document
writing and if it used plus equals this
this P would be beside the div but
because it's wait until the end it knows
Oh it uses inner HTML and enter HTML
figures out that the P goes inside the
div but not only is the div not
available here we actually broke the ad
the P can no longer be written because
Dave one is null this sucks and and and
this is as do this all the time they
write something and then they want to
they want to append children to it they
want to set attributes so I know I'm
being really negative but if it weren't
for you know digital folk fulcrums ghost
writer for right capture for qubit and
open tag crux wouldn't have accomplished
what what we have and that's what I'm
kind of pretty excited to show you guys
so our solution is called post-grad
so post grape here is in the in the
upper right so I'm going to turn diffs
on so we can see where things screw up
so as you can see subscribe postcard
gets the immediate part right post God
uses inner HTML but it does so in a way
that is streamable it figures out the
plus equals and I'll show you how it did
that it also gets all the nesting right
there's RP with a div that not many
people know about PI surplus Tom gets it
gets it wrong ghostwriter actually
partial US dollars right capture to
ghost rider gets it wrong innerhtml gets
it right but once again that's because
it was buffering post scribe gets the
correctness and the immediacy how does
it do that i'm going to show you in i'm
going to show you the algorithm so you
can understand because it's actually
it's actually pretty simple
alright
I had fun thinking of this like a proof
by induction you guys remember that from
from school where you say you know this
is the base case you know for the first
right we're going to use inner HTML and
then assume magically we can do it for
the first n rights we can write
perfectly how do we do the n plus 1
throat so the way we do it is is this
context we keep track of a cocker this
context of everything that's been
written so far but we strip out the text
and we strip out the attributes because
they're not really needed to understand
what the Dom should look like
here we have what we want to write next
so we open a span then we have this
image we don't want the image to fire
twice then we want to write some text
have a paragraph some other text and
close the span and behind that write
some more got it so here's what is what
we want to talk like this this tree down
here is just is just a fancy way to look
at the Dom all we're doing here is inner
HTML how do we get the next right
the answer is we take this context and
we append it prepended sorry to what we
want to write next now the yellow nodes
are nodes that we've already written
and the other nodes are not-- our new
nodes we know that if we see a text note
that it's a new note and maybe we've
inserted an attribute into the context
that tells us that that this image is a
is a proxy for the image that's over
here then what we do is we look at the
parent the parents of the new elements
if that parent is a proxy for an element
that's already been written we move that
child underneath we append that child to
the actual node in the Dom that make
sense
so in doing in doing this we've been
able to see some amazing differences and
and how ads are rendered asynchronously
you guys have any questions about this
this is this make sense the question was
how are we buffering yeah just in a
JavaScript variable I know maybe that
was too much of a simplistic answer
actually this is just it's just a string
and then we use regular expressions to
just extract take out the attributes and
take out all the text nodes there's a
general in the front here in the nice
shirt we don't do we don't so the
question was about how do we how do we
put the attributes back into the Dom
okay well we don't they we didn't take
them out in the first place these as you
can see that the attributes are here are
there we we just keep around a copy we
only keep around the only thing we care
about what's been written before we want
to give some context to to the new right
so that we understand where nodes fit in
and inner HTML is going to tell us that
so this context is just a string it's
just the bare minimum we need to keep
track of to let innerhtml know where we
are in in the writing process
so listen
I'm going to leave you with some
resources
some links to all the things that we we
talked about just just to refresh your
memory we we talked about how horrible
it is I mean people talk about blood
pressure and they talk about you know
heart heart problems but no one talks
about banner ads then we talk about the
idea of making document dot write
asynchronous we looked at a couple
approaches for doing that inner HTML and
parsing and inserting things into the
DOM and finally we introduced a new
library into the mix called post grab
now all of our clients are using this
right now where we've probably delivered
a about a hundred million tags since the
beginning of this talk to viewers of
nbcuniversal wikia new york times this
is battle tested there's the github repo
we'd like you guys to give it a shot if
you find bugs let us know we our company
is really behind this product it's the
core of a lot of things that we do yes
oh jeez is it for you to use and if so
how do we make money that's like the
classic and startup question it is
absolutely free to use MIT license
really friendly support staff we make
money off of a whole bunch of other
things weird crux is in the business of
helping publishers manage their data so
this this product is actually part of a
tag management solution we tag
management is kind of like a content
management system for snippets like
google analytics ads all kinds of pixels
so this this is the core of our tag
management solution our ties managed
solution is just one part of of what we
do we we this this has been this
projects been closed source for a couple
years but we decided that we want to get
the word out there and get people using
this and yeah hopefully you'll like it
well listen I had a lot of fun and yeah
let's let's go drink something thank you
very much for your time
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>