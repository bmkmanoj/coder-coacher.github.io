<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Learn Node By Example - Part 9 - Sessions &amp; Tidy | Coder Coacher - Coaching Coders</title><meta content="Learn Node By Example - Part 9 - Sessions &amp; Tidy - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JREAM/">JREAM</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Learn Node By Example - Part 9 - Sessions &amp; Tidy</b></h2><h5 class="post__date">2017-02-15</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/9gbn6Ren3kw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">and this video we're going to install
the session handler and we want to save
sessions to Mongoose so if I just go to
NT MJS calm I'll look up expressed
session and I'll just check by
popularity and this guy see these two go
together pretty much and we're going to
title then so 82k downloads in the last
day usually something that more people
use is a good idea so NPM install dash
dash save Express dash session and we're
also going to use Kinect dash Mongo
okay so down over here looks like added
coat but I'm going to put the years
doesn't have this if I put this at the
top I'm going to start doing this use
strict it's just a little cleaner and
all I did with these was sublime
alignment plugin and i just press
control all a and just aligned it so
what we need to do is make a variable
and i'll say var section equals require
express session and bar Mongo store
equals require connect dash Mongo and
we're going to pass in the session there
ok and I want to kind of clean up some
of this because it's really hideous
looking what I'll do is just go to one
of my routes and copy this and I'll just
paste it here it'll say in it app and
I'll go to here and this will be
database and at the database and then
for the view engine will just say you
engine then here I'm just going to say
at configuration and let's see without
route
here and this guy let's move him up
catch four or four and same with error
handler ok and then that looks a little
bit more readable in my opinion where
you have these blocks of code the next
thing we'll do is we have routes down
here and then you'll notice we're
including routes here I'm going to cut
this and bring it down right here ok so
instead of just doing this index
variable i'm just going to require
inside of here and the same for users
but dashboard i'm going to leave a loan
because we're going to do something
different with that which will come
later it's going to have to do with
middleware and what i want to do is
under the app if i copy this again is
we're going to have logging and then
we're going to have arm wait custom
middleware i'll put the custom
middleware up here I like that better ok
so we have our mando store the
connection and all that and what we're
going to do is go down where we have we
can put it right under the cookie parser
f dot use session and we're going to
pass on an object and we want to do is a
secret I'm just going to do abdominal
snowman resave will be set to false this
has to do with the session package if
you want to read up on it save
uninitialized true and cookie in this
mode we're just doing over HTTP not a
secure connection or anything and then
we can set the store and we'll say new
mongo store and here we put Mongoose
connection and we just put Mongoose
connection which is to say this is the
same as what we have up top see this
says connect but we can access it from
connection ok and this make sure you
don't put a semicolon there because this
is still a comma separated list from
there if we go to probably our routes
let's go to ropes of Sun dashboard users
ok we can get rid of all this stuff in
here because we're going to do it
differently now all right first thing is
for this we don't have to end it we can
just chain it like this for the post in
order to get a session you just say
requests dot session even a sign of our
variable to it also and then you could
say esta I don't know ID stuff like that
so and i will say that whenever we're
using something like this this is middle
where this session is middleware meaning
it happens it's a prebuilt middleware
and we're going to make our own soon and
then there's a router get log out so
with the log out um I suppose we could
do something like this will say destroy
session and we'll say request session
that destroy function ER for error first
we'll attempt to check that failed so
this error response that redirect just
to the home page and we're going to want
error messages in here too so put to do
ash message and I'm just going to copy
this because i'll paste it a few times i
know and then we'll say success flash
message and response the redirect to
home actually this could probably be
dashboard if there's an error i'll just
leave it at / for now and then if we go
down a little bit to the register guy
we're going to kind of clean up a little
bit and what i had done was I installed
a linter it was called sublime Lynn j/s
yes I believe something like that and i
installed that i'm not sure why it's not
working
okay I guess I'll install annotations
whatever that does but if we go to
sublime linter on github I'll just load
it in here sublime winter we want to
look for Jas Jas hint JSC s so this is a
guy we want and we need to do a npm
install globally jsps and TM install
what i think i have to be sued along
here ok so that's going to install him
and should be able to tie Jessia ok so
that works
so before going further read these
finding a winter executables but I'll
validating your path to verify sublime
winter will be able to see the change
you made above enter the following
command we're just want to see if this
works so user bin which linter kind of
weird because I don't recall anything
being called a linter it's actually
really useful sublime winter if you use
sublime I'll just go back let me just
try one more time to install sublime
winter so many of them very cool
well it was working on my laptop I'm not
sure what's up right now who knows but
anyways it'll show little errors and it
just it's going to make your cold
cleaner like you add a little space
before anonymous functions make a space
between things like this and also at
this I wanted to have those nested like
that because it's an object it just
looks cleaner to me so we go down a bit
to the register and we're just going to
do the post here get rid of that ending
guy register clean up a little bit of
clothes so we could just look for this
and i'll press slow so I know my hot
keys ctrl H I'll just replace this with
function request replace all and all on
do it for all these find in folder and
replace all looks like only two
occurrences and escape ok so in order to
get like post stuff that they post we do
request dot program email so we're going
to say of our email our password request
/ M password and then we want to do
password confirm in JavaScript we don't
really use code like that it's
recommended to do it lower camel case
and then our HTML form name would be
like that but you could differentiate in
your HTML I just like to keep it
consistent
okay I guess the first thing the check
would be if packs or does not equal to
password confirm then we have a problem
flash message looks so I copied flash
message here and then we'll say request
that redirect to register okay and I can
just enter out of that one and before we
create a new user we're going to get
into that later right now we're just
looking at the session and for the
session we can go ahead and create
middleware I suppose we'll finish
cleaning up a little bit of this where I
can put the title / consistency not
everyone likes the cold like this but I
really like things to be consistent and
the JavaScript Puritans who like doing
things a certain way might disagree
that's okay you know all right so just
checking passwords we have a post so we
can get rid of this lash sky you like
this oh I forgot my bad wherever we do
this we don't have to pass in the path
name because it already knows it's
attaching to this path so let me go up
and make sure i get rid of these post
login okay because it's already attached
to this we don't have to define login
twice I'd be silly all right and let's
see forgot password
and then reset password okay and we had
a password reset and a profile going
here my profile and then I was going to
add a new section this was going to be
called delete reactivate account and
will say router get delete function will
be request response and here we'll say
response that render users account
delete and then dot post remember I got
rid of the cenacle in there and i'll say
function request response and i'll say
if request program confirm equals one
then we'll go on to get info I'll just
put like VAR ID equals request session I
think it's underscore ID and will also
pass if request / am soft delete equals
one meaning they could come back if they
want it then we'll do a soft delete and
we'll use the user model so user dot
update and we're going to look in these
braces with the database and ID will be
ID I have to double check on that
underscore once we get to it and here
we're going to say that dollar set is
the same way you do it in Mongo deleted
at equals date or it's a sorry it's
like that and then here we'll put a
function for the error that is if there
is an error okay make sure I got all my
stuff here and we're putting a little
bit of logic here which is ok I know
we're managing sessions but I just want
to get this out of the way real quick
and here we'll just say if err we want
to shoot
run a flash message that we want to
response.redirect to users / delete and
the it's going to tell them what the
error was once we get a little flash
uninstalled will do else statement here
so if it was not a soft delete it's
going to be a hard dilly and here we'll
say user dot find ID ID dot remove
function error and I'll say if error
we're just going to copy the same code
here and then otherwise if none of those
fail we'll say success and looks to do
flash message and response that redirect
to I guess just the homepage this will
also need to do a session destroy
and for this one I'm not going to pass
on a function for errors you'll see that
we do have code that's reusable that we
could put in a function and something
that would be good little later on and i
also want to do one more for router get
/ reactivate function request response
and we'll just render the user's account
reactivate ok and get rid of the
semicolon and we'll handle the post for
the function of request response and in
here we'll just save our email equals
request / am female and we're going to
have to check you know if it's an email
so to do validate email and here we
would do something like user find email
based on the email and then the function
if there's an error so if error I keep
losing track of those flash message and
we'll do a response that redirect to /
reactivate mean it goes back to the same
place and here we'll put a to do send
email to user with reactivate / ko's
here okay and then we'll just make one
more route router get reactivate / colon
code we haven't done this yet but this
is a URL parameter so it would be like
reactivate / anything we want and it
would be packed in here is the code so
we'll do function request response and
i'll just say bar code equals request /
am code I don't think that's considered
a query string where you go like that
I'll have to double-check well just
comment that out there and now let's
make a folder we're going to call this
middle layer and as well we'll put our
middleware will make a new file we're
going to call it require login I'll put
use strict so require login dot j/s you
know what what's curious is they use a
lot of dashes and all their Express
packages and I wonder I'll just do it
underscore for now so we'll say function
or choir login or quest response the
middle where we always want to pass the
next and we're going to do a console log
of middleware triggered and console dot
log request session see what's in there
and we're going to say if request dot
session dot log N equals 1 we'll keep
going else response the redirect to
slash users logging and will probably
want to do a to do now we'll just
redirect them and force them and we'll
do module dot exports equals require
login okay and in apt j s where we put
our
custom middleware that's where we're
going to put our new little middleware
guy so I'm going to save our require
login equals require dot slash
middleware require login ok now I'm
aware that there's packages like
passport and all that and they do
requires a kind of the same amount of
configuration might be to have the
differences it supports several
providers Twitter Google and all that I
try to do things the hard way so that i
can also learn it the hard way and then
you can too then when you find these
packages you'll see the benefit I feel
like it's always better to learn the
hard way as bad as that might sound good
so what we're going to do is go down to
our routes in our app and is why we left
dashboard there I want to duplicate this
and I'm going to say put an asterisk
here and i'm going to say require login
dashboard ok so first let me just try
and make sure everything works npm start
all right looks like i have a bug up
here that's why I need my linter Express
handlebars I have a comma here try again
user account delete that I went through
this a bit too fast i'm sorry about that
little semicolon there and there was an
account delete on line 121 why did I
mess that up okay okay it's running I'm
only human so I'll go ahead and go down
and goes the homepage forgot password
and I want to try to go to dashboard and
it takes me to users login okay so
dashboards now lock down based on this
middle layer and we could obviously
change this to maybe something more
complex so down here require login
dashboard I'm going to go ahead and
comment this out and see if it works
with every route on dashboard I think I
had a problem with that so if i go to
slash dashboard okay it's still working
if you try to go to dash or / test even
if it doesn't exist it will rear out you
so we can get rid of that guy and they
require routes you can require in there
okay so that cleans it up a little bit
one thing I do want to do is add an
editor config so I'm going to make a new
file and say this is dot editor config
and if you've never heard of it it's
just editor config and you can install
applause on for whatever you use I'll
just copy this here
all right oh by the way that was editor
config dot what was it org okay okay so
what you would do is you would install a
package in sublime and say editor config
but I already have it installed and I
want to move this up I want my
JavaScript to be two spaces and you can
do this how you like I'm going to do
this with CSS fast less HTML handlebars
and what's the other one HBS okay so
then this should always tab whatever
files were into two spaces so for now
that covers what we want to do with
sessions what I do want to check is the
terminal or the console so ctrl shift I
and it looks like I'm under application
refresh and go to cookies at localhost
and I have just a connect ID and for fun
let's try to do something make sure
everything's fine and dandy and index
will say on request that session the
count plus equals 1 okay so now if we go
home refresh refresh and this doesn't
look right there supposed to be more
values
oh I didn't reload the server I hate
when I forget that refresh refresh okay
well that's odd I'm going to clear all
refresh I get a new cookie oh yes but
it's supposed to be under there I will
only creating sessions all right we're
not going to worry about that right now
because this video just got really long
we'll fix that and everything so we'll
continue from there and just make views
probably for the next one</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>