<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Stagerless Meterpreter - Metasploit Minute | Coder Coacher - Coaching Coders</title><meta content="Stagerless Meterpreter - Metasploit Minute - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Hak5/">Hak5</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Stagerless Meterpreter - Metasploit Minute</b></h2><h5 class="post__date">2015-05-25</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/VEGj-SaLfu8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Metasploit minute is brought to you by
viewers like you
if you get value from this show and you
can spare even a dollar please consider
contributing at Metasploit minute comms
welcome to Metasploit minute the
breakdown on breaking it I'm your host
Rob fuller but you can call me Moving's
today we're gonna be going over an
awesome addition new addition to
Metasploit the stage realest interpreter
okay so when you say stage realest
meterpreter that implies that
meterpreter is by default staged correct
what's staged mean well we actually went
over this a little bit in season one
actually which doesn't it doesn't seem
like a long time ago but it actually is
a little bit so staged payloads what
happens is an initial connection the the
little piece that gets sent over in your
exploit or in your binary is very small
and all it's designed to do is make some
kind of connection back to you so that
it can get its stager or staged stage 2
basically so it's like setting up it's
like you know you send just enough to
kind of clear some area and download the
rest of the payload right and it's
actually it's very interesting and very
important to remember that your stage
and your stager so the stage is the
thing that goes over initially and your
state your your actual stage your second
stage are completely separate threads of
execution so you can actually have your
stager make a connection back to your
multi handler and then have your multi
handler set in a stage that's actually
pointing somewhere else right so you
could have I mean if you're working with
a team this makes a lot of sense if
you've got one box that what it's doing
is you know trying to pop shells and
inject you know whatever if it's a it's
a remote code execution or something
like that which showed last week it
could be sending the stager and then it
could be then connecting to the you know
the mothership ready to actually get its
expletive goodness on right so how I use
this in in quite good effect on on
fishing is I'll have a website on one
spot right so that website is where
they're all connecting to for the
wait then I'll have the binary that or
the jar or whatever I have executing
over here and when they pull that down
that executes and that's the malware
that the reversers are going to look at
so it's going to connect to my first box
and my first box is going to then send a
stage that says hey I'm actually
listening on IP over here so their
malware they're gonna see this that
makes so much sense right so then they
block this and I don't care right
because if I still have shells right
because if this okay so the stager is
like pointing over here but when it
downloads the rest of the payload that
one is pointing something there
completely different and exactly it's
running in memory right and I can't see
so you know machine reboots do you do
forensics analysis you get the binary
point one they block that IP but I still
have the session right and you say that
they actually both run in different
processes so that's not different
processes different threads different
threads and you can do pre pin migrate
there we go I'm saying tying it all
together okay cool so I staged your list
version of meterpreter right so the the
benefits there is the biggest real
benefit is the fact that you can bundle
everything together into a single
executable or a single mostly executable
because exploits normally won't have
enough space when I say space the 73
kilobyte file that is generated with
meterpreter in it by default is tiny the
deals that are loaded for all of the
functionality that goes into meterpreter
like so like a kilo there every time you
use a payload every time you load an
extension loading extension right yeah
that's it it's got to load those into
memory and it's like transfer those over
right and that turns out to be like
seven MiG's if you if you start loading
a bunch of stuff in there like incognito
Kiwi maiming cats all that functionality
that you're loading in there it makes
sense right if I'm using say like a
keystroke injection or something like
really tiny I want it to be as small as
possible which is actually why I like
your PowerShell w get neck acute for the
USB rubber ducky because it's like plug
it in and you want it to take as little
time as pasta so that's kind of an
example of a stager in fact right in
fact that could probably be then used
to download your seven meg stayed your
list why not okay
right so we're stage realist comes in
into big play though is something like a
satellite shot or third-world country or
something where the bandwidth can not
handle the seven MiG's that are going
over the pipe initially right so let's
say that you have a one time executable
that you don't want to have anything
seen on the wire going over so let's say
that you have SSL decryption on on your
proxy and you have all of these things
that are IDS's we'll look through well
in in Metasploit if you do a staged
payload that SSL is is automatically
decrypt ovale because it's a self-signed
cert that that doesn't really check them
they're actually adding some checks into
there but which is awesome but not right
now
and you'll see the Met serve DLL being
thrown across the wire well if you use
stage your lists there's nothing being
thrown across the wire except for the
one connection right so the only thing
that's being transferred now the only
activity on the network is just you
communicating with your reverse
interview oh wow and so then you can set
it up with your own like what you
transfer your own encryption keys to it
can you well the package your payload
with your own custom crypto so that it's
not like a self-signed thing yeah yeah
yeah you can actually do so what we're
gonna actually we're not gonna go into
that yet we are gonna go into actually
building the stage your list payload
okay so I also just realized that this
makes so much sense of you're like say
gonna put it on a disk right right
because if you're just gonna like
remember when CDs would come in the back
of magazines and stuff that kind of idea
right so we already have our errors
handler from before from the other
segments and so we're gonna just
piggyback on that so set Paila or not
set use payload windows meterpreter now
if you if you notice anything different
here if you have an updated version of
interpreter or updated version of
Metasploit you'll notice that when i hit
tab complete it didn't give me another
/y oh because there's more than one
meterpreter is because now there's an
underscore matter per and we talked
about this in in the pain
section where if there is no extra slash
that means it's staged non staged or
singles oh so it begins with an
underscore so let's go ahead here and
you'll see that the anything with a
slash means that this is the stager
right and that's the stage right so
stage or stage and then we go over here
and we see that there's no slash on
these underscore underscore underscore
underscore right now so we put an
underscore here and now we have all of
the available stage or lists hey you
know what that's actually as far as file
naming conventions are concerned that's
kind of brilliant because it means that
when you hit that tab to autocomplete
then it's just like underscore and hit
tab again and now you've got all of the
you know that you're looking at the
stage of this person so we're gonna use
reverse TCP and the crazy thing about
this is that since this is still the
same reverse TCP connection we can still
use the staged handler oh yeah that's
interesting because it's because it
doesn't care I mean what it already know
it's like hey I'm listening from
interpreters I don't really care so
you're stage-door so it makes one
request to make to get the stage down it
makes a completely different request to
make once it's staged so it just skips
this part that's rad so show options and
these will be the exact same options
except for some a couple new ones the
extensions so this is actually where we
get to load in whatever extensions we
want to wrap in there so we don't have
to do them all which is great so if we
know that we're not going to use the key
we extension we don't load it on it
right so you definitely want the
committee cats once toss that guy in
there okay so it's that extension
extensions instance so we're gonna type
in you know we want standard API right
yeah we kind of want that one we want
extended API cuz that one's awesome okay
and we're gonna throw Mimi cats in there
thank you and yeah we're good there yeah
we don't we don't we don't need to make
a giant interpreter right so that's it
it's just comma separated and we got all
of our other options in here
type generate t4 exe or type nuke cf4
file temp bottle hunting - it about to
dot exe and you notice the size on this
Hey Hey look at that seventeen Meg's
it's pretty big or not seventeen Meg's
one point one point seven one point
seven one point seven okay hey that's
that I mean that's not too bad right
it's still pretty still yeah it's not
something that you're gonna be sending
over most like posts so we get into our
thing we upload PWD so upload camp Bob
Bob - oops - Bob - I'm gonna take a
second this is really fast because it's
all rifle a local right and then we
execute hf2 dot exe and it says standing
stage but it doesn't so that actually
doesn't happen okay so we have our
ritual procession - you'll notice that
as soon as it sends stage it was
automatically like right so if you do
sessions now and see what you've got
list those guys have number three there
we are now if we do three and we do a
question mark yeah you'll notice that
the ones you've no so this is one one
very important thing so even though they
are loaded so you'll notice that privat
is loaded that actually got thrown over
the wire because we didn't select it but
it doesn't show the commands that we've
already that we said what we wanted
there are many cats doing I don't have
to you have to load mini cats but you'll
notice that it's fast oh okay so it's
like already there it's local copy right
because I'm already there set so does
this mean now that if I forgot to add
some extensions that I wanted I can then
later of course you can write because
it's using the same session it's using
the same four four four four that we're
expecting whoa
that's rad it's really cool okay does
this though for example mean that since
it doesn't need to wait for a handler to
be listening to send the rest of
meterpreter because it already has all
of that
about it once at that time at least does
that mean that if you don't have any
handler running that it will just keep
waiting until you do and that's a short
so you want let me show you something
very important if we go back to our use
exploit multi handler we talked about
this briefly in one of the segments but
I'm show advanced so there are a couple
whoops I have to set a payload sorry so
options set payload to Windows
meterpreter or CCP so advanced so it's
HTTP so in the HTTP payloads or HTTP
videos there are two really awesome
settings the session expiration time out
okay and the session communication time
out the session expiration time out says
this meterpreter session will die in X
number of days so the oil minutes
actually so six sixty thousand four
eighty one or four hundred eight
thousand is like a week seconds sorry
and the session communication timeout is
three hundred which is five minutes five
minutes right so so listening within
five minutes but you're toast but the
problem is with with a staged payload
with a States payload it has to
communicate back to a handler to get
these settings so so we can prepackaged
these right so if you set these settings
in the state your list one two something
much higher it's gonna try and
communicate forever you can put a zero
there you could end these since these
are just Advanced Options it's just set
set specifications timeout nine nine
nine nine zero zero perfect it'll try
and communicate so this setting in a
stage airless payload we'll continue to
try and canary for at least a week and
unless you change this expiration time
out to something long right zero right
but if something happens to you so your
handler will keep going right but if
something ever happens to you move X and
and your meterpreter sessions are always
trying to phone
back home to you that could just
heartbreak live on I'll live on through
my handler you will in fact yes
yes that is pretty wicked and I totally
see the power now of lazy it's a deal
yeah and huge things to oj the guy who
actually made this happen inside of
Metasploit yeah so many cool things are
happening with this framework it's
awesome to see this evolve it's awesome
to see this show evolve right yeah and
so you know what we do need to thank our
epic sponsor because this show would not
be made possible without you guys and
that is and it's am I'm saying this is
so proud and and I'm just beaming right
now to tell you that the reason the move
makes is sitting right here next thing
it's because of you guys
supporting at Metasploit minute comm
that's where you can find the links to
all the ways to support including the
patreon patreon comm /mu bik's you join
up you you know if you find some value
out of this and you can give some value
back so you can be a mu bixie remove X
or you can be i moving say hmm let us
know let us know what that might be you
can leave those in the comments or you
can email MSF hak5 org we really value
all the great feedback that we get all
the awesome comments we read all of it
and it really shapes the show too
because if there's something that you
want to see we'll put it into a future
episode definitely definitely and like
the fact that season 5 is even happening
is such an awesome thing is it's because
of the patreon supporters patreon these
people we haven't figured that oh yes
patrons the patrons the fact that I'm
here the fact that I'm doing this is
just so awesome to be a part of yeah and
you know what we want you to be here and
be a part of this we want you to be pen
testing with hak5
because that is our new course that we
are launching and we were very excited
June 6 this is the date and the physics
20:56 is the date and we're very excited
because it means that we are opening our
home and letting you guys into the
warehouse and we want to be hacking with
you so pen testing with hack 5 is where
you can come and
get all of the hack five arsenal and we
will equip you but not just with the
gear not just with the Wi-Fi pineapples
and USB rubber duckies and all of that
but with the knowledge to be able to use
those in a practical setting and it's
myself and mu bik's and sebastian four
days of hands-on training so we're very
excited to be launching this and because
we are launching this and we're super
excited that Metasploit minute viewers
who you guys are getting something extra
special so basically if you're a
supporter you're going to get lots of
warm fuzzies and massive discount right
now just so hack five org slash training
hopefully it's not sold out by the time
this airs we're gonna have it if it is
we'll keep adding seats but I'm gonna go
find out more to some more courses but
you just start putting people on the
rafters if you want to hang from rafters
at the hak5 warehouse oh my god Rob this
has been an awesome season I'm very
excited about this and now I just want
to start crafting stage your lists of
interpreters that never die never yes so
awesome and the functionality is great
so and and that's really it for this
episode so I'm lumix and I'll be hacking
to the costume oh thank you very much
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>