<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Making Your First POST Module, PART 2 | Coder Coacher - Coaching Coders</title><meta content="Making Your First POST Module, PART 2 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Hak5/">Hak5</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Making Your First POST Module, PART 2</b></h2><h5 class="post__date">2015-04-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/85TBguij620" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Metasploit minute is brought to you by
viewers like you if you get value from
this show and you can spare even a
dollar please consider contributing at
Metasploit minute calm
welcome to Metasploit minute the
breakdown on breaking in I'm your host
Rob fuller but you can call me movies
today on Metasploit minute where you're
gonna be going over the post module that
we already did and we're gonna just pare
it down into something actually usable
and repeatable and unfortunately not
just pervy you know that's the
unfortunate thing is well scripts are
awesome for doing things very specific
and targeted to that one host and at one
time that one time we want to make
something that anyone can use to change
the windows wallpaper to not just photos
of my cat but use your imagination and
you'll be able to yeah there's a lot of
stuff that you can throw on someone's
wallpaper on especially on April 1st oh
there we go so let's just dive right
into the code then huh right so we are
already in our post module we already
have it loaded like like our last
episode we already have a session that
we can pointed that and we are going to
go into it and start paring it down
so the first thing is that we can start
removing is this we don't need to do
session equals client anymore so let's
remove that we don't need the that and
move this stuff over just to be just
make it pretty
right so I'm gonna move everything over
yeah yeah as you've been gonna say like
that looks pretty hard coded slash roots
that is burden that we're gonna start
removing that stuff so one of the things
that we need is we need a BMP a location
for that bitmap file so what we can
already do is based we can remove based
completely that's gonna be gone all
right we're gonna I want to show how you
can use that later just remember that
based was our path locally on our
attacker machine of where our bitmap was
gonna go and this wallpaper we're gonna
name it Kirby dot BMP for now now let's
let's remove that too so how we're gonna
remove that and why we're going to move
that is because we are going to actually
add another variable
scroll out so we can actually see this
called opt string and this is just
basically a string that we're gonna have
it so it's going to be called on the
actual target host so we're gonna call
it what would be a good name for the
wallpaper
well name and I'm sure you guys can
think of better names for these things
this is a variable called wall name
alright so then we're gonna set the
default to true because you're gonna
need let's set it to false for now so
this means that you don't actually have
to set this variable so if so we'll we
have like a default where if you don't
pass it that it'll make it Kirby because
you didn't give it a value perfect okay
so you know what we're gonna do is say
name of wall paper victim and you what
you could do there is so so you're
saying that you don't even need to like
actually like print out all of that
stuff it knows that since this is a
variable that you can set when you do
show options it's going to tell you this
is the help for it
yep so when you have show options like
here's our here's the actual thing that
we had here path to file to upload and
set that's exactly what it says right
here dad that's kind of RAD yeah
so let's see what you're saying about
like you know as opposed to a script
that post module just makes this too
much so much easier right so we've
actually removed three lines already
right so we're pairing this down this
key it's just a to KCU so we already
have this here we're gonna actually
remove that completely we don't need
that and this is a nice note for us the
base I'm gonna scroll because you mean
just a bit so this base is we're gonna
just keep this here for right now
just because it's good knowledge to keep
and the bgcolor
that sets the actual background color
later on
it actually doesn't look like it does
ever so we're gonna just remove that for
now goodbye refresh command we're gonna
keep this here but we're gonna replace
it later okay
so refresh command that's normal that's
going to stay there and the delay I
don't think we needed delay for anything
upload image alright so this is where we
get to start having fun so this client
FS file path expand path stuff is great
but there's actually easier way to do
this so what I'm gonna do is I'm gonna
grep through the modules directory and
the post modules and I can even go into
Windows let me let me zoom in a little
bit there so you guys can see you so
inside of there we're gonna grep for
expand just so that we can find this
stuff and there look there's expand path
boom so no client file stuff we can
actually just go whoa goodbye save some
space right now we don't now we've got
that expand path there as well and how
you can find that find that out without
having to do all that stuff is you can
go to Ruby doc dot info / github slash
rapid7 slash Metasploit framework MSF
post and inside here you get to see all
of the awesome post libraries that are
available so you have file and then
Windows you can span expand out LDAP
PowerShell prove process rail gun
registry all of this fun stuff yeah
these are all of the ones that you were
talking about where you added them it
was what colon colon registry and colon
colon yep file so the file one lets you
what I guess manipulate files and
registry one obviously that in a very
very
cross-platform way so I wears with the
with the Metasploit scripts or the
reverse scripts I'd have to do that
uniquely for different types of stuff so
if I get a command shell instead of
mitre procession I have to figure out
how to write a file
with that right so I have to echo it
whereas with this it's going to know
that it's a command shell instead and
run that code it that's wicked so this
is where you can find out more about all
of those scripts are all of those
methods
hooray for documentation right so
there's right file okay let's keep let's
keep that in mind
for right file but so we're going to get
a temp directory expand timpz random
let's just keep that that creates that
makes a random value for our temp
directory leave that there
I thought we removed some of this delay
we did oh this is back in set wallpaper
okay so that's their refresh command so
we're going to tab this in so that we
know that we're all done with that print
status and the cool thing about this is
you can actually do V print status which
means only in verbose mode so if you
want a lot of stuff to be printed out
it's so cool yeah so this way you can
have it so that it's very minimal unless
you want more right that's rad
all right so then we have client make
der that I think you can actually pull
this down to make der but I'm not sure
we can just leave that there for now
and we type in session instead because
we got rid of so clients gone we're
gonna just use session and we're gonna
change this to a V print just so that we
only do it when we want to file new so
this is the right file look at this way
too much stuff right so you've got big
two lines three lines three lines and
all they do are upload a file right so
what we're gonna do is we're gonna
change this to write file we're gonna
keep that quote we're going to kill
remove that and that based is there so
we gotta make sure what we're gonna do
is is get that temp directory instead
right so kill that and that right file
is going to work
and we're gonna just you know what
that's not gonna actually work so it
needs let's go back to the documentation
so right file needs a file location and
then the data or the file name in the
location and the data so that's not the
file size we don't need the file size
anymore all right
so file read based so this this column
file is reading from local that's Ruby
built in scripts so that is actually
fine and what the base is what we're
gonna use and we're going to say instead
of this we're going to use data store
BMP so that means it's going to read
from our option that the user set and
the VMP okay so that and then what we're
going to need is the actual location
we're going to upload to so what we're
gonna which and we had just created that
that Randolph directory well-known oh
yeah the random directory plus the wall
name right so we're gonna go back over
to delete user cuz this has a really
cool little thing in here where it says
if something's set mmm-hmm right delete
user using target server question target
sir yeah it's that question target if
target server does not exist target
servers nil then oh so we're gonna use
the same thing here or and we're gonna
say if wall name and then if question
mark wall name is Kirby right so we're
gonna go back up here paste that in
and what we're gonna do is say tempter
equals oops not tempter TAF and just
name it path path there equals datastore
all name and then if data store name it
makes it meal we don't want what you
know we want
we want it to be curvy right right yeah
no we're just gonna go ahead and make it
Kirby Kirby BMP right and then this way
we just couple that bitmap file with the
post module yep yeah
so we then put in here so this file
right is path temp der plus path that's
it so so right file right file is it
alright files it so to do to do in this
path we're gonna actually need so yeah
we might need a couple slashes in there
but we can do testing with that sir okay
so then then we set this registry key
that likes that nice cheese why not can
you just pass it a dot reg and have a
execute that means that doc he waited if
it uploads a file then then executed
command I don't like executing commands
and this list down here this session dot
sista process if we go back over to the
post modules over here you can see that
Windows apps under sis I'm sorry where
is it it's not in there anyways it's
somewhere else so I'm going to scroll
back out so this is not a very good way
of doing things because it didn't work
in RDP it's it's a registry right and we
can actually keep this set Val stuff
because it's actually part of the final
registry stuff and we can we can keep
all this but I don't like to like I want
to make it even more useful so what
we're gonna do is remove all all of it
like all of it and the great thing is
that I found this awesome little thing
over where is it these scripts this it
was a it was a Stack Overflow post okay
a couple just a couple of years ago that
says that you can use a system
parameters info action it's an API call
to actually set the wallpaper and have
it update automatically so what I did
was I pulled out
registry I'm not the registry I pulled
out the railgun call for it so system
info and I think that's an a so session
not railgun that user 32 that's system
parameters info I'm sorry and if you
remember from from our railgun episode
this is basically calling the windows
API call directly from Metasploit from
inside of interpreter so this 20 0 and
then Kirby was actually from that script
so you can see that 20 s is set desktop
wallpaper 1 and 2 equals 3 update I and
I file and send when I and I file
changed this actually sends the update
change and you can see that in their
their script this is a PowerShell script
it actually put adds these together
that's why I get a three okay so you're
just taking advantage of that I'm adding
so if you actually submit this to
Metasploit they're not gonna like the
hard-coded values right they're not
gonna like the seek or the 20 of the 0
the 3 you have to explain what those are
but for our sake for now what we're
gonna do is just hard code these in for
now and then we can make variables out
of them and explain them later if you
want to alright so this does say sequel
and template this but what we're gonna
do is say just like we did our write
file
Tim dur plus path nice ok and that
should be it so our 45 line script is
down to 1 2 3 4 5 6 7 8 and cuz that's
actually the part that's doing this
stuff everything else is just making it
pretty inextensible yeah but anybody
else can like change the options and get
verbose output and things like that
yep niceties yeah and there's so there's
actually two outputs for just text so we
actually have only 6 lines that we
actually have to do this in so let's see
if we they actually work so reload
when you lose the module to see if it's
actually works show options
there's our BMP set BMP to route Kirby
dot BMP set walnut yes you want to set
the wall name or not I mean does it
matter it will upload it is created way
yeah so either way we went okay so and
you can see that in the required
instruction it does say you know it says
no so we don't have to do it let's not
do it alright set our session to four
because that's the session we have it's
just verify even sees every module now
has a verbose setting so now you can see
that our verbose is set to false so it's
not gonna actually show those outputs
yeah fantastic so we could actually just
do that globally and see the verbose
output for all of our stuff right that's
pretty wicked
so rerun let's go back over to our RDP
so we can see the change start Kirby oh
no oh it's a variable unknown wallpaper
so where did we use wall means the word
wallpaper somewhere aha we used it in
the print status for uploading wallpaper
all we can do is say I'm just gonna
upload wallpaper I'm just gonna need a
wallpaper so it didn't know what
wallpaper was because we left that from
the script previously and we so we're
gonna rerun it again go spawns will
completed and it did not work
hmm so let's see where where that file
went so we go into temp and it should
have created a random string name
somewhere let's sit provost
so that's so that's the file so there
are you H so we're looking for that
scrolling are you H ah this is what's
actually is because you're adding the
path and the wallpaper name but it's
concatenated them instead of making that
with the slash right so what we're gonna
have to do is very simply just say that
let's scroll into the narrative zoom
into that so plus right back so then we
do that over here too and this isn't
great coding you should actually set
this somewhere else but now that we know
that that's the problem
and that's what's great about what's
great about the you know verbose versus
not reverse and you can set things to
kind of be debugging if you want so
we're gonna go back over here and we're
gonna close down that movie it actually
works that's fantastic no logging out no
logging back in and our script is down
to six lines of code technically yeah
right so that's awesome
and now that you see the power of post
modules right so we have the ability to
set the wallpaper name on the target we
want so we don't have to have it Kirby
BMP if we don't want to or the BMP and
and we could actually make this into a
much more plus top post module yeah
fleshed out totally get that I mean if
we're gonna change colors and all that
right yeah we could even submit this so
that everybody can enjoy the the wonder
that is having Mike on their desktop
that's really epic I can't wait to hear
some of the comments from this stuff
because you've basically taken a script
that is specific to one host and now
made it so that anybody can use it
across whatever hosts and where can
people do that
where can people leave us feedback at
Metasploit minute calm or on our youtube
channel or they can email us msf
hak5 org and I do want to say you a huge
thank you to Victor and Jacob four plus
one unit two for this for this module
idea it's great I loved getting back
into the wallpaper setting it's awesome
yeah and I have someone to just you know
mention to everybody that's like
enjoying the Metasploit minutes as they
are multiple the multiple minutes that
you know there's there's a very simple
way that you can support the show to
make sure that it continues coming
directly to you and that's really simply
by going to patreon.com slash move x mu
b IX or you can go to Metasploit minute
comm and find all of the options so that
you can subscribe and you know support
the show and I just have to say that
it's really heartwarming to see that
here you are in the you know the high
five warehouse making more shows season
five is alive yeah because of the
Patriots it's awesome fantastic so let's
continue to make this happen
yeah yes really appreciate all that all
the support everyone's giving me for
this show it really it's really awesome
yeah and then humbling and you know if
you want to get even more hands-on with
Metasploit mu because going to be here
you're gonna be doing a little bit of
training sometime in june right yes june
26 that is our inaugural show it is our
very first training seminar it is what
we are lovingly calling pen testing with
hack 5 so if you're down with pen
testing if you're down with hack 5 come
on out sign up you can find all of the
ways to get that hack 5 org slash
training and that gives you 3 days with
3 epic instructors including muak seer
so that you can learn all sorts of stuff
about hack 5 gear learn wireless that
you know auditing with Wi-Fi pineapple
you can learn social engineering with
USB rubber ducky mountain break into
stuff break into stuff yeah i learned
some Metasploit it's going to be epic
you can find all the details and all the
course description on all of that stuff
over a hack $5 training but wanted to
clue you guys in on this because it is
the first run and so very special
pricing especially for our Metasploit
minute fans
so yeah imminence eating yes we don't
warehouse is big you know it's it's
it'll look it'll look a lot nicer
it's gonna be pretty epic so yeah I
check that out so thanks a lot and when
i'm rubik's and i will be hacking to the
cows come home thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>