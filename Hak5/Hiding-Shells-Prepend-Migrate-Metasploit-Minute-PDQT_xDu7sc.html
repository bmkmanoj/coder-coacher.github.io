<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Hiding Shells: Prepend Migrate - Metasploit Minute | Coder Coacher - Coaching Coders</title><meta content="Hiding Shells: Prepend Migrate - Metasploit Minute - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Hak5/">Hak5</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Hiding Shells: Prepend Migrate - Metasploit Minute</b></h2><h5 class="post__date">2015-05-18</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/PDQT_xDu7sc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Metasploit minute is brought to you by
viewers like you if you get value from
this show and you can spare even a
dollar please consider contributing at
Metasploit minute comms
welcome to Metasploit minute the
breakdown on breaking in
I'm your host Rob fuller but you can
call me Lewis today on Metasploit min
we're going to be going into a really
cool feature called prepend migrate so
we're gonna pretend it to migrate what
now prepend migrate so prepend migrate
is basically in addition to a payload
that happens before the payload happens
so what it does is it prepares a
migration you know that black guys are
we got about a couple episodes back how
if you're in one process and maybe you
want to be in I explore that exe because
you want to capture keystrokes the only
internet explorer are seeing with the
key logger you would migrate over to
that process so prepend migrate right I
mean before you execute the payload
right so let's say that one of your one
of your targets is Internet Explorer
vulnerability okay and we've already
talked about how rare that kind of is on
real tests
but let's say it is and you want to you
want to get out of that process as
quickly as possible what if you're not
around to the console to do that then
they close the browser and you've lost
your shell bad right yeah don't want
that to happen
well what pre-paint migrate does is it
actually migrates out of that process
that's crashing because of your exploit
right and then gives you a shell from
wherever it goes nice because you know
because again this is just like you know
the why you need persistence in multiple
different you know processes and had
your bets in that sense because yeah
processes are gonna hang I mean that's
what exploits do like your computers
like you know right yeah so the cool
thing about this is that it's not just
singularly useable in exploit
possibilities right so prepend migrate
is great for other things as well so
let's say that you
want to have persistence and want to
migrate out of that process that you
have persistence is first that way they
when they delete or stop you or whoever
is looking at it right kills your
connection that executable is still
there the and your you're just getting
killed in notepad or something way so
walk me through that you're saying that
before you even start the the reverse
shell or whatever have you whatever you
exploit you've chosen okay so let's
let's let's say that I have a
persistence method where I'm dropping a
binary I don't want them to find that
binary okay right so what happens is I
have prepend migrate in the pot binaries
payload that I'm throwing in there oh so
that run its runs it actually going over
here into another process and making the
connection so then go ahead and delete
Bob dot exe because it's not going to
matter right or no Pat dot exe or
whatever you want it to write migrate
into nice right so they're gonna see C
colon windows system32 notepad.exe
connecting to wherever the which it
normally doesn't do but um so you said
that this can be can this be used for
more than just exploits is this just
something that you use do you like use
this and then pass it the name of an
exploit and then all of its settings you
know so what I mean by that is is most
people would think of it as is migrating
out of a out of a crashing process you
know what I was trying to say is that
you think a little broader you can think
of it as a persistence method as well
yeah right so well we're gonna take a
look yeah what we're gonna do is
actually we already have a meterpreter
session treated so let's just say that
we want to and the only reason I'm doing
this is so that I can upload the file
easily okay okay I've already got a
session right so background I'm gonna
use payload windows meterpreter reverse
reverse TCP and we're just doing that
for ease of use and so show options
shows our basic options if we do a show
advanced and we already covered show
advanced in the past we go up to here
and there's prepend migrate
we set that to true and it'll spawn and
run shellcode in a new process but that
new process is going to be run DLL 32 by
default however if we go over here it
says process to migrate she'll go into
prepend migrate process so what do you
think it's a good set of options
definitely turning that to true right
sure a pre fin prepend migrate to true I
got that now does it have do we have to
then say show options for pre pen
migrate or no can we just you know give
it the name of an executable or DLL that
was reprinted migrate proc svchost.exe
oh that's a good one
yep so now if we set our options
correctly RL host to 172 said RL power
we're gonna just you know set l port to
you know ad a no can't do that because I
already have something listening all you
181 I actually think I have
let's do jobs V and there is my where
it's already listened to our for for so
you know what let's just keep it that
way so let's set our L port 2 4 4 4 4
and then we type generate and we've
already been through this we really have
so exe file to temp dot exe wham bam
dunk sessions si 1 upload so now we're
in a mortar prayer and we're gonna go
ahead and upload this and execute it
yeah we're gonna go into temp upload
throw it in there
okay now we've uploaded bob dot exe
we're gonna do a process list and in
this process we're gonna see that there
is a bunch of SVC hosts as there usually
are right but there are no SVC hosts and
then you can see as our user as the
standard user
we're not escalated we can't see see
this four to nine yeah you can ask what
were you getting the user from over here
so that column I see that's user there
you go and this is a good indication up
said this in past episodes but this is a
good indication that you are not
elevated past you eight
see so if you can't see other processes
users that means that those are usually
system or other users that you can't see
so what about those up at the top there
like WMI press c SE exe what user is
that probably system but it doesn't have
to be it just means that you are not
elevated enough to see it
anyways so we've done that we we've
we've uploaded it to see content so
we're gonna just execute it so you :
temp Bob dot exe okay so we see that
we're getting a new session and we do a
PS and Bob dot exe is still running so
that's one one thing about prepend
migrate is that it doesn't kill the
process okay so it's it's designed for
exploits that are the process is dying
anyway yeah so it doesn't try and kill
it as well but if we killed Bob dot exe
right now it wouldn't matter because
it's already moved over to service host
right
so kill three three six eight our
session didn't die that is really rad
so as you're running in service house
now yep you just might yet hence the
term you've just migrated over so and
you can see right here I'm gonna scroll
in there's our SVC host and it's wedding
is ourselves there there you go
that's it so we have our second session
and let's go into it let's go into the
second session and doing it that now if
you do that's that you can actually see
so we'll see it on port four four four
yep we'll see our connection and there's
svchost.exe it on four four four four
Wow
so that's kind of RAD but one of the
things that I'm wondering now is you
showed the option to do this process
migration by doing the show Advanced
Options right yeah does every exploit
have to have this or can I use this with
just any exploit so that's the amazing
thing about Metasploit right so
Metasploit actually separates payloads
and modules right so the modules can use
palos but
the the payloads can be anything and if
you're talking about a Windows payload
any windows payload actually has the
prepend migrate ability
so whatever Windows payload you select
it you know windows meterpreter reverse
TCP or a reverse HTTP or bind or
whatever you still get the awesome
ability of prepend migrate and is it
because those modules were written to
support it or is it just because it's
just the way the framework works it's
because the framework is in a sort of
fashion where you can just add more
things to it so what it's really doing
is is taking the payload and appending a
you know a prepending more shell code on
share sure that's kind of rad and I love
how is just like put into your Bob exe
yep yeah sweet okay I'm totally getting
how this can be just applied to social
minute games like oh and I just kind of
want to start stacking all of the stuff
yeah so think about it in persistence
like take a persistence payload and then
change it from from just a normal
service to a buying payload so now you
have you know the service starting and
then as soon as it starts as soon as
that executable finishes it then runs
your or before it finishes it runs your
new thing binds to a port and then dies
that service is no longer running right
so you can kill the service or whatever
officer and you have a buying session
going then you can connect into it and
it doesn't show if there's anything yeah
well can you migrate to multiple
processes can you prep in migrated
multiple times I'm sure you could but
there's no way in the man in his frame
work itself to do it maybe Chris at this
point I just don't like be a part of
every running process mm-hmm like a
scatter bomb yes actually that's
actually a feature request that I made
into meterpreter there we go maybe
that'll happen hey you know what if you
guys have a feature request you can send
it to for the show that is you can send
it to MSF at hack 5 org you can also
just leave a comment on the YouTube we
do really read all of this and we
appreciate those because a lot of times
they really drive what we're doing on
the show so I do have to thank you for
that
the first what five episodes of this
season has all been because of the
things that you were guys requested yeah
seasons five is also brought to you a
plea by our best sponsor ever you IQ say
this with all honesty it is just
heartwarming Rubik to see that you're
here because there are people all around
the world that love this and want to see
it continue and they say hey I see some
value in this so I'm gonna give some
value back and so I say if you're in the
Opera if you actually have that
opportunity to give even like a dollar
an episode that is huge because that
means that we can produce more shows and
more epic stuff is happening hit those
milestones where we get you know RSS
feeds and then downloads and then also
streaming and then even you know there's
a there's a crazy epic lesson that I
hope we can achieve which is free
training for a free trip free training
for all of the patrons and I'd be
awesome is kind of huge you can get
there we can and you know what we're
even doing our first ever training here
in the hak5 warehouse and it's a white
free though not quite free no but close
look close
no seriously like look at some of the
other training this is a very special
introductory because we are just kicking
this off and so we would like you all as
guinea pigs so that we can beta test on
you know uh we're gonna migrate your
processes in the details over a hack
five out or such training but June 26th
we're having our first ever pen testing
with hack five you know with us yeah
it's gonna be a lot of fun to like we're
gonna talk about all kinds of practical
application stuff where you're gonna
talk about SDR pineapple Metasploit like
ducky you're gonna learn like the
practical acts of stuff there's a bag of
tools that you can walk home with and
the knowledge and confidence to use them
appropriately not just giving you a show
but showing you how to use the show
there we go love it
so anyway I just want to thank you all
again for supporting this and allowing
us to make this happen because pretty
epic so again hack five dot org slash
training if you want to get in on that
well as supporting the show at
patreon.com slash mullux mu VIX yeah and
all the other ways to find out epic
Metasploit miniature AG and all of that
at Metasploit minute dot-com yep so
that's it for the show I appreciate all
of the support that we've get you can be
been getting for season five it's been
an awesome and I'll remove it and I'll
be hacking til the cows come home thank
you very much
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>