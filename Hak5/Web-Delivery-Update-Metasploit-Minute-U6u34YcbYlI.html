<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Web Delivery Update - Metasploit Minute | Coder Coacher - Coaching Coders</title><meta content="Web Delivery Update - Metasploit Minute - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Hak5/">Hak5</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Web Delivery Update - Metasploit Minute</b></h2><h5 class="post__date">2018-04-09</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/U6u34YcbYlI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">web delivery update this time on
Metasploit minute Metasploit minute is
brought to you by viewers like you
if you get value from the show and can
spare just a dollar please consider
contributing it Metasploit minute comm
hello and welcome to Metasploit minute a
breakdown on breaking in
I'm your host Rob fuller but you can
call me movies this time we're going to
be talking about an update to the web
delivery module now web delivery is one
of my favorites simply because it tells
you a list of commands that you can very
easily copy and paste into a high-five
rubber ducky or on an RDP session or
whatever and just get a shell and that's
really great so originally I showed you
the PowerShell version now there's also
been the Python and PHP that have been
there but we're going to show you some
of the new ones like register 32 and the
peach powershell binary version alright
so let's get into it so use dot star
remember that awesome command dot star
cuz it's regular expressions web
underscore delivery you don't even have
to finish the delivery all right so
options if I can actually spell write
options go up same stuff as before our
serve host is where we're going to be
serving out the file that it goes and
gets served port SSL a cell sort URI
path unless automatic and it
automatically gives us this Python
meterpreter
with a target of Python so if we show
targets we can see that now we have
Python PHP powershell and reg surf 32 we
also have powershell binary today we're
going to be using read serve 32 now the
awesome thing about register 32 is that
it's built in two versions of windows
pre
our shell so sub T or Casey Smith online
he may he found out that this command
actually has the ability to go out to
the web and pull things down and then a
module
came out of that which is now
discontinued because it's now built into
the web delivery so we're going to use
that and we're going to set our target
to three now our payload is wrong so we
have to set payload to Windows as soon
as it figures though meterpreter reverse
HTTP now I'm going to use that because
what I'm going to be doing is I'm gonna
actually be generating everything here
on my local Kali box but I'm gonna be
sending the shell somewhere else so
let's look at this so what I'm gonna say
is sort of host is fine I'm gonna say
port 8080 is fine why not
we're gonna set our URI path just
because it makes it easy path to slash
Bob set our L host to our listening host
there on the intranet set L port to 443
because everything is allowed out over 4
4 3 that should be good enough so
exploit says it's listening handler
failed to bind that's because this host
that I have doesn't actually have that
IP address that's a kind that's fine so
this is what we're going to be
connecting our victim to so this is what
we're gonna run it's a Windows signed
binary that if you have white listing or
whatever on your system or the target
that you have it still will run because
it's signed by Microsoft the commands
here or what subti actually identified
and the eye lets you run SCT file now an
SCT file is basically a little bit of
JavaScript inside of an XML file that
can basically run anything jscript we
can look into that by just hitting it
locally so I'm gonna start up a new tab
and I'm going to curl my local IP
192.168.1.1
- our port 8080
Bob SCT and this is it this is all
that's in there so this XML scriptlet
then a random program ID a class ID and
the script tag which is ActiveX objects
W script up shell now many of you have
probably seen W script up shell in in
hak5 episodes with the rubber ducky it's
very commonly used with any VB script to
run a shell command so what we're
running in here is actually just
PowerShell so this is not actually
compatible with older versions of
Windows the SCT this register 32 that is
and you can have it run whatever you
want however this module itself because
it's running power shell doesn't get
that backwards compatibility as well as
what's available for register of 32 so
we can copy this out we're actually just
going to copy this and put it on our web
server so here's our little web server
we're gonna make a web server directory
I know you guys like everything else but
like Vai and stuff but Arman using nano
insert that file all right so we go back
to here and see that it pulled the web
delivery we go over to our curl session
and notice that it's pulling down
another file so Bob we're gonna have to
host this as well and we're gonna have
to edit this file so let's go back into
Bob's SCT and go back into the
powershell that is downloading and give
it the correct IP address so that it'll
actually get there so it's going to be
external so we're actually taking a
Metasploit module and converting the
output of web delivery to something we
can use on the Internet if this will
actually copy and paste correctly all
right so that's Bob dot there so we're
gonna have to curl that again
with just the Bob now again that's more
PowerShell
this is base64-encoded if we look
through this this is actually converting
the powershell base64 right here from
base64 this block of base64 to a binary
decompressing it and running it with no
window so we are dropping a binary with
this module so it's not in memory just
so just so you know so we got to copy
this out that worked the first time
that's awesome
insert there alright now we have
everything we need for our web server to
start and we're gonna start with you can
do with python simple web server you can
do it with apache you can do with an
engine X you can do any web server you
want I'm just gonna go with a ruby web
server since I already have Ruby
installed here and it's just easier that
way I can pull it up and down it's a
single liner so here we go no Ruby - run
- e HT DVD port 8080 so now we have that
web brick web server going go back over
here we have our handler running with
the correct options just showing you the
options out here and now we should be
able to run this command on our victim
and get a shell on the server on the
internet all right we all have it all
typed out now we're gonna try and run
this thing and see if it works so what
how it's gonna operate is it's going to
go from the windows host it's gonna go
out using register of 32 automatically
detecting proxies it does all of that
inside of that binary grab our SCT file
run whatever shell script is in there
which is PowerShell then it's going to
use that PowerShell to go get another
script from our webserver and then drop
a binary and hopefully give us a show
we'll see how that works let's see and I
can't type worth a darn this is gonna
obviously so Reds SVR
that's better so nothing happened no pop
up no anything I'm going to fix this all
I can I'm gonna go over to our attacker
nothing's going to happen over here even
though we generated the binary or the
payload over here we copied it to our
web server so let's see if our web
server got anything no requests ah I
know where we messed up I bet some of
you are already pointing it out
port 8080 look at that still nothing
still nothing let's now check our web
server it got Bob SCT so we're off to a
good start
it got Bob got it for the PowerShell so
we're good there let's check our oh we
got a show alright now that we have our
show we can start looking around poking
at things see see what access we have
we're going to be running as whatever
user ran that script it's not there's no
escalation there there's no extra bits
there so it just ran that now like I
said this is running PowerShell twice we
can very easily edit that SCT file to be
whatever we want if we want to just have
it run add user or net user ad or
whatever this is great because we can
actually set this up as a script or a
scheduled task and say hey go get this
SCT file every hour and change what's in
that W script shell as much as we want
that's the beauty of this command now
there are more detection since the sub t
tweeted this out and and made this
really well-known more detections that
people see on this thing but it's an
awesome way for persistence as well so
what we're gonna do next is we're going
to look around and see what we're
running as on the system and see that
where we've made that binary and maybe
do some cleanup we didn't do much
cleanup when we talked about Metasploit
well three but we're gonna do it now to
see if we can kind of clear up our
tracks
all right so PS see what we're running a
it's gonna take a second because it's
doing the round-robin all the way out to
the internet and get paid for 20 oh
we're actually running this power show
so it didn't actually adopt a binary at
all that means we don't have to do any
cleanup that's amazing I didn't know how
this module worked I guess because I
didn't know what the basics d4 did I
assumed a lot and let's go back to the
basics c4 and I was totally wrong about
that yeah so look so it G zips and then
in memory string this is this is what
you get for not looking and reading
ahead of time but that's amazing so it
is all in memory it does everything in
memory it does still use PowerShell
which means it's not our backwards
compatible so you can still make those
edits if you want but well you learn
something new every day
so let me know what you think send me
your favorite in memory module email me
at MSF at hack 5 dot org and stay tuned
to menace wait a minute for more shows
like these and a huge thanks to everyone
who supports this show if you would like
to support the show directly go to
patreon.com/scishow bik's every dollar
goes towards making this show even
better just for you I'm very grateful
for your support so until next time I'll
try to be hacking til the cows come home
so let me know what you think
give me your hate mail send me</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>