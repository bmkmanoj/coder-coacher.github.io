<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Devious Fun With Impacket - Metasploit Minute | Coder Coacher - Coaching Coders</title><meta content="Devious Fun With Impacket - Metasploit Minute - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Hak5/">Hak5</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Devious Fun With Impacket - Metasploit Minute</b></h2><h5 class="post__date">2018-04-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/xUk9aSJz12U" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">the in packet library this time on
Metasploit minute Metasploit minute is
brought to you by viewers like you
if you get value from the show and can
spare just a dollar please consider
contributing at Metasploit minute comm
hello and welcome to menace white minute
the breakdown on breaking in I'm your
host Rob fuller but you can call me mu
bik's today we're actually going outside
of Metasploit shocker this is pretty
cool I've been using in packet for a
long time a lot of the wonderful tools
inside made by Beto he is such an
amazing guy does a lot of great work for
the security community and so I had to
talk about his tool because it's one of
one of my staples I always have it
installed alongside Metasploit and even
get pivoted through Metasploit so if you
haven't looked at it all the episodes
about pivoting or proxying stuff go back
look at those episodes see how you can
use Metasploit and in pack it together
and we're just going to be talking about
installing and using some of the tools
and examples inside of in packet today
so go back look at that then come back
and watch this so the first thing you
got to do to install an packet is get
clone github.com for Cesc or security
slash in packet it's pretty small
it takes few seconds and it's done so we
go into a packet the first thing we got
to do is actually set up install it so
python setup install that's going to
take a few seconds to get done now we go
into the examples now the reason why
these are examples is because this is
just a library you can use this library
to do amazing things I've had I have a
ton of scripts that I have written just
to use in packets amazing utility in
other ways that it has written examples
but we're gonna just look at their their
personal examples that you can get and
use yourself so it's kind of hard to
read but I'm gonna highlight this to see
if you can see all of the examples here
didn't really help but let's go through
some of my favor
so get 80 users it's pretty
straightforward so Python get 80 users
ad users now inside of inside of in
packet some of these are very basic
straightforward tools so get 80 users
basically where's the target domain for
user data now why would this be
important well if you have a username
and password you can do this as any user
on a domain let's look at what it gets
so let's follow the long Python get 80
users and we need to give it let's say a
target so domain using that's it it
actually queries the domain for you so
let's say we're gonna do sitting duck
because that's my domain
uber user and then that should be it
the reason why that's not going to work
is because it can't actually look up the
domain in this current set up because I
don't have DNS directly to it so I'm
gonna have to give it the DC IP and
that's 191 6 880 10 so that should work
but we can also give it a password of
the colon so let's give it this
amazingly secure password retro so it
can't find sitting duck because it needs
a fully qualified domain so that's hard
to see but you should be able to kind of
zoom in and see what we got but I'll
just walk you through what this is so
it's the name of the user the email
address the password last set and the
last logon so why would this be
information that you'd want that you can
get as any user on a domain a password
last set sort see you who that last time
someone set a password in 2001 or
whatever last logon see if they've ever
logged on their user name and their
email address so you can take all of
this with a single shell so you drop in
you pivot this through or route it
through a meterpreter session you run it
against a domain and then you pull out
every single email address for that
entire company that's pretty powerful
right so even if you don't do anything
on that pen test after that you have
every email address to then send more
phishing emails in alright so let's go
to the next script one of my favorites
is get SPN or get user SPNs so again
what this does is actually gets the SPN
or server service principal name of the
accounts that have those set up so this
is this is called Kerberos ting you
should talk to Tim Medan he actually did
a Derby con talk about this I I wrote a
few blog posts about this about Kerberos
ting basically what's happening is
you're pulling down a ticket then you're
breaking that ticket by attacking the
ntlm or the password inside of it and
then you are able to recraft it if you
want or just get the password of that
user now you have to crack it it's very
slow but it's pretty powerful when you
do so let's see if we this domain has
any SPNs
so we'll actually just change this part
because Beddoe does an amazing job at
keeping everything uniform we can
probably just change that so no entries
found that's okay this is just means
this just means that this specific
domain that I've set up doesn't have any
usable SPNs
now that doesn't mean that there aren't
other avenues of attack but with most
corporations if they have ever installed
mssql or a web server like IAS or
anything under a different user you're
probably gonna find SPNs and this again
standard user level generic user can run
this so let's look through all the other
ones see we got here um ah of course we
have to run secrets dump so python
secrets dump is one of my favorites as
well so let's just edit what we have and
we haven't given a target actually
Charles to stop so in in secrets dump it
actually needs a target to go against
this one I'm giving you a domain
controller as the dcpip but I'm not
actually
target so if we look and do seeker stump
- eh the target is actually a little bit
different than our normal target because
it needs a target IP or address or name
it also takes local so if you've ever
done dumping of a domain you need NTDs
it to do that or DC sync order a bunch
of different things I think we've
covered that if not we'll have to do
that again but pulling things out of
NTDs it has always been troubling like
you had to use like EDB things and all
these other different libraries together
and you have to do them one by one
whereas with with in packet you can pull
all that down do it offline and all you
have to do is give it some the Sam file
the security file the security of the
system file and the NTDs and it does all
the parsing for you it's great so we got
it we we definitely have two secrets
dump this thing so secrets dump and give
it a target so at is how we do the
target 192.168.0.1 the dcpip isn't
really important and there it goes so
it's looks for the registry it's in a
stop state it starts the remote registry
pulls down the Sam file via the remote
registry so this is not injecting into L
SAS it's not causing any instability
it's really great pulling the the
administrator password the guest
password now since we're targeting a
domain controller it actually switches
into domain dumping so it automatically
sees that it's a domain controller
switches into domain dumping and dumps
the domain as well alright it's done
doing that one of the things to point
out actually a lot of things to point
out here is that if there's any clear
text the credentials where it says store
in reversible encryption it shows you
the password that's set so no matter how
long it is if as a backdoor if you want
to say hey I'm going to set this user as
a reversible encryption now you have to
be a domain admin to get there to pull
that out so it's not really giving you
it's not really giving you any extra
access but if you have a way to get the
domain admin or dvdc sync you can set
another user as a reversible encryption
and then what you can do from there is
then have their clear text credential to
go other places so if they use that for
XYZ script or whatever you can you can
get into that it's pretty pretty devious
so if we look also in here we see all
the the Kerber are up sorry AES keys and
Kerberos keys if we scroll up a bit we
can see all of the other the ntlm hashes
for all these things the help desk they
I'm I'm a not an admin one of the
important things I want to point out is
this right here so I don't know if I've
talked about in the past or not but this
domain controller account can DC sync so
what we did just now is synced all of
the main controller domain passwords now
this is important because if I'm acting
as a domain controller I can do it again
now that password is really long and
complex and binary I think it's 255
character binary bits by default but if
I have the ntlm hash guess what I can do
let's just do this just to see so I'm
gonna take the ntlm hash and I'm gonna
finish this up real quick so let's go
like this let's say I don't have the
password anymore we need to say - H for
help we say hashes we put that in and we
say dcpip is 19 1 6 8 80 10 look up just
DC because the domain controller can
only dump so the domain controller
account can only dump domain hashes so
if you try to do it without just DC it's
going to tell you access tonight
so just DC and we do sitting duck info
for size DC and it was DC one let's look
at how to make sure DC one alright so DC
1 1 4x last dollar at 1 i2 that wants to
say not a 10 and you can see that it's
now done peeing the hashes of the domain
using the computer account the domain
controller computer account now once you
have that you have the domain computer
computer account it's gonna change
unfortunately it's gonna change every 30
days now that's a setting inside the
main controller you can tell it not to
change its password that's a thing
because the computer is what changes the
password so every computer on a domain
changes its password every 30 days but
you can tell it not to so one of the
things as a defender to look for is any
computer accounts that haven't changed
their password within the last 60 days
is conspicuous if you have any domain
controllers at all that haven't changed
their password within 30 days that's a
problem however as an attacker switching
gears if I have a domain content and I
have another domain computer account
they're not going to change their
password on the same day so if I have a
script that dumps it one day then waits
until the computer found our computer
account changes its password and uses
the other domain controllers computer
account to dump it and then switches
back and forth and back and forth you
can pretty much stay with domain admin
as long as you want and it's really hard
to tell because you're using the
computer the domain computers count to
do the syncing
that's how Active Directory works so
this time on Metasploit min and we
talked a little bit about the examples
of the in packet library and what you
can do through Metasploit with these
libraries because all it's doing is TCP
handshakes and stuff and we've already
talked about routing so let me know what
you think
do you want more stuff about outside of
Metasploit email me msf at hack 5 dot
org and stay tuned to Metasploit minute
comm for more shows like these and huge
thanks to everyone who supports the show
if you'd like to support the show
directly head on over to patreon calm
for cows Moo bik's every dollar goes
towards making this joke even better
just read I really am grateful for all
the support the next time until next
time I'll move expand I'll be hacking
til the cows come home</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>