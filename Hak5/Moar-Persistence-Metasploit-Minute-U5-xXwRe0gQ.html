<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Moar Persistence - Metasploit Minute | Coder Coacher - Coaching Coders</title><meta content="Moar Persistence - Metasploit Minute - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Hak5/">Hak5</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Moar Persistence - Metasploit Minute</b></h2><h5 class="post__date">2015-05-04</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/U5-xXwRe0gQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Metasploit minute is brought to you by
viewers like you
if you get value from this show and you
can spare even a dollar please consider
contributing at Metasploit minute calm
welcome to Metasploit minute they break
down on breaking I'm your host Rob
fuller but you can call me Moo vics
today on Metasploit minute we're
actually be going over windows
persistence or actually persistence in
general and this is this is a question
that was cursed suggested this is an
episode for suggested by Krista Phi on
the youtube comment on you go and say
yes we read every single one much valued
and it's a really good question it is so
we've talked about persistence in the
past a little bit half and one thing
that I was taking away from that I would
say is that I know that like many things
one is none similar to backups and two
is one right you're gonna need most slam
that in everyone persistency I know you
yes because that's going to be a really
huge bummer when you spend all that work
getting into a host and then you've lost
your connection and now you've got to do
it all over again right yeah you can
give me an example of like you know I
don't know maybe you maybe you do a
phishing campaign you gotta you got
somebody in the organization to click
the link and run the thing and now
you're in oh no
quick before they reboot or suspend
their laptop or whatever have you
right so persistence comes in a lot of
different ways right so and and it
really depends on what you want to
happen so persistence could be as easy
as adding a new user oh that could be
your persistence right so yeah when you
think of persistence you need to think
of what you actually want out of it do
you want to shell back do you want to
just enable RDP where it was enabled and
you want them to open you know like a
Samba share or something right right
well persistently be able to get to this
computer whether that's through the
terminal or whatever hire you you just
got to keep your mind open on those
things and that's where a lot of people
fall down right so many things that they
need to install something to get a shell
and I have a call back and
you just just got to take a step back
and breathe and say what does this
system already provide me that I can eat
leverage right so because if it's a file
server and what you really want access
to are the files then maybe the
persistence is like sending their
missions setting permissions and Samba
shares or something like okay so you
know what I think about persistence and
the whole idea that Y is to one and one
is none is because you know if policies
change on the firewall or the systems
administrator notices a funky process
they're not quite keen on should I be
keeping multiple different forms of
persistence because the network
environment it may change or because you
know the the computer environment may
change and I just like hedging my bets
when it comes to those so it for
Metasploit right now which is changing
so little think that this is changing
Railly Metasploit changes really rapid
that's really awesome
so like seven things are rapidly
changing right so the whole joke of so
uh well a thumbs up for terrible job so
the crazy thing is like this year I'm
actually I worked with and I was and I
was there was a rapid seven form that
was asked to fill out for any
meterpreter add-ons and I filled it out
with like 40 things that I'd like its
feature request but as part of that they
asked me to come kind of help you know
formulate things into story lines and do
kind of stuff like that one of those
things was like an ID for a specific
session so right now when you when you
have persistence pulling this back and
you do you run sessions
I got multiple meterpreter x' back right
but let's say that you install 30
different persistence methods that you
have all this crazy stuff you're going
to get 30 sessions and right and you're
not going to know where this levels are
and if this is Bob or is this Alice or
is this and and that actually creates a
good point right so and when you do
persistence it is based on different
user levels too so if you if you install
a persistence method that will
start up when Explorer starts up but
your system level process when you get
that persistence to call back it's
actually going to be as the normal user
so you're losing those privileges so
that's a really good point because I
mean if you're spending just like if
you're spending the time to do say a
successful fishing campaign where you
now get a you know user permission well
great make sure you get persistence back
from that point it's kind of like
bookmarking in a way so the same thing
with your privilege escalation hooray
your system now two is one one is none
make sure you still have a way to get
back into system without having to
perform the same escalation because may
or may not work the second time exactly
there's actually just going over here
there's actually some post modules that
do persistence so s for you persistence
and I'll talk about that in a second VSS
persistence and there's actually another
persistence one and just called
persistence okay so let's just go from
top bottom persistence itself is it
installs an executable onto the system
so service executable and it runs as a
service so that will be system level
process so one thing to keep in mind
though is system level processes don't
have proxy settings so if you're within
an organization that has a proxy your
persistence is just not going to work so
you're installing this thinking that
you're going to get a system shell back
and he's like I'm when I grade over to I
explore so it uses its proxy settings
yes no we'll talk about that in another
segment okay it with something called
pre pin migrate okay so not yet alright
get ahead of ourselves okay so and then
there's s for you persistence and this
is actually a really pretty like really
cool persistence method and it was
created by Matthew weeks also known as
script junky who provides a lot of stuff
to Metasploit and this is cool because
what it does is in scheduled tasks when
you create a scheduled task it creates
this XML file in in sequel and windows
tasks and that XML file has as what what
this task is supposed to do and the cool
thing about tasks is that you have the
ability to say do this every five
minutes do this win when this event
happened my favorite is at now
it's just a great way to fork but yeah
anyway right but but at at is limited to
do a specific time and it only runs once
yeah
where is with scheduled tasks you have
on Idol on log on on startup on event
with I love the on event one because you
can say on event failed log on huh and
then you can cause a failed log on and
get persistence back okay so this s for
you persistence specifically is for for
scheduled tasks and the great thing
about it is that what it does is it has
a special operator and I'll load this
real quick just as for you just to show
you so you have to have log on as batch
job as your permission one of your
permissions for whatever you run this as
so definitely look into the information
for any persistence module you're about
to run but what it's doing is is making
a service for user and that's the s for
you part so that service for user so you
let's say that you're logged in you're
not system you're not elevated but you
have the privilege to run as as the user
as a user right or as as a batch job and
some some places allow that sometimes
just don't so you're going to have to
know that or or look it up but this
makes it so that this persistence will
run even if that users not logged in
wait okay even if they're not logged in
right right because it's just it's a
scheduled tasks so it runs as a batch
job and allows it to run even when that
users not logged in so so now you have
the user logged so you are anything that
you like that user can do right and with
you know after five o'clock they leave
the author log off here's your sessions
the scheduled tasks kicking off and
there you go you guys you said it for
like six o'clock then I on their home
and then haha right
that's pretty rad so the other one the
other cool one is this is the VSS
persistence so this one I
actually allows you to inject into a
volume Shadow Copy
so not even for like I guess or some
right like you're not soon you're not
even showing up on des côtes it's it's
a so again just like the DLL injection
into registering so like it is on disk
but it's in it's sort of an compressed
version of this it's like a a diff sure
right so the crazy thing about this is
you can still execute from that mmm
right that's that's pretty cool right
and those are just some of the ones just
built built built in the nest wait yeah
yeah so but that's these these
persistence methods or Windows and you
drop an executable the service
executable is for you executable the you
know the VSS execute these are dropping
executables to get persistence but you
don't always have to do it like I said
just getting back to the whole mindset
of persistence you have to keep it open
and say I don't need to drop an exe for
everything right no I mean some of the
best things are just like I mean put my
favorite really is just on Windows 7
especially if you know it's a laptop so
it's going to have a wireless card is
turning it into a soft ap I mean here
you have to be within proximity but if
you you know then you can connect to
them as if you would any other AP and
now you're on their computer or well
you're on the same network as their
creator and so if you've added a user if
you've opened a Samba share things of
that nature right so one of the most
interesting and we'll put a link in the
show notes somewhere interesting
persistence methods that I found was a
talk done by Mark Baggett and I and
malware Jake I forget his first name or
FERS last name but they did a talk at
shmoocon called format that drive or
sometimes something along the lines
where basically persistence methods that
malware uses that you just need to just
quit pointing format reinstall right so
the cool thing about the one that one of
the ones that really kicked in for me
was a persistence method
that you used the sari kind of have to
break in this the persistence method
that what it did was installed a s DB or
SB D which is basically a compatibility
plugin so you know when you're trying to
run on an old game on Windows 7 you can
run in XP compatibility mode yeah what
this SPD does is it actually has a bunch
of different options allowing you to do
things on certain events and stuff like
that and I could be messing this up this
could be a different one but I'm pretty
sure that it's the STV stuff that what
it does is it listens for a wireless
access point and when that wireless
access point happens yeah it does it
gives you actually I have seen this and
actually not just this but anyway I just
love the idea of wireless a pieces like
ce2 you know no this isn't c2 right but
I've seen this as well so you couple
that with that a nun phone right oh yeah
yeah so so you just roll lensing you
just roll up to the warehouse or you
roll up to the wherever you've done it
and you spin up on AP and you get a show
right or or you just know that hey you
know when they take their laptop to this
coffee house or whatever yeah there's
you know yeah exactly yeah we're home or
whatever yep because huh in fact
actually that's kind of brilliant for
the whole home thing because you like
well fire when we're punching through
the firewall at the office but I do know
that their home access point is named
Linksys or one cuz you used to dumped
the from back with a couple episodes
back right the VLAN profiles right so
now you've profiled your victim and you
know when they go home they connect to
this access point and they're obviously
not on the corporate firewall when
they're at home so you use that to get
yourself your shell and it only executes
when those protections are not in place
sorry corporate security oh man
this is a good one I do you know we
could just talk and talk about
persistence because it's so much fun
we will persistently continue to retouch
on this topic if you do so ask in the
comments below or if you email MS
F at hack 5 org and that's where you can
also let us know what you'd like to see
on future episodes because this one is
brought to you by you guys not just in
the comments in fact it's brought to you
by you guys if you support the show and
the numerous ways you can you can find
all the ways over at Metasploit minute
comm and here this patreon patreon comm
slash move X mu bi X that's where you
can and all the people who are already
there I really appreciate it's such an
awesome thing that that now we've gotten
to the point where season 5 is
completely supported by them like the
flight out all all of the stuff is just
so amazing yeah yeah it's just
heartwarming to see like that this can
happen I don't know I'm still you know
buzzing on the whole idea of like the
democratization of media it's you know
yes we've been doing hack 5 for 10 years
but this is something really truly
amazing and it's also been you know a
pleasure to you know grow up with you
mimics yeah hey you know how long it's
been it's it's been 10 years so it
sounds like we've got quite a bit of
experience and awesome stuff to share
with the audience so if what I'm
alluding to here is that if you're
interested in coming down to the San
Francisco Bay Area June 26th we're doing
our very first training and because it
is our first we've got like basically
like ridiculous discount so that you can
get hands-on with mu bik's and Sebastian
and myself and learn testing with AK 510
testing with hack 5 right so you'll be
using hack 5 gear you're going to get
the awesome tactical hacker satchel full
of hack 5 year and then learn from us
how to use it and then dive deep into
Metasploit so yeah and it's practical
right so I don't teach anything that
doesn't have a practical application
it's not going to be a flat land that
you can just throw stuff at and it's
always going to be XP with MSO 267 it's
going to be szostak but it's going to be
fun stuff it's going to be actual like
corporate security type level stuff that
you get to break into and learn and SDR
and all kinds of so come down to the
hack 5 warehouse to do that and then we
all head over and grab a pie at the
baltic afterwards so it sounds like it's
not enough so
I just want to throw that out there
because it is like early bird access
you're not going to want to miss out on
there are many seats yeah I hope it's
not sold out by the time because we're
recording these ahead of time right guys
know how that works might be sold out
already
oh I'm barely looks I hope or not yeah
yeah okay anyway that would be really
bad if this is already sold out I
already filled out yeah I'd like all the
comments are like yeah guys she told us
this last week when it was sold out
anyway with all of that I just do want
to again say thank you for allowing us
to make this happen so let us know in
the comments let us know the feedback
emails what you guys want to see alright
that's it for Metasploit minute until
next time I'll move excite I'll be
hacking til the cows come home
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>