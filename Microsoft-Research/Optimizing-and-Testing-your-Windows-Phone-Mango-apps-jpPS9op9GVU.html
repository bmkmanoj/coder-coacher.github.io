<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Optimizing and Testing your Windows Phone Mango apps | Coder Coacher - Coaching Coders</title><meta content="Optimizing and Testing your Windows Phone Mango apps - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Microsoft-Research/">Microsoft Research</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Optimizing and Testing your Windows Phone Mango apps</b></h2><h5 class="post__date">2016-07-28</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/jpPS9op9GVU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">each year microsoft research helps
hundreds of influential speakers from
around the world including leading
scientists renowned experts in
technology book authors and leading
academics and makes videos of these
lectures freely available
you
okay so my name is Ben Lauer and i am
the sponsor for zap fest and if this is
your first time joining us welcome and
if it's not your first time welcome back
and zap fest is a series of events where
we're trying to connect developers or
people interested in developing apps for
Windows Phone connect them with internal
experts who work on the product mmm here
at Microsoft and before I introduce our
speaker tonight I wanted to mention that
tomorrow excuse me I'm actually going to
do a blog post about a contest that
we're working with core77 on and core77
focuses on design so there they have a
huge audience of designers and they're
actually they've been running the
contest since last month to get great
design ideas from designers in the area
of productivity apps for Windows Phone
and we're expecting that a lot of these
designers are going to have a need for
development help so I hear from
developers all the time hey I don't know
what my next idea is if you're if you're
coding is like mine I can build a an
interface that only a developer could
love right so I would always love to
work with a great designer and so I've
posted the link here at the top which is
just the overall contest that's going on
right now if you're interested but the
link at the bottom for developers is
basically it's a self referral page and
so if you're interested to put your hat
in the ring and say hey I'm interested
to look into helping some of these
designers bring their apps to market
please do that because we've we've
gotten some designs in already I think
we've had about 67 submissions and some
of these things are really amazing you
get great designers and their ideas it's
things look really good but we need
developers to help so please if you're
interested check that out you can email
me if you have more questions I also
want to make one more plug for some time
we started doing recently with loaner
devices so we have devices here tonight
if you want to see the new Sam
some focus s the HTC Radar or the
samsung focus flash we've got those if
you want to check them out but we also
make devices available on a loaner basis
if you need to test your app with with
some new hardware that you don't
normally have access to so if you want a
loaner device email zap fest hyphen
devices and we will get you squared away
so without further ado it's my pleasure
to introduce stefan wick who is a
principal test lead working on windows
phone and i'm really looking forward to
his presentation so Stefan thank you
very much man appreciate the invitation
hello everybody my name is stefan wick
i'm a test manager on the developer
platform team in the Windows Phone group
and I'm responsible for this silverlight
platform in Windows Phone I want to talk
a little bit about testing and
optimizing your windows phone mango
applications today and hopefully can
give you a handful of useful tips that
you can use to improve and optimize your
apps that you have today or that you
might write in the future a little bit
of motivation up front here I'll give
you a second to to read the slide so I
don't think actually you know buying a
lottery ticket increases your odds of
success but instead i think really
understanding the platform and
optimizing your app to take best
possible advantage of all the
capabilities and testing your app tuned
to find your box and add to to to make
your appt more robust and more
performant is actually the key to to
success here i'm not going to talk about
money but if you want your app to be in
the top 100 or whatever off the
marketplace i think the key
differentiator between your RSS reader
and the next person's our RSS reader is
probably you know how performin is it
how
how well it is designed how how
responsive is a 22 your input and so on
and so forth and those are all things
that you can control and with you know a
few little things you can easily do you
can make your app look better than the
next person's guy and maybe that gets
you from a three-star rating to a
four-star or five star rating and and
those are all the apps that will bubble
to the top so i also have a little bit
of a hidden agenda here today so i guess
it's not that hidden now that i talked
about it but i want also motivate you
guys to actually upgrade your apps 2271
so how many of you already have written
some 70 apps and published them in
marketplace quite a few how many of you
have upgraded them to 71 yet not too
many so I think it's it's a good goal
for me too maybe motivate the rest of
you as well to to do that step and along
those lines there was actually an
interesting thread just today on the
windows phone developer discussion areas
if some of you follow that there were a
few people who have added some
instrumentation to their app to find out
how many of their users are already
running mango versus 70 and they
actually found that the vast majority
already runs on mango so that is another
good data point that hopefully motivates
people to actually you know put your
effort into building 71 apps because
that's where the majority of the
customers are and that's also where you
get at the best performance and and best
appearance for your apps so let's take a
quick look at the buckets of mango
improvements and I'm not actually going
to talk about all the features that we
added in mango just taking a look here
real quick at the improvements in
existing features from 70 we can put the
improvements in in three big pockets
there's one the general improvements
that are baked in the platform every app
world will take advantage of the
if you have a 70 app you run it on mango
you will get better scrolling you will
get a lower memory footprint and you
will get better video playback just to
name a few but then there is a second
bucket where we where we improve the
default behavior for 71 apps but we
didn't change it for 70 apps that is
because of our high compatibility bar
that we have for 70 apps and some of the
changes that we introduced would have
broken existing apps so we couldn't just
make it default for everyone examples
for that our fast app switching and also
our news are more passer everyone know
what fast app switching is we need a
demo or any okay and just to let me just
launched a few apps here real quick and
then I navigate out of them forward and
maybe ie so so now I have launched a few
apps and when I go into my app switching
mode by holding down the back button I
into this screen where I can see all my
apps that are running on the back stack
and I can really quickly switch between
those different apps so this is a very
seamless experience for the user you
don't have to you know wait for you know
the app to relaunch or deserialize the
data everything is right there where you
left it off and you can continue so this
is something that your app gets for free
just by recompiling it at 71 if your app
is still 70 app you don't get that
feature even when you run on mango so
then there's the third pocket which
excuse me which I call here like new
optional behaviors and 71 those are
behaviors that you know your app may or
may not want and so you have the option
to use an API or property to to opt into
the new behavior and then take advantage
of it so and this is what I want to
focus on for the most part of the talk
to give a couple of those examples of
where you can you know do a little bit
of work in your app and and get some
some really good improvements on on 71
so first thing I want to talk about this
very simple feature actually and you
know very easy to enable in your
application the background here is in in
700 we only supported 16 bits per pixel
rendering in in third-party applications
even though most devices actually were
able to display 32 bits per pixel you
couldn't take advantage of it in mango
we now enable that but we didn't make it
the default again to maintain
compatibility and and consistency with
existing experience but in your app you
can easily opt into it and let me just
pick pick a random visual studio project
here at the way to do is very easy you
just go to your WM app manifest.xml in
your project and it's just one property
that you set here and it's conveniently
named bits per pixel and so by default
you don't have this this in your in your
manifest so the default is empty which
is 16 but if you set this property you
you opt your entire app into this new
rendering mode and that gives you some
pretty significant advantages or improve
rendering specifically for scenarios
where you render photos or you have
designs that take advantage of gradients
so if anyone of you ever tried gradients
in your 70 application you probably
notice some pretty ugly banding and then
you probably stop using it there we go
yes so question from the folks online
what's the 44
sit if any for opting in yeah the
performance is really low on this one so
I would still recommend if you opt in
that you will retest your application in
both scenarios and make sure there's no
noticeable difference but there should
be only very minimal difference in terms
of memory usage and and and no
difference in interactivity ESPYs
excellent implications and really good
question and the question was does it
applied to X and ay applications as well
and the answer is yes so one important
thing to point out here is for video
applications we actually automatically
opt you in on mango so this was a
decision we made because we thought most
video applications are kind of full
screen anyway and there is no other UI
that that would be affected and the
video playback in 32 bits per pixel
looks so much better and and so much
more natural that we thought that is the
the right call for video in general yes
please this lush green sometimes you
don't like your ingredients there are
shoes we'll just hope that as well I
know the splash screen and is not
affected by the setting my experience
like you know what I decided Glendon
sure yeah yeah so question was about the
splash screen splash screen yeah it's
not affected by this so you want to make
sure you design your splash screen that
it that it still looks okay in the
16-bit mode okay so I do have a quick
demo for this as well but and in case
the projector doesn't show the
difference I also put it put it on the
slide here and i hope i hope you can
actually see it see this the banding on
on the left and no banding on the right
can you see these stripes over here so
this is a typical effect that you get in
16 bits per pixel so on the left is the
is the 70 a case and on the right is is
mango when you opt into the 32 bit per
pixel mode it actually is much more
visible if you look at it on the device
itself and of course it depends on your
scene the more gradients you haven't you
know if you have a photo with with like
a sky you see it very noticeably maybe
if we can switch to the projector can
show it here so I have the same app and
16-bit per pixel and 32 bits per pixel
so that's a joke yeah so you can you can
tell which one is which I think and when
you animate it it actually is even more
noticeable and if you if you look at the
device directly you can actually see it
much more visibly so it's as something
you might want to try on your app if you
if you have you know lots of colorful
things it might help you get a
significant a better rendering
experience yes points to the live tile
at all or is that all handle differently
question is does it apply to the
lifestyle I know it does not so a
lifetime is not affected by the setting
meanwhile by default 32 or 16 no I think
lifestyle is by default 16 so um so the
next thing that is kind of new in let's
go back to PowerPoint the next thing
that is new and 71 that you can opt in
very easily is at the background image
decoding so we did a lot of work and 71
to improve the list scrolling scenarios
and specifically when you have lots of
images in your list you you may have
seen problems in terms of responsiveness
and and stuttering in in your list so
one of the things that we have enabled
in mango is to move your image decoding
on a background thread because in 70 the
image recording always happen on the UI
thread which then interferes with your
input and your inner activity on your
list or whatever piece of you I you have
with a simple option by setting create
options to background creation you can
move that to a background thread and
achieve a a much natural experience for
the user of course in the end the time
it takes to decode and image doesn't
change but by moving it to a background
thread
the perceived user experiences is much
better let me let me try to demonstrate
this here on the projector so I have two
identical apps one has the background
creation flag set the other didn't and
so what I want to do first is just kind
of scroll as fast as i can add down here
so first i can see so both devices are
running mango and so the responsiveness
is is kind of nice the scrolling seems
okay and natural but now when i try to
scroll as fast as i can you notice on
the left one ad there's a lot of these
completely blank items where the you I
just completely disappears for for for a
few seconds even and I don't have have
this in the right application because
here my image recording happens on the
background so the images you know they
still take a while and then they pop in
but my but my text and the rest of my
list items is still there as the user
what would expect and another thing to
to demo here this improvement nicely is
if i change the images in my list by
clicking this button here and then
indirect you see the the one on the
right responded immediately while the
one on the left was actually stuck for a
good number of seconds before it even
started to school so this is this is a
big big thing that you can enable in
your app was just one property setting
yes please this property is available in
creating them from a great you can do it
program a glee as well yeah if you
create a bitmap image instance you can
set the create options property at that
point
yeah I will be sharing the PowerPoint
and also the demo applications yeah and
this one here I think is actually up on
our proof block all ready for was so you
can also get it from there so yeah so
that was second one a really really
simple thing that can give you big
improvements in your app if you if
you're dealing with images a lot if you
just have one image then you may not
care but for for especially for this
it's a it's a really good improvement so
we've seen the demo so the the next one
actually wanna talk about that'll quite
a bit is memory testing and debugging
and and optimizing its if you're new to
Windows Phone development and you come
come from a desktop background you you
may not think about you know 10
megabytes here 100 megawatts there you
know who cares right but on the phone
and memory is one of the resources that
are very very limited and precious so
generally we want apps to stay under 90
megabyte when in the certification
process so you do want to be careful how
much you allocate in your app and most
importantly you want to be careful that
you're you're not leaking any memory
because we've seen apps that pass the
certification because yeah they they
don't exceed 90 megabyte at that point
but when an actual user uses them in the
real world for more than 10 minutes and
and the app has a leak then you easily
go up to 2 200 or more megabyte and and
at that point you are likely to crash on
the device and we're actually seeing a
lot of Watson reports from the wild
where third-party applications are
crashing with out of memory exception so
that is there is a real problem and a
lot of it has to do with people's apps
are leaking there was a question
how are certification done is it like
manually people from the app and yeah so
it's a it's a mix of some automated and
static analysis and actual manual
testing so there are humans who are
exploring the app doing exploratory
testing as much as they can of course
they don't fully understand each app so
at the mileage may maybe I but I humans
humans are testing that but then the
real world is always different right you
can consider kind of a facebook
application and you test it with five
friends everything may be fine but then
someone has 50 friends now does that
mean your memory usage is ten times as
much then now you might have a problem
right so so that's something you also
want to consider in your testing put it
to the real world test with real-world
data in real world environment also
consider monitoring your heavy objects
and it's something I will demonstrate in
in a second just understanding you know
the number of instances of your pages or
your user controls on the heap is very
useful metric during the development and
testing of your app to actually identify
any leaks in your application and it's
it is really a fairly common problem
that people have leaks in their app
initially people think oh it's managed
code so how can I league right there's
garbage collection what can go wrong but
almost all apps that we have analyzed
that have performance problems we've
found that they have some amounts of
leaks in in their managed code and and
that is something that you can prevent
upfront also wanted to call out even if
you have just the tiny little thing in
your UI that that has a problem and
leaks like you know a single element
that is maybe not well written like a
user control and app and it leaks this
can actually cause or typical
does cause your entire visual tree to
leak because in the tree based framework
that we have in silverlight each element
has a reference to all the children as
well as to all their parents so if one
guy leagues it keeps everything else
alive the entire subtree and so this can
be your page when you navigate back your
entire page may be leaked and if that
has a bunch of images and other heavy
data objects you know one navigation can
leak five megabytes right there and last
but not least i want to encourage people
to take a look at the new seven or one
profiling tools which include a memory
profiler which i will also show in a
second and that is a very useful tool to
actually track down your box once you
have a suspicion there is a leak in your
app you can use the profiling tools to
actually get to the bottom of it so for
demoing memory testing i switch over
here to to my emulator and so I have a
little app here that has a small problem
so this is just a dummy app it just has
to hyperlinks here up on the top I I
just have some Diagnostics so you can
see what's what's going on here and so
all it does is it navigates to one page
which shows a photo and I can navigate
to a second page which shows a different
photo and these are pretty large photos
I I picked up picked large once so that
you can easily see at the memory problem
so let's monitor our kind of what our
usage is so we're already up to 16
megabyte here so let me and repeat this
cycle here a few times so I'm going to
these pages repeatedly as a user and so
now my memory usage is already up to
twenty nine megabytes so this is pretty
disturbing because typically or the way
it's designed when you navigate back
from a page that page becomes eligible
for garbage collection and you know it
should just disappear at some point so
it could just be the garbage collection
hasn't kicked in yet that's a
possibility and actually looks like
that's what happened here so I can force
garbage collection and my memory goes
down but it's still not where it started
where it should be and my little heap
tracking indicator here shows other
there seems to be a problem with with
the second page class because all those
three instances are still there while
the first page instances have been
collected let me kind of try to validate
this a little more when I repeat this
with first page it always goes nicely
back to 20 and when I do this the second
page it just keeps growing and now i'm
at five and my memory usage is is that
is that twenty two megabytes and I'm I'm
really on a bad trajectory here and i
will i will soon crashes or if I keep
doing that so let's first take a quick
look how I how I'm tracking the data
here in my
in my testing and then I will take a
look how we can use the memory profiler
to get to the bottom of what what the
blog might it might be and how we can
fix it so what I'm doing here to to
display my my text in my little
Diagnostics helper there are properties
that we expose us as API said you can
just curate to get the current and the
peak memory usage so that's pretty
straightforward to get the number of
instances for my pages I have exposed a
little static on on these classes a
public static that just counts the
instances so whenever I hit my
constructor I increment them and
whenever my page gets finalized and
collected by garbage collection i decree
meant the counter so this way I can just
keep track of what's currently active on
on the heap so let's start the
performance profiler why is this not a
little Oh
doesn't need to restart project okay
interesting so and we want the memory
profiling here at the moment there's
also execution profiling but we'll focus
on memory profiling obviously for for
this problem so this will now launch my
application with the profiler attached
so we can collect detailed data about
the allocations and who is holding on to
what oh yeah that's good catch it was
actually running over here okay enough
to wait a second real quick until it's
done analyzing this so let's close this
out and we want to run on emulator
ok
so this should start in a second okay
here we go so let me just go through
this iteration real quick oops think
that was not what I intended let me try
this again I don't know what I just
crashed
okay try again
okay so we go to second page let's do it
okay I don't know white white exits on
me but maybe that that's actually enough
data to to to look at this so I have all
my memory data here well it tells me
excessive allocations okay that's good I
can probably figure that myself and I
get a heap summary so there's lots of
data here I will not be able to get into
all the details here so that's probably
11 talk of its own but I want to take a
look at the retained allocations at the
end here because that's kind of what's
what's left over and so from our own
initial testing we already had the
suspicion that something is with the
second page is not getting collected so
I'm gonna sort by type name here and
find my second page type somewhere down
here phone app second page so here is
and I can scroll over here and I see
okay there are two instances that's not
more at what I expect so I can look at
these two instances and so let's take a
look at the first one that was created
so that's definitely one that should not
exist anymore and so now I'm missing the
data here so I give me one more try okay
then let me restart the emulator
sorry about that give me just one second
restarting the project and then do the
profiling from scratch okay
so what I want to get to is in the in
the data that the profiler spits out for
my instances for second page it can tell
me what are all the objects that hold
references to to that page and by
looking at that data I can get a really
good hint at what where's the problem
what what is the culprit in my code that
is causing my page to not be eligible
for garbage collection because obviously
there's something in the app that still
has a reference on it so the garbage
collector thinks it cannot collect that
instance yet okay so hopefully we're
back in business now okay here okay so
this looks much better now I can stop my
profiler and hopefully I have to follow
data set now okay this looks pretty good
so let's analyze this and look at our
heap again allocations at end and
scrolling down to sort it and we're
scrolling down to the second page
instances here we go okay so now i can
go ahead i can either look at the object
graph of what what it is referencing or
the GC routes those are the the routes
that you know prevent my object from
being garbage collected and so if i
follow this down here i get a really
good indicator here are so there appears
to be a context menu that is that is
holding reference to my page in the end
of the at the end of the day actually
it's holding reference to the image and
since the image has a pointer to its
parent and the parent at some point is
the page
everything in that page including the
image and the context menu and
everything else is is just leaked so
some of you may be familiar with that
back because that's actually a bug that
that was present in the toolkit so full
of you using the the Civil I toolkit the
context menu is is a control that ships
on corp ex was the toolkit and it had
this bug so the fix for me you now would
be very easy here I'm just using a very
old version of the tool kit and I if I
just upgrade to the current August
version the bug will be gone so so
that's the the fix here but another
possible fix would be if you if you
didn't have that fix available and as a
possible fix here would be at on the
navigate event before the page goes away
you can basically just unhook the
context menu from from its element and
this way it doesn't cause any harm the
context menu may still leak but
everything else will will be collected
so that is kind of a workaround you can
do if you consume a third-party control
that has a leak on your page then you
can just throw it out of the tree before
the tree goes away this way everything
else becomes eligible for garbage
collection yes please would it be a bad
idea to call the garbage collector
explicitly in here
question was is it a bad idea to call
garbage collection in your app and not
necessarily so there are different camps
on on this one depends on on your app
and and how you do it you don't want to
call it all the time because that also
gives you a performance hit right so but
if you kind of know what you're doing
then it's okay but generally you should
not have to do it so the garbage
collector should be smart enough to to
do the right thing other means there's
some general guidelines around when you
might want to consider well if you have
a situation where you know you know the
user isn't interacting with the app
right now and and there is cycles
available you might as well kick it off
and because it's not causing any harm at
that point and it might you know lower
your your memory pressure so that would
be okay but if the user is interacting
with the app and scrolling and and
sliding and flicking at that point you
you don't want to call it because then
the user will see stuttering and and
things will just stop for a moment so
yeah generally you know you shouldn't
have to do it and obviously calling GC
explicitly doesn't help with situations
like this where you know something holds
a reference to to your objects because
they are just not eligible for garbage
collection okay so actually let me go
back to my my little app here real quick
so obviously this is kind of a contrived
sample and demo and you don't want all
this kind of UI on top of your
application to always monitor you know
all the different pages that that you
have in your app or other objects and
memory usage and have a GC button and
and whatnot so I want to just use this
opportunity to kind of highlight another
mango feature that that we have added
and that comes in handy here because
that enables me actually to move this
piece of you I out of my phone
and I can just throw it into into my
into an application running on my
Windows desktop and monitor thinks that
way let me just show show that real
quick went back to my project here so I
I have a little controller app here this
is just a standard WPF application that
i put and i just put the same UI in
there pretty much and so now when i when
i launched my my phone application and
now it's not working it should actually
connect to this one maybe it's because
I'm running the also the device here
okay let me try from the device
okay it looks like demo God's or not
with me today it worked before in my
office anyway the general idea is that I
just put my monitoring you I up here in
a in a windows application that I'm
running on on my desktop and i'm using
sockets to connect to my phone or to my
emulator and this way i can i can
actually operate the app and and monitor
anything that that's going on there so
well it's the sockets being yeah so yeah
so I'll gets me being the new feature
right so that I'm just using to enable
the connection between my desktop app
and and my phone application here so
okay i'm not going to debug this year so
maybe i'll get it working up after the
presentation but hopefully you kind of
get got the idea so that is something
that that can come in pretty handy for
for debugging purposes or you know if
you just want want to do some some
logging and and things like that this
this can be a useful feature you can add
just during the development process so
next topic very important end-to-end
testing for your application you know I
I think most of you are engineers so I
don't need to explain the importance of
testing and the value of testing but
still I want to want to highlight maybe
some of the the obvious benefits here
and then show a little bit of a demo of
you know how this can look like in in an
application on iphone so you know if you
if you're just developing kind of you
know 99 cents i fought clone application
you know your end-to-end test is
probably not that complex and you can
probably get away with
you know just kind of ad hoc testing it
and then then you're done but if you
have anything more complex than that you
do want to have some structured way of
actually going through your app hitting
you know all your different code paths
or your different pages and controls and
and and your business logic and and
verify along the way that you know your
state of your application is correct and
the visuals look right and that you
don't you know hit any crashes or or
memory problems so in simple cases you
know probably some sort of manual script
will suffice there but if you have you
know a slightly more professional app or
you know you make more long-term
investments in your app you might want
to consider having you know some sort of
automated script for that so that's
something where we don't have really any
tooling support today to help you with
that but still I think it's something
that I would encourage you to consider
because using the the public API surface
that we have and you know using some
standard techniques around you know
mocking and inversion of control you can
actually very easily build these kind of
scripts that will you know exercise your
application and you know verify a lot of
things along the way one important thing
for that to work is actually that you
design and end and develop your
application with testing in mind from
from the beginning if you kind of treat
it as an afterthought then then it might
already be too late and you you will not
have a have an easy time to to actually
do it yes please Dateline's regarding
this like spending automation framework
yeah so there aren't there aren't as I
said there aren't many that there is no
real tooling support available for this
and also a guidance is very limited
today the patterns and practices guys
actually
out some guidance along those lines I
think last month they put something up
on codeplex with some guidance the only
other sort of framework that is
available is for unit testing so the
solid unit test framework but that won't
really help you much with the end-to-end
testing because it's fairly limited in
terms of what you can actually execute
but kind of to show it you know more
conceptually how this can look like and
what you can do I have little demo here
in in my emulator so let me deploy that
so I've picked the the few tracker
application which is some of you might
might have come across this one on msdn
it's an application and it's it's a
sample on msdn it comes with a fairly
nice article about building an
application from start to finish and
that is basically the application that
that they are building in in that
article and so what I've done is so I
took that application and modified it a
little bit too to make it more testable
and then I've wrote some tests against
it so I have feared the few tracker
application let me just demonstrate it
real quick how it works so you can enter
enter your car name choose a picture for
it don't have a car picture here so
whatever and so now that you've set up
your and initial automator and now that
you save your car you can track your
fuel consumption so there's some history
review and so whenever you fill up your
car you can go ahead and enter
your new automator and enter how many
gallons you filled up with and then you
know the price you paid for your gallon
and then you can get you know your
average miles per gallon you see your
history and so on so forth so very
simple application and nothing exciting
but it's still more than hello world and
it you know it's pretty close to
something that you know you could
consider a real application so and now
the application is here in this project
so what I what I've done here in my
second project this produces a second
zap which basically is a superset of my
few trackers app with my test code added
so this way I keep it nice and separate
so my shipping zap doesn't have any of
my test code and I have a secondary zap
that use this exact same code that I'm
shipping plus plus my tests and then
these are just help or libraries so now
when i launched my my test application i
get to a test menu or test page first
and from here I can launch different
tests against my application I could
just do a manual test which will just
launched my application and and I can go
through it manually this actually is
pretty useful can be useful because I
also have some additional sort of
features here that I can enable for my
testing I can enable frame rate counter
and memory counter and some other debug
flags that help me identify problems or
issues in my application I can also turn
leak detection on which is something
similar to what I've shown in the
previous demo where I just kind of count
the the instances of my interesting
objects and whenever I see something
didn't go away after page navigation I
basically fail
fail my test so you know with these
flags the manual test can actually be
fairly interesting as well so i also
have unit tests here and this is using
the the silverlight unit test framework
that that you may already be familiar
with so this is just standard a dotnet
stuff for unit testing and this is
nothing nothing different from what you
probably already familiar with but then
the end-to-end test that's probably the
more interesting piece here so in the
end to end test that's where i have
basically my automated script that go
through the entire procedure of my of
using my application and actually kind
of hits every page in every control and
and does something useful with it let me
actually show show the test finding
finding a buck so if i run my end-to-end
tests now was a leak detection on me run
it again
so now at the end of my test it actually
flex it that hey there's a leak and so I
can see oh my Phillip page didn't get
collected at the end so there's probably
a buck so my test failed let me go fix
this bug real quick so i go to my views
here fill up page and of course i
already know the box so it's easy to fix
otherwise i would use the profiler to
tell me you know where the bug is but
the book here is kind of a standard you
know don't net bug that people easily do
i subscribe to to a static and event
here for four touch input and but i
forgot to unsubscribe in the end so that
that one keeps my page real life so the
fix luckily someone already coded it up
here the fix is you know before i
navigate away from my page i I go and
unsubscribe from my event so this way
and I don't I don't leave my page so let
me rebuild the app and deploy and so now
I can run it again let's not forget to
turn on the leak detection on my end to
end test
and now the test pass so so system works
yes please you can't be sharing this
quarter you're doing this yeah sure yeah
definitely shit and I can also i don't
know how much time we have eight minutes
left so i can also go a little bit into
the code right here and so then my last
option that i have here is just a stress
test it's very simple what i'm doing
here it's just i run my end to end test
just in a loop that's that's basically
all i have but you can certainly get
more creative here and more crazy and to
you know more stressful things and so
maybe we can pick you know a small piece
of the of the code here and look at that
so one one thing that's kind of
traditionally challenging if you if
you're trying to test your phone
application is some of the launches and
choosers that you interact with for
example in this application i have the
photo chooser so i can pick my the photo
for my car from the library so what
happens when you run your app you launch
the choose you launch the photo chooser
and that actually puts your app in the
background and the chooser is in the
foreground and then you are you no
longer in control right and so that's
kind of changing for test what I've done
here is I've built a little extension
for tasks and so in this case I only
implemented it for the photo choose a
task but the same would apply to others
as well so the way the photo chooser
task works in the platform is it just
has a show method which launches it and
then it has a completed event that fires
when it's done and when you get control
back then it gives you the the pointer
to the picture that the user has picked
so what I'm doing is here I'm adding
basically an overload to to the show
method that that also takes a
and that takes a delegate to to a
completed method and so now I just have
two different execution modes in case
the user uses the application I just do
the same thing I would normally do I
just you know call show on my task and
then when the completed event fires i
erase the you know the other completed
event that my application is subscribed
to and everything just works exactly
like like it does in the normal world
but if i'm not in the user execution
mode meaning i'm in the in the test
automation mode then i go down here and
what i'm doing here is I just skip
launching the task and instead create
the result myself and then then launch
the completed event with that result so
this way I have kind of mocked the mock
the photo chooser task and my automation
can just continue right because the goal
for for me is not to test that the that
the chooser works the goal for me is to
test that the application works and I
just assume the chooser you know works
correctly because that's actually my job
and in my day job so yeah so that is
that is one example and some similar
things you can do with you know the
other you know parts of the platform as
well using mocking or inversion of
control type of techniques okay I think
actually that's yeah that's all I have
so yeah thank you very much
and yeah I think we still have a bunch
of time for for questions
there anyway to see what is happening on
the device that some sort of am i
drawing some problems in my app where
they there's something simply UI thread
and I don't know what okay and I'm not
sure how to find out what exactly is
happening because in the framerate drops
and cpu a great rock solid North i order
order find or take any something okay a
question was is there any way to find
out what's happening on the UI thread
and sew the the 7.1 profiling tools
actually give you some good indication
of what's going on on on the different
threads so if you run your app in the
sort of execution profiler you get a
breakdown of what's happening on on what
thread so I would recommend trying that
see if you can see anything obvious
there's a lot of data that you get so it
might take a while to kind of actually
wrap your mind around that and and trace
it back to like what what you're doing
in your code that triggers it but it
should show you you know what's
happening on the earth way
so some of the folks online are asking
if you would do some more general
coverage of the profiler since we have
some time they're wondering if you can
just show more because they're really
intrigued by what this all so far okay
for the for the memory profiler or the
execution profile memory okay
okay actually yeah why don't we try to
debug the other problem here that that I
just fixed in the few track or
application using the memory profiler so
let me put the bug back in here and
let's see what the profiler has to say
about this one so
ok so now i have to get all the way to
the Philip page 2 to see the bug
and so you fill up
why is it invalid huh all right there
you go Wow so now yeah now that I got
back from the fill up page I should have
leaked it so let me stop the profiler
and see if the profiler can confirm that
and then also hopefully it will point me
to the problem so there's a lot of data
now since took took a while to get there
so but let's still look at everything
here so my heap summary locations at end
oh yeah there's actually probably
something useful to call out here I
should have actually said that before
and so in this view intuitively when you
look at at the types here you would
probably intuitively go by you know sort
by size and you know just look for you
know what are you know the biggest
things that that that are and not not
collected yet but in most cases actually
that gives you kind of false put you in
the fourth direction because if you look
at the size this year they're not
actually that that large right this
isn't bytes so we're just these are just
and like 160 k or something like that so
that's not really that important and it
is important but not that significant
it's important to understand that many
objects in in the framework have both a
managed memory footprint as well as a
native memory footprint like if you have
when you have an image control with a
large image the managed image control
that's just a couple of bites that is
that is not
really significant but the decoded image
which we keep a in native memory on on
our side of the framework that's where
where you know all the mega bytes are so
in that case in with that in mind the
actual manage bytes that you see in the
profiler don't necessarily tell you
where the big chunks are that that are
being leaked so it is more important to
look for the instances of objects that
should not be there I like the several
page instances that that we saw in the
other example but so here let's look for
our fill up page and actually need to
take a look at the namespace here so I
can actually find it its fuel truck or
reviews fuel track reviews fill up I
think that's that's probably it no fill
up page this one so so this is the one
that should not be there anymore because
I've already navigated back from it so
that that is that is our leak so let's
see what the GC route says here
so there's a lot of data so slightly
more complex page so
so this part obviously was not rehearsed
at all so
there's a question as you're clicking
through and they're running the profiler
on their machine and they don't see the
bottom window so they're wondering if
you did something special to get the
bottom half of the analysis page to have
no that should just show up maybe they
need to rearrange their their windows a
little bit that should be up by default
so I didn't do anything here so the left
like it's section of the time oh that's
right yeah you yeah you first want to
select a sectional talking on the time
yeah yeah exactly yeah so there's since
I'm looking at the at the root of the
page and the page contains a bunch of
stuff that's why we're seeing you note
on Tonto roots here so and that is a
little bit hot hard to grok here right
now and pinpoint and the the exact issue
right right there so that that takes
takes a little more I think at time and
and also a practice to you know kind of
know how to get through through the data
here and actually pinpoint the thing in
code so
yeah so well but the good thing oh here
we are so okay I should have started at
the bottom so anyway so it is something
that yeah you you do want to practice a
little bit i think it's it's not the
most you know intuitive thing at the end
of the day the data is is there and it
can help you pinpoint your leaks but
yeah i would recommend practicing that a
little bit maybe with some sort of
contrived leaks that you sort of
introduce yourself and then you know
make sure you can see them and then with
that knowledge you can expand later to
to you know find other leaks as well as
you were scrolling through the list i
missed two things what were you looking
for when you went through the list and
then when you got to the bottom how did
you know that was the thing they were
looking for yeah so actually there
there's there's more more data than and
in this sense actually on my laptop in
this resolution and it's hard to kind of
see everything at together there's also
add the the root kind that that you may
want to take into account and and and so
we're looking at the at the end of these
and of these various routes that go all
the way down and again it's kind of hard
hard to see everything together here and
it also is a little bit kind of knowing
some of the normal patterns that you see
on on on like every page that is that is
you know just a life by default versus
things that that shouldn't be there if
they are collected so I think that goes
goes back to to what I said that you
might want to practice that a little bit
and looking at a page is probably count
the more complex scenario here because
it had there is a lot of things that
that have references and and two to the
page so you might actually want to pick
in a simpler example where you just have
one one control on on your page or 11
panel on your page that contains a
leaking control and then and then
inspect you know what's what's going on
on that panel and so look at the panel
you know without without that control
and and with that control and see what
what the differences are
okay other questions yes please do you
say that the majority of leaks happen
because of unsubscribe events is that um
that is definitely a big class of
problems yeah so that that could that
could easily be the largest class yeah
separate amen Hitler's in that list no
there's not no yeah so that's definitely
one but also just another common pattern
is where you have maybe some static
collections and so a control that that
adds itself to a static collection and
then later when the UI goes away the
control is still referenced by that
static collection that's that's another
pattern that's that's quite that you see
quite often and i think in practice in
many cases you will actually find that
it's not necessarily you were leaked
that you're hitting in your application
if you're using a lot of like
third-party mvvm frameworks or you know
control libraries you actually inherit
all of their box as well right and so so
that's that's another thing you will
likely encounter especially in the mvvm
what we've seen a lot of these problems
as well another question online DVD tips
around using dispatcher versus a
background worker
well those are fundamentally different
right the background worker spins up a
new threat so you're executing on a
whole different thread versus the
dispatcher just basically puts the work
into a queue on the UI thread and then
execute it when when the queue is ready
to process that so that's the main
difference so if you want stuff to be
off the UI thread then yeah background
worker or you know any other thread is
the right choice if you want or need
your work to be executed on the UI
thread but you don't want to run it
right this moment but only later when
the UI is ready then this picture would
be the right choice
okay any more questions online okay cool
alright thanks again</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>