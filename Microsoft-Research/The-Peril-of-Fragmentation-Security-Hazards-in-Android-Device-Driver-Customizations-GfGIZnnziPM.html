<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>The Peril of Fragmentation: Security Hazards in Android Device Driver Customizations | Coder Coacher - Coaching Coders</title><meta content="The Peril of Fragmentation: Security Hazards in Android Device Driver Customizations - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Microsoft-Research/">Microsoft Research</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>The Peril of Fragmentation: Security Hazards in Android Device Driver Customizations</b></h2><h5 class="post__date">2016-06-21</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/GfGIZnnziPM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">each year microsoft research helps
hundreds of influential speakers from
around the world including leading
scientists renowned experts in
technology book authors and leading
academics and makes videos of these
lectures freely available
you
okay Sosa pleasure to have a mom in
Nevada speaking again today so I melissa
is a student at university of illinois
at urbana-champaign and today he'll be
speaking about android security thank
you sending for the introduction so
today i will talk about our work on
android device driver customization and
how the security of the phone is reduced
during this customization process this
is joint work with my colleagues from
indiana university so android has more
than eighty percent of the global
smartphone market share we are more than
a million apps on the Play Store and
yeah the good thing about android is
that it's open source and our like all
of our observation is based on this open
source nature and yeah this is one this
like a this paper in what we show in
this paper is one bad thing about open
source it's just because of the open
source nature so what happens is that
because the Android code is open source
the manufacturers customizes the end
right to support different hardware or
the support or to give different
functionalities for example they have
different apps their default different
default apps they provide different
functionalities so they can just like
get better somehow get better phones
than their competitors and they do need
to modify driver always because for
example if they want to have a camera
from a different vendor or any driver
any device from a different vendor they
need to write their own drivers for it
and yeah so for that reason they need to
heavily customized is both at the kernel
layer and the application layer so how
this works is that Google first releases
their Android source code to these
vendors
and then Google gives some time to these
vendors because before releasing it
officially so Google releases their
phones with the bleeding edge Android
version but they give some time to the
other vendors so they can also put the
state of the art Android in their phones
typically this time is something like
six months so Wenders do add new
applications and drivers to the colonel
a layer and there was a paper at ccs
that showed that the pre-loaded
applications leak system capabilities
and sensitive information to malicious
apps but and android a USB stands for
Android Open Source Project so since
2009 there has been like 19 official
Android releases so when just need to
customize very frequently and for every
different phone they need to customize
the version that is released at that
time like the latest Android version
yeah before talking more I'll just
introduce the Android architecture so
Android is built on top of Linux kernel
and then on top of Linux kernel there
are libraries and there is Android
virtual machine that is actually a
modified form of Java Virtual Machine
and then these are see libraries and on
top of this layer on top of this lady is
the application framework that that
provides different services to the
application layer and then on top of
this application layer developers can
write their applications so they do add
like vendors do add applications at this
layer the system applications at this
layer and they do heavily modify the
Linux kernel layer also we observe that
there
there are no changes at this little very
minimum changes at frame of year so as
you know the device drivers work on a
kernel layer and drivers communicate
with the apps through the frame of you
so this customization process should not
degrade security at both the framework
layer and the colonel layer so actually
if you are familiar with Android
permission model what happens is that
the pep the permissions are checked at
the application framework layer and then
after checking the permissions they are
in force at the kernel layer so somehow
if the app can bypass the application
framework layer and the colonel layer
just talk directly to Colonel layer for
example by just writing C code like in C
code is some somewhere here I mean they
can just talk to Colonel without going
through application framework layer so
then they can just bypass permissions so
they need to like if they modify
something at the kernel layer and there
so they need to make sure that this is
consistent with Colonel layer so the
customizations that are done at the
kernel level a layer they customizes
different things so we analyzed a
different phones for like what type of
customization have been done and on a
samsung galaxy s3 what they what you can
see is that forty four forty three
percent of the customization in the
kernel are being done for in the driver
folder and this architecture is all they
are also drivers but their drivers like
four processors for GPU and these type
of things which we do not consider in
our study because we cannot exploit them
next twenty percent is the other changes
I mean they do it for other purposes and
on samsung galaxy s
to you can see that they're even more
driver changes and less remaining
changes so this just means that it at
the kernel layer the heavily customizes
the drivers and at the framework layer
they do not customized much I mean
pretty much are the same so how Android
security model work is that Android
security model is built on top of Linux
user name process protection so every
app on Android is a user it it is
assigned a UID and then it is protected
using Linux user isolation and every app
can just access the data that is in its
own sandbox it cannot access the data of
any other app and if application wants
to access system resources for example
camera Bluetooth NFC it needs to ask for
a permission at install time when you
install an app it will ask for
permissions and at that time the user
agrees and after that the app have these
permissions so what happens is that at
the install time when you give an app
permission for some resource then an app
is granted permission and it is assigned
to the corresponding linings group so
there will be a group for example for
GPS and then it will be assigned to
their group this is how they check if
the app has permission at Colonel layer
so resources on Android need to be
protected both at the cut at the
framework layer because at the framework
layer it checks if an app has the
permission or not to access the resource
and at the same time they need to
enforce it on the kernel layer because
at the kernel is where the resource the
device and not exist device file exists
driver exists so these two needs to be
consistent with each other
so this is very challenging task if you
modify anything at the colonel and then
make sure that it is consistent is very
challenging because they have just six
months to customize hours before google
officially he loses it and it's very
difficult to do it properly so they just
don't care about security they just and
yeah as we observed in this study the
driver programmers don't have security
expertise they don't care they just
customizes it and then they just release
the phones and there is no documentation
for hawaii by google to like do this
whole customization process the vendors
are have to do it on their own so to
study this like this whole problems
systematically we have developed an
approach and then we study a large
variety of these security hazards that
are caused by driver customizations so I
mean just to make sure these
terminologies are little confusing so by
phone we mean the like the mobile
smartphone and like any smartphone and
the device actually means the hardware
on the phone for example camera is the
device GPS is a device and device node
or device file we mean an interface for
a for a device tribe so every device in
Linux has a corresponding file so by
this we mean this like a device node we
mean that file so for example for camera
they will have another file for example
dev / video 0 yeah so every device has a
corresponding file in Linux and then we
have other files for example logs and
node files even known file so we call
them device related files so how we
measure the whole like security of the
this customized phone so what we do is
we compare the protection level on the
customized phones to the corresponding
version of android open source code for
example if a phone has an android
version 4.0 3 then we compare the
security of this version to the android
open source project that is we we use it
as a reference of the same version so
here the assumption is that we are not
saying that AOSP sorry this is an error
this is AOSP we we are not saying here
that AOSP is the best has best security
what we are saying is that this
customization process should not degrade
the security of the Android below what
AOSP is providing so we check if the
vendors degrade the security below or
the air over the Android original source
code is providing so the high level idea
is that we first we need to
automatically identify the Linux files
that is like the device node files that
corresponds to different devices for
example camera will have a device device
node in the linux their folder and we
need to identify which rich file
corresponds to camera which is a
non-trivial task I will explain like why
is it non trivial and after we have done
that then we need to compare levels of
protection just we just see the perp the
permissions for example if it is
publicly readable or not and we check
the permission with the corresponding
file in the AOSP so if the if if the
customized file has a different
permission then we say that it can lead
to a security hazard it it is possible
that it does not but it is it is also
possible that it can so like if we
detect this permission change it might
not lead to a hazard but in some cases
it can
so for example in in in in samsung
galaxy s2 camera device is publicly
readable like any any app can read
camera device without any permission so
it's publicly readable yeah I'll show
you a tax also how we exploit that and
carry out attacks so like it does not
need to be publicly readable it should
be just readable by the root and the
apps in the camera group so this is how
the customization flow works if you want
to take a picture you go through this
manager and this manager will just it
will check permission and then it will
link you to the camera service but how
it actually this is virtual link how it
happens is that it first talked to a
binding device this binding is just a
device is just a driver through which
this app will send an int'l procedural
call so whenever whenever an app wants
to communicate with this service it
needs to send a message through this
device binder this is virtual thing and
this is how how it actually were
actually works so then it talks to this
camera device through this binder and
then and then this goes down like this I
mean it can talk through like this
framework layer permissions and now you
can see if there is another app that is
like native app which means if you have
written it in C then you if if it is
written in C that means that you have
bypassed the application framework layer
if you have written it in c you can just
access the library's directly and you
can just bypass this whole permission
system and just talk to the camera so
the like the whole thing is that this
permission is being checked here but it
should also guarantee that this file is
not readable publicly if it is then you
can just go like this with just
bypassing the framework later and just
read the camera file just get access to
the camera file so there are many
challenges to study this problem like on
a large scale so correlating the devices
to the corresponding device note is ha
for example a NFC device so NFC sends
for Near Field Communication you can
yeah and so it is like one device and
the name of this device on google nexus
4 is like this and on sexy s2 is this
and it readies on every device and we
don't have any idea what it is without
ya knowing something about this I mean
so it so this was really hard how do how
how we figure out this so we created a
tool to do this this mapping yeah and
like depending upon render this can be
arbitrated like it does not depend upon
anything so to study this a problem in a
systematic way we develop this tool that
we call addicted yeah it stand for
android device customization error
detector so it has two components one is
device minor that finds out device nodes
for a device and then it has another
component that we call risk identifier
that check the corresponding device
nodes with with their counterparts on on
the Android source code so this is how
it looks like this is a complete design
of addicted this is smart phone and the
smartphone is running an application
that we call test runner and then it has
our dynamic analyzer that will yeah that
I'll I'll explain later but what happens
is that we have test case so test case
is just like take picture I mean if you
want to see if you want to see the
device node for camera this test case
can we just like take picture
and this reference test case is that we
need to write a complete app right to
take picture so this reference desk is
just means that it is a complete
application but it will not take picture
so all all noise that will come out of
it like okay let me explain this another
way so what happens is that we have this
test runner and so test runner will run
this test like take picture and dynamic
analyzer will analyze all the system
calls so the hope is that if we analyze
the system call then one system call
will touch the file device notes and
from there we will pick out that this
file is is related to this device now
the problem is there is lot of noise
there are many processes running how we
find out that this device like this call
should corresponds to this device not so
for that we have this reference test
case which is the same app but it does
not take a picture so then we redo this
test think and analyze it again so and
then here we just filter out the noise
and we do it repeatedly like so many
times until we get constant so we are
sure that a device note that we are
getting is just because of the test case
that is like take a picture that is
related to the device that we need so
and at that point we add it to a
database and after that so now as I have
shown you that even at this point we
just know that this test like this this
device not put it in the database is
related to camera but then it can be a
completely different device on AOSP like
the name can be completely different so
we also fingerprint the system calls for
for this device and if we create a
fingerprint that will and and then we
find identical
fingerprint in AOSP for a 440 file then
if we have identical fingerprint that
means that these devices are doing the
same thing for example if two files have
identical fingerprint and this one was
camera then they they both corresponds
to camera at that point we are sure that
the Duke are the these two files
correspond to the same device and then
we correlate the permissions and see the
permission what's the permission level
add in a OSP and were superb well
permission level in customized OS and
after that we just reported like say
that the it is a customization flaw or
not so what else you have stand for is
lightly customization flaw because it
might not be a customization fly it
might be some false positive but we
output all of them any questions okay
so yeah device minor is just like it
traces operations on Android to identify
related linux device files so static
analysis here like to do the same task
is very hard because the code is written
in both Java and and and hand kernel is
in C and also there is no tool no static
analysis tool available that works and
dynamic analysis if you want to do that
then it requires extensive
instrumentation in the in the operating
system so what we did is we we wrote our
own and the dynamic and net analysis
tool so what it does is that at so when
we run this test and when the app wants
to communicate to this device it goes
through it goes through this check this
channel so when it comes here at this
point we know that the app wants to
communicate with this service and now
this device we we instrumented device
binder like we edit code here and then
this this device binder will actually
launch the tracer that is like estrace
so this this application when when it is
attached to any process it will log it
will record all the system calls Jenna
Jenna Jenna generated by that process so
we attach it to these system processes
and we also attach it to the application
because sometimes this application might
access directly the colonel and it might
not go through here so we attach it to
here also and yeah this is way we attach
it and then we records the all the
system calls and once we remove all the
noise and everything we get we will get
a file descriptor for this file and then
we find out that this file is related to
this device
so we do this type of lightweight
dynamic analysis and as for for tracing
we use estrace yeah so this is the test
cases that we ran for different devices
we done it for camera NFC audio radio
external solid GPS and they need these
permissions if you want to access these
resources you need these permissions and
like these other like frame buffer you
cannot even excess it so frame buffer is
actually it stores your screen whatever
appears on on your screen is stored in
frame buffer so you cannot access it
like it's very dangerous but still there
is a device node for it and same for
these other devices yeah and then we do
these type of test cases to test each
each device to to remove noise we do
like extensive differential analysis and
see like so we then test cases again and
again again and again such that we get a
constant number the constant
intersection of all these test cases
which means that these nodes actually
corresponds to the device and they are
not because of some noise so after that
we have this risk identifier which just
compares with with with the reference so
for example this is one device and that
is on a customized phone and this is
other device that is in the reference so
the reference permission is like it's
not publicly accessible and here you
have publicly accessible so this is uh
no sorry this is not publicly accessible
is zero and this is publicly accessible
so this means that this is a
customization flaw which means that this
allows any app without any permission to
read this file which which we do not
want
so we did this on three different phones
gleg cs2 grand and s3 and we found these
customization flaws that is in Lexi s2
we can access the camera note both this
is front camera this is back camera both
of them are publicly accessible same for
a Black Sea Grant and input touchscreen
so this is another one livability that
we discovered that is whatever you
touches on the screen it's like it is
locked and this should not be publicly
readable and this is also publicly
available and there's frame buffer I
mean as I showed you the like frame
buffer should not be accessible by any
application it stores everything that
appears on the screen and in this galaxy
s3 this is this is only yeah and so I
mean all of these all of these
vulnerabilities allow very high impact
attacks and we develop a three different
attacks based on these one these issues
and so our our adversary model for these
attacks is there is like these malicious
apps running on the phone I like we
assume there is one app that is running
on the phone and the intention of that
app is bad like it can be any app for
example if Angry Birds want to do this
attack they can I'm if anybody wants to
do an attack they can and yeah and all
these apps that we developed they do not
have root root permissions and they also
do not have a permission to use the
device for example if I want to take a
picture with these apps they do not have
camera permission so we first develop
the touch screen loggers our tool
addicted found that deb input even to
file like this is a min to file this is
public on galaxias to samsung galaxy s2
yeah and many other phones have this
problem and lexie s2 is like the
was the flagship phone of samsung this
was a phone which like gave them the
break-up well I so like millions of
people are using this and and it's not
just because of like just limited to
this and this is like and this problem
is valid for many other forms of so we
exploit this vulnerability and we can we
can lock the screen without any
permissions so if you can lock the
screen then I mean if you so you know
how your phone where your keyboard is on
the phone right so then you just like
you just need to fingerprint like like
this position like XY position
corresponds to a this position
corresponds to be so I mean whatever you
type and any app can steal this dead so
if you type your password they can log
it and yeah yeah again without any
permissions and then we have a camera
attack that allows you on samsung galaxy
s2 that that allows any app to take
pictures without any permissions so like
I mean your phone can take pictures you
will not you will never know what's
what's happening and so for the camera
attack the attack is non-trivial because
if we have the camera it wants to take
picture this is the camera app we need
permission checking it it needs to tech
talk with this camera hardware
abstraction level and then this is like
how you talk to driver and then in the
kernel a layer it talks with driver and
out after that they just you can just
talk to the hardware so we tried this
approach because this camera driver I
mean we have all the permissions like
it's publicly accessible but this way it
was hard to figure out the protocol so
the phone keep rebooting again and again
so we didn't know what to do so what we
did is we wrote our own
when we put the complete this this
library we this is like the open source
driver we put it in our app as a native
library and then we just talk directly
to the dry camera driver so this this is
also possible but it it it would have
taken more time or something so another
we exploit the frame buffer one a frame
buffer issue and now we can take
screenshots and if you can take
screenshots that pretty much means that
you can steal whatever is is shown on
your screen which means everything you
type your password pictures anything and
and this is again because of this file
is publically available and I for this
app we just need SD card permission so
we can store the how we can store the
screenshot so now I can shoot attacks we
have attacked demos
so this is the touchscreen logger attack
so you can see that this app is running
on the phone and we will like if we will
just show you that it does not have any
permission if the app has put any / any
permission it will show up here we are
sure it does not have any permission and
now you launch this app and you can see
this is actually the our server like
adversity server you can see it's
getting the location pressure and
everything that's displayed on the
screen so you get like all the
coordinates on the screen yeah we have
just blinded it because of when we
submitted the paper we didn't change it
yeah
so this is the our test screen lago de
tag so this next is our screenshot
attack so again we show that this this
will just have a SD card right
permission so it can just change SD card
because we really V if we need to store
somewhere the screenshots and now you
see screen captures there is no screen
captures this can happen in the
background also for the demo when we
wrote this app so we can show that we
started app and everything everything
can happen in the background without
user interaction so this is taking
screenshot periodically this app is
taking screenshot pretty periodically
now open it it it has taken all these
screenshots without any permission and
screenshot like there is no permission
to get screenshot screenshot is like
very dangerous they don't have any
permission to take screenshot yeah so it
just goes on hinder it shows this and
yeah we have this final attack which is
very interesting that now it can take
pictures so again it does not have any
permission
it does not have any permission
so this is our attack app
Oh
it's YouTube it's not know what had
so they're just coined showing that we
are taking image yeah so we just out of
the app visible yeah okay i am not sure
if you see it but he put the coin and
then it took the picture of the coin
yeah and this is like all without any
permissions so like these are very high
impact attacks if you can take pictures
without any permissions that's very
dangerous and that's also on flagship
phones so then I mean this is just like
on three phones then we did a large
scale measurement study to find out if
how like how widespread this problem is
so for this we collected 2500 images
approximately and they corresponds to
like 288 distinct models so some of them
are like four different upgrades and
like different updates for every model
but we have to ET eight distinct models
in 243 and 2,500 images so I mean
Samsung provide these images they upload
all the all that images online so we
were able to download it from there and
the rest we down from like this other
third party websites so you can see this
different distribution of Android
version the most like the most phones
has android 4.1 point2 at some has 4.0
point 4 and this is just a distribution
of the end android versions so we did a
wide like analysis on all of these
images 2500 images and we find that
fifty-three percent of these images
contains these likely customization
flaws and like they have they are like
they belong to variety of phones because
of these images
and then forty percent have video
vulnerable which means that forty
percent of these can take pictures
without any permission and then we also
discover that other lcf there are other
lcf that we discovered that might or
might not be a problem it needs to be
studied in detail but we discover
they're like 28 issues input there's
like just one note that corresponds to
input and for video there are five
different notes that we discovered and
say that a frame of frame buffer is
standard just FB so they were like 1290
images have these lcfs 952 images has a
video issue and same some heads in
Poland some has this but but you can see
these are like widespread and our our
attacks were possible so our like camera
attack is possible just because of this
so on 952 images that can be like
something like 100 models there's like
millions of phones you can take pictures
without permission so this is like the
dude distribution how these are
distribution throughout the world and so
each image has a code like if it is from
if this image is for China then they had
like oh like chn so from that we figured
out that so in Chinese spoons I have
most LCS and less in u.s. lesson yeah
maybe this is NSA NSA has a role here
else not sure just like yeah but for
some reason we find I mean this is like
maybe on the same device models same
device models that is distributed in
China it has different lcf than the same
model in US so a different device
manufacturing carriers like AT&amp;amp;T and
these other church china mobile and
tmobile they also customizes these
images and that is we found out that in
the like from the korea they have more
post so model with lcf means that they
can be customization flaws but we don't
know but this committee confound means
that we know that they can cause
security issues so you can see that
they're like widespread less in US but
more in other countries yeah so this is
how different versions of OS I I
distributed most of them have four point
zero point three so that lexi is too
fond that we showed it has this version
4.0 point three or four point zero point
four so I mean then we studied if the
upgrade process like whenever the up
operating system is upgraded to a new
version whether they solve this problem
or not and we find out they they like
they fix at least one this customization
flaw in 53 models and they fixed all
these flaws in six they fixed l-like
they fix some and then like they fixed
in one version and then show up in again
in the next version we found two of
those also and they also introduced new
customization flaws and like these
customizations laws are not just because
sometimes they know what they are doing
but they need it for example for if they
have a different type of camera they
need to interact with a different driver
and they cannot so they just make it
public yeah so in conclusion I would
like to say that these like these vendor
heavily customizes the phone and that we
did a first step to study the impact of
these customizations on the security of
these devices and they this
customization do degrade the security
like to a horrible level and millions of
phones are affected from these
vulnerabilities we are like we are now
working to write an app that like that
that will tell you if your phone has
these issues or not yeah but we we talk
to Samsung I mean we actually talked to
Google when we found this issue with the
forwarded us to Samsung sensing is now
like we
we work with samsung to fix these issues
yeah i'm not sure if they're they fix it
all but we are working with them and we
like told them that these are the issues
with your phone like for ethical
purposes and in return the senders and
North reform yeah they have a very small
bug bug if that's a should you have any
questions I think so yeah this the yet
they might have thought that their life
like they were at least like impressed
so they offered job now of what in same
thing is research to the first author
like mike cooley now he yeah so they're
really impressed that this is there were
six places the upgrades produced
introduce these ourselves new yeah so
Jill distribution of that was
here's the slow yeah if we can do that
really knew what was happening to be
biased or lucerne actually don't you
really suspicious yeah actually we do
not claim anything about like this is
because of the region it might be but
yeah but yeah I mean this this can be
introduced as far as yes if the
intention interior</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>