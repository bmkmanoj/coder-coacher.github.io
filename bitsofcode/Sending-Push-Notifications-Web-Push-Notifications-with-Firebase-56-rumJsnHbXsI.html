<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Sending Push Notifications | Web Push Notifications with Firebase (5/6) | Coder Coacher - Coaching Coders</title><meta content="Sending Push Notifications | Web Push Notifications with Firebase (5/6) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/bitsofcode/">bitsofcode</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Sending Push Notifications | Web Push Notifications with Firebase (5/6)</b></h2><h5 class="post__date">2017-09-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/rumJsnHbXsI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so finally we're getting to the part
where we can actually send notifications
and we do that using firebases new
functions and if you noticed at the
beginning this functions directory was
created for us and its own project has
its own package JSON node modules and
what we really need here is this index
dot JSON files
so as you can see here we have just the
functions but we need to include one
more thing which is the firebase admin
so I'm just gonna add that right there
admin equals to require our thanks admin
which if you check the package JSON you
can see that it sorry there it just
wasn't included and then finally what we
want to do is initialize the application
so under the admin we call initialize
app and then we pass it the admin option
all we need to know is just call
functions dot config dot iron base and
there we've initialized like firebase
function and firebase admin so each
function that we want to create so we
export it so what I'm gonna do is create
exports don't send notification which is
the function that we want to export and
the way we're gonna do it is first of
all we want like I said before to check
that notifications node to see if
something new has been created and the
way we can do that is listen for changes
on that particular node and this is how
we good we do functions dot database dot
wrath and as you know that we have it on
the notifications right so we can do
notifications but we don't want to do it
on the entire reference we want to do it
on any particular node that's created so
what we can do is just say slash
notification ID and that is putting the
reference on a particular node not the
entire array so on that reference and
you can see here we want to check the on
rights
you want to check if there's anything
being written to that particular note
and every turn is immigrant and this is
where we're going to do all our logic so
we're just checking for any rights
that's happening on that note and then
you can do a bunch of stuff the first
thing we want to do is check to make
sure that it's a new notification being
created so we don't want our
notification to be sense whenever
someone might be editing like a note or
if it's been deleted or anything like
that so we doesn't want to check for a
new addition so what we can do just
write a very simple if statement so then
so that's checking to see if the data is
being edited like if it's already
created and so we can just return like
we don't want anything to happen and
then we can write another one to see if
the data is being committed so what we
can do is just check to see if it exists
and then check if it doesn't exist and
if not we can just return now we want to
get to actually creating the
notification that we want to send so
first of all we need to actually get the
data so let's just take a snapshot a
snapshot of the data that was being
written and then we can actually set up
the payload that we want this is an
object and it's gonna take a parameter
which is called notification and this is
where we're gonna write like the message
the title and the icon for that's
notification so first of all we want the
title and what I just wanted to say is
new message from and then the person's
user name so let's just go new message
from and now I want to do is get the
user name from the notification that was
passed so if we actually go back to our
database we can see that here we have
the user's name and stored under you
so what we need to do is take the
snapshot and then take the value of that
snapshots and then past user next thing
is that we want the body of the
notification so and this is basically
just if we go back here we can see
message so let's just take this and then
top message now we want the notification
icon here and I believe we stored it as
user profile image so the user profile
image and finally we want to redirect
the user to the application if they were
to click on the notification not that
it's actually being saved so it's not
gonna do anything but just to show that
we can do it and to do that we have
click underscore action and what we want
here is the URL for our application and
we can get it similar to how we
initialize our application here can
actually just get that so first of all
we want to just pass in the protocol and
then do that all we need to call off
domain on it so now we have the payload
that we want to send but what I want to
do is actually just console.log it
somewhere so we can check to make sure
everything is fine
so what I'm gonna do is consult on info
payload and the reason I'm using consult
our info here is because there's a
special log section for five based
functions but in my experience if you
just write console download you won't
show so you have to use the specific
type of log that you want so I'm using
console info here now if I were to open
up my terminal again and what we want to
do if we go back here is the prior
application so similar to how we
deployed only hosting before now we just
want to deploy a function so we don't
want to be flowing the entire
applications every time you change
something only two functions let's do
that okay so our functions have now been
deployed let's go
back to our firebase that one here and
you can see that there is a tab for
functions if I were to click on that
hopefully we should see our new function
which is called send notifications and
yeah you can see it right here and you
can see that it's on this node
notification slash the idea of the
notification so if I were to click on it
or you can click on it if I was to go to
logs so there are no logs gets obviously
because we haven't really done anything
but let's actually test it out now so if
I go back to my application here and I
say this is a test ok then I send that
we go back to our functions it takes a
while sometimes for it to come up but we
just have to wait a bit ok so now you
can see the log here and we can see that
the function has started you can ignore
this thing about billing because we're
not gonna like add our details right now
and then we can see the notification
that I just logged so we can see here
that we have the title new message from
it correctly says my name whoops
then we have the body here says there's
a test of the logs or whatever and we
have the icon that we selected which is
like the profile image and then click
action will take us to the URL for our
application so that looks really great
we've essentially created the
notification and sending it is gonna be
really easy as we can see so to send the
notification first of all we obviously
need to get all the tokens of all the
users that have been subscribed and as
you know that we have our tokens node
which has this information so similar to
how we've been doing it if we just need
to get the array of notification tokens
and send to each of those so all we
should do is return admin interface
dollar F and this time we're getting
tokens and then we just want to get the
value once which you can do that dot
then
Pizza so this is just gonna give us the
array of all the data and let's just do
a quick if statement to make sure that
there's actually value there so just in
case there are no like tokens there we
don't want to cause like a huge error so
let's just return so first let's just
take a snapshot of the data found and
then let's just create an empty array of
the tokens that we're going to do so
what we're gonna do is loop through the
snapshots array which isn't actually an
arrays and objects and then we're going
to create like an actual proper array of
just the token strings which is what
firebase needs to send to them so so
anything right we're just gonna do or
let clean and stop shots and then I'm
gonna do token stop push so snapshot
value or actually it stopped talking
because the value we already have to
bother you there we weren't talkin so if
we go back to our database you can see
that we have token and Urd so this is
the snapshot and then this is token and
sending the notification all we have to
do is pass the array of tokens which
we've just generated here and then also
pass the payload that we want to send so
let's go to intern admin the messaging
this time whoops
oops looks like I made a mistake here
dot database hope I didn't make up some
a mistake anywhere else but looks like
it is working so far so dot send to
device and as you can see this takes a
registration token either string or an
array of strings which we have in the
tokens here then we have payloads so
which is the variable that we created
objects okay load
and that is pretty much it's to send the
notifications so what we're gonna do is
toggle my terminal here and let's just
deploy the functions again and then
we'll test it out to see if it works so
the functions have been deployed and now
I'm back in my other browsers to just
test it out so I'm just going to say
something I say hello and then send and
that just hope it works
yay so you can see that I've got the
notification here so and this
notification is being sent from the
other instance that I have which is in
my chrome running on localhost so that's
pretty much it's we've created an
application that just send those sends
notifications as I've said here it's
simple and it's pretty useless but at
least we've created it so I noticed one
thing that I actually did wrong which
was here I put icons instead of iPhone
which is why in that notification you
saw it wasn't working but I've changed
that now and everything should be
working fine but next what I want to do
is just some final cleanup of our
database because as you can see here we
have all the notifications here and we
don't really want to keep them because
as I said this is kind of a useless
application and all it does is send one
notification and that's it so what we
want to do is actually delete that and
secondly what we want to also do is make
sure that if any of the tokens fail so
let's say someone just manually goes to
unsubscribe so the token is not bad
anymore we also wanted to meet that from
our database as well so we're gonna do
those two things and hopefully you won't
take so long so after we send to device
here this actually returns a promise
with the response like the results which
also includes things like any errors
that happen
so after here what we just want to do is
get the response I'm gonna create a
function that will clean the invalid
tokens
what I'm just gonna do is pass the
results of the response Oh respond start
results let's create this function here
so here we have their results but
besides the results what we also need is
each of these tokens that have been
passed and we also want their key that
they are saved by in the database
because that's how we're going to
reference them even though we can't
perform a query together it's just
easier seeing as we have that
information here to just pass that as
well so I'm gonna create another array
here called tokens with key and in this
loop I'm gonna pass a different object
so this is going to sing token which is
gonna be the same thing that we have
here and then we're also going to have
key which is just sticking here so now
we have these two things and instead of
just passing the results were also gonna
pass this array here so let's do that
and then here in our function we're
actually using it so that's that we've
created the function let's actually do
it wait a second for some reason I
didn't add the word function which is
weird but no wonder I was getting that
error anyway so we've created our
function here now we want to actually do
stuff with it so first let's just create
an array of invalid tokens so we're
gonna actually link through all the
results and see if it wasn't violent and
if it is then we're going to push to
this array not just the token but the
action that we want to take to delete
the token so we can just at the end
return from stall and have everything
don't stuff for each results and first
we actually want to check to see if
there was an error because this is just
showing every single results so
everything we sent to so if we don't
have an error result of error and
just return but we don't really want to
do anything here but if we do we want to
check what's the error actually is and
then we want to meet it because they're
different error messages and we only
want to delete it if it's one of the
ones that says this token is no longer
valid so let's just look at the error
code so it's a code and there are two
cases that we are worried about so one
says messaging and I'm reading this off
somewhere let's have a look invalid
registration token or there's another
case which says messaging and it's
registration token not registered so for
each of these cases that's gonna break
just like doing as long so I'm just
writing it this way just in case there's
something also wants to do with a
different type of error message so in
this case this is where we want to push
the really action that we want to take
so let's do invalid tokens
don't push and like I said we're not
just pushing the token itself or pushing
the action to delete the token so if we
remember we have admin database daraa
tokens and then it's dot child and then
we need the key and that's why we passed
those tokens with key
and since we're looping through this
we're looping through it in order so we
also have an index which we can access
here what we can do is access tokens
with key dot P and then all we have to
do is call don't remove on that so now
at the end of this we should have an
array of all the tokens that we want to
be remove so what we can do is return
almost all
and invalid to Achilles one other thing
we can do that's kind of useful just for
our own logging purposes you can just
say that in our console notes that there
was an Arab before anything happens so
that way we can just double check to
make sure things are great
so with token and then you can just say
see me I'm accessing here but seeing us
we also have the token itself in dude
token so yeah we're gonna return forms
to all of our tokens so that should work
fine but let's also do the second thing
I said well that we should do which is
to deletes the notification message that
was just added there so we can do that
it's gonna be pretty simple in one leg
here so seeing as that is returning like
a promise we can just do that then on
that as well the same way we are
removing the token here I'm just gonna
copy this actually because it's pretty
much what we want to do it but what we
want to do is go to notifications and
then instead of this key we want the
notification key so if we go here we
have a snapshot of the notification so
if I just go back and I place this this
should actually delete the notification
there as well so let's do one final push
of our functions and hopefully
everything should work so I was getting
an error deploying the function and I
realized that I was I just wrote to this
year I didn't write doc push so there's
an actual error with the function let's
try that one more time hopefully there
are no other errors so it's all deployed
now let's try and test it out so I'm
gonna go back to this version which is
like the vibration let me just refresh
the page and I'm just gonna send out a
test
actually first of all what I should do
is go back here and delete the
notifications that are here just so we
can make sure that there's gonna be no
notifications there that last seeing us
for deleting them so let me just go back
here and say this and send it and yeah I
got the notification you can see the
image now that I fixed one before so
let's go back to our database and yeah
we can see that it's been deleted like
there's no notifications note here
because in our function is actually me
turrets so now we want to test what
happens if one of the tokens actually
fail so what I'm gonna do is just edit
one of these so it's like becomes
rubbish and become something that's not
going to actually success when you send
and I'm gonna send another notification
go back again so this should fail like
that I should actually still get a
notification because yeah as I thought
that token wasn't open for this actual
user so that's why I still see a
notification but if I go back hopefully
yes you can see that that token was
deleted because it didn't go with a box
thing so if I actually sorry for all the
switching hmm so if I actually go back
here and refresh the page it should say
subscribe yeah because the user's token
is no longer there because it wants to
reach out so let me just subscribe yeah
so that is basically it we've pretty
much finished our application but
there's just one more thing I want to do
which is the firebase database like
optimizations and security so that's
what we're about to do next</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>