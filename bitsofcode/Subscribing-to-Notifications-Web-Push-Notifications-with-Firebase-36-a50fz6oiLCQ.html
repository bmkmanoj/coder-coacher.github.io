<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Subscribing to Notifications | Web Push Notifications with Firebase (3/6) | Coder Coacher - Coaching Coders</title><meta content="Subscribing to Notifications | Web Push Notifications with Firebase (3/6) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/bitsofcode/">bitsofcode</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Subscribing to Notifications | Web Push Notifications with Firebase (3/6)</b></h2><h5 class="post__date">2017-09-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/a50fz6oiLCQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">now we want the users to be able to
subscribe to notifications on the page
and again firebase makes this really
easy to do the person we need to do is
create a serviceworker file specifically
for firebase messaging so we're just
gonna do is create firebase messaging
service like a dot j/s I mistakenly made
this in the J's file but you need to put
this in your root directories so there
it is there and if we quickly go over to
the firebase dogs we can see that we
need to import certain scripts and
initialize our application so we do this
slightly differently because we don't
actually need to reference these
absolute URLs here so I'm just gonna
copy and paste something that I have on
file and you can get this from the
repository as well or you can just copy
it so here are the files that we need to
include and then we're just initializing
firebase messaging so that's all we need
to do we don't need to even reference
this file anywhere we just have to have
it there and make it make sure that it's
called firebase messaging service worker
doc GIS so now like how we created a
sign-in button we're just gonna create a
subscribe button let's just do that
right here what's in subscribe ID and
then back here like we always do we're
just gonna create a reference to it and
then we're going to create an event
listener this is a function that we are
about to create let's go down it's just
a dick here to notifications now the
whole subscription process takes about
three steps for us first we need to
request the users permission so get that
pop-up that you've probably seen where
it says this site wants to send you
notifications then once we've done that
gods in the users permission we need
get the token and then after that we
need to save the to token to the
database so that we can actually like
references to be sending notification so
let's just take it step by step
first thing is request permission so if
we go up here we have the firebase
messaging and to do that all we need to
do is click firebase messaging don't
request permission really simple rights
so let's just check that out right now
let's go back to our file so let's
refresh the page we have a subscribe
button so we click the subscribe button
and then we can see that the new chime
pop-up comes up and really really simple
so the user can say allow or block so
let's just click allow but we haven't
really done anything to handle that so
that comes to the second part which is
where we actually get the token let's go
back here so so then after you
successfully got some bats we now want
to get token so we just called fairies
and messaging dr. catch open and then we
have the token here and that's just
console.log okay I'm gonna add the catch
here and let's just add sad face okay so
let's go back again refresh the page
when I click Subscribe this time the
puppet doesn't come again obviously
because we've already gotten permission
but we've gotten the token and you can
see this is what it is here so let's go
back and now what we want to do the
third part is save it to the database so
instead of just console logging the
program can still have it there but
let's just do more stuff here so to add
save stuff to the firebase database we
need a reference to where we want to
interact with the database with so let's
go back here we have our database on
variable
so we're just gonna paste it here and go
dot reference dot wrap I mean 1
/children should just be an array of all
the token so I'm gonna have an object
that has both the token itself and then
the user who's talking it is so all we
have to do to add a new item to that
array it's just push so basically just
like JavaScript and then the object that
I want to push here so first of all the
token okay and then the user's ID so you
ID and we can get the current users ID
by referencing firebase off and then we
have the current user object and that is
just whichever the corn user is
obviously and then their ID ID so let's
do that so let's check it out so first
of all let's just go and do this again
so subscribe again we have the token
then I'm gonna go back to the database
and we can see that we now have in you
node which is called tokens funds and
inside it we have an object and this is
just a random ID that firebase assigns
to the object then we have the two
things that we've specified here so the
users ID and then their token so now we
have a place where all our tokens are
being saved and we can reference them
anyone's actually send notifications out
later so before we move on I'm just
gonna refactor this a little bit because
like how we have this off States changed
function fry based messaging has a
similar thing which is if the token has
been refreshed so what I want to do is
create a different function here so
firebase messaging dot on token refresh
then I'm gonna say handle token real
crush so I'm gonna create another
function then refresh and what is going
to do is just get the token and save the
token to the database so essentially
this logic
I want to move it to a separate function
so here I'm gonna just have just gonna
copy this don't get token you can
actually just do this yeah done that I'm
just gonna return it so instead of this
part where I'm just doing a manually
here I'm just gonna remove this and just
call this function handle token refresh
instead so this way we don't have to
have the same thing it's in twice don't
repeat yourself as you probably know
so next like we have a sign-up button we
also need to provide a way for users to
unsubscribe so we're just gonna go back
here again and just do unsubscribe I
cannot type unsubscribe okay so I'm just
gonna quickly do the same thing that
we've been doing here so I'm subscribe
alright then we're gonna have
unsubscribe button and then we're gonna
have fun subscribe from educators and
let's quickly create this function here
so subscribe and similar to subscribe to
notifications we have a few steps to go
through it so what we want to do when we
are subscribed is first delete the token
from firebase messaging and then also
deletes it from our database so the
first thing we need to do is obviously
get the token so firebase messaging get
token and then with the token always do
is called pry based messaging doctor
meets token and then pass in the token
so that's step one then the next step is
to delete it from our database and to do
that we need to query our database and
find that node or that objects where the
UID is equals to the current users ID so
that's just good stop then so let's get
the firebase database okay there it is
firebase database don't wrath tokens so
what I want to do is order the list of
tokens by the specific child which is
like the UID users ID and make sure that
we're only getting instances where it's
equals to the current users ID so we can
do that here when you order my child and
then let's just do UID and then dot
equal to think that's what it is
equal to and then to get the current
users ID you can just copy this one here
and then we just want the value so we
just want to get an instance of that
value here so doc then let's just
hopefully see that we have the same
thing snapshot
snapshot and let's just see that we
actually have the current thing going on
here
so it's refresh the page and then click
unsubscribe and story about this warning
for now I'll get into how we can
optimize the database later but we can
see here actually five these values are
a bit weird so if you actually want to
see the correct value we just need to
call snapshot file actually let's go
back refresh I'm going to try this again
and subscribe and then we can actually
see the value here so you can see the
user ID which is going to be the same
you actually want to check UID yeah yeah
so we want to actually just meet that
from the database
so what we need to do is get a reference
to that particular node and then call
dr. needs on X so to get the key or we
can do is use object or keys on snapshot
bomb and just get the first key because
we know it's like just one and then what
we can do is return firebase don't wrap
tokens so accessing that again but first
of all and then we're using the key I
don't have to just called don't remove
on it and that is it like the users node
will be removed so that's quickly check
to see that work so let's refresh the
page click on subscribe and then if we
go back to our database we can see that
it's been deleted so that's subscribe
and unsubscribe and finally we just want
to change things with the buttons again
like we didn't sign in/sign now we want
to hide or show what's in these
depending on what the user has been
subscribed or unsubscribed so i'm gonna
do that real quick right now
first of all I'm gonna do is just create
a function to actually check if the
users data is there so that's just
create a function that it says function
should check some description right and
we're gonna actually call this whenever
we see that there is a user and we can
also call it whenever these are
subscribes on subscribes you want to
check it again
so what we want to do is actually check
to see you can just copy this right here
we're trying to check to see if that
value actually exists so snapshot so if
it's not shot
so similar to what we did here with
hiding and not hiding in fact I'm just
gonna copy this so if the user is
subscribed we want the subscribe button
to be hidden and then the ups and
subscribe button to not be hidden and
just to be opposite there and then
subscribe button and if we just go back
to our HTML I want to hide both of these
by default and then what we want to do
is call this check subscription once and
only if there is a user so you can come
here and do check a subscription so as
you see what we're doing here
first of all checking to see if there's
a user if there is then we want to check
if they're subscribed and that's when
they subscribe or unsubscribe button can
be shown or hidden so let's just check
to see hopefully that works refresh the
page okay cool
so we can see that's the user hasn't
been subscribed so the subscribe button
shows and one thing I forgot to do is we
want to call check subscription after
the user has subscribed or unsubscribe
so that they get like instance so they
get instant feedback so if we go to our
SUBSCRIBE function we can just call doc
10 check subscription oops stop doing
that and we can do the same thing here
but then should probably add a dog hatch
here somewhere
just in case unsubscribe failed sad face
so okay let's try this so let's refresh
so subscribe button shows let's click it
okay unsubscribe is now showing you can
actually go back to our database see
that we have a choke in there let's go
back and then unsubscribe and then the
button changes and you can go back and
see that in Sweden
so there's gonna subscribe because
obviously that's kind of what I want to
do here and we fresh the page and we are
all good</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>