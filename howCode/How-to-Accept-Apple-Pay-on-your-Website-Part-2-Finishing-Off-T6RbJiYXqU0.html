<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>How to Accept Apple Pay on your Website - Part 2 - Finishing Off! | Coder Coacher - Coaching Coders</title><meta content="How to Accept Apple Pay on your Website - Part 2 - Finishing Off! - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/howCode/">howCode</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>How to Accept Apple Pay on your Website - Part 2 - Finishing Off!</b></h2><h5 class="post__date">2016-11-30</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/T6RbJiYXqU0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so in the last video we set up
everything we needed to setup on the
iPhone now we just need to finish
setting up the server so the first thing
we need to do is actually enable HTTPS
for our server because as you can see if
we just type this in it will actually
load because we're not serving anything
over HTTPS we don't actually have HTTP
setup yet so to get Nasus our
certificate we're going to use let's
encrypt which is the free certificate
authority that gives a SSL certificates
so we're going to install their software
we're just going to paste this in here
and we're going to hit enter and it's
already installed so what we want to do
is we want to say let's encrypt - -
Apache and it's just going to run us
through this installation so we're just
going to hit yes and - the domain name
it's gonna be Apple pay dot Frances
McNamee com hit OK just put in Francis
on haiku org
we're going to choose easy to install it
there we go we're done so if we just
actually go back to the HTTP version
you can see it's all set up
automatically that software did it force
it got the certificate force and
everything
if we click details we can see here is
our certificate
the reason we got the certificate is
Apple pay will only work if we have an
SSL certificate installed on our web
server otherwise it won't actually let
us communicate with Apple pay and we
can't actually take payments so normally
to use Apple pay you have to have the
pad Apple Developer account which is
$100 per year and that's because you
need to tell Apple who you are before
they let you use Apple pay until you be
able to do that you need to have that
special developer account the cost $100
but we can do it for free if we use a
service called stripe which is a payment
provider so we're using stripe because
not only does it mean that Apple pay is
free to set up it also makes it so much
simpler to set up because we don't have
to set up any of the other server-side
things on our server to be able to
handle the payments because if we set
all this up ourselves it would be quite
complicated but stripe makes it
extremely easy and it means we can do in
a couple of minutes so you just want to
create your account and then just put in
your details click create account and
when you have your account we want to go
to the dashboard so the reason you can
see one successful charge is because
that's what I did when I was tasking it
earlier but what we want to do is and
you can see we're in the test mode we're
not actually in live mode so that wasn't
actually a real charged so what we want
to do is we want to go up to the top
here I'm gonna click on our current
settings and you want to go over and
click on Apple pay and what you have to
do is add your domain names so as you
can see I have two domain names here
what I'm gonna do is add the new domain
name I just created Apple pay dot
Francis McNamee com don't load the
verification file and we need to upload
that to our server so what we want to do
is create a directory called dot
well-known so we do that by saying mcdr
dot well-known
go inside a directory so he says CD dot
well-known and here is where we want to
see if the file that stripe is asking us
to download so we dine with the
verification file so this is the file we
need to upload so we just select a lot
and copy it then we go back to the
terminal and then we type in the name of
the file is gonna be Nano apple
developer Merchant ID domain Association
then we want to put in the minus L flag
to prevent Nano from adding a new line
onto the end of the file when we save it
hit enter and we must paste this in we
save that with ctrl X hit yes and hit
enter now we go back to stripe and we
see if that's worked so we go to click
Add here and I should say our domain has
now been verified and now we can use it
with Apple pay so the next thing we want
to do back on our website is we want to
go to the terminal and we want to just
go back into the previous directory and
we want to remove all the files we want
to refresh and you can see we just get
this this is just the page you get when
you have an Apache server serving an
empty folder so here we are on the
stripe documentation and the reason
we're on this page is because it gives
you all of the example code that you
need to actually integrate Apple pay
with your website using stripe so we
just want to copy and paste this code
from stripe paste it in here and we want
to go up here and we want to remove
display:none
to make sure the button actually
displays save that and back on the for
we'll see something like this you can
see it's quite zoomed out so what we're
gonna do is just open this file again
and right up at the top we're just gonna
paste in this and this is a special
matter tag that will make the web page
responsive which will just mean that
it's the correct size and no matter what
device you're viewing it on we'll see if
that and we go back to the phone you can
see now that we've got the correct size
button so what we need to do is just
open us again we want to go back to
stripe we want to copy their JavaScript
paste it at the bottom here and here we
just want to copy this first line this
is just stripe specific stuff aside
actually Apple passed off I just want to
create a script tag for this
piss that in their own server the next
thing we do is create the apple pear
session which once again we can do that
with stripe so we want to copy this and
paste it just below here and what this
does is it says get the apple pear
button add an event listener called
click whenever the button is clicked we
want to run this method called begin
apple pear next what we need to do is
just copy their example function to
create an apple pear session paste it in
here delete this line because this is
the actual session so what this says is
create the payment request and set the
country equal to us that's the default
we can change that if we want the
currency to u.s. dollars we can change
that as well and then the total is going
to be the amount we want to charge the
user and we give them a label and that
label is actually displayed in the apple
pear window before they put their thumb
on the fingerprint sensor to pair for so
we'll leave that at the default for now
and then what we need to do is create
the session this is a wee bit more
complicated but all we have to do is
copy this from the stripe documentation
we just want to copy all that remove
that line and just replace it with the
line we just copied so the first thing
we're doing is we're creating a variable
called session and we're setting it
equal to the iPod at this method from
stripe and what it does is it sends
jQuery post request to have page called
charges which is the way we actually
charge the user because if we don't
actually include this we can go through
all the steps of Apple pay and Apple pay
will say we've been charged but it won't
actually send the charge through the
stripe we can send this charge through
to whatever we want we don't actually
have to use stripe for that but it sends
a request to a page that we have called
charges dot PHP and it sends a token in
the body of the post request again this
is stripe specific stuff we could just
literally call the charges stub PHP page
if we want and not use stripe at all to
actually handle the payment and once the
payments been charged successfully we
run this method called completion and
that tells the user that the Apple pay
transaction was successful and then we
redirect the user to our special page
called success if we want to and then if
it fails we return album finish and up
status failure which just will show the
user that it didn't actually work we can
change this if we want so we just copy
this and if it doesn't work if the post
request fails we tell the user that it
failed by telling the Apple pen session
that it failed so what we're gonna do is
we're gonna actually download this so if
I go up here we're gonna change that to
charges on page P and what we're gonna
do is we're gonna comment on completion
Apple pay sessions on success and we're
gonna paste in failure so no matter what
we're gonna get returned a special
failure message so we're gonna save that
we're gonna create the file called
charges the PHP we're just going to save
it as an empty file and we're going to
go back to the phone now and see what
this actually does so we refresh we tap
on pay so you can see this is the apple
pear dialog we've been brought up with
it says pay hike org and if we go back
to the desktop and scroll down you can
see that the label haiku org and that is
shown in the apple pear window came from
the label we sat in the payment request
variable and that's also where the
amount comes from if we change that in
this variable it will change the amount
that's displayed to the user you can see
that after the post request no matter
what happens it's going to return a
status of failure because we're just
trying to test it out so if I hold down
my thumb on the sensor it's going to do
the request but it's always going to
return failure because that's what we
told it to do so if I add just tried
No
and it says payment not completed we got
an error and it redirected to success
dot HTML
that's because back on index.html we
told it that no matter what happens
we're gonna return album pass and dot
status failure if I change this
and try it one more time even though
charges that PHP doesn't actually do
anything and therefore we'll get a
success message returned so if we just
put our thumb down now
you can see it was successful so no what
we're ready to do is actually charge the
user so we need to download this special
library from stripe we download the zip
file in here we just right click on it
to save the link we go back to our
server and we type in W get and we
download that file now we unzip it might
have to download unzip so we need to
install that salsa after install unzip
and I will unzip that and we'll rename
it from stripe PHP master she just
stripe will remove the master node zip
file and now we have stripe on our
server so now what we'll do is we'll
open charges stop PHP and we'll say
require once
straight slash init.php and here back on
stripes website they show you how to
create a charge so we want to copy that
because we're gonna use stripe as our
payment gateway if we were using like
PayPal or whatever we would actually
just not even have to do any of this but
because we're using a stripe for
everything we're gonna use stripes
sample code for their payment gateway so
now we're just gonna paste that in and
this is the charge it doesn't even have
to match the charge that was set by
apple pear whenever we showed it to the
user so I'm just gonna leave it as 10
pounds at the moment it's not even in
the same currency and now what we're
gonna do is we're just going to see of
that so what you can do if you have
Safari on a Mac and Safari on the iPhone
is you can go to Safari in the settings
on the iPhone you can scroll down you
can go to advanced and you can go to web
inspector if you turn that on then you
go to Safari on the Mac you go to the
develop menu you go to the iPhone and if
you have any pages on the iPhone open
does show up here and you can click on
that and you can see a web inspector
just like if you want to inspect element
inside google chrome and this can help
us with diagnosing problems so what I'm
gonna do now is go back to the phone I'm
gonna refresh
now I'm going to click on pay
and I'm gonna try and buy this
so it says we had a failure there Allen
says we have an internal server error on
charges of PHP so you can see we got an
internal server error but we didn't
actually get any outputs we can't
actually see what the error was so what
we can do is we can say a PHP charges
dot PHP to run the script and we can see
the errors in the command line so that's
an undefined index just because we
didn't run the script properly we run it
through the terminal instead of the
browser and this warning just means we
don't have something installed but
that's a notice and that's a warning so
they're not actually going to get in the
way of the execution of our program this
big arrow down here is because we need
to install Carlos so we say apt install
PHP 7.0 Cardle
well install out and I will say PHP
charges top page pay so charges up HP
keeps sending us an internal server
error so the way we can fix that is we
can say it Nano charges to PHP and we
can firstly just change token
to make it a instead of stripe token
it's actually token because if we go
back to indexed up HTML and what we're
sanding is called token as you can see
here if we try to run charges dot PHP we
will get is a 500 error which is a
server error that's halting the
execution of our script which means
we're not actually setting the charge
through the stripe so what we can do is
use a sort of proxy so we can just
create another script called seed of PHP
and in that we'll run shell underscore
exact which is a method just to run
shell commands and we will say PHP
charges the PHP and then we'll pass it a
variable called token as our parameter
then we'll say a token is equal to post
token see if that will see hich mod
seven seven seven seed of PHP to make it
executable then we'll say nano charges
top PHP and we'll change this from post
token to our V 1 which means regarding
the token from the command line as
opposed to from the post request and
then finally we're going to index that
HTML and we will change this so instead
of posting two charges dot PHP I'll just
post to C dot PHP so essentially what
this is doing is it's bypassing the
500-hour by using a proxy file so what
we're doing is we're going instead of
directly going from index to charges
we're sending our request to this file
called CDHP and that file is calling
charges up HP from the command line
which in which case it gets executed
properly and c2 PHP will return
correctly which will mean that our Apple
pay request will have gone through
correctly so hopefully this will work so
let's just try it and before we run that
we'll just say nano success dot HTML
we will also go into index dot HTML just
to make everything neater and we will
change the charge of mine to the correct
amount which is going to be tamp irons
change the currency to GBP so let's just
run this and hopefully everything should
work
you
and you can see everything was
successful
if we go back to straight you can see
before we were on 30 pounds for three
charges and now if i refresh we should
be on four charges of tampons and now
you can see we have four successful
charges so for whatever reason stripe
was sending an error to the browser and
one of its HTTP headers because we ran
it using a proxy file from the terminal
the Hatter's were ignored completely
they weren't actually even returned so
everything was successful so that's how
you set up Apple pay on your website
some people also had problems setting up
their tax records that's because if
you've never had a paid apple developer
current everyone actually work it turns
out so what you have to do then is just
use real cards and whenever you're ready
to actually make this a live program you
go to stripe you go back to the Apple
pay section and you can see where it
says here is your task key you want to
change that to your public key that will
allow your charges to actually go
through as legitimate charges I'm not
fake charges for testing purposes so
that's it for this series if there's
anything more you'd like to see on an
apple pear just let me know but that's
it for this video don't forget to Like
comment favorite and subscribe and I'll
see you next time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>