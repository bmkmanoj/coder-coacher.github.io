<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>New Social Network - Part 6 - Token Swap &amp; Email Check | Coder Coacher - Coaching Coders</title><meta content="New Social Network - Part 6 - Token Swap &amp; Email Check - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/howCode/">howCode</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>New Social Network - Part 6 - Token Swap &amp; Email Check</b></h2><h5 class="post__date">2017-01-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/HMYnR5mBr9k" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so in the last video we laughed off
where when the user logged in and they
used to correct username and password we
created a cookie and then that cookie we
stored a token and that token was how we
verified the user was logged in so in
this video what we're gonna be doing is
actually checking that cookie to see if
the users logged in or not because at
the minute all we've done is set the
cookie we haven't checked it or anything
to be able to tell which user is logged
in so on the login page we created a
cookie called
s an ID and that stores the user's login
token so if we go to the index page and
this is the page we're going to use to
check if the users logged in or not
so here I lied
does include the database class which
will allow us to query the database and
what we want to do is create a function
to test if the users logged in or not
so the function is called is logged in
and it's going to return a boolean value
of true or false depending on whether or
not the user is logged in so if the user
is logged in it will return true and if
they're not logged in it returns false
so by default we're going to return
false and what we're going to do first
is check if the cookie has been set so
we're going to create an if statement
and we're going to set is set and we're
going to use PHP special cookie variable
and we're going to look for s and ID and
that's the cookie we are restored so now
what we're going to do is we're going to
create a database and see if the token
is valid so to create another F
statement and we said DB query
so what this query does is it's like
they from the login programs where the
token is equal to the token and the
cookie so check if the token is valid
essentially if it's one of the tokens in
the database and before we run this
query we need to hash the cookie value
using sha-1 because all the values in
the database are hashed using sha-1 so
now if that returns true we're going to
say return true otherwise it will
default and return false so join here
what I'll do is just create another F
statement and what this this statement
does is check if the users logged in
because it says if this returns true
then we'll say echo logged in then we'll
say else echo not logged in so let's run
this so you can see here we already have
the sash and cookie stored and if I go
to the index page it says logged in if I
remove that cookie
and i refresh it says not logged in so
we could actually modify this function
so inside here instead of returning true
we could copy the query from above paste
it in here and we could call it user ID
and we could access the zeroth element
and then access the user ID column and
then now if I return user ID it serves
as a staff later on so if they're logged
in we've got the user ID returns and if
they're not logged in we'll get zero
returned or false and then here I can
login with another account go to the
index page it says logged in and what I
can do is copy the function and a quit
out and you'd see it is logged in three
if I go to the database table of users
you'd see the user with the ADF three is
Francis so we have one more thing to do
I submitted this token is valid for
seven days but whenever it expires the
user will automatically be logged out
and there's nowhere to keep them logged
in at the minute so what we're going to
do is create a second cookie and that
cookie itself will be valid for three
days and for as long as I cookie is
valid we're going to allow the user to
use their SSN ID cookie but if the
second cookie is deleted or is false or
expires then we're going to force the
user to ask the server for another login
cookie and it's going to delete the old
one so it's actually really simple to do
all we have to do is go in here we say
set cookie we do it one more time we'll
call this one SN ID underscore just so
that it's different from the first one
its value doesn't matter so we'll give
it a value of one and we'll copy all of
these other values and will change the
seven which means seven days is how long
it'll be valid for we'll change that to
three days so this second cookie will
expire every three days when whatever
this cookie expires we're going to tell
the user they have to ask the server for
another cookie so we can change the
user's SN ID cookie every three days
without them even knowing it and they
don't have to log out and after seven
days the cookie will automatically be
deleted so if the user only logs in once
every two weeks their session ID will
only be valid for seven days so what
we'll do in here is once we know the
users logged in with a valid cookie and
we have the user ID we're going to check
if the second cookie is still set
cookie is still sat we're going to
return user ID because we don't need to
do anything else and then we'll say else
if the cookie isn't set in other words
the on the second cookie must have
expired which means it's been three days
since the user logged in and we want to
give them a new login token to keep it
secure so what we'll do is we will say a
query just like in our login page we're
going to generate a new token just like
this we'll place it above here we can
have already token generated and then
here we want to do is insert it into the
tokens table just like we did in the
login page finally once we've inserted
the new token we want to delete the old
one so we'll do another query
so here we've done is gone to the log
into
we're going to delete the row where the
token is equal to the value in the
cookie and we need to pass the chair one
that we deleted the old token we've
inserted the new one so we want to
create the new SN ID cookie to replace
the old one and we want to race that the
SN ID underscore cookie which is the
cookie that tells the first cookie to
expire so we essentially just recreate
those two cookies and then after we've
done that we want to return user ID
because we need the user ID regardless
and then here we just need to change
that user ID to user name with an
underscore so let's run this and see did
it work so before we can run we need to
delete our cookies so it says logged in
I check our cookies we have two cookies
now so now we will do is go to the index
page remember this token it's a four F
and we delete our s an ID underscore
cookie which will force the server to
send us a new token K so that air is
just because in here we said cookie
token instead of cookie s n ID because
we want to delete the cookie we have
stored and we have called cookie s an ID
we didn't call that cookie token so
let's try this one more time so now we
have nine eight seven as the start of
our token we're going to delete s an ID
on the score that will force the server
to give us a new token or refresh we'll
check our cookies again
we have a new hacen ad on
kokin and we have a new as an ID token
so before we finish this video we need
to effect something from a previous
video when we create accounts we're not
checking for duplicate emails so we need
to go in through the create account page
and we're checking if the email is valid
but we're not checking if it's already
being inserted into the database so here
after checking if the email is valid we
want to check if it's already been
inserted so we can do that by saying
another F statement and we can say F DB
query
and then here what we want to do is to
get that so essentially what we're
saying is if the email doesn't already
exist in the table then we're going to
allow the user to be registered
we're going to set email in use so we've
got to create account I try to put in an
email address that's already in the
database Francis at haiku org for
example and I click create account it
says email in use and if I go to the
database table and I refresh there's no
extra account if I try to add an email
that isn't in use
it says six
refresh and the New York Hunt has just
been honest so that's it for this video
don't forget to Like comment favorite
and subscribe and the next part will be
handling logging out users of their
accounts but that's it for this video
don't forget to Like comment favorite
and subscribe don't forget to follow us
on Facebook and Twitter and I'll see you
next time
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>