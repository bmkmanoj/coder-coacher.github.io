<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>New Social Network - Part 9 - Forgot Passwords | Coder Coacher - Coaching Coders</title><meta content="New Social Network - Part 9 - Forgot Passwords - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/howCode/">howCode</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>New Social Network - Part 9 - Forgot Passwords</b></h2><h5 class="post__date">2017-01-21</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Yy5_u_7u4RY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so in this video we're going to be
learning how to reset a user's password
if they're forgotten it so in some ways
it's different and in some ways it's
similar to the changing user's password
and in fact in this video we're going to
be using the change password page that
we created in the last video to actually
reset the user's password so normally
what happens whenever you reset your
password is you put in your email
address and then the website sends you
an email and then you click a link on
that email and it takes you to a special
page you can reset your password
securely so that's what we're going to
be learning how to do so the first thing
we need to do is create a new page
called forgot password and what we want
to do is go to the index page and once
again just copy and paste stop I don't
think when they do logged in class so we
can just delete that and we'll just
Adele leaves so the first thing we need
to do is create a form
so those are forms so let's just see
what that looks like
those are form there's the tax box you
put the email in and then we could
crease that password to send the email
so the first thing we obviously need to
do is check if the form has been
submitted
and once the form has been submitted we
need to send the user an email and this
is the part where we will actually send
the email and we could use pH please
mail function but because we're running
on a local computer that won't actually
work so what we're going to be doing is
for this video we'll be leaving that out
and we'll be coming back to it later so
for this video we'll just print out the
token and then we'll use out to reset
the password but whenever we actually go
to put this on the Internet we're going
to be sending the user an email because
when we put it on a live server we can
use the PHP mail function fine but it
doesn't work on a local computer without
a some special modifications that would
take too much time in the video so where
we would normally send the email we're
just going to print it out so the first
thing we need to do before we could even
send the email is generate a token and
we've already done that on our login
page so we can literally just copy this
and generate another token a different
type of token and paste it in here so
now we have our token generated and we
need to store the token in the database
so we need to create a new database
table and we're going to call our table
password tokens and it is pretty much
integral to the login tokens table we
have our chokan we create a char and the
length of our other token and the login
tokens table is like 64 characters but
because we're using sha-1 to actually
hash the token and that's only ever
going to be 40 characters long so if we
want we could create 40 characters but
for consistency I'll keep it a 64 in
case we decide ever change it it just
saves us an extra job in the future so
that answer there and we will put in the
user ID underneath that's going to be an
integer we don't need a specifier length
and if we go to the login tokens you can
see we want to make a user ID unsigned
we don't want any of these to be no we
want to sadly token to unique and we can
do that by going down here to indexes
changing the key type to unique and on
the token fields we just click hard make
sure you don't put it on the user ID
otherwise it won't work so now that I've
created that table that's identical to
login tokens it just has a different
name we're ready to actually insert our
token into that table so just like login
we're going to query the database and
insert it into the tokens table
and we need to get the user ad and
because we are storing the user ad in
the password tokens table we need to
actually query the database and get the
user ID out of it and we need to do that
when the user isn't actually logged in
so we want to run another query called
user underscore ID to be able to set a
value to the user ID variable and we
want to run DB query and we need to
select the user ID from the database
based off of the email that were given
by the user
so here we're just backing you
I D from users where the email is equal
to whatever the user puts in the textbox
and before we can do that we need get
email data from the textbook and store
that in the variable so we do that by
just creating a variable and saying
email equals post email and that
corresponds to the name of the textbox
and then once we query the database we
need to go through the results there may
be one result we go to the zeros item of
the array of results because there's
only one just like in the earlier video
with login when we retrieve the ID and
then here we want to retrieve ID so
we're going to test this now and we're
just going to echo emails sent and once
again in a future video we'll be
covering how to send the email with the
token in it so we're going to refresh or
we're going to just put in the email I
have associated with my current process
at Hoku org and we just want to click
reset password it says email sent we
check our database and then password
tokens we have a new token just like
before we're using sha-1 too harshly
token value because just like the login
tokens if we didn't hatch that and
someone broke in and they had a login
token that's as good as the user's
password and this is the same if we
don't hatch these tokens and someone was
to break in having access to the reset
password token is as good as having the
user's password because all they need to
do is pass that token to the reset
password form and then they can change
the user's password to anything they
like so now that we have the token in
the database we're going to go over to
our change password page and we're going
to check if a gap parameter has been
passed and that parameter is going to be
C token so we're looking for something
like this so if we see the token
variable in the address bar we know that
we're going to use the token to reset
the user's password and we're not going
to ask them for their current password
because they've obviously forgotten it
so we've already covered what happens if
the users logged in but if the users not
logged in and they're forgotten their
password we're going to go down here and
instead of saying not logged in what
we're going to do is we're going to
check for the token being passed to the
page so we're going to create a variable
called token and it's going to be equal
to cat token now what we're going to do
is we're going to create a query and
that query is going to check the token
is valid
so what we've done is we've said select
the user ad because we need the user ad
be able to change the user's password
from password tokens where the target is
equal to whatever the token that's
passed to the pages and we get that
token and we convert it to acid share 1
and compare it with the value in the
database so we're going to say user ID
is equal to the output of that query
just like usual we want to get the
zeroth element from the array that's
returned and only one element will exist
in this array and then we want to go
inside the array again and get the user
underscore ID field so now that we have
the user ID we want to just copy and
paste this query and we want to change
it to an F statement so we're saying if
the query returns successfully then
we're going to assign user ID otherwise
kill the page and we'll say token
invalid so once we know the tokens valid
we're going to allow the user to reset
their password so just like above we're
going to copy this
and we'll just paste it in here and we
want to change a couple of things we
want to get rid of old password and we
want to remove this password verify
function because we don't need it
anymore and we want to remove the user
ID assignment and we should be almost
ready to go and then up here we want to
say if is set yet token then we will run
all this code otherwise we'll say not
logged in so let's try and run this so
the first thing I'm going to do is copy
this I'm going to change the token to an
invalid one that isn't in the database
and with a syntax error so you just want
to remove one of these closing curly
brackets some refresh and now it says
token invalid if I paste in a correct
token and error because we're using
sha-1 to hash the token before we
compare it but we got the token out of
the database and that was already hashed
so what you need to do is get the UM
hashed version of the token so whatever
we go back to the Forgotten password
page and when we activate email sent
we're also going to AcuRite token the um
hashed version of the token so once
again what we're going to do is fill out
the forgot password form we're going to
click reset password it says email sent
and it passes us this token this is a
token that we would have been emailed as
we set that up we're going to copy that
and we're going to pass that to this
page and hit enter I know it says we can
change our password before we run this
what we want to do just go back to here
and we want to remove this current
password box if we provided it with a
valid token so what we're going to do is
just add some PHP tags here
and then what we'll do beside them is
say if token is valid then with a code I
know and that up here what we'll do is
create a variable called token is valid
and set it equal to false and then here
we'll say if the token is valid
instead token is valid equals true and
then we'll actually get that and then
finally what we want to do to change
this form action depending on whether or
not we've provided them with a valid
token so we'll just change that with
another set of PHP tags token is valid
if the token is not valid with a KO
change password page feet and then else
if the token is valid with a KO change
password dot PHP classroom our token
equals token and then semicolon and in
PHP when you use echo with single quotes
to include a variable you have to put
single quote dot before the variable
name and dot single quote after the
variable name so let's try that again so
here we are on our page when we go to
inspect element we can see that the form
action has indeed changed because we
provided it with a valid token if I go
and change one letter of this token if I
add a ladder at the end of it you can
see it says token invalid so what I'm
going to do is change the password to
Francis and if I go to our database you
can see there's the old password I click
Change Password it says password changed
successfully
and I refresh and you can see the
password has just changed so we've one
more thing to do once we change the
password we want to delete the token
we've just created so we want to set DV
query
so what we're doing is we're just saying
delete from password tokens or user ID
equals user ID and we're getting the
user ID from up here and what that does
is once the user changes our password
we're going to delete it from the
password tokens table so once again I'm
going to refresh and because this token
hasn't been deleted it's still valid
so I refresh and we can change the
password again to cast password we can
click Change Password it says password
changed successfully I go to our users
table you can see there's the new
password and I go to a password tokens
table and you can see it's empty so now
if i refresh this token will no longer
be valid and it will give us an error
now you can see it says invalid token
and if I delete the token completely and
refresh it says not logged in and if I
log in using the old password which was
password
it says incorrect password and if I log
in using the new one which is test
password and click login
it says logged in and I can see we're on
change password on page P and we just
find a bug so we're going to line 73 and
it says token is valid is not declared
because we declared it in the else part
of our if statement so we want to do is
just copy it from there and paste it
above the login check and now if i
refresh the arrows disappeared so that's
it for this video don't forget to Like
comment favorite and subscribe don't
forget to follow us on Facebook and
Twitter whereas this series we're going
to be covering more topics such as
sending emails uploading profile
pictures adding people's friends writing
posts things like that so that's it for
this video and I'll see you next time
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>