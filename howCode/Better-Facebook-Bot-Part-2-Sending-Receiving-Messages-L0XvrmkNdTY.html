<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Better Facebook Bot - Part 2 - Sending &amp; Receiving Messages | Coder Coacher - Coaching Coders</title><meta content="Better Facebook Bot - Part 2 - Sending &amp; Receiving Messages - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/howCode/">howCode</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Better Facebook Bot - Part 2 - Sending &amp; Receiving Messages</b></h2><h5 class="post__date">2017-04-18</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/L0XvrmkNdTY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so in this video we're gonna be learning
how to send a message to our path so if
we go to the bots Facebook page and you
can see I have the chat box open and
what we're gonna do is I'm gonna send it
a message I'm gonna say hello world and
at the moment the bot has been
programmed to send whatever I typed back
to me so if I hit enter you can see the
bot replied with how to world so we're
gonna be learning how to do that in this
video so I have a blank PHP file and
this is where we're going to put our
code from our bot so I'm gonna open up a
PHP block and the first thing we're
gonna learn how to do is to print to the
screen so if I just save this and I run
the server and the only thing this
server will print out is the arrow log
and the pages that are visited so if I
type in a qohelet it's not gonna print
out to the terminal so for us to be able
to see the I put on the terminal we have
to send or I put to the arrow log so to
do that we just have to write to page
peace standard error stream so what I'm
gonna do is create a function and it's
gonna be called print line and it's
gonna take a string variable to print
and what we're gonna do in this function
is we're gonna create another variable
called F and it's gonna equal F open
which is another function that opens a
stream so we're going to type in F open
and what we want to open is we want to
open PHP standard error which is how we
can I put to the error log and we want
to open it for writing because we want
to write to and then to output to that
log all we have to do is write F put's
we pass it the stream we want to write
to which is going to be F which is our
standard error and then we put in the
string we want to I put which is going
to be to print so now that we've done
that we want to get the body of the post
request because when we send a message
using Facebook all the information about
the message is stored in the body of the
post request so if you get the body of
the post request we have to say that
post body is equal to file get contents
PHP input stream and that is worthy body
from the post request will go so now
we'll have the post body stored in the
post body variable so we can read it and
then what we're gonna do is are just
gonna print it out so we're gonna say a
print line post body and we put a
semicolon in there and we run this so if
we run this server and we send a message
you can see here is the message here
here's all the information Facebook
sends us in the post body and you can
see here is text and that is the text in
the message so we could access all this
data by converting it into an array and
then accessing all the members in the
array
so we're going to delete the post body
and what we're gonna do is we're going
to convert it into an array so we're
gonna say a post array equals JSON
decode and we're just past the post body
this will convert it into an array and
then the array there is a member called
entry
only one entry so we're always gonna put
an entry zero and then we want to put in
messaging zero that's because the these
two members will always be there in
every message so you just make sense to
access that member automatically when we
create the poster and so the next thing
we're going to do is we're going to
reply to a message so to send a message
back to Facebook we need to send a post
request to Facebook's API so to do that
what we're gonna do is we're a set file
get contents to open the file and what
we're gonna do is we're going to just
put in this URL graph dot Facebook
search v2 0.6 slash a massage messages
and then we're gonna put in a question
mark and say access token equals and
then this is where we put in our access
token to access the API so we click on
select a page and we click on basketball
a ver and we copy this to the clipboard
this is our access token and we paste it
in here so now I will be able to send
authenticated requests to the Facebook
API but we won't be sending a post
request so to send a post request we
need to modify the file get contents
function so to do that we need to add
some more options so we're going to go
up here and we're gonna set options
equals an array just like we did in the
last video if you watch that one so what
we do is we create an array and the
first option is HTTP because that is the
protocol we're using and then we say
here CGP equals another array and in
this array we say a method because we
want to choose from the default cat to
post let me set the content which is
what we want to send back so we'll just
set that equal to an empty string for
now and then we set the headers so we
set a header and we're gonna modify the
content type header so we're just gonna
paste in this content type is
application size JSON and then make sure
you put in the /r and the slash nu9 at
the end so that's our options created we
just haven't put any content in yet and
then what we're gonna do is we're gonna
go down here and we have to create a
stream context so we say at context
equals stream contacts create and then
to create that all we have to do is pass
in the options we created earlier which
is this array up here and then CI
thought to finally work all we have to
do is go to a file get contents function
and then after we paste in our string we
want to say the word false to set that
parameter to false and then we want to
pass in on stream context which is just
context and now we have to put some data
in the content so the content has to be
JSON so we have to say JSON encode
because we're going to pass it an array
so we're gonna pass it an array after we
put in the JSON encode to convert the
array back to JSON and now what we want
to do is we want to put in the
recipients we want to say a recipient
equals and we pass another array and
then we said the recipients ID is equal
to whatever their ID is we're gonna say
a sender ID to send the message back to
the sender
next we're gonna say the message which
is just gonna be message is equal to
another array and we pass text it's
going to be equal to say for example
hello world so to get the sound right a
we're just gonna go up here and we're
gonna say sandir ID is equal to post
array because that's the array that we
got from Facebook and because we've
already accessed the entry member and
the messaging member all we have to do
is type in Sander ID just like that so
the reason we're using this weird are
set of arrays to send back the text is
because when we convert that back in a
JSON what it looked like is
so this is what the Jess and I part will
be obviously these will also be
surrounded in double quotes so let's try
and run this now and you can see what's
happening is regarding lots and lots and
lots of masters sent back to us so I'm
just gonna stop the server and I'll
explain why we're getting lots of
messages back the Facebook API whenever
we send a message what it will do
Facebook will call our end point which
is our index page and then our index
page will send a message back to
Facebook whenever Facebook receives
another message from us their API will
automatically send us another
notification but our script is just
automatically sending a message no
matter what sort of information is sent
to it so we're just getting this
infinite loop of masters being sent back
so to fix that we need to be able to
determine whether or not we were sent a
message or whether or not we were sent a
notification and the way we can fix that
is we could surround all this in an if
statement so we'll just write a listen
an if statement for now I will not put
in a condition yet and then up here what
we'll do is we'll create some new
variables we'll create one called
has text and it's gonna be equal to post
array then we access the message member
then we access the text member and this
is how we get the text from the message
then we're gonna have another variable
called a Zaku and it's gonna be equal to
post array message is echo so if a
message has this special is echo member
that means it was sent by Facebook as a
notification to us to tell us that a
message was read or a message was
delivered or something like that so if
it has a text member it means that
somebody sent a message to our bar so to
make sure we only send messages back
when we receive a message and not when
we receive a notification we're just
gonna say if has text is true and is
echo is false so we're just gonna put an
exclamation mark before the is echo
variable and this means all this code
would only run for masters that are sent
what we're gonna do it on here is say
else print line not message and why
we're here we're also going to scroll up
on at the minute we're only sending back
hello world so what we're gonna do is
we're going to stand back the messages
text so we're just gonna stand back pass
text all right we're gonna run this and
we're probably gonna get a few extra
messages in here because these masters
weren't successfully delivered so then
Facebook is gonna queue them up and try
and send them later so this will just
stop eventually so that should be it and
what we're gonna do is we're just gonna
type in in the ladder a we're gonna hit
enter and we get the ladder a printed oh
okay so we're getting a site error and
the reason for that is because at the
minute we're trying to access the is
echo member
it's not always there because it's only
there for notifications so we're gonna
change this to is sad so this will test
if a member is there and it'll just
return true or false if it's there or
not and then house tax will just change
to is set as well so this will return
true or false so our if statement is
still work but we're just going to copy
this code I'm just have to change how
we're getting the text for the message
from instead of saying past acts we just
went out to a post or a message text so
now if we run this we shouldn't have any
errors so if I send a letter B we get
that out or be printed back and you can
see we got the letter Beit printed back
I'm the makeup - not a message
notifications so these were two
different types of notifications such as
Facebook telling us the message was
delivered so we don't want to respond to
that sort of notification sort of saying
it's not a message so that's it for this
video in the next video we're going to
be learning how to use natural language
processing so now we can get the value
of the message that's sent and we can
send it back to the user so we're gonna
use that information to send more
meaningful responses back to the user
next time but that's it for this video
don't forget to Like comment favorite
and subscribe don't forget to follow us
on Facebook Twitter and reddit but
that's it for this video and I'll see
you next time
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>