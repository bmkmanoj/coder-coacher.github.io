<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Bluetooth &amp;&amp; Azure IoT hub == IoT - Or how to rule bilions of devices -  Jimmy Engström | Coder Coacher - Coaching Coders</title><meta content="Bluetooth &amp;&amp; Azure IoT hub == IoT - Or how to rule bilions of devices -  Jimmy Engström - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Bluetooth &amp;&amp; Azure IoT hub == IoT - Or how to rule bilions of devices -  Jimmy Engström</b></h2><h5 class="post__date">2016-08-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Cjxl8yW63xo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">good morning so happy to see so many of
you here this early in the morning
thanks for joining me so as developers
we tend to go through different stages
my first stage was when I was about
seven or eight years old I got my first
computer and i remember i sat down a
right route 10 print Jimmy 20 go to 10
so that was my goal I got my computer to
do stuff for me this is actually my
first app and if anyone wants the source
code I will be happy to share it this is
actually the moment when I realized that
I wanted to be developer this is what I
wanted to do with my life the next stage
was when I got a calculator and a mobile
phone there's a very special feeling
when you're writing something on your
computer and you then you deployed to
something smaller that you can bring
with you in your pocket I could actually
sit down and write code on my calculated
during class mind blowing for me the
third stage was when I was introduced to
circuit boards raspberry pi nectarine or
Arduino and stuff like that I remember I
went into into the living room and I as
gel to my wife Jessica Jessica you got
to come and see this to have this
blinking look the lab it's blinking on
MC thinking and she just went into the
room yeah what about it no you don't
tell us that the lead here on the
circuit board is blinking I made that
happen I think it was a bigger moment
for me and for her but I was so happy
that was blinking
then the next stage was when I realized
that can control other devices devices
that I actually don't have any code
control over I can get measurements from
sensor I can can turn off and on lights
and this is what we're going to talk
about today bluetooth how we can control
devices through bluetooth but why should
we care about this well first of all
it's really really fun and the second
reason is this number 3 billion
Bluetooth devices were manufactured last
year of course we want to be here as app
developers make apps for this customer
base so what we're going to talk about
today is how does bluetooth low energy
work how can we figure out a Bluetooth
protocol and then we're going to go from
Bluetooth Low Energy all the way to IOT
and see if that works so my name is Jim
angstrom and I work as an asp.net
developer I spend my spare time doing
Windows and Windows Phone development
and some hololens and together with my
wife I run a user group called coating
off the work and a podcast for the same
name i'm also a windows development MVP
but enough about me let's dig deeper
into this fun stuff so Bluetooth Low
Energy has many names it's called
Bluetooth smart it's cold see there we
go it's called Bluetooth le Bluetooth
Low Energy ble and sometimes wrongly i
should say bluetooth 40 it's part of the
Bluetooth 40 serums and for dot 0
standards but it's not the whole thing
bluetooth low energy was actually
introduced back in two thousand six by
Nokia under the name vibe really Bri
however you want to pronounce it and
then 2010 it became part of the
Bluetooth core for that Oh standard the
nice thing about bluetooth LE is that
you can actually ask the device what can
you do what services are you implemented
that's perfect for developers it's easy
to reverse-engineer to figure out the
protocols so Abby Lee device can tell
you what services in what service it has
it Abby Lee device always has one
service or many must have one the
service is identified by a grid so there
is an organization called Bluetooth Sega
special interest group that has named a
couple of these services they have
documented them and they have said that
to to be able to use this squid this
service need to look a particular way
there are also of course services that
is not defined by bluetooth sig and we
will go into those later on one service
has one characteristic or more most have
one you can think of them like methods
or events because every characteristic
has a way to access them you can read
you can write you can indicate and you
can notify and the last two of them are
you can see them as events so those are
your device is going to send those
values back
so this is the documentation from the
bluetooth sig the special interest group
for the battery service so their
documentation says says that to be
implement a battery service you need to
have a characteristic called battery
level it must have read access it
wouldn't be much of a use if you didn't
if you couldn't read the battery level
right and then it may have no define
doesn't have to but it could so let's
look at this service in another way so
we have the ble device it has a battery
service it has battery level
characteristic and it must have read and
it may have notified
the really cool part of this is that you
can actually build your narrow gaps you
can say that my app want to connect to
any device that implements the battery
service so you don't have to write
specific app for a specific device so
now when we know how to communicate over
how they work how do we talk to device
well the first step is to pair the
device you can do that form within
windows and you can do it
programmatically they're actually
working on now I'm talking Windows 10
specifically they're actually working on
parallel s bluetooth as well but they're
they're not there yet so you just search
for Bluetooth settings you click your
device and you click pair sometimes you
get this window usually it's 0 0 0 0 1 2
3 4 or something like that or you cannot
you can probably find it in the
documentation for the device or you can
do a side it I just try 0000 0000 I'm
serious resort to until you've got it
luckily it's what 007 so didn't have to
do that for long so if you want to do
this programmatically you set up a
device watcher you can request
properties that you want to have access
to so in my case I want the device
address and I want to know if is it
connected
then you create a watch
and you supply it with a filter that's
so those three dots we will look at the
filter on the next slide and you supply
it with the request properties what
properties do you do do I want from it
and what kind of endpoint am I looking
for then you just add the added and
updated event handlers and just started
watching and the filter looks something
like this you can find they thin I msdn
or something like that so you don't have
to write it down or anything then we
have the added event with the event
handler in my case I'm checking the name
I don't have to check the name since I'm
checking for for services but in some
cases that you reuse their services
there use the grid so it could be a good
thing to actually check the name if it's
if it's just a particular set of device
you want to use and then if it is thrown
right one you just parrot you can also
use the powering custom dot para think
if you want to do some special pairing
code so i found this scale on that on
that this is a anderson scale but it's
actually son son who makes them so i've
written a small application that lists
all the services all their
characteristics all the ways that they
can be accessed because the device knows
these things and are happy to share them
with you i also created a collection or
a database that converts these services
to their bluetooth
sig real names if you wish so if you
look at the Sun some scale it contains
generic axis this service will contain
things like name and device address let
me have the numeric attribute this is
the service that actually makes it
possible to ask the device what can you
do then we have device information it
contains manufacturer versions name of
the device name and stuff like that then
we have another one not defined by the
bluetooth sig interesting so the one I
know that generic access generic
attribute and device information won't
give me a weight value because these are
defined by the bluetooth thing they
don't have a get wait so the one named 0
0 0 FF peace I'm sorry about them
they're not going to let you it suffered
through that so the last one is to wanna
I want so looking at our mystery service
it has two characteristics they both
have a way to act system in this case i
can write to it and i can get a
notification from both of them so i've
wrote those a very simple application
that listen to those those notifications
and from one of the services actually
got to refine so probably that one so
now the fun part starts the detective
work so i get ten bites back
and look like this so I started off with
a base line 0 grams not putting anything
on the scale so I'm guessing but i'm
actually looking four bytes that are
zero those ones then I try to put an
energy drink on my scale just happen to
be next to me it weighed 235 grams now
these value changed and i actually have
235 on by five so i'm guessing that's
the weight while value so now we reset
the scale remove the energy drink and i
got- 235 now by seven and nine changed
but by five is still 235 so i'm guessing
seven or nine it's a sign right then i
tried with 120 grams suddenly white ford
changed so after testing different
weights i managed to figure out that
bites I wanted to to talk to you or read
from was four or five and seven and the
formula ended up being like this so if i
take the bite for x 256 plus bite 5
that's going to give me the weight and
then I can use by seven to figure out
what's I'm it is so 0 for 4 positive- is
14 negative so my first demo is going to
be a legend wait for it dary i'm sorry i
really like puns
so let's take a look at the code
so let's start with I've actually
written a couple of helper methods so
the first one is set up no define a sink
to get notifications I have to tell my
bluetooth characteristic that hey I want
noted notification from you so what I do
is the first thing I is that I get the
service with this particular grid when i
get the characteristic with a particular
grid and then i right right client
characteristic configuration descriptor
sings the longest method name ever and I
say that I'm interested in notifications
and this method is going to return the
characteristics to me when it's done
when I also have a read value the same
thing here I get the service I'd get to
characteristic i read the value and i
say i want it uncashed because sometimes
the device will cash it for me so that's
that's good if you want to if you want
to have low battery consumption but in
this case I want to latest value let us
everything goes well I get the data i
feel i get a an array bitrate and in my
case i have made this method generic so
i can actually say that i want to string
back but the bluetooth device is always
going to return bytes to me in this case
I just converted I I'm guessing is utf-8
that's that's not a given
and then I just return the bites and
then we have right value same thing here
get the service get the characteristic
and here here I'm actually asking okay
what kind of way can I write to you can
I write with the response so without
response or can I write with the
response and depending on what it can do
I just implement that so I just just
right value a sink again bikes always
bites so in our application i defined
the service ID this is a our mystery
service then we have the characteristic
characteristic squid when I create a
device selector from good so this is
going to give me all the devices that
implements this service I get a
collection and I just loop through them
I get the bluetooth LE device and well
here I shake is then does the name
contains shenzhen again i don't have to
do this if I know that all the devices
that implement this particular service
going to use the same same
characteristics but just to be safe then
if i get a device I run the my method
set up notify Singh so I say to the
service I want as I want notifications I
get two characteristics back and then I
just
listen to the value changed event in the
value changed events again an array back
an array of bytes so I send it into my
convert to white method and just set the
property i have on my page to the new
white and the white convert to white
method is doing while it's going to
check whether or not by seven is set or
not and it's gonna take this sine x
bites bike number for buy chips shifted
and then white five so let's see if this
works
oh I have an energy drink put it on the
scale and the value changes
pretty simple huh I mean this is not a
lot of lines of code to do this so let's
go back to the presentation
so what we is a company who makes robots
toy robots and they released a whole
bunch of robots this is the one to your
let's see your left is the meat it's I
am it's a Bluetooth robot and that one
is the meat Pacelle I actually written a
an SDK and to talk to these two actually
the the the one for me is out already
that's open source I'll share the link
later on and the meat posao is coming
they also took a lot of old toys these
were these robots were controlled by
remote control but they'll upgrade them
so now they can conviction troll by
brigid so let's talk a little about a
little bit about the azure IT hub
actually I'm sorry Microsoft has to
release that uh sure I t-hub a way to
communicate with IOT devices so what I
could have done here is that I could
actually I could have shown how to how
to upload sensor data to the cloud and
do stuff with it that's no fun I want to
do something more fun so we're going to
try to control one of these robots
through that you LG hub so the first
thing we need to do is actually set up
the IOT hub of downloading involves so
it's a little bit quicker to do this
with slides so the first step is to
click new so this is the azure portal
the next step is to click internet of
things and then asher IOT hub so let's
name this NDC I have chosen to use the
free price and scale tier and I've
chosen location Northern Europe just
create and then you wait a couple of
minutes then you will see at this screen
and your ihe hub is right if you use the
free tier actually gives you eight
thousand messages that you can send
through the IT hub for free so that's
awesome
the next step is to install the device
Explorer it can be fine found on this
URL you can download the source for it
or you can download a full installable
looks something like this so to be able
to use the device Explorer you need a
connection string so let's go back to
the azure portal click the key then I OT
hub owner this is created for you so
just just click away and then you have
the connection string and just there
copy it and paste it into your device
Explorer and you're all done so now we
can go to the management tab and click
Add so we could have done this from code
but since we're just only going to use
one device this will just this will work
perfectly so i'll name this Robosapien
and i just press create and I get it
nicely in my list then you create your
application and I have chosen to create
universal Windows platform app this will
of course work with any app so the first
thing you need to do is to install the
microsoft azure device client nougat
package once that's done you can go to
this URL microsoft actually helps us
even more with this
so this is not going to be an Asscher
IOT hub deep dive I want to open your
eyes to see how cool and how easy it is
to communicate through the IOT hub with
Bluetooth devices so the first thing you
go to this portal you click connect your
device you will see a list of some of
the devices you can connect your diet e
hub I have chosen use another device and
windows and microsoft is actually going
to provide you with all the code you
need oh my sister's just copy and paste
it into your application and you're done
you also need a connection string to
your device so that's the same
connection string you can find in the
Asha portal but you need to add a device
ID but the device Explorer actually
gives it give you the correct connection
strings you can just copy it from there
so let's see bluetooth Internet of
Things robot that's a really boring name
should be called bluetooth Roby earth
right of course so there we go much
better right we're about to demo
something now actors know that they
should never work with children or
animals as a speaker you know that you
should never work with Bluetooth that
can be disturbed by thousand people and
in the same area venue we also know that
we should never rely on internet so
that's the cycle what I've done I'm
relying on internet and bluetooth so
let's just hope this works
there we go so this robot actually has a
bug in it so I have to pair it every
time I use it this is made for parallel
its communication but it will work
hopefully I'm actually talking to to
what we trying to solve it so here just
I went into the Bluetooth settings and I
paired the device
let's go into messages i'm going to show
you the code in a while so let's try
let's do a explosive demo c4 sorry i
need to start app as well
I gotta go
let's try that again so now I'm actually
controlling my robot through the device
Explorer into IOT hub then back to my
application and then over to the robot
so let's try something else see I
actually have a list of things it can do
so let's try a second so all the
commands that is available through the
through the the infrared controller is
also available through bluetooth so
let's take a look at the code
yeah so what I've done here is that I
start I create a device client I created
from my connection string this is the
connection string to my device then I
have Robosapien class this is the class
that talks to the robosapien and we will
look at that in just a second and then I
say robosapien connect this is going to
try to find the device and connect to it
and then I also have ascend event so the
send event is going to send Robosapien
connected message to my IOT hub and if
you look at the the device explorer
let's see if I monitor it and I started
so if I start app it will connect to rob
sapien and I will get the message
robosapien connected if I if I monitor
the hub and then i have received
commands so this is this is going to
check do I have any messages on my hub
if I have a message I will convert it I
will get bites I will convert it to a
message and then I was then i will call
the send command on my Robosapien and
sending the message so in this case I'm
going to get the bikes for c4 for
example then I couldn't going to convert
it to text and send it in to my
Robosapien so let's take a look at the
robosapien class so here I'm actually
not using my helper methods just to show
how easy it is so first thing I get to
service quick get the characteristic
squid
then I connect I try to find the device
selector so I try to get all the devices
that implement this service and one way
is actually one of the examples that we
use their service grids so I have
another robot that that does the that
works completely differently has
different characteristics but the same
service ID as actually seeing think that
it has the same characteristics ID as
well so I get the enumerator and I get
the device here I check does it contain
robosapien because the other robot is
called mate I get to service and I get
to characteristic then we have the send
command so here just take the
characteristic and write it write the
data straight to the characteristic so I
also have a method here that converts my
c4 string hex to a byte array
that's all it takes so i can send
commands up to the IT hub then it will
return to my application or actually
every application that listens to that
particular device and then it would just
send the bytes outro bott all right
right
so here are some resources Microsoft
actually has a lot of great samples on
their github account we have the azure
sorry the device explorer and then we
have the URL to my Mick winrt SDK do you
have any questions I assume done thank
you do you have any questions no
questions so then let me round up just
to say that as I mentioned before there
are three billion devices out there they
were manufactured last year alone it is
so much fun to do this and if you have
any questions about this presentation or
windows development in general or if you
ever in Sweden please come by coating
off to work so I'm I'm a kind of ahead
of schedule so I'm going to let you go
so please contact me if you want to
thank</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>