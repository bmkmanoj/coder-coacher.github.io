<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Hack back - bug hunting on the dark side - NDC Security 2018 | Coder Coacher - Coaching Coders</title><meta content="Hack back - bug hunting on the dark side - NDC Security 2018 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Hack back - bug hunting on the dark side - NDC Security 2018</b></h2><h5 class="post__date">2018-02-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/WEYTRb6BFsg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">my name is uh Felix later I hope
everybody had a nice coffee break now
and you're all well awake maybe some
people just arrived after a longer sleep
today I want to talk a little bit about
people about humans about mistakes and
how you can actually use mistakes people
make to hack back do we have any pen
testers here one it also counts if you
just hack your neighbors do we have any
software developers here lots of them
amazing
anybody like security architects working
more on combining lots of systems into a
secure infrastructure 205 very good so
um
we actually have the crowd that usually
is in the disadvantages position you
know you guys always have to make sure
that you don't have any mistakes in your
software there are no mistakes in the
security architecture because if you
forget something essential somewhere you
make a mistake you're gonna get hacked
right and it happens eventually who has
been hacked which company has been
completely owned before I bet pretty
much everybody but nobody is allowed to
admit it because that's what usually
happens but let me give you some words
of confidence and that is everybody
makes mistakes right it's not only the
defending side that makes mistakes but
it's also the the attacking side for
example malware authors and to give you
some of the similarities between a
normal software developer and a meta
we're author let's have a look at some
examples to illustrate what I mean
everybody makes mistakes and you can see
that actually everybody makes the same
mistakes so here's a classic example I
love that because it's really like every
software developer has made this mistake
before this example is from best
antivirus 2011 so it's a few years old
it's a fake antivirus that means it says
something's wrong on your system you
know you've probably got a virus and in
order to remove that virus you need to
buy the full version of our products
so please enter your credit card number
here and you will get the full version
and then we will make everything
possible to remove that threat but
actually there is no virus on your
computer
except of this best antivirus software
on your machine and because they know
their business model is not a JIT they
want to avoid being analyzed by a real
antivirus company or a malware analyst
or something similar and usually malware
analysis happens inside virtual machines
well their target group the people they
are targeting you reduce use real pcs
you know like laptop or desktop or
whatever so they have implemented a
check in there they basically used to
get CPUID instruction from Intel CPUs
and use that to find out if the platform
is hardware virtualized if the uppermost
bit is set they know they are running in
a harbor virtualized environment and
then they actually don't do the whole
crap that they are normally doing on the
system they just pretend to be harmless
let's say so um you see the disassembly
assembly on the top right while on the
bottom you see like a recoded C version
of what they have actually done do v-nec
coders in the room okay okay can you
spot the problem here you can please can
you say it right so if you look at the
if statement over here its assigning
this value of 8 and so on to the second
part of this area what they actually
intended to do is to compare but they
were lacking an equal sign there
classical mistake as a result actually
they always think they are running in a
virtual environment and they never do
the crap that they actually intended to
do
another example also a mistake that
probably all of you have done not in the
same sense but I'll get to the point
configure it's also a few years older
anybody remember configure yeah old
timers configure was a very aggressive
warm spreading it spread via an SMB
exploit similar to eternal blue which
was pretty hip last year or what was the
Linux one called again okay I also
forgot that anyways so almost ten
million devices were infected including
military so for example the French Air
Force they had their planes grounded for
two days because a flight plan database
was infected all planes were grounded so
perfect situation for an attack from the
outside forty that never happened
the British Navy was also infected they
said we were a bit more lucky we only
had two devices infected does anybody
remember what those two devices were
aircraft carriers so they had two of
those infected not sure if they clean it
up or head to reinstall everything and
the reason why configure was so
successful is because it randomly chose
the next target and the routine that
actually created the next target
looked like this it was using the
Windows rant function which creates a
random number and because the Windows
ran function only returns a word you
basically need two of those one for the
upper two numbers of an IP address and
one for the lower two numbers of an IP
address and when you look at the
documentation for the rent function you
see the rent function returns a
pseudo-random integer in the range from
zero to rent max so the question here is
what is rent Max and if you read the
 manual you will actually find
out that it's not using the full range
of bits that are possible but it's only
using up to the value seven FFF because
rent wants to avoid that somebody gets
into trouble with signed numbers so they
don't use the full 16 bit so if you
think about this basically two bits are
never used here so in the end configure
only scan to less than 1/4 of the
internet and it was still so successful
but they could have been up to 4 times
they're successful just by reading the
manual and if you talk to some of the
people in your organization that maybe
had to deal with configure at that time
and they said we never had any problems
you know maybe it's not because of their
security maybe it's because they are in
this IP space that was never scanned ok
but since we are talking history who
remembers Stuxnet ok that's a lot more
people very good so Stuxnet it was
pretty interesting because it was really
a sabotaging malware you know they used
it to basically sabotage the uranium
enrichment in Iran pretty well planned
pretty well developed and they wanted to
make sure that the whole campaign really
only targets systems that they intend
for so the installer of Stuxnet had this
checker of the Windows version numbers
just to make sure we are not going for
very old systems which we don't support
platform wise and so on we our software
crashes and maybe also not newer
versions so the idea was to use an
install only from Windows XP on which is
Windows version 5 up to Windows 7 or 8
which is then Windows version 6 and you
can see the statement on the top which
it should be it should be version is
large or equal than 5 and smaller or
equal than 6 unfortunately when you
program C you know you don't write and
or you don't write or but you use some
strange characters like for example the
end sign or the pipe sign over here so
they mixed up these signs and instead of
an end they actually end up with an or
saying if the burden is larger equal
than 5 or smaller and equal than 6 so
basically any version and the only thing
that say
them is that they actually had another
check in there that the platform needs
to be NT otherwise they would have
crashed a lot of Windows XP 95 systems
and fortunate Windows 10 was not out
there because that would have also
created some problems so mistakes that a
lot of people have done a lot of us have
done but if you have them in the context
of malware they can screw up campaigns
let me give you some other information
this is more from the information
leakage side the Kiryas spam botnet one
of the biggest spam bot nets out there
pre surfaced if sophisticated
infrastructure using multi tiers similar
like a peer-to-peer botnet or a
peer-to-peer network and it had a lot of
functionality which was pretty hard to
analyze a lot of code in order to get
the details out you had to spend weeks
if not months of reverse-engineering
time but fortunately they included
actually a debug switch in there and
with this debug switch you would
suddenly get a new console where it
would print out in very nitty-gritty
detail all the things that it would do
and I can tell you this is just heaven
for reverse engineers because for every
function you step through it will output
you all the data and everything it does
it's fantastic here's another example of
information leakage energetic beer
coming from Russia definitely used in
targeted tax mainly targeting the energy
sector the idea here is to get all kinds
of information about the energy
infrastructure control panels and so on
actually um I think two years ago there
was an attack on the Ukraine and their
power infrastructure see some heads
nodding was that two years ago two years
ago thank you for confirming so
energetic beer is assumed that it was
actually the malware for collecting the
data necessary in order to do that
strike so um the idea was to exfiltrate
information and
to not let anybody see what kind of data
was exfiltrated they used RSA you know
military-grade encryption what kind of
encryption algorithm is RSA asymmetric
thank you very much so a symmetric that
means you have a public key and you have
a private key and you can only encrypt
for example the public key and then only
decrypt with a private key and so what
you can do is you can embed the public
key inside a malware encrypt the data
and only the server on the other side
which has the private key can decrypt
the data the beauty of RSA is you can
actually also do it the other way around
you can use the private key embedded in
a malware encrypt the data and then on
the server use the public key to decrypt
the data so it works both ways around
that's also what the male authors knew
that you can actually use it both ways
what they didn't know is that there are
some libraries out there some crypto
libraries and when you say I want to
export the private key they also include
a copy of the public key and that's what
happened with energetic beer basically
they were shipping the binaries with
both keys and then in the end everybody
who wanted to investigate what data was
actually exfiltrated could just go take
the public key from the binary it was
actually possible in there and then see
what data got stolen and even create
like collections on the network okay so
information collection it's nice it
helps on the defending side but it
doesn't really help defenders to hack
back so let's have a look at some
mistakes that people have made that
really ruin parts of your campaign who
has written on their CV I have been in
the security industry for more than ten
years one person very good then you're
probably the only one who knows this
nice mare with the storm one from 2008
first version at least it was the first
peer-to-peer button
really sophisticated so think about this
they didn't really have an
infrastructure like a server they would
connect to to get new commands but they
were using a peer-to-peer network like
BitTorrent for example actually there
there there
p2p network was based on Kadeem dia so
closer to emule and in order to get
commands they would just push out new
files virtual files to the peer-to-peer
infrastructure every infected machine
would get those and then execute the
commands but because nobody knew who
pushed these new commands into the
peer-to-peer network it was also not
possible to find the origin so very
resilient infrastructure but they also
had an HTTP component in there um it was
not using curl or any standard library
or even windows components but they
wrote their own custom HTTP client and
unfortunately somebody made a typo when
they created the user agent can you spot
the typo windows yes so it didn't take
too long to create IDs signatures for
that right and they were pretty good and
at one point the authors found out damn
there's this signature on our user agent
and it triggers all the time it seems
like our user agent is unique we need to
fix that and they did they actually
fixed the user agent by removing the
last three numbers you can imagine that
it didn't take very long until somebody
updated the IDS signatures and they were
tracked again let me give you an another
example how actually you can use
problems in malware against it here's
sickie pot not really known where sickie
pot is from you can find lots of Chinese
error messages in the binaries if you
look closely one thing that's for sure
it's it's a targeted attack the reason
for that is they burned all kinds of
zero-days for internet explorer which
are quite expensive in order to infect
their targets so
definitely something that has a lot of
funding probably state sponsored again
this piece has a some very nice
command-line arguments that you can use
in this case it's removed Kay wires
it was meant as a real as a clean up
tool for themselves
so that they could remove and not to
leave any traces on the system that they
ever was an infection the beauty of this
is you as a defender if you get infected
and find out it's icky pot you can do
the same thing you can also just run the
same executable again and you're rid of
it forever
okay no malware talk nowadays without
talking about ransomware right that's
what scares people so let's also have a
look at some ransomware
here's one for Android it's called
simple Locker it says you have child
pornography on your phone and you have
to pay to the local authorities some fee
in order to let all charges go obviously
you don't have that it also has a kimono
control I'm so over to get some more
data what it does is it's basically
encrypts all kinds of files that have
some value for you like pictures for
example documents text files and and my
private story to that is we had an
analyst who accidentally got infected
with that malware and he called me and
said Felix I have a problem I have
basically more than one year of photos
private photos that are only on my phone
I don't have any backups and these are
really worth a lot because my wife is on
there my kids is on there all this data
that's not worth a lot of stuff to me
what was a lot of money actually more
than money can buy what can we do and I
told him
for now let's stay calm let's have a
closer look at this and the first thing
you do when you look at a ransomware is
you look at the file encryption function
and there was a class called files
encrypter and when we drilled down on it
we actually found out it's using AES
and you know when you see a s the first
thought is
 that's military-grade encryption
and the algorithm is definitely not
breakable but then we looked and on the
second look you actually see yeah it's
unbreakable unless you know the password
which they hard-coded right in the
function call so and then at that time
you can imagine the mood of our analyst
went up and said hey you know what now I
can code my own decrypted I told him
well that's wait a second let's also
have a look at the decryption function
and the decryption function was also
right in the binary and same thing
AES encrypt and it all said the password
hard-coded so the only thing our analyst
had to do is basically take that for
take that class out put it into his own
main routine and call it and all his
phone was clean again so he was very
happy let's have a look at something for
PCs another ransomware and that's a
pretty nasty one so a same same scheme
bayesian Crips all your files actually a
lot more than the ones we have seen
before all kinds of suffix also mp3s and
stuff that you might like in some way
and it says you need to pay one Bitcoin
in order to get your data back and
submit it to this wallet address or if
you don't have that money if you're a
poor student we give you an alternative
which is quite nasty just go and in fact
three of your friends so which choice
would you have made that's pretty nasty
I tell you later why they did it that
way so again same thing you first start
looking at the encryption function and
this way this time you can see they have
not hard-coded the password where the
function is called but basically you
need to provide a password you need to
compute or they compute the hash of the
password and then use that to again AES
encrypt the files so in this in this
malware it's not as easy as before but
if you look like where does actually the
past
for encryption come from you find it
it's actually a static string inside the
same binary so you just have to search a
bit like what strings do we have and
maybe try out a few and yeah that works
like charm um if you don't like to
reverse-engineer the whole thing and
find out if this real thing and really
want to brute force it's actually having
a countermeasure against that it tells
you hey enter the wrong code you have
three attempts left now and then we will
do something nasty with your system
however the state machine for these
three attempts is stored in memory so
you just need to reboot your computer
you get a new three attempts or even
better you just need to restart the
executable and get three new attempts
and to tell you the full story they
count down to down to zero and at zero
they say in two hours something bad will
happen but they have never implemented
the logic for something bad state
machines they are wonderful also same
malware popcorn time they basic give you
seven days to pay the ransom or
something bad will happen this time they
said okay in seven days maybe this
computer gets rebooted so we don't store
that a memory but we store this
information on disk the way they store
it on disk is a file called time file
name which actually has the termination
date as a txt so if you want you can
just go in there with you with notepad
or any other edit or change the time and
sorry suddenly you have 40,000 days left
for this ransomware
I can tell you there's lots of things
wrong with this one so I've just too
much stuff on that particular one so if
you don't like to break open executable
or if brute-forcing
is too scary for you and you might
eventually lose some data if you don't
want to take that risk there's another
approach here so what they are doing is
they are not over writing your data but
they are taking a copy of your data they
encrypt that write that to disk and then
delete the old file so
the old file is gone but not completely
because usually the data is still on
disk because the new file has been
written to some free space and the
deleted file is not overwritten
necessarily so what you can do easily is
use a Windows system restore point or if
you have like an undelete software
that's carving deep down on disk you can
also get your files back so you don't
even have to pay if you want to avoid
infection completely for popcorntime
it's also possible because they are also
writing a file called being here when
you have cleaned up the system doesn't
need to be anything in the init file it
doesn't have to be signed or anything
just has to be there in your app data
roaming folder and if it's there well it
will never infect you again so you can
see even with ransomware there lots of
possibilities how you can actually use
some problems they have against them so
now I'm feeling a bit bad because I have
to tell you who actually wrote this
ransomware because they say themselves
on a webpage that opens up when you get
affected they say we are a group of
computer science students from Syria and
we're just trying to do some fundraising
basically in voluntary donations to
Syria so all the bitcoins that you give
us will actually end up to be something
good okay so I'm sorry for flaming
student project here actually those
students were quite smart because they
were not the typical criminals so they
don't didn't have access to the same
infrastructure to get the malware out to
lots of computers and then I thought
what can we do to actually make this
malware spread if we don't know these
criminal Russians that put it on all
kinds of computers well we just ask
people themselves to spread to their
friends you know that's where the scheme
came from in fact three of your friends
and you will get your data so using a
snowball effect okay so I'm sorry for
flaming a few students let's get back to
some professional malware
somebody seen this domain name before
hey wow you've got experience man been
around for more than ten years and still
no the reason
awesome what is it yes this is a domain
that was found in wanna cry one cry was
really big
last year was again similar to configure
spreading via SMB using the eternal blue
SMB exploit which was essentially leaked
from the NSA
so thanks NSA for getting this big into
it warm out there a lot of people say it
was North Korea actually putting this
out
it's definitely there's still definitely
something strange about it so let's
assume it was North Korea it infected
about 300,000 computers in 150 countries
and if you track the wallet you find out
they made about a hundred and thirty
thousand US dollars not quite enough for
a new rocket launch but at least some
money so the point of ransomware is or
if you want to sabotage stuff is you
want to have it out as long as possible
right so you want to avoid being
analyzed and you want to avoid that
somebody hex back on you and in order
for somebody to analyze your malware
they usually have analysis environments
and they made a pretty strange
assumption here saying you know this
domain is so random and so long that
nobody in the world has registered that
domain now if we actually our resort'
are able to resolve this domain we are
probably in the malware analysis
laboratory where every domain is
resolved and you know what so if we can
resolve this domain we think we are in a
malware analysis lab so we just stay put
and don't do anything
so then this smart guy
Marcus Hutchins came along and he
thought well why don't we register this
domain then and that's the reason why
they only made a hundred and thirty
thousand US dollars because he
registered that domain and suddenly all
instances all over the world thought wow
we're running in a malware analysis lab
that stopped working so he basically
made sure that this whole campaign
stopped at once so I'm not sure if all
of you considered this hacking what we
had so far so let's move more into their
space of what people really consider
hacking starting slowly I have to admit
here's an example from a Zeus drop zone
Zeus is a pretty famous banking Trojan
and it uses MySQL usually as a back-end
and is called databases and for this
particular one if you went to their
command control server and just appended
slash PHP myadmin
to the URL you would end up at this
screen so they use them that to set up
the whole database but they forgot to
set the root password which means
everybody gets access to that page and
full access to their database including
all of the reports in all of the stolen
banking data credit card data
certificates anything that they have
stolen from somewhere accessible to
anybody just knowing the URL when we
came across this we thought they
probably going to fix that at one point
because we also know that a lot of
researchers use try that out PHP myadmin
suffix and we want to make sure that we
actually get access to that panel for a
little bit longer fortunately there's a
user table and if you look in the user
table there was just one entry and an
md5 password and talking about good and
bad passwords we thought okay we
probably have to get a rainbow table
from somewhere and have a look maybe
after a few days we find something but
actually we only had to Google because
the password was a strong Tony
not sure if anybody speaks Italian
please don't translate so with this
excess especially their MySQL access you
can pretty much do whatever you want to
on this server since we talked about
banking Trojans here's another example
and that's a pretty cool example
actually when you took a look at the
technical sophistication it all is
normal banking Trojan which means it
modifies your browser hooks into your
browser and then as you go to a banking
website it transfers money to different
accounts that you have entered does all
kinds of modification and maybe ask you
to enter multiple tens or pins in order
to make a transaction and so on the cool
thing about your luteal is it does not
show you that something was transferred
from your bank account but it keeps a
fake state machine of how your account
is supposed to look like so if it helped
for example to transfer $1,000 to russia
you would still see the $1,000 in your
bank account because it would modify the
output of your browser in a way that you
always appeared like the transfer had
never happened so that's that's
something you don't see in many of these
of these tools and that's a neat feature
of your little so the your little back
end is written in in PHP and you can see
all the information on the left side
that is transmitted as part of a command
and control request and you can see on
the right side that these guy actually
knew their and they do some
sanitization what I haven't told you yet
is on the left side you see all of the
variables that are sent and on the right
side you also see all of the variables
that are sanitized so have a close look
how many variables are actually
sanitized and how many variables they
get so why in the world would you only
Senate eyes two variables when you have
11 and total that you're sending over
and with that you can basically craft
craft some really neat
equal injections and own their whole
infrastructure anybody ever been
infected with a mobile malware not that
you know very good point actually in
mobile malware has been around for some
time but not construction kids
construction kids like we have for zoos
and other or plugging sore other PC
based Trojans we didn't have those for a
long time for mobile phones but one of
the first ones was add Android actually
was quite cheap
it was developed people found out later
by an intern from the security vendor
fireEye
so this guy during his internship he
learned a little bit about what
construction kits and he also learned
about mobile and then he said okay why
don't we craft something similar for for
mobile devices and it was actually had
some pretty cool features like you could
take any app that you thought was
popular put it into his tool and he
would repackage all of his bad creation
into that new app so you could for
example say I take Twitter and put all
of my bad functionality into Twitter and
then put this out somewhere on the
market again and it also had some pretty
neat features like it could record phone
calls remotely activate microphone and
camera spy on your SMS and calls and so
on and think about this that's a real
threat I mean the mobile phones are
always with us and you probably also
take your phones to most meetings very
often probably also to confidential
meetings maybe where finance or company
strategy or whatever is discussed and if
somebody has the ability to at any point
in time activate the microphone in the
camera you are basic bringing your own
bugging device into those meetings but
I'm not here today to scare you I want
to talk about what you can learn from an
intern actually this intern learned a
lot he learned about prepared statements
has anybody heard about prepar'd sequel
statements okay very good very good we
have some people but let me briefly
explain how a sequel injection works not
in detail but just roughly basically you
create a control string for the database
craft that in some way and then hand it
over to like here the query function and
then the database is executing this
query and if you at the point where you
have external content like the UID
include something that terminates for
example some quotes that you had in
there before you end up in a situation
where the database X actually runs a
differently controlled statement that
something that does something completely
different we don't have to go into the
very nitty-gritty details the difference
from prepared statements here is in the
prepared statement you don't make this
connection between data and control
functions yourself but basically you're
just saying I put some placeholders in
the control statement then you prepare
it and then you hand over the arguments
to the database and the database is
doing all the necessary steps to keep
you safe so in the end you cannot have
sequel injections anymore because the
database is making sure that the data
you enter is safe cool right
who's using that who's using prepared
statements who's still using the top
form
nobody's admitting everybody's doing it
okay here's how the internet at fire I
did it he basically said okay um I'll
create like the control string and also
include the data then give this to the
prepare statement but because the
database doesn't have to do anything
because I have already done all the work
I don't need to add any arguments so he
reintroduced the concept of sequel
injections into prepared statements
if you are doing a sequel work and maybe
want to have a new intern who wants to
learn something then why don't you
contact him okay let's move on to more
sophisticated infrastructures and
away--but from just sequel injections
here's another example the whale deck
bought that whale deck had a pretty
sophisticated infrastructure it would
never tell you who is which is the real
command control server it would always
relay every request from an infected
system through other infected systems
and a layer of proxies until you end up
at the real command control server the
idea there is that nobody ever knows who
is the final server because you're going
through multiple tiers and you're only
talking to the next level of infected
machines so if you want to see what's
going on in such a botnet there's a very
nice position and that is right in the
middle because you get a lot of traffic
from all kinds of infected machines and
then can maybe see what's happening
there so when we were researching this
botnet we were actually thinking how do
we become such a relay and we did some
experiments and we found out that for
example if you provide full internet
access like no firewall good bandwidth
and you have to wait about like 45
minutes sometimes an hour and then you
would be promoted to such a relay I can
tell you when you reverse engineer stuff
45 minutes is a boring long time if you
have to wait for feedback it sucks and
you do that maybe for half a day but
then you say no there has to be a
different way and actually yes there was
a different way they had a command-line
switch you could just say - are and
suddenly you became a relay hey
beautiful that simplifies things a bit
way like was actually also properly
architectured there used our say for
encryption again military-grade right
and they had a well planned command and
control stack you have to say
so they used XML for formatting the
messages and what's the problem with XML
it's big right XML gets huge and bloated
so how do you deal with data that's huge
and bloated
well you just compress it so they took
XML be zipped it but be zipped is still
something that everybody can read so you
need to add some level of security and
in that case that was aes and the keys
were exchanged using RSA so best
practice military-grade again but they
wanted to use HTTP connections because
HTTP traffic that's kind of not
suspicious if you create your own custom
binary protocol that's usually held up
by firewalls next-generation firewalls
and so on so in order to get binary data
through HTTP connections they used
base64 and because basics t4 by itself
is not supported by GP they also needed
to URL encoded it in some form by
changing a few characters so then they
had like a beautiful stack that fit all
the requirements okay I'm looking a bit
at the encryption so they had pretty
much three keys - were hard-coded for
exchanging relay nodes and for
exchanging client RSA keys to the server
but the important one is actually the
session key for command control traffic
between infected system through the
whole chain to the command control
server and we observed that key for some
time actually at the top down here you
see the session key for January in the
second line you see the session key for
February in the third line you see the
session key for March than April then
may I you can see that actually the key
never changed and stuff like this
happens when you create a threaded
server and some threats like Windows
they don't see the random number
generator so you always end up with the
same beginning seed and if you create a
new random number and new keys like that
you always end up with the same key and
they didn't see it
so what we did we created a decrypter
and told our friends we can break ours a
because we can always extract the
session key
they were pretty impressed until they
found other we were just playing them ok
so now we are man in the middle we can
crack open their crypto and we can
actually encrypt as well because we know
the AES session key then we started
investigating what is actually inside
the command control protocol and we
found out that they are downloading
pictures in there and I wanted to share
a little bit about the picture we found
here but this is not really for
everybody so um if you were not if you
have problems with this bad pictures
please um close your eyes now seriously
this is not for everybody there was the
picture they were sending us politician
in his best form when you reverse
engineer I tell you you were always
interested in the naked truth so we
didn't see the whole naked truth yet we
wanted to know what's actually under his
pants and we did find something there
we found a signature and an X or encoded
version of a binary which would then be
downloaded decode it and then execute it
on the infected systems so there are
three problems here now you can easily
become men in the middle
they have screwed up the encryption even
though using RSA and AES because of not
thinking about the random number
generator that's creating in the keys
and third of all there's an easy way to
create payloads just using some simple
XOR so putting this all together you can
actually push your own cleanup utility
to all infected machines and do all
kinds of other things you can also
divert the infrastructure and then take
over the whole botnet and actually we
did so and there are still some infected
machines reporting stolen passwords to
some of our sinkholes
sometimes you don't even need to hack
the infrastructure itself but you can do
some tricks in order to divert some
traffic so we started with configure
let's also end with configure configure
a had this random number generation as a
random IP generation that we talked
about the very beginning there was one
limitation to that it was using a GU IP
database and looked up the IP it
randomly generated and if it found out
this next IP address I want to attack is
in the Ukraine I'll skip it I'll move on
to the next one what does that tell us
do we have any any analysts here like
political analysts because they always
tell you it's not that easy my friend
it's more likely that it's actually the
Russians trying the Ukrainians for
creating something like that and if you
look at the current political situation
between Russia and Ukraine it's highly
likely or if you know how smart Trump is
and you can also say it's Trump blaming
the Russians for blaming the Ukrainians
for creating a conflict there could also
be that North Korea is trying to blame
America for blaming Russia for blaming
the Ukrainians but let's not go into
these details the database that they
were using is from a company called Mex
mind anybody heard about max mind some
people so max mind because they were
almost 10 million machines infected they
were dust ddosed on voluntarily because
every instance of configure would
download the full database extracted
locally on disk and then run these
queries so max minds they had to take
their database down and move it to a
different location not the hard-coded
your l that configure was using and so
they only serve to 404 and then we went
to max man and said you know what we've
crafted this rather small variant of
your database just 36 bytes in size it
tells that the whole internet
is in the Ukraine and you know what that
really worked
suddenly all configure a infection
stopped and by the curve you can see how
infections went down over time so to sum
to sum this up attackers they usually
exploit bugs in our systems they exploit
bugs that you by excellent have in your
software in your architecture but also
for contains bugs not only the ones that
is used on the defending or productive
side but also in malware and there's a
lot of stuff you can learn from the
mistakes they make but the key message
is don't be afraid there are always
things always ways you can hack back and
it's a lot of fun thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>