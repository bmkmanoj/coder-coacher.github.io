<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Thinking in Events - Mathew McLoughlin | Coder Coacher - Coaching Coders</title><meta content="Thinking in Events - Mathew McLoughlin - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Thinking in Events - Mathew McLoughlin</b></h2><h5 class="post__date">2017-07-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/sPseA_3UOMk" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">my name is Matt McLaughlin uh she wants
a welcome to my talk firstly want to
take it all in the right room because it
seems to be an awful lot of you and I'm
pretty certain some of you might have it
wrong but anyway um I should also say
welcome 20c Singh is on the first talk
for those of you haven't been to his
conference before my beams
I think last four or five years now I
had the privilege of speaking a few
times and it's a brilliant conference so
hopefully the next few days you're going
to learn a lot of new stuff and by
Friday you'll be absolutely knackered
and brain fried but it's a good thing
because you can learn lots of stuff so
my telex titled thinking in events
before I get started was couple of
things that I want to cover firstly I'd
like to thank NDC for not putting me in
one of those crazy stages that you see
around the building of amount of stage
actually hangs above the ground on these
big chains if you have stood on one of
these things they would do a little bit
and it's a little bit disconcerting how
you're expecting it to drop at any
moment so thank you for putting me on a
nice stable stage of over here some
cables and probably I could pop over
secondly I this is the second talk that
I've done where I've used my surface
book like Bobbie surface book in January
and it's it brought out me in an artist
in me because he's got a pen you can
draw all these slides turns out my inner
artist is pretty bad also turns out my
spelling is atrocious and my handwriting
is atrocious
so I've done all these slides now
hopefully there's not too many spelling
mistakes and hopefully you can read them
but with all that in mind yeah my talk
thinking events so excuse me M
why why restore why did I want to give
this talk so I've been working in the
main driven design for about four or
five years now in this concept proving
the main design of the event it's not
directly but it gets talked about a lot
and this event is very simple concept
the idea of an event is very simple
concept pretty sorry it's very clever
nice it's really useful for helping you
design your application for figuring out
how your application works and it's also
a good resource for helping you build
your application and it can change the
way we do architecture code so I just
wanted to give a talk that goes back to
the basics of an event and point out and
highlight some of the benefits that it
can bring you when you're going through
this process of working on an
application the things that were going
to be covering so like I say I want to
talk a little bit about how this idea of
event can help the way that you design
your application it can help you figure
on the stand the application you're
building better and it can help you work
with your domain experts better so I
want to talk a little bit about that and
I'll then define I also define water
what an event really is and then I want
to talk a little bit about how this idea
of an event can change the way that you
write your code and at the end I'll talk
a little bit more about some of your
benefits of this idea of an event will
bring but what I want to do is I want to
start off actually by talking about
where I see a problem with the way we
currently write applications and this is
a problem that I hope events or will
will fix the domain that I'm talking
about so I used to work for a hospital
in the north of England and NHS hospital
called the Leeds Teaching Hospital and
whilst I was working there we had this
idea of something called an encounter
now it's a pretty simple concept and
basically an encounter is the thing that
is responsible for free I'm getting very
close to the edge honor I'll sit back in
a list that would be disastrous via
Darin encounter is if the thing was
responsible for tracking a patient's
movement through the hospital so when a
patient gets admitted
but you see encounter that deals with
that when they get transferred to
different worlds
it's be encounter again as a finger
deals with that and finally and
hopefully when we get discharged
again its encounter it deals with that
so it's only very simple problem
hospitals in general are an absolute
minefield of it is in crittenton
incredibly complex feel to be working in
but this is the only very simple problem
but I want to talk about but hopefully I
can use it wellness to demonstrate some
of the points I want to make so like I
say let's start talking about the
problems I see with web applications
so I with applications in general sorry
so imagine the scenario okay see inner
artist godhunt that so this is a little
stick man I'm going to call him Adam
Adam stigma
I'm stick man he's on his way to
hospital because he's got something
wrong with him now the first thing
happens when you go to hospital is if
you're in the NHS you wait for a very
long time like four or five hours before
anybody even realizes you there but
you'll end up speaking to a doctor he's
a doctor he's got a stethoscope that's a
proof this doctor will be responsible
our nurse will be responsible for
admitting you to the hospital now when
we make you to the hospital they need to
record this somewhere right missus
whereas software engineers come in and
we build these applications so they can
record this information and generally
what we'll do is we'll go our right it's
a new patient let's create a patient
okay so we have some code creates a
patient then that's fine
now it turns out that mr. stigma here
he's not so well stigma is not well you
can tell by the unhappy face and he gets
moved to a ward so it was the transfer
happening again so again in this
situation we need some software that
will manage recording this transfer so
what will we do or we go our right okay
so we looked at the patient record
we know he's now gone from soirée to
what be what tend towards 74 or whatever
it is and we need to record that
information then if all's well
mr. stickman gets to leave the hospital
he's alright everything's fine and a
good excuse me again he need to record
this information so we do the same
things we did before and we update the
patient record right now this this is
wrong for a number of reasons firstly
when you come to writing a code like
this and you can all see where it is
going into an update method this is in
service layer somewhere and we always
try and handle too much in these update
methods you'll always I find them like
100 line long hundred lines long but
I'll trying to deal with multiple
different situations but that's not the
only problem
the other problem is this isn't how
people think right we are software
developers of me personally in my early
career especially we would be taking
these what are actually real world
events with things that are happening in
the real world and we'll be taking them
and we'd be trying to convert them to
these update statements whose create
statements and there's a there's a
disparity between this we it's not
one-to-one it doesn't make sense and it
gets worse than that as well because
it's not just us that are trying to do
with conversion when we start talking
about updating things and creating
things and deleting things to the domain
experts to the nurses to the doctors we
also get them to start thinking in that
way as well and they start going alright
so you want to create patient and you
need to update a patient man and then
and that's not how it is in real real
world in the real world it actually it
is it's events it's events that are
happening to his patient and these are
what we call the main events right so
these are things that are important to
the users of your system okay there's a
couple of things to note about events so
firstly they're always a if it always be
described in the past tense which that
makes sense because an event is
something that's happened subscribing
them in past tense that's pretty obvious
we should always be expressed using
something called ubiquitous language
because nothing that's right whatever
and this is probably something recession
worthy of its own slide this idea of
ubiquitous language now this is
something else that we do with software
developers where we take what is
actually in a real world and we change
it to suit our needs and we change the
way the code is written and we change
with the language we use and it's very
important in you you use the same
language with your domain expertise
because then you've not got the
ambiguity what people are saying I mean
it can be something just as simple as if
they in last bill they call it the
birthdate so don't change it to date of
birth in the code use the language of a
domain experts use in your code and it
makes everything a lot easier to
understand especially when you explain
what's happening to them and as I say
it's something that invented something
we are your experts care about excuse me
so another thing that happens when you
start talking about these events and
start thinking about these events is the
way in which you actually think about
the entire lifecycle of your application
changes as well you go from thinking
about updates and creates and changing
continuously changing the state objects
and you actually start thinking about
what happens within your system over
time so if you think about some of the
events which we discussed early about
all we showed earlier we've got patient
admitted admitted patient transferred it
might be patient record survey taking a
diagnosis of taken or whatever it is
these are actual events and you can
start to see but sad to think about how
that patient goes through the hospital
and how it works over time which is good
because again that's model in real world
so where can we use the idea of this
event
now does this idea called
event Stallman it was devised by a guy
called
alberto Brandolini two or three years
ago now maybe even a little bit longer
and the best way describe it's a recipe
that he's come up with
for organizing a collaborative meeting
between you and the domain experts it's
a meeting was designed to help you
figure out what your applications should
be doing and to help increase your
understanding of a domain and as with
any good recipe it's got some
ingredientses so the first ingredients
is a roll of paper now well-aware now
what that actually looks like a roll of
toilet paper again not the intention
we're talking like a big sheet of
butchers paper as much paper you can get
a hold of okay and this is going to be
your modeling surface this is going to
be where you're actually figuring out
how the application is going to work the
next thing you need is a stack of
post-it notes of different different
colors now when you actually read about
alberta's but of stuff he specifies
certain colors for certain things you
can follow his a scheme is a key but
ultimately just get as many different
colors as you can and then the last
thing you need for this recipe is these
guys the domain experts so when you set
this meeting up the intention of a
meeting is to figure out part of your
application are a large carry
application or a small pilot application
what you need to make sure is in that
meeting is the people who know about it
people who know about that part of a
system and in it and in meaning it's not
going to it's not going to be worth for
any time because you're just not gonna
be out answer any of the questions that
you've got so you need to get the right
domain experts and the right engineers
in the room now when you've got all
these things you go into room and you
get your paper and you stick it up on
the wall okay and visit like as a basis
and modeling surface and the first thing
you need to do is you need to get
together and you need to sign decide
upon an event your first event there's
going to be a number of different things
it can be an important event within your
system or it could be the last event
moving your system or the first event
where you need to come over just one
event which everybody agrees on is
important and you put that on a yellow

okay again just to say the main events
grabbed in past tense expressed using
the ubiquitous language this is where
ubiquitous language comes in helpful
because when you're talking about it
together in the same room there's no
confusion
I've even going to be extent with regard
to the language if it's certain terms if
you're working in the complicated field
actually documented in that language you
know in a github repository or something
is also pretty user so you take that
event
and you put it on your paper now this
service modeling surface you'll see this
time at the top so the idea is that
these events happen over time we modeled
intellect left to right and as more
events we put on get put onto a sheet
you should form some sort of order so
once you've got this first event on that
you now need to start thinking about
other events you want to think about the
events that lead up to the first event
you want to think about the events that
happen after this event in snap pop
among any piece of paper and such build
up a bit of a picture of how your
application is going to work all the
time now your system isn't just events
there are all the things misses where
the different colored post-it notes
notes come in to come into play so
another thing you might want to take
into consideration is the commander of
the action okay so this is something
that a user an action reviews might
perform you know that results in
generating an event so in order for a
patient patient to be admitted somebody
has to admit the patient so these are
also useful things to document on the
under under modeling board use a blue
post-it note for this are and even any
clue youtubes and you can start touching
these next to the events but the events
that they generate so now you've got
your actions he commands and your events
some more things you might wanna think
about external events because purple
post-it note for this I think I might
have that right
these are passive you system where you
might not necessarily have control over
what is happening it might be an
external system it might be another team
within your
a business but you might not necessarily
be able to do anything with our software
maybe some legacy stuff these are still
important events might relate to your
name so you need to put these on the
board as well things on you control in
the case here admission from ADT so in
the hospital ADT stands for admission
discharging transfers
it's another application that can also
admit patients to to the hospital so
it's possible we could get an admission
not only from a user interaction but
from a different system and then people
those bars on the body on the bar as
well again science build up a picture of
how your system works over time another
thing to consider is read models are in
DDD the marked and known as projections
this is your views your views of the
data these are the things that we are
your users want to be able to gather
information from it's also where you
might get information from in order to
execute a command also important to the
system you can put these up on the board
as well now the next one's relatively
important and that's questions so at the
start I said you need to gather all the
people that are relevant to that domain
in the same room so you can answer all
the questions but it might be that the
right person is actually not in the room
you know you don't know where this
modeling process is going to go so if
the right person isn't in the room you
could get stuck on a given point now
normally what happens in meetings
earlier I find in meetings is when
there's a point of contention or
something we start understood rather
than trying to get that guy in a room or
postponing it what happens is two people
who don't really know what's going on
will then attempt to try and figure it
out themselves and we'll make a lot of
instinctive guesses about what could
happen and we'll probably get it wrong
so rather than doing that just write the
question a post-it note and stick it up
on the board now it might also be done
of all the relevant information as well
so it's not just that one person the
system don't not let out the system
might not be in the right state to make
the decision
now when you put these on the board
you'll start to notice something and
this is why it's good but it's visual is
that the certain parts of your
application that might be more
problematic than burnovers you might not
know what these are going in but when
you start speaking to the domain experts
and all these questions that coming up
you'll notice or probably our color
right around a given event or a given
part of the system as you can see here
as a poly demonstrated my drawings all
the events are kind of group sorry the
questions are grouping around the top
left hand corner so even without knowing
what the questions that you can tell
that that's probably a problematic area
in the software so you can then go and
drill into that at a later point our
focus on that in a different meeting but
it highlights it there for you now just
to give an example you hit two actually
some real world events in there that you
might see so you've got a admit patient
command there a generates a patient
admitted event we've got a question web
with transfer a couple of log use it
really helps building a quick good view
and collaborating now a couple of tips
for running this meeting so the first
one is you need lots of space is a space
lots of space I'm talking about modeling
space there's no point going in there
with a couple of a1 sheets of paper
sticking up up on the wall because
you're an out space and it becomes
difficult on the meeting so it makes
sense to put up as much paper as you can
just spoil it all across the walls and
give everybody the opportunity to work
on it the next point is no chairs get
rid of the chairs because wheelchairs in
room it gives people the opportunity to
do what I do which is go and sit down in
the corner of a back in Chandigarh I'll
let these guys figure it out if you take
away the chairs I've got no opportunity
of a possibility than to stand up and
actually partake in the meeting this is
important okay then finally we have a
typical X install like I said about the
questions when
people get stuck on a question or they
start arguing about how certain things
should work it can just completely
dominate the meeting and you'll so often
you going to meetings and the aim is to
figure out a large part of a system and
how you want it to work and you'll get
stuck on at one point before you know it
the meetings done so just write your
question down stick it up and come back
to it later you have got to try and keep
the flow going so what are the benefits
of this well as I said it really does
help with understanding it helps you
identify the problems are in your system
it helps you collaborate better with
your domain experts and understand what
exactly what it is they're wanting it's
visual now there's a was a guy called I
think his name's Dan Rome I don't if any
of you guys have heard of Dan realm no
nods or anything so this is a guy who
wrote a book called back of a napkin
she's all about how you can use diagrams
and things I like to explain your points
a bit better and this good book is worth
reading and one of the things that goes
into is the fact that when you're young
when you're a child you you you learn
via pictures that's the best of a
primary way that you learn and then as
we get older we seem to replace this use
of pictures with just text which is a
little bit crazy because when you ever
look into any scientific reports on this
that better learning is aided by Bofur
use of visual aids and text so just
using text is it's really so when you're
giving few functional specs just reams
and reams of what you want to happen
it's nowhere near as good as doing
something visual it uncovers problems as
I said with the with the questions in
highlight where the problems are and
hopefully it's fun as I said there's
nothing worse and when you go into
meeting and you've got this big round
table and you all sit around it and
somebody says right I wanted to do this
this and this and you sit there and
start checking Twitter and we start
falling asleep and you just give up on a
meeting emails whatever by forcing
people to stand up to actually interact
and work on this board it really
cultivates this want to figure out these
problems and generally when you come out
of these meetings you don't want to kill
yourself which is a pretty big plus in
my in my opinion now once you've done
this event solving process it's
sometimes useful to focus in on a
particular commander in a particular
event in more detail so we're talking
about this kind of relationship and when
I do this this is fourth aspects that I
like to look at as far as I guess what I
like to ask about this and this is what
is the decision is getting made what is
the information that needs to be
provided as part of a decision getting
made what is the result of this decision
and finally in probably and importantly
when to miss decision actually be made
and when you ask these four questions
they're kind of like my my guidance or
when figuring these things out you can't
come back with something a little bit
like this so you can say the decision is
to transfer the patient so you've got
your commander so that's defining your
command the information required is the
new word reward where this person's
being transferred and that's the
information we need to provide with
patters commanding the code then you've
got a result and patient is transferred
that's ultimately the event that gets
generated back of it and then over
bottom when can this decision be made as
long as a patient is admitted now it's
only a very simple business rule often
it's more complicated route but that
helps you've ended define business rules
which you want to build into your
application if you do this for a series
of commands and a series of events
you'll start to see that certain events
are aligned and certain commands that
are reliant upon information from each
other and when you get into DDD versus
our idea of aggregates and grouping like
objects together into these aggregates
and knowing which ones are related by
asking these questions helps you define
that are exact finally helps you define
that because it is two events are
reliant upon the same information and
it's possible venue
together and same aggregate Bismol scope
of that lab but I'll I'll leave that for
the philosophers table
so we've now gone ahead and we've used
events darling and we've used it to
understand which events are in our
system we've refused it to help us
understand the system better and to
collaborate with domain experts to find
out what they want but the reuse of
those events what you discovered doesn't
need to end there and you can you can
take those events and you can use them
to actually help you build the code and
having helped you didn't figure out how
to act take the code this is where a
subject called events arson comes in
Alex in my mind it is now this is a an
idea that a guy called Greg Young came
up with during our 10 years ago or so
but if you speak to Greg it's actually a
concept that's been around for a very
long time in other industries it's only
really in recent years and like so past
10 years when we started considering
these things in in software architecture
and it's very basic level it's just a
different way of storing your
information just so happens to work well
as events and same events awesome so if
you take this example here going back to
a state driven application you can see
on the left hand side we've got a series
of events a number right hand side you
can see how we potentially update the
state right so in the first case we
admit the patient a gentleman called
Tony Ferguson we then transfer patient
towards 76 we went transfer patient or
what again to far and above times to do
that we just update record and then
finally at the end when we get
discharged you might have a flag
announced as a no longer around which is
in the hospital and we're not in the
wards so you'd say it's Anil or
something like that
now we've events arson rather than
updating that state you actually make
use of the events that you've discovered
as part of events on the process and
take those into a code and you star
those events as opposed to change your
mistake so in the case of admitting the
patient we saw a patient admitted event
in the case of transferring a patient so
our patient transferred event
and finally when we discharged the
patient discharge of them again you'll
notice the use of passive tense in the
events and also when we're saving the
events we're only starring information
which relevant to that event rather than
constantly saving the entire object and
if you do this for all the objects
within your system you'll start to build
up the stream of events of everything
that's ever happened in your system
since of a day of Inception and you'll
you'll get something like this which is
an event stream right now this isn't to
do with the main I've been talking about
but this is a piece of software that
Gregor's written called events star and
it's the persistence mechanism is
designed specifically for starring
events so here you can see this is
probably part of a credit check software
so we've got the deal complete for our
check paths and things like this and you
get this stream of events of everything
that's happened over time now why would
you want to do this well we've said that
it's a good way of modeling the events
that you've discovered in the system but
it's also got some technical reasons
which are pretty good now if you
consider this situation here okay so
again patient admitted patient
transferred transferred and discharged
if you were just continuously updating
the state then there's a potential that
you you're going to lose the fact that
this patient was currently on a
different mod if you're just updating
the wild ID that they're on once you're
under the second transfer the first
transfer is going to disappeared you
never could have known that's happened
we're event sourcing because you're
saving the events you've always got a
record that that thing has happened now
there isn't of a way to do that
lose them this is anybody's on this
before there's not enough funds up I'm
sure over a year ago way more people
have done this I've done this and this
is the whole idea that you starve
patients in the table but each time you
update that patient record you take a
copy of a row and you and said in an
article using sequel server you will use
this thing called database triggers to
do is potentially which a categorically
the worst thing ever as far as I'm
concerned the amount of times I've been
caught out by database trigger that's
hidden
and are so many times a guy even count
so you could do this but this has got
some problems and one of the big
problems with this this free fall
probably prom service the first one is
each time Europe datum and record you're
saving the entire row now space isn't as
much of a premium as it used to be a but
it's still possibly something you want
to take into consideration so
duplicating the entire row every single
time you just change the world it's not
necessarily a good thing
next you actually have to figure out
what has changed and this normally
results in some sequel script that
compares one row to its previous row and
looks at the differences and tries to
figure out what what has changed my can
kind of be a little bit of a tricky
thing to do
also it's not reliable especially if you
have used database triggers not
necessarily a guarantee with this happen
if somebody deletes the trigger where
you have no idea of deleted it and the
only way you time you'll have to find
out with links is when somebody says
yeah how about that audit we need to
take a look at it at that point yeah
it's too late but the last point and
possibly the most important point when
it comes to artisan a use for them when
you do eventually get audited and ever
having everybody who's gonna go for it
at some point with their software when
we order two looks and they see that
something's change your first question
we're going to ask you is why I changed
okay and doing it this way you've got
even no way of knowing that I mean you
might be able to interrogate an IAS log
or you might be able to interrogate a
transaction log in the database but
you're never really going to know what's
happened with events are seeing you're
starring the event which is what has
happened and you're soaring just the
information but has changed so when it
comes to an auditing when it comes to an
odd in point of view it makes it pretty
good okay so that's one reason why it's
good and it's alright to say yeah it's
good but how does it actually work in
practice so again going back to the four
events that we've already talked about
admit transfer transfer and district
education now it's alright saving those
events but ultimately still need to know
the state of that object if you want if
you want to apply any business rules to
it or you want to check anything about
it so the way it works is when the first
event comes in or when the first command
gets executed and with patient that's
pretty simple one the object doesn't
exist yet so we just generate a patient
admitted event when it comes to
transferring the patient well we need to
know if the patient's already admitted
in order to figure that out we take that
patient admitted event and we replay
against the object when we've done that
we'll have it in its current state and
we can check to see whether we can
transfer it and if it's successful then
we can save away the patient transfer
event can serve a patient again so in
this case you need to replay the patient
admitted event replay visit patient
transferred event and then finish off by
attempting to apply the patient
transferred event the second patient
transferred event a finally when it
comes to discharge and patient you
replay the first three events and then
attempt to discharge a patient so that's
how you get to experience state now this
does have a couple of problems and it
might be pretty obvious it is if every
time you're wanting to use the subject
you have to replay every event that's
ever been saved against it you have to
replay all these event and it can take
quite a long time well no it
realistically doesn't take a long time
if you've got an object that's only got
maybe like a hundred event saved against
it you'd be surprised how quickly
depending on complexity you can replay
those events to get to the current state
but if your object does have a lot of
events again so that you can use
something called the mental pattern of a
snapshot plan depending all you want to
call it and this is the idea that every
X number of events you actually take the
state of that object and you save it
away okay now what that then means is
when you want to rebuild your subjects
you don't have to replay all the events
you can just take the last state and
then replay all the events that have
happened after that state was taken
makes it a lot quicker so I covers
pulling out these objects in order for
in order to be able to change your
object or be able to execute a command
against it but what it doesn't take into
consideration is the possibility you
want might want to aggregate a number of
encounters together so we saw in one of
the previous events on screens screens
that one of the things they wanted to
see was a ward view now if we're going
to use this technique in order to
generate a world view we would have to
get all the encounters we have to replay
all the events of those encounters have
got against it you gonna have to
aggregate that data together into some
code word view and they'd have to return
that to the user and that could take a
long time that's where it really does
fall down but it's also where this idea
CQRS comes in now CQRS is an extension
upon an idea from cob from a cob
Bertrand my opium decided everything
called cqs which stands for command
query separation and this was the idea
that a method should only ever be
responsible a function should only ever
be responsible for either performing an
action are returning a query you should
never do both and that makes a lot of
sense because if you've got a method
that returns data but at the same time
it modifies it then you're going to end
up in a world of high especially if this
is something that's hidden behind a
third party API debugging what's going
on is going to be a nightmare so it
makes sense to keep them separate CQRS
command query responsibility separation
yep stands for takes it one step further
and it says well we want a different
object for our rights and we want two
different objects for our reads and in
the case of events arson that makes
sense because you've got this model
which is good for writing it stars all
your events which are incredibly useful
but it's not very good for reading so it
makes sense to have a different model
now if you ever if you ever used the
sequel server and you kind of use the
entity framework to write to the
database but you've used something like
an SQL view to read from a data basis
that could be considered severe icing in
one respect because there's two
different models
now it turns out the reasons are
actually really good at generating these
remodels because there's no reason you
can't have a mechanism within your code
that says well when I see these events I
want to use them to update a static view
so when I see the patient admitted event
there's no reason why I can't say well I
want to take that event and use it to
insert a row in table when I see the
patient transferred event I want to use
it to update a row again second transfer
or gate the row again to salade and then
finally when it comes to discharging the
patient when we see the patient
discharge event we could just delete a
row from the table we don't have to do a
soft leave anything like this because
we've got a record that delete happen in
the event so this is just the purely for
weed per Connery point of view so you
can remove that rail completely so now
you've got your event stream and you've
got them generating a model that's
suitable for reading and when you start
thinking about separating your write
model from your read model there's no
reason you can't take this a step
further and say well why can I have
multiple read models or you can there's
no reason why when you see the patient
admitted event but you can't use that to
update award view you can't use it to
date a demographics view and again this
is something that's incredibly powerful
technique because it it brings a number
of advantages the first one is if you
get a bug in your ward view for whatever
reason some reason somebody to print
some bad code probably me.we syndrome
some bad code what you can do is you can
delete that wire of you completely you
can fix a bug and then you can take all
the events that have happened within
your system and just replay them against
them against it since the beginning of
time and you have you'll come back up to
date eventually and the fix will be in
there another advantage is that
occasionally you get asked the request
I can see the world view now but what
was it like last week and in that
situation just create a new copy of a
wide view but this time only replay the
events against it up until last week and
then you'll have an exact representation
of how it looked last week and finally
and this one saved my bacon a few times
is adding for example reports to the
system after it's already in production
now in this case imagine situation of
the Lord we've been created it's been in
production for six months and the bus
comes along and says you want he wants
the demographics view well in that
situation you can created demographics
projection you can listen to a patient
admitted event you can bring it online
and you can replay all the events
against it and it will be as if that
view was there since the beginning of
time it's dead simple to look around
let's just talk my finish it 20 past
that's all right yeah okay so that's
kind of how ever to work together I just
want to talk a little bit about the
architecture so there's multiple
derivatives of this and you'll see this
but you'll see this kind of diagram
quite a lot people change it a little
bit doing slightly different ways but
this is kind of your quintessential base
level architecture where you'll have a
client at the top this client will take
the command and it will give it to a
dispatcher which will enter interact
with a domain resulting in some events
being saved those events will then be
put into event star and read by the
projection manager now one of the terms
like two times I really hate in software
development app manager and service they
don't do anything to explain what's
going on but in this case I think it's
okay everything is a service right
everything so this projection manager
will be responsible for giving the event
to the correct projections and that in
turn will populate read model which come
and be viewed by the client to go into
it in a little bit more detail um this
this is a start of a pipeline so when we
see a patient command this is a common
pattern but you'll see a lot basically
give that bit patient command to a
dispatcher
about dispatcher will then be
responsible for it figuring out which
piece of code needs to handle that
command if you see in a mediator pattern
ever mediator library by German Bogart
is that kind of does this thing when it
what it looks like in code it's a see
shout but wait looks like in code
eventually is you can see the top you
create the patient and MIT command you
then dispatch it the dispatcher is
responsible for figuring out which
handler it needs to use to execute and
it gives the command to the handler the
handler itself creates a new encounter
and saves it away the next step is is
actually within encounter objects so we
admit and leur calls into the encounter
object now this encounter object is
responsible for a number of different
things it's responsive responsible for
three things first is a list of events
so it needs to be able to generate a
need to get to keep track of which new
events have been generated so they can
prevent save to the database
it needs to be able to keep track of its
version which I'll talk about in a
second and lastly a nice fail to apply
events so this is what I was talking
about when in order to get the object to
its current state you take off events
that are happening you play it against
the object and eventually you will end
up in its final state the reason for the
version is to do with concurrency and
this is if you've got two people that
both want access the same encounter one
pulls it out at version 5 we haven't
built it out of version 5 first person
generates a new command new event sorry
and it's now at version 6 we save it to
the database the database go so it's
version 6 call you can save it
the second person tries to do the same
thing and save version 6 but now it's
version 7 see there's an app
screw you can have it throw an error
return it back to the customer get them
to be submitted are some other business
rules can take care of that situation in
code it ends up looking a little
something like this
so this is the constructor of encounters
so personal information was required we
generate a new patient admitted event
and raise it so when we call the raise
method this is responsible for storing
that event in that collection of new
events and it also is also responsible
for calling in to the correct
method and then the when method applies
it to the actual object reason these two
a separate is because like I say you
need the ability to replay and when you
replay call it just cause these blend
methods and then this is the last bit of
a puzzle which is a projection manager
so we've now got this patient admitted
event that gets given to projection
manager which not dissimilar to how the
command dispatcher works it takes that
event and it figures out which
projections care about it and it gives
it bad event which make a man go and do
whatever they like with it such as
update award view again there's an
important thing to note here which is
the check point there's going to come a
time when your system goes down every
day and when it goes down the last thing
you want to do is start it up from event
one again so in order to prevent that
happening each time your processor to
rank you saw a check point of when that
event us of when a bad event that means
that when you restart it you can restart
from that event as opposed to the
beginning encode looks a little
something like this so it is a
projection and handling an event the
patient emitted event when it sees it it
this was actually done using Raven dB it
opens up a connection to the database it
stars a patient says the changes and
then carries on with it's on its way now
if we go back to this diagram this
process can actually take a bit of time
and that can be problematic so when the
client submits a command yes they have
to wait for it's a con to write domain
to rehydrate the object to attempt to
apply the event save the event event has
to wait for the projection manager to
build the Pollack's projections before
it can return the view saying successful
and although it can be reasonably quick
akin it can produce it unresponsive UI
and to get round that you can actually
separate off this section on the right
you can separate off of a projection
manager into another process because as
far as vu is concerned as soon as that
events being safe you can consider that
successful so you can return 200 to the
user
and they can go on with their merry way
but it does introduce a problem doing
this which is this worth it obvious two
words here eventual consistency it's too
terrifying words and this is the idea
that because your views have been
generated in a separate process there's
a possibility but when the user submits
that command the result of it might not
be very straight away realistically
we're talking seconds but from a UI
perspective we can look a little bit
inconsistent we start talking to
front-end devs about this stuff they
start getting really ratty because they
want the data that straight away in
reality I don't think it's that big a
problem I mean there are ways you can
deal with this so one thing to do is
once the command is being successful for
that user you could emulate as if it's
being successful on a front-end maybe
update a table or a review just sort of
a meanwhile or another option is you
could you could generate an event after
projections have been completed and use
WebSockets or something to return that
to the UI and then they could say ok
it's there we can update the update
review now in reality I don't this is
only a problem for the actual users
submitted the data everybody else is
using the system probably with no idea
this is going on but it's something to
bear in mind I also think a topper a
little bitter it's almost something
we've enforced upon ourselves but a user
now expects when they do something that
information is going to get propagated
all around the world instantly and
everybody's gonna be able to see what's
going on in reality it doesn't work like
that and before computers it definitely
work like that because you have to wait
for the paper to go down the hallway to
different office so it's just something
to bear in mind it's something to work
around if need be
so at event sourcing now there's some
more advantages that events bring the
diagrams are missing around us I
apologize in advance but it changes the
way your UI will look so many other
systems that I've worked on in the past
they all end up looking like some access
application where you've just got
streams and streams of pages that have
got every single fields of that object
on them and an update button or annotate
button our council bone at the bottom of
it and applications start looking like
that when you start thinking about them
as crota as opposed to a series of
events so our diagram but you kind of
get the idea when you move to events
this changes and you start thinking more
about I think the proper definition
definition is task-based you guys these
are you eyes that don't necessarily over
am just a single screen their screens
but more context driven they only
contain the information that's required
for whatever you're trying to do for
reacting you're trying to perform and
got more distinct actions which you want
to perform instead of just a single
update you'll have buttons Brad and mid
transferred discharge and so on and so
forth you can you can build more of a
workflow into your into your UI which
ultimately ends it ends up we've been a
lot more usable than these monolithic
screens they've got 100 million fields
on it that you have to change one and
save and wait the other advantage is
that event spring is around testing so
it was it of given one thing all right
so everybody knows Google Mondays are a
third arranged actual assert a camera
what we want is with events it becomes
really easy to write tests if you make
use of this given one then
so rather than updating an object having
to check the entire state of the object
after to make sure that if it's happened
you can write your tests more like this
and here we send up a scenario we're
saying given these events have already
happened when I try and discharge the
patient then I expect this event to be
generated okay and that that's that's
all that's pretty much only the south
test so you'll need to write right you
can set the system up in a certain
fashion and then you try and execute
command and certain result
and because you're using the events in
the tests and because it's written in
such a way but you send all these events
beforehand real are understandable and
Myra partly are a lot more
understandable to the domain experts as
well when they come to when you come to
talk about which tests you've
implemented because it's using language
they understand that okay when these
things have happened and I try to do
this but misses a result but some
libraries out there that can't remember
name fit now which help you help you
write testing miss fashion and this is
really the last advantage are on talk
about which is communication I don't
know what's happened in the past few
years but this idea of micro services
nano services Pico services it's
everywhere you can't get away from it it
don't understand it's not like it's a
new idea so the idea of separating
services but all of a sudden now the
micro services let's make them a little
bit smaller and suddenly a different
thing events are a good way of
communicating between the services so
these events are you're saving these
events that you've worked out in your
system make sensitive users make sense
to you both streams of events you can
use community between service and
service B so when serves a forms action
generates an event a service we can
listen to that event and do something
with it now there's two ways you can get
these events movies events between the
two services the first one which most
people have probably heard of these and
message cubes right smq RabbitMQ 0 and Q
these sort of things and the idea of air
is that you have a cue set up in the
middle and you put that event on the cue
and eventually service people pick it up
that works well in a number of
situations such as if you need that
event to be there immediately
then using a message queue is a better
way of doing it but it does have some
disadvantages another option is to
expose an API of some kind which which
basically lists all the events of your
systems generated right that's another
option that's good because it then means
it's service B is in control of events
that are coming out service a so
for whatever reason it needs to go back
and look at events that happened five
years ago we can do that with a message
few back can be a little bit of a
quickie thing to handle the downside of
doing it that way is in order to get the
events you know we have to send up some
set up some kind of polling service and
depending on how important those events
are you might poll every 30 seconds of
new events if that's a situation you're
not going to get your event immediately
and if you need to vent maybe message
queues are the best way to go about it
so that's that's pretty much it to be
honest there's some resources what I
want to point out so the events arming
but I've talked about it's time to talk
this is a book with Alberto's writing
it's on lean pub at the moment I think
it's about 70% complete but it was still
a lot of really useful information in
there already
hopefully you'll completely over the
course of a year so with the improve I
think I think you can pay what you like
above a certain amount so it's
definitely worth getting old about
there's these two books here which
anybody's done domain during design will
have read these books and not understood
them then read them again and not
understood them and then maybe Road on
the third time and finally got the head
round it okay so the first one on the
left is by Eric Evans which is kind of
the the first one to come along and
vonda and load another one with the
foreword by Eric Evans which is a new
book was also worse worth reading
I mentioned this it is done wrong yeah I
mentioned this book called back of a
napkin by Dan realm it's not directly
relating to this but I genuinely think
it's a good book to read and it will
make you want to make a render slide
decks with images that nobody can
understand like I did the code samples
that I showed you is part of the
explaining event sourcing I actually
wrote like a dumpster small application
with demonstrates fees for these points
and one of the things about events often
when people get into it is they're
always convinced that they need to look
for a framework or a library that helps
them do this if you actually go and look
at that code base you realize that the
actual framework code in order to get a
system like this working
if it's under a few hundred lines of
code I mean there's a little bit of
security in bits and pieces like that
but you might want to add
but it's there really isn't much to it
so by all means go have a look at our
project and berate me for my coding
styles or whatever and lastly some links
so there's this DDD event sauce
Instagram Google group has been around
for a long time now it's still pretty
active go on there ask questions you'll
get answers I mean there's people like
Greg Ewing on there it uses it Alberto
uses it couple of other guys are really
foreigns in these subjects answer
questions on that so it's a good place
to go and ask we run a channel a slack
channel that's server login for it and
we've got like a hundred users on there
now it's active every day we've got
channel there are rooms for events
arcing events darling DDD even CV app
stuff so it's worth going on there again
lots of people answering questions every
day sirs in a good resource and finally
the guy who invented event sourcing Greg
Young has done a really good video there
from I think that's our coding on the
beach one which is again another great
explanation but probably better
explanation me to be honest about event
sourcing and it goes into a bit more
detail about that
and finally my twitter address at the
bottom if you want to heckle me or
whatever by all means try and get hold
of me there and that's about it so thank
you very much rather than get everybody
to hang around and wave questions if
you've got something you wanna ask me
want to talk to me just come up
afterwards I'll find me so if I don't
keep everybody here you can go get some
food so thank you very much
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>