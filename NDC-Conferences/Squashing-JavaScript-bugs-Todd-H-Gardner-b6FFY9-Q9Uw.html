<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Squashing JavaScript bugs  - Todd H. Gardner | Coder Coacher - Coaching Coders</title><meta content="Squashing JavaScript bugs  - Todd H. Gardner - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Squashing JavaScript bugs  - Todd H. Gardner</b></h2><h5 class="post__date">2017-04-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/b6FFY9-Q9Uw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">is that my good to go awesome welcome
everybody thanks for spending some time
this afternoon with me my name is Todd
Gardner and what I want to talk about
today is smashing javascript bugs
debugging client-side JavaScript errors
because we probably are all writing some
JavaScript right so everybody writing
JavaScript yeah that's kind of scary
sometimes right you're not entirely sure
what's gonna happen and you delivery
you're at these applications out and
then when they go wrong you're not
always sure how to deal with it because
there's a lot of different things that
can go wrong and so what I want to talk
about today is we're gonna do some live
coding together not so much live coding
as live fixing bugs so I've personally
helped fix over thirty two billion bugs
and I'm kind of inflating that number
because I run a company called track J s
we have a booth out there if you haven't
stopped by to visit us and we help we
have all kinds of customers understand
the bugs that are happening in
production for a bunch of really cool
companies so if you want to check this
out later that'd be awesome we could
chat but so what I want to talk about
today is something else I have I've this
this this thing this problem I see out
in the market that I think we can fix
how many of you have experienced this
rage someone is wrong on the internet
and we have to go and fix it we have to
prove them wrong but more often than
that that gets us into trouble right if
you end up in an Internet argument they
probably shouldn't have started and so I
have this idea on how to fix that
problem and so I want to show you all my
next business idea are you ready get
rantarou uh-oh and so here it is is this
is really cool
blow you out of the water this is get
ranter dot io and it's kind of like
Twitter
it's got like your profile you can say
like how long have you been ranting you
can like add new things you can you can
talk and spit stuff out into the
internet and get all the rage out and we
can see
timeline of all the things that you've
been upset about over the over the last
couple of days months and I even have
like my mana tation on my monetization
model already in place I have these
awesome targeted ads that like follow
you around the internet and they know
exactly the things that you want to buy
so this is my account and so obviously
I'm really into bears and Crocodile
Dundee and bacon and oddly David
Hasselhoff but like it's targeted that's
what that's what I want and so I think
this is gonna be awesome this is gonna
just blow up but unfortunately I think
it ranter has some bugs in it and so I
want your help today we're gonna go
through this and we're gonna fix a
couple of things in it
so obviously this this is Silicon
Valley's next unicorn startup you know
we're gonna be a billion dollars next
year you're all gonna be like I saw the
first demo of it the first one I was if
I was there but so I really hate bugs
that's gonna kill my startup if we get
this thing out the door and there's
still all these bugs in it so there's
five of them in this app five different
classes of bugs so we're together gonna
go through this thing using live
developer tools and we're gonna bust
this thing open walk through the steps
to identify the problems where find them
in code see how they manifest themselves
and fix them
does that sound good is that pretty
close to the expectations you had coming
in the door I'm happy because that is
the only thing I am prepared to present
to you right now
all right so here is our very first bug
the user cannot delete a rant from their
timeline somebody said something that
they feel they'll end up regretting and
they want to get rid of it and right now
there's a bug that prevents them from
doing it so we're going to talk about
two different things in order to fix
this bug we're gonna look at the chrome
Dom inspector and the JavaScript
debugger
so let's kill this bug so we're gonna
switch back over to get ranter now one
of the first things that I always do
when I'm trying to troubleshoot a bug in
real life is I want to look at real data
and so this is my account on get Rancher
but you know I'm I'm the developer and
so my accounts always a little bit weird
you try out but you have interesting use
cases so I want to use one of my most
prolific users as my test case so you
know as an admin I can switch you know
the user that I'm dealing with so I'm
gonna I'm gonna switch that out and load
one of one of my big customers and we'll
see we'll see how well it does for them
so this is this is one of the biggest
customers the biggest users of get
ranter and and so he's been using it
since March of 2009 and obviously you
can tell that my ad targeting is just
it's just spot-on right like it is
clearly clearly a good target for my
customers but so let's use this customer
as my basis for fixing this buck so the
book was that the user can't delete one
of their rants out of the time line and
so here's here's the timeline and
there's a pretty obvious like delete
button there so let's just give it a try
let's just try and delete something and
see what happens so here um here mr.
Trump was railing against Congressman
John Lewis a few days ago and so we're
gonna try and delete that one because
that's obviously something that he
probably regrets at this point we delete
that and we just kind of see the page
reloading and but nothing's really
nothing's really happening although I do
get a bunch of new ad impressions every
single time he does that so I'm you know
I'm making a little bit of Bank off of
the whole situation so let's uh let's
start with um the Dom Explorer to figure
out how to do it so you pop open the
chrome dev developer tools how many of
you have spent time in the chrome
developer tools yeah all right how many
of you feel like you already know all
this stuff in chrome developer tools
alright well hopefully I can show you a
few tricks along the way
all right so here in the main elements
panel we see a bunch of information
about about the document itself we see
all of the different markup that makes
up makes up get ranter and so what I
want to do is I want to see what's going
on with the delete button itself so I
can use the selection to go into my
document and pick a certain element and
I can get some information about it so
let's grab this delete button we can see
that the the delete button itself is a
button element inside of a form with a
bunch of other things but I can get a
bunch of other information about it like
what I'm gonna do is I want to see who
is listening for events on this button
and so we can punch in here to event
listeners and we see that somebody at
least in the ancestors of this of this
element is listening for a click event
on the delete button so we can punch in
and we say hey somebody at the div level
so a couple of objects above this is is
looking for a click but it's just
something in jQuery that's not really
particularly helpful this little
checkbox here allows chrome to like
navigate through a bunch of the event
management frameworks and tell you the
actual code from your app that is
listening to it so by turning that on we
can actually see that some of my code
here in this rant ListView j/s is what
is actually doing the behavior through
through jQuery and so we can punch
through and and take a look at what's
going on and by doing that it bounced
this over from the elements tab to the
sources tab and the sources tab allows
us to actually see the source code
running and punched a straight 2 through
to the line which is right here on line
19 line 19 is we've set up a click
handler using kind of a Jerry esque
syntax but hey when we're gonna win
somebody clicks on an element we're
gonna check to see if that element
matches a particular pattern and then if
it does we're gonna call an on delete
function this is a event delegation
pattern where you can listen for an
event at
higher level then then where it's
actually going to be originating from
and then check to see the the event
target matches the event you're looking
for it allows you to centralize some
logic and attach fewer listeners on the
page so let's um let's attach us some
breakpoints here and see if we can debug
what's actually happening so well we'll
go ahead and attach a breakpoint right
here on line 20 and you can do that
simply by interacting here with the the
the line numbers with a breakpoint
attached we can go ahead and try and hit
the delete button again and we're able
to catch that the event happened or have
you dropped in here to our event our
event listener function and we can see
all kinds of interesting information
about the current running state of
JavaScript at this point so in these
sections down here we can see
information about local variables we can
see what is the event object that
originated and we could explore and see
more information about it we can also
see anything else in the local namespace
like what is the value the current value
of this and then here on the left we can
see the call stack so we could see what
are the the things that originated this
function so we see that right now we're
calling into an anonymous function which
would be the function that was defined
here without a name is the anonymous
function that anonymous function was
called from deep inside of the bowels of
jQuery now we don't really know what
happened before that which is kind of
interesting like where did this event
come from chrome dev tools and maybe the
last year or so introduced this check
box right here this async check box
which is off by default because there's
a slight memory pressure that it
introduces on your local computer when
you turn it on but if you have a
developer class workstation it's totally
worth doing by turning it on we can see
a whole bunch of more information about
where the this current - JavaScript
execution stack came from so if we go
ahead and just with this turned on we
just need to reload the page to like
make that take effect our breakpoint
should still be in place and if we hit
the delete button
again and our and get moving right along
okay
so here let's like take a look at the
actual code so the actual code that we
have operating is where we get this
event and the event is a click event a
click event on a button and we can step
through this there's a bunch of controls
down here about like how do you want to
step through code do you want to just
step over the functions or step into the
functions or step out of the functions
and that should be like are most of you
on c-sharp developers normally say not a
c-sharp developer normally what what are
you alright the same kind of tooling
right so the debugging of step over step
in to step out or should be pretty
familiar all right so like Chrome gives
us all the same things if you do this a
lot you should totally learn the key
commands on how to do it so you're not
always like trying to find this little
toolbar um so we can step through this
and see that the event target did indeed
match the query j/s delete and so now
what we're going to do is we're gonna
call the on delete function so I want to
see what that is let's let's step in to
the on delete function on delete is a
function that does not take any
arguments prints some snarky message and
then destroy some stuff now even though
it doesn't take any arguments I'm pretty
sure where we were before we were
passing something into it so because
we're broke inside of a function we can
use with a console to the live evaluate
inside of it and so I want to see what
what the value of arguments is right now
arguments is a magic parameter that
happens inside of JavaScript that we can
see how was a function called even if
those parameters were not declared so
the arguments that we got is we actually
got an event and that event is the click
event that originated this thing so but
we're getting this click event
not doing anything with it we're just
you know ignoring it and then we're
trying to destroy and remove out all of
the stuff having to do with it if we
recall I think if we bounce back here
the back tin the elements the button
that we're clicking is inside of a form
and when you click a button inside of a
forum what what normally happens Assam
it bubbles up so we're submitting a form
and that's what's causing like a page
reload so I think we need to like make a
few tweaks in our code so you know stop
that submit from handling and let our
code execute normally and so I don't
want to I don't want to I have a bunch
of context going on right here about
about how I'm fixing this bug and so I
don't want to punch out into a different
IDE I want to just fix my code right
here and so chrome lets us do this with
workspaces so I can take chrome and
attach it to the live files on my
computer and make modifications and so
from the sources that I'm interacting
with I just want to add a local folder
to my workspace I keep all of my stuff
inside of let's see projects the
original name of get Rancher was
soliloquy too so we're going to or just
mean to attach it right there and I want
to UM let's see now we see oh I have to
give access to Chrome so it can access
my hard drive because Chrome by default
doesn't want to talk to your hard drive
and now I should see that I have a
folder here in my sources tab even
though this folder doesn't isn't served
directly by the website chrome can link
it up and I can see it as a set of
sources and now I actually want to link
these two together so there's a two-step
process here first you have to like add
the folder to your workspace and then
what I want to do is I want to map this
file this rant ListView that was served
from my server
I want to map it to a local file
resource and by doing it it'll
automatically try and match it up by
name and so it found a file called rant
ListView in
project soliloquy to source public
scripts etc and so I want to go ahead
and add that and then I'm just gonna do
a quick test here to see if I'm to see
if this worked so I should just be able
to live edit this file now and I want to
do like some old-school just I mean how
do you test that changes work I'm just
gonna add a like block alert right in
there and hit save let's uh reload the
page oh there we go
hey NDC off and running
projectors kind of wake it up guys
alright so we're gonna keep going and
ignored that that's happening for now
alright so we can make live changes to
this file so we were able to save save
the rant ListView so now what I want to
do is let's let's define the parameters
that this thing is getting passed with
so on delete gets an event passed into
it and in order to prevent this click
from bubbling out and becoming a submit
we need to prevent its default behavior
and so that's just a standard function
on top of JavaScript events so event dot
prevents default so that right there
should stop the behavior of a form
submit and stop the reloading of the
page let's let's confirm that that's
happening this seems to be getting worse
as we progress so anything we can do
about that no all right we're just keep
going and ignore it all right so now
let's give this thing a try
so we hit delete I'm just gonna stop the
breakpoint for now and just let it go
see if we fixed it and we did not fix it
but it's not reloading the page anymore
now it's just puking out an error type
air cannot read property destroy of
undefined but now we can go in and we
can start debugging the next step of
this so here right in the console it
printed out an error message and from
that error message we can we can explore
and see what this is so it says that
cannot read property to destroy of
undefined a Trant list view line 35 it
was some anonymous function
called by set timeout which was called
by on delete so we can navigate right
here from the console and we'll punch
back into the sources tab in chrome very
nicely even highlighted the line that
broke it's saying hey I tried to call
this thing and it wasn't there cannot
read property destroy of undefined means
this was under means that model was
undefined at the time this thing
executed does anybody know why that
might be yeah because this is not what
you think it is the trick here is that I
use the keyword this inside of a
callback function which is one of the
most common JavaScript errors that just
about everybody in the world still makes
right so because we've passed a callback
function in when that function is called
the value of this the context of that
function is not really what we expected
it to be this code obviously expected
this to be the object that on delete is
operating on but it's not it's probably
like it's probably window or it's null
or it's some some global object that is
definitely not what we expected it to be
so let's fix that there's a couple of
different ways we could do it but you
know you know this is this is 2017 now
we can use some new cool JavaScript key
things so what I want to use is I want
to bind what the value of this should be
when the function executes and so to do
that what I'm able to do is functions
have a have a function that you can call
on them called bind which permanently
glues together what you want the context
to be when that function executes and so
I want to bind the value of this on the
inner function so the value of this on
the outer function
I want to guarantee that this callback
function uses the same value of this
that I have on the outside and so by
gluing those two things together and I
can just hit save because everything is
attached together in a workspace I
should be able to give this page a
reload and let's see if we can get rid
of that pesky
Chrisman John Lewis rant now oh there
you go I told you you'd regret it but
does anybody listen to me no I'm just a
hyper-intelligent JavaScript computer
suite we fixed the bug now we can go
through and delete a whole bunch of
statements that he might regret later so
here was our bug number one we talked
about the Dom inspector we talked about
the JavaScript debugger we fixed this
thing by adding two different kinds of
things we first we had to prevent the
forms or we had to prevent the click
event from triggering a form submit and
we had to bind the contact so that we
had the correct value of this let's not
stop there let's keep going we got
another bug the rant text somebody goes
and starts typing a bunch of text in the
rant and we have some cool functionality
that like if your page accidentally
reloads will remember what you were
ranting about so you can reload it next
time but the problem is like somebody
gets all paranoid about what the writing
and deletes the whole thing but we still
remember it it's still there so I think
to fix this one we're going to need to
take a look at the application Explorer
and because just about everything
requires it will be in the JavaScript
debugger again so let's kill this bug so
let's reload here let's make sure we're
clean so the problem that was described
is that I should be able to write a
bunch of stuff and if I go ahead and
just reload the page it's it's still
there like it's being remembered and and
how we're able to do this is we're
saving these values in storage so we can
take a look at some of the other chrome
functionality here which is the
application capability the application
capability lets you look at all of the
different things your web browser the
web page is storing on your local
machine so things like local storage
session storage cookies and the end the
index DB so um get Rancher just uses
local storage so we're gonna take a look
and there's just a key right here called
next rant
we're we're just arbitrarily storing the
text and you can even see as we type you
can see the value changing inside of
next R and if we wanted to you can even
interact with with local storage and
change the value on the fly of course I
don't expect that behavior in my in get
ranter but if we were to reload the page
we would see that I did a keystroke if
we're going to now reload the page you
would see that the value from
application is now pulled in but so the
problem of this bug that we're facing is
that if we type some some stuff that we
might regret later this is all this is
all saved in storage and so like if I
decide you know what I do not want to
post that and I just zero it out if I
reload the page now it's still there it
comes back it's like I can't get rid of
it every time I delete it it just come
it just keeps coming back and so let's
take a look at again how is this how is
this happening
so we can take a look at this particular
text area which is where we're pulling
stuff up and take a look at the
listeners again about who is who is
interacting with this so the event
listener is attached here is we have a
submit and we have a key up key up
sounds pretty good now key up somebody
is listening to it but somebody's
listening to it with with lodash and
unfortunately the framework listeners
doesn't know how to like navigate
through lodash which is not so cool so
instead let's just take a look and see
if we can figure out who is who is
interacting or who is finding who's
using the key up statement so if we go
back over to sources and we use the
chrome search functionality we can
actually just search through all of the
sources and see if we can find something
we're looking for so I'm going to search
for the string key up and see if I can
find some stuff
and I find one right away here in ad
rant view looks like we're attaching
some sort of events to the key up on
text area so the key up on text area is
gonna call a function called
on change so on change takes an event
and that events we look to see you know
what's the target of that event which
based on how we declared it should be
the text area hypothetically right and
so the text area should have a value or
it might be garbage in what's case we
get nothing and so if we pull some text
out if there's text in there we set the
item in local storage so it seems like
it should function correctly
let's thought let's maybe put some
breakpoints in there and see if we can
figure out what's going on so we'll
attach there on 16 and then type some
more characters and we see we caught the
event the event comes in and chroma lets
us just mouse over different elements
and we can just see the values in line
it also prints these fancy things like
right here next to things so you can
quickly examine what the values of
different variables are but so if we
mouse over here the target the target
does look like a text area and if we
even go out if we step to the next level
we can see that the text is the contents
of that text area and so we're passing
it into an if condition and we're just
evaluating its true or false eNOS and so
it's a string with text in it so what
should evaluate Shruthi and will it will
set the item so that looks so right so
let's try it in the bug case now so
we're gonna clear it out all right so
now now we're gonna get the text again
and the text is empty string because
it's gone there's like nothing there so
so empty string just thrown into here is
going to
well it falls right out of that if
conditional and it never sets the item
and so the the condition here is an
empty string is false II and even though
that condition is just trying to protect
us from setting bad values where we're
not clearing out the value so let's go
ahead and stop this and see if we can
change it so maybe what should we change
this to well I mean we could probably it
might be a superfluous check so we might
be able to get rid of it entirely or we
might want to check to see if like it's
a string and if it's any string um what
do you think what should we do lengths
if it has a length that's not bad if so
if text or an object because if text
ends up being like undefined I'm pretty
sure undefined length is not a thing but
you know JavaScript is weird so you
never know
doesn't look like it's a thing so texts
or some object length although length
what's length going to be of empty
string it's gonna be 0 and so what's 0
going to be if we drop it into the truth
your faulty operation it's still gonna
be false and we're gonna fall right out
so that's not that's not necessarily
gonna work yeah so what would be like
the type of string oh well maybe we
could just do that so maybe we'll just
do type of text equals equals equals
string so if we get any string off of it
we want to save it even if it's an empty
string but we get some garbage value due
to some weird browser quirk like if it
drops off undefined or drops off null or
drops off 0 or you know browsers do
terrible things sometimes then we don't
want to save it but as long as we get a
string no matter what that string is we
probably want to save that so let's give
that a try and because everything's
wired up we can just save it right out
to the environment and we'll give this
another go
so we put something in there and it
saved let's put our breakpoint back on
there and now we're gonna zero it out
OOP that's not what I wanted
sorry stuff going off so now if we
zeroed out the key up event goes and we
check event event target and we get text
of empty string and the type of text
empty string is string which is
obviously equal to itself and we're able
to set the item of next rant to empty
string and everything continues on its
merry way
so now we're able to zero it out and
it's actually gone so what we took a
look with here was we looked at
application Explorer yeah yes because
the question was if we were to type a
number into the field would it still be
a string yeah so let's actually just
play with that that's a good question so
we put three in there the value of text
isn't three the number it's a string
using the three character so it wouldn't
only become a number if we explicitly
cast it or coerced it into a into a
number type anything that comes off of
the Dom which is probably a string so we
looked at here as we looked at the
application Explorer we looked at the
JavaScript debugger and we fixed this
thing with false e an empty string so
let's take a look another one so the
server is reporting a lot of 400
requests so might Michael my server-side
team is complaining a lot they're
getting a lot of 400 requests so let's
take a look at the network inspector and
the JavaScript debugger to see if we can
we can recreate this let's get rid of
that breakpoint and keep on rockin all
right so we're gonna pop open the
network tab now the network tab lets us
see all of the different requests that
our page is making in order to construct
itself now it's got a lot of things we
can do we we can see a timeline of all
the things that are happening as part of
load we could filter this down to say
hey I only care about image requests
right now or I only care about Ajax
requests right now
but so if I just take a look through
this on a normal load I'm not really
seeing any 400s that would be like an
error response and I would expect to see
it in red but I don't really see
anything so maybe let's try just
interacting with the app a little bit
see if we can create them so I added a
rant that's Donald and nothing really
happened
maybe we delete one you know that Menten
really change it either well what
happens we just clicked on rant there we
go so we just click on the rant button
by itself kind of just blows up so here
we can see all of these these 400
requests right here in the network tab
and we can explore them we can see that
the status code that their servers
returning is this 400 we can actually
see a whole bunch of information about
it and will you go in and we can see
what is the piece of code that is
triggering this we could even see the
stack trace going all the way back to
say what exactly is making this Ajax
call right now let's just take a look at
the request itself so here we have a
request going out - we're making a post
- API slash rants it's coming back with
a 400 and we can take a look at even the
response code and the server is even
telling us kind of what's wrong so my
server team did a pretty good job of
actually giving error responses and said
hey we're not gonna let you post
anything where the text is empty so if
they're not gonna let me post it I
should probably like prevent myself from
doing it so let's go back to just the
listing and I want to look at the code
that's causing causing this request to
be made so by mousing over this I'm able
to bring up this history and so there's
some there's some junk that like I don't
care about like I didn't write jQuery
it's not my e I didn't write that jQuery
it's not me I know right lo - there we
go there's one of mine ad rant view ad
rant view so I there's something with
the framework that I'm using must be
triggering this Ajax event because the
only call that I'm making is this doc
collect
creates so I'm I'm adding a rant to a
collection and it's got some text in it
but I'm not doing anything with I'm not
validating it so if I just put a
breakpoint here and hit rant the
collection I'm trying to create a value
from text of rant or a formed rant value
which is empty string so I really just
need to put some safety checks around
this like I shouldn't send an invalid
value to the server so we can just jump
in here and and make that modification
maybe so maybe we'll say if if formed
our rant value now in this case we could
probably get away with a falsie value
because really the thing we we want to
prevent is an empty string from being
sent so if there is no value there then
maybe we just want a return let's just
have like an opt-out in fact maybe we
should put that maybe it even up here
before we print out some snarky messages
so let's put like a defensive statement
in there this form dot rant value and
we'll punch out and I hit save and it
reloads this function so now we're going
to come in and we prevent the default
behavior I stepped into instead of over
so now we have the form and we can check
if formed rant dot value which should be
a falsie value and we bounced out to the
return and we leave so let's check to
make sure that that prevented the
network hall from being made so if we
reload the page clear this out hit rant
not seeing any new requests being made
so that should I should calm down those
server guys so we used the network
inspector to look at who was making
requests and troubleshoot back to the
original code that was causing it and
then we use the JavaScript debugger to
fix it and the root cause of this is
that we are sending data up to the
server that it didn't really expect
didn't conform to its expectations and
so we just needed to use the client-side
to like make sure that we stopped
ourselves from submitting invalid data
all right bug number four we have some
unexpectedly high memory use so there's
not I mean get ranters
obviously one of the most epic and
prolific apps of our generation but in
terms of code it's not all that complex
so we shouldn't be using gigabytes of
memory for what we're doing but we're
hearing things about like slowing down
our users machines and using you know
multiple like multiple gigs of memory
inside of chrome tabs and so that's kind
of sounds like a memory leak so let's
see if we can find a memory leak inside
of get ranter and so to do that we're
gonna look at a couple of different
things we're gonna look at at the
profiler we're gonna look at the
timeline and we're gonna obviously look
at the JavaScript debugger to see if we
can fix it if we can find one so let's
kill this bug all right so we're gonna
reload the page make sure we're we're in
a clean state so the first thing we're
going to do is let's prove to see if
there is a memory leak kind of proving
whether it's a memory leak is easier in
one tool versus finding a memory leak is
easier in another tool so let's prove it
first so first I'm going to go to the
audits tab no I'm not I'm going to go to
the profiles tab the profiles tab lets
you take different kind of profiles of
JavaScript utilization during the page
life cycle that is interesting to tell
you different kinds of things and it
even like gives you a little snippet of
information about each one about what
each one is good for and so the one that
we want to use right now is the record
the allocation
on timeline what this lets us do is it
it lets us record when is memory
allocated for JavaScript and when is it
freed so if we just turn that on and
let's just record the usage for a little
while let's see if if anything is
happening over the lifetime of the page
we although we got a little spike of
something let's watch it maybe a little
bit longer oh there it goes again
let's just give that a stop and won't
kind of go through it
so there's a lot that's going on on this
page and a lot of it's really detailed
and you don't really need to care what's
interesting is you look at the chart on
the top and you just kind of zoom in on
the parts that like show up as
interesting like the parts that are just
a great big flat line or not all that
interesting but these parts are kind of
interesting so you can just drag a
selection around it and say alright what
was that what was going on and what's
telling us is that during this
particular time period memory
utilization increased by eight eighty
two point nine K just a lot but it's a
little bit and it seems to be happening
every 10 seconds or so we can look and
see what were the UM see let's get rid
of that slide this over
so we can look and see it this and why
isn't that going over there we go poof
where I was losing my mind
so here during this time frame it shows
us all of the different actual things
that are consuming that memory and it's
not really interesting to go through and
like explore all these a lot of these
are very low-level things basically
anything in parentheses here is like a
low-level object that you're probably
not going to be able to like
reverse-engineer and figure out what it
is but the other stuff might be
interesting so like let's take a look at
what are some of these objects so some
of these objects here are consuming a
fair bit of the memory it's it's a big
part of the retained size that were
we're seeing and so these objects I
don't really know what they are but they
have this thing called an advertiser ID
and they have an image URL and they have
a target URL I kind of maybe that's has
something to do with advertising so I
feel like there is a memory leak here
like we are seeing an increase in memory
over the youth over the time period of
the page so over the time period that we
recorded this we're seeing an increase
of about 100k and so if we had people
who are using Rancher for like hours or
days this could actually start adding up
to like real amounts of memory here so
in order to figure out where these leaks
are coming from we have it I have an
idea that it has something to do with
advertising but to get a better idea I
want to use the time line now the time
line allows us to get a very low a
little bit higher level view than the
profiles but a view into what javascript
is executing and what the browser is
doing at each given point and so in
order to find these kind of problems
what I want to look at is I want to look
at the JavaScript and I want to look at
the memory utilization over time and so
I'm going to just turn this on and we're
gonna capture we're gonna capture some
of the timeline or the same kind of
maybe 10 15 second period so there we go
we got a little bit of data 15 all right
let's take a look at what we got
there's again a lot of information on
the screen and you don't have to join us
at all at once think of it as a drill
down the top shows us this general
timeline measured in milliseconds over
the period that we captured and it's got
some high-level statistics about what
was happening so we can see in blue the
JavaScript heap allocation over this
time frame we can see in gold the number
of event listeners attached and we can
see in green the number of HTML nodes
that exist at this time and using this
we can kind of drill in on where are
things changing because that's the point
where memory leaks can happen is where
our change is happening that might not
be getting cleaned up and so we can just
go ahead and zoom in on this so I want
to look at this period right here this
period right here we're creating a lot
of nodes we're creating a lot of
listeners and the memory utilization is
ticking up and it looks like it gets
cleaned up but the heap already proved
that like over time it is ticking up so
the fact that we have a Down increase
decrease here is kind of a red herring
but so as we look at this area the area
below starts showing up each individual
thing and we can just keep zooming in on
this area so it even supports key
commands so if anybody's like a video
gamer like WASD is your classic
navigation here so like just like a
first-person shooter you just kind of
like zoom in on the area where like more
and more interesting things are
happening and as you get closer you
actually start seeing that we're like
measuring in milliseconds at this point
but here's where we're actually seeing
what JavaScript functions are doing and
what are the impact of those JavaScript
functions on the behavior of the page so
you see that the JavaScript functions
that are yellow are involved in creating
listeners the JavaScript functions that
are blue are involved in increasing the
JavaScript heap size and both of those
things are big factors in terms of the
overall memory the memory of the system
is both in terms of JavaScript heap of
what variables are kept but also the
size of the Dom
the amount of JavaScript nodes that
exist and so we can look through here
and scroll down and see all the
different things that are happening and
the darker the color the more prevalent
it is so we see a couple of like really
dark anonymous functions here maybe
we'll take a look at one of those here
if we go even farther down into the
summary we see anonymous it unknown
that's not very interesting prepend rent
ok so here we see a whole bunch of
different things happening we see a
render function which is creating nodes
some a bunch of anonymous functions that
are increasing JavaScript heap some more
render functions that are creating nodes
and ultimately some gold things creating
listeners so let's look at the routes
kind of the problem which is the
creation of nodes we see a render
function here which if we keep digging
down through the data eventually we get
to a summary which points us directly at
the line of code that is being executed
that represents that bar in the graph so
if we take a look here here's here's the
function in question we're seeing a file
called add ListView and so the add
ListView looks like it's going through a
collection of ads and for each one it's
trying to render that ad so then we when
we highlight this it points us at the
function below so we see a render ad and
an ad is creating a new ad view and then
it's rendering that so an ad view looks
like it's right up here ad view add view
renders itself and we write here right
here we see something interesting here
after we've rendered it we look for
anchor tags and we attach a click
handler to those anchor tags now that
click Handler creates a pointer to the
dom
and so every 10 seconds or so these ads
are changing out and so these ads are
changing out and but they still have
click handlers pointing at them which
means even though we're throwing away
the ads that bits of Dom those bits of
markup are still floating around in the
page
Putin is just all over this page
floating around in cyberspace just
waiting for somebody to click on him but
he's not visible anymore but that's
what's consuming all the memory now in
order to fix this I think we would have
to work with our advertiser a little bit
because because they probably want to
know more about their click analytics
but this is a pointer to what we need to
do is we need to find a way to detach
this now it's not a good way to fix this
thing and we're running short of time so
I'm going to move on to the last bug
this bug should be fixed by we need to
be able to detach an event listener when
we're cleaning up the ads but will will
let the interns take care of that one I
think right so this bug we looked at
profiling and we looked at the timeline
and then we you know played around with
the data and the JavaScript bugger
debugger the RIP problem was we weren't
releasing events even though we were
destroying the Dom all right last bug
sometimes pages slow
that's real vague huh sometimes it's
slow so we're going to take a look at
the timeline again but this time we're
gonna focus the timeline on
understanding the performance of our
page and what are the things that are
doing that it's doing that could
potentially be slowing down our our our
load time and what things we could do to
fix it
let's uh just reload this make sure
we're in a good state again probably
just close all you all right so let's
open up the time line and still got our
previous session here but let's just get
rid of that so this time because I'm
interested in performance I want to know
about a whole bunch of things so let's
just let's go ahead and I want to know
about the network
I don't really so much care about the
JavaScript profile anymore because
that's not really a key part of the
performance I don't think here but I
want to see some screenshots I don't
really care about memory but I care
about the paint time so I kind of just
inverted this I want to know about how
long do we take on the network what does
the page look like over the course of
its operation and what are the different
times it takes to paint my page now this
we're interested in what's happening on
load so if these things turned on any
time I just reload the page the timeline
will just start recording automatically
so I'm gonna just reload the page and it
should record here for a few seconds and
we get a breakdown of exactly how the
page loaded now I render most of my
stuff here off of localhost so stuff is
really really snappy for me but we can
extrapolate out this data as though
somebody else somebody on a much slower
connection might be experiencing it in
fact we can even simulate that if we
backtrack over to the network tab chrome
allows us to pretend to be slow so let's
pretend to be slow let's pretend that we
are on a good 2g connection it should be
like pretty slow at this point does
anybody still use 2g here only when
you're on the trains right so let's turn
that on and let's maybe give this a try
again
now this isn't foolproof because it is
simulated but it should give us like
some idea of how much slower things take
I mean and it definitely was slower when
we did that so we have a little bit
better idea of how our customers might
interact so over over time here we can
see like at each time slot here's how
get ranter renders to the user you know
what let's do this one more time let's
let's scroll this over so that
get rancher actually shows well I
probably should have spent a little bit
more tonight we probably have a little
bit of work to do on a responsive design
you know but right now Trump you know
he's mainly a desktop kind of guy
so has it hasn't been a top priority for
us just yet well it is kind of slow huh
all right so let's now take a look at
our timeline so we can see here at each
given phase what did the page look like
at this stage of its load and so we see
we get the header come in at about you
know a thousand milliseconds and it
stays that way we don't really get
anything else until about five seconds
in and then the left side starts drawing
out we start knowing about that and then
we get the timeline that fills in and
then at about you know six seconds or so
we start getting pictures ads are still
haven't loaded yet you know ad networks
are awesome and fast all the time right
but by the time we get to the end of our
timeline we still don't have our ads
loading here and so we can we can kind
of breakdown that there's a couple of
different phases of load time here so in
the next section down we can actually
see what was the page doing during each
section of time so let's zoom in again
and get a smaller sample so at the very
beginning we start loading localhost
there's not a lot we could really do to
improve that we have to load you know
the original page maybe you could put
yourself on a CDN and do like some edge
Network stuff but that's a really hard
infrastructure thing that I'm going to
leave for like when we need to hit web
scale with this sort of stuff then we
have to load a whole bunch of stuff so
we're reaching out and talking to fonts
Google api's com that's that's kind of
harsh vostok Google API this isn't
always the fastest thing in the world
maybe we could pull that locally and
then and then we have some CSS files
that aren't aren't so good takes like
400 milliseconds and we have all these
different pieces of JavaScript that are
coming down
that's probably not so good either we
could probably improve this quite a bit
by like taking all those JavaScript and
like smashing them together you know
doing some concatenation some build time
processes to do that you just has at the
top of our priorities we can't ranch or
just yet but we're spending a lot of
time here just loading just loading
JavaScript on the page you know the app
isn't really very functional until
javascript is on the page so maybe we
should like think about our architecture
a little bit and see if we can you know
shove down the initial timeline maybe on
first load so that the user has like
something to do or if that's too hard at
least maybe a little loading spinner a
little Trump gift like spinning around
in circles or something like that that
might be a little helpful so then we a
little bit further down we see that
we're pulling down another file from
Google this fancy static and this takes
one point three eight seconds so this is
fairly slow to pull down the sponsor but
it's still it's like blocking the page
like we write we haven't rendered yet so
maybe we could make this asynchronous I
mean this is a design choice fonts are
often quite large but if you wait until
after page loads you have that annoying
flip where like you see the fonts change
from one font to another I imagine
you've seen this on some web pages
that's the performance decision that you
have to make like do you want to slow
down the whole page so that the user
sees the font you want or do you want to
get the content out fast and you can
flip the font later when you have time
let's keep going through and see what
else is going on so at this point we
still haven't haven't rendered anything
we're still loading JavaScript jQuery is
still coming down jQuery is huge
maybe we shouldn't use jQuery do we have
to support ie8 so now we're making some
Ajax requests we're pulling down some
ads we're pulling down some users from
pulling down the rants and those are
probably things we have to do but again
we could make some choices about maybe
we should inject those things onto the
first load so that we don't have the
back-and-forth of pulling down a page
and then making an ajax and then pulling
more data and then rendering some stuff
and then pulling more data maybe we
should just figure that all out
server-side and ship one finished page
on the initial low
so then we pull a bunch of images and
these images I mean it says the impact
is fairly small but we're spending a lot
of time there there's some things we
could probably do there around running
blurry images or a two-phase image
approach Facebook does a lot of that and
we should copy Facebook so that's the
general behavior that we're seeing here
so there's a couple of different things
we can do we can decrease the size of
our images we could bundle some of our
data on initial page load so that the
user experience is faster initially we
should consider maybe getting rid of
these big JavaScript libraries that are
taking a long time to download and we
should definitely bundle all this
javascript together so that there's
fewer things that come down all of those
things together could make this page a
lot faster fortunately these are all
probably conference talks onto
themselves
hopefully somebody else is talking about
I know I've seen NDC videos a good
friend of mine Nick molnÃ¡r have recorded
one a nozzle about six months ago on web
performance talk to all about all of
these things so what we did today is we
looked at the timeline to see how what
are the things that are blocking page
load and the couple of things that we
can do is we can look at how do we solid
eight fonts how do we get rid of big
page libraries and how do we compress
our assets down and so these are these
are some good things that you need to
think about if you're building
large-scale web applications that need
to be delivered quickly so here's all
the things we talked about I'm running
about 55 minutes so we should be good we
looked at the Dom inspector and how to
look at an element and see what are the
JavaScript things that are listening to
that element and how to navigate
starting from there which can be really
helpful when your user tells you a bug
involving the visual elements versus the
code this is how you enter the code from
the visual representation the JavaScript
debugger itself stepping through code
looking at the local variables
understanding its context the
application Explorer lets us go in and
see what are the pieces of data that are
actually stored in the browser the
timeline lets us do a couple of
different things that lets us diagnose
memory leaks to figure out where things
are coming from but also helps us
understand general perform
and so it's one of the most valuable
pieces of chrome dev tools and it's one
of the least understood and finally the
profiler helps us prove whether or not
memory leaks exists for other scenarios
it also lets us do things like
understanding CPU utilization if you
have a high processing JavaScript app
when I'm not doing this I work on track
J S which helps you understand when your
users are running in bugs in production
if you'd like to check us out we have a
booth out there and we do all kinds of
cool things about giving you like really
detailed error reports and understanding
when things fail and if you'd like to
give that a try we're out at track J's
calm
this was squashing JavaScript bugs I
hope it was fun I hope you learned
something I have a bunch of squashed
JavaScript stickers feel free to take
one and give me a green card thank you
very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>