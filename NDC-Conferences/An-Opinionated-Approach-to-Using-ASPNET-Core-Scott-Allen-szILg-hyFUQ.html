<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>An Opinionated Approach to Using ASP.NET Core - Scott Allen | Coder Coacher - Coaching Coders</title><meta content="An Opinionated Approach to Using ASP.NET Core - Scott Allen - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>An Opinionated Approach to Using ASP.NET Core - Scott Allen</b></h2><h5 class="post__date">2017-05-10</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/szILg-hyFUQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thank you it's good to be here in
Copenhagen at the first NDC Copenhagen
this is always a great conference so I
hope that continues to grow so my name
is Scott Allen I've been working with
asp.net core for at least 12 months and
currently four months into a project
that's going to be in production
hopefully in a couple months and at the
end of 2016 2016 is what I call the good
old days now at the end of 2016 I was
trying to put together a document that
listed some opinions on how I wanted a
particular project to be worked on and I
came up with the list of 56 things and
then I thought well if I just remove a
few items and get to an even 50 that
might make a nice conference talk where
I could share all these opinions that I
formed over the last year on asp.net
core and that's what I have to present
to you today so I do assume that you
know a little bit about asp.net core
already I'm not going to go into the
fundamentals and just basically going to
come talk about some ideas and opinions
and best practices for what I believe
are the best way to structure your
solutions and your projects how to lay
things out on the file system how to
structure your startup code how to
implement controllers with the MVC
framework how to apply client code and
use client code frameworks like angular
and react and whatever else you want to
do in JavaScript or typescript some tips
for the c-sharp code that you write for
dotnet core some tips for views and
writing unit tests or I take that back
writing test let's just say so we'll
start off with what you would start from
day one which is how do i structure my
solutions and my projects and lay out my
file system and if you go out excuse me
and you look at how microsoft structures
all of your open-source projects that
revolve around dotnet core and asp.net
core they all follow a rather consistent
convention which i think is quite useful
which is if you look at the top level of
any github repository that Microsoft has
there's always a top-level source folder
SRC there's always a top-level test
folder there's always a solution file in
the root of the github repository so as
soon as you
you know where to go and click on
something to open it if you're using
Visual Studio and it's a nice pattern to
follow I think for our own business
applications to follow also because it
just is making sense and it's a
convention here in this new world of
dotnet core and in addition to source
and test folders which are always there
I usually always include a couple other
folders in my business applications like
a Doc's folder which might contain some
markdown files or HTML files or Word
documents whatever you're using to
implement coding guidelines and
architectural decisions a place where
when the team gets together and makes a
decision on how to implement something
or a direction to go we can at least
record that and keep it in the project
and keep it under version control so you
can see how things evolve over time I
also typically keep samples in setup
level samples folder so if you're
writing an application it might not make
sense to have a sample folder but if
you're writing something that will build
into a new get package that you're going
to share with other members of the
company or publishes an open source
project it's nice to have that top-level
sample folder where people can clone the
repository and open a working project
inside of there to see how to make use
of whatever you put together something
else and it's Microsoft follow this
example also so actually a lot of what I
learned about some of the asp.net core
security features I learned by going
into the security repository and going
into the samples folder and looking at
some of the low-level samples that they
provide and actually I've been saying
for the last year that one of the great
things about Microsoft open-sourcing net
core and asp.net core and all these
tools and technologies it's not that we
have the source code we've always been
able to get the source code somehow with
the D compiler what have you the great
thing about this is we have access to
little samples that they write to test
out ideas or to document things we have
access to the unit tests which actually
describe how things are supposed to work
at a low level and describe not just how
things are supposed to work but how
they're not supposed to work or things
that are supposed to fail so I've gotten
a lot of information by going through
the github repositories and looking at
tasks and looking at samples
and I think there's a good patterns to
follow in our own projects something
else I will keep around in my project is
I typically have development a script
folder with development scripts so these
days you might be using Visual Studio
code you might be using Visual Studio or
sublime or whatever but chances are
you're working with the command line
somehow somewhere either because you're
running net or because you're running
web path or some npm tool or you're
using dotnet anyone to implement
database migrations what I'll do is
create some bash scripts or command
files in a script folder that developers
can run to do common things with the
command line for this particular project
so for example in the early days of a
project when you're still trying to
prototype things and figure out your
design and you're using a database
perhaps with the entity framework
chances are you're creating a lot of
migrations you're applying there's
migrations you're trying to drop and
recreate the database so I'll have
scripts from the scripts folders so that
developers can just say add migration
foo and that will create a new migration
based on the current state of the code
automatically applied to the database
and there's nothing else they have to do
they don't have to remember to run a TF
update database and then or and before
that dotnet EF migrations add and one of
those scripts might look like this go
over to the data project add a migration
to it update the database and then put
me back to the folder where I was
push T and pop T I also like to add
deployment scripts so there's lots of
techniques that you can use to deploy
asp.net core applications there's lots
of environments where you can deploy
asp.net core you can put it into local
you can put it into IAF you can put it
an azure you might be behind engines on
a Linux system wherever your produce
wherever you're publishing your code for
staging for for QA for production I like
to have some scripts that will automate
that and actually have them in source
control so that developers can run them
and debug them and we can see how they
change and so this is just a screenshot
might be hard to see but it's a
this is inside of a resource group that
was set up for a sure that will set up
the app service for the asp.net core
application and set up the sequel server
and the document DD and all of those
things that are needed for a single
deployment and then after you can go and
produce an automation script that will
give you a JSON file and a PowerShell
file as well as c-sharp code and Ruby
code whatever you want over here that
will recreate that environment using
some parameters to change names so I
like to go into Azure if they give me an
automation script and then check that in
the source control also under a
deployment folder so that I have all of
that available for me and of course
there's lots of other tools that you can
use to do this across Amazon and so
forth terraform being just one example
making sense
there's also build scripts so I like to
have a proper build script in the source
control as part of the project and this
all depends on what your build
environment is so there's a couple
projects that I have that will go out
and use a player anyone use out there
it's one of those services that will set
up behind the scenes of virtual machine
for you and spin it up and build your
source code and throw everything away
but they allow you to go into the app
thayer website say I have this project
that's hosted on github please pull the
latest code whenever there's a check-in
and at the air will do a build and you
can configure the whole thing in the UI
that's one way to do it but that UI will
also let you export the yamo file and
put that check that yamo file into your
github repository in the root and if a
player sees an app they mo file in the
repository it will use the instructions
in that file and this just goes back to
the principle that I believe anything
that you can get under source control
you should put under source control so I
don't want to leave my bill definition
in the UI of a payer somewhere I would
rather export it as a gamma file check
it into source control and now I have
much better feeling for what's actually
happening behind the scenes much
changing over time and even though
developers can't necessarily use this
gamma file to do a local build to
troubleshoot things
it feels better to have this under
source control but and what we can do is
when we actually do the build and up
there we can have a powershell script
that we check into source control that a
player uses that will do things like
okay for this project do it net restore
do a dotnet build go into the test
folder and do execute the unit test net
tab and then do a dotnet pack which will
package everything up into a new get
package so that's something I can run
locally and I can also give to a player
to run on the dome server and that way I
have a consistent build environment this
also goes for visual studio what do they
call it now visual studio team services
in the cloud visual studio team services
online they allow you to set up a build
process graphically by adding these
build steps that'll do net restore net
build and so forth and there was one
project one project I'm currently
working on where we have started down
this path of creating build definitions
this way and that was fine for the first
few weeks of the project but as soon as
things started getting more complicated
I wanted to rip all of this out and just
include there's a PowerShell script
tasks that you can drop in as a build
step that basically says run this
PowerShell script and then so I want all
of the build things to happen like the
dotnet restore in the dotnet build I
want all that to happen from PowerShell
so I can run it locally and I can debug
it and I can make changes and I can
check it in source control and I can see
what changes over time and why something
might have broken today if someone
changed something and there's all sorts
of tasks in the STS on line including a
PowerShell and command line tasks or
bash tasks that you can just write your
end script to do your build cake and
peace sake are also available in Visual
Studio online familiar with there's
tools for building some people believe
that you should create as many projects
as possible in a solution there's a lot
of people when they sit down to design
an application they want to break things
up to be very small and granular and say
that okay these classes they're part of
this domain and they should never be
accessible from the
other part of the application whether
it's data access project or what have
you but I've always been frustrated by
the solutions that I open up that have
50 or 60 projects inside of them to me
creating a project in Visual Studio or
wherever whatever whatever tool you're
using is more a function of how a
particular piece of code should be
deployed so the current project I'm on
now we're going to build two different
web applications one is for external
customers one is for internal people at
the company to use to manage the
application since those are two
different deployments that to me that's
an easy choice to make two different
projects there's another project that
has to be deployed as a Windows service
so that's a third project there's a
project that has to be deployed as a web
job and Azure so that's a fourth project
but all those projects we decided on
because they were deployment units and
then when it comes to other pieces of
infrastructure things like data access
code and so forth I don't have a problem
with let's say business logic and some
data access code inside of the same
project and that freaks a lot of people
out and they say how do you get a
separation of concerns and I say as long
as you have a good development team that
understands what they're doing it's not
a problem
to have all that code mixed into the
same project it's just it's how you use
those different abstractions that you're
building startup code so asp.net core we
know there's a static main entry point
we were basically writing a console mode
application at this point and the web
host builder that you use inside of
program dot C s will call into a startup
code so how do we want to organize our
startup CS file that's the typical name
for the startup file to me that file has
three responsibilities and three
responsibilities only one responsibility
is to set up the configuration sources
for your application and I believe that
should happen inside of the constructor
of that startup class before anything
else gets going because when you tell
asp.net core that this is my startup
file the first thing it will do this
instantiate that class then it's those
invokes configure services then it
invokes the configure method so
start up the constructor to me that's
about setting up the configuration
sources configure services that is about
configuring the inversion of control
container that asp.net core uses behind
the scenes so what components am i using
what are their lifetimes how are they
scoped are they scoped to an HTTP
transaction or they Singleton's and so
forth and then configure the method that
takes the I application builder that's
all about configuring the HTTP
processing pipeline what middleware do I
want in my application to process
messages so the constructor typically
looks something like this
use the configuration builder add some
JSON files add some environment
variables add some command line
arguments whatever you want I want to
set up that configuration inside of the
constructor can also so a lot of the
Microsoft templates when you do like
file new project in Visual Studio
they configure the logging inside of the
configure method which to me is
irritating to me the configure method is
only about configuring the middleware
configuring that HTTP processing
pipeline so I like to rip that code out
of there any logger configuration I
either want it in the startup
constructor or you can actually take
this bit of code and put it into the
static main entry point in program dot C
F because at that point dotnet core has
already created an ilogger factory
instance and will be available to pass
that into your main method so you can
actually get a hold of the logger
factory and start logging right from the
beginning of the application when it
gets spun up you don't have to wait till
startup but leave configure famila where
only the other thing I like to do is
keep it clean so if you look inside of
the typical application inside of
configure services this is where you're
configuring the IFC container
this is where you're configuring things
like the MVC services that are used at
runtime things like the model binder the
controller factory the serializers that
you use all of that stuff if you're
building an application that is creating
custom model binders and adding
additional serializers like an XML
serializer it's really easy to write a
configure services method that has 5060
lines of code in it as you configure all
these different options I like to look
into the startup
ts file and just see a nice clean line
by line description of what's going on
so add a customized version of NBC so
we're going to customize some of the
services add my security features that I
need add mediator which we'll talk about
a little bit later add all my data
stores with entity framework stuff or
document DB style for your repositories
or what have you there so just simple
one-liners inside of configure services
and then the actual implementation of
these methods they're just extension
methods for I service collection so over
in some other file that's where I would
go to actually get the details ok what
does it mean to add a customized MVC
well it just means we're going to add
NBC but changed some of the options so
change some of the view locations and
things like that
for middleware again that configure
method I like to see that be ideally
just a line by line description of what
middleware is installed ok developer
exception page database error page
browser link which people make fun of me
about that that appears there I don't
actually use it but it just happened to
be in the screenshot I think it is ok to
branch in other words have an if
statement inside of your configure
method because I do want to make it very
obvious that ok if I'm in development on
my local machine and the proper
environment variable is set to put
asp.net core into development mode then
I have a slightly different pipeline
than I do in production which is just
using this exception handler which
should produce some sort of friendly air
page instead of dumping a stack trace to
the end user so I think that's ok but
these again should be one-liners and if
you have middleware that takes an
options object and you're setting up a
whole bunch of objects I'd kind of like
to extract that again into an extension
method somewhere for I application
builder where I can say app dot use
something custom and just have all that
complexity pushed somewhere else and
just these simple one-liners inside of
here something I started doing last year
with making use of my web application as
an executable so again asp.net core
you will have a program that Cs your
program that CS will be and that's just
a conventional name but somewhere you'll
have a static void main entry point for
your application so you can almost think
of your application as next cutable it's
something that you can come ask pass
command line arguments to and have it to
work on your behalf
work that doesn't necessarily mean just
listening for HTTP connections because
once you get through all this code with
the web host builder and you reach this
point right here after you've called
build you now have a fully configured
environment that is aware of a lot of
different details so it's aware of
different configuration sources and
configuration files it has the ability
to grab a database connection string it
knows exactly what little where's
configured and how services are
configured how your data access
components or repositories or whatever
you're using how all of that stuff has
been put together and now I want to take
advantage of it sometimes or most of the
time I want the host to run and listen
for HTTP connections and send HTML or
JSON back to people that are using it
but there's some other situations where
it's nice to use that fully configured
environment so for example when you have
questions such as well let me go back
for a second so one of the common
questions that comes up is how do i
automatically iran database migrations
or how do I feed my database where do I
put that code in previous versions of
asp.net we have the global de sÃ¡ xes we
had an application start of an it was
very clear when the application was
starting and we could wedge code into
there to go out and do things like oh
let's check the database see if it has
any data if not we'll push data into it
I like to do that now right from the
entry point of the application I have
this process DD command method where I
can pass in arguments so I can pass in
arguments actually let me show you the
if I open up script file here there are
times when I just want to drop my
database create a new database migrate
it to the latest version feed it with
some data and then stop the application
so it doesn't start listening for HTTP
requests I just wanted to do that work
because
again it has access to all the
configuration and all the services that
are needed to pull that off so these
commands drop DB migrate DB c DB and
stop are all done from this process DB
commands method which and this is very
brute force code but okay if there's a
drop DB will drop the database by
getting a DB context and calling ensure
deleted on it on the database then we
can run migrations we concede it with
some initial data and would I ever do
this in production no but I might do it
against the production database by
logging into a server to a you know one
instance where my application is running
and telling it to do something like this
like migrate the database as part of our
deployment script and some people put
this code like c DB again inside of the
startup class inside of a method like
configure which drives me nuts because
configure is just for middleware so at
least don't put it in that location when
you do this there's one thing to be
aware of and I'm going to flip away from
the slide again and come back to visual
studio just be careful if you are
locating a service outside of an HTTP
request because if you pull out a
service from the service provider like
so dear service provider please get me
this dbcontext typically you configure a
DB context or something that uses the
database to be a have a lifetime of
scoped scoped it to an HTTP transaction
which is perfect but if you pull out a
service outside of a scope definition
you can easily turn this into a
singleton which is very dangerous so so
it's not net core what you do is you ask
for a I service scope factory that will
give me back an object where I can call
create scope that's a disposable object
but anything I create in the scope any
services that I pull out when I dispose
that scope they can all be thrown away
and I don't have to worry about them
screwing up the lifetime their lifetime
definitions
we have to move fast to get through 50
things forging ahead again adding
scripts to make the startup rain which
is easy I already showed you that script
where it can do a dotnet run drop DB
migrate DB c DB style logger
recommendations i really fell in love
with sarah log last year anyone use it
yes so it works with dotnet core it has
a huge number of syncs so you know in my
application i want to be able to log
when i'm in development perhaps just to
a local to the file system to a rolling
log file but then when i push to
production I went to log to a database
or the table storage theory log it's a
logging framework and it has a huge
number of things available so it can go
over WebSockets you can send stuff over
UDP can write to files write to events
tours write to document TV rave and DB
pretty much everything and it's really
cool because you can actually dump out
objects you know structured logging so I
can say processed position in this
number of milliseconds and sira log can
look at this object and write out
latitude 25 longitude 134 it's really
easy to configure into asp.net core you
literally add one nougat package for the
course server log then you'll add a
typically a NuGet package per sync where
you want log events to be stored and you
can either configure it using code or
configure it using JSON but this would
be configuring a logger to be verbose to
write to a rolling file called log -
whatever the data is jason and we're
often running there so this one I was
thinking about last year a lot the IRC
container inside of asp.net core is
quite capable it understands how to set
up lifetimes it understands how to work
with open generics there's all sorts of
things that it can do but of course
we've had all these ifc containers
around in dotnet that are very mature
things like structure structure map and
inject and so forth and a lot of them
like structure mouth still have some
features that are nice that go above and
beyond what asp.net core provides for
example with structure map I can say yes
for every every time you have to create
an eye widget creating
instance of a widget that's a concrete
class but I can also instruct your
amount say things like for every eye
which you create
make sure you decorate that concrete
class with a widget holder so
instantiate that and it will pass in a
widget to be the inner thing inside of
widget holder those sorts of things are
still useful and this is just so you
know if you love structure map or you
need some additional features like that
it's really easy to plug structure map
into asp.net core project structure I'm
a big fan of feature folders
how many people have feature folders oh
good quite a few so feature folders are
I have a really difficult time now
looking at an MVC project and seeing the
typical controllers models and views
folder we all know that controllers can
live anywhere they've always been able
to live in anywhere because I don't have
to put them in the controllers folder
same thing with models these are a
little bit trickier because they do have
to live in the views folder unless I do
some configuration but I like to do away
with all of that so in this application
when I go to work on something I don't
work on a controller or a view I
typically work on a feature so the
manage users feature or the audit
account feature and when I go into my
project I would like to go to that
feature and actually have a bunch of the
abstractions related to that feature in
one place for example the controller the
view the view models that are specific
to that feature so here in this MVC
application there's no controllers
folder there's no views folder all of
those types of things are in a feature
folder so if I want to look at something
that related to accounts or let's say
admin then I even can have a hierarchy
in here where I can say ok this is the
admin section it has a controller in a
view I'm going to go in and manage a
seat and that has a controller and two
views associated with them and just
structure the project more like this
because number one it it's a little bit
easier to scale up in terms of
complexity in asp.net core obviously if
you try to put every controller from
your application in a large application
into the controllers folder
becomes overwhelming that's why we've
had areas in HP net for quite a while
but even areas I get irritated because
there's still controllers using models
I'd much rather have the ability to
organize in a hierarchy that kind of
mimics my user interface or how people
think about the application and it's
it's behaviors and then be able to find
everything I need inside of a single
folder like this the view the view model
commands depending on you know what sort
of Technology you're using commands and
queries and so forth all of that some
one place even actually I like to put so
this particular projects using react if
there's a react component that is
specific to that particular feature I
like to at least have a my type script
or JavaScript file therefore that react
component in the same feature folder so
it sort of gives me the entry point here
for everything now yes and feature
folders are easy I created a new gate
package if you want to use a simple
install package Oh decoded add feature
folders and all you have to do and
configure services to get that same
behaviour to say services that add NEC
that add feature folders and that'll
work you can just have a feature folder
and start putting everything underneath
of it and that includes also just want
to point this out that includes your
shared components shared layout shared
views like the layout view all of that
still works I can have a shared folder
under features things like view
components that'll work and put your
view components if they're used
everywhere under that shared folder
everything just works like you would
expect it's just a different way to
organize things controllers talk about
controller code I'm a big fan of routing
using the route attribute now in fact
I'll I'll try to get away in every MVC
project without using the decorative
template advanced at all just used about
attribute for one thing it's nice
developers will we're all kind of lazy
right so if I have a default route that
says the rad will be controller flash
action slash ID
all of a sudden every parameter to every
controller action that needs an ID is
just an ID right that's the name of the
parameter and then when you look at a
controller where one action might take
this an ID that represents this thing
and an ID that represents another thing
it becomes very confusing so one little
advantage to this always using the route
attribute is I can force people to name
parameters a little bit better so this
is a seasoned ID this is a matched set
ID don't rely on just ID all the time
I'm also a standard mediator anyone
using mediator heard of it just couple
it's like an in-memory service bus so to
me controllers should really just be a
facade in the application they shouldn't
do anything significant to me a
controller is a component that should
receive an HTTP request and the model
bundle the model binder in NBC will work
with that controller to test in some
data to me so I receive an HTTP request
and I have to produce some sort of data
structure that about how to respond to
that request but everything in between
all the data access work all the
authorization checks a lot of that stuff
I want to be able to push out into other
components in the application so the
controller's still stay very small and
one technique I like to use to do that
is to simply so let me back up a second
mediator it is a I don't have a browser
open
open-source project from Jimmy Bogart
author of Auto Napper and various other
famous things it's a really simple new
get install it's a really simple
configuration you just have to add a
couple lines of code to your start up
and now what you have is a component
that you can inject into your
controllers a component that implements
imediator
and you can basically say dear mediator
please handle this thing for me that
thing might be a query it might be a
command you might just think of it as a
request but basically you put together a
data structure with information that
will be needed by the other components
to satisfy this request information like
I went to query and find the user with
this ID the ID of three or I just need
to know what the current season is for
this golf year or football year whatever
you're writing an application about and
send that thing of a mediator mediator
will find the component that is designed
to respond to that particular query or
command execute some code send back your
result which in this case might just be
a simple view model or it might be a
data structure that you send back using
an object result so it's content
negotiated into JSON what have you but
all of the Oliver Oliver logic here goes
behind mediator now I don't have to
inject data access components or
repositories or any of that stuff into
this controller so an implementation of
that might look like this over here this
is the current season summary query
handler that implements an interface
provided by mediator and I async request
handler that basically says I am here to
process a current season summary query
and I will give you back a current
season summary result and then it is
this component this is the magic of
asp.net for dependency injection that's
everywhere where this can take whatever
dependencies it needs on databases on
data access components and it's going to
do whatever it needs to handle that
particular request and implement a
business logic or call the business
components and put everything together
for me
so my controllers become very small very
thin they just delegate work to
something that is hiding behind mediator
throw it this is the hard one if you use
asp.net identity and you say file new
project give me a project that
implements authentication and
authorization using individual user
accounts Visual Studio spits out this
account controller and manage controller
that does have like 500 lines of really
nasty looking code inside of them it's
hard to throw all of that away because
it works and maybe you'll never need to
touch it but if you're going to
customize any of it if you ever have to
touch that code I mean it can be a
couple days of work but I would I would
throw all that stuff away and start over
with it use it use it as a prototype to
write something better and maybe all you
do is this maybe all you do is this is
separate some of the responsibilities so
if you look at the account controller
it's responsible for logging in and user
and logging out the user and registering
a user to me it would be nicer to have a
log off controller and a login
controller and a register controller so
maybe you just start by ripping out to
code and copying and pasting it into
other controllers that make them a
little bit easier to manage if you're
building an API application I've had a
lot of people ask me this for whatever
reason but a lot of people are building
API applications that still rely on
cookies for authentication and anytime
you're building an application that
relies on implicit authentication that
is a scenario where the browser will
implicitly send along some sort of
credentials or some sort of information
about the user that will authenticate
them and that includes like windows
authentication those are situations
where you need to make sure when you
accept an HTTP POST that that was
actually an HTTP POST that you intended
the user intended to send you and it was
came from a form or from a service
endpoint that you gave to the user and
that means using anti forgery tokens so
how do you use anti forgery tokens when
it comes to an API where there's no
forum post with a hidden input that has
the other half of the anti forgery token
well with asp.net core it's really
simple to build a controller where you
inject a service that implements a anti
forgery
and that component the default component
that implements int forgery when you ask
it to get in-store tokens it'll do two
things the first thing that method will
do is issue a set cookie header to the
client which contains the one-half of
the anti forgery token that a browser
would need to send along and the second
thing it will do is return a data
structure that includes a request token
and a header name property the request
the request token is the value for an
API call that you would make from
JavaScript it's the value that you would
put in an HTTP header with that header
name so that you can use that would be
anti forgery token on an API action and
asp.net core will look for that request
token and look for the cookie and make
sure everything matches up and if not
throw an exception that there was a
possible forgery attempt in brain
security policies so one nice thing in
asp.net core that they've done is
they've really embraced claimed now what
they espied on that core so the claim
can be it's really any key value pair
like my name is Scott my email address
is this my role is this and this and
this
so claims or key value pairs and the way
you can take advantage of this is let's
go - well actually any of these
controllers I got user is admin so
there's two ways to express that I would
want only administrators coming into
this controller I could use the
authorized attribute of course that
would just force the user to be
authenticated I probably need something
a little bit more than that
I can also pass in here a policy name
and say authorize based on this policy
and we'll talk about what the policy is
in just a second but I would prefer to
create a custom attribute the canta that
will excuse me I have to slow down a
second finally recovering from jet lag
when I get in front of people I would
prefer to create an attribute that hides
the specific policies that are being
applied into some other code to make
this a little more flexible because
there might be a day when we need to
allow different sorts of administrators
and let's say
where does this attribute come from it
comes from that was the wrong heated
press just started the debugger hate
that I'm starting to press f12 and I've
been missing that key all week so while
Visual Studio is crunching along trying
to start the debugger I'll just point
out that this is going very rapidly but
I'll give you my email address at the
end of the presentation so if you have
any questions about all of the Brambling
that I have done here this morning you
are more than free to email me and ask
me about what's what I was talking about
let's stop the debugger now that it
finally got warmed up and this time I'll
be very careful to press f12 all right
so users admin that's just a derivation
from authorized attribute that's calling
into the base class constructor and
saying the policy to use as the policy
named is admin where does it admin come
from that comes from a policy that I
dolt which you can do using the
authorization policy builder and asp.net
core and I basically say that that
policy just requires a single claim the
is admin key in the list of claims has
to have the value true and you can put
multiple things here so I could require
multiple claims different roles require
a username all sorts of things I can
abstract into a policy and then apply it
through well named attributes throughout
the application yes and if you've ever
wanted to figure out how do I create
something that represents your user
identity with asp.net core because maybe
you have a custom identity system or you
need to read out your own database to
figure out who a user is just be aware
that it's now it's about claims
principles the claims principle has a
claims identity it claims identity has a
series of claims there's some well-known
claims like the email claim and the name
claim type and that's how I can add
planes through a user to establish who
they are and I can add my own custom
to take just a key/value pair is headmen
true favorite color blue whatever claim
you want create custom autopilot
attributes is what I just described to
you I'm going to rapidly advance to that
slide we'll talk about views for a
minute avoid the HTML helpers there's a
new thing in asp.net core called tag
helpers I never ever ever want to write
another HTML helper I always thought
they were the worst feature of NBC tag
helpers are much cleaner you can embrace
and extend them so an example of tag
helpers if you haven't seen them tag
helpers would be like ASP - anti forgery
equals true they're like HTML attributes
but they are processed on the server by
the razor engine so they're not emitted
into the source code ASP - validation -
summary you can get intellisense for
these you can get checks to make sure
you put the right values in here so for
example ASP - 4 that is saying that I
want to label for the name property of
my model and when things are set up
appropriately and it's a sunny day and
everything is working that will turn red
if name is not a property on your model
so you know that you have a typo there
those are the HTML helpers much easier
to use so it's relatively easy to write
them - basically you write a class
derived from tag helper you tell asp.net
cor the razor View engine what your
element or attribute what name it will
have so this would be like my
environment my - environment public
properties that you have on there will
automatically read attributes with that
name from the source code and set values
for you and then you implement a process
method that's where things get a little
bit tricky but there's an API there that
allows you to do anything to the HTML so
you want to suppress the output and not
output anything you can do that you're
going to change attributes add
attributes remove attributes change the
inner HTML whatever you want to do these
components are the new solution in
asp.net core to replace basically HTML
that action which is you are familiar
with that used to set up sort of a sub
request inside of asp.net MVC that would
allow me to from a view set up a sub
request that would call into another
controller that could build its own
model
two could render a partial view that
would get tucked into the larger view
that's kind of what gone away because it
was kind of an ugly hack and it created
some problems in some scenarios we now
have these things and ESP Dinoco are
called view component and I would
encourage you to look at them to do
things like I want to build a main menu
and reuse it across various pieces the
application so let me write something a
main menu view component that derives
from a base view component class this
thing can have services injected
whatever you need data access components
anything you want it has one primary
method called invoke that will return an
eye view component result of some sort
so you can return a view but you can put
together it's isolated you can put
together your own models your own data
access whatever you need and produce a
view that will render HTML into a larger
view and the way you use it is well used
to be the that you would use component
in both async
and named your view component you could
also pass along parameters there and you
had to await it that was kind of ugly
with 1.1 they introduced a tag helper BC
so you can invoke a view component
without that ugly syntax so BC - main
menu would go out and find this
component render it stick it in wherever
that code appeared here what about
client code we're all writing stuff that
involves JavaScript these days I have a
couple opinions about that if you're
doing anything with like angular -
typescript or raelia anything that
requires compilation or transformation
my favorite go-to tool is still web pack
there's a lot of good integration with
between web pack and asp.net dotnet core
that I can show you in just a minute but
there are tons of tools out there they
all do different things they all say
they have different advantages to me web
pack has been the one tool that no
matter what else I'm evaluating it's
been the stable thing that's been the
most well used it's been the most
well-documented and ok maybe it doesn't
produce the most efficient code compared
to some of the other tools but it works
well on it's easy and unless it's unless
I'm getting like a 20% performance boost
from some other tool I'm not going to
worry about all the pain involved in
migrating to another tool for 2 percent
gain let's say
anyone using webpack basically there's
so the story would be for like in this
application I am using react components
and I'm writing I want to offer them in
typescript
so not only do I need to transpile from
typescript into JavaScript I also need
to bundle up all these little individual
files until a single javascript file
that I shipped down to the browser in an
efficient manner to do that I'm using
webpack web pack after you install it
with NPM because it runs on a junior you
write a configuration file there's a lot
of complicated configuration files out
there but here's the simplest part
resolved that tells web pack what types
of files to look at here I'm saying look
at j/s files this is because this
particular configuration file is just
bundling code that is that doesn't need
transpilation so it's already in jf the
entry will tell web pack I need an entry
point known as bender and here's the
code that I want associated with a with
the vendor so what you're listing here
are the various entry points where web
pack will go and say oh you need react
let me look at react and see if it has
any other dependencies and basically
walk the dependencies pull all the code
together and put all of this into a
single file so everything from react
react Dom we have to bootstrap Axios
from es6 promise we'll go into a single
file called bender it will go into a
single path called bender because I have
said the output of this should go into
my assets folder in WWE and the file
name should be parameter placeholder
there yes but it will use this name
vendor jf slightly more sophisticated
example this is web pack config dot Jas
this is the one that actually has to
crawl through my feature folders find
all the typescript files and then output
a Java Script bundle for each feature
file so there's a little more code in
here yes web pack execute under nodejs
you can write imperative code inside of
here if you want to go out and do things
like glob up all the tsx files
but again it's resolved
what is it resolved typescript
JavaScript and TSX which is react plates
Krypton reactants a script
what is it output output something with
name jf the name will be derived from
the file that it's sound and the only
other thing we do for typescript is we
say ok if you're actually loading a TS
or TS s file use the typescript loader
which calls the typescript compiler web
pack itself is actually a pretty dumb
tool it relies on a bunch of plugins to
do actual work so web pack itself is
really just about packing stuff taking
javascript files building a single
bundle it relies on other tools like
tight script to do things like
compilation so you can have multiple web
pack configuration files as I
demonstrated just there you can yes use
multiple configuration files there's one
of the tip I wanted to give you which I
think comes later so I'll come back to
that JavaScript services anyone here the
fantastic project initiated by Steve
Sanderson of Microsoft of usually guys
that implemented knockout jf might have
used that in the past so here's the deal
typically in an asp.net core application
that's using aralia or angular 2 you
need a tool like web pack to help build
and bundle your JavaScript files so what
you end up doing is you have a command
line window open somewhere it's running
web pack so every time I say the
typescript file I can see web pack
running rebuilding my bundle putting
some output somewhere and then I refresh
the browser and now I can test out the
code that I just changed in tight script
what JavaScript services will do there's
actually a whole slew of features that
JavaScript services implement but in
this repository asp net javascript
services it's a new get package that you
would install and it includes some
middleware which is quite interesting
one of the pieces of middleware that it
includes that you could use during
development is a piece of middleware
that integrates with the web pack in a
way that you don't have to open the
separate command line window to tell web
pack to run and it's a piece of
middleware that will work with web pack
to compile your typescript behind the
scenes when you save a file you don't
have to explicitly start a tool used
we'll just have to write the webpack
configuration file and the other thing
it'll do is integrate with a web pack
development server which is a tool that
can push hot reloads into the browser as
you change files so in other words with
JavaScript services in an asp.net core
project I can go in and save a type
script file and I don't have to do
anything that code will just come into
the browser and I can just start working
in the browser again I don't have to
refresh I don't have to build none of
that it's really quite nice and it would
look like this I would say most
definitely in development only I want to
use this web pack dev middleware and
enable hot module replacement and so
those two lines on a web pack
configuration file and your you'll be
good to go using webpack I like to use
karma as a test runner so that's just a
suggestion but I want to have tests from
my JavaScript code karma is a tool that
will work in an asp.net core project I
mean it doesn't know anything about
asp.net core room it'll work anywhere
it'll work with any framework - it was
designed I believe by the angular team
but it works with anything anyone used
Khan EMU or commander yeah a few people
so when you start working with all these
command line tools and you start running
dotnet in one window and you're running
web pack continuously in another window
the the built-in command prompt and
windows starts to break down a little
bit and that's why I like to use Conny
me or commander because one of the
they're kind of like I term in Mac LF
you can open up multiple tabs notice
down there at the bottom so I can have
multiple tabs with different command
windows and I can even tell both of
these tools which are you Google for
them you'll find the downloads for them
to pre pain so I can have different
things running in different panes so if
I'm running my unit test runner for
javascript I can have that in one pane
and web pack building my bundle files
and transpiling in another pane and in
fact let me show you this one of the
scripts that I have checked into the
project as a little script that I can
use which will basically say we're going
to start con mu and in one window run
NPM watch the watch
command another window run my test watch
and by the way put that into a new
console that is split horizontally this
is an ugly syntax icon EMU requires it
has to be all on one line and then a
third window run karma and split that
window vertically so when I come out and
actually run that which would be scripts
jf what I'll get is this sort of setup
which I can throw up on a second monitor
in any minute now webpack should kick
off in one window and carmen should kick
off in the other window and it's just
all everything I need is up and running
so it's kind of neat I'm going to give
it five seconds to try to produce
interesting output there we go so
fascinating stuff right yes I can see
everyone's thrilled all right we'll kill
that off and get back to the slides and
make sure we get through some content
here in the last few minutes client code
layout I pretty much described that I
like I like I like to have these feature
folders and I like to put a component
that is specific to a given feature in
the feature folder but what about the
other JavaScript code that you have to
write the stuff that represents your API
calls and infrastructure code and
logging in your models and stuff like
that I like to have a client folder
which is at the root of the project that
contains the pieces of the application
to go to the client so CSS files script
files my models and my services that are
implemented in typescript and the funny
thing about this and then keep the feet
thing specific to a feature over here
like a component to list golfers the
funny thing about this when I tried to
six months ago it was not possible the
JavaScript tools just were not flexible
enough to give me the ability to do this
a lot has changed in the last six months
a lot has changed both with web pack and
with the typescript compiler but
especially with the typescript compiler
one of the things I can do with
typescript if I advanced just a slide
here
excuse me one of the new features they
added is this ability to find your pass
and pass basically tell the typescript
compiler where do I look to find code so
when I'm writing typescript code in the
es2015 style and I say import through
from bar typescript now if you're using
at least version 2.0 it'll go and look
for a bar in the node modules folder it
will also go look for a bar in the
client flash script folder because I've
added that as a path and that just
allows me to place my code anywhere not
have to use crazy relative paths or
anything like that inside of my
typescript files I can just have
well-known modules the typescript goes
out and finds and backing up a few
slides that allows me to have a client
folder and put my script wherever I want
it and that's really nice the other
thing I would suggest is use nougat as
your package manager for all things net
use NPM as your package manager for all
things JavaScript and that includes
front-end frameworks so it's actually I
don't want to say it irritates me
there's bigger things in life to get
irritated about but I find it crazy when
people are still sticking to Bower it's
not that Bowers a bad tool but NPM has
been able to do everything that I need
recently so if I went to NPM install
bootstrap the CSS framework that's an
NPM if I went to NPM install jQuery NPM
install
Axios all these front-end frameworks and
tools I only need NPM for that I don't
need Bower so all of my dependencies
both server-side and client-side
are stored in my NPM BOM so everything
to do with JavaScript I just do that
with NPM and that includes by the way
another thing that they introduced in
tight script which is you don't need if
anyone who's using typescript if you
upgrade to 2.0 or 2.1 I forget the exact
version number you don't need the TSD
tool or the Taipings tool anymore
basically for typescript development if
you want type definition files for a
framework that you're using like react
those used to be available by installing
them a PSD then they migrated to
Taipings all of that is gone away all of
the typing files that you need are any
types repository on NPM so now I can use
I am for everything I can npm install
app types flash jasmine and i have type
script definition files for the Jasmine
API and it just works it just magically
works the only tool I need now is NPM
and I get and type script just works and
I can use Visual Studio code off the
type script and it's beautiful there's a
lot less setup setup in fact that's what
I do in this project that we're looking
at now any USB done that core project
that I use are typically use Visual
Studio to edit on my c-sharp code
because I really like to use resharper
but I'll turn to Visual Studio code to
do anything with typescript or es2015
because it just understands that code a
little bit better when it's very good
before and because you can point you can
point Visual Studio to the same folder
as your asp.net core project and because
asp.net core isn't tied to Visual Studio
anymore and it's just a file system
based project layout it just works
I consider www root is my bin folder for
JavaScript so I don't want to have any
jf file that I see in WWE I believe
should be safe to the lead I just want
to delete it every every Jas file or CS
file but CSS file that appears inside of
here is something that's been built or
minified or processed by some tool and
it's been placed here as the output and
just like bin-debug and dotnet I'll come
back to that one or skip that one for
right now because I want to talk about
testing it's fine to have a single unit
testing project for multiple projects I
believe if you look at how Microsoft
implements their unit testing project
they typically have one unit testing
project per project I think for an
application development is typically
fine if I have a web project and a core
project and a domain project I think
it's fine to have one unit testing
project for all of that I believe unless
things get really complex or too complex
I prefer to use X unit as my unit
testing tool I hope you do too not going
to talk about it much but I think a lot
of people already use it but I just
think it's the best one out there I try
to avoid sorry I try to avoid mocks as
hard as possible
my philosophy into testing has changed a
lot over the last five years I started
trying to do test-driven development in
2004 and I spent a lot of time with it
and I still believe that the best way to
come up with a design in a domain that I
don't know anything about or with a
problem that I don't know how to solve I
truly believe the best way to approach
that sort of situation is using TDD and
trying to unit tests and trying to
isolate things however when it comes to
implementing an MVC controller I have a
pretty a pretty good idea already of how
that's going to work and so I'm not
interested in TDD my controllers in fact
I've also completely lost interest in
writing a unit test that will isolate my
controllers you might find that
controversial we can talk about it or
whatever but a few years ago when I was
on a project where we were heavily
heavily isolating all of our controllers
where we shouldn't have a lot of logic
anyway but we're trying to isolate them
or writing all these marks we are still
getting so frustrated by all these
stupid little bugs that were found
because our unit tests we're not testing
the features of the system they were
testing that the controller invoked the
Maas with the right parameters right so
I said let's just throw all that away
and write more integration tasks I want
to actually invoke the controller and
have the controller call a real service
to do something with maybe it will mock
things out of the database level but as
soon as we did that we drop 60% of our
test code and there were fewer bugs and
so I thought that was a win how do I do
integration testing with asp.net core
one way - one way to do integration
testing is to use the asp.net core test
toast the test toast gives you the
ability to walk up to your startup file
and say configure me a host that has the
exact same middle where's my my code
would have in production and now let me
fire off an HTTP request at it and see
what kind of response I get back but it
doesn't have to go over the tcp/ip
networking stack with the test toast
everything can happen in memory and it's
a great way to test things like
middleware so you want to make sure that
the user is rejected an anonymous user
is rejected access to such and such a
controller action you can do that with
asp.net core test toast
as you are set up in production the
other thing I use when I'm using entity
framework is the entity framework in
memory provider this is for testing
purposes only they don't give you a
memory provider to use in production but
what this allows me to do is set up a
database in memory with the entity
framework and now I can write unit tests
let's see that would look kind of like
this I'm going to actually create my
controller pass in a real mediator
create a real command saying that I want
to create a season and invoke a method
on that controller that will go the
whole way through the system so it's
going to use every real live production
component including the entity framework
it's just going to write stuff in memory
but now I can write assert that I got
back a redirect to action result if this
is successful I can write an assert that
will look in the in-memory database and
make sure there's a record there and
then throw it all away before the next
test so to me it's an integration test
but that little bit of code one two
three four five six seven eight lines
whatever it is more effective than
trying to isolate all these independent
pieces and test them independently
that's just my opinion
you can differ if you'd like I have a
few setup tips on using the in-memory
provider but I'll make the slides
available basically I want to way more
integration testing for your unit tests
at the asp.net core level real quick now
so if you're going to write something
that's going to be cross-platform and
c-sharp code a couple things to be aware
of use environment new line don't
hard-code /n or slash n /r use past
combine if you're trying to build up a
path to a file because you don't know if
you might be in an environment where
there's forward slashes or back slashes
do be very careful of environment
variables if you want to find out like
the home profile for a user the name of
those environment variables would be
different on different operating systems
and I'm tired of the async suffix on
async methods so I don't use them
anymore and that's my reason but you can
always get the slides and look up that
reason thank you for coming I hope you
enjoyed this that's my email address let
me know if you have questions
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>