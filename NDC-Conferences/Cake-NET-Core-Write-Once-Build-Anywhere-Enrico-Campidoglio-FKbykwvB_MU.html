<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Cake + .NET Core = Write Once, Build Anywhere - Enrico Campidoglio | Coder Coacher - Coaching Coders</title><meta content="Cake + .NET Core = Write Once, Build Anywhere - Enrico Campidoglio - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Cake + .NET Core = Write Once, Build Anywhere - Enrico Campidoglio</b></h2><h5 class="post__date">2018-02-14</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/FKbykwvB_MU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">we start one minute early because we
have a lot of content to go through and
I mean a lot and that's why they gave me
this session this lot right off to lunch
because you know when if you're gonna do
some heavy coding and new concepts and
everything all together it's better if
you do it after a big meal so yeah I
hope you guys stay awake I will not try
to keep you awake so welcome to this
session this is going to be one hour as
a set of intense programming with cake
so first let me ask you has anyone here
heard about cake not CakePHP oh all
right so we're on the same page so there
is something called CakePHP which is a
framework that's not it
it's cake build well that's good all
right so this is about using cake to
automate the build and deployment
process of your application running on
Dalton core so question number two as
anyone here is anyone you're running an
application on dotted core a perfect
well most of you so you are the perfect
audience for this first let me tell you
a little bit about myself my name is
Enrico campidoglio I work as a
freelancer as of September last year
some kind of new at this but I've been a
consultant for almost two decades so we
are not here to talk about the good old
days or the new good days we are here to
talk about cake so as anyone here played
portal so you know there is a memeing
but there is a thing in that game where
the cake is a lie and this is the cake
from the game portal sorry I just had to
make a joke because you know it's part
of talk about cake so not gonna talk
about this cake gonna talk about this
cake the cake project so you might
wonder well most of you already know
this but in just in case you might
what is cake well cake is a make like
build tool
however unlike make it doesn't have an
awful domain-specific language to write
scripting it has dsl built on top of
c-sharp
so really if you move those around its a
c-sharp make so actually should be
called CS make but what's the fun in
call is something she make when you can
call it cake so this is what cake is and
now if you're like me and just heard
about this your eyes could be rolling so
hard that they are falling onto the back
of your head because we all know that we
already have a few of those tools make
like tools
apart from make itself gonna make we
have these tools like Apache and maven
and Gradle if you are on the Java space
if you're in that space
yeah or Ruby you have things like a rake
and fake and sink and lake do you have
lake yeah we do oh yeah so we have all
kinds of this make like languages so do
we really need another one do we really
well there are a few things that cake
has going for it that none of these
tools have and I'll give you three
reasons why cake is different the first
one is well it uses sharp to write a
build script and diploma scripting so if
you are a six-yard programmer you're
going to be like wait a minute
you know it's sharp you are ready using
it to build your application and
hopefully the next scene is not going to
be this because this is definitely not
c-sharp
it's not Unix either but that's another
story so reason number one it is too
sharp reason number two it's
cross-platform so it can basically run
wherever your application runs and it's
written is cross platform because cake
itself is built on dot on core number
three cake has a gazillion of add-ons
that integrate with all kinds of
external tools and you all know that if
you are going to make the build and the
primer process it's all about invoking a
series of tools sending parameters
receiving back the results and
orchestrating that into a process that's
all Automation is about so your build
tool better integrate with as many
external tools as possible and when I
talk about many I'm not kidding I mean
cake has stuff like cake you can invoke
from cake in a native way stuff like I
must build X pill or the dotnet core
tool chain just know for compilation for
tests you can invoke ax unit and unit if
you're going to run your clip now
continuous integration environment you
have integration points for team city
team foundation server out vo or three
VI and Jenkins two you can up push
packages or download packages from
nougat or you can do your deployments we
have to push deploy you can interact
with an iOS web server create and delete
websites you can interact with kudu
which is an infra Speas of
infrastructure that's built into Azure
that makes it easy to deploy and monitor
your applications then you have stuff
like curl so you can send and download
files from anywhere from any URL doesn't
even have to be HTTP it could be FTP and
then you can also automate your front
end so you can invoke a gulp script or
NPM all of these things
you can do from your cake script so this
is pretty cool and the list keeps
growing so but this is not what we're
gonna focus on today no that's so nice
and good but what we're going to look at
is the cross-platform aspect of using
cake because as I said before cake runs
wherever your application does and this
is a very powerful point because if you
have a cross-platform by by the way this
is I'm quoting myself here so if you
have a cross-platform application where
developers might be working on different
operating systems like someone is on a
Mac someone is using Windows someone
might be on Linux the cool ones of
course are Linux and so they must be
able to run the exact same build
processes you do so having a make like -
that has all those integrations and can
run anywhere is pretty powerful so the
demo because no talk is cheap show me
the code we are going to use a demo
application that's already not built and
kind of done with tests and everything
and we are going to automate the build
and deployment process of that
application from scratch with cake and
we are going to do it on different
platforms so first let me tell about
this application it's called linker
sorry no naming is hard it's a one of
those like bitly short URL shortening
service you have a long URL you paste it
into the web interface and you get a
shorter URL back and then you can
navigate to that URL and you get
redirected to the original one no rocket
science
however it's built on not a core and
this is kind of cool so this is what the
application we are gonna demo and how
does it work the UI looks like this and
I'm very new eyes so you
you type on URL you press shorten and
you get a shorter URL back of course
this works way better if I actually had
registered a short URL
Oh last time I looked the short one-word
URLs are pretty expensive and this is
just a demo application but I did manage
to find one we're going to use it later
so this is how it works how is it built
just to give you the context it's
basically an HTTP API that runs on
asp.net core it has a database actually
not really just an in-memory store
because I had very high ambitions when I
started but then I didn't have enough
time so it's not really a database it's
like a dictionary well let's pretend
it's a database then there is a front
end which is just no HTML Javascript
style sheet it calls the HTTP it sends
the URL to the API it saves you into the
store and then you can get back a
shorter URL that's it that's the
architecture and it runs not the core
1.1 ok where are we gonna deploy this to
we're going to deploy it to an as your
web app so this is the context how is
our pipeline gonna look like first we
compile it for that we invoke dotnet
build with just a dot accord compilation
- then when I run the tests all 25 of
them and we're going to use dot a task
for that so these are the tools that are
built script is gonna invoke you know
shell out - then we're going to package
it into a one single file for that we're
going to use dot at publish which takes
all the files needed by your application
binaries and as well as the front end
files and copy them into a directory and
then we take that directory and with zip
it so we have one single package file
after that we take that package file and
we deployed to Azure
how do we deploy it cysteine is a
cross-platform pipeline we need the most
cross-platform way of deploying
something to a website which is yeah
some one-sided FTP or HTTP in other
words you just upload it okay and for
that we use of course curve which also
runs Windows and Linux and Mac OS and
actually Amiga was even I checked so
this is the pipeline let's get started
with this thing so we are going to
develop the build script here on Mac OS
okay using vs code but we might as well
be on Windows using vs code why do I use
vs code because it has some nice
extensions that make it make it easier
to work with cake so if you go to the
extension gallery for vs code find the
cake plug in and you get some syntax
highlighting code snippets and stuff
like that so that's pretty nice there is
also one for visual studio but it's not
as nice so here on the Left we are going
to write our build script and here on
the right is a terminal console which
are going to use to run every step when
we are done we are going to take all
these process and run it in a continuous
integration server as well unchanged the
continuous integration server runs on
Linux alright and the final application
runs in Azure which is Windows
cross-platform okay so let's get started
well actually let me show that doesn't
really exist and so I told you I had
registered a shorter URL for it
it's Alan Kay oh yeah like this so if
you look at not right now what is it can
I do this
well I'm gonna do it the there you go so
right now the website on Azure doesn't
have any files in it actually let me
further prove it prove it to you that
I'm not lying this is the content of the
the root of the website on Azure no
files completely empty alright so let's
get started first thing we need to do if
you remember we need to compile this
application ok so if you're already
familiar with the curl with them the
cake syntax no it's no brainer if you're
not it doesn't matter because I'm going
to explain the concepts to you as we go
along
so the first thing we need to do what's
happening with the keyboard ah there you
go so so I told you there are some
built-in snippets for vs code so you
create a cake task with an action or you
create a cake task without an action
which is not that useful so this is how
you define a task you see this is just a
C sharp matter that you're calling cold
task which returns an object which has a
does method not fluent interface which
takes a lambda and in the lambda in the
in the metal in the function there you
define what's going to happen for that
task so it so she shot we're going to
call it compile and here here we are
supposed to invoke an external tool now
cake has this really elegant way of
calling external tools there is you just
invoke them as if they were a sharp
method of a dotnet method you make a
metal call passing parameters like you
will normally do cake is going to take
care of translating those parameters
into the correct syntax for the external
tool you're invoking just all
behind-the-scene not only that is that
if you don't have the
tool on your machine it's gonna download
it for you before you start and it's
gonna also take care of concatenating
together the right path to the
executable which you all know if your
ever written a build script that's
number one pain I want to say in it's a
pain it's being recorded or so it's
really into concatenate the relative
paths or the absolute path or whatever
you're running you're screwed from into
the script kick just takes care of it
behind the scenes so what we can do if
we're gonna invoke dotnet build we just
say dot net core build just as a method
and the first parameter of course is the
path to the solution file alright as
easy as that now in order to invoke wait
we have to do one more thing this is
just a task nothing is being executed so
we need to save to cake around target
which tasks do you want to run when I
run the script I want to run this task
don't forget your semicolons so this is
basically the most the simplest bills
cake script you can define how do you
invoke it we invoke it through a so
called bootstrapper it's just a shell
script that checks
do you have cake on your machine if not
let's download different nougat and then
let's check that you have all the tools
and add-ins that you are referring to if
not let's tell them too from nougat and
then it's gonna invoke the cake
executable and pass the path to your
script so that's what all the book with
the bootstrapper does there is one that
for bash and there is one for powershell
as well so you don't have to write the
bootstrap or your stuff you can just
download it actually there is another
thing in vs code that's called boot you
see if you there it is a what is this
causing vs code an action
uninstaller so this is basically gonna
affect the bootstrapper from github and
place it into your working directory so
pretty nice
so let's run this so you see it's okay
it's compiled in the script with Rozlyn
because what cake is don't mind that
what cake is doing is that it's taking
the contents of your builder cake file
parse it as a one long string and
feeling feeding it into rustling for
compilation and out you get a binary
which should then execute like any other
does not program now why is this failing
well this is not a core 1.1 and if you
just compile it for the first time you
don't have any of your dependencies
downloaded no nougat packages that you
are using in your application have been
downloaded so you need another step
before this which is dotnet restore
which looks at all your does not
packages that you are using and download
them from you get how much can you say
nougat in a sentence I'm sure I heard is
called a new jail is it correct you say
news new jail nougat
all right must have been some strange
all right okay so some what does good
news yeah nice okay so let's define
another task done before yes and let's
call it restore and dotnet core restore
so this basically looks in your root
directory of the project looks for
packages that were using and downloads
done
notice that if we were using dot and
core to restore happens implicitly you
don't need to do it anymore
unless you're old-fashioned now we have
two tasks what's important here is that
restore must happen before compile so
this is where the concept that make
introduced way back when of dependency
tracking you can define individual tasks
that do one thing but then you can say
that tasks are dependent
another one that needs to happen before
it one or more and the tool when you say
you want to run compiled its going to
look at what tasks could do I need to
run before compile and run them in order
so you need to take care of what is
running first you can just declare them
and then the two is going to take care
of resolving the dependencies so that's
really nice so how do you do it in in
cake I wish you could say depends on
because does and depends on number one
mistake that I do all the time
I write depends on but it doesn't exist
because when they make cake they thought
that is dependent on is better I totally
disagree I would like to write it depend
on instead of is dependent on but we're
gonna do is dependent on because the
otherwise doesn't work so we're gonna
say is dependent on restore all right
let's run this again now it's gonna do
the restore first which uses the network
so if you guys are running some kind of
torrent seed tracker is time to stop it
now
alright so excuse me for the font size
this should be on one line but anyway
you get the time it took to run those
tasks and it's green so it it's
succeeded
so we're basically done with the compile
step no not that much code next up is do
you remember are you still awake I also
wrote it Z T so what was after compile
publish that was like the last one
okay there are if you're in a hurry I
can just to publish let's just skip
everything else
test yes thanks so another task let's
call it test now dr. Corr
when you say dr. core test it's actually
going to do a compile also unless you
pass the no build option which we're not
gonna do so test what it really is
dependent on is actually said is
dependent on is restore not compile
because the compilation is going to
happen automatically so I'm gonna say it
so this is dependent on restore now you
you can guess what the method is by the
way those in the cake terminology those
are called aliases so dot net core test
and then we need to give you the path to
the project the test project file which
is in test a linker dot test dot linker
dot test dot C a splotch semicolon so
what do you think happens if you run
this sorry yes thanks
I'm still always running compile so what
we need is actually a way to say from
the external script what else do you
want to run this time otherwise it's
always going to be compiled which means
we need to pass arguments into our build
script from the outside and that's
pretty easy to do turns out so let's go
to the top we define a variable called
target and you know this is going to be
one class so this is going to be a class
field you could think of it's going to
be accessible from all the tasks so you
say we're target equals argument which
is another alias which hides all the
parsing of the arguments from the
command line and just
gives you the result so what is the name
of the argument its target what is the
default value let's say compiled yeah
actually I'm gonna reveal a secret are
you ready for that
the bootstrapper defines its own
parameters the common ones one of them
is target and the bootstrapper has a
default value for that which is not
compiled but it's built so if you want
to mirror what a booth default bootstrap
of course you can go and change the
bootstrapper to whatever you like well
in this case if we want to mirror what
the boost upper has as a default value
we should call this build
turns out that we don't have to change
this into build because build is our
default task it would be nice if and
this is just a design pattern you could
call it it would be nice if we can
define a task which just does not have
an action a task whose job is to simply
define what is the default task is going
to be invoked so we can change it later
without having to rename all the tasks
and all the dependencies so it's kind of
a marker tasks you could call it or a
grouping task so let's define this here
and that's where this snippet comes in
handy the task without action we call it
build which is the default one and we're
going to say that this is simply
dependent on compile and this is our
default task later you could keep adding
on other dependencies and here you are
defining what's going to happen if if
you just call the boost up with no
parameters so that's nice
so let's start by invoking the
bootstrapper first with the double
period you might have saved me right now
where is it oh yes well actually let's
let's take a look thank you for pointing
that out so I don't have any surprise
and I don't panic so here you see now we
have a syntax error and this is
basically just a it's the compiler
telling you that you have a syntax error
so nothing nothing strange we even have
the line number of course off by one
zero based so line 18 now it is actually
line 17 and so you can just correct the
error so another advantage of having
build scripts that compile is the
compiler instead of having a grunt
script or a gulp script which is
JavaScript which you know notoriously
does not compile you're going to find
out those errors by by run in the script
or over and over here you just care it
exactly what the problem is so another
advantage of having a c-sharp based
build DSL so let's run the test compiled
in the build script doing the restore
doing the compile sorry I forgot one
thing now that we have the target
variable defined we also better use it
so we say target here instead
so restore no compile running the test
blah blah blah it's taking a while 24
tests they passed good next step we're
almost done no wait not really what time
is it now have plenty of time so we are
gonna package it out this application
because we know that it compiles the
test pass so I mean must be you must be
okay
packaging also requires another thing
another piece of information what is
that when you pack us something in
preparation for deploying it you might
also need a version number now this is
not this is getting really exciting I
can contain myself so where is the
version number indata Corps no more
assembly yeah yeah it is in assembly for
battery there is another place you could
put it yeah in the project file so in a
project file you can define a kind of
metadata which is the version number of
your application in one single place so
that's pretty nice what's not nice is
that this used to be Jason once upon a
time and now it's XML kind about 90
climax but what this means is that we
can from our cake script just pass that
value out of the project file to
determine what the version is and since
it's XML how do you extract a value from
an XML file and it's not rag acts we are
linked to XML is an option but here
let's be cross-platform XPath there I
don't know is it better there than rag
acts are no you tell me that's what we
have so XPath that's how we're going to
read this value out of the process file
luckily for us there is an alias to do
that you could of course write just
regular C sharp you're invoking the
dotnet classes but let's not do that
there is a better way so that's the
final task let's call it version now D D
Aaliyah's to run an XPath query on to a
file is called XML peak there is another
one called XML poke where you can set a
value on the matching element so XML
peak this is gonna return a value let's
call it version since we're going to
need that version in another task later
the public publish task we are going to
define it as a script variable not an
argument but available that's accessible
from all the tasks and let's give it to
the default value of 0.1 zero which is
the default semantic versioning version
if you follow the same where
specification this is the default
unspecified version so let's go back to
where we were before
XML peak two arguments first the file of
course which is SRC linker linker dot CS
proj and next is the XPath query now are
you guys good with the XPath right so
luckily for me I think I have a snippet
for it which I mean is not that bad it's
basically following the dress code is up
yeah it's following the hierarchy of
notes going from project project loop
version and then extract the content
project project loop version extract the
content of that node is enough no forget
semicolon so and once we have the
version instead of
just being silent in our script that's
because that doesn't output anything
let's print something out the standard
output just enough to let us know that
this actually worked and there is an
there are actually many built-in aliases
to do this kind of stuff
one is information now information we
just pass a string and it's going to end
up in to the standard output what we
want to write me write detected version
and then we say plus version I know but
some of you are thinking now and we're
gonna get to that so the title version
and then the version to see that does
this task have any dependencies no this
can run by itself so let's run it we say
version let's see if I'm any compilation
error nope
there you go detected version 1.0 0.0
okay now you might look at your script
now and think isn't this a little bit
too 90s maybe even JavaScript that's the
only way maybe you have to do it but
remember we are running on top of
rustling and if you're using the latest
version of cake were running on the top
of the latest stable release of rustling
which means I mean all this is to say
that you can use C sharp 7 syntax
features in your build script or C sharp
6 or whatever C subversion
now some of these features are really
nice syntactic sugar for for example
string interpolation so you can say this
instead just put a variable right into
the script instead of concatenating
together which is definitely more
elegant than just concatenating
and it turns it's really handy if you're
going to build a path so let's run it
again
and there you go
Excel same result alright moving on now
it's time to publish this thing so let's
once again define another task with an
action let's call it a package sorry
package what do we need before we can
package we need to compile yeah and
version yeah we need the - this is -
thing so it's dependent on compile and
is dependent on version so you can chain
as many as you like here all right now
we're gonna use once again the tata core
tools we're gonna use two of them one is
dotnet core publish which takes a few
arguments so never remember that's why I
have them over here there you go
so we need the source directory that we
want to publish
of course it's SRC linker is the root
directory of a source code where do we
want to publish it we publish it into a
kind of a middle stage directory that
we're gonna zip later so how do you pass
the this argument these aliases
sometimes they usually take at least one
to three arguments just like that but
some tools have a huge number of options
you can pass and what you don't want is
just passing them by order like this so
a common convention among these aliases
is that you create an object that has
all the properties corresponding to the
options of the tool so in this case we
create a new object called the dot and
that core publish settings and this has
an output directory property which we
set to publish oh no semicolon there
do we need any semicolons yeah we need
one here and actually let me just put
this here so this is a way of specifying
more parameters to an external tool then
it will be feasible but just having them
by order so this is step number one step
number two we are going to need to put
this zip file into a directory now where
you put your package could be a
parameter of a script because it's going
to be different if you run it locally or
if you run it on a build server for
example so let's have that as a an
argument of our script so we say hi
catch output path argument package
output path default value list or
whatever you like now let's go back to
our our task now there is another
feature this directory may or may not
exist already
so there is an alias built into cake
that's called ensure directory exists by
packets output path only does its check
does this directory exists yes then I
don't do anything if not just create
make dear mkb ensure directory exists
really nice areas after that we're gonna
package this up with deep what you can
think the alias is called it's called
zip what do we want to see if we want to
zip the package where the publish
directory which has all the files and we
want to output a package output path
plus linker and a version where all
women were embedding the version in the
in the in the filename actually if you
want to be really fancy you could do it
this way
publish then remove this like that right
publish slash linker and version dot zip
sorry i deleted the first part we want
to say publish and then i made a mistake
here it should be called package output
path alright so this is the destination
or where we want to put the package
which is a parameter so let's try this
out
publish compiling know one thing about
Oh publish was not found
what line was that are the target our of
course it's not called publish it's
called package
one thing about cake is that rustling
isn't fast so you notice that everything
as we go through these iterations you
know it's not as fast as you would like
so over I was really fast ok the
compilation is not fast so you saw that
I know it's a lot to scroll in text but
well we are basically compressing all
the for all the dll's you know it's not
a core so you know all the DLS that you
are ever gonna need are part of your
application bundle and then we create
this file which has one dot dot o in the
file
let's check the dist directory and
indeed here is our zip file okay last
step deploy this is gonna need a
questions we are going to save them at
the end yeah hold on Tara
so deploy and now this is the point
where I ask you again if you're using
the Wi-Fi please stop whatever you're
doing because I'm gonna use the network
now now easily run when I do demos you
know Wi-Fi it conference Wi-Fi is are
notoriously unreliable so I run
everything locally that's why I have a
local instance of team city and a local
git repo and everything but this love I
don't have a local Azure so I'm gonna
have to use the network further so let's
define this last task let's call it
deploy task deploy now what are we
dependent on before we deploy package'
and we know it's just a package and then
package has its own dependencies and
then the chain continues so that's
pretty nice so these here it's getting
interesting
up until now we have only used aliases
that are built into cake you know it
comes with the cake this DLL however
they told you in the beginning there are
there is a huge ecosystem of add-ins
that add additional aliases onto your
context so you can interact with tools
that the cake team didn't foresee where
we're going to be used curl is one of
them support for curl is not built into
cake so we're going to use an additive
how do you use an add-in in a cake
script well you use a juster a regular C
sharp preprocessor directive does the
start with the hash tag like if you're
done if def for example you you already
know this cake define its own called
adding and then you could just say cake
curve what cake is gonna do is guys
gonna go in to the nougat repository
Luca package look for
PACA squawk a docker and download the
latest verse
let a stable version of it download it
into your working directory loaded dll
and make whatever Alice's are defining
that DLL available to your script
yeah that's I'm like first time I saw it
my head exploded
however the cake team tells me that this
is our not a good way of declaring your
add-ins why it's a little tricky but
it's a good reason remember I told you
this is going to download the latest
stable version of whatever the package
is now if the packet author has a
breaking change your build script might
suddenly stop working because every time
it goes and checks oh there's a new
version let's use that and if it's a
breaking change it breaks your build so
that's not good so it's better if you
paint what is this oh wait okay let's
stop everything I'm just gonna buy the
new version now and I'll get back to you
later
sorry for that unbelievable unbelievabl
good price though
[Laughter]
so kick the curl you don't want to just
use the latest version you want to use
you want to pin down the version that
you know works so how do you do that
well you pay the price in elegans
because now you don't you can't just say
this you need to say you get the
protocol and then package equals that
and then end version equal to 1.2 to 100
so this is the syntax - so what is does
is that cake is always gonna get to dot
100 no matter how many new versions
there are and if you are feeling
adventurous you could say really
and that means that it's gonna download
whatever unstable pre-release version of
that package there is probably not gonna
ever wanted to data actually so so cake
is gonna take care of downloading it and
make whatever Alice's are in that adding
available there is one called curl
upload file which now becomes available
so the first parameter is what you want
to upload well I want to upload the
package output path slash slash linker
dot version dot zip of course you could
put this into a variable so you don't
have to specify twice let me say that
everything is okay yeah
so that's the first it actually closes
yeah that's the first parameter that's
what what file do you want to upload
then where do you want to upload it now
as your websites have this kudou thing
running which is a piece of
infrastructure which adds services on
top of I is one of the services is a
nice REST API which you can use to
deploy files onto your website one of
these endpoints that they expose is
called a zip deploy endpoint what this
means and I'm sorry but this is not
really well documented so I actually
stumbled upon it by mistake and also my
head exploded again what to do is that
you take a zip file with the contents of
your application whatever is going to be
in the www route take that file upload
it into this endpoint and kudou takes
the zip file and packages it into dww
root directory all automatically just
upload zip file there and it just packs
it and puts the file in the right place
go figure why is this not a highlighted
feature I don't know
so what is the URL well we're gonna
create a URI object because
not after all and well do you RL is this
basically your website URL s with the
SCM subdomain which points into the kudu
website and then you say API slash zip
deploy yeah pretty cool
take a deep file upload it there and
just unpacks it so that's pretty nice
however this is a secure of course are
going to need credentials and stuff like
that in order to do that but you know
the curl alias for cake has all those
properties so we're gonna create a curl
settings object to define those
parameters so first parameter is the
command that you are gonna use and it's
a post because by default if you
incurred just say upload file it's going
to do a put to request and this endpoint
does not support put just post so we're
gonna say use a post instead and well
let's just how much time do I have left
20 minutes 10 minutes well let's just do
everything at once I wanted to show you
everything piece by piece but I don't
have enough time so let's just go
everything at once so the next step is
the username of course now you probably
and the password now you probably do not
want to paste your password in clear
text into your build script so a better
way of doing it is that read those
credentials from the environment from
environment variables there is an alias
for that of course environment variable
we're going to call it link sorry
deploy user and then we're going to say
password pass work also environment
variable
deploy password oops what has to win it
well let's stop what I'm gonna tell you
there is a data problem with Curl Curl
by default simply outputs whatever
response it gets from the server into
the standard output so if you are an
unauthenticated it's going to return
with the 0xe code which means success
and then spit out the error page from
asp.net in the console so your script is
going to succeed but it didn't really
deep publish anything turns out that
curl has an option which says if the
HTTP server responded with something
else than a 200 let's not just print the
output to the standard to the console
let's interpret it as an error and exit
with another exit code than 0 in this
case 22 this super hidden option is
called
- - fail I know it's like that with old
unix-like Tools so if you pass fail to
curl it's going to interpret the HTTP
status code correctly however and this
is a problem the cake alias for curl
does not have a property for that switch
for that option so what do we do turns
out that I thought about this too
because of course tools can get new
options and the Alice's might not
support them right away as properties so
we need a way to be able to specify any
option to the external tool from the
cake DSL this the way you do it is that
every setting file sorry every setting
class or setting object has a property
called argument customization what this
takes it takes a lambda with one
argument called cold arcs
and this object that you get in the
function has an append method where you
can say - - fail for example and then
you can say append and go on so this is
the way you pass any arbitrary argument
to an external tool even if the alias
itself does not support so let me show
you everything at once let me back into
this yeah so this is how the invocation
looks like okay it's pretty readable
let's try it out from the console yes 57
okay let's go to line 57 there
this is 57 60 63 ah yeah sorry you're
confused because of the relative line
numbers over there yeah yeah yeah
because I mean I'm using vim mode in
envious code and the reason why you want
those relative line numbers is that in
vim if you want to go to this line for
example over here and I'm here I can say
6 up so I say 6 times up but I need to
see how because I'm not going to count
how many lines there are so that's why I
am anyway you said 63 5 ok 5 down from
here there oh yes thanks nice spotted so
let's let's run this target to deploy
some of you oh I'm missing a
next up bracket where is it is it here
ah
oh wait isn't it that I think this is
the bracket for this oh wait what line
is that 70 some nice trouble it was that
what is the yeah ah yes dirtiness Thanks
yeah she'll be right now
why would there is another thing we
didn't do we're gonna find out what the
thing is compressing now it's deploying
oops nice this thanks to the - - fail
option that is telling me that the
request I made is unauthorized see our
code 22 I don't know why it's 22 so why
did i do why do we get the error because
we haven't declared those variables as
environment variables in our session
here in the console so let's say deploy
user which is linker deployer and then
deploy password ok can you all look away
and stop the recording okay I think I
have it here there you go brackets no
brackets let's put a bracket see okay so
now I have this I'm always paranoid with
this thing I always check yeah so now I
have defined them as environment
variables in my session so let's see if
this time it actually compiles you see
cake caches the nougat packages you
download so it's not downloading them
fresh every time ooh
is it still unauthorised yeah because
right before the talk I changed the
password but it didn't really know act
when I did it
that's if maybe the new password which
is yeah it's much better than the other
one let's see if the new password now
works because we know with cloud things
when you just when you change something
on press save is not really changed
until sometime later so let's see if
that's the password
should we call deploy pastor run it's
taking a while it's not fast to dai it
went yeah so that was the password so
now let's see if this actually works for
real let's refresh this yes deployed
let's try it out and you see long dong
shortened ah this is act no it's not
it's still not shorter okay okay
but it actually works you know I clicked
on the link let's look at the files
well that's adjusting of this again yeah
there you go
sorry ww route here's our all our files
dll's and double w it has the front end
now for the last part I wanted to just
show you how to run this exact same
process into a team a continuous
integration server so this is running on
one agent that's running on can you
serious Linux yes so that's and we have
been running this on Mac OS 10 or this
whole time
so I have a build configuration defined
let's define one single step that's
another beauty of having your build
script as a file instead of defining it
into the build server is that you you
have a versioning of your of your build
process you can see who changed what
and you can switch continuous
integration servers because they are
always gonna do the same thing invoke
your build script so let's have the
command line step which is build and
deploy maybe I should make it bigger and
we're gonna see a custom script we're
gonna from the working directory we're
basically just gonna do the same thing
we did here invoke the bootstrapper we
deploy and to save time I already
defined the two variables as environment
variables in my in my build server our
build servers have a UI - let's define
environment variables and the beauty is
cake can read environment variables from
wherever from your console or from a
build server doesn't matter and now
let's change it to the new password yeah
let's see that's it now I better know
commit those changes by the way let me
show you that this whole entire build
and deployment process is 76 lines to
take an application compiling run the
test version it package it and deploy it
less than 100 lines of a build script
which i think is pretty good considering
what other dsl or build yourselves have
you do so let's just commit everything
and say complete build process now I
told them running a local git server and
a local team see it is on on no network
here so let's just push it oh yeah you
know when you push when you when you are
overriding when you don't have the
latest version of the source code from
the from the server but you really need
to push your changes you just say force
push
so now we just push our bill script on
to the git repository which is being
watched by this team city instance let's
see if it starts by itself that would be
really nice
otherwise let's not wait that's rounded
the build here we can follow it in real
time build log there you go
is it readable more maybe there you go
here you see you recognize this it's the
same output we have been looking at for
the past hour compiling the build script
we did the restore nots doing a compile
yeah you know where this is going I
guess now it's already - yeah well we
missed some it is the packaging and here
is the output from curl where it's
uploading the package everything
completed being succeeded is this thing
still up it's taking a while - because
we changed all the files so yeah okay
same build process run it on a
continuous integration server 76 line of
c-sharp so let me just wrap this up what
did we do well let's not go to that
slide again let's just sum things up
what did we do for one hour
we took our source code of our
application written under the call with
c-sharp we run it through a pipeline of
computation test packaging and deploy
and ultimately we deployed it to an
azure website but this could be your own
on-premise iis web server as well
doesn't have to be a sure because it
turns out that you can run kudou outside
Azure
because it just it's just a web HP - net
web application that runs on top of your
website so you can restore KU the
outside of your eye is
and then we took the same process and
run it on a continuous integration
server which happened to be team City
but could be anything for the
cross-platform part we did the
development of the build script on a Mac
we run it continuously on Linux and the
application itself was running on
Windows okay of course you can mix and
match this as you like it could be
developing at Windows running running it
on Linux again because that's the only
kind of server you should be running and
deploy it on a ship by the way let me
tell you this if you are running vs code
on Windows and install the cake
extension you get intelligence because I
mean only if you noticed but I didn't
have an intelligence here and upon this
no enough times that I know what the
names are but intelligence really helps
unfortunately it doesn't work on lips or
Mac yet
it just works on Datuk or on Windows so
there is that but of course support for
the other
OSS a will come so if you want to look
at the source code for this linker
application with the build script a more
complete one with more things in it you
can find the address here and if you
want to learn more about how to use cake
to build and deploy your application I
have a florist
of course called building and deploying
applications with cake I remove the
application because it will no it didn't
fit so it's actually called building and
deploying applications with cake but
here is the short URL for that we might
have one minute for questions but first
let me thank you for your attention
so questions yes excuse me sir I you
need the microphone yeah there you go
Thanks what about application settings
like connection strings different for
different environments okay so the
question you have to repeat the question
no because it's okay that's good
so connection string and things like
that you handle it out it's the external
to that you're using in this case I must
build they will probably do the
web.config transformations for example
so you handle that outside of cake you
just let cake in volcanoes build and
msbuild then does the config
transformations however there are others
is to do config transformations in the
built-in cake as part as there is an
alias that just runs the transformation
so you can do that either way either you
let an external tool handle it or it
implement it inside of your cake script
yeah
next question yes there was another
question on the back in the gentleman
left maybe still are you sorry the
question from before the the hand that
went up is the hand still here no it
didn't wait okay is it possible to
inject other variables into those those
pills step rather than apart from the
environment variables such as if I want
to inject like build numbers like build
counter it's to increment okay so the
first part is the way you can get
variables from the outside world into
your cake script is two arguments like
we did so you define arguments and then
you can pass different values for those
arguments from the outside if you need
to read for example to build counter
most continuous integration servers have
that information as an environment
variable okay so it's just you read it
and in TIMSS it is called build
underscore count or build and score
number for example yeah I should say
that team city has built-in aliases to
interact with the team the build servers
as well
teamcity you say team citi dot and then
you have a number of methods you can
call for example to publish your package
as an artifact of the build for example
or setting the bill number those are all
methods that are part of the team city
alias that's built into cake next
question yes how extensible is cake is
it a strict superset of C sharp or do
you need to implement whatever for
custom functionality you're talking
about add-ins or you're talking about
expanding your bid script I mean if we
need to make a dance or if you can
program pretty this is just so let me
show you the great question this is just
too sharp so if you want to make some
more complicated steps that you don't
want to have inside a task for example
so let me get rid of this this one here
so you can define other cake scripts
auxilliary x cake script for example for
the version i have one called version
cake which just declared a static method
which does the xml peek in this case
then the way you refer it into your
build script is that you use another
preprocessor directive called load and
then you say version dot cake so you can
break out your build script into
multiples files which is a good idea
because otherwise it's gonna grow and in
those files you simply declare either
methods or for example you notice that
I'm repeating a lot this path all over
the place as strings what I normally do
is that I have a path cake file which
defines a class with properties for the
common path that I'm gonna use in my
applique in my build script and then
from my cake script I can simply say
for example instead of saying this I
would say path dot project file yes
thank you how did you pass parameters to
your task meaning I want to build debug
or release yeah I know it's a very good
question as far as I know you can't
I also wish I could pass parameters to
the task or invoke a task from task
instead of using round target and right
now it's not built into the DSL so
that's one thing but you mentioned that
you wanted to you mention that you
wanted to pass for example debug on
release yeah so okay in DOS
so this is just a c-sharp program so
it's being compiled with the Rosling's
so if you're gonna do different things
depending on the configuration you can
always say if the bug like that I was
thinking about building the pipeline for
ya so that's a parameter and that's
actually defined in the bootstrapper as
well so you say configuration and then
you say configuration and then you can
say that default is debug or the default
is release and then in this case in dota
core build you can say new dotnet core
build settings and one of the properties
is configuration and you say
configuration all right cool thanks and
all of the data core tools have this
configuration option yeah we don't have
time for more questions all right well
thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>