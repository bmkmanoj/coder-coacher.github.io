<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Diagnosing issues in ASP.NET Core Applications - David Fowler &amp; Damian Edwards | Coder Coacher - Coaching Coders</title><meta content="Diagnosing issues in ASP.NET Core Applications - David Fowler &amp; Damian Edwards - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Diagnosing issues in ASP.NET Core Applications - David Fowler &amp; Damian Edwards</b></h2><h5 class="post__date">2018-02-15</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/RYI0DHoIVaA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">there we go
hey all right so we give a talk last
year and you see London 2017 about
diagnosing common issues with a spirit
core this talk is kind of a part to do
that that first talk it's a pretty deep
dive so if you'd not familiar with a lot
of yes--the reading and those kind of
issues you may not make sense but if you
watch a video ten times in there and I'm
gonna explain it that way I will explain
it okay
everyone understands let's go through
all the BS I'm David he's Damien hello
I'm real get started you have a nice way
so we can just wait like did you try and
use present a moment that's very brave
oh they go what's up is it working
it is right now no it doesn't work all
right this is this all right so a snake
horse been around for like I don't know
not long before a snake or I didn't have
any kids and I have to sow out for a
while anyone be using it for the whole
time I need I heard dnx fans anyone's
still running day necks there's one day
here somewhere no one there's no one
good good good good
um there's a lot of issues don't get
home doesn't mean it's buggy there's no
place to actually put like good feedback
so people open issues it's to say this
is a great product so there's a place to
put it back yeah she issues only praise
it's just meant to be a measure of the
size yeah the people are using it a lot
of issues being logged it's been a big
uptake sense 2.0 since we had the
compatibility stuff in 2.0 so we saw a
big uptake since that came out and as a
result there are more issues more issues
in emails and in on github right if you
pay for Microsoft support you get to
call into Microsoft whenever there's an
issue and they eventually will cause and
we you'll have to handle bugs we have
buzzing both issues an email I'm
connected to call this both define like
common things so what we did was we we
kind of went over all the issues we saw
over the last two years and we kind of
found a bunch of patterns and the goal
to show you a bunch of those issues for
this talk and it is crushing ready if
you were worried
whatever that means it is founded people
always asks they say is it production
with me and I'll read it
that was like it's a professional video
and they're kind of two camps one who's
like yeah and one was like this is
terrible don't use it yet it's ready
it's good it's totally good because need
to understand a few things
wolves a text need to be out there
anyone run it gunmen encore the original
asp.net system web-based net yeah it's
like parsing it so parts of this talk is
is understanding what happens if you
move migrate from one to the other and
what the changes are and why there are
the way there a spirit core runs outside
of the I guess process so in system web
asp.net we have an is monitor that runs
in process for a spinet core it doesn't
run in the same process as I actually
run outside of the I guess process and
that has a bunch of caveats on on - why
would care about that its net core does
not have a synchronization context
anyone know what that is one heard of a
synchronization context in dotnet
bathroom water of the room maybe a third
of it I've heard about Italy this is how
the name where you know what it is
who's ever called an API on a
synchronization context that's thought I
expect two or three four or five beaming
since yeah that's better
I shouldn't have to do it very often it
does have some implications on the
actual code you write yes it's both good
and bad actually as part of doing the
research for this talk I realized that
maybe we should add some things back
there's no request qhp nightcore does
anyone ever seen the performance
counters in system web where you you
know your app is performing poorly and
anyone to see what's going on see so the
request queue number right there's no
request Queen XP Network which also has
good in bed and we'll look at why that's
a problem yeah a little later on static
files in a spirit core are served from
Eithne itself not from III so previously
in system web static files came from is
itself so imagine a scenario where your
servers overloaded you're starting to
still work because you had kind of is
serving them and it's been at core if
your your app is overloaded the starter
fellows won't load because it's the same
process of uploading both talking
follows and and I'm your same set of
gates same memory and their way to work
on that and there is a configure injects
I have to surf sorry fellas but it's not
the default story hey snake whore
doesn't try to copy assemblies then you
want to know about the asp net temporary
files folder that beautiful folder that
has all those weird and is it I just
who's ever had to delete something from
the HPA temporary but yeah but then it
worse they don't work out already
I'm sorry yeah so it's good and bad
because that folder actually when you
load assemblies in dotnet they're locked
in place which means you can deploy
opens assemblies and in asp.net whatever
happening there was a feature in dotnet
on AB domains called Shadow Copy
directories so that was set by asp.net
to temporary folders and whenever you
loaded file it would actually make a
copy
I love the assemblies from that folder
as a result you can ex copy deploy
things like normal this is not in the
net core as a result if you try to
deploy over a live running site it won't
work you didn't hit that if she was one
of the biggest issues we've seen if I
have deployments and people hate us for
it right we're not sorry do we have a
solution app offline still works in is
only so if you if you deploy an app
offline file first in is not nowhere
else the site will die because there's a
file watcher and gracefully that
shutdown shutdown it'll it'll die it'll
it'll just die gracefully Shakespearian
Eddy it'll it'll so the goal is to drop
app offline make a new site somewhere
else I'm point your pointy deployment to
the new site right well deploy actually
automates this for you and when you and
I'm having luck files whether the play
will do a bunch of retries and in the
worst case it'll rename the file to make
it to make it all work wasn't this
broken for like several time to like two
months ago as long yeah okay so if you
keep trying it it eventually worked
really well should be good now there was
actually a bug it was supposed to work
again that call there were issues where
there was like race condition the
process dying yeah and they're retrained
the fought over pretty sure it's fixed
now
does anyone deploy their sites like in
place without doing a swap don't be
ashamed is fine who's like a single a
Just Cavalli over the top while they run
web deploy straight onto it I'm
shoulder are people here who do that yes
it's not a ship production it's fine
it's fine
Shay you did it you bet I'm sorry yeah
be that this is for you this is what
it's for right certain that it makes it
work if you're doing hot swapping yeah
if you have different slots and it's fun
you shut it down you deploy and then you
bring that up all the other one goes
down but not everyone does that so when
you migrate from 8 to 32 exponet core
you may hit this in your deployment
scripts right um there are no optimal
there is one of them in there is a
abdomen is an abdomen the main abdomen
so there's no multiple domains running
multiple apps in the same process that's
been gone since like forever forever
yeah
we actually don't recommend you do that
for security reasons if you if you offer
holsters we recommend one process per
app right if you were using what's about
the minutes to get more density I don't
have answer for you I'm sorry but in
this context it's a little more
important in the COG to look at it for
deployment yeah no I think in in is it
would use app domains to help shut down
the old version of your app while the
new one was starting up and so you could
have requests in flight to the old one
and the new ones would get routed to the
new abdomen a new app running in the new
app domain and it would all just be
seamless and there's our web domains and
on the core so that process still works
with with the is motor because with the
process but there's worry yeah yeah all
right I have specific changes an cm is
what we called the asp net core module
it's a new is module that manages dotnet
core apps in in is the way it works is
it's a native module that when requests
come in via is it uses HTTP to make
external requests to the backend process
what win HTTP where CP is a kernel API
that does HTTP oh it's like HTTP client
it should be client for Windows R in 32
yeah it's in a DHCP client that Windows
uses to to do this kind of stuff ok so
it manages connections between the
reverse proxy is and your back-end
process so you're never running in the
same process as as is which has some
interesting implications I am has to
minus the person's lifetime so whenever
request comes in it has to find if there
is a
process sniff it isn't one would put it
up make a request to it and it is back
and forth so it's lazy so I've had to
flip my app there was no requests dotnet
it's not running yet yep and then a
request comes in a in cm booster prior
to the request queue to request booster
booster process waits for a start and
then the request gets forwarded that's
correct as a result an tiem has to pick
up port dynamically we've seen a class
of issues where either there's a port
conflict or or maybe this port is Austin
you run out of ports your honor's
reports on the machine we've never run
out of ephemeral client ports anyone
know what that means so if you're making
outgoing TCP connection you need to grab
a client port on your machine and then
to make an outgoing call to a server
port so everyone knows HTTP goes to port
80 usually in SSL support for four three
but there's a client port on the client
right that's being occupied and it can't
be shared it's just you using that and
so we need to do that from a NCM to.net
XE if NCM needs to allocate a port on
its side so we can talk to your app now
the server side can share report
everyone connects to the same one that's
fine but the client can't and there have
been circumstances in fact it took down
my site it took down live like for a
couple of days where for some reason
some condition happens on the server and
you run out of ports an NC em can't
connect new requests yeah that kind of
sucks yeah it's pretty new where you're
we're a poorly written back-end
application imagine you you've made a
bunch of our consent and you used to me
suck it on your Donna process right that
bad code can affect your incoming
requests to an see em oh but it's the
same machine since your everyone gets
action so if you're making you of your
server
don the XE or a teaspoon of core at and
it's calling out to api's right h-2b
client if you do that poorly
where you're perhaps using too many
instances we're going to talk about this
in a minute you know you're doing it in
such a way that you end up using too
many client ports you're stealing those
ports from a NCM it's a shared resort
it's machine wide right so you can write
bad code and net that results in the
native code means um not being able to
connect your app if you get this
cascading failure as a result you
innovate a notes and you just get
timeouts everyone's favorite thing so
that there's an issue one on a stern net
I think is integration repository and
the the title is this error code 2003
and this
this error happens whenever the the back
end process can't respond in time so it
climbs out the problem is people always
think that it's an is issue it's really
probably in your app but it's so generic
but and it always happens it can be for
anything out of memory it can be
anything in the back more so that goes
wrong it's kind of the first thing
you'll see as an as a nuclear that we've
seen this error when they're running a
screen it core behind is ever no one no
one
they've suppress it this one person
Renault one is the horror thing I see it
every day usually I do something that
makes my app not work and then I see
this in I yes you have to go figure it
out and the and the front end will drop
the client from the request so this is
what it looked like
today in system web in the existing
exponet song isn't it cool
yeah I had a hard time picking a name
for it on the system web system web
client so ACB sis is a kernel module
that handles a CP in Windows that has a
queue
so whenever a request comes in it goes
into a queue in is iist nd cues from ACB
sis and in whose into its own thread
pool and then is well dispatched to
asp.net via the isin the is module and i
think it's called web engine for web
engine for that module is the managed
code motto for SQL net system web in is
that has its own request queue and when
so this isn't totally inaccurate because
the request queue isn't always used so
think of it but think of it as a pipe
liner
so I'd like if there were if there's
nothing in the queue and nothing me
it'll just jump it'll jump I can jump
but it's there it is there ok so you
have this she'll of that kind of tries
to do a bunch of back off in case the
thread pool in Donna is being overused
and then if your net core is really good
so the big things are different
processes so on the left you have it
should be cysts and I asked our pool in
w3 w p our favorite process and there's
an i/o thread and castro that had that
hand of the request and that this part
is to thread pool threads this is Castro
at schedule yeah that takes bites off
the wire yep I have memories of I'm
doing dances explaining this a couple
years ago it I was like and
and this is your code generally on one
of these three right okay so you're
always going to threat people eventually
the question is how many hops do you
have to get there right all right not
having a saint context what does it mean
so it means you want deadlock if you if
you block if you did that wait that's
that's pretty good
anyone ever deadlock they're like MVC
old app by calling that way yeah okay
don't wait don't the cold dot way and
there's one thing she's learned from
this talk it just don't block he's doing
if I don't don't do it unless you cut
then you have to he's doing this still
don't do it configure await false does
not have an effect in exponet core I've
seen a bunch of questions asking if you
have to call you should still call it in
your library because libraries are used
in every kind of done application and
you may actually harvesting contacts and
so you will typically have a sink
context in like a uwp app or a WinForms
apple or DF app or a traditional a speed
on their app there will be a
synchronization context and it manages
threads and thing as Cole's going around
yeah we don't have one right so so what
it actually is is its kind of an
abstraction over where code runs so all
it really is is coding honest in context
and it's kind of an abstract concept and
the different kinds there's the UI
thread informs the UI thread in WPF in
its net court doesn't Iver Easter
request right yet the requests right so
you could think of your your request as
a UI thread and work always goes to the
request read right but we don't have one
there's not on a stack or so and as a
result when you when you continue a task
after the await returns those can run in
parallel so if you have multiple tasks
running at the same time when those come
back they're running on different
different threads so you can end up you
can end up corrupting structures that
aren't thread safe if you weren't
careful the conference itself isn't
thread safe we had a bunch of really
cool problems where people saw
Dictionary corruption and infinite loops
because multiple threads were accessing
the headers at the same time sorry the
HTTP context which is like the root of
all the api's your bill with a request
is not thread safe nothing hanging off a
destroyed so you should never ever in
not even do not you know think about
right and can't do a single you can't
even read it you can't even read price
yeah there's
and out of that surely it's easy to
avoid that right um so no you go notice
how it's alright um there's a there's an
interface called the IH DB kana
successor that gives you access to a few
currents outside of the actual request
if you and it's commonly used for
getting things like the user for
something you're not in the right
question is read you have a thing as a
singleton you capture it once and then
you can get the context for request
right it's dangerous
that makes things really hard to see
when your code of viewing so there was
an awesome bug in a kitchen insight
they'll open up oh my god how do you
even do that from there we can't see it
work oh oh like doing a little widely
gesture or just exit presenter mode
there you go
yeah and this is uh so it's still open I
notice yeah so the you said there was a
bug we're still discussing stuff yeah
there is a bug the thing was fixed but
this is this is a follow up bug I see I
see when you have a bug in late this is
a fixed piece that looks like a button
okay finished yeah so there's a bug and
it's really bad it's really hard to see
this is kind of the long explanation
there's a big thread about this oh my
goodness going on all right now we
haven't agreed to what we're supposed to
do yeah all right so this is generally a
problem that affects things that live in
di yep right in the dependency container
three injection container net core that
want to do something per request or they
want to might just be reading something
project quest that is a is a logical
pattern
whew laughing it every time you're but
onion but you don't want to have to pass
through the context in manually when you
pull it out a DI right you just want it
to be able to pull it in the ether
that's quite a difficult pattern to
achieve these buzzards are due to the
mutable shared state so that's kind of
the general
alright general issue let's look at a
demo of this yeah slides now let's can
you break something and slightly fix it
um Oh somewhere salon so let's look at
something interesting
I'm most gone oh oh that was good
why we watching your goodness I saw this
same thing happen before this is
recording right you'd be amazed how many
times we watch David try to type his
password in at work and it takes him
three or four times every day yeah
have you actually forgotten it no again
I think it crashed blowed me out you
lost all you state that's right even
Carlos that was a person can you dance
no it's distract no I can't just try the
audience
distract them now we're gonna watch you
recover because that's that's the fun
part
what are you gonna demo tell us what
you're gonna show I'll show them what
abusing okay I'll show you some good you
put what's wrong with it aah aah and
then you get a press I don't have a
praise but afraid that we could probably
did you get one okay so you're gonna
show them a snippet let's give it a code
and then you have to figure out what's
wrong with it okay is it bad
oh if it's bad or not I guess yeah so I
have a project here I'm gonna show you a
controller action and then the name of
the controller is kind of giving away
okay this one first
it's more fun okay all right so I have a
list ten tasks I have get number async
she's doing hard work doing aya and then
add into a list okay in parallel and
then I do when all tasks so you passed
the list I see you create a list you
create a bunch of tasks you fall each
over the task array you pass in the list
into a thing and it does some stuff in
those wait okay wait and then add
results to a list okay and I see a wait
I see a sink I don't see any blocking
calls look right it swings like so far
it looks pretty good anyone that spot
the bug yeah
so the results right here so he's
passing them in so he says it's a local
variable and then he passes it he
constructs it up there and then he
passes it in it is oh it isn't went all
so I'm doing in parallel yeah
so I buy he collects up the tasks and
then he puts them all then he passes
them to tasks top when all and then it
effectively awaits it for you because
you have returning that task back to a
spit out neck or because it's being
returned from the result there we go so
I heard a couple of correct why does
that matter here yeah why is it that
list does not thread safe which is
correct but why does that matter here
because you're using async and one and
there's no sterilization context and so
what happens it's running in parallel
you get them running in parallel so
every continuation so whenever this
returns from so you do a delay it goes
to a timer it comes back after three
milliseconds and it's on a different
thread let's run this let's let's crash
in all them in all days in asp.net that
works on asp.net that works this code
works fine because it cues continuations
so hang on hang on this is the async
part right this is the OL method this is
the only bit that actually does any type
of yielding right but once you come back
from here the thread pool you're gonna
be hoisted onto some thread pull thread
randomly right in the old world because
there was a sync context when you
entered this well when you entered here
actually yeah when you when you yield
back here the task scheduler would say
oh there was a sync context let me ask
it where I should run the code and then
it would block here and I seen it
actually and then wait before it would
run again so you would have all ten
finish basically at the same time right
and then they would all get in line and
run one after the other this would run
then that would run them without a ten
of them
that doesn't happen a snit core correct
you just get all these running on ten
random threads maybe they get scheduled
anyway you might get a couple running in
a time around although yeah so how does
that fail what does it do
let's see thinking it feel okay this app
has panelists
let's launch this app five zero six
seven what a random port or is it random
oh I'm using work this is the this tool
runs only on Linux and it works well on
the windows subsystem saloon yes well it
does on WSI is he used by tech empire to
do up to do the load testing for it's a
large generator well now you're not
you're actually just running your app
right now
oh yeah is that what you meant to do no
[Laughter]
there we go okay alright so I'm using
256 connections
I want the right so it's in a hammer
that endpoint for 20 seconds okay okay
it's pretty boring : mine it's coming
don't worry alright I don't know
winter is coming right is it printing
like you don't watch Game of Thrones I
don't I look at memes warning oh what's
going on it looks like it's working
perfectly that's that's the trick Larry
OH
are you telling me that this is racy it
took me two times and it would happen
every time after two times after two
times it happened every time that's what
you want to hear that's what you wanted
from a production application it
deployed it was fine and then it
restarted and it wasn't it still looks
like it's long it functioning did you
fix it accidentally while you were like
preparing okay let's try one more time
okay this let's try harder let's try
hotter create more talk of it straight
harder more threads throw more dye
things at it
we actually I we said to each other
before this talk wouldn't it be funny if
when we tried to show all the errors we
couldn't get them to fail because this
is the nature of like oh good
all right this just proves these are
horrible horrible horrible bugs to have
in your application because it'll run
fine for a day and then you'll do an
advertising campaign and 20 percent more
people will show up at your website and
then it'll crash horribly all right
let's corruption the capacity was less
than the current size so that's a race
condition yep right okay there you go oh
good good job okay I remember the the
the salient point about this is that
this code works in nbc5 yep all web
forms or a spinet system web you work in
a spinet core you need to protect this
code so you didn't lock here and then
you're fixed or use a concurrent
collection oh use a concurrent structure
of some sort by concurrent list and
current queue right okay something that
will trust that will never net will
never fail now all right so let's look
at this one separate so same kind of
issue by Carla access to this looks a
little more real now yeah I'll be
calling out to something but is it for
delay oh okay let's assume it's actually
HP client do something useful okay fair
enough but this is very common right I
mean who's ever called to web requests
concurrently yeah right to make it a
little faster of course you would right
and this is how you do that right one
calls it lot faster right so the hood is
is making it making you a request okay
logging there before your L and
content-type okay quest I'm not seeing
sheds today
yeah it logs something right yeah
logging stuff sure before and after so
you're not passing in some shared state
there's no giveaway there what's wrong
with it all right so what's wrong you're
using ambient values which one's this
one what do we say before where did this
come from it's a property on this
property
it's a property so what's wrong with
this one you're on the right track
you're on well I'm not the it's shared
right what does this hang off
HP context what are we say on the second
slide yep H no context is not thread
safe and so when is this going to run
because this is where the asynchrony
happens right before here you're all on
the same thread right this is this is
where you yield and after this point you
can be on different threads and in
parallel up to this point you won't be
right so this one is the problem not
this one
yeah and so this continuation is the
term that which gets used right these
this is a continuation of from this task
this will get scheduled and will be
potentially in parallel in parallel yep
and that's when you're gonna start
seeing strange things but Tony reading
how could it possibly be a problem
subtle right right so in its neck word
and it's kind of a detail reads because
of how the request is designed reads may
do a lazy evaluation and cause things to
be read all of a sudden so maybe maybe
the headers haven't made it read yet
okay first time you read them it'll all
it'll read all the headers and then
materialize in dictionary I'm reading a
single property can end up doing that
operation and it ends up being a right
to be on thing so you end up with okay
erase and so that's an interesting
detail so Nate's been a core we focus a
lot on performance you know that right
we did a whole bunch of work one of the
things that was we don't do work until
you need to do it right so we don't do a
whole bunch of work up front that
involves we might be pausing the request
but we may not populate a whole bunch of
structures that need that data because
it costs cost time until you ask for it
so that's a lazy evaluation so you can
end up if you've got two threads who
start to cause like you eat this one is
your evaluation then this one tries to
read it knows it's constructing stuff
but now you're reading in the middle of
it being set up right and you can get
very strange results same kind of error
as the one we had before do you ever get
a situation where you start reading from
the wrong request no no that would be
really bad
I'll be off okay I mean I hope not cuz
we don't pull don't pull request today
no all right no good let me check
everyone we wrote signal are originally
yeah we had a bug where we ended up
getting the response from other requests
that was pretty good in the see these
singular response to stress test that
was interesting all right and this is
the most fun one okay so same pattern
before
okay so there's no context now all right
what's this all okay so you're calling
out to something I get it
you'd say basically just removed the
thing that you're already the request
okay it's gone okay
and I'm logging okay it's fine it looks
fine you got rid of all the problem most
part right didn't you get rid of all the
problems except there's a whole strange
thing that's your logo yeah I see some
so this lager is a special thing I wrote
that's super fancy that gets the it
should be content and then it tries to
log the same stuff oh but it's hidden
now it's hidden
this is what you were saying yeah so
this is the kind of error that we we got
from the app insights I seen there was a
team in Bing that was doing this kind of
stuff
and we really we don't see anything
wrong this is ironic wrong it's code
right it's just a logger what could
possibly go wrong
app insights whenever you call a tractor
limitary they have an entire pipe when I
think of things that are run called
telemetry initializing lasers yeah and
those cat feet the assessor and TRADOC
mister context and it was causing havoc
on their their their machines actually
cause they start to run tests got to go
to an infinite loop so to hone their
CPUs and was that's not good it's bad
okay
so how do you fix this let's try to
write something to fix it okay quickly
okay so I'm gonna write well you could
log which is simpler but we're computer
science look let's write complex code to
do something super simple okay so to
show people how this thing conduct kind
of works I'll do a private class one at
a time sync contacts just like if your
knit okay and it would be very from
synchronization context and there's
method called post post is like it's
called so whenever you do an async
operation the task a waiter looks to see
if there is a current sync on if there
is one it'll call the post whenever it
wants to run a continuation so when ever
wants to continue
heard from in a wit returning it calls
pause to say like keep running this code
on this on this sinc context
so what I want to do is store a task
that it's basically gonna be my cue I'm
gonna have a little pseudo Q okay and so
whenever someone calls post you'll add
this to the queue and then it'll
eventually run the sequence okay so I'm
going to say task equals task start
continue with I say run D passing state
so I get the previous task I chain this
continuation after that task to sign up
with this giant chain of a it's
basically queue but the attack right
okay thank you very single to right that
should actually be the whole thing okay
how do you use it
that's the question so I'm gonna go
ahead and create a new context and then
it calls sync contacts dot set the
context okay it should be intro finally
but sure it's a demo to undo it you mean
certain to it you're icing I don't know
wait here except to undo it afterwards
I'm going to do st. context dot set
no okay let's do we basically just put a
god around like we basically put a
little area where we want this to be
coordinated so just for this one this
parallel all I'm gonna right make it
make it run out of time okay
I'm gonna hit that five on this so we
can see how the same context handles the
pose
the speedy I mean you might look you do
need anyone's kind of suck this I don't
want that so that's running all right at
the end point I think it was called
parlor list
5:06 create a faint context
sit down the current thread yeah I put a
Brit point here and here this is bucket
by the way okay I was gonna say that but
I thought I'd let you find it first and
then you fix it I have no idea where it
is so they call it post okay and if you
look at the cost AK it makes no sense
but right look at this thing I see time
is hostage innovation run callback okay
so the task continued the task Athena
mission tasks actually runs on the same
context so it's clung pause to sing
resume wherever you left off from
alright I'm gonna put this in the tasks
you right and it should just run in
sequence so I ran this again under under
load it should just like should just
work she just work okay
I never feel never failed the question
is how many times I run it to prove that
it works that's a good well that sounds
a bit like it what's the number that's
probably a comp site time what than that
we can't do that what's the number
well had you made it fail before with
one there is a there is a risk here
where as tasks returned from the await
they do post at the same time so I
should probably put a lock around this
oh my goodness okay which is what system
web did if I were does yeah okay it's
not only for the in queueing not for
actual it's not for the execution okay
so I'm looking in this carrot I have to
tell you fella I'm like we're not
actually telling people to do this right
yeah no no of course not it's not like I
don't want writing this this is more of
an educational thing I see so the lesson
here is to do what you were doing before
safely you would
to do something like this thread-safe
collection it's probably easier what you
really want to do is it's more about
identifying the situations that will
introduce parallelization that's going
to cause you a problem and then using
the correct constructs or using
different patterns and patterns in order
to do it not building harnesses and
structures like this we know this may be
an ad well but we did it under the
covers I'd feel ok if you get that out
one customers to have to do this time
you sure no I'm pretty sure yes pretty
this is pretty bad it's an interesting
educational tool I'll give you that
pretty bad this is pretty crazy
all right so I'm lit once and then
that'll just be good enough okay you
believe me did you dial it all the way
up yeah all right see that just never
I'm not finally not fixed it's perfect
shipping it's perfect not a problem at
all all right all right
Oh perfect let's resume because this
thing like long meal person wheezing all
right so where was I still showing their
thing Oh
starring nice there you go
that's recorded probably oh there we go
you good all right yeah so we were at
st. context yeah
is everyone thoroughly like freaked out
not yet does anyone think they've hit
one of these issues yet when they've
moved their code from a you spinner
toast minute call because we lay a hand
at the back yeah okay you're all lucky
so far
maybe all right all right no requests
queue so as part of doing research for
this this talk I found this this
beautiful comment we have to end this
Late Show noise yeah I think you should
just give up on the presentation it does
it link by itself you can turn it off
completely
yeah that sounds super complex there's
this comment that says the request queue
was made to prevent thread pool
starvation I felt a little bit bad
where's this comment in system web
requests queue in the.net framework in
the nephron in HP net
okay so turns out if you make a new
thing you should probably like read the
old thing for it's not read it but like
appreciate it okay for what it was okay
um the fact is that that bad code runs
better on a stone Nathan espenak or did
that land it's kind of a double double
meaning it will run better on a spinet
yeah
well crap is it like a pseudonym because
I wrote yeah right yes
my body's just an ideal that's not
lesson I do better on it garnet okay
Cole with an opportunity to be improved
yeah so so when you port your code it
unveils problems that you may not have
seen before
nice so we're kind of like a linty so we
help you like find your finder bad code
I used to pick coal into a run pile into
that happens arbitrary run times it
happens randomly
yeah that's great so blocking the top
loop tress can be problematic
buddy fault as you saw in the first
diagram we run your code on thread blue
threads which it's gonna cord us as well
as well but right we do it we don't have
a queue to handle burst up front so you
kind of have to write the code and then
I'm walking away to make it work below
okay I know Jesse is really good at this
and there's no just good to know what is
good at this no no doesn't have any
blocking API is well they
have a few but in general right no
doesn't have any blocking API he's done
that came from a place where where was
think at first had a really bad I did
bad I think like two times and then had
tapped and it was like oh my gosh task
agree then they think who ate was great
and then everyone's gonna figure out how
to move their code from the old stuff to
the new async/await
see so you end up with a bunch of ApS
that look acing that aren't cinq-cinq I
will see more of that as we go to the
top okay under and what ends up
happening is if you do put your code but
you may end up doing is a reason that's
very cool because you may be using an AP
that is over posting or doing doing IO
that is synchronous and the you get
worse performance on its kinetic or
because we don't have that layer in
front to to help you throttle requests
but if you write good code it's much
much faster it's much faster correct
good the thread pool has a has a very
fancy algorithm for measuring measuring
throughput so it so you give it a minute
of Max and it has this very computer
science the algorithm for figuring out
when it has to be injected first I
remove threads to keep the system at a
constant like rate is very slow my
default so if you get a burst of traffic
and you don't have and you don't have
non blocking code you can end up driving
thread pool and so if you run out of
threads you you're not gonna get another
one you won't get even for a while right
you can work run it by increasing the
limits the the minimum number of threads
in the thread pool but you have to take
into account the stack size Porifera
he's ever fiddled with the thread pool
size yeah kind of do is usually it
usually happens people do it yeah and
it's sometimes it's fine right but it's
generally a sign of something something
that's not something that not happen to
be solved a different way yeah so most
of the time when you're when you're in a
case where you hit this situation and
you're starting the thread pool a quick
fix is to bum the button the main
threads if you have a lot of memory and
then fix the problem and then buy down
right and you okay after you fixed it
let's have a let's gonna see this if I
all I want to say this so
oh these really about starvation mercy
so think over a scene I want to read
Stephen topes blog post on cinco bracing
he has a great series on all of the
async stuff from like I think years ago
basically an APA that kind of masquerade
sinkers but I see
blocking ethnic methods so you have read
on stream in Castro for example Castro
does not have blocking i/o so it's a
farce we implement stream and we
implement read but actually calls read a
think thought thought wait right so it
does the thing we tell everyone not to
do yeah yeah yeah so what was what would
be the alternative throw so I actually
tried to make that change in to Oh
so that if he tried to call one of
kestrels non asynchronous mounted
methods it would throw by default and
then we turned it on and all the
applications started throwing by default
there are really interesting things that
haven't made her do these like big
change it turns out that there was code
that there couldn't change its
fundamental silicon example there
streams that buffer like gzipstream and
memory stream and there's no displace a
sink in the framework and there's no
like using dispose they think so as I'm
happening in streams that do buffering
and normally flush on dispose and they
call synchronous flush which is called
synchronous right right so you end up
with this chain of things that you can't
really change or you might be using a
serializer yeah that you passed the
stream to you say I want to deserialize
this stuff from the incoming stream
incoming request you pass it to adjacent
D serializer
and it reads the stream using
synchronous API is because the vast
majority of them do that
I think only Jason's are nets that are
doing your base it's in 11 and so you
think everything is fine so in your code
it's just configured in the system and
then you can get into situations where
you've got the system making synchronous
reading calls which you should never do
and the case study that also next ok
most of them were the first one the
first ones kind of most common issue
some imported some code doing some stuff
I don't know if it was passed or not and
they called like I think API a dot dot
result or not wait okay
I think what we're saying is when you're
doing offloading is you see this more in
you guys you I present when you want to
not block the UI thread so you task to
run something to run some background
process it's not great and in server
after because you're you're taking a
pool out of the thread that could be
used to surf requests so it's fine if
you want to do legite virtualization
doing something faster but it cost you
more it cost if you do it correctly you
pay the right cost for what you're
getting that's fine what we did before
you were weighted to you
created two tasks that result in
paralyzation than your weight of them
both that's a sink over sink at some
point we're saying clay know that that's
more everything is when you tasked our
random block ah well that's okay that
would cost you even more even more yes
blocking API is don't block just doing
don't do it what does that mean so don't
call these don't call yeah ever so okay
I want to be extreme of course you can
do it sometimes if you know what you're
doing but like it it's a general rule
the general rule if you haven't you
should be like huh why is it there
right I think I think this is kind of
the same thing just don't block don't
block that block ban Adams of the UK
wrote this this awesome middleware
called blocking detector bans blocking
today's blocking blocking effector and
what it does it creates a sink context
and tries to capture all blocking API is
for a single occasion call and what it
gives you logs for whenever you do you
block and the funny thing is he actually
found a bug and this probably scare you
you found the bug in physical client oh
like the white the single coin please
people going oh wait I can't see the
screen hey yeah I can see presenter mode
there we go
there's an issue where some guy was like
I use your tool it's awesome and some
hole using dapper and create a sink I'm
getting this weird log thing it's
blocking was it blocking it Ben goes oh
snap that's a bug that's a fucking core
effects
this is buggin core effects Wow the
connection pooling API is in sequel a
sequel server league block oops and
they're gonna fix it is it fixable
uh-huh okay Rob put that maybe I don't
know okay cool so this tool is quite
messy right say yes this to this library
is quite new yeah okay so it's probably
hopefully will become more popular this
type of thing if you've been talking
this week about I was researching this
talk we
need to do more as a team to help you
find this type of code in your
application so I would imagine in a
future release never be towards the end
of the year we might have analyzers for
things like this so that you'll get
warned in as part of your build right
and while you're editing code that
you've got issues if you don't own the
code that's a problem at Ricky rabbit
and so then the next thing you do is
introduce something we call an app
verifier which is a mode that you run
the application in and then it reports
things when it finds them which is kind
of what this is doing and then you put
it in different modes so you can even
run it in a mode where it crashes the
application purposely when it finds a
mistake and you might do that in your
test service and stuff like that so you
prevent it getting out we actually have
that in system web yes the system web
has an app verifier that you can turn on
the registry with different levels of
severity one it is halted the program
capture a dump and then crash if you
find a violation and we use that with
Microsoft support to find issues in
people's applications where they violate
these types of rules because gonna be
very subtle to track them down even if
you have a heap and a dump and profiling
tools it can be very hard you really
need the runtime to know about it sorry
all right show some some demos for this
all right that time all right so I have
this app called threading it has a
controller that has a bunch of actions
it has hello that was asleep dirty low
world that looks bad is it I think you
just said that was bad he's just tired
okay it's just tight hello sink over is
there a thread cot rest I don't know
just just resting my eyes
hello sink over a sink this is this is a
basic API and you're doing dot wait on
it okay so sync erasing this is TAS
start run thread that's sleep so spawn
use hair pull thread away in it and
thence people not thread okay and then
hello async beautifully thing can we
should we ask people how many threads
are being used in each of these examples
how do they think yeah okay so for the
first one it's just one thread how many
threads surely it's just one one you
just call sleepwalk right so that's
easiest one thread gets used okay
think over it I think anyone want to
guess yes how many threads get used when
this method
is called - finish it - is it - its food
okay yeah so the first one to start it
and then you yield this one no and then
then you call wait blood the blood
thread that has to get scheduled I guess
yeah so that the second thread that
pulse work I see
comes back compared pool to resume so
two threads on that one what about this
one - task dot you will wait tasks run
it's an async method you will wait the
async thing and then inside that it
blocks the thread that's running on I
think it's three is three
is it four I don't even know no it's a
fire maybe it's three I think it's three
right because current generations get
scheduled right yeah so this is the
second half of the method after this
semicolon so you get one frame maybe and
if you shouldn't call it threads we
should call it like no no no I'm not not
new threads it might be the resin
execute up to three it could be it could
be up to three right and so you come in
on a thread you yield that roast this
into a thread and then you run on a
thread down here those are set three
separate logical operations you could
end up using three separate threads for
that yeah from the thread pool depending
on the load all those things could
result in a new thread neutral being
added that makes sense
I mean you could be lucky if there's no
other load it all runs in the same
straight that does happen sometimes
write code that runs after your way up
to three is the continuation so
everything after anyway is like is a
continuing a continuation right okay so
three four what really look like two
right now for this one oh that looks
simple like one - I know one and a half
so you come in as one thread right it
yields the yields so this thread yields
here heels yeah yeah it comes back and
resume so two threads tooth right okay
two sections that ones again so it's
really this one of the middle is the one
that you got to really look out for us
yeah but the point is in a wait go down
this one here is doing the right thing
yes but it can use two threads do this
okay
all right so which is the worst one then
one no way this is much worse than this
one like much much worse like this
just don't do it worse well two is
bigger than one so yeah that's why it's
worth its it's at least twice as bad
you win I can make it quick maths
alright so this app has a background
thread that prints out the triple stats
so I made the tear pull the thread pool
small it's not this small normally just
like in show bad things happening okay
see you second for the max is not that
small max is 10 the min is actually
smaller usually the Matty at the
ministry is the number of CPUs and yeah
so on your machine is - yours is old on
mine it's 16 or something bad I feel bad
that's mean and yours is too but the max
is like unlimited usually writes like a
max value or something right so every
every loop I get the available worker
threads I don't care about IO threads
are important all right these but these
idle threads are for like HTTP requests
and sockets not for orchestral things at
all we use a dedicated right we have a
difference we don't use the pool yeah
yeah mint is max right so I guess the
mint prismatic stress and available
threads every every loop okay so it's
printing out we're just counting choice
available active threads main threads
max threads and requests a number of
requests currently a flight okay cool
and that's counted by startup all right
I guess this middle work that increments
after and deca mess after okay so these
are these are our rudimentary perf
counters yeah because we don't have
parameters in call yeah not yet so I had
this other Prohm they wrote that sucks
but it's good enough to show things this
five thousand I think that basically
lets me add load add constant load by
hitting up or down on my keyboard okay
so I'm gonna do hello hello first and
how I was the one that just did a fret
don't sleep rightly yeah so it's just
request comes in you're gonna sleep that
thread and then it's gonna return after
it what is it a second yeah okay two
seconds two seconds okay
I ran so you guys see UI number of
requests I hit up there's one it should
have one request going into this is app
one request after there's one available
trans nine okay King sees this right so
it's continually issuing a one request
there's always a single request in
flight it goes it comes back it sends
another one right one at a time - now
there's two concurrent at any time four
four and so you can see the threads
going down like available is now six
because four active because there's four
requests because we said that that card
used one thread per request and it's
blocking so we're always using four
threads with that blocking car and the
thread pool never goes past the max max
isn't us so our server can scale - well
I'm gonna do some math again I think the
server's gonna get to ten and then it's
gonna get a little wonky you're clever
no I see it's a nine looking pretty good
it's so far ten I'm like a super stress
test why is it working perfectly fine
okay it's ramping up still Oh up ten no
threads left
what is this possibly do no more threads
so make it 11
oh it's crashing already oh clients are
crashing is that a timeout yeah but that
what happens okay so now I'm gonna I'm
gonna go down it should recover you're
reducing load yeah shit them back it
should be late oh oh oh yeah there we go
perfect so that's actually a really
interesting demonstration recovered says
distillation hits here's the max
recovers it's fine so it is blocking
threads of who's ever had a website
they've deployed an application they got
an increase in traffic and their website
became unresponsive right I'm hoping if
you've ever had a site of any type of
scale you'll get that when you don't
control the traffic that's really
stressful because there's not a lot you
can do to turn the traffic off you have
to have something else in front of your
site some type of load balance or some
type of reverse proxy where you can fail
quickly so your app can keep going in
this case we'll be hitting it directly
you see very quickly once you go beyond
the
to leave your site to scale in this case
it's blocked by threads yep right
because of bag code then it's done like
people just start timing out but it came
back right once the Lord went down it
came back it came back that's a key so
okay fucking fucking cars do that let's
do this think over this one is the most
fun but the clients weren't failing fast
yeah I had to timeout the time though my
single racing so I'm still running an
achievement URL - hello sync overrating
so runs in the fate request to make sure
it's running should have okay so we've
got ten and no requests no requests 10
threads ID 5 6 7 8 9 10 this is the same
code but we were just doing tasks are
delayed don't wait right yeah okay so
it's late asleep right
it's doing a tosser delay and then doing
a dot wait okay so I'm gonna add 10 okay
no trace left okay Oh start feeling good
night 11 12
okay still dead yeah gonna go down now
reduce load okay
char - anyway there we go there we go 10
9
I mean this is what a cascading failure
looks like right things become
unresponsive 7 this is me a production
all right Francis fixed my site so the
hope here is the app will recover
because we reducing connections right
why what's going on oh why is it what's
still zero it has ten requests oh no
available threads
10 active why is it not recovering
anyone was white yep so he's saying the
thread pool there waiting these requests
are waiting for a continuation to run
that was the the the the inside line
yeah all right
and it's awesome the thread pool for a
thread bond you're blocking the current
thread you schedule the work to the
timer right that and you're and you're
blocking the current thread yeah so
you're taking up the 10th red so this
app will never
never a couple is a that job is dead
this is a is reset oops that's kind of
subtle yes so when you said it was
really bad because it used two threads
that you were really lying yeah you're
really bad because it'll never recover
yeah if you go beyond load okay I know
real life you you probably want it the
maximum less you have Hugh a huge burst
of traffic but but there's thread pool
injection rig
yeah sue a second and it may seem it
won't recover because you're adding
press so they pull like that you may not
end up getting to the max and I don't
care how good your Linux kernel is or
your Windows kernel there's only so much
you can do to multitask and like a
thousands of threads on top of four
physical CPUs or eight physical CPUs
right especially if they're all blocking
and you're only injecting a new thread
every two seconds anyway so one thing we
want to show before you probably pick
one more in this is going so maybe was
say that a think makes things scale it's
kind of hard to see what that means
right people say and it sounds good web
skills songs sounds good it sounds
powerful
you think is web scale but what it
actually means is that you have
available threats to handle more stuff
so if I did the same thing for for hello
async so this is a white tossed delay
yeah this is a could be a sink okay so
okay so we've got ten requests in flight
at all times and we'll always have ten
threads of paranor threads and use so
we've got ten requests running right now
but we have all the threads available
which is counterintuitive right but the
reality is there's code running there
are threads being used but at the rate
he's printing them out they're always
available because they're writing for
millisecond yeah I mean let's say
microseconds probably even just to do
the scheduling the time out and then the
scheduling back so that each request
takes a fraction of a CPU to finish
which means that you can hit this
probably with thousands of requests
automatically and it would scale fine
web this is web scale this is web scale
nice that make sense to people
understand that now so like if you use
async purely all the way up and down the
stack and the things you're calling in
to that are a single well-written so you
know you hope that the the async API is
in net are well-written you hope the
tasks pull a thread pool and the task
scheduler are well-written you hope you
hope and
Kestrel and a spirit core is well
written and you almost be fine bugs we
fix them then it scales really well
right because you actually don't use a
lot of CPU if you're calling async
methods you do one thing wrong one thing
you can literally because imagine you
only had one method in your entire app
that did this right but then you had a
thousand people hit it no apps dead they
will never recover
okay so this is really dangerous we're
gonna really blow up really really
dangerous no time left but okay I'm
gonna show it a couple of slides lately
it should be client cuz it's pretty
interesting
perfect so starvation there but should
links here to a bunch of scenarios will
share the slides yeah afterwards to put
them up so people pretty good I think
all razor is I think so if don't ever
call synchronous methods to render razor
always called the async version in a
spec core we are going to get rid of the
sync versions in three oh yeah okay
let's go with super angry we kill this
site yeah sorry
oops HP client everyone familiar they
should be client you should use a
singleton it should be client never
create one per operation is very very
very bad there's a blog post from the
exponet monster is talking about why
it's so bad in great detail always make
sure you bump up the concurrent action
limit by default in dotnet framework is
to I think to persever linked server
2000 you can figure it in different
places based on where you are always
using the ethic methods don't block
don't block you just saw why you
shouldn't block never block if you're
porting code from full front Dominic or
you shouldn't use they see you requests
because it creates in the HIV client
everyone knows this type right this is
what we use for operation HP client
don't use that in dotnet core just don't
use it this yeah not in a spinet core
anyway bad bad things happen do not use
this get a string async and I should be
client for large responses that's a very
common pardon I see where you people
call get string I think deserialized
string as Jason and every turn to NBC
don't do that
use a stream API is and always use the
this triple used to about the stream
parsing yeah okay and I had a demo but
this so usually free too late now
alright cool yep I think all the things
you think all the things that's probably
the crux of the entire talk yeah
okay so we'll share these slides and the
code is all available up in your
Reaper yep we'll just put the slides in
the github repo yep otherwise thanks for
coming Alice will be around for a little
bit through an awesome question</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>