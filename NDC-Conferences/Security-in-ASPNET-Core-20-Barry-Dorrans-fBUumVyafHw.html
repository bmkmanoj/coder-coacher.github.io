<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Security in ASP.NET Core 2.0 - Barry Dorrans | Coder Coacher - Coaching Coders</title><meta content="Security in ASP.NET Core 2.0 - Barry Dorrans - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Security in ASP.NET Core 2.0 - Barry Dorrans</b></h2><h5 class="post__date">2017-07-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/fBUumVyafHw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello good morning oh it's on oh that's
marvelous welcome to my session on
security in asp.net core 2.0 with little
bits of nods back to 1.0 because I
realize some of you may have not made
the transition yet my name is Barry
dorrance
I am the security PM for all of net
which means that I do things that upset
David Fowler
and then Damien Edwards acts as you know
some sort of negotiator between the two
of us till we come to somewhere in the
middle that doesn't upset him as much as
I would like and makes it usable for you
which is nice um if I start coughing
during the session you will have to
excuse me I had flu last week in a
temperature of 39 so I'm still not
feeling terribly well hopefully the
water will help quench the the massive
coughing fit and frankly I do not want
to cough and shake these really spooky
floating stages which I still haven't
gotten used to and freak me out every
single time so there is my website I
don't know two org the slides already
there as are the pieces of sample code
the slides are quite heavy they are
basically there to reiterate everything
I'm saying and to try and guide you
through what the sample code does so I
will be skipping over a bunch of slides
but you can go back and look and use
them as a reference you can follow me on
Twitter as at blow-dart I swear a lot
which Americans do not understand
Europeans do they get very upset and
honestly I don't care so I'm going to go
through all the things that we've done
for dotnet core 2.0 and first up is
hosting as those of you that have used
dotnet core one already are aware we
decided that I is was not good enough
and we wrote our own web server which
from a security point of view is an
absolute nightmare
I couldn't stop David unfortunately but
you know
these are the things that I have to put
up with so we have a web server called
Kestrel and we have wanted to be able to
put Kestrel raw on the internet for a
while in 1.0 it was not ready and we've
done a lot of work in trying to make it
ready we've had two different rounds of
external pen testers come up come in and
beat it up and I've never seen the
excitement from pen testers before you
say we've got a brand new web server for
you to break and there's this great big
grin from like three different sets
three different companies repentance is
going really a brand new web server okay
yeah well we'll do that that'll be fun
and expensive so we've made some changes
to Kestrel Kestrel now does HTTP and
we'll do it based on configuration we
are selecting a certificate based on
subject name and expiry date so you
don't have to worry about rolling things
over for those of you that are using
Chrome you will have seen that chrome
change the way it validates self-signed
certificates so every time you start up
chrome from Visual Studio and go to
localhost it will complain that is
slowly being fixed it was a little bit
more complicated to actually get the UI
changes made than I would have liked
especially with iis because that ships
with Windows and when things ship with
Windows Windows wants to get involved in
all your patches which is not a pleasant
experience so there is a fix coming IAS
Express will be fixed first because
that's easy because we own that and it's
self-contained a fix for big iis will be
coming later at some point in the
meantime if you are annoyed with the
self signed certificate warnings from
Chrome you can go to that gist which is
a really weird PowerShell script that
does a bunch of funky things and then
eventually calls out to the plant lying
about 100 times to do a bunch more stuff
so you can load that in PowerShell ISE
as an administrator run it and all your
Chrome errors will go away because I'm
finally generating the certificate
correctly here is an example of the
configuration it's very very
sating we've redone a bunch of the
configuration stuff in 2.0 and that is
how Kestrel is going to pick its
certificate and now we've been very
opinionated in things if you were at
Damien and David session yesterday you
will see that we changed a lot of the
startup stuff to use a bunch of defaults
and a bunch of configuration and a bunch
of conventions so you don't have to
write as many lines as you want casual
now has a bunch of security
configuration switches in version one we
had all of those they were not enough to
make it secure in version two we've
added a bunch more stuff and we're still
adding stuff now they were adding stuff
whilst I was away which is always a
worry I have but never mind I've read
the emails and hopefully they're doing
what I advised so we are hopefully good
enough to expose on the edge without
anything in front of it however now in
1.0 we said if you did this you were
unsupported you should put cash flow
behind IAS you should put cash over
behind nginx any sort of forwarding
proxy we didn't care in 2.0 we will
support you if you live life dangerously
and put it on the edge but I will say to
you that it took seven years for iis to
get rid of most of its security bugs and
only end up with having one or two a
year this is a web server that we have
been working on for three years we've
done a lot of effort we think we found
everything but being the paranoid person
that I am I would still recommend that
you put Castrol behind an edge server
either iis or nginx however if you want
the raw speed you want ramming speed
damn the torpedoes you want to head
towards an iceberg fine stick it up in
front of the internet and we will
support you you should keep a close eye
on security patches for this
so that's Castro
it's made its made filer happy that we
can I put it on the Internet it gives me
nightmares and stomachache but never
mind how many of you have used dotnet
core 1.0 it's very hard to see with all
of the bright lights oh it's quite a few
of you okay some of this will be
familiar to you but as you can look
around
not everyone has moved to core so I'm
going to cover some of the stuff that
you already know we have a bunch of
authentication options in asp.net core
when I give this talk two weeks ago it
was accurate in the last week Damion cut
some features that will now be into
point one so I'm going to cover those a
little bit because you know I didn't
want to change my slide deck because I'm
lazy but it will give you an idea of
where we're going so authentication
option is p.net core reasonably familiar
you have no authentication whatsoever
you have individual user accounts and in
2.1 rather than 2.0 now we are changing
the way that works and I'll discuss that
in a little bit you have worked in
school of kinds which is as your active
directory and you have windows
authentication and then you have all the
social stuff that everybody likes
Facebook and Twitter and Google and
Microsoft account and often whatever the
heck else so we have asp.net identity as
our individual user account backing
store I want you to think of a speed up
my identity as a database and the
classes around it and then on top of
that in asp.net core 1.0 and 2.0 it's
all cookie bits so you log in using an
HTML form and we dump cookie and away it
goes in 2.1 we will be changing this it
will no longer well it'll still be an
HTML form and it will still be cookie
bits but we are switching to use o ID c
so we are finally using a
standards-based login flow rather than
something we made up which is nice and
that has a bunch of advantages we can
still have our local database option so
you take care of looking
after that database of looking after the
usernames and the hash passwords you
manage the database and then you cross
your fingers that that database is never
going to be breached and you're never
going to end up on Troy hunts have I
been poned we do a good job of hashing
your passwords for you to be perfectly
honest we've taken away a lot of the
choice from you and we've done as strong
as we think is necessary right now but
you know what is necessary seems to
change every six months so if you don't
like that option because we're heading
down the OIG see where you can swap it
out for any other sort of oh I DC
service so you could swap it out for as
your BTC which is a consumer version of
as your ad so you aren't locked into an
Active Directory it's basically the same
flow it's the same code but your users
can register using whatever using them
they like you can set up email
verification you can ask for a bunch of
information it has a standard way to
edit profiles and all sorts of other
funky stuff so you can use that and my
hope is that you know at some point if
you've used the local database stuff
that you want to move to as your b2c
I'll give you a button that says okay I
no longer want to worry about this
because I am scared of ending up on have
I being Punk'd so why don't you take my
database shove it up into Azure b2c and
then I can change one line in my program
and it will use Azure b2c and everyone
will still have our logins it's just the
login screen will look slightly
differently and if you don't like a sure
and I know some people don't it can be
very expensive you can use any other oh
I DC server you can use identity server
you can use Dominic and Brooks
absolutely wonderful identity server
which has a lot more configuration it
has a lot more options are oh ID see
server will be quite basic it will
support web apps it will support
third-party apps and not much else we're
not doing the IOT stuff like when you
click a buttons when you've installed
hulu or netflix on your xbox and it says
go to a website and type this code and
we're not supporting that identity
server on the other hand we'll support
absolutely everything including good old
WS fed which by banks
but we're like nope we are just doing a
nice simple Oh IDC server if you don't
like it you can use that any server you
can use a bunch of other open source
options and just swap things in tonight
because now we're being standards-based
and playing nice with the community so
template authorization if it fans like I
say we have individual user occurrence
which is your local database you can
customize that using EF and write in
your own model and we're quite
opinionated about it we're going to use
the algorithms we think are safe for you
and how to store passwords work in
school account it's as your Active
Directory and again it's it's open ID
connect best so you could swap out for
as your Active Directory with just a
single line of code you can have a DFS
open a geek max requires a DFS 2016
which means you're going to have to go
to your network admin and say can you
please update our ad FS server which is
kind of a hard sell sometimes because
that's a piece of critical
infrastructure so just either bribe them
or beat them up one of the two and we
don't have support for sam'l and WS fed
yet which is why we require ad FS 2016
it is coming it has been horrendously
complicated we didn't have all the
classes that we need in dotnet court 1.0
there they're mostly in 2.0 we're still
trying to figure out if we've got
everything that we need but we have an
early alpha version running which seems
to work we just need to do a lot more
testing so Samuel and WS fed support may
come for 2.0 it may be in 2.1 and then
you can use older versions of ad FS or a
bunch of java based stuff or things from
IBM or you know bank stuff because banks
don't update for seven years so they're
still stuck in WS file in sam'l and
there's windows authentication which
obviously needs windows you can't use
windows authentication when you're
running on Linux because it's not
Windows so you need a is and you can
locally join your demand server
the only thing that's different from
asp.net desktop the previous versions is
that there is no automatic impersonation
because that's a security nightmare so
you now will have to do impersonation I
run the little bits where you want the
system to act as the logged in user
which is easy you just pull out the
current user and you do dot impersonate
and then don't forget to roll it back
again
because otherwise that would be bad it's
like I say we're switching to OIG C in
two point one just because it's
standards-based and we can swap things
in and out and I'm going to demo this
because the code is in preview one not
in preview - it was great coming back
last week going hey all those demos that
you did I'm not going to work any market
react all the code out so I haven't
updated yet which is why you will see
the little visual studio update flag oh
now you can see my stunning design my
web design skills and I am going to use
hopefully Chrome as my browser just to
prove that I can write PowerShell
correctly there's as a p.m. most of my
coding ability has has dropped away as
I've been using alcohol to numb my brain
you have no idea how much of those
external pen testers just stress the
heck out of me all right so we have cry
have no idea why it takes Chrome so long
to eventually switch over I might switch
back to edge in a minute so but look
it's secure and there was no certificate
warning so go run that gist thing and it
will replace all your certificates and
life will be good so this is our Oh IDC
server implementation so think 2.1 this
is what will be coming which will be
painful I'm sorry it's a lot of things
will be self-contained in it's just a
matter of cutting and pasting so you can
if you have gone through the normal
forms authentication stuff you will see
that the URL has well it's it's gotten
and
awful lot big bit bigger but I heard
someone swear yes I know since this is
still going oh there we go
so this is mostly the OIG see specters
if there's a version number thing in the
end which is what the ad folks have
added on so if you are authenticating to
as your ad your security person could
actually keep an eye on what version
your software is using and if it goes
out it then ring you up and say hey you
need to update your eyes your ad
libraries but that is mostly oh I do see
it's lovely isn't it
so yeah so I'm going to log in and you
know the flow is exactly as you would
expect it to be let's see if I can
remember the demo password yay okay so
from the users point of view because
let's face it users do not look at URLs
they don't even look to see if there are
SSL for crying out like nothing has
changed you you sign in via form u sine
V a-- form so if I sign out of this and
I close this and I go back to visual
studio I can then go down to startup and
this is really badly named it said add
identity service authentication I kind
of throw a wobbler at this and it will
be renamed to something better for two
point one I have no idea what better
will be but yes so I'm going to comment
that right I'm going to put in as your
ad b2c authentication I've already got
my config set up which is a bit of a
cheat but all my conflicts in here that
has all the various options that I need
and if I run this again
because we're using a legacy and because
it's a standard I can swap things in the
night and we'll just wait for chrome
okay so if I click signing now and the
wireless is working which is always a
risk today and you can see it's got a
different sign in page it's gone to
login dot Microsoft online calm which is
the BTC stuff and again I can login
and so I've swapped everything out with
one line of code I could now go and
delete all the oh I DC pieces which are
nicely contained in an area so I could
go to areas and then delete the identity
service area there are a few extensions
around that we're in the template in
preview one and by the time it we reach
2.1 they will actually be in code so it
will just be a matter of deleting the
area and then all the magical trimming
stuff that's eventually going to come
along will drop the NuGet packages that
you don't need and we're all good and
just to prove that this isn't just a
Microsoft thing I am going to swap to
identity server and I need to set it so
I actually start identity server which
is useful so if I go to go multiple
start our projects start start right
click start again and it will have a
think I had got a shiny new surface book
because this is my personal surface and
it's quite old
I got shiny new surface book five weeks
ago and two days before I wish you to go
to tackle Rama in Belgium the SSD date
on a brand new surface book and did not
make me very happy at all it was very
interesting because it blue screens at
every blue screen and it was happening
once a minute would have a different
reason some of which I've never seen
before and I'm like yeah okay I'm just
going to think that this is screwed
Hardware rather than an MS IT pushing
some sort of betta build to my machine
that I did not want so anyway if I click
sign-in
it goes to identity server mr. lovely
open source project and then I do that
and hopefully my password is the same
and I click login no it's not darn it
and because we've got a legacy and I've
not actually gone through this on
identity server before because the demo
broke last week and I only fixed it last
night you can see that you get the
permission stuff that you would expect
and we go through and we've Logan again
so we've taken what was the standard
asp.net core off and swapped it out for
as your b2c in one line of code or so up
to out for identity server in one line
of code or whatever open ID connect best
service that you would like to use but
that will not be in 2.0 that will be in
2.1 all right so that goes away we will
go back to just light so for those of
you that are still on desktop framework
who have not looked at core we changed a
few things in core ones there are no
more there's no more support for custom
I principles or I identities everything
is claims principle and claims identity
based so you need to inherit off that
you have multiple authentication
middleware which was a bit of a mess we
kind of fixed that in 2.0 when I come on
to that in a minute so you can have lots
of different middlewares running at once
you could have things listening for gel
tokens you can have things listening for
cookies you can have things listening
for external authentication coming from
Twitter or Facebook or whatever and
cookie authentication finally
understands the difference between
unaffiliated and forbidden which was a
huge request from absolutely everyone
for the last five years and finally I
got to implement it so for those of you
that have been using core 1.0 and have
tried to use multiple authentication
middlewares you will realize that we
made a mess of it the holiday multiple
authentication middlewares was only one
was supposed to be active and active was
probably not the right verb or property
to choose so people will active well
that's the one that's going to run all
the time so I have cookie authentication
and Facebook authentication have Twitter
indications they should all be active at
once and that to you in what we politely
call an unsupported scenario basically
setting more than one authentication
middleware to active menu were screwed
we did not know what was going to happen
it was kind of random which one would
choose to run then everything was very
order dependent and it was horrible and
we didn't document it well because you
know documentation is hard and all my
developers use the excuse that English
is not their first language so I have to
write documentation and I spell you know
I spell I've been authorized acing with
an S and annoys people especially
Americans because you know I like to use
the Queen's English they have simplified
English it's so yeah I hate
documentation I have to admit I've been
very bad at writing some of it but it is
there you know every now and again I get
forced to sit in a room and write
documentation for two days mainly
because Rick Anderson will keep sending
me requests of github saying hey this
issue is not assigned to you this issue
is now assigned to you I assigned this
issue to you three and a half months ago
why have you written documentation yet
oh okay right so we have made this up
less in core 2.0 there is no individual
authentication middlewares anymore there
is a single authentication middleware to
rule them all and then you have little
services that you slot into that and the
reason we've done that is because now we
have a single service there's a single
property on it that says this is the
only active service that will ever get
run so github announcement explains it
in greater details here is basically the
changes in code we're trying to move
everything across to the new
configuration system as well which will
make things a lot easier and here is how
you set your active authentication
scheme as you can tell there's only one
okay there are three things there
challenge sign sign in and authenticate
which is a little bit confusing but
trust me the documentation actually
explains this reason
well because I spent three weeks on it
and I got it wrong the first two times
and the developers laughed at me and I
don't like it when the developers laugh
at me so it's a lot easier now because
we've removed your ability to configure
it incorrectly it wasn't a mistake in
your part it was a mistake in our part
and we're done and I'm sorry so there
are a couple of other things that's
changed if you have been doing things
manually you are used to calling context
authentication authenticate challenge or
sign-in we've moved it because we like
to confuse you so now you just call
context dot authenticate challenge or
sign-in with the scheme name you don't
need that authentication namespace in
there if you forget to make a switch you
will see that exception in preview one
we deprecated some of the old classes
but kind of forgot the key one that's a
developer mistake that's not my mistakes
I'm quite pleased with that in preview -
everything is now finally properly
deprecated it points to a webpage that
will actually explain the changes that
you need to make when I finish writing
it next week when I'm back again I told
you documentation sucks so we are going
to make some changes we were thinking of
doing these for 2.0 and doing things
like adding things like last login time
and a bunch of audit trails but they
were kind of intimately connected to the
OIG see stuff so that's going to bunch
the 2.1 however we have had a request
and it used to be possible to use
asp.net identity outside of asp.net you
know I would have thought saying asp.net
identity was a big enough clue but no so
we've we've added that back again so you
should be able to use all the EF stuff
all the store implementations in for
example a uwp app so you could point
your uwp app to your login database and
log in via you WP I mean obviously you
don't get cookies or anything once you
love getting it's up to you I don't care
past our stage you can save your
identity and use it however you want but
that should be possible in 2.0 which
will hopefully make some people happy
there's also two do-it-yourself option
which I must admit I'm fair because you
know I like to believe that I can still
develop things it's not actually true so
you can do it yourself with cooking
education and we do all the encryption
and signing of cookies for you it uses
get a protection which means that if you
have multiple machines you're going to
have to sync your keys between machines
and I'll come up for that in a little
bit and here's how you configure it and
buddy gladly blahdy blahdy blah there
are some caveats to this once the cookie
is dropped it's the sole source of truth
we don't go back to a database and keep
checking because you've dropped the
authentication cookie you have to wire
this up yourself you can implement a
cookie validator which not many people
do but if you're using asp.net identity
we do it for you which is nice because
we're kind but if you're doing stuff
manually you're going to have to do this
yourself we can use a validator it
supports sign art everywhere or in a
feed up my identity we recheck every 30
minutes and refresh the principles of
roles or group memberships have been
added or claims it will refresh in about
half an hour here's how to implement a
validator it's very very exciting I will
show you some code in a minute just to
prove it I can still code and here's how
you wire it up so doing it yourself
where you can switch through here
you can tell I'm not I'm not Fowler just
because I pre prepare all my demos
because every try them I try and do
something like it goes horribly wrong
and I get lost and then I got in a tizzy
and then I fell back to my pre-prepared
mo anyway so how there's we'll just
cheat so here is cookie off from scratch
nothing exciting there here I'm adding
my cookie authentication which is what
David did yesterday and got very
confused about because he complained the
defaults didn't work he lies the
defaults do work but he was adding two
pieces of authentication service and at
that point you actually have to be quite
specific about what the defaults are so
I'm adding cookie authentication and I'm
also adding user authentication which is
new in 2.0 do you need to add that and
configure like a wire up validator in on
validate principle my validator is here
and so what's going to happen is every
five requests it will reject the
principle it will sign me out but
because I'm a lazy and I don't want to
have a database backing this in my
account controller I just signed myself
back in again by doing everything
manually and I'll show you what happens
keep trying to persuade my security devs
that they really want to come along to
conferences and present beside me and
they're like goo goo goo whoo-hoo you're
mean enough to us in the office I don't
want to see what you're going to do with
an audience so because I wrote the code
that just loves me in automatically Here
I am logged in I'm going to hit refresh
and there we go of course Chrome is
caching thanks Chrome this works in the
edge it really does Oh for heaven's sake
I'm good I hung a cheat let's let's just
go back to edge which is not something
you often hear people say okay get head
meals from the edge team night because
this is video all right so I set my
validator basically to run an every
request actually every minute and so it
will start bumping up every minute and
eventually it will love me after five
minutes and no one ever wants to wait
for that but you can see that the valid
error is just running and incrementing
the same kind and eventually it will
love me out and this would pop back to
zero or one in about five minutes and
just know no one wants to no one wants
to wait from you hitting refresh for
five minutes I mean I know my shirt is
exciting but it's not that exciting how
many of you who are using dotnet core
one have tried to write your own
authentication middleware really okay
yes what you would because this man is
doing a plural site course on it
anyone else apart for the victims at the
front yeah it's kind of a rare scenario
she really don't want to go down this
route I have written one for basic
authentication which is filled full of
self-loathing because none of you should
use basic identification it is on my
github card
if you want to see how much I hate
myself but for those of you that have
written fendt ocation middleware and I
know you're only here for this slide
there's no or middleware it's just a
handler we've changed a few things just
delete your middleware class
things have changed from task for task
tools to tasks and so on and so forth or
just take my basic auth middleware and
hack the functionality behind it until
it does what you want which is what I
did to get my basic authentication
middleware working I took dot stuff and
active until it did what I want you can
limit by schemes so you may have for
example API is embedded within your web
app that you want to use both with
cookies and with tokens I maintain this
is a really bad idea if you have an
external API that what you want to use
job tokens with hosted outside your your
app that uses cookies it's what Google
does if you look at Google's Gmail API
the API the third parties get to call it
entirely different to the API that is
called from within Gmail itself because
you have external entities and a bunch
of trust boundaries and a bunch of other
stuff and different authentication
schemes but some people like to do this
you make me unhappy when you do but I'm
sure you don't actually care so you can
limit the authentication scheme for your
controller or for your controller
methods by using the active
authentication schemes property and
stick bearer on it so you could limit
something to job and it would ignore the
cookie stuff that has come down so I
mentioned data protection because that's
how we encrypt and sign our cookies how
many of you have accidentally checked in
a web config into github that has
contained your machine key I see one
person is being honest I'm sure - two
people are three people are being honest
the rest of you are liars because I go
to github every night again and I search
your web config I look for machine keys
and it makes me sad let me explain to
you why this is bad
if I have your machine key it is the
sole encryption and signing key for
cooking education so now I can pretend
to be who I want on your website which
is fun if you are using webform actually
how many of you are still using web
forms oh I'm sorry
not okay if you are using web forms it
is also the signing key or the
encryption key or both for viewstate and
used it is basically binary
serialization and I have that key I can
deserialize a bunch of objects that you
were never expecting and I can have
remote code execution on your website
which is nice so machine key sucks and
it's really hard to change especially
when you're in a web farm environment
because you have to change them all at
once and that never works so we kind of
threw it away we have an entire new data
protection stack and we have a compact
layer as well so you can use this within
your four points you're done at four
point six apps if you like I would
strongly suggest looking at that
especially for you people are still
stuck in web forms so we generate keys
automatically for you we rotate the keys
every three months by default it is
scalable it provides isolation based on
your apps it provides isolation based on
purposes we try and figure out where to
store the keys best on your platform but
there are other options you can actually
write your own key stores if you want to
show them in a sequel and if you are
Russian we can support your strange
Russian encryption system that the
Russian security services say you must
use we do not provide you with an
implementation of that because just no
but you can hook in your own one so data
protection is a bit of a shock for
people when they first see it and
they're like okay well well our security
people want to know what your defaults
are and they are there and that will
make your security people very very
happy you can kind of change them if you
want but we provide some key stores by
default if you're running as your web
applications we put them in a special
magic folder that flows between all the
instances of your
application however if you are using
slums they don't give us anything that
will allow me to synchronize the keys
between slots so if you're doing a/b
testing people will get logged out which
is not useful so we have other places to
put things you can stick them in at your
key vault you can stick them in Azure
blob storage if you're running on iis
locally we will stick them in the
registry if you're running an IAS with
the user profile we stick them in the
app data directory for that user and we
protect them appropriately you can store
them in memory if you want and throw
them away afterwards which is actually
perfectly fine unless you want to use
data protection to protect your own data
and shove it in a database at which
point you better hope that your keys are
stored somewhere that you can reload
them from and they're protected using a
bunch of stuff you can use DP API or dpi
P DP API ng on Windows ex-59 your
certificate and then if you just don't
care about life where you want to live
dangerously you can store them in plain
text so you can use this manually it's
all hooked into our DI system so you can
just take and I did a protection
provider in your constructor for
whatever class you want that comes from
di and it will get passed through
automatically and you can call protect
and unprotect and we do everything for
you we do not just encrypt we encrypt
and then we sign with an authenticated
signature because encrypting without an
authenticated signature is bad you can
go and look at padding Oracle attacks on
the internet you can see some very
clever mathematics and it will show you
that if you just encrypt without then
also adding a signature people can start
decrypting your data without knowing the
key which is a bit scary so here's how
you call it manually and it's all very
exciting
we have purpose strings so if you are
going to call this manual you should
have a purpose so some purpose of say
authentication cannot protect any data
that's being protected with the purpose
of data it's quite nice don't use user
input for that because that would be
silly
and we recommend that you just do a full
namespace with a version as part of your
purposes so when you update your classes
you can change the purpose and you've
still got the isolation and things will
not go badly wrong data protection is
really well documented because the
developer that wrote it gave me a
OneNote file with 60 pages of his
thoughts of his reasonings behind every
decision that he made and I just turned
that into documentation without much
thought so you can actually see the
decisions that we made and why we did
stuff and then only extension points
it's it's very impressive and I will
take credit for it because he never
wants to appear on stage for me so it's
my documentation and I'm wonderful
here's how you configure it
this one's persisting keys to the file
system and doing stuff with a thumbprint
it's not very exciting but you can
implement your own key store I know that
sounds scary you only have to implement
two things get all elements which is
give me every single key that you know
about and here's a new key store it an
attic so I'm done at desktop we allowed
x.509 certificates we did not have
enough support in 1.0 in dotnet core 2.0
yes you can now finally use certificates
to protect your keyring and you should
or if you're only an actor you can use
key ball the way these things work is we
have a store where your keys are stored
and then we have a protector that can
run on any type of store it doesn't
really matter so key vault is a
protector it uses a master key inside
key both of them wraps and unwraps the
keys that we generate and it's all very
fancy and very very clever and it only
takes one key in key vault which keeps
it underneath the free tier for using
key vault which is important for all of
us because we don't like to pay for
things so authorization how are we doing
on time
when did I start ooh I still have 20
minutes okay we can get through this
authorizing change in dolt met core a
lot how many of you have ever tried to
write your own custom authorized
attribute that's way too many people and
I'd like to see how many of you think
you did it successfully that's a lot
less hands okay yeah it wasn't the most
pleasant experience so when we when we
moved to core I got to design an entire
feature and my entire feature was I no
longer want you to write custom
authorization attributes because it's
horrible and it sucks
and it goes wrong so we change stuff a
lot we now have a way to express your
authorization pieces in code without
having to write your own custom class we
have requirements and we have
requirement handlers and then we have
policies in a policy is built up of one
or more requirements it says okay if
this person is going to be authorized
they must fulfill this requirement and
that requirement and then the
requirement handlers get called so you
can figure out whether someone has
passed or not it's all based on di you
can add resource based authorization as
well so you can have say for example
passing a Word document into authorize
and it could pick apart the word
document and look at the author and look
at the current user and say yes these
two people match so he can edit and so
on and so forth and you can actually
just throw the entire damn thing away
and replace the authorized interesting
service with something that you want for
yourself please don't do that
if you go to the point where you need to
do that drop me an email and tell me why
the whole policy system does not work
for you because I would far rather that
we fix the policy system so you don't
have to write your own massive
authorization service there is a
workshop on this it takes about an hour
and a half to go through that will guide
you from writing your first authorized
looking at a role all the way up to
writing
no policies and having multiple handlers
and then doing resource based
authorization and then going inside your
view and changing how the view looks
based on the current user risk it's well
worth doing because there are slight
differences between 1.0 and 2.0 there
are two different branches so make sure
you choose the right branch for the
version that you are working on so I'm
going to just switch to a demo because
no one wants to see slides excuse me CH
is much faster to start up in Chrome as
for debugging I have no idea why all
right so I gave this demo in Antwerp and
I did the most American thing I have
ever done and that I got Belgium and
Netherlands mixed up and used the wrong
flag because you know I've lived in
America for seven years now as you can
see and obviously all the small European
countries have merged together in in my
mind so let's hope I've got your flag
right here we have a simple demo imagine
you are flying into Charles to go and
you're being welcomed to Charles we've
got well I say welcome but they're
French
so that joke is so not going to go down
in in America because Americans think
Paris is romantic obviously they've
never been so
I took my wife there and she's just
wandering around looking at a nice
architecture and I'm just steering her
around all the things on the Paris
pavements that you don't want to step in
so she thought it was romantic and I'm
just like you did not look good so I
have got my three custom fans I have got
the EU customs lame I have got the
nothing to declare and I have got the
customs inquiries rubber glove thing so
I am going to enter through the arrivals
from the EU and I can go out somewhere
British because they're still part of
the EU right now despite their attempts
I'm okay I have both the British and
Irish passport so I don't care I can go
in as an American I can go in as you lot
this is the right flag right and I can
go in as a North Korean us why the
hell not so let's go through hello I am
Morten Harket because that was the most
the most famous Norwegian I could think
of when I was in Antwerp I had a is Papa
Smurf the amount of booze I got what I
got their flag wrong and I'm like what
have I done so we have Morten Harket and
we can sign I and I can I can do this
British because that still works hello
Tracy may you're not going to be Prime
Minister for much longer
you may laugh but you're going to deal
with Boris and I try it again and this
time I'm going to be mr. Trump I know
you cannot go through the arrivals from
the EU line because you are not you are
not a member of an EU country you're
probably not even human you are a big
cheeto cheesy Watson person with fake
tans and weird hair yeah I know this is
recorded
I have I have my green card I have it
set up so all I need to do is scan it so
I never talked to any customs agents
it's great so we will take a look at a
little bit of the code behind this
eventually when it saw yes because
that's the only drawback from edge it
doesn't doesn't tell me when edge has
stopped so I have a customs land
requirement I've set my custom lanes up
it's an EU nothing to declare goods to
declare and so I've got a parameterised
requirement and then I've got handler
for that requirement so I can just look
at the country for a person's passport
and then look at the land they're coming
through and for the EU I'm going to say
if you're part of the EU you have
succeeded the requirement everyone can
go through goods to declare it everyone
can go through nothing to declare so the
EU one is interesting because it runs
off to a repository that I'm injecting
into my handler so you can now run off
the databases during an authorization
there's no database here of course
because I'm lazy my repository just has
here so now we go brexit so my database
is changing but my policy is not I run
this again
humpty-dumpty dome so I'm going to enter
again and this time I'm going to say I'm
British and now I can now go through
because Britain has gone through four
exit and I changed my database so we
have a flexible authorization service
where you express absolutely everything
in code and hopefully that removes the
need for you to write your own custom
authorized attributes now that is a
quick run through that it's not a
particularly complicated example you can
do really complicated things I strongly
advise you go through the workshop it's
been written and honed over the last
year and a half I've even taken pull
requests for spelling mistakes but it is
only for authorization please don't ask
me offend occasion questions on that
that workshop because my response will
be this is only for authorization I will
eventually get round to writing an
authentication workshop when someone
asks me to do an authentication workshop
at a conference so requirements are
quite simple you basically implement I
authorize a shim requirement nothing
more there are no methods to implement
there are no properties to implement you
don't have to do anything
I have a parameterised version in my
sample which is nice because it's lazy I
don't have to have multiple requirements
and then you write a handler for your
authorization requirement and it has a
single method which is handle
requirements and you just do what you
want in it if someone has passed your
requirement if the current user has
passed you call context dot succeed and
that's it that's all you have to do and
then you build policies like this in
your add authorization you call options
to add policy you give it a name and
then you add all the requirements that
you want for your policy and their
cumulative so you have to pass every
single requirement and then you register
the handlers for each requirement and
this is being lazy so it's a single
thing that doesn't have any database
access but you can add a scoped or
whatever you like based on
how you're going to write your handler
and then with authorize there is a new
attribute and you just specify your
policy and it runs magically the little
authorization Pixies do stuff and lo and
behold hopefully it works I've done my
demo no way
so the complicated thing that takes
people a little bit to get around is you
know policies are made up of one or more
requirements every single policy must
pass but even if a previous one has
failed we are going to evaluate every
single policy that you have or every
single requirement that you've put in
your policy because you may be logging
stuff your policies are your
requirements may have side effects so
we're going to run every single one we
don't short-circuit and requirements may
have multiple handlers if you've ever
been to a Microsoft Office you will see
people wandering around with badges and
badging themselves in the night so if we
take a microsoft office building entry
requirement there are a few ways to do
it you may have your badge and you tap
it and in you go that is one example of
a handler for that requirement but
another handler may be that you are
wandering around with the temporary
badge of shame which has a really bad
black and white picture of you because
you left your badge at home so that's
another way to fulfill that requirement
so now we have two handlers or you may
be a guest that is being escorted so now
we have three handlers for a single
requirement and if any of those handlers
succeed then that requirement has been
fulfilled just don't forget to register
them in your di system otherwise
everything fails if you think something
should be passing and you've written a
policy you have probably forgotten to
put your handler in di which I do all
the time which is why I don't do these
demos live on stage so we have context
up succeed and that leads to you
automatically thinking we have contacts
that fail and that is true but I don't
want you to use it context succeed is
when your requirement has been fulfilled
but remember if you have
multiple handlers another handler may
have the ability to say context of
succeed so if your individual handler
can't fulfill the requirement do nothing
just return context dot fill is there
for the rare occasions where you want to
short-circuit everything and say no
matter what this needs to stop
so it's like my databases on fire don't
do anything else or David Fowler's made
another security mistake mm in the
ability for 24 hours no will ever let me
away with that so context uh Phil is
just the most severe action possible and
it says even if any other handlers
fulfill the requirements I don't care I
need this to stop so it is that someone
has just been fired option you can also
call this in code you can take an AI
authorization service because we're all
di friendly and then you can call
authorize async and then it failed you
can return a challenge response or do
whatever you want resource based
authorization you're just passing in a
document it's just another parameter so
here we have an authorization Handler
and whereas before it would have the
requirement just the requirement now it
has the requirement and the resource
type that I want to check so here we
have my canonical well I've got a word
document and I look at the owner of the
word document and if the owner is the
same then my requirement has been
fulfilled you can turn on authorization
everywhere with that don't forget to
then say Ally anonymous on your login
page and your logout page and your error
pages otherwise everything gets stuck in
an infinite loop and it's really funny
and like I say you can also limit your
your authentication scheme you can put
it in a policy here rather than just
doing it in the authorized attribute and
you can do things in views you can
actually inject the authorization
service into a view and call authorize a
sync with the policy name in your
you and then hide or show certain things
in your UI some people don't like that
some people think you should do it
beforehand and then pass the appropriate
flags in your view models I'm kind of
agnostic on this I honestly don't care
but if you are checking in views
remember to duplicate the checks and
your controllers because otherwise
someone will just type the darn URL in
and if you've only done the check in
your views they're going to get in which
is what I do to interns every year we
have interns every year and they get to
write some code and then they get told
they're having a security review of
their cousin every single one of them
just does the check in the view they
don't then duplicate it in the
controller behind the scenes so don't do
that
don't be an intern you can have custom
policy providers and yada yada yada
there's bad compact stuff which I've
talked about it's basically getting
protection pieces so you can share
cookies between katana based
applications in asp.net core it's not
really bad compact it's dragging 4.5
forwards to use the new formats and the
new data protection stuff we have some
miscellaneous enhancements all the
encoders are based on safe lists the
encoders are in DI and you can inject
stuff you can make CSRF automatic if you
want um you have to be using very simple
websites for that you can try it see if
it works for you if you're going to use
bearer tokens it's never going to work
for you
but some people like it we've got cores
middleware and we have the environment
stuff which will default to release so
if you have set configuration up that is
based on environment remember that your
default environment is always release
because that way we don't have yellow
screens of death the full actresses on
machines that are exposed to the
internet so that's how to just move
stuff around we have a secret manager
which is basically for development time
only and basically all the way that I
have three minutes which for a European
audience is probably enough to get one
question out of you because it's like
dragging blood out of a stone so
I don't actually mind it's fine I mean
you're not whooping and cheering like
Americans which is the most off-putting
thing ever
does anyone who is not American because
we have a couple sitting down here is
anyone who's not American have a
question wow I was right that's why
that's why I like just blathering for
the entire hour because I'm never going
to get I'm never going to get a question
out of it that's absolutely fine thank
you very much for coming I know that has
been fast please grab the slides from my
website they have all the stuff that
I've said and links to github repos and
issues and the authorization lab by all
means go through it if you have any
problems drop me an email talk about
issues and if you don't think the code
based policies are enough for you please
drop me an email so I can look at
getting it enhanced to cope with your
scenarios thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>