<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Using AWS Lambda and Azure Functions to develop serverless applications - Rajpal Singh Wilkhu | Coder Coacher - Coaching Coders</title><meta content="Using AWS Lambda and Azure Functions to develop serverless applications - Rajpal Singh Wilkhu - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Using AWS Lambda and Azure Functions to develop serverless applications - Rajpal Singh Wilkhu</b></h2><h5 class="post__date">2017-03-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/vecVMhdR-kw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay um yeah let's start so long tail
but so who's this guy so I'm a software
developer like all of you right so you
know like writing software that's why I
do most of my time I'm not the expert on
AWS lambda and as your functions
actually I don't think you can get an
expert in AWS London and your functions
I merely use that as a tool to solve
business problems right and I only use
the bits that I need to solve the
business problems right so there's a lot
more that I think it's going to take
longer than an hour to cover everything
around
it'll be lambda so what I want to kind
of take you through is is my experience
with working these with these two and
why I could kind of work with these two
in a way I mainly work in teams so I
can't take credit for any of these
either so this is basically if you like
it it's quite it goes to my team and in
fact even the demo here I had three
iterations of it it's all credit goes to
my son he was the program manager I I
just wrote the little code runner right
so if it's bad it's my fault
right if it's good it's the team right
so what do I do
I have two jobs actually I write
software for big enterprises who kind of
want to move things to a show and a
double yes mainly primarily AWS and
that's what I do
9:00 to 5:00 and I'm also I've got a
started with a couple of friends we
we've kind of created a platform for
selling wine the little wine little wine
merchants you kind of never hear about
we kind of give them a platform to sell
their wines it's not the wines you buy
at Tesco or Sainsbury's these are like
you know really nice wines and who
doesn't like wine so I mean I got into
that because I just like wine right and
we've got a bit spark kind of in that
program so we use Azure and we are 90
percent toujours 5% Amazon but on the
daily basis I work with Amazon and which
is why I'm kind of doing this because
you actually get to where you know where
I am with these technologies it's not
been smooth right so you know the
documentation tells you one thing and
when you start working with these things
in production it's a different story
whether it's a good choice actually I
wouldn't use anything else for the
problems let's try to solve and I'll
tell you why all right so why I start
with why I mean who went to Ian's talk
yesterday from from the team yeah yeah
so so you know in did a better job then
I'm gonna deal with this I'm gonna take
you and I would recommend you know if
they start recorded watch that that's
you know a brilliant talk I'm gonna go
through my kind of view of things I've
been a developer for a couple years and
I started with this you know but this is
something I drew on a on a piece of
paper with a friend once I've kind of
taken the ddd pill domain-driven design
and I was selling DDT to everybody you
know domain we need to write yeah I was
actually doing DDT right no but I was
preaching it and I kind of I learned
what DDT actually means over to over
time but I remember sitting with him and
and I was like saying I you know you got
DDD's cool and he was going no no F
sharp
I'm sorry doing F sharp efficient as a
couple years ago no one had heard of his
shop said why would you use f sharp and
we started talking about about this and
in domain driven design you've got
something what you call the core domain
that core domain is a bit that
differentiates you from your competitors
is the code that you write that has no
dependencies that says pure C sharp pure
pure businesslike right so this is your
business code domain that you and and
base I'll show you in the next page you
basically had there's a couple of
patterns to make sure that that that
piece of code stays pure that describes
your domain right and then you go all
the other bits and pieces around it that
you know infrastructure services that
you know do other things like you know
integrate with you know repositories
that you know the old-school kind of
patterns right so we talked you drew
this
he drew he can't sell you know what
f-sharp would fit well in the co-domain
because actually it describes your
domain in a more natural way and
actually we sat around Eagers actually
it does you can read F sharp and you can
in maps directly to your domain but the
rest of it doesn't need to be an F sharp
I mean that's not what your customers
pay you money for they pay you make
money mainly for that bit there because
that pay is the bit that differentiates
you from your competitors right this
book is amazing all right so if you get
a chance read it the only thing I would
say is it's back to front
right so the all the cool stuff is at
the end and I would start reading it
from from kind of page chapter 14 and
come back so this is for directly from
from his book right the core domain is
the domain which makes your business
unique and gives you an advantage over
competitors right and you got the
generic subdomain it's still important
right but there's a chance you'll find
in another solution and that's what
companies do they they this is a bit
that open source because you know it's
not something that is interesting for
them as a business yeah it solves the
problem right it's good to open so say
we get developers working or choose
something that's you then contribute to
to that in an open source way very few
people actually open source that middle
bit right and because that is where you
make your money and that's way where you
know you add value but to be honest in
this book he goes put all your
developers to write code on the codomain
the best developers you have put him on
the codomain but what happens in today's
world right you find all the developers
are working on this bits here they're
working solving infrastructure problems
they're solving like bits that don't
really solve the business problem right
and that's what happens in in companies
and his book tours text she talks to you
about not doing that put your developers
way with where the money is in a way
best developers and you know add value
there and you know people don't wonder
why do you don't get the best software
and the problem is that book talks about
that bit there needs you to talk to
to a customers and you know that's
that's a challenge as well right so
keeping that mind that kind of was the
first time I actually thought about like
domain-driven design what's important
what code should I be writing yes should
I be spending more time doing that right
and then back to f-sharp and function
programming yeah function programming
yeah it's based on kind of data coming
in they're coming up in mentioned this
yesterday it was adaptors and was
opposed in adapters and it obvious
lambda functions are like that to me
right it's like almost functional
programming kind of the the higher-level
right so you write a couple of functions
and you tie them up together using bits
that you you really care about what's in
those functions what you write is more
important to you as a business that
makes sense and the bits that you don't
write you let someone else write them
right I mean you don't camera so to
really appreciate I think you've got to
go through this journey I mean if you
haven't built monoliths haven't kind of
worked with infrastructure-as-a-service
and trying to write you know terraform
souls bits and pieces these days right
platform ation you know writing as your
resource templates to basically just
spin up a machine you know am managing
am eyes right that's a lot of pain you
have to go through to get your code to
actually work in in the cloud right and
you I think you've got to go through
this setting up deploy entire pipeline
how do I get my code on that machine
that I've kind of spun up if yes is
immutable right but how do you get
getting on that machine and run it I've
got to solve that and then I've got
monitor - pose to figure out you know
what happened with the infrastructure
and then I've been working worried about
costs why am i cost I need three
machines on each because I need H a
right and then you fall into this this
whole problem of like you know you got
like a base set of machines and you go
and you got to keep it all running right
that's that's where you spend your time
most most of time actually
however you may get function fever after
playing with a double yes you know and
the whole kind of lambda Atreus lambda
and the Jo functions does not solve
every type of problem right so even this
even though I'm gonna be talking about
server less in this session it doesn't
solve everything
so Baco comm that site is not really a
server less can is ecommerce platform we
need server side rendering progressive
enhancement there's no way I believe
I mean at this point in time I'll be
moving that to to service in a way but
everything behind it is service right so
let's talk about how right um so I'm
gonna I'm gonna use something called a
service framework so a tips lambda is
really good this is where Microsoft I
think are slightly better than a SS in a
way they give you tools you know
Microsoft's very good at giving VG
studio AWS give you lots of robots and
then someone else kind of adds the bits
together to make it gel together so what
I'm gonna do is I will give you a hello
world demo and I'm not doing this I'm
trying to do this demo for for to show
you something else actually in a way so
I'm gonna use service so they already
install service I'm gonna do so let's
create and stop there let's see what
that sports so I can actually write
service applications in any of these
languages so I'm going to choose nodejs
because it's be quick right and I'm
gonna add s minus F and minus sorry
minus t minus P quick what suppose be
quick
um and that will basically generate a
template for me if I look in this
directory
I have two files
and I have something called a service
llamo that just describes I'll go
through this later on this is not the
point of this demo I just want to give
you a quick taster
that gives you tells me you know I'm
gonna run a double yes and it has some
some bits that I can actually change and
it's got one function called the hello
if I look at the hello handler a handler
sorry
that is my function and I change it
slightly and console.log quick okay and
I can now deploy this so if I do server
less deploy too much coffee so that is
actually deploy my code in a double yes
let's look at what's happening where is
it I had this all set
now it's back here so what's happening
is if I go to the lambda screen it's
actually creating a stack platform ation
why do lambdas do demos go so quick diff
and as part of that I get lambda right
which is called quick death and you see
it's not yet created come on wakey-wakey
okay we should see a new lambda in there
I've kind of preset a demo here I'll go
through in more detail but while that
comes up and should be quicker than that
the joy of demos okay we'll come back
let's go back to our presentation and
come back to this right so when that
comes back right we're gonna play with
it a bit but the point of this demo was
that actually I've got in ten lines of
code all that for free so my hello world
is the most scalable hello world ever
right well in this world I've got high
availability across three availability
zones I can have hundred concurrent
quests right to that hello world app
it's a soft limit I've got free logging
I'll show you come monitoring and
alerting right
I've got DDoS protection no one can hack
me right which they can but you'd be a
you know they have to get past Amazon
I've got entick ation for free
I've got configuration through
environment variables and that was
supposed to be really quick but you know
when it comes to a demo things do go
slow I don't know why it's something oh
so that's it it's deployed right so it's
kind of deployed a function if I go into
the console here refresh
I should see quick dev hello right and I
that's my code day right I can't have
configure it give it more memory you
know dead letter Q if it fails I can
configure that so V PC I can add
triggers so I can say you know and talk
about this bit more I want any of these
to call it if you know based on how they
work I don't go more into more detail
around that and I've got monitoring you
know out of the box right so also I have
logging so I'm gonna do one thing so I'm
gonna call this invoke right - f hello
right so that calls my lambda and
returns errands in AWS and returns or
the response that it wasn't forget to do
it if I do invoke local this invokes the
lambda in memory not on in Amazon and
basically I can test it locally so that
is my hello and if I do serverless logs
- f hello and that will show me the
cloud watch logs as part of that
deployment so I get all that for free if
I do server less I can roll back so I
can find out more information query I
can deploy list if I had multiple
versions time stamps them right and I
can roll back from the command line so
it's all one-liners right so I've
actually got almost like a deployment
pipeline
well it's bitten bit of automation I can
deploy that that's not the exciting part
of my presentation by the way I was just
to show you that I get all this with ten
lines of code right as your resource
manager is different so functions are
different so
this is I think this this is kind of a
when you set this up it's the first clue
as to what the differences are and it's
not bad it's just different as your
resource manager is more about having an
application and within the application
functions run yeah so whereas a lambda
AWS lambda is completely free you know
it's just single you know no
dependencies that's what as soon as you
actually has a concept of an application
with functions in it right so you've got
to basically create the application
resource use the application resource
manager and deploy that so what have
what the application resource manager
does so all this code by the way the
demos and everything here is on on
github I'll send this run it looks like
that right it's like a bit of like cloud
formation in JSON right so some kind of
you know parameters some resources
there's my my storage this is my kind of
application plan I've chosen dynamic
dynamic means spin off a container but
when I need it right and then you know
I've got my function and all this
configuration I can deploy this fire
powershell but what I've done is I've
given you a little link here that gets
you to log into Shore and once you image
or you can fill in the blanks and it
will create you an app template now
after you create this this bit of
PowerShell to run and since I have an
hour right I'm you can do this like
actually you know what
that's all pointed the demo let's let's
look at something that's created so that
templates gonna create you some storage
storage for the functions storage for
for what I need and your functions right
in here your function up lives so you
can see that you're up here right has a
set of punk functions when it comes up
thank you I feel like as if the the
wired connection is slower than the
wireless yeah so the function
settings as you can see are for the
whole app right so when I specify
environment variables anything that's
for the whole app and it cross all the
functions whereas in e ries lambda it is
per lambda it lives on its own right
that's the big major difference it's not
bad I think the good points to both and
yeah we will we'll go through a bit more
in detail as we go through my demo so
there are two models
you've got the consumption dynamic which
is equivalent to AWS lambda works
exactly the same and you got a classic
model where you know things just run
they're like almost easy two containers
that you know spin up and run you can
use them for long running tasks you
can't do that in lambda at the moment
right so lambda only runs maximum 5
minutes right so I thought what I do and
this is a this is the idea I had of
though I wrote this demo three times at
three different stories so I came up
with this story and this is more
realistic this is a problem I we have on
backhoe
so if I go to bucket or come by the way
we drink more wine than actually sell so
so if you go to give it to the site you
see that you know we miss it it's not
these these are not missing images
they're really bad right you look at
that bottle of wine that's 5100 pound
right and look at the image right and
the details there's not much there and
it's mainly because right we rely on our
merchants to upload the images so there
are good quality sometimes they don't
contain a bottle wine they actually
contain something nice interesting right
and the images do not always contain the
bottle of wine being sold which is even
worse I think you know like some
deliberate mistake in a way good images
can be overwritten so if we get data
from one merchant that wine and it's a
good image the next time we go to
different merchants he can upload an
image and it overwrites the good one
right so we get images like that which
has a background it's not very nice I
mean that's actually cool not too bad
right
so I thought let's let's kind of solve
this right
it's a real problem and I think land is
pretty good for this so and I'm actually
gonna use lambda amateur to solve this
because Baco is in Azure and maybe
because I wanted to give you some code
to actually that shows both sides of the
thing so there's a new service Amazon
recognition that looks at a picture and
tells you with some certainty what's in
that picture it's really cheap you know
it's one dollar four million images we
don't have that many right and eighty
you know dollars so I mean I could write
something from scratch but it's never
gonna be as good as Amazon Prime
this is what Amazon Prime photos kind of
used behind the scenes what why just
kind of just use that right so I thought
let me pick that up right and call that
but that was solved the problem way you
know the image doesn't contain a wine
ball ball of wine right it might be red
wine white wine this should tell me the
other problem I have is like you know I
don't know whether it's the right wine
so there is this max of cockney services
that can read labels of text of images I
thought and wine bottles if you notice
the in the test is never the same I'm
the bottle the same you know everyone
bought looks very similar but the labels
never the same and the text is always
sometimes vertical you know and I need
to solve that and could be in any
language and this thing works really
well so the core set of engineers whose
full-time job is to write that and it's
quite cheap you know
one dollar fifty five thousand free
calls I don't need more than that so I
can get it for free I can get both for
free that on a free tier I don't have to
pay for anything that I don't have to
pay for anything for what I need so it
could work like that so we have a
merchant up the merchant uploads is code
to you know something storage somehow
through a web application we could pull
or we could send a message to a to
something that picks
up goes to Amazon recognition right
finds out if it's a one-ball and says
okay I find if it's a point ball I know
it's one ball maybe I can get the next
bit to read what it is what wine is it
so picking the next thing picks it up
goes to kagu services and says yeah okay
fine
I read the label it is the wine that I
think it is or you know and I'm gonna
forward it on through the first step I
know the quality of that image I also
know it's a ball
second step tells me what wine it is and
then the third bit can take it and
forward it to barcode calm which is in a
job and also notify me why a slack so I
thought yeah let me let me try and solve
that so I thought I'll pick no Jess just
because I kind of have a I feel you know
I am more productive in know Jess these
days I've kind of doctor like the this
functional style of JavaScript it's
quite nice it's easy its quick to test
you know you don't need fancy editors so
I pick no jess C sharp is also supported
I don't write Java so this is what a
traditional solution would look like so
I thought yeah I can have you know a web
server that can post stuff to rice to
some storage I'll choose s3 I'll be nice
and send a message to a queue right and
then that guy there the worker can pour
and do all those bits right it's not
very micro services right so basically
that can just pull and do the rest of it
this is kind of nice easy solution for a
start-up that's fine
I thought you know what let's let's try
Micra services within that model but if
you look at that right even this I need
an order scaling group three machines or
scaling group of single machine yeah
this is good practice from Amazon right
I need to set that up
I need machines right I need to put the
code on there I need logging monitoring
CI you know and I need to main manage
the a.m. eyes and if I can't use
Beanstalk that's the most efficient but
that's service again right so this is
kind of the motor
right the service types this this model
I'm as a recognition yeah split each
piece does its own bit right and then
forwards it on
I have cues between each one that manage
you know if I can pull look for work and
then do the next bit that works quite
well that can work but the whole point
of this is to to serve lists and then I
need to consider all that right you know
if I was doing you know for a startup
right lock services lock shipping agents
I've got to put you know agents on the
boxes to ship the logs warranting
services code deploy deployments lots
are gonna worry about that unless you're
a security authentication I need
identity server maybe yeah ok fine I'll
do that right but I thought the whole
idea is to use serverless so this is I
didn't come up with this by actually I
started outside in right with with this
model and I kind of ended up with this
so the journey to get to this is not you
know one step it's it's a couple of
iterations right so my first problem is
to create a website so I took a bit of I
decided to choose single page app hosted
is three that's enough for me I don't
really need a web server right so it's a
static site the JavaScript runs in the
browser
I just basically host your next three
build it host it right then I need s3 to
upload my images to but to upload to s3
I can open it up but I want to be a bit
obscure so what I'll do I'll write a
little service that can I walk yeah that
all it does right is that guy there it
goes to a3 and creates a signed URL that
allows me to upload that image within a
certain time right so all it's going to
do is I'm going to call it it's going to
return a URL that allows me to upload
the image that's the specific image in a
secure way that's good that's good
pattern and that's a service pattern to
use by the way to over upload things I
thought let me do a bit of bonus and
write a get that goes through your three
and returns a list so that you know the
merchants happy can see what is upload
that's a bonus then this is where it
gets exciting right it's when I upload
the image to s3 I don't have to write
anything that holds s3 or does anything
with s3 I can write a lambda that gets
triggered when that image is written to
s3 so when I write the image to s3 that
lambda gets called and I lambda its job
is to go to Amazon recognition right and
ask about the labels and if it's a valid
a label if it's a ball it's gonna send a
message to SNS right here's the valid
image it's gonna get all the bits it
needs the labels is there wine ball is a
red wine is a white wine and it's gonna
tag the s3 right so object so I don't
need a database in fact I thought I
don't know I'm gonna try and defer using
a database so what I'm going to do is to
actually add the data I'll just add the
data to the metadata of the object so
I've got a tagger that adds data to s3
and I've got another subscriber to them
to the publish/subscribe that says if
it's a ball yeah 42 sure so that's going
to go to Baku comm right and when
bakkoto come in as oh I've got as your
functions that do the same thing so to
upload that image I've got a same
pattern I've got to get a signed URL
from the blob container I can open it up
but it's not secure so Alaska's your
give me a sign I signed Europe then I'm
going to approve the get my lambda AWS
lambda - right - the blob container
right using that signed URL so it's all
HTTP right and that is gonna trigger off
my as your function to go to Cognito
right and then find out what's on that
label right so let's look at the code so
I apologize right I mean in advance like
I'm you know coding wise right you know
I try my best right so let's look at
some code actually you know what github
is better much better to look at code
right so let's
let's look at I thought I'd get up open
oh yeah because I went to Joe it's me 20
years ago right so this is the code I've
ended up with so under merchants is the
merchants up I have a website it's react
based right there's nothing much in
there all it does is and I'll show you
why does it it just creates a list and
shows what's in s3 and the tags on those
objects the exciting bit comes in here
I've got the upload and in the uploads
if I go to service civilized or mo what
I've done in here is kind of said what
permissions I need to give that lambda
right I also have two functions right
that signed URL creator and I have a
list uploads lambda all it is is an HTTP
ilysm to http event right and run some
code and return some somebody some Jason
the other one is another HTTP endpoint
right and returns some other JSON that
talks to s3 right so let's look at that
function right we only go through every
function right by the way there's not
many so sign you are a generator well
that does is that that's how much code
there is right all that's gonna do is
talk to a3 give me and give me your URL
right I don't have to write a lot of
HTTP you know translation or anything
that's all defined within templates or
within you know that the translation
layer I can just return there right and
you see more of that as through my
presentation this is a bit more involved
this does a bit more because it gets the
tags out so it gets the list of objects
and for each one I can't do it in one
call it returns the tags on it and then
decorates that object and returns that
so that's my list right so that's
uploads let's look at one more which is
within the
scanner and in the scanner I have three
handlers right so one scans the image
one tags the image and the other one
scans the label which only does it
forwards it to Azure which is the
coordinated services right actually I'm
gonna drive it through here so if you
look at one of these functions let's
look at the one that actually goes to
recognition that's it all I do for
recognition is tell you where the images
in the bucket and I call out that's
that's all the code I have in each lamda
there's there's only like 20 lines
I mean the less code you write the more
code you write you move work bugs you're
gonna write there's not many bugs you
could put in that code dead right you
might find some by the ways but so this
is not a lot and if I look at here's
your side of it
right so as yours a bit tricky because a
Java enforces a folder structure on you
right
so when I go in I knew all my functions
at the top so I've got the create sign
blob you all right right and that is
very similar to the the AWS one right so
let's look at that
okay so the handler is that all it does
is you know returns data that comes from
this guy here and what does this code
look like that's it
20 lines of code blob service give me
something that returns I don't have to
write anything track translates anything
all the translation in the is done in
the JSON file all I say is you know this
is HP trigger in right out I'm going to
return some console out or return some
object that's default your function will
convert that into HTTP response and
that's how functions work it doesn't
matter
I mean like in terms of I I can write
something today that listens to an SNS
event right and actually that might work
for sqs no I won't forgive or first yes
there's no problem there work for
Canisius right and with a bit of changes
they can work for sqs right so you know
you can I can swap the triggers okay so
should we see this working right so
if I go into the code all right always
going to deploy this but I'm gonna run
it and then we go with if we got time
we'll deploy it into a different region
okay
the same code base so NDC London and
I've got a gulp local task here that all
it does it spins up the UI locally but
this is pointing to a double yes I
should have cleared the bucket actually
let me do that this is me testing before
so in the s3 bucket and you already see
a bottle there actually you know yeah
yeah I'm gonna just clear the bucket
right okay let's go back to my demo
open up here will refresh that shouldn't
have anything ok so this is I'm a
fantastic UI developer another you're
really a guy is gonna think what's
what's going on in here I'm not a UI you
know developer so what I did was to plug
in a kind of some HTML and something
that allows me to upload some images so
I am gonna find my images in here and I
have three I'll go to wine bottles and a
banana right so I'm gonna upload the
wine that you saw in the end and that's
uploaded what's that's queering s3 so
that means actually it made itself to s3
if i refresh this right you see it's an
s3 oh I've got it running Rainwood
another window sorry that's running
that's why you see that error okay so if
I go into my what happened there right
so if I go into my merchants folder I go
into my uploads right and I run so less
let's catch service
I've got two let's look at one of them
right so server less logs right minus F
signed you are I creator and I need to
give it a stage this is my of course
this pain on myself
actually this stage you don't really
need that an actor's me the logs and it
shows you that I create a signed URL you
can monitoring's all setup logins all
set up so what happened there so if I go
to slack I see nothing
and this is the the beauty of it all
right so nothing is like okay so let's
troubleshoot that right so we can go
into scanner and we can see that serve
cut service so something's gone wrong
right if i refresh this i should see the
tags on it so yeah so the tags are there
what that means is amazon recognition
kind of said that is a bottle it's an
alcohol you know it's red wine so that
all that data comes from amazon
recognition and it's not going forward
it shows your so something and by the
way this is i was expecting us right so
in cat serverless and i want to show you
something else right so all that's gonna
do I've got three lambdas in here and
once the label scanner and that's
forwards it so let's do server less logs
minus F labels I can't type all of a
sudden and Stasia - region
give me logs
okay so that said something like
successfully received signed blob
request that's not what I wanted
oh yeah so yeah it does
so it says successful receipt signed
blob requests from a Joe and then
successfully wrote to Azure blob storage
so what's happened on the show oh there
is actually it just takes a bit of time
so this is one of the things I'm gonna
talk about so lambdas go to sleep there
it's called co-star right and so does
your functions you've got to keep them
awake right so what will happen I
deployed and that lambda went to sleep
there are tricks to keeping it to wake
I'll talk more about that but what hap
it's come back with a bottle of wine a
pillow uploaded it and it's it's
actually read the text so work and gran
reserva is what that ball comes off the
ball right let me upload another one
since the lambdas warm it should be
quicker right so it should go off to
recognition and he gets the tags and in
slack i should see the new one right
they go so Rubina and it's red Rioja or
vena 2006 let's try a banana so I'm
gonna try banana right
I'm cold this is this is Amazon right so
yeah I'm just showing off what they've
kind of done right so that should hit
yeah it tells me it's a banana fruit and
if I look at the logs you'll see that
what it does is it won't forward it on
to your right so I kind of if a merchant
uploads a banana that's not what that
looks should say so that's the lost log
find a bottle fail to find a bottle
right and banana poor PNG right yeah so
it works right
and there's a couple lessons here right
so let me
talk about a bit more about a dose
lambda and and and kind of go deeper
into into this right so how much time do
you have
yeah so Italy's lambdas are all of our
functions events right you can have
multiple event sources like which we saw
SNS we saw kind of a kind of HTTP events
sources right that's API gateway in the
mix and you have two types you have
asynchronous and synchronous and it's
really important to understand the two
because the reason I want I was hoping
that is your one would fail is because
my lambda would have failed right and it
didn't unfortunately just took longer
than he should I put a real low timeout
and what I wanted to demonstrate is that
if my lambda failed I sure I mean a
double yes would automatically retry so
a double yes we'll try it retry three
times if it fails I can say you know put
into a Delia queue and that's I don't
have to write a code either right
so I all the retry logic is built in
writing into del ik q is built-in right
I don't have to write that and I was
hoping to show you that actually it was
really quick this time
um well quickish synchronous the HTTP
kognito they don't retry so if it's an
HTTP request you get response there's no
retries that's it done right and they
behave differently as well so if you got
streams and the mapping is different and
it's important to know this because when
you when you send a message through SNS
and you get a message through to your
system you'll retry three times right go
to Ted like you when if Kinesis Canisius
is batch it will retry for 24 hours so
you basically have in hammer your lambda
until like you know it works so you got
a kind of almost code for the scenarios
right you gotta understand the different
events as your functions are lambdas
plus bindings right so you go functions
your triggers and bindings you can
actually in in lambda you know what my
first diagram I talked about like
codomain
your infrastructure code and lambda you
do because your output is not is it's
not magic right it's like you still have
to write to s3 but within a sure it has
an input and output binding I can say I
just output and I want that output in my
Jason to go to table storage I don't
have to write the code that says put
this Jason into table storage I just
define it that means I can actually turn
that output into anything else right so
it's like you know it's all defined
within the Jason right there's no limit
to number of bindings right however you
can only have one event source in in
Azure
so each as your functions can only talk
to one trigger can only have one trigger
inedibly a set lambda you can have
multiple triggers on the same lambda so
you can have Canisius drive the same
thing as s3 or SNS drive the same thing
as well that was the structure we went
through sure all the code is in one
place and you can actually run this
yourself right so all that should work
and if it doesn't send me a message and
I'll you know or pull requests let me
know if it doesn't definitely because
I'll make sure that this works the dam
was done so what do I get for free
I get H AI get multiple a Z's all that
stuff so we'll stay up right I get auto
scaling if I my you know back o does
really well and we sell more wine than
we drink right then basic I'll have kind
of we know we we will scale up right
I guess security API keys I can extend
it to do open ID connect tokens so you
know if I if I could go to functions
let's say I've done enough for lambda
let me give you a function demo so I can
go to as your app start and I can say
configure authentic thank you configure
authentication and basically I can
choose from here Facebook Google Twitter
and you know any any of these providers
out of the box it's simple as that I
mean I don't have to write that code
either in alias lambda you have to
unauthorized function and actually
there's many templates for that as well
and actually there's built-in ones for
Cognito right very similar lambda so
authentication is so it is talking
token-based authentication everything
forces you towards doing things in the
right way in my opinion right
you know token-based authentication you
know little short-lived functions
looking monitoring alerting deployment
pipeline you can actually can connect
that to circle Y Amal and there is one
in there and then basically dota mate
that deployment I just work I get s3
durable storage you know that's thus
given right norm is to manage no servers
no database to worry about no complex
code to maintain right
I just rely on Amazon and Microsoft to
write the code for me and the retries
are built-in right and I can have jet
like you so I don't lose anything and
it's all pay-as-you-go I'm not going to
talk about costs because everyone talks
about cost in lambda right it's not the
main thing yeah it does kind of work I
mean cost savings the real cost savings
from lambda are not when it runs it's
when it's not running if that makes
sense so if you got lambda that you know
if my merchants are going to upload you
know ten images per day I'm only gonna
get billed for the ten images I don't
have something running for 24/7 that I'm
getting billed for right that's the
difference but if I now my merchants
grow to such an extent are they
continuously uploading images then I've
got a rethink lambda might not be cheap
right and you can see it in this table
the whole point is table is like you
know if I have more and more requests
coming in and longer longer requests it
gets to a point where you know ec2 might
be cheaper right and yeah
- maintenance costs but it might be that
you know lambdas not the right solution
for that okay there's some cost a glaze
I'm not gonna go through this here you
can put a million lambda calls and it
cost like 80 pens some nice it's it's
ridiculous so is cheap and so this
functions
some will talk about testing a bit more
you got to treat your handlers so if I
if I show you one of those handlers
again apologies for going back and forth
there so that's my code in in in in the
handler most of my code is is not in the
handler my handler doesn't do very much
it's almost like a MVC controller right
it translates kind of the handler world
into kind of pure JavaScript world and
it's the same for sheezy shop and it's
recommended I think you should actually
code in that way regardless and you know
portability I could actually put these
functions across as your and a double
yes right that's the the last thing
about that is in terms of like they will
just work with little work and it goes
back to my first diagram your customers
don't care whether you're an AWS or
lambda they're not gonna say I'm gonna
buy that bottle of wine because they're
on a Joe right it doesn't matter and it
doesn't matter if you're you know using
the best of each either right so you can
test everything in memory so since
everything is input input and if you in
your can in your lambdas if you are
really gonna integrate with our area
services there's things you can spin up
in memory you can spin up elasticsearch
in memory and test that to be honest
it's so cheap I can just spin up another
count and test everything in there it
doesn't cost anything
I mean lambda you have to call it
million times the millions and one per
month is gonna cost you the money the
first million is free right so whatever
I just create a new account and test
everything in there right it doesn't
cost money and smooth I do nice poked
smoke tests
I mentioned that lambdas go to sleep is
a good good idea to have a health check
that checks the permissions and at the
same time I can use route 53 health
checks to keep my lambda awake so that's
one way of keeping a lambda so unit
tests actually look like functional
tests your deployment pipeline then
looks like this
build a pull request here you do the
eslint you do your unit test some unit
tests you can do that in the test you
can spin everything in memory right test
everything in memory deploy to dev
environment that's cheap test things
again run acceptance tests on tests and
then promote to other environments yeah
so you can you can do a lot more in the
pipeline in terms of in memory tests and
the jury is a bit different so azure
doesn't support diplomas anyone who who
here works with a job by the way
yeah so as your functions don't do
deployment slots it does exist at the
moment so one way to work with as your
is to actually have two service plans
right so I created one beforehand you
cannot create create another one that
points to your get up a different branch
and you can actually deploy that branch
test everything and then promote it to
master
it's bit weird it's it's a well I think
they're gonna solve it with deployments
loss it's it's coming and since you have
smaller functions you can test
everything image in memory as well for a
job right because the output bindings
input bindings have no knowledge of what
you know it's bound to right logging in
monitoring in an area with lambda I
showed you a kind of the hello world I
log to console out and it appeared in
cloud watch as your functions very
similar you have log to the context very
similar
you got cloud watch for login monitoring
on Arabs lambda and you have app
insights on on as your functions this
might work for a lot of people but we
tend to do this in in production where
you've got cloud watch we we have of two
plugins that run that install on the
locks such instances that grab cloud
watch logs and cloud watch metrics and
push them into cabana and there is
there's Griffin I integration built-in
for cloud watch we tend to use these
because it gives us the flexibility to
create dashboards go stuff running on
some of the servers that will work out
you know alerting
last Alert functions as well if you go
to this URL from Azure
it shows you how you can push some of
this into ELQ as well so all you as your
data can go into ELQ into one place so
you can monitor your whole whole AWS you
know is your environment from one place
so but these are service right I mean
you can use the ELQ kind of setup you
got built in in AWS but you really
service and my point in this
presentation is like lambda it's
functions solve some things for you
you still do need service and in those
cases they still run on servers
it's abstracted away right but you know
you don't need as many servers so you
might pick decide to do identity server
rather than you know use kognito or you
know any of that it's a server right you
still do two hosting but it's not as
many so tips on writing is that
duplicated kind of yeah so treat your
handler as you treat a controller you
need to save messages as stubs so if I
look if you look in the repo and this
London you see messages folder here
merchants messages and in here I've got
some messages I used to test so these
are very useful so that's an s3 event
that comes in and I save these so I can
replay them so I can call server let's
invoke local invoke the lambda locally
on my box with the event as it would
come from s3 and test my lambda I can
attach a debugger to it I can step
through it all that just works use a
functional style
I mean promises ideally your lambda
should read quite nice
there won't be shouldn't be a lot of
code in there right I kind of prefer the
promises functional style the Maps and
what JavaScript gives you that's es6 use
F sharp if you know if you
that's your preference keep dependencies
to minimum so the more dependencies you
include the bigger the zip file gets
right in lambda Asher has no zip file so
Asher when you push a function we'll
build it on the Box lambdas don't get
built on the box right so there's a
difference there so but there's a
there's a tax you pay if your if it's
your spins on your container or you know
Amazon spins I container it takes a some
time to spin it up again right and the
more dependencies you have the bigger
gets those keep them small and don't run
big functions you can run them on as
your there's a plus and this should just
do one thing all right how much time do
you have six minutes okay and use
messaging for cross function
communication it's easy it's not like
you've gotten throughs introduced
libraries to do that it just works out
of the box
everything is stateless and you should
follow that model you can't write
anything to disk because you might not
have it you can't write anything to
memory because you want to have it so
nothing is guaranteed your function gets
invoked from scratch it gets a message
it gets a message out right right
defensive code one two days ago I was
writing this code and I did a deployment
and basically while the function is your
function was being deployed I did handle
the error really well and I lost a
message so and that was I fixed that but
ideally you don't want to be in that
position either
and leverage dead-letter poison keys
when you're you doing something like SNS
definitely use that
if using Kinesis write or streams or
even image or leverage your own Delic
use don't let you know the retry logic
on those things because you don't have
any control kind of determine you know
how things gonna be retried and
everything is via variant variables if
you look at the code base I'm going into
this detail everything comes via
environment variables into the functions
and then it's pushed to two
or your functions um so I'm gonna go
through gotchas there's a whole list
here right these all my learnings and
some some you know just so the whole
point of these is not to give you a
whole list of to tell you that these are
the problems with lambdas I faced and it
might be unique with you but it's also
some of these problems that are quite
nice in a way that it forces you to
think in a way right so it forces you to
write stateless function it forces you
to write really small functions if the
forces try functions that execute really
quick so you know I've got solutions for
these we've kind of worked these out but
in in in most cases like you know no SPO
for Q's
there's no Q's before it is lambda
you've got to wake up and trigger a
lambda there's a friend of mine yang Kui
who is written an article how you can
write write recursive lambda and that's
another lesson if you call a lambda
recursively for the whole month
calling itself it costs like two dollars
right it's it's it's unbelievable it's
still cheaper than an ec2 instance API
gateways of support you know self-care
manages is missing so everything in
areas you get an SSL certificate
matically here you've got to basically
work it out this is all coming by the
way this is one thing about AWS and as
your functions things change right and
you might Coates for something now
actually this this poit going forwards
but there's always workarounds right
there's deployment limits it's a good
thing she tells you to clean things up
there's a max duration 300 seconds you
can't set it more than that if your
lambdas doing more than five minutes of
work you go think what why use using a
lambda right maybe you shouldn't be
right there are timeout restrictions if
your code still running and lambda
terminates it right it will still run in
the background
no this single threaded right if it uses
is the same container so you got to
think about some of these things soft
limits you'll hit a lot these and I do
and these are there to protect you I can
I can send I have broken these I've sent
like hundred requests in parallel to
lambda and 101 fails and actually
that's a protection in itself because
actually it's gonna cost me money I've
got to think what am i doing that right
and then have a conversation with a
double yes actually they just the the
turn run to change this is like you know
15 20 minutes
running out of vbc and ice this is when
you're in a certain scenario where
you're running the lambda in a V BC it
can actually take up all your network
interfaces so you've got to think about
how you construct your V PC to support
lambda right it's it can actually take
over if you scale out it will take over
you all your IP addresses and it won't
cycle them because it code it freezes
them your network interfaces are
reserved and you can't see there's no
way of seeing that numbers kind of black
box right authorizers are not easy to
write this is you know if you do open ID
connect or if you doing some customer
authentication but there's a lot of
examples users to plans so you can
actually say this API are only support
you know throttling for this customer
for a thousand two thousand for this
customer it's there but it doesn't work
that well retries may seem like magic
sometimes it just retries forever like
Kinesis right and you go think about it
used Delia queues if you can write and
actually this is another limitation you
can only send six Meg to a lambda
actually that's another lesson why would
you send more than that right the trick
here is to write to s3 and then
basically send it the path from s 3 and
do do that way as your functions has
similar things right there's no support
for deploying swaps there's no
versioning so when you push this sure
there's no way to see versioning the
only way to actually roll back is to
push again your latest code or something
from get you gotta rely on get for that
whereas lambda you can roll back its
windows it's not a problem if you're
doing C sharp F sharp but with no Jess
when you have got NPM and you got big
directory paths we've faced problems but
actually that's the problem in no Jess
and Windows and it's been fixed in kind
of some versions not all version so
you'll choose your nodejs version
the tools only work on windows I didn't
do a demo of noise oh I was trying to
keep this short almost there so and you
got only 10 concurrent instances that's
instance is not instances of your
functions by the way so there are
limitations in a jaw but the scaling is
you can scale right so your source is
deployed not bill artifacts in the jaw
in lambda you push up the zip your
artifacts are deployed and that was
that's what runs in as your it should
get up it connects to it pulls the code
builds it on the box and then runs it
right so here's the difference
and then enforces a folder structure and
you have to live with it right and
there's one trigger per function okay so
there's some good things about it in
memory tests rely on it right there's
lots of tools you know logging in
monetary czar the tool but you know
there's options as well that's it so
this is my last slide by the way so this
is the one of the lessons I kind of
learned from this exercise focus on the
domain right be lean in terms of delay
why do you need a database so in terms
of the last project I was on the
customer one is something you know
really quick to demo something on s3
gave them a demo in like a very short
time you know to spin up a machine and
put stuff there that it works really
well in that scenario actually that
decision stuck we've never actually
taken that code out of s3 and put it on
a machine actually works really well and
in in in Baku comm we wanted to manage
the categories of wines and we thought
you know we need a back-end application
we'll choose irelia we'll write a server
to manage it right and then you know we
can a database we need all that in the
end we put it into Google sheets right
we put permissions around Google Gucci's
who can edit them actually and we got
sync between google sheets and the
website that was it
that's our management app it's Google
sheets and it works it just solves the
problem and we're delaying some of the
decisions till later we don't need a
fancy solution
it just works and actually simple
solutions actually work a lot better
leverage cloud services you know in
terms of this is
no I mean well 20 years ago I used to
write I used to love right in that kind
of code you know where you know you're
writing infrastructure code you there's
a point where you think actually you
know is it worth it
why don't I just you know like identity
server I you know I've done a couple of
talks on Irene server I love I didn't
server but actually it's just quicker
for for me to pick a Cognito or ad to
solve that problem and identity serve of
to solve some problems right so I won't
jump to it I would use it but there are
some scenarios I would choose this or
that over yeah so it's not it's not all
the same right rely on event sources to
invoke your code don't you know don't
look use a timer you rely on that
because these are more reliable like I
can I've never had these failed on me by
the way use messaging cues between
functions don't call functions from one
another function you can do that but
don't do it and build thick clients and
thin stateless battens only in some
cases so for e-commerce website that
doesn't work right ecommerce website use
progressive announcement and preset roof
racing do you think I say questions
thank you very much
sorry I'm I think a minute performance
over sorry
any questions around this sure so you
can write and we do that in some cases
for CI tasks so we don't use functions
just to do to do kind of you know the
app itself but in CI we have some bits
that we leverage AWS lambda because we
run things within a V PC and we tend to
use call functions from a function the
recursive function is a quite neat idea
where you can either either wake up a
lambda every minute right to do
something or you can do something and
call itself right which will do the next
bit I call itself and if you did that
for a whole month right it's still
cheaper than having a machine do it
right so that's an example right make
does that help you can yes what I'm
doing what I did locally with servants
of let's look local was actually calling
the lambda from my box directly a
non-local so these civilus invoke one is
the local I'm calling the lambda in a
double yes and returning the the
interface between lambda and anything
else is still HTTP and it's always a
post so even if you do a get to API
gateway it translates that to a post to
lambda right it still kind of spins it
up calls calls it and then returns a get
request and now you can cache that and
do all that yeah hey
I have a webapp 20 and toys
yes so this is the case so there is a
there is a scenario like this is why I
mentioned like become the main website
is an e-commerce website it is I
wouldn't see that translate to the to
the lambda world because I want to
progressively you know provide that
experience of progressing enhancing the
the the website on the machine so on the
template right though a plain website
and make it richer on the box so I want
server-side templating but for a in a
back-end app where you know I manage
things like you know I can leverage
irelia react to to do the crud pieces
right so then there's not a lot there to
do there's only a certain set of API
endpoints that manage certain things
right it makes sense I mean in terms of
like the you got to think what the
balance is right I would jump directly
to to API gateway lambda right so in
that case right they are if you if you
go on to AWS lambda and the patterns
there is no js' Express if your
application is no just Express you can
move this way of hosting Express and
moving to area based lambda C sharp
world not easy right but if you look at
in the in the repo for c-sharp so it'll
API get way now suppose C sharp now API
gateway can call you a win pipeline so
you can host your c-sharp code in a web
api and you can host it in api gateway
right so you can actually do both if
you're using the owen pipeline</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>