<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Build Your Own Azure - Mark Rendle | Coder Coacher - Coaching Coders</title><meta content="Build Your Own Azure - Mark Rendle - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Build Your Own Azure - Mark Rendle</b></h2><h5 class="post__date">2017-03-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/vIg_rrAxulo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">blimey that's loud
good morning everyone all right stay
hands up if you've got a hangover well
you obviously yeah
so welcome to build your own Azir which
is honestly no we're not going to build
as you because as you as really it's big
it's complicated
it's got databases and document
databases and storage systems and
InfiniBand ultra-flat mesh networking
and media services and whatever else
we're just going to build a very small
part of as you there's a thing in SEO
now and in most clouds actually but in
Azure it's called
app services it was called Web Apps and
it's basically a part of Azure where you
can just build an application and then
just push it into us here and run it
this was a trend it was started by
Heroku I think the first people who do
it you basically did a git push Heroku
master and it just automatically built
all your code and ran it for you so I'm
going to show you how to build your own
app services the original plan was that
I was going to bring in a little server
rack that was about that big and I
started I tried it with Raspberry Pi but
it didn't work and then I was going to
import a bunch of kangaroo mini PCs from
the states but that would have cost me
nearly a thousand pounds for a talk and
no so I'm going to build my own Azure
and I'm going to run it in Azure because
I know what I'm doing with a zero I
understand it but I'm going to run it
cheaply and cost-effectively so why
would you want to do this well this is
the primary reason if you use app
services all that convenience and lovely
stuff that they've built on top of the
underlying infrastructure comes at a
premium cost and it's a big premium
an app service VM costs fifty five
pounds a month and the same size of VM
running Ubuntu 1604
costs 36 pounds a month and that's for
the kind of dual-core D Series VMS and
36 pounds a month gets you quite a nice
box for running Linux but it's not a
great box for running windows and iis
and all the stuff that goes on top of
that so you also get more performance
out of that 36 pounds a month then you
do another 55 pounds a month so that's
that's one reason and you know multiply
that up by the number of cores you
actually need to run all your apps and
services and everything else and that
becomes a fairly substantial amount of
money I know because I used to run an
app that was in every Azure data center
and I was running it on App Services and
when my Bismark plus ran out I nearly
went bankrupt honestly that's why this
laptop is so old I'm still like
recovering from from app services so but
the other reason that you might want to
do this is the just the control so when
you run app services they basically go
it's a VM and they don't tell you what
kind of VM it is so you don't know
whether it's an AC series or a D series
what kind of storage it's got whether
it's using SSDs or the old kind of
spinning rust whether it's using premium
storage with the really fast disk access
underneath or anything else and there
are this basically you've got one core
to cause for calls or eight calls that's
it
and so if you switch over to the ends
then you've got all the available
options the massive compute things and
everything else and you can run whatever
you want and you can spec them according
to your requirements so that's kind of
also a very good reason to build your
own app services on top of this thing
even though I am just running it in
Azure I'm building my own Azir insiders
here it's like googling Google it's
going to make the internet explode so
what are we actually going to build what
we want is something with easy
deployment so I can build an application
and then just deploy it without really
thinking about it automatically handle
domain
assignments and routing and everything
else that goes on there and because this
is 2017 we want HTTPS on everything by
default so we're gonna build all of that
in an hour
actually in 55 minutes because that's
what I've got left because I talk too
much so step one they're not gonna be a
lot of live demos in this because
there's an awful lot of moving parts and
it works eventually but you kind of have
to restart scripts and things
occasionally and also Niall is in the
room and he's got an internet disrupter
and so I don't want to depend too much
on the internet just in case he decides
it would be funny to break me so runtime
we're going to use docker obviously this
is now your opportunity to get up and
walk out of the room if you are really
sick to the back teeth of hearing about
King docker know it's a DevOps talk so
you know docker we're going to use
docker swarm and docker swarm is the new
thing in the most the current version of
docker 1.12 they added swarm mode into
the core system so you can spin up a
bunch of machines run docker on them
till some of them that their managers
and some of them that their workers and
then just say create a service and run
it for me and it handles everything in
there and you can do this from the
command line or you can use kind of GUI
tools there's Dockers Universal control
plane if you're running in Azure there's
docker for Azure if you're running in
AWS there's docker for AWS I would be
very surprised if there's not a docker
for Google cloud at some point so that's
what we're going to set up and the
infrastructure that we need to run this
on in Azure tone so we need some servers
obviously and we need those servers to
be in a network and for disaster
recovery and availability and load
balancing we need them to be in an
availability set and then we need a load
balancer in front of them pointing at
those different machines and doing the
routing the server's we're going to
create one manager and two workers so
the manager is the thing that controls
cluster and tells the workers what to do
and works out that that work is not
doing very much and that work is
overloaded so I'm gonna move that
service from there to there and just
Auto balancing and everything else we're
going to run this on a bun to 1604 LTS
because why would you run any other
linux but it actually no it doesn't
matter you can run it on anything that's
the nice thing about docker is you get a
machine if it can run docker then it can
run pretty much anything and Ubuntu just
happens to be the one their package
manager I know what I'm talking about I
know all the libs are called and
everything else but you can use Fedora
CentOS Red Hat Enterprise Linux if you
work in the financial sector where they
actually won't use something if they're
not allowed to pay for it I love the
financial sector and you can use Oracle
Linux if you hate yourself and you want
to die they're not a sponsor are they no
not anymore so to set up a manager you
spin up your box in in Azure with this
is assuming a wouldn't - and then you do
this that first line their hands up who
thinks that first line there is the
worst line of anything they've ever seen
anywhere ever yeah yeah download
something off the internet and pipe it
straight into SH preferably with sudo so
yes I say it's ok because it's HTTP and
so I know it's coming from what you
would actually do though is you would
download that shell script and you would
go through it and make sure it was doing
what you thought it was doing and then
you would just run it with with SH but
this is this is easier and and I like
telling people to do this because it
creates millions of machines running in
clouds all around the world that are
vulnerable to my botnet so that so that
I can infect Mongo and elasticsearch
clusters and then hold them to ransom
and tell them that if they give me
Bitcoin I will give them their data back
now I've just deleted it
that's assuming that they get my message
and Niall hasn't come along since then
and dropped in his message telling them
to give him Bitcoin then I'm going to
that second line there is really handy
when you when you've installed docker
you add your login to the docker group
and then you kind of need to log out and
log back in again usually but that means
you don't need to use sudo to
communicate with the dock demon anymore
and then to create the manager we just
say docker swarm in it and then the
advertiser dress is your internal IP
address on your network so ten or
whatever and then we are going to secure
it because seriously I got a call from
one of my consulting type customers
saying have you ever heard of a
container called runner's root did you
put that on our system and I'm like no
no that wasn't me they hadn't secured
their swarm so anybody could just deploy
anything they wanted on it and there is
a docker container called runner's root
which allows you to do root things on
the host operating system and yeah and
the thing is docker when it's listening
on TCP it listens on port 23 75 and
there aren't that many IP addresses and
machines are very fast these days and so
if you've got a botnet you can just scan
all the IP addresses in the world and
see if there's something listening on
port 23 75 and if there is you can go
can I run docker things on that oh yes I
can
so secure your swarm it's not actually
that complicated all you have to do is
create your own certificate authority
and that's it's not complicated so you
know like Komodo or let's encrypt or
whatever you just create your own
certificate authority then you create
and sign a certificate and use that on
the server to secure that and then any
other you create client certificates and
any client certificate that is signed by
the same Authority as the server
certificate will be able to communicate
with that server okay so that sounds
really complicated but actually this is
how you create
certificate authority it's it's two
lines of code you generate a key and a
public key and a signing thing and what
I don't understand I just typed the
words in and stuff happens and it seems
to work but that's how you create a
certificate authority so the things that
are coming out of this basically your
CAPM and you'll see a dot PM check those
into github because you know as long as
you put it in a private repository it's
fine how is anybody going to be able to
access it if it's in the private repo I
swear to god I'm gonna strangle some of
my customers so yeah that's that's how
we create a certificate authority then
this is how we cite we create a service
certificate and that's basically so we
generate a key and then we add a subject
to it which needs our domain name in
there so I've already got my stuff up
and running on honest you it's running
on spiffy manager theoretically
about.com I'm gonna add in the internal
IP addresses it's running on so the
other things inside can talk to it as
well and then that last bit there is
just how you sign your your certificate
this bit here I could have done this
with the mouse goodnight whatever that's
that's my password that's the password I
use for everything so so you can access
pretty much anything of mine on the
internet just with the password secret
squirrel with numbers instead of letters
does anyone remember secret squirrel old
people is the best I just made up a
cartoon that I'm trying to convince my
children was real calling called um
Captain Spang in the monthly bump please
and I'm trying to seed the internet with
evidence that this was a thing
the monthly bum pleas were always
stealing captain's bangs cheese so yes
and generating the client certificate
it's pretty much the same thing except
instead of the the domain name we just
put C N equals client and that goes into
files on your system and then you copy
those into your docker directory in your
home
directory and then docker will use those
to communicate with the remote server to
add the you can get all this off the
slides the slides are public and
theoretically by the end of the talk
there will be a website that you can go
to that's got links to the slides and to
all this code on github as well as long
as the demo works okay so then we just
configure docker to tell it to listen on
the TCP so docker by default listens on
a UNIX socket which is just a file we're
gonna add some stuff to the startup here
to say I want you to listen on TCP I
want you to use transport level security
here's your key
here's your certificate and here's the
address I want you to listen on which is
just the network host and when doc is
running securely it runs on port 23 76
so it's not worth your botnet trying to
connect on 23 76 because it's going to
be secure so we do that and then we just
restart docker so it's secure and then
on our kind of machine that we're doing
stuff on the the client a desktop
machine to attach to the swarm we say
export docker host equal you know create
an environment variable in Windows
however you do that export docker host
equals TCP colon slash slash and then
the the web address of our manager TLS
verify equals 1 just tells it to use TLS
certificate authentication and then
talking to our manager we say docker
swarm join token - queue just says don't
put all the other stuff out just give me
the token and I want to join token for a
worker we can then use that token which
is a hash of something somewhere no idea
what to tell the workers so you SSH into
your worker machines and just do sudo
docker swarm join - - token and the IP
address and it will become part of your
swarm
okay everyone get that good there will
be questions in the pub quiz this
evening I've got a whole section on how
do you do this in Dhaka it's gonna be a
fun quiz so the next thing you need is a
registry a registry is where you put
your docker images and there are
multiple options here the simplest one
and the one that I advise people to do
just for small projects and making life
easy on yourself is you can just pay a
small amount of money for a private repo
on the docker hub they will host your
image for you and keep it private and
safe that's fine for a lot of things if
you've got like proper security concerns
like your a bang course you know scary
data type stuff then don't do that
because it is public and they might get
hacked they probably won't but they
might so the other option or one other
option is to use your cloud providers
registry so as your and Amazon and
Google all provide docker registries
built into the system and so you can
push your images into there or you can
just run your own docker registry guess
which one we're going to do haha it's
actually really really easy all you have
to do is run the registry and then you
have to secure the registry for the same
reason you have to secure the swamp
because otherwise people can go oh that
looks like a nice image I'll just
replace it with one of mine so I'm gonna
use docker compose for this if you are
using docker and you are not using
docker compose you are an idiot and you
should stop and just go and learn docker
compose it's rather than running docker
commands with all those - - this and - -
the other and - - whatever else you
created yeah more file and you put all
the things you want to run in it and all
the parameters and configuration and
everything and then you just say docker
compose up and it starts it running and
you can spin up 15 different services
and multiple networks and volumes and
all sorts of stuff it's great so this is
the docker compose for starting a
registry restart or where you
says to the doctor demon if this crashes
can you start it again please Cheers
and then the docker registry is
available as a docker image from docker
so you want to run a registry you go
docker run registry and it's we're using
version two we're exposing a couple of
ports 5004 unsecured access and 443 for
secured access and then we're mounting
some volumes onto it so we're mounting
our own configuration file in there and
we've got an authentication folder which
it's got something in it that we'll look
at and we've got cache folder as well
which is where it could potentially keep
the actual image data this one's a bit
more scary this is the configuration
file but it's it's not difficult to
write what you do is you go to doc accom
you find the page with this on it and
then you copy and paste it into a file
on your machine and then you delete the
bits that you don't want that's that's
how the professionals do it anyway so
this is a docker registry configuration
file important lines so we are going to
use Azure storage because we're running
in Azure we're just going to use blob
storage to to store our image data and
push it and pull it in everything else
and then we're going to tell it what to
do on HTTP and because we want this
running on HTTPS we are going to use
let's encrypt to grab a certificate and
apply it to the registry and the docker
registry image has support for this
built in so you start it and because
it's in the configuration it goes to
let's encrypt and says give me a
certificate and let's encrypt says are
you the domain you say you are on the IP
air do you laugh why are you smiling at
me in that way it is it is it just does
it it's fantastic this is this is the
alternative to applying for a
certificate from GoDaddy or Komodo or
whatever and then waiting 24 hours while
they verify that your gmail address is
actually you so yes
and then we're gonna so that's what the
cache directory is for look cache
obviously that's let's encrypt cache and
the email address there that's going to
become the certificates contact thing so
if anyone wants to get in touch with me
to find out who I am and what the hell I
think I'm doing they will be able to and
then so we've got storage driver and
then the HT password down at the bottom
bit there we're just using basic
authentication for this because that's
easy but you can also set this up to use
the same kind of certificate based
authentication that you use for the
swarm security so basic authentication
one of the things I really love about
docker is it's not just for spinning up
services and running them and leaving
them running and so forth there were
really complicated kind of commands or
or things and you have to install an
absolute shed load of stuff on your
system to get it to work properly and so
you can use docker containers just as
command line things and the registry
container actually will allow you to run
it and use its built-in HT password
thing to create your encrypted password
file so we create a directory called off
in the same directory as an aqua compose
file and then we docker run tell it to
run HT password as the entry point
instead of what it normally does and
then just pass in those parameters there
so this is Mark that's my password again
and that's going to go into an HT
password file on my local system which
is then going to get mounted into the
docker registry when I run that okay so
I do that then I do docker compose up I
do - D - tell it to run into tat mode so
it just carries on going and then I log
out of the Machine and I have a secure
docker registry that I can access over
the Internet
okay it's incredibly easy and
straightforward how long do you think
all this is going to take
when you do this like what half an hour
maybe an hour to run these commands and
so forth so that's that's all very well
and good but it gets boring
it gets boring really quickly did anyone
go to James Newton's talk on terraform
on console yesterday no there's some
people it's terraform is awesome
essentially all you're doing here with
all this sort of modern cloudy DevOps
type of thing is you're entering
commands into a console and waiting
until I finish and then entering another
command in or you know if you are more
of a GUI kind of person you're
navigating the lovely blade system in
the azure portal and ticking tick boxes
and putting settings in there and
uploading files and everything else and
terraform
basically does all that stuff for you
it's a system for scripting
infrastructure and and you tell it what
state you want your infrastructure to be
in and then you do an apply and it just
goes and does it for you and it's really
powerful and it will work with all the
different clouds and digitalocean and
various other things as well and it also
works with ancillary providers and so
forth so I'm going to show you a couple
of terraform files here I'm going to
close all of those I'm going to ctrl +
so here's terraform is the registry
so this is a terraforming script file
and all this is going to do is it's
going to buzz through all my various
commands here and I just tell it what I
want to exist and then when I run it it
goes off and it looks and for anything
that doesn't exist it will create it and
so I say I want a resource for a group
called spiffy registry and I want a
virtual network and I want to subnet
within that virtual network and then I
need a public IP address and I want that
to be static and then I need network
interface that I can attach to my
virtual machine and then I need some
security rules to say what ports are
allowed in so I want 80 and 443 and
5,000 and I might want to SSH into it so
I'm going to open port 22 as well and
then I need a storage account which is
where all the images and also my disk
images and so forth are going to go so
I'm going to create a container in there
called VH DS and then I'm going to
create my virtual machine and so this is
the fun bit you say this is the image I
want to use to create the virtual
machine so it's canonical Ubuntu server
16 point Oh 4.0 - LTS used the latest
version of that create an operating
system disk create a login disabled
password authentication and upload my
local RSA key so I can SSH into this
machine without passwords and I will log
in as that user there
I want to tag it with a production tag
to say this is a production system even
though it's not it's a demo and then
when I get to the bottom here I am going
to say remote exec and tell it to login
using the spiffy admin user and then run
that get docker and pipe it to so SH and
then add the thing in there and then
I'll going to add in the steps to just
run the registry and create stuff and
everything as well
again what you would do if you were
concerned about security is you would
download that shell script and add it to
the resources within your terraform
directory and then you can just upload
that script from your local machine and
then execute it on the remote machine
and that works perfectly well as well
and then so at this point a lot of
people say what do you think of your
resource manager so as your resource
manager is essentially terraform ish but
it's just for Azure and there are two
things that turn me off as your resource
manager I love the fact that it exists
it's only because as your resource
manager exists that terraform can do
what it does because terraform is using
it under the covers but they have this
thing called arm templates which are
JSON the files that do roughly the same
thing except Jason it's not a scripting
language it's it's a serialization
format and I wish people would just get
over Jason as a scripting language just
stop it
it may be for configuration may be for
sort of like a couple of settings and
whatever else it's fine or if you've got
something that handles it for you
automatically like NPM then that's fine
too because NPM choice with Jason fine
but um so that's that's one issue with
it and the other thing is that for some
reason that I cannot fathom as your
resource manager templates don't work
with AWS or Google or CloudFlare and
terraform works with CloudFlare so I
have a key
a token so I can talk to CloudFlare so
at the end when all this is up and
running in terraform will also attach to
the CloudFlare api and set up a registry
subdomain on my spiffy demo com domain
that I registered just for this talk
eight quid that cost and it will create
that record and so once this finishes I
then have my daugher thing running and
it is actually addressable from the
internet so that's that's quite a fun
script and again that's going to be
the resources that there'll be a link to
at the end of the talk
here's an even more fun one so this does
actually create the entire swarm and it
secures it and it gets it up and running
and you know once this is done it's done
and it's not actually that much more
complicated so essentially the same
things go through here quick note about
variables so all your tokens and your
hashes and API keys and everything else
that you need to operate as your
resource manager or plowshares api or
whatever else you're working with I
don't care if your repository is private
do not check credentials into github at
all ever don't do it all right just stop
has anyone ever done that on purpose
just gone it's fine it's a private repo
no one's going to admit to it now mark
you've scared the out of them
that one guy there he's big all right
big guy don't surrender look at him
berries of poor puss right so yeah the
secure variables are all in ATF VARs
file and you just add star dot TF arse
to your git ignore and that stops it
from ever going in there so I just
declare those variables up at the top
here and then I've got other variables
that I'm declaring and I'm putting
defaults in because it's fine people can
know that this is running in the North
Europe data center they can know I'm
running standard d1 v2 s it's all good
I'm not scared of those things so my
CloudFlare email and token and domain
are also across in there as well right
so we now have our same sort of thing
virtual network subnets bunch of public
IP addresses we're creating a load
balancer in this one so we need an IP
address for the load balancer as well
and then we've got back-end address Paul
is just this is what you're going to use
is your routing system
three network interfaces so we've got
our manager here which is being set up
one way and then we're creating workers
and the workers are all identical so we
just declare it once and then we tell it
how many of those things we want to
create for a production system
incidentally you would be looking at
creating three managers and then as many
workers as you need and the workers
don't have to be the same you can create
different kinds of workers for running
different workloads with completely
different configurations and then you
can tag them and then when you start
services you can say to docker swarm
I need you to run this only on workers
with this tag so if you've got stuff
that's doing really complicated compute
then you can spin up 36 calls and half a
terabyte of RAM and so on and then tell
the big compute tasks to run on those
but all the website stuff can just run
on little d1 v2 s or whatever if you're
running D ones by the way stop switch to
the v2 s they're cheaper and they're
much faster so yeah as your tips so
network interface on the workers
security group inbound rules we've just
got 84 4 3 2 376 for the manager so that
we can control it remotely
SSH as usual and then similar sort of
stuff we've got storage things we're
creating an availability set because
we're going to put each of these
machines into the availability set and
then that allows us to have a load
balancer that points to all three of
them if you don't have an availability
set the load balancer will just go no
not not talking to that and what the
availability set does is it makes sure
that each of your machines is in a
separate cargo container in the azure
data center so if one of them explodes
your whole system doesn't come down then
we create our manager virtual machine
which is pretty much the same as the
things before except down at the bottom
here we're going to run a generate cert
SH which is going to generate do that
holes crater certificate and sign it for
us and put that into a file then we're
going to upload
docker config directory up onto the
remote machine then we're going to
attach to the remote machine using SSH
and we're going to run all the security
still piping the thing through a shell
script create the swarm and then run
that configured akhada SSH which is
going to secure it and everything else
and then on the local machine we're
going to run a script called get token
de Sh
none of these are going to work on
Windows by the way so I hope you're all
running either Mac or Linux as your as
your primary desktop operating system
they would be fairly straightforward to
convert to CMD files yes yeah I have
issues getting bash on Windows to talk
to the docker for Windows host for some
reason and the bash subsystem for
Windows absolute bad words when it when
it comes to dock it tries to run docker
and it can't run docker because it's not
actually Linux underneath and also it's
it's it will III actually believe that
once they get the whole windows
subsystem for Linux and bash on Windows
working and I've been to on Windows
working I think we'll be able to run
docker inside it because the stuff you
can already do is just amazing
yes funnily enough you can't run the
Linux version of.net core on bash on
windows or linux on windows yet but
again when I get my new laptop in March
which is going to be probably in the
same Lee powerful kind of four core
thing people think I run Linux I tell
people I run Linux if they're kind of
accusing me of being a hipster because I
say oh no it's because the machine is so
old and Windows just runs like a dog on
it but actually I've been doing it for
two years I kind of like it it's it's
nice so yeah I am just going to put
Linux on whatever I get and then
run Windows in a virtual machine for
demos so this is creating the workers so
what that lost this script here
basically sets those things sets the
docker host and the docker TLS verify
and then gets the token and dumps it
into a file on my local machine then
when the swarm worker things are being
created I can use that token while
they're starting up and I can just copy
the token up into the temp directory
there and then do the config thing and
then say docker swarm join and pass the
token up as well so this terraform
script creates the manager gets the
token and then creates the workers and
then joins them to the swarm as well so
we're the time this thing is finished
you have an up and running swarm and
then we've got some load balance of
stuff down there just saying do HTTP and
HTTPS and a probe which is just
literally going to say can I attach to
this machine using SSH or can I attach
to this machine on port 22 and if I can
good so if the SSH daemon is running it
will consider the Machine healthy you
would want a more realistic health check
for that in reality and then down at the
bottom here we've got a couple of
CloudFlare records that we're creating a
wild card because CloudFlare will do
wildcard DNS records it won't do all the
CloudFlare magic on them but it will at
least do the dns so anything anything
dot spiffy demo com will now get routed
to this cluster unless there's a
specific record for it and I'm also
going to create a record for the root
domain which is just to do with let's
encrypt if you don't have the root
domain on the right IP address for some
reason let's encrypt doesn't like it
okay so when I have better internet and
more confidence and everything I just
run both those scripts at this point and
they take about ten minutes both of them
to complete I have three or four minutes
for the first one and then the second
one
takes between five and ten minutes
depending on how was yours feeling that
day I wasn't I'm not confident enough of
the Internet in the Excel to do that so
trust me I ran this and you can run it
as well you just download terraform it's
a single executable written and go by
Hoshi call and you put it on your
machine and then you just do terraform
plan and it'll show you what it's going
to do and terraform apply and it'll show
you it'll do it and then tell you what
it's done down at the bottom here I'm
just getting it to output a couple of
the variables that it's generated fqdn
is fully qualified domain name so that's
going to be spiffy demo cloud app
dollars you know spiffy demo dot north
europe play on that door zero calm okay
so now we've got a cluster running and
we can do docker service create and we
can run things on it and everything else
but we still need a way to get it to
serve websites really really easily
that's that's kind of the point of this
whole thing I just want to be able to
create a website and then just run it so
we need to serve web and to do that you
want some kind of proxy running on this
cluster that you can say right I'm going
to spin up a service and I want you to
just automatically root requests based
on the domain name the header record to
the relevant service within here there
are three sort of major things that
people use as proxies and I have almost
certainly missed a couple and I have
left I is off on purpose nginx is the
kind of one that always wins web server
slash proxy of the year
I love engine X you can script stuff in
it with lure you can script stuff in it
with JavaScript now and you can run it
in docker and all this sort of stuff
there's also a che proxy which has
similar characteristics nginx is also a
web server H a proxy is primarily
concerned with with proxies and load
balancing and health checking and
everything else and then there's traffic
which is a new thing that's written in
go and it doesn't it's not quite as
blazingly fast as nginx but
because it's go and you know Engine X is
written in really hardcore kernel-level
see the traffic does have another a few
nice characteristics it has built in
support for an awful lot of stuff and it
has a gopher dressed as one of the guys
at the airport which I kind of like I
hate go oh I've never like right go code
myself but people do build some nice
stuff with it I'll give them that if
they put generics in then I'm gone you
know I'm there but yeah so what does
traffic give us magical docker
integration you can literally when you
start traffic you can say you're running
on a docker swarm and the manager is
here and just just watch and when
something starts up if I've applied
certain labels to the surface then do
your thing and traffic just sits there
and goes alright I'm waiting yeah it's
got let's encrypt built in so you can
just say here's my email address please
do let's encrypt for all the sites that
I run and the performance is acceptable
you would have to be hitting like a lot
of requests a second before traffic
became the bottleneck in your cluster so
it's it's perfectly decent much much
simpler to get it up and running than it
is to get nginx
to do what I'm trying to do in this this
talk here it's mature and supported
enough that it has an official docker
library image basically a docker library
image is one that doesn't have a name
space slash prefix on it so if it's just
traffic or registry or nginx or anything
like that that means it's official and
docker like monitor it and approve it
and it has their seal of approval
doesn't necessarily mean it works but it
means that docker have like checked it
over and made sure that it's not
malicious and so forth so to deploy
traffic we're now going to we've got our
environment variable set so our local
docker command on our machine here is
now controlling our manager in the swab
if you've got multiple managers you can
connect to any of them it's fine they'll
they'll all just communicate and do raft
consensus things always an odd number of
managers by the way and probably never
more than five three is the magic number
for all these sort of men docker
managers and console and calf care and
zookeeper always three once we set those
then we can just say docker network
create and we're going to create overlay
network which is a virtual network with
docker puts over the top of whatever the
actual network is so that the machines
can talk to each other and we're going
to call that network traffic I did
briefly experiment with pronouncing it
with a sort of Afrikaans accent but no I
will just get shot something and then
before I set up my traffic server like I
said the default behavior for the docker
is to run on a network socket and for
some reason if I point traffic
internally at one of the managers it
doesn't work and so what I've got here
is an image called so cat - docker
what's or socket and socket which really
attaches to a UNIX socket so one of the
file things and proxies everything in
and out over a TCP socket and so I'm
running that just so that my docker
proxy is running internally and is
addressable over the overlay network
that's the issue with telling traffic to
attach directly to the manager is the
manager is not running as a service on
the cluster it's running the cluster and
so things can't talk out of the cluster
it's like trying to talk to God you know
he might be there but he's not
listening so we do that and then we run
traffic you only have to do this once
and then you get done and it's fine you
just bang this in a shell script so
docker service great those first five -
-
our parameters to docker service and
we're saying so great service called
traffic published these ports so it will
listen on all those ports attach it to
the traffic network mode global says run
an instance of this on every node in the
cluster ok so you have options with this
you can say I wanted to only run on
workers I want it to only run on
managers I want at least this many
instances of it running but I don't care
where they are but I want this one
running everywhere so there are as many
of it as possible so that's going to go
there and then I'm just going to mount a
temporary directory on the host machine
into the container to store the
certificates that I get from let's
encrypt ok this is quite an info
information rich talk isn't it I've just
kind of realized that yeah who would
have thought that building your own Azir
would be so complicated if Microsoft can
do it then sorry mark russinovich can do
it and write books at the same time it's
just what is that guy does they do seem
to have some good people working for
them I'll give them that
right then traffic traffic : latest is
just the current traffic image and then
everything underneath that is just
arguments to the traffic daemon so we're
saying you're running in docker you're
running in docker swarm mode because it
will support multiple ways of doing this
in docker but it's warm mode is the
easiest
here's your docker endpoint that you
need to listen to to find out wind
services being created and get
information about them here's the base
domain for all the things we're running
in docker so spiffy demo com
we'll look at what that's used for in a
minute docker watch says watch docker
and when something starts maybe proxy it
and then entry points this is one that I
really like you look at doing a redirect
from like port when something comes in
on HTTP doing an automatic redirect to
HTTPS so the you always serve the site
securely and
and Google does good indexing and so
forth do that in iis and you're
installing URL rewrite modules
restarting your iis server and then
writing half a dozen lines of
impenetrable XML to get the damn thing
to work here you just say as a TLS entry
point and there's also an HTTP entry
point but if anything comes in on that
redirect it to HTTPS that single line
does your whole redirect thing there the
default entry points things can come in
on HTTP or HTTPS and then the Acme stuff
I don't know why it sacked me but that's
let's encrypt does anyone know why it
sacked me is it just a roadrunner thing
you like Wiley coyote going haha my
server is secure they didn't think that
through it's because I wasn't in the
meeting yes that's just so here's my
email again stall certificates in this
file here which I've mounted up at the
top there and get the certificate the
first time a request comes in that's
what the Acme dot on demand thing does
is it
thank you it's apparently it is
automatic certificate management
environment and nothing to do with
roadrunner and Wiley coyote and and
catapults that kill you no matter where
you stand that is my favorite scene in a
cartoon ever way the catapult kills in
three different ways I just love that
also if you look on YouTube you can now
get the video where he catches the
roadrunner and eats him which is just
really good closure for anyone who grew
up in the 1970s it's it's awesome so now
we're ready to go now we can just use
our pears so I've run both my terraform
scripts and I've run my traffic scripts
I've got a traffic start SH and there's
an le start door SH in the in the github
repository that will start the traffic
thing for you so now we're ready to use
our platform as a service so the publish
process to get a service up and running
on our new cluster you build the docker
image
and you push it to your private registry
and then you create the service okay and
so this is how you publish it you need
to login to your registry and then you
need to build your your docker image and
tag it with the registry name and then
push it to the registry and then create
the service with this line here and then
you will be able to browse to your thing
see that's that's a very simple deploy
prayer is still too difficult that's
that's far too complicated I just want
to run it and so I wrote a thing JFR I
just run it it's pronounced Jeffrey
because it's the thing I'm actually
going to support it I I'm gonna you know
and so the Jeffrey this Jeffrey
repository has got the terraform scripts
for spinning up the cluster and it's got
the shell script but eventually it's
going to actually have kind of Jeffrey
create cluster will run the terraform
scripts for you and it'll have terraform
as a dependency and so forth so yeah so
you can get that so I'm going to show
you how that works so I'm going to CD
dot dot I'm going to make this a bit
bigger can everyone see that okay right
so I'm going to make a directory I do
want to prove that this is working so
someone give me a name for my site
there's like ND c and o ND SERO drana
okay
yes we'll be all right with the
profanity filters on on CloudFlare so
that should be okay right so now I'm
going to say dot dot net oh just to
prove how absolutely hardcore I really
am by the way look at this yeah I am
running preview for because because I
can I like living on the edge songs they
don't net new type web that's going to
create me a web application there you go
there's my web application I'm gonna
save dotnet restore so that I can work
with it locally okay I never jumped down
to here I'm gonna run code dot to open
it up in Visual Studio code okay I'm
going to go into my views bit here and
my home and my index this is where
Microsoft put all their marketing stuff
by by marketing stuff we're going to
grab these lines out of here instead
that's my marketing stuff and we're
going to paste that in there we're just
going to jump into the home controller
no we're not going to jump into the
layout and in here not now and in layout
here we're going to change MVC app to in
DC Road Runner and change down to the
bottom there and I'm going to put my
name in here okay
I'm gonna save that and I'm going to
save that and then this is the fun bit
okay that's not working
there we go JFR I does need a couple of
environment variables to be set for it
to work so this is building my docker
container that's installing all my stuff
locally there I've got my own docker
base image Rendel lab slash net which
includes its pre-installed and cached
all of the web libraries and and
everything so when I do a dotnet restore
in my child image it doesn't have to go
to the Internet that's a public image on
the docker registry and you're welcome
to use that or fork it from my github
repository and build it that's running
theoretically now I'm gonna go gonna go
to the browser and I'm going to go to
NDC roadrunner dot spiffy demo comm and
this is going to be running place your
bets ladies and gentlemen and it's going
to redirect me to HTTPS and I'm going to
close my eyes
it can take it well you know it's hitted
because it did the HTTP redirect thing
sometimes it takes it a couple of tries
to get the certificate back
I swear to God this worked just before I
walked into this room that's saying it's
not private sorry yep okay
it's not doing it why won't you do it
okay
docker service PS NDC oh oh that's
interesting
well where did you just go
that would explain that no no it
actually it were it doesn't explain
where it's gone let's go over to this
one today it's running
and it's running okay
see that works that's the one I put up
literally just before this talk using
exactly the same thing that's working
fine and this one is not so yeah I
always like to finish my my talks with a
really abject case of demo fail docker
service RM I did yes yeah it's yeah this
is exactly what I hear does this is this
is entirely right let's try dropping it
and recreating it again so we'll just
run J Fri again which is going to be a
much quicker because nothing's changed
I like that yeah Joffrey so that's done
that let's give it another try
oh that it's different
nope I'm going to debug this afterwards
I'm just going to try one more thing
MV NDC roadrunner in roadrunner
run it one more time with the different
things if I get more like I was deep
debugging this at 2 o'clock on Thursday
morning Wednesday morning trying to get
it to work and it turned out that let's
encrypt was down or something
so Roadrunner dots Biffy demo calm
nope I'm going to debug this and find
out why it doesn't work but it will be
there seriously oh the other thing I can
do for the time being is I can see the
into labs NDC JFR I trap resources
traffic and I can do docker service RM
traffic and then just do dot slash start
this is the version that
those were already running sorry
that's because I've just taken traffic
offline so get rid of it again and then
start it again and then just go to http
: Roadrunner dot and now I'm getting bad
gateway right
start those again one minute to go well
I blow I'm gonna fix this but I'm not
gonna do it now so yes I will get that
working and then I will tweet the link
to it it's a good job I didn't do the
thing where I'm running my slides on
this so yeah eventually you're gonna
want to sort of automate everything and
so look at building things like a build
server it's really easy to setup a build
server for this because you don't have
complicated libraries and everything
it's just docker build so you can use
any of these to do that if you can
figure out Jenkins because the
documentation is awful the build steps
are literally you have a get web hook
you clone it you build it you tag it you
push it and then the registry sends
another web hook and you have something
listening that automatically updates the
service in the server that's where you
can get the resources the slides are
there jeffrey is there I will get this
bloody working I'm gonna go outside and
I'm gonna do it and it's just gonna work
yeah exactly it's that's just that's
just what happens so yes but feel free
to contact me on rendell Lev's comm I'm
doing consulting on all this stuff if
you want to do this at your business
I'll coming out you get it set up donate
core or whatever it is you want to run
thanks very much and I hope to see you
at the end of the day when I'm doing
another talk about what I'm going to be
talking about in 10 years time Cheers
enjoy the rest of your day</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>