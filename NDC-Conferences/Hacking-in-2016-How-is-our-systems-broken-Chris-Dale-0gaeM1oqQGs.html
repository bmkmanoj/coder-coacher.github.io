<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Hacking in 2016 - How is our systems broken? - Chris Dale | Coder Coacher - Coaching Coders</title><meta content="Hacking in 2016 - How is our systems broken? - Chris Dale - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Hacking in 2016 - How is our systems broken? - Chris Dale</b></h2><h5 class="post__date">2016-08-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/0gaeM1oqQGs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right I think we're good to go
so welcome welcome welcome this talk is
a demo based talk there's gonna be a lot
of hacking it's gonna be a lot of
keyboard activity there's gonna be demos
all right so thanks Mike break don't
worry
usually we fix it okay don't feel bad
for me if something breaks if something
doesn't work don't worry about it I
don't
this is hacking things tend to break
okay normally thanks run okay but still
we're gonna mess around with some memory
stuff we're gonna mess around with
backdoors things can crash and so on so
I am Chris Dale I am NOT Moriarty
we are keys to supervillain from a
Sherlock Holmes books and videos right
he's in this case the super hacker
because how can Moriarty always stay one
step ahead of they're good guys how is
he always one step ahead of the
detective Sherlock Holmes I in my
opinion is quite obvious he is the super
hacker and he has access to all the
systems all the backgrounds so he knows
her plans he knows what we're gonna do
when they're gonna do it that way he
could stay one step ahead so hacking
it's awesome it's the way of the future
for terrorists for criminals and that's
why we also needed to educate ourselves
within cybersecurity only because it's
so tremendously big and important my
daily job is penetration testing instant
response normally some people laugh when
I say penetration testing because it
sounds kind of funny but it's basically
just ethical hacking professional
hacking right so I tried to break into
customer systems in order to determine
the business risk involved with those
systems I'm also a teacher for Sam's
travel around the world teaching hacking
techniques and instant response and
exploits and stuff like that so I have a
good time teaching all around the world
like Saudi Arabia was my last
destination I crazy everywhere they send
me this pretty cool all my spare time I
also do a lot of hacking so I'm actually
lucky enough to have my hobby as my day
job because I always like to have
and some of the results from hacking has
been metals and prices from different
competitions for example i went to
washington d.c to play in what we call a
Tournament of Champions previous winners
have captured the flag events like
competitions for hacking the most
servers within a certain time limit I
went there in a place twentieths out of
164 that's not too shabby but still you
do there is a lot of community within
information security and if you want to
get involved please do so because we
need people we need bright people and
especially people who have developer
backgrounds to help us actually combat
that the techniques and tools that the
bad guys are using so this talk
basically we're gonna be hacking right
as I said we're gonna be hacking servers
and moriarty it's gonna start out at a
vApp server so we're targeting an
organization called elite host it's a
hosting provider and this organization
is actually quite secure when it comes
to their external network so they've had
a lot of penetration tests happening
however we're still gonna look at how we
can break in so we're gonna have kind of
an of loyalty we're gonna hacked the web
server we're gonna upload backdoors and
then we're gonna make our way into the
domain and eventually we're gonna try
get keys to the kingdom which is the
domain administrator right so domain
admin it's like when you have that you
can control the entire business so my
demo environments quite simple on my
laptop I have everything virtualized I
have my attacker a Linux box which is
basically just Kali Linux virtualized
it's on the same host only network as a
server 2012 which has a web server and a
database on it kind of standard setup
rights and behind that so this is the
DMZ behind that I have my domain
controller which will serve the users
will serve policies in Sascha so as I
said it's a demo based presentation so
why don't we just get on hacking huh so
let's start with looking at the websites
like that just let me fix my
presentation mode the sec let me
duplicate the screen looks good so this
is it right this is everything that is
exposed and let me challenge the
audience what would be your initial
thought on how to hack this form anyone
like the collection yes so we're not
gonna do that
nope because that would be easy okay so
not too many customers today have sequel
injection in the logins form still
because customers they tend to get
audited and pen tested on their external
networks so a lot of people have been
slamming these services and logging
forms already only thing for known
vulnerabilities right so instead we're
gonna look at something called username
enumeration and pass or spring because
what does most every single system have
on the internet they have login forms if
you can have a list of usernames and if
you can find just one user with a bad
password you will extend your attack
surface of that system and a lot of
customers today they will only have
their external site path tested because
everyone already authenticated is
trusted we trust our users right that's
a big mistake alright so let's try log
on with something like admin admin right
I always try to figure out the system
before I try to hack something you will
always see some new Packer immediately
trying to hack something before he even
understands what the system is doing so
first of all we try to see what this
system is doing and it says look the
login failed
check your password right that's
interesting not too subtle but that's
interesting that it says check your
password so what if I type in a random
string blah blah and they see tests it
says lo you fail check your login name
parantesis username so that's
interesting right it's very explicit in
this example but by actually testing
admin and a username that we
don't we know don't exist we could
immediately see that look we know that
admin exists so now we can use our word
list to check which other users exists
for example I could scrape the LinkedIn
page of only employees of the business
and try first names against last names
and so on to see is there any usernames
that exist in this system if there are
they might have a weak password that we
can attack so we're gonna default back
to attacking users it's always the
easiest way in somewhere so how do we go
about attacking this well first of all I
need to have a proxy set up a proxy just
a tool which will capture all the
requests from my web browser before they
are being sent to the web server so let
me demonstrate
I'll try to log on again with like admin
admin and right away would you see that
look it has captured my requested web
server I'm posting some data I'm posting
username admin password admin let's go
so this request when i press forward
this is what will be centered web so
right now I can edit it and I can do
whatever I want
but the interesting thing to do when
doing a username enumeration is using
what we call a father a fuzzer is just a
tool that will try multiple different
types of values within a short time span
or whatever time span was set so I just
sent my request my login request to a
fuzzer and let me edit my little request
first of all let me remove the cookie
because the cookie is gonna make the web
server have some kind of state dummy I
don't want that I want every request to
be a fresh request and then I'll define
that look this little value here admin I
replace it with some special characters
meaning that this value should be
replaced
whatever payload I said whatever value I
want it to be replaced with it will be
replaced and let's look at some values
to replace so I have a little tax file
with different user names known user
names from like Linux systems like PHP
BB and so on just a list of tip
user names okay so I've just loaded this
in here and every single one of these
text drinks will be replaced with in
here right quite simple so these values
down here it's gonna be our testing and
then I need to do some quick options
because this login field is kind of
special so it has some funky funky
settings so I need to process
redirections and I need to process
cookies and basically that's it let's
see what happens when we press attack
oops it's not gonna take ten minutes
don't worry so immediately you will see
that my system is now trying to login
with different usernames boom boom boom
boom boom boom
just different usernames Go Go Go Go Go
all with the same password admin right
so we're not really trying to log on
with any users we're just trying to see
what the error message is let me
demonstrate
the error message in my tool login fail
check your password right that means
that this username of admin exists and
also notice that the content length of
this request request the response rate
coming back from the web server its 1472
well all the other ones are 1485 right
so we have an outlier so let's sort by
those and see look suddenly we have a
pattern of what we can assume is known
user names within application that is an
a really interesting thing to find
however most pen testers today they
would classify this finding as a load
maybe medium risk finding in your
application and it probably won't
recommend you to patch it immediately
well it's perhaps it should we'll see in
a minute right so now that we have a
list of users let's take those users and
add them to the list again in our Fuster
let's define another value the password
field now we want to try all the known
user names against weak passwords and
typical weak passwords will be like for
this case if we leet hosts 2016
summer 16 Leto sucks 16 for those that
don't like their company and their
employer and so on so let me show you
how I can change my attack that for
every username I will try a full list of
passwords okay
so I'll change my attack to what they've
dubbed cluster bomb attack sounds fancy
right and I'll give it some a list of
passwords so these passwords in here
just are just like abc123
axis admin admin one two tree changed me
change me it's actually a lot of places
for default configuration on switches
and routers and stuff it's quite quite
nasty so just just a series of passwords
right let's try again
so you'll see it's trying for every
username now is trying the password AAA
and then it starts doing ABC for every
username was sorry so she's trying to
log on right and how do we determine who
it's log on well again we just sort by
the length to see what is the difference
who is the outlier here and immediately
we see that the payload on the left side
Gordon be username Gordon B seems to
have the password ABC one two three and
let's check let's check what responses
have come back from the web server sue
the render done Tonto aha it says
greetings Gordon B so a very simple
attack showing how we could actually
find the user to gain a login with let's
see
Gordon B actually this is still hanging
in my proxy so let's go back here let's
try to log on with Gordon B Gordon be
ABC you want to tree and it works right
so suddenly we now have an increased
attack surface and this is important
because this is the place most
businesses forget to test so in my pen
testing endeavors I always ask to have
credentials from a user but give me a
test users user so I can test within the
application itself because we need
to assume that the bad guys already have
access to our internal network and our
external applications as a logged in
user we have to assume that we have to
assume the worst and most likely they do
have some kind of access if they want
access so we got some functionality here
we'll look at that in a second but just
couple of quick PowerPoint slides so how
do you protect against this well we
could simply shun users or IP addresses
that make multiple failed logins right
that could be really problematic
especially when you have big customers
that are all coming from one IP and are
using your system and every day they
might have like 200 300 failed login
attempts per day for example so you
can't just block someone prayer an IP
are you could implement CAPTCHA you know
these little tax forms that will ask you
questions like find a cat whoa oh nice
oh so we got one guy giving me a hat
stop look at this stuff
and all the rest of you like haha this
guy's making a fool of himself
but let me try to duplicate it and do an
f5 and we need to go actually shouldn't
do f5 I should actually do there the
button so where you have to figure out
the pictures of the cats and you click
the cats and you can login once you have
done those things right so that works
somewhat but we can break those as well
so it helps adding a extra layer of
security you could make the attack
really slow so then so the login form
could take a really long time to process
that is actually good practice as
developers you guys should make the
login forms take a long time because the
password algorithm that you're using to
hash the passwords hopefully you are
doing that should be slow it should be
slow should take like a second or two or
three to create the password hash of the
users have password so that compare
should also take time and of course
two-factor authentication would
definitely break this attack most likely
right if I have to steal this almost
phone it would be harder so with that
we can now see what else exists on this
lab server and I'd like to remind you
though this could be game over from here
we have Gordon B's username and it's
password right what is the chances that
Gordon B is using a different password
for every single service he is using
it's quite low right I actually do it I
have a password manager and have like
unique passwords for everything so
actually I could actually show you my
Facebook password and it wouldn't really
hurt anyone because it's like this long
and if you could remember that I would
love to have you hack me like that that
would be cool but think of like VPN
endpoints a lot of businesses have some
kind of VPN login somewhere could you
just log on with Gordon be abc123 on
their VPN and have internal access to
the network
I think you could most likely you could
just port scan their network find a VPN
endpoint authenticate and it's game over
could be that easy right but no we're
gonna look at this table application
we're gonna find some exploits and we're
gonna see how we can use it to gain a
backdoor on the system so let's see back
to the web application let me do this
like that so we got we seem to have some
kind of functionality here right it
looks like a control panel of some sort
we can ping a server we can do a user
search and we have an about Us page
it's about us page is interesting
because it says that if you're worried
about security you shouldn't be because
they have everything in order all right
really you're laughing but if you think
about it what is most vendors saying to
you today well he looks security of
worried about it and don't worry we have
like best teams in the world they're all
on top of everything all right so
there's some interesting I Evert
abilities in every single picture that's
all right so so I know the developer who
made this it might be me but that
there's some interesting parameters up
here that's interesting the user search
might be connected to a database so
there might be some SQL injection going
on however for this audience
because most of you aren't security
people I'll be demonstrating the pinger
server hops so in this example it says
enter the IP address you want ping and
there's a list of the IP addresses that
most likely those are mine right those
are Gordon B's IP addresses so always
the first thing we do try try to
functionality and see how it works so
it's like ping ping that IP address one
of the lists and it gives us the reply
and this replies kind of familiar
isn't it what does it look like mmm
looks like ping yeah but it looks like
paying from windows like from the
Windows command line so immediately
we're thinking aha the developer
probably didn't want to write its own
ping in PHP or done that right so he
just made a system call down to the OS
and made it Ã´s ping for him and just
read the response from that really good
idea because then you don't have to
rewrite functionality you can basically
just reuse it and should be good right
so let's try something else like an
interesting IP address the ping would
maybe be like localhost can I pink
something else that isn't in the list
just just to learn right I'm interested
I'm curious aha I get four replies from
local host so it looks like I can ping
anything so I could perhaps try to ping
Google if I was online or like a ping
anyone I particularly with a ping if I
wanted to but do I really want to do
that no let's try something else let's
try to like add parameters like only
ping one time does this work and
immediately I got response much quicker
X so I can actually add attributes to
the ping command hmm what about like
windows and linux solaris and most
likely although asus they have a way to
concatenate commands so if you have one
command on the left side if that runs ok
run this command let's try that let's
let's see let's see let's do the
ampersand will concur it concatenate
another command let's try that dir like
show the directory contents
aha suddenly we have like some kind of
code execution right but we're limited
to the commands in the OS so what would
be like from here how would you have
this server you can run any command and
witness that it won't how would you do
it
say what peyten yeah definitely try
peyten
but we're on the windows box and let's
try it let's try Porsche all right yes
let's try PowerShell by the way if this
was Linux this would be game over from
here okay we would do like an F get back
door and we would have a fully
functional functionality back door in
within two minutes right from from here
but we still have like if 40 minutes ago
so so all the PowerShell commands and
I'll do the LS command which is
basically the same thing as dir partial
- command LS and suddenly we have the
same type of input so now we have
programming environment our hands
the attacker can no basically run any
programming Porsche programming command
command light that he wants to and that
gives us flexibility right that gives us
a heap of flexibility so let's see if we
can find something interesting for
example which user are running like can
I do like LS % user profile can I expand
variables and it looks like it can looks
like we're running as a user leet web
dot only hosts so Lee hosts like missing
7 in there I wonder why I was typo when
I set up a server I notice it like when
I started my demo and I'm like what
Spicer I'm missing a 7 stupid I was
thinking all right so we can now agree
that this is quite dangerous right we
can run anything and we can get
responses back with PowerShell so let's
do a quick recap of what actually went
wrong here and how we can defend against
this type of type of attack
so first of all developers made a
mistake they didn't properly sanitize
the input coming from the user they
didn't think that you could actually
break out of the command and actually do
different stuff so there should
definitely be some white listing and
filtering going on for sure
of that application firewall could have
rules preventing this type of attack
however in most cases we're able to
bypass those okay it just takes a little
bit more trying and failing and we can
most likely bypass without application
firewalls but they're still nice to have
don't get me wrong
also verification firewalls support
whitelisting so you can set up a red X
saying I look an IP address should only
have like three numbers and a dot one to
three numbers and the dots and so on
that would be really hard to hack
wouldn't it if the only characters that
you can input into that field was
numbers and dots I don't know how to
hack that so that's definitely something
good
what about source code analysis you
could have tools there are lots of tools
out there free and commercial that will
automatically scan your source code
source code looking for known weaknesses
like Oh hairs that blunder this is most
likely a burner because you're using the
exact command for example it's very
dangerous or you have a cross-site
scripting vulnerability because you're
not filtering so there are tools to do
that for you and of course penetration
testing would definitely find this I
mean if if your pen test team doesn't
find something as open as this yeah you
should really you should have a refund
to be honest and there's the
vulnerability scanning parts which is
basically a tool that will try to
simulate an attacker and see what's
going on but still we're not done yet
right we need more access we Moriarty
he's he's quite crazy so he's not gonna
give up from just having some kind of
remote command execution he wants full
access so preferably we want to have RDP
okay
some kind of GUI just so we can show
that the mouse is moving around and
things are happening okay so let's let's
see how that works
so bring up my firefox so how would we
go about like uploading a Baxter like
what's that all about well first we need
to create the backdoor we need to create
some kind of matter or slash virus to
actually help us out that's quite simple
so it's actually super simple today
because as they do in the developer
world they also do in the security
industry they try to make things as
simple as possible to like show the
impact of something right so right here
is my server I'm not gonna touch that
because that would be cheating but here
is my Linux hopefully things are working
you never know but let's see actually
there's some debugging from before let
me check my IP address looks like I'm on
the same network you can all see that
right in the back they said ok sighs
good stuff so I'm on the same network so
I should be able to ping one or two 68
looks good right
so in Kali Linux there is a tool called
MSF venom it's packaged within a
framework called Metasploit and mr.
venom allows us to create viruses we can
create partial viruses visual basic
viruses Linux viruses and executable
files so let's create an executable file
let's see if I have I have a little
cheat sheet I'm gonna copy paste
something just because it makes things
easier and you guys don't want to show
you you don't really want to see my
typos going on everywhere so let's paste
that in here so I'm telling my little
MSF venom tool that I want to create an
executable with payloads meterpreter
meterpreter is an in-memory rootkit for
windows it will allow me full access to
the system with the correct width
permissions the user is running us so
that's the first part here and then we
have a remote connection coming back to
us so we're telling anyone who is
clicking our file that we will we're
creating how they should be connecting
back to our IP address
so normally this would be an online IP
address right I would have my domain
name in there
I have a special pentesting domain name
which are used to this stuff and which
port they should connect down so this
will bypass every single firewall rule
in a world most likely because people
are not filtering where they are allowed
to go on the Internet
most of people aren't and we'll put this
inside our web server so let's see can I
actually visit this my own attacking
machine now and see if there's a
backdoor galaxy yes so when I visit my
little URL from the attacker machine
appeared this is my Linux box we have
our payload ready the executable is
ready to to be sent somewhere right
how do we get this file on board well
with PowerShell maybe some of you guys
notice already but you can actually do
just about everything with PowerShell
okay so we can actually do a simple
command called invoke web requests and
it will actually pretend to be a little
browser and we'll go out online pulling
down whatever file you want that's
interesting let me copy that little
command as well from the cheat sheet
just to make sure we don't have typos so
I'll show you so we do that PowerShell
this is our command injection right we
are PowerShell - command invoked web
requests really nice commandlets and we
point it to our attacker IP address we
point it to the back door guard Exe I'm
sorry if it's a little bit small and we
said look this file should be written to
the user profile which is people's home
directory right lustre slash user slash
lead host and so on and we'll name the
file back target exe let's see what
happens
did I think
oh yeah I did click looks like it
clicked let's see if we can see if the
file has been written so we'll do LS
user profile and well we now suddenly
have a file on the system we told
PowerShell through the web server - hey
go out to the Internet pull down a file
pulldown malware and store it on the
system but we haven't executed anything
every no we just we just downloaded it
before we run it though we need to set
up a server we need to have some kind of
way to process a backdoor coming back to
us so for that I'm going to be I'm gonna
be using the Metasploit framework
basically it's a framework for hacking
makes things simple let's see if we can
find it should have it up in the
background here we have some options
just verifying that everything is
looking good and I'll set up my little
server so this server will just wait for
anyone who is trying to connect back to
me with them with the virus I've created
and if they are clicking on a virus
connecting back to me we should interact
with it and have some kind of remote
control so let's see what happens if we
click the file huh you click the file
well you don't really click the file but
you run the file right you use partial
don't even need to use partial it's just
to ampersand user profile slash back to
order XE this should run the commands in
it just like you would run ping from our
system 32 or Windows folder this should
run this executable so let's see it's
just hanging oh it doesn't return
anything right that's interesting
because it's waiting for this executable
to complete just like it was waiting for
ping to complete it's waiting for
backdoor to complete and back towards
connecting back to me so let's look at
our Linux and see if we have anything
going on we do it says look mature
interpreter session 2 has been opened
you have an incoming connection from
this vApp server interesting let's try
to interact with it suddenly we have
command execution from a shell so we can
run the IRL oh sorry LS we can type get
UID for example or let's do help let's
look at the commands we can actually run
from this so I can kill any process that
process that I want to I can migrate my
process so instead of being inside the
Apache web server I can migrate the full
rootkit the code of it true memory into
for example explorer.exe because
explored that exe is never closed right
it's going to persist my malware
ensuring that it won't get closed when
someone reboots the web server or a
thread or or application pool dies for
example so it's very nice functionality
I can cat files you can remove files I
can upload files I can at the typical
networking commands here and some
interesting ones are I can do a key scan
start this is a key logger so I can just
start the key logger have you running
for 24 hours
dump the output tomorrow and I'll have
whatever is typed on a keyboard on this
from the server on my system that's
really really nice I could even if this
was a client PC right if this wasn't a
server I could activate that camera and
take a little snapshot of whoever
sitting behind the screen I could even
have his stream data from me
and I've done this a couple of times
specifically for tv2 a big news channel
in Norway and I've done it I guess still
a dealing of a news anchor he asked me
like the day before my interview you
asked me hey is it like can you hack my
facebook this is simple no it's not
really simple to hack facebook but it
could be simple to a queue are you
giving me permissions and it's like well
yeah why not yeah for sure I got a
screenshot of him his face is kind of
and I also did it to another reporter in
tv2 and they're using this material
actually for for internal training right
now to try educate people better to
don't click viruses basically so lots of
different cool commands which
from here so this is our back door
running right and that's all nice and
good but let's look at some defenses
from this no wait we were we told you
that we're gonna gain early P sorry this
is not our DP this is only like a
command axis so let's look at how we can
get some our DP action there so on a
system the first thing an attacker will
do if it's remotely good okay he's going
to try dump the password hashes from the
system that means it's going to try to
gain the passwords but they're not in
clear-text most of the time they're
hashed so he wants those so it can start
cracking them to try to gain passwords
because they can be used elsewhere as
well so for that I want to upload some
file so false so my little tool here
meterpreter my little backdoor supports
uploading files as we saw in the help
list I could simply say I want to did
you see that
I should be offline so I don't want any
like emails popping up but hey Chris
there was a really fun last night I
don't want that stuff to happen so I'm
going to be uploading my kids my files
my I have a little sip file right with
all my life hacker tools that I want
onto the system most attackers or
hackers they have their own kit and will
upload a kid because it has some
interesting features well let's see it's
18 megabytes it's fine it looks like it
uploaded so from here I kind of like
going back to the Windows command line
so I'll stop shell and look at that we
have like the Windows command line at
our service so from here I could do like
CD - he thought whatever I could do
there I could just see the users I just
he delete grabbed out late host except
they are I could see that look I have my
sauce uploaded so here's my backdoor
that we're currently running right we're
inside this factored exe but just
uploaded these files
from meterpreter so it's a zip file
right how do you unzip from the command
line
in Windows what you wish you wish it was
just like unzip like it would be in any
other operating system like Linux for
example let's try and sit nothing that
will help you on sip on Windows from the
command line
except partial and I'll be honest I'll
be honest though I'm not gonna try type
this command because it's hilariously
long look at this stuff
this is unzipping from the command line
windows if anyone ever has a better way
of doing this than this way let me know
after my talk ok but this should
hopefully extract my thoughts and look
at that we have our false extractor
that's good stuff so inside here I have
a tool called mini cats
it's from github that's fine it's an
it's a really nice tool that will try to
look true it will scrape through a
memory looking for passwords in
clear-text and having a hashed form this
tool is is actually very very nice for
attackers to use let's run it I believe
we need to have the debug privileges
oops that's the type of that's why we do
the copy pasting right privilege debug
so that means I'm granting this tool to
have debug privileges inside windows and
I know there's a lot of dotnet developer
sirs here so you might know what the
debug privilege means for user in
Windows local administrators normally
have debug privileges it means that a
process can interact with another
process debugging it and also having its
code run inside other processes code and
even access the memory space of those
processes so that's what we're doing
here if we didn't have local admin in
this case it wouldn't happen so let's
cover that in a bit ok then we'll do
secure LSA
long on password again typo let's just
do the copy pasting phrase it's no
problem much easier to just do a
copy-paste will tell mimic cats to look
for a log on passwords and we have a
long list of output let's look at these
things the first thing we have is an
interactive logon to the computer from
the administrator and this user has no
password interesting there is a hash
here that we could crack or we could use
as a notification mechanism but still
there's no password in clear text that's
because Windows Server 2012 r2 actually
has something called protected admin so
they try not to store the users clear
tax password in memory so it's a really
good security feature added by Windows
and let's look for different things here
look at this suddenly we have the verb
user the password in clear text because
that user wasn't covered by the
protected admin module so mimic a simply
took the password straight out of memory
and we could use this for remote or
navigation that's no fun is it it's just
having the password sir Jack's not so
this ntlm hash that I've highlighted is
the password representation right so
let's just pretend we don't have any
clear text password ok let's crack this
little sucker
so for cracking I will be using a tool
called hash cat hash cat will interact
with my GPU and it will try supermanny
will actually try to crack they will try
to crack 66,000 mm plus three zeros
right like 66 millionths 6.6 million
passwords a second it's gonna try
cracking the hash so I have a word list
right with 58 million words in it my
word list will be what we call mangled
so I'm going to try
leet-speak replacement so every I will
be replaced with an one every I will add
exclamation marks automatically add like
2016 behind every word and I'll crack it
and running this GPU tracking tool it's
super quick and we can see that the
password crack almost instantly this
hash which I copy pasted represented the
password manager double-oh-seven
so really from here all we have to do
hopefully is try to authenticate no
that's the domain controller let's see
the username is correct so let's through
manager double-oh-seven aha so we could
suddenly log on to the web server that's
cool and as any good attacker does the
first thing you do when you hack
something is you bring up the terminal
window because you don't really need a
GUI right you really don't need a GUI
let's see yeah so we are running as this
user let's see
leet web so that's interesting we can
now browse through the system we could
like look for network machines if
there's anything on here look through a
local disk look through your scripts
that is hosted from for example Apache
so we cannot basically do whatever
access this user have from the GUI a lot
of people appreciate the GUI but we
don't really need it as you've seen so
let's cover some defenses for this
because it's kind of important kind of
report not to have this happen to your
environment
first of all believe it or not antivirus
could help all right it could help so
we'll bypass antivirus no problem ok any
time to the week will bypass antivirus
however we're lazy attackers are very
often Laci so they'll get caught a
couple of times by the antivirus while
they're trying and failing and that will
create alarms in your environment so
hopefully your IT operations will
actually react to those alarms and check
out why this web server is acting
strangely right
also your file rules should never allow
a server to talk to the internet why
would your servers be allowed to talk to
anyone on the Internet it's quite stupid
you should allow connections coming in
and you should allow your server to
reply to those connections that's a
stateful firewall right but you should
not allow this web server to initiate
connections to anyone on internet that's
just bad practice and again our user the
web user was 'dom a local admin and
that's interesting why was it local
admin well turns out that IT operations
have big problems with permissions when
those permissions is health and
basically to fix the problem they just
gave the user all the permissions and it
worked and they're like ah that's
convenient and they lost it like that
but this user is not domain admin okay
so he doesn't have any access except
access to the web server while domain
admin access means access to the entire
kingdom keys to the kingdom
okay so we're going to go back to the
demo and look at how can we use our
access to elevate our privileges to
become domain admin that's our next goal
so let's look at this server again then
we'll be you saying we can use let's see
you closed this one
I think we can just use the RDP that
should work because I mean it's a
legitimate connection right we are in
hacker we're on top of server so let's
see let's go back to our files see which
other files we have on our system so
what when I uploaded files my little
tool kids my kids
we also uploaded something called a PI
tag does anyone know what the pie cake
is it's a Titan Kerberos exploit kit mmm
and Kurvers it's authentic Asian
protocol for Microsoft and Windows
machines right Microsoft Windows
machines those are those are most likely
all using Kerberos for authentication
it's quite good protocol however in 2014
late 2014 there was a witness update
patch you guys know those rights witness
updates they're kind of important
actually there was one patch and Miss
14-0 6 8 so 14 means that it was
released in 2014 and 68 is a number
they've given it it was a vulnerability
that allowed anyone to create a fake
Kerberos authentication ticket
pretending to be domain admin that is
bad any domain user can suddenly become
king in your environment can you imagine
that if you don't patch that immediately
any willy-nilly script kiddie or or
anyone who wants to take full access to
your kingdom could do it just like that
and I'll show you just like that it
would be kind of embarrassing if this
demo fail right now as a prize just
gonna be like that and I can't do it
right so let's run up by CAC and let's
see what it's all about
so I've downloaded that the proof of
concept code that will allow me to run
this this code this little file I'll run
it first let's see let's see how it
behaves like we have time looks good
oh sorry
peyten
so this script requires some parameters
first of all it requires the SID
the user's SID then it needs to have the
domain controllers IP address and the
domain we're talking to so the sid is
basically this long string up here so
it's no it's no secret it's just your
unique identifier to the domain so it's
not really a lot of advanced stuff going
on here so I'm going to give these
parameters to the tool and let's see if
we can create a ticket and it requires a
password so that's the interesting thing
right we need to have some kind of
password in clear text and our password
was yes managers e-reserves Evan I had
my demo fail once because I typed in
master double-oh-seven multiple times
manager double-oh-seven I will never do
that mistake again so it gives us a lot
of dumb messages looks good right we
type dir and we have a little file here
this file is basically a ticket granting
ticket it's basically a ticket giving us
authentication but it's just as a file
right we need some way to load it into
the system actually we'll be loading it
into memory and we'll be doing that
using a different tool called mimic ads
which has a lot of Kurvers interaction
modules as well so mimic as support
interacting with Kerberos tickets and
we'll use mimic apps to push this ticket
inside our memory
so let's CD into the correct directory
Oh
i'ma get drunk so mimikatz can be run
interactively or it can be run from the
command line right now I'll run it
strictly from the command line giving it
the parameters to pass this ticket into
memory and I'll point it to C colon
slash users and our user that the user
file I just rated ticket fault and I'll
exit immediately let's try this actually
wait before I do I promise you I wasn't
domain admin right
challenge me well he's lying he's
probably domain admin all right yes I'm
not a domain admin so let's check okay
let's do a net user group domain admins
and see the users in the domain admin
group
it's the administrator only one user
right let me try also net use let me
copy that command because my host name
for the domain control is hilariously
bad let me try to mount the C Drive okay
the C Drive of the domain controller you
shouldn't be able to to interact with
that drive and browse the files unless
you have permissions and as you can see
that it's giving me the prompt to enter
your username and password that means it
already tried your credentials as the
elite web user and it didn't work so
please give me the permissions will
cancel out that and that's a proof of
concept I just showed you we don't have
access rights and let's now load this
little ticket to the memory let's see
there is
looks good did you see that you never
know what kind of information you will
be showing people so I just listed off
my tickets and to be honest it looks
good let's try the net use again
basically I'm mapping a network drive
nope let's see win-win-win but ok let's
first let's do this again I just removed
all tickets oh it doesn't work so I said
it would be embarrassing if it didn't
work and it's actually quite
embarrassing right now but just give me
a second to debug let's see let's see we
have let's see I think we need to look
at our ticket let's see how our command
ran let's see this one let's see we're
giving you this Python script yeah we're
giving it a user name a domain we're
giving the SID
and I verify the city rule today it
should work and the mainly host so that
should work let's actually create
another ticket because I think something
went wrong you never know and these
things they've been written to be easy
but they're not like super robust so you
never know right see it's running one
more time
nope wrong command let's see we have our
command up here this one and to be
honest it looks good to me
manager double-oh-seven that's my
password bad way so check it out try it
my LinkedIn and so on I'm just kidding
and yeah it did say done on everything
so let's go back to mimic Apps try one
more time it doesn't work I'll show you
guys still so don't worry about it
so no I want to purge my take is first
first just remove all the tickets all
the authentication takers you already
have on the system just remove those so
you have a clear clean slate right looks
currently web Plato's would be cool if
it's actually worth but they're honest
truth though it's a I tested this like
30 minutes before I came down here for a
demo and and I reboot it just to make
sure that there wasn't any caching going
on oh and it worked right oh nice
thank you thank you nice nice so let's
browse the domain controller let's look
in the windows directory let's look in
system 32 let's look for a very specific
file that is called NTDs dubbed it this
file 8.4 gigabytes
what file is this ad this is active
directory okay copy this file back to
your own system you have all the user
hashes of all the users in the domain
alright let's just look at a couple of
things here so while I'm wrong we forgot
Windows Update I have clients that
refuses to patch domain controllers
because they are afraid they will crash
while they are doing so if the domain
controllers go down everything goes down
so there are most vulnerable services in
the entire organization multinational
companies is the domain controller so I
haven't passed this specifically this I
forced them to patch this so definitely
when it's updates matter but I want to
bring up a scenario which I'm not gonna
demo because it takes a little while but
with this ad dumped I have a very
specific of special users password hash
the krbtgt user this user is a user that
creates tickets if I have that users
hash I can basically create tickets to
my own on demand whenever I want to and
I can create
gets that will grant me 10 years for
example of domain admin to your
environment and how do you fix that
well it turns out that if you change
your krbtgt hash the password if you
change the password two times my ticket
will be invalidated and I would have to
hack them again and dump the hash but
two times it goes two times because a
password rotation and a history it has
to rotate so it doesn't remember the
hash I had when I dumped it and just if
you try to reset that user two times
you're gonna have health it's not gonna
be pretty
your link is gonna die exchange is
probably gonna die you're gonna have
stuff happening that you can't explain
because so many things for is relying on
having week long tickets in their
systems so when suddenly all the tickets
are invalidated things stopped working
so normally you would have to like wait
a week and then reset the second time
giving the attacker a lot of time to
regain his foothold dump the hashes
again try to compromise different users
compromised domain admins that that
didn't reset their password and so on
it's really really hard to recover from
all right so I think we're on time is
there any questions because we have five
minutes don't we five minutes yeah sir
is there any questions on this hacking
activities I expect there to be
questions because I'm Norwegian and
you're Norwegians and everyone is saying
that Norwegians they don't ask questions
so bring it on come on go oh definitely
you could but not on a domain controller
so this patch is for the domain control
but I love the idea though to uninstall
the protective mechanisms we do that for
a V sometimes when we have local admin
good question all right are you in the
wigeon I represent
nice anyone else before we finish our
cake oh it's a very valid question so
this tool is open source so you can go
manually and review the first code for
many of my tools and my team we actually
do source code review before we use
tools especially new tools that have
just been released there are multiple
cases online where we're seeing people
releasing some kind of tool and it's
actually infected right so you certainly
have access to a security researchers PC
because they were dumb enough to run
your tool without checking it but tools
such as like Metasploit meterpreter
amazon venom those have been scrutinized
by the security industry for many many
many years is a very highly renowned
company called rapid7 which is
developing it and they have a quite good
reputation so it's sort speak right so
that's nice at least that gives you some
assurance anyone else all right
so thank you very much everyone I'm glad
we got a full pack of people in here
thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>