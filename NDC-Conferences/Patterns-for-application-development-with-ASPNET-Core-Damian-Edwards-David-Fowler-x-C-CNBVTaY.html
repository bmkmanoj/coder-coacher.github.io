<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Patterns for application development with ASP.NET Core - Damian Edwards &amp; David Fowler | Coder Coacher - Coaching Coders</title><meta content="Patterns for application development with ASP.NET Core - Damian Edwards &amp; David Fowler - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Patterns for application development with ASP.NET Core - Damian Edwards &amp; David Fowler</b></h2><h5 class="post__date">2017-02-15</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/x-C-CNBVTaY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey welcome welcome
it's a full room this time
dining at the back hopefully it's
exciting enough to keep you standing for
a full hour
I am Damien Edwards David Felder it's
mr. Fowler yep we're going to talk about
some stuff that we've seen nice
kinetochores been out for six months six
months is that one six months feels like
longer because we've been working on it
for about four and a half years yeah and
we're still not quite finished yet so
but we've seen a bunch of stuff now
we've had calls internally from
Microsoft support engineers or the
people who helped you when you have
trouble with your apps who have seen
some things with Team Lafleur get Stack
Overflow yeah github issues the slack
Twitter and so you know in our own
experience as well we wanted to share a
bunch of things that we've seen that are
either good or some things that aren't
so good and what you should do to avoid
are those pitfalls some of them are
pretty bad some of them are like just
you could do it the better way so
without further ado let's get into it
right into it first of all actually how
many people are using hu neck or right
now in production excellent that's like
half the room at least that's awesome
that's fantastic alright very good
logging you should always configure a
logger we added this new ilogger
abstraction in the ethernet core
technically you can use it anywhere but
it's used throughout Ethernet core and
it's not only for you we use it so if
you want to like diagnose stuff routing
or EF see the queries that are going
over the wire the kestrel and
connections start and stop as well as
requests all those things we log per
dish ously from throughout the framework
and you can configure that stuff so you
can see and obviously you can log
yourself which you should probably do if
you want to be able to diagnose stuff
later on in production so you should
always have one set up in production now
by default the application templates
that you've used so far do a terrible
thing and they configure a console
logger by default which runs even in
production now it does configure it I
think at the information velocity level
for all log areas which is probably I
mean that was really intended for you to
see it as a developer at the command
line not really intended
that you want to capture every
information level log forever with your
app running in production and route it
through the console which takes a global
lock doesn't do great things for your
performance and so I would recommend you
don't do that we actually have changed
the templates to only do that in
development load and then we tweak the
settings in production so that we only
capture warnings or higher the in
production you should probably use a
real logger and plug that into our
logging system behind the abstraction
like Sarah log application insights or
then pick your favorite logging
technology and help elk you know
whatever log stash and whatever you want
to use it's a great first step to use
logging to help diagnose problems so in
the path for example if you were trying
to diagnose route issues you might use
the great route debugger utility I think
still hang hydro long road I can go but
now because we log so much by default
and it's very very easy to get to see
this stuff it's a really great first
step to dial up the logging verbosity
from information to like debug or even
trace if you'll just want to see
everything that gets spat out by our
stuff and then you can you know it
really shows you the steps going on
inside the framework when you're trying
to diagnose a problem you can change the
velocity without having to restart the
app and so the templates are set up by
default with a configuration file that
you can use and you can just flip those
things on the fly and change the upload
look at that the minute to avoid logging
too much you can also tweak the category
so every log message goes through a
specific category and you can change the
velocity per category and you can turn
it off completely for other categories
and again by default we kind of set up
the template to capture information for
all logs and then the idea is that you
can go in and put specific categories
and dial them all the way up and turn on
the ones all the way down depending on
what it is you're trying to do and then
the other thing is that there are other
places that we do log so a NCM or the
asp net core module which is the part of
IAS is the module we install into if's
at launches net XE and runs your
application that will log to the Windows
Event log when it fails to launch the
process so if you get the dreaded white
screen of death the iaf screen of death
with like 503 - whatever it is if if the
app process can't be started which is a
terrible thing to get because but I have
no idea what my app isn't running it
means that it couldn't start the process
it'll love to the Windows Event log only
give you a little bit more information
as to why and then you can go in and
turn on stand it out capturing which the
module allows you to do and then hope
you'll get the stack like an exception
in there and you can actually get a
really good idea of why that's there and
if his unhandled exceptions a log to the
configure blogger providers by default
that's request exception yet to be
specific you guys on background thread
in it throws and we're not going to know
about it but if a request faults and the
exception unwinds all the way back to
the host to kestrel all the while the
hosting layer then we will log that by
default to the local providers so let's
have a quick look at an example of that
I'll actually I'll create a new app it
might be easier so I'm going to use 2017
here because you know why not I may as
well just use the latest stuff and throw
caution to the wind and hope that
nothing crashes anyone using 2017 RC yep
they say as far as chilling ok is it
good yeah amazing I know it's wonderful
yeah it's getting better there'll be a
new build soon very soon hopefully in
the next week or so didn't hear the
tourney fixes and has tons and tons and
tons of fixes especially kinetochore
okay so the dotnet calling is getting
better and better every day
I actually have a private internal build
running down here which I'm not going to
show you side by side which is a new
feature of Visual Studio 2017 you can
run different builds side by side which
is really nice so if I look inside my
apps settings here in a file new you can
see I have this logging information so
here the log levels are being configured
by this JSON file and that's passed into
my startup CS all the way down here
where I configure the logger so I'm
adding the console logger here and it
passes in this logging section so if I
run this application and I'm going to
run it directly rather than through ice
Express so I can see the console I wash
the debugger I probably didn't have to
do that did I could have just launched
it alright I get the explain I can see
this thing it's not a problem
so my application is going to start and
I get the get a browser to do so we can
see some log information coming through
here and by default we're just logging
our info okay we're not logging any
higher than that we still get a fair bit
of data which is going to know
all the static files are going through
here as well so I'm getting every single
request is being logged but I can choose
to come in here and I could dial up this
to like debug and then if I go back and
I run the request again you start seeing
now we get these debug level messages as
well so we're getting a higher verbosity
of messages from the framework so now
kestrel is telling us about the tcp
connection not just the request okay so
that's a really nice trick to when you
start to try and diagnose stuff you can
see here that MVC is reporting that it's
looking up the view and there was a
cache hit so it doesn't have to
recompile the view okay so you get
really really deep information about
what's going on the application just by
tweaking some of these things that are
in the default template now this file
driven config for logging right now we
only support that for the console worker
but we have a bag of logs and we intend
to extend that support to more logger
providers because you know frankly to be
really nice to be able to have
application insights logging for example
you'd be able to tweak that on the fly
without having to restart the app or any
other logger for that example for that
matter - okay so the other last thing I
want to show you quickly with logging is
in the weather context file where you
configure a NCM the HP net core module
that boots dotnet XE when you're running
in is there's this flag over here
standard log enabled a sender Logan
abled it's false what you can do here is
set that to true and then when I'm
running under is when I flip this back
to is Express it's going to try and
write out a file to this location here
so I'm going to create a logs folder
because it won't create the folder for
you although I think we have a bug to
get that fixed and we know we don't know
so if you can't figure out why it's not
working
the folder has to be good this actually
totally intuitively is the prefix for
the files that will be created not a
folder alright as you'll see in a moment
so if I run this now and of course I've
dialed my flag my logging up to like 400
right so I'm going to have lots and lots
of information going into text files in
my app now so I'm the dotnet XE is
logging to the console and then is is
capturing that information for me and
not doing usual because I don't see a
file there
fala what I do the run huh what I do
wrong better work then see it like it's
there oh it's right there there it is
not looking yeah
there it is and I my mouse to slid off
the podium which is why I'm making you
fall through all this now and there it
is right there so all the way to
clearest what's that kill the process
now yeah because it's locked by the PSS
so let me go ahead and stop debugging or
come down here and kill lice Express yes
and then now I get come on like okay
that is the some other total problem
with the build that I'm running let's
just do the old-fashioned way so now I
can see all those logs as they were
funneled through is Express again I
don't recommend that you do that in
production because that's going to slow
down your site considerably if you're
capturing everything through all the
logs through console and you have a
success and make it not be in line and
lock in lines we do have trying to make
that better Andy yeah so we're actually
going to fix in process now to make the
console logger basically buffer and go
by background thread yeah so it doesn't
lock so anyway all right configuration
options we have a whole new config
system and this options strongly-typed
binding system for flowing config
throughout your app in Ethernet core
we've probably talked about conjugal
lock we tend not to talk about options
too much I think we should but we can
show you a couple things here
configuration supports reloading based
on file changes that's exactly what we
just showed you so that log file the app
settings that Jason those settings were
flowing through the config system into
the logging system and then when I
change the file a change propagation
takes place and that goes all the way
through into the logging provider and
reloads those settings for you so that's
kind of nice you can use that for your
own stuff yeah so if you want to change
the connection string on the fly while
the app is running for whatever reason
you could do that for any setting that
you have in a file based provider we
support that right out of the box in 1.1
we added support for reloading options
as well so the typical pattern is that
you'll have configuration which you read
from various providers the environment
variables files on disk whatever other
provider that you write and then you
bind those name value pairs because
they're just strings at that point on to
rich objects going on to options objects
using the options binding system in one
oh that was a one-way one-time thing and
then the options object goes into the DI
container cuz I've white and you resolve
it once and you use that throughout your
app in one one we added the I option
snapshot interface
which allows you to get a snapshot of
the current options but then ask for it
to be refreshed at any point in time
which means that if the options
themselves were bound from a contact
provider that supports changed
notification you can now get your
strongly type objects that represent
your conflict rebound on the fly while
the application is running which is
really really nice in cases where you
need to configure options objects and
just to remind you options just aren't
for your code we use the option system
to configure our own framework so when
you use MVC and you want to change some
features of MVC you'll often use the MVC
options type and you'll change settings
on that okay in the startup code of your
application if you have a complicated
set of logic that you need to set up an
object or an options object you can
actually put a service in the container
that says I configure options of this
type and the advantage of that is now
you can activate that service if you
depend on other services in DI because
it's kind of this reentrant problem
right so you don't want to have to put a
lamb's or inline in the configure
services code I'll get services and then
like get everything in the constructor
which you can't because the things won't
be the container is not there yet how
did this last time thing you have to
worry about so if you when you're
configuring options if you need other
things from the container you can simply
create a type implement this interface
put that type in the container and then
anytime anywhere in your app someone
says I need this options object your
options configuration type will run okay
that includes getting stuff out of the
container I'll show you an example in a
minute this is just a best practice type
of thing
generally the the advice in terms of
environmental configuration so that's
config that's unique to a specific
environment so development staging test
products cetera you want to keep that
configuration as close to the
environment or in the environment if
possible so that you don't have
configuration for one environment it has
to be managed somewhere else and then
flowed with your application and that's
one of the primary reasons we designed
the context and the way we did and the
whole environment name system in a
spinet course so you can have config
that comes from places that
traditionally live on the server or in
the environment that you're running in
so for example use environment variables
so that they live on the server so when
you set up the server if you're running
in Asia or an environment like that you
can set it once and then it flows in or
use config stories that you'll
and provides so something like as your
keyboard its escape yeah so keyboard
isn't the easiest system exterior today
it's very secure very secure your own
car to use we have we we shipped a key
volt config provider within worth in one
one to consider which the the costly the
trouble there is it generally to connect
to something as complicated as keyboard
you need config to control the keys and
the connection string and stuff like
that and so but there is a provider so
as long as you can get the connection
string for your keyboard and this client
cert or whatever it requires for you to
connect from some other mechanism so
maybe you put it environment variable
read it manually or create our first
round of config that reads from the
environment build that config object and
then flow that one into the second one
so you can connect the keyboard are we
support that now we have an inbuilt
provider that you can certainly get
package you can grab and there is
probably an example of the in the repo I
imagine all that there is our opening
down there is there in the in the repo
for that and if not just ping us and
we'll give you one the last thing that
you can do is you can actually set
environment variables that are local to
your application when you're running in
is via the website config file which
hasn't always been true in I fi think
this is added in is 1010 maybe but we
can do it in the NCM module so if you're
running on dotnet core and you're
running on is on Windows 2008 r2 or 2012
you can do this because the core module
itself supports ending environment
forever we've seen lots of customers you
go I need to set the environment
variable they set it on the machine
that is is running on so just as it
flows to the one app you don't need to
do that you can just do in the web the
config file for that one app okay it's
much more isolated so that's a good way
of doing that as well oh I was going to
do a demo here wasn't what we're going
to do oh yes so just an example of this
I configure option stuff that I was
talking about this is my project that
runs the live asp net website that runs
the community stand up every week and if
I look in my startup class here down in
this section
oops that was the wrong key down in this
section here arm I
and you do adding and I configure
options here somewhere I saw it just
before right down down then down right
there little there so this line here
this death by generics line 54 so I'm
using a new version of the application
insights SDK for up the freights net
core which is currently in Vida which
will RPM soon which greatly simplifies
setting up a pin sites with a spinet
core which is nice and it has an options
object that you can use to configure it
which is great it's like a lot of the
things but I needed to set options on
that based on the current environment so
if I'm in production I want to do this
if I'm in development all under that to
get the current environment I need the I
hosting environment interface which is
in the container so I could capture it
kind of up here put it in a variable and
then use in here but it just makes the
startup cost get a little messy so I
encapsulated all that in this type which
is in my application ok so it implements
I configure options of application
insert service options I take in on this
case was actually deployment environment
sorry not hosting environment it is my
type and so now I can set this option
here and also get stuff from di it's
very very simple
so there's generally a way in Ethernet
call of either di system to register
services does a whole bunch of other
things and it used the I container to
get things that you need so that's a
very very simple way of doing that ok
I'm not going to do the environment
variable once more yeah I'm not going to
do that
alright file upload you can do this one
ok ok so the file it is pretty scary um
anyone support support say that these
handles are loads no one never did that
no no one has file no you've uploaded
little islands so if you in a spec where
we have a slit between content route and
web root whoever is for web possibly
served by the by the web server the
country where source code and that's
place because we want nan is based web
service and not serve random files so in
the past I had a giant web as I said I
can serve these file types and in the
future all we want to do this a point is
to the web folder so it can only serve
files or affricate files for content and
your code files never actually got
served by the web browser so if you want
to have your elbow default served by the
web server you have to put in the web
root right all right so in nmbc there's
a way to have to model bind an i form
pub to the new your charts gonna be high
infinite core from getting files or you
can bind a knife form collection in the
past in the past I think it with an eye
for eye form motives are something that
a new type type for this thing if you if
you're a middle where I get to get the
form you call a read form a sink or but
form and that gives you the entire form
its file as well if you start form is
that a blocking call right so yes so
forms bad you want to use reform async
first that's a blocking call very
promising you kind of want to use the
async version if you can you should use
value how could it think it's bad
yeah just to make that really clear yeah
if you use HP context or form after
it'll wear and you haven't had something
else for this read the reformatory for
may think on your behalf it becomes yeah
then you've now blocked a thread yep
while you upload your living area router
to the server okay yeah doesn't all go
into memory which we'll talk about a
minute but still you don't want to do
that so those who call that please lower
error if you aren't in a form based
request you have to check the has form
content site before calling reform I
think which happens in MC for you on
your behalf don't worry about a few tnbc
it's interesting in if your net of the
past you can actually upload CSV files
to app code or upload a view files to
the view folder and look at brenell on
the server so if you're trying to
actually build on that premise orchard
and other CMS's should I let you upload
got a new kind of content have pretty
much remote quit execution on the server
side so if you don't want to you kind of
want to make sure you are you aren't
allowing uploads of these kind of files
on your server so definitely what from
by defaults for your server side stuff
if the file uploaded is above 64 K I
believe we start buffering to disk on
your behalf so when you call read stream
we actually save the content on this so
you don't block memory with a giant
piles of good
can you change where it gets in change
where it gets saved by changing out a
few on that core underscore 10th path
I gotta fall asleep your temp folder
okay there's a pretty good one so when
someone elbows the file the file name
comes from the client side which can't
trust the client is untrustworthy so by
default if you take that path and
and you pass them by an escape to disk
and it has like a pot reversal to your C
Drive you don't wanna save files like on
your hard drive but of course your app
is running as a low mileage account so
never happen don't sudo a run you're a
server and like give admin privileges if
you're doing if you want to do very a
manual parsing of the body we have type
that leg you guys fit the actual
multi-part body so you can read the
actual thing it's been 15 years one day
and this is the first time we've had
anything in the framework that lets you
do this it's super nice it's actually
really does anyone ever tried to process
like very large file uploads on a spur
net manually manually yeah yeah it's
horrible
if you have to pass my multi-part mime
encoding yourself whereas now we
actually have a thing that does it for
you which is great oh yeah I love life
and you're behind is yeah so request
filtering tool applies 1963 on your
house let's brighten it up I don't have
a Mac so I forgot to use this computer
alright so here's the sample pretty
benign code file upload was pretty
simple right gonna zoom slightly oh yeah
oh good control skull control control
well that's not my goodness such a Mac
user know the kind of this thing is
awful
alright so upload the action takes a a
nice warm file and I'm saying I want to
get it from the forum the name was
defeatist data find an eye forum file
get that file open the stream half
combine the content root which is my
code root of the site and pop the file
name and then create that file copies
copy the input stream into the AOPA
stream pretty simple right alright let's
hop there's no this hack make like so
I'm going to watch this in the browser
some day
what
oh I'm impacted already Oh God you money
to reset it don't delete that follow my
carring ruin the entire demo get back
right there in the root oh yeah delete
preserve didn't happen it was so easy to
hack even I did it oh this is I think
start stuffing configuration all right
run it again and followed you know I
need fiddler to put all this stuff let's
upload your file submit what's the
market want to blame me somehow what did
you do what you bark at you bark the
demo dude
what a lot is it locked you know what
this is gonna work hit refresh try again
five that's perfect
Longsight guess that works
I have a file in my root benign find so
far nothing bad now I mean look you
can't rename a file to have dot slash
but what's flash of any flash or
something that I think even honest you
can't do that icon so instead what a
good hacker would do is don't let's get
it from telluric and change the request
that was needed zoom into this the
control flux what's the green tool water
only minute applause all right
right-click I'm going to edit this
upload request replay edit and then I'm
going to change with the body this will
raw
alright let's change this to oh my good
yeah it kind of smells out the Lexus
like it let me use this up good I got it
let's change this to fuse all caps fuse
a time home so that looks legit perfect
and this change the content hack
wonderful trend a few laughing Serge's
okay let me zoom out change here and now
should I perfect alright so if i refresh
this page now yeah wonderful
okay so don't take Stefan the cuts from
the client and ever use it on the server
side because clean the names right so so
I think that's probably if you want to
serve these files you want to store it
with a grid pick a random name that is
of that is that file map that the client
file name for your random grid and then
serve that via like started follow but
wherever by exclude something but don't
use what the client sends you like
verbatim this kind of league's best part
in what scenarios I think that was the
only Center okay Wharton is one more
sample we have a repository called
entropy which is a I believe is
described as a chaotic playground some
experimental safety net that's not how
you spell it
there we go alright so here is a sample
a sample ricotta that has a bunch of
samples of things that are kind of uh
not at you but it kind of not the main
listener Scripps Networks Inc
so as an example there is a multi-part
fault load sample that shows you how to
use the actual low-level API is to parse
the request body so as an example we
have the text the the content styrofoam
depart content does the runners parts
and using the most part Reader API we
have in the framework no call it to be
nekked async so you can not be read the
actual multi-part request without having
to park yourself manually
nice so this where entropy because
they're a bunch of cool samples in here
that are kind of like fringe and the one
yeah that's like doesn't those know
dozens of samples give that follow
there's salt upload via middleware which
is they're all sort of categorized yeah
upload those files someone do you can
see request limit via is bump it because
my default is for Meg to make it like
mark st. and then you keep going down
here you can see call reform async to
get the actual form and you can
enumerate the form and the files in the
form
get my people on it yeah some modern
browsers yep yep I'm a very nice view
here we bring the now if we round out
dot and have Raisa yep cool all right
 perfect
alright VI who here uses our booking
container who uses auto fat so this
applies to the booking container it may
apply to other other content as well I'm
not sure about their details but to get
as general general knowledge of how
these things work in general ok so by
default
keep your day factories class and
synchronous we've seen cases where
people have a sink batteries and they
have to blog because the call site
actually synchronous see I'm doing in a
way that results don't you thought
result ever ever ever ever
you have to bid dummies ever don't try
it like especially avoid it in a factory
yeah in the beauty in the dialog you can
call it that lot we had a team in
Microsoft sinister of factories and they
definitely killed their entire service
we're doing a simple if think next call
in di you know I will show them of that
later today and it's kind of in a
sensation quark of our container but
just don't block and if you ever find a
files having to call result you don't
wait the task stop this thing superher
take a 15-minute break and then come
back and look at the code and think
really hard about whether that's you
really should be doing that right now
yeah right
don't do it in the instructor you can
defer it to be late not in the
constructor right so you can do it later
on so this team actually had a bug with
keyboard they were doing dot you've all
get yes labs out results and it killed
the entire service I mean the point is
just defer the expensive operation until
after the object is constructed and then
sort of do it on so what you wait also
you want to do if you is if you have
something asynchronous you want that to
run while you're in the request pipeline
or do it up front when the application
is starting like just front loaded if
you have to where it's safe to do dot
result yeah and then put the thing in
the container and then go from there but
yeah out the containers are lazily
initialized and register a factory it's
not going to run until someone asks for
it
so the total hack is you could keep
doing horrible factory and then the
config
method you could resolve that service
while you still haven't had the service
start and that will work just fine yeah
okay but you have to really understand
the lifecycle they don't make sure you
do the right thing it's very easy to
shoot if you're creator you can add it
you can add a 52 gashel container yeah
but I mean so it's a lot of facts of
worth lazy of T and you can do kind of
cool stuff there no a boy : get serviced
because it's hard to tech stuff on it
and the container that we have that's a
good that's a better job if you can see
the entire object graph if you have a B
and C all declare as Connect arguments
it can generate a better code Beneke
called get service from each time from
from each of those on different services
it's basically avoid I want to do a
service like ADA yeah like River that
pattern of what it try not to do that
but if all our container stores all
disposable transient services until this
until the containers is closed so it
means if you have a disposable transient
service that's resolved in the blue
container of the of the application it
will never be just be disposed until the
operation goes away and the issue there
is if you end up resolving a bunch of
services it'll be complete so it'll be
helpful forever so it's never it's kind
of built in memory leaks yeah we may
look at tweaking this but right now it
happens to this don't try to try to
avoid if you can we have a new feature
in a snack or 1.1 that is scope
validation so basically if you have a
thing where you have kind of a sculpture
vez that captures as well another option
so we have a symptom service capturing a
skull service that's probably a bug we
had actually a bug in the framework is
pretty pretty bad if you're using NBC
1.0 please at this please updated on
every bug
well what is the issue so this depends
he should have been transient been said
it was it was singleton and was
capturing a per request dependency so we
captured the user wants and then we
should have roll so we handle e-cash I
live in elevation it's kind of good
caching first request yeah it was that
was only in a certain case like you had
to it was only if you use this pipe the
view component result executors right so
it will only happen if you had a
controller that had an action method
that returned a view complete when it
results which was very rare like it was
a very rarely rarely used feature yeah
and so we deemed it not a massively
massively bad issue but it was bad
enough to get fixed in 101
or to make sure you update that's why
it's important to update your packages
yeah
all right this okay so here is kind of
the thing we're talking about if you
declare a B and C in the Indies for that
argument we can generate cool like this
our run time versus you doing together
pattern where you taking tripping or you
call get serviced manually uppercase
peas buggered me now which B that's that
one there can you fix that one go to
your slide just just making me yeah that
PJ oh my god damn you autocorrect there
we go a bombing why did I put code in a
PowerPoint slides like vomiting like
there we go okay so at each call to get
service that's the exchange look a bit
slow so you're kind of paying the cost
of the sham look up every time you call
it you'll get service so if you can
declare your object graphs all in the
same call tree is kind of a better
better job we can do I'm making that
fact all right good demo no up di stuff
so say map first thing transient without
disposable let's put F ten beads that
you saw that project oh cool it you've
chosen to stop okay wonderful
let's do this f10 or f/11
I don't know it is anywhere all right
let's pack 1211 so right here I have a
completely useless right now I have a
selection and by the weight you can use
our container in any project it's not
just an affinity for only container to
use in any project suppose I'm super
here this is a call to application a new
service selection I have I have 11 I'll
add a transient disposable service if we
look here if disposable one says
disclose so it's not a big deal as
transient I call those provider I guess
or supplier bag then I resolve it a
thousand times
and if I put a breakpoint here and just
skip over it you'll see we have all this
called transient disposables and it's
this stored so you should avoid doing
that because unless your container is
sculpt it will never go away alright the
end the application so
we need to mail this thing if the most
earnest cut loose blowing away control
don't do it there you go teleswivel
not good so the work around it you
really want to use your tribesmen so
it's only in the end of sculpt container
the pro request container because I get
this close if you if you dispose the
service provider this is all go away
after that resolution right there you go
so you know Nate's gonna tap that only
happens on the app shuts down right
right if you do this in route so so
avoid that pattern I think we that that
that presents itself if you do it
accidentally as a memory leak yeah
you'll just look and go why do I have so
much memory being use my up for my
application and quick keep analysis will
show you oh I have all these things
being routed all right the fun one then
I'll we are through this is awesome
all right so this is kind of a mind
bender so I create a service selection
I'm gonna add a singleton this is the
factory the factory taken in a search
provider and I'm gonna get so entry and
be first a it takes would be very simple
object ref right now I go into my
function I add singleton for a and in in
that in that song in that factory what
it does is it get to be asynchronously
does that result on creating you able to
be a breakpoint here you see what
happens and then I call get service a
which calls get ba think and one get ba
think does does it something I think it
comes back and then calls get service be
so so if we this clone gets everything
to be after a fret hop and there you go
we can sit and watch that now for a few
days but then I'm gonna go anyway wait
for a 10 but it won't if I pause
authorize and look at the like a prowler
stacks which is an awesome feature you
should always use
Carlos tax you know you're in trouble if
you have to use parallel sex I like you
know you're really into one of those
days right yeah okay it's a good day
so igniting deadlocks is awesome so you
can't really see it but visit visit
sculpt it's a lock on the container and
we're currently waiting on the results
of that half that results are complete
but since we did at a slight delay which
did a thread hop to a different thread
and then we called gate service after
that Fred hops but yet service is
waiting for the same lock so we're in
this deadlock situation and it's super
hard to - no one is - solution I avoid
calling avoid cotton get serviced after
those async calls it will make things
like horrible
so the Tina did this and the devil like
this descent of happening on their
service and it killed there in the
entire website what it means that every
request this hangs completely basically
any hole to get service now hang right
there all waiting on the same block
right so so scary fun so don't do that
yes right it's fine it that works yeah
so the funny the funny thing is if I
move this code like if I did this above
the delay it's fine where you'll have
problems is if you take a third-party
dependency they have a nice extension
method that hangs off by service
collection you say yeah and so party
libraries things and they register a
crapload of factories they do some async
stuff you'll have no idea yeah and I was
kind of lamenting this David before when
we were looking at this I'm like want to
be nice if the parallel stacks window or
something in vs shows you and locks or
being acquired yeah and not because
while we can look at those two threads
and they're stacks and we know that
those two frames there we know they both
share a same lock you have no idea like
it's our code but that that information
is all tracked by the CLR like you can
see all that stuff if you have the right
tools so I'm going to work a bug yeah
Lucy will look out they sing it I mean
so we do have a thing to look at ticking
more granular locks and said locking the
entire container but the thought was if
you have the constructor it should be
fast or you can't do anything reductive
but bright having Patrick and makes it
go away because you can do anything in
here with code
alright captive dependency
the term coined by mark humans who
definitely here I think talking and
doing other stuff what was here about
this whole flow pattern so I have an
type an anti-pattern I have I have AV
services a singleton via scoped remember
the thing it it could be so I have a
cinnamon thing capturing a scope thing
and the problem is it'll it'll create
the it'll create a once and it will
capture whatever B happens to be less
cold at that point in time let's debug
this and see what it does
so I did a made a resolve magics so now
I have okay it is a lot to be in my code
but a now has captured be forever that's
bad in some cases so then one point one
we have this new feature that says
please check my hold my hands for me
check my work yeah make sure you got a
and what it does is it checks with these
common patterns that end up being
mistakes that says oh my god you can't
consume a single turn from a
you can't see let's go from a single
time what are you doing so I recommend
turn it on just to see if your if you
configure your your bunnies properly in
the container by default we haven't
turned on by default because we're
scared of making breaking changes yeah
we could do it into a tool it we might
turn it on by default
yes
yeah so we didn't want to walk the
entire object graph of the container at
plenty call Bill because that's a
perfect if you're walking because we
this thing is super lazy so it kind of
watch the graph at the points I'm called
get service and they want to change the
designs to make it like have to walk the
entire thing it would be better because
doing this you only catch it if you
haven't call get service which is
unfortunate but I mean we could
certainly add a method yeah well not
kind of all right before you can count
our I have its provider to alcholic
verify whole verify yeah and it would
force evaluation we could do that yeah
exactly yeah you could do that so you
would know immediately rather than
because you're right because it's lazy
but you guys have to run through the
entire app yep before you see it yeah so
that's a good little bit for us a good
thing we should do that all right
the last one is also another category of
issues where the I just sound scary ways
the yeah is monden least here I mean
it's awesome but it's like there are
just subtle things that you can so
sculpt service is a singleton within
that container what that means is that
if you have a new container a scope
service will live for as long as a
container lives so you'll have one into
that container when you're per request
this cool piece of request go up so you
have a single summit in a request so if
you if you resolve it sculpt service
from from the app container you have a
singleton right so that's mostly a
mistake right if you have a scope
service like B and you didn't create a
scope container and you call the resolve
from the top level container you're kind
of capturing the scope sort of singleton
forever
that makes sense so in this example I
just felt service B and I've built it
with about it scopes true and I created
a child scope container to resolve that
dependency from and this is fine I made
a child a child service provider I
resolved B it went away all good but now
if I resolve these from the out level
container which which is not in the
scope it frozen says you can't resolve a
scoffer from the route provider and it's
kind of another issue that we see in
application so now I mean I'm a little
hard to see because we've boiled these
demos down to their simplest
possible thing you need an ass in an app
you'll have a bunch of service without
those services like a bigger services
and the way you would run into this
typically is in your configure method
you will take in one of those scope
services in like the next line
underneath so you'll set up a bunch of
stuff something might be scoped then in
your configure method you want to take
in that service because you need it
while you're building the HTTP pipeline
right and that's when you get into this
situation okay what exactly not to get
starting from the app container
otherwise if you add VB context and you
get it in your configure method that
will be singleton run I know anyone
never get this close which is often done
for seeding for a right ample so you end
up licking the connection because you
have a context open for the entire
application lifetimes right so you can
want to create a scope if you're doing
manual residue of services you want to
call create school for scope services
click Google EIN the scope that question
yeah
does every time it does every time yeah
okay we could cash it I guess and make
it you could we could cash it yeah where
today does every time you call resolve
the container that'd be pretty clever it
there to class late worse is when you
have an object a flow table and you call
gate service the first time it uses
reflection and then the second time it
says okay this has been resolved more
than once so accuse a work item to the
thread pool that compositing an entire
object graph into IL and then it says
okay i'm going to replace the reflection
based one with the eye of this one and
that happened it's Leon's like so you
get really fast performance what do you
call get service more than once it's
kind of an interpret then zip style
right top pattern so you just need to
create the scope yeah like if you want
great then go configure you would call
you would get you know I have services
that I have builders application
services you would create a scope off
that then resolve what you want there
rather than just injecting in the DB
context directly into configure right
and do it that way or create desire I
mean you could try and create a service
that does it for you but that's a little
warm on to you'd be trying to create a
scope within your service which is a
little weird but yes it's possible yeah
okay in this offered you or you seed
lazily yep yes so yes
it's not nothing is implicit so okay so
this is aptly important so the question
was other is there always a scope to
request there is it looks good for
requests I think we excited all by
default yeah the big thing is if you
have to resolve services from that goal
so if you don't call get service on that
specific container you're going to get
it from the application scope so for
example if I want to get a scope service
I would close to be contacts that
request services right like this is a
specific scope we create that we give it
that we have to use to call resolve from
the way where it's mostly is that we we
create stuff from request go up so once
you're in the request cult like for
controller if you get more things here
at our scope you you'll be in asked
already
so we resolve things from request
services for you on your behalf you have
to call this yourself I'm not and it
should be in the right field yeah I mean
again this is you don't have to worry
about this if you don't use service
locator if you don't use the service
like get a patent you generally never to
worry about this because you're using
constructor injection and whoever is
building that pipeline right MVC is
doing all this for you it's only when
you take the I service provider yourself
and then you're saying I'm going to take
control everything or you grab the HTTP
context and you start digging around in
there to find the right container is we
run into these issues yep okay good good
MVC organizers you hear all right so
who's heard of mass assignment or over
binding okay one hand two hands three
hands I hope more people will go and
look it up after this four hands because
it's scary who uses their EF models and
they're like model binding for inputs
who accepts their EF models in their
action result and hey brunette or the
ORM model no other use view models in
place or input okay you get a good who
shares the same view model for the post
and the gap don't be ashamed don't be
ashamed certify that that's that's
usually the promoter and the judgment
regression is you start out you watch a
demo from four years ago that's got
handsome and did or me or you is it like
it's so easy you scaffold out a the
credit classes scaffold out the database
or scaffolds at the front end go home
right fine and you go okay this isn't
good so then you create a view model and
then you use a single view model for
both the sort of reading part of the
form or the API and the writing part of
the form and then over time you realize
well maybe I should really have a
separate
model for handling the input and then in
once the Apple and that's kind of the
the the the ultimate realization of this
so the mobile was having a single model
that represents multiple operations
obviously is when you're doing incoming
binding when model binding is looking at
stuff in the request and saying I need
to build a customer objective that's in
your action method then it's just going
to take data from the input and try and
match that with property names and bind
that on there and if you don't
explicitly call out what you want mined
in what you don't i can just bind stuff
to any writable property on that
customer which you may not have intended
you may only be displaying three fields
for editing but it might have twenty
fields and now i can over bind or max
assign those values and then you'll just
screw all that away in the database and
now i've done something you didn't
intend github was hacked by the way via
this mechanism or well max very publicly
about it twenty twelve i think yeah so
there's a way to I mean the way to
protect against that is to use a
separate input-output model so or you
can use there's there's a notation that
we have using attributes to say bind to
this thing but then you can pass strings
to see which properties you want to bind
or you can decorate the properties that
you don't want bound with never bind so
there are ways to do it but I hate all
those ways because they're horrible this
is a much nicer pure way of doing it
just have separate types more classes
the references right it's a c-sharp you
shouldn't be afraid of creating classes
and we're glad tag helpers handling Akio
right who's written a custom tag helper
anybody good okay so I'm not just
talking to a bunch of people who have
never went to tackle it which is good
but if you do cuz you will because
they're great you'll find yourself going
I really wish I could just do this once
throughout my app and this is a really
good way to do it you need to handle
attribute values if you're reading
values from an attribute on the HTML
element one that isn't bound to a
property on the tag on the tag number
itself then there's a special way to
handle those values because with razor
it could be a literal string or it could
be the result of C sharp right you could
have at blablablablabla
as the HTML property and then that flows
through to your tag hole but not just as
a string but as a thing that hasn't been
evaluated yet it's like a special type
and you have to handle that correctly if
you're writing tag helpers where you
look at an HTML attribute and you assume
that that's a path there for example if
you write a tag help with it augmented
the script
and you look at the source attribute you
know it points to a path and you want to
go and load the file and do stuff you
have to protect against whatever that
thing is pointing to I've seen a lot of
people write tagged helpers and they
don't properly validate that the thing
that's being passed into the path is
actually in the site okay it's a similar
problem to the path traversal issue but
of course a lot of the time those
attributes will point to other websites
completely like a fully HDB address you
have to handle these things correctly
another one is are using temp data for
post redirect post redirect get
operation state so post redirect get for
those who don't know is the operation
where you say ok I've got a form I post
that to a controller I do my processing
if everything is valid then rather than
just returning from the post which means
I'm showing the user an HTML result as a
result of a post which means if they hit
f5 they'll get that hot water again the
relatives resend the request what you
want to do is if the posts are
successful you want to redirect as they
send a redirect response that goes back
to maybe the original page or a
different a success page or something to
force the browser to do a get so it's a
nice clean state the problem is you
generally want to give like some type of
success message you want to pass
information through that post redirect
get cycle maybe congratulations you
created your order or something like
that some people use cookies to do that
like a temporary cookie that goes in and
then comes out and they cleaned out
maybe there's a query string to pass
data using career strings a little yeah
because now you can taking data from the
crew string if you're not using it
properly you can open yourself up to
issues or you might use session ok to do
that stuff for a user profile temp data
in MVC is a really nice succinct crisp
way of doing that that just manages the
whole problem of user makes one request
I want some data that round trips for
exactly one more request
that's what Ken's data does ok so using
that for post redirect I get status quo
nice so I'm going to show you the
examples of these in the live ace
Connect website so let's look at mass
assignment protection so in my admin
controller so I'll get my home
controller first actually my home
controller here no these are the real
site so there's a lot more code ok
so let's have a look at what I'm
returning so the index which is the home
page isn't taking anything it's just to
get but
can the home view model so I have a
specific view model type that is for
displaying information on the home page
okay it's just for doing that it's
nothing to do with taking stuff in if I
go to the admin controller and I look at
the a post that you can perform to
actually update that stuff you can see
I've actually declared a class in line
in my controller called the admin input
model and then I take that in my save
method okay so the contract of what I
want to be able to be posted into this
action method is right next to it which
I kind of like mainly yes I could put
the class in a different place but I
like kind of like having it as a nested
class of this controller and then in
terms of validation I can tell MVC to
get its model metadata from a different
model this is the Buddy type system so
rather than having to duplicate
validation attributes I can say well the
admin input model just gets all of its
validation from sort of this master
admin view model okay because I want to
have validation on the way out so that
when you render the admin screen
validation works client-side validation
works it needs to send all the
validation information down but then on
the way in I need validation to be there
as well so I can run it when I check
model state obviously so if I'm using
two models I don't want to have to
duplicate that only one on one and this
is one way of doing that you can also
use inheritance so you can have sort of
the base model which has the validation
and have a derive model and you only add
the extra properties that you need for
that one but I just find this one a
little cleaner this way yes so the
question will you anyone work with
c-sharp seven value tuples rubbing that
I don't think not yet no yet
that's a nice idea though yeah we would
look up and know exactly okay so that
that's using a separate model for input
versus viewing and you can see like I'm
taking in output admin input model here
but if there is an error I return the
admin view model okay so in this case
model state is not valid so I am
returning from the posts all right so
the user can see validation errors I
create the view model I populate that
from the input model and the the actual
live record so there's basically three
bits of operative trooper to data right
the record as it exists right now what
the user posted and what I want to send
back to the user I merge all those
things together and I send that through
to the view all right
who'd use something like Auto mapper
before okay great this is a great case
for Auto mapper I am not using it this
application I'm doing all the monkey
left hand right hand code as you can see
down here I don't know why but you
should use something like Auto mapper to
make this stuff simplistic okay I'm
looking at our covers over custom a
couple of custom tag helpers down here I
have a script inlining tab tag helper
which you can probably guess what that
does if you have an attribute on your
script tag that says inline and rather
than rendering a normal script tag that
makes a request back to the server it
just in lines the script in the HTML
really nice for smaller file so you can
avoid another request to the server so I
have to handle dealing with the source
attribute okay as it is in the source
HTML now a script tag can point to a
JavaScript file anywhere can point to a
JavaScript file on my site it could be
on a CDN it could be are a random other
side so I need to make sure I'm dealing
with that properly this is the code that
you need to write to correctly handle
getting the value from a raw attribute
okay if I was declare if I was to
declare source as a property on here
which I can do so I can do this okay
that will take care of that for me all
right the tag hopper system will bind
the source attribute to my source
property and it will do all this logic
for me but I have an aversion to doing
that because if you do that then it
shows up in the editor as purple because
it now says well this property is from
the tag hole for an overrides the
factors of HTML and that just annoys me
so I do it manually and if you're
writing complex tag couples you need to
do this anyway so just to walk through
this what it's doing it says get the
value of the tag hole but this attack up
or attribute it comes back as you can
see here if i zoom in Mouse podium
situation is interesting so it's a tag
helper attribute so when you say please
get me the source attribute from the
rendered output and I'm going to render
you get that as type tag helper
attribute I pass that to a string if
it's null then I go okay well that's not
a string I need to do something else
let's try get it as an HTML string I do
that first because it's very cheap to
get a real string from the National
string I can just grab its value
property so if its nature mile string
I'll do that if it's still not there
my sort of second last-ditch effort is
to get it as an IAC more content HTML
content is a new type into n razor that
effectively represents razor code or
anything really that hasn't executed yet
it's something that wants to write out
HTML but in the old razor what would
happen is we would just do that when we
encountered it and then things would get
double triple quadruple buffered during
as they went through all the layers of
razor and so you take a lot of strings
basically to build HTML now we have this
nice deferred execution system so that
we can avoid all the texture buffering
so if it's an I HTML content you have to
do it's a little bit trickier because I
system our content wants to be written
to something you can't just get it as a
string so I have to create a string
writer write it out to it with no
encoding otherwise it'll try and encode
it with HTML and coding which I don't
want in this case so it's not going to
do it now then I can choose string that
and if all that is false and I just add
screw it I'll just get to string I'm
assuming as some other objects I can
just to string it and I'll get it yeah
yes I'm expecting lots of pull requests
from John skeet later on afterthought as
where to heard I think we should create
a helper for this personally because
that that saddened me when I had to
write that code out so the other thing
here is dealing with the past so here's
all the logic I'm doing to make sure
that once I actually have the source
I'm validating that it actually maps to
a file in this site okay and I have to
deal with things like past base where
the site may be being hosted under a
video in is so rather than being routed
at the root of the site it's like rooted
at /foo I have to account for that and
so I have to grab the pass space do a
whole bunch of files exist checking to
actually realize that the file is there
or isn't and once I've done all that
work it's pretty straightforward it's
just you know going through the sort of
a methodology the the method to go
through ok
is it a very simple URI to the fool you
are a well yes and I cannot wait to get
that file is there something on disk in
my site yes or do I have to adjust the
path but if I do go through all that if
it's not there fail or just return and
do nothing if it is there go ahead and
read it and append it to the output ok
ok
lastly are using temp data for post
redirect yet so if I go back to my admin
control it's pretty straightforward so
down here you can see here
in my save method after a successful
save I wanted to show that the it
succeeded so I say okay shoving the temp
data use the name of this the success
message property on my admin view model
as the key and just say this is what I
want and then when the get happens which
I come back up here I pull it back out
again yeah and I just cast it I just
push the strain of that simple as that
we are looking at a feature in the next
version of MVC that allows you to do
something like this so you'll be able to
do string success message and then you
would just be able to do something like
this and then you would just be able to
assign directly to a property on your
controller and then we would take care
of the other way and temp data and then
repopulating it for you on the next
request okay
we've actually really got a prototype of
that is part of our razor pages work and
that's actually going to be really nice
way of doing the happening and that'll
be implemented using a filter so you
could actually use it anywhere in MVC
which is kind of cool okay yes yeah so
temp data is totally pluggable in one oh
we supported session only in one one we
added a cookie based temp data provider
which is what I'm using so I don't need
any extra set up it just encrypts it on
the server signs it sends it down as a
cookie it gets posted back up again red
and and cleared very very nice all right
talking a pipeline we've got a minute
and a half but I want to show everything
so we have a feature called aam catalyst
which is basically a full a full
in-memory web server so you can test the
entire pipeline I still putting up a web
server having Network good for
integrations everything right and I've
been interesting to show it it show it
show it it's all over the card right now
that's pretty easy to show there is a
unit test and what it has is a simple
fact that has rep our response and I go
to I post loader which is in my program
and if you've seen a program man before
it has the code me builder here the
server here is the content here is all
that stuff same idea but less thing so
same though their stance at our class
I'm planning to actually this class
right here which runs response which
writes hello works with good response
I'm going to do is put up the server the
test server hop in the Builder call
create client and you get it should be
client back which is super nice and
called get a sink with a this is a
an important especially a really good
demonstration of why there's a
separation between the web host building
sort of phase and the startup class yeah
so you can do everything in web host
yourself like you can just tag
everything on but this separation allows
you to say well my at Ramsey starts at
startup and then I can take that up and
run it on a different host very simply
by doing this so basically this would
get from FTP client with around them URL
because it's not relevant anymore and
get a response back I read a string and
hello world for this she just run and
work actually a test run already run
tests should be clear that's all in
memories and I know socket listening or
anything it literally just run the
server with all the memory caching and
it even though WebSocket in-memory
client Leros kind of good like so you
can test your entire and family without
ever going online cool here's an example
of making an environment test specific
so in your application I can say I want
to run tests for the code and I can
write code that says come in environment
test using like this versus my prod
service on all the service does is it
has a string test regression based on
what's your run you're running in so the
test it says I'm going to response all
right the service I get later so added
service here got it into the config
method and call get beta supersize yep
yep no hdvs mmm see me see me after yes
give me after class
so yeah environment test it just print
so it adds attach service if it's not
added to the prod service unless kind of
the whole thing could here we go out of
time
yep it's done and yeah step back of the
slide there you all right we had more
than we have one more thing so just a
bunch of a prayer request state it's a
bunch of different ways that you can
store stuff per request obviously can
shove it in the old you know in context
of items has been there forever there's
a new thing called features this is how
we flow like stateful not just fateful
but things that have actions things that
like do stuff on the request throughout
the request lifetime middleware can add
these and read these you can add your
own features to do complicated things
but that's basically you add
capabilities scope services we talked a
lot about ok things that live for the
life of the request generally and then
if you really really really really
really need to get access to the HP
context from inside a service for
example there is a thing called the HP
context accesses that lives inside the
container that you can resolve and as
long as your thing is resolved correctly
so it just work the figures itself out
you will get the HP context inside your
random service ok which is kind of nice
that's the replacement for HD context
dot current current alright
di friendly way of doing it and that's
it so thank you very much all the code
that we showed you is in a repo up on
Fowler's github so if you want to see
that code</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>