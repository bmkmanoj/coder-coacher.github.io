<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Solid ASP.NET Core -  Jimmy Bogard | Coder Coacher - Coaching Coders</title><meta content="Solid ASP.NET Core -  Jimmy Bogard - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Solid ASP.NET Core -  Jimmy Bogard</b></h2><h5 class="post__date">2016-08-25</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/I3ou92_vV6g" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello everyone thanks for coming
appreciate
you having the very nice weather this
week for my first visit to Sydney thanks
a lot
my name is Jimmy you can find me at
twitter @ @j bogart and i promise it's
not entirely untapped check-ins there
are some insightful tweets somewhere in
there and you can find me a github too
at github.com /j bogart i pretty much
everything I do is on that repository
including every presentation I do so if
you check that out you'll find all the
materials for this as well and a blog at
loose techie so you can go to Jimmy
Bogart at Lowe's techies calm and I work
at head spring a consulting company in
Texas very far away from here very very
far away and most people know me because
they work on an open source project
called autumn appart which we may or may
not be talking about today we'll see hmm
so today I want to talk about the new
asp.net core framework which is released
right it's not preview to beta seven SDK
something it's actually out now so
that's good I want to talk about a
little bit how we build a speed inet
core applications and one of the
interesting things about the asp net
core framework besides a ground-up
rewrite is just like the old asp net
framework NBC and web api
is completely devoid of any opinions
about how you should build a speii not
net applications so what I wanted to do
with this one is take kind of a normal
ASP netic core application you typically
see out in the wild and wanted to
refactor it to make it more solid solve
being the single responsibility
principle the open closed principle
something about inheritance interface
segregation principle and then the
dependency inversion principle although
some people just say dependency
injection and just be done with it I
don't you don't have very many slides
like this is like the main one that
we're going to go straight to code so
let's just do that sound good okay so
enough of that
and now we'll be using Visual Studio I'm
not one of those Joker's that says they
code in Visual Studio code or something
like that I'm using a real editor here
okay the first thing I wanted to do is
just go through this controller and view
as it is to just kind of see what we see
and see if there's things that stick out
to us as things we want to try to fix or
remove some of the duplication make it
more solid
so this is kind of a normal MVC style
controller it's got a number of actions
as part of it so there's an index action
details action a create action with a
lot of space there need some space and
then then we're kind of top level things
you typically see so create edit update
delete and I wanted to take a little
tour of these to see what kind of things
we see stick out to us in terms of
duplication and the stuff that's just we
see over and over in our typical
applications and just to make sure that
this is a real running application I'm
going to run it and make sure it
actually actually works so it does
actually have a real database behind the
scenes this case I'm just showing a list
of students nothing terribly exciting
except that I can do things like edit
them so I can go edit them and add some
additional information here or save and
yes indeed it actually saved I can
create a new students how about me and
my Roman dates I don't know today why
not and then we would verify yes indeed
it actually did create me up there so
yes this is a real application with a
real database on underneath the covers
so it probably looks and feels more like
the applications I typically write so
let's look at this controller here now
most applications I run into the MVC
applications have due to general flavors
of actions there might get actions and
there are my post actions the get
actions are going to be making some sort
of query and showing some data on the
screen and then my post actions of
course are going to be manipulating some
information behind the covers okay so
here's our index action it's somewhat
complicated because it's having to do
sorting filtering pagination as well so
my controller is building up a result
object that it passes along to the view
it takes in a query here so these are
the query string parameters and after
some code here falling down at the
bottom here we go
it's building out my view model in the
turn in the form of a page list that it
passes along to the view so far so good
and then inside my view it's nothing
exciting here it's just building a table
of entries down here and then displaying
that information on the screen not that
exciting there as well so my get actions
more or less look the same there's
there's may or may not be some sort of
inputs for a query string parameters and
then builds out some sort of output now
every application that I build as well
is going to have one single model in and
one single model out and one of the
reasons I do this is on the model inside
this is a lot more refactoring friendly
so if I add additional query string
parameters it isn't necessarily break
other parts of my application that
assume a very specific ordering or
naming of those parameters as well so
these are all the query string to print
parameters that could potentially come
in as part of making that individual
request one of the other first things
you should notice as well is that out of
the box
I do have dependencies being injected
into my application so in this case
that's school context the DB context
from entity framework that's being
injected this time by not not by my own
dependency injection container but
actually from the one out of the box
from asp.net MVC core that piece is
actually set up and our start up over
here and then a little bit further down
here we go so that right there is
manipulating the base service collection
you can think that as the thing I stick
all my services into and I'm telling it
to add this DB context of type school
context with some configuration saying I
want you to use sequel server and the
connection string is going to be what I
pull from over here this default
connection from the configuration
manager here so that kind of checks the
D off the list of my solid
out-of-the-box in older versions of MVC
framework it was pretty annoying to have
to deal with the pendency injection it
wasn't out of the box built in
and you usually had to poke many
different places to make sure your
pendency has got absolutely everywhere
and we'll see what some of the other
extension points here later at NBC
that's everything at NBC core is
dependency injection enabled so they can
take those dependencies with just about
everything I use inside of NBC core
including my controller here so Dee is
down now we can focus on the solid part
of the solid alright so let's look
further down now I'd our different
controller actions specifically I want
to look at the forum posts so I look at
the create action here okay and then the
Edit action down here the to forum posts
now if I look at these two controller
actions I see some commonalities here
that my forum post will typically take
the form of doing some sort of model
state validation so validation has
already occurred let's say okay is it
valid or not and if it is valid then
let's actually do the work of the
controller action we'll save some
changes and then finally redirect and if
it wasn't valid then I go ahead and show
the view passing in that model so they
can get rehydrated now nearly every
single one of my post actions looks
exactly like this do a model state check
do the actual real meat of the work Save
Changes and then go redirect now one of
the duplications I typically see my
applications and not the kind of
copy/paste variety where it's the same
exact code in two places but it's more
of a concept duplication and the concept
I see here the overall kind of pattern I
have is doing a validation check
doing some work and then saving some
changes so what I'd like to do is take
advantage of some of the extensions at
NBC core to remove this duplication I
see and all of my post actions so first
well the one I want to get rid of is
this right here
DB dot Save Changes that's the line of
code that is something you can't ever
really forget to do
if you forget to call Save Changes then
your changes aren't flushed to the
database and then you'll just have some
you know like oh you edited something
and nothing nothing actually changed
behind the scenes and in my applications
if I have to remember to do something
then I'm probably going to forget even
it's it's something as simple as calling
Save Changes so what I want to do is
build a policy in NBC core so that on
every single request my changes are
always saved to the database and I never
have to remember to call Save Changes
ever again so let's do that one by the
way one of the other things that you can
look at to see am i violating solid is
if you go up to the top and look in your
using statements and if you see things
from a lot of different places things
like I've got things doing with NBC
I've got link there's any framework in
there as well if I see a lot of
different concerns in one single spot it
usually comes out in the form of my
using statements but back to our Save
Changes what I want to do is take this
and put into a place in the NBC core
pipeline so that executes in every
single request now similar to a speed on
at NBC and web api before it's NBC core
has the concept of filters and filters
or sets of code you can execute before
and after every single request at
specific parts in the execution pipeline
so that every single time it happens on
every single request and what that
allows me to do is that this kind of
duplication that I copy and paste in
every single one of my actions I can
pull that out and have that in one
single spot as in the form of just one
single class that then goes across my
entire application so let's do that now
I've also got some cheat code here so I
don't want to miss type something so I
actually got it over here in the form of
a filter and the other thing I want to
do is go into my DB context and add a
bit of code there and I'm going back to
my cheat code here to grab that here we
go so one of the kind of interesting
things about
spm sorry
both an entity framework and entity
framework or is they try to hide a lot
of the transaction support behind the
scenes I don't really like that I ought
to be very explicit about when a
transaction begins and when a
transaction ends as opposed to just kind
of a magical safe change is called like
well where did the connection open what
are the transaction open is it is it one
transaction that I do up here and
another one down here I don't like that
I like to have a very explicit boundary
so I'm going to create that boundary by
extending my DB context a little bit
here so let's go to my school context
and I'm going to add this is my DB
context that I'm using for the entire
application I'm going to add a few
methods to help me build out some
transaction support so I have a exposing
a few methods here one is to begin a
transaction and that will open up a
transaction behind the scenes down here
one there one of the other things I like
to do is have a very explicit isolation
level in which I'm opening up the
transaction does anyone know what the
default sequel server transaction
isolation level is serializable that's
wrong it actually depends on the version
of sequel server you're using like even
different like editions of sequel server
will be like read committed serializable
I think snapshot may be a default here
pretty soon I don't it's it's really all
over the place so instead of me relying
on the installed database default or
someone's default that some DBA puts
somewhere I want to be very explicit
about that that's what I'm doing here is
being very very explicit about saying
I'm opening a transaction with this
specific isolation level now one thing
you could do that I do in some projects
is open up different isolation levels
depending on whether doing a get or post
like you could do a read uncommitted for
a get versus like a snapshot for posts
that way you have you know just
different concurrency models based on
the activities you're trying to perform
I'm not going to get that complicated
I'm just going to have begin transaction
with this specific isolation level and
luckily I'm using entity framework or
luckily that's actually expose
it's kind of a crapshoot within any
framework or these days about what it
actually has out of the box it's a 1.0
but I think that's a kind of a loose
term with that release I'm also going to
expose some methods to close a
transaction if there's an exception
it'll roll back the transaction
otherwise it will go ahead and commit
the transaction so all that stuff that
people typically build into like a unit
of work class or something like that I
like to just stick that right on the DB
context itself as opposed to building
some other abstraction one of the things
I want to highlight here is that the
solid principles don't mean to abstract
everything it just means put things in
the right place and that's what I'm
trying to do here okay so back to our
filter I declare this MVC transaction
filter to be an async action filter this
doesn't this didn't exist in previous
version of MVC there was no async so the
MVC core pipeline was completely
recalled to be a sync all the way just
like you saw in Web API if you have seen
that as well this filter can now take up
dependency okay so this used to be super
super hard to do in asp.net MVC the
previous version you couldn't actually
have a filter take dependencies at all
you have to do like service location or
put in a very special place or I've seen
tricks like put it in HTTP context items
everyone ever do that yes that's like
the thing that exists in every single
requests you can stick stuff in there
and have it available for parts later on
their quest but that seemed kind of
crazy other the interesting thing on
filters with previous version of MVC is
they were all singleton so they were in
Senshi ated once for the entire lifetime
of the application and there was that
that that letdown feeling when you
realized what it was doing like oh crap
i'm with the code around this well
that's not happening anymore NBC is
building NBC cores building out the
concept of a composition route so that I
can have one single spot where I
instantiate everything for the entire
request and depending on life cycle
rules we'll have things instantiated at
different points so what that means for
me is in my filter can now take a
dependency on a DB content
now on the actual filter method itself
the on action execution async which I
don't know what that means in real
English but I think it's just when the
accent execute is kind of weird
naming syntax on their different methods
here so this means when the action is
executing do the stuff and what it does
is it passes in this delegate which is
supposed to be the next thing to do
so my filter so if I can get it all on
the screen here there we go has a
try-catch it's going to first awaits
against opening the transaction with a
Bink begin transaction method then it's
going to call a wait next and that next
is the next thing in the MVC pipeline so
it may be another filter it may be
executing the action that's all
encapsulated for me in terms of my
individual filter here I don't care it's
just the next thing to do after that
next thing is done then I go ahead and
close the transaction that would commit
the transaction and if any exception
occurs then I'll go ahead and roll back
by passing in that exception I'm seeing
this now and it probably should have
named those like commit and rollback
but hindsight is twenty-twenty will edit
that out later I'm sure okay so now that
I've declared my filter I can then go
register that in part of my startup so
something else new an asp.net MVC core
are the ability to configure directly
using this configure services in
previous versions of NBC you had all
these static classes you were dealing
with like the bundle config the filter
config all those config classes remember
those things we don't have those anymore
now you have a single spot where you can
specify all your MVC core configuration
and that's going to do right here so do
my little configuration block and I'll
say config dot filters dot add and I can
tell it the type of filter I want to add
so this case is going to be type of MVC
transaction filter
that one now because I'm giving it the
filter type and not a filter instance
NBC knows that it needs to instantiate
that filter every single time for each
request that's what I want okay so now
with that filter in place I can go back
to my controller and remove some of
these save changes so in my post actions
creates oops save changes goodbye edit
save changes goodbye and delete save
changes goodbye as well so what I've
just done there is removed some of the
responsibilities from my controller of
knowing when to call Save Changes and
commit those to the database I've
removed those and put it in one single
class so that's the s in solid for
having a single responsibility for
managing the transaction scope for my
application oh but let's make sure it
actually works
okay so I should be able to edit my
information and it should save correctly
and yes it did so hooray
now this is just one controller I know
but if I have my typical application
that I'm working with has dozens of
controllers some of the applications
that work with have over a hundred and
if I get a half after that one single
line of code in every single controller
action that's just going to bloat up my
code and if I ever need to change what
actually goes on behind the scenes I'll
have to go fix that in all those
different places so let's say you need
to have a policy around saving changes
to do something like logging in the turn
logging when something fails something
like that well now I have that one spot
I can go to to be able to have that sort
of logic some people don't like this
because they're like it's magic because
Save Changes I don't know where it's
being called but that's like 30 seconds
a conversation to clear that up or
documentation summer maybe and not to
worry about that sort of conversation
really ever again okay on to the next so
I remove save changes from each of those
now the next thing I see is this if
model state is valid on both of my
controller actions this is the one that
I really do get annoyed with just seeing
that if model state is valid over and
over and over and over and over again it
just gets really annoying that to deal
with those happy paths sad paths for
every single forum post in my system one
of the other thing this that can be
pretty difficult to deal with in forum
posts is if the model state is invalid
and there was some validation error now
I got to worry about how to display
those errors to the end-user and here
I'm just taking the the model that I was
passed in from the forum post and
straight up passing it on through the
model that I'm showing on the view but
that's not necessarily the same model
that I was originally hydrating over
here when I was showing the forum to
begin with and so you if you're familiar
with NBC applications and you built a
few of these
you probably have some code and yours in
some of your forum posts it's like okay
here's the actual forum post model let
me go also hydrate some other junk in
there because not all the information
was posted up so you have something's
like okay get the model then go
rehydrate some of that additional junk
and go on from there well I don't like
doing that on all my forum posts what
I'd like to do is do something I did
with the transaction filter and try to
get and remove all of my model State
valid checks throughout the rest of my
system to do so is going to take a
little bit of finagling unfortunately so
I actually have a diagram of what this
looks like so if I look at a normal
validation foe and an application the
normal post redirect gets well do a post
to the npc controller it'll check to see
if it's valid or not and if it's invalid
it will return the entire HTML payload
rehydrated with my view model back to
the end-user if it is valid then I go
ahead and do the work save the changes
to the database and then it returned
that redirect to the end user so they
can go see the changes that have been
persisted so the post redirect get the
problem area was this part right here
I'm returning back all the HTML to the
end user and they have to go then I have
to make sure that it can properly show
that HTML based on just the form data
that was posted up through that post
flow so I'm going to flip this and my
modified validation flow and this is a
trick I've been using for about four
years or so my modified validation flow
is going to hijack the forum post and
instead of doing like a sort of full
post it just takes the form variables
and posts them up to my controller my
controller to will check to see if it's
valid and this time instead of passing
back HTML of like the full form and all
the validation errors pre-rendered I'm
only returning back the error
information in the form of a JSON object
the JSON object will have which
properties are invalid and also the
validation messages for those invalid
properties then on the client side I'll
have to take that and bind them up to
the screen somehow and if you're using a
client-side application framework so if
you're using like
react or angular or if you're one of
those guys using aralia
out there then all of this sort of stuff
will be more or less taking care for you
- the server-side hookup of getting the
validation errors back to you to be able
to be shown for you other ways on the
success path I want it to be exactly the
same so what I want to do is hijack my
forum post make an AJAX call on the
server side I'll just check to see if
model state is valid and if model state
is invalid instead of returning back
HTML in the form of the view I'll
actually just return back the errors to
the client and they can then just rebind
them to the screen so let's do that
first looks like a my filter that's
going to be doing the server-side
validation work okay so this is my
validator action filter and I don't
really care what validation framework
you're using this works for all of them
really and really what I'm trying to do
here is encapsulate that flow of if
model state is valid then do the success
path if model state is invalid then do
the sad path I want to have that in
exactly one app one class in my
application so in my Valder battle
validator action filter which is an IEEE
action filter the on executing method
means it happens before ordering I don't
know the naming is really weird here
in this part I'll check to see if my
model state is valid if it's not valid
then what I'll do is just straight-up
sterilize the model state is the
underlying validation information inside
NBC core and then just serialize that
whole object as JSON so I'm not creating
some sort of intermediate validation
object I'm just saying take whatever MVC
has and just shove it on to the client
and I'll go deal with it over there so
finally yeah here we go so the filter
context I'll set the status code to 400
and then I'll set the results this
content results over to the filter
context now
replace the results on the filter
context object that means it's going to
do that result as opposed to continue on
with the controller action so this means
that my controller actions will no
longer have to deal with the sad path a
validation okay now that I have the
nothing afterwards so now that I have
the action filter defined I want to
register it startup so over here I will
go ahead and do config filters ad type
of valid error action filter and then
finally there's a bit of kind of ugly
code and this is not it's not ugly
because the code is all that ugly it's
just because I'm not really that much of
a front-end developer so this is much as
I could manage given my limited
front-end skills so what the front-end
set of code is going to do is hijack the
forum post and then take that model
state errors and then just put them on
the screen next to the right HTML
elements based on where the input
elements validation error should be I'm
going to shove that over here in my
layout right that looks like a good spot
okay so I won't go through the whole
thing just this one little part here
using jQuery it's going to hijacked
every form post form and on submit it is
going to serialize the form data right
here I'm going to remove any validation
errors that may already exist on the
screen and then perform this Ajax
request it's going to do an ajax request
against the existing URL the action for
that form and post up the form data as
part of the data it's going to post and
then on success it's going to do this
right here and on-air I will go ahead
and highlight the errors now I'm go into
the highlight errors function it's just
like lodash code that loops through all
the errors and highlights
correct things on the screen never
exciting me because I don't find
JavaScript code that exciting but it
works all right so with that front end
code there and my back-end filter I can
now go back to my controller and just
remove all these really irritating
if model state is valid checks okay so
let's find it so this is a good action
it won't have one get action one have
one get action one here's a post okay so
let's just go ahead and remove that and
remove that all right and in my post I
and my edit action I'll remove that and
remove that lovely all right let's run
this and see what we see
all right so on my edit action I'm just
going to do the happy path and make sure
it actually works I'll remove that I'll
hit save and it broke sometimes I forget
to pull in some jQuery here I told you I
was bad at front-end JavaScript all
right well I'll come back to this later
because I don't want to spend too much
time on this other than this works when
it works when it doesn't work well then
you have to get your front-end developer
to come show you what's wrong with it's
probably going through like chrome dev
tools or something like that so what
we'll do is go ahead and remove that and
just say it works and the demo that I
post up later will have the correct code
it sound good all right there's a
question yes
all right so the question is will be
covering server-side validation so I
guess I should have pointed out this is
still doing server-side validation the
only thing I'm oh so what if my
validation is to do something a little
bit different like hit the database or
something like that if I need to do that
I won't use the MVC core validation
stuff because I find it to be not that
great and instead I use fluent
validation which actually is dependency
injection aware I won't go through all
that because that's like a whole talk
onto itself to go through full
validation but I would check that out
because your validation classes in
fluent validation could be registered
with dependency injection so they can
take things like a DB context to do that
database level check so in my
applications they typically have two
levels of validation one is the just
really simple form validation like is
this thing required or not and then the
complex business level validation I use
fluent validation to do that good
question though like I said we're just
going to pretend it works and not show
any more validation errors and I will
take out this probably really ugly
JavaScript code and fix it on the
example I'll post online later okay so
going back to my controller one of the
things I wanted to do was introduce Auto
mapper as a way to get rid of this dumb
left hand side right hand side code now
anyone here use Auto mapper okay
everybody
yeah so one of the things I wanted to
highlight are some of the features that
are kind of lesser-known to people in
automobile and that I think are really
cool so what I want to do is get rid of
all these but I don't want to do is do
the old auto map way of doing things of
loading all the properties into my
domain model and then mapping my domain
model into my view model I'm reusing
something else entirely
now what I've already done is in my
project JSON I've already referenced
automap ER as a dependency using the
latest version on the my gate because
that's how I roll
something I am adding on top of this are
some extensions for Microsoft's
dependency injection framework so this
autumn a poor Dex tensions the Microsoft
dependency injection that's a new
package that plugs
Auto mapper with the dependency
injection container that asp net core
uses now why is that important well if I
go back to my startup we'll have a very
similar feel why I can do services dot
ad Auto mapper there we are so what
that's done let me add one more thing
here type of startup so what that's done
behind the scenes is for these different
types I passed in it's going to be using
reflection to load up all the types to
see if they have any auto map or
configuration defined in that assembly
and if it does find it it's going to
pass that in into the autumn a poor
initialization so that's equivalent to
me doing something like map or
initialize and then adding all the
profiles add profile and then all the
profile is my application so I I used to
accomplish this find all the auto map or
configuration via dependency injection
and then people would do do really
horrible things like having their
profile configuration take dependencies
unlike dbcontext and hit the database
during configuration time which was a
really really horrible idea but it was
enabled because that was all configured
through dependency injection so I'm not
doing that instead I just call at Auto
mapper and any profiles I have defined
and these assemblies that are in that
type will just be automatically loaded
up and initialize with autumn a per so
let's go over to our few models and add
in all the appropriate auto map or
configuration were interested in so I'll
just call this a student profile it's
going to here from profile from Auto
mapper and some of the maps I'm
interested in are going to be let's go
to our controller first of all we see in
our index action
here we are this select projection here
so I'll need a map from student to
student index model student index model
there we are and probably one for
details as well for student to student
details and probably edit as well and
probably delete as well okay so with all
the mapper configuration oh there's a
couple more I'm going to cheat I don't
normally do this but the Edit action and
the create action are doing really like
very boring backwards mapping code like
really simple ones so I usually don't
recommend people to do this but because
this is a demo I can cheat I'm going to
go ahead and reverse map these two
pieces as well oh just the Edit one and
then finally the I'm going to create a
map from student crate model and to
students okay I like never do that in
actual production application but this
is a simple one so you know I can cheat
okay so that's all the automatic
configuration I need the next thing is
to go back through my controller and
then replace all that mapping code with
the autumn app or code instead now the
the ones that are going through
dbcontext to use this select like this I
can replace this with project two
student index model and this is defined
in automatic wearable extensions and
what that project two is doing is
examining the source type and the
destination type so student and student
in the next model loading up the auto
map or configuration for that mapping
and then building out this exact select
expression that the configuration
represents
and what's interesting about that is the
entity framework linq query provider
interprets that select expression it
builds and builds up the exact sequel I
need to be able to be to hydrate that V
model so that means I don't actually go
from database to domain model to view
model I go straight from database to V
model directly so goodbye that and down
here the same thing did that whole block
of code right there can just be project
to student details model so it handles
top-level properties like this it also
handles sub-collections so this
enrollments an annulment selects and
also handles flattening so this course
title it handles that as well so I can
get rid of all of that junk goodbye
other really cool thing is when you use
select projections and when you select
projections and ORM s you don't have to
do any that include junk you normally
see so this kind of like dot include
does that not exist in any framework or
oh my goodness maybe it's over here
intersect
there's no way it doesn't exist I know
I've seen that before maybe it's not
called include I'm not in any framework
or person because it's not a 1.0 product
it's a 0.1 product our applications that
use a speii net core run on full Dynamat
framework and use like the real nougat
packages that actually do work for the
real world so you can still use ASP net
core on full done that framework full
other packages that's the way that our
clients use them right now yeah
let's keep going this one this is
mapping a student crate model into
students so let's just call mapper map
yes pull that in a student create model
to student
passing in the model and that's going to
return a student so this replaces all of
that another projection I can get rid of
so dot project to student edit model
getting rid of all this stuff and on the
reverse side the same thing I will map
back into that original student so a map
map student add a model to students
passing in the model and the students so
I'm hydrating an existing object not
mucking around with the existing
properties that are in there
actually that's redundant I don't even
need that there we go so map the model
into the students and finally I believe
the delete action has one as well here
we go dot project to student delete
model there we go my favorite part of my
job deleting code all right so I've
replaced all of the manual projections
with auto map or based projections now
the configuration was very simple here I
would caution that if you find yourself
having more mapper configuration than
Auto mapped members probably shouldn't
use Auto mapper probably just map it
manual yourself so if I find it getting
any more complicated and sort of like
redirecting members and some calculated
members I don't tend to use automat but
I just go ahead and manually do it but
this being a dummy application I can do
whatever I want
including may being the mapping as
simple as possible so automatic
configuration is there I've replaced all
my projections with auto map or
projections whether in memory or through
link and then I've also registered
automatic Asian so with all that in
place let's make sure it actually works
all right let's go back just refresh
this page make sure it so it looks like
it's all working still I can still edit
things right edit yep save it yep I
fixed the validation thing so that's
working now details OOP
it says I'm missing a map from
enrollment to that one oh that's right
some people do this they do a Aperta
cert configuration is valid during your
application so if I did that I would
probably get that error saying I'm
missing something
OOP there we go unmet members found on
the student create model to students I
have a some unmet properties here so
let's go fix those oh right
student model student Cree motto
students yes okay so back in my models
student create model to students by
default automatic entire should be
mapped it usually thinks I'm projecting
in this case it's not it's everything on
the source type so for this one I'm just
going to configure automatic a just
ignore and map everything from actually
the source members and so during
configuration validation instead of
paying attention to the destination
members pay attention to the source
members so the question is that new
relatively speaking yes so like 4x4 for
time frame Oh still got a problem
differently though the enrollment cannot
be mapped so there's not a map from
student details enrollment you'd be
really cool if the exception message
actually had the configuration so you
just copy/paste I'm just making a mental
note here okay so let's go ahead and add
that configuration as well so that said
student details model so there's
something about student details model
dots oh that's right that show the
collection so
enrollments to student details
enrollment
oh okay so the configuration validation
works and the detail there we go details
works
so through link projection it was able
to hydrate the top-level model as well
as a collection of items as well so even
though I'm using in any framework or it
still supports some pretty complex
operations is able to support like a
one-to-many joined-up set of data behind
the scenes now if I had sequel profile
or open I could show you the exact query
that's being run to prove to you but the
queries generator from entity framework
are so ugly we don't want to look at
them so let's not okay so I could go
further with controllers and I usually
do I usually go through and take all the
actual business the actual business
logic that's happening and put those
into individual classes by themselves
I'm gonna go through all that practice
if you want to look at the full there's
an entire talk dedicated to even taking
controllers roll further down the path
but now I want to switch gears and now
take a look at my views so up to this
point I've been mainly focused on the
controller part of my application but in
my systems the views have just as much
duplication as the rest of my
application and people tend to ignore
that that the view is just about
rendering HTML how crazy can it get well
it can get pretty crazy but what I found
is that the abstraction is actually
available in both the old NBC and the
new NBC core are not really well
equipped to handle the kind of
duplication I see on my projects so I
tend to build enterprise II applications
made some at work line of business kind
of applications there are a lot of a lot
of forms of information a lot of tables
of information and people were using
this application on a daily basis to do
their jobs not so much like a like a
public-facing web application it's more
like a behind-the-scenes back-office
application and for those kind of
systems all have applications with 100
or so controllers and then hundreds and
hundreds of actions with hundreds and
hundreds of views so there's going to be
a ton of duplication going on with all
those views going on so instead of us
using the out-of-the-box stuff that
comes with MVC core instead what we use
is a library called HTML tag
that provides a really cool way of
building out just like how our auto map
or library builds convention based
mapping HTML tags provides us with
convention base HTML building just like
we did on the backend so what does that
look like well I've already pulled in
the nougat package HTML tags dot asp net
core so this is a version of the HTML
tags library that is targeted
specifically built for asp.net core and
in my startup I'm going to go ahead and
initialize it so I'll do services dot
add HTML tags here we are okay so as
part of this is a few options that I
will then add configuration to but first
I want to go to my tuning my view to
show you what the kind of duplication
I'm having to deal with and the worst
one I can see is probably the Edit one
so in my edit view I have this block of
HTML that's copied let's see one time
two times and three times and this is
just for a very simple form with three
fields if I have a form with like a
dozen or two dozen fields I'll have that
same set of HTML copied over and over
again now I could use something like
HTML helper extensions people use HTML
helper extensions before the problem I
see with HTML helper extensions is that
they're all string based they're all
dealing with string base HTML content
well asp net core introduces the concept
of tag helpers which are basically fancy
strings behind the scenes and much
harder I found to extend so our teams
took a look attack helpers tried to make
them work the way we build forms and
found they weren't nearly as flexible as
HTML tags and HTML tags our object base
as opposed to string based what I mean
by that is I can do something like far
tag equals new HTML tag
passing in what kind of HTML tag it is
do you want to add a class to it there
we go add a class fun time
do I want to at pin HTML add an
attribute all sorts of crazy stuff so
because my tag model my HTML tag mount
is now object base I can now start to
inject some smarts into how these HTML
tags are built so let me get rid of all
this okay so I'm going to do some more
copy-paste from my cheat sheet to do to
do oh I remember what I forgot I didn't
look at my cheat sheet I'm for my
validation example should have cheated
cheaters always win
ok so first I'm going to modify my
initial using is initialization just a
little bit and I'm going to be adding in
these different convention classes this
default HTML conventions is what comes
with HTML tags it's all the HTML
conventions 4nbc applications so the way
to build input elements and you know
boolean's being checkboxes things like
that that comes from that base set of
configuration there and I'm going to add
on top of it more conventions in this
class right here I'm just going to stick
it right next to it because you can do
inter classes ok so what I'm going to do
is side by side slowly make changes to
my tag my tag my tag can configuration
until it matches exactly what the
existing editor does and then go from
there and make it even more smart even
smarter even more smart smarter ok so
back in my edit action I've got this
editor for blah blah blah that's using
it's using editor templates which again
or anyone tried to make custom editor
templates it's like stupid hard to try
to do that it's ridiculous so they're
all razor based and you can't do like
we're in
code logic in there it's just just a
kind of a nightmare to deal with and so
I can do this instead so I'll do at HTML
dot input Oh before I do that I'm going
to go to my view imports and do at using
HTML tags dot conventions dots
conventions and I think just HTML tags
as well this is a new thing in NBC core
to have global imports across all your
views that's what the view imports file
does used to had to go to that web
config file that thing's gone you use
this thing instead HTML dots inputs
there we are that was not there before
and I give it the expression for the
model so exactly what I have before
inputs model dots last name okay let's
go ahead and run this and see what we
see
alright back over here let me go ahead
and click Edit and we should see it look
a little bit funny but I've got this
over here and I got the this is the new
one and this is the old one on the right
so it's already being able to do like
the model binding stuff to put the
correct piece in there I don't have to
worry about those pieces those are all
coming from the integration with asp.net
core now I have to go look at the HTML
though I will see some slight
differences let's go and inspect this
element that one and I see its input
type equals text value equals Alexandre
this one oh that's more it's got like
input class text box single line blah
blah blah blah blah blah blah a whole
bunch of other stuff on top of that so
what I'll be doing is adding those extra
conventions on top of it so that all
that other information comes in as well
okay so back in my start up my
configuration for my tags I'm going to
go ahead and add from my cheat sheet
this right here no here we go so this is
saying that my editors will always add
the class form control which I think is
the old bootstrap version but that's
okay
what does this have input class equals
text - box even though it's an input
type it was text we have to be extra
redundant here so let's do that instead
of form control I'll have text now this
is leave form control that's fine okay
so refresh this page and now oh it still
has the old version of it oh it's
because it's a editor okay I'll get
there in a second the next one I want to
add on top of it is my date times should
always have this configuration
associated with it so
oh let me get rid of that pattern I
don't want that I don't want that either
those are some extensions that I don't
actually want here okay and a short date
string does that not exist that's okay
we'll do two string and which kind of
string is it going to be it's going to
be the short date that one okay so what
this is saying is if it finds a property
of type date/time nullable day time is
going to modify that by adding the date
picker class on top of it and then the
value if it has a value is going to make
sure formats with a short date kind of
format so back in my view if I now go
replace this editor full with inputs
this one up here as well well again see
what we see
you
okay so if I go look at this element now
I remember what I forgot I forgot to
cheat again back in my startup I forgot
to actually add this convention to my
list of libraries so I need actually do
new NBC core HTML conventions okay
so pull down the default ones and then
adding on top of it are mine okay that
makes me less confused now
alright let's refresh this and now we
should see now my all my conventions now
there we go so now it's adding atop that
form control bootstrap style that put
the little rounded corners on top of it
the short date format here which I'm
sorry and my laptop is month/day/year
sorry and putting all the appropriate
styling on top of everything and I can
keep going with this I can then go pull
in all the view kind of conventions and
label conventions as well so let me pull
those in here and custom category of
kind of tags that's what this piece is
here I'm going to paste it all in so I
can show the final product which is
going to be my view oh let's not do that
okay so all this configuration is for
telling the HTML tag library when you
see this kind of request to build this
kind of tag modify it with this
configuration here so the policy about
how to build HTML tags is in one spot in
my application right here and if I need
to add on top of it additional ways of
building HTML tags again it all goes
back to here I'm going to go take this
one step further and that I'm going to
create some HTML helper extensions to
build out and let's just put this at the
root Oh helpers there we go
and here we go listen right here and oh
no that's not the one that's ugly
okay ah there we go should pull
everything in oh I HTML Humber there we
go so now what I can do with this input
block that is building out these
surrounding HTML I had earlier and this
form block as well I can now go back to
my view and actually replace all of this
with that HTML dot form block form block
namespace is wrong let's do
there we go just made something up Harry
Oh form block M goes to m dot last name
and I'll have two more of those first
name first mid name and enrollment date
and that actually gets rid of all of
this and what I'm doing right now is
just really building policies about how
these different form tax should be shown
OOP
I'll just get rid of these display ones
that's fine and making sure that
whenever I want to display a form block
on a page it always goes to that one
single spot and because it's all object
based in HTML tags it makes it super
easy to compose out those individual
models so let me refresh this and it
should look exactly the same it's got
the label it's got the input element the
validation message is on the side and
because it's all based off objects it
makes it super easy for me to in my
extension method compose up different
sets of HTML tags with different
information pushing them all together
into one single HTML tag to show to the
end user is that core now okay so that
library is called HTML tags it's plugged
into a speii net core and I use the
plug-in to ASP net core plus some
conventions to define a single policy
for how HTML tags should be displayed
throughout the entirety of my
application no more arguments about use
this day picker used at that day Baker
oh this label should be above it or
behind it nope we have a single policy
in a single place so that was solid
asp.net core my name is Jimmy you can
find me at twitter @ @j bogart
everything you'll see here included the
right working example will be on github
at comm /j bogart all this kind of
topics i blog at Lowe's techies and one
of the things I'm doing is building a
video course doing exactly this if
you're interested about that go to that
bitly link right there and you can sign
up for the video course that basically
walks through exactly all these things
that we just went through thank you very
much
I
we enjoy this and have a great rest of
the combo profits</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>