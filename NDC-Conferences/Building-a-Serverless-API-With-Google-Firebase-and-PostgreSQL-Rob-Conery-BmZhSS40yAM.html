<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Building a Serverless API With Google, Firebase and PostgreSQL - Rob Conery | Coder Coacher - Coaching Coders</title><meta content="Building a Serverless API With Google, Firebase and PostgreSQL - Rob Conery - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Building a Serverless API With Google, Firebase and PostgreSQL - Rob Conery</b></h2><h5 class="post__date">2017-07-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/BmZhSS40yAM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">I think we're good to go so I might as
well just get started um welcome thank
you for coming I know it's Friday
yesterday yesterday was kind of a long
day and then last night was a long night
too I guess
anyway I know that Friday afternoon
talks are kind of hard to come but I do
appreciate you coming as you can
probably tell I'm going to talk about
firebase and serverless stuff and for a
lot of people that's a bit of a trigger
word I want to start by saying that I'm
not here to sell you anything I promise
I'm not going to be a cheerleader what
this talk is about is exploration that's
what I do for a living I like to explore
and I like to tell people about it so
there's a lot of stuff in here that you
might agree with might disagree with and
I think all those things are great my
primary objective is that you walk out
of here knowing a little bit more than
maybe you did before so that when
someone says stimulus instead of
freaking out you can have an informed
freakout and that's a should be a new
thing so everything you're about to see
is in a video that I did that's my
website right there I did a 3-hour video
everything you're about to see me talk
about I spent lots of time detailing
this in this video I built an e-commerce
system and I decided that if I really
wanted to jump into this serverless
thing and do firebase I wanted to know
based on building something so I built
an e-commerce system and it's well I
shouldn't say a system I built like a
checkout with a catalog and like
fulfillment and digital delivery in the
whole deal so it's actually pretty
detailed I had a good time doing it and
what I'm going to share with you today
are three main things successes which
there are plenty of weird things that
kind of caught me off guard and failure
and I want to just give a shout out to
failure right now because I think it's
really important to fail often and to
enjoy failing like John does often not
really see I I can't believe I even just
said that like I think it just bounced
off you and hit me in the head anyway no
failures is one of the best teachers
teachers ever and conversely success I
will I will say and I always say success
is the worst teacher you could possibly
have if you have early success in your
and your turn to do something you're
going to think you're all that and that
you know everything well you haven't
so failing is good I tried to fail as
much as I possibly could with firebase I
did you learn about that but in general
I like firebase came away from this and
I really enjoyed the surrealist approach
it made me think completely differently
about building applications so that's
what you're going to see today it took a
lot of experimentation to get right and
a lot of exploring the edges and
boundaries and breaking things and so
I'll tell you about that for the snarky
out there I just need to say this
because I know there's snark that's
involved with this but it's also some
confusion yes there are servers involved
in server less it's one of the dumbest
names that was ever given to technology
and no you can't use EFT sharp with it
there's my dig adept sharp that I have
to do it every single talk but maybe
actually on Andrew you can use f sharp
so I might have to take that slide off
the best way to think about server list
is you have your application in a normal
circumstance you'd have an application
and then you'd have a database server
web server you'd have just servers that
do stuff well instead of having those
servers that do stuff you have Google
that does stuff you have you have real
time database that Google just manages
for you you have hosting you have a
bunch of things and it's just Google
running your stuff you don't have to
worry about tweaking and tuning and all
that other maintenance that goes into
running your own box if you still don't
believe me just get over it please and
we can move on it's good to have
opinions but let's have informed
opinions the next question I always get
is have you tried and that's my job I
like to explore it's just who I am and I
like to explore anything so I spent
about three weeks with AWS lambda just
to see what it was all about I had a
good time doing it but I spent a lot of
time just figuring out the bits and bobs
tweaking little dials with AWS and I
know that people that are familiar with
AWS Amazon's web services will find that
easy I didn't I found it confusing and I
found it expensive I got a bill for $50
and I had no idea what it was for until
I dug down and found out it was for a
networking thing but anyway it's okay it
works and I'm not here to trash it it's
just I'm not in AWS person web cast I Oh
is another offering that's out there but
it's from the folks at auth0
and you can go in open a browser and
write some code
using node and run it and it's pretty
neat the problem with it is that you pay
nine dollars a month you get two
functions and after that they have an
enterprise plan and so and they don't
even know really what the offering is
all about anyway I have some friends
that work there and I tried to get some
answers and they just kind of shrugged
there's a shore functions I worked with
that for about 10 minutes just trying to
log in and I couldn't find my Microsoft
password next thing I know I'm answering
questions about Xbox and then I just
kind of give up um
then of course Heroku I think you guys
probably know who Roku we just kind of
push your code in the sky views that
many times elastic Beanstalk another
Amazon offering I've used that many
times and then we have dr. in cloud 9
all of these are kind of like these
virtual ways of getting around working
with a server and yes I've worked with
all of them as to why I just had this
inspiration one day I remember I was in
Munich and I was just thinking hey let's
build a website without a server plus we
could try and at the time the
inspiration was to get a bunch of
services to work together knitted
together by either web hooks or
something like zapier which is a way to
compose web hooks together it's another
service so I decided to work with
firebase user app which is now in a
business snip cart send out Jekyll on us
Shopify was another one so I put all
these things together to see if I could
get a working site based on a static
website and I kind of succeeded there's
still a few problems here and there
where I realized I just need my own code
and this is where it always comes back
to you for me is just I've got my shell
scripts it will build a node box for me
I've got images up at AWS or Amazon and
I also have images over at digitalocean
just plug and play and go and it's
usually just simpler and easier for me
to do that this was actually no simpler
at all and involved a bunch of services
services that can all fail so as far as
you are concerned now you've heard my
story what does this buy you why would
you want to care about any of this stuff
so normally what I like to do in these
talks is I like to just come out with it
you know just come out with a punchline
immediately but I actually have to build
the case so just stay patient with me
what is this going to buy you well
number one this is what I built
and this checkout system is on a static
website built with middleman I plugged
in a plugged in stripe stripe check out
as you saw and that is a real-time
checkout that is being fired by
firebases database and then all these
functions are going off updating the
status and that status is being rippled
back down to the browser so you can see
these little check marks go off when
everything happens now you and I are
developers and we don't necessarily I
mean we get excited about this but
customers probably won't care but then
again they might because this is where
the this is where the thinking starts to
change about what's possible with the UI
using a real-time backend having an
update your front-end so for instance
you might want to let them to custom an
earlier we say an email but while
they're waiting for the email give them
access to the download and that's
exactly what you just saw that download
button right there actually has counters
on it so every time they click it it
goes up to Google's storage grabs the
file brings it down with an expiring URL
and updates the the ticker right there I
built this with the bottom I built it in
about 10 days and it was really fun to
do so overall in terms of firebase what
you get with the server list thing is
you get web hosting number one which is
pretty neat SSL website your own domain
you're going to see that just a second
you get a real-time database that is
quite powerful it's a document database
document database I kind of think of it
more as a key value store you'll see why
in a second you get authentication and
so you can have authentication across
mobile and web and it's all going to
work together and that includes
anonymous authentication which is
fascinating I'll talk about that more in
a minute you get file storage so you can
allow users to upload and download
things you can put images zip files
anything you want in their mobile
analytics which is a really big deal if
you're doing mobile mobile apps if
you've ever done them before and you
want good solid analytics on it then you
know that you usually have to go with a
third party a third party application or
service that specializes in mobile
analytics and it's expensive Google
throws it in for free you get logging in
a three-dimensional oddly or something
like paper trail but it works it works
well and then finally you get little
functions firebase functions that fire
in the sky
I based on certain things so we're going
to take a look at all those in detail in
a second but I want to get to the
negative part which is why wouldn't you
want to do this I think that's important
too to understand when you have to make
these decisions as to which technology
you're going to use and the first answer
is pretty much the obvious answer that
service lock-in sucks it doesn't matter
what service you're using it could be a
sure could the AWS could be firebase if
you build everything on top of a service
like this then you're setting yourself
up for a possible bit of trouble like
these people I don't know if you've ever
read this post on medium it made the
rounds on Hacker News these poor people
I first left when I talked about I can't
help it it's hysterical they do Internet
of Things and so their Internet of
Things used firebase and they were in
the firebase $25 a month plan and then
all of a sudden firebase found a bug in
the way they reported their analytics
that shot their expenses of up to $2,000
a month from $25 a month which is not
funny I guess
so the poor people tried to tried to
talk to firebase they submitted a ticket
and said help what did you guys do
nothing has changed on our end and
firebase said oh right yeah we had to
fix an analytics problem that we had
we weren't accounting for SSL
Certificates coming in through the
bandwidth and so that was enough to
shoot this company's bandwidth up and
boom they're in trouble so let's talk
about this because this is important
what happened and why did it happen so
this is the pricing model for firebase
and it's actually pretty comprehensive
the free plan you can cover most
applications with a free plan if you're
not using any of the real-time stuff on
using just the functions you can get
away with using firebase for incredibly
cheap if you want predictable pricing
$25 a month gives you access to two and
a half gigabytes of storage which is a
lot of data and 20 gigabytes of
bandwidth per month so put that in
perspective the entire work of
Shakespeare I think fits in five
megabytes all of it
I ran tech club business for five and a
half years and my entire back-end
database every bit of data came in it
honestly twelve megabytes so you've
really
really got to try to hit this if you're
just running a regular website but they
also have this flexible plan
pay-as-you-go which is quite cheap
that's when I'm on my last bill was nine
cents so the take away that this company
had from this whole problem was sort of
profound and sort of not what they had
done was they had built our application
on top of firebase in such a way that
they hard-coded just about everything
they were not flexible at all to fix the
problem that was causing this massive
amount of bandwidth to go back and forth
to fix it they would have to recall all
their devices and recompile the
application and send them back out
basically it means going out of business
so they made it in such an inflexible
way that they couldn't change so that's
kind of the thing one you have to have
to consider they were sending a ping
once a minute from all our devices to
firebase and when that SSL certificate
payload went on top of that boom Sony
could have to scratch your head going
wait a minute so you relied on a service
and you wrote your code in such a way
that you couldn't change don't we know
better than that and this is where it
kind of leads me to my favorite Hawaiian
saying gum I you hear that a lot over
there and it just means think use your
head you know better than this
we're software developers we should
understand this now I can have some
sympathy for the developers because they
kind of started this as a bit of a fun
project and next thing you know it's
blowing up but they never went back and
tweaked the stuff that they were working
on so they could lift up and move and
that was their solution which is
actually kind of misplaced because if
they would have picked up and moved to
AWS they would have been hammered by the
bandwidth charge anyway so looks like
they might be going out of business
quite soon no matter what which is
unfortunate here's the here's the thing
I'm trying to bring across is that
businesses are here to make money and
sometimes if you rely on a service it
doesn't matter what they're doing and it
doesn't matter if it's a platform it
doesn't matter if it's anything
businesses are trying to make money and
you need to understand how they're
trying to make money off of you and so
you have to give yourself a way to get
out if you disagree with the way that
they're trying to make money think about
some of your favorite businesses that
have come along before Volkswagen I love
to Volkswagen when I was growing
up uber GoDaddy is another one that
people are fleeing from parse is another
horrible story because they were a
competitive firebase real-time back-end
Facebook bought them and then shut them
down and left a ton of developers in the
lurch and a lot of applications just
went offline and disappeared while
you've been here hopefully you've
attended a few talks where they've
talked about software architecture you
want to build for change this is the
answer to what happens if firebase
changes its mind in the future then you
change what you're doing and you don't
get caught that's just the answer I love
what Martin Fowler says here that
problems and solutions and software have
not changed in the last twenty years all
these things are still the same if
you're going to use something like
firebase or AWS or any other stuff be
prepared to be let down that's just
something you're going to have to do you
have to code defensively prepare for
change we know this right and trust no
one I hope there's some well players out
here yeah trust no one especially
yourself this is why we write tests all
right lecture is over I hope you guys
get the idea that's my answers when
people say I don't know about firebase I
hear they're kind of questionable well
you should be questionable about what
you're trying to do anyway all right
let's get into the fun stuff and then
for the lecture how does this actually
work and what does it look like so the
first thing that you're going to do is
of course you need to have node on your
machine so it works with Windows or Mac
Linux whatever you install node and then
npm install firebase tools and then you
install it globally now you have the
firebase CLI you create a directory and
then run firebase in it and that's going
to drop some files onto your hard drive
excuse me that's going to run this it's
going to run this little wizard and it's
going to first thing it's going to ask
you is what kind of application are you
trying to build what services do you
want to use and so you get database you
get functions and you get hosting
all-or-none you don't have to have each
one of them in there they all work
independently of each other which is
really nice it's then going to open up
an authentication screen you're going to
authenticate at Google and then the
browser is going to close and it's going
to drop you back into the command line
where you then get to tell it which
project you're going to work against and
so these are little prod
so you kick up in the firebase interface
which you're seeing which you're going
to see in a second so once you're done
doing that it drops a bunch of files in
your directory and this is the fun part
there's not many files there it is super
lightweight and super simple to use I
have two directories here I have
functions you can guess what goes in
there inside of there you can notice
that it just looks like there it's a
node module and that's exactly what it
is you just export the functions that
you want firebase to run in the cloud in
the serverless
space wherever that is and this there's
just simple exports that you would have
on a node module the highlighted
directory there is the hosting directory
in the HTML that you have in there is
serve simple enough they even give you a
simple page to get started it's got the
firebase stuff in there on your client
there's a few other files in here
including firebase JSON which is just a
configuration it tells the firebase
tooling where to find the database rules
which we'll talk about in a second and
then also where is the hosting directory
and something I want you to notice is on
line seven even though there's no server
you have server settings so let's call
the server list settings but you can set
up rewrites if you need to this is set
up to handle a single page application
so it'll redirect every single request
to the app to go straight to index.html
so if users are going to go in there and
try and mess with to your URLs they get
redirected speaking of rules we're going
to talk more about rules in just a
second but one of the things about
firebase is that it's built so that it
can be accessed directly by clients and
they did this with mobile in mind so the
idea was that people aren't really going
to be able to get in there and mess with
it anyway because they're working on a
mobile app but you can also do it from
the web as this is sounding alarms in
your head I'm going to talk about this
in a second but the idea is that people
write directly to your database so
obviously you're going to need some
rules surrounding that interaction and
that's what you're seeing here I'll get
into that in just a second so I'm done
so just simply by writing firebase in
net I now have a website that I can use
I now have a database and I have server
list side server code so now we can put
everything together the question is what
are we going to build so I could build a
single page app if I wanted to I could
build
weird hybrid that works with another
website or I could just build a full-on
web application which you're going to
see me do in just a second
personally I don't think it's very good
for single page applications I think
there's better uses of a single page
application but whatever you do it's up
to you and this is where we start making
the mental leap for what is it that
we're going to build here this is not
just your typical website what we're
building is just another client for the
logic that you're going to put up in the
cloud and and this is where kind of my
brain started to shift a little bit it's
something I've always wanted to do
because I like static websites I really
think they need to have a static website
and then my API that has all my logic
seems like a great idea but the thing I
don't like about that is the amount of
JavaScript I need to support it this
makes it easier working with firebase
and you'll see what I mean in a second
so my first step here is that I want to
create my static site so for this I'm
using middleman which is the Ruby static
site generator it's my favorite but you
can use Hugo you can use anything you
want
so I've installed middleman here now
into the same directory and it's giving
me a few more files including a build
directory where it's going to output all
the HTML that it generates so if you're
on Windows Hugo's is a good one if I
didn't say that before is a great way a
great static site generator to use so
because I've started to use middleman
now I need to tell firebase where it's
going to find the hosting files so
instead of the public directory which I
deleted I am now going to tell it to use
the build directory that's where
middleman is going to put everything
when I say middleman build it's going to
go through all Maceo on pages and it's
going to crunch them down it's going to
crunch the JavaScript for me and a CSS
and boom so this is my website
it is completely static I don't have to
worry about any server stuff behind it
rendering viewing templates routes none
that crop it's already built and so it's
ready to go and I can push it live I
don't blame you if right now you're
underwhelmed because what I'm simply
talking about is building a static
website and where's the good stuff
whereas the serverless code the reason
I'm starting this way is because you
need to have a break in the way you're
thinking about building websites and the
way JavaScript interacts with a server
because we're going to do something
completely different I have a different
client now that's my website place
static site I want my client to now work
with firebase to do some things and
that's really the start of the different
thing that we're going to be doing the
different journey we're going to go on
we have a real-time database at our
fingertips we have authentication for
authenticating our users storage in HTTP
and all of those fire events and we're
going to use those events to actually do
something so now let's get to it and
we'll step through it let's say we have
a business where we run tours to Mars
and we're going to send people up to go
hiking through the Valles Marineris for
$35 first thing they were going to do is
we're going to want to charge them money
and so because we're going serve list
we've done any server-side code and they
don't want to write forms and form
validation I'm just going to use stripe
which is a big payment processor in the
United States I hope you guys are
familiar with stripe they have a thing
called stripe checkout which is just a
really cool UI you just drop it in fire
it up and off you go
it pops up takes the payment information
and send it off now in a normal
situation to try and power a checkout
system like this this is a normal
situation we would probably have routes
like controller carts controller let's
say index new create so on so that would
be working for working with carts we
might have something for orders and then
we kind of just process these orders
we've bounced Ajax back and forth wait
for the response we kind of just sit
here and wait for everything to happen
the firebase it's different with what
I'm doing what you're about to see it's
totally different because we're going to
be using 100% events that trigger other
events that trigger other events with
the server this stuff up of firebase you
get a number of events that you can use
you can trigger a function to go off
when you write to a particular area in
your database when somebody
authenticates or when they log out you
can trigger an event based on a Google
analytic event because you know it's
Google and you can set up a Google
Analytics event and it will actually
fire a function that is in your project
cloud storage if someone uploads a file
or downloads a file you can have an
event go off I didn't I'm not going to
touch on this today but the Google cloud
system has a pub/sub thing which is
amazing you just pipes data pub/sub you
got a message queue behind all of this
and it's a great way to send information
between different firebase
projects so if you'd like to think in
terms of microservices you could have
one project dedicated to what you're
seeing here you can have another one
dedicated to fulfillment and it just
sits and listens to pub/sub and it
starts a chain the final thing we have
is HTTP today I'm going to talk mostly
about database rights I'll talk about
the HTTP trigger in a second too but
that's how we're actually going to send
this check out information into our
server lists back-end because when the
client comes or when the customer comes
and they want to go check out they're
going to fill out our stripe thing and
what's going to happen is stripes going
to take that credit card information and
send it up to stripe com it's not going
to touch our servers at all and they're
going to hold that card information and
they're going to give us back a thing
called a token and it's going to come
back to us and it's basically a
representation of that card that we can
now use to charge against this is great
because it keeps us PCI compliant which
is something we want meaning that our
servers never touch any credit card code
and stored safely and securely up at
stripe what I need to do is I need to
take that token now and do something
with it
and that's what this code is right here
this is some JavaScript on that same
checkout page and this is the handler
for configuring stripe checkout and
basically I'm setting some switches
saying if I want to know their address
and so on but the big one is online I
can't see that line 136 which is the
callback handler this is the function
that fires when I get the token back I'm
going to create a payload appeal it's
going to have the order items on it and
then I'm going to tack on the payment
which is going to be the token itself
and this is where the goodness comes in
is the very bottom there that is the
firebase SDK code for writing to the
firebase real-time database I'll talk
more about this in a second but the
thing I want you to focus on is the way
I am specifying a reference and you can
think of that as an H ref for a URL it's
a way that I think about the data that
goes into firebase it is a JSON document
store but it's also not it's kind of a
key value thing and I like to think
about the data having a URL and so what
I've done here is I've given this data a
specific URL of having sales and then an
order ID that I create on the client you
can see
it is a great if you want I'll show you
that in a second and then finally after
that check out so it so firebase is
going to write this data into firebase
directly this is a firebase console
which I haven't showed you yet but this
is the real-time database and what it
looks like you can see it looks like
just a big JSON tree and that's all
right if you think about it that way but
you can see that what I have is instead
of a big fat grid I like more logical
order numbers so I have the name of the
store then I have a date and the time
and then a little bit of randomness
after that and then underneath that as
you can see I have a bunch of data that
goes into the order what I'm going to do
here is I'm going to build out this sale
I'm going to build it out as these
events go off from an attack information
onto it as each event goes off I'm going
to build a god document as they say and
this is where I need to take a quick
segue and say that when you're working
with firebase you really really have to
understand the way they want you to
store the data which is in a flat
structure they don't like big nested
documents the reason why if you have a
big nested document and you pull back at
a top level you pull back a huge payload
and you're going to get charged for it
so ideally what you want to do for speed
and other things is to make everything
flat with associations that's really not
something I have to worry about because
I'm writing historical data I'm not
going to access this stuff a lot in fact
I'm not even going to use firebase when
I'm done which I'll show you in a second
okay so this is what I'm trying to build
out moving on what I need to do now is I
need to actually create the function
that's going to receive this data and
this is now node code that is running in
my functions at firebase so what I have
here is a database triggered function
and so I'm simply exporting a method in
my index dot yes in my functions
directory I'm exporting a method see
what's the name of that one its payment
received you can see it right there
online god my eyes are blurry line four
that's a simple function I'm exporting
and it's staring at a path sale and then
parameter whatever some ID and then
check out when something gets written to
that path in the database this function
is going to trigger and it's going to
give me an event that I can then use
so from that event I'm going to pull out
the data I'm just going to grab the
value now I can do a number of things
with the event itself and the data and I
can listen to it for changes or what not
but in this case I'm just going to pull
the value out it's going to be a JSON
dump that's going to have the order and
the payment information on it then I'm
pulling out the order ID itself I am
doing that simply by grabbing the
parameters from that I like to call the
URL it's just like working with Express
or ASP done then we see I'm going to
pull out that parameter that you see
right there that's my order ID and then
finally I'm getting a reference you can
think of it as a client I'm getting a
live reference so that I can write data
back to that sale if I need to something
I'm going to just point out really
quickly and I'll talk more about in a
second but notice that I'm calling this
or I'm getting the admin ref this is
important because there's a distinction
between the public can do and what an
administrator can do and since I'm
running in a function up on the cloud I
can do administrative stuff which is
like God powers I'll get to that in a
second so down below it becomes easy now
if I was being a good coder like I said
I should have been before I would put
this on the Lib directory and kind of
encapsulate it but just for clarity too
so you could see it online I put it in
line here
I'm just requiring stripe and then
because I can't stand asynchronous code
in JavaScript I'm using the code library
co-routines
and generator functions with es6 I'm not
going to go into explaining that but
this allows you to use the yield keyword
to run to run asynchronous code
essentially synchronously on line 13
you'll notice that I forgot the yield
keyword sorry it's in a later slide I
goofed but anyway I'm running the charge
and then down below on line 17 I'm
updating the data at the checkout path
again and this time so I have the
checkout data that was just passed to me
this time I'm writing another key in
there called progress and I'm setting
captured to true so why would I be doing
that well let's go back over to the
client code again and this is why I'm
using view j/s I don't know if you've
ever used view GS but it's a fun library
you can use knockout you could use any
number of things but view is reactive
and it does this two-way binding one of
the things you can do is to use a
plug-in called view fire and that allows
you to basically listen to firebase
fire base and when something happens you
can change your UI around it's actually
really easy so here I'm telling it to
listen to our check out path but listen
to the progress specifically the
progress for that check out so that's
going to have a bunch of little flags
that I'm going to set along the way by
doing that it's going to allow me to
change the CSS and update the screen
based on what's happening on the back
end of firebase so what does that look
like well let's run through this order
one more time so we're going to bring up
stripe check out and we are going to hit
pay and this is now going to write that
record to firebase in the database and
now a series of events is going off and
each one of those events is updating
that progress and I'm staring at those
individual flags on the client and I'm
just changing the CSS as each one goes
off that's that so what are those
functions look like this is them I kind
of commented them out so you can see
what I'm doing but I want to step
through it and notice that I'm listening
to different paths that get triggered on
different events so in the first one I'm
listening for when a transaction is
written that happens when the Striped
charge comes back and I'm just writing
that striped charge straight in on to
the checkout itself or on to the sale
itself so when that transaction is
written we're going to write an invoice
down we're going to set up deliverables
for the client and then we're going to
set the progress to be fulfilled after
that we have another function called
notification that's going to listen to
the invoice key that's happening on that
sale when it sees that an invoice is
written we're good to go to email the
client so we just put a few things
together and we sent an email off to the
client and then we're going to put a
note on the invoice itself to say yeah
we emailed you which is just a nice
thing to do finally because I don't
trust firebase and neither should you
don't ever trust anyone to do anything
for you forever I'm replicating the data
completely to Postgres so this is
triggered when the progress gets down to
completed so when the completed thing is
written to the database that I know
everything is done and I can take all
that data and write it up to Postgres at
compose comm and I have a full set of
data that I can then switch on a dime if
I need to and get the hook away from
firebase if they ever decide to charge
me two thousand dollars
which I think was Skeets fault you're
unusually quiet I do appreciate it
do you see a problem with the way I put
that all together I noticed I told you I
was going to talk about successes which
all of that works but this is a bad
thing that happened to me so when you
write these functions to trigger on
events you're triggering on write
anything that writes to that path so
here I'm listening for an invoice right
so when the invoice gets written I'm
going to email the customer I'm going to
update the progress we're good so far
but then I'm going to go back to the
invoice and say hey thanks for that I'm
going to add a note to it and then I'm
going to go up and I'm going to trigger
this function again and then I'm going
to email a client and this happened to
me about five times yeah this would be a
recursive call emailing your client
blasting room full of spam that's not a
good idea and I did this about five or
six times and it was really terrifying
to see the logs just going boom and
there's no stop button so I had
redeployed I just imagine doing
something stupid like that production
which leads me to the next thing I was
going to say the production environment
is going to be almost completely
different from from the environments you
have on your desktop how am I going to
possibly replicate this or even know so
that's something that you discover
unfortunately in the live environment
and hopefully at some point in the
future this will all change the second
problem that we have and hopefully
people in here are saying things that a
good idea we're letting the public write
to our database and what I mean by that
is my handler is basically writing and
you can see the write code right there
an enterprising young person might sit
there young person whatever junior
developer senior developer neckbeard
anybody could be sitting there open the
console what's this guy doing and start
messing around and start writing to our
payments table and causing us pain and
this is where you're sitting in in a
meeting with your boss and your boss
says wait let me get this straight
you did what now like I writing through
the database from the browser why you're
fired
that's really all that discussion that's
all that discussion needs
so let's talk about security because
that's a big deal a lot of people ask
that question how do we prevent how do
we prevent bad people from doing bad
things
the first way we're going to do this is
with rules so now let's jump in a little
bit how do we protect our data we've got
payment coming in how do we know that
it's good and that we should allow it so
we talked about this or I talked about
this briefly before
rules are basically just a giant JSON
document and you can set little to false
flags in there or you can actually have
expressions that get emailed when a
certain event happens so let's take a
look at that a little bit more in depth
so you set rules for various pathways in
your data so you've already seen that I
have a sales pathway if I had read true
on there then someone in the browser can
just use my client and say show me all
sales and they could they could have a
dump of every single sale in my database
by default everything is set to
readwrite false as you can see here I
have rewrite false just to be sure for
the sale and underneath that though I
can override that so the dollar sign
notation there just is like a
placeholder it's like for every single
record in for every sale that we have
under the sales key we want to make sure
that for checkout and payment that the
customer the client can read the data
because they might want to see the
payment I can set that to false too we
can allow no reads on that if we wanted
but to right now we want to use some
predefined variables to check one is
their new data coming in because this is
just on right that's all this stuff
happens is on right is their new data
coming in if so good we also want to
make sure there's no data that already
exists so what we're doing here is we're
setting up a condition to make sure that
only new rights are allowed which is
just a little bit of extra precaution
that we can have so that someone can't
come in and tweak their payment data
later on or even delete it yes
well if I know the ID if you know the ID
yes not the wholesale you can read their
payment but that's just a stripe token
I'll come back to that in a second the
last thing that we can do here is we can
run a validation the validation just
validates some data that that is being
written to make sure it conforms to
certain rules so here I'm just checking
to make sure that there is a token field
and there's also an email field and you
know this kind of works we can we can
write some decent JavaScript expressions
in here to make sure that things happen
the way we want to john Eschete just
asked what happens if if you can guess
an order ID yep you can go in there and
if you know order ID and you know
firebase you can go in there if it's set
to read you can read certain bits of
information you have to another pathway
otherwise firebase just ignores you so
if you were able to guess those URLs yes
you can do some damage
the last thing I'm doing here is on the
bottom I'm overriding the progress key
so that we can read the progress what we
can't write to it from the client it's a
little confusing when you started to do
it because what's the difference between
validate and write we have these two
expressions that are both running
validations and it's a little confusing
so that confused me but it turns out
that write will cascade to every child
record and validate will only stay with
that current note so that's a difference
but as John pointed out very eloquently
a whole as a whole as a whole as a whole
you're seeing in a you're sitting in a
meeting with the new CTO that just took
over for the old CTO and they're
grilling you about the decisions made on
the application maybe there was an
incident that you're responding to and
you're being grilled about it they will
find a way that you screwed up and if
you let the public write to the database
you are in trouble and that's that's a
problem and I don't have an answer to it
sort of and I'll get to that in just a
second because there's actually a way
you can expand these rules to do some
clever stuff let's take a look at option
two because the first option was just to
write to the database what if we did it
the old-fashioned way and just using
HTTP events and just in an Ajax post and
that's certainly something we can do so
here is our different function let's
call it a different one instead of just
doing a database right let's say we did
in Ajax
post up to up to our firebase functions
once again I'm in index J s and here I'm
doing functions HTTP on request and one
thing I want you to notice here is it
doesn't care if you're doing a post put
delete patch whatever it's just going to
receive it and you're getting a request
response object that looks just like
Express doesn't it in fact this is based
on Express so you can actually do things
that you are familiar with in node and
Express directly here in firebase
functions which is neat so for instance
I'm pulling out the request body which
is going to be the JSON post stuff
coming from the payments going to be the
items in the payment information then I
can run an if checkout is valid and they
could do my validation code on on the
backend there and I can go on something
that's interesting about this that I
really really like is since it's based
on Express you can actually use Express
so here I am just requiring Express if
you've never worked with it it's an OGS
web framework I'm requiring Express I'm
creating an application I'm writing a
bunch of routes I can even use a router
if I want so I can handle all this code
in an express out this is awesome
because the firebase screws you over in
the future you can just take your
Express app and you can move it over to
digitalocean and just just serve that
directly and that's a great way to
shield and hide yourself because here
I'm just passing the app straight off to
firebase functions and since it's just
like middleware like the what you get
when you get a HTTP HTTP event you can
just plug it right in and it works which
is kind of nice but again a little bit
of confusion here it's based on Express
but it's not expressed it's something a
little bit different so you're missing a
few things in here such as if you wanted
to use a view engine and render some
templates res dot render does not exist
and I think they're thinking on that was
well this is supposed to be a back-end
for a full-blown website so you don't
get template rendering you can do it by
hand if you want to but you don't get
that another one is you don't have
access to the raw request body which
kind of sucks because if you're using
stripe and you want to have a web hook
receiver you have to validate using
sha-1 encryption and other things but
using the raw body and since you don't
have access to it
you can't do it so you have to do a
different thing but those are some of
the gotchas that I ran into with that so
again this is a same kind of logic that
I have in here in this HTTP responder
I'm going to run the charge and see I
remember the yield keyword which is nice
but here you'll notice that I'm using
admin database ref and I wanted to talk
a little bit about admin versus the
regular firebase SDK you can't do
administrative stuff through the regular
firebase SDK they want that they want
that separation so you don't
accidentally make a mistake
based on some authentication or whatever
it's actually an entirely different SDK
it's based on the firebase SDK but it's
completely different so you can use that
in your node code you can use it in the
back end here firebase functions to do
anything you want to the database right
anywhere you want you're an
administrator array for you so that's
what I'm using here to then run the
updates and write the transaction and so
on the final thing I can do on this HTTP
event is I can just write out using
course which I have to do because it's
cost origin so I use Corey's middleware
which is just Express middleware and I
write out the response and we're good to
go
okay so I've managed to change course
here and move my logic from a database
event responder to an HTTP response is
it worth it did I get the problem I mean
think about the code that you've written
mate might accept payment do you have if
you have throttling in there for IP
flooding if someone's just going to sit
there and write post to it and try and
jam your jam up your back-end
what kind of validations do you have
that you would have written that you
can't otherwise write in these
JavaScript rules well it's interesting
because I found this code on Stack
Overflow this is actually it's weird
it's a question that ski did not answer
though this is actually this is actually
some code that someone wrote that uses
another index and anonymous
authentication to check a timer to see
if it's okay that someone can post again
it's really clever stuff and it brings
me around to saying highlighting a thing
that I really like about firebase which
is they have a notion of an anima saw
then' ocation where it'll actually know
who the user is based on a token they
stick and local storage
and it's based on IP address and I think
MAC address as well but anytime they
come to your site you recognize who they
are and then you can actually in your
rules here check the users ID and then
make sure that they're not flooding your
system and if they are you can cut them
off or do other things so that's
actually one really clever way of
preventing this yeah yeah John saying if
you're a bad actor there's ways that you
can tweak an instrument and like I said
a holes of holes a hole right so I mean
you could you could have some bad things
happen to you if you just wrote directly
to the database and just want to say to
in the video that is about this I
discussed this and I go with the HTTP
event okay so that leads us on the last
part one thing that we need to do is we
actually need to notify our users of
what's going on and this should kind of
make you think oh wait a minute
this was all neat you're doing the
checkout but what about all the
administrative stuff that comes along
with the application that's the hard
part isn't it you know you've got to
respond to users you've got to track
customers you've got to know what's
going on you've got a refund if you had
to well this is where we get to the
really interesting part about going
serverless is you can weave in functions
excuse me services that do things it's
all kind of open back there
and and there's all these different ways
you can do web hooks and responders to
use an external service that might do
the stuff you need such as drip which is
my favorite favorite email service I
don't think they're marketing themselves
very well because there's so much more
than just a mail lists or mail
automation service like MailChimp that's
what a lot of people think about this
company they allow you to do all kinds
of really interesting automations where
if you have an email address come in you
can cycle some events you can update
some data you can do a whole bunch of
stuff including setting up a custom
event that gets triggered by an HTTP
POST so you can make up your own events
and on the backend of their system and
here I'm making up what's called a rule
and I'm saying anytime an event is
triggered in drip called new order this
is what I want to happen so from my
functions all I'm doing is I'm doing an
HTTP
host and sending some JSON data up that
JSON data has some email it has the
charge information it has an order ID so
now up here at drip what imma what I'm
doing is I'm sending the notification
email saying here's your order and I'm
able to use liquid the liquid templating
engine that you see somewhere I think in
Jekyll and also on Shopify and they
Mabel to format this stuff based on some
wildcards and variable data and so on to
to show a really nice email and send it
from my list server instead of writing
the mail code myself and the formatting
code myself I'm also doing something
else that's kind of interesting they
allow you to have custom fields based on
based on the person's email so I can
come in here and I can set the orders
that they've put in there and I can
concatenate them on so I know every
single order the person is has made I
can also put the charge information so I
can put the transaction IDs for stripe
or PayPal or whatnot so basically what I
can do is if I keep going here I can
make drip my admin back-end which is
kind of funny to think about it because
the user comes to me and says hey I
watched your video it's really neat but
I want my money back sure I can go to
drip I can look up the email address I
can see their order yep there it is
I can see a timeline of their order
activity and then down below I can see
the charge I can see what's made it
stripe I go over to stripe and I refund
them based on stripes back in because
they already wrote it why do we need to
write it again this works for me because
I have a small business it's probably
not going to work for you if you have a
big business but one thing you could do
is you could just create a whole other
fire based application make yourself a
single page application that works with
this stuff and off you go
it's just one way of doing it why am I
doing this why would I want to do want
to use a service like this instead of
just writing my own back-end this is my
friend Johnny when he came in and helped
me test test out my application that I
built and you can see a timeline there
of everything that Johnny has done to
through this order you can see down
below the very beginning he's triggered
the new order event and then right after
that you can see that some data was set
we have a custom field the data was set
you can see which order it was
and then you can see that he received
and opened the email that I sent him
notifying him of his sale which is kind
of cool I can actually trigger a bunch
of other events if he clicks a link in
that email I can trigger another event
that he cooked it and it can do other
stuff like follow up a day later saying
hey what the download went okay so
number of things I can do in here and
then finally we updated some more custom
fields and if you think about this from
a customer perspective and a marketing
perspective your customer doesn't start
when a sale is finished your customer
actually starts way back here when you
engage with them on Twitter
maybe you gauge them some of they heard
about you somewhere so they became
interested in your offering maybe they
went through a preview thing where they
downloaded a preview and you followed up
with them some with some more marketing
emails but that engagement started back
here and then eventually resulted in a
sale you want to know that and and a
system like this is built for that and
so that's one reason I love drip and I
think it's really cool when you start
doing serverless stuff and you start
thinking about integrating with other
businesses
it changes your mind about what's
possible which I really really like so
much to cover I haven't even talked
about authentication mostly because it
is so basic to implement it's JavaScript
and you basically wire up to calls to
firebase and they track who the user is
when they log in and if they're logged
in you can wire that straight up to view
j/s and you can have a little things
show up in the top right corner you
recognize who they are welcome back
it's persisted in local storage so it's
like a cookie but a little bit better
and safer and also firebase storage I
haven't talked about and how you just
works just like Amazon's s3 you can set
expiring URLs that you can grab from a
firebase function and you can set it up
to the digital download service for your
application which I did if you want to
see more of all that stuff I encourage
you to go to my website big machine Bo
and you'll see it and if you are
interested at all there is a coupon for
20% off the video is $30 and you can see
in detail everything I just walked
through whoo that's about it if you have
any questions I'll take them
thank you any questions anyone you just
shout it out yes yeah so the question is
if he tried the free plan and he did
something stupid and like something
recursive that used up whose bandwidth
and whatnot would he be charged the
answer's no you have to set up a payment
plan you have to put in a credit card
you have to actively go in there what
they'll do is they'll just cut you
they'll just cut the function off
entirely and you can actually set that
rule up and they have notifications
where if you're going over your
bandwidth I didn't mention that but they
do have notifications in there and you
can actually set a switch like yep take
me to overage or no don't shut this
thing down and send me an email
yeah the question is is it node only and
man do you know I I was hooking that up
I thought I saw some Python code what's
that it's Python supported - I think
Python and I think I saw a Java in there
too and it's one of those things i meant
to investigate the tab is still open to
my browser but i didn't have an answer
for you sorry but I think it I think
Python and Java are supported not F
sharp though sorry I'm getting trouble
for this okay anybody else all right
enjoy the rest of the conference thank
you for coming appreciate it</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>