<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>There's Treasure Everywhere - Andrei Alexandrescu | Coder Coacher - Coaching Coders</title><meta content="There's Treasure Everywhere - Andrei Alexandrescu - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>There's Treasure Everywhere - Andrei Alexandrescu</b></h2><h5 class="post__date">2016-08-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/fd1_Miy1Clg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello slaw take it right hey you guys
thank you very much for having me this
is amazing
hi this is my third year and I just love
no way it's just awesome and let me tell
you a few things I like because it's
just it's been a wonderful couple of
days so far
one thing I like is that I did some
research and it turns out that I'm I'm
on an average Norwegian 180 centimeters
unspecified weight and I'm still working
on getting by q up to the average so if
I applied for a residence in Norway it
might be just the out your average guy
in Norway which would be awesome and one
thing I really admire about about
Norwegians is they speak English like
like to perfection like awesomely like
idioms everything they got everything
even they got kind of done the not so
nice parts of American English for
example sometimes some Norwegian folks I
want name names
they say they end the sentence like a
question you know like hello I'm you
knows I work at Cisco not like well I
don't know your name so but you're not
sounds plausible and I can fix your job
at Cisco I can't help there but I'm glad
you asked well it could be the opposite
which is new was new to me there's folks
who say a sentence a question as a
sentence he sells in the loop they go to
Europe and the other night I was a high
eight at hotel and then I went to have a
beer so I go have a beer and I see that
table and this guy comes like like a
Viking like two by two okay two meters
by 2 meters
and he comes and says are you having
dinner but it's like final it was it was
almost as if I heard you're having
dinner and I was like well I didn't plan
to eat again but like there's nothing I
can say sourdough salad what can you do
so I presume that guy was actually a
bouncer at the restaurant because he
liked to solid then to muscular to be
just just you know the server so maybe
they were shorthand and they said you
know treat way why don't you come help
here because the short-handed with the
with the waiters and he was like ah sure
tips are good I don't know why people
always giving these great tips for some
reason I don't understand so anyhow I
love no way and I also like one more
thing I'm going to take one 30 seconds
for for this because I think it's
wonderful
I like that if I can pronounce it
properly egalitarian ISM in Norway was
it what was it understandable all right
I like it like the other night I was
looking at I was watching TV like just
flipping channels not understanding
anything like okay so that long so I
found like documentary from the prisons
in Norway so they show like the into
prison cell which we're like you know
awfully good
and it was like an eerie and it was like
oh this is deja vu all over again that
I've seen this somewhere so I'm looking
at the prison settings like this is
familiar where'd I see this and then I
look around me so oh it's the same
furniture in this hotel room here same
thing I was amazed but anyhow well you
guys are great but I gotta say you
destroyed troy hunt this morning like a
keynote I forgot hillarious and
everyone's like yeah well I got that
next one it's way fun nice joke where he
had like one after another was chuckling
a couple of times I couldn't contain
myself
there was looking like what's with this
asshat here like I was wrong with this
guy I see fire in the library and I was
supposed to like you know keep shot kid
chaton so in the ends like okay so Troy
has like this great talk hilarious talk
and I was like white why isn't everybody
laughing in here like this on golf tap
okay yeah we appreciate your irritants
and I talked to that guy he says when I
say oh this was brutal and he's odd this
is expected I've been in Norway before
so so alright forget all about all that
we're going to talk about efficiency
today now have like a great task on my
hands right now have a great task on my
hands is a huge pressure here's my
here's the here here's the pride here's
what we're going to do tonight
last thought last talk of the thing I
hope you're not gonna be late five
minutes because he had you know I I had
to tell all the stuff right about Norway
right I'm going to be late a bit I have
many slides I have much to share with
you new content and my hope is that by
the end by the end of the stock all of
us are going to have sort of a mini
imaginary hat if you wish which is our
efficiency hat which is whenever we wear
it we're going to be able to look at
things in a slightly different way just
slightly different which is going to
allow us to find and improve those
points in our programs that are less
efficient that they might be and you're
going to are you're going to see tonight
how we're looking at a few absolutely
all classic algorithms literally from
fifty years ago and we're going to
improve them together in ways that
nobody knew how to for fifty years I am
not kidding
first I'm going to talk about sentinels
who can tell us what a sentinel is who's
got a Viking blood in them come on
what's a sentinel yes please
it's a special value that you plant
ahead of an operation to make sure that
you can arrange computation in a more
efficient way thank you so awesome right
so we have this sentiment notion and
that's great because it there's a joke
which my hope most of you don't know yet
there's the thing with our how does a
program find an elephant elephant in
Africa does anyone know great so this is
new to you this one guy well you can
just you know phase out for you know to
know for a second here so the joke was
is you you put an elephant in Cairo and
you start from South Africa and you go
up north and if you find an elephant
you're good you look at are you in Cairo
or not if you're in Cairo then you
didn't find any because you found yours
is what I'm saying
same about find right let's look at the
find routine that's very simple and I'm
going to use the D language for examples
here because it fits on this on the
slides that's how I define a generic
function in the D language you just
press put the type arguments first and
then the regular function arguments and
I'm going to use indexed access just
because it's easy I'm going to just talk
a bit about about it later so we're
going to have a loop as easy as P as pi
so I have four I equals zero all the way
to the length of the range which is kind
of a sort of an array you can think of a
portion or of an array or a pair of
iterators if you wish I'm incrementing
this good guy and if I found the element
I'm going to break out of the loop and
not what I'm going to return is the
range from that particular position all
the way $2 which is a symbol for the end
of the range so if I have an array with
numbers in it I'm going to look for it
and I'm going to return the portion of
the array positioned at that particular
number that I found what if I don't find
the number what do I return talk to me I
don't find the thing when does the loop
break when I cross length and here I'm
going to return our
on length all the way to length which is
the empty range the sliver of them the
range just at the end of the range which
is an empty is nothing right just like
in the STL remember you return end when
you're done searching and found nothing
you return and in this case you're
returning the empty range this function
has been implanted millions of times in
millions of languages everybody knows
knows it inside and out
so today we are going to make it faster
how do we make it faster obviously by
doing sentinels I presume right so how
do war ideas talk to me yes sorry oh
yeah
so saved us going a variable yes
actually turns out that the compiler is
very good at doing that already so in
good shape thank you that's a good start
it's a good it's the right hat other
ideas
sentinels ha right how about I taking
I put it at the very back of the range
last element instead of the last element
there and then I run the search what do
I save Hubert yeah so I gotta save that
what do i what computation do I save
awesome thank you yup this is right I
find I find my elephant at ndn I'm gonna
look at mine Cairo is easy my elephant
which probably painted pink you know
whatever sigh Marty in some way yeah
it's a good point it's a good point but
here let me let me do the talking of the
microphone
all right so I saved this work and this
is important to save even though I add
some more stuff here and here because
it's my core loop this word it's going
to be like disproportionately much
executed right awesome so let's do that
I'm going to save as hubert said i'm
going to save the last amount of the
range in a temporary c and I'm going to
push e I'm going to just put in in its
place there and then I'm going to do the
loop where does this whole scope exit
thing which means whenever the scope is
exit is finished here I'm going to put
the element back just to restore the
previous state of affairs and then this
is my savings this is the code look this
is what the action is this is where it's
at right this is where it happens so I
have nothing here so I'm going in to
save time and here do that whole cleanup
that we're talking about I was I adjust
the elephantine Cairo is my elephant is
it pink etc so this is my extra word
that I'm doing but I don't care because
it's ideally once right so this is the
fix up so that the pollute does the core
there's a fix up and I'm done terrific
now a few details I do this whole scope
exit saying what if something throws an
exception so I just want to breathe the
prisoner range what if the range doesn't
support random access what I do this
doesn't apply right it's not this that
is not going to apply any more if the
range is not does not support yes I
gotta fall back to a conservative
version which doesn't all of these
tricks so there's a number of things I'm
not going to focus on but if you do want
to focus on those ever talk which you
just search for a CC 2016 and my
unpronounceable and unrightable last
name and you're going to find that talk
and it discusses these things in more
depth I eliminated that part because I
want to share new material with you
that's not online is essentially is not
isn't is never to be fun it's nowhere to
be found
okay great
so it doesn't fall ties but I'm going to
focus consider like things like integers
and sort of the basic the the civilized
types right very nice alright question
does it work or not what they think how
much improvement are going to get I hope
he gives like one percent give it one
percent who gives one percent or more oh
okay whoo-hoo-hoo things going to be
negative negative performance depends on
on a number of things such as the range
size because then I do a right even if
the range has like five elements a right
is going to be a disaster right okay
let's say we kind of focus on the longer
side of the like you know one hundred
thousands millions of elements because
that's where it's at right so does this
help or not who gives you like positive
performance more than zero for large
long ranges thank you yes
great who gives it five percent a few
hands ten percent Anthony's like I can't
believe this happening alright so um
actually turns out it's pretty good it's
pretty good though we have time in
milliseconds here and we have like
millions of elements here we're talking
floating-point search in a floating
point array and just to make it clear
for you I plotted the speed up in
percentage compared to the baseline
which is the conservative that simple
fine thank us what we get like awesome
speed up there between like 20 and 60
percent do you need you know I could
roll with that that looks you know it
sounds I could I couldn't do to live
with yes great excellent
you would think however so so far I
bored you because you knew all this
stuff or worse if you didn't know it you
didn't know it because it's not
fashionable it was I'm not kidding it
was fashion with the 70s cause like all
those sentinels you know they will
protect in a Cove ferrite put assenting
out there like you know scribble it by
hand with other my for whatever
that that's my Sentinel right there you
can literally hold it in your hand right
to the center and it was very popular
technique and then it fell out of use
it's still very good actually turns out
you just have to do the proper
specialization in introspection such
that you apply it when only when it's
applicable for example about this coat
again
how about multiple threads execute this
code you don't that's a bad idea I mean
that leaf can just talk your ear off
about that right it's not what you want
it's not look at yeah it's not what you
want definitely not so there's a number
of situations in which this doesn't
apply but you should apply it whenever
applicable so you know but this is like
old things let's talk about new things
how about 20 horse partition partition
the workhorse of quicksort who can
define what partition does partitioning
like an array partition I give you an
array I give you a number partitioning
for me what does he do huh split into
puzzle what's what are the properties of
those parts somebody else yes please
awesome so choose a pivot and then put
the little things on the left and the
greater things on the right and that's
your partition
it's used by quick sort and quicksort is
like very important function right it's
also used by median and element which is
also very important in a bunch of
algorithms right so okay so this is nice
to optimize partition right that's all
I'm saying
so let's look at the baseline partition
that is already highly optimized
I'm using a label break here by the way
like in Java so I put a label you put a
label here put a label break here I just
want to do like zero redundant
computation that's why I need this
otherwise I would need to use a go-to
and believe me I never use go-to except
when I do I never use it
except when I do because when I do it's
awesome right so I did like only for a
reason but I never do I never use it
never in my life except when I do right
so uhm because of this labeled loop here
I can go like this well here's how it
works I have low and high so I have two
variables I got a mirror this for you
Sam I'm doing some awesome brain thing
in real time like this is left this is
right all right you see I'm an average
Norwegian I have the IQ right okay so um
I go from the left I girlfriend and then
I find something that doesn't fit that
doesn't you know it's good to great
it's a greater than the pivot and I come
from the right until I find saying that
less than the pivot what do i do then
it's not on the slide it's not on the
slide talk to me swap them whoop put
them in place and then what I do go on
but what I do then swap again and then
what I do and then they meet and run
done this is your partition function
it's I mean you think of this it was
1956 when it was even invented at that
time it was a
just like one of the first algorithms
ever you know it was amazing that it
like 24 like genius and let me tell you
this he also invented quicksort it took
five years to four people to get a
correct implementation of quicksort that
bugs for five years in it I'm not
kidding so it was very hard back back
then it's not like a you know I find out
to this hopefully all right I hope I
have no bugs here so this is the look
that goes from from the low portion up
until I find this guy right this is my
pivot because I put it here swapping
swapping into the first position just to
put it on the left so this is my part I
found the left bound and then I'm
continuing with going from the right
with with the other bound with a high
bond and I stop if I have the pivot
greater than or equal than than the
element the current element and I found
the right bond and then I swapping and
making progress and this is my function
at the end I just a little fix up to put
a pivot back where it was and I'm done
and this is my partition function it's a
classic implementation you would find a
variant of it in taste year now there's
a few solid is a body which are
interesting ah here I could use greater
than and with it would still be a
correct algorithm because you know I go
with low until I find something that's
strictly greater than the pivot I can
just go through the equal elements I'm
fine and there's a very subtle problem
with it what is that
who can tell us it's a it's an extremely
interesting problem and similarly I
could use greater than here instead of
greater than or equal which means I go
through the equal amounts I skip the
equal elements I leave them in place
what is the problem there
ah genius if all elements are the same
or you have a lot of elements that are
the same what's going to happen somebody
else somebody else another student here
now it's interview question well what
happens let's say everything is equal
what's going to happen then well what I
have here is this Lo is going to go all
the way up like I start from the left
and everything is the same so everything
just goes through and I say oh so my
partition partition the array in a
completely useless way all the way on
the right whereas I want partition to
have some fairness in it all right if
they're all equal I want some in the
middle because that's the nice thing why
is it a nice thing because when you
quicksort if partition goes all the way
then what do you get
quadratic performance awful so partition
must be fair meaning whenever have equal
elements they must kind of you know they
must be fairly distributed or along the
two halves of the of the array are
interesting it turns out that people who
have these bugs and it was like all it
is they're like awfully difficult to
diagnose because this is going to pass
all unit tests unit test is not going to
help this agile is not going to help
this scrum is not going to help this so
young crying it's not going to be helped
by those techniques so you gotta kind of
really it's difficult anywho let's make
it faster thoughts ideas I'll give you a
hint let's use assent enough how do we
use a sentinel in this case it's a bit
more complicated it's a bit more
complicated so consider this the first
line that puts the pivot in the first
position in the array or the front of
the array I have the pivot already so I
know that the P the first element is
kind of less than or equal to the pivot
and also greater than or equal to the
pivot which is good information but on
the other side I don't have a I don't
have a sentinel so I have one on the
left side but I don't have one on the
right side what I do now put one on the
right we save that and do what you did
with find so we could do this
I did it it doesn't save anything it
just doesn't add up it doesn't add up
it's the savings like 0.5% it's like
nothing the function is more complicated
for no good reason so now I thought
about how to minimize work here because
this is what we're looking at we know we
don't have an agenda to plan sentinels
in places right we have an agenda
dropped in my software and this is all
this is what we want to do this is what
we're up for right so we look at
minimizing work here so I want to
consider this for example let's let's
tell me what's overhead and what's
legitimate work for example or is this
work no its overhead I'm comparing
limits that I have nothing to do with
the algorithm it's not work is this work
yes
I'm comparing element against the people
I must do this there's no way to not do
this I must look at the elements and
compare them against the pivot this is
like whatever eliminate this has to stay
if I don't do this I'm not looking at
all the array and I'm not doing the
right thing with all elements so this is
work this is overhead I'm incrementing
things I'm doing these things these are
overhead this is work and the comparing
the comparison between low and high is
overhead so you know I have a lot of
overhead mixed in with the legitimate
work so we want to reduce these
overheads these comparisons and these in
these indices and this this is also
overhead but I don't care it's just at
the end is not in a loop so who gives a
damn right great
so let's reduce work and here's an idea
you'll no idea how about we plant a
sentinel in the middle and instead of
going like a subway all the way to one
and all the way to one and we kind of
put a center in the middle and we're
going with meat in the middle and it's
it just stops there you can't because
you don't know what the middle is you
don't know where you're going to end up
what those guys are going to meet up you
don't know so we can't do that
so I thought about that for an hour so
that's crazy right well every time I'm
telling you here and I'm saying it was
easy it's like you know sleepless nights
friends you know it's like you do the
same right I mean come on this is group
therapy right let's be honest okay so we
can't plant on Center in the middle so
we need to put one at each end
now here's a key idea let's put Center
us at both ends indeed and we're going
to create a vacancy who knows what the
vacancy is vacancy not at the hotel what
is a vacancy in nuclear physics vacancy
Anthony it's a missing electron in a
crystal and what happens if you have a
vacancy in a crystal attraction said
that's some you know 16 as the right
some attraction going on so if whatever
there's a whole another electron is
going to be prone to fill that hole that
vacancy because an imperfection is
they're going to by attraction they're
going to just want to migrate there
what's going to happen what that
electron is going to get into the
vacancy another vacancy so you know it's
kind of essentially moving the vacancies
around and essentially physically what
happens is that vacancy starts to behave
like an electron with a positive charge
like the positron except it doesn't
explode when it you know so it's like a
positron it's a vacancy it moves the
other way so electrons move this way and
the vacancies are moving the other way
and guess what this is all
semiconductors work like there's a bunch
of vacancies floating around this laptop
right now I'm not kidding all right so
we have this vacancy idea so here's how
we apply this idea we created of an
imperfection in the array 7:11 umbers
and we put a cent in us and then we
create a vacancy hole in the array we
extract we kind of say ah this is kind
of an empty position in the array and
then what do we do once let's say a
vacancy on the far right here
what's the first thing I want to do fill
it with what appropriately but you can't
go wrong with that right
how do what do so we come from the left
and we're looking for a big element
something bigger than the pivot once we
find it we fill the vacancy what happens
next what's the next phenomenon that
happens I have a new vacancy here on the
left now Oh what do I do now genius so I
come from the right and I got to fill
the vacancy whenever I find something
little I put it in the vacancy here and
now have a new vacancy here and this way
I'm moving the vacancies I'm moving the
vacancy for how long when what's going
to happen like in the limit I end up
somewhere in the middle like at the you
know the right partitioning point and
then what I do so out of a so they meet
the vacancies right there at the
partitioning point everything is greater
everything is less here and I put a
pivot back and I'm done so I gotta save
the pivot you know etc so this is all
like a simple matter of programming once
you get the idea it's going to be like
three slides yeah three slides it's a
long function I'm not expecting it to
understand every come of it right it's
ask applications so this will be the
prelude I'm going to put the range I put
a pivot in the first position right well
I have special case here I'm going to
save the pivot save it because right now
at the left most point of the range so
I'm going to save the pivot I put it
there and now I plant the pivot in the
end as a sentinel so i'm going to save
the old position of the last position
this like length - once is the last
element in the range the last element of
the array this is my last element I'm
going to save it and then I'm going to
BAM slap the pivot onto it and that's my
hole that's how I start with the vacancy
on that far right and then it's all as I
said the matter of programming and it
turns out I get to save
a bunch of work I get to save a bunch of
work and I need to test all you want for
two of these long iterations I save a
bunch of work which is pretty awesome
and you know let me kind of give you one
more detail which I find I find is
interesting here all of this vacancy
filling and stuff you can think of as a
half swap because people usually think
in terms of comparing and swapping
things when they think of sorting
partitioning etc actually the whole
Vegas e-business is half a swap and
that's great because it's more
economical what's better to do like the
temp and you know that to the little
three steps or just the half a swap and
yet I have from the other form another
point awesome I'm seeing some nods here
that reveal that you know I'm a I'm a
get slowly slowly to the average
Norwegian IQ there which is awesome
thank you that left so getting there
right so the word has become a matter of
moving the vacancy around and Indian
we're going to fill it back this is my
core it's become a lot cheaper it's
become a lot cheaper and it does a lot
more work a lot less a lot less overhead
this is this is overhead this is work
this is work this is overhead this is
work this is overhead and this is work
it's like almost 50/50 and somewhat very
just can't escape right awesome in the
end it turns outside kind of analyze the
thing run through it and in the end is a
bunch of fix up you need to do but this
is how it works each unit tested what
can go wrong right so there's a number
of cases you need to fix up at the end
because you've kind of been running real
crazy with these these indices here just
kind of low lowest high plus two and etc
so there's a large fix up root part here
I don't care it's done once all right so
we're done with this let's see how good
it works how well it works so time
milliseconds oh that's pretty cool we
look at some somewhere between like
three five percent all the way to like
25 percent and guess what this is a
function that has not been improved in
50 years
it's a big it's a big deal and moreover
this savings is going to transport into
sort because sort all sort does is
partition the everything else is just
Smoak and Meers both of the workhorse is
partitioning right so with this it means
like I get to improve sort significantly
and that's awesome and its new and I
hope it convinces you that you know you
I got a look at these sentinels things
right alright so I thought I smart I
thought I'm above the average Norwegian
IQ I'm not I am NOT because I did some
researching of the topic I thought I'm
awesome and but actually a who's awesome
there's like three other people
two Indians and one Russian so from this
paper from 2011 by up Hutton are in
England and which is like it's very
funny because it's one of the few papers
I read which is a research paper and has
the type of research paper
I'm not kidding so it's a paper and
titled research paper which I love
because it's it's obvious what it is
right you can't go wrong with that so
it's a research paper and title research
paper with a subtitle engineering
quicksort partitioning algorithm by
these guys and they have the same
vacancy they describe the same vacancy
idea I think it's a bit inferior because
you can't choose any people you want so
it's just a bit more limited than our
version now but this like this is a core
idea also Stepanov has recently has a
nice PDF on his site if you just look if
you just Google for steppin off
partition you're going to find a nice
PDF which discusses both sentinels and
vacancies he calls them holes and the
massing is discussed until s1 chapter
discusses vacancy the next chapter and
the end there's an exercise please
combine both right so essentially I
implemented the exercise if you wish but
it's awesome that this what's
interesting is not that this work exists
is that it's recent
it's not 1975 right it's recent work
like 2011 and stop on road that's like
what it was like mm like this is recent
work and it's interesting because with
the with the right with the right
attitude if you wish with the right way
outlook on things you're going to find
opportunity to optimize things you you
may think I'm Cho peeking I'm not sure
peeking there's a bunch of work you can
apply sentinels to dot product of sparse
vectors also application set
intersection same patterns you want to
merge sorted lists you know the merge
function right
merge sort can put a Center at the end
Lexia parsing and put an ascending at
the end you parcel your legs a lot
faster so um a very very great many so
we have I guarantee like 40 past also
match I can spend a minute here to talk
about these that product response
vectors you have sparse vectors which
are indexing value and that's sort of by
index and you go whenever I find equally
indexes I add it to the sum right how do
I apply the sentinel here so that
product I'm its pulse back these vectors
most things are 0 in a sparse vector so
you only store the non zeros together
with the index so have a sparse vector
which has like element like 3.2 at
position 42 and it has like 0.1 at
position 100 and so on right so this is
my first parts vector I have another
sparse vector which has the same
structure and whenever you multiply
these guys you need to find the same
indices and multiply those guys together
and add them up that's what they finish
the scalar product right so how do you
apply a sentinel to that to that layout
yes
stick and stick something at the very
end it turns out the subtleties for
example I don't know so you know we've
been talking about this on a forum and
essentially sort of one of the best
approaches is to put like the size team
acts like the larger size T at the very
end of the largest thing there and then
when you kind of when you go through
with it you just have to do one test out
of three instead of doing the on each
branch so the solid is tree but it can
be done
same deal about set intersection emerges
or lists lexing and parsing how does
that work
let's see how like lexing of large file
like a C++ file after pre-processing I
may add you know hello well how big it
is thirty six thousand lines 80
megabytes it's amazing
so make the compile can go through with
it like it's a miracle of technology can
do it in two seconds right so you
pre-process hello world I'm not kidding
you pre process data actually I have it
you know what I'm going to show you no
kidding here all right
is this an even visible oh by the way
I'm building my size with latte and what
you saw the graphics and everything the
plots they were generated this morning
in real time it's part of my built so
the slides are built running the
benchmarks so that we don't want to do
make dash J because going to run to
benchmarks at the same time is going to
get it's going to be messed up right
anyhow what was I was I proving hero
hello world way hello hello Dottie I
don't know work out 37,000 lines and 538
thousand lines if you round up and I
don't let's see the characters okay
that's like 1.2 megabytes and that's a
little world so that's like
so this is it this is a program I'm
telling you the sheer fact that
HelloWorld compels
get into an object file gets linked with
the linker and libraries and stuff and
nobody knows how a linker works right
the sheer fact that it goes through with
it it's a miracle of Technology if I
want to explain this to a guy who didn't
know computing they would say I'm um I'm
kidding there is AG this can be write
this like what's next e to the power of
1 minus I pi is minus 1 or what who one
or what what's wrong with you right all
right how do you apply this to lexing
and parsing this large HelloWorld
program so here's the human idea let's
say I read a file in memory and I plop a
zero at the end which is an invalid
token an invalid character in any C++
file right and then any Lexi is going to
have a huge big switch statement with
like depending on the current character
you're going to do different state
things right what do what I save there
what am i saving by means of planting a
zero in a big switch state statement huh
you say one comparison per character
because otherwise you have a switch and
you have at the top of the switch would
have while I'm not at the end of the
file right so you have a big-ass if
inside and inside of it a big-ass switch
and inside the switch you have a nice
table and everything all the compiler
knows how to optimize that but outside
that you have 1/8 per character which is
crazy so triple the speed of things if
you just put the zero in the plant you
put as your as the case inside the
switch because then the cost of testing
for that case is divided by the size of
that big table right this is awesome so
sentiments are very much usable outside
the sort of the obvious fine I'm going
to find I'm going to plant an elephant
there etc right so you may still think
I'm cherry-picking here so let me
actually switch gears here and
with this hat on maybe discuss a
different algorithm
who knows about selection the selection
problem who knows about an element in a
steer and element yes please I saw Han
oh you just senior heard of it you know
of it okay somebody else except the
thundering voice Hubert Matthews here an
element in the STL and if I might I give
you an array I give you a number you
give me mark awesome so I given away I
give you half the length of the array
and the element is going to put the
smaller things on the left and the
greater things on the right that's
actually giving me right at the middle
what's the element that would be if the
whole array were sorted to rephrase
given away in the number and find what
Evan would be if the array were fully
sorted you just give you one element and
you know if on the face of it
if each other if you approach it sort of
naively just sort the array and you're
done
just so do you have your answer but
actually there's a cheaper way to do it
right there's a variant of it also like
Mark said you want to place everything
that's more than a of n to the left
everything that's greater to the right
there's a relationship between selection
and the partition we just discussed the
partition I choose the pivot I partition
things but I don't know where exact one
I'm going to end up with selection it's
exactly I want to be in this position
and I want to put everything less and
everything greater applications even the
top ten cells one even a top 100 cells
one finding the median that finally the
median height of the Norwegian male age
46 180 does it
I'm not kidding right so it's computing
the median is very important a bunch of
applications right now so this is also
like much more important applications
such as shortest path and your neighbor
so this is like a lot of computational
geometry algorithms end up doing median
at some point or another
so it's an important algorithm so for
those of you who don't know about quick
select I'm going to introduce it to you
because I think it's a very interesting
and fascinating algorithm who knows what
quicksort quicksort most of us right
who knows what quick select all right
I'm very happy to introduce quick sealer
to you here's what quick select that is
very clever so quick select is what it
does is it does a partition part like
quicksort but you know quicksort every
curses to the left to the left and
recursive to the right right okay quick
select partitions and get some people
position and then it looks out what we
are looking for malloc in foreign index
here or here and then lazily kind of not
lazy cleverly all the requests on one
side either the left or the right so
what as quicksort needs to fully sort
the array quick silat is like ah I don't
care for this half because my index is
not there what I'm looking for so I'm
just going to recurse on one side of the
of the divide of the pivot very
interesting so you request only once
what do you think that complexity of
quick select is complexity of quicksort
is all log n log n right so quick select
which only does half as many recursion C
is going to come up to obviously for
those of you who are expert
mathematicians right linear but like
with quicksort if you choose a bad pivot
systematically you're going to end up
quadratic so in a way you know it's if
that so that the risk is even higher
here because you go all the way from
linear to quadratic in quicksort you go
from L again to quadratic in the worst
case right so with pick select if you
don't have a good pivot you're
completely messed up right so let me
show you how nice and easy quick select
is I just use partition as a primitive
and all I'm doing is i recurse either
here or here I don't even care to
recurse I put a loop around it
I just reduce the range a very simple
fun actually
I'm not kidding this is production
quality
so don't even need to optimize it it
looks as good as it looks it's just
production quality you can't make it
much faster so that's great quick select
awesome so just to explain how it works
what Titian is what we discussed is sort
of choose a pivot it gives you the
partitioning and you use a quick
selection of cleverly uses it repeatedly
to get an exact partition where it wants
to usually during the meet are you
around the medium so once your partition
you're good great
if quick see that gets to eliminate any
fraction of the array then you get
linear time if you get like sometimes if
you get like all the way on the left or
no on the right it's not good
all right and as we discussed the people
quality is a problem here and what what
techniques do you know for choosing a
good pivot for quicksort the same
problem applies ideas for quicksort good
pivot like find out something that's
about in the middle a good people for
quicksort yes
you take the you take the medium between
probably like the left or right in the
middle people do that
right you could you could randomize you
could say I'm going to randomize and
kind of choose some random element or
choose 300 elements computer median and
that's my pivot right so there are a
number of heuristics that people use
what's the problem if you don't
randomize if you don't run it shows like
first last and middle and you compute a
median
yes the generating you get some patterns
in the input that then completely mess
you up which are going to be quadratic
right and actually it's plausible
because it can be machine produced so
actually there's a tax you can imagine
that you know this Garron so not good
what what are the problems if you do
randomized I choose a random pivot yeah
you may end up choosing a bad one anyway
and even though but do you know this
phrasing statistics it's almost never
now I'm not kidding actually you know
what almost never means it's a it's a
scientific term for those of you don't
know this science thing almost never
means the following let's say I throw a
dice right and again and again and again
many times and how likely is it that I
throw a six every time it gets smaller
and smaller and smaller and ad infinitum
it's almost never it's possible by the
laws of physics it's possible it could
happen but it's going to happen almost
never and that's what almost never means
in statistics the probability of you
choosing a pivot above the bad pivot by
random sampling for an infinitely long
array is almost never right but in real
life let me tell you go back to us folks
right back to earth in real life what
happens it's front-loaded the first
three if you choose three bad pivots in
the beginning like Anthony said you're
messed up choose three bad pivots you're
done because it does the largest
so if you have if you are lucky enough
to choose the first three pivots badly
you got to do a lot of work that you
shouldn't and your performance gonna be
like three times worse than otherwise
right so even with random pivots I'm not
cool I'm not cool at all
so that's what people do we discuss this
so in 1961 five sacred masters of
algorithms
Floyd reversed Arjun Blum vfe and Pratt
so five sacred mods like very good
algorithms people they set out to prove
you cannot do selection linear time
guaranteed there's no guarantee can do
selection in real time in a linear time
so you can on average but you can't in
the worst case so they wanted to write a
paper that would prove you can't and
they discover an algorithm that does it
true story so actually they're like ah
so let's prove this can't be possible
possibly doable and they're like oh crap
man it's working it's working I can't
believe it right so this is why what
almost literally happened so they found
an algorithm which is called media of
medians it's a miracle
of like human thinking it's amazing
human ingenuity that went into death
algorithm is one of the most elegant
algorithms I've ever seen
it's godly and it has only one on a
problem we're not going to assist
there's a little problem it's three to
five times slower than anything else
that's fine because on average it's and
in the worst case is linear but it's
just like if you if you want to wait
five times more than usually you're
going to be fine so as a consequence
it's you know books and in no
implementations like everybody reads
about it analyze this is like this is a
good algorithm I'm not going to use it
at all from now on I'm just going to go
with the random selections and stuff so
1961 we have
minutes to break the record I am not
kidding we have ten minutes to break
that record we're going to implement the
rent of this algorithm media of medians
that's going to beat everybody at the
tushy everybody and take names
okay we have ten minutes are with me
these ten minutes like like three folks
in the back just leave and like ah the
hell with this
I'm not kidding we have like what you
know we are like a few more slides and
we're done nine slides right we can do
this so let's start with media of
medians the classic implementation first
of all I have a particular case if the
length is less than five I'm just going
to do it like so it doesn't matter it's
if it's few elements not really every by
hand it's just it's it's a particular
case but if I have more than five
elements is why I compute the median of
medians and the way the media of minions
goes is you don't need to look at the
indices there the way it works is very
simple divide the array in groups of
five elements so imagine I have the
first five next five next five and so on
compute a median for each of those five
elements so now I have a fifth of the
array in those little medians that's why
it's called media minions because I have
like every five group has its own median
and I compute that by hand brute force
all right I have algorithm for five
elements I did by hand right five
elements one medium five balanced 1
million 500 million then I have a fifth
of the array which is the medians of
medians and that i recurse computing the
median of that fifth of the array so I
get on I get the final result a medium
now here's the property of that number
that I get so I can build up medians of
each five groups of groups or group of
fives and then I take that fragment of
the array and I compute each median so I
get the number it's going to be greater
than half of the by definition is going
to be greater than half of those guys
right but for each of those
how many other elements are smaller than
it each of those which or each of those
like fifths right has two other guys
that are smaller than it right are with
me so for I computer medium of that does
like that fraction of the array and for
each of those guys have two others that
are smaller than it by symmetry I also
have two that are greater
so this media here is guaranteed is
guaranteed to be between three fifths
and three times and seven tenths of the
real medium it's not going to be at the
end of the array it's going to be within
a fraction of the real median remember
when I told you a while ago that if I
get to eliminate a finite fraction of
the array at each step I have linear
speed if I get to admit and I get to it
at least three tenths of the array by
this computation and that's how the
proof goes you compute a medium five by
hand
you compete a median of those medians
and then you're guaranteed to be greater
than three times smaller than three
times and you eliminate those guys one
of them at least right and that's what
this guy does
m5 this is going to be a brute-force
function it just does it takes like five
elements five sorry five indices takes a
range than five indices a through e I
just you know I'm not kidding I didn't
write this I wrote on a forum and a guy
did it for me like he I don't know his
name because there's a pseudonym like TN
so there's a thread I'm giving credit in
the paper but essentially goes like the
site I wrote guys how do i compute
middle five with minimum swaps mean
comparisons and they're like ten folks
who like think that they're from Mars
they think a different way than me
because I can't do this other people
know how to I have no idea and actually
there's a guy who generated the who
wrote a program that generated these
functions so yeah okay so how many swaps
and how many comparisons do you want
right I'm not kidding so there's one
with no swaps and other comparisons and
there's one with a bunch of sorts and
fewer comparisons so there's the
spectrum there right amazing anyhow this
works for five elements I only tested it
and guess what I can only test it for
everything because how many permutations
of five are there factorial was the
factory should compute it on my friend
you should compute it during compilation
right hundred twenty so you have a
hundred twenty next permutation it's the
unit has writes itself
so this is our brute force media of five
and we use it here as a primitive for
the groups of five very nice now here's
what you do so you take these groups of
five and you put the medians those
medians of five you put in the first
portion of the array that's I'm having
the swap here I'm going to increment J
every time and that's because I want to
reuse a portion of the array instead of
allocating a new array make sense so I
computer a million that I'm putting it
at the front of the array and then the
first fifth of the array is going to be
the medians and I can continue with with
recursion and everything awesome now
let's make this faster together five
minutes so I gave you a background media
of medians convenience of five put on
the front of the array recurse and
you're done and now let's make it faster
let's let's make a breakthrough after 55
years ideas so this is optimized up to
awesome I guarantee the m5 is good so
this guy will look at what can we do
better here huh a sentinel no it's not
going to be a sentinel
because because I know wait I have
everything here this is the section set
the section title here minimize indirect
rights so because I want to minimize
indirect rights what most indirect
rights happening so I do the medium five
which is highly optimized I guaranteed
and then I do the swapper here and then
what I'm going to do is I'm going to
recurse to this fifth of the Orion I'm
going to develop more swapper rules so
that's where the most rights are going
to happen in this swapping here so I'm
going to essentially like make this
these medians I'm going to compute them
and swap them and then swap them again
and it's just useless a lot of overhead
so here's a key idea the key idea you've
heard of this guy rob banks a journalist
asking why do you rob banks because
that's what the money is you sound
unconvinced it's like my better one of
rob a convenience store because that's
you have they have $15.50 right how
about this my casa are faster because I
have more horsepower Ferrari what should
you say to get more speed do let's work
this is your hat this is your attitude
this your outlook this is how you think
in terms of doing less work there are a
few cases in which more work is more
speed
can someone there's one case I know of
honest one case speculation speculative
execution is more work and you may
actually throw it away but on average is
going to be more speed I don't have any
other case in general there's only so
much you know work you can do in a
finite amount of time and you want to do
less work otherwise you're gonna have
less speed let's do less work here's my
idea number one we have three ideas to
discuss idea number one better layout we
use this first fifth of the array we put
a medians you don't even need to kind of
understand every detail of the algorithm
but essentially there's a lot of
moving data around right during this
computation of the medians of five so
insides it's kind of firm this is the
point we want to put what do you want to
do in partition put the little things on
the left and put the bigger things on
the right so how about this
remember our m5 routine the brute force
what parameters did it take fire the
array the range and five indices so it
actually can is able to swap elements
wherever they sit in the array so how
about this instead of choosing like the
first five elements and the next five
elements on the next five we're going to
choose like this first two elements
middle two elements last two elements we
compute a median sorry middle element
and last two elements so we have two on
the far left one in the middle between
the far right that's my first group of
five was my next group of five the next
two elements right the next guy in the
middle there and the next two on the
right and I'm doing this meteor of five
which is going to statistically cleverly
swap things such that the little things
on the Left statistically the median ish
things are in the middle and the great
great tier things on the right
yeah it doesn't rhyme sorry so
statistically I'm choosing my indices
I'm choosing my decomposition cleverly
instead of choosing the first five like
an idiot the next five like an idiot
Linux five like an idiot and she's like
a small guy the average IQ Norwegian
right I'm choosing that a smart guy I'm
choosing first two elements middle
element last two elements and then the
next two elements next meal element and
so on so I'm going to exploit the fact
that I can compute medians of any five
indices not only consecutive or
contiguous indices so we divide the
right into five big sub arrays computer
median of the first as I said boom boom
boom right so we're going to have with
the same swaps we're going to
statistically divided your way into
some littler things media things greater
things and this is that is going to be
part of computing the m5 it's not it's
going to be sort of I'm helping my next
step with this step minimize work right
that's what the money is minimize work
so after I'm done with this amazingly
the medians of five are already going to
be the middle quintile the middle fifth
of the array so already done with one
fifth of the job we're done we don't
need to move those guys anymore it's
done it's a done deal so the middle of
the array is done in the first step
which was computed a median of five the
medians of five and then we have the
little of things here and the greater
things here and i recurse to one-fifth
of the middle array and then i'm going
to do the fix-up so amazingly i'm going
to swap a lot a lot less element if you
do the math is one tenth of the array
and we're kind of done there which is
amazing so this is the big thing that
took me over that so i thought about
this for weeks on and there's like
there's got to be a way to minimize
those swaps i said the key here is that
you only you need to swap from non
contiguous portions of the array such
that the little things go there the big
things go there and then you're done
that's idea number one so it's more
complicated not by much this is a whole
function is the whole function not by
much saab idea number one boom 50% speed
up not that yet not yet not yet but you
know what a scientist does never give up
right so i gotta rig the competition now
right I'm kidding so now we got to make
it better but we gained fifty percent
and moreover we gained the right insight
because then every other optimization is
going to compound with this one is not
going to compete with it and on top of
this optimization which is layout I'm
going to be able to build more and
here's what I built more did my research
Chen and dimitra's Q Demeter squeezed a
professor at University of Chicago is a
fellow Romanian here as you can tell
from the
four letters the fellow Romanian and
they prove that very nice very nice
conjecture
actually they disprove the conjecture by
saying you know what you don't need
group of five it's okay with groups of
three or four and that's much simpler
it's cheaper to compute so the kind of
they very cleverly have an algorithm
that they call repeated step and then I
said oh so this is exactly what I need a
simpler medium five installing media of
three which is trivial boom that's idea
number two kind of Google right Stack
Overflow by did not post a cover with
you know I look for it and I look for
all the work at the area and this was it
this was what I needed it compounds with
that so I wrote the guys I said guys do
you do this to the oh no we do although
you know it's just the algorithm was not
fast but it's fast because you can pull
your composite with this thing with the
better layout so now I better let and
you have this thing awesome we got to
200% we got to 200% who have - like one
minute but one minute we got to beat
these guys kind of like 3x if we get to
3x we're done he died yeah number three
adaptation so I ran ideas number one and
two and it was great for medium to a
stable for anything but medium if you
want like the top 1000 or the top two
one-third anything has not in the middle
it was bad so I wore turns for a long
time and then I said well you got a
specialized use whenever you're asked
for something that's not straight in the
media the middle the median you use a
symmetric groups two or four or two five
use a symmetry to your advantage if the
index salt is small you search a group
of like 200 out of four and you cannot
get something like that's a bias to the
left if it's great you get bias to the
right so as a guy said on Twitter you
choose a happy case of all algorithms
right so if it's in the median I do what
I just said if it's small I do one of
these tricks
right I just kind of different fractions
of the array and if it's great I choose
the you know lengths - those guys happy
kids of all algorithms we're done
awesome so Google for this fast
deterministic selection you're going to
find a very detailed draft paper on arcs
arc see if I know how to pronounce it
a are XIV not org so I'm going to find
this guy and it beats everybody to pop
everybody like I did like carefully
optimized implementations of all
existing algorithms this guy beats them
to a pulp
the more important graph that you may
want to look at here is the speed-up
compared to the classic heuristics media
free media through randomized nicer and
nicer randomized neither is a sort of a
medium of nine approximate they call it
a nine through its pack is neither it's
a famous heuristic so these are the best
ones in practice meteor three meter
through randomized also tried window
five it's about as good as new your
freezer didn't put it'll not clutter
anything so what we have here is
improvements between like what ten
percent here and like seventy percent
over the best in the world over the best
in the world friends the best in the
world better than the best in the world
we did it we did it
to conclude if you want more speed put a
hat on got a do less work
forget the sentinels the same as army
min to an end
then at the end the end is less work and
we saw how sentinels are part of it but
in the second case it was simply less
whopping kind of just choose your layout
properly such that you minimize the
amount of data movement access the
amount of Rights you do essentially
marshal the computation to
50 most arrange your computation you
know think of everything that influences
your result and make it such that
everything flows toward what you need
what you want with minimum work do
Aikido if you wish in programming you
know I can use your opponent's power all
that stuff right okay don't do it don't
do it like Vikings with that you know
the accident right use Aikido right all
right and most importantly do your
research it was very important for me to
find the algorithms that the Indians and
Stepanov implemented was very important
so I had a good I had good baselines and
I could credit them properly right it's
very important to do research know what
people are doing on in your field right
and in this case if I didn't find a
Chilean Dumitrescu paper I would have
been like blocked because I didn't have
their idea I didn't have their insight
and without that I uh
that's interesting but I'm not there I
can't get the performance so this
treasure everywhere as Calvin ahaab said
you just have to find it
so announcement I'm writing a book about
this kind of stuff it's called fast
where it's a bunch of optimization
techniques such as how to benchmark how
to reduce strength cache Vanilla's in
the right Elysian memorization in the
opposite of memorization which is
obligation hoisting and lowering and a
lot more thanks very much
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>