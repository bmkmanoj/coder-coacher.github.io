<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Awesome Node.js microservices in the cloud for (almost) free - Gojko Adzic | Coder Coacher - Coaching Coders</title><meta content="Awesome Node.js microservices in the cloud for (almost) free - Gojko Adzic - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Awesome Node.js microservices in the cloud for (almost) free - Gojko Adzic</b></h2><h5 class="post__date">2016-09-09</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/mhNIXMV3-ZI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thanks everybody for kind of coming in
it's quite a big room so we're gonna be
having fun
the idea for this talk is to kind of
tell you a bit how I burned my fingers
trying out lots of different things I've
read this article last year that
software developments changed so much
it's no longer kind of anything to do
with science it's mostly development by
poking where people trying to figure out
how stuff works and then suffer until
they make it work
and a lot of it is easily like that and
I've played with something in particular
over the last year quite a lot that's
kind of cloud functions different
providers called him differently Amazon
calls it lambda Microsoft calls it as
your functions and Google has Google
functions and things like that and it's
not the naming I guess is always a bit
problematic but it took a lot of poking
and peeking and things like that until
we made it work and I think we made it
work incredibly well now so that's kind
of what I want to talk about and
hopefully give you some ideas that you
can try out or if you're already trying
those things maybe learn from my
mistakes and I know one of the first
things that I really think is
interesting is that cloud functions kind
of that came on the scene last year are
probably at least for me the most
revolutionary thing that happened since
virtual machines in the cloud I'm
incredibly excited about the whole thing
and it took me about four months to
really kind of realize what happened and
why they saw revolutionary and if you if
you read the docs online it doesn't
sound that great at all it's kind of ok
write a function run it is kind of
pretty much the same thing but I I think
it changes the set of incentives under
which developers work to something truly
revolutionary and that's kind of part of
where we're going with this now a lot of
what I'll be talking about comes from my
experience with the particular product
that I'm building it's a mind mapping
online collaboration tool and we started
building that kind of about four years
ago I'm an early adopter of kind of VMs
in the cloud because that sounded
fantastic and we started using VMs in
the cloud maybe 2007 on kind of some
other stuff and before that kind of you
know in one year one before clouds what
people used to do is if you wanted to
host a service you'd get kind of the
browsers to connect to some machines
that you maintain and some you know
databases that you maintain and things
like that I I started working in
software kind of around the time where
if you solved somebody an accounting up
that gave them the right to harass you
for six months whenever their email
server goes down and for a long time
kind of the most amount of money I made
in an hour was resolving the internet
not working for a client where it was
the proxy server running out of temp
space full of smut and and stuff like
that so I was a reasonably good Linux
admin for a while
I wasn't any kind of Rockstar in
excitement by by far but I knew how to
do admin stuff I knew how to reset Cisco
rooters I knew how to set up databases I
knew how to do a ton of other things and
that's why kind of that happened to me
from day one
pretty much when we started to start to
make money from programming so I never
really understood the whole DevOps
revolution coming later because kind of
that was always a part of job for me but
that's not particularly part of the job
that I enjoy very much and I've realized
that you know I don't want to deal with
those problems I want to deal with some
other problems so when Amazon started
offering VMs
free in kind of year one of Amazon
dominance I kind of realized that pretty
much you know it doesn't matter how good
I or my colleagues get with kind of add
meaning the databases and add meaning
storage and stuff like that Amazon is
gonna be a lot better and the first
thing that we did then is kind of the
whole immortal storage that we had to
maintain that took a lot of power and
knowledge and things like that and when
s3 came along that was like a revelation
for us so the first I think think that
lots of people did with the cloud is
start using files in the cloud kind of
year one of Amazon dominance files now
after while people realized well you
know now we can start putting VMs and
stuff like that there as well why are
people connecting to our servers why do
you have to maintain network connections
reuters and stuff like that and then we
started kind of renting VMs from Amazon
but I I don't know if anybody tried to
rent VMs from Amazon in 2007 yeah one
person there is that there was still
patching operating systems still dealing
with a ton of crap I didn't want to deal
with and kind of overtime the next I
guess bigger of elation for me was that
these VMs I shouldn't really think about
them as normal computers because normal
computing servers we'd put stuff on that
served JavaScript we'd put stuff on
itself CSS with put stuff on that served
the images which put stuff on that
served dynamic content and we're just
sweating these VMs without any reason
and we're maintaining more VMs than we
need what we should really do is start
pulling out some assets and stuff like
that and this is where kind of all those
CDN starts becoming really popular
because we realized the cloud is
starting to change how we structure our
ups now at this point still kind of the
incentives were pretty much the same and
be incentives for this at least for me
were keep the stuff you bought busy
because we needed failover we needed
load balancing and stuff like that we'd
get four VMs
and everything goes in those four VMs
and a ton of code that's not necessarily
related to each other goes into those
four VMs because we paid for those four
VMs we have to keep them busy it made no
sense for every single conversion we
have to do with the files to create a
separate set of VMs you just stupidly
expensive because they're not going to
be doing anything in it all the time now
as we started doing this Amazon was kind
of a bit late to the next stage of the
game this is where kind of Google
slightly started taking over and then as
you start to take in other people
realize that we don't tell me to kind of
maintain VMs and people don't want to
talk about VMs they want to talk about
apps and they want to talk about I want
to run a node.js up in the cloud they
don't care about node.js security I
don't care about port filtering I don't
care about setting up SSL's
I want to run an app or a pH a PHP app
or whatever and then kind of this is
where I kind of got in again into the
into kind of did the cloud thing with
mindmap and for us the app platform was
Heroku Heroku was magical when I saw
that you do git push it does stuff you
scale up scale down it does load
balancing does routing it does a ton of
other things
it was completely magical for me but the
incentives are still the same
you pay Heroku for a VM and our up
converts mind maps into a ton of other
formats PDFs images Word PowerPoint
setting up a separate set of VMs with
failover with routing with for each of
those formats we'll just kind of
quadruple our costs so the incentive is
keep it together which means the
incentive is basically over complicated
stuff so more of it can fail at the same
time plus there was this big thing with
Heroku a couple of years ago where
somebody found that above depending who
you listen to either had a bug or
defrauding their customers for kind of
doing routing incredibly stupidly and
they were doing routine basically if you
have four VMs and three of them are busy
and one of them is free
and a request comes in it's very very
likely that it's gonna hit one of those
three B's idioms and in particular kind
of with the app structure they were
using them for Ruby we were running on
Ruby it was one request at a time
although you can use kind of
multi-threaded vmz stuff like the way
they were routing is one request at a
time so you have four VMs you can
process four requests before that when
you know we had the immortal source
stuff well you know with one machine I
can process probably two 3,000 requests
if I have optimized it well now I can
process for requests for machines it
doesn't sound that good and kind of this
is where we started looking at well now
we have all those kind of apps and we're
still using the cloud storage and things
like that the next big thing for us was
to realize that maybe all those file
uploads and file downloads and stuff I
don't really need to go through our VMs
maybe we're doing it wrong
you know we're blocking those 4 or 5 or
20 VMs with big files coming through
where Heroku is routing it's stupidly
and we started looking for some other
things and we realized well you know
we're using Amazon s3 anyway and we're
thinking about it as storage but maybe
we should be thinking about that more
you know what we're giving people a
direct access to our assets on on the
CDN why not give people direct assets to
files and kind of work with s3 security
this is what I realized well s3 is a lot
more than a stupid storage it gives you
an API it gives you an API that the
browser can connect to directly she
doesn't even need to go through your
storage it doesn't need to go through
your VM she doesn't need to clog up that
and this is where kind of we slowly
started doing something it took me about
2 years to understand what we were
actually doing and we were thinning and
thinning and thinning our up until our
up actually just became a configuration
set our app became something that
configures the initial HTML file and the
initial HTML file gets kind of
configured to access all these endpoints
and the browser is just kind of spinning
all these endpoints and we're paying
Heroku for VMs to basically generate
what
a reasonably static file it changes
maybe every week or so or if we're doing
more frequent deployments it changes
five times a day but still you know it
doesn't change with every request and
then we started kind of moving the index
page to the CDN as well and all the time
I realize that we're kind of we started
thinning up thinning out the mane up so
much it's no longer an up it's no longer
what people connect to what people
started connecting to is a bunch of
static pages and those static pages kind
of serve the stuff and people were then
connecting to some api's in the
background whether it's us or Amazon or
something like that and we kept we
Amazon Heroku mostly to run these api's
now at this point we're still using
haiku it's still kind of the same set of
incentives I run it in a VM and although
we have 20 different file conversions
they're all running the same VM if one
of them gets stuck because of the bug
all of them go down if one of them is
slow if one of them hogs up memory we
need to increase memory on the whole VM
PDFs are stupidly memory hungry if you
do go script so we were running this or
high memory VMs although generating SVG
doesn't really need that much memory and
this is where kind of we were going for
the worst common denominator of the
whole thing because that's how the
incentives work now then lambda came
along and and cloud functions came along
and things like that and we realized
that instead of kind of running these
VMs that the basically shells around
small functions that we need to do what
we started building out is just a bunch
of small API is the turn on Amazon that
are completely separated and we're you
know we can undo SPG with 64 Meg's of
memory we can run PDFs with this and
they started becoming a lot more
independent and they started becoming a
lot smaller they started becoming a lot
easier to maintain and we go to this
point now where when we need to change
something slightly more we don't alter
the code at all we throw it away and we
pretty much write that module from
scratch we got into the point where
modules are so interplay scible and
kind of so small that we can benefit
from learning of writing something six
months ago and rewriting that part from
scratch read the rest of it kind of
stays the same and kind of cloud
functions kind of pushed us in that
direction and they pushed us in the
direction where we are incentivized to
do better things we're incentivized to
create a better architecture and that's
because kind of the way lambda is priced
and the way cloud functions are priced
pushes you to small loosely coupled
things lambda is mostly priced on the
maximum amount of memory you want to use
and the time you run in the processor so
if you have a PDF exporter an SVG
exporter and the PDF exporter requires a
gig of ram the SVG doesn't you're
incentivized financially to kind of run
it is two separate modules because then
you pay a lot less for SVG exports then
you would if it was together and kind of
this is where it really clicked how
revolutionary this is because it's
pushing teams and pushing companies to
create more loosely coupled modules to
create more modular software which is
kind of pretty much last 20 years
everybody's been saying this is a good
idea this is a good idea this is a good
idea but our architecture commercial was
incentivizing people to do something
else where the deployment architecture
is now Lily incentivizing people to kind
of do something that is completely
different now
lambda my experience is mostly with
lambda on Amazon so I don't know how
things at kind of Google or Microsoft
functions but pretty much everybody
copies everybody else and just as a
frame of reference kind of the price for
lambda is something like the first
million requests are free per month and
after that you pay something like $2 per
million requests
and they're also charging you for a
hundred milliseconds in the processor
times the memory you want to use and
kind of this is something like $8 for 1
million times hundred milliseconds at
512 megabytes which is kind of a
reasonably good VM now if you multiply
all that and kind of add it up a fully
utilized VM at 512 megabytes cost
something around 14 or 15 dollars a
month now that's about five times more
expensive than you can get a dedicated
VM but at the same time it's kind of $20
more expensive and at $20 is kind of
it's really not worth even thinking
about the other thing because lambda
puts some things in for free that are
really interesting plus kind of you know
if you don't utilize it you don't pay
for it which is really amazing for kind
of very cheap and stupid experiments so
one thing I started doing the started
doing this kind of incredibly cheap
stupid experiments all the time and
throw them out for example one of the
things we built is this repository
labels generator for github where kind
of you type in the name of the
repository and the kind of the owner and
if the internet works in this country
yes it gives you an SVG that you can
then include so this is about 20 lines
of code that is not particularly smart
and I can run this on my own website and
get run this on my own VMs I can run
this on anything I want but then I pay
people you if people don't use it or if
people use it this way I pay when
somebody actually wants to generate
something plus of put this in front of
clouds front so kind of I don't pay even
for that because I'm cashing these
things another stupid thing I've created
with this is kind of this week in mind
that say visual Explorer for Vicky's
data when I do my presentations I often
try and explore kind of connections
between entities
words languages to make stupid puns and
then kind of I've created this thing
where you can put in pretty much
anything and it goes to wiki data
collect some drops it together
manages that and kind of starts creating
a mind map of the whole thing and then
goes and starts fetching other things
that are related to that
and kind of keeps on doing that and now
I can explore you know but random stuff
when I'm doing presentations now this
requires me to connect to third party
API to expose the web server to kind of
do stuff that is relatively common it
all of it is boilerplate lamda allows me
to do this in about 40 lines of code and
while I'm while I'm actually using it I
pay for that while I'm not using it is
just sitting there and it's kind of
perfectly fine and you know we started
building a ton of stupid things like we
built a support IT support bought for
slack where you can say well why does
Australia not have internet and then it
goes and come on it goes and kind of
comes up with a random excuse I don't
know if you can see this I already say
so your message is very important to us
the problem was caused by the boss's kid
for yeah okay so then you can say why is
the net so slow then it goes and kind of
fetches another thing so you know
elliptic curve seems to be fractal or
whatever so it doesn't matter it's kind
of general it's um so for things like
this where you want to do a very small
experiment you want to see how it works
you wanna kind of install stuff lambda
is absolutely perfect
because it changes the incentives so we
no longer previously you know I was
running my web server I'll probably put
all these three things in the same place
now these are kind of running completely
separately they're all marginalized
they're all running outside now and as I
said the first million requests of free
per month so until you actually kind of
ramp up some serious use eternal any of
these you're good now
there's a couple of things that are
really
evolutionary about the looking at these
things like small functions more api's
compared to VMs because um ups like
Heroku a platform or kind of Roger ups
or kind of Google App Engine and things
like that they were incredibly
interesting because they started
handling a lot of stuff I didn't want to
handle like routing like task dispatch
like restarting like monitoring and
things like that and lambda kind of
pretty much gives you all that for free
so it gives you execution on top where
you don't need to worry about failover
anymore it's there if this thing gets
stuck it's just gonna start another one
if you start being bombarded by a
thousand requests it's going to scale if
you are not using anything it's kind of
quiet and if you scale automatically up
scaled down scale and things like that
because you're paying for the time in
the processor you're not paying for VMs
the other thing that's kind of really
interesting about this is whenever we
were running stuff with VMs we had to
worry about failover you have to have at
least two VMs for everything if one goes
down you have to kind of get to another
one if they're busy you have to kind of
load balanced you have to with this
thing it just kind of magically there
for you and kind of the paying for
actual usage is is quite revolutionary
but the other thing that kind of lambda
gives you out of the box is kind of it
comes with all the batteries included
it's like one of those toys in the shop
where you can press and it immediately
does something useful so it does all the
kinds of stuff like toss dispatch
monitoring control restarting and a ton
of other things that now allow us to
finally just focus on the problems we
want to solve rather than dealing with
all this boilerplate stuff now I used to
joke that lambda is is so easy to eat
you know allows even he children to
create stuff in the cloud and I got
challenged on that so today we're going
to try and kind of probably break the
Guinness record in the youngest person
launching something useful on the clouds
and my son here is gonna kind of try and
create
a London launched it for you so be let's
see if I can get this up okay so the way
kind of lambdas are created with
JavaScript at least you can do it in in
other languages similarly is you need to
define a handler that lump is going to
call you no longer thinking about tops
you no longer thinking about VMS you're
thinking about a discrete piece of code
that needs to run and generally kind of
you define a in node.js at least you
define a handler for a function that is
going to execute and this function
inside lambda has two important
arguments so the first argument is going
to be the event sent to lambda I'll talk
about this later but in case of a web
request this would be all your get post
form parameters and stuff like that in
case of a message queue going out this
would be the message and things let's
say get a trigger you get an event the
second parameter is the context of the
lambda function and the context of the
lambda function is kind of giving you
access to how much time you have left
and where the function is running what
the privileges are who's the user
calling the function and things like
that but it also has a couple of kind of
useful methods you need to know succeed
is one of them and succeed basically
terminates the lambda and you tell the
lambda well you know this is my result
so pretty much at this point you know
you can tell it to run whatever you want
and it will kind of return the result
back and the the succeed method is
important because kind of a lambda
assumes that your function is going to
be asynchronous and you're going to be
talking to some other stuff and so at
the end you can succeed with the latest
version of lambda there's also kind of a
notified callback and things like that
so
this point this is pretty much all
somebody needs to do to create a lambda
function and now we're going to deploy
to the cloud so can you please save this
and one of the things that's really
interesting with kind of lambda is
they've made the programming model
incredibly simple they've made the
configuration model stupidly complex
incredibly stupidly complex so it takes
about a hundred and twenty lines of
shell script to deploy that thing into
the cloud and Milan is not going to type
a hundred and twenty lines of shell
script we're going to use a tool that
kind of does all this for us so this is
actually kind of a small tool that I'm
contributing to and it kind of automates
all the boilerplate required to get to
node.js function running the cloud so
what we're going to do is we're going to
tell it to run in a particular region
and when it runs in a region kind of
lambda created lambda support for Sydney
went live I think last month so we're
going to try that now not to have to use
kind of the pipes going out of Australia
and in order to deploy a lambda function
to the cloud what you do is kind of you
provide a region and we're going to say
the region is I think a PE Southeast to
is Sydney so and kind of the other thing
that you need to give I this tool to
deploy is the main function you want it
to run and then it's going to kind of
zip up the nodejs thing and it's going
to package all the dependencies going to
validate that you have a right package
Orion could create all the privileges
and everything about this to not
Southeast to go back yep
good
southeast - so - number two good
fantastic so the other thing we need to
give it is the name of the handler we're
running and for let's expand this a bit
okay and you need to give it to handler
so handler so that the handler is going
to be kind of the main function we
created we saved it to a PP j s so this
kind of a P P and then they will call
the function handler so that's going to
be a PP dot Handler and now when you
punch enter kind of cloud is going to
start shipping this thing up and
deploying it and kind of pushing it to
AWS so the what this does is kind of it
provisions a kind of VM template it sets
things up and because it's running we
then pair it running with no drea city
of package all the dependencies should
you have dependencies and things like
that and now it's live and it gives us
well you know you have your end your NDC
lambda function and we can now test it
can you try and test it now so we lose a
shortcut to execute this again Amazon
Klee is pretty good for this and it only
takes one command-line to actually kind
of test this and we're going to execute
this without an event because it doesn't
really use any particular events for
this and let's see what's going to
happen yes good so we have a function
running in the cloud now and kind of
it's so easy even a child can create it
that's kind of pretty cool see them so
okay so so kind of DD what's really
really interesting about this now is
what we can do with this thing because
unlike normal functions where you have
to call them with something lambda you
can call pretty much on anything which
means if you're running in Amazon you
can call it when a file gets saved to s3
so remember what I said we gave our
users direct access to files that means
that when somebody creates a file I
don't need to do anything from the
browser to actually call an API to
convert it lambda can kick off
automatically or when something happens
the event log Amazon has this cloud
watch events where you can say well if
this thing happens for more than five
times during the last ten minutes and
the aggregate value of this is this and
this is this relatively complex business
rules you can kick off a lambda or you
can kick off a lambda where there's a
message on a message queue or you can
kick off a lambda where there's a work
flow in through Amazon workflows or you
can kick off a lambda where there's a
record coming in to the database or you
can kick off alarm done anything I
remember kind of you know 15 years ago I
was a relatively decent to Oracle peer
sequel programmer and I was always some
psalmist how in Oracle with triggers you
can do pretty much anything it was all
magical and kind we got Tiggers now on
on the cloud for databases that don't
support triggers because you can set up
lambda plus kind of you can do scheduled
tasks so there's kind of grown in the
cloud that you can make R and stuff and
and we started you know stuff that I'd
normally kind of do with the chronal my
machine to kick things off I no longer
need to do that it's it's there one of
the most interesting things that it also
does is this kind of API gateway API
gateway allows browsers from the web to
kick off a lambda and that starts to
become really really interesting from
the perspective of building out apps and
doing these small api's because if we
are incentivized to kind of keep them
small and modular and independent and we
can set up the browser to kind of call
these things when it needs to call these
things pretty much we can honor lambda
for a button and that button function
can be pretty much independent of all
the other button functions and things
that so the the fact that kind of lambda
can be called by so many different
things is absolutely amazing for me as
that means that you don't have to have
the code that listens to these cues
while migrating from Heroku for mindmap
to we started migrating the entire back
end from Heroku to lambda we deleted
about 50% of the
code is about 50% of the code was oh I'm
going to connect to the sqs I'm gonna
wait on this I'm going to restart the
connection if it breaks I'm gonna kind
of do a lifecycle trick I'm going to
validate a downloaded the entire file
I'm gonna do this I'm gonna do that all
that is gone because lambda gets called
when the file is in s3 that's done or
when the message is on the queue kind of
magically gets done so that's another
kind of really interesting effect of
this is that we started deleting a ton
of this code and you know the less code
I can maintain the better because I'm
not really good at code maintenance so
that's another kind of really
interesting incentive for me so the the
configuring lambda is kind of reasonably
complicated but when you throw API
gateway into the mix that becomes really
really stupid because you start having
to define JSON templates conversion
templates XML template sending things
back sent back and forth and the whole
environment on Amazon is geared towards
executing Java code so it took me a
while to actually figure out that the
main templating thing they use looks
like velocity and it actually is
velocity and you have full access to
kind of all the Java API is underneath
that but it kind of breaks stuff for
Java Script in some many many really
interesting ways so what we started
doing with this is we kind of try to
simplify the whole deployment and I kind
of mentioned this tool that does start
the way JavaScript developers expect out
of the box so we looked at kind of how
how can we make this so simple that
people feel right at home and I think
we've made something that looks like
you're creating a lightweight web server
in JavaScript and it's actually kind of
configuring the whole magic underneath
so we're going to kind of try a like
once more and do live coding on the
stage and I'm gonna get milind to create
a web api now
come on good so we're going to pre
create this as a as a Web API and you're
going to see how easy it is to kind of
call stuff so at this point when you can
call things from from the web so clients
can call it directly and there's kind of
some infrastructure around is to provide
authentication and kind of authorization
and things like that plus we can now
expose other API is very easily kind of
to the whole thing and we can remove all
the infrastructure code around waiting
for tasks dispatching organizing
workflows and things like that we're
left with kind of the meat of the
application that's really just the
business code that we need to run and I
think that's another kind of really
interesting set of incentives that this
thing opens up so when you have this
kind of architectural push to create
small independent modular things that
kind of don't really interact with each
other plus kind of you remove most of
the infrastructure code because amazon
can honestly do it better than you can
and this is kind of really really
amazing and that's why that's why I
think it's kind of a revolution it's
something that pushes people to have a
completely different set of incentives
and it's something that pushes us to
create a completely different
architecture and the thing that we need
to include into this is kind of the the
wiring module so the deployment tool I
showed you I showed you earlier it
doesn't really influence your code in
any way you can kind of deploy any
JavaScript function but if you want to
use the kind of web wiring thing then
there's this dependency that's
relatively minimal and has no other
dependencies so it's only about 50 lines
of code and it only does wiring and you
use it by instantiating a new API there
and pretty much doing stuff as you would
in Express and it's kind of taking care
of all the other things for you so the
it will package up all the gatepost then
and kind of form requests it will do all
the dynamic parameters and everything
and just expose it for you so you can
handle it easily and once we started
kind of moving from all the weird shell
scripts that I used to something as
simple as this that really allowed us to
migrate the backends very very quickly
because we were taking stuff old all the
kind of payments processing all the file
conversions pretty much everything that
we had people doing in all these kind of
Ruby VMs and and and nodejs VMs on
Heroku we've now decoupled into lots and
lots of small functions that are kind of
serving their own purpose and the one of
the most important things at least for
me when we were doing this migration was
to kind of mentally start decoupling
things again because kind of I think you
know we get taught to kind of all
everything needs to be a small object
everything needs to be a small function
everything needs to be a small module
and then you think about one I'm going
to package this up in an application it
has five hundred handlers and has this
session that kind of becomes magical six
months later as these cookies that
nobody understands three months later
and it's all kind of bundled together
where now we can start kind of doing
things much much easier and what's
really interesting again about the whole
thing is if you have a particularly
quest that takes a long time or a
particular thing that needs more memory
or a particular thing that kind of
requires access to some third party
things but you're really scared about
exposing the API because of security you
don't wanna open up everything you can
kind of modular eyes and lock that thing
down everything else can go somewhere
else and kind of the so the API series
is very similar to Express you just do
not get and or dot post dot put up do
you want deny good so the API kind of
you provide the path and then you give
it a handler and the handler is any kind
of JavaScript function
the function will automatically get the
request object with all the post
parameters get parameters the body and
pretty much everything lambda an API
gateway for cur of the JavaScript
version are geared towards executing
application jason so by default you'll
get a JSON object in from the body
you'll get kind of post requests and
that's not like than you're expected to
return a JSON object back if you don't
want to use JSON it's kind of trivial
easy to switch it to plain text HTML
stuff like that for example for the
reprolabels thing i showed you i
actually serve an SVG image i compose an
SVG image in alarm then kind of serve it
back so the in this case kind of from
the handler you just return the results
out if you want to do something a
synchronous you push out to promise and
it will wait for the promise to resolve
and now the AWS sdk also supports
promises since a couple of months ago so
it's kind of really trivial just kind of
going to DynamoDB return the result of
dynamodb and that's it
and this allows you to do kind of
filtering authentication and
transformations and stuff like that so
now when you save this stuff we can now
create a web api you need you need a
column column
so let's try and apply this to the cloud
and in a case of deploying a web api
because it has these roots and stuff
like that instead of defining a single
function to be deployed we provide a
whole module again just the region and
the module and that's it and if there
were any package dependencies in NPM
package JSON and things that everything
would go to the cloud and lambda has
this thing where it limits you to about
one and a half gigs in total for all
your versions because every time you
deploy just creates a new version and
I'll talk about that I think that's also
kind of quite revolutionary because it
pushes people to another really good
pattern but we'll talk about that later
so if you try and bundle too many
dependencies into the same thing then
you get fewer deployments you can do
which is again incentivizing people to
do small modular things don't bundle the
whole internet with your app and that
means you know there's this less risk
for kind of an area of coverage that can
go wrong so and we need to define the
API module as well so the one really
interesting thing about this whole idea
of versions is pretty much every time
you do a deployment it creates a new
numeric version of your app and you can
do labels on those versions so you can
say production is version 46 development
is version 29 testing is version
something it's trivial easy to provision
these things now I remember kind of even
with cloud VMs and stuff like that we do
testing on our machines because it takes
a long time to provision the whole thing
well now it's kind of 20 seconds to
provision something because now this is
configuring a web api it's going to take
slightly longer because it needs to do
lots of lots of weird things as I
mentioned but it's relatively easy to
set up a new version so what we tend to
do is pretty much every developer has
their own version that they're playing
with on the cloud and when we're happy
with that we just promote kind of the
version we like to production rollback
is trivial
simple just reassign an alias and all
your versions are there for kind of
posterity and what's really interesting
about the whole thing then is it pushes
people to do multi version incorrectly
because then it makes you think about
well you know we don't have to upgrade
the whole set of our users immediately
we can give something to people who
really just need this feature and it's
half-baked but these people need it
let's connect them to this version
everybody else connects to this old
version and kind of stuff like that is
really amazing so when this thing runs
it prints out the URL up and you see
that kind of do you start of the URL is
this weird
think that's the idea of the API and now
I can kind of track this in a browser
and we have a result so we have a
function running on the cloud now this
function although kind of it's
relatively minimal and done by a child
has bulletproof load-balancing
bulletproof scaling bulletproof
monitoring bulletproof dispatching
pretty much you know you're benefiting
from all the knowledge that somebody
who's created a massive data center like
Amazon or Google or Microsoft has put in
over the last you know 20 years these
people have patents on cooling servers
that's how far they go now he can
benefit from all of that just by doing
this stuff now as I mentioned you can do
lots of weird things with this and it's
really perfect for small experiments but
where this thing starts becoming Israeli
this kind of combination of the business
and technical impact that's why I think
it's revolutionary so the technical
impact is you get pushed to these
smaller functions you get pushed to
smaller modules everything is pushing
you to create more independent things
you know the whole microservice
phenomenon is really this is pushing us
to create something like that it's
making multi-version trivially simple
and it's forcing people to kind of think
about multi versioning and benefiting
from that multi version is stupidly
difficult to do if you try and do it
manually here you get it for free
and the risk is going down significantly
because kind of you can roll up roll
down it's it's very you can kind of just
rewire these things the other thing that
it's kind of really providing is ops by
magic there's a ton of buzzwords that
already started in this space and one of
the buzz words that kind of people
mention are these two talks at this
conference about that it's got its
serverless and kind of this course
everlasting you know then people say
well it's not without servers it's kind
of you don't have to worry about service
and somebody says well I didn't have to
worry about service when I had VMs and
so Alice but kind of the whole idea of
this is not to think about applications
anymore think about api's and this API
is running somewhere for my mom of two
for example
kind of you know we hit this kind of
service point about six months ago where
browsers are directly uploading files to
s3 lambdas are kicking off to convert
them browsers are checking when I stream
whether the conversions done all the
payments and everything like that the
very small functions that the browser's
collected directly and there's no
central up anymore the central app is a
static HTML file running on CloudFront
it scales much better than Heroku will
ever will the other thing that kind of
is again a buzzword that people mention
about this is kind of this zero ops
thing or no ops as a two kind of DevOps
or whatever I think kind of ops is still
interesting but at it from a different
perspective ops in terms of maintaining
your queues maintaining your database
and stuff like that gun ops in terms of
thinking about what you want to package
how you're a package is how you want to
test it how you want to set up your
deployment pipeline becomes really
interesting by the way I've kind of
researching this thing yesterday I have
learned that you can also trigger a
lambda from the Amazon code deploy
pipeline it's kind of their continuous
deployment pipeline so you can set up a
lambda this kind of packages other
lambdas it's kind of a metal and I guess
or something like that and what one
thing that's kind of really really
interesting from a
business perspective is that it kind of
pushes you to think about paying per
usage so small experiments are really
cheap but when they need to scale up
this kind of ops by magic is going to
provide the scaling so one thing that
kind of is particularly problematic with
this whole thing at least for me because
I'm a fan of automated testing is that
kind of it starts becoming challenging
to actually prove anything locally
because there's so much magic running in
the cloud you can deras that your
functions work locally but connectivity
configuration wiring and things that
becomes an interesting problem that
needs to be solved things that I didn't
really think about one kind of doing
stuff on on dedicated servers of VMs now
become really interesting and one of
them is kind of testability so we have a
bunch of kind of these tests now that
run functions locally I mean the code
that Miller wrote is just a JavaScript
function it doesn't connect to anything
in particular but we also run some
really interesting integration servers
in the cloud now automated and generally
I think testability is going to be a
really interesting problem going forward
now one another really interesting
aspect of kind of this being functions
and not being a UPS is that there's a
couple of limitations to lambda that are
kind of forcing us at least not to be
able to do everything we want the first
thing is that the total time Alondra is
limited to is about five minutes you can
make it lower by default it's about
three seconds which i think is
reasonable if your API doesn't respond
to a web user in three seconds people
are going to think it's not doing
anything but file conversions background
runs and stuff like they might take a
longer time so lambda has this hard
limit of five minutes after which it's
killing of them and you need to kind of
think about packaging tasks in smaller
things it's not necessarily that bad but
what that does is prevents any kind of
stream
clients from this so which is kind of is
good and bad at the same time so instead
of just streaming stuff from lambda eat
you know makes you think about well
maybe we should put this sort of file
storage somewhere and let people stream
is from there or kind of have another
API or have some kind of push it to a
message queue where people are kind of
consuming it from message queues again
from one perspective it's kind of
pushing people to good architectural
patterns from another perspective I
showed you kind of the the support bots
for slack I wanted to bill the same
thing for Twitter and for Twitter
there's no web hook API for Twitter you
have to set up a service that connects
to Twitter and listens to their feed
streams it in that's pretty much
impossible to do with Londoner and
things like that I kind of still left
with running a separate VM connecting to
this but you know that's something that
is interesting to see how it's going to
be solved in the future
the other thing that kind of this whole
ops by magic and scaling by magic and
things like that forces people to do is
pretty much a share nothing architecture
where lambdas you know at any given
point a hundred of your lambdas might be
running concurrently or one
there's no stickiness there's no
sessions there's no that the you know
thinking about stickiness and sessions
gets people think about VMs these are
not I mean physically there are VMs but
you have no access to that and that's
why kind of there are no sessions no
streams to share nothing thing which
again again pushes people to share stuff
through databases share stuff through
queues share stuff through s3 or some
kind of other cloud storage and kind of
lots of people complain about lambda
that you know if you have a fully
utilized VM just kind of renting a VM
from Amazon is five times cheaper which
is true but that's if you think about
this thing as a VM what if that VM
starts getting clogged what if you have
started getting too many requests what
if that VM is not doing anything and
that's where I kind of thinking about
these things as V
he's no longer useful and which is why
kind of I've mentioned over and over I
think this is kind of truly
revolutionary so the to finish this
thing off assert configuration is a
really big problem and it's gonna it
will take more than 40 minutes to just
go through all the screens you need to
do to configure this thing
luckily Amazon has a good command line
interface and other cloud providers do
as well and there's a nice article on
Martin Fowler's website about service
which is not written by him written by
somebody else but it really really nice
article where they talk about how
because of the whole kind of octopus of
connecting to everything everywhere and
scaling the configuration itself needs
to be relatively generic which means it
needs to be hard but if you narrow it
down to a particular use case like
running node.js you don't really need
that much complexity and the very
Vogel's the city of Amazon did a
fantastic talk about six months ago
where he talked about the top ten
lessons they've learned from ten years
of running AWS and one of the lessons
was that the market wants primitive is
from Amazon the market doesn't more
high-level tools because then people
come up with lots of interesting ways of
combining those primitives now what you
see now is Milan demonstrating this tool
called cloudy address which is an
example of that it's an open source tool
that kind of combines those primitives
narrows down the use case and sets
things up the way JavaScript developers
expect out of the box so it will use the
NPM for packaging it will use all the
JavaScript concepts where you know
there's a ton of alternative tools for
Java Python and other things
klaudia does not try to abstract away
AWS I like to use AWS api's directly I
like to connect to history and Dynamo
directly so I know what I'm doing but
there are some relatively interesting
other projects like Severus services
again geared towards JavaScript but it
tries to abstract away the cloud and it
provides a ton of services
and dispatching service location so it's
a framework it's not just a deployment
tool and I think last week they
announced that you can also deploy
several PSAPs to Azure so it's kind of
bridging the gap between AWS and other
things apex is another interesting
project for the JavaScript and ojs space
apex is a deployer like cloud is but
apex does some things differently tries
to kind of be a bit more generic so it
allows you to deploy binaries as well
and and things that so with Apex for
example you can deploy a go language
runtime and do a London go although it's
not supported on Amazon officially or
you can deploy a new node.js runtime so
lambda for a long time used to run on
node 0 10 with Apex you can deploy node
6 and kind of run your mom they node 6
and stuff like that so kind of for me
the choice between these three is if
you're happy using AWS directly and you
want to do pretty much JavaScript setup
out of the box without any configuration
or anything like that claudia is kind of
very simple if you want obstruct away
the cloud if you want to kind of do your
own service locations through this new
framework then you serve Alice and if
you want to go for kind of really
esoteric stuff do a pix and that's
pretty much it the hope of kind of
tickle your imagination at least a bit
we have five minutes left for questions
does this make sense at all did you see
why I'm so excited about functions
rather than VMs and I think this is kind
of truly does anybody have any questions
you'd like to kind of ask while we have
time
yes
yep yep yep yep
so it's eternal you get an event you
don't I mean you can control where the
events are coming from you can
authenticate a stoplight but for the
most part you're completely right you
get an event and you do something about
that that's it I think you'll mention of
strip so there's lots of ways of
notifying the client so for example what
we do with file conversions is we send
the client assigned URL on s3 where the
file is going to be so then the client
kind of polls every five seconds until
the file appears there magically and
again this is kind of trying to push
people into doing things not inside that
function but decoupling Amazon also has
a MQTT service that is this kind of IOT
message queue for devices so you can
send messages to like notifications to
mobile device it also has a JavaScript
client so the browser can connect to the
queue you can push through the queue
from lambda and that's it it's kind of
no I assume it's implemented through
WebSockets I don't really know but at
the same time it doesn't matter how it's
implemented you know as far as lambda is
concerned push the message on to the
queue the client gets it and that's it
so that will be waved so the functions
are kind of trying to push people to use
these highly scalable services that are
provided there so you decouple your
stuff from that does that make sense
so the question was kind of testing is
to be challenging and how we solving the
challenge so I'll give you a short
answer and a slightly longer answer so
the short answer is go to this website
and then there's a tutorials page and
then there's how to design testable
under functions it's a very very long
article detailing how we're doing stuff
a quick answer is we're doing hexagonal
architecture I don't know if people are
aware of hexagonal architecture it's
kind of a design pattern where you're
not allowing your code to talk directly
to external services you're not allowing
external service directly talk to your
code you're putting on a layer in
between so then you can kind of really
nicely test the core part of your system
by providing ports and adapters for kind
of different things including a test API
and then you need to do bulletproof
integration tests around kind of the
layer that's outside so we have a mix of
kind of tests that prove that the code
is working correctly locally in the
cloud and things like and then a lot of
integration tests that kind of prove
that things are connected correctly so
that that's kind of a slightly longer
answer and again that's nothing to do
with London particular just that because
everything is so magical it again pushes
you to kind of use a good architectural
pattern so if if used two domain driven
design domain driven design has similar
concepts as kind of the core domain and
kind of interface domains and
translation layers and kind of the
anti-corruption layers in domain driven
design are kind of related to that so it
forces people to kind of separate out
the communication part of the software
from the kind of processing part of the
software so you can test it
independently good we have another
question over there
so I'm pretty much I refuse if I run the
deployment again or if there's a record
of the deployment here you see that it's
kind of creating a roll first and every
lambda function has a security role it
executes under this thing is kind of by
default creating an empty role that just
allows you to run a lambda but you can
provide policies and say well these
people can call this thing or I can call
this lambda can call other things it's
kind of on on Amazon it's kind of pretty
well done through roles and then you can
assign things to different roles and you
can control who can call the function or
how it can be colder what that function
is actually allowed to do to access
other things on Amazon there's this
federated authentication thing the cold
kognito so you can allow only
authenticated users to do this or run
authenticated or kind of say it's it's
all possible it's just that kind of for
a very simple use case where you want to
do course you want to allow the browser
to connect it you want to do a
background thing this does it
automatically for you out of the box and
then you can configure more complicated
things
here you can make it as broader or as
narrow you as you want and kind of the
deployment tool will also if you can you
can provide security policies to it to
deploy with the API but but by default
it creates because that's kind of that
the most that the standard use case is
to allow the browsers to call your
functions that are clear and then you
authenticate inside it so that's kind of
that's why there was no configuration
here but I could have configured this to
allow only me to call it or only you or
anybody who's authenticated through
Google or even provide a custom
authentication thing to tell who can do
what so it's it's kind of you know like
I mean should Amazon can do UPS way
better than you and I can so they're
kind of thought about that and their
solution is already integrated into the
whole thing the reason why I didn't
that's one of those you know 20 steps
you need to do to deploy this but the
tool does it for you and it does the
kind of simple case first unless you
configure it to do something else so the
question is interfaced issues with
spiders the bots on the API gateway I've
not the API gate where you can limit it
so that only people with a particular
API key can call it and that's reported
pretty much out of the box so for
anything that's more serious that we
need to do we'll put an API key and then
the browser is going to get the API key
with the CDN deployment throttling and
things that are really really well done
so you can tell your lambda to start
throttling at a certain point you care
tell your API gator to start throttling
at a certain point the github label
generator that I showed you it's
actually done so that cloud front is in
between Amazon CDN so the cloud front is
in between the browser and the API
gateway so what the spiders can kind of
take a hit at Amazon's CDN as much as
they want they're not really going to
hit me
so they
the labels are generated on-demand and
regenerated only every kind of 15-20
minutes so the death part is pretty well
done we are we're not my mob who has
about 250 active users per month and
kind of the average session is about
half an hour so it does get kind of
reasonably busy it gets more busy than
you can do with kind of two or three VMs
but it's not Google scale so I don't
know how I don't have an experience kind
of how lambda would behave at Google
scale having said that most of these
api's tend to come from Amazon actually
opening up the stuff that they're using
themselves so I think it's reasonable to
expect that kind of it can deal with
that case pretty well again you know
Amazon can do ops much better than you
can merging secrets so API gateway has
this thing called a stage and you can
assign variables to a stage so stages
like production development testing my V
my machines your machines and that's
pretty good to keep keys in if the API
calls multiple and the functions yes
then they'll get that because the
variables are in the stage there another
thing that you can do that you don't if
you're not deploying through API gateway
is you can put in the key in the event
itself one thing is said again it
changed it takes slight adjustment to
thinking about this so for example we
have as I mentioned the key use case for
us is people upload the file to s3 lamda
kicks off process saves test three now
if you think about configuration there
for a normal VM you'd have to configure
where it reads where it saves access
keys with lambda you get an event and
the event says this thing is a file from
this s3 bucket so there's no
configuration that part you saved back
to the same
kit there's no configuration and you
manage the rolls to allow you to access
internal resources so there's no secrets
so the the third option there is to use
our file that gets deployed with the
lambda and then detect the context where
the lambdas running as their production
tests Laura Jason the fourth option is
to use something called the Amazon key
service that's kind of a hardware
security thingy what we don't use that
so I don't have any kind of experience
with that because my risk model doesn't
really require that but if you're really
thinking about something that's horribly
secret I would keep it in the histories
good well thanks very much I said I hope
of tickle your imagination at least a
bit and you know go and deploy lambdas</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>