<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Continuous Delivery in Azure - Jimmy Bogard | Coder Coacher - Coaching Coders</title><meta content="Continuous Delivery in Azure - Jimmy Bogard - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Continuous Delivery in Azure - Jimmy Bogard</b></h2><h5 class="post__date">2017-09-25</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/lqnUdEwVXOU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">everyone good afternoon evening ish
I think it's nearly pub time isn't it if
it's not already sorry
no one's sorry their me I probably so
hello everyone my name is Jimmy you can
find me at twitter @ @j bogart all the
code and stuff that I'll be showing
today you can find on my github as well
I get up it come /j Bogart and I blog
quite a bit probably not as much as I
used to I guess that's Jimmy Bogart calm
and you can also find a lot of old blog
posts a few hundred of them actually on
my old lo Stuckey site which is Jimmy
Bogart dot Lowe's techies calm some of
you probably use some of my open-source
libraries for which I am deeply sorry
that have the bugs and problems that
I've given you over the years so today I
want to talk some about continuous
delivery and Azure especially looking
past the kind of demo where you
typically see from from Microsoft
presentations they're like the new file
new project and they right-click the
project in Visual Studio and they do
deploy and everyone's clapping in the
audience and then you go to actually do
it back in your company at home you
realize oh crap it's actually a lot
harder than that there's not more things
going on so what I wanted to do is to
walk through some of the options that we
have available for us for building
continues to livery pipelines and Azure
I'm actually going to start with the
very simplest option actually going from
right-click deploy and taking a real
application all the way from that kind
of deployment to like ludicrous speed
and see what we can do with that so
let's look at some of the deployment
options that actually exist in Azure so
the first one that that does exist is
that that right-click deploy out of Asia
so you never use that before like
actually in production shame shame no no
no I actually have used this before
especially with smaller applications or
things I'm just trying to get up and
going and just push out there somewhere
so it is a valid deployment scenario
it's it is that that kind of right click
deploy experience outside of Visual
Studio it works not only with just kind
of Web Apps but there are a lot of
different Azure applications that you
can deploy right out of there uses a
technology called web deploy even though
it can deploy other things but sighs
websites but the name kind of stuck so
that's what it is behind the scenes it
does use PowerShell scripts and
powershell commandlets so there are
options inside of Visual Studio
say show me the actual script behind the
scenes you can see the PowerShell script
that actually runs and does these
deployments but the demos you always see
right our visual studio right-click
deploy
everyone's cheering confetti from the
ceiling all that sort of stuff
the next option that they have available
to yours something called continuous
deployment this is not something that
the Microsoft invented it it's actually
something that's that it existed for
quite a while
the idea behind this is my deployments
my deployments happen directly from some
sort of source control so every time I
push my code up to some source control
then the production deployments happens
straight from whatever that thing is
zoom here you ever use Heroku before
just me a few of us so Heroku
popularized this idea that I just have a
single repository of my source code and
whenever I push my source code up it's
gonna deploy whatever is in there which
works really great if if you never write
code that breaks like myself but the
idea is that if you have simple websites
then they don't have a lot going on but
it's still like an actual application
and you have source control behind it
then this kind of pushed this kind of
deployment works for you and they call
this one continuous deployment Microsoft
softens for this which we'll see can
connect to a lot of different kind of
source control providers but when you
start to have more complex things going
on you can't really have don't have
really a lot of hooks for yourself so it
works really well for really
self-contained applications that have
the entire ecosystem in that application
but once you start getting anything more
complicated than that this tends to fall
down past this we actually have to build
a actual continuous integration and
continuous delivery pipeline so this
wouldn't tell us having some kind of
continuous integration build this
integration build would still be hooked
off a source control but do it compile
our application run both tests that
we've written except for the other one
we caught a minute out because it keeps
failing for some reason and then at the
end of the the the build process out
comes some kind of package that wraps
everything up together into one single
one single thing that can
deployed and then there's something else
so that we'll take that package and push
it out into different environments
whether it's just production environment
or perhaps we have an entire set of
different environments that this gets
pushed out to and the final and this was
a kind of a new one
the kind of holy grail of continuous
delivery pipeline come in this form of
templates in measure this is not also
something new that Microsoft created if
anyone here has ever used a tool called
terraform terraform also has this idea
of describing in some sort of format my
different environments that I have and
as er this comes in the form of as your
resource manager and so these are JSON
templates that describe what my interest
and my infrastructure should look like
and then alongside of that is some
tooling that says make my environment
look exactly like this and so whenever I
run these a source as a resource manager
tools it will change the configuration
of my production environment to match
whatever that document looks like so if
you enjoy working with Jason as your
resource templates are a great tool for
you one of the cool thing about these
templates is they can be they can
introduce a concept of variables so a
lot of times what we do with our
customers is we have a product we may be
building and that product has to be
deployed to individual customers
environments so we can template eyes
some things as part of those templates
or introduce variables as part of them
so that when I get deployed when I try
to deploy those templates to those
individual customers environments we can
swap out things like the connection
string information maybe servers or
different but we have an overall
template of what that environment looks
like minus some customer specific things
so it starts out with something very
simple just like right click publish out
of visual studio and it can get very
complicated as complicated as you want
to all the way to this kind of holy
grail of infrastructure as code where
instead of me having a bunch of settings
hidden in some crazy single page
application and the azure portal we
could have our actual entire production
environment
in it as some configuration file that we
we can even put inside of source control
so what I want to do is take an
application from that very top bubble
there and walk her through the steps of
what it would look like to move it down
all the way down to this kind of Holy
Grail Nirvana at the bottom of using
templates to describe and define what
our entire ecosystem looks like that
sound good that's my last slide except
for this slide which just says demo okay
so let me switch over to a mirror
display so now to keep looking behind me
and we'll give parallels about 30
minutes to figure out the resolution
here oh that was quicker than it usually
goes okay so what I have right now is a
sample application that I've built up
over the years it started out with the
sample application from Microsoft the
contoso University in any framework six
MVC application but this is an
application that's more or less built
away I tend to build applications so it
actually does have it actually just have
tests as part of it as well and they do
run actually and behind the scenes it
actually does have a real database most
the time when I see Microsoft demoing
these kinds of right-click deploy is
just a static website so there's nothing
really else going on but this does have
an actual database behind the scenes and
that will introduce some complications
when it comes to building our
deployments so let me run it you
probably have seen this application
before many times at least I have
probably the past three or four years
this is an asp net core application acp
net core 1.1 because I know 2.0 dropped
yesterday but I'm not crazy gonna
upgrade my my my system and the day I'm
doing a demo I have done that before it
was a very bad idea so this isn't it as
an asp net core application with
targeting the full Donette framework
using in any framework 6 to do its to
data access so it is a fully functioning
application I can go like edit someone's
information I don't know why their name
isn't like that but that's what it is
now and so yes it actually does
actually does work it is actually
connecting to a real database behind the
scenes so the I built this application
myself I'm super proud of it and now I'm
ready to go to production so I've
watched all the Microsoft videos and
what do they say to do they tell me it's
you right click and right click and
publish so let's publish this
application out to our asher
our at least my Azure account here so
I'm going to create and completely new
Microsoft Azure app service this used to
be called as your websites and as your
web applications now this is the fourth
or fifth name for it as your app service
why not and let's hit publish and these
days we actually do have we actually do
have Australia based resource groups and
Australia based
as your data centers so we don't have to
I don't to deploy this 12,000 miles away
or how many kilometers like several
hundred kilometers away I guess I might
go with math alright so I'm going to do
this on my subscription and I'm not
going to go to this whatever this
resource group is here I'm going to
create a new resource group and I'm not
very creative so it's just have the same
name we're gonna see this resource group
come up over and over again so pay
attention to what you're doing those
resource groups because when we start to
do as your resource manager probably got
clued in there the name resource will
come back when we start scripting these
pieces out and the app service plan let
me pick a new one and we'll go as free
as free can be location South Center
central us probably not a good idea for
us here so let me go up to Australia
East sore southeast this is more south
east right is it ok
east what south east Melbourne ok ok
okay so all of these other ones cost
money of which I don't have very much so
let's go all the way top to the free
that one sounds like a good one to do so
do the free size click OK and everything
looks good let's go ahead and hit create
now of course this is going to create
all of those as your pieces behind the
scenes is gonna create the azure
resource which is kind of a named
container for a lot of different Azure
applications and services as your
resources also allow me to provide
security for a specific group of
applications and it's also going to be
creating the actual azure website for us
that's going to deploy out to and all
this configuration that I've just done
here is going to live as part of my
project here while this is going I'll go
ahead and pull that up and if I go look
into the source code of my project I go
to source into the properties folder
we'll see a published profiles folder
here and that's where the configuration
that I just selected all those pieces
will live so if I look inside of here we
can see some XML files so in an
environment where I probably have source
control I probably push those items up
there too it's a source control so they
don't just live on my on my individual
laptop here let me zoom in a little bit
it's time I need a control mouse wheel
up but there's no mouse wheel here so
let's see does this work
nope nope nope none of those works so
let's zoom in a little bit
control non-plus yeah there's no no
monkey on here okay so this is all the
configuration they did for that you
through that user interface along with
some other pieces as you didn't see
through that UI so things like the
resource group name we said it was
contoso University - NDC Sydney so
that's the resource game it has there
it's going to be using the azure website
published provider so I've have other
kinds of things they can publish through
here that would be a different provider
and some other junk would I don't know
what it means
all right so it said it published the
application so it popped open this
Microsoft edge window because I'm
legally obligated to use Microsoft edge
in these conferences I think a part of
my MVP status and at some point we
should see our beautiful website come up
right I used to I should have chose like
maybe not the free tier because I'm
competing with everyone else that's
building all these free applications so
any any who thinks this website is gonna
work aw crap usually usually takes a
long over this okay so it didn't work
why didn't it work
database oh the database so I pushed up
just the code part of the application
but there's an actual database behind
the scenes that this is supposed to be
talking to behind this if I want to see
what database it was trying to talk to I
go over here to see my configuration for
the connection string and it tells me
it's trying to access MS sequel local DB
sequel local database which doesn't
exists in as your websites so this is
just not gonna work so what can I do
there are ways for me to have like
sequel Lite local databases inside of
this application but those are all I
quarry broken and don't really work very
well I'm trying to build a real
enterprise application so I should have
an actual database so that means we have
to go back to our favorites user
interface the user interface they
reinvented the scroll so you thought you
just need to scroll up and down no you
get to scroll left and right now so
let's go ahead and create a database for
ourselves alright so I'm going to add a
new database
for this application and again because
I'm not very creative I'm just gonna
call the same name as everything
everything else and the resource group I
want to be part of that existing
resource group is everything else that
one the select the source a blank
database sample adventureworks
which I don't think anyone ever picks
that option well--we're backup the
backup though has to also exist in Azure
so that's not gonna work for me this is
a totally new database so I'll pick
blank database and the server I have to
actually configure a server as well
this database has to execute somewhere
so I'll go ahead and say yep same name
as it was before server admin login will
be will be sa no no Oh we'll be there we
go just my typical nickname and the
password will be super secret that same
thing again this right here this is all
IP restricted so don't worry you can't
you can't go crash my database and the
location should probably be in the same
location as everything else
assuming want to not have this thing
totally perform horribly so Australia
East and the last party needed to select
a pricing tier which of course I don't
want this one I don't have that's much
money and this I want to go to the very
basic one the smallest one this is kind
of like sequel Express for the cloud the
basic one is still not free though
unfortunately it has does cost us
something all right so this will create
a completely blank database however I
still need to actually give it the
schema and data as part of it if I ran
it now yes I could connect to it but it
would not be able to get any information
now because it's a again a completely
blank database all right now is the
point in the demo where I click refresh
and you watch me click refresh waiting
for this thing to come up Oh No there
yet
maybe again maybe this time okay so I
need to fill that database with
something as part of my application I do
have an initial schema and data as part
of it
if using any framework - it has that
idea of migrations as part of the code
none of my money of my clients ever let
me use that so I'm not gonna do that as
part of this demo and they don't let me
like have an application when it runs
just decide to start changing the schema
of my system that's never as anyone
actually had a DBA that's let them do
that wow that's amazing
mine don't okay so let's see is this
still waiting still waiting but while
that's going I can go ahead and pull up
the script I need to use to run and
actually fill up the database with
schema and data and that's what we have
right here alright so I can go ahead and
let me copy everything we have here and
maybe it's back again Oh hooray we have
a database all right confetti from the
ceiling alright so in this database we
need to create the initial schema create
the data as part of it and the lovely
right scrolling interface of azure lets
us execute scripts directly in the
browser not scary at all the spring
sequel injection to a whole new level
here that I can do this okay so I need
to log in to this as J Bogart oh and I
need to give it that super secret
password ahead before yes all right I'm
authenticated and now I can go ahead and
pull up my scripts and paste it in run
it and now my database has some data run
it run it
hello
I think I've really annoyed it now oh
here we go
it's just there we go run run
when in doubt refresh it certainly can't
be that I'm running parallels on a Mac
trying to run Azure through that that's
definitely not what's wrong here all
right let's try this again
get that and use the tools and query
editor now I could connect through a
management studio or visual studio to do
this what we'll need to do in the future
though is to open up a firewall
exception to allow this laptop to
connect so I'll do that right after this
and copy in that super secret password
again
and my full scripts and are we having
fun
hey now something's happening okay so
after we run the scripts now I should be
able to go back to my web application I
deployed hit refresh and it should work
hit refresh and it should work
hey oh no right my connection string is
wrong what happened there oh because my
app settings over here it's still
pointing to sequel local database so
more right-clicking and more scrolling
to the right and Azure to get our
connection string corrected here so back
over in Azure I can go to my whoops oh
yeah I don't care about these I'll go to
the web application I just created right
here and there will be a section here to
load up the application settings and so
I will paste in in the application
settings right here the connection
string to connect to that individual
database so down here
there we are I long slide my website no
default version which I didn't know I
was running node I need to put in the
key here so back in my application
settings I know it's data default
connection connection string so I'll
need to do something similar here where
I have data : default connection :
connection string and I have cheated by
typing out the connection string earlier
and let's go ahead and paste that in
here and hit save now will it work I
don't know actually let's find out
all right so I've created a database
filled with the default schema and data
changed my connection string and the
application setting so that my
application now points to the correct
database and that was a lot more
complicated than right click deploy
wasn't it as soon as I have that
database that's when things start to get
more more complicated for my application
and that's one of things I want to show
here is that yeah things are super
simple if it's just a static website but
as soon as I have a database which I
think every single one of my web
applications does it's going to get a
little bit more complicated here really
shouldn't pick the free tier because
this is gonna take forever so while this
is coming up we can talk about different
ways for me to then take this
application and move it to more more
interesting deployments oh it works all
right so let me go try to edit something
all right and click Edit and change this
poor person's name to something else and
hooray my cloud deployed application has
a database that actually works
yay yay okay so my contoso university
core is trying to become more and more
popular to the point where i can't do
all the changes by myself I didn't have
to start having different teams help
help me out to be able to build and
deploy my application now we can all
keep working off my one shared drive on
my laptop for all that shared code and
whenever someone changes something that
needs to go to production each
individual developer can right click
deploy but that's crazy talk let's not
do that instead what we want to do is
introduce source control as part of that
to have our all of our shared changes
together I've already set up the source
control here I'm hosting all this on
github but I could have hosted on
bitbucket RVs tests or anything like
that
so what I want to do is now hook up the
deployment of this application to github
so that whenever I push changes up in a
github my application then goes in and
gets updated so more right clicking in
Azure
to set all this up so in my web
application here I can go to the
continuous over here the deployment
quick starts
oh no deployment options that's the one
I'm going to set up get based employment
and the idea here is that anytime I push
my code up to some source control
provider the azure detects that I've
made that change and will go ahead and
deploy those new changes to to the per
to production so I can say oh I'm on
github and this is off my personal
account so choose organization je Bogart
choose the project I want to choose my
NDC Sydney CI CD example here the branch
is master because that's the only thing
I know how to do and I will click OK
alright so of course more just like
everything else in Azure more Spinney
gifts and little dots to tell me that
everything is going here oh it's
successfully set the deployment source
so is much faster than I thought I was
going to go so let's go ahead and make a
change locally commit that change push
it up and watch that in production so
first of all let's just make sure
everything's still working ok locally so
I'm gonna run the application again
we'll make a change to our local
application make sure that it's not any
different in production and then I will
go ahead and push those changes up and
watch a sure or figure it out and then
start to make that change
alright so this one I don't like the
title of the I don't like the title of
the project here it says contoso
University core that's boring let's make
it more exciting so I'll go to my layout
and change the title to from contoso
University core to down here there we
are in DC Sydney I can't spell it right
2017 alright so I can save that I go and
refresh here and we should see the title
up the top changed to in DC
2017 I pull in the product owner I pull
on my users everyone agrees that they
love that title the ready to ship let's
get it going so I will go ahead and
commit those changes give it a good
commission commit message like awesome
title and I will go ahead and push
alright so I'm pushing those changes up
a sure is going to detect that I've
pushed those changes and something's
changed in the repository on the master
branch so back over in Azure oh we can
see that it's actually starting to
synchronize it actually hasn't quite
detected that new change yet so we'll
let this figure it out right now it's
actually building the the current
version in master but I might just kill
this and say build something new sync
yes
so what is this doing it is actually
have to build the application it can't
just take my raw code and stick that
into Azure it is actually compile the
application now it has detected what
kind of application this is so you can't
just really throw any code up there and
expect it to work it does know that I
have a web application as part of that
and so it's going to deploy that web
application inside of there into
production this doesn't take usually
terribly long usually takes just a
minute or so for it to for it to detect
this and pull it up but if I want to
force it I can just use this little sync
button and I'll force it to force it to
make those synchronization changes now
this kind of get based deployment there
are some hooks that we could have as
part of that if we want to do things as
part of our deployment oh there we go
awesome title so detected the next one
it's going to do that next one right now
so it can do some kind of I just have
some level of deployment hooks I just
have some level build hugs but you can
imagine it's not that extensible so it
doesn't do things like run all my tests
it doesn't do thing like any kind of
build script or anything like that
it literally is compiling my application
just every time I bill every time I push
is gonna go straight into production ok
so it says my awesome title is awesome
title version is now there you can't do
things like deploy older versions so if
you want to go back in time you can say
redeploy this older version if you want
to let me go back to ok this is the old
version if i refresh now we should see
this title up top now change from
contoso university core to in DC 2017
and to see Sydney 2017 now again I
didn't choose the like nice version of
this this is the free version so it has
to compete with everything else to like
spin up and start going if you have the
the more the higher level versions of
your website this doesn't take so it's
so terribly long to load up but I'm
cheap I don't have that many credits so
we will have to stare at the little
spinner
while that's waiting
I'm sorry
hmm so the question was will its
override the connection string
configuration no it won't because that
just lives in that very hidden spot
inside the azure UI so for these do the
familiar Thatcher it's like what it's
this game of like whack-a-mole like what
what did I set I don't know it's hidden
somewhere in these right scrolling user
interfaces so that one is one day set
even though I deployed a new version the
application those settings that I put
inside of the azure website still stay
there they don't get overwritten by what
I've done they're deployed the
application and then on top of that are
my other configuration now we are using
ASP net core so asp net core has a
number of different configuration never
different correct configuration
providers so this one for example I have
configured to do oh no no that's the
wrong way wrong way okay all right this
is why I don't like ctrl scroll
we also are pulling from environment
variables so it's not actually changing
the file on disk it's setting up some
environment variables and my HP net core
application is in setup to read those
environment variables so it's not
actually fiddling with the code bits
like we might think okay so that's a
that's a very boring kind of change
we've made here which has just changed
the title of something I want to do
something a little bit more interesting
so we had this database right that is
that is behind the scenes one of the
more difficult problems I have to solve
and changing an application over time is
what happens what do I do when I need to
make changes to my database so the next
that's the next thing I want to do is
make a substantial change of application
we're have to add new schema and add
some new new inputs to my screens a new
outputs to my screens and let's try to
get that change all the way to
production so I look at my application
now and in my current user information
the student and instructors only have
last name and first name so what I want
to do is add middle name to my schema
and into my application so let's do that
together
I'm using any framework so there's
probably some kind of base object where
I need to add that field to the screen
so over here I've got last name first
mid name even though it's just first
name everywhere else in the application
so I'm gonna add in here a middle name
okay that just added it to my entity
framework object so that's not gonna
actually change anything in the database
NORs it gonna add it to the screen so
the next thing I want to do is to add
that editing ability to the different
screens that I have so I want to have it
show up on the Edit screen and I also
want it to show up in the details screen
have middle names show up there so I
have that as part of my application
let's see that's on the students side so
in the Edit screen I'm going to add
middle name to the view model it's and
I'll add it to the view so down here
where I have a form block for last name
middle middle name let's add one in the
middle here for middle name and on the
details screen I want to do the same
kind of operation add it to my view
model here and add it to the screen here
first mid name I don't know what this
DTD D stuff means it was just in the
HTML that they made so don't ask me
about that all right so last name first
mid names right here will do middle name
all right now this isn't actually going
to work is it I haven't changed anything
in the database so at this point I need
to make a decision how am I gonna get
these database changes not only just not
only on my box but all
production and all the other different
developers that are working on this
application there are a few different
ways that are out there to perform this
kind of change across all these
different environments they want to like
the most these days our database
migrations database migrations allow us
to take a snapshot of a database
identify that version in time and then
as I'm making changes to the database
additional scripts that migrate the
schema from one version to the next I
add to the actual source control and
deploy those scripts as part of any kind
of deployment now in any framework has
this built in through code based
migrations I'm I've never been
successful in getting those to be able
to be done via was DBAs involved the
other way P I see people typically do
this are through sequel database
projects which are the scourge of the
earth wellmy there's another one in the
States right now but it's the second
most scourge of the earth right now
besides King cheeto so and those and
those kind of deployments the the sequel
database project the DAC pack pack pack
way of doing things what those do is you
have your own definition of the database
in in some kind of formats and source
control and then when you go to
production and you go to a different
environment at that point in time is
going to take a dip between those two
different schemas it's going to try to
figure out how to map that schema that
is your the version that you want to the
version that exists right now and most
the time that works okay except in cases
where I need to do things like script
migrations so if I need to actually
migrate data from one point to the next
or if there's like more complicated
changes that happen maybe I've renamed
tables or rename columns and things like
that it's not so smart about doing those
sort of things and so there it
introduces the chance and the
possibility that I need to have some
kind of manual intervention and
deployment I do not want any manual
intervention in my deployments and I
want to be called at 10 o'clock at night
like hey the database isn't gonna isn't
deploying can you please tell us what
you actually did I don't want that so
I'm going to use a sequel based way of
doing my migrations sequel base doing my
way of doing migrations means my DBAs
are happy because they can see the
sequel that's gonna run before it runs
and migrations so that I can easily
upgrade any database over time without
worrying about things breaking the tool
I'm going to use to do so is a tool
called round house and it's a Cutts a
console application and for this one I
need to create a new migration script
for for adding this new middle name
column the way all database migration
scripts work is they have some kind of
ordering of this migrations over time
and the way you do the ordering kind of
depends on the way the different
migration tools and any framework you
may have noticed has this like time
stamped file based way of doing things
and the way ours works is very similar I
just it's like literally orders the file
by name and we'll check each of those
scripts to see if they need to be run so
what I have right now in this case I
have it in an app data folder is a
single folder called run after create
database and it has that initial schema
and data file that I had that I used in
my production database the idea here is
that there's typically in my systems
there's kind of there's already some
sort of initial schema in my databases
and so I don't want it to try to run
that script because everything's already
there but for new databases let's say
for local development environments or
new testing environments I want that
script to be run so that's what this
folder says is if I'm going to create a
database go ahead and run this script
after you create it separate from that
are going to be actual migration scripts
and those come in a new folder that has
a special name called up
up so inside of here I'm going to create
the new script that will represent
migrating my schema from the way it is
right now to the way I want it to be so
essentially this is going to be an
altered alter table add that column
script there's a lot of different ways
you can generate this script so you can
go on management studio make the change
and say create scripts if you like me or
so your sequel ninja then you can create
it yourself so I mean just let me just
do add new item and sequel script
doesn't exist in anywhere so I'm just
going to click text file but I'm going
to name it in a special format so I'm
gonna this is the very first one so I'm
gonna prefix it with a number you can do
a number you can do a timestamp as well
I've seen that very often done as well
so you have to have a like year month
day hour minute seconds to ensure that
there's that ordering or you can just do
numerical that also works as well so I
also give it a meaningful name add
middle name dot sequel all right before
I do so I want to I just call it
something else text I want to actually
introduce sequel migrations to my
overall build environment so over here
I've got a build script this build up
ps1 there right now just as some very
simple things like run dotnet restore
dotnet build dot net tests and donnetta
so actually does run the test so i from
this build right now build it'll just
compile the application and run some
tests now what I wanted to do is run my
migrations before does anything else in
the application the idea is that I can
give this repository to any new
developer on our team
they run the build script and their
entire local environment is set up and
ready to go so we call this in my
company time to login screen how long
from when a developer pulls down the
can they run it and see that initial
login screen and ideally it said like
five minutes or less just like pull the
code down run the build hit f5 and
you're good to go
now we can only really do this easily if
I can have this local environments where
I have my database up and going so I
will run my Roundhouse tool which I have
as an executable just inside my
repository this our HDX II and I'm going
to give it some commands to migrate some
of my different databases so I on my
team always have local development
databases because shared development
databases is also crazy so I have this
local one here that I can run against
and I tell it the folder I wanted to run
my migration scripts from that's this
next argument right here and then of
course I actually have to tell what
server to go against so I'm just gonna
run against sequel local database
there's a ton of options in Roundhouse
you can do things like restore from a
backup first before you do any
migrations you can clean that you can
wipe the database and then build it from
scratch that's what the next two ones do
where it drops the database and it's
gonna run some simple migrations against
just the normal migrations so my test
database always starts out from a clean
slate and now with that OH
ready to my tests fail yeah yes why do
my tests fail the database isn't
migrated yet so let's actually run that
migration we got some new green stuff
here going that's that's the piece
that's actually gonna be running those
migration scripts against my database
and the way that works behind the scenes
let me pull up management studio and if
I look at my database right now you'll
see the normal kind of the normal tables
that existed as part of my application
if I've refreshed this table list after
migrations have run we'll see some new
tables pop up down here under the
Roundhouse schema I have three new
tables scripts run scripts run as errors
so there's something that that went
wrong and a version table and if I go
look inside the scripts run select top
thousand rows
I don't think I actually see anything
here yet because there's no migration
scripts that I've included no nothing
nothing is part of that yet so my script
as it's going it's probably a fail my
integration tests because that table at
that calm doesn't exist so let's go over
here to our migration script I did
taught text at the end so it wouldn't
get picked up
rename it back to dot sequel and yes
change let's go ahead and make a script
here I may or may not need some help
here from the audience and what I need
to rights alter table person add column
middle name nope no column it's red and
I just kidding invar car we're not crazy
okay so I've created this script then
migrates my database I'm not gonna run
it myself though I'm gonna allow the
tool to run it for me
so let's go back over here rerun my
build and it'll just blast pass it but
it'll actually run that script now if it
air is out it'll tell me but I I did the
sequel right the first time I think all
right so it's gonna go ahead and run if
I go back over now to my database and go
look to see what scripts are one we
actually get a value back now here it
says oh it has this script called add
middle name here's the actual text to
the script here's an interesting part it
actually hashes the file so if you
change it it'll barf at you saying
someone changed the file I don't know
what happened
fix it please and if I go to my person
table we should now see a middle name
column a alleged anew my tests will pass
now - yes test passed all right so my
build is successful I should be able to
run my application now and that new edit
field on my middle name should now show
up here I think so go over to students
and edit look at the details of this
person middle name is blank so I can go
edit their middle name did it and back
to the details and a middle name is
there we made a substantial change in my
application and everything is good and
well in the world except I need to
deploy this to production but now I've
got this database change I have to do
how do I make sure that actually happens
production so I go log into the database
server and manually do fiddle the bits
to add that column there probably not
that's probably not what we want to do
so what I'm going to introduce to this
system is the third way of building in
deployment applications which is an
action
see icd pipeline may introduce
continuous integration so it will build
my application run tests and create a
package for me and on the continuous
deployment side I'm going to introduce
an actual like automate a deployer that
will take my package and deploy it out
into production sound good yeah ok let's
go ok so my current CI tool of choice
for me personally today in dinette
applications is a fair a fair is a
cloud-based continuous integration tool
that uses configuration files that are
inside my source control to define
exactly what my build should be and any
time I have those kinds of things in
source control I feel a lot better about
life it's just one less thing that it's
in some user interface locked away
somewhere else so I'm going to add as
part of this let me let me know let's
just leave this here I'm going to
connect up my new repository up - up -
up there so down here I've got my NDC
Sydney CI CD that's the one I want and
alright so now I've added a build to my
application but nothing is configured
yet so let's see how we can do that the
first thing I have is my app very mo
file so what does Gamal stand for yet
another markup language yes so this this
is the this is the instructions - out
there and how to build my application so
what I'm telling it is a few things one
is how to do the version number so it's
1.0 dot the build and that's information
that can then be used in my build script
to do assembly versioning I'm going to
tell what image to use Visual Studio
2017 is a specific build image to build
against they have like I know a dozen or
so different ones I told the build
script I want to use this build up ps1
and then the last important thing here
is what artifacts exist as part of the
output of my application so I'm telling
it I'm going to create an artifacts
folder and or look in the artifacts
folder from nougat packages
and over my build I want to actually
create new get packages as part of
building my application that's what I
have here I'm now going to publish my
application to a folder this published
folder and so that's gonna strip away
all the c-sharp files and all that junk
we really don't want to have deployed as
part of our application and the final
thing I'm going to use is a tool from
octopus deploy to package my application
into a nougat package this nougat
package I'm gonna say to put it in the
artifacts folder and now a fare is gonna
look in that artifacts folder after my
build is done for the nougat package one
last thing I need to do is a bit of
cheat code which is to tell the
published command for dotnet some
additional files I wanted to have
published so down here at the bottom my
cheat code there's some additional
things I want to include as part of that
final package so I want to include all
of those migration scripts those sequel
files I'm actually going to deploy to
production but this time in a special
AppData folder that no one can see I
also have a deploy script which will
look out here in a second and the
roundhouse executable tool that will
execute whenever I actually execute my
deployment and production but we'll get
to that here in a second let's just make
sure I can build this application push
it up to push it up to production and
have it actually all run it sound good
all right
so we go ahead and commit all my changes
and push it up and if I go back to a
fare which we should see this in a
second detect those changes and then now
start to build yeah there we go
that fear so I'm also in the free
version of a fare which means I'm going
to be also in a queued shared resource
pool of build agents what time is it in
the states 3:30 in the morning I think
we're okay there's no one building over
there so we should be go here we go
eat up right away in in my actual work
environment we do pay for build servers
to make sure that have those dedicated
resources to run these builds but for
this we're just gonna head and use all
the free versions because I don't feel
like paying for it myself
okay so what is this doing first behind
the scenes we've told up there this is
the build script I've lined and run so
she's gonna take that exact build ps1
and execute it for us this is important
to me because I want to make sure I
understand exactly the build that is
happening in the server I can I can
actually execute that and run that
locally a lot of these other build tools
have these kind of like configurable
steps so you can make all these
different things happen and when
something goes wrong you're like no way
to debug that so with an actual build
script I can run this entire build oklee
make sure everything looks good and then
say just do exactly that over there and
then it can work okay all right if I got
a latest build it should actually go got
some stuff going on this is that this
app faire supports equal local DB so
will actually run my migrations and run
those integration tests against those
migration migrated databases so they'll
do like absolutely everything is part of
it oh look it actually completed so it
said uploading artifacts to contoso
University core 1.0.1 nougat package and
it all succeeded there are 21 passing
tests one unit tests yeah I think it's
like a cert true true and we're good to
go all right my artifacts I can see yep
that's the nougat package I'm looking
for so the final piece of this puzzle
here a pair has its own built in nougat
feed I don't have to use that is anyone
here using like my get pro get that's
the only one I know of
so there's also hosted options for
nougat feeds most build servers also
have their own ability to host nougat
feed so it doesn't really matter where
you nougat feed is but I do have to tell
my deployment provider where to pull
those pieces from so I'm going to switch
now over to my continuous deployment
tool which is going to be any guesses
oh and I just put it up there grab
ruined it octopus deploy octopus deploy
is they going to be the tool that
managed the automated deployment of my
application into production so the very
first thing I need to do is tell octopus
deploy where it should look for for
packages to deploy out into production
so over here and the library I can tell
it's add a new feed and this is going to
be at fair and that's the URL I have
from earlier let me go and save and test
it the package name I can look for is
contoso university core no it's not that
that's the one and it mmm
should find oh I misspelled it Jesus
here we go okay it found the package
there so now what I want to do is set up
my deployment to deploy to Azure based
on this package now I one thing I also
need to do is turn off the automate
automate a deployment for a major I'd
probably try to deploy and did some oh
yeah it did that so let's let's not do
this anymore I'll disconnect that yes we
don't want this get base deployment
doing anything anymore whatsoever and
yes oh here we go yes there we go
the next thing I need to do is there's a
little piece on you doing in the
security side on the database I'm gonna
want to run migrations as part of my
deployments and right now mais database
is only allowing connections from
basically inside the portal to be able
to run any kind of script so what I want
to do is configure to say you can go
ahead and run scripts from this machine
which is where I'm running octopus
deploy so I'm going to add this IP and
that shouldn't take very long okay and
so the very final piece I need to do is
go back to
octopus octopus deploy and set up my new
project I'm gonna set up
first of all just I have my production
environment octopus deploy has a concept
of different environments so I've had
like a dev test QA production
environments we can set those up with
each of those different like steps and
machines that could be part of it but
the final thing I need to do is set up
my project to actually deploy this piece
out we're gonna call it of course
contoso university core so I'm not that
and at our first step and our first step
is going to be deploying and as your web
app deploy the package feed is going to
be from at there so this difference
nougat package feed here the package ID
is going to be contoso University there
it is and finally I have to tell it
which account to use to deploy so my
MSDN accounts ends the web app it's
going to deploy Tzu so this one right
here and that is all I'm going to do for
now so me it's save okay so now that I
have my deployment set up here I can say
I have my all my changes are good so
let's go ahead and create a new release
that represents this new version that I
just pushed out so 1.0.1 I'm going to
hit save against the 1.0 point one
version of my application and I'm going
to say go ahead and deploy to production
now one thing this will do and I've
already got my pre-built application in
that nougat package it knows how to take
that NuGet package and push it out to
production but there's an important
thing we wanted to do as well migrate
that database so the very last thing
that I'll show you is in my application
I had this special filed on here that's
deployed at ps1 and when I have a
deployed at ps1 file as part of my final
nougat package it's going to run that as
my deployment and so what this will do
is run my migrations against my deployed
environment ooh I forgot something some
of these deployment parameters okay so I
don't want to hard-code in connection
strings and things like that as part of
this so I can do as part of my part of
my configuration is introduce some
variables that when it runs the
deployment is going to set those values
as part of my deployment so the first
one is going to be connection string
hello
oh there we go connection string and the
value is my cheat sheet over here sheets
sheets and I think at one other one
which was the developed deployment
environment so if I have different
scripts I need to run for different
environments that's what that piece is
right there deployment environment is
just prod okay now since I've introduced
new variables I actually need to create
a new release to capture those variables
so I'm gonna just call it one point two
point O 1-1 against that same nougat
package hit save and I'm gonna go ahead
and deploy now this to production deploy
now
no I wanna so the question is will that
connection string update the the
configuration settings in Azure
or Azure as we say it in Texas no it
will not so as part of our configuration
for that step we can also I say go ahead
and make that change to app settings and
this is the value want I want to give it
we're butting up against time so I won't
walk through that exact scenario but
absolutely I would do that as part of my
deployment process oh look it did
something successfully downloaded
package I look at the entire entire
application here it looks like it did
everything I want it to do
let me go ahead and refresh and see if
it did its thing so we should see a
middle name pop up there eventually and
so if part of the deployment it's going
to be pushing my package out as well as
running that deploy script as part of it
my going to my database adding that new
middle name field and now I can have
this kind of Holy Grail environment
where I have my my database changes
living alongside my application pushing
out all the way to production so we
could see right right oh yes thank you
this is taking forever okay well that's
gonna come up eventually I don't want to
sit and we're here forever because it's
gonna take forever so just to bring
everything back together again I've
taken an application that just did
right-click deploy from Visual Studio I
introduced the concept of git based
deployments through through Azure
configuring it in here had the problem
of needing to migrate my database so now
I've taken my application introduced
continuous integration packaging and
continuous delivery all the way out from
my an original right-click deploy all
the way out to production so thank you
very much I'll just wait for this to
keep spinning
it'll keep spinning because it's free Oh
five hundred I'll fix that later anyway
take care of much I'm putting up on time
so if you have any questions we'll be
sticking around otherwise have a great
rest of the conference thank you very
much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>