<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Keeping the Noisy Neighbors Happy - Eran Stiller | Coder Coacher - Coaching Coders</title><meta content="Keeping the Noisy Neighbors Happy - Eran Stiller - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Keeping the Noisy Neighbors Happy - Eran Stiller</b></h2><h5 class="post__date">2017-07-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ivgad9ZI71Y" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so hi welcome everyone welcome to
multi-talent software architecture or as
I like to call it keeping the nosy
neighbors happy the first question which
I'm trying to answer is why are you all
here why are you sitting here listening
to me
and what I want you to take out of it so
let me tell you a little story I'm a
software consultant for the past few
years I've worked for other companies
doing what all streams but the common
thing about most of these companies is
that they built a product now this
product could be something very simple
to be a very complex gold-plated
expensive system it can be some legacy
system which would have been burnt a
long time ago but you still maintaining
it and selling it because between the
money case it doesn't really matter what
the system does it's a product and the
company sold a product now the customers
want to buy this product do you know
what else do they have to do except for
buying your license usually going to buy
the hardware to run yourself your
software they need to configure it need
to install it they need to maintain it
they need to upgrade it they need to do
a whole bunch of IT related stuff just
to run your software and guess what
don't like to do it Derek doing it they
just want to go click a button get your
software up and running and that will
enter the world of the cloud customers
today come to vendors and they say well
I want not a product what I want to
service I want to go to a website click
a couple of buttons click a couple of
knobs the number of users the throughput
I need or whatever else it's required
enter my credit card number because I
need to pay for it click go and then
something automatically happens behind
the scenes and I get myself running no
ID no hardware no installation no
monitoring no anything now since that's
what the customers want a lot of vendors
want to do that so when they say hey
let's take our system whatever it is
doesn't really matter
throw it up into the clouds let's get it
running so little service and off we go
make bundles of money but you know what
happens next
something like this a reality hits them
they come and say it is because
something less like customers can say ok
how do you know you're secure how do I
know that you that you're properly
securing my stuff how when new customers
come in hell today they provision new
resources the company the vendor how
does the vendor the vendor monitor it
now because now the now they're not in
the business of selling products now
during the business of maintaining a
running system a live system which
probably needs to run 24/7 and maybe
serve customers potential around the
globe that brings in an entire new
operation to this vendor and that's
where I come in
or the software architect to try and
show them how much as you do in what
they should work under to get their
software running up in the cloud so what
are going to talk about today first off
we're going to start with a couple of
definitions you can define what is a
multi-tenant software system will define
what is a tenant we're going to talk
about who will dependent the bulk of the
talk will be around architectural issues
involved in creating multi tenant
software as a service systems in the
last couple of minutes we're going to
discuss a couple of DevOps issues which
you chobot
which you should probably take into
account as well but before I start I
have a question for you how many of you
are software architects or designers
surface software architects rate of hand
okay that's a half I have a question for
you what is the best answer a software
architect can give to any question yeah
right everything in the far north I
haven't it depends
ok what technologists actually use it
depends
should I write a web or mobile client it
depends which cloud vendors they use it
depends you get a picture so I have
assured this clamor to give you in this
session
not give you the answers or we do not
give you all the answers of how you
should build your system and take it up
to the cloud not as a lieutenant
software the service system but what I
will attempt to give you if give you the
questions you should ask and some tips
and pointers that have a couple of demos
of how you can solve this questions
usually well again there's no there's no
one-size-fits-all for this kind of
synonymous because again it depends
remember that so I hope you get the most
out of this session
my name is the hans pillar i am the
cloud division and the cloud division
leader of a company called code value or
software consultancy in israel
I'm a software architect at Microsoft
Azure MVP and also founder one of the
biggest meetups for Azure in Israel one
for politics out code we have a booth
outside if any of us wish of developers
I do encourage you to go out there and
check out the booth to make your life
much better so let the start what is
multi-talented as a multi-tenant
software as a service system but what is
multi-tenancy
okay the term software multi-tenancy
okay and this is from Wikipedia
Wikipedia sometimes has very good
definitions and we're going to go with
that the term software multi-tenancy
refers to software architecture in which
a single instance of software runs on
server themselves multiple tenants the
key thing here is that you have a single
instance of software one system which
gives service to a lot of tenants will
go back to the single instance later on
but what is a tenant eternity the group
of users who share a common access with
specific privileges to the software
instance let me give you an example my
company code value will office 365
office Physics 365 is Microsoft's a
service with Exchange Online share port
online microsoft games or kind of
productivity tools for organizations and
enterprises so if we look at that as an
example why is it bothering me right now
sorry for that if you look at office 365
is an example all the users of code
value my company are a tenant why
because we share access to the same
files on SharePoint Online we share
access to the same things on Microsoft
team the same channels to the same data
not all of us necessarily have access to
exactly the same information but we
share the permissions on the same items
if we have now an employee from another
organization we're using office 365 we
won't see this data I want to decide
they won't see these channels why
because it's from another tenant this
attempt is a group of users are related
to each other in some way and they
usually have access to the same
resources they have permissions to
access to the same resources with a
multi-tenant architecture a software
application is designed to provide every
tenant a dedicated share of the instance
it is including its data configuration
user management tent individual
functionality non-functional properties
there could be a lot of things but all
the tenants users have access to the
same things as I said now the last part
is interesting multi-tenancy
contrasts with multi instance
architectures well separate software
instances operate on behalf of different
tenants let's go back to the system I
told you at the beginning let's say we
have the software system running on
premise we take it to the cloud we want
to take it to the cloud a valid solution
would be is to say let's create some
sort of total for customers to login and
let's say a customer comes in and buys
all product they make a circle when a
customer buys your product we spin up an
instance of the system when another
customer comes in we spin up another
instance of the system dedicated for
that customer and so on is it better or
worse what do you think what
answer it depends right so they depend
on your requirements and we talked about
it very soon but the key thing here is
if everything is separated then it's not
really a multi-tenant system might be a
software service system but I like to
call it multiple single instance
software the services that will have a
lot of single tenant instances and that
find that the valid solution of done
these before but you should bear this in
mind wait when we talk in our talk today
so we describe what for multi tenant
systems but we describe what is the tent
but who is the tenant and let's say this
is our system with our customers and
let's say that the building that's now
marked on the slide is an organization
is an organization necessarily a
lieutenant what's the answer we should
remember by now
it depends right sometimes it's the cost
it's an organization sometimes it's a
division inside organization with the
tenant in fashion it's a department
inside the division with the tenant but
how do we decide let me tell you a story
a cutter will go out for a big
multinational corporation and they had
this on-premise software product which
which they sold to customers and was
very successful they didn't want to
replace it because what he did it was
managing a couple of machines on a
manufacturing flow so it can't be done
from the cloud so many reasons but they
wanted to add some additional
value-added services from the cloud
which was subscription-based
which we interact with the server with
the software and they'll give additional
services so initially for effort well
every organization who buys this product
is a tenant but then the product people
came in and they told me that actually
when dealing with large multinational
customers then most of the times each
division at that customer will buy the
software separately they will get a
separate bill they have a separate
customer ID in the Vandals
database so they're not really connected
to each other so hum well okay so
if we have small customers than the
organization lieutenant if we have large
customers then it's divisional each
entity which corresponds to a client ID
in the vendor database is a tenant and
that's defined that defines the scope of
the users but then they came in told me
well if we sell this service to multiple
divisions at the same company the
managers will definitely want to see a
report of course all the divisions
because otherwise you're not giving them
a lot of value and so what wait you
can't do that because because no one can
have access to a lot of times at the
same time we'll have a lot of data so
it's the same tenant then he came back
to the first position and had a lot of
discussions there eventually built a
hierarchy of tenant so it was a commode
complicated case but I just want to tell
you that who is the tenth is the
question that you should ask your
product the product teams whoever is
defining the product but let me give you
another question let's say we have tenth
a in blue attendant be in red now let's
say we have a user with an employee of
organization a and is using our system
and yet the user accounts during the
system everything's great
then one bright sunny day decides to
leave what does he do he is moving to
organization B now what do you think
when an organization is using the same
system the same software is a service
system should that user that employee
get a new set of credentials and
basically have a new user account or
should his existing user account to
migrate with him and just giving
permissions to the new tenant what do
you think which is better
it depends right again because this is
not a technical question this is a mark
not a marketing question again a product
question what is the requirement both
are valid cases if for example the
account is let's say in my case overcoat
value so my account is an asset code
value net and it's an organizational
account then if I work for another
company it makes sense to target another
account that if I'm using let's say a
Google
or Facebook account or something doesn't
make sense for me to open a new Facebook
account just because I moved to another
organization right so it's more for
permission issue so this is the
requirement and sometimes have to
support both by the way and we can
complicate this let's say that this user
is not a full-time employee that says is
a consultant like me and now he needs to
work for both organizations at the same
time that we have two separate users
account of one user accounts with
permission to both tenants at the same
time that's a good question
again question for the client that's a
question you should ask yourselves and
whoever's defining the requirements for
a product ok so we talked about
multi-tenant systems we talked about who
is the 10 we talked about who does the
user belong to these are three basic
questions which you should be keep in
mind ask yourselves let's go talk a
little bit about architecture and I was
ever posed to what he said here you
should really take the time and get the
architecture right when you're migrating
to the cloud and we discussed put color
of questions we should you should really
ask yourselves now as we go along we'll
have a couple of resonance architectures
which we say we see how they evolve as
answer more and more questions so let's
say we're talking about a messaging
system for an organization something
like flag or Microsoft games or whatever
but it doesn't really matter the domain
and let's say it implemented the
monolith so usually we'll have like this
in the middle the backend API a big
maybe two balls mad maybe something
balkanized
but it's a big something with all the
business logic we have clients on top of
it and we have multiple data stores
below whether it's sequel for relational
data a blob storage for maybe
attachments pictures stuff like that and
ready stash to make things work faster
so that's one possible implementation
another implementation may be a micro
service or ended up implementation may
be on docker
we look like this we have a reverse box
maybe nginx or something else you have a
choice on top clients coming in our
authentic ated using some sort of
authentication service which is right
here
we have a user service for managing all
the users the properties the
relationships with the front pool and so
on and some sort of message service for
storing the messages them served
attachments and so on so this is the
possible implementation in micro service
or architecture for an on-premise system
and let's see how it evolves so first of
all let's talk about the first question
that you should ask yourself shared
resources versus dedicated resources the
first type of resource is shared
resources in here we have a space it
could be a compute space like a web
application or it could be a data space
a storage space like a database or
storage account or whatnot where
multiple tenants get the requests served
at the same time in the same place that
those are shared resources the other
type of resource that we might have our
dedicated resources well each tenant
gets their own dedicated space so for
example if it's a database we might have
a database where a tenant or if it's a
web application we might have a web
application instance per tenant and then
we to figure out well throughout the
requests so we have shared resources we
have dedicated resources when you have
your architecture like actually we found
you need to go over each and every
resource and decide is this a shared
resource or delegated resource if our
resources are dedicated then we said
it's not a multi-ton system anymore it's
a single tent system but assuming some
are shared and some are dedicated we
need to figure out which is who and how
do we manage it so why should we
favorite why do you think we should
favor shared resources anyone what's the
major benefit of share of a shared
resource cost right exactly
the major benefit of a shared resource
is cost and why is that
assuming let's say we have multiple
tenants we have tens or hundreds it
doesn't matter and if we give
a dedicated resource for each and every
one of them we need to prepare for the
maximum expected capacity of that tenant
we need to offer provision for each and
every tenant for the expected maximum
capacity obviously we can scale it
result if we lose in the cloud but still
we need to provision enough capacity if
we're talking about a single instance
which serves multiple tenants let's say
web app or something like that then
assuming that not all tenants do the
operations at the exact same time and
reach the peak load at the exact same
time
the load the load averages over time so
we don't need that they have a hundred
tens we don't need 100 and times
resources we might need 70 and or 50 M D
really depends on how the load
distributes that will be cheaper when we
get adventurous for size so Dylan isn't
a reason why to use shared resources we
lose dedicated resources for security in
privacy
obviously let's say we have a database
pertinent if we connect the correct
database for the question that's a big
if ok we'll get to that but let's say we
connect to the correct database for a
given request and we go we know the
correct amount the no matter how bad our
queries we can't get data from another
tenant and that's the biggest thing you
should be scared of giving access to one
tenant to another tenth data rate that
something you should be really afraid
that that can take you out of business
literally if this happens to and let me
tell you a story a good friend of mine
is using the music and service from a
big corporation which you all know but
won't live in right now and we was using
it and one day he got a bill like
usually does but the bill had
information for another customer now you
can assume that if that gets public
that's pretty bad because you sent 1/10
information of expensive information
what they're using what prices all the
pain and so on we send it on to the
wrong person at another organization
question to Bill really cause when
you're working with a dedicated resource
minimize the risk okay so these are the
reasons of why should we favor each but
how do we decide how do we decide which
results what we should use now the first
thing we can use with the requirements
go to product team and ask what is a
varying or deployment strategy and now
think about that if we have shared
results anywhere then that really makes
it helped us to version or deploy
separately for tenants so if all our
resources are dedicated for a single
tenant okay so it's not a multi-tenant
system I told you but then you can
deploy a well or give a version for each
tenant separately and then you can cater
for various requests to various tenants
obviously this turns into a management
nightmare because you have to support
multiple versions at once but sometimes
if you don't have a lot of customers
this is a good choice another option
would be that if we have shared
resources of course a regional
deployment let's say well a system is
deployed in the United States in Europe
and in Asia for example so if we have
shared resources at the regional level
to deployment level that means we can
deploy only a single region at once we
need to update all tenants in that
deployment at the same time we can't
give separate versions to separate
tenants the same thing happens across
the global scale if we have a shared
resource which is global let's say we
have a replicated database of course all
the globe you say you can cosmos VB or
some sort of MongoDB application or
whatever it is then you pretty much hang
yourself together across the globe and
you need to update the entire system at
once
now that usually means that you need to
have an operating system for 24/7 that
raises the question how do I update my
application while it is still running
how to update my database scheme over 60
running but that's an all sort of
question which is not specific for multi
tenant systems but you can go to our
product team you can ask what is the
deployment or versioning strategy and
that will give you a hint as to well can
the shared resources with what scope can
they be
shared or dedicated another thing you
can look at is the state management of
the resource so for example if we have a
stateless resource it could be lets say
web application and we build stateless
because you always thought that stateful
Services Oh bad so let's say we built it
stateless and if it doesn't have a
mistake it's a good candidate to be
shared across multiple tenants because
no state is kept between a quest we
still have to be careful though a lot of
the times you have you know like static
variables or all kinds of thread
contexts which move around and stay in
all kinds of places willing to be aware
of those and find us out to make sure we
are really really spacious so again so
there's no case that a thread which
served one tenant will be used to serve
another tenant and you have something on
the thread context and we've pretty much
done so you have to be careful but again
spÃ¤ter services are usually good
candidate for being shared resources on
the other hand if we have stateful
resources like a database of a stateful
web app that's a good kind that for
being a dedicated resource for the
tenant and it's obvious because if we
have States and we know the state is
copped for single tenants then if the
request arrives at the correct instance
then we'll good again it doesn't always
say that needs to be the case sometimes
if I tell you for example for a database
and my recommendation for database
almost always almost always is to create
a database lieutenant because it gives
you good security a counter-argument to
that would be it's too expensive we're
going to create hundreds of databases of
thousands of databases not only
expensive we need to merge it manage it
all so these all collect arguments and
I'll give you a tip on how you can do
that in a couple of slides but again
they're good candidates for becoming
dedicated resources because I personally
my opinion I believe that the security
and the privacy concerns on one opponent
here but again it depends like I told
you
on the other hand if you have something
like a cache let's say ready cash or any
other in-memory cache if I tell you to
set up a Redis cash for each tenant
let's say 100 you have hundreds of
thousand tenants that would definitely
be way more expensive than you probably
want to spend because it will cost you
customers a lot more because this
between memory and memory cost a lot of
money so in that case I would usually go
with keep the single service cash just
make it bigger use the side but you can
use all kind of tricks for example when
you access the Redis cache if you if
your exit for some sort of
infrastructure you control you can
always contact innate the tenant ID to
the key which you are accessing so you
know if all of your code access is the
Redis cash through the same
infrastructure we talked about the
infrastructure
later on but if all the code access to
the same infrastructure and the
infrastructure you know that it's tested
it always adds the tenth IDs the
tentative not a little fallen exception
for example then it can be pretty sure
that the data in the Redis cache will be
separated so if you look at the monitor
catastrophe so before it can turn into
something like this where we can say
that the back-end API status for example
so it will be shell and the sequel and
blob storage are stateful and we want to
create one to tenant so they'll be
multiple of them and in the Redis cache
we create some sort of logical a regions
for using appropriate keys or if we look
at the multi tail it s sorry the
microservice architecture it can look
somewhere this we can say that for
example in this case the user service is
common because user might be might
belong to a lot of tenants because
that's the requirement it's all good
depend on the requirement but the
message service we can decide that it
will be pertinent and then we turn it
into a hunting issue because when
request comes in and let's say the first
box is aware of the tenant like maybe
it's in header or in a sign token or
something like that then the reverse
proxy can route the requests to the
appropriate instant of the message
service and then it becomes a simple
problem so that's the idea of what you
can do
now it doesn't have to be always one of
the other there are types of resources
which can help you get the best of both
worlds both cost and security so for
example if we have the azure app service
as you might know in a hosting plan you
only pay for the resources but you can
provision as many web applications as
you want
obviously provisioning many web
applications has its cost because using
resources but you only pay once for the
poor of resources that you have the same
thing goes to storage accounts you only
pay for the storage it doesn't really
matter how many containers do you have
our mini storage accounts you have there
is a limit on the number of storage
accounts but it doesn't but it doesn't
matter on the building itself so you can
separate for containers for storage
accounts depending on number of tenants
you have and the ones the one I want to
demonstrate if the sequel server in a
group sequel we have the mechanism it's
called elastic pools only we've ever
heard of it for the fund okay whew
okay great so elastic pools or mechanism
in which was built specifically for ICS
where you can buy a pool of resources
instead of buying database one by one in
pain one by one you can buy a pool of
resources and you can deploy many
databases as you want obviously there is
a limit but you can deploy multiple
databases in that pool and all these
databases will shallow pool much like
like a logical server lets you have a
logical server you can run multiple
databases on top of it
so using this abstraction we can pay one
for the poorest resources and assuming
not all tenants have the operations at
the same time the load will be spread
but we'll get one database pertinent or
one database pair several times we can
decide so let's see how it works let's
get out of PowerPoint now all the codes
I'm showing you today it's all on github
and public repository I'll make sure to
post it the URL when the slides are up
but if you want you can look in beta
balance theta equal know your neighbors
you'll find your older code
so let's see what we have here yeah I
have a scripture a small PowerShell
script this can be done from templates
for the total it doesn't really matter
it creates a result group it creates a
sequel server you have her new a dream
sequel server click the flower words to
open up the reports and the file also
the IP addresses so far it's pretty
simple and then we create something
which is called as URM elastic pool so
which is what I told you so you can see
I specified it here
this defines the all kinds of features
that you can get and the dtu's database
transaction units this defines the scale
of the pool okay so we can start from
fifty fifty is the lowest one you can go
higher as much as you need the
limitations for each skill now I can
also specify database vtu min and
database V 2 max I can guarantee that
each database will get at least 10 V to
use in this case so there's no database
with no 10 to be starved because other
tenants have a lot of population how do
you find the maximum so no 110 m to get
a lot of resources while others again
don't
so I already learned the script and if I
go to the portal open the elastic poll
it created a resource called an elastic
pool
okay we can configure it we can see that
every database is 10 to 20 easy to use
it has 50 elastic dbq's elastic dto in
total this one already has 4 database I
will show how they created what you can
see here and you can see the resource
utilization right now it's doing nothing
because we didn't learn anything on the
pool and once I have databases for show
in a moment we can see the utilization
per database so let's I run the script I
created the elastic poor but how do I
use it now I can use the elastic poor
just like any other sequel server I can
create a database with PowerShell with T
sequel with a do dotnet with whatever
you want and it works you just need to
specify there's a way to specify that
the database should be as part of
a specific pool so that'll work I'm not
showing that once I want to show you
here is a small application which is
based on the elastic secure samples as
you can see it uses some sort of the
library the Microsoft Azure sequel
database elastic scale shard management
so you might have heard the term shard
showed you the refers to when you have a
database and we split it up due to scale
it's part of databases recalled a short
now short can be on original basis it
can be on a databases or time basis in
our case it will be on a tenant ID basis
we'll short the database
according to tent IDs because that's
what I want to do so this utility what
it gives us the SDK it gives us a class
it's called short nap manager which are
us to create shouts and play the
mappings for the shelves so I'm not
going to going to the details of how
this code is built you can download
later and it's pretty much
straightforward but we create the child
map manager then we create the shelves
now already learned this because it will
take two frames to for it to run so you
have to believe me this code works and
before the session what we have here is
that we create a shell map the sheldon
appendages and quite several maps you
can call it can control several child
sets if you'd like short naps are the
code here and then we create the tenants
rerun across the number of times you
want to create in our case it's fall
then we create a shell what does it do
for creating a shout as you can see it
gets an ID and the existing map its
create an empty shard if I go into this
code all it does as you can see it
creates the database there is a single
script here for initializing a database
an empty database a shard here's what it
looks like it has a region table and a
product table and a customer's table
zone this is the what we want to
initialize a new tenant with so it
created the database network and we're
here and then it creates something
called point mapping on the shard map
what do we tell without that this is the
ID that you want to associate with the
database and this is the data type the
data
you just created so we created a mapping
with all the tea ten-to-one
this is the database 10 - this is
database and software and it's installed
behind the scene we've sold in the
sequel database separate database for
controlling this and it's all done for
you behind the scenes you don't need you
don't need to touch it in there in the
application config there's a connection
string del - well it should connect
where it should store this data but how
do we use it in one time so this is
called right now this code creates salt
Energy advanced or that does that in
advancement starts if you don't exist
obviously in a real application you
would call this every time you create a
new tenant now once you have this tenant
up and running and as you saw earlier we
have four databases in the elastic pool
they are called 10 and 0 1 2 3 &amp;amp; 4 so
they'll be finding the code let's hope
it will load soon okay here they are
here they said you can see the peak for
everyone the average search size
fragment is not a lot of detail there
but if I run this code after after I
create the shell mcmanager clade the
shelled if you don't already exist does
a small matter it's called execute data
dependence out in coil now this method
why does it mimics the behavior runtime
will you have a request
you know the tenth ID for that request
how do you know that second that's out
of scope right now but usually it's in
the property of assigned token something
like that
the to a some claim you give to the user
and why it does do not get enter the get
connection screen it's not one that here
we go so in our case I just randomly
generate the customer ID atic 3 that's
the tenant ID I want to update usually
again this will come from the request on
the context of the request and once I
have it let's say I want to add a
customer to that tenant so if I go in
here
and this is the interesting code and
does the retry policy here it doesn't
really matter but what I want you to
look at is this line of code see her
shard map open connection for k3 and the
connection thing for the controller
database
so what happened here is I don't really
care about the separate databases in the
connections things in their names and I
think I have a mapping I went to the
shore now but I want to open the
connection to the database of tenant ID
X once I have that connection think I'm
connected to that specific database okay
and I can unquestioned data from the
wrong tenant because I'm bound by the
scope or the database okay so this is
quite a powerful tool imagine you don't
need to merge the shard yourself you can
have a runtime which manages for you
when is it fall and then does the query
and goes to the correct tenant but not
only that you might say that when we run
this when let's say we have a hundred
databases 1,000 databases
how do we manage it let's say we need to
update our schema do you imagine going
database one by one and updating the
scheme and everyone coordinating it no
that's a lot of work so luckily for us
another thing that we got from Azure
with elastic pools is something that's
called elastic jobs and now have your
small script tips now I have a small
script here what this does it gets a
credential for connecting to the pool
and then I want to run this script for
example the script creates a table on to
update the schema know when to run it
across all of my channels so I create
something that's called a job okay the
job content with the script
and then I create I specify the target
in this case the target is the shard map
itself now I'm using the shona but i can
specify any custom set of databases that
I like or the old database in the poor I
can play around with it I create a
target and then I create the job and I
tell it to one and once I run this
that's from this code it will add some
Exponential's and let me enter my super
secret passwords here and it should run
hopefully
relatively fast and this would go ahead
and start the job now when I want to
print out the execution status let's see
where it stands
you can tell it's still in progress we
one one job the parent job which we
created and that that job went ahead of
schedule for other jobs for the four
databases it will go according to the
little high to do all the operation
required for updating the schema and
when I enter Ganic should be completed
by now so it goes succeeded we
successfully updated the schema cause
all the databases in the tool you can do
both scheme updates you can do queries
across multiple database in the pool you
can do all types of things with elastic
jobs so far so good
great let's get back to this issue so we
saw an example of how it can get both
resolved separation but still get the
benefits of the cost for the scale now
one thing you can do we've let the
customer decide we heard the word
premium tier or alternate or Enterprise
or whatever you can go with a shell the
architecture shared resource
architecture will share resources full
cost and you know that you whisk privacy
sometimes but you do do your best to
test it and you know it to pay for
customers sometimes okay best effort
they won't ask but sometimes they will
come this custom and say hey I don't
want my data stored with all of them I
don't care about them I want to make
sure that my data sits alone it's not
with anyone else and I'm willing to pay
for it so last time you can have solve
it as a premium tier the customer decide
if the customer pays for the decayed
resources they can have their own
instance of the application as far as
you can just need to management into the
cost okay so this is again this is not a
technical question this is a question
for the marketing for the product team
but you can definitely raise it and
offer it maybe not
for starters but later on the product
progresses now what happens if we need
operations which are cross tenant okay
we need to run some sort of query let's
say we're running a analysis another
customer that I have what they have they
have a multi-tenant system and as part
of the system they're running a machine
learning
the algorithm which outputs all kinds of
events for the tenants but what they
need is we need to get the typical
information about the algorithm about
its performance across all tenants so
they can tweak it so they can make it
work better so they can develop things
more sophisticated you get it across all
tenants now the best thing I can tell in
this case is first of all be careful we
don't want to cross from one time to
another just like that but something
else you can do that's something I
usually do it tip I give you can you can
you should try and separate and isolate
the problem as much as you can meaning
for this example if we have a database
pertinent with all the information we
need together we can set up some sort of
ETL process which extracts data from all
the databases automatically into another
separated database with only the data we
need only the statistics maybe it
anonymized
only the information with a coil and
then govern the access to that database
separately that will probably be used
only by internal employees and stuff
like that so you should really isolated
as much as you can another example I
gave you is with the customer at the
beginning with the sub tenants to build
the hierarchy again this was another
case that we need to have constant
operations so in that case we had we had
a let's call it a super tenant which had
its own database in that case and the
subtenant they were sharing a database
so it was a Hayek is going to be careful
inside the tent but we could list get
the reports we wanted of course the what
we call supplements eventually so this
is the question of shared versus
dedicated let's talk a little bit about
unbowed a on boarding and provisioning
when you when you build such a system
you to remember that ever posed to an
on-premise system you need a way to
unload new customers new customers come
in and they want this they want a way to
log in to the photos put the credit
cards pay the money you want and use
your system and that's another
functionality which you need to think of
you need to think about the web portal
you think about the business logic
behind the scenes which provisions new
resources because if we have a database
pertinent we need to build create the
database if we have some sort of tent
configuration we need to update it
that's an entire process unbuilding and
also tenants who are living in it but if
someone is done also needs updating
their usage plan if you think about all
these things a lot of customers you'll
be surprised they don't think about it
when they're on to the cloud asking how
the customers going to start using the
software so we didn't think about that
good question we really need to think
about it so here we have some example
code - example this is using the a a
sure a RM SDK for example to create a
storage account if you have a storage
account well tenant so we're creating a
storage management plant so the storage
account god create a sink then we go in
provision the required reserve this is
behind these things now obviously need a
way to charge your customers again
billing this is not specific for multi
tenant systems it's generic software the
service problem but it's still something
you could keep in your mind so if we
have this model it's Architecture from
before now we have a new provision
portal in a new section of business
logic for tenant provisioning the same
thing goes to micro services we need
another provisioning portal which is
another rewrite separate client and with
another service to handle all of this
with logic force another thing which is
which you should consider is global rich
where our tenant is located and this is
the requirement question are all tenants
located in specific region
America Europe whatever are they global
if we have a company which all of it is
located in Europe for example then great
when they sign up with they can tell us
they want to be in Europe and then we
can provision the resources in Europe
but we here if we have a company with
offices in both Europe and North America
we can't really ask them in which data
set that we want to be you could be
global I mean this goes back to the
shared resources question and the
versioning question
now one thing to keep in mind you're
better evidently I know if your systems
400 but there are a lot of countries and
namely a lot of them in the EU
specifically Germany Germany and France
and the UK they have all kinds of food
that if you gather sensitive user
information into stoical in that country
when you operate such a multi-tenant
system and you have customers especially
if they're global but part of their
users well let's say in Germany going to
select in Germany if you think about it
when you build your provisioning process
will do provision the database the
storage account that the cloud vendor
give you solution for electronics and
this is a product question do you need
to think about it or not this is a
product question but it should be in
your mind at the skipping friction for a
while let's talk a little bit about
infrastructure as I said before if you
have shared resources or delicate little
cells you need to know well throughout
the request with other if you're going
to the Redis cache server infrastructure
which makes sure to add the tenth ID and
if you have multiple method services you
need to know well throughout that
request these are all infrastructures
and this infrastructure the common thing
between them is that they handle cases
in concurrent concurrently of multiple
tenants and these places need to be well
well well secured so won't get up in
this situation or distillate or before
with the customer getting the long bill
so my accommodation air in this case is
have some sort of tenant management
service have this one place this one
location can be a service it can be a
component if it's a model it doesn't
really matter but it's one place where
you can go give it your token for
example is return you the tenth ID and
all the configuration that will be one
place which we stole connection strings
IDs of encryption gives college account
ID empty files very secrets related to
specific talents so I have one place one
place alone will be function right
exists where we need to test this
functionality
okay Antonio test it and which you need
to secure okay there's obviously be a
very basic component in your system so
if you go back to the architecture
instead of having attend provisioning
now have some sort of talent management
logic with maybe a database or a data
store it doesn't really matter which
type the same thing the micro services
we don't want just to provision it
parisians part of managing a tenant we
want to have a tent management service
with its data ok let's talk a little bit
about DevOps and DevOps is a lot of
things too many things too many people
and I have a couple things I would like
to say about specific to multi-tenancy
so one of the drives and it's very
important word of advice and it's not
specific to multi ten system but it's
emphasizing multi tenant system is this
automate I always tell customers or tell
people if you do something twice
manually in the portal then you're doing
it wrong okay it's very good to do
something one time to try it out in the
portal it's very easy to experiment to
try out a couple of things to test
things but then you should really
consider all to making it because when
you have manual processes especially in
this kind of system will have multiple
resources multiple instances of each
resource then if you get an arrow and
I've had cases where customers had
arrows in the different process because
it wasn't fully it was all manual it was
one was fully automated then reverting
back rolling back is much harder because
in 2012 as they'll which tenants were
affected and how they roll it back so
this is very important the other thing
which I like to say on our close with
this and this demo is monitoring
obviously every system needs to be
monitored all right it's no secret I'm
sure all of you do it but in the medical
system it's very important that you not
only monitor the entire system you know
the response the response time the
failure rate the exceptions and so on
it's very important to monitor each and
every tenant because you don't want the
case where let's say some tenant has a
problem in this case the one in the
middle turn red you want to be able to
identify yourself you don't want to wait
for the customer for the time to call
you and say well we have a problem and
if you only have like this big dashboard
you know it's averaged inside all the
data and then say no I don't see
anything it should work I know what's
the problem but that specific tenant
might be if database might be in
specific server is web app might be
experiencing some sort of failure and
you really would like turn data fight
the tenant level before the tenant calls
you it will be much better so how can we
do that again it really depends on what
your technology stack on what you're
using but you like to offer one A one
option have any of you heard of
application insights in Azure ok are you
nodding your hands okay that's great
application insight is a very powerful
tool for monitoring your application it
can collect information regarding
response time failure rate exception can
collect your log if you can do a whole
lot of things but other what a lot of
people don't know is that they can add
their own custom data what they call
custom dimensions on top of each
telemetry which is being sent
application in fact you can do it from
the infrastructure point of view and
let's take a look at an example again
all the code is open source on github
you can look at it later so what we have
here to open up this monitoring demo I
have a very simple a spinet call web app
see it's just upload is a start kestrel
and in the startup we wire up a couple
of things which I'll go to in a second
and our controller what it does it will
- the HTTP context of the specifics of
the current request it gets the
tentative extension methods which I'll
show you in a second this is we just
place it on the HTTP context in this
example we take the tenth I this one one
of the HTTP headers which is totally
unsecured usually we take it from some
sort of sign token or climbing inside
token but for example this is good
enough and what is called - its X if
this is a bad tenant ID in our
three or five because as I said we
punish it what is punishment we be late
we resent me choose a number between
1000 and we delay the requests this
could be a data-based delay this could
be a lot of things that could happen in
our case it's pretty trivial but in real
world this could really happen if let's
say 10 sir in five owners specific
several had a specific issue with
causing problems now we have a cost we
have a client application here which I
want ironic before the session started I
just start up a loop and just keep
sending more and more requests to the
random tenant ID and getting regular
answers now but what do we do on the
server we have in some sort of middle
well which I call the tenant ID Miguel
is like I told you it looks at the
authorization header from the HTTP and
if it's a tenant of civilization gets a
tentative I told you this is unsecure
but this is not the point
the monic portent thing is that we have
this little guy tenant ID geometry
initializer and it implements a
telemetry initializer which is something
that comes out of the application
insights SDK now what we have here we
have your one method okay it's called
initialize which we need to implement it
gets the telemetry and the telemetry is
every pieces of information which
application insights send the SB case
sends to the server to the application
side server and what we do that we get
the tenth ID for that specific request
if it exists and if we have a tenth ID
we attach it to the telemetry item we
have context which is it has a property
bag then we have a property in internet
ID and replace this number inside so
when I run this code and I run the
client which creates a lot of requests a
lot of information will be sent to
application inside so I can run it now
this will build it here we have the
console client
and I'll run it it doesn't show a lot
but if I open my task manager you'll see
that it's using almost all my CPU so
keep doing something it's working it's
calling the server and the server is
coming the request and telemetry is
being scientific
insects which I created before the
session and the rate I'm going to show
right now is data which from flag before
the session because we takes two three
minutes for data to appear in
application insights we don't want to
wait for it so if I open up application
insights let's close it this the one I
created then we can say ok this is from
previous ones they had before today so
you can see that the average response
time is 23 milliseconds hmm that's great
Wendy from millisecond response time for
web servers that's that's perfect
but if that's why I look at then
customers for inside will call me and
tell me I have a problem something is
not working right but if I was real down
in here we can see that the operation we
need the median with 0.14 millisecond
which is great but the 95th percentile
is 183 milliseconds now that could be
okay it could not be okay that really
depends on your application but if it is
done I can add shout at every level so I
drill down into that specific operation
and I can add a chart I can configure
multiple types of charts and let's say
if I add a grid oops where there's now
if I add a grid for example I can group
by notice tenant ID because this is the
dimension we sent it's a custom
dimension now if you do it from the
start it will take again two three four
minutes until this appears in the
drop-down so don't so don't be worried
if you don't appear right away but if I
add this chart then we can see here that
indeed for all the tenants who get very
good performance
these two are anomalies so if I have
this on a dashboard let's say across all
operations for each tenant all the worst
tenants then I can detect if there is
some sort of anomaly or not not only
things I can do with application
insights and have this material feature
it's called application insights
analytics
well it's like a dashboard we can a full
a for bi for analyzing your analytic
information
it has a query language it's called
application inside query language a iql
it's very similar to sequel to remind it
but you can see it also has intelligence
in here so and say request where time
stamp equals 30 minutes ago something
like that and I can continue but I have
the query here really made so let me
type it here so if I run this section
right here
so I tell it give me all the requests
from the last 60 minutes take the tenth
define from in content ID from the
custom dimensions which I sent summarize
the average of the duration by tenth ID
and all the by 10:30 so we're we going
complete needs three and five let me
increase the size of it a bit fit well
it doesn't want to zoom in for some
reason and no I oh here we go
so indeed you can see lead at three and
five that worse results but we can also
chart it so if I run the entire query
you can create a nice chart you can see
the three five from the tile this is
undefined
this song trivia song ahead and you can
take this you can put it even dashboard
you can put in power bi can be lowered
on top of it you can do many many things
and get what I wanted to remember to get
the neurotics at the tenant level okay
don't forget that it's very important
you don't want the customer to call you
you want to call to customer first back
okay so what do I want you to remember
from this session okay you really need
to define the ten boundaries can be an
organization it could be a division
organization it's not a simple question
sometimes it would be simple sometimes
it won't
it's not a technical question I asked
the product or defined yourself if
you're in the position to do that
invest in your architecture okay when
you go to the cloud and now you have a
system running 24/7
if you've done something wrong the wrong
it's great exaggerating so for every
system but for my experience when you go
to the color and you have a multi-time
system these things tend to show up
pretty fast consider which resources are
shelled or dedicated the coder or maybe
both going to what we talked about
don't forget all the things directed to
unbowed in provisioning buildings you
want to get paid in the end have the
rock solid infrastructure okay test it
if you have like I recommended one place
what if you like it if you like isolate
it maybe a 10-minute service test it
well and you know you're in a much
better position than you were before
doesn't mean you don't need to check
other things but you're in a much better
position monitor which not returned like
the story oh and the most important
thing or in a lot of cash so thank you
everyone know Rocky is done go and ruin
some systems for enjoyment and that's
about it so thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>