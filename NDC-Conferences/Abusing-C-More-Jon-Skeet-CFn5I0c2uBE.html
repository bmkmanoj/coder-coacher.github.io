<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Abusing C# More - Jon Skeet | Coder Coacher - Coaching Coders</title><meta content="Abusing C# More - Jon Skeet - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Abusing C# More - Jon Skeet</b></h2><h5 class="post__date">2017-07-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/CFn5I0c2uBE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello folks I have a little bit of a
quandary over exactly what I'm going to
present this isn't as bad as it sounds
as I have far far more code than I could
possibly show in an hour if any of you
were at my c-sharp 7 presentation
yesterday then I had just more code than
I could present in an hour
quite clearly today I have way way more
code and part of the problem is I know
I've done abusing C sharp at NDC before
but I'm not sure whether it was NDC Oslo
NDC London or NDC Sydney or which NDC
although it would have been so could you
put your hand up if you've been to one
of my abusing c-sharp talks before okay
I'm reckoning that still under half
which means I might pull out some of the
old great glorious ones that are some of
my favorites but which you may have seen
before apologies if so a word of warning
do not use any of this code in
production the point of this talk isn't
half-bad code because anyone can write
bad code and you know just look at my
day to day pull requests to see bad code
and this is code which looks quite
appealing and you may be tempted and
think oh how clever and anytime you find
yourself saying gosh that code looks
clever that should be the time that you
scream and run in the opposite direction
um however it's really fun to do for a
talk I used to say this was great
because I didn't commit any real c-sharp
code but now I write c-sharp at Google
for Google cloud platform so yeah that's
that's awesome having got one advert out
of the way quickly the other one is for
my book some of you may already have C
sharp in-depth the fourth edition is
being worked on when I'm not speaking at
conferences and for this week you can
get 40 percent off any Manning book
using the code CTW NDC although 17
so please buy you could buy c-sharp in
depth you could buy other books you to
buy lots of copies of c-sharp in depth
it's all good
without further ado and yesterday I was
saying to blame blow darts on Twitter if
any demos go badly today
take your pick Rob Connery Damien
Edwards they Fowler any of those three
to blame if any of this goes wrong and
this talk usually does go wrong because
I make the mistake of trying to ad-lib a
bit of the code and some of this code is
so hairy and bizarre that if I haven't
looked at it really recently I have no
idea what's going on anymore
it's a voyage of discovery for us all
and I would like to start off with my
favorite unicode character so I'm sure
we all have favorite unicode characters
- the Mongolian Val separator the
Unicode consortium occasionally run a
little sort of sponsorship drive and
they let you sponsor a character and
every time they do this I go and I try
to sponsor the Mongolian Bell separator
I'm quite happy to give the Unicode
consortium you know $20 or whatever to
have a bit of paper saying I sponsored
the Mongolian Bell separator they never
let me do it it's really sad but let's
let's see what it is when we've thought
about this code so if anyone other than
myself showed you this code what would
you expect it to do when we run it
what's it going to print out hint it's
either going to print out string x
equals an initializer or string x equals
in main any thoughts
okay I'm hearing enough muttering I
can't actually tell what people are
thinking but it's clear that people have
thought about it enough so the answer is
you can't really for sure tell because
you don't know what's in my text editor
we appear to have a variable declaration
here a variable assignment here and then
a variable read access here and if this
middle one is where things get slightly
tricky if any of you near the front can
have a look down here the whole column
and character bit you may not notice
something interesting if I just right
arrow over then things are fine column
18 character 18 and then we get to
column 19 character 19 and then column
19 character 20 and then column 20
character 21 it's probably no surprise
at this point that the Mongolian vowel
separator is a character between string
and X here so the next present that
there isn't a good bit okay the next
question is what does that mean what's
that going to do so I'm sure all of you
have read the c-sharp specification and
the Egmore standard which are different
things I have to say this evening I hope
I still have some voice left because
from 10:00 p.m. till midnight if you can
believe it I'm convening what I hope is
going to be the last meeting of ECMO
standardizing c-sharp Phi's I know we're
a little bit out late but until now it's
been C sharp too and we are finally
finally getting there um however the C
sharp spec and the C sharp standard
slightly disagree on which version of
Unicode they support and this makes a
huge difference
I believe and it doesn't really matter
if I've got these wrong way around that
the ECMO standard says that c-sharp uses
Unicode version 3
and the c-sharp 5 specification says
that c-sharp uses a Unicode version too
and it must us because of the history
here oh if I even read it written it
down so Eggman says 4 and the c-sharp
spec says 3 and the important thing is
that the Unicode val/val separator you
+180 II didn't exist in Unicode 2 in
Unicode 3 it was a formatting character
this CF is that's the Unicode category
for formatting character in 4 5 &amp;amp; 6
it was s which is sort of some kind of
whitespace I'm not sure whether it's all
white spaces LS MN 4 7 8 &amp;amp; 9 it's back
to being a formatting character the
reason that's really really important is
although the standard and the spec
disagree on which versions of Unicode
they're going to use they do agree on
one thing which is an identifier can
contain a formatting character and when
you use an identifier with a formatting
character it's sort of normalized away
it's as if the the c-sharp compiler does
a replacement of all formatting
characters with nothing which means that
they identify a string X with nothing
else in it is equal it is viewed the
same as a string identifier of string X
with a formatting character in however
if we put regular white space in that's
clearly no longer an assignment that's
now a declaration of a new variable not
sure why I'm getting a squiggly there
the type or namespace string could not
be found that's kind of interesting my
guess is I've left the Mongolian Val
separator in there and if I do that Miep
what the hell
oh no I'd still left it there okay
there's there's a couple of bits and
pieces so it seems that I'm going to
have to check the spec after this it
seems that you can't have that the
string keyword because it's a keyword
not an identifier can't have the
Mongolian vowel separator in it if I let
me copy and paste the Mongolian vowel
separator I think I am doing so yeah
then it goes wrong so keywords on tight
identifiers important oh I've just
worked out a whole other thing I can do
with yield kiss is yield and identifier
or is it a key word well it's a
contextual keyword so maybe sometimes
it's ah I'm not going to try to do it in
front of you because it'll be far more
fun to do it later on um I would love to
be able to show you compiling this code
in with different versions of a C sharp
compiler and it's actually doing
different things I have not yet found
any version of a compiler that actually
treats it as white space which is what
the Egmore spec says it should be
treated as and the reality is that
Roselyn just uses whatever version of
Unicode comes with the version of.net
that you're using and I think the
previous despite the fact that the C
sharp 5 spec says 3 ya know um the old
c-sharp no CRC's Aleksey before Roslyn
came along came with its own version of
Unicode presumably version 3 in there so
it would have thought it was form
formatting and I haven't got a version
of Roslin that will work on a version
of.net older than 2014 in theory if I
use the mono compiler it sort of should
use this to be ACMA compliant and view
it as a different identifier but
actually it doesn't that's still one of
my favorite things and that's why the
Mongolian Val separator is my favorite
character because just changing from
being a formatting character to a
whitespace character and then back again
is wonderfully evil how can a character
evil that's like--that's hell right
we're not going to leave strings though
I want to give you some tools here for
what I'm sure is a very very common
situation which is you want to write a
string literal but you don't have the
shift key working at the moment all
right so your your shift to foot for a
quote at least it's shift to on my
keyboard and maybe it's shift quote for
us keyboards and things so suppose you
can't type double quote this happens all
the time of course and but you really
want to initialize a constant string
well prior to c-sharp 6 you are stuck
but now we have the name of operator so
it's great if I want to do hello world
and I want a consonant I want to print
out hello world to the console and
without any spaces because spaces make
it awkward frankly and I can do that
with c-sharp 6 just with the name of
operator this isn't teaching you
anything that you probably don't know
already let's just prove that that does
print hello world and it will then print
is null or empty as well so that's name
of intro hello well and is null
aventurine are all empty and the latter
of these proves that you can print the
name of a member it doesn't matter that
X is null we're not really accessing the
member at all all we're doing is saying
well it must exist and I think it has to
be accessible as well however if I
wanted to print out hello world at the
moment I have to declare a method or a
variable or something and that's that's
just annoying having to declare
something bring some variable into scope
or whatever fortunately it turns out
that name of works with the dynamic
keyword as well so we can put whatever
we like in here
this isn't going to access anything it's
not going to do any dynamic member
access to try to find fellow world it
will just print out hello world and then
it's going to do print out the Mongolian
Val separator and the length of
Mongolian Val separator now as you might
guess there's a Mongolian mell separator
here between yep
between the N and the V and there's
another one between the L and the s and
just to prove not that you can actually
see that I'm copy pasting but I really
am pasted into there and pasted into
there and the great thing is that not
only is the name of operator allowing us
to use almost whatever string we want in
here it's also doing removing formatting
characters for us so when we print Mongo
name of Mongolian veil separated length
that will print it without the
formatting character whereas here we've
got a string with all those pesky
formatting characters that we don't
really want we only want the length of
what we can see so if we just run that
we should see that they print different
lengths that's entirely the wrong one
apologies nope name of anything yes so
Mongolian valve separator
after removing the Mongolian belt
operators has length 25 and with it it
still has an sorry without its 23 width
is 25 I'm just going to bump this on top
a bit because otherwise people back may
be hard to hard press see hopefully that
okay yep cool thank you folks right I'm
going to go back to the agenda so I
don't forget some of my favorite bits
right deconstructors any of you who came
yesterday to c-sharp 7 know all about
the constructors and in particular that
we can use extension methods to
deconstruct things into their composite
parts and the fact that we can use
extension methods are on just regular
methods means that we can do it on other
people's types like date/time
however there's a bit of a cultural
problem here because suppose we weren't
sensible if you're sensible you
deconstruct a year month date but
suppose you were a rigidly UK oriented
developer and out of interest in Norway
how do you format the dates is it day
month year yeah okay it's the halfway
sensible thing it's clearly not as
sensible as year-month-day going in you
know the same decreasing order of
importance as numbers but at least it's
not the American approach okay I think
we can all agree that the American
purchaser date formatting is just plain
weird so suppose I work with some code
that is UK based and some code that is
US based I've got some fiercely American
friends who do some some work and we
want to always deconstruct dates and
times into the appropriate version for
what we're fiddling with at the time
there are a couple of ways we can do
this so this is just date deconstruction
we take today and we're going into I've
tried not to give things away
they're just x y&amp;amp;z and the question is
what this is going to do well let's I
can't remember which way around it
prints at the moment because I fill with
this code all the time okay it's doing
it as the American month/day/year let's
see if we can work out why I have no
idea whether there's some shortcut in
Visual Studio how do you navigate due to
deconstruction I don't know whether
there is a shortcut I'll just go to
where I know it is so depending on
whether the UK date formats compiler
symbol is defined or the US state format
you can see that we must have US date
format defined at the moment let's just
use different overloads they're not
actually overloads in that they're only
one of these will will actually be built
but if we decide that today we want to
be more UK
oriented let's just define UK date
format instead and now when we run the
exact same sort of client code it comes
up in a slightly more pleasant format so
that's fine if you're doing a single you
want your whole project to take on one
kind of formatting but what if you've
got different modules different plus
bits that want to get different formats
well we don't have to be quite as single
you know one format will rule forever we
can do it on a per class basis because
instead of importing the whole of the
extension methods for a namespace with
c-sharp six we can use using static so
we can just say at the top of this one
we're going to use ISO date format and I
could have another class without
changing any project web properties that
use us date format so this means that I
can keep my American friends happy by
saying right you can work on the code
over there and you can use yem
month/day/year I can't even think about
it properly I'll use day month year and
really sensible people will define also
date formatting and they'll get the
right way of doing things which is
year-month-day so everyone wins and no
one will possibly be confused by looking
at any of that code ever again am i
right I did say never to use any of this
stuff
a scout separated I'll leave
preprocessor oddities let's look at one
of these there are two conflicting bits
of language a lot of these I sort of
found while doing the ACMA
standardization they were bits of the
language that I wasn't aware of before
and one of the interesting things is
there are two ways of ignoring whole
chunks of code there are flash style
comments and hash if preprocessor bits
so the question is which wins and
ideally I would show this by sort of
removing all kinds of coloration in
Visual Studio but we can see in this
case we have a hash if foo and two hash
elses which sort of looks a bit odd but
one of them is commented out if and only
F foo is defined but if we don't define
foo I just remove that at that point
this part of the code is defined instead
and this else is within the comments and
this little sort of slash star slash
that's a really helpful thing when
you're writing code like this because it
is end or start a comment
yeah just whichever think of it as
toggle comment the toggle comment
operator and it's great and the nice
thing is because because of the way it
round it that it works the bit that
would be the end of the closing part is
just ignored because it's within a
comment now if we're starting and
otherwise if we're ending a comment well
we're ending with a slash instead and so
yeah good ways to confuse your
colleagues right um let's talk a bit
about string interpolation everyone
fairly familiar with three interpolation
from C sharp six um I do want to give a
bit of a health warning at this point
it's possible you'll learn something in
the next ten minutes and I know that's
not why you came here I apologize but no
it happens sometimes just occasionally
so let's look a string interpolation
project in case you missed it before all
of this is on github under je Skeets
last demo code along with c-sharp seven
stuff and all kinds of bits and pieces
and so let's start first with lambda
expressions so we know that and we can
use general expressions within
interpolated string literals so you know
you can put food or techs and it will
get the the X property or whatever but
wouldn't it be lovely if we could just
write arbitrary code in strings that's
clearly what the world has been waiting
for ever since you know code behind and
or avoiding code behind so we can't just
put things in braces that's just not
allowed so maybe lambda expressions are
the way forward and you might guess this
by lambda expressions being the title of
the class here however if we just try to
use lambda expressions on their own that
doesn't work because lambda expressions
have no type I won't go into why lambda
expressions don't have a type right now
but instead they are assignable or
convertible to any appropriate delegate
type or expression tree type any
compatible one so all we need to do is
cast a lambda expression to say action
or func of string because we do need to
produce a value to be printed so if we
cast this at this lambda expression to a
func of string and then invoke it all
within the interpolated string literal
it will work so there we go
umm now yeah I don't think that's
terribly readable I think we can do
better than that
and so it's the class thing that's the
problem
and even though lambda expressions don't
have a type they can still have the type
inferred if you're doing something with
them so I could have had
you know funk string funk equals and
then this that's fine I don't need to
cast at that point so I was only having
to cast because we didn't have any sort
of context of how we were trying to use
this thing and at the same time if we're
going to have a context in which we're
using this why not just invoke the
method as well there's a delegate so all
I've done is introduced a local function
here it's only a local function so that
I can fit it all on one screen without
revealing other things but now when we
call F we pass in a lambda expression
and that can be implicitly converted to
func of string so that's fine and as a
by-product yeah we really wanted type
inference here but while we're here we
might as well invoke the delegate and
return the string so that we can get rid
of the invoked call afterwards and now
this is starting to look significantly
like a more readable way of writing code
and the great thing is you can have
whole programs like this so look you can
have user inputs and everything so what
this code is going to do I'll run it in
a sec so it will first it's got to
evaluate the interpolated string literal
which involves evaluating this so the
first thing we will see is what's your
name will then get to write something
and then when that's returned we can
invoke it I'm using the class this time
just for fun and just so we can have the
maximum number of and braces and
brackets at the end anytime that you
want to find out how drunk you are maybe
see whether you can get this right first
time without a compiler actually I don't
think it has anything to do with how
drunk you are it's just complete
luck so let's just prove that work so
we'll see one of the other ones as well
so NDC Oslo and it prints it alright so
in fact you could have your whole main
method could be within here if you
wanted I haven't tried
yeah you could even do it not in a
method at all and just have an empty
main method and then static string x
equals and then an interpolated string
literal that just did everything why not
okay so that was part one of
interpolated string literals next I want
to talk about lazy evaluation so let's
look at link first so we we think of
string interpolation in a little bit of
way of linked in terms of well we can
use variables that are within you use
local variables and all kinds of things
and even though we're calling into
string dot for math and things but link
has lazy evaluation so I won't bother
running this code because I'm sure
you'll all understand what it's trying
to do so we have some minimum value and
then the query that we are not
reassigning later just select all the
values from this values which are
greater than or equal to min so
initially it will pick four five and six
so when we print the count that will
print three when we change min to two
because we're using lazy evaluation and
because the minute self has been
captured when we call query count it
will re-evaluate the whole query and
we'll get four instead because it will
now find the two as well okay everyone
with me so far good otherwise you're
kind of nine years out of date so the
big question is clearly we want to be
able to do this in interpolated string
literals because why not
and at this point we have to start
talking about formattable string as our
interest how many of you have run across
formattable string before no I very very
few okay right you really will learn and
this will be actually useful stuff for
formattable string is used where you
want to do some of the string
interpolation now but not probably not
the final formatting because you want to
be able to specify either immediately
afterwards or later on a different
culture in particular you almost always
want the invariant culture and because
interpolated string literals for better
or worse just use string dot format
without any format provider so you get
the current threads current culture I
could rent for a long time about the
design decisions around string dot
format and but let's leave that for
another time so that's why formattable
string exists but the interesting thing
is what it does or rather what a
compiler does with it and there's
actually a formattable string factory
class that the compiler uses and you can
even plug in your own ones I think you
do get nasty clashes if you're already
using a version of net that's got
formattable string factory but otherwise
you can create your own and the compiler
will use it find its all pattern based
all right it's all based on I know that
this type should exist so what
formattable string does is it evaluates
the expressions within the interpolated
string literal so here it's going to
evaluate this highlighted expression
which calls my underscore method
and in fact is it that on the score
method how is that getting I'm trying to
work out how that's in scope oh I've got
it I've got it using static yes because
using statics awesome right okay yes sir
oh so focus down here so it will call
this method passing in the delegate that
capture method just returns an instance
of capture that remembers the delegate
it does not invoke for delegate so we
are evaluating this expression but that
in turn is not yet calling this so we've
got a lambda expression that's converted
into a funk of object and we're
remembering that funk of object and then
when we try to turn the formattable
string into a string and I can call dr
string if i want yeah same deal and then
it will call into because i'm
implementing i formattable it will call
into outer string code here and at this
point we call the delegate and the
important thing is we can call to string
multiple times and because we've
captured the value variable rather than
the value of the value variable if we
change value and then implicitly call
the string again we'll get a different
result and I've even gone you know a but
above and beyond here that you can even
pass in a format string so that if your
delegate happens to return something
that can be formatted like a date and
time we can format things appropriately
so if I run this code I believe it
should print current value before
current value after and then take ten
times of printing out the current time
in UTC with our minute second etc let's
check
that it works lazy evaluation whoa
again completely pointless but it's
quite fun to to think about when things
are executed now the bit that I'm going
to ask you to vote later on whether you
think this is abuse or a good use of
seat up features so this comes on two
builds on what we've just learned about
formattable string that's also sequel
injection now you sort of you probably
have some idea of what's coming but if
you saw something like that in most code
in particular imagine that I didn't yet
have the NVR which sort of hints that
something weird is going on if I have
that code is it fair to say most of you
would run a mile or you know and find
the junior developer who has introduced
a sequel injection attack actually I'm
not going to assume it's a junior
developer I think there are plenty of
senior developers who have become blasé
and whether they knew about sequel
injection and tackle and vulnerabilities
before or not have forgotten over time
this looks like terrible code on the
other hand it also looks quite appealing
this is the core of what I love about
abusing c-sharp of the talk and this is
appealing because the alternative the
sort of normal safe boring version and
would be to construct you'd have var
sequel equals let's copy that and and
make that here at name F ID and then
we'd have and let's move sequel
connection up there we'd have far
command CMD equals new sequel command
and give it the sequel and the
connection and then we'd have sorry CMD
doc parameters dot add and then we'd be
repeating things so there'd be the room
for typos sequel DB type dot mbar char
dot value equals name assuming that we
got name in scope and things and I don't
like this it's ugly and it's sort of
separating where I'm using things from
where I'm declaring them so in that
situation
this really has significant appeal
particularly when I specify the type so
I'm not even using the old parameter add
width value effectively so let's see
whether we can get this to work so I
started off by this is a new sequel
command instead of calling new sequel
commands we're calling the new sequel
command extension method and you know
you might want new safe for interpolated
strings sequel command but we'll leave
it for the moment
and that is this extension method so
that only takes a formattable string and
what I didn't mention before was that an
interpolated string literal does have a
type of string but is also implicitly
convertible to formattable string so if
you use var with an interpolated string
literal that still works fine and you
get a string however if you do
formattable string F equals Eminem
interpolated string literal it does not
turn it into a string and then turn it
back into formattable string it does
that just the first bit of the
evaluation evaluate the arguments and
pass the formattable string the
arguments and the format string with the
formatting removes and sort of curly
brace zero
thing you were passing to string dot
format so we can use that here so we'll
have been given in formattable string
get arguments will return the bits that
we've got the name and ID from the
variable so that's from the expression
evaluation and the format string will be
this well it'll be the whole of this but
the important thing to focus on is we've
got 0 here and 1 here so this is ready
to pass into string dot format although
this n VAR char has been left alone and
is kind of what are we going to do with
that well let's think backwards how
could we possibly get this to work we
need something we're going to call
string dot format because there's no way
that we're going to parse the format
string ourselves that would be crazy
talk when string dot format does it
itself what we want out is some sequel
that looks like the secret I typed
before where name equals at name and ID
equals at ID or at least at something
doesn't have to be at name doesn't have
to be f ID @ p0 will be fine and at p1
in other words whatever the position is
within the format string that's
perfectly fine as the name of the sequel
parameter the mbar char does not affect
the sequel that we're going to produce
but it does affect the parameters that
we're going to produce to pass into the
sequel command and this is where things
are a little bit funky if they weren't
funky already so let's generate some
sequel parameters first okay so we're
using an overload of select that gives
us the gives us the value but it also
gives us the position within the
sequence the index if we want and so
we're creating a new sequel parameter
with a name of position and we're giving
it a value ok so we've got our sequel
parameters and their values already
sorted we haven't yet got the sequel
itself or the types of the sequel
answers so that's just from the
arguments if we transform each sequel
parameter to just a new format capturing
parameter that's an extra class that
I've introduced all it does is remember
the sequel parameter in the constructor
but we are expecting these to be
formatted we know that we're going to be
calling string dot format and passing in
this array of format capturing
parameters and we know that string dot
format is going to look at the sequel
that we've got or other the format
string that's got the curly brace with a
zero : n VAR char and say ah that
corresponds to the first of these
arguments I and this implements I
formattable therefore I will call I
format of all dots a string passing in
the value of the format of all string
parameter sorry the Jo I'm I'm now not
with it myself yeah no no no it will
cause the string passing in the format
because it's expecting the value to have
its its own value as it were and it will
pass in the m VAR char and a format
provider we don't care about the format
provider at all that could be the
invariant culture that could be some
completely different format provider but
we do care about this format because
this is where we get n VAR and it'll be
null or an empty string we don't really
care if you haven't specified it so at
that point we can take the sequel
parameter that we previously captured
and poke at the pipe so we're using the
format string not to affect the result
of formatting but to affect the
parameter that we captured earlier on
I'm spending longer on this because I
think it's actually useful let's run the
code so we're going to print out the
command text the parameter DB type and
value for parameter 1 and 0
but Papa Prime's isequal I hope this
still works yes so we have perfectly
reasonable this now does not look like
it's vulnerable to sequel injection
there are no values there no apostrophes
nothing we have P Zero and we've got the
right database type emitted Lee it would
probably have been inferred to be n VAR
anyway just by default let's see if we
can change that if we make that text
then yeah so so our our parsing is
working and I think the fact that 2
string is modifying something is using
the format string to modify the sequel
parameter and not affecting the
formatting itself is by far the most
evil parts of this however I would like
to take a vote on this now and I always
do this I've had mixed results how many
people would be happy to use something
like this oh not very many not very many
I've seen more sort of 5050 splits and
to my mind it really depends on what
team what kind of team you're working on
working with and if there's a fairly
small team and it's reasonably easy to
keep everyone up to speed and make sure
they understand this is ok but new
sequel commands stuff would not be ok if
there are with it bunch then I think the
readability benefits of this are quite
nice if you're doing anything else if
you have any doubt in your own or your
colleagues ability to remember that this
is ok and other things aren't and then
stay well well away ok didn't think
suppose that cool let's look at some
performance I actually run this code
earlier on because every time I run it
it seems to give different results or
rather every time
I come back to this talk the results are
slightly different and I have to
demonstrate some slight different things
this is another case where maybe it's
useful it's sufficiently useful that I
do actually use this in no time
let's look at the background okay we
have a large struct it's read-only as in
it's immutable as all structure should
be unless their system that value tupple
and it's quite large so it's 256 bits
wide and ignore the fact that it says in
two five six as if I have implemented
operators and all kinds of things I've
implemented absolutely nothing it's just
a way of demonstrating our logic and
struct so this is now 16 bytes and it's
getting into the large territory but in
no two time and my date and time library
I do have sort of this large or even a
little bit larger sorry it's it's 32
bytes not 16 I think the largest one
I've got is 40 so within the large
structs class and this is where we're
going to be running code I have a field
called value and I initialize it it's a
read-only field I initialize it and I
have a property called total value which
I'm going to leave this not as an
expression body member just because I'm
going to want to be adding some code in
a minute this is all totally fine there
are there aren't any tricks at this
point okay I'm going to run a
performance test I'm very keen on
performance for no to time so I
benchmark things quite significantly and
you may notice that there's a lot of
iterations here so that's what see what
I can use okay it's a billion I should
keep that in that's that's helpful so
I'm going to iterate a billion times and
add the total value property each time
let's run it as it is
so this is going to take about 12
seconds and if it was running as it was
before
and literally I'm now plugged in which I
wasn't when I was running tests before I
don't know how much difference that
makes on a surface book 13 seconds okay
that's a reasonably long time let me
show you the optimization I used to show
that made a significant difference and I
don't know why it doesn't now I can tell
you a suspicion in minutes but it's only
a suspicion let's see maybe it'll be
faster now for no obvious reason so I
yeah it looks like this is going to take
about 12 13 seconds again while it does
I will start exponent explaining why
it's so 12 seconds okay
what does temp bits zero do does it
invoke the bit zero property on the
value of the value well back when we
were using value if I undo everything
does it invoke it on the value of the
field not quite
it takes a copy and then invokes the
property so back when we have this okay
this code was somewhat equivalent to
Vartan equals value long in fact bottom
two equals value bottom three equals
value bottom four equals value and then
some one dot bits zero some 2 dot bits
it could compile it could optimize
things a little bit better than this
because it could reuse the same stack
bit and just be keeping the sum but
that's effectively what it was having to
do why did it have to do this because
this is read-only
okay the C shop specification is very
clear that if you call a function member
such as property on a read-only feel
it has to take a copy and that's because
you know you know I'm a nice person but
I could be doing something evil
where let's make
okay this is um I've got the syntax
right bits one equal value whatever the
important thing is we have a getter and
appalling Li format together which
mutates the value if we call that
directly on the field then our read-only
field would be mutated that's bad okay
and this is why you can't call setters
on read-only fields because there's an
assumption that if you invoke a setter
it's going to mutate things it's a
pretty weird setter if it doesn't so
let's go back to what we had so we know
that our original code was taking a copy
each time before it calls the property
and it can't even unless the JIT is
being really clever it can't take the
copy once and then invoke bits zero on
the copy and then bits one on the copy
and then bits two on the copy because if
we had our evil code from before
invoking bits one sorry bit zero would
have mutated bits one and that's bad for
if we take the mutated version so if
this is taking four copies I have
expected
Vartan peak will value and then using
template bit zero etc to be a bit faster
because it would be taking one copy
instead of four and I'm pretty sure that
used to be the case but I now suspect
that a JIT compiler says oh you're using
temp equals value and then using tump
I'll just optimize that as if you'd use
value directly no that's doing too many
copies fortunately there's an
alternative let's make it read right
boom about two seconds six times as fast
this is why I have an attribute in Noda
time so I would have something like this
and read write for efficiency where the
I can't remember the rather got round to
writing it but I was going to write a
rosin analyzer that would ensure that
and I would only assign a value to value
here if if I'm in the constructor and I
would assume that anything I was doing
they were all pure structs and so I
wouldn't be able to mutate them so it's
probably not useful for most of you but
if you are dealing with large structs
and you do have read-only fields of
those trucks if this is a tight loop
then consider making them read/write but
do protect yourself somehow you really
really don't want to be accidentally
mutating things when they were meant to
be read only 10 minutes left right I'm
going to have a look now at old staff
what's what's going to be the most fun
let's have a look at this code so what's
this going to do
any thoughts well you can just read it
so it sets limit to ten and then it sets
limit to five and then it iterates from
X being 0 to limit so you know that's
going to be until it's 5 and then prints
X and it seems to print X twice so we
expect to sort of see 0 0 1 1 2 2 3 3 4
4 in the obvious way what we might not
expect is that it prints 0 and then 0 1
and then 1 2 and then 2 3 and then 3 4
and then 4 now you can see you know all
I've got here is a program dot CS
packages config that's just got some
config what can possibly be going on any
ideas button var is a class well where
are we defining where are we declaring
var sorry in the project properties
there's just assembly info and it's
possible that assembly info declares a
very class called var maybe it does and
it has implicit operator conversions so
there's an implicit operator converting
string to var where we basically just
take the index of that and check that
it's okay so that will set our number to
5 when we say limit equals 5 okay so
that's a start
how is this doing different things
puttan
scroll right no this time I don't have
anything there's just more licensee
stuff but good thought and that
certainly been the case before I've had
the scroll left I've got a hole now I'm
not gonna bother Cheney fm
so the interesting thing here is
overload resolution so console dot write
line here takes a string and an object
array or an object or an object on an
object or object object object or object
array but either way they're all objects
it then calls to string on those values
so that's going to call whatever our VAR
dr. string does what about this call
here though there are lots and lots of
overloads of console dot write line
there's byte in long object string etc
etc and if there's happens to be a
conversion from var to int then that
ends up being more specific than the
implicit conversion the reference
conversion from varta object so this
implicit conversion here gets called why
don't we if we stick a breakpoint on
here we'll see it today I'm okay fine I
wanted to be in release mode for the
performance things obviously right so
we'll see here it's being called the the
integer conversion is being called
directly oh it's sorry it's also being
called in order to make the limit work
but it's now the second time hello
it's possible I've given you entirely
the wrong explanation let's have a look
at the overload no it is calling the
overload with X value my guess is that
for some bizarre reason when it's
evaluating the implicit conversion
sometimes Visual Studio will say yep you
definitely want to stop on those things
and sometimes it will say I was doing it
in a different format but it definitely
is using this conversion let's just
prove that by if we make that return
number times two so we'll see half as
many numbers now but we should see not
know that the digit 0 to 4 and the the
words 0 1 2 I think 0 to 6
I have no idea why that's happening oh
yeah yeah yes I've got it
anyone else got it yep
are you saying I'm nearly out of time
yes two minutes but someone else it's
very like something shout loudly sixteen
more than five yep but that's fine we
only have the value three at that point
so it with when it's stopping but why is
it going zero to six instead of zero to
four any thoughts any thoughts come on
yet but why did we miss out so let me
show you again right I would I had
expected zero one and two but it turns
out the this implicit conversion and
this implicit conversion are happening
all over the place so it's happening
there in order to compare it but it's
also really importantly happening there
we're converting with taking zero and
doubling it and getting zero and adding
1 to it and setting that as the number
fine that's the first iteration of the
loop on the second iteration of the loop
the increment is saying oh well your
underlying value is 1 I'll double that
and return that as 2 plus plus gets you
to 3 set that as the value again oh
we've got 3 um so that teaches me not to
do really really crazy stuff in there
I'm going to undo that before I forget
because it would be terrible so okay
there we go
um so all of that was to talk about the
implicit conversion is being used in
there so you might think that a
reference conversion which is something
that is does not change the
representation at all is always more
specific than anything else but now it
turns out that if you've got an implicit
conversion certainly to a value type I'd
have to look at the exact details of the
spec as to what ends up being counting
as a better conversion and that's better
than conversion to object okay I have
three minutes left
let's find what what else was on the
actual agenda okay
no conditional very briefly I only have
plans to show one of these um no no no
logging logging can be nice or annoying
you don't want to evaluate a detailed
error message unless you're going to log
it on the other hand you don't want to
log a rubbish error message because you
couldn't be bothered to do the the right
the right logging and interpolated
strings are a lovely way of putting all
kinds of information in an error message
however if you just did the normal if I
had supposing this compiled because it
probably been log or log log level dot
debug that okay suppose that were even
slightly valid in an obvious way then
the fact that we're using formattable
string or imagine that we have an
overload taking fullmetal string would
not help us we would still be evaluating
this and we still be evaluating that we
wouldn't be doing the string formatting
ahead of time so we could save some code
there but we still be evaluating stuff
and we really don't want to evaluate
stuff however the null conditional
operator yes can come to our rescue here
if you write an API which relies on
people being able to use the null
conditional operator you can basically
turn an if block into a single statement
so normally the way of avoiding things
is to say if logger dot is debugs
enabled logger dot debug and then stuff
or you write things and pass the
argument separately and let it do the
string formatting and neither of those
are nice because they're not as readable
if on the other hand you have a logger
as I've got here with debug and info
properties which return either something
that will really do logging or null if
that log level is not enabled if we say
I don't know what the deburr the default
level is for this well I've kind of
hard-coded it but you can imagine that
it would be based on configuration so
debug is going to return null info and
warn will return actual active loggers
which means if so very quickly I know
I'm out of time I'm so nearly there
wrong one wrong one I'll just run okay
if I run logging demo it will log the
info that I had but not the debug in I
believe the most readable code that you
could have that never evaluates the the
log string unless you want it to that's
another one that's sort of on the cusp
of is that abuse or not it's really
relying on people being happy to use the
null conditional operator you don't want
to use it without um however it's just
so pretty and on that note I hope you've
enjoyed it please go away and look at
the code and then invent your own abuses
because I can tell you this is so so
much fun to do it really is see if you
can fool your colleagues give them
clever code that looks beguiling but is
awful or that look straightforward but
actually does gruesome things with var
or dynamic is only a contextual keyword
I've got a whole other example that
deals with that anyway enjoy the rest of
n DC I'm John skeet thank you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>