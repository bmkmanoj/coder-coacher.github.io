<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Implementing authorization in web applications and APIs - Dominick Baier | Coder Coacher - Coaching Coders</title><meta content="Implementing authorization in web applications and APIs - Dominick Baier - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Implementing authorization in web applications and APIs - Dominick Baier</b></h2><h5 class="post__date">2017-09-25</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Z2Pcatq8tBs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hi welcome
that's the spirit so I lost my voice
yesterday and I had heard full-day
workshop and I had to shout my way
through the day because you know I had
to finish the workshop somehow so I
asked several people how to cure debt
and they're all at different opinions so
I tried all of them it had medication in
it you know some weird stuff that I had
to take whiskey yeah so something of
that seemed to have worked because my
voice is back I might sound a bit a
little bit rough today so excuse me for
that but at least I can speak okay which
brings us to exactly this topic your
authorization because all so many people
have different opinions about
authorization yeah which was a perfect
segue I think yeah
so then that the background story of
this talk is so I'm not sure if if you
if you know the work I'm doing but I'm
I'm a security consultant but securities
is a broad field these days right so I
am mostly specializing on what is called
identity and access control so basically
authentication and authorization and I'm
working on this open source product
called identity server it's a it's a
open source implementation of oak MIDI
Connect and OAuth which is which are the
most popular you know the most popular
protocols these days for implementing
authentication and access control so and
when you are doing that for a long time
you know like working with companies and
with developers and trying to figure out
what's the best way to get their
authentication story right it turns out
at some point it's pretty much much
cookbook style right so you are you're
listening to the to the scenarios in
architecture and you are pretty you know
you can say okay do this and do that and
it's you know it's once you've done it
often enough it becomes easy I guess
that's for everything you're doing in
your life but since I'm I have the
luxury you know in quotation marks
sometimes to do that full time that's
all that's all I'm doing really it
becomes easy at some point yeah what's
not so
easier thing even after many many many
years of doing my job is finding the
best way once you then have the
authentication done figuring out how to
implement your logic around and what is
this user allowed to do in my
application right so I think that's a
much more challenging problem than
authentication because as I said
authentication is pretty much you know
once you've done it it works
ma'am so so for many many years you know
people that are using our our libraries
and frameworks said like oh I can't you
just create another library
you know authorization server or
something like that and you'd be just to
you know aptoide use authorization and
we're done right i turns out there is no
way to turn authorization into a turnkey
solution yeah because it's so
application specific yeah so it turns
out authorization is hard and the
hardest part about it is I guess that
when you talk to ten people you will get
15 different opinions on how to
implement it yeah so you know some
people like roles
some people like permissions you know
some people think of like a resource
based style we have maybe you have
access control lists that I attach to
object in your application you know that
is typically inspired by how Windows
does it right where you have an access
control and actual that hangs off a file
or a directory and you have all these
complexities around inheritance and
orphans and you know all these things
you approach authorization differently
if it's about queries versus commands
right so a command this is typically
something like I want to do something am
I allowed to do that yes or no and then
either succeed or fail
whereas queries are more like you know
give me all the things from that table
but only the ones that the user is
allowed to see yeah and again how you
feel that that is often very specific to
the data access technology you're using
and what you want to avoid is getting
all the data and then filtering it in
the front end right that would be a bit
of a security fail so we've been looking
at all these things for many many years
so when I say V it's a proc and myself
we have this little company that you
know does this style of consulting and
and software development and we try to
find a pattern over the over the years
rights okay is there something in there
that can be turned into a framework
ma'am but yeah as I said it's often very
application specific the other thing
that that hits you sometimes when it's
too late is you realize that actually
the authorization rules you're just
trying to implement are actually
business rules right well you know it
looks like authorization it you know it
walks like authorization and it talks
like half restoration but it isn't
authorization it's more like something
that is very very core to your business
and I will have an example of that later
on and has anyone ever tried to use this
thing called XML no one ah - so you can
see from going to hands going up it's
not very popular yeah exactly Mel stands
for extensible access control markup
language thank you yeah it's hard to
pronounce it's hard to use and it's an
XML as you can imagine XML vocabulary -
mortal authorization and they try to
find this Universal answer to all the
problems in the world and it I guess you
creates very complicated exactly so they
try to find the universal answer to all
the problems around that spectrum and it
turns out sometimes it's well most of
the time is it was much much harder to
now formulate your problem in XML and
just write a couple of lines of c-sharp
code I think yeah anyways so
basically so my starting point typically
is this architecture right where you
have a couple of clients you know like
browser-based Native youth us you know
some users use the same application some
users switch between applications maybe
even throughout the day you have like
server to server style communication you
have applications and api's and you know
API is calling api's and you know all
these permutations of things that make
make our today's architecture
interesting yeah and the very first
thing you have to solve before you can
even think about authorization and that
that's probably my first advice to you
is before you can think about
authorization think about authentication
first right because you need to find a
way in that architecture how you can
provide a stable identity for every user
across every application and service
he's using yeah if you don't have that
upfront you heard the whole
authorization question is moot ma'am
so what you want is that this guy you
know pop or Elias or whoever regardless
of how he comes into your system and at
the end ends up somewhere is always the
same alias and always the same Bob right
you know and that is pretty much a
solved problem you are using the the
security token service pattern for that
right where you abstract all your
authentication into a single box make
authentication as service in your
architecture used the established
protocols for that ultimately connect or
off to connect your different parts to
the system into this thing and then your
users and your clients will have one way
a one-stop shop for all the
authentication needs and your users will
get the benefit of single sign-on and
single sign out and all these things
right so once you have that the ultimate
the next question will be now okay so
now we have that what what is this guy
allowed to do in my application and now
you know test test is there's this
desire that this would
a central service as well right so you
know and people look at the action say
oh we have a central service right we
have this thing called the identity
provider so why not just use this guy to
also distribute or authorization rules
to our api's and client applications
right so this guy creates tokens so why
not stuff our authorization data into
these tokens yeah as a side note these
an identity provider creates identity
tokens they are not called authorization
tokens there's actually a good reason by
authentication authorization are two
different words yeah because they're two
different things right so we see many as
I do a lot of code reviews where I come
to a customer that that started
implementing identity server and I see
them extending the system in a way where
they start depending on you know who
declined this and who the user is and
what you're trying to talk to staff
authorization data into claims okay and
what is a claim well a claim describes
the identity of a user it doesn't
describe what he's allowed to do right
you're conflating two things here of
authentication which is this guy with
authorization which is this guy and this
might look manageable to start with but
the more clients you get the more
services you get the more complex your
system gets you will you know have a big
ball of mud at some point which is
really really hard to get rid of this is
a good example often of an overloaded
security token that some people produce
with their identity system okay so there
are some obvious things in their
authentication metadata like you know
who's the issuer and how long has this
token valid for and where can you use
that token and how did the use
authenticate and so on and then there
are actually real identity data in there
as well you know what's the user ID
what's the name and then it starts to
get problematic yeah so authorization
data like he
and delete data okay cool he can manage
customers hmm he can change treatment
plan so this is all inspired by a
customer I have two pills hospital
software so maybe you know da cross so
and then Dias rolls okay so these are
clearly that's authorization data and I
don't think there should be in an
identity token and I tell you in a
second why rolls rolls is kind of like a
Cray line yeah so in my mind there are
identity roles and there are
authorization roles so for example again
let's let's take a look at my customer
each user in that system has exactly one
role and it's called EDA doctor nurse or
patient and there's no situation where a
doctor will be a pair a nurse or vice
versa okay so that role clearly
describes the identity of that user
where is approver what does that mean
what what can this person the proof it
probably depends on which API are
talking to right so the model in you
know of is unlike in WCF for example
it's not that you get one access token
per API you're talking to but you're
getting one access token for all the
api's you want to talk to right so now
let's let's take this token and use it
here remember
this guy is an approver hmm in which API
right he might be an approver in the or
you know he might be allowed to change
the treatment plan in the oncology
department but not in the cardiac
Department right he's not qualified for
that yeah and and stuffing in these
permissions into your tokens you know a
that's just something that doesn't
belong there in my opinion B what
happens if this data becomes ambiguous
right even due to the role approval
right that he might be an approver in
the patient data API but not in a
cardiac API and then what you do like
start prefixing those claim types of
ah react toward approver and I don't
know that's madness yeah so is there
anyone in the room who ever tried to do
that like mix identity tokens together
with access you know access rules yeah
don't be shy I did it as well and you
have to learn the hard way it's it's
easy to put a claim into a token it's
very hard to get rid of it again because
some people already have a dependency on
it right that the token that the tokens
shape that the types of claims in a
token they become an explicit contract
between the issuer and the consumer
right the consumer assumes that these
claims are present and they have a
certain meaning and if you realize oh I
did a mistake changing the meaning of
claims and changing the types of claims
requires an overall you know operation
in in your architecture to make sure no
one is now doesn't have a wrong
understanding of that right so this is
troublesome okay and I have many I had
many discussions with with customers
they started with a small system and it
and they said like yeah but it works for
us yeah and then three years later they
came back said yeah you were right now
we have these 20 more api's and we have
to refactor everything because now we
you know we did the mistake we be
conflated authentication with
authorization okay so a couple of more
things why I think this is a bad idea
your identity system yeah can be a very
effective service because it only does
one thing it authenticates the user and
it's all about identity your identity
system shouldn't have intimate knowledge
of an application specific authorization
concern right why would the
authentication system know that this guy
is allowed to change a treatment plan at
this API it's not a job of the identity
system yeah
the ask is rule insecurity do
authorization as close as possible to
the resource you are trying to protect
and that's definitely not the identity
system okay
another thing is you know tokens are a
very handy data structure if you have to
transmit something that shouldn't be
altered like like your identity for
example but the only way to get a new
token an updated data is to go back to
the token service and that typically
requires re-authentication of the user
or similar things yeah
and let's say your permissions change
your your permissions you know identity
is typically something that doesn't
change at least not during the duration
of a user session right you're not
changing your first name every half an
hour but permissions might change yeah
so somebody might take away a permission
from your edge give you a new permission
and if the permissions are in the token
the only way to get a new permission is
to re-authenticate with the system yeah
Windows has exactly the same problem
yeah when an admin puts you into a row
into a Windows group you have to log off
from windows and log back in because
these groups are in the Windows token or
even worse let's say an admin put you by
accident into the admin group now he has
to back you yeah look out please so I
can you're not admin anymore right
it's not a good fit I think I said it a
couple of times now so so my conclusion
is this you have to have two things one
is the identity system and one is the
permission system and Dad together
becomes the authorization okay
so what do I mean with that so in my
mind you have to introduce another
infrastructure component and let's just
call it your authorization provider okay
as being complementary to the identity
provider so the idea is one guy knows
about identity and one guy knows about
the permissions of the user okay and you
know if this is really like central
central central in the way of there's
only one in your company or if there are
multiple of these providers that know
about you know only parts of your
applications doesn't really matter it's
the point is they're separate yeah
that's the main point of this slide here
and the way I see that
is this so the first thing you do is you
authenticate your user right so you do
an authentication request you
authenticated user you may be your your
authenticated client as well and you
don't know if indication requests you do
a token request and what comes back is
the is the identity token that that
describes the user right and now the
really important thing is now for me
that now there's a separate service that
you can talk to and you can and you have
the notion of give me the client
specific permissions right so I am I am
client X this is Dominic give me the
permissions that he has in my
application right I am the oncology API
yeah give me the permissions that
Dominic has in my API okay so basically
what is offer a session provider really
is it's a you know it's it's a service
that knows about applications and you
can have more than one application and
the way you cut them depends on your
architecture right you could have
front-end applications that typically
have different authorization
requirements than back-end style
applications right your UI typically
cares more about like do I show this
button or not or do I you know whatever
where is your back-end services
typically care much more about like is
he allowed to change that plan right you
are only doing authorization in the
front-end for usability and you're doing
authorization in the backend for
security right
there are different things so long story
short when Brock and I sat down and said
okay now after many years of of
listening to our customers and so on
let's prototype something that we think
can work right and I'm not claiming it
works for everyone that's what I learned
in authorization it's so it's so
specific to the customer but we think it
works for many people and we call it
like lack of a better name
I guess the authorization provider and
the idea is it has do I have a picture
here oh yeah it has a in addition to
that in addition to that service it has
a an admin
you I write at some point you can hand
over the permissions to someone who is
non-technical or at least not not a
developer right and they can change
basically the rules using some UI I
don't have a UI right I'm a developer I
do my stuff in code but for a real
product that you know might be something
that we're working on
you would have a UI that then you can
per application can define the
permissions and roles of that user so
roughly how that looks like that's
that's our prototype is you have
basically you have two endpoints one is
the management endpoint that's what the
API and what we did the admin UI would
talk to and the way we think is if you
want to generalize things on on what is
what are most people are doing it boils
down to they're doing roles and
permissions yeah
roles for more for the coarse-grained
style yeah well there are three levels I
think yeah one is the level of is this
user allowed to open or to use that
application at all right that would be
like the very first check then the
second check is something like okay this
user has roles that are global to the
organization that would be the nother
level one one level deep into how you
would describe permissions and then a
per application there are application
specific roles and there are basically
roles to permission mappings right so if
you are in the role of a doctor you can
prescribe medication now if you're in
the role of a nurse you can take the
temperature of a patient something like
that okay the way we think about it is
there there are static mappings and
dynamic mappings so static mappings
could be you know here's your list of
users and you say user number one two
and three they are doctors right and use
of five six and seven they are nurses
right but this whole system becomes a
little bit more interesting if you take
this idea of claims transformation
where you not only send the user ID in
but you send whatever you get back from
the identity system right so you
authenticate that user and that might be
using your local you know your local
provider or maybe this is an external
user right he comes in why are you know
like a business-to-business
you know hospitals work together you
could do Federation between them so
whatever claims you're getting back from
your identity system yeah the subject ID
role other stuff can be used in here to
dynamically put them into roles right so
maybe if he has a gmail account he must
be a contractor yeah or if he I don't
know
yeah this this this external system sent
us he's a specialist in oncology so we
will give him oncology specific roles
without you having to statically define
who is allowed to do what you can based
on the input data map him to two roles
of permissions okay so let me show you
that so what we what we have as a
prototype as I said is we have a library
it's your authorization server and we
have a host that hosts that logic right
so it turns out is it's just in a spin a
core application API and we are adding
the authorization engine here and you
are loading the configuration from
somewhere in our case that's code but it
could be a database or whatever and the
way the configuration looks like
basically it's you know it has this
notion of an application yeah so and
again what an application means to you
depends on your architecture it could be
the hospital what you want to maybe
subdivide it into the department for
example you know or perhaps you know up
to you right and we have this notion of
roles and permissions so we have a role
called doctor or a role called nurse and
a role called patient and we have
permissions like prescribe modify
medication that that is mapped to the
doctor role and the nurse
roll yeah or perform surgery is only the
doctor right that makes sense
request morphine with for the patient I
guess yeah now the interesting thing is
this are so-called conditions so how do
we associate well we are calling how do
we associate those users with those
permissions or roles dynamically so you
see here we have something called a sub
check condition which basically really
means user number 1 and user number 2
they are they are doctors right where is
this here means if the identity system
sent us a role called doc dynamically
assigned him to the doctor role in the
application okay
same idea here you know 11 and 12 are
nurses or you're sending a nurse role
from the identity system and this here
is patients right and that is an example
of a more dynamic thing where you have
an expression yeah so it turns out you
know if you have a claim of type sick
you're a patient ok and we have some
people in there they are very sick ok so
that's basically that's basically the
configuration if you like and again
imagine imagine a fancy graphical user
interface on top of that right so let's
start
okay so that's just an API that's not
much to see here and we have like a
simple test application here's an
account controller then you see
basically we can login with free--free
people Ellis Ellis is subject number one
and pop is subject number 11 so based on
our configuration Ellis is a doctor and
Bob is a nurse okay and all the other
people are very sick okay so if we log
in here now in this application and you
know that's just a mock up really how
you do authentication is it's not really
part of the discussion this could be you
know local or Active Directory or hrad
or OpenID connect in general whatever
but yeah here's our login so we see when
we login with Ellis we have a claim
called subject 1 okay if you log in with
Bob I guess that's not very surprising
we have a claim called subject 11 and if
we login with prog since Brock is not
here maybe he's sick right so that's how
that works
so now now how do we as an application
connect to such an authorization
provider and again you know it's it's
not that I'm telling you this is the
best way in the world to do that it's
just what we came up with and I've I
hope you are inspired by the pattern at
least yeah
so a modern way of doing that probably
would be you know you're providing a
client library that sits in your client
application and the way we do that
that's a spirit core we just add an
authorization provider into the into the
DI system you specify okay I am the
hospital application right the context
is very very important as I mentioned
earlier you you you probably will get
different permissions for Bob depending
on if you are an application one or
application - yeah and that is the URL
where the central authorization provider
sits okay and then in our home
controller we can take that
tendency on the authorization
authorization provide client that comes
from just the eye registration okay and
then in our secure method here we can do
things like you know wait
client get authorization async and we
pass in the user yeah and that could be
your current user but the nice thing
here is above you know for for unit
testing you can pass in any claims
principle you like but yeah what this
means basically is we send whatever
claims the current user has coming from
the identity system we sent that to the
authorization system and you could
create your own and you know have have a
user in any shape or form that you can
pass in but basically this the claims on
this user object will become the input
to the claims transformation yeah
and what does this return roles and
permissions okay so now this here is the
smart guy right you you don't want to do
it a network round-trip for every time
you're calling this method you want to
do some caching you know maybe more
intelligent caching caching is you need
to define basically how often do you
anticipate your permissions to change
right so if if you said like it's it's
okay for me to cash my permissions for
ten minutes but after ten minutes you
should get a new copy of that because
maybe someone has changed the permission
maybe in your in your system it says
yeah we change permissions maybe you
know not not very often so maybe caching
for one hour makes more sense for you
depends right but that that is the job
of the client the client library so to
speak yeah so in our view in our secure
view you see basically we read a few
data
let me just crap
and do something like roles permissions
okay so in other words if I round it
again and login as Ellis I should see
now Ellis is in the dr. role and based
on the mapping the permissions of a
doctor are prescribed modification and
medication and perform surgery right
whereas if I'm Bob I am a nurse and I
prescribe many medication but I'm a
nurse okay and I guess if I block in a
sprog I'm a patient and I can request
morphine okay so and you know that
that's the primitive so to speak yeah if
you have that client library you can
write your code around that that
obviously means you have to start from
scratch with a new application because
obviously this becomes kind of like you
know pretty much the the backbone of
your of your logic right so we have
looked at other ways to integrate that
into into applications you know the
client library is it's the core maybe
but then there are other other styles of
authorization api's for clients so one
that is wildly popular which I don't
like at all is this style yeah where you
put the authorize attribute on top of
your methods and you put like roles
equals doctor in there and if you're a
doctor you can you know you can update
the treatment plan right so who likes
that style okay who uses it and who
likes it
okay I think it's the worst thing ever
sorry
number one what what strikes me always
is why are thought net developers so
crazy about attributes I mean you know
it's code right it's code above the
method name what is different to code
below the method name yeah I don't get
that maybe you can do reflection against
that I buy this argument but no one ever
does
yeah so that's one thing the other thing
I don't like about his style is that you
have a you have a tight coupling between
your code and your authorization rules
right that that implies a couple of
things that that implies that the
developer at the time he writes that
code already knows who will be allowed
to call that code in production I don't
think that's true that also implies that
every time your authorization rules
changed you need to update your code
right so let's say for this particular
method you want to allow the doctor and
I don't know someone else so now you
start going into your controllers and
you know type away on these magic
strings if you have you know five
controllers that might be okay for you
but if you have five hundred that's
that's a different story right make sure
that whenever you do updates to your
authorized attribute you don't make it
mistake right because I suddenly you
have a security hole in your application
so I have customers who have written you
know we are all engineers right so I
have so we can write tools that update
the authorized attribute in our code
base to make sure we don't forget
something right or you become just a
master and regular expressions also
testing how do you test that you have to
write authorized attributes what you do
like to call every method over HTTP and
make sure the write status code is
coming back yeah so not a big fan of
that but as some people raise their
hands let's have a look how that would
work
so basically there's a technique
called claims transformation so the idea
is that instead of calling this API
explicitly you turn it into middleware
and run it in the pipeline implicitly
ma'am oh and I have a non fatal error
that's good so we have this thing called
apt or use authorization provider and
what it will do basically is it will
crap the authorization proxy from the DI
container called a method for the
current user and then whatever comes
back adds it to the claims principle
right so if I compile that and log in
again and login with Elias you see now
that in addition to having our explicit
roles and permissions you now see that
the claims principle contains a roll
claim of doctor and two permission
claims of prescribed medical care and
medication and perform surgery so what
that means now is that you can write
code like you know like this home
controller let's do offer eyes roles
equals doctor right if that's your
preferred way of doing it and that means
now that only LS should be able to to
access that page right and if I log in
as pop with a nurse I get forbid okay
that's by the way a subtle new feature
in HP encore I'm not sure if you know
that that in a spirit core they now have
the notion of what is what what does
unauthorized mean for an anonymous user
was an authenticated user right so if I
am if I log in here and try to try to
access the secure method right I am
anonymous and they bring me to the login
page
so I login with Bob now I'm
authenticated
and I'm trying to access secure but I'm
still unauthorized because I don't I'm
not a doctor right so they bring me to
forbidden now and then if there was
something that you had to do manually in
old a spinet applications right because
all they did in HP no that old so to
speak was always send you to the login
page right because logging and logging
in in logging in again might solve the
problem right
it doesn't typically so that's quite
cool so if you haven't seen that
basically on the middleware in in your
pipeline not this one this one you can
specify these two paths here login path
and access denied path and then the
middle way basically did you know
dispatches you based on on your
authentication status so to speak yeah
okay so yeah where are we here okay so
if if you like that you can do that I
don't what else can we do in the new a
spinet Court as a brand new
authorization API and has anybody about
you said or played around of that it's
been around since HP or 1.0 right that's
eight months do you know that they
relates to 2.0 yesterday yeah so the the
backstory of that is that proc and I
have been working with the asp.net team
for many years and we always were
unhappy with the authorized attribute
job and we told him that for many many
years and obviously they couldn't change
it a lot because you know there there
was no no opportunity to do breaking
changes but if a spear core there were
plenty of opportunities to do breaking
changes yeah
so they Inc so basically we prototyped a
framework for them which you know was a
prototype it was okay it wasn't really
good it elect liked some of the features
but big big we showed it to them and and
now with HP of core they took some of
the inspiration from that and and and
using it now and the main point my
main point of improving the
authorization attribute story is that I
want to separate my code from the
authorization logic okay that is my main
my main goal yeah because I don't like
this this tight coupling in inner
controller and that's that's the the
main feature they did okay it's
extensible into one of the fourth and it
by the way funnily the most common
question I get when I show someone this
new authorization framework is ah that's
cool is that available for is it for
nbc5 because I don't I don't do HP net
core yeah I'm doing web api and indeed
someone someone did the back port of
that framework to to you know a version
minus one so to speak yeah okay so what
what does this look like so they have
this notion of a so called
authentication Polisario authorization
policy and the idea is that in a central
place in your application you create
so-called policies and policies are a
list of so-called requirements okay so
basically you can say like if you want
to prescribe medication
you must be authenticated to start with
and then you need a permission called
prescribe medication okay or you know
whatever you can you can basically
extend this system in any way the main
point here is that the policy is being
defined outside of the controller okay
so maybe even in a different assembly
maybe you pull in your policies while
you're in NuGet package for example yeah
so you conversion them independently of
the application and if you change those
policies all of your controllers will
automatically get the updated policy
okay so let's do that let's have a look
how that looks thing so the way you do
that is in your startup file so the
policies live technically speaking they
live in the DI container that's why you
configure them from the configure
services method obviously you wouldn't
put your policies in this class here in
this file yeah that would be probably a
bad style especially if you have more
than one
but you get the idea you call it from
here so you can populate your di
container with that and then I can go to
my controller and instead of doing this
I do this okay
and now and now basically what this
means is if you want to access the
secure method you need to fulfill the
prescribed medication policy no still an
attribute it's fine but better than the
other one above okay so in other words
if I run it again it behaves exactly
like you would expect it to behave
yeah so if I'm if I'm a nurse I can
prescribe medication but if I'm broke I
can't okay what I like a lot about this
is that instead of doing it like that
you can also work with the policy system
imperatively right so it doesn't need to
be an attribute as we all agreed now
attributes are okay so as a service from
admin for Microsoft it's called the eye
authorization service that comes part of
their new authorization framework right
and then you can do this okay and then
instead of doing you know this here you
could be more imperative we are like you
can say if sorry var allowed equals
authorization dot authorize async you
pass in which user you want to offer
rise against and see the name of the
policy okay and then if you want to have
exactly the same logic as the attribute
you could say if this is not allowed you
return a so called and that's the new
feature I just mentioned a challenge and
this challenge is the thing that knows
about
you know login versus forbidden well now
what does what does this enable you now
if you can call the policy system
imperatively
what do what do you think what excellent
features your software could have by
enabling that one of their yeah but I
think something could can be different
you can unit test your policies now
right yeah so you can basically write
tests against your policy to make sure
they actually do what they are supposed
to do yeah so I mentioned earlier if
using this old style here how do you
test that this method is really secure
right you can't do that without doing
you know like a real HTTP request
against it and make sure that the right
status code is coming back for the right
state you set up first but here you can
write a unit test make up whatever
claims principle you want to make up
pass it into the policy and make sure
that you know nurses should be allowed
patients shouldn't be allowed right and
if someone along the line has has to
change the authorization requirements
and you know some other developer or
yourself half a year later changes the
policy you can still make sure at a
check-in time that all the tests are
still passing and you haven't by
accident altered the policy in a way
that it breaks the existing requirements
right I liked it a lot mmm obviously
also you are do totally right by having
by having this boolean now you can have
multi level you know request and can
maybe handle the failure code path
differently than you would just you know
just to redirect to forbidden page for
example yeah maybe maybe maybe you can
recover from that in a way okay
cool so that's the new policy framework
so one thing about it which obviously no
one yet complained about is oh I should
mention that that's something that you
can also do in HP or court in our
support dependency injection infuse so
if you
we want to inject your authorization
service into your view you can call the
policy system there as well if you want
to like conditionally conditionally
render your UI for example I'm not too
excited about that to be honest yeah
because that basically makes you just
write more code on your views and you
know your views basically shouldn't be
another code file my requirement my
advice would be if you need to
conditionally render UI put it in a view
model right but there is one point where
where I find this useful is on layout
pages right where you can't pass in a
view model so basically on a layout page
if you want to change your clothes
navigation to whatever this guy is
allowed to that's a handy little you
know tool in your in your tool belt okay
so the only thing I don't like about
this approach so far is that now I have
to you know for every permission in my
system I have to create a policy right
which is kind of a bit awkward ma'am
there's another nice feature in this
system called the policy provider and
the idea is that you can create policies
on the fly okay so what we can what we
can do is by implementing a custom
policy providers that we can create
these policies you know on the fly when
they are needed yeah so let me show you
that that's an example of a simple
policy provider so basically they pass
you in the name of the policy like
prescribe medication then what what you
can do is you first check is there
aesthetically defined policy with the
same name so that wins over a
dynamically created one and if not you
basically you know call into the health
commissioner API manually and return the
status so basically in other words now
every permission in your system becomes
implicitly a policy that you can program
against that's quite cool right so I
like that so how does that work
basically in here we have a little
extension method at permission policies
and
what is you know dust under the covers
is it wires up this policy provider that
view that we've written and that has
this logic I've just shown you so in
other words in my startup I can remove
this now oops not all of it and my code
will still work right even if this
policy is not defined now aesthetically
I will I can create on the fly I also
don't need this anymore here because now
I don't rely on the claims being present
in the claims principle anymore
no and if I run that you know it will
still work so Bob it's allowed okay cool
so let's take this one step further
custom requirements okay so I I said
earlier I said earlier area policy is a
list of requirements and there are a
couple of requirements that come that
come from Microsoft like to claim type
requirement and there's a role
requirement and so on but you can extend
this system in with your own custom
requirement so maybe you know depending
on which medication and the amount
you're giving the nurse or a doctor
should be allowed or not right
so you know it does it probably a big
difference between five units of
morphine and ten I assume at least so so
what you can do is you can model these
these requirements as just data classes
and you implement this I offer ization
requirement interface and that just a
marker interface so in so that in the DI
container they they find these things
and you know that that's a bit a cramp
slide here but to show the idea is
you're writing an authorization Handler
and you're deriving from this t
medication requirement base class and
then whenever somebody invokes a policy
data that contains this requirement your
handler will get called at runtime
and then you say okay you know if the
client has the permission of prescribed
a medication okay that's the that's the
prerequisite but now if the amount is
less than 10 okay they all can do it
right but if it's more than 10 it must
be a doctor unless it's a placebo right
and then you know we don't care okay and
how you call that it's basically by you
know your newing up this requirement
class and then you're calling the
authorization API pass in the user pass
in the requirement your handler will get
invoked at runtime you will get back
true or false and based on that you can
make a decision okay and obviously since
policies are a list of requirements you
can have more than one and they all must
they all must agree on to each other
right so if you have five requirements
four of them succeed one fails the
policy will fail right so they all have
to succeed and that's what you do by by
calling context or succeed if you don't
call that the default will be fail which
makes sense okay are we on time that's
good so the last thing I want to show
you is another another feature they
added in HP nerdcore again based on our
on our feedback and that is called
resource based authorization and the
idea is this so far policies only have
two inputs if you like it's the identity
of the user and the requirement right so
what a policy doesn't have as an input
is the resource this user is trying to
manipulate so let's say for example you
want to have something like this user
can only delete a document if he's the
owner of that document yeah right so
basically a third input comes in and
that is like what is he trying to
manipulate ma'am
so in our in our in our context the
resource would be probably the patient
right so
let's say we have this we have patients
and they have allergies to certain
medication right so now you're asking
yourself the question is this nurse
allowed to give ten units of morphine to
this patient or is he allergic to it
okay and the way you can implement that
is very similar to you've seen the
requirement you have an handler but
you're taking into account the second
input which is the the object or the
resource that you're trying to
manipulate in your application okay in
this in this case it's an object called
patient ma'am you know and then you do
your your Lord shake your medication
requirement Lord shake and then at some
point you basically say something like
you know if this patient has has an
allergy to the medication being
subscribed then this is not allowed yeah
and then and then you invoke it like
you've did before you're creating a
patient setting the elegies you're
creating the medication operation you're
calling off rice they sing you pass in
all the free inputs and you will get
back a true or false how do you like
that hmm okay that's where I think it
goes wrong to be honest you remember
when I've at the beginning I talked
about at the blurry line between
authorization and business logic what do
you think is that this this line of code
here is that security or is it is that
core hospital software business logic I
think that business logic right good I
would agree right so if you are a
software company that writes hospital
software right you're probably one of
your main intellectual property or you
know like one of your main value
propositions if that you have some logic
that finds out if you prescribe aspirin
to a person if the person is allergic to
any of the ingredients of the aspirin
for example right I mean it's not as
easy as saying oh he's allergic to
aspirin it's probably what's inside of
yeah or you know more complicated stuff
so I think at least in this example here
you are probably already having a whole
API or a whole you know business model
around around this question that that
I'm asking on on this line of code right
so I'm I'm not sure if if it makes sense
to shoehorn that core business decision
into an authorization policy yeah you
might disagree and that's totally fine
because I'm on the fence as well
sometimes yeah so it's kind of like
that's where it becomes really really
interesting part
I still think you know if you are
already dead deep into your
domain-specific logic why would you turn
everything into this Microsoft framework
here of handlers and you know
requirements and so on you already have
an API probably for that right I'm not
saying it's a bad idea to separate the
concerns I by all means I would
recommend that you separate the concerns
of business logic and decisions and
authorization into separate pieces but
I'm not sure if this particular
framework is the right answer to that
okay I totally like the policy based
approach that makes total sense to me
but once you are dead deep into your own
application it feels a little bit like
XML you have to use a framework to fit
into the model Paris not using the
framework might be easier yeah so that's
my conclusion so you know our our quest
to start with was can we write this
authorization framework to rule them all
like the one thing you need and you're
you are forever happy with your
authorization decisions and it's easy to
use and all that and I think the
ultimate question is no but that's a
good thing right there are various
decisions around authorization like one
is like can you
access the application at all yeah this
is typically done at the OAuth level
even yeah you're asking for an access
token for API one you're not allowed to
use API one you you won't get it right
if you're a user the application says
okay you are your Dominic but are you
actually a user in my application I
totally get that once you are inside the
application you want to access a feature
I think this is where the roles and
permissions model fits in really well
right if you're a doctor you're allowed
to do this so if roles are to cost range
for you then map roles to permissions so
fan-out basically you know the different
permissions so you know you want to you
want to prescribe medication you must be
you must have that permission for that
but once you are inside that feature
yeah think of the allergic or the
allergy problem I think from that point
on it's it typically becomes application
logic and not so much authorization
anymore so for me my conclusion to the
problem is typically authorization stops
here at this boundary and everything
gets inside is mostly business logic and
there might be totally use case but this
is not true what I'm saying but for the
most use cases I've seen so far that's
what I think it is so I don't hope it's
disappointing that I conclude my talk
with this this opinion yeah I think it's
a good thing because maybe maybe it
saves you some time trying to shoehorn
this into an authorization logic yeah so
I think the main takeaways from this
talk is a even people like me that do
with security full-time struggling with
it so don't feel bad if you struggle
with that as well and from all the
scenarios I've seen that the common
crowd seems to be something like
permissions and roles and maybe access
control lists things like that
but nothing more sophisticated I think
you're far better off if you have more
sophisticated things than just can I do
this and can I do that I don't think you
will do yourself a great favor of trying
to fit into an existing framework write
your own thank you we have more one
minute left if you have any questions
yeah you mean like is this user in the
right tenant tool - that would be a for
me typically a front-end application
concern right your identity provider
authenticates the user he doesn't know
specifically which ten and he's trying
to access but you typically would put a
tenant ID into the identity token so you
heart so basically you you burn in the
tenant ID along with the other identity
data with that user and then wherever he
presents that token that system must
make sure hey you are ten and five what
you're trying to access tenant free
that's not going to work that that's a
policy maybe no but it's an application
concern from you know okay one more yes
okay so the question is can so you you
want to basically annotate your policies
yeah that would be I guess we not the
prototype but it's a good idea thank you
so yeah me yeah it would probably
totally make sense to have an additional
you know field say why is this policy
the way it is and then maybe can even
produce automated documentation from
that be great yeah thank you for that
yeah cool
thank you very much enjoy the rest the
conference thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>