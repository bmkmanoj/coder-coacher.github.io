<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Security in ASP.NET Core 2.0 - Barry Dorrans | Coder Coacher - Coaching Coders</title><meta content="Security in ASP.NET Core 2.0 - Barry Dorrans - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Security in ASP.NET Core 2.0 - Barry Dorrans</b></h2><h5 class="post__date">2017-09-25</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/TfmBOzuPFLQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">good afternoon thank you for coming to
my session on security in asp.net core
or I will probably be heckled by Dominic
at the back because he knows more about
some security things than I do I will
freely admit that my name is Barry
d'harans I am the dotnet security PM the
slides and the demos for this will be
available from my website which is I
don't know two org probably in about 20
minutes after I'm done assuming the
hotel Wi-Fi does not fall over which
seem to be quite often here basically my
job is to try and tell everyone how to
do things correctly from a security
perspective I also own certain features
of asp.net that are related by security
and then when everything goes wrong and
someone hacks us I'm the person that has
to deal with it which is why I chain
smoke in order to quickly end my pin you
can follow me on Twitter as a blow dart
it is not very work focused I will warn
you now today it has been pictures of
ibis weird looking birds that I
apparently am told are called bin
chickens you people are weird so I cover
some of the various things that we've
done in asp.net core 2.0 I was gonna
cover some of the things that are coming
up in 2.1 but my 2.1 install does not
work so we're just gonna talk about
those vaguely but unfortunately a can't
demo first up is hosting in asp.net core
we decided that we didn't like any web
server on the planet that already
existed and so we thought it would be a
great idea to write our own which is
wonderful from a performance point of
view from a security point of view it's
very much giving me an ulcer to be
perfectly honest however we did a lot of
work in cash flow for 2.0 including
having some pen testers come in from
outside and beat up on it and when you
tell pen testers we have a brand new web
server for you to test they tend to get
very very excited because that doesn't
happen very often kestrel now supports
HTTPS
we have finally updated visual studio so
it will issue self-signed cert so that
chrome does not barf on if you have an
existing self-signed cert we won't
update it because we don't want to
overwrite you but you can update it
yourself manually by following that gist
and you can get a self-signed cert that
chrome is happy with you can configure
the search via a config like this it's
all very exciting because the way that
we are now building our web hosts has
using a lot of opinions and defaults and
we've decided that yes this is probably
the easiest way to do things so now you
just have like two lines rather than 17
to configure stuff but you could still
have those 17 lines if you are paid by
the line of code we have a lot of limits
in castro in version 1 we had all of
those I'm not going to go through the
slide in version 2 we added some more
and when we added those we've come to
the conclusion that yes you can run
Castro as your main web server with
nothing in front of it I am very careful
in my wording here which makes Pilar
really unhappy he's like what are you
trying to say with Castro 2.0 using it
on the edge will no longer be
unsupported which is a wonderful phrase
that should make you stop and think
basically if you use the only edge in
one we're like hey you're on your own
it's not our problem in 2.0 if you want
to do it feel free now would I recommend
it no uhm I think we're all in agreement
except maybe perhaps for David in that
it's a new web server it's been out for
a year it hasn't been beaten up a lot by
attackers so being a lot by us but with
the best will in the world we're
probably not going to catch everything
they're going to be some weird edge
cases where some will be able to
denial-of-service attack your server and
iis was the same as was apache in their
first 3 or 4 years of existing so i
would honestly recommend that you still
put a proxy in front like nginx or
yes and then stream everything through
to Castro but if you want to live
dangerously feel free and we will
support you authentication in dotnet
core in 1 we rewrote all our
authentication story and our
authorization story so there are a few
options that you have you have no
authentication which obviously is still
a type of authentication you're just
anonymous you have individual user
accounts where everything is stored in a
local database that you have to manage
and backup and how never ever leaks so
you have to secure it we have work in
school accounts which is as your Active
Directory and we have windows
authentication for those of you that are
running on internal windows only
networks you do not switch windows
authentication on to the Internet it's a
bad bad thing
we have social offs we have Facebook
Twitter Google Microsoft account and
Roth bill in there is a community driven
project for lots and lots and lots of
providers for social networks that I
have never heard of but you can
basically find pretty much everything
you want in the SP net security ooofff
providers project in asp net contrib so
template off like I say we have local
databases everything is done via EF so
you can change how your models look it's
very opinionated in how we store
passwords we're not going to let you
change that because we think we know
best so it is what it is and eventually
we will be supporting authentication via
oh I DC and we'll talk about that a
little bit
working school accounts as your Active
Directory it's open ID Connect based if
you have a DFS in your network and you
want to use a DFS you must upgrade to a
DFS 2016 which if you're not the network
administrator good luck and convincing
them to do that because network
administrator's do not like changing
major parts of their network but it is
necessary we have had lots of requests
for sam'l and WS fed because a bunch of
you work with governments and by
and people that generally don't move at
a fast rate it's not there yet it will
be there some time between now and two
point one you won't have to wait for two
point one we're probably playing to push
it out in about a month the support that
we needed for it got delivered two weeks
before two Oh dropped so we're like yeah
okay we're not gonna do that right now
so check again in about a month and we
should have WS fed support for all those
banks and governments and witnesses
dedication obviously needs to be running
on Windows so it requires iis and it's
just against local demand joint servers
we don't do impersonation by default
anymore which is something that we used
to do in the dotnet framework so you
could say if someone is logging in via
integrated off I can I pretend to be
them it causes some rather interesting
scalability problems so if you are going
to need impersonation you will have to
manually impersonate just around the
little bits that you need to like
database access for example so we threw
away custom identity classes you can no
longer really use a custom identity our
custom principle everything is claims
principle best we can have multiple
authentication
it was middleware and one it's not just
providers in two they don't have to run
automatically basically you could allow
your users to log in with cookies but
then have an API that needs a job token
and it will magically work as long as
you remember what the right spell to
make it magically work is only one
middleware will run with every request
so there is one middleware that will
always look at a request coming in and
try and construct an identity out of it
if you will have to choose which one
that is normally it's cookies and if you
are using cookie authentication we
finally got to the point of
understanding the difference between you
being unaffected gated are you being
authenticated but not allowed to do what
you want to do so 401 versus 403 because
we sucked at that and the dotnet
framework and we fixed it in two well
okay so the support
for multiple middlewares was a great
idea but we kind of budged it it was far
too easy to configure more than one
default middleware and then you put
yourselves in what we politely call an
unsupported experience which basically
means we have no idea what's gonna
happen and you're on your own so we fix
this
sonication into is a single service and
then you plug the authentication pieces
into that service so it's like a little
di container all of its own so we fixed
they're active versus passive stuff and
the selection of multiple middleware so
now you can't send yourself into a spin
and finally I got rid of two factor auth
fire
SMS or email if you go file new project
in asp.net 2.0 you will see that we
support Authenticator apps which is nice
because nest has been saying for a long
time don't use SMS for your two-factor
off because it's incredibly easy to
social engineer your way through the
very lacks security on American mobile
networks and steal someone's phone
number so I can I can vaguely demo this
it's not very exciting here is our
template and if I can find the right
project there we go
so I start our project we run it and
it's going to do everything that you
expect it to do except by default it
doesn't generate a QR code for legal
reasons kind of legal reasons if we use
third-party software we have to put it
through a bunch of code scans and we
also have to make sure that it's
supported if it's an active open source
project and I haven't found one yet that
meets all our criteria for QR codes so
if I log in so we're not like to ship it
I am however I like to document it and
say this is how you can do it so that's
what I've ended up doing when you use
the templates you will see that when you
run things there is a little line of
code
that says go to this this documentation
website and it will tell you how to
generate QR codes and I have done this
in this template so when this eventually
wakes up yay I can go here we've made a
count mine's a little bit prettier I can
then choose to configure an
Authenticator out with a QR code yay
people have been wanting this for ages
and it's been sort of sitting there in
asp.net core wom one it's just we never
wired it up because we hadn't tested it
properly so you can get your
Authenticator apps and that should
hopefully make everybody happy
many of you have been using doclet core
1.0 not enough of you I I dislike you
all immensely ok fair enough so if you
are porting things from 100 to 200 how
many of you have tried this how many of
you tried it with the release candidates
yeah
how many of you that then tried your
port from the release candidates to RTM
- one of which is Dominic who writes
identity server so he does not count so
it's a little bit painful it's even more
painful if you move to rc2 because we
change things for our TM so I apologise
to that other one person this was how
you configure things in 1.0 you had used
cookie authentication and then this is
how we change things in 2.0 you have apt
use authentication in your configure
method and then you add a fabrication in
your services and then you chain off all
the authentication handlers that you
want if you will note that our way of
fixing you of stopping you messing up
having multiple handlers is now the
options for authentication middleware or
handlers is set at the authentication
level rather than the individual handler
level so there are a bunch of defaults
if you're using one you can just use
default scheme you
using multiple ones well you have a
choice if you start using social off
which is what file are likes to do in
all his demos we know make him do a
little bit of extra work because you
have to configure the default
authenticate handler which is the one
that runs in every request and
constructs an identity default signing
handler which is what gets called when
someone calls sign in and default
challenge which is what gets called when
someone hits challenge for example by
encountering an endpoint that has an
authorised attribute on it so if you
were using Twitter because it's Fowler's
example and I like to be helpful you
would set the Authenticator handler to
be cookies because you want to use
cookies to persist your identity you
have sign-in being cookies because you
want to have your identity persistent
but challenge would go to Twitter
because that's what you want to actually
perform the little login dance
we moved where authenticate challenge
and sign in was from contacts
authentication just up to context so you
need to search your code for context
authentication and just remove
authentication you will get warnings
about deprecation if you tried this in
our c2 we have the warnings on some
things and not in others because we suck
and we like to make life difficult for
you but the warnings are now finally
there in the RTM code so one of the
questions we get asked where the
scenarios we get asked a lot is cookie
if education with asp.net identity
asp.net identity is the bits and pieces
that keep your username and password and
roles and claims in a local database but
people don't necessarily want to use
that because it's a bit of overhead and
my god it's really hard to understand
sometimes so people want to use the
cookie middleware on their own because
rolling your own encryption scheme for
identity cookies is a really bad idea so
I'm gonna walk you through how we do
this just because it is such a common
scenario so everything is going to end
up in your cookie middle or your cookie
Handler and we will encrypt and sign
cookies for you when you call sign-in
and by default that uses our data
protection layer which I'll talk about
later but we have a keychain that you
need to synchronize between multiple
servers if you are going to run with
multiple servers which a lot of people
are you could just shove them in a
database you can shove them in Redis you
can shove them in a shared folder you
can shove them an azure key vault you
can write your own it is incredibly easy
and then the cookies will take the
identity on every request and rehydrate
it so in order to do this you have to
sign in and sign night calling HTTP
contacts that's sign in and HTTP
contacts that's signing out you just
give it a principal and it will write
the cookie it's magical but when you
drop a cookie it's the sole source of
truth we don't go back to your database
we don't check things for you as long as
that cookie exists we're gonna take the
identity from it until you implement a
validator which asp.net identity does
for you so if you think about it you're
probably gonna want to do this every
time there's a request or every certain
number of requests you want to check if
a user is still valid if you haven't you
know banned them for posting poop emojis
on your message board so you need to
hook in a validator and a validator can
either reject your principle or it can
actually update it which is handy if you
are changing the roles or the claims
that are associated with the user you
can even go further
asp.net identity uses it to support sign
right everywhere so if you have someone
who has logged in for multiple browsers
or from a phone for multiple machines we
use the validator to sign out every
single one at once and it runs on every
single request it's up to you to
throttle it it's up to you to throttle
it going back to your database which you
will want to do asp.net identity runs it
about every 15 minutes you can customize
that in asp.net identity so this is what
a validator looks like it's nice and
simple hey it's is ooh a static class
which means there is no di you're gonna
have to manually do that yourself I'm
afraid eventually it will turn into a
service but we had so many
other things to do that we did not get
rid of it so that's how you wire it up
and let's just go through our very
exciting demo cookie off from scratch
here we go says startup so we have an
account controller that is going to log
you in and this is pretty much the
standard account controller I'm just
going to construct a principle here and
then I call sign in async I give it a
scheme name which is just a string that
is going to identify your handler so you
can have multiple instances of cookie
handlers for example but you need to
tell us which one you're going to sign
into you pass in the principal yeah
tweak how the cookies gonna live
somewhat and then you do a redirect to
local we're wiring it up and start up so
we have used authentication and
configure and then in configure services
we're going to add a sent ocation we're
gonna tell it that we want to use our
cookie middle wire that we're about to
add and we're just going to use the
default scheme and then we add our
cookie underneath and you can see here
that we are validating a or we are
wiring up a validator just to prove the
validators work so I have a simple
validator that if I hit refresh enough
times it will update my principal so
it's just gonna pretend as if I was in a
group and I'm gonna update group so if I
run this
it will eventually start I blame your
Australian internet so I have loved him
once so I have a kind of once and then
if I hit refresh 1 2 3
I hit 5 the validator is going to kick
in and update me every 5 requests and
you will see that number keeping going
up and up and up so I could just lock
myself out
I could have updated my name I could
have changed the roles that I'm in or
the claims that are associated with Mike
Mike claims principle so if you are
doing cookie middleware or middleware
act it's not middle wearing wear its
handlers if you're doing cookie
authentication with our handlers by
default wire up a validator so you can
keep the identity up to date with
whatever your back-end thinks is there
so like I said we can have multiple
handlers so we could have cookie in one
point we could have jot somewhere else
and you can tell the authorized
attribute which handler you want to use
by specifying the scheme name that
string that says this is the identity of
a handler that you have wired up so what
used to happen was that people would
wire up Joe and people would wire up
cookies and then your API would accept
both where as I'm sure we all realize
that API should not be accepting cookies
anymore because there's a bunch of CSRF
vulnerabilities that you really don't
want to deal with so you can limit the
identity that is accepted by specifying
the scheme name so this was where I was
going to demo my 2.1 stuff but I've been
talking to the dev when we spent the
last three days trying to get the damn
thing to work and it does not because it
requires asp.net core 2.1 and i've tried
to install that and it destroyed my
machine and i had to pull it out again
and then it just got very messy so i'm
gonna have to talk about this in theory
i am sorry there are no demos we've the
the cookie auth flow has has been well
it's been our opinion of how things
should
happen but identity has a bunch of
standards around it and one of these is
open ID Connect so we have been thinking
and we will probably deliver a slim
opinionated open ID Connect service in
asp.net identity so the flow will look
slightly different the URLs that you
will have will look like standard oh I D
see URLs and we'll be logging in with oh
I DC before we use cookies to drop an
identity so this is kind of nice because
it's decoupling your app code from your
authentication code so it can just be
like hidden away in and you get packaged
and it allows you to support external
clients first party clients third party
clients you can write your own mobile
app and use the OID C pieces to log in
and if you get to the point of being
sick of managing your own databases we
hope to get to the point of having a
button that will take your local creds
your local identity store and just shove
it into Azure b2c so you never have to
worry about it again if you don't like
as your b2c there are other options
because it's using oh I DC so it's nice
and standard we're only going to support
authorization and hybrid code flows and
implicit for spa applications so you're
no longer using cookies for spas if you
want to use more than we give you and a
lot of you will then Dominic is sitting
at the back row there with identity
server and that's where I recommend you
go he supports an awful lot more of the
OID C standard than we do like I say we
are giving you a skinny opinionated one
that only supports two or three common
scenarios identity server is the big man
Oh IDC server for dotnet so if you want
more than we give you you can plug in
identity server and because we're going
to use the OID C it is a matter of
commenting out use asp.net identity
service or whatever we're going to call
it and replace that call with you app
don't use identity server and that's it
that's why we want to move to OID C so
you can swap with one line if
code and it worked in our situ and then
we yanked out because we didn't think it
was ready and it doesn't work anymore so
I can't demo it it was impressive when
it worked I promise you it looked really
good in Oslo so you have your options of
identity server ASOS and open eye dict
which are the the three dotnet
third-party ones or you can use Azure
b2c authorization for those of you that
have not used asp.net core this is where
we changed everything how many of you
have written your own custom authorized
attribute ok keep your hands up now
drop your hands if you thought this was
easy and didn't suck real I have three
people drop their hands Wow okay yeah
okay we know this sucked and it sucked
hard so we decided to redo everything in
dotnet core which upsets some people
case we can't make everyone happy all of
the time but most people have been happy
with what we've done you do not need to
write your own authorization attribute
anymore in fact if you do it won't do
anything the authorization attribute in
dotnet core is just a marker and what
we've been trying to do is we be trying
to remove hard code rules are hard-coded
rules of attributes things like user
names claims groups whatever else we
have moved all authorization into code
everything is based in a policy and
requirements and requirements handlers
so your policy says the current user has
to fulfill one or more requirements and
then each requirement may have one more
handlers that will tell the policy the
current user has fulfilled those
requirements and we've also added
resource based authorization because
Dominic had been on RS for absolutely
ages to do it and it fell nicely into
this it's all putting di like most of
asp.net core is these days and you still
have your scheme filtering and you can
even replace the entire thing if you
don't like our implementation
and have your own policy provider there
is a workshop which is their the the 2.0
stuff was for 2.0 RC 2 and I have not
gotten around to updating it because all
the internet sucks and I can't even sync
my repo I've been trying for three days
it's just not a pleasant experience so
when I get back next week it will be
updated for 2.0 RT M if you are one of
the two people that logged a bunch of
issues this week saying it was broken if
you are in the room I'm sorry I will get
around to it when I get back and I have
internet again so let's talk about what
requirements are if you have ever been
to Microsoft in Redmond and I assume it
is exactly the same for the various
offices here you will see people using
their badges to scan into a door so
having a badge is a requirement for
opening a door at Microsoft so we can
express this as G an office entry
requirement and all it does is you
implement I authorize a shin requirement
which has nothing on it it's a marker
interface and then we have our
requirements so we have to figure out a
way to handle them a way to process them
so we have one or more authorization
handlers against each of our
requirements so here this does actually
have something on the interface handle
requirement async I'm gonna look at the
user I'm gonna make sure that he has a
valid badge number I'm gonna make sure
that it's issued by me and if it is
everything's good if it isn't I'm just
gonna return so you call contact succeed
of the requirement if everything is good
everything is bad you do absolutely
nothing at all because you may have
multiple handlers so the normal way of
handling entry is to tap your badge but
if you are like me about once a month
you forget your badge because you're in
a rush and you have to get this little
sticky badge of shame that gets printed
out from a thermal printer and you can't
see the picture and their reception has
to open the door for you so that is
another way of fulfilling our
requirement I have a temporary badge
that hasn't expired and there's a
action is there to press the button so
we have one requirement but two ways to
fulfill it which are two different
handlers and the reason I recommend two
different handlers rather than just
having one great big handler that checks
absolutely everything and branching is
well that stuff's hard to maintain but
you can reuse handlers over multiple
requirements so you could have for an
example if you were rewriting SharePoint
and someone really ought to you can have
do I have permissions to put a document
in this library normal user would have
permissions and you would check just by
looking at what the user is but if
you're an admin you may have rights
everywhere so you could have an is admin
handler for every for everything and it
would run across all your requirements
so rather than doing things in a branch
and duplicating all that code you just
keep things in little individual
requirements and apply them using policy
and away we go
and then how we express this it's when
we're adding authorization we add a
policy and we're gonna call this policy
building entry and then we build up all
our requirements and then the one thing
that I always forget to do when I am
writing demos and I'm sitting there on
stage going why doesn't this work is you
need to register the handler for the
requirement in the DI system because I'm
lazy and because badge Hamner has no
state I can add it as a singleton but
you can add it using the various scopes
if you want to do things like inject
your database into your handler that's
absolutely fine just never do it as a
single thing because that will be a
nightmare and then you specify the
policy on the authorize attribute by
giving by specifying this name and away
we go
this makes more sense with a demo like
most things so this is that this is the
actual really technical demo that we
have the the soul one so I'm gonna say
this is a startup project and I'm gonna
run it and I'll see what it looks like
in a big screen you will see how
beautiful my UI skills are so I have
noticed whilst I have been walking about
that you guys think this is
old despite it being 20 degrees I was
wandering around in shorts this morning
at 6 a.m. and everything woman was
looking at me like I was mad so here we
have my emulation of Australian weather
and travel as you can see it is winter
I'm using a snowmen because all Zee
winter would probably just be a beach so
will will make this perfectly clear and
we have two options we can go outside
and we can go inside and we're going to
evaluate whether someone is allowed to
do that based upon who they are so if I
go outside it's going to ask me to log
in so I picked famous people we have
Daniel Radcliffe because he's British
we have Rupert Grint because he's ginger
and we'll come on to that in a minute
and then we have Steve Irwin I'm not
gonna say anything bad about Steve Irwin
so we'll go back and we will remind you
that I am I am in Australia and it is
winter and I want to go outside so I can
go outside because I am Daniel Radcliffe
and it's okay if you're British going
outside in Australia winter because it's
not cold what is wrong with you people
okay
and of course I can go inside because
there's no problems with going inside
just a quick reminder to check for
spiders in the dunny but because it
doesn't eat just makes me laugh isn't
work so I'm gonna sign now I am no
longer Daniel Radcliffe it is winter I
am going to go outside I'm gonna be
Steve Irwin oh my god no it's too cold
you can't go outside because it's only
20 degrees now if I go back and change
it so it's summer Steve Irwin can go
outside because apparently it's an
acceptable temperature and he won't
freeze if I say night I try and go
outside again in summer but I'm Daniel
Radcliffe no it's to time war
40 degrees is not an acceptable
temperature what are you thinking living
here okay so we are adjusting our policy
is evaluating who someone is what their
nationality is and what the current
weather is and just to be mean to
gingers because that's who I am
Rupert Grint obviously can't go outside
in somewhere in Australia because he's
ginger and he will spontaneously combust
if I go back and change the weather to
winter it's 20 degrees he still can't go
outside because it's too darn sunny and
he walks spontaneously combust
so for Rupert Grint it doesn't make any
difference you cannot go outside in
Australia so we're gonna look at the
code now I can't do these sorts of demos
in in America because they just don't
understand the ginger thing they think
gingers are real people I should look
around to see if there are ginger people
in the audience that would probably
would have been a really clever thing
today all right I'm not looking up
because there probably is one than
they're glaring at me right now when
they're trying to steal my soul so is
there anyone ginger in the audience
still wants to read yeah you saw our
ginger and bald so you're fine so I have
a weather provider at the equivalent of
some sort of database and so I am
injecting that into my di container and
we will be using that in our policies I
am setting up a policy of inside and
setting up a policy of each site so what
I have done with my requirement is I am
making it a parameterised requirement
remember requirements have no code but I
can stick properties all them all I like
so I'm going to use the same requirement
I'm gonna have a location so I can just
branch based upon it and then we have a
handler and it's going to take our
weather provider in so I know what the
current weather is and then I'm going to
look for the nationality of a user
because I'm recycling their demo from
Europe and I did stuff with past
or control and Briggs it and then just
made myself very very sad because I
changed it to before and after breaks it
and to reason me I got rejected from
Europe just like she should have been
rejected in the polls however I can
laugh at that but I mean I stuck with
Donald Trump as a president and that's
just even worse I got I got stopped by
one of the charity muggers yesterday
when I was walking around in my shorts
and he was like how much do you like
nature and I'm like I don't even live
here and he goes how much do you hate
Donald Trump Wow my accent has changed
so I signed American to Australian so
that's really depressing so I'm gonna
get the country is someone's identity
which I've shoved in via the account
controller and I'll log someone in we're
putting their name in we're giving them
a hair color so we can you detect Rupert
Grint we're giving them a country so if
it's outside and the season this summer
that's come from RDI and you're British
it's Phi or it's it's not good so I'm
not gonna do anything but if it is good
if I'm Australian and it's not winter or
if I'm British and it's not summer I'm
going to succeed my requirement and if
I'm going inside I'm always gonna
succeed in my requirement now I could
expand this I so you know Australian
people could go outside in winter if
you're all wearing five layers and hats
and scarves and at 20 degrees there are
fire pits lit and fire lamps and the
outside of the pub as I saw in Melbourne
at the weekend and laughed very hard at
so does this make sense as a requirement
and how to fulfill it this is the sort
of thing that you would have had to
shove behind your custom attribute
before which was incredibly hard to test
policies and requirements are incredibly
easy to unit test this does not help
Rupert Grint however so I've got another
requirement I have or I've got another
requirements hand rest I've got a single
requirement but I have two handlers and
this handler is especially for gingers
and it's gonna check that I have a hair
claim that has come from the passport
control and if you are ginger
and you are trying to go outside and I
don't care what season it is I am going
to fail I haven't covered failure yet so
there are three things that you can do
in a handler you can succeed this
current user fulfills all the
requirements you can do nothing that
says they haven't fulfilled this
requirement but another handler may
kicked in and you may fail and fail is
there for those scenarios where even if
other handlers have succeeded fail
overrides everything it's the sort of
thing where you use where your database
is on fire or someone has been sacked
but the the system's have not updated
yet and you have a specific check for
sacking or they're ginger and they're
going to spontaneously combust because
they're in Australia so we have two
handlers for a single requirement and in
start-up the CS I remember to put these
handlers into DI because I'm not doing
this life because this is where I always
forget and because they're taking
requirements that are pretending to be a
database I'm going to add them as
transient and then all my location
inside is going to in the code say that
I am authorized I'm going to use my
policy for inside and if outside is got
to use my outside policy what I would
recommend is that you never use strings
you end up having a static class that
then where's my static class let's go
find it go to definition yeah so you
just have a static class that then
exposes your policy names as constants
so you can change them at whim so does
that make sense is that easier than
writing a custom authorized attribute
there's no one going to admit to that
cleaner by default yes it's a little bit
less flexible the complaints that we
have heard a complaints is a strong word
the feedback that we have gotten is that
people who have written custom
attributes generally have put custom
properties on them and we don't really
have support for that properties are
part of your requirement so we're going
to revisit this in 2.1 and see if we
have a nicer way of giving you the
ability to write custom attributes that
still don't have code but you can put
your own strongly typed properties on
there so you can start building rules up
or requirements within your custom
attribute there is an issue on the
security repo about this if you have
strong feelings about it I would advise
that you go check that out and leave us
your comments but no complaining about
the fact that I'm just picking on
gingers so here's a quick summary of
where we we're with policies
requirements and handlers there's no
point in me going through that again and
here is what the handler should return
generally you just want to call succeed
or do nothing at all because of multiple
handlers for a requirement and because
it's a service you can check all of this
in code you could in your controller or
your race or page because everything is
cool and trendy with razor pages if you
listen to Damian yesterday or the day
before you can inject the authorization
service into your code and then you can
call authorize async and you don't have
to duplicate that stuff that you had in
your custom attribute somewhere else if
you failed
you can return forbidden result if you
want to tell someone that they're not
allowed to get in or you can return
challenge result and it will flow
through the log a flow again and then
hopefully they can login with with an
identity that has access just remember
to register your handlers and one thing
I will say is I've seen people write a
bunch of stuff and they're like oh well
no one's ever gonna send me an identity
from someone else really okay
especially with Eli DC it's great you
should be everything should really be
claims-based now rather than doing
something like checking rolls or
checking someone's username so when
you're checking clams check the issuer
for the clam to make sure it has come
from where you expect and then we have
resource based authorization which is
just a little step further
taking the SharePoint example there's a
document in a library and you want to
check permissions whether a user is able
to edit that document or delete it
that's not just a requirement on can you
access the library but it depends on the
resource that someone is trying to
access so we have the same thing again
with policies and requirements and di
and on our little system that you can
pass a resource through to the
authorization service and you can pass
an operation through or a requirement
through that says this person is trying
to do X on resource Y and then you can
pick apart the properties from resource
Y and in our SharePoint example you'd
look at the document author property and
see whether the document author is equal
to the current user or not and let them
do it all you'd have another handle that
says are they admin will then they can
do what they want
so you just extend this out instead of
having an authorization Handler that
takes in a requirement you know take in
the requirement and the resource that
you want to check it's just an extra
parameter so if you've already gotten
into writing policies you should be able
to write resource authorization handlers
if you want to authorize absolutely
everywhere that's how you do it you just
build a policy and you register it as a
filter because at the end of the day
policies and attributes end up as
filters and you can limit by scheme in
policy so if you're having API rather
than putting the scheme name in the
attribute because everyone will forget
you can actually enforce it in a policy
itself and because we have things as a
service you can actually inject them
into razor or
if you're putting this doesn't really
apply to razor pages you would just
inject them into your page and brunch
based upon it so if you are a horrible
person because people get really upset
when I say you can do this you can in
your razor page inject the authorization
service call authorize async and then
vary your UI based upon that some people
don't think that's clean they would
rather put what's going to be shown or
not shown in the UI in the view model
but if you're lazy or you're writing
demos for presentations you can inject
the authorization service into your view
the only thing that I would remind you
to do because our interns do it every
single year is it's all very well hiding
things in the UI but even in your
controller just do the checks again so
for example we give our interns every
summer a blog system to write it's like
here you go you know what a blog system
is why don't you go away and write one
and make sure that you have
authorization and authentication and so
they will end up adjusting the view so
if you're not logged in you don't see
you edit and then I go okay what happens
if I type edit in the URL and they're
like oh because they haven't duplicated
the check in the controller so just
remember that hiding things in the UI is
not enough and if you hid all of that
you can replace it because everything's
a service so you can write your own
policy resolver you can write your own
policy provider and you for now until we
fix this custom parameter problem you
could do parameters this is sort of like
stringify the the policy name it's
incredibly ugly but you could just
separate stuff with dashes and split it
up and get parameters that way data
protection
how many of you had to synchronize your
machine key across multiple machines to
make everything work for those of you
that have done that how many of you have
then changed your machine key after
deployment not a single hand goes up how
many of you tried it and then yeah okay
and it was bad wasn't it it was like I
have to deploy this exactly the same
time to every single machine or
everything falls apart
I am sorry machine key was a bad idea so
it's not there anymore well you have
replaced machine key with data
protection which is a little bit more
complicated but does allow you to change
keys without having to synchrony with
out having to republish to every single
machine data protection is aimed at
ephemeral data it's stuff that you can
throw away you don't particularly care
we use it for our authentication cookies
we use it for a bunch of tight providers
that go into rezard the temp data
provider and stuff like that stuff that
you can recreate now people have been
using machine key to protect data of
their own so despite all of us saying no
this is only for ephemeral data we know
that you're going to use it for non
ephemeral data because no one ever wants
to write their own crypto code so it'll
work you just have to be very careful
about where your keys are stored and
that you don't lose them so we have
taken away the ability shoot yourself in
the foot machine key was incredibly bad
at that you could encrypt things but not
sign them if you were at my presentation
two days ago you won't know why that is
a bad idea
it will provide isolation automatically
it will provide isolation on purposes
automatically and it will try and figure
out where your key should be stored
based on your platform and you can even
write your own custom algorithms that
are going to be used for encryption this
is not for you this is for Russians
because no seriously Russia says that
you must use our Russian encryption
algorithm if you are storing data in
Russia China has been mulling over the
same thing
I've seen how your government talks
about the internet so at some point you
may end up doing this yourself as well
because apparently the laws of
mathematics do not count when it comes
to encryption and storing data and the
Australian government would like you to
break the laws of mathematics so they
can spy on people's IMS in facebook but
you can do it just don't so when I say
that we are going to make all your
choices for you security people tend to
get very upset these are the minimum
ones we don't allow you to go any lower
than this and you can send this to your
security people and go here they are
using good defaults so what we have is a
keyring and each keyring has a single
master key in it to start off with in
every 90 days a new master key will be
inserted into the keyring and everything
will roll over slowly by default so we
create a new master key probably about
three or four days before the 90-day
period is up to make sure that it syncs
and then everybody sort of flips over
around the 90 day period because the
data that we encrypt has a key
identifier at the start and says I'm
gonna use this key and then when system
number one starts using the new key
system number two no it's using the new
key so we can go and check for it we
derive keys based on purpose in every
single payload so if you encrypt the
same data with data protection twice the
result will not be the same because that
stops people trying to figure out parts
of what your debt is so we're gonna use
AES g56 CBC and H H Mac sha-256 we give
you some key stores if you're running an
azure Web Apps it's all done magically
for you the key store will flow between
all your instances until you use slots
because as your key vault have not given
us storage between slots and lots of
people use slots to swap stuff over and
then we're back into the same problem we
have with machine key where everything
is out of sync so if you use slots this
is not what you want to do if you are
running a and we'll come on to what you
do want to do in a minute she usually is
with no user profile which I think's in
the registry for using is with a profile
which is what you're doing in Visual
Studio we store in app date
and then on Linux because Linux has no
good security story by default we store
the keys in memory and throw them away
afterwards which is why we say this is
targeted at ephemeral data if you want
to use it on your own data you need to
make some changes to the defaults we
will protect your keys as well if you're
on Windows we use DP API if you're on
Windows in an active directory will use
DP API and G which just means that
everything flows nicely you can use next
509 certificate or you can just not
protect it at all which is probably not
a good idea for your encryption keys you
can do it manually
lots of people do you create an ID a
protection provider you create a data
protector with a purpose from it and
then you call protect and um protect
with your data and that's it so here is
how you would do it we are using the
ephemeral data protector just to remind
you that things get thrown away
we have purposes and purposes are
allowed to provide isolation so the key
the the purpose might be slightly
different for example you want to
encrypt someone's credit card number not
that you would ever store a full credit
card number because then the bank's get
really upset but we'll take this as an
example you would store your credit card
number using one purpose and you would
store perhaps someone's address using
another purposes so the same key can't
be used to decrypt both don't use user
input for this that's an incredibly
silly idea it means that an attacker
would be able to construct a derived key
that might not be the one that you want
so we have configuration points the key
stores the encryption algorithms you can
serve like up up if you're in Russia and
you can change the key expiration policy
so if you don't like ninety days you can
lower it to thirty please don't set it
to one we set it to one just to prove
that the key rolling works which was
quite fun but that's just a bit too much
work for your per application and there
is a forward compatibility package for
don''t 5.2 so the reason we have a
forward forward compatibility package is
people want to be able to log into their
dotnet frame
app third MVC one two three four or five
app and shared the authentication cookie
with a core app now we're not gonna
reinvent machine key in core that's what
we used to use on frameworks so we took
data protection and we put it into the
dotnet framework so you have to pull
your dotnet framework app up to make it
work with dotnet court rather than
crippling dotnet core and sucking it
down into a vortex of depression so
configuring services nice and easy
everything's a service we will add data
protection then we will choose where we
are going to store our keys and then we
are going to choose how we protect our
keys and then finally we set an
application name because then we have
isolation between apps if you want to if
you want to share data protected data
between applications then you need to
set a static application name that is
the same for all your applications you
want to write your own I XML repository
and we used XML because it give us some
nice encryption capabilities and there
are only two things you need to do you
need to give it a way to get every
single key and you need to give it a way
to store a single key so it is honestly
easy to write your own one of these in
2.0 we now allow you to protect your
keys with an x.509 certificate
everywhere we only did that in the
desktop before because encrypted XML was
not in core and we have kevo if you are
running in Azure and it will use
certificate stored in key volts to
protect your data now you still need a
backing store because like I said this
is the protection provider so it layers
on top of where you are storing your
keys but we have we have ones that are
suitable we have blob storage we have
Redis then and we have local filesystem
someone wrote one for MySQL I've seen
one for sequel Lite and it's only two
it's only two things that you need to
implement so it is easy to do so back
compact we have our yank asp.net up
package for cookie sharing the docs are
a little bit weird
so I have my current version of of how
to do this sitting on that github repo
and we just did some general stuff the
HTML encoder all our encoders are based
on safe lists rather than exclusion
lists because generally that's a better
idea the HTML encoder is quite
opinionated and what it will encode and
not encode by default we will encode
basic English I'm sorry we will leave
basic English alone but as soon as you
start wandering off the basic Unicode
plan if you are going to go to Chinese
plans or Russian plans or Japanese or
engine hieroglyphs of which there is a
code point for in Unicode they will all
get encoded by default in your HTML and
then people go well my HTML is very big
and I say that you can configure the
HTML encoder so if you know that you're
going to use those characters and you
consider those characters safe you can
turn off encoding for each code table in
each of the Ãºnico stuff now people go
well of course they're safe if anything
it's it's the basic English ones that
are unsafe and that's probably true the
reason why we're being paranoid is that
browser security sucks especially IE
and that we have seen too many bugs in
the handling of Unicode code points in
browsers so we're gonna be very safe and
very paranoid by default and if you want
to take the risk you can just turn off
the encoding we have CSRF cross-site
request forgery you can actually turn
the checks on automatically now we have
a way of accessing your eraser for use
in JavaScript so you don't need to do
all sorts of ugliness if you're using
razor pages razor pages will both insert
and check the CSRF token for you we
can't do that in straightforward MVC
because it would break too many people
and I don't want the complaints we have
Coors middleware and the one that spent
four weeks of arguing with mr. Fowler
about
was the default for environment how many
of you have deployed an old application
up and forgotten to turn debug off and
had a yellow screen of death with your
stack traces when a user hits an error
the rest of you are lying so by default
now and all asp.net core application is
the default environment is release you
have to jump through hoops or run your
code from within visual studio to set
the development environment to
development and all our templates use
environment checks if is development
then we're gonna put in the full stack
tress error so when you shove them up to
a life server because the default is
release
none of that code runs so we're being
safer by default this is how you enable
automatic CSRF validation this is how
you get the CSRF tokens and views now
finally we have secrets far too many
people check in their encryption keys or
their machine key and web config on
github including certain people at
Microsoft you have done it in sample
code so we have the concept of Secrets
if you're looking at settings in asp.net
core a lot of things will come out if
you're saying start JSON file but if you
go to a sure for example and set things
for your application those get shelter
in environment variables so your secrets
can end up in environment variables and
that's absolutely fine because you can't
check them into github but what you do
during development you don't want to
mess around with environment variables
so we have a secrets manager that puts a
secrets file in your user profile way
way out of where your source code lies
so you would have to copy it and do all
sorts of really really dumb things in
order to put it in your repository we
have support for as your key vault
putting your secrets if you don't like
environment variables but of course
that's not on Linux so you're stuck with
environment variables there so that's
pretty much it is a quick run-through
what we've done which will hopefully
make most of you happy for those of you
that do want custom properties on custom
authorization attributes please go to
the asp.net security repo on github and
give us your requirements it is the top
issue right now we will listen and we
will try to make you happy so I have who
just tweeted about my presentation I
have G one minute which is great because
it means Dominic can't ask a question or
make a comment and embarrass me does
anyone other than Dominic have a
question everyone's staring at darling
now hello the person next to did Dominic
tell you something to ask what was the
question is what was the solution with
slots and dinner protection you would
end up using blob storage or as your key
vault to store your data protection key
ring in rather than letting Azure do its
thing and storing it in a secret place
on the what's not exactly secret you can
find it quite easily by looking at the
code but as a directory in the file
system so if you're using slots use as
your blob storage now remember when we
put things in blob storage it's not
encrypted by default so you still either
need to use an x.509 certificate which
gets deployed across all your slots
because they'll do that for you
or key vault to hold an x.509
certificate to protect the stuff that is
in blob storage anyone else have a
question or we all just want in our like
sweets and sticky buns as we run to the
next session now great oh here's an easy
one
when do I expect two point one I refuse
to answer that because I am NOT Damian
we do not publicly comment on when we
will release stuff mainly because Fowler
does something unhappy and then I have
to go no we can't do that and it gets
delayed a week or two I honestly don't
know we've started writing it now if you
look at the daily build server you will
see that there are daily bills for 2.1
but i have no idea when it will come out
that it's not my decision to make
damian gets paid far more than me to
make that sort of decision and I'm not
about to undercut him or second-guess
him nice try though
thank you very much I hope this has been
useful the code and the slides will be
available in about 20 minutes off my
website thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>