<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Let's talk Auth - Jordan Knight | Coder Coacher - Coaching Coders</title><meta content="Let's talk Auth - Jordan Knight - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Let's talk Auth - Jordan Knight</b></h2><h5 class="post__date">2017-01-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/gaGF1imyfDg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">having this conference down in Sydney
you guys familiar with NDC sort of
before this was here like did you see it
here and you're like got to go to that
yeah awesome it is it's just really
fantastic to see such world-class
conferences and world-class speakers
coming coming into into Australia so
awesome to whoever's running out my
name's Jordan Knight and I'm a Technical
Evangelist with Microsoft here in
Australia and I'm going to talk to you
guys today about perhaps one of the more
interesting topics in computer and
software developments and that of course
authentication so you guys are really
excited by authentication or scared by
it scared of it excited by it yeah 10
occation we should all hang out like you
guys are weird I don't really like it
like it's one of those things that you
sort of get to know because you have to
get to know it but um you know it's
difficult it's hard to know if you're
doing authentication right you it's just
one of those things where you go sort of
try and tuck it away to a project and
that's it's done and everything like
that so today I'm actually not going to
show you guys any radical new
technologies or some sort of hot new
york education system you guys need to
hear about that's coming out next week
oh I'm not not going to show you guys
some you know wicked custom
authentication system that we built from
the ground up and over engineered and
you know you guys should totally check
out what I'm going to do is actually
take pretty much off the shelf for ten
occation pieces you may or may not have
seen but at least most of them will be
familiar to you and go ahead and package
them up in an elegant way and i guess
some turn them into a usable product
that you and your team can can go and
consume later on so it so i guess
bringing in some elegance to that
authentication piece being in charge of
setting up new projects and i'm thinking
if you guys are here to learn about
authentication you must be involved at
least
on the end of it because it's not
something usually out of the end right
and so and it's a very important job
because you guys are setting it up you
know in your role as as software dev
leads and architects and things like
that it's I like to think of it that you
guys are actually producing a product
for your internal developers and then
they'll go and use that product to go
and deliver deliver the actual software
to market and blood products I mean it
can be in a really good architecture or
you know good base class libraries and a
nice setups and DevOps things like that
all those pieces that you do so then the
actual debt the actual devs on the
project don't have to worry about any of
that they can get on with the job of
actually writing productive code and so
many ways it's you could almost call it
framework engineering you're building
frameworks for people you're setting up
frameworks for other people to use and
so what I like to do in talks like this
is to take a very advanced concepts and
break it down and then the end result
will be an artifact or something that we
can we would be able to show you know in
a talk that's at a far less level than
this so we're going to take something
really complex and make it really simple
Serbian the last sort of one minute the
talk i'm going to say and here's what we
did and if it works you can all go yeah
it worked and if it doesn't you can all
just leave that's fine so I'm actually
I'm going to demo a lot today on asp net
core as well so there's there's two main
components are going to be demonstrating
we'll get to that in a minute and yeah
so let's get into it man that's a slow
animation so if you've ever set up a
greenfield project and you've gone off
and done that first little search for
authentication punch that into Google or
being whatever it is you go use you'll
know that it says that the stuff that
comes back the sheer volume of content
that comes back about authentication and
what you should be doing and the
different ways to think about an order
for the stuff is huge so it's really
really hard to know what you should
actually be doing it's nearly impossible
to sort of figure out you know what's
the best way and in what was the best
way yesterday might not even be a bit
wait today so the other problem that
we've got these days is that modern
modern systems don't just sort of sit in
one area they they span platforms they
span different workloads most that most
most systems that your builder going to
have a mobile app they're going to have
an API we're going to have management I
guess you know some sort of a website
that you can go and edit pink or
something like that so there's all these
different types of workloads and
products that you need to be able to
make your education system working and
it may not actually be straightforward
to go and do something like that and so
back to that net net search and I think
this it does it turns up it turns out a
lot of different stuff and I think you
can roughly group them into three
primary categories you've got the stuff
you write yourself you've got the stuff
that's half done in the middle there and
then you've got the stuff that where you
do nothing it's fully third-party
software as a service style
authentication and I mean they've each
got the benefits you could use whichever
one depending on your needs so we first
party basically you're you think of it
as like storing these name passwords
yourself so you've got lots of control
you've got lots of room and flexibility
to customize so there's also room for
mistakes and errors and if something
does go wrong it's on you so today and
you've got to spend extra time securing
systems you've got to basically you know
it's going to cost a little bit more in
software development i guess the second
the second category is basically a
platform of some kind with actually just
due to the authentication piece for you
but then you go off and sort of manage
the rest of it so it's like a little as
it's in a hybrid solution in many ways
so they're storing the passwords and
they're managing actual authentication
but you've still got a lot of control
over the code so but you do lose control
over the actual authentication piece
which may or may not we do and the third
kind deeds dump the fully managed
products so Jen Ryan or
spero things like that it's basically
another API that you're installing your
in your product and then off you go and
treated as such they're those systems
you can get off the ground up and
running really really quickly but
unfortunately they might be expensive so
if you've got like a diva many users
even just sort of twenty to fifty
thousand users you're going to find that
those products can get quite expensive
pretty quickly and as I said they've all
got their pros and cons and depending on
what are you doing you could recommend
any of those solutions it's sort of you
don't just say oh this one's definitely
the best it for every given scenario so
but it's more telling you guys like this
heaps of choice out there because I want
to want to put emphasis on the fact that
your actual products the code that your
writing is part of your product
shouldn't actually have any concept of
authentication once you once you're down
and actually doing the doing the
workloads that you guys actually trying
to produce them sell though that code
should have no concept of syndication
should be completely separate piece so
it shouldn't matter to your local code
or the coder your devs are working on
how the authentication happens they
should be able to just get a user ID or
something like that so separating out
the authentication away from the main
product i think is a really really
important piece for maintainability and
for upgradability in the future as well
as simplifying things for end developers
who end-user developers and in fact I'd
go so far to say is that that you could
actually take authentication out and
treated an entirely separate product
that's run potentially by another team
and then you consume that in your own
organization as if it was a third-party
products at someone else owned man those
animations
and so we've done a few projects over
the years before work to Microsoft's
leads to run a software company and we
build all sorts of things and ran into
authentication on many occasions because
we were doing bespoke software de belem
we had opportunity to do Greenfields a
number of time so we got to sort of
start start over a fresh each time and
apply previous learnings without having
you know in currencies of having to to
support it and things support an older
versions of product and so in in the
last few that we did we actually decided
to try a central authentication
mechanism and separate it out and so the
real code would really only be the real
code the non authentication PC actually
writing the API whatever would actually
only really be worried about
authorization and even then we make that
super easy as well so you might have our
products we had an API which was quite
scalable to this handling that the
mobile apps we had the mobile apps
themselves we need to be able to Center
Kate easily as well as a measurement
website services like that we made it so
then each of those products we could
actually very easily say yeah let's add
a new product that's got a syndication
because we didn't have to sort of
worried about cuz I separated out are we
gonna have to worry about how that was
going to work we could just know that
would work so there wasn't like this
discussion how we're going to a thinner
coat and so yeah I mean at this in most
efficient code I'm just getting through
the background story here a little bit
be the first part I'm just going to
quickly run you through the central
authentication site and there's no
rocket science in there really is just a
very simple website i'm just going to
show you it to set the context but then
there's sort of back half of the
presentation i'm going to show you how
we consume that and take it into a real
asp net web api and actually start using
it in a real product there's a link on
the bottom of every slide here to the
code everything i'm going to show today
is a lot github these days and so if the
deal is is that the central
authentication so it goes and gets an ID
token from as your better safe
now i'm just using a gob to see because
it's not quite out yet and i thought i'd
try it out but it could be any any
third-party authentication free office
365 or facebook or anything like that we
then go and get the token from there and
we actually transform it into our own
token so you must like I think a lot of
things in software development shouldn't
depend on an external dependency like
like an energy or something from an
external system you should as quickly as
possible bring that entity into your
into your own code so you might do some
mapping at least you have control over
it so if they change the entity later
you can still just fix this one little
piece instead of having to fix a whole
lot of stuff around the system and that
goes i think for assets that come out of
other systems including security tokens
so in this case you actually their maps
to claims through and that pretty much
this ends up looking like the same token
except we've generated it really being
as if we decide to go away from b to c
which is business-to-consumer and as you
are we can quickly pick that up and we
still generating the same token we can
also generate their own tokens whenever
we want so we can generate test tokens
and all sorts of other stuff so by
having that dependency shifted into our
code we're freeing ourselves up to do a
lot of stuff yeah we could easily put
you at B to C self 365 and Azure Active
Directory and all those other system can
rain or sorcerer or whatever or we could
run in side by side okay demo is gonna
be interesting because going to change
resolution and might explode everything
come out yeah
hey beautiful um so yeah so we've got
this it's going to go into here but the
central authentication host and I've
actually deployed it up to you are this
is done that cool site and it's
immediately redirected me I've hit the
home page to stick them Illidan and it's
redirecting me off to a gob to see now
gob to see is basically for consumers
account management system so it's like
authentication with some identity on top
so i can actually go in there and create
a new user and everything like that I've
set up the fields that I want to collect
and and as you'll will handle the
storage of those you know passwords the
reset you can do two factor
authentication and lifestyle features
doing it so and this talk is meant to be
about benefits more just demonstrating
of it I'm going off and I've decided to
have something external handle my actual
user name password for me I don't click
cancel and get a 500 euro and then we'll
try that again beautiful just me to be a
web page there in case I click cancel
but I'm already got a an account so kind
of log in with that so I prepared
earlier it's like been seasoned
approximately out yet and but it's a
value can try it out it's pretty cool it
seems to it seems to be on the right
track i think so what I've just got back
there is now the central authentication
host it just does one thing it's just
sent back a token that I've generated
and so the token format that this that
we're using is JWT a JSON web tokens
which is they called shot I think I
don't know how that works but that's
what I've heard a few people call it and
basically what these guys are a they've
got a header and then a full stop and
then payload which is the claims and
then they finalized by a signature and
the signatures of the important part so
I've just copied that token into JWT to
i/o and that's going to go and decode it
such as a base64 encoded string on the
right with
full stops in it you can see that the
full stop there that's can we yeah there
we go you can see the full you see the
full stop down there and that's that's
the full stop between the payload and
the signature on the end so the
important part is is that with some JSON
web tokens is that you can put whatever
claims and then you want then they get
signed with these some the signature and
then later on when you've got the right
key you can actually validate as a token
haven't been manipulated so by putting
claims in there and then letting them
out of the Central Los host into an apps
for example you can go to a non trusted
platform like an app that's in they in
the user's hand it's outside of your
control and then come back into your
system and you can check the crypto
validation on that token and if it
hasn't been modified then the key will
check out and so you can actually then
trust the claims and one of the claims
there is 0 ID and so that's going to be
the user ID when we get into our new
system the actual code behind the
central or post is it's up there and
available pretty much it's centered
around a couple of bits and pieces as I
said it's using HP net course so in asp
net core the way we set up things such
as vindication just for anything to do
with the pipeline and a management the
app is that we we use middleware and the
0 in pipeline and so what I've actually
done is I've had an extension method
here that I can call off from my startup
which I'll show you in a minute and
especially what it's doing it's going
off to settings and it's going to
configure the built-in open ID connect
options so in this case is your b2b to
see his arm based on technology called
open ID connect which is basically 0 off
to with some identity laid on top the
beauty is is that that asp net core
doesn't actually have any concepts of
open ID connect sorry ability but
because it's compatible it can go off
and and we can create a very precise set
of configuration or we'll say did take
me a little while to get it right but
once it's going it's been working really
well and so the reason why i put that in
extension method is because there's a
fair bit
he's sort of get going it looks a bit
messy and then we switch over to the
status of cs which is the main
configuration spot for HP net core and
you see my extension methods being
called there try and get some resume on
that and basically by tucking that away
an extension meta made it all nice and
neat and then I'm passing in a
configuration settings so it's been it
cause got some really cool new stuff
around configuration don't know there's
a couple of intro asp net core talks on
in this very conference so don't go too
much into the basics but i'm essentially
i'm looking for a setting there and I'm
passing it in from the app settings so
if I pop that up for a second I'm
looking for this ad settings thing there
it's got all the bits and bobs that came
out of the b2c configuration in there's
your portal I would show you that but a
really is justly configuration set up
web page it is very boring but this is
the stuff that it gave me to put in here
and so that's pretty much it so when I
run the guy I get that token and a
creative so yeah that's all I want to
show you guys on that piece I just
wanted to get through it so we know
where this token is coming from and
basically what it is okay
cool so some things in consider yes
there was a Jew better seat and i was
using their customers in the owen
pipeline with open ID connect options so
if you spot another authentication
technology that just using open ID
connection i think we'll start seeing
more and more of them coming through
then that will work as well and that the
reason why we can trust this totem and
we take it out is because it's signed
there is one thing with those tokens
though is that they shouldn't be made
public so you shouldn't ever send them
over an unsecured link if the user loses
them you might need a way to invalidate
them if they change their password or
something like that they really they do
really will represent the user so they
have to be very secure and yeah you
because of centralized the
authentication system you can integrate
with other systems later if you like you
can have multi-factor authentication you
can multi-tenant it so you could dump
have one central authentication system
setup and depending on what your posture
on the crew string you get to have
multiple different products using it so
we actually did that we added a second
product to the family and one of our one
of our solutions we're able to reuse the
same off site with some slightly
different settings to be able to go
ahead and do that and you can do pretty
much whatever your demo one okay so the
main part of the presentation is this
some how to actually consume this
authentication piece I think token
generation and setting up authentication
and stuff like that's cool but I want to
show you guys I think I'll i would
actually go about setting up a real
project to go and use this stuff to tuck
it away and make it really neat for um
for our users to to getting there when I
say is I mean steps in the team I like
to to make things simple enough that a
junior dev could come in on the first
day and I'll see a couple of questions
about what they should be using and
figure out how it works without them to
know any of the complexity underneath
so especially file new project already
just in the interest of time web
application to and the only other thing
I've done to this project after creating
it just before is a sporting a function
held part that just contains some of the
code for this demo I'll show you guys
the code but I'm not a big fan of
copying pasting each way per code in it
in a demo so what we've got here is
we've got this project and it's an API
Web API site so we've got a values
controller here and in the past we would
just go we just add authorization here
you go to probably seen that before the
authorized attribute and that should
mean that now I want to go ahead and
numb authorize that that particular get
operation on that back controller now is
not going to really describe what
happened so let's flip across him to
post me in and we'll just run that again
and you can see there that yes indeed I
was not authorized which is interesting
because I don't really know how I would
be authorized yet because in asp net
core there is no actual built-in way to
do anything so whereas a box there's no
concept of attend occation there's two
extension methods you can use to do it
but essentially when you first set up a
new project there's nothing in there so
it's just detected there's authorization
and its end there's no authorization
schemes present so it's just flat-out
denied it so we've got to go ahead and
actually add in some of those so we've
got we've got this token that we've
recording around with this all of a
sudden that token probably this say for
argument's sake it's coming in from a
mobile app that's logged into the
authentication site so that this mobile
apps gone off to authentication site and
come back and now ready to start talking
to the API the API sort of probably
doesn't really know where where it got
that token from or anything to any
concept that I guess of the
authentication site it doesn't either
have to talk a bit of talk
talk to it so again back in start up at
CS which is you know spinet core it's a
fairly common spot to be working I guess
there's two main system eight sections
there's configure services which is
basically configuring configs and
various other things that you can use
services the app can use ready for
dependency injection so basically net
call is completely built around
dependency injection and that's what
configure services sure it's getting
things set up reg provide options and
then below that is the configure section
and that's where we actually go ahead
and set up the middle where it's going
to be run as the app flies through its
various stages down the bottom here
we're going to add some more things I
just want to really call that right now
that ordering is important if you've got
a DMV see and you want the MVC to be
able to indicated you have to put the
authentication stuff before it to
commons common mistake that people make
okay so we could actually use a built in
JSON web token authentication extension
method so middle where my mouse keeps
falling down the lectern sorry so
basically they spin at core it's
probably a bit small to read or blow it
off a bit is it comes with the
capability to go ahead and actually set
up a piece of middleware complete with
options including the tokens valid issue
are the tokens valid audience as well as
keys and things to be able to go and
check the signature so out of the box
you can actually do this really easily
and you know in certain circumstances
that might be good enough so actually
this cards that I've got in this jest
here we actually probably enough to go
ahead and say yes this use is real and
yes this user you know is a syndicated
against the system but it does come with
other problems firstly it leaves the
question of how to actually get access
to that in your code so
because the token is good and the users
been given access to it you haven't
actually really authorized anything and
even if you check a claim in the token
to make sure they that the particular
claim is valid in the suit your
requirements you haven't really
authorized and you haven't really
actually gone off and done any database
operations or will actually set up the
current request to be the identity of
that user so it sort of these all that
sort of stuff um so begging the other
problem in Scott is that before I want
to change the way that we validate
tokens so my sis my boss has just come
to me and said we need to bow to cancel
them into better have it the tokens need
to have an ID which they do we need to
be able to register ID somewhere and
then have it cancellable now for I've
got four websites and product sites and
things like that especially non-trivial
task to go and change this piece of code
everywhere so what I want to do is
upload that onto another system as well
so I think we need to customize a little
bit more for this particular scenario
but i just wanted to really point out
that there is a really really
straightforward way to validating tokens
so when i actually first started
preparing this talk a while ago I went
in there I saw the use do a bear
authentication and I started writing my
own class based on it so I'm casting off
it and overriding things but then I was
looking through the source code this is
what's so great about things that are
developed in the open so what I've got
here is the source code off github for
asp net security and so i was looking
through for some stuff and I just acts
stumbled across a way to actually
intercept the JWT token processing and
run my own codes fed so and this is this
is only great things about having stuff
developed in the open I don't think so
okay say yes so we actually did is I was
just looking through and I just saw I've
just punched him the JWT stuff there and
I found basically the local spot here
where I think it's going to be doing
stuff and I was just reading through and
I become fairly familiar to code I guess
you could save it and I came across this
little piece here and what saying is
when there's been a new token message
received in the pipeline if there's this
particular event registered then go
ahead and return its results instead of
processing all this all this stuff down
here's what actually is doing the token
processing in the old code so I realize
that so I thought I'd have a bit of a go
of that so I went back into my own code
and I above NBC yeah because we want to
do this so an app that use to achieve
various education
it's annoying
so again okay cool and then it's got
those options that we can see in the old
code and then options had those events
so ago you know events and then there
was that event that was on message
received so there it is there like it's
sitting there ready to go by being able
to read the code i was able to finest
this guy there and so now we needed
something to pass into it and rather
than just run just straight up just put
a message handle there or something like
that i figured we could use the
opportunity to have to investigate a
little bit around dependency injection
in HP net core and also setting up all
those sorts of services so once again
doing things in the correct way rather
than doing a demo rushed way and so I've
actually 14 already another class up
here which actually has the ability to
receive that message so this guy here's
a is looking for a message received
looking for a function returns a task
that except the measure received context
so in order to do that we've got this
graph here is some 0t event-based to
horrible name for a class I'm little bit
I'm basically I'm message receiving here
and I'm going to step through this in a
minute but essentially all I had to do I
didn't have to but I'm inherit off
anything it's just just as long as I
have the right signature and this is
going to go ahead and work and I'm
seeing a lot of this pattern showing up
in asp net core at the moment it's got
to have the right signature for
something as opposed to having to
inherit because inheritance had the
dependency on something that's in their
code where if signatures seem to be a
much more healthy way of doing things
that I really appreciate pattern before
we can go and consumers guide I can't
just create a new instance of it because
because it's its constructor is actually
taking these I options now I options in
asp net core is a central theme for
passing around configuration settings
around the app in the past year sort of
left there's less up to you decide how
to pass configuration through things
that eventually made it essential seema
included as part of the disk the deserve
creation so the suspension injection set
up and service configuration and so but
I can't just create a new one of these
guys because of that dependency say I'm
going to actually have to register for
dependency injection to make sure that
it's all it's all sorted out so if i go
up here and um into the configure
services section now this is the bit
where we go ahead and make these
services available thing so i can
actually go service services dot add
transient so transient is add every time
I dependencies cool it's going to create
new one there's a couple of others is
add scope which is going to create a new
one for every web request so you can you
can guarantee that the objects the same
no matter where you get it from but I'm
going to go and get the I i'm going to
copy that gonna try and go of it okay in
a register this guy so I'm going to
register this interface to be used by
this guy yeah as such so now whenever I
request that somewhere in a dependency
injected operation I'm going to get that
JWT event-based sing out now did have
those settings that were being passed in
and so there's another type of gift set
up concept that you have in these
services and that is services dot can
figure and so it was of type signing
settings and then I can give it a
section name or so I give it a um
configuration thought get section and it
was cool planning settings okay so
that's the second concept here I guess
is the ability to configure from
settings like that now being a new
project I'm gonna have to get those
settings I'm just going to quickly copy
am outta here definitely not going to
type these by and now I Cena caught
we've got the it's probably pretty hard
to read so that the app settings are
Jason down there which is new concepts
just Jason file
fairly flexible format and by popping
these guys in here I've got that signing
settings section which I asked for from
the configuration manager and it
contains the various configuration
options that are then being used by the
strongly typed validation endpoint token
valid issue are and all those they're
actually being used by this strongly
type class here signing settings so you
can XO the concept of settings being
first class in this point is caught core
to the system okay so now I've just got
to I can actually inject that anywhere I
want now so I can actually go and get
this guy and inject him anywhere so I
jovi go to event based response service
can inject it i can even inject it into
the configure section so buddy just set
it up and your figure services already
starting to work so i can grab that guy
because because i'm injecting it when
it's constructed it's going to
automatically inject to their settings
as well and if i might apply later and
add more things i don't have to change
my kögel around the place because the
dependency injection system is going to
look after that for me and so now I
sugar added as pop here service thought
our message received and we've just
injected into our pipeline a piece of
middleware that scene got a custom call
back out to our code which is free in a
day for the complexity of what we're
trying to do that was actually pretty
straightforward I'm so let's fire it up
and just makes just take the pulse to
make sure it's still working and if we
break point in here and i'll run it now
the first time it hits its going to be
emptied a token because they're just
hitting straight from edge there so far
just moves a bit point down a bit there
it's trying to get the authorization
header and it's going to be empty so
that's fine we'll just move over to post
mount and said I've actually grabbed the
token and popped in an authorization
header and basically when you're when
you're dealing with
judgment of tokens or other various
tokens use the bearer authentication
type and then just a token after it no
special encoding or anything like that
so in this case that I'm actually am
passing through that any authorization
header so now I'm actually send into
this guy we should hit and we should
actually see the token sitting there see
so we can't read it but anyway it's
there and if I start stepping through
this code let's trip off the bearer
there and then go in and actually want
to go and do the validation piece here
so it's going to give 10 / that to clean
ok checking its work so what's actually
happened here is there's no code in here
to actually validate the token I've just
farmed that out to something else in
this case I've gone off to a particular
URL which is this endpoint and apologies
have carried it what it is is actually
put the actual validation code up into
Anna's your function and so and that
allows me then to centralize and break
apart even bits that in the past i'm in
a code would have just been in here
tough data would have to go around an
update all my products but now that I've
found it out to anna's your function i
can now go and work on this further
decentralized piece so I'm going to go
let's go and have a look at that guy and
see what's going on up there now for
those who don't know as your functions
are basically these little tiny
single-use single responsibility pieces
of code that run up in the cloud they're
basically sent it around triggers so you
can trigger on various mechanisms where
as being when you write a file or when
something comes in on a vent service bus
or in queues or another one that I'm
using here is actually via web hooks so
you can actually fire them based on web
hooks so I'm saying hey can you please
to code this payload to make sure it's
good i'll give it the key the public key
of course never the private one and the
values that i'm expecting
and then returns whether or not it fails
or whether or not or if it didn't fail
it returns the that returns the claims
for me so functions they run in these
your app service so the beauty is your
appt services let's just create and you
have service and it's got four servers
or two servers or whatever going to
scale it up and down as much as i want i
can t install multiple different things
on that same grouping of service it's
not just for one site so i can i can
have staging deployment test1 test2 of
one website we're going to have website
one two three and all different
deployments lot tons of them as well as
a bunch of these is your functions and
some other stuff as well so you can
actually share resources that you've
created cost-saving but also you
guarantee that they're running on the
same hardware so when I say that I'm
farming out this this this token
decoding piece to another to another
system it's not actually going very far
should be adjusting the local cluster of
servers so it should be fast and also
cheap so I've got a few different types
of function in here but essentially this
one here what it is these these your
functions they're written in C sharp or
node this one's in C sharp and they're a
special file type there are CSX so
they're not actually a full project and
CSX is basically got a few funny little
syntactical things you can you can
include assemblies you smash our
directive CCM including systems identity
model at the top and basically there's
no class yup not saying a classy but
there is there's actually if you can
notice the first thing in the file is
just this public a sync task so under
the hood you can you can probably see
you probably imagine that it's actually
wrapping it up in something else as it
builds it normally can edit these guys
just in here and just try them out but
I'm dive deployed this from github this
one but what you can do is down the
bottom here is I can take this payload
and just quickly run it into the guy to
see how it to see how it works so you
can get in to bug them up here and all
that sort of thing and once you get it
working you can take the code deploy it
up into another one so I github really
easily and so in this case I can see
that
the results come back and it's got this
set of claims it's just be hard to read
they might bring it down to postman ok
ok so again possibly ok so I honestly
through the claim so I've just sent up
the token in this payload and I can see
the claims that have come back so it's
two codes them out now if I go up into
the into the header area up here and I
go and make a mod to this hitter the
body so you see here I'm going to go and
edit that just going to remove one
character and try and send it it's
immediately invalidated it it's been
unable to decode the payload so just one
minor tiny change for that and that
crypto fails so they can't be edited so
you might be able to see them but you
can't change them and so I guess that's
broken they're probably not going to be
able removed which is cool we don't need
it um so yeah back to this one I think
this is where we're working the virtual
these as your functions are pretty sweet
really i've actually got one already
that I've put in github early i just
want to show you how quickly an easy it
is to to go on to pull one from get up
so I've created this new NDC function
demo here it's empty it took about
probably 30 seconds to a minute to
actually create and deploy it but I
figured that's a long time to standing
on stage doing nothing so what I'm going
to do is I'm actually going to go into
the settings for this guy I'm going to
go set it up and i'm going to set to
deploy from github so i'm going to go in
here and say I'd like to deploy you from
github please and it's going to go on
login i've already logged in but if i
wasn't it would pop up the OAuth
authorization thing you know choose
project today w two functions this is
budget listed on my projects i'll show
that again sorry that's just listing all
the projects that are in my probably get
up I've got a branch and everything like
that I'm just going to click OK it's
going to go set up the deployment source
that's part of that what it's actually
doing is putting a github we're booked
so when giro we're actually go and check
anything in it
immediately synchronize that back to
hear the thing is that these deployments
run so quickly that by the time I've
checked something in and come back it's
already rebuild it so if i go back over
there now and refresh this guy i love to
just go out and again i should be able
to see my functions have been deployed
already with anyone know like after
going to make a change and get up
probably anyway that's how easy it is to
actually link up continuous integration
into stuff in inertia of these days so
that we've got that function running up
there and that's pretty much what's
going on back here like i can see that
same result has popped out here is that
that's set of claims yeah but having
that function there I I can then pull it
in my mobile app as well and from any
other app that I've got anywhere at all
but importantly in that function I can
go off and check and other data source
to make sure that token hasn't been
invalidated or something like that so
there's all sorts of other things that I
can do in this other spot without having
to even touch the rest of my products
the last thing on is your functions is
that they do scale out so if you run
them in me in the non app server space
mode they'll auto scale basically you
just paper consumption and they'll scale
layout to the buca if you're running a
min the app service version you you
respond to the scale but you can scale
them out to as many services you want so
you can go really really large with
these things if you wanna run on a scale
okay so I've got the result there and
i'll just keep continue back in postman
just make sure that we're still going
now this is interesting i've just put in
that pipeline and it's gone 200 ok so if
i go and cut that and send it in it's
still 200 ok over here Dupree how to be
projected low quality I guess you could
say so it's still saying 200 ok but I am
past any berries in there it's not at
the moment saying
nothing's actually saying hey these
people need to actually be all sir eyes
or its indicated just because we've
added stuff into the pipeline that's
checking them and saying yes sir they
user president nothing's rejecting it
and saying how you know this user is so
good get them out of here so we're going
to do is go and tell it that these users
actually do really do need to be
authenticated so I'm going to grab
another piece of code just quickly here
sorry and back into web application to
I'm going to go up to i'm going to go
back into the startup this is where
everything happens and up to the point
where we actually can figure how MVC
works so there's a adding services at
MVC is adding a Hollywood default
configuration data for MVC i'm going to
override it with some authentication
stuff so by placing this in a bit there
we go but facing machine what i'm doing
is i'm saying you use most of the
default stuff but i want to override
some so i'm creating a new authorization
policy builder which is going to require
a claim of type ISS to be central or
host so that's the issue are so
basically I'm just making sure the
issuer is something in when you're doing
your project you can have any time
dependency here for these types of
authorization and you can actually use
different authorization policy builders
for different things across your product
sort of you don't have to don't have to
have the same one on everything you can
have one control using particular
policies and the other controller could
have a policy on it same as the user has
to be a an administrator and you can put
a claim in there saying administrator
true so there's all sorts of things that
you can do there's a lot of flexibility
here in this case I'm just saying make
sure the Central Coast claim is present
and then before we just say before we
just had service at NBC now I'm actually
saying I want to do some configuration
please so hover over the Wonder school
here consumers especially in MVC options
so it's this cool pattern that they're
doing another new pattern they're doing
in asp net core that makes it really
easy just using Landers and so Delta
like Yale ambers to do call back
sorry to to make it really simple to go
and get into configuration as we start
going codes them to know how everything
works I didn't have to know that I was
an MVC authentication option I just
typed it and it worked lowering the
barrier of entry I guess to
configuration here and then before add
the authorized filter to the get method
in the in the controller this way I'm
just going to add it to everything in
their whole project and and this is the
way I usually work is added to
everything and then you can use the
opt-out no authorized that it's like the
inverter of it if there are things that
are open like discovery end point source
or login pages and things obviously need
to be open and so let's do an that so
now when we run it it should be rejected
us it should actually be saying there
that's some we should be told to go away
so send it so it's for I went on
authorized and then I'm just going to
undo that and then again back to 200 ok
now that and I've actually passed in the
right token let me just modify it send
it and make sure we get the unauthorized
so I've just modified the token and
we've gone back to unauthorized so it
seems to be working ok it's going to
make sure that's working against before
I move off cool alright so I mean that's
all interesting but once again we've we
haven't really actually done anything we
said other than say yes because you can
get in we haven't supplied anything to
any developer to go and actually use
this so we're going to do now is put in
our own piece of middleware that goes
and collects this information and
supplies it to a point supplies it to
one of our own services so getting into
our own code that we can then go and use
elsewhere in the product and so adding
custom middleware is really quite super
easy as well you can just add a new
class i'm going to call it my custom
middleware now middleware is a thing
that runs in the o/n pipeline Owen is a
way for to abstract I guess the concept
of web server away from code so it's a
really great way to say
I think to me I Dooley's web server
e-type things but I don't know what web
server running on and I don't care so I
could actually run this in iOS Express
like animating Kestrel although pretty
much i express is just proxying back to
Kestrel though if I was then to fire
this up on another new web server
doesn't even exist yet asp net call
being cross-platform I'd have to worry
about it because it knows that
particular website will know how to fire
up their own pipeline as long as it does
knows how to do that but when you
actually write custom piece of knew
where you actually you can see the
pattern coming in that these things sort
of our training together so you've got
this some again you don't have to have
it based on anything as long as the long
as the the signatures are correct it
will work so I've taken a request
delegate there into the constructor so
that's obviously something it only needs
to be able to do and then that's it
that's going to that's going to create
that when that boots for the first time
and then every time that something runs
through the pipeline is going to call
this this this guy invoke which accepts
the HIV context and then I actually have
two is part of it being a good omen
citizen I have to actually make sure
that I call next dot invoke passing in
the context so you can actually get a
feel for what Owens doing there some
coming to me and it's gone in and I've
called the next one you've got has to
hover on that I'm going to put this
before that add MVC bit o next that
thing there's probably the MVC one that
I'm actually calling so you can it's all
pulled apart like it's it's not this
thing that's running hidden underneath
the covers you can see it clear as day
the way that pipeline is operating I'm
writing it here it's it's pretty cool
it's really simple i think i mean is
probably not at all wise needs a hood
bit and so in here though because it is
now my code it's not some real
authentication piece running deep down
the 0 in pipeline I can get out some
claims like a new lips excuse me
women's using the question marks there
for those of you are familiar fish at
six that's a null propagation so by
putting ? dot push them up dot if users
now fill in there and return null rather
than trying to keep going through and
then throw an exception because the
thing before it was not just a really
nice way to check lots of things for
noah with adam to have lots of uses
around them but anybody put the claims
out and so i need to do something with
them so what I've got what I've done is
I've created a user service so use the
service basically what it is it's got
one method on it called set up user it
goes through the claim to the numerator
and looking for the name claim and then
it sets a local variable a local non
static variable to of name now that's
important that's not steak because we
need to be able to share this around
their app but we need to make sure that
it's only shared for the current request
because if we know put the memory these
guys are all running next to each other
right we want to make sure that that
when we do call this particular object
back out of wherever that we're getting
the same object back and then said it's
the right name so I've got the user
service and I've already implemented I
use a service on it so you can probably
guess who this is going I'm going to go
back to start up top CS and I'm going to
go up to configure services there here
there is now this time I've had to add
transient before which is going to
create one each time this time I'm going
to do add scoped and so scoped is going
to go use a service there we go scoped
is for this particular request so now
that guy is going to whenever a request
that it's going to get the same instance
for just this request HP net has
provided me it's this really awesome
scope that I can use to to basically
control what I get on every request it
makes it really simple to do it so I'm
going to go back into the my new custom
middleware and I'm going to inject it
here now don't inject it on the top line
cleft created to start
so it's obviously not going to be this
class isn't created for every request
could creative ones and invoke scald for
every request so I'm going to have to
pass it in here so this is dependency
injection at work and they start getting
an idea you get a feel for the
patterning asp net core that it
signatures as long as the signatures are
okay it's going to work because you can
see it's using dependency injection to
fire thing up if this is on a base class
of you know middle web-based class that
i inherit it off and had invoke i cannot
override that and then add more things
that i need injected so in this case i'm
a will just modify the signature with my
user service and then go away user
service set up user claims okay cool so
now the user services got the claims and
this is where we pop out the end I
promised at the start we would behave we
would see something that is that a
junior developer could use so I'm on my
first day and I'm say hey just use
though I i use a service to go ahead and
throw in to be in this other phone stop
it hey going go into the values
controller and pop my name out can you
please just talk about the name of the
current user and it's jus de bellas
gonna go how I do that I'm like well you
can it try using their I use a service
because I've set it up for you so you go
here I'm going to inject I use a service
so i'm going to make in local property
if it will allow me I've lost all
resharper so right I'll do it the
old-fashioned way I really am a junior
developer I'm not eating the sharper so
I've got the user service has been
imported there and then down here in the
actual values i can say name because
we've been seen value one and two and
then because it's a scoped thing I've
going to use the service name and I know
for a fact that that's the name that we
set up through all that complexity so
everything that we just did just popped
out this Sanders this two little lines
thing and I'll just run it up so we see
that in operation okay in postman and no
that's annoying what do I do okay i just
put a breakpoint why are you know what
if anyone can tell me what I didn't do
you win my gonna know I'm going anything
to give away actually
middleware yes that's exactly right and
I did every time I did a practice run I
did this wrong so Shannon can figure I
want to do it after the bear
authentication cuz im using the claims
can our apps that use middleware my
custom middleware and that's it so after
the bear a bit before I'm v6 i'm using
it an NBC but i'm using claims so you
can see the order if I don't put this
before they used a devotee Barrett's
indication that claims will be empty
because we've seen the way they call
next next next right so right now at
this time and we should see the name pop
out
Oh break point I'm thinking our man
having at this one shot so let's check
that the claims of their own oh that's
the browser version sorry just there
there we go check of the claims are
there and there's some claims beautiful
and it passed into the set up user here
it's chicken for the client so it's got
the first name then so that's good now
I've hit NBC you can see the name is
Jordan aight i'm probably too small
degree but trust me it is but when i get
out to post man over here and if you the
names popped out at you tonight and
that's that's it simple once you do all
the hard bits and tuck them away and so
let's the end of the demo guys i just
wanted to pop up the slides again for
one second there because we've got an
xbox one we give it away so if you want
to go across to that URL there's a brief
survey and basically asking you in 25
words or less where you'll do with IOT
and we're going to give that away on
friday and so do encourage you to head
across there to enter that if you want
to take a photo or that or whatever i
know i went right up against time
apologies for that i Surata sleeve up
there but we might have a couple of
seconds for some questions if not i'm
actually i'm going to go to the ask me
anything singing after this just outside
so if you want to come over there and
ask any further in-depth questions
please pop out and say hello i hope to
see you guys around the conference and
thanks for coming along today guys
really appreciate it</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>