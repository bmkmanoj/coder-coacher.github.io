<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>implementing authorization in web applications and APIs - Dominick Baier &amp; Brock Allen | Coder Coacher - Coaching Coders</title><meta content="implementing authorization in web applications and APIs - Dominick Baier &amp; Brock Allen - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>implementing authorization in web applications and APIs - Dominick Baier &amp; Brock Allen</b></h2><h5 class="post__date">2017-07-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/EJeZ3YNnqz8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay hello good morning that's that's
the spirit yeah come on good morning oh
thank you sir
so welcome my name is Dominic that's
Brock and for those who don't know us or
for those who know us we kind of have
luxury and not everybody agrees on the
word luxury of doing you know security
stuff full-time like every day you know
and since security is such a broad field
we kind of specialize on authentication
prime you know what is these days called
identity and access control they are
which is basically building
authentication architectures and you
know single sign-on and and these things
so and it turns out when you do that
like every single day it's important it
gets really easy yes because you kind of
seen almost everything and it's very you
know it becomes easy to map the
architecture to the right you know like
cookbook style solution right but once
you're done with authentication then
inevitably you will hit the problem of
okay so now I know who the user is but
what is he allowed to do in my
application right and that turns out
it's much much harder then then just
figuring out who the user is so for many
many years yeah our standard answer was
yeah you know that it's very application
specific and you know identity server
which is the open source project we're
working on kind of it's like a like a
turnkey style solution already for most
of indication scenarios so people were
asking us I can you do the same thing
for authorization you know just do
episode use authorization and I'm done
and it turns out that it's not that easy
right the first observation is anytime
somebody asked me that question I said
okay so how does authorization work at
your company right and then you know you
ask 10 people you get 15 arms after that
and
it turns out you know everybody does it
a little bit differently and and that
there's a really blurry line between
what is authorization and what is
business logic and what are business
rules and what is security related and
what is just you know the way your
company works and we identified a couple
of common approaches you know like
something like Rose for example you know
like I'm a I'm a doctor I'm allowed to
do this yeah permissions right so Brock
is allowed to stand on a wobbly stage
for example yeah
some people use apples you know inspired
by how Windows works you know that you
attach you have objects in a database
for example and you attach to who is
allowed to do what to the object there
which has its own own issues right or
inheritance and orphans and these things
communities versus commands right so
commands are basically I I do something
am I allowed to do that there vs.
communities you you get some data but
you only want to show the data that the
user is allowed to see right and you
don't want to do the filtering ideally
not in the front end right and don't get
all the data first and then hide the
data that he's not not supposed to see
but you know do it more clever so you
know these are some common observations
and I'm you know I'm here you all know
that and then people ask that you know
like is there a standard solution to
that yeah and you know who has used X a
camel in his life well a couple of
people well one hand it's even hard to
pronounce right
it's then for extensible authorization
markup Oh extensible access control
markup language yeah
and that was an attempt to to to fill
the standard framework for authorization
and as you can see with one hand going
up it wasn't very successful man it was
really hard you can tell that something
is too hard when people BSL
on top of it that could use the XML
under the cover right and then put it as
an eclipse plug-in so so broken ah you
know always like kind of yeah we could
if we go to think about that next year
or next year and then we finally sat
down a couple of months ago and and you
know like okay let's let's try to build
something okay and that's something is
what is talking about there it's maybe
not you know it might not be that the
best solution ever or the you know just
something we came up with and we're
going to show it to you and maybe that's
an inspiration of how how you can do it
yeah okay so the first problem we're
seeing is you know once you're moving
into this modern application
architecture you know you have this
distributed systems you have all these
different client types and you know you
have your browsers and your mobile
devices and your your servers and your
web applications and your api's and all
kinds of permutations of call patterns
you like delegation and trust the
subsystem and it's getting already
pretty complicated so the thing that
helps yeah is introducing the notion of
an identity provider or a security token
service right where you at the top of
this thing is to provide a stable
identity for the user across all the
parts in your system
yeah and that helps a lot right I mean
now that wherever that same user goes to
he used the same user right and we can
abstract that logic into a box so to
speak right and reuse that for all of
our you know parts of the application so
you know that kind of like a
subconscious idea that everybody has oh
now we have this central thing right and
it's issuing tokens and huh we can put
stuff into tokens yeah that might be the
solution to our permission problem yeah
so why not be just you know the user
logs in in addition to just putting in
the identity of the user why not just
put in the roles and the permissions and
all that stuff into there as well and
that's how we see identity server our
project often
being abused yeah and this might sound
like a good idea to start with but once
you go down that road there are many
many issues you're hitting and that's
why we don't recommend that at all yeah
so that's my you know my the way I
remember that is identity is not
permissions okay identity is you know my
name right on all my date of birth yeah
a permission is for example you are
allowed to drink alcohol in the bar yeah
but you know your your passport doesn't
say you are allowed to drink alcohol
right because every country handles
these things differently you have your
passport has the date of birth on it and
then it's up to the end point to apply a
local rule right that's how I remember
it it lives there it doesn't work for
yourself okay so so you know when we
come to these customers they show us
what they did like sit oh I think we
have solved the Commission problem yeah
and they show us what they put into the
tokens now and that is a good example of
a problematic token okay so the first
thing we have is you know that makes
total sense we have authentication
metadata where the token coming from how
long does it live where can it be used
which is the first problematic thing as
we'll see in a second there how did the
use authenticate who is to use a right
of subject ID the name and then the
trouble starts right permissions so you
know he can delete data okay he can
manage customer so that that's all like
a hospital scenario yeah that's our
little playground project he can change
a treatment plan now and then there are
roles as well yeah and roles is also can
be problematic not necessarily so the
way I like to think about roles is there
are identity roles and there are
authorization roles now so an identity
role for you so we have discussed my
appeals
hospital software
and every user is in one of three roles
it's either a doctor a nurse or a
patient that is identity in my mind
right regardless where where this user
is going to he will always be a doctor
or a nurse or a patient and there won't
be situations where in one system he's
the doctor and the other one he's a
nurse yeah it just doesn't happen
okay so that that's okay and if you're
using these identity roles as includes
to figuring out what this person is
allowed to do for example the doctor is
allowed to change the treatment and the
nurse isn't that's fine right but the
audience field yeah in in in tokens
tells tells you where is this token
allowed to be used and in our scenario
here it's API 1 and API - ok so now this
guy has the permission to delete data
huh what does that mean in API one that
doesn't mean the same thing as an API -
does he have the same permission in both
api's yeah so the problem is really the
model in Olaf is not that you're getting
one token per API you're getting one
token for all of your API it's right you
don't want to go to the token service
every single time you want to talk to it
to an API you ask for the token and say
like you give me a token that that's
good for API one two and three and you
get one token back and then you can use
that right and what is the data that the
claims are ambiguous now yeah like a
delete data yeah in one API that means
something else in India as in the other
ma'am the roles you know if they are
identity roles they will have to say
meaning in all api's but if they are
authorization roles you know like I
don't know what's notation role can
prescribe or prescriber prescribe
medication prescriber whatever yeah
which also it which is are already the
outcome of the authorization policy
again there's a chance that this is
different in the patient data API or
Indian
ecology API as opposed to the cardiac
API for example okay so that's why I
think it's it's a bad idea to put these
things into tokens the other thing is
tokens are a very handy data structure
to convey you know data from a token
service to and to an API because it's
signed right so nobody can tamper with
it that the recipient knows that it's
coming from a trusted issuer but the
only way to get a new token is to go
back to the token service right of what
if these permissions change during the
lifetime often of a session what if you
want to remove the permission from this
nurse to do I don't know take the
temperature right you're the only way
she did this permission change will
become effective it's by getting a new
token to me which means logging in and
logging off and logging in again okay so
like like in Windows Yahoo Jim you might
know that you are in Windows at logon
time that the domain controller puts all
the ad group memberships into the
Kerberos service ticket here and when
the when the admin changes your group
memberships the only way to Det to
become effective is you have to log out
and log in again yeah and what if you
remove one too what if you what if he
puts you in admin by accident and I said
please log out don't don't be an admin
anymore yeah so yeah that's why we think
that security tokens are good for
conveying identity and details about the
authentication but not good for
conveying application data which
authorization in my mind ultimately is
okay that's just what I just said so
which which led us to the conclusion
added that there needs to be a
separation of concerns now and that
might sound totally logical to you but
it's not for everyone because we've seen
these things mixed up a lot ma'am so
there there's a reason why
authentication authorization are two
different words right because they are
two different things so so we think
identity is is the input to Europe
system and the outcome of mixing
identity and permission
that's your authorization data okay so
the way we like to think about it is you
introduce another component in your
system and you know lack of lack of a
better word I call it authorization
provider they are like like an identity
provider but for authorization data so
to speak and then what we think is a
good approach is you know when the user
logs on to the ED to the system he goes
first to the identity provider
authenticate with the provider gets back
an identity token right or an access
token that represents the the access to
or to a resource or to an API or ap is
and represents the identity of that user
at these API and then the authorization
provider is more like more like a system
that knows now about the various
applications in your architecture you
know like your your client application
the UI might have different
authorization requirements than an API
right or you know maybe you want to make
it easy for the UI developer to not know
or have to infer that not having the
prescribed medication permission means
he has to gray out that button maybe you
want to have a permission call you know
a height prescribe button right which is
much more tailored to the needs of that
specific client application yeah so you
know why not have a system that knows
exactly what the client needs right
all these API is right so we going to
call this api's with the identity and
then the API is intern will pass on the
identity of the incoming user to this
authorization provider say hey I am the
oncology API that's my user gives me
back the permissions that applied to me
right which makes much more sense
because then you know you can maintain
these permissions separately you don't
mix them up in a separate token and you
know it's actually really a different
concern so we should separate it
and then combined I guess with a really
good UI right that that kind of like
fulfills the dream of many architects
right so somebody can go to a UI and
graphically configure roles and
permissions and so on and the developer
just calls an API gets the data in its
application and works with that and if
these things change you know somebody
can just go there make the change don't
have to redeploy the application don't
have to get rid of crappy authorized
attributes on your controllers or change
them or whatever yeah and you know just
just be happy I guess are you happy very
happy good good next slide so yeah so we
came up with you know a prototype which
roughly looks like this it's it's
recorded your operation provider it
basically has two endpoints one is give
the management API that's the thing
where people can then you know Trek and
drop their roles and permissions or
tracking dropping is outright it's not
working very well on an iPad yeah
configure whatever and then there's a
client endpoint and that that's the
thing that that that can be called by
anyone who's interested in authorization
data and the way we think it is most
useful is that you know you get data
about that user in Wyatt the identity
token or the access token and you pass
that identity on to the authorization
provider and then there that there's
going to be a rules engine that knows
how to map from identity to permissions
yeah that might be static rules like you
know user one is a doctor and user free
the nurse or that might be you know if
he has a gmail email address he must be
a contractor you know like like you know
that some some dynamic evaluation you
have a based on the incoming claims
creating outgoing Commission's that kind
of like claims transformation is there
we have roles so we can map your throws
we can map permissions to roles right
and at the end of the day what the
client application gets back is a list
of permissions or a list of roles
depends on what you prefer you know some
people like to work with
rolls more like cross-grain some people
like more the permission-based approach
and that's basically how it works
okay so next slide so now brought will
walk you through a couple of well first
of all shoulder showed us the server
mapping style and then we have a look at
how we tried a couple of options how to
integrate that into today's applications
frameworks like HP dotnet for example
and and what we can do there yeah so the
idea is that we have these primitive
constructs that you have to then piece
together your authorization provider
system and so we have a host application
that you know is your centralized
authorization provider as we saw on the
slides and this happens to just be a
good old you know asp.net core who does
good well yeah it'll all change next
week next year so next month sorry yes
just a web api project and so the idea
is that we're going to load in into this
Web API project this this authorization
engine that we've prototyped and we need
to configure this authorization engine
and so this is where those primitives
come in where you are going to model
your application domain if you will so
we have some primitives in here the
first concept is this notion of an
application so this application could be
the UI project or the API project like
one could be the oncology the other one
could be the cardiac api's for example
and so we give them the name so in this
case is generic sort of a hospital
application and then the idea is that
within those application domains again
you want to model the users
authorization behind roles and
permissions so what we have is we're
listing for this application this has
three roles and again the idea is that
these are application specific roles
kind of like the authorization roles
that the Dominic was mentioning and then
we also have this notion of permissions
so for this application it needs doctors
nurses and patients and these various
permissions based on the the actions
that the user is going to be taking so
then for these two different concepts we
have a mapping mechanism so
for the role mechanism we have mappings
and so there are various conditions that
will indicate that the user is in one of
these particular roles so as Dominic
mentioned we have some static mapping
user number 1 and user number 2 they're
both going to be part of the doctor role
in this application also maybe if the
centralized identity provider provides
an identity role of doc that also means
for this application they are a doctor
so you can have sort of a you know you
can choose where to do your mapping it
can come from the centralized identity
system or within the specific app you
can choose the map based on individual
users so we have something similar for
nurses and then patients and then this
is showing an example of a dynamic
condition so based on the identity of
the user right they are happened to be
sick so that obviously puts them into
the patient role in our application ok
and we do have a very sick user in the
system so we'll see that in a minute
even request multi nine yes he does so
that's how we can do role mappings ok so
that's pretty straightforward we are
going to map identity to roles for the
purposes of authorization we also then
if you want to work in a more
action-oriented style for doing your
authorization permissions and for this
model what it seemed to make sense is to
simply say ok well if you're in a
particular role then we allow you to
perform a particular type of action or
have that permission so that's the basic
mapping here you know we could give then
this being a centralized server could
host many different mappings for lots of
different applications and in a
centralized location we don't quite have
a UI yet again because we just kind of
prototype this up so that's why we have
code only config for now all right so
this is just an API I'm just going to
run this so there's not much to see here
but we then have our consuming
application so here's our good old MVC
consuming application the idea is that
we're going to authenticate the user so
we're just doing standard cookie based
authentication and then here on our
account controller we just hard-coded
some users just for the prototype so
Alice look
Gallus is subject ID one so according to
our mappings earlier it looks like alice
is probably going to be a doctor and
then for user bob user bob is subject ID
11 so i think bob falls under the nurse
category and then i think we have
anybody else comes in is going to be
very sick so they'll be they'll be in
the patient role okay so we get the
ideas that we run this and right now we
can login to the application right we'll
login as Alice and as of right now we're
not involving the permission the
authorization provider in any way we're
just logging the user in and showing
their claims so the next thing is to
find out how now it's in this
application start to incorporate based
on the authenticated identity of the
user incorporate the authorization
provider okay do you want like with us
or no it just shows okay so what we have
then is another project in here which is
the client library so this is a library
that you would load into the MVC
application and it's really just a think
of it as a proxy you take in the
identity of the user and this
authorization library then can contact
the authorization provider running so
this actually just ends up as a service
in dependency injection so we have this
authorization provider client class that
we need to stick into di so back down to
the actual consuming MVC app what we can
do is do services that the authorization
provider all right we have just a really
simple configuration here so again
imagine this is your UI project or the
API project it knows it's the hospital
application and then we need to know the
ural of the actual service which I
actually have already forgotten so that
was that URL okay so we pop this in here
so what this does is it registers in di
our authorization provider client and so
as you know standard asp.net core what
we can do is in our controller and we
can do authorization provider clients
right and put this in via dependency
injection okay and then now in our
secure method right we have the user
right that's made available from the
cookie and we can invoke our client and
we have get authorization where we
basically pass in the user so this
method is invoking the centralized
authorization provider passing in the
current users identity sends it to that
thing and then what we get back are a
list of the roles and permissions like
this okay and now you just put in the
weight there so what I'm doing then in
my view is I can take the view data and
I shall grab it this way both of those
and I can simply pop these in here like
this
and that should show that data so if I
rerun this my user I think should still
be logged in as Alice yeah there we go
okay so that basically invokes the the
the provider and now we have the mapped
information so we can now perform
authorization in our application there
are a couple other convenience methods
here just for for show there's a
shortcut methods basically where you can
say is the user in the role or does the
user have a particular permission and
again since these are application
specific the app is going to know which
role it needs to look for or which
permission it needs to check for
whatever operation is being performed so
yeah let's go back to slides oh nice so
yeah so we showed that to people in the
city okay that looks good but you know I
will develop a state they want to use
like the authorized attribute yeah or
you know something that they they know
about from from MVC let's go our next
one okay so you know like something like
authorized roles equals doctor yeah and
we thought about that and and how can we
make that work and there is a way to
make it work and I'll show it to you in
a second yeah but who really likes this
style of authorization code enforcement
of right attribute so on Alicia who uses
it actually who uses it right okay who
likes it yeah okay so yeah many people
like it yeah miss mystery number one to
me is why are those net developers so
crazy about attribute it code right it's
called a faster method it's the famous
code below the message what's the
benefit of doing it declaratively I
don't know that but much much bigger
problem I have is that obviously you
know what what that kind of pushes you
to is kind of like mixing up two
concerned in a single place like yo your
controller logic and your authorization
load sugar and the active magic strings
your roles equals doctor and what
happens if now some other people need to
have access to this method you need to
go back to your source code and find all
the places where it says rows equals
doctor and updated through comma nurse
whatever what if you miss one of those
or what what if you if you change the
wrong one you create a security hole in
your application that is hard to find
right how do you test these produce this
attribute there you have to invoke every
single action method right and make sure
it returns the right thing don't forget
to add your test when you add new action
methods right I have a customer you know
like five hundred controllers or
something and they have all these
authorized attributes and they are like
you know the the visits in regular
expressions in search and replace these
days right because anytime a requirement
changes right they did right there the
automated the update of the permissions
right we are we are all engineers slide
we spend a couple of weeks writing a
search and replace engine for our
authorized attributes here
so in short in short we we don't really
want you to use this model right but if
you want you that there's a built in
thing in a single core that makes it
really easy and that's called claims
transformation right so what you can do
if you plug into the pipeline and and if
that's what you want is you take the
roles and the permission is coming from
our server and just put them into the
claims principle on the fly right so
it's not in the cookie it's not in the
identity token it's just in the claims
principle in memory so to speak okay so
just do that quick right so we basically
want this line of code to be done
automatically on every single request
okay
so we can do that is as part of the the
client library we wrote this claim
transformation middleware so after the
cookie meddler what we'll do is we'll
use our authorization provider and so
what this does is again takes the
outcome of the cookie invokes this
method for you right gets the result
adds it to the current claims of the
current user
and now in our rendered page we should
see both the same I showed earlier but
also now notice that within the claims
of the user in memory we have for
example roles and permissions so this
means that if you really want to use the
authorized attribute you could do
something like roles equals that and
that should work okay one of that
decimal are we a doctor no I mean
technically speaking anyways
oh yeah that's another style now as I
said we don't like that too much for all
the reasons I've given you already so
you know like many years ago I mean we
spoke to that to Microsoft about that
many years ago already and told them
that I think the authorized attribute is
is just not good yeah and and people
prototype something and gave it to them
we didn't have the time to make it
really good and we gave it to them and
they listened to us and they're finally
in a third car there there's a new
authorization API built into the
platform which which you know promotes
some of the things that that we before
are much better than having this type
coupling of attributes and code and so
on and it's called a speed Co
authorization has anyone used that
already or try it played around with it
yeah okay so it has two parts roughly
one the one we the one we like better
it's called the policy based framework
and the idea of the policy based
framework is that you are you can
decouple your authorization logic from
the actual controller right so have a
good separation of concerns it's
extensible so you can you know write
your own custom policies and we'll see
in a second how that works but let's
just do a really simple policy now so
the idea is that you put your policy
into the DI container yeah give it a
name prescribe medication in this case
and and you can encapsulate all of the
logic around what this policy means for
you in the central place and then just
sir to it from your controller and if
your if that policy that requirements
change over time we just changed the
policy in one place yeah and then all
your controllers get that for free or
you know automatically right muscle free
yeah nothing's free it's just prepaid
okay so what we can do is add this to
our application because we're doing
claims transformation now and the
in-memory user has these mapped
permissions from our centralized system
we can key off of that as our as our
claim the permission claim to see if the
user has and then now that this is in
the DI system back over in our home
controller we could now apply the
authorize attribute just passing in that
policy name okay so if we rerun this and
I think if we go here we'll login as
Alice again and yeah we were able to get
in because Alice can prescribe
medication if we use a different user
like Bob okay looks like Bob can also
prescribe medication but if we log in as
some not so good you're sick very yes
can you also show quickly how to invoke
them imperative lis because I think
that's that's even the eisah but yeah
you know you you don't have to use the
declarative approach anymore with
policies yeah that's what I think is
also a big improvement
asp.net puts in an AI authorization
service into the I container at startup
time and then you can get that from your
controller and then you can invoke them
imperatively by name okay and basically
you pass in the user the user you want
to run that policy against and you pass
in the policy name yeah and then you get
back a true or false and this is now the
key to making your policy for the unit
you a unit testable right so you write
all your your policies and then you can
write unit tests you please create a
claims principle that has the shape and
form that you want to test against there
and then run the policy and you know if
it's a nurse that
should sail if it's a doctor that should
succeed right so you can prove that
these policies actually work in an
automated way and if the requirements
change down the line and people change
things around and you know you have your
test framework to prove that the
policies still do what they should do
okay so I like that approach really good
really nice I'm I'm a fan of this one
oh and challenge that's also a new
feature in a student core challenge
basically tells the underlying platform
that something is not allowed and then
18 court can decide between do I have to
send into a login page if he's anonymous
or do I have to send into a forbidding
page but if it's already authenticated
that's also a useful abstraction to not
having to make this distinction on your
own in your code over and over again
right that was subtle here in the demo
right the very first time we go there
were not authenticated so you have to
authenticate actually I'll do dahm again
so now then we go back and now we go the
second time we had it we are
authenticated just not allowed we get
the forbidden page yeah cool so deep I
like it approach you only mmm seeing
that feeling yeah well I should mention
that what's also new in MVC cause it
that you can do a dependency injection
in infuse now okay so if you want to
conditionally render your UI based on
the permissions or of the user that's
how you would do it ma'am I'm personally
not a huge fan of that because I think
that just pushes you into adding more
code to your to your views right if I
personally think if you want to if you
have to condition to render something in
a you know interview put it on a few
model right but you know but you're
still taking advantage of the
centralized offer yeah yeah that's the
main thing okay so go on back sorry No
one more yeah so that's nice
the only thing that's now a little bit
weird is now right because you're
writing a policy that looks up a claim
now you have to create one policy
permission in your system right and that
feels weird ma'am so a nice thing about
now not go forwards and I think about
this policy system is they have
something called the policy provider so
you can basically tap in
- the way they resolve the policy name -
the actual policy which means if you do
that you can now basically have a policy
called prescribe medication this doesn't
exist this policy is at least not
aesthetically defined but we can on the
fly create that policy in memory so to
speak which maps to the to the to the
permission claim called you know
prescribe medication so let's do that or
show show it quickly so what we'll do is
we'll go back and take this out yeah of
the authorization system so it's not we
don't have to want to define one of
these for anyway and we can remove the
claims transformation as well we don't
need that anymore in the claims
collection okay right and so we then
after we're adding our authorization
provider this extension method on our
service registration
knows to say okay we're going to use the
policy based authorization system so
register the right extensibility you
know register in di the right
extensibility point to dynamically
extend the policy system you want to try
to provide us well we could it's not
hard to build it sounds hot but it isn't
so this policy providers just another
service in DI we are simply accessing
the authorization provider client that's
the one to hit the centralized API and
so when we say get a policy all we're
doing is dynamically building a policy
based on our you know requirement so in
other words it's just dynamic right this
method get policy gets passed in a name
you return a policy and the Microsoft
provides a really simple class which is
the authorization policy builder to
build up your policy NRS is just being
built off of our you know the policy
string that's being passed in fact cool
that's a little bit more involved but
that's okay we should be able to run
this now
wrong project so yeah we should we have
the same the same behavior now but
without having to aesthetically define
the policies and without having to dump
all of the permissions in into the
Claims collection yeah which is an
improvement
so we're Dominic and now we are back to
Alice and Alice can get in okay and now
Alice doesn't have all the claims that
are in memory can claims transformation
the the dynamic policy providers
querying the centralized system one
thing we should probably note about this
is that the the use then of this client
obviously every call every time we call
this get authorization to call the
centralized authorization system you
know that may be an expensive call so
behind this client you would build you
know whatever kind of caching was was
appropriate for your type of non fatal
ever yeah I have a non fatal error
wonderful so okay good anyway
there's a lot of a you know features
behind this client library to abstract
access and make that properly efficient
cool so I mentioned earlier that it is
also expensive so you can also write
your custom requirements for for these
policies so but if you think of a policy
as a list of requirements yeah so don't
the one we just showed was it was a very
simple policy it just has one
requirement which requires that you have
basically has a permission yeah but if
you you know want to extend the policy
system in agent core oh by the way I
should mention the the most common
question we get when we show that is
like does it also work with NBC five
yeah and indeed it does on the slides
which we'll put up later there's a link
to a guy who backed part of the whole
framework to NBC size and the bet API so
that's that's totally possible but yeah
you can extend the policy system so in
that case you know maybe that the name
of the medication and the amount should
go into the the authorization evaluation
so to speak yeah so make it a little bit
more complicated all right so we have
some other wrong one so we have some
other method being invoked here the
ideas that actually should be show the
the policy first yes okay so the way we
build these policies with these custom
requirements is you create a class that
represents the data structure that will
dynamically change based on the
condition based on the situation so
maybe today the medication is aspirin
tomorrow its morphine and BAE
on that user maybe if you're a nurse you
can only do prescribed one only a doctor
can prescribe the other and maybe the
amount is also important here I think it
is yes yeah so to build custom logic
around this more dynamic requirement you
build what's called a handler the
handler has the space class but the
point is it is a generic off of the
custom requirement class and so this
handle method gets invoked dynamically
and parameters to this method pass in
the actual requirement object so at the
call location you would construct the
requirement object populate it with the
contextual data based on the operation
being performed passed it into the
authorization system and then this
particular implementation is you know
checking well it's whatever custom logic
is is appropriate for the hospital so
the user has to leave to be able to
prescribe medication if the amount is
low then we can let them in if they're a
doctor they can prescribe anything you
know so there's some logic in here
whatever that logic may be okay so then
at the call location what we would do is
then create the custom requirement
object okay right let's say that the
medication name is aspirin ASP IRM they
get it right that time wonderful and
actually our call is going to look very
much like this now yeah right we passing
the user and now we pass in the
requirement and I think we need to know
here yeah like that so you're going to
dynamically evaluate this based on some
varying amount of you know parameter
coming in so actually I've already
forgotten what our logic was so who
should be able to do what it looks like
if you first have to be able to
prescribe medication if it's below 10
anybody can do it above 10 a doctor
needs to be able to do it so I proceeded
room for placebo
okay so who are we logged in as we're
the doctor right now
so the prescribed medication okay past
ten in right the doctor can do ten or
twenty that looks good so if we then log
out and log in l Bob's the nurse okay so
here amount 20 okay now what's my logic
so of course you have unit tests overall
it is to make sure that they actually
are working the way you want and then
that actually is a valid point that's
one of the benefits or the whole point
of putting this requirement into a
separate class because you can in fact
test this oh you know what it's not
getting called at all you know what I
forgot to do yeah I forgot to put in the
DI system so that's actually probably
not a good default behavior so what I
did was you need to stick this into the
DI system so services dot transient
offers a shin handler I'll put in my
custom Handler like this we probably
guess that doesn't matter now we're
mining that one all right but that
doesn't interfere yeah I think all right
let's go back to our so right now we are
we can prescribe medication the Bob is a
nurse okay so 20 so they rebuild
now I want to put a breakpoint here to
see if this is in vacuum called
okay and it's not
I'm creating the medication requirement
where's my home controller Oh am I going
to this method
maybe that's probably what's happening
it doesn't even help does it
okay one more time live debugging in
front of 100 people okay
no it's prescribed about med no thank
you I was going to the wrong line okay
all right here we are we finally hit the
correct method okay we're hitting our
handle as you can see now we're going
through our authorization logic so the
other benefit about this is that this
class is in the DI system this class
itself can take dependencies and what
does it take in dependency on the
author's they can provide a client
object so all anything else you want or
yeah your custom DB contacts or some web
service you want to invoke so again this
is calling out to our centralized
service to figure out if the user can do
these various things in addition based
on that authorization okay so hopefully
no we're not allowed so now we should
get the forbidden page good code okay
okay yes okay so that's the policy based
system yeah a student co-author ization
api has another approach they call
resource based authorization and the
idea is now you know so far we kind of
only took into account the permissions
of the user that is performing the
action right we haven't taken into
account the object on which he is
performing the action right so in our
scenario that would be the patient right
so you're prescribing some medication to
a patient so what if the properties of
the patient changed the outcome of your
decision right so for example he has
allergies that maybe he's allergic
against morphine who knows yeah so so
that the whole resource based API that
that Microsoft put in there is a way
basically to
to take one more input right so you
already have the requirement and you
have the user and now one more input
comes in which is the resource that
you're trying to manipulate so to speak
yeah which is not a very nice word for a
patient and they also offers the
operation yep yeah which is the
requirement and oh okay so I have anyone
try this API already in agent for now
okay so you know we were pondering if
how useful that is really and if it can
be generalized and if it would fit into
anything that can be done as a reusable
component so you know just quickly show
how that works actually okay yeah okay
so now you basically what once you go
down this is level deep where the
properties of the thing you are
manipulating changes the outcome of an
authorization decision you are very very
close to Quartermaine business logic
right
so yeah just show it yeah so here's our
now our new requirement has to do with
prescribing the medication in this case
the you know the the action is the
action of prescribing now the resource
being prescribed to the patient we're
going to model some allergies and that
this version is same as the previous
handler where for a custom requirement
you build a custom handler this version
though now takes two generic arguments
right which is the operation and the
actual resource so the version of handle
here takes now three arguments which is
the context which really has our user
the context like I said and now the
patient so now again you have to go
through all the same you know bits of
logic to figure out if the current user
is allowed to prescribe this amount of
medication on this patient and as you
can imagine you know we have to kind of
repeat that same logic that we had
before we see if the user is allowed to
simply prescribe we have to repeat our
prior limits you know the amount of
medication and then we continue on and
now finally can look at the patient yeah
and you know the well the reason that we
have to repeat this logic is because one
handler can
to use another handler you might think
oh right I already have half of this
logic in the other handler it turns out
because these are all in the DI system
they all get injected as one big array
or one big collection so they can't take
dependencies on one another
unfortunately so so so just to think
that either did occur to me if you know
like this line here line 16 you know Ted
is where the real domain logic is right
I mean you're not just saying I'm
allergic
against aspirin by the vu you pass in
the name of the medication and then some
some some service needs to know what is
inside of that medication and figure you
know I mean and that now is you know
that's not even authorization anymore
right it's just like a core domain
knowledge like if you're building a
hospital application you probably have
very very smart people figuring out
which combination of medications is it's
good for a certain patient right so yeah
so just go back to the Google go to the
last slide the big witches are kind of
our conclusion here yeah so you know
like when all these people asked us can
you build something reusable for
authorization we we we were pretty sure
we can build something for cost cranes
authorization like if someone allowed to
access an API that's easy right
if someone allowed to use a certain
feature of an API that can be done with
roles and permissions but once you are
inside that feature
you know like figuring out if this
medication if if a nurse is allowed to
prescribe this medication based on the
allergies of that user I don't even I
don't even sure if that authorization
anymore right that might be just
business logic you know and pretty
pretty sensitive one in that case as
well yeah well that's the whole point of
your system right is to build that that
logic around how to run a hospital first
and I think that that's why X agonal
failed as well because they try to force
people to now formulate they're
launching in XML right I mean why
wouldn't you just write some good old C
shop code or call an API that already
exists because that's our core business
right
so our initial question was when we sat
down is like can we write at one
framework to rule them all they are like
the one authorization framework that
just works for everyone and I think our
answer at the end was no right you can
go up to a certain level they are role
permissions maybe get a little bit more
fine-grained even but once you are
inside the feature as we call it here I
think it's a not authorization anymore
and B it's indeed so application
specific that I don't think it makes
sense to write a framework for it write
your own framework that's the conclusion
any questions yep
so that the question is you were missing
the authentication piece yeah right
that's authentication yeah so yeah we
didn't do that because we do it every
year this year we thought this was a big
difference yeah nobody know that you go
right here maybe go back to that yet to
this picture here so before we can
authorize something you have to know who
the user is right so and that data can
come from a local database it can come
from Active Directory it can come from
external identity providers like Google
or maybe have a business
business-to-business like like hospitals
that irate with each other these days
actually maybe that's a doctor from a
different Hospital right and depending
on which claims he has in that origin
hospital he might have different
qualifications in the current Hospital
things like that yes that's a whole
other topic right but the way we
designed our engine is just go to the
the one with the input data yes no no's
in the next next slide the way we
designed our engine no next one and one
more yeah the way we thought about is
yeah is that you hand us identity claims
into the system's right and where they
come from they might come from your
local identity provider it might come
from an external identity provider which
typically means they get transformed at
the edge before they enter your system
right and then you hand us this list of
claims about that user and then the
rules engine maps them to permissions
right
for what exactly that that's what
identity wise doing right that's what
it's good at authenticating users
transforming identity data into tokens
and then once you have that token this
thing would take over and change it into
authorization data okay yeah OOP louder
yeah what's the code in the slides not
yet
let us do a little bit more a nicer
version of that and then figure out how
we exactly pack it to that but yeah I
don't think the code is the most
important part of this talk it's more
like the pattern well but yeah we will
get to that
okay cool one more question or two or
are we done like a head start to the
buffet I think we're done okay thank you
for your time and enjoy the rest of the
week thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>