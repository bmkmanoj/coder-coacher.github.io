<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>JavaScript's Most Wanted - Todd Gardner | Coder Coacher - Coaching Coders</title><meta content="JavaScript's Most Wanted - Todd Gardner - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>JavaScript's Most Wanted - Todd Gardner</b></h2><h5 class="post__date">2016-09-09</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/sH2mUncl2WU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">- right okay
hi everybody whoo how's it going
haven't good in DC first one that first
one in Australia how's it going so I've
been to a bunch of the NDC events
they're all they're all really well done
and so far this is no different this is
this was going great how many of you are
JavaScript developers how many of you
are just forced to write JavaScript but
you're really you know you'd rather not
that's really that's really most of us
right like when you have a choice how
many people just choose JavaScript even
when you have other options
unfortunately we don't have a lot of
other options especially if you want to
do like highly interactive sites in the
web so that's what this talk is about
this talk is about your web applications
the stuff that you're building and how
it's eventually going to break in the
hands of your customers this talk is
called JavaScript's Most Wanted and it's
about outlaws it's about the JavaScript
errors that happen in production for
your real customers even when you don't
you never emerge during testing even
when all of your developers and all of
your QA staff if you have them never
expose stuff the crazy stuff happens
when you actually put something into
production on the real internet the
Internet in a lot of ways is still the
wild wild web it is as Crockford says
the most hostile development environment
imaginable because JavaScript itself is
kind of hard there's a lot of complexity
just in JavaScript as a language and
then we add on top of that that we're
gonna take this JavaScript application
that we've built and we're gonna ship it
down over an Internet that is as you
well know I'm not always very reliable
honestly in the last few days that I've
come to new realization on how
unreliable it can be accessing it from
from this part of the world
I'm sorry so you take this JavaScript
app and you try and shove it down these
pipes across this Internet into a
browser environment that you also don't
control you're trying to just build an
application that will run in your
customer's browser that maybe you built
it in Chrome but they're running it in
ie9
does it work should it work
maybe not only are they running it in
some old version of a browser but
they've put a bunch of gunk into it that
ask toolbar malware is injecting ads
into your page or they have an ad
blocker that's stripping out a bunch of
analytic services and does yours app
still work when all of the analytic
services are gone there's so much that's
gonna break when we actually get into
the real world and so that's what we're
gonna do today is we're gonna talk about
six of the most common errors that I see
happening in production apps how do they
manifest themselves how do how do we see
them in reporting tools how do we
diagnose them we're gonna open them up
live in chrome debugger and we are going
to diagnose fix them and show you how
you can prevent these things from
happening in the future sound good
awesome so in order to like expose these
bugs we need honeypot we need something
for these outlaws to attack and so I've
built this app for all these outlaws to
come out now I want to show it to you
it's called soliloquy so soliloquy is
this thing I've been working on and it's
what I call an anti social network it's
kind of like Twitter so just like
Twitter you can type in you know
narcissistic thoughts about yourself and
what you're doing and just like Twitter
those will show up here in a timeline
that you can look over and just like
Twitter I have annoying inline ads that
are injected into those timeline and I
have some amazing sponsors already from
from cats and bacon more bacon and and
mr. Dundee and so I have all of these
things coming in that's just like
Twitter but unlike Twitter
I've left out one of the most annoying
things other people because with
soliloquy it's all about you only you
can write status updates and only you
can see your status updates right so
this so look we is going it's going to
be huge right if anybody here is you
know venture capitalist get your term
sheets ready like this thing is going to
be amazing
but I want to make sure that look we has
has a really great user experience I
want people who are using this to have a
good time when they're doing it and make
sure it doesn't have any airs no no the
outlaws attack and so in order to do
that I'm gonna protect soliloquy with
another thing that I work on which is
track Jas so track J's is a JavaScript
air monitoring tool that helps us
understand when things are gonna go
wrong and we're gonna show just a little
bit about that but this isn't really
about that what treks yes does this is
the entirety of the sales pitch is we
capture really detailed error reports
about like how did a user get into this
situation
what were they entering what were they
clicking on what kind of things were
happening in the console that led to an
error so we can give people really
detailed error reports and I wrote it so
like if you wanna know more about it we
can talk later
so let's get into actually a real error
so here's our first wanted poster this
is our most wanted and this is an out
like all script dijo how many people
have run into script dijo script err
this is the most common error that has
ever been reported into track J's or
anytime I've worked with a production
app so what happens with script dijo we
just launched look we not that long ago
and we only get about 2,400 hits a week
and script error happened right away as
soon as we launched 2,400 times this
script err happened and it didn't just
affect like one-off browsers it didn't
affect just you know ie 10 or whatever
this is affecting everything this is
affecting recent versions of tons of
different browsers across the board
so let's let's take a look it's the
locally itself we'll look at some code
we'll see if we can diagnose what's
going wrong alright so here it is let's
pop open the dev tools and see what we
can see maybe we should look at the code
first so here is here is the code of
soliloquy I trust you all have signed
your non-disclosure agreements under
your chairs right good all right we'll
move on so here's that here's the code
backing soliloquy and it's not it's not
all that complex but one of the things
we need to do is we need to capture
these errors that are happening in our
app and show and send them back to my
server so that we can like see what's
going wrong and one of ways you could do
that was with direct yes but for the
purpose of this demo we're gonna do this
right here
so window dot on error if you're not
familiar with it is this function that's
existed since the very beginning of
JavaScript in the browser and it allows
you to basically attach a function to
get any unhandled the error that happens
on the page and it'll just dump into
this function and you can do stuff with
it
and so what I'm doing is I'm just going
to push it in the console so that we can
see it and so what this is going to show
us is what is available to us
programmatically when an error happens
what can we see about it it will go the
console but in a slightly different way
and that's what we're gonna show I'm
going to show you right now so if we pop
this open and reload the page we see
some errors on soliloquy now the second
error is this big enough is this too
small for anybody all right good
so this second error is this uncaught
reference error now this is like a real
error this is this is informational but
this isn't JavaScript telling us this
that's chrome telling us that chrome
operating at a different level of
abstraction it's actually telling us
real data what's available to us
programmatically that we could actually
like send back to our servers or dump
into a log or try and do something with
it is this right here is this this array
programmatically we think there's a
script error
we don't know the file we don't know the
line we don't know the column and we
don't know anything about it it's just
your stuffs broken dude that's that's
all we know
of course like it's a real error but
it's being hidden from us so why is it
hiding it from us so what's interesting
about this is that this the underlying
air is coming from this file called the
side bar add provider and what's
interesting about the side bar add
provider in this case is not necessarily
even what's in it but where is it coming
from
the main app where I'm coming where
soliloquies coming from right now is a
domain called dub dub dub soliloquy dot
local
but this file this side bar add provider
is being served from somewhere else it's
coming from this place called ads dot
local which is a different origin so the
Brout how many people have heard the
term same origin policy that's what
we're dealing with right here part of
the same origin policy is trying to
protect information from leaking between
origins one of the ways information can
leak is in an error and so because side
bar add provider is in a different
origin than the rest of the page chrome
is trying to protect it and say hey I'm
not actually gonna reveal any details
about this thing I'm going to strip
everything out of this error and say
something broke you got to go figure it
out yourself
and so that is the actual origin or the
browser origin is the origin of script
there but there's a way we can get
around it so side bar add provider is
coming from this other origin but we can
tell the browser to go ahead and trust
origins and let that information cross
and we do that with cross-origin
resource sharing or cores you may be
familiar with cores if you're used to
Ajax calls to different domains if
you're integrating with third party API
is that's typically what we're course
comes in but it's also really useful in
this case because when you take a
javascript file and you serve it with
the cores headers like I'm doing here
like I'm doing here access control allow
headers and access control allows origin
these are the HTTP headers that come
from course or cross-origin resource
sharing and what this is doing is
because the web server is serving this
file with these headers it's saying hey
you can go ahead and use this anywhere I
don't mind it's cool you can we don't
need to hide this information and so
we're already doing that so we've done
half of the problem but now we need to
tell the browser that our page also
trusts that file both sides need to
trust to make sure that works so there's
a really cool way you can do that it has
fairly new inside the HTML spec so
here's all of the script files coming in
to to soliloquy and you can see that
like they're all coming from different
places right nothing is actually coming
from dub dub dub soliloquy I have a
bunch of like my files coming in from a
CDN which a lot of people do for like
performance reasons and then I have a
couple of different files coming in from
ads dot local and so I would have script
air all over my out anytime anything
goes wrong it's guaranteed to be on a
different origin right now because
that's where all of my scripts are
coming from and so script there would be
all over this app but we can get around
that by there already being served with
course headers and now we just need to
tell the browser to trust these and so
we do that by decorating these script
tags with cross-origin anonymous which
is new inside the spec and what this
tells the browser used when we're
loading this file look for those course
headers if those course headers are
their same origin policy doesn't apply
anymore we're good to go we trust this
file both sides trust it and we're good
to go so I'm just going to copy and
paste this little sky down
and if we reload our page here we can
see that we actually haven't fixed the
error itself right we haven't changed
anything however what we're able to get
now is real data so programmatically we
now know that a bunch of our users are
having this uncaught reference error
that's coming from side bar add provider
on line 20 column 16 with a stack trace
and so by putting this little change
we're able to get around script there
and actually start addressing some real
problems in our app and so this was
script yjo script each row comes from
browser obfuscation due to the same
origin policy and it's really noisy if
you start capturing JavaScript errors
from production on your apps this is
gonna be one of the first things you run
against it's gonna hide all kinds of
good details from you and so you're
probably going to have to deal with this
sooner rather than later so there's
really two ways you can do it if you
have to load from third parties which if
you're using a bunch of services in
every you'll you'll have to reference
something from somewhere the way to do
it is with Korres and cross-origin
attributes alternatively just load
everything from the same origin and then
you don't deal with this problem that's
of course a performance trade-off you
have to deal with whether or not the
advantages of loading from CD ends or
other parties is worth losing that
visibility so this was our first outlaw
it was hiding the other outlaw which is
Jane ads II Jane ad Z is manifesting
itself as this area which we saw a few
minutes ago this get random ads is not
defined and what's interesting about get
random ads is not defined is that I've
been monitoring soliloquy for a little
while and you know I was a little a
little nervous every time I'm leading up
to a talk and so I I don't want to like
change anything like we went into code
freeze on soliloquy I didn't want to
break it last minute and so I hadn't
checked anything in for like a couple of
weeks but all of a sudden yesterday for
no apparent reason
BAM my error rate is up 6,000 percent
like what is going on I didn't change
anything you didn't change anything
why is this thing blowing up so let's
take a look at some look we and see if
we can figure out like how is this
breaking and why is this breaking so now
if we take a look at our console here's
that same air that was being hidden bye
bye bye script D Joe before and let's
actually like dig into this a little bit
so here chrome is just telling us hey
this is an uncaught reference there get
random @ is not defined so it's coming
here from from side bar add provider and
the chrome dev tools are like really
smart and it's basically telling us
exactly where this thing is going wrong
it's saying hey we tried to call this
function inside of this file and and we
didn't it's not there there is no
function called get random at so let's
maybe take a look at this file this
isn't mine
right this isn't part of my app this is
something from an advertising provider I
put this thing on my site to try and get
ad revenue so I could like monetize my
site but I didn't write this code so
let's maybe we'll take a copy of it down
locally and we'll see if we can can fix
it so this was the side bar add provider
and it was this line here this line 20
get random ad so we just look around
like it's not defined let's see if we
can find where this is looks like we
call it a couple of different places
down here at the bottom there's this
function called get random ads maybe
maybe this was just somebody like you
who didn't know how to exit vim
correctly and you know left a little a
little thing let's let's just try it
let's just try it we make that change
and now let's reload look no there's no
error and look at all these new ads I
have now I got even more bacon and and
bears and and mr. Dundee I actually just
put Dundee into this demo for you
usually usually I taught I used David
Hasselhoff but I felt like this might be
better
all right so this error was trivial
right it was a typo we all make typos
I've made lots of typos the problem here
is that this was a typo that was
introduced beyond any controls that you
or your organization's can put can have
right you're relying on a third party
who's writing JavaScript that you were
injecting into your app at runtime like
whenever a user connects to it this is
unplanned changes anytime you are
bringing in a script from somebody else
even if that somebody else is somebody
really trustworthy like Google or
Microsoft or Twitter or stripe or
Braintree or a payment provider anytime
you're doing it from anybody you are
giving control of the runtime experience
of your app to another organization we
need to recognize that like we kind of
gloss over that fact today but we are
introducing the ability for some other
team to break our app even when we're
not in active development a web app
should never not be in maintenance you
can never just disband the team and say
hey this app is done because the web
isn't done the web is still dynamic and
it's still injecting stuff and so
anytime you were building an app and
you're bringing in a third party you
have to weigh the risk way the value of
bringing in third parties versus the
risk that they're going to create
problems in your app downstream
compatibility with new browsers etc okay
so those were our major blocking errors
so now let's get into some stuff that's
a little bit more subtle so this is
Claira context and clear context reports
and error as cannot read a property of
undefined and so we're seeing this a lot
inside of soliloquy and and one of the
things that we're looking at here is
that this this error is manifesting as
can't read property destroy of undefined
but every time it happens well we what
we're seeing in our logs is that
immediately before it happens the users
clicking on this button
this j/s - delete - statement and then
this error happens so I think I have
enough contacts that we could like go
into soliloquy and see if we can
recreate that so let's just refresh this
so I happen to know because I wrote it
that that jeaious that statement delete
button is this little garbage can right
here so if we just give this a little
refresh and if we try and delete one of
these statements we see that we print it
into the console that we were going to
attempt to delete a statement with an ID
but it blew up uncaught type error
cannot reproduce troye of undefined it
exactly what we were seeing in our logs
so let's see if we can figure out why
that's happening so I'm gonna just use
the chrome tools here and and we'll pop
open and like take a look at stack trace
that's a kind of a terrible stack trace
sum function that doesn't have a name
blew up on statement view J s line 30
that's not really that's not really a
very cool stack trace I don't really
understand anything from that but
recently in the let well not recently
maybe 12 18 months ago chrome shipped
with a new feature that's off by default
but it's really cool so if you go and
look in the sources tab where you look
at all this code there's this little
checkbox down here called async now this
is amazing
so javascript is an async language so
much of the stuff that we do with
javascript is we're setting up functions
to be called back later do something
later when the user duck when the user
clicks on this do something later when
the network is done do something later
after a timeout has occurred but
whenever we set up these things we lose
context because the all of the code that
we were setting up our application and
deciding what callbacks to attach stops
and then we wait for users to interact
or networks to complete and then starts
back up and we lose all the contacts all
the logic about what
functions were executing we lose in
those asynchronous boundaries we don't
know why are we we know what blew up
inside of a callback but we don't know
what attached that callback and why and
that's what this async check box does so
I'm gonna click it and it's gonna be
amazing so we're gonna refresh this and
we're gonna do the exact same thing here
again I'm gonna try and delete this
statement this time we have async stack
traces turned off I'm gonna delete it
still don't have this problem fixed
let's pop over and take a look at this
stack trace now though BAM that's
awesome all right so we still have this
same line this is what blew up an
anonymous function on statement vue.js
line 30 what we know is that that
anonymous function was passed in a
callback to set timeout and that set
timeout was called inside of a function
that actually has a name called on
delete which is also on statement Vijay
s we know that on delete was called by a
dispatch thing from jQuery and an event
handle which is kind of enough to know
that like hey there was some event that
happened jQuery was wrapping up an event
and I'd said hey handle this event with
on delete on delete said hey I got to do
stuff later I'm gonna pass this thing
and it's in two set timeout and that's
what blew up and now I don't even looked
at code yet and I have way better
context of what happened because I can
see this history so let's take a look at
statement view J s line 30 and see if we
can actually get to the bottom of it so
this so locally happens to be written in
backbone which I know is like an ancient
you know framework in you know
JavaScript terms but like it doesn't
really matter at this point we're just
talking about raw JavaScript so let's
take a look at this on delete function
here's here's line 30 give you a moment
to digest that
has anybody spotted the problem yeah
this this is the most common error in
JavaScript even for very experienced
people like myself I make this air all
the time still we're passing a function
into a call back or we're passing a
function into into an asynchronous thing
into set timeout and inside of that
function we're using the keyword this
implying that there is an object context
that we're running inside and I want to
access properties or functions on that
context this is some object to represent
statement view on line 29 and on line 31
but on line 30 this is cast into the
future when this set timeout expires and
in the future we don't know what this is
in this case this is probably going to
be the global object it's probably gonna
be window when set timeout expires and
it calls our callback it doesn't know
the context it was executed at and so it
blows up and so the specific error that
we're getting the specific error that
we're getting is cannot read property
destroy of undefined it's trying to find
a property destroy on this thing called
this dot model but this isn't what we
think it is and so this dot model ends
up being undefined and there isn't a
property called destroy on undefined and
that's why that error gets generated so
there's a couple of different like easy
ways to fix this right and like probably
the most common is just to save off the
context that you want to operate in and
so depending on which JavaScript book or
blog you might have read first will
dictate your preference on whether or
not you feel this should be called VAR
self equals this or var that equals this
right who's a who's it who uses who like
self
who likes that I like that
anyway so we take a cut we we basically
grab a reference to what is the context
that we care about and we store it in
another into a value that we control and
then we can fix that just by saying that
dot model dot destroy right see I like
that because it's like go destroy that
model like you've you've like taking
this and you've made it a bat it's not
yourself anymore it's it's somebody else
anyway all right so this was this would
be one easy way to solve this we could
check this real quick and make sure that
this works yeah we can delete a
statement but there's a bunch of other
cool ways we could do this too like so
for example this is a really simple
function it only references you know
model dot destroy so we could be like
maybe a little bit more explicit we
could say something like bar model
equals this dot model and then we'll
just reference it as model dot destroy
that would work too
or we could we could use some new
advanced JavaScript be things and we
could actually set the context that we
want to operate in and so then let's
just back all this out and leave it as
this what if I just want to make make
sure that the context of this function
that whatever this is is something I
control and we can do that because in
newer releases of JavaScript functions
have some things we can do with them
like we can bind them a bind lets us do
is it lets us set whenever this function
is called here's what your this is I
don't care what object you're executing
in I don't care where you put the
function we are like attaching a context
to a function permanently and so we can
do that by just saying hey bind the
value of this from you know our outer
closure into the value of this on the
inner closure and this should work if we
refresh this yeah we've bound it but
this isn't the most compatible thing in
the world right this is this works in
chrome and working in edge it'll work in
Firefox but
it probably won't work in like ie9 so if
we wanted to work in like older browsers
which I do for first a little quake we
could polyfill this
so we're can I'm using a backbone here
which already takes a dependency on low
- low - is like a really popular like
set of utilities for JavaScript and it
manifests itself as you know an
underscore so what we can do is we can
use underscore dot bind the function to
this now this is a super compatible way
of doing the same thing now it's not
native in JavaScript you have to bring
in this utility library to do it but it
does give you the benefit if now I can
do it in this style of gluing the
contexts together and it should work in
every browser now it's probably a little
overkill for this particular example
because I got one line here but if you
had a more complex callback with a lot
of stuff going on there might be design
advantages to actually gluing context
together I think it's just called
function dot bind it was an extension as
part of es6 alright so now we can delete
statements right up until we get to ads
suite alright so here was our yours our
outlaw Clara this in that context now
this this error this isn't something
that would arise only in production like
this is a logical area this is a this is
just a straight-up bug in JavaScript but
it happens so much JavaScript of apps of
reasonable-sized gets so complex to test
every possible edge condition of the
order at which things happen in the
network stack in interaction stack in
time out stacks that even though it's
theoretically possible to discover all
of these through a robust set of unit
testing almost nobody does because it's
too expensive to test every single
possible permutation
and so we still see this air is one of
the most common things that happen in
production so this you can find anytime
there is a functional argument if you
are passing a function as an argument
into something else and that function
has the keyword this anywhere in it
throw up a red flag make sure you
understand the context that that
function is going to call back with and
that is like the key on how to do this
so this happens with callbacks with
promises with async any of the ways you
can do this you still have this problem
and you need to like make sure you
understand the context if you're going
to use the keyword this okay let's move
on to the next one so this error is
dolly data dolly data manifests as
substring is not a function and this
one's pretty isolated like we're not
seeing very many people have this in
fact only one person has this we saw
this error 2,000 times but we saw it
2,000 times from one person one person
just reported this err that many times
and so like maybe you don't need to care
but like something is definitely going
wrong for this person and I want to see
like I want to see if we can fix it so
this particular person seeing this a dot
text sub string is not a function so
let's take a look at soliloquy and see
if we can understand why that happens so
if I just refresh on you know my demo
customer here everything seems to work
so maybe it's something with this
particular customer right so looking at
my log I see that hey this is you know
customer ABC who's having this problem
so let's let's go and load their data so
when I load soliloquy for this customer
they have a kind of a terrible
experience here they see nothing like
none of their stuff is there none of
their their posts none of their data if
they try to interact with it it just
goes away when you refresh nothing gets
persisted and they're seeing this error
a dot X dot substring is
not a function so something is
definitely going wrong here
so let's take a look at at statement
model J s line 21 where this problem
seems to be happening so here here's
that here's the error in question or the
line in question and so it's happening
right here so let's let's break this
down and see what we can figure out
what's going on so I have a function
called parse and parse takes this thing
called RESP or response probably so
we're probably dealing with like getting
some data from somewhere and now we have
some expectations on that data it looks
like we're transforming some data we're
using another lodash underscore function
called map which allows us to iterate
over an array of objects and transform
them from one thing into another so
we're looping over RESP so at this point
we already have an expectation RESP is
an array of objects right so we're
looping over it and then for every thing
inside of it we're expect we're setting
a property called text on it
we expect text to already exist and we
expect it to have a function on it
called substring so we're expecting we
have this set of expectations already of
this data where item is an object it has
a property called text and text is a
string so that we have a substring
function but that's blowing up so we
just like set a breakpoint here and take
a look at what actually happens when
this runs let's just give it a little
refresh we pop in and let's take a look
at what's in RESP I'm just going to go
down here to the local scope and pop and
take a look so here here's our object
this is minified code and so it's
actually called a even though the source
map is showing the item we don't need
talked about that right now this is RESP
so RESP is an array it's an array of
objects we already see that there are
101 objects in this array so so far so
good we're matching our expectations
let's take a look at one of these
objects we pop into the object we do see
a property called text
but text is not a string text is a
number and a number does not have
substring I can't go into my console and
type I don't remember what what did it
do
substring 0 140
subscrive zone function that doesn't
exist on number so why is that happening
so if we look at our network itself
sunshine this breakpoint go if we take a
look at the this network itself the
response that we're getting from our
server indeed has an array of objects
with a text property that's 42 so my app
is blowing up because my client side has
one set of expectations my client side
was written to expect I get an array of
objects with a string on it but my
server returned an array of objects with
a number on it and my app blew up
because it didn't know how to handle it
so if we take a look at the code in
question which was statement model the
code the server shouldn't have done that
right somebody probably made a mistake
something got released the API changed
somebody fat-fingers something maybe
somebody attacked my API and inserted a
piece of data that shouldn't have gotten
in there for whatever the reason it
happened and so we should change our
Java Script to be more flexible like if
if this is an expectation that isn't
always true we should really be safe
about it so maybe what we should do is
we should say you know whatever rest
doesn't even exist maybe we should say
hey we're either going to iterate over
RESP or we'll iterate over an empty
array let's make sure that it's real and
I'll let's loop over the things in it so
we'll take a look at item well I think
that text might not even exist
and if it does exist it might not be a
string in which the case we have here so
we should just check that we should say
like if if item is a thing and if it is
string item dot text
so let's just be safe about it we have
these expectations let's call it out so
we're only going to you know do this
transformation on item text if it's not
but what happens if it's not what should
we do if item dot text is in the is in
the wrong format we should probably do
something we should probably write
something to our logs so that we know
stuffs going wrong so maybe we'll do a
console dot warned we got bad data we
got bad data item and then what do we do
as far as the user cuz like item dot
text is probably a thing that the UI
needs so we should probably write item
dot text is invalid data or whatever so
if we put this in place and take a look
at at our code now our UI actually loads
now because now we're able to process
that data so it still looks a bit the
greatest user experience in the world
here right because the user has a time
line full of invalid data messages but
we're at least able to show them
something the app just doesn't break on
them overtly and our logs themselves
report something there's way more that
is much easier to understand what is
actually going wrong we don't see this
something blew up because substring is
not a function that will require
diagnosis we see that hey we got some
bad data here was something we didn't
expect that came down from the server so
this is the kind of error that happens
when a client-side expectation doesn't
match a server-side expectation which as
people are building more and more
complex apps is happening a lot more how
many of your organization's
have a different group of people working
on the backend api's versus the
client-side front-end application if a
back-end team and a front-end team right
this happens when you have
different teams somebody thinks the
datatype is X it ends up being why the
expectations don't match
maybe the API releases code before the
front-end got out and you you have a
mismatch so this tends to happen and you
end up with a production fault two
different teams working on different
expectations happens anytime you see
separate teams working on the two sides
the trouble with this is it's really
difficult to prevent with standard style
unit testing even if both the back-end
team was testing all of their api's and
the front-end team was testing all their
expectations the problem is that nobody
ever integrated them together and
actually ran through a test and so you
got to make sure that you're constantly
monitoring on what actually happens
doing a full end-to-end test before you
put stuff into production and even
watching when it's in production to make
sure stuff doesn't change this one is my
favorite for Australia
this is script eg earth this is script
load failed this manifests itself as
something is not a function now this
isn't happening a lot you know we get
about 2,400 hits a week on soliloquy and
this has only happened 134 times if it
happened to 129 people so this isn't
like a one-off this isn't one user with
a bad situation this isn't like a none
compatible browser this is something
that a significant amount of my
customers are running into and it's
pervasive there's more than it's
happening to multiple people so let's
take a look and see if we can figure out
why does a dot inline ads why does that
break I'm going to switch back to
standard customer all right
so looking at soliloquy refreshing it
here I do not see that error it's not
happening for me close the bug works on
my machine right move on now let's
figure out what why would this happen so
let's let's look in our code and let's
just do a search for inline ads why
where is that where where does that come
from
and that's defined in two places here
it's defined once in one of my
advertising providers one of my
advertising providers defines this
interface when I use this provider it
says hey put our script on the page
well we'll create this function called
inline ads and you set up your
advertisement with that so here's where
window dot inline ads comes from and
then I use window dot inline ads here in
my main soliloquy JS file so I'm setting
up the page I want to like put some ads
on the page initialize it and do some
stuff and so like I don't know why this
wouldn't be a function like I have one
file that puts it on the page and I have
another file that uses it and like
there's no real variability about either
of those so if we go and look at the the
actual HTML file that this comes from I
see all right here's here's inline ad
provider it's coming in right here
here's where it wouldn't get defined why
would why would it ever not get to find
well let's just pretend it's not there
let's see if we can like recreate the
problem so I just comment out inline ad
providers not on the page and reload I
absolutely get the air that was reported
this a dot inline ads is not a function
so this is this is what's happening but
look at the user experience again when
this happens for those 130 some people
like this is what soliloquy looks like
to them looks like crap there's nothing
here none of my ads are there I'm not
making any money there timeline isn't
there if they were to like type some
stuff in and try and interact with it it
just doesn't do anything it's just
broken and they're like the soliloquy
thing sucks I'm gonna go back to Twitter
so that's not what I want I want people
to use this so look why would this
happen why would this that why would
this happen and why this happens it's
probably way more clear to you than most
people who I've talked to because you
live in Australia and sometimes
sometimes stuff just doesn't load
and that happens a lot at the recent
Google i/o conference they released some
internal numbers from Android and when
Android is making an HTTP request based
on the network that it's on between 1 &amp;amp;
4 percent of the time that request just
fails like maybe the D the SSL handshake
failed maybe the maybe the DNS lookup
failed maybe like you just went into an
elevator and like you lost connectivity
maybe you lived in Australia like a lot
of times it's just the request doesn't
work and so that's what's happening here
is that on a significant percentage of
time in line add provider Jess doesn't
come down now that could be any number
of things maybe their DNS service is
like a slightly slower maybe maybe it's
just random and like various different
scripts are like failing to load often
but when this particular script fails to
load it manifests itself in a really
dangerous user experience and a really
bad a bad experience for my customer and
so let's see if we can like be a little
bit smarter about that so here where I'm
using that file is right here right here
on line 38 I'm just calling a function
called window dot inline ads and I'm
setting it up so I'm giving it my you
know customer key I'm saying hey I want
to like you know show ads every 700
something I don't remember we're just
calling this function with our
configuration but what's happening in
these small set of cases is sometimes
inline ads isn't a function it's not
there so let's check it let's just be
obvious about let's say hey if window
dot inline ads is a thing then let's set
it up and if it's not a thing again
let's just put something into the log
and say inline ads bailed again get them
to give you some free stuff and then
just continue like inline ads in the
case of soliloquy it is
the killer feature if I if I don't have
inline ads are you really gonna care if
you open Twitter tomorrow and all of a
sudden all the inline ads were gone to
care that much would it like negatively
affect your experience and so like this
is something that's not critical for me
and so just by taking it out of the
critical path and saying hey load inline
ads if they're there and if not like
just move on these customers these
hundred and thirty people a week who
have this problem they get a way better
user experience they don't even know
that anything went wrong and that's
awesome like we should they like it's
still failing but they don't they don't
need to have a bad experience and so
when we think about all of the different
scripts that we're loading all the
different things you assemble on your
page what happens if one of them isn't
there what happens if some random script
is part of your overall app just doesn't
come down what's the experience is it a
catastrophic things are just gone and
does it have to be what-if hypothetical
situation you had a credit card checkout
form and you use a third party script to
process that credit card like stripe or
Braintree or PayPal or any of those what
would happen on that credit card form if
they're JSF I didn't come down would it
work would it would you have a customer
typing in a credit card number nothing
happening and being really frustrated
would you your form take a credit card
number and then go and post it somewhere
because it didn't have the script to
like intercept it and do the proper
thing there's all kinds of terrible
things that can happen when just
partials of your application fails and
so we got to think end up being a safety
mindset the web is flaky parts of my
script or parts of my app are gonna fail
and we need to like fail gracefully when
it does all right I only have time for
one more error this one's kind of fun
this is my browser crashing and my
browser crashing is manifest by slow
performance and occasionally a browser
crash now the problem with a browser
crash event is that all the tools we
have to monitor web applications are
built in JavaScript they're inside
the application and so when the browser
itself goes down like the whole runtime
goes down with it
and so we don't know that it happened
like the whole browser just disappeared
and we can't get one more error report
out the door on the way out and so the
only way we really know this is
happening is when our customers complain
and unfortunately they complain on
Twitter and they say solutely such a
piece of junk I'm like been typing all
of my thoughts at all day and like it
just gets slower and slower and then it
crashes and it sucks and I hate it so
much
and and that's you know bad publicity
one and and two it's just really it's
it's not a fun experience for them so
let's take a look at silikal and see if
we can understand what happened so what
what we're hearing is that people use
silica leaf for a long duration and it
gets the performance suffers and and
then it crashes so that sounds like a
memory leak so there's a bunch of
different tools we can use to diagnose
memory leaks who's diagnosed memory
leaks before anybody sometimes it's
terrible but with some of the new tools
here I actually think it's kind of fun
so how I like to do it is I like to use
the timeline function in inside of
Chrome here and what the timeline lets
us do is it lets us record a series of
events and to end it give us a playback
of what's the browser actually doing
when we were doing those things like
what sort of events were happening in
the JavaScript layer what sort of events
were being painted on the screen and so
we can like diagnose behavior and so
what I like to do here is I'm gonna like
type a few statements into soliloquy and
then I'm going to delete those
statements back out what should
hypothetically you know change the state
of my application and then return it
back to the original and so I should
expect everything to kind of level out
so I'm going to just refresh the page
here quick make sure everything's clean
and we'll start recording and while
that's recording we'll say hello Sydney
you don't know what winter is this is a
mild spring day and then I'm going to
delete those all right so we've recorded
about 24 seconds of activity I won't
take a look at what that looks like
and I know this is a little intimidating
at the beginning like this this screen
just shoves so much data in your face
and so we're gonna break it down and
actually take a look now the thing I
think is confusing about this is that
the the place to start on this page
isn't at the top it's this line chart
right here right here on the bottom half
of my screen this is the place to to
kind of see what's happening and let me
clean I don't care about that I don't
care about that what I want to care it
what I care about here in terms of a
memory leak is I want to know what is
the JavaScript using in terms of its
memory how many HTML nodes are on the
page because the size of the page is a
reflection of like how much memory the
browser is using and I wanna know how
many listeners are attached to those
notes because that is a direct
correlation back to how much how much
JavaScript needs to remain in browser
memory to deal with callbacks to those
sort of events the more listeners you
have the more JavaScript can't be can't
be garbage collected and so when we look
at this here like there's a bunch of
stuff happening like there's definitely
a few drops there's a few garbage
cleanup events that happen but for the
most part we are kind of stepping up as
we go and like we're ending with
significantly more nodes and listeners
than we had when we started so like
there definitely is something hat like
there's definitely something going on
we're not we're not right back where we
started
so let's start digging in further and so
what's cool about this is that this is
your 10,000 foot view this is like in
general what happened but how we can
like start zooming in and see like the
nitty-gritty details so I used to play a
whole lot of video games a whole like an
unhealthy amount of video games and one
of my favorite I used to play a lot of
first-person shooters on computers
and and so the controls for all those
games is WASD on your keyboard right so
you could have like one hand over here
and the other on your mouse and really
rock some headshots it's the same
controls it's like it's a video game so
we like we can we we can interact sorry
please wait there we go there we go so
we can interact with our charts if you
get the right focus window which is this
little thing right here in the middle if
you get your focus window right there
you can interact with this just like a
video game where you're like zooming in
zooming out strafing laughs strafing
right dodging bullets taking a look at
JavaScript errors so what I want to zoom
in on here is this this step function
here I see a series of things that every
time this is happening it's taking up my
usage of both nodes memory and listeners
I want to see what's going on so let's
just keep zooming in and the closer we
get on on one of these closer we get on
one of these we see that like it's not
one big step happening there's a bunch
of little actions all happening together
and we see it happen not just once but
like multiple times over the course of
this lifetime of this app so I'm gonna
zoom in here on this one and we're going
to take a look at what exactly is going
on so the closer we get here our view
I'm gonna spin up drag this down here a
little bit our view here begins looking
not just like lines but we can actually
see what was going on that was causing
these things so I can actually see real
JavaScript that was executing and we're
like really fine green we're talking
about a difference of you know 18650
milliseconds two 18650 one milliseconds
we're like we are
real nitpicky here but here's what was
actually happening at this step this
timing is I see a timer fired that timer
fired this thing inside bar add provider
which called a function called place ad
which triggered some Ajax well this was
happening the number of nodes went up if
we keep going we see a timer fired again
the same the same pattern nodes went up
same timer fired side bar add provider
place add nodes went up if we scroll
over a little bit more we see it again
and then here's something just a little
bit different we see an xhr ready state
change so that's an Ajax completed and
Ajax finished we call the callback we
did some stuff don't have quite enough
screen real estate to show you much more
it called the function called place adds
success and the number of nodes and
memory went up and so we have this
pattern that every you know in rapid
succession the number of nodes are going
up and has to do with this side bar add
provider so let's take a look at side
bar add provider and see if we can like
reason about what happened here's a
function that we saw in our time line
place add and place add is happening
inside of a set interval so that's a
timer firing every so many milliseconds
we're on a loop where this callback just
says every so many milliseconds call me
so that's where we see a timer going off
it's calling place add what does place
add do place adds going out and making
an ajax call one of the other things we
saw that was contributing is an xhr
finishing and we saw whatever was
happening in response to that ajax
finishing was increase in the amount of
memory pressure we saw place add success
so this seems to be like related to the
memory leak so what's actually happening
here is instead interval the first thing
we do is we clear out some HTML
container we have some element it's got
some HTML in it we zero it out then we
go and make an AJAX call to a server and
we get some new content we get a new
advertisement and we take that
advertisement and we shove it into the
container again
and then we attach a click handler so
that we know when the user clicked on
the ad so you can see it kind of
happening here on that right-hand
sidebar we see every few milliseconds
the container for all of those ads
zeroes itself out we make a bunch of
calls and get new ads we put them in
there and we wire up click handlers the
problem here is that we've wired up this
click handler but we've never unwired
the click handler
so even though we took all of those
elements and we throw them away when we
zeroed out the container there's still
this little bit of JavaScript attached
to those elements waiting to be clicked
on there they're hanging out even though
they're not visible they're not
recoverable but this function is
attached to it and so neither can be
garbage collected and they just sit
there and grow so when we see this
happening all these ads that are on the
page right now for forbears
they're still there like they're just
floating out in the nether world waiting
for something that can never happen and
so our customers who who use soliloquy
all day after several hours like there
could be literally millions of pictures
of Crocodile Dundee just waiting to be
clicked on and it takes down chrome of
all the wanting to be clicked on takes
down the browser and so that is my
browser crashing that is the core thing
that causes memory leaks is detach Dom
elements it's why it's a core thing in
looking at memory tools it's when you
have an element and you remove it from
the core Dom but something is
referencing it there's an event listener
still attached to it that causes so much
of the browser's memory to be retained
waiting for these events to happen and
the characteristics of this is slow
performance and eventually crashing if
your app does any sort of client-side
rendering this is a possibility
unfortunately there's not a really good
way to monitor for these sort of things
and so I'd encourage you if you're
building one of these ambitious
client-side apps you need to
periodically scan for it and like the
tools are pretty cool and you can kind
of learn a lot about the base level of
browser interact
simply by like looking at the core
things of what is the browser doing when
you're doing these sort of interactions
so these were the Outlawz yeah go for it
yeah exactly so the question was could
we have avoided the memory leak by
calling off exactly you avoid it by call
by calling off when rather than just of
clearing all the elements out we should
have gone through them and detached all
the click handlers then cleared out the
element that would allowed the whole
thing to be garbage collected
you're right I should probably should
have actually like fixed it but I'm kind
of running short on time we could hack
on it after if you want all right so
these were the errors that we captured
today these were the outlaws first
scripty Joe it's browser obfuscation
it's the first air that you're gonna
have to deal with to actually get a
better picture of what's going on in
your client-side environment the second
is Jane ad Z this any time you're
introducing a third-party script you're
introducing some risk in your
application that some other organization
can make changes to your production app
Clara context is one of the most common
JavaScript development errors it's a
misunderstanding of context and the
complexity of JavaScript apps tend that
these even make it into production Dali
data a misunderstanding of a contract
expectation between a client side and
the server side if you have multiple
different things happening multiple
different teams working eventually
somebody's going to miss and you need to
be have ways to like test for this
during your deployment or monitor for
this in production
Logan no Loudoun this one's obvious for
y'all sometimes the internet breaks you
need to code your client side app
defensively so that when an arbitrary
script in your application fails to load
what is the experience you give to your
user can you gracefully to fall back
and finally my browser crash in memory
leaks happen when you do client-side
rendering you need to periodically check
your apps to make sure you're not using
up all the memory of your of your
customers and causing all of their
MacBook fans to spin up like jet
airplanes we did all that with the help
of Trek GS so Trek jeaious is a company
that I started does JavaScript air
monitoring all of the data that we have
today
was based off of some analytical tools
we took over the airs that have been
captured over the last six to twelve
months so this is like really the most
common errors that happen in the real
world and I am Todd Gardner I've been
your deputy sheriff today if you want to
talk to me more about JavaScript
JavaScript air handling anything really
you can get me on twitter todd h gardner
you can hit me up on email or i'm gonna
be hanging out all week thank you very
much
I also organized this thing called pub
comp which is like the after party on
Friday tickets are literally about to
sell out so if you want to go to pub
comp and you should because it's awesome
it's basically a dev variety show in a
bar like I pull a bunch of the NDC
speakers in and they do five-minute
funny talks and then we buy a bunch of
beer so I mean how bad could it be right
so grab a ticket for that at a pub conf
do you should do it sooner rather than
later thank you very much I'll be here
if anybody wants to hang out and talk
sorry one more thing there's a rating
thing if they do these at all the NDC
you give me a card based on what you how
you think I did if you give me a green
one you can have a sticker that is over
there if you don't give me a green one
you can still have a sticker but I'll be
sad about it okay</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>