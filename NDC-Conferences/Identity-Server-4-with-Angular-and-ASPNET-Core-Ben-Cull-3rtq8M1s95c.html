<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Identity Server 4 with Angular and ASP.NET Core - Ben Cull | Coder Coacher - Coaching Coders</title><meta content="Identity Server 4 with Angular and ASP.NET Core - Ben Cull - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Identity Server 4 with Angular and ASP.NET Core - Ben Cull</b></h2><h5 class="post__date">2017-07-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/3rtq8M1s95c" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">well good excellent welcome everybody to
the final session I'm going to kick off
now because we have got a ton of
information to cover today okay just an
absolute ton so the sort of speed of
today's talk is we're going to start off
basic and then we're going to ramp up
okay so get ready for a wave of
information to come over you because
this is going to be pretty intense and
especially for the final session of the
conference but don't fret because of
course these videos are all recorded and
this presentation is designed to be just
going to viewed later on as well okay so
don't feel like you need to you know get
writers cramp supply trying to keep up
so identity server for angular 2 and
asp.net core these are three things I'm
going to be covering today the main part
of the main focus of the talk is
identity server fall okay angular I'm
going to show you how to set up my
angular 2 application or to have a
version of angular up to these days and
the reason I include asp net core is
because all of what I'm doing today runs
on asp net core ok including angular so
keep that in mind but yes the focus is
definitely on identity server 4 and I'm
super excited and I'm a little bit
scared a little bit nervous and that is
because the code we're looking at today
is my real world application ok this is
running in production
there's commented code around the place
there's probably rubbish bits and pieces
here and there and I'm just literally
loading up my solution and so if you see
a key you didn't see a key if you see a
password you didn't I have to rotate
them every time I do this talk which is
good practice for me anyway it forces
needed to it so as a bit of context for
why I'm here today about a year ago I
decided to begin a startup in the
payments industry I used to work for a
payments company it was rubbish their
systems were awful it was mainly vb6
all of the logic was installed
procedures and I thought oh I could do
such a better job than these guys now it
turns out I learnt a lesson a little
later on
it doesn't matter how good your code is
if people are willing to pay for your
product and the other way around
basically it's your sales team that
makes a product and I only wanted you
know a little application you want a
unicorn I'm happy with just a tiny
little business that works and earns a
little bit of money I'm happy with the
doge of applications so I started out as
you would with you know any good startup
should as you find the MVP right you
find the simplest thing that will work
that get hand to someone and they can go
oh that's cool here's some money and so
I started off with an architecture that
looks like this now being a payments
company I rely on the banks to do all of
my transfers under the hood and if
anyone has ever worked with a bank you
might understand what's happening here
it took me nine months to get access to
the systems I needed nine months it was
ridiculously slow and so as with any
kind of developer who's got some time on
his hands you know I ended up with an
architecture that looked like this so
rather than actually you know working on
finding customers talking to you know
business people and that kind of thing
I thought oh you know what I'll just add
one more little thing I'll just
investigate one more technology because
I want my product to be you know super
solid and really really great for
developers because the whole point of my
product is to let developers access
payment systems easily okay and this is
where identity server really shines
but perhaps I shouldn't have gone so far
so I now have quite a complex system
architecture but at least I know the
intricacies of all these systems the
acts I've spent a long time gold plating
them so anyway we want to build
something like this right we want to
build an API that we can give out there
developers and we want solid systems
that are protected weezing identity
service so where do we start with this
that's right if you don't know me I am
Ben who likes beer I was working on the
beer that was at the party last night
with Ellesmere and so I really enjoyed
that if you sort of videos on Facebook
you can see
how excited I was to go ahead and visit
the spiri but if you want to follow me
on Twitter you can follow me there it's
probably the easiest place to find blog
posts or something like that about this
kind of stuff just really quickly I was
a solution architected SSW that was a
year ago
I still do a little bit of work to them
I like payments I like beer untapped you
haven't seen that yet you should install
it follow me I'm Ben Cole and I'm
working on the startup which is of
course pinch pinch payments and so this
is the code we're going to be looking at
today okay now just before we dive into
code I want to cover just a little bit
about asp.net core and why I chose that
as my platform and why you might want to
do that yourself as well I guess the
first reason is the latest version of
identity server runs on asp.net core so
if you're using that then you're going
to need to use a skin across there so
who's using ASP net call here already
okay cool it's about three-quarters of
the audience so those of you who aren't
convinced yet thing the fast okay things
are pretty damn quick and you don't have
to do anything to you know reap these
performance benefits everything that
they're doing now they're focusing on
performance it's highly composable and
this is kind of comes back to identity
server as well right it's just a package
that gets put into an MVC website it's
really easy to write these extension
points and write these products to just
slide into other applications so using
ASP Emmett core makes things a lot
easier to compose it's got all the
attention right now okay you've got
Damion and David working on this stuff
and all these teams working on this
stuff all the time now this is a
double-edged sword it changes every week
which if you're not developing every
week is a pain in the ass so it's good
because it has attention and it's
getting updates and they're making
things better and better but they're not
changing it all the time too and so that
is a little bit annoying if you're not
ready for pain and breakage and probably
my main point especially for people
newer to asp.net and it's easier to do
the right thing so it kind of funnels
you towards success with the built-in
dependency injection it kind of makes
you architect your solution in a way
that sets you up for success okay it
makes it
a good guide you towards good
architecture just a quick point on on
performance here's a quick slide from
this week all of this stuff's in Asia
and you can look at this you can see
okay I think they're coming back under
200 milliseconds the page is an angular
page so it takes a little bit to load
here and there it's fairly steady
requests someone has had tripped over
the power cord in the middle there and
then plug it back in
hence the failed requests and you might
think okay yeah that's not bad but you
could remember that this is on
Australian service okay this is an
Australian internet which is refresh and
so these speeds actually pretty decent
they say that in Australia we have a
hundred megabyte a hundred megabits down
and up the problem is the whole country
has to share so asp.net core is a good
idea okay it's nice it's fun to use and
it's it's performant and the first thing
you do when you begin a project usually
one of the earlier things you do is you
need to think about security and
authentication mainly okay pretty much
every system has a user that needs to
log into that system and this is where
we're going to start talking about
identity service specifically now over
the last year it's been kind of scary
there's been a lot of data breaches
being you know a lot of security threats
even myself if you haven't seen have I
been pwned by Troy hunts it's a
fantastic tool it tells you when you had
a data breach against your email account
you can see I've been breached five
times
it's like LinkedIn github Ashley Madison
hopefully not and so I asked her a
little bit scared I said I need some
advice what can I do to make my
application secure because I'm not a
security expert I just want to make good
applications and he gave me some great
advice but I think what he meant to say
is don't roll your own security okay
there are tools in the box that can do
this for you and there are safety in
numbers when you all rely on Microsoft
and these kinds of smart people to take
care of this kind of stuff for you and
so when I talk about security and in
asp.net core world we're talking about
two things
asp.net identity which
scare of stirring example passwords an
identity server that takes care of
bearer authentication and giving out
tokens now a quick quick quiz here also
a quick poll here who's used asp.net
identity in dotnet cool so far
yep and who's used identity server
before as well okay so about half the
room is there not the identity and about
a third I think I've used identity
server which is good because we're going
to start off with the basics and how to
get up and running and then I'm going to
shove you into the things that aren't in
the documentation okay the things that
you won't be able to find or do easily
because it's so flexible and as I said
we'll look at asp.net identity first and
its job is just to save usernames and
passwords in the database essentially
log you into an MVC web site you can use
cookie authentication but the goal is
basically yes that's what asp.net
identity takes care of and we'll look
into that in a minute the problem
happens when you add in an API ok what
happens when you want to expose your
data to third parties using an API and
all of a sudden your cookie based
authentication is not going to cut it
and so this is where we rely on the
second piece of technology now identity
server because what it does is it wraps
your asp.net identity website ok the
place where you log in it wraps that up
and it issues tokens to your clients
your third parties to protect your API
in this case but then you can also add
other things so just a couple of quick
points before we dive into some code
here are some scenarios where identity
server is a good idea for you ok
the first thing is that it's compatible
with any authentication system ok so if
you're coming from a legacy application
and you want to start implementing this
stuff
you don't have to wrap a student
identity you could wrap an on-premise
Assaidi
or an azure ad or a custom
implementation if you have one
especially if it's legacy which I hope
you then update to something else it
includes all of the things like Google
and Facebook logins and the external
I D connect stuff it's not quite
microservices but we are lifting a
responsibility and putting it at its own
place so it's kind of one step towards
segmenting your application a little bit
more which I like I wouldn't call it
micro services but it's on its way you
can give out different claims to
different clients so this is just about
permissions okay so if you want one
group of people to access a certain part
of your API and a different group of
people to have limited access or
something like that it's very easy to do
that with identity server and some
claims if you're building an API that's
designed to be given to third party
developers this product is perfect okay
it is an excellent tool for building
exactly what you need highly flexible
and powerful and on the flip side of
that if you've got lots of your own
applications okay you're an organization
with many internal apps and you just
want to you know use one ad
authentication for all of them this is
also a perfect tool for single sign-on
within an august organization so the
point of today is that we are going to
look at the code that is this we're
going to spin up an asp.net identity
server and identity server so and we're
going to take a look at the code that
protects our API and how our angular 2
application is set up within MVC to make
use of this identity server as well so
just to give you an idea and I apologize
as well I couldn't get duplicate to work
so I have to work from extend mode which
is a little tough
I realize the solution Explorer is going
to be if it's small and we have to
restart this is what we're going to do
is I'm going to fire up each of the
applications and I'm going to guide you
through I'm just going to give you a
quick demo of what it looks like to log
in so I have an API project that I've
just spun up I have an authentication
project which is just an NBC site with
identity server inside of it
spin that up as well we can also spin up
our website and this will load so one
thing you'll notice when it loads if we
get internet on this side as well one
thing you'll notice when it loads is we
won't be logged in it we shouldn't be
logged in and I'm using a pretty heavy
build process it does take a few minutes
a couple seconds to load now we probably
shouldn't be logged in maybe we will be
but what will happen is we'll load up
our main application our angular 2
website and immediately will be
redirected to the authentication website
where it will ask us to login
as you can see lightning fast and the
point of this is will login will go
across maybe we'll skip this step wait
for it to load up in the background
oh no there we go okay cool I also have
my database migrations and my seeding of
the database on startup as well so
normally this would be spun up
beforehand but essentially what what has
happened is we've been flicked over to
our authentication server I'm going to
login using the asp.net identity
provider essentially and when I do so
I'm redirected back to my angular 2
application it loads up and it will
start being able to use the API so I can
come over here to something like payers
and it will load a list of payers and
there they are and we can come in here
and see something work like that
cool so we have our three pieces we have
about three pieces here API identity
server and angular server on startup
probably something you won't realize
this happened the API project has gone
and it's hid the identity server is
downloaded the public key okay so every
access token is signed using a
certificate and the public key is given
to the API so that it can verify the
tokens that it's receiving from the
angular 2 app so when a normal request
comes in we tried to go to the angular 2
website we want it logged in so we get
redirected over to identity server token
comes back once we've successfully
logged in we send that token up to the
API with all of our requests and if we
have access and permission we will get
the data back ok this is the general
workflow of this particular bit and so
now what we can do is build these things
so let's take a look sorry
cool so we're going to do is going to
start I'm just going to quickly add it
as being that identity to our project
okay so the thing you need to know about
this solution is that the pinch start
also notice a little bit hard to see but
we're in one MVC project here and this
one is where we're going to add asp.net
identity and also identity server so the
first thing you want to do is add your
packages
all right is that large enough for
everyone to see at the back as well yeah
sweet okay so the first thing we're
going to do is add our asp.net identity
packages okay and that's these two guys
here identity and any framework or queen
of using energy framework to connect
everything together so you add those two
packages to your just a file new project
MVC application and then in startup you
come down here good and they'll have to
bear with me and look at this in stages
all we're doing is we're adding identity
you've got a few options that you can
configure here I've turned down the
password requirements to easier
development time stuff and the key bit
is that we're adding the entity
framework stores and pointing it at
pinch context so pinch context is just a
regular database context that inherits
from identity dbcontext okay this can be
empty the only thing you need is the
constructor here I've got a bunch of
other tables in there but for now you
don't need to worry about that the
identity dbcontext spins up all of the
user tables and the role tables and all
those bits that are built in and the
only thing you do need to do is provide
a user if we look at our user class this
is just a regular entity that happens to
inherit from identity user that gives us
the password and all those other columns
but the user is just a basic class so we
have our context and that is pretty much
all you need to do to add identity you
can come down here to the configure
section and you just need to add use
identity into your pipeline okay and it
has to be above MVC for those of you who
don't know because this pipeline is
executed in order MVC there has to be at
the bottom okay
so the other thing you'll need from that
is the controllers and the views for
things like log in register and all that
kind of thing
now if you go file new projects and MVC
projects and you pick individual
accounts for authentication
you'll get given these things we're
going to change them in a minute anyway
so
all you need to do is those couple of
bits from Anna plank project and you and
you'll be ready to go because what we
will do next is the next slide we'll add
identity server to this blank empty MVC
project so starting in the same vein we
need to add a few more packages again
we're still in the same MVC project here
we're going to need to add identity
server for as a package the base package
and then if you look at the top here
we're also adding identity server for
the entity framework and identity server
for dot ASP no identity and this just
makes it really easy to use entity
framework and connected to our asp.net
identity provider okay it handles pretty
much most of it for us back into our
startup class and we'll just go back up
to where we were here you can see that I
am adding the database context in the
typical built in asp.net core way you
might notice that I've got my kin
migrations assembly referenced there as
well and we'll talk about migrations in
just a second
what we need to do is skip add identity
we've got MVC in there that's all built
in what we need to do is this services
that add identity server here and it's
very similar to add identity okay move
that up we've got some options that we
can change I've changed the login and
logout URL importantly we're adding a
signing certificate we're adding two
configurations store two database
contexts essentially and we're telling
it to use the user table so three really
important points here starting with the
certificate now as I mentioned before
whenever identity server generates a
token it's signing that token using a
certificate and you have the option
during development time if you'd like
it's come in here and go add a developer
credential add developer signing
credential and that just generates a
little key pair and it's tempting to use
this from the beginning just to get up
and running
but what I'm here to tell you is that
it's probably not a good idea because
you can't deploy it anywhere it's not
going to work on Azure or anything like
that and it's pretty easy just to make a
cert and you know do it properly so you
may as well do that and so to do that
we've got this bit of code above us and
what we're doing here is we're loading a
certificate from the registry it happens
to be the store name I and the store
location current user and the reason for
this is that this is where Azure places
its certificates so all of my stuff's in
Asia and I like it to work that way so
to load certificates I'll give you a
link to this code in fact what I will do
if you just search then called blog or
even just creating an entity or
something like that
my latest post is how to do this okay
how to create a certificate how to
register it with Azure and here's that
exact same code we just saw before and
how to use it with a giraffe services
because there is something you need to
do and so the easiest thing to do there
is just Google Ben Cole blog or Ben
caldo com there's a bunch of ways to
find this you could also just Google
creating a scientific but the end the
end part of that goal is we load the
certificate and we pass it into identity
server the next thing I want to show you
or the next thing on to point out
because again this is kind of not really
in the documentation either is how to do
AF migrations with multiple DB contexts
because that was a little bit tricky to
set up as anyone here done if our uses
entity framework starts ok it's the bulk
of the room uses any framework
migrations really of core I guess you
have to these days and who has used
multiple contexts with es migrations
before perfect that was no one that's
what I like to see so you'll have to
with this and it's not too bad you'll
notice I'm pointing all of my databases
to the same term all of my connection
strings the same database because I just
prefer to have it all in one spot
especially on Azure it's cheaper
and it brings it together easier so if
you look at my data project I've also
got a blog post on how to do this as
well so I'll leave that to the blog post
but essentially what happens is you have
a standard sorry a dotnet standard class
library okay this is what my data
project is and inside that you reference
entity framework and such and what you
need to do is add something called a
temporary dbcontext Factory okay so the
tooling isn't quite there yet to
understand how your application spins up
so it knows what the database status is
knows how to connect into all that kind
of stuff so what you do is you add this
particular dbcontext Factory just
pointing to my development copy of my
database and that way when I run don't
net EF migrations it knows where to find
the database and I've done that not only
for my applications context but also for
the two contexts that identity server
requires okay they all just there it's
all just the same code and again if you
go back it's just the second one here
energy framework core migrations in
Visual Studio 2017 and that will show
you how to set up multiple contexts but
essentially all you do is once you've
got that temporary database context
factory you just call and I'll just show
you very briefly
on your data project you don't know TF
migrations add my migration you give it
the context name inch context okay and
that is going to add the migration for
your own application and you do that
first and then second you come along and
you just put in the configuration DB
context so whatever the context name is
that you have in your database here when
to call persisted grant DB context and
configuration DB context and what that
does is it spins up the migration for
the tables that identity server users
you can kind of see I apologize to the
size you can kind of see at the top
right there that it's made to folders
for these things and they just have one
migration in them at the moment because
identity server hasn't changed its data
database structure yet okay as of 1.0
but that's an important tip is getting
all your migrations set up and probably
what I'll also show you just as a bit of
a bonus the starters we needed to add
identity server come to the bottom of
our authentication project starter class
it needs to go below identity because it
relies on some stuff in identity and it
needs to go above MVC because it
protects MVC and that the bonus tip here
is just this migration and feeding of
the database so there's a bunch of
different ways to do this my preferred
way to migrate and see the database is
to place the migration and seeding code
in the configure in the pipeline part of
the startup class because this will one
run
sorry this will run once per startup and
the caveat is that if you've got a
synchronous code it needs to run
synchronously okay if you try to it will
function if you run it asynchronously if
you use a wait but it will actually
break things so use the get a waiter on
the end of your feeding stuff
beautiful okay cool so that's
technically what we need to do to get
identity server slipped into our
application okay the next thing we need
to do is understand our architecture and
we need to start configuring you know
our identity server to understand our
environment and our architecture so the
key things there
we'll start with resources okay for
those of you who haven't used the
identity server there are two types of
resources that it protects information
and an API resource okay so information
or identity resources is just
information about a user so in this case
I've got things like their user name
basic profile information and email
address importantly I've got a custom
identity resource in my application
everyone who signs up to the website is
a everyone in slides up to the website
is a merchant ok and this is the
information about that merchant that I
want to protect or I want to give out
for example and you can see in the user
claims section here this is the stuff I
want to give out just some IDs and some
names so they don't have to keep looking
at up out of the database every time
it's just embedded in the token so
that's the identity resources the API
resources our API one this is in our
earlier diagram this is the API I want
to protect the other project it's just
the configuration of it so I'll call
that API 1 it's got a secret forget the
secret it's got some user claims these
are just things that I want embedded in
the access token when you ask for this
API and it's got some scopes now scopes
is more of an OAuth idea and the thing
you need to know here is that you've got
a creative scope with the same name as
your API
don't worry that's in the documentation
so that's okay and something special I
have also added is a secondary scope
okay so this holds or this gives you
access to a slither of my API that I
only want certain people to have so all
third-party developers can have
everything else but only my angular 2
portal has access to the API keys
because I don't want my third-party
developers just taking the keys from the
customers they have access to and so I
also get a second API but we won't look
at that that's okay
so now that we have our resources okay
we've mapped out logically what we want
to protect the next thing we need to do
is add the configuration for our clients
ok so these are things that want to
connect to our API so in my case the the
main client is my angular 2 application
and we'll take a look at its
configuration here ok so when you've got
a client my main one is the angular 2
application so any client though that
tries to connect to your API and it
tries to go through identity server will
go through this client store and this is
kind of these are the stuff that's not
quite in the documentation or not widely
available anyway and this is my
preferred way of implementing the client
store ok rather than using the database
or everything I kind of have a hybrid
bit here so a client will connect using
their client ID in my case it's a pinch
web for the angular 2 portal it's a
pinch web anyway and if we go and we
take a look at the configuration of that
client ok let's have a look here you can
see I've got a bunch of different
properties the important ones here that
I set the URI so I know information has
to come from that website require
consent is false
ok I don't need to ask users whether or
not my portal can access my data okay
it's got implied consent
it's got allow offline access which lets
you ask for a refresh token and then
refresh your access tokens over and over
and over it has a secret to prove Who I
am so this is the string you would need
to pass him to say yep you definitely
are my application and importantly here
we have allowed scopes now allowed
scopes you can see here I'm asking for
the identity information I was
protecting earlier and I'm also asking
for API one merchant which is some
identity information and Merchants API
keys okay so so I'm not asking for it
I'm allowing that client access to that
scope okay so this is how you protect
certain parts of your API is through
this allowed scopes this client connects
that can access that one and we'll
contrast that now to what a third party
developer client looks like now just as
a quick just as a quick sort of context
thing whenever you sign up for an
account I generate a merchant ID in a
few keys right and this is just string
as I've made up I'm just saving in my
merchants table okay there's nothing
special about any of this
but that merchant ID and that secret key
are what are provided to identity server
to identify this client so I find a
third party developer building a system
and I'm going to use my API this is the
configuration that they will get so
we'll come back up to our client store
the client ID that comes in will be that
merchant merchant ID that I've saved in
my database so it's not going to be any
of the ones I know like I hard-code know
about it's something from the database
so I look up the merchants table and I
go okay are there any merchants with a
merchant idea of this one and if there
are I get the configuration link so
given the merchants from the database by
the way and what I can do is set up a
client I can give it its name from the
database whether or not it's enabled so
you can trigger that at this point if
you'd like to important things here the
client secrets is just the secret key
from the database again so that's how
they prove who they are using that
secret key you can see here in the
allowed scopes they're allowed
everything except the merchant
information and the API keys scope as
well so if they try to request it
they'll be denied and they don't have
access to that area okay and I'm also
embedding a few claims in here as well
and this is just a convenience thing
I'll talk about quickly I've got some
data I don't to look up every time and I
want to embed it in the token you could
be careful not to do this too much
otherwise it'll you know be too large of
a token but this is just stuff like
their merchant ID a couple of internal
IDs and whether or not they have
permission to use the live system it's
just information that the client might
like to know about the users using it
cool so what we'll do now is we will
jump over to looking at how to protect
our API I think first we'll do that okay
so by this time what we've done we've
set up identity server it's just a
regular MVC website we put our identity
server in there we've configured it into
the pipeline we've added the the
resources that we wanted to protect and
we've gone ahead and set up our client
configuration so that we can get
third-party developers in there as well
so what we need to look at now is how to
protect the API itself and this is
relatively straightforward to be honest
so we can go in and add the package for
access token validation identity server
for like a bit low access token
validation and this is what we're going
to put into our pipeline to read the
tokens that we get given so if we look
at start up in our API and we'll come
down to will go past the MVC bits and
we'll come down to our pipeline so you
can see here again I use the API to
migrate my data so this is the project
I've chosen to kick off the migrations
I've got calls in there so everyone can
use it
even JavaScript libraries and the thing
we need to look at is identity server
authentication so in the authority
that's just pointing to our identity
server URL so it knows where to go
we've got require HTTPS yep enable
caching I don't have a casing provider
so I haven't done that and importantly
I'm identifying myself as API one and
here's my secret and once you've done
that if we look at just like a
controller let's just pick this one for
example
what you need is authorize ok and all
the internal mechanisms kick in at this
point and they'll make sure that
everything is correct ok so if you're in
an API setting and you're using a token
and you don't have permission to use
this a particular class it'll click back
at 4:03 if you don't have a token at all
or kick back a 401 and essentially the
cool thing about this as well is here's
that API keys method right it's just in
the same class I'm the only thing I've
added differently here is the policy
merchant API keys and this is what
protects this particular method if we
look back at our start up to the API
just back up here in the authorization
section we have a thing called a
daughter ization and we add a policy
merchants API keys all you have to have
is a claim of scope merchant API keys
which you'll only be given if you have
permission so therefore only my client
the angular 2 application can access
that endpoint and regular third-party
developers can't beautiful okay now we
can dig into some of the angular 2 stuff
and how that's set up it's a little bit
more complex and a little bit more
controversial to be honest as well so as
I mentioned before all of my
applications are running in dotnet core
and including my angular 2 application
so if we take a look at the startup
class again I just might finally project
NBC and
added my angular2 application to this
project if we come down to the pipeline
of this guy you'll see what we need to
do to protect our angular 2 app ok and
I'll also show you how the angular stuff
is hooked up as well so the first thing
we need to do is we're using a slightly
different authentication mechanism this
time we're not using the identity server
authorization one that we had on our API
instead we're using oh I DC connect to
identify ourselves from our angular 2
application you have to put that line in
but don't worry about it it's in the
darker things to look at here and things
that are interesting I've got a rebound
on the pipeline here who's who's using
angular 2 actually I wonder how much I
need to explain yep ok cool that's about
the quarter of the room the thing with
angular 2 is when you it's a single page
application ok so the only endpoint I
have in this MVC website is home index
it all traffic goes to there and that
home index boots up my angular 2
application now what happens when I go
into it I'll show you this actually
it'll be easier to visualize what
happens when you actually go in and
navigate around we're just you know it's
just all one page application we're
loaded we're not doing any post backs
but our URL and again it's a bit hard to
see is changing as we go around ok so
what happens when I just go and request
that URL you'll see that we are put back
in the right place ok now the way that
works is with this rebound stuff because
the request comes in and it's to pay as
slash some identifiers ok at this piece
of middleware here on the way in for the
request it skips it says ok I don't need
to do anything on the way in so that's
that oh wait next next what it does is
it goes all the way down the pipeline
all the way through our file servers and
through down to MVC and then back up ok
and if if it hasn't been found by the
file servers so
there's no static files that conserve
and in our case players / ideas not a
file it's just a URL so then it makes
its way down to NBC and every see goes
oh I don't have a I don't have a payers
controller that doesn't exist for or for
I can't find that so it comes all the
way back up the pipeline er this thing
here goes okay if we get a 404 from both
the file servers and the MVC side and
the path doesn't have an extension so
it's probably not a missing file and
what I want you to do is change the
request path back to root set the status
codes of 200 and push it back down the
pipeline again so we've got a second oh
wait next there and that pushes it back
down file servers go not root I don't
have a file called just slash MVC goes
our home index that's linked to root
here is home index and so home index is
rendered which boots up my an applic and
go to application and then the URL
though in the browser stays the same
because it doesn't know that all this
happened it just went I want this and it
said here it is and so angular 2 picks
up that URL and says up I have a wrap
for this payers slash something I'm
going to load that page up and that's
why we are given the right response
essentially and just to show you the
rest of the pipeline here you can see
I'm using the use file server so that
just creates WW root and serves every
file in there I've got a second use file
server for my node modules takes so
there are a few node modules that I need
to expose as well and because they're in
the past slash node modules but
physically on the project that one
folder up so you need to add a second
one of these to expose it properly so
that covers all the static files and
most of the angular 2 application we use
cookie or because you have to the OID C
stuff all the tokens that we receive
from identity server in that are stored
in the cookie in this particular
application so we do need to see we do
need to add cookie authentication and
you'll see here right below it we
reference that cookie so we're telling
it where to store the tokens when we
receive them we're using OID C and the
important things here are again you'll
see this everywhere
authority is our identity server so we
pass it that URL we say which client we
are and we prove it using our secret in
our case we're using code and token so
we're using a hybrid flow I don't have
time to get into that one but
essentially we're just requesting tokens
we're saving those tokens into the
cookie and that's really it basically
just pointer to that kind of stuff and
just below here so all this was doing
was setting up a variable and just below
it here's where we request what we want
okay so we're in our angular 2 portal
right now we're saying please give me
these scopes and you'll see much an API
keys there and offline access as well
which is important so we can get our
refresh token and we will be allowed
because we've proven that we are pinch
web that special clients and we've given
it's our key so that we definitely know
who we are all right so I will also just
show you briefly the home controller the
way we protect our MVC application is
exactly the same authorize just the top
that's it and that's going to handle the
requests coming in going you're not
authenticated kicking you over the
identity server to log in logging you in
kicking you back taking the token from
the response and then passing it down to
your application which is the next place
I want to show you so all the steps I've
just shown you here I just had a secure
an MVC website okay there's nothing
special to angular yet you could do that
just for regular MVC sites and you be
done actually by now which is great but
when you want to embed angular 2 in MVC
website you've got to do one more or a
few more things and what we'll do is go
through that it's the best way is to
start with frame index so home index is
the only endpoint basically and you can
see a couple others but they're not used
inside home index is the familiar what
you'd normally put into an index HTML
gets the root of our application
nothing really special there I won't
dive too deep into how angular works but
what we will look at is the layout file
for Home index so the important part is
I'll just give you a brief look at the
whole files so you've got some context
there all we're really doing is loading
a bunch of CSS learning a few node
modules bits that I needed rendering the
body there and then loading all of the
scripts that I need as well as
bootstrapping the application now this
is this is the bootstrapping here it's
one of the upsides and maybe downsides
as well is I'm using systems AS to boot
my angular 2 application okay and it's a
bit of last year's technology these days
everyone's using webpack and the angular
CLI to build the applications but I'm
not really a fan of how you then taken
out of Visual Studio and you need to use
the node web server and let web pack do
its magic I like a little bit more
explicit control over these things and
so I'm sticking to a system jeaious
because I can control everything through
gulp including bundling and minification
and all that kind of stuff
you explicitly write it and whether
that's a bonus for you or a detriment
that's up to you but one thing I can do
and I'm quite happy about it was ctrl f5
in my MVC project and it all just works
and given the power of a back-end if I
need to do something like for Facebook
sharing you need to render straight HTML
you can't give out JavaScript it won't
accept it
and so I can catch things like that and
I've got a powerful back-end that can
then deliver something else other than
app if I need to there's a bit of an
aside basically what we're doing here is
booting the angular 2 application so at
development time I'm using a non bundled
version of the app and a production time
I'm using a bundled version of the app
so it's much smaller and much quicker
but for debugging it's not very nice to
have a bundled application the key kind
of trick here I guess is this line I'm
using a view component to render my
settings down to my angular 2
application okay so if we take a quick
look at that
you'll see some of the magic coming up
so this food component every time the
page runs which typically is just once
at the beginning for a single page app
what I'm doing is I'm using the
authentication context pulling out the
access post my current access token the
current ID token which contains the
identity resources
I'm also pulling out the Refresh token
so my MVC app can go and fetch as many
access tokens as I want this is probably
another big benefit if you're more into
security is that my refresh tokens are
never exposed to the client so the MVC
back-end is the only thing that sees a
refresh token so you could make your
access token expiry really small if you
wanted to kind of mitigate people
stealing keys or sniffing keys or
something like that it will only ever
last as long as you set your access
token expiry to and then it's pretty
simple I'm just building a model and I'm
putting some data in it so I've got some
base URLs that I want to give to the
client so it knows where to where the
API is and where the authentication
server is I keep the tokens just in the
backend and then I add a bunch of other
information that I don't a call from the
database every you know every time
instead I'm just using the current with
the context version of these and if we
take a look at the view I'm just hard
coding a bit of a settings file and just
rendering that information in search
global variable basically in JavaScript
and because I did it just before the
that gets rendered here so our global
variable gets rendered here just before
my angular 2 uploads so that in my
angular 2 application we go to
I just have a service stock standard
service here angular2 service that reads
the magic variable so load settings here
is called once yeah it Maps the magic
global variable stuff to a typed
variable that I can then expose to the
rest of my application which is quite
powerful and I've got I've got 10
minutes to show you something pretty
cool as well now just before I show you
the cool thing and probably while it's
loading does anyone have any questions
about things there's a lot of
information to absorb I didn't have any
questions about anything they didn't
quite catch or anything like that no
blown away look up on there yep
they only have access to their own data
so the question was if a user gains
access to their access token they could
use that to try and get other people's
data from the system good question good
question so the way that's handled in my
application ok cool the way I'm handling
this and I guess the best place to start
is to show you know or sanitation when I
configured my identity server up here
ok you might have noticed these three
lines down here and this is a couple of
service implementations I've ever
written from the default ones and the
clients store is one of them so when I
was showing you all that client
information stuff that's a special one
the other one is a profile service and
the job of a profile service is to take
the currently logged in user
because remember identity server knows
who's logged in it's to take that user
and it's create claims from that data
and here I've got an a spinet identity
profile service I had to write one
because they did there wasn't one before
I wrote this but there's a built-in one
now so by default you'll get things like
that their user ID is a claim and the
user name and email all these built in
asp net ones right they all get given to
you for free so they'll be in the token
if you ask for them and more importantly
I kind of override that as well and I
hit the database to pull out any claims
I need as well so I guess if you come
down here not this one pinch profile
service so I also when a user is
authenticated at the time they login
these claims are all
so embedded in the token so you can see
how I've got a test submission ID in
life subversion ID
okay in my API as a convention no not
that one
okay this is a base controller all my
controls inherit from this one and what
I do is I look in the victory should be
context and I'm looking for a merchant
context if I haven't already put one in
but essentially what's happening here is
when you ask to the submerged an idea of
the current user it's going to go ahead
and look for yeah it's going to go ahead
and pull this out of the current context
and it's going to pick either the live
sub mention ad or the test submerge
entity from the claims so they're since
they're set at authentication time
basically all of my code has a woops all
of my services code just has a where sub
merchant ID equals this and yeah that
forces it basically yeah that makes it
so cool
any other questions before I just move
on yes correct
great question okay the question was the
refresh token is not given to the client
therefore how am i refreshing my tokens
excellent points there's actually again
in the web project this time to the
angular 2 MVC application there is a
little endpoint in my account controller
here called refresh tokens and that does
what you might think so
we basically take the current tokens out
of the authentication context that line
51 is the identity server code itself
okay so this is code they've written
where all you need to do is pass in the
Refresh token given some settings hard
to read with that oops
so we create a token client this token
client is an identity server class we
give it some settings such as the
identity server the client ID and the
client secret and then we call request
refresh
and we'll get back a token and you can
see here basically I take the old token
and the new one and the Refresh token
and I Jam it all into a new contact what
is it yes this is it here claims
principle so basically this guy updates
MVC so it knows 1/2 this is the current
authentication context and then I just
returned JSON with the new access token
and that's it so that goes back down to
the angular application and probably one
last thing to look at is the
authenticated HTTP service I've got here
this is an angular 2 service and what
this does is it wraps every HTTP call in
a retry given the and it knows how to
basically refresh the token so I'll come
down here and pretty much where's the
best one to look at I guess for example
get so you can call get with any URL and
then it turns that request into like a
lambda function basically and it
executes it and it will refresh the
tokens if it didn't work so stepping
through that I add an authentication
Bearer header to each request that's how
the API knows who I am that's how you
pass the token to it and that Refresh
method here a little bit tricky is some
observable observable fun but basically
we take the request we wanted to do we
execute it we catch the error if it
happens to give us a 401 then what we do
is we call refresh tokens so it makes a
separate call off to that MVC endpoint
gets the new token back and then adds it
to the original request and require an v
it off a second time basically which
works pretty much all the time the
reason I say pretty much all the time is
because when you load my application for
example if you happen to land here
there's several calls that go off to
load the data for this page and if your
token has expired it does it all at once
so it'll hit refresh token three times
all at once and it yeah I'll get the 401
three of three of them all at once I'll
refresh the tokens all at once and that
can cause identity server to get into a
bit of a fuss if you don't set the
refresh token this is going to be a bit
of a jump around up in my sorry client
store so Kinch web so this is the client
configuration and you'll see refresh
token gives it a better approach refresh
token is set to reuse which means when
you use the Refresh token to get a new
access token it doesn't also give you a
new refresh token because when I call it
three times at once all of a sudden I'm
in this big mess whereas if I get the
same refresh token back each time it
makes three successful calls and just
changes access tokens really quickly but
they all work and the great thing is you
can set this up to a client so maybe I
want my internal have to work that way
but if I want third-party developers to
have a better way of doing it I could
set that to a different configuration
cool I'll take questions at the end as
well no it's been a long day the last
thing I want to show you it's just
something a little bit fun is ah
the SDK okay I wrote an SDK basically to
make things easier for developers to use
my system right now what was fun about
this and what's cool about identity
server is this something there's the
concept of connect built in as well so
up until now third-party developers have
built their own system they have their
own keys and they access their own data
but if you've ever used something like
stripe or PayPal or some a very large
API where you want to build a system
that uses other people's accounts right
and you want to connect to their account
and get
keys for their account rather than your
own and this is actually built in this
is what my system does as well so if you
look at the you know the keys page
you'll see this concept of an
application ID on the right hand side
and what this lets you do is like if
you've ever seen something like Twitter
if you made a Twitter or Facebook
application you create a bit of
information and then when a third-party
application wants to use your Twitter
account it'll say hey so-and-so
application once you use your Twitter
you can you know do give consent and
it'll say let me tweet let me read
tweets or give me my email so that
consent sort of workflow is actually
built into identity server as well and
to demonstrate this let's just connect
the pinch it was a very very prototype
based screen here this is given to you
I've kind of half styled it a little but
this is built for you and you can see
here you can configure all this stuff as
well so I'm asking for their identifier
I can choose whether or not to give them
merchant info
all right whether I want to come
complete today I want API one access and
I want offline access and I can remember
that decision as well and if I go yes
allow all of a sudden what's happened
here is my third-party application this
is a technically what some developer
could go build now has access to the my
claims ok it's logged in as me yeah it's
partly the best way to describe it
basically so the user has logged in
before that consent screen I was already
logged in but I could have logged in as
any other user and what would happen is
I would get the details of that user in
my third-party application here and it's
all the same there's no difference to
using the API you still send an access
token you've still got a refresh token
and you've just got some claims that you
can read and that's something I think is
really cool and it's built-in but wary
of time basically what we've looked at
today is some basic how to set up
identity server stuff we'll take a look
at all sonication and we've kind of
really ramped up to
a scenario that's very specific to me
but you get to see a couple of the cool
things you can do and some of the
challenges you'll face when you go to do
this yourself the best place to see
information about identity server in my
blog post and stuff like that is just a
Google ven health blog you'll find
information there and thank you very
much for coming to NBC it's been a
pleasure if you have questions feel free
to come up and have a chat</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>