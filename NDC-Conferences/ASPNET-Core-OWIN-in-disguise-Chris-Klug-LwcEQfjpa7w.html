<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>ASP.NET Core – OWIN in disguise - Chris Klug | Coder Coacher - Coaching Coders</title><meta content="ASP.NET Core – OWIN in disguise - Chris Klug - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>ASP.NET Core – OWIN in disguise - Chris Klug</b></h2><h5 class="post__date">2016-09-09</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/LwcEQfjpa7w" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">awesome hello everyone everybody happy
having a good conference look at that
the amount of feedback I'm getting I'm
from Sweden Swedish people don't give
that much feedback Belgians don't give
in the feeder all finns don't Americans
do but you guys have been so good I'm
impressed
and so we're going to be talking about
asp.net core or Owen or sort of a
combination so Who am I some people say
you don't need this slide yeah the
person that says that is Scott Hanselman
if you're Scott Hanselman you don't need
this slide if you're me you need the
slide my name is Chris Klug I work as a
senior developer / technical thing
something teacher mentor for a company
in Sweden and I generally spend a lot of
my time sorting knowledge I go to
conferences and spake I mentor teams
I've done a Pluralsight course I used to
blog a lot and I love sharing knowledge
in different areas that I've figured out
along the way
any sprouting that MVP ASP insider all
that little thing doesn't really matter
the only thing that's quite important is
I am from Sweden so if you don't
understand what I'm saying
tuff there's not much I can do about it
that's just the way it is um so the
question is what is Owen how many of you
are working with Owen today okay how
many of you could go up here and explain
what Owen is he goes I went into stretch
okay it's actually not that complicated
there is nothing oh it's a specification
right so the Owen spec says Owen defines
a standard interface between dotnet web
servers and web applications that is
basically where it is it's it's a piece
of paper or a document that basically
says this is the way we abstract the way
our web servers using a simple interface
and it means that instead of having this
where if we're building web based things
on net we have to run it on iOS with
Owen we're basically saying No
we'll make it possible for you to run
wet dotnet based web applications on
other platforms an is which is got cool
except how many of you guys are doing
web development today United on that how
many of you are not using asp.net MVC
okay not even close to half of you so
the problem is that a pregnant MVC is
actually tied into is completely which
means there's actually no way of
removing MVC out of IES and putting it
into Owen or Project katana in the
current version but a split neck or
gives us that ability so the idea behind
the the Owen pipeline is that we have
this company called an app funk that
funkiest abstraction between the web
server and your application so the web
server will do the thing of accepting
your request and pull it apart and take
all that information into put into
dictionary pass it into some thing
through the app funk and that app funk
then returns a task back and the web
server sits there and waits for the task
to complete
and one the task once the task is
completed it's done so that is the
abstraction we're getting so with it the
whole thing pretty much inside Owen is
that one delegate and a dictionary this
by the way the server dot on requesting
is sevdah code it's not there's nothing
that you can run like that but that
would be sort of the idea behind it the
server will go or when I get a request
pull it apart put it into the dictionary
and put the send the dictionary into the
app funk the app funk then has a friend
called the mid funk the mid funk is not
actually in the spec today it's a it's a
draft 1.1 or something like that of the
Oh inspect and it basically defines how
do we add things to this incoming and
outgoing at the request pipeline because
right now with in oh and they specify
and say the app funk is the way that the
server calls into our application and
then you will build some form of
pipeline that we will send the requests
through and then when it comes back we
will we will send response back but
somewhere in the middle they sort of for
God
how to go from this into building a
pipeline so everyone did their own
version of it or the few people that did
build this actually built their own
version of it so they decided that we're
gonna have another func which is say if
you see they're using mid func equals
it's a func that takes an up front and
returns an up func it's getting
ridiculously complicated figure this out
laughter hi you'll see when I remove
sword the syntax like this and you'll
see me building stuff you'll see it's
actually not that hard but it's good to
know that you've got the app func in the
mid func so if we look at what's
actually happening in Erwin you get this
process called some process or DXA it's
a host the host can be anything in in
Owen it can be a console app it could be
a window service it could be a is it can
be anything
it's a host you can literally plug it in
to your WPF application and have your
WPF application act as a web server for
some reason not saying that that would
be very useful but you could inside the
host you have a server we split this
into think two different things so
you've got the host that will just host
it and you have the server which will
open the port and listen for incoming
requests and then handle all of the HTTP
communication with the client and this
the reason is that it basically makes it
easier for us to pulling things apart
and plug different things in if you're
running this in iis which you can I is
will both be the host and the server so
it's a 1:1 package deal but when you're
building in a command-line application
for example you will have the host being
the exe file and then you will pull in
another server that will do the actual
communication for you inside the server
we have a pipeline the pipeline consists
of middlewares pieces of code that will
execute as the information goes in and
out of this pipeline and we have an
application the thing that organizes to
respond or creates the response that we
need to send back and if you don't want
to code all the way down into this raw
framework which basically you get
incoming requests here is the path I
requested here is this you request this
is the information and you have to do
everything manually you will build some
have some form of web
brain work that you will put on top of
it that will do it for you something
like Nancy effects or food where Missy
or something like that that works with
Owen so you get a client client connects
to server right it creates a request and
it's a simple get HTTP 1-1 requests
sense or some information and says this
is the path I want to use is the host
I'm requesting and all that server takes
that request and pulls out the parts in
that HTTP request and puts it into a
dictionary the dictionary is of string
object so it means that you can conclude
include everything which is kind of cool
because it means that inside that
dictionary we can include strings like
the path I request the user agent string
and everything but we can also include
things like the stream the incoming
stream in and they should be post or the
outgoing response stream as well so we
can put stream objects in the dictionary
and that's the way that we communicate
with the client when we're sending back
responses but we can also put in
delegates so we can put in application
delegates in this thing and basically
say here is a function that I put into
this dictionary with this name and if
you want to do something pull out that
function and pass values to it so we can
actually pass not only data but actually
functionality through a dictionary as
well does that make sense
there's a sample that that's actually in
there so and Owen has an extension where
you can you can add Owen extensions and
one of them is file send so if you want
to send the file in a win there's one
way of doing it is opening the file
reading the file from disk and then
streaming it to to the client through
the stream but most web servers actually
have a built-in functionality to serve
up files so IAS has a very optimized way
of serving a file so there's an
extension to Owen that says you can if
your server supports it add the
dictionary key that is a windowed file
send or whatever like this that returns
a function you take that function and
you pass it the path of the file and
then the web server does the rest for
you so you can pass functionality and
the web server can actually add
functionality to your Owen pipeline in
an agnostic way so you can have a look
at it and say if my web server supports
this feature I can use it if my web
server doesn't suit
this feature then I have to do something
else let's mix out very simple
abstraction it take this server then
takes the dictionary sends it into the
pipeline it hits the first middleware
first middleware that does its thing it
can be anything it passes it on to the
next middleware and it passes through
all the middle words in the pipeline
until it reaches the application the
application looks at whatever it's in
the dictionary and figures out that okay
so he's requesting XY said with these
parameters I need to go and do this
thing here and then I'm going to
generate some HTML and then I'm going to
post that back to the client as soon as
I said send something in to the response
stream I notified the server and say I
am the right writing things to the
stream and the server automatically
sends all of the headers and he sends
all of the data and starts streaming the
data back to the client at that point as
soon as you've written anything to the
response stream you cannot modify any
headers you cannot make any changes to
the response stream they are already on
the way to the client you can get
notified if your middleware needs to
know it can get notified that this is
happening the server then takes whatever
is coming back and says okay so you've
started writing your body that's fine I
will now take all of the headers that
are have been configured I will generate
an HTTP response with all the headers in
there start sending down that down the
wire to the client and then I'm going to
keep on feeding whatever you're pushing
into the stream I will just keep
streaming down to clients make sense
hope so it kind of should and that then
goes back to the clients client and
happy it gets a webpage tada but then it
goes to back again so basically the the
dictionary then goes back out again so
it goes from the application to the
middleware too and then it goes from
middleware to to middleware one which
then goes and sends it back to the
server or rather notifies the server
that now all the the middlewares have
been able had looked at it on the
incoming and outgoing and I am now done
with the whole request and the server
can then go and terminate the connection
and basically say the response is now
done that is a win and I guess most of
you have heard of Catan project katana
or katana project
Kitana project is Microsoft so an
implementation so it basically Microsoft
took a look at a witness that this is
pretty cool we'll build our
implementation of it they made some
tweaks to it they made some
modifications to typical Microsoft
spirits will take what is there and then
we'll make that and then something else
but they kept in line with what's in the
spec so actually all of their
modifications could actually still go
under the OEM specification properly so
they did the change that they did as the
day instead in the app funk here you see
funk I HTTP context and tasks it used to
be I dictionary of string object so they
added a little layer on top of the
dictionary to make it easier for us to
get access to the response stream and
the request stream and the path and all
of that without having to know all of
these dictionary keys and then it still
supports the dictionary syntax where you
can go context dot environment and then
you get the dictionary and you can go
and add and read things from the
dictionary as you want
it's just that Microsoft thought it was
nicer to get a typed statically typed
interface for you to work with than a
dictionary which I find quite abuse then
comes long asp.net core one I think that
was the final name of it after all of
the other things it started out with Kay
somebody gave me access to Kay before it
was even announced before tech ed when
they announced it because I was doing
some stuff that kind of had nothing to
do with Kay at all but I thought I'd
want to look at it I went in and I
looked at it and I understood nothing
it's not easy when you get a new good
proto and github project with all of
that in it and you saw go okay it
changed a whole lot of things I just
gave up I didn't look at it and then I
went from K which was a fantastically
ungoogleable name Kay throwing error duh
okay that goes into asp.net v-necks
became a spirit net v and then that
turned into a speedrun had core one and
all that and we're now at a spread like
work or one core one has a pipeline the
pipeline looks a lot like Owen but it's
not Owen the idea is there
the functionality is the same but what
they've done is instead of having an eye
dictionary or string object they are
doing an HTTP context a cheapy context
is not a tiny little shim over a
dictionary it is a statically typed
object it's not an interface it doesn't
support a dictionary syntax at all it is
a new object so they are breaking the Oh
inspect there but it's actually easier
to work with this thing so I find it's
actually quite ok it's still you can
still mock it you can still new up that
thing you can still do all the testing
you want with it
but that's the big change so all the
places where you see I Dick ssin area
knowin you will see HP context in here
instead so let's have a look at getting
started I be considering the speed of
internet in Australia yeah I used to
live in New Zealand I know exactly how
poor it is so I've started up the
project before because I want the new
get packages to get installed properly
and not sit here and waiting restoring
so what we get here this is quite
uncomfortable
it's a simple empty asp.net core web
project using the.net framework I could
have gone with core but I went with
dotnet because I have a other demo later
on that will include some that stuff it
starts up with this main method I guess
everyone has seen core by now right
anyone not seen core ok cool so there's
a project programs static static void
main then there's a startup file which
is exactly the same as you would have
had in project katana there's a class
called startup but instead of it being
dynamically loaded when iOS starts up or
your app starts and is it's actually
they point at it here so you give it the
class name there there are no class
there are no attributes there's nothing
else it's just you have to put it in
there and the other difference is that
there are now two methods you need to
implement or you should implement one is
configure which used to be called
configuration and I applications builder
as the first parameter used to be I app
builder they're like tiny little
variations between katana on this if you
look at the syntax and so that is the
one that we used to
it also supports dependency injection
which is why I can add other parameters
here like AI hosting environment and I
lager factory and all of that it will be
dependency injected everything in a
static or includes dependency di and di
is setup in the configure services
method that takes an AI service
collection where you're basically going
to say I want to add a service with this
interface here's the implementation and
you're good and it starts doing
everything for you so that's the main
difference and if we look at I'm just
gonna scroll down focus on this part
here this is pretty much our pipeline or
app so we can go here it looks to see if
we're in development mode then use a
developer exception page otherwise just
go and say app that run run means I will
return a response I am the end of the
pipeline there's nothing after me I am
the final stop and when I if I'm not
returning a response everything is
broken so that doesn't take a reference
to the next middleware it just takes the
context and then you say context dot
response rate is right I saying hello
world pretty simple I go control f5 I
hope this works because it's not this is
Microsoft template it should sort of
work out of the box it's SLR world
nobody's impressed um hard crowd not
seriously I know I know it's not
impressive but it's kind of it shows how
simple everything is so we can go into
say app dot use instead use is saying I
have a middleware I might return a
response or I might just pass it on it's
kind of like a I had a friend that I
showed this to the other day because he
hadn't worked with with this before and
I said Russian dolls actually makes a
lot of sense it's like a Russian doll
you pass things in through the dolls the
outer layer passes it to the inner that
passage to the inner that passes it in
there and somewhere it changes and goes
back and it basically goes out all the
layers until it exits the doll again
make sense it's the only time I will use
a doll as a reference for anything while
doing a presentation next you get these
two there are two ways of quote calling
use there used to be only one but
Microsoft decided that that whole mid
funk that is going into a win should go
in here as well it's not a proper mid
funk because it uses the wrong app funk
but it has the same idea
it takes a nap funked and returns not
funk but the one that you used to sing
looks something like this a sing CTA
this is going really good next how many
of you have seen this before how many of
you you said you had worked with a win
and it's like one hand that goes up have
you seen this this is a win 101 it's not
even that this is like beyond 101 this
is what I expect you to know when you
come to class so I'm just gonna CTX dawn
really spawns the right a sink and I can
go hello and DC like that and if I
compile this it should sort of just work
it does
whoopty-doo I've made no difference
except the fact I've not made this thing
completely useless because I'm always
returning a response but what if I want
to do something as what if I want to go
in line what if the whole thing of
Russian dolls and I'm talking about the
pipeline and all I'm doing is returning
it so instead of that I can go ahead and
I can do something like this so let's
pull out that actually let's not let's
not do that I want to do this app don't
use let's check the other syntax this
this is gonna give me a kick I'm gonna
see how many of you are gonna look at
this and go what it's gonna be next fat
arrow a sink
I really can't spell CTX fat arrow thing
does that syntax make sense there's a
guy go yes is there anyone that agree
with me that this syntax does not make
sense thank you there's at least one
honest person in here I looked at this
and I went what it's not that
complicated it does make sense it does
it's basically it
it's a func that takes the next
middleware reference as a parameter
but that func intern returns returns
another function text so it basically
just becomes two fat arrow funky
after each other it's apparently very
logical then we can save our timer
equals new stop stopwatch like that
timer don't start wait next it wants the
context let's pass in the context so
that's where this before doing the call
to the next this is on the way in
through the pipeline then I go and I
wait the next one which passes the whole
thing back back into the piper through
the pipeline and then when it comes back
from next I'm on the way out so I can go
and say timer stop and then I can say
console dot write line I can use this
funky new syntax and say request to see
TX dot request request dot path took
timer
elapsed milliseconds I am a really slow
typer I figured especially when I was
standing really there is so I I stopped
my timer and I write out the request to
the console the problem now is that the
console doesn't actually work if you put
it through is Express because there's no
console in there it will just swallow it
so I can go up here and I can switch it
and say I want to run it as a console
app instead and I can go f5 it goes up
and it goes hey hello NDC which is quite
cool not but the interesting thing is
here so I get all the days so basically
I'm now measuring the time it takes for
all my requests to go through and it's
just an inline thing so basically
methods goes or incoming requests go
through me and on the way out I do
something else so we've got this awesome
pipeline everybody's going not very
impressive no it's not very impressive
it's actually very low-level not very
complicated at all but it gives you a
lot of power to go this deep how many of
you have built I HTTP modules before or
I HTTP handlers for is how many enjoyed
it
exactly this is the same thing it's just
that this is actually quite enjoyable
because it's simple and it's not is
dependent there's one little thing
writing to the console is a pretty bad
practice right so what we don't want to
do since we have dependency injected the
ilogger factory we can go and say no for
logger equals logger factory dot create
logger name it request timer like that
and then we can say logger dot log
information and once I've done that I
actually do get color coded messages so
I get a little green thing it says info
and it's more structures is structured
so I can go in and say it's it's
information and it's from the request
timer and it took that long nobody's
impressed okay
well that's what you get for trying to
be nice so it's all very very simple
right but that's also kind of the
problem do you want to build all your
applications like this like in line
methods for everything so look at this
user go oh that is ugly I really don't
want to do and do this full-time so you
really need to go and get organized when
you're building your middleware so you
cannot go and just build in line
functions it's just it's gonna look like
crap and you're gonna end up it's gonna
be ugly
but then somebody's gonna go that's no
problem I can just do a static class and
I can put my functions in there and it's
gonna be awesome
yes I know so you need to make sure that
you are structured if you're gonna do oh
and stuff and one of the things is that
we build middlewares middlewares don't
have to be in line function so I really
don't think unless they're very very
simple ones like this it shouldn't be an
inline function can we agree on that
good if not there's the door and if I
ever end up on a project with you guys
messy in line one I'm gonna hunt you
down
so I'm gonna add a middleware folder
like that and I'm gonna add a new
middleware so I'm just gonna go on add
new class request timer middle where
like that remove all of that stuff gonna
add a constructor in here
constructor is gonna take a request
delegate which is an a core specific
thing it's similar to Owen and I'm gonna
call it next I'm gonna store that in a
variable like that I'm gonna add another
method down here called public async
task yes
invoke the invoke takes a HTTP context
like that then I'm gonna go out here and
I'm going to pull out this thing here
that was wrong key combination there it
is there is I'm gonna fix this I'm gonna
slowly gonna fix this let's go like that
so it's gonna say next lesson available
that's fine it's underscore next because
the reference comes in through the
constructor and not as a part of this
function call then it's gonna say I
can't access logger factory I can solve
that because this thing supports
dependency injection so I can just go in
here and ask for a logger factory but
I'm actually gonna go and request an
ilogger instead because one of the
things with the DI here is I can request
the logger factory and create my logger
and I get an ilogger back of a specific
type or I can request an I log or of the
right type to begin with so I'm gonna
take this thing and I'm gonna tell it
that this is the thing that I'm logging
for I'm gonna call it logger we're gonna
introduce logger gonna remove that threw
it in there and everything seems to work
slightly more struck I don't like the
fact that one is grayed out but I am
calling it there right yes and why is
that things quickly
I really hope this works it looks right
okay I'm just gonna ignore those now
that we've got those into our own class
we can actually just remove this thing
and say app don't use middleware instead
and then I tell it that I want to use a
request time or middleware like that is
that more structured since I'm getting
squiggly lines I just want to press f5
and see if this actually works no I know
I know I'm just I'm yeah it seems to
work I mean I'm getting timing right
request to blah blah took yeah it seems
to work okay
yeah now I know that there are some
there are some yeah I don't know how to
put this in any other term stand bugs in
I used to do when it comes to this
there's potential I think that's the way
you you put it as a program manager um
this looks cleared cleaner right but
it's actually not that clean well it is
pretty clean but it's kind of annoying
because I don't like doing it like this
this looks quite cool right so one of
the things that we do with with oh in
middlewares and also middle is here is
that we actually tried to make extension
methods for them so they're easy to use
and we have this syntax of app dot use
whatever and everyone is used to working
with that so if we're going here
creating your class I'm gonna call it
request timer middle yeah middleware
extensions like that remove that intern
your file save that make this thing
public static class public static I
application builder use request timer
like that there's gonna be this I a
platoon builder up then we take this
thing here no we take this thing here we
do return
like that and this is now the freaky
part I'm gonna move this thing into this
namespace like that anybody know why
yeah it's an extension methods to be
able to use your extension method you
have to do an import of your namespace
by putting it in that namespace that has
to be there because I application
builder is being used anyway it means
that you will automatically get app dot
use request timer without having to do a
separate imports or using that looks
pretty good right okay this is cool
until somebody goes and says by the way
I actually want to log something else I
want to have a different format of it
oops
so next step in this thing doing a
middleware is an options class and tell
it that I want to be able to configure
my middleware you don't use that or do
that by creating another class they're
always three classes involved there's a
public request timer options it needs to
be class right there it is look at that
that's beautiful and then you add
whatever functionality you need whatever
configuration you need for your
middleware you had here as properties so
I'm going to create a probe that has
this it's a func that takes and and HTTP
context a long and returns a string and
I'm gonna call it format there I'm gonna
go in and create a constructor and I'm
gonna say format equals and I'm going to
create new one of these CTX elapsed and
I'm going to take this thing here
and this thing here is gonna change into
elapsed does that make sense okay I just
move that into a different move that
into a different file to get it out of
the way I change this thing here and I
add another parameter to my constructor
I'm going to say I can either request
timer options options let's save that
save that as a variable and then down
here instead of logging it straight like
this I do options dot format and it
wants the context of CTX and you want
the elapsed time which is timer dot
elapsed milliseconds like that okay
and finally and the last thing we need
to do is in our use request timer I'm
going to say you have to be able to pass
in the request timer options but it's
not mandatory
so it's optional and then I pass that on
I am NOT doing this very well today
there it is
I pass that into my use middle worse
cool which means that it's going to be
power to be passed into the constructor
so anything you pass in here will be
passed into your middleware after the
delegate and then I'm going to say if it
is not provided I'm gonna create a new
new of them and basically give you the
default options and once that's done I
can go and say new request may lure
timer options and say format equals
something useful actually it needs to
look like this
CTX elapsed
request took elapsed MS and if I run
this now it answers as it should and if
your go in here and have a look it says
request to exterior milliseconds so I'm
now posted able to modify the the way
that I format it okay going to make
different changes since I'm getting the
HTTP context I could be logging a whole
bunch of other things as well and adding
extra string if I wanted to and I can
make more complicated things but the
most important thing is when we're doing
our middlewares we should really be
doing a middleware class an extension
method and an options class it might be
that you go I don't need options class
just throw it in there it's actually a
neat and empty where you're passing in
an object class it's there and then if
you ever need to add something it's
actually quite easy to add it instead of
having to add the help file does that
look cool so we need to keep simple
right we cannot build a whole bunch of
things using this middleware as easily
because as you see I forgot to show you
this but there's actually quite a cool
feature with this
you know this path gives me exactly the
same response there is no path handling
in here there's no functionality this is
the raw version of everything so
basically if you need to do anything in
here you have to do it manually so if
you're going to build a website that
returns different files or different
responses for different paths then you
have to build your own little thing that
parses those paths and if that is a big
website that is going to be a long
switch closed or something else so it's
it's very very simple so we do need and
go don't get help we need to get other
people to build the stuff that we need
right so far we haven't done a whole lot
with project katana most people see Oh
in middleware in katana when they do
security or authentication because all
of your authentication area MBC uses
Project katana and the om pipeline to
plug in all of their oaths stuff but we
can do much more but it's basically the
same idea if you want to go and do
something you can actually actually in
katana you can do Web API I I tend to
host Web API inside the OM pipeline
quite a lot so we get other people to
build our stuff and we can go and have
coffee and charge the client foot no
sorry I didn't say that it makes
everything faster no it's it's get other
people to do your work it's it's much
easier I promise you
so either going and you get something or
get a slave so what do we do if we want
to do something more complicated well we
go and find whatever person that has
built this awesome tool that we want to
use and obviously when we come to a
speed on that core we can finally use
MVC inside the pipeline so MVC is to
absorb the yeah whatever sometimes my
English fails me badly yeah MVC is the
one that I'm gonna be using I was
supposed to something else but yeah so I
go at the project Aysen I pull out
Microsoft Microsoft I don't know why
that is lower case if anybody at
Microsoft listens can you get that upper
case first letter thank you they're
recording it that's one thing I
so somebody watches it so I'm going here
a split-core vc10
like that not very impressive but it
means that we can go in here and we can
say ooh that thing shouldn't be upper
case don't use MVC with default route if
we don't do default route we have to go
in and do our route configuration
manually with this thing we just get the
the default one that everybody knows and
MVC actually needs a bunch of services
so they've been nice enough to create an
extension method to I service collection
that it's called add MVC and there it
will add all of the services with the
default config and then you can go in
and pass in an options class if you want
to make change to configuration with MVC
in my pipeline I can now go and do the
stuff that we always do we go and go
folder controllers go and say add new
item I want to have something asp.net
let's do a an MVC controller called home
let's clean it up because there's no
reason to keep that there is beautiful
right not gonna make any changes to it
it's a clean controller what next also
we need we need a view folders a new
folder view we need to add another
folder in here add folder home and then
you see here we gonna say add new item
MVC layout page I'm gonna call it index
I'm gonna take this and I'm gonna go say
h1 then I say hello NDC from MVC there
is I run this
kinda sucks that this is all Michonne
like ninety thousand times by Damien
Edwards and David Fowler and nobody's
impressed that in about five seconds my
application will do an MVC application
in the console app which is really
really cool
but they've destroyed it already but it
works right so what we do is we go ahead
and we get our middlewares
from other people we let people like
Damien and David go and build our stuff
and then we piggyback on it that's the
way we should be doing things one thing
to keep in mind we just little bit
different here than it was a project
katana if I go in like this and press
ENTER I end up back at a hello and you
say because MVC we can't come into our
pipeline it's actually quite easy to
have a look at this let's just kill that
we come into our pipeline request comes
in it has the exception page
it goes through request time or request
time oh that's kind of cool I didn't
show you that but the request time
actually works still even though I'm all
of sudden doing MVC stuff this thing
still times everything so when when
David goes up and says that MVC is
really a frenetic or is really really
fast we can approve that he's hopefully
right then it goes through the party the
timer it goes through MVC MVC will then
look at it and go that path is not
something that I recognize it's not part
of the path that I would expect so it
passes it on to the next one in if you
were doing project katana you could
combine Owen with MVC but what would
happen is you would have your Owen
pipeline and if there is nothing that
responded in the Owen pipeline you will
actually fall out of the pipeline and
hit IAS is would then handle requests
and do the embassy stuff and then it
would pass it back but that also meant
that if MVC didn't find anything that at
that path it would return a 404 in this
case if it doesn't find anything it just
lets it follow through to the rest of
the pipeline okay so this is pretty
awesome right
it is very very simple very very low
level it is very raw and awesome to work
with it's it's fast it's easy to throw
things throw things in there you do
things like oh I just want to see what
this is you do a little inline thing you
run it you can debug it it's very very
easy and
if you want to go bigger you add more
you can also fork the pipeline so
instead of doing use or run there's a
map and map when method and basically
you can say when somebody comes in to
this pipeline and the URL is this I want
to have this configuration of the
pipeline and these middlewares and
otherwise use this which is really cool
because it actually opens up a scenario
that I've been doing a few times and
people look at me weirdly when I do I do
different authentication methods so I
have an application where we split the
application into three different
pipelines one pipeline will run an MVC
website that uses login I think they're
doing social logins through through a
Facebook so they will use cookie
authentication then I have another
portlet web site that starts with slash
API which is for a web api and that
thing will not use cookies it will only
use access tokens so it will use bearer
tokens and then I have another partner
website that goes to slash and it's an
admin part of the section thing that
couldn't use social logins but uses
their internal logins instead so they
have a different login there but they're
still using cookie authentication but
the cookie authentication there is
different from the cookie authentication
I'm using in the other part of the site
there's a stupid guy on stage saying
that I should have a bunch of different
no I didn't say that but it opens up a
bunch of flexibility that you can do
different things it also means there's a
map when where you can do your own
predicate and you can have a little
function that actually evolves whether
or not to use this other pipeline so it
doesn't only have to be a URL you can
actually go in and say if this user
happens to be deluxe awesome fantastic
you students paid you a trillion dollars
he gets a different pipeline I don't
know why that would be useful but it's
kind of it could be but yeah I think
it's pretty cool but what about old
stuff what if I come now into a static
or and I look at this and I go oh I have
this awesome middleware I wrote a year
ago in project katana can i plug this in
here yeah it's answer is that it's not a
good answer it's not Swedish it's not
even
yes you can but you can't plug it in as
a middleware you can't throw it into
this middleware pipeline and say here is
another middleware because your old
middleware will expect an addiction Airy
and this thing will give it an HTTP
context so you're going to go ahead and
go and you suck and it's going to start
the pipeline so what you need to do is
you need to have a different way of
doing oh in a wind middlewares from
project katana or other own stuff and
the way to do that actually I I just
happen to have a project with a mid
we're in it so I'm just gonna go add
existing project just gonna put me in
here there's a simple Owen based project
katana based middleware Owen own way of
doing things I can take that but I can't
plug that in because that middleware as
I said is different so what we need to
do is we need to go in here and say
project with Jason and do Microsoft with
the capital K capital M it's been a core
Owen 100 100 having that in there means
I can then go back in and say somewhere
in here let's actually do it here cuz
the middleware I want to plug in is an
exception handler delegate so actually
wanna I'm gonna remove that thing
because that is way too fancy for me the
app dot use a win it gives me a pipeline
that pipeline is awesomely enough tan
action of funk or Fong coughs I
dictionary thread onion going if you
look at the length of the signature of
that thing just ignore it it's a it's
this function so if you go pipeline like
that it gives you a whole new set of
weird things what you're getting here is
kind of that mid funk version but the
mid funk expects sort like inline
function it doesn't expect classes like
we do our Midler's so what we do is we
say next
with the Ferreira and then we say new
and the name of my that my middleware
was something was some debug error
handler middleware it's a new debug
debug.error yeah
as if I normally oh yeah in core that's
not handled for me by resharper properly
so that's the one there it is so I
create one of those and that one expects
a reference to the next thing which is
going to be next and then it I return
the invoke method does that make sense
you guys are way smarter than I am okay
so once I've got that I need to throw an
exception somewhere to get this to work
let me go down here and say throw a new
exception because that's one cool thing
if you throw exceptions without some
form of exception handling middle where
the pipe line just swallows it it
doesn't break your debugger it doesn't
give you any info on it does give you
logging but it just swallows it and
doesn't break we should still you or
anything like that and go into debugging
it just goes bad and it just gives you
500 back so I'm going to throw a new
exception I'm gonna add something I'm
going to say it's Gillan's fault if
anybody would want to know who Glen is
his name Glen Condren he's p.m. on
dotnet core team it's his fault
everything is his fault we start that
and this might work it might not work
because it's been slightly flaky on me I
hope this works now
okay didn't break because I'm now in MVC
right so I'm throwing after MSA so it's
gonna break something here hope didn't
work I need to force this thing to
recompile properly let's see if I can
get to work now I figured out that it's
actually a company it's a compile issue
it doesn't get updated code for some
reason doesn't recompile properly so
I've got this error handler thing now
that will now give me it will tell me
that something wrong and it's going to
tell me it's Dan's fault it's gonna give
me a stack trace and it's also going to
give me a length linked to a stack
overflow with the error message if I
click this I'd pretty sure it's stack
overflow won't tell me why it's a glance
fault but it should that's kind of cool
right easy to plug in old Owen stuff as
well so I'm yes
that's the thing NBC will say I can't
handle it go to the next guy so anything
that NBC doesn't have a response for
we'll just go on through the pipeline so
you won't get for a force you could
probably configure it or you can
actually if you if you don't have
anything after MMB say they I think the
pipeline will actually go 404 because
there's nothing answering it so this was
kind of the end of stings but I have
some extra stuff that I want to show you
gonna go completely freak out and show
you weird things and give you some ideas
of things you can do with the Owen
pipeline one question one comment I get
is that the whole how do you do error
handling I'm using that Owen pipeline my
in the my debug error handler blah blah
blah if you don't want to go this big
and have your own middleware and
everything and just want to do it for
debugging purposes for some reason you
can actually go it's actually quite easy
this is kind of a cool way this is
something that's easy to throw in for
Deb you go app dot use CTX async CTX
next do a one of those then you do it
try since this is all code right we can
to put try-catch in here so we can just
do a wait next and then if that blows up
I can go and say console the right line
or that's this that's gonna be defining
out there right I forgot
go to some weird location it goes
alright so since the pipeline as I said
it's just a matter of code and methods
calling methods we can add try-catch
stuff anywhere in it because since it's
Russian doll and not like a linked list
it basically it means that I'm pushing
things in and when something breaks it
bubbles up and I can handle it wherever
I want and in here I can say try catch
if it blows up change it to a 500 and
here is my awesome content for my 500
error page or I can create a redirect or
something
creating redirect however is a bit of a
pain because as long as the exception is
thrown this is bad this was my last
piece of paper and it doesn't include
what I'll show you now this is gonna be
interesting um yeah it would be fine I
think I used that one um
how let's do something about it bubbling
up ya rear eggs thanks sorry I'm losing
myself redirects it's a pain in the butt
because as long as your your exception
is thrown before anything is written to
the pipeline which I do here everything
is fine in my exception here and error
handling middleware I can change it to a
redirect and change the headers and all
of that but if the exception is thrown
after the response or during the
response as soon as somebody has written
something to the pipeline I'm actually
written through response I'm too late
because it's already sent all of it so
it has already sent they to HTTP 200 and
probably partial response and then it
blows up and I'm sitting there going you
just sent an HTTP 200 and half of your
content and now you're coming telling me
that you made something wrong douchebag
so we need to sort that out and there
are a couple of ways of doing it this is
done internally you can actually buffer
the response which is a neat way of
doing it so if we take this thing and we
can buffer the response let's try it
here let's do VAR MS equals new memories
memories
nothing to get better sounding like
you've got something wrong in your head
that apparently doesn't make your
spelling better VAR response equals CTX
dog responds the body CTX thought
response the body equals MS see what
I've done that I should create a an
another stream and add that to the body
so when everybody anybody in a
middleware after this starts writing to
the stream they're actually writing to
the memory stream and not to the actual
server stream so nothing is going to get
rid get written and then I can go down
here and what I do here is I say
something brilliant like I had code for
this to remember what I'm supposed to do
let's do a mess see if this works see TX
dot response dot body equals response
and then do ms dot copy to async
response and wait that thing so that
means that basically if if everything
goes fine I'm gonna copy everything from
oh there it is that's the one I miss
zero there so I basically I take the
memory scheme that they have written to
I run that back to the beginning and
then I take all of the information in
that memory stream and I pass it to the
the real response and that gets rendered
but if something goes wrong I can go in
here and say now actually let's put it
back the body back properly like that
but then let's do see TX dot response
the right async make that a wait you
caused an error stop ruining my website
and then return access
I run this
that works and that now buffers it so
even if I yes oh yeah this is this is
crap from a memory point of view all
right yeah III was gonna come to that I
was gonna say that that there are our
issues with this and I wouldn't
recommend doing it all the time yes
there are four sort of kind of H obvious
reasons there are memory issues with
this because one when you write to the
response stream that you get from the
server it's actually not being buffered
to go straight to your clients it
doesn't stick on in memory this thing is
gonna make you make that every single
request to your web application will be
stored in memory as a string buffer
before it's being sent out and it gets
even worse if you do it like this
because the memory stream without
actually being initialized with a
specific size will do a whole bunch of
weird things to resize it and everything
once it grows beyond the existing size
and things like that so there are there
are definitely this is a demo right you
need to do it better than this you need
to show me it show me up and go I know
that sucks I'm gonna do this better and
prove me wrong but yes there are memory
problems but it also gives me the
ability to do something really cool
which I've done a few times I can take
this code I'm gonna make a few tweaks to
it I'm gonna do that but I'm gonna cut
that out there not do that and then I'm
gonna turn that back I'm gonna die ba ba
ba ba I'm gonna do that and then I'm
gonna let's see here I have code for
this I should know this for actually
let's do it let's do it like this for
response equals response text equals and
coding the utf-8 dot get string from MS
dot to array like that response text
equals response text dot replace replace
hello I'm in Australia so I've heard
that it's all great down here right and
then you go and take that and you say
8c TX dot response dot right
asyncresponse text run your application
that is not what you want to see but
that's temporary until it boots up
properly
it works you can go in and buffer
everything that goes out and make
changes to it
not recommended for something really big
or really complicated and there are
memory issues with it and there's
another problem with this is that
there's actually another request coming
in here going to favicon dot ICO that's
not a problem right now but if I was
serving up images and stuff like that as
well and I try to read that the UTF
stream and then go in and replace stuff
with it that would be bad so you don't
want to do that and also one thing to
note is if you're serving up static
files that is not handled by the
pipeline to begin with so if you want to
serve up study files you need to get
another middleware called static files
and go app dot you static files and then
it will serve static files out of the
dub-dub-dub root folder of your project
if you want to change it you can
actually tell it to serve up the files
from some completely different place
like a network drive or something like
that and you can also tell it what URLs
to respond to and things like that so I
used all the memes I could find kind of
sorry about that hope we can still be
friends I'm not a big-name person
normally but I needed something my
presentation was quite boring otherwise
so I just want to thank everyone for
coming it's been awesome presenting and
I hope you got and it's something out of
it that you can use if you're more into
interested in more information about
Owen
you can obviously go to this URL here
and you can watch my course on
Pluralsight on our win and get lots more
information and give me money which is
good you always want to give me money
that's a good thing and if you don't
you're not a member of pleura site they
might have those trial cards understand
if not hit me up I'll get you want I've
got one in my bag or a couple in my bag
so you can have a look at my course you
only get a free trial pass if you watch
my course at least four times thank you
everyone
it's been awesome</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>