<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Inside the new team build - Richard Banks | Coder Coacher - Coaching Coders</title><meta content="Inside the new team build - Richard Banks - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Inside the new team build - Richard Banks</b></h2><h5 class="post__date">2016-11-28</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Au52lvTPTTw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">yes good it's coming through the air
awesome all right hello everyone hello
you awake awake coffee you got coffee
morning tea something like that all
right so what we're going to be doing is
running through the new build system out
of curiosity just before I go too far
how many have played with the new build
system kind of nun kind of nun excellent
i'll plan at the back well thank you for
your support all right so introductions
I'm Richard I tweet there I have a site
I do stuff visual studio alm MVP general
pain in the butt all that sort of thing
but you don't really care about me what
you care about is the content of the
talk so I'm just going to move straight
on and here's what we going to run
through we're going to go through the
howlin live team build why there's a new
thing and I hit the button twice I
didn't mean to do that we're also going
to look at custom tasks how we extend
the build add new tasks to the build and
then we're going to look at a thing
called sonar cube and how we can do
integration of our build too so no cube
so it can track technical debt across
builds and hopefully keep on top of our
technical debt avoid getting worse and
if anything even during pull requests
and stuff monitor that so that we don't
go backwards in terms of our code
quality and maintainability which is
kind of cool I actually like that a lot
so the Y the Y abbr team build I'm a
little bit echoey by the way there were
some gaps in the old build system who
you've used the old build system worked
I windows workflow based all that sort
of thing have you ever tried customizing
that by the way and you're still alive
so that's good so there were some gaps
there were some questions you might have
had some of these questions anyone any
of these seem familiar to you guys at
all cross-platform anyone tried doing
cross platform before i actually did
believe it or not tried doing linux
builds in the workflow system by using
remote power shell and ssh and other
things and to say was painful
probably an understatement or the you
know things like why do I need the
current version of visual studio just to
build a definite change a build
definition like what where'd I set of
logs had I coverage in there she have
you seen as Amal definition anyone
opened one up and opened it up and then
kept opening it up and kept opening it
up and then opening it up add more and
open up a bit more and you get the idea
keep your build agents up to date all
those things and of course the main
question uh-huh so why is teamcity you
so popular lately exactly it's just a
task runner you just kick it in you set
the toss-up you do your thing it just
works so Microsoft saw that and they
went you know what this really isn't
working for us we're going to go back to
the drawing board we're going to take
the lessons that we've learned from
looking what the competition's doing and
we're going to kill the old bill
definitions and the build approach and
introduce a new build approach that is
effectively like teamcity in some
respects it's not a direct clone of
these thing those concepts of how do I
just do task running and go from there
the mechanism itself is then what they
end up using for the release management
so who's played with the release
management as well now anyone so release
pipelines write a CI CD pipeline these
days is effectively just a sequence of
tasks that get executed team build is
the build part of that the continuous
integration part and the release
management is the deployment part they
work on the same approach you have some
tasks you run them you put them in an
order step step step fairly
straightforward so the new build system
as you can see now has a whole bunch of
these different tasks we have you know
Android builds Xcode build we've got
shell scripts and command scripts and
everything else no more zamel yes no
dependencies on ms build genuinely
cross-platform these tasks will run
either PowerShell jobs or node jobs on
the various platforms so windows you're
generally looking at PowerShell and on
Linux and Mac OS
all that sort of stuff we're looking at
no Jas and we just go from there so
quick run through the build system for
those who haven't seen it before I'm
just going to jump over here here's our
build view so this is a VST s hosted
project you'll see this is slightly
different than what you'd be used to you
put my teeth back in you'd be used to
probably the build Explorer view which
is this view here let's go don't Wi-Fi
there we go come on phone you can do it
with our list of builds and everything
else and you go into Visual Studio you
see the build Explorer etc etc what
we're seeing now is probably more let's
go a more dashboard based view of things
so these are the builds that I
personally triggered so they come up
under my list but I could look at all
the definitions and I could look at the
old zamel builds as well so vsti still
supports those old ones and I can see
these builds have happened the
continuous integration build an admin
project at github build yes I can build
github code Envy sts which is cool and i
can see the success rate of these things
how they've been going is this build
healthy is it having problems all that
sort of stuff the usual things if i want
to trigger one of these i simply go in
queue and you build as you do and i will
just hit the magic button hit okay and
we now go into the build view which is
going to be executing the various steps
that i've set up and the joys of doing
this on slow network i think the fact
that we're inside a big concrete box
slide down my 4G connection a little bit
so you can see here it's doing the run
and we're going to now see the live
console so if you haven't seen this
before this is kind of cool I'm actually
getting logs straight off the build
server this is the hosted build
controller and we're getting a live feed
of what it's doing so we're restoring
the nuget packages we're doing whatever
else it is that we need to do
we've got the build configured to do
which is great so I'm going to let that
run that will finish we'll have a look
at the build log in a minute if I go
back to the build definition itself and
edit it so here I've got a specific
build the summary of what's been
happening we can see the various history
of this build over the last nine builds
they've all been successful for example
so we're getting these dashboarding
views of our build health I'm going to
go heap edits and we can see then the
steps any second now to actually click
it there we go little spinner spins and
and and and there's my steps okay now
i'm not going to bother clicking a plus
because i'm sure you know how to hit it
plus to add a step but the key with all
these steps is they have parameters to
them these parameters grouped in terms
of building custom task later we'll show
you how to do some of that variables as
before dollar variable name in a bracket
those variables come from the variables
for the build these can be overridden
that cute i'm so i could say i don't
want to build the debug and release one
I wanted to build just debug for example
I could change that we have the usual
things like the repository to connect to
so this is a git repository on the STS
but I could quite easily talk to github
or an external get provider like a a bit
bucket if I use them or subversion
builds even tfpc as well all that sort
of stuff is in there and I can then pick
that up in and compile you'll note here
this little flag report build status
this is kind of cool what this does this
puts a little icon here in my sort in
the code view that says what's the state
of the build for this branch so if I hit
f5 while this builds running I should
see that it's pending because there's a
build currently in progress and when
that succeeds I get the little green
tick if it fails like at the big red X
as I suck and as a dev be how to jump in
and see the health of a branch is good
if I go to a different branch which
doesn't have a build attached to it I
won't have a little indicator sitting
over here okay so it's not going to show
me the health of code that's not
currently under build which is good so
it's still pending I also have in
general as this thing badge enabled
which is a similar concept but let's say
I'm doing a github build so I have this
same code over here in github and you
can see that this build is failed the
little build things you've seen these on
github projects i'm sure this is a
really easy way to get one of those in
there you simply turn on the flag it
gives you a URL you pop that into your
markdown file on github and then it just
renders the current state of the build
which is like nice nice or you could put
it into your wiki for example as well
let's save got an internal wiki or
something like that that renders marked
down or just renders images because it's
just an image you can put that somewhere
and have the current build status
sitting there all the time so you've got
these badges that show current state of
the bill which is cool you'll see other
things in here so on the general tab
there you can see that we have demands
this build has based on the steps that
it has has certain demands on the bill
dejan that it's going to run on it says
I need to be a machine that has ms build
on it Visual Studio MV sts if I was
doing Xcode I'd want something that
supports that or if I have to do NPM or
if I have to do you know grade or
whatever else these are going to be
different demands and these are picked
up by the agents which will look at soon
and the other thing just to be aware of
is there's history so every time I
change these builds I now have version
control bill definitions which you don't
have with the sam'l builds so when you
change the build and build suddenly
broke you don't know who changed it what
you changed and inside of workflow
definition if you change one thing and
you get it wrong oh yeah it's not much
fun and as you would expect you know
triggers and all those sort of things as
before key thing to note that you can do
pass filter
so while you can do a trigger on a git
branch you can also filter down on that
so if the branches checked in but you're
only interested in a follow three levels
deep or something like that because
you've got maybe artifacts and you don't
care about them or whatever else then
you can filter your builds get a little
bit more specific about what's going on
all right so that build hopefully is
ticking along let's have a quick look at
the summary jump back to the summary
view and no builds q that builds
succeeded the one we triggered before so
we'll just have a quick look at the
summary view which is nice i like this
view so there's my builds there's the
steps that occurred the bill was
successful and I now have a view as to
what's going on so you can see see that
their little animation as well just for
fun if it's got an animation it's got to
be good so this build has a hole for
test its massive obviously he's got a
huge coverage but at least they pass hey
and I could see code coverage if I had
it turned on i can see any information
any warnings coming out of the build if
i had a deployment tagged onto this i
could create a release of this links
through to release management so i can
see which builds have been pushed to
which environments which is good so we
get that full C icd pipeline going on
I'm not going to deal with release today
too much other than the occasional
mention work items change sets etc we
also have because I'm running tests we
can have these extra view so this is the
test hub or the test tab I should say in
the build results and the summary if you
write your own custom tasks you might
want a different view in here using
information that's been recorded you can
extend these views you can add your own
tasks tabs own tabs into the summary
here without a problem through
extensions so if you don't know what you
might be doing but if you want to do
something around that you could put it
in there without a problem so that's how
this is actually implemented the test
tab here is actually an extension yes
yep whatever you like in units just
another task or running it's the best
test run right so end unit because it's
supported by vs test just run it through
that where you go if you want to do j
unit test or something like that let's
say you had some java code you can push
those in as well so that the j unit
tasks will do whatever it needs to to
push stuff in and here at the moment
only showing failed ones if i switch
this over to past you'll see there's
might our tests etc so i've got those
different views of what's going on nice
alright so that's the build fairly
straightforward in terms of executing
running them adding tasks and so forth
it's nice it's nice to support this the
team made some architectural changes
that are important to know if you're
coming from the old one through to the
new one or just in general so firstly
the old build system required a
controller so if you had an on-premise
TFS server you'd have to run a
controller which then talk to agents and
so bill would trigger it will pass a
message to the controller the controller
would figure out which agent to run it
on and handle all that for you the
control is gone no separate controller
process which is great turns out that
agents now registers directly with the
deployment level theme which basically
means your on-premise TFS server or VST
s at the account level so that's what
we're talking about when we say
deployment level and the collections
talk to those agents themselves are
pooled so you don't directly address an
agent you address an agent pool and
agents register themselves in a pool and
then we go from there and the good thing
with those agents is once they're
installed they actually update
themselves automatically so you don't
have to worry about keeping these things
up to date as new versions occur or a
release they simply go and grab
themselves self update restart
themselves very nice so from a
management perspective really easy so if
you end up running a large build farm
that's really important and Microsoft
dog food at a lot of this themselves
they run a couple of hundred build
servers managing all those was a bit
painful for them so they fix the pain I
don't know how many build agents or
serve as you run but I don't run a
hundred I don't run even ten normally
most people will run one and maybe one
agent but architectural e what we see
now is this that agents are doing the
work agents execute tasks those tasks
get downloaded to the agents and run
from there as you version or update
those tasks they'll come down
automatically and those agents will
either do build tasks or release tasks
it's not a problem they're just agents
they execute things the agents get
pulled as I mentioned and in a team
project collection we create cues that
point to those pools so there's a
one-to-one mapping of a cue within a
team project collection to an agent pool
and then the jobs that executes whether
it's a build job or at least job simply
run in those cues they get queued up and
executed away we go nice turns out that
the agents themselves they're actually
two versions at this point in time the
original versions were a dotnet version
running on windows and a nodejs version
running cross platform so running on the
mac or the linux boxes they still exist
they're still usable no problem at all
however we've done that core coming out
the team's done the smart thing
consolidated the code and now has a
dotnet core-based build agent so the one
code will run across all you know all
the different platforms so it makes it
much easier for the team to maintain it
also makes it much easier for us
deploying things to go well I don't care
what version i'm just going to take the
agent and push it to the machine where
we go so we'll see that in a second as
well a few other things to be aware of
there were some security gaps in the old
system the old approach so each build
now runs in its own separate process
that means if you've ever
the situation where a builder's hung and
locked files and you've had to log on to
the build server and try and release the
files and you've done this just me it's
just me that's not there anymore if a
build hangs in you kill it because it's
out of process those that process
disappears the locks get released end of
story happy days each build is also now
given a time and scope limited access
token so previously the bill would run
under full permissions that doesn't
happen anymore so that means a naughty
developer doesn't get to write a unit
task to execute something and does
something evil on the TFS box or the VSP
s account and we now have restrictions
around that not that that would ever
happen right never happens no dad's ever
do naughty things where's Troy stalk
alright so let's have a look at agents
very quickly so the idea with agents if
i go into admin over here to start off
with all right and I go to agent queues
you will see that in this particular
team project i have AQ 2 q's one of them
is pointing to the hosted build
controller or the build services hosted
agent and the other one is might what
I've called the creatively named default
queue for my my on-premise build server
which is actually my laptop actually not
this one this is a V nevermind different
setup doesn't matter it's a machine the
default queue has two agents in it
creatively named RV build now be billed
to and you can see what's happened that
each agent we can see has run that run
has run two builds this one's run three
the host of one where I normally run
things has run a lot more the hosted
agent green it's currently available at
the moment my default queue has no
available agents they both stopped we
will fix that in a second you'll see
here if I want to set up a new agent I
simply download the software I hit
download
and you'll see now we have windows OSX
and Linux and we have windows legacy
this is the old dotnet one that's the
bring it down install it this is now the
new dotnet core stuff so to download it
you can either just download it yourself
or you can use a little bit of
PowerShell this is simply doing a zip so
you can see it's a zip file there
extracts it to the current directory PWD
current working directory and then we
run config and run config simply
connects it up to the your deployment so
your TFS server or UV STS account
connect that up using a personal access
token have you seen these by the way
personal access tokens nope okay so very
quickly let me just go here I'll just
under here if you go security under your
account you'll see these personal access
tokens I've created one for this agent
for example this creates a one-time key
you've got to copy it down and remember
it because after that the UI never shows
it and then you can use that token to
connect up your agent so if you change
your password the token stays the same
and your agent doesn't suddenly stop
always handy you've never had that
problem right someone has an account
password someone changes it oops
everything broke never happens never
these keys themselves have scope
restrictions on them the only one you
need for an agent is this one here that
says agent pools that's it so I don't
need to give my agent permissions to do
code load tests extension data I don't
know whatever else managed projects push
stuff to the team room it doesn't need
any of that stuff I just need to have a
token that says do that and this is
valid for a year once it's expired if I
want to fix that I jump in here and I
hit refresh I change it to expires in a
year and whatever else we go from there
so that does probably bring up a short
question which is should I run my builds
under my user account
one else's trick question right still
create a service account for these
things don't run that under your own
because it will show up in the builds
you'll see it in the logs anyway so we
download the agent if I'm running on
Linux for example it's exactly the same
deal I download it we use tar in this
case to unzip it and based on screen res
we do config again and we run it so you
can see there's you bunt to 16 Red Hat 7
whatever else there are the dotnet call
supported platforms at this point in
time I would expect as don't knit core
improves over time that that will extend
I'm sure you can try running it on
something else like gen 2 or whatever
else I just don't know if it's supported
that's all all good so I have one here
I've prepared earlier look at that
screen res isn't that beautiful that's a
4k display getting mucked up but you
should be able to see here this is the
agent I've done the config already i
won't go through that again I'm just
simply going to do run command which is
going to start the agent as you can see
it's going to say I'm listening for jobs
so it's currently doing a scan of the
machine to check the capabilities and it
will report that in the agent and then
that's used by then VST s to figure out
what to push so if i go to my agent here
and just hit refresh on this page you'll
see that our be billed to is now an
active agent it should be green there it
is because the agent has connected it's
got a current status and the
capabilities in here are simply a list
of key value pairs so this says you know
here's my capability i can run ms build
for example i can run down the bottom vs
test for example so i have that
capability if i wanted to query the
specific version of vs TS or the path or
whatever the value happens to be i can
do that in my build as well ok so this
is how you configure agents get them up
and running it's very straightforward
nice and easy to deploy
and can then run anyway so if you want
to do your Mac builds or you need to do
I OS development whatever else you
simply take your agent you put it on a
local Mac because you have to compile
obviously on those things hook it up to
your VST s instance and job done you've
got yourself a build server ready to go
alright so moving through extensibility
I've never got to build i can run steps
I've got agents I can deploy to I now
want to do something a little unusual
because hey I'm me and I've always got
something special I need to do so what's
the approach the general approach to
extending a build and doing things that
aren't in the normal step is and he's
probably the preferred approach is to
run scripts scripts don't require you to
build your own custom tasks deploy them
or anything like that you simply take a
command script or a shell script or
whatever else put that in a task in your
build step and execute it and a story
and nine times out of ten that will be
sufficient probably ninety five times
out of 100 to be honest where you want
to think about custom tasks are where
you taking the same script than you're
applying it to multiple builds multiple
do build definitions all doing exactly
the same thing and you can parameterize
that whatever else you might think about
doing it that way or you've got an
overly complex set of things that you're
doing and you want to do something
around that make a little easier to
manage all your doing custom actions or
whatever else it is that you want to do
there are reasons to do that what you
should think about yep
yeah absolutely yeah it's just a script
it's going to be running a script that's
from source control so as long as it's
in source control you just point to the
path away you go the thing to remember
with any custom task is it simply a tool
runner it's going to run some sort of
executable on the machine to do a job so
we'll look at one in a little bit but it
the octopus deploy one will look at that
one just for fun it will run octo XE
that's all that's going to do it's
fairly straightforward and those tasks
as I mentioned either PowerShell or
nodejs and we use a thing called tfx
cell I to do these things to manage
those tasks so if i go back here for a
second very quickly and as you can see
screen res come on baby and it's unju
mal ittle bit that's probably too small
isn't it that's good how about that
alright tf-x is the thing that's been
installed to get this in you simply you
need to use node this is cross-platform
so this is an MPN think so you do npm
install dash g for global tfx CLI and
will turn up in your path and you can
simply run tfx everywhere it's good
because as mr. hanselman was saying
before it's got ascii art so it's got to
be good and i simply go to FX build and
I can do dash dash help to see what my
options are and I can either queue and
you build I can list things I can show
tasks I can do whatever it is so I did
before task list which shows the
existing ones that are there and you
could see the octopus ones that had been
loaded up then not part of the default
install I've actually added those and
this is querying so initially I did a
tfx logging I use the personal access
token to login connect it up and then I
can see these things and if I wanted to
get rid of one of these I would do tfx
tasks delete and then give it the task
ID and it's gone so this is how I'm
managing custom task
on my account okay to put a new on there
i do tfx tasks upload build task upload
whatever and that will package up for me
automatically a folder and send it up
there with a manifest file and
everything that you would expect so
custom tasks are different to the
summary extension by the way so build
summaries extending that with extra tabs
or adding extra visualizers is an
extension the build tasks themselves are
custom task they're separate pieces so
if you were putting together a component
that show build task and visualizations
you'd package that up as a extension
overall and deploy that and you'll see
that with the octopus one common
question that comes up how do I say if
I've got multiple tasks how do I get one
task to create a value that I can pass
on to the next task you do that with a
thing called logging commands logging
commands to be genuinely cross-platform
do something really simple and really
simple and it's really simple and its
really kind of simple you simply take
because I said simple enough double hash
vso and you log this to the scone the
console the log monitor picks that up
and goes all I know how to pass that and
will read it so if I wanted to set a
variable i do a double hash vso task set
variable variable name equals test var
and then the value after that and that
will then become available in subsequent
tasks as an environment variable and
then I can simply go dollar environment
variable name and I can pick that up and
read it mmm if I was using PowerShell if
I'm using node I'm obviously doing
something slightly different to read the
environments but same approach one thing
to avoid a lot of tasks originally were
setting environment variables themselves
if you do that it won't get passed
through because tasks themselves are
executed out of process as well so a
builds executed out a process
and the tasks we learn to build executed
out of process so if you set an
environment variable when the task
finishes that process goes away the
environment you set it's gone so you
need to make sure you use it the login
commands there are a whole bunch of
others as well so you can do things like
reporting progress so if you had a
long-running job and you want to report
you know every ten percent how my house
my progress going you can do that with a
log in command as well and the build
agent picks that up and the build system
reports on that makes it available and
is it's cool all right so let's have a
look at a custom task shall we go away
you so this is the octopus build and
released asks if I want to install those
in my account or on my TFS server I can
either download and just hit install
that's going to create all the various
tasks for me nice thing is you can look
at this code cause it's online so here's
octo TFS this is all the source we need
so this has information about deploying
it packaging these things up putting in
the task if I jump into sauce here we
can see extensions and tasks and I can
come into tasks and we've got some
common things we've got deployment task
packed a stock go pack who's used
octopus a couple of you so I'm just
going to have a look at this create
octopus release and you can see this has
a task JSON file so this is effectively
the manifest this is the definition of
what the task is and let me just go full
screen oops not github desktop no all
right what have we got here we've got a
name it's a well-described JSON document
effectively versioning information the
category this is set in whatever else in
it can be build or deploy what grouping
I've got so and then
here inputs user inputs remember the
parameters on the right hand side of the
screen that we were looking at so when
you add a task you've got parameters and
variables you can set this is where
they're described so they come in here
they're described with some help files
on various things as well so you can put
a little mark down and document things
so little information icon that's there
and that's pretty much it so yeah it's a
little bit adjacent it looks a little
clunky but it's fairly descriptive and
it's fairly easy to read and understand
it's just a matter of setting properties
ronke alright so if we go have a look at
the task itself this is simply launching
a PowerShell file remember that's just a
task runner and if we look at the
PowerShell file you can see it's picking
up things like the current repository
provider PSS endpoint all these things
that have been set and you'll find if I
look for octo that it's going to run
like to push down here it's going to
check the credentials do whatever it
needs to do execute a whole bunch of
things and essentially calls octo XE
after its set up whatever it needs to
based on the properties that have been
provided and it's the magic button
that's as complex as it gets question
you can that's the that's the whole
thing right if you just do this as a
powershell script that's perfectly fine
but you might want to make that easier
to manage you might want to make it more
parameterize so that you don't forget
what you were doing because I could just
do in my build definition let's just
jump back in here and I'll show you I
could if I want go edit for example and
in my build steps add a build step that
simply says execute PowerShell and to do
it's going to be utility let's go there
powershell yep and I could add that and
I could go into here and I could put in
the script path like putting all the
arguments but that's a long set of
arguments and editing all those on this
line he gets a little clunky because
it's just not that much screen real
estate or I could make it a little
easier for myself and go and add instead
in i'll just do it all wherever it is
create octopus release undersea create
where's the octopus there it is hello
add that you can see here that this is
all the extra information so what's my
project and we've got you know the help
mark down and if i want i can had
deployment things i want to deploy this
too I've got additional options where's
octo Dex he actually lives if it's not
in the parser all these things that that
I have that it just makes it easier for
me to do some of these things so yes
scripting is definitely the preferred
approach as a basic starting point but
when you want to get beyond that it's
not too hard to extend from here the
good thing with this is this is now
bundled with a whole bunch of other
tasks as well so you can actually bundle
these tasks together as a full extension
and deploy that to your installation so
octopus it depends who you know
now octopus costs money it's a
commercial deployment product but the
the extension itself to integrate to it
from the STS or TFS that's a freebie
they're not the only things if you want
to look at other tasks all the Microsoft
tasks that are in by default are
actually provided online the source to
them also if you want to have a look at
how archiving worked zip files I can
jump into the archive files task and I
can see that this is got some type
scripting here where we're doing some
effectively this will run under note so
this is typescript get compiled down
obviously and then we've got things like
where's the tower or the zip location or
7-zip or win7 zip and whatever else and
this will go through and execute the
appropriate zip task on the appropriate
platform so if you're after inspiration
on how to do something definitely look
at the task library here and it's also
got all the JSON files and everything
else that you can look at on in terms of
how do these things work so extending
VST s really easy and a lot simpler than
it used to be alright so moving back to
other things so I want to talk about so
no cube so technical debt or if you go
to doc Norton session later this week
he's going to talk about technical debt
versus what we commonly call cruft being
just stuff we don't like inhale codebase
well worth going to that session by the
way if you want to a little bit of a tip
I like keeping on top of things I like
to keep my code clean because I
personally am a pretty crappy programmer
I use tools to point out when I'm
rubbish they pointed out regularly and I
have generally relied in the past on
things like you know FX cop and so forth
to tell me where things are so no cube
if you haven't seen it before is a
really nice tool for for tracking these
things we don't like all the technical
debt you know the questions like here's
my code getting better or worse over
time because FX cop doesn't tell me that
just says at the mome
and you suck by this much but am i
sucking less or am i sucking more or
where the hotspots I need to think about
in my code what should I target for
refactoring an improvement where's my
dead code that I should get rid of what
are the problems I haven't spotted for
myself such as not disposing objects
properly and even better can I get that
information during a pull request so
that I can see that and fix my pull
request so that I keep the you know the
campsite cleaner than I found a boy
scout approach to code so let's have a
look sooner cube MV sts living together
so if you point your browser's if you
want to play along at home to RB
sonarqube cloudapp net I actually have a
sonar server running at this point in
time it's open I don't really don't care
what you do to it I can always just kill
the vm and start it again but I have in
here two different projects that are
showing me what's going on so he's a
dashboard show me I currently have no
bugs but I have for vulnerabilities why
no I don't wait oh yes I do I have four
things that are potentially
vulnerabilities and I can decide if
these are good or not and I can have a
look at my code I can see what's going
on i can jump into it I can see other
things that are going on like aa really
program should be static ah doesn't need
that or console.writeline look at that
there's my logging statement and I'm
passing a literal oh really should i do
that i don't know and i can decide if
this is actually important or not i
could decide that i can resolve this as
i won't fix it it's a known issue i'm
happy with it or yep it's a false
positive it's not really true or I'm
going to fix it or whatever else so this
is a good way of keeping track of stuff
who's run across so knock here before no
one oh one person that's exciting so
welcome to the brave new world of how
the rest of the the non dotnet Microsoft
universe works
a lot of these guys out there will pay
attention this stuff especially in Java
and things like that in fact the way
this whole thing works is there's a
bunch of analyzers this particular
project that I'm looking at I've only
run the dotnet analyzer on it if i go to
my main dashboard and look at the micro
cafe 1 i'm actually running c-sharp
javascript and web analyzers on it so i
can pick up a bit more stuff and it's
also telling me here you know I've got
no code smells seven days worth a dead
two percent of my code is copy paste if
that numbers above fifty percent you're
looking at an enterprise system five
point two thousand so 5200 lines of code
so you can tell this is a huge project
this particular one I can also see that
I found what's called a quality gate so
one of the things I can do with sonar
Cuba's i can say i have a certain level
of quality that i want to check if I
don't meet that I'm going to fail the
quality gate that quality gate at the
moment if i click on it says I should
have no blocker issues so the logic
around these flags is kind of backwards
but basically says if the blocker issues
is greater than zero then I'm failing
the quality gate does that make sense
okay there's other ones like this one
which is says IAM on new code if the
coverage is less than eighty percent
failed the quality gate so we want to
make sure that yeah we don't have good
coverage at the moment but if i if i
write new code from this point forward I
want to do better than I've done in the
past or I want to make sure that over
what we call the leak period which is
the last point in time we're checking to
now that I haven't had critical issues
greater than zero I could so that means
i could have old critical issues that
are there and unknown but i'm just
making sure that i don't get worse from
here makes sense so we can set these
things up how do i actually hook that
into hook this into vs TS
good question i'm glad you guys asked
it's kind of like the curiosity show
right so i'm going to look at this build
the app build it Wow don't you love it
when that happens by the way a page
refreshes before you're ready one of the
fun parts of JavaScript so if i go and
edit this definition there are two steps
to custom tasks that the that have been
created by microsoft to do the
integration for you and make this really
really easy you will see down here
sonarqube pre-build and so no cube
post-test these two steps or tasks i
should say we simply include that so
this is the same build as before
effectively it's just a CI build and
I've simply added this step first which
is the pre step what happens is I point
to sonar cube endpoints by the way I
just simply a way of making it easy to
reference a URL or a service so github
and so no cube so no cube is here and if
I update the service configuration you
can see I've given it a URL and I have a
username and token that or password that
I've entered previously we don't see
that again obviously so that's how vs TS
knows where to talk to so I'm going to
talk to my son r cube server and I'm
going to say this build is related to
micro cafe dash admin which is the
project oops the project here that i was
looking at this one here so that's the
name of it so that's how it knows where
to put the metrics okay so it needs to
know where to publish the metrics if
I've got multiple projects and other
than that there's my project name
version numbers and I've got in here
some Advanced Options one of those
advanced option advanced options is to
fail the build when the quality gate
fails that means if I fail the quality
gate visibility is going to go red
that's a good thing
that helps enforce that idea of if the
quality gates failed break the bill
break the bill because if I fail the
quality gate and I just leave it sitting
in so no cube guess what the devs do hey
just get gone I don't look its own i
cube until it's broken and it tells me
off we then do our building test and
then we simply take at the end our
results and we upload them so this is
just the aggregation step and it pushes
it up and does the final check and waits
for the analysis to complete and check
the quality gate and so forth all good
nice and easy such a simple integration
if you tried doing this with teamcity
it's a bit painful look at the docs on
Team city on how to do it and you're
kind of let's go in that's how you get
bald like this or you try putting it
into Jenkins and maven whatever else
these things are a little bit more
complex this is the easiest integration
of scene for this stuff and if I build
one of these let's actually I won't do a
build at the moment cuz it takes time
but I can queue that build and we can
have a look at the results and you can
see at times that the build has failed
because I've been playing around with my
quality gates which is what these ones
are now you'll see also possibly if I
just zoom that up a little bit that I
have builds of mass but I also have
these other ones seven eight and nine
these are pull request builds if you've
not come across this before this is a
really nice feature of using git and
that i can go into my admins part here
and if i go to version control i can
have policies on my branches so on the
master branch because that's going to be
my nice good code i have set up what we
call a branch policy that says when
someone checks creates a an update hmm
create or update say pull request that's
meant to be going into the master branch
make sure I build this project with this
particular build definition so I'm going
to do it with the sonar build what
that's going to do is it triggers the
build process but from a sonar
perspective it doesn't record the
results so that you can you avoid having
this incremental logging happening every
time there's a pull request it's here's
my last known good build how does this
compared to it did I go better or worse
and fell the gate and I've said block
pull request completion unless there's a
valid build nice nice so now I can go to
code and I can go to my pull requests
like it is and pick one of these for
example and because there's a build
attached to this a policy you can see
the build failed if I tried completing
this pull request sorry build must
succeed for you to update master no luck
no dice don't go messing up our
beautiful master branch with your crappy
code Richard like seriously so I'm going
to just reevaluate this manual merge are
really all right I'm not going to do
that that's what happens when you
practice things and you put it in the
wrong branch so what we're going to do
is we're going to be really naughty
really naughty and I'm going to go to
master here and I'm going to add a new
branch on the fly okay whatever complete
with typos ignore that they're not
really there and in my thing I'm going
to jump into some admin code i'm going
to go to admin service program CS and
i'm going to do what you should never do
which is edit directly in source control
right
maybe either dead or whatever else save
that that's created a commit which is
cool so now if I going to buy pull
requests and I can go new pull request
here and it'll validate I'm just going
to hit the magic button and what will
happen is I'll go to the pull request
view this is then going to go and start
a build automatically because of that
policy if I have a look at the build
over here you'll see that this is going
to go through the normal process as we
saw before waits for an agent starts
running we're going through the steps
it's doing his thing which is cool
looking at a previous one here's one I
prepared earlier I can also see I think
it was this one I can look at some
completed ones if I pass the quality
gate but I still have some issues what
will happen was it this one not this one
let's go to a completed one completed
so no cube as it runs if it picks up
warnings or things like that it can
actually log it automatically into my
pull request view uh-huh so on my new
code hey what works there's this unused
variable why why is that in here why why
and I can then go through that as a dev
look in this pull request ago yeah you
know what that's kinda not good and we
could have looked through that and made
comments and fix things up and and
pushed in new code fix up our warning so
that all our pull requests come through
is clean all the time so really nice so
I would encourage you to play around
with that in terms of time we're almost
done so just as a quick recap we've gone
through the why and the how of team
build why they build a new version other
than the obvious how the new bits work
together the basics of doing a build
what we need to do to customize tasks
and how we can do things like putting
sonar cube into our build pipeline so we
can keep on top of technical debt and
keep out quality high and that's pretty
much it so I would ask you guys to go
and play with this stuff yourself if you
haven't yet done it it's really easy to
set up it's not too complex probably the
hardest players getting a sono cube
server running but again if you're using
Azure or something like that you can
probably find a VM image with it sitting
on there already and then just go from
there questions
yep so you'd be looking at gated builds
so you'd have a gated build that runs
and get the gated build do the sonar q I
haven't checked TFE see in a while in
terms of the support in terms of what's
there or not that said shouldn't be too
hard to find out run to build see what
happens obviously for some of this stuff
maybe not obviously but for some of
these features especially the
integration here you will need the
latest version of TFS on-prem if that's
what you're using so put 2015 update 3
on generally we TFS keep it up-to-date
anyway it's not a problem unless of
course you've got the you know ops
department that says it's a production
system and the only time you can update
it is once a decade when we have an
outage window sorry about that other
questions
yep yes they do yep
so the question was for the recording is
the build agents update themselves so a
build agent that was six months old for
example will it automatically update
itself to the dotnet core build agent no
it will update itself to the latest
version of the.net agent or the node
agent the.net agent the v2 agent isn't
quite at feature parity with the or it
wasn't two weeks ago anyway with the the
old net agent there was just some gaps
that said the UI updated itself on the
weekend so I'd say that new agents
probably at feature parity now so I'd
have to check and I have to find out
what happens with the old agents now
that the new v2 is the main agent so I'm
not quite sure you have to check yeah so
really easy to change an agent so I was
on remote desktop before this is the
build server here if I just kill that
for example to remove one simply do
config we comfy oh gosh don't be that
command remove that removes the old one
and i would put in my auth type make
sure I've got permissions to remove it
obviously and then just it d registers
itself then I can just drop a new agent
on to the same box the agents themselves
are simply small executables or small
zip files you unzip them into a folder
you run the config command you're done
so it's a really simple process it's not
this whole uninstall reinstall dance
it's just config remove drop it in a new
folder whatever you want to do so I've
got this one in agent to also have
another one in
c / agent which is that one there that's
the old one where you had to run
configure a junt and run so there's
slightly different so other questions
other than that thank you very much guys
go enjoy lunch enjoy the rest of the
conference I'll talk to you later</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>