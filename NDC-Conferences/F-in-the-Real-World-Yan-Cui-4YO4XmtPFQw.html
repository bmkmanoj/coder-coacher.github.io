<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>F# in the Real World - Yan Cui | Coder Coacher - Coaching Coders</title><meta content="F# in the Real World - Yan Cui - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>F# in the Real World - Yan Cui</b></h2><h5 class="post__date">2016-09-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/4YO4XmtPFQw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so let's kiss 30 guys and good evening
everyone and thanks to her Chronicle
from Comstock on f-sharp so my name is
Yin tray and I've been working with F
sharp in production and s care for quite
a few years now so you kind of saturn's
saddens me to see still a lot I guess
misconceptions about F sharp and
functional programming in general we
often people tell me that oh you know if
F shine and functional programming is
great in specific settings such as when
you're doing loads of maps or finance
whereas for my personal experience I
know that is not the case the function
programming is great that you're very
useful and can be and should be used to
solve many different problems that we
see in London business applications so
for my personal experience I've been
working in gaming for the quantum of
years until recently and I've used a rep
shot very heavily to do a number
different things including modern
domains - right infrastructure code game
logic I with them in cetera et cetera so
until this year I was working for a
company called Games's in London where
towards the end of my time there I was
building backends for social games and
we have something around a million daily
active users with the number of people
that's installed that's close to it so I
don't know in the tens of millions and
from the million daily active users we
get week we receive somewhere around
three and 15 million requests per day
and pretty much all the requests are
well everything you doing the games are
recorded so that we can tell we can
understand what people are doing the
games so that we can optimize them and
improve them and for that will you call
somewhere around two to three terabytes
of data just for analytics every month
it doesn't take into account order data
that we generate and maintain in order
to facilitate your actual gameplay and
what interests things about gaming is
that pretty much whatever thing you do
in the games is it's a right so
everything I do the games it's going to
update my game State in some way so we
usually see one two one three two right
ratio which is quite different from the
use of read heavy traffic they see for
web-based applications and a peak we see
some way around 25,000 database of a
second as for the team we had
a polyglot team both in terms of the
languages being spoken as well the
technology stack being used
you can probably notice or you can
probably identify a few of the databases
that we were using and we were very
happy users for both Amazon Web Services
as well as Google App Engine and on a
backhand we use a C sharp and F sharp
very heavily and also do quite a bit of
work with the Erlang as well as for why
F sharp whilst most of the adoption is
happening is or finance space F shower
and storm is a very versatile language
is good for great many things and one of
the things we found is that we can be a
lot more productive in since our switch
to f-sharp and that's very important to
us because with a very small team of six
back-end developers we look after
everything that happens on a servers
from writing the service that game logic
to building our infrastructure so that
we can scale to to meet the demands we
have and we also have to do Olaf's
ourselves we didn't have a dedicated ops
team and once we want to move fast we
don't want to sacrifice on a quality end
of the world that we produce and we also
found that F sharp is very good to end
him use restore for to help us to write
efficient concurrent and parallel code
and I can often find the simple
solutions to otherwise complex problems
and as a company we were doing a lot
suffer both real money as well social
casino and soft games and I personally
be queen of all games in the the backend
for normal games in the F sharp and one
of the more better more interest games
we had was this game called the monopoly
house play house party if in place or
scheme before there are mostly happened
and unfeignedly starts at all until I
started working for games this ended up
building all these backends for social
air for social source games the
mechanics are very simple you define you
say how many coins you wanna bet on each
of these 25 lines in the game and then
when you press spin it makes the server
call and order what a symbol is going to
spin around and then when they settle
down if you've got the number of
matching symbols that are here on the
same payline then you
in what is called lime green and in this
particular game and are most other games
you also have a wild simple while
casting both I can substitute for other
symbols as well and for this particular
game you also have a bonus symbol where
if you have three or more bonus symbols
anywhere on the screen so you don't have
the phone the same pay line then you
also get what is called a scatter win
behind the scenes where we came the
accession math model which governs the
likelihood of your winning and how much
you can have been based on different
combinations so we know for a fact that
over the long term players is going to
win 95 of 95 percent of their weight
back which means the house always keeps
5 percent all the time so remember the
house always wins
so the models this game are the games
like this we have the first model what
are the different symbols that we can
have which is either a standard symbol
or a well symbol so this is what is
called Union typing F sharp is kind of
similar to Anam in there you can have
different cases but unlike enum each of
these cases are is a full-on type so you
can't just create any valid the value by
casting 42 to your enum type and each of
the cases can be associated with an
arbitrary set of types in this case a
standard symbol have to be instantiated
with a name for your symbol and a while
symbol just waste a is on a team we can
use it you a union types and model
different wins you can have as well for
instance a language just so you need to
know the pay line number the symbol day
one with and how many of symbols that we
actually have and for scatter win
because we don't have to consider the
pay line so you just need to know the
symbol and count when I'm what are my
domain I don't like to see things like
integers and strings all over the place
because they are very generic and
doesn't really tell me what those values
represent so what I typically do is use
tight radiuses to then help service my
domain through my types and what a nice
thing is about Union type is that it
unlike class hierarchy which is always
open for extension by sub-classing so
wasn't working
no scope I can't tell what are the
future subclasses that's going to be
created but with the Union type I create
a closed hierarchy of only the states I
get my demo system can can have and when
you're working in F sharp you don't have
to know to deal with it which is the
number one invalid state that everybody
spends time dealing with all the time
which is wise the Tony Hoare actually
caused them he's a billion dollar
mistake and you for working so and you
can hang around with the functional
programmers you often hear this
particular phrase being repeated all the
time that we want to make illegal states
and representable in our model so then
we don't have to spend more time dealing
with them later on on that topic you can
also have this feature in F sharp which
is very useful
we call it unit of measure whereby you
can have a type that represents some
unit you can decorate it with the
measure attribute and from then on you
can then use that to add context
information to numeric values the way
you can use them in like generics so 42
is no longer just a normal 42 but you
can attach it with some units and
out-of-the-box F sharp handles the
combination of units correctly so if you
have ten meters divided by two seconds
the value you're going to get back is
not just five but it's five measuring
with the unit of meter per second
similarly ten meter times by ten meter
is going to give you 100 meter square
but if you try to combine incompatible
units together then you get a compile
time error it's for you so - because it
gives you much stronger static safety
with regards to the use of numeric
values and can use that to help model
your domain to help you valid to help
prevent invalid stations creeping into
your part of your calculation for
example that were that works out how
much should we pay out to the to the
player in terms of wage amount which in
this case has to be a long that's
measured in pence and again you can see
and see them using fiber aliases to help
surface my domain through my type Sigma
and to capture the host day for the game
I can use what is called a record type
which is a very lightweight data
container type where the fields are
immutable by default and this was one a
more complicated there were more complex
games that the company has ever done it
was delivered on time perform really
well and that we had zero bugs reported
over two years since the world of the
game being in production so to recap
with the union types in records you can
have you can have a very library syntax
for describing for creating types as
well as hierarchies they are great for
modeling your domain because they allows
you to clearly and concisely express
your domains through types and because
you don't have dude knows
and because the screaming unions union
types can help you create a closed
hierarchy of only the very states the
system can handle it helps you eliminate
illegal state from your domain
altogether and with Union measure it
helps enforce correctness with regards
to use of numeric values and from our
experience compared to existing Java
solution we had for the real money
gambling games we had switching to
f-sharp as implementation language gave
us easy and all the magnitude increase
in productivity so where we had a
previously a team with Java developers
maintaining a bunch of while working on
the the the O's game engine and we take
them sometimes weeks to produce a new
game for f-sharp engine taking - some of
the learning that we had as well as the
language beam to give you more concise
way of expressing the problem sometimes
I can push our new game in a matter of
hours or a day or two and that was our
first foray into adopting f-sharp and it
was a big win and from then on helped us
to sort to use F shiny more places apart
from social slots games we also make a
number of different other games in
number of games in other genres
including a softcore MMORPG game called
the hippie monsters an interesting thing
about this game is that we had tons of
content just in terms of a dialog within
you
as and non playable characters we have
more text than the first three Harry
Harry Potter book combined and where you
view this virtual world where people can
go and around travel and collect things
you find that people do that awful lot
and their stage gets really big in fact
we find that that it's quite common for
our player state to go into several
megabytes after just a few weeks of game
play and when you play states that there
are so big the stateless approach it
doesn't work anymore because of shifting
all your or your load on to the database
and this approach became is very slow
and inefficient given the size the
number of writes that we are doing
remember we are typically 1 to 1 to 1 we
through our ratios and even though we
were using pre scalable key value stores
already which if we always benchmarks
they can do know tens of thousands of
operations a second on commodity
hardware but turns out those are those
always benchmarks are done with very
small payload and when you have
real-world payloads that are in several
megabytes the numpty actual number you
can access through / you can see a much
much smaller and once and once you take
into account the need for redundancy
then the whole sub setup became quite
expensive because it is one at least the
server list a couple of quite big
sizable nodes and through profiling we
also find that the game servers
themselves we're spending upwards of 90
percent of CPU on serialization
deserialization so we if we had
continued down the same path would just
be throwing money down our ad based
account which of course they'll be very
happy but it's not going to be great for
our long-term economic health
so when we've games like this one of the
things you find is that the player
activity is also quite bursty
play will come in they do a bunch of
things and then that we would know they
would catch a few monsters you'll plant
a few tree trees crops and whatnot and
then they'll go away they may not even
come back to the next day so you can
actually take that the kingdom entity of
that and the move to a stateful approach
whereby you can cut out most of your
database course as well as all the
Associated civilization costs on the
game servers and for us we were even
able to fall back to using s3 because we
only needs very simple key lookups and
s3 is very cheap to operate and scrape
for storing large objects it also has
the port of versioning and swaps
lifetime management lifecycle management
so that you can automatically archive
the old versions of player state onto
Glacia which is an even cheaper
long-term storage solution that Amazon
provides and because the way we have set
up our our stack where the substrate
management is in the media submitted
here so that we could replace the
stateless one with the staple
implementation without changing any of
the game's logic internally the stay
committed here is implemented using F
chart support for actor model and actor
model with something that's coined by
cow Hewitt back in 1973 it was later
made popular by Erlang and it's a model
for describing computation we're about
everything is an actor and an actor is
the fundamental unit of computation that
that consists of the three things
processing storage and communication and
this model everything is an actor an
actor has the mailbox they share nothing
they don't show any memory and the only
way for actors communicate is via
synchronous message passing and inside
the body of an actor is inherently
stress safe because
messages are processed one after another
in a single-threaded fashion so you
don't need to use a very heavy kernel
level constructs such as logs and mutex
and whatnot and when the actor received
a message from his mailbox you can
create new actors you can send message
to other actors it knows about or you
can do some work or all of the above
and in our particular setup we have two
type of actors a worker whose job is to
manage the different pieces of state for
a particular user using automatic
locking and if this users been idle for
a while it would also then persist the
player state in the background there's
also a gatekeeper whose job is to keep a
list of the active workers on the
machine and in spawning new ones when
the new player comes on board so in this
moment in time we have workers for
player B and C the sly one is
machine play a makes a request and
through the request hand encode it got a
request was sent to the gatekeeper who
then sees okay I don't have a worker for
this new play this player so our spawn a
new one and as far as initially is
initialization the new worker with NFS
the player state and then the respond to
the request calling code directly
bypassing the gatekeeper because in this
particular setup the gatekeeper is a
potential bottleneck so they want to
reduce the number of messages they have
to flow through the gatekeeper in the
meantime work a pieces that his players
been idle for a while so then he will
persist the player state as a
synchronous e in the background and
provided that that was successful and
that the player hasn't made a new
request in the meantime it would then
tell the gatekeeper that hey my job is
done and then it will shut itself down
and and the next time the beta player B
comes back then the gatekeeper will say
hey your guy is gone and you respond
with a specific error code so that the
client knows that it's time to go back
to the load balancer to find another
server to talk to you for the duration
of this new session and we do this so
that the law is distributed across the
cluster and we stop players from hogging
a particular server so that we can still
scale down our our cluster machines
elastically I mentioned earlier but I
shall support forward active model
intercedes through these mailbox posted
so type which for some reason everybody
in the community always aliases to agent
I don't know I don't need forward one
reference dice for but I wanted to do it
and notice their agents are typed so you
have to specify what messages that an
actor can receive and for the workers
messages I can we can send two messages
with there are two type of messages
either get for the current state of the
probe argument player or put to update
the current state with with with a
version choose control in both cases we
need to pass in an asynchronous reply
channel which is a mechanism for us then
send respect loop response back to the
call
and they can wait for asynchronously but
what you need to decide what types going
through those reply channels well we
need to tell you whether or not the
operation was successful or if you
failed and if it fell then what
exception was thrown so we can capture
that with a very simple Union type that
captured both the success and failure
case so forget the response will contain
the players current state and version
number and therefore put which written
unit which is the functional programming
a functional language way of saying void
so that completes our definition for the
message type and as for the workers they
need to know the unique ID for the
player who stay there managing and every
worker can be in either one of two
states which is started working or
closed and when you start so up
initially it's going to get the player
state and then it's going to go into the
working state with that as version one
and we're either in the working state we
have this async block within inside
lacing block we can then use the we can
do we can perform a signature operations
and bind the result with the leg bank
keyword in this case this is how you can
do non-blocking i/o in the in F sharp
and C sharp a single a keyword was
heavily influenced by the design of F
sharps acing workflow the one big
difference is that in C sharp the
language feature is a single weight
which means that the mechanism in which
is implemented can you can't extend it
yourself or you can't borrow it to
implement something else
whereas in F sharp the actual language
feature is called computation
expressions which for which is something
that you can you can sort leverage
yourself to create other type of
workflows acing workflow is in one
instance of a use one implementation
using computation expressions and thus
disguise in the fer space code Nestle's
their Shapira framework whereby instead
of having an async blog you have a cloud
block and everywhere you can say let
bang some variable you call some
synchronous operation that that
operation instead of being killed to a
stripper
is cue to the cloud via and you can any
currently were supported profess your
and this alpha support for each basis
well and which means that whenever you
say you're doing some heavy computation
work you can offer all the computation
to the clouds to some cluster machines
that you have running but programming as
if everything is running locally and
that's that's one advantage of having
the computation expression being the
language feature that you can leverage
yourself and extend and there's also
other other computation expressions that
you can implement for example if you're
coming from Haskell and you want to
reenact some maybe monads and stay
monads
you can do the same thing with
computation expressions as well in this
particular case we want to wait for
message to arrive in the mailbox for up
to 60 seconds this particular method
returns an option type which is either
some value some message that we receive
or none if no message received after 60
seconds and that's our cue to then go
and persist the player state
asynchronous II because remember do bank
that's when you do in a synchronous
operation and after that we go into the
closed state if we did receive a message
then we can apply pattern matching
remember the message can be added again
with a reply channel so we can use we
can look at that and then we can apply
the pattern so that the reply channel is
captured in a replied very broker
variable that we can then use to send a
response back to the caller before
recursing with the current state and
version the message can also be the put
require a put message in which case we
can use panel matching to get the new
state the version number and reply
journal back and additionally we can say
that this particular pattern will only
match if the version does pass into the
message message the match is the current
version that we know about this is how
we can do can optimally locking so that
if two concurrent request is received
for the same user the first and the both
will get for the current user state the
first put wins and with that we can
recurse with the new state as you passed
in i will we increment the current
version so that the
put will fall into the next case which
is okay sorry you tried but you are too
late so we respond with a version
mismatch exception instead so with
pattern matching that's also very
powerful way for you to handle all your
branching logics very concisely and
clearly and once we're in the closed
state we just blank and replied with the
further the workers stopped exception
because we no longer the that the work
is done this job is now in a closed date
so with this stay for approach we found
out that we we got at least five times
more efficient efficiency improvement
meaning that the same server can handle
five at least five times as the number
of concurrent requests versus the
previous stateless approach and we also
managed cut the average latency down by
over 60% which was even the job was even
higher by the time located 95 99
percentile latency numbers and
importantly we were able to color all
the database knows that we have to run
previously and just used s3 which is
much cheaper and combined with the
efficiency saving on the game servers we
managed to cut the the operational cost
down by over 90% and actually made the
game economically feasible to run s
scale and this was the another
interesting use of f-sharp and the
importance of part of our journey but
it's worth mentioning that this work was
done in late 2011 early 2012 where a lot
of tools that's available now wasn't
available to expect then so even as do
this again our properties use something
along the lines of a code or net or
Microsoft or liens which says god is
this concept of virtual actors which is
very powerful a very very interesting or
if you have more ventures feeling more
adventurous and they're happy to step
out of the door net world know Erlang
and Dixie are also both very good
choices as well and staying with this
game we also have a very interesting
achievement and quest system whereby you
can pretty much hook into anything that
users can do in the game so for example
if a player called unknown then it's
going to get some XP
some items some gold and he's going to
be some progress on a quest and by
getting more XP he might level up and by
making progress on a quest he might
complete the last thing they need to do
on a quest and therefore complete that
quest and completing our question give
you more XP more ice more goal it's
going to unlock any any follow-up
question levering are means more items
more gold and more quests and so on and
the whole thing also then feeds into the
achievement system which again if you
complete achievement you can move I to
them more XP how could you get a drift
so this system was so great for game
designers because they can hack the peg
and hook into all these little things
then and it can make a make a quest that
requires users to go to learn the bar go
from mr. McDonald's then use that goes
then catcher to catch some monster
somewhere and take the loot job then
take it back to to to Uncle Bob in the
New York so there's all kind of easy
things you can do first developers misc
well it was quite a big challenge for
starters we have more than hundred
different actions you can do in the game
most of which is going to give you some
reward the end of it and all of that
have to be pro that process or that we
see a cyclical relationship hardly
process in the same request handling so
that the first week that actually action
you perform which is catching a gnome
everything else that comes off the heavy
process within the same request and then
at the end of it returned the doubter in
the player state in the request to the
clients interest or in the response to
the client so that we don't have to
return couple megabytes of users they
every single time so that made my life
quite difficult partially because we
have quite a number of different
abstraction layers for different parts
of the games for traveling for leveling
up for the fishing caching monsters and
so on and so forth and then there's also
non-functional requirements for tracking
analytics and if the users are come from
a partner such as Nana guns then we also
want to inform them when the players is
reached a milestone such as completing
the tutorial which in level 10 code
their first monster and so on so that
they can then optimize their wisdom the
youth algorithm on
sorry to improve the quality of the
player that bring into our games so that
made my life even more difficult so and
and we end up with this odious spaghetti
code which is just crazy it was really
hard to reason about because everything
can't depend on everything else and the
solution we ended up with we was heavily
influenced but I was inspired by the
message broker pattern which is an
architectural pattern that we simply
applied at the lower level so whenever
stuff interesting happens in the game we
record it as the fact and that fact goes
into a cue that's specific to that
request that we handling and everything
is then presented to a number of
different processes that looks after
different aspects of the game which may
just ignore them or may stir something
interesting with it and as part of
processing it may cause other state
changes which are then recorded as fact
and they all have to be processed by
order or everything else and so on
okay so animations we for this system we
should look at a number different
options including a complex event
processing system but the purpose and
the scope of the events that we are
dealing with here are quite different in
that they'll well they are limited to
one request for starters and what we
need it really is a mechanism for linear
rising what is otherwise a spaghetti
program flow which is why we end up with
the tailor solution that in hindsight
was actually quite easy to implement and
maintain the one downside is that we
needed lots of different facts represent
everything they can happen a system for
order actions that can be performed as
well as all the resulting state changes
that can happen from those actions and
if I was implement this with a class
hierarchy then I could easily end up
having to write hundreds of classes
which of course is no fun whatsoever and
not to mention all the time consuming as
well so I need of writing them
representing them as Union type of
course when you have a union type desk
or a hundred different cases that's no
more manageable than the massive
hierarchy so what you typically do in
this case is you break it up into a
smaller more specialized Union types and
they nested them with top-level Union
type so and this this would be the idea
Matic way of doing things in F sharp and
the one on a processing side just do
pattern matching and then you can also
break up your processing code into
smaller and more specialized the chunks
as well but because we have lots of our
code within C sharp as well and we do a
lot of interrupts between C sharp and F
sharp and when you when you're in C char
trying to create a nested the Union type
is doesn't read really well at all and
in fact the motor has your unions have
takes a few parameters this becomes more
more unreadable very quickly so we ended
up making a set a compromise and decided
to go with the marker interface instead
so the order specialized the Union types
would implement the interface effect
which is just a marker interface that
just helps us to identify and Union so
unify our processing code so instead of
doing what we did before we just replace
it with a type test which is what this
operator does in the F sharp but because
we're not using a top-level Union type
so we don't have that close hierarchy
anymore which is why we now also need a
casual in case the summer as a new type
of fact which we we don't know about at
this point
so even with the compromise we still
find the solution to be pretty simple
and put it to reason by understand and
they were very easy to add and remove to
add the modify existing facts we just
follow the compiler errors until you fix
all the problems or to add introduce a
new type of effect and it probably saved
me easily days or weeks in terms of the
effort to create the class hierarchy as
well as maintain them going forward and
as the name of the game suggests monster
trapping is a big part of it and inside
the game to catch a monster you have to
be in the right place and you have to
use the right combination of bait and
trap kind of similar to what you do
mantra Pokemon go now adays in the game
you have a waste calling Almanac which
is
in game wikipedia where you can look up
all the items as well as monsters so for
Bigfoot we know they exist in the North
America and you need to use a particular
bait with some chance of attracting
Bigfoot to your trap and your ability
you have to use a particular trap with a
know some catch rate which then and
recent which then raise another
challenge of how do you automate the
process working out of tuning the trap
and a monster so that you get the cash
ready after both both monsters and traps
have a set of stats points that we use
to calculate cash rate between them and
then the formula also take into account
other factors such as some traps are
strong against ear monsters but weak
against the water monsters and then you
also have a seasonal monsters they're
only they can only be called you saying
since the matching seasonal traps and
you should be that our game designers
would do this by hand while refer to our
world via trial and error which of
course is laborious and also error-prone
and barring some miracle you're never
going to find the optimal solution and
when your system that requires people to
do so much work by hand by a while trial
error what you're doing is you're
hanging those people out to dry because
as Brian hunter pointed out written as
well so very nicely that if you've got a
system that require constant diligence
you're just setting everyone up for
failure and hurt because people are
going to make mistakes that's just what
we do and they also does just know
that's just not how they should be
spending their time so instead we build
a bunch of genetic algorithms and expose
them as as a web to so that the game
designer can then go today go they're
set up ok for this monster I want to
have this potential for this trap and I
want to have 85% chance of catching the
mermaid and then 75 percent chance of
catching something else and then you
specify some set bow arrow margin and
then just press a button and then wait
for the answer to come back and behind
the scenes
we implemented there are genetic
algorithms which sub in some general
general terms means when you start with
a generation of possible solutions who
then each of them then goes through a
selection process by passing them
through a fitness test those that
survive the fitness test are then put
through a mutation process to generate a
new generation of potential solutions
for the problem and you repeat this
until you either found a solution or
you've exhausted the maximum number of
solutions as of generations without
finding any suitable solutions in our
particular case we take for particular
amount for a particular trap we start
with some guesswork well estimate for
the stats and then we will take each of
the stats points with a small amount so
that when we are close to the optimal
solution hopefully we get them in a
slightly better and we also mutate each
other's numbers by a large amount so
that when we're far away from the
optimal solution hopefully we get
something else that's different enough
so that the difference doesn't get
swallowed up by rounding and we keep
doing this until we are they exhausted
the maximum number of generations we are
allowed to run or in which case we
return the best solutions we found
provided that they meet the acceptance
deceitful error margin or if none of
those the Nano solutions in the new
generations survived the fitness test in
which case we just say sorry we can't
find the answers based on your criteria
and the fitness test is as simple as the
solution is better than the one day was
a mutated form and I mentioned earlier
that we use the Amazon Web Services very
heavily which also gave us some insights
into some of the complexities that can
come up as you integrate with many of
the api's and we found the F sharp was a
very effective weapon in creating DSL to
help us tame those complexities for
example Amazon has got a car wash
service which is the which is the
monitoring service where you can publish
and collect metrics you can set alarms
and by default you get a bunch
of metrics for your ec2 instances such
as CPU and network in and out and you
can also publish your custom application
level metrics as well and there's the
measurement console we can go to and you
can select bunch of metrics child
monograph and so on and so forth it's an
important service in the iOS ecosystem
but there's number of shortcomings
including the lack of ability to define
correlations automatically so if we're
gonna find if to latency spikes is
correlated to each other and final
course then that's countdown to user
then goes through all the metrics and
then identify those correlations
yourself so if someone come to you and
ask why was the payment service slow
last night which could be because
database was service was slow because
some other service that we depend on was
slow maybe a strike was having a problem
with the API for example you don't have
to go around and find look at all this
goes to all the relevant latency metrics
itself to try and define their
correlation and when you turn routine
post-mortem investigations into exercise
of finding a needle in a haystack
it becomes what I call a paint chip and
development and which is why I dissented
doing this so many time so I decided to
spend a weekend and roll a couple of DSL
to help to help automate all this work
that we tend to do by hand cry often so
that for to say if you want to find out
the the 5-minute average metric of some
metric for whose farming average was
more than a second any time over the
last 12 hours
you can then express that as an internal
DSL which is very human readable or
equally can express that as external DSL
which does exactly the same thing and if
you would find that if any of your
various clusters had the CPU spike you
can also use use regex to to match
against the metrics by their namespace
as was by name and total we had I had I
think 15 different operators based on
what I can reasonably do with the API
and the internal period
DSL was implementing about 25 lines of
code with some supporting functions who
do two sq against the cloud watch and
then I wrote a parser for the external
DSL using a feature in F sharp called
active patterns and which was a bit more
involved
still wasn't a lot of code and the nice
thing is because I was able to use the
type system to guide me along the way so
the first time my code as you can power
and ran it digs le what I've what I
wanted to do which was great and now
that I'm working a lot with no GS is
frankly it's the feeling that I've been
missing cry quite a lot and it was in
this particular case it's also a great
because I started the work at 2:00 a.m.
because at the pride yet at the wrong
time in the day and managed to finish
everything and God could have had after
4:00 a.m. and when I showed it to my
workmates afterwards they say well you
type in oh you did have really fast but
really using the right tool for the job
this case has really helped a lot and F
sharp is in general it's just amazing
and the function program in general is
amazing for writing DSL Swift and DSL
and parsers with and for this particular
piece of work the internal DSL can be
used in anywhere where you can run the
left shell code it could be in the repo
could be an executable and the external
DSL is useful for building tools so that
I can I can patch them up as a CLI and
just give it to my co-workers who can
then just write some queries and then
run it and then plot some charts some
water
and the so to recap we saw how with
Amazon CloudWatch how is the impedance
mismatch renders routine postmodern
investigation in tea and exercise of
finding a needle in the haystack and how
you can use F sharp to write to create
simple DSL to make at least make the
needle a little bit bigger and easier to
find another very popular service the
Amazon has is called the dynamo DB which
is to manage the key value store that
has got butan redundancy of nine 9's
guarantees and everything runs on SSD so
you get great and predictable
performance chemically in the
single-digit the mini second range for
both gets and puts and unlike most of
other services the Amazon provides with
DynamoDB you name your super requirement
upfront and that Amazon will preserve
enough capacity to service your the
troop requirement that you've specified
so you can easy scale to have a table
that can they can scale to support
millions of reason right a second with
just a few button clicks and you can
change your super requirement on the
flight without any downtime so it's
great because you just don't have the
worry about scaling your database
anymore and and because of the way is
charge spaced on how or what based on
the throughput requirements you have for
fourth generation you need them so to
some interesting patterns that came out
I heard there for those this advertising
company that for pretty much most of the
year there's a very little traffic but
then for the four hours of Super Bowl
it's in spite of something crazy like
having two million a two million reads a
second and instead of having to maintain
a super super scalable infrastructure
and I wanted to use it for their four
hours and then just just had that go to
waste for the 99% of the time you can
just scale your up your ass here up your
DynamoDB look throughput for their four
hours and get whole thing over and done
with we filled thousand bugs
and so dharma DB is great it's amazing
to work with us and so for the last
couple of years have been working with
them this really had really one big
outage but one big downside is that when
even though there's the built-in support
for queries and the full table scans to
do them it took from with cold it's kind
of clunky
you create this a request this query
request where you set a few parameters
for the table names this cetera et
cetera and then to express York your
query you have to create condition
objects and then set attribute value of
just and then set the comparison
operators and so on and so forth so even
though you're not really writing writing
a lot of code but by the time you read
all of that you kind of forgot what was
the question that I'll try and ask in
the first place and with anything
wouldn't it be nice if I can write
something more like sequel which is much
more expressive of what I'm trying to do
well with the data and so with that in
mind I sit down for another weekend and
create an in the DSL to give me just
that with the aim of disguising some of
the complexities that comes with the
query and scan api's with dynamic DB as
well which contains a lot of different
tricks and options that you can set and
keep most mark and keep my developers
some query syntax that's very familiar
that's very similar to a sequel so that
something that they are familiar with
already and the way it works you say you
take the query and then you pass it into
an abstract syntax tree which you can
then use to actually make the transform
to the request object that we saw
earlier but without you have to write
them by hand and to do this implement
this DSL I use the F parsec which is F
sharp or of the passer library from
Haskell the course itself the a passer
Combinator library which is something we
until you understand what he actually
means but all is all it is is that you
have start with very simple passes for
simple things such as quote is stringing
quotes or single quote double quote or
flows or integers and then you have
functions that can compose them together
to give you more complicated or more
powerful passes and those functions are
called the Combinator's so you do this
iteratively to then build up a pastor
deck and they can pass the key words to
the table names to the attribute list
accessories etc
and then you can then build up a more a
fully-fledged DSL for managing and more
complicated than Cree syntax and so with
that I was able to turn what I would
have to write otherwise into something
that's much more expressive and easier
to to understand
the Cree syntax took less than 50 lines
of code to write and which again just
shows the amount of the how much
productivity gain you can get using the
right set of tools for the job and
everything on time with you okay and
finally we use the s3 an awful lot and
one of the features of f-sharp very
powerful feature f-sharp it is this
thing called time provider which gives
you type assets to external data source
and you disorder type generation for you
both factors are at the same time so as
you type working and coding in the in
your repo in the IDE as well as as well
as the compile time and at runtime and
to show that because we use actually a
lot notice that at the top I've got a
type that represents my my s3 account
and then another type that represents a
bucket in my account and every time I
press thought what's happening here in
the in the IDE or when I run my code in
them in the official report is that
oddness this way for the dot okay what
happened there is it's actually making a
call to s3 and based on the data the
response that comes back is generating
types on the fly so that I gain tella
sense for the for my SQL for my account
in s3 and all the buckets and object
that I have it there as well which is
very useful it means that instead of
having to leave my leave my IDE to use
as a model to to download the files are
linked from s3 and then go back to mr.
studio or somewhere to then write some
code to parse it read it I can just do
everything do everything from within the
comfort of my ripple and where you have
a packet that's called a lot millions of
billions objects you can also use a
search as well here I'm creating a type
to represent the search in s3 by prefix
and again when I press stop that's the
idea that's when ID is going to make a
call to
three and based on the resolve their
search creating types on the fly for me
so it's great because now I get
intelligence over some external data
source I've got and it helps me remove
all these magic strings from my code as
well and I don't have to wait until you
run time to find out that some s treat
some objects industry that my code
depends on is missing so the first time
I find out is when when I'm writing
writing a code because the only factors
because only get was those objects back
if the object is necessary in the first
place and then every time I compare my
code the same checks happens and also be
I don't have to even though there's all
kinds of code generation is happening I
don't have to manage them myself so the
store typical problem you'll run into
with t4 and other Cochin of enthuses
well what happens if if some if eg if
you want to make many modifications and
you have the amendments you press the on
every time someone regenerates that code
all your manual changes are gone you
don't worry about all of that yourself
and because the types are generated are
you raised to the object type at runtime
so you can easily scale to having
millions of types without blowing up the
CLR and this is something that I build
myself because I use s3 a lot so but
there's also other more useful pie
providers out there for say reading SML
and JSON file so that instead of having
to create your type that looking at
inspecting the JSON file create a type
of the matches the structure you're
looking for and then write some code to
read and and pass it you just let tie
provider to that for you point it to an
example data say XML or JSON file so
that it so they transit hypervisor on
what so shapes that those data are going
to be and then you can use the type that
you've created to read from other
sources so an example would be if you
point it to some some JSON file you've
downloaded say locally and then once
you've created that that type provide
that the type that can parse the data
you can then point to the real data so
you're looking for there are sort of
high providers for reading from sequel
as well as high providers from
a tube to let you use and I kid you not
functions are written in our or or
Python so that the if a 3-node of data
science is great because instead of
reinventing all those lot of those
functions that you get from are you just
use whatever out there so that all this
g pro and other things that are gives
you which is great but i simply is a
terrible programming language for take
everything else so you can do everything
else in F sharp but then still leverage
the things that our community has to
really develop with with the help of at
the tower PI provider so that's a super
tool of some of the things I've done
with a sharp in the introduction the
last couple of years and I hope know by
now you've heard if it's seen a glimpse
of what you can do with F sharp the
beyond the pet the basics and again like
I mentioned earlier the dry for us was
really really around productivity and
people to write more correct code and in
the case of for a concurrent and
parallel code also very efficient code
using async workflow and help us solve
some some some more complicated problems
so things like dear selves are usually
quite consider a hard problem in in many
languages but for function program for
finally in functional and F sharp so
function languages and F sharp they're
really quite they're really really easy
today so is that the thank you very much
for listening so sorry I was speaking
really fast I'm really a leg right now
have you got any have you got any
questions yep so you see them using a
sharp increase your team efficiency yep
I don't think it really explained why I
would really like in a why sure so one
of things with the F shell type system
for example is it's more expressive so
one of things I touched on earlier is
that the ability to define to to express
a closed hierarchy and that's all it
does does one a dialogue with the
compiler that I don't have with the
class hierarchies and because the syntax
you've seen how I can use two lines of
code to really Express what is the two
separate classes in two separate files
again this I can condense that to just
two lines of code in the Union type and
in general in F sharp we just don't have
as much ceremony as some of the
synthetic noise that you used to
generate systematically say with
procedure there's a guy called Simon
cousins whose company did the deal
implemented here so he works for the
energy sector where his company
implemented a bunch of energy contracts
and the c-sharp project I think had a
most a developers in the Spencer has
three years without implementing the
older contracts and took so long the
assignment is one they just decided I
wonder how long you take me to do this
in F sharp and he managed to do I think
they managed to implemented all the
contracts in under a year with at most
three developers and only Simon had ever
done any air shine in the past so that's
a good so empirical evidence of some of
the productivity gains that I've been I
was talking about as to why I think the
port reaffirm when you program in C
sharp or Java you're not just
programming in oo but by by and large
you're also programming in imperative so
by definition imperative is you tend to
computer what to do so imagine you how
to do that for sequel you have a child
sequel server how to query data every
single every single time it's gonna take
you forever to do whatever you want to
do rather than using a more expressive
language to say this is what I want you
work out how to better do it so by going
into the functional world you're moving
stuff up - so abstraction level which
means you start thinking more about what
it is you're trying to do rather than
how to do it I think in terms of the
protocol games that's probably where
that comes in more often than more than
anything else there's also the sort of
less typing because of the commotion
size syntax but it's more the sort of
the approach that gives our findings
that is that is what gives me more
productivity question
hi you said right at the start that you
had a team of Java developers before you
went to F sharp yep
so I was wondering why you didn't go to
a functional jvm language especially
since using Amazon as well rather than
switching to the dotnet framework so
interesting so here is that because
scheme sees as a whole is quite a big
company so might so my team works on the
social game so games are not real money
gambling but because we had a company
that's that's been building real money
gambling as a social many slots games
for a long time so even though my team
was running a completely different stack
that's mostly based on ton net and
running in Amazon we were able to we
were to get us get our product out there
we decided to just leverage the
intellectual properties that the the
parent company has invested in and built
over the years which is this Java based
game engine what we engine for the slots
but then what we found is that while
whenever we need a new a new game or
some changes from those guys it take
them very long time to turn things over
and a new game sometimes like I said
takes weeks to implement which is why on
the sort of social space we need to we
need to do research very frequently
because while players have a very short
attention span we need to give them new
content on a regular basis and in fact
we are doing new release a new slot game
for every sub venture we have every two
weeks but it means that we really need
to get the server side of things done
quicker so the client guys can then have
something to do the development against
and we ended up having ended up
rewriting while writing at something
from scratch as a demo for using F sharp
because I've been prepping using F sharp
my spare time for a while and this seems
like a good fit for the problem so I did
that over the course of I think a week
or two from having nothing to having
something that's demo Bo and can be
presented to to the rest of the team as
well as other people and from then on we
now think by the time I left the company
we have seven 150 games implemented in
the in F sharp
and everything was done by I can you
know someone I hire from out of
University who knew nothing about F
sharp the new Haskell so he was able to
do a new game in his first week at work
which was a lot more than I mentioned to
my next year which is B which is that
Jesse where I had a spare whole week
just going induction so what the thing I
found is that this is when you
transition to the F sharp the difficulty
is more in transitioning to thinking and
if you know you have a loads of
experience if C sharp with Java that
doesn't necessarily help you because
more than anything you have to unlearn
what you've learned before you can know
change your mindset to a different way
of thinking where so someone who's got
experience with function programming
learning a different syntax that is the
easy part
learning how to solve problems in a
different way that's often the hard part
and it took maybe two years for for for
us to get to the point where everyone a
team is comfortable you know reading and
working the F sharp code to various the
decrease of competency but at least
everyone is you know is comfortable
working the code base we fir one
specialized guide one one special is
that basically work all do all the
backends for all the slots so one one
junior graduate is basically doing work
of a whole whole team which have a
developers that's pretty awesome you've
touched a little bit on what question I
was going to ask which was what advice
would you have for somebody who's
wanting to get started an f-sharp or
learn about it but it's coming from a
very heavy c-sharp background sure I
mean c-sharp is actually you know in a
bad place compared to Java C sure you've
already had loads of functional so
features link for example Skrillex I
know how we how we write code before and
after Lang is completely different
nowadays we wouldn't think about doing
all this for loops everywhere just to
accumulate things and mappings we just
use select them where right so you've
got a lot of exposure to some as
function thinking really but I think the
difference is that because the default
is still imperative you see visible for
is everywhere and that's where F sharp
guides you towards a different way of
doing things where the default is what
is should be doing so if you listen to a
lot of the sub big old guys they also
talk about all these things okay the
middle bility is important because it is
a concurrency and all these other
reasons but the language is working
against you the tools that we use in the
language is also working against you if
you use resharper you can bracket get
straight away you get setter almost
without even asking for it so that's
what a nice thing about a char is that
where you want where you want with
ability is something down to you to do
the actual work so that you have to be
conscious about the decision where you
make of where the system what know what
part of my system can change over past
count in terms of getting to a shop I
would say now find some problem that you
have a work maybe or even a home home
some side projects small things and then
just expose yourself to that it would
probably take time to change your
mindset but you know it just will happen
you just have to take small steps that
at the time maybe don't try to rewrite a
whole project a critical system at work
because if you fail then you're never
going to see never want to hear by fgi
ever again but if you try the small
things at a time and then now prove that
you know we can do this then you have a
better chance of versus eating in the
adopting f-sharp at work and also one
thing I'll say is that someone who have
gone through this and try to do this
this work is is because if you are the
person driving it at work then it's also
down to you to really be the link to the
community and to find out for a team on
behalf of a team what is happening in
the community and also be with not be
the person to sort of tailor for where
things are some quite work and listen
know how people work through things
because initially there will be loads
people saying just know why is it so
difficult in Ayrshire I cannot have nose
so as the person tried to driving their
change as the Salama board that's a lot
of burden on you but know the rewards is
well worth it I think
any other questions okay if not I'm
going to be around tomorrow as well
it's kind of a bad time for me good
thank you very much let's see</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>