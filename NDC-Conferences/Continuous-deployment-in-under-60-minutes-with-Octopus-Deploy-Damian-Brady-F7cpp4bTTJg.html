<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Continuous deployment in under 60 minutes with Octopus Deploy -  Damian Brady | Coder Coacher - Coaching Coders</title><meta content="Continuous deployment in under 60 minutes with Octopus Deploy -  Damian Brady - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Continuous deployment in under 60 minutes with Octopus Deploy -  Damian Brady</b></h2><h5 class="post__date">2016-09-01</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/F7cpp4bTTJg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so welcome everyone I've got about one
more minute by my judgment and I heard a
bell outside so I'll just give people a
few more minutes for the people who are
here just a reminder of the voting
system at the end the green ones are the
only valid ones to put in the box if you
want to put the other ones in and you
can just skip that bit that's fine
three green ones equals are red by the
way alright Mac get started welcome
everybody today we are going to go
through continuous deployment in 60
minutes we dr. burst deploy my name is
Damian Brady I'm a Microsoft MVP I'm
also a solution architect for octopus
deploy and you might have seen a few
octopus deploy people around wearing
these kind of hoodies one thing about
octopus deploy is that we don't really
have any salespeople so nobody's really
sitting there trying to make money off
everybody so I'm gonna as much as
possible make this not a product pitch
I'm gonna show you how octopus to play
works and explain some of the reasoning
behind the decisions but if you're not
gonna pay money for it fantastic that's
awesome if you just want to use some of
the principles and use other products
that's great as well so I'm not going to
try and tell you anything the first
question I guess that you would be
expecting to hear is what is octopus
deploy and I might just get a bit of a
gauge right now who uses octopus
deployed now okay
that's probably about a third of the
room who has heard of it but doesn't use
it okay a few more people and who has
never heard of octave us to play before
a couple of people all right
okay so octopus deploy probably the
easiest way to explain what it is is to
just grab the text from the web site
which is octopus deploy is a friendly
deployment automation tool for dotnet
developers so number one it's friendly
and so that means that you can do a demo
in 60 minutes from start to finish we
like to think that it's easy to use and
we have a lot of feedback from our
customers that says that it is easy to
use so most people have a deployment up
and running
within a few days of getting started for
the first time so we aim to make it very
friendly and easy to use deployment
automation tool is kind of
self-explanatory it automates and
orchestrates the deployment of the
application do you write as a developer
so whether that's dropping files on a
server and setting up iis updating
databases running some scripts you know
setting up load balancers all that kind
of stuff
we automate that deployment process of
your application and the final part here
actually gets less true as we go on in
time so originally it was for dotnet
developers so you write C sharp or other
languages and it's dotnet code and we
deploy IES websites and things like that
but as of a few versions ago we've
started supporting SSH endpoints you
don't need to use and you get to
packaged anymore you can use tarballs if
you have that you can run bash scripts
so we're less and less dotnet developers
but that's where we started so that's
where we have the most power
the next question obviously is why would
I use octopus deploy as opposed to just
whatever the the current method of
deploying our applications are and
probably the best way to explain why is
to talk about what deployments currently
look like in a lot of organizations so
let's do one here's my app I wrote an
app specifically for this and several
other talks this is my app it's a
weather app I'm gonna make millions off
this thing and it basically just gives
me the weather where I come from right
now now this isn't actually getting real
data because it's changing pretty it's
just getting random numbers on my local
one if this was Melbourne it's probably
correct but it's um negative oh so this
is my app and I've got it running just
locally here my test server is over here
I've just got a test server on localhost
for the purposes of demo and it's not
working at the moment there's nothing
there and production obviously is not
working we've got an azure VM for
production so not running so I need to
deploy this thing so the first thing I
would do obviously is come in here and
right click publish right which is a
terrible way of deploying stuff if you
see demos run with right click publish
that's fine if you don't care what
happens on the other end but
great otherwise so instead I'm gonna do
the real way which is to change this to
release mode and then build so this is
obviously you know some very important
person in the company's machine
you can't build from just everybody's
developer machine it's got to be you
know Steve's machine doing the
development or doing the build so then
you go and you grab the output of this
so where the view here we go we've got
that one there's a whole lot of CS files
in there so we'd probably try and rather
than just collecting everything we'd
probably take this CES files out because
we don't want them in production and
then we'd RDP to our production box to
copy them on and we need to make sure
that we're not going to make any
mistakes here so let's RDP to the
production server which is this guy here
with me and copied that this is the best
way to fun to make sure you're on
production obviously there we go and
logging in as me long password which
means it's secure and you need to make
sure it's production I'm not going to
deploy somewhere else so I've done this
so it's super safe and then so I'll grab
all those files an old log on I'll get a
C drive on it pub WW root and paste them
in and then fiddle around a bit and
there's some web config settings that
need to change for production so I'll go
through my little checklist and I'll
make sure that I'm changing all the web
config settings because we've got a
environment variable and we've got a API
key that we need to set which I've
cheated a little bit we're gonna set
that in octopus in a little bit some
other API keys some file locations and
stuff so I'm going through all of these
little steps and getting it right and
getting it ready so you know what what
is wrong with that process there's
obviously a lot wrong that's the
creepiest gift ever I love it
yeah so what's wrong with that process
and there's a lot wrong with it um
ultimately I'm just sitting there going
through this script right this list of
tasks that need to happen the first
thing I'm doing is ID peeing on to
another server and that's okay because
I'm deploying one website and I know I
have one environment it's got prod
written across the desktop so I know
that it's the right one but imagine if I
had two or three web servers and now I
- do it again and again so we've got a
repetition problem I have to make sure I
hit all of those servers and if I'm
hitting all of them and running through
all of those little steps manually I
have a consistency problem right I need
to make sure that I do exactly the same
thing on all of those servers otherwise
you know some things can go wrong and
this is generally why people do their
deployments who does their deployments
generally on a Saturday or a Sunday yeah
that's kind of half the people were
willing to put their hand up then and
the reason is the deployment itself
probably only takes a couple of minutes
but you need the rest of the weekend to
make sure that you can find the little
problems that you came up with on the
way through who's heard of this company
unite Capital Group anyone a couple of
hands good I like seeing almost no hands
because it's a fun story so night
Capital Group wrote some software for
share trading New York Stock Exchange
trading stuff and they passed billions
of dollars worth of trades through every
day and they had a application change
they needed to make so in 2012 they
repurposed a flag in their code so they
had this flag that took the code down a
particular path and it hadn't been used
for ages and ages so they thought we'll
just repurpose that flag and use it for
our new code so they did that and
because they're putting billions of
dollars worth of you know trades through
every day they needed to make sure it
worked so they tested it really really
really really thoroughly and the code
worked it was great
so they deployed it overnight and when
the market opened in the morning they
lost about 440 million dollars in a bit
under 45 minutes before somebody worked
out what was happening and flicked the
kill switch so the company went bankrupt
in 45 minutes now there was nothing
wrong with the code actually the code
was fine they tested it really
thoroughly but what happened is when
they deployed the guy during the
deployment deployed the new code to
seven of their eight servers so the
eighth server was going down this code
path that hadn't been run for years and
was reporting the wrong values for these
truckers share trades so they basically
went bankrupt straight away because of
the human error a deployment problem
what was that sorry
was he fired I don't think he needed to
be fired because the company didn't
exist anymore
so you know win-win yeah so I mean
that's why there's a problem with this
process because people can make mistakes
and when I did that you know I did it as
a human and I'm not great at following
these instructions absolutely correctly
consistently every single time so that's
something that we want some automation
tools to do so this is kind of a better
workflow what we're going to look at
today the workflow I was looking at then
you had all these developers they do all
their work they test it locally and then
one guy would do the deployment bike
running through the script what we want
to look at today and what we want to try
and get to today is this workflow so
number one we're going to commit our
code we're going to make a change commit
it and push it up to our source control
I'm using V STS we get as my source
control mainly because I'm familiar with
it but it doesn't matter what you're
using we're going to do a build
automatically continuous integration
build and then we're going to package it
into a package of you know the artifacts
from our build we're gonna push that
package - octopus deploy so say this is
version 1 point whatever it is and say
give that to octopus deploy you're not
the boss we're then going to create a
release now a release in octopus is
basically a snapshot of both the
artifacts from your build
so version whatever it is of your build
plus all the steps that need to run for
that release and what that means is you
have this snapshot that you can then
move through your environments so when
we deployed a test we're deploying those
same artifacts in the same way and where
we go to production later on we're going
to deploy those same artifacts in the
same way but to a new environment so not
only will we have tested the code but we
will have tested the way we put our code
on our machines so we that's a really
important thing which we'll look at in a
sec all right so today this is what
we're gonna do to achieve that workflow
I'm gonna install octopus there's
machines I had before word don't have
octopus on them at all we're going to
configure the environments because
octopus needs to know where to deploy to
we're going to configure our build so we
have a build already but it doesn't
package our application doesn't
anything about octopus so we're going to
set that up we're going to set up the
octopus project so this is the steps
that we need to run to deploy our
package to our environments and then
we're actually going to do a deployment
but we're going to do it using that
workflow where I just make a change and
commit it and it will go all the way to
test we'll have a look to make sure it's
okay press a button and it'll go to
production so that's what we're going to
do in the following 50 minutes now as
I'm going as well by the way obviously
there's a lot to cover so if you have
questions that are really quick please
feel free to ask them but if it's going
to take me more than a minute or so I'm
probably going to ignore you and just
redirect you to the booth where we have
20 odd octopus employees including
myself straight afterwards so go and
speak to us and ask us the hard
questions then I'll be around straight
after this as well just a bit of warning
there right that's enough talking so I'm
just gonna do this stuff first
installing octopus all right so if who's
been using the Wi-Fi here it's a couple
of hands all right
so normally you would come here click -
the octopus comm click on downloads and
grab these files but this is 119 Meg's
so I'm not going to do that because
that'll take the rest of the 50 minutes
so I've already done this so number one
we're going to install octopus so this
is an msi it basically all the same
incite does is just drop some files on
and then we configure so I'm just going
to skip through this really quickly
there's really not much to do I totally
read all of that License Agreement and
we're going to do it in a default
location all right so that's the msi bit
done and you can do that silently as
well so how you can script this install
and now we need to get started
configuring a couple of things this is a
really not interesting part of
installing yeah I've actually this demo
so I'm just going to skip through a lot
of this my full name is demo I work for
octopus and then it's damien d-plus
and DC yeah so what do that'll do is
it'll go to the octopus server and get a
trial license so we get a 45 day trial
which gives you unlimited targets and
all that sort of stuff and after that we
revert to the Community Edition which is
five projects five users and ten
deployment targets so you can use it as
a proof of concept really really easily
as well okay so um the next thing we get
asked is where we want to keep all of
octopuses files that we need on the file
system so configuration files logs
packages all that kind of stuff goes in
here I'll just choose the default the
octopus service itself on the server
runs as a Windows service that just
listens over HTTP ports or TCP ports so
we can run that service itself as a
local system account or as a domain
account it's up to us I'm just going to
leave it as a local system account and
then our data sits in a sequel server
database and once again I'm sure you
didn't really want me to walk through
the sequel server install process so
I've already put sequel Express and I'm
gonna give it a new database name called
octopus deploy so what octopus does when
it upgrades database details and things
when we release a new version is it will
run scripts on behalf of that user and
run migration scripts so we need that
local system to have access full control
over that database so we can run their
update scripts and things like that so
the first thing is it says I'm gonna
create the database and then it's going
to say I need that account that you
chose to give full access to the
database so let it do that
now our test server for octopus is sorry
for our application is going to be
localhost so I don't want to use port 80
for octopus so I'm just gonna use port
8000 so there's a UI a web UI for
octopus deploy and it just calls our API
and it just listens on that same port as
well so this is the main site we're
going to go to so port 8000 and
localhost
will do that and finally we need to
decide how we're going to authenticate
with octopus we can do Active Directory
accounts or username passwords so I'm
just going to make
add me an account and type my passwords
and we're done
I don't want to help us out so before I
click the big you should leave those
checked by the way before I click the
big green install button I just want to
show you this there's a show script link
there and I don't know whether you can
see that very well but all that does is
so this wizard we've just gone through
all that's done is generate a whole lot
of command line commands basically so I
can grab all of this quit out of my
Installer there and then just run that
on the command line and we'll do exactly
the same thing so this is really handy
an octopus does this pretty much
throughout this is really handy if you
want to build this as part of your
provisioning script so if you need a new
octopus server you can script the entire
thing and on provisioning just run these
commands and you'll have a brand new
octopus server so I'm going to install
and it's gonna run those scripts all
it's really doing is hitting the command
line and running those things and when
we're done we will end up with an
octopus server that is up and running so
finish and open this in browser and we
have octopus super zoomed in and
obviously there's nothing in it yeah so
that's octopus itself so this is the
server side I'm going to do one more
thing and then we're going to talk about
the client side as well so we want to
deploy two virtual machines to do that
we need to run an agent on those
machines which we call the tentacle so
the idea is the octopus controls a whole
bunch of tentacles so once again it's a
much smaller package that's only three
Meg but I'm still not going to use the
Internet here
I read that License Agreement once again
the msi really just drops files in a
location and tells windows that you've
got this thing installed and we have a
get started button here as well it's
going to ask me some similar questions
things like where do you want the
configuration files and the log files by
default at C Drive octopus and then when
you install applications so when the
octopus server gives me something to
deploy where should that go by default
and you can override that on a on a
project-by-project basis but I'm just
going to use
the default here now there's two types
of tentacles that we have there's a
listening tentacle and a pauling
tentacle in the main differences are
listening tentacle opens up a port an
incoming port and when the octopus
server has some tasks for that tentacle
agent to perform it will hit that port
and immediately the tentacle agent will
respond and say yeah argument I'm gonna
do this stuff but if you can't open an
inbound port for whatever reason for you
know the security theater or the you
know whatever happens in your
organization you can set up a polling
tentacle and that polling tentacle the
way it works is periodically it'll just
hit octopus and say hey do you have any
tasks for me to perform and if it does
you know it'll run those tasks there so
you can keep this pretty isolated if you
can't open firewall ports on your target
machines but we're going to choose a
listening technical and by default that
will listen on port 109 33 if you can't
see that we've also got a checkbox to
add a firewall exception now I'll talk
about the security in just a sec but we
need to tell it this is the tentacle
agent we need to tell it what octopus
server it should trust because remember
we're just sending kind of commands over
to a target machine we don't want
anybody to be able to send commands we
need to be able to tell it this is the
octopus server you care about so to find
that thumbprint for the octopus server
we've got our certificates in
configuration I'll just grab that paste
it in there and paste it here and once
again we have a show script so all that
did that wizard basically generated
these command line things and then we're
going to run that now I'm actually going
to copy this and I will run it here as
an install but I'm also going to go to
my production machine and I'm going to
go to seed
it's gonna be somewhere here download
instead okay so I've got this install
technical script I'm just gonna edit
that the first one is the silent MSI and
the second one is going to be our
commands now the reason I copied and
pasted that was because we have a
different thumbprint from the last time
I ran this demo so a thumbprint is oh
that's the new one for the tentacle
alright I'm just going to assume that
work people who are paying attention did
I do that properly yes good it's always
good when Vanessa tells me that I did
things properly all right so I'm just
gonna run this command line and we're
gonna go back to our slides and I'm just
gonna totally trust that that's going to
work perfectly so we've installed
octopus we've set up the tentacle and
the server as well and I just want to
talk about that a little bit because
that's an important part of octopus so
we have our server with a server agent
and we have our target machines with
that with the agents running on those so
there's a little tentacle agent running
on all of these target servers and in
this case we have a couple of web
servers and a database server and they
all run an agent now to make sure that
we're sending commands only to and from
the right machines each of these agents
has a thumbprint has an x.509
certificate which means that we can
communicate over a secure transport
layer security TLS 1.2 you know an SSL
HTTPS those kind of words over that kind
of channel to make sure that the server
is the only thing that can send
information to the tentacle and the
tentacle knows that their information is
coming from the server so when you
establish this communication mechanism
here to all of your different servers
that channel is a secure Channel now
this gives you another really cool
benefit as well that agent we just
installed actually runs as a local
account the way I've set it up now now
you can run it as a domain account
that's not a problem but we're running
as a local system account by default
which means that we don't need to worry
about a domain account that has access
to our test servers and our production
database and all of the things across
network boundaries you know across
outside the DMZ and also inside the DMZ
so this kind of can't exist in its own
little
we just need to punch that one hole
through the firewall port so that gives
us a lot of advantages as well doing
that does that all make sense is
everybody clear on how that
communication works yeah
use sequel server database a hard
requirement yes it is for version three
point X but you can use sequel Express
which doesn't cost you any money
octopus deploy itself doesn't actually
have a lot of resource usage on sequel
server I mean lots of stuff is stored in
there but it's not gonna hammer the
thing I mean you don't need your own
separate sequel server I'm running this
sequel instance its sequel Express
running on a local VM on my macbook
alongside other VMs it's really not very
resource intensive
so sequel Express is perfectly fine for
that kind of stuff unless you're doing
hundreds and thousands of deployments a
lot of the time but yes we do need to
equal server cool just grab some coffee
and then we're gonna do these next three
steps all together and I'm gonna explain
a little bit more about them we'll get
to some deployment very very soon don't
worry
right configuring our environment so
we're going to tell octopus about those
tentacles we installed we're going to
change our build
so we're packaging our application and
sending it to octopus and then we're
gonna tell octopus how to deploy that
package so what's the first one
configure our environments cool you
think I would know these demos with you
all right so let's go to our environment
tab and we're going to have a test
environment and a production environment
so test is our first one it's gonna zoom
out of you and a second environment will
be production now in our test
environment we need to connect to that
tentacle that we installed so let's add
that deployment target it was a
listening tentacle and you can see we
have the ability to add SSH connections
you can ignore these two because they're
being deprecated offline package drops
if you really have an air-gap server you
can drop it to a USB key go to another
server somewhere and run a PowerShell
script and it will do the same thing or
appalling tentacle so we have a
listening tentacle
it's at localhost and it's listening on
that default port and the service found
it it's been able to communicate this is
our test web server and we're also going
to give it a role now the idea of roles
in octopus deploy means that during your
deployment process you might have a
number of steps that need to run on your
web servers and a number of steps that
need to run on an application server and
some steps that need to run on a
database server by giving each one of
these machines a role it means that all
of the tasks for a web server will run
on all of the web server machines so
it's a really nice way of being able to
scale out especially so if you add a new
web server you just add a new machine
and all of the web server tasks will run
for that machine as well so we only have
a web server here we've exchanged
thumbprint already so let's save that we
have a test web server and I'm going to
do the same for the production server
which once again is over here and it's
listing there we're going to discover
and the Internet's worked great so
that's a production web server it's also
a web server but waiting the production
environment for this one so I've got one
web server in a test environment one in
our production environment and we can
see I've got one there and one in the
production environment now there's a
note here about calamari that we need to
update calamari I don't want to go into
it in too much detail but more or less
previous versions of octopus deploy the
tentacle agent itself did a lot of work
so it would communicate and it would
know how to do things like set up iis
and all that kind of stuff
we decided that especially as we moved
away from Windows as a requirement that
that bit of code that does the work
could probably be shared amongst all of
the different locations so the tentacle
itself we kind of sliced it up hence the
name calamari we have fun with names we
sliced it up so the tentacle itself
really just deals with the communication
calamari that bit of code and that bit
of binary that does the work we actually
put that out so we actually passed that
over the wire and then tell it to do the
work and that gives us the advantage
that if we update the bit that does most
of the work we only need to update the
server
and we can push that updated version to
our target machines as part of the work
we're doing so it's telling me that this
target machine that I've got has an
older version of calamari but it's going
to push that out the first time I do a
deployment anyway so I'm just going to
ignore that for the moment does that
make sense
calamari and tentacles yes okay the
question was with the calamari be
sitting on the tentacle and yes it we
have a copy of it on the server and then
when we do a deployment we make sure
that the calamari that's on the tentacle
said that executable that's on the
tentacle is up to date and if it's not
we send it up to that version along with
our tasks all right so we've got our
environments we've done that bid what
was next building package so let's go
and have a look at our build and right
now we have our build which just does a
compile and it puts some stuff in a drop
folder and so on we need to add some
stuff to it to be able to package up our
application now has a few ways to do
this but I think I'm going to use the
easiest and most common way and that's
the a dokdo pack to our to our project
now octo pack is a new get package which
creates and you get packages so it's a
bit meta basically we add it to our
project and what it will do when we
build is it plugs into the MS build
process and it'll take our build
artifacts so our result from our build
and put it in a version to NuGet package
it'll also let us do things like push it
to octopus and so on but for the moment
I'm just going to get it to package our
application so let's install that and we
need to push that to to our server and
you'll see me do this a lot I don't test
anything I'm just gonna go back and I
will commit and push so that's going to
go up a new version to our build we need
to add a couple of arguments to our MS
build stuff so our actual build
definition okay let's do that so the
first first argument is that readable it
was in a bit
is run octo pack it was true so that's
gonna say when you finish with your
build package it up for me I'm gonna add
one more argument which I like to do
especially for VST s which is octo pack
package version and I'm going to tell it
to use the build build number so the
build number that we're using for the
TFS or for our team build is going to be
become the package version as well so if
we have a look at our build number
format here it's one zero dot the build
ID so every time we do an you build that
build ID is just gonna increment and
because of this packaging here it means
that the NuGet package we produce as
part of our build is going to be 1.0 dot
whatever the build ID is so we'll save
that and I'm just going to cure a build
now this would take a second because it
has to use the internet which is fun so
while that's running hopefully it is
running I'm just gonna have a look at
we've got build 1 0 32 that's going to
run hopefully in a sec we have a look at
1 0 31 and have a look at the artifacts
that got produced before we added octo
back so we have our drop folder we'll
have a look in there and in where the
view we see we've got our bin folder
we've got all our dll's and things like
that we don't actually even have our
content file so we would have had to do
some more work to get the content files
for our web application as well it's not
really what we want it's not packaged up
in a way that we can deploy later on so
how's that build going is it actually
working yeah technology so what we're
doing is we're building we're restoring
and you get packages we're building our
application and we're creating a new get
package and pushing that up to the
server so pushing that up to the server
to that artifacts that drop folder is
probably what's going to take most of
the time so the subsequent runs I'm just
going to disable that stuff we don't
need it up to 25 let's have a look to
see if we can can't see the artifacts
yet
so what this is doing just to remind you
as well it's taking the output of our
build grabbing all other files we need
and packaging them up into a new get
package and it's going to version that
and send that up to the server we're
going to need to do one thing in a sec
as well which is to tell octopus about
that so push the package to octopus so
we've finished that we'll have a look
and we can have a look at the artifacts
as well and we'll see the same files
except there's also going to be a
weather view dot one point 0.32 you get
package now octo pack has the other
advantage where it adds all the content
files and all the things they conceded
it's a web application so it has the
dll's plus all the content stuff that
you would need to deploy so that's why I
use doctor pack I don't need to worry
about that so we've got home you get
package the next thing we need to do is
tell octopus that we've got a new get
package and so to do that I'm gonna add
another build step now this build step
doesn't come out of the box package it's
an octopus one saying push that package
to octopus which is what we want to do
to get that build step in there you need
to add an extension from the marketplace
so if you browse to the marketplace in
via steam services you can see octopus
deploy build and release tasks which
will give you all of those tasks so I've
already installed that to save some time
we can add that build step and say when
we've got this new get package we want
to push that to octopus to tell octopus
about it now we need to set up an
octopus server and we can do that using
a feature of bsts called
endpoints so we'll just manage that and
the reason we need to manage this is we
need to set up some credentials because
I've just installed octopus so our
credentials it's localhost 8080 puss and
our password our API key comes from our
user so I'm logged in as admin and you
can add some API keys to your account
what that means is when you hit the
octopus API if you use that API key you
are acting on behalf of that user so if
I add a new API key here for VST S build
just so I can remember what it's for
I'll grab that API key
and I'll use that for my octopus
endpoints so we're authenticating as
that user when we do this work that's
saved so kill that and come back to our
build so that's going to use those
credentials when it connects to octopus
so interestingly I mentioned that the
API key acts on behalf of that user and
I think I mentioned before that
everything in octopus deploy actually
hits the API so we have our UI and all
it does is hit the API behind the scenes
and this is just a jason like a REST API
so we can use API
you know slash users and that will give
us all their users that's me and so on
so the whole thing everything with
octopus deployer is scriptable you can
hit that API and that's ultimately what
our extensions are doing what this step
is doing is just hitting our API using
that API key are just provided we need
to give it the package that we're going
to push to octopus in this step and oh
my god I'm cheating I'm just gonna do
this you don't wanna see me tap that and
get it wrong so let's just paste that so
that's just a pointer to the NuGet
package we created and so it's gonna
push that to octopus we'll save that
that was a super exciting part of the
demo by the way but the ultimate aim of
that is in our build we're packaging up
everything we've built and at the end of
that we're pushing that package to
octopus so octopus knows about it so I'm
just going to queue a build and we'll
move on to the next step while that's
running agents that are not online
that's awesome so when I ran through
this demo plenty of times the bsts build
agent kept just quitting which is great
for demos so I'm just gonna restart that
we'll try it again okay it's back online
hopefully it's going to get started so
the endpoint of that should be build our
application end up with and you get
package and it gets pushed to octopus so
now what do we need to do we need to get
octopus to do something with that
package so let's go back to our octopus
application we'll create a new project
called weather view
and we will add some steps that are
going to tell us how to deploy that
package first step will be deploy a
package pretty self-explanatory deploy
weather view and now remember how I
spoke about roles we're going to deploy
that to all of the web server roles so
when we deployed a test it's going to go
to our test web server when we deploy to
production it's going to go to our
production web server so that's this
step will only run on the web server
roles if we had a database one it
wouldn't run there the package we're
going to add is weather view and
normally this gives you autocomplete but
that build is still running we don't
actually have that package in octopus
yet and we have a couple of other
features that octopus gives us as well
so being able to replace application
settings so I spoke before about having
to modify that web config to make sure
that production looks at production
databases and all that kind of stuff
octopus will do that for you
it'll also run config transforms which I
don't have any conflict rants form so
I'm just gonna kill that feature but one
feature I do want to add is the idea of
an IAS website and application so I have
created a web application that's what
I'm deploying I need to tell is about
that an octopus knows how to do that so
I'm just going to add that feature and
that gives me the ability to add some
things like the website name we're going
to install that to the root because it's
the only application running on this
machine I'm going to call it call the
application pool weather app and we've
got some bindings we can change the
ports if we need to on a environment by
environment or machine by machine basis
we don't want windows off we want
anonymous auth and that's it we have
this one step in there that does that
work
I'm going to add one more step as well
which makes it much nicer for demos and
that's basically just one bit of script
that hits that endpoint URL and just
make sure that it is up and running it
also gives the added advantage that it
spins up is and make sure that it's
actually running again now I could add a
script step here and write my own
PowerShell or C sharp or Barry
very soon f-sharp as well but instead of
doing that somebody's done that for me
so I can go to library - octopus deploy
comm and somebody has already written a
script that does this so I'm gonna reuse
theirs
so there's an HTTP test URL one that
somebody else has written so I'll copy
that to my clipboard we'll go back to
our library of step templates and import
that save and now when I go back to my
project I have another step type that I
can add down the bottom HTTP test URL so
I'll add that that's going to run I'm
gonna run this on the octopus server
because there's no point running it from
that target machine it's probably going
to work if you're hitting localhost and
run it from the octopus server but on
behalf of each of those web servers so
on behalf of the web server and the URL
I want to hit is going to change
depending on our environments so now we
need to think about environment specific
variables so let's just put something in
there and say this is gonna be the
server URL that we want to hit we'll
save this and we'll go and have a look
at setting up that server URL for
different environments so octopus has
the idea of variables which you can
scope to various things so we've got a
server URL and in for tests that's going
to be localhost and so the scope of that
variable here is the test environment
you can also scope based on roles
targets steps channels if you're using
channels you can scope on a lot of
different things here but we're just
going to do it on the environment which
is the most common and for production
the value is this thing that I
constantly copy and paste so that's our
production one
now I mentioned that we know how to do
upsetting changes and things like that
so if you have a look back over here in
our web config we also want to change
our end environment variable so our app
setting that says the environment that
we're in and also our API key from our
weather service so the weather service
API key is going to be the same for test
and production because it's just pulling
some weather information we don't care
so luckily I'm gonna cheat again because
I couldn't remember that so that's gonna
be what was the weather
API key so what octopus will do is will
actually match any app settings that
match that variable name by default and
this is a sensitive variable you guys
didn't see that so we want to hide that
from everybody as well we don't want to
share that around so that's a secret one
and then we have our end which is
testing server for our test machine our
test environment and in production we
have prod super super professional so
let's save all those variables so what
will happen now
is that step that we've got to hit the
URL to make sure everything's up and
running we'll use localhost if we're
deploying to tests but our production
machine if we're deploying to production
the environment variables in our config
files we'll use testing server for that
end thing in tests and prod for our
production one and our weather API key
will match for both environments because
we haven't scoped that so when we
actually do a deployment these these
settings will get get set per
environment that we're going to now
let's just have a look in our library
and see whether there we go so that
build has succeeded and we've got our
weather view package in there as well
yeah it's a question
yeah so the question was in the HTTP
step can I explain a bit more about what
I mean by running on behalf of service
so usually the task will run from the
tentacle agent so when I have this step
here which is a deploy package any
scripts and stuff that that run as part
of that deployment will run on the web
server
as that agent tasks which means they'll
run under that local account on that
target server when I say run on behalf
of it's gonna run from the octopus
server but if I have five web servers
it's going to run for each of those five
web servers and then some of the octopus
variables that we give you things like
what's the environment we're going to
what's the Machine name and so on even
though we're running locally those are
going to be set to the context of where
I'm gonna go to so in the case of
deploying the web application it's
important that that runs on that target
server to set up is and things like that
but when I'm just testing a URL I can
run that from my octopus server it's
really handy especially for deploying to
databases so if you have a database
server that's over there you can just
run sequel commands remotely if you want
to and so you can run them from the
server there's no point installing a
tentacle on that agent and doing that so
yeah that's what we mean by running on
behalf of that's a relatively new
feature too I think three point three
three point three which is cool all
right so we've got our process we
haven't done a deployment yet but let's
do one will create a release which is
what I what I talked about before I
gotta change one more thing in our
settings we can say that version in
octopus we want it to match the version
of the package so this is something that
sometimes people don't do you have a new
get package created by your build called
one 0.29 but in octopus deploy at 0.01
so we want to just line them up so we'll
save that and we'll create a new release
and this release is going to be one 0:33
same as an you get package we're going
to choose that and you get package
remember this is a Snow
shot of the artifacts we want to deploy
so we're gonna say this release that
we're creating has a snapshot with that
package in it 1 0 33 so if we do more
builds this release itself is not going
to change we can keep moving this
through our environments so create that
release and deploy it to our test
environment it's warning me about
upgrading calamari which I mentioned
before and then we can follow through as
it goes through that deployment process
and everything goes green with green
ticks and there's no problems did cool
that wasn't I wasn't meant to sound
surprised then we can actually go a
little bit further and we can watch the
logs as they happen
so all of the steps that do a number of
scripts and things all of this all of
the logs that happen on that target
server get sent back to octopus so
octopus collects all of these logs that
happened on all of the remote machines
and puts them in one spot and these are
just text it's just raw logs you can
look at so we don't hide anything from
you there's no magic that happens that
you don't see as a result so we've got a
green deployment here everything went
well let's go back to localhost which is
where our test server is and we can see
that we have our running application so
those variables are set before testing
server because we're on tests that
environment variable is there we're
clearly getting the absolute accurate
temperature from our weather weather
service because we've got the API key
but production again is just is still
not running so we need to promote to
production we can do that by clicking
the button says promote to promote
production it's supposed to play that
and it's going to go to the azure web
the azure vm that we set up with the
tentacle and the variables are going to
change value because we're now going to
production so again we can watch this as
it goes through there's some really cool
stuff that happens with acquiring a
package where we say you need this
version of calamari so we'll be pushed
or push that up but you also need this
version of the new get package and we'll
push that up now if you have like a
couple of hundred Meg in your
location and you just change one file
then it seems a bit stupid to send that
another couple of hundred Meg to that
target so a little while ago Henrik was
one of the main guys who did Delta
compression so basically we look at that
zipped up NuGet package or a zip file or
tar ball or whatever it is and we do a
comparison of what's changed at a binary
level and we only send that change up
because the server already has
potentially you know 1 0 32 so there's a
tiny change we send that change up apply
the change and then use that whole
package so this gets much much faster as
you go as well alright so we've done
that we're still waiting for our HTTP
200 to come back because I'm cheap and I
got a cheap VM on Azure that might take
a couple of seconds but when that comes
up and we get a 200 response we should
be able to refresh our production one so
while that's happening I'm just going to
go and do a couple of things to our
build we want to we want to set up a CI
build so when we check in it does this
stuff automatically and we also want to
add a couple of steps to the end of our
build to say alright I don't need to
press the release button and the deploy
button I just want you to do that for me
before we do that I just want to
highlight a couple of things to do with
this build so octopus has the idea of
life cycles as well and what that means
is we have to set we can set our life
cycle up so when we do our deployment to
test and that succeeds only then are we
allowed to go to production so if that
deployment failed to test I wouldn't
have had that promote to production
button and what that means as well is
that you can add the ability to click
that button to people who are
non-technical like your manager your
manager can click the everyone's a
manager is probably you know really
smart sure but the CEO maybe is the guy
who clicks the deploy to production
button which means that all of the ideas
around all that developer stuffed-up you
know it goes away a little bit because
they were the ones who click the button
and I've heard it goes away of course
yeah
I've heard stories as well about
companies as well where they're at the
pub doing a release party and stuff like
that and one of them hands the manager
an iPad and said I'll just press that
and he's like oh okay what's this person
you guys we went to production that's
what you did well everybody's holding
holding beer but it's it's safe because
you've run this in your test environment
before so when you click that button
it's going to do the same thing and go
to production and so your production
deployment itself runs the same steps
with the same package and will deploy
successfully so let's come back and have
we deployed that yet that one there we
go we're green so we've gone to
production if we refresh this one we can
see zoom in and now we're in prod so
that variable was applied for production
as well and the temperature hasn't
really changed it's changed a little bit
tiny a little bit it's gone up by a few
thousands of a degree yeah question
so the question was do we push those
bits to each server individually and
there's two kind of options the answer
in general is yes each of those servers
needs their own copy of the package but
we can also set a check box to say that
that target server can just pull it
directly from a new get feed somewhere
so we're using an internal octopus
deploy and you get feed here but you can
also point at an external feed so if you
have your own you get repository
somewhere else in your environment you
can tell octopus to tell the tentacles
to go and get that file for themselves
so rather than the server pushing it out
to ten machines those ten machines will
just go and get it from you and you get
repository but each of those machines
doesn't need their own copy of the
package to deploy that answer the
question so we don't push it to a blob
store or something the blob store is
actually the file system on the octopus
to place server so if we went and had a
look in that home directory that we set
up there's just gonna be new get files
in there and then we index them in the
database and you get as well so it's
really really fast that way if you had
another new get server that uses a blob
store somewhere you can tell octopus to
use that as its new get repository and
so when we get new versions for new
releases you can get them from that and
you get repositories so we don't have to
use the internal one it's just very
convenient cool all right so we've got
prod we've deployed one set of steps and
there's a another couple of things that
are really important about having that
one project that has one set of steps
across your environments and number one
is that practice makes perfect right so
we want to be able to fail in early
environment so we want to be able to
prove that not just a code works in
tests but the way we put our code into
test works because we're going to do
that process again when we put it into
production so we want to practice that
and the other advantage of that or the
other side effect of that is that it
gives us the opportunity to fail early
when it doesn't matter so so far all
these demos have worked really well but
when I did this in the hotel room I
failed earlier
times actually so but that doesn't
matter because that's in the hotel room
like nobody knows that I failed heaps in
the hotel room until I told you so if
you fail in your test environment and
your staging environments it doesn't
matter right but if you fail in
production that's why you're there all
weekend because the if you fail in
production you absolutely need to get
that working so failing early is a
really really handy thing and that's
what having that same process is really
important for all right it's a great
gift all right so let's put all this
together so the other things I said I
was going to add we're going to add a CI
trigger for this so when I check-in it's
going to going to build every time so
we'll do that so when I commit a change
it's going to do that and I'm going to
add two more build steps so the two
things I did an octopus create a release
and deployed a test we have steps for
those so in our deploy tab these got
added with that extension create an
octopus release and deploy that octopus
release so create we're going to use the
same octopus server I think we call it
weather view right weather view we did
cool release number gets said
automatically so I can just leave that
blank and then deploy that release we
just created two weather view and we're
going to deploy it to test and make sure
it works and then we're going to click
the button to go to production and we're
going to use the latest one because we
just created a release but I could also
put that build number in there because
we know what no what that was so we'll
save that and then we'll do the grand
finale kind of demo which is do a
deployment but do it using that that
workflow that we mentioned before where
I just make a change now can anybody see
anything you'd like to change with this
application
maybe that so let's do that
luckily I know exactly where to change
there which is down here when we pass
our view model through to our thing the
actual change doesn't really make make
much of a difference but we're going to
do a math dot around
we're gonna round it to what one decimal
place it's probably enough and we are
going to because I'm such a hardcore
developer I'm not even going to compile
that there's no red squiggly line so
it's probably fine and we are going to
commit that and push and let's watch it
go all the way through that process I
still got a few minutes so there's also
some other reasons I might watch this go
through as well so we have our build
it's waiting for an agent I may need to
restart that service again we'll see
this is the V STS agent that does the
build and I'm running it locally so I
can say that octopus is at localhost if
I was running there cloud-hosted build
which is also cool and it would work the
same way but localhost is not going to
resolve to my octopus deploy server so
the octopus had just installed I'd have
to make publicly available which is
boring and I don't want to do that okay
so we're building so we're building our
project creating a new NuGet package and
I really should have disabled that step
because now I have to upload all of
those artifacts back up to bsts where
I'm not going to use them anyway so
we're in file and I'm 18 of 20 of 46
it's going a little bit faster we'll
just wait for that to finish but when
that finishes we'll have our NuGet
package our next step is to push that
and you get package to octopus so over
an octopus remember we had version 1 0
33 when this actually ends up pushing it
to octopus will have a 1 0 34 when we
create our octopus release by default
it's going to grab the latest versions
of all the packages we use so in octopus
we will now see in our project whether
view has a 1 0 34 release which is
currently deploying to test because we
said now deploy the latest version of
that release to test so it's going there
we're just going to go back to the
dashboard so we can see this go through
so 1 0 34 is going to test its succeeded
so let's go and have a look to make sure
that it's changed and wow we're right on
17 degrees so either the rounding didn't
work or we're right in 17 degrees but
I'm happy enough with that I'm going to
promote that to production I'm actually
going to do that a different way and
just click the deploy button in our
overview for that project deploy it
again and we'll wait for that to go
through and we should see the same
change once we spin up is again in
production so any questions about that
process because remember all I did then
was make a change commit and push it to
the server we ended up with it in tests
tests said it was fine and pressed the
button to go to production and now we're
going to production hopefully
yeah yeah the first question was how
does this change if you're in team city
and it will change if your intimacy this
is like plan D by the way team C so the
build definition here I have another
build and there's an extension in team
city which means that my build steps in
team city are run the build and then
there's some other build steps from the
octopus extension for team city that are
the same so the ones in V STS are
actually that they came more recently
and we patch them back to match what's
in team city so same process just
obviously different product
yeah so that the question was if we're
deploying to say ten servers it deploys
to three and then it fails on the fourth
one so by default when you deploy to you
know five web servers for example it
will do that those deployments in
parallel and I'm waiting for these guys
to correct me if I get something wrong
it'll do those in parallel so it'll send
the files out and run those deployments
and stuff on each machine at the same
time if one of those fails though the
deployment itself gets marked as failed
there's a couple of things you can do at
that point because we don't really know
the state of that deployment you know
some of the machines have succeeded
maybe you got three-quarters of the way
through that deployment and then that
server ran out of disk space so there's
a couple of things you can do you can
set up a manual intervention in there so
a guided failure mode is what we call it
and that means that when something fails
we give you the opportunity to try again
or fix it or just you know fail the
deployment itself so in a production
environment it's really handy to have
that manual intervention kind of the
guided failure mode on because we get
halfway through our run out of disk
space let me just jump onto that machine
and clear some space and then say all
right try it again and then continue on
with that deployment if it's in a test
environment or something like that then
you know you probably don't have guarded
value mode on you can the important
thing of course though is that ideally
in an ideal situation those kind of
failures when you get to that last
hurdle you're gonna get a lot lesser
than because you've tested that same
process with the same bits in all your
previous environments so yeah that's
generally how you do it rolling backs a
whole different thing
you shouldn't roll back you should roll
forward previous versions and things so
I can actually in octopus I can go back
to and that one's worked will just
refresh yeah everything so in octopus I
can actually go back to this overview
grab one 0:33
and deploy that again to production so I
can roll a previous version over the top
because that's a snapshot remember my
snapshot of the bits and the price
there's another question up yeah yeah so
this has changed was changing with three
point five I think isn't it so right now
octopus needs looking at these guys
right now octopus needs to be able to
communicate to those tentacles so if you
run a deployment or try to run a
deployment and it can't communicate with
one of those machines right now it will
ignore that machine or it won't let you
deploy which won't let you to play right
so you can disable that machine and say
just deploy to the remainders but in
three point five which should be out at
some point soon three point four four
sorry three point four I said that twice
in three point four which should be out
very soon and there's a beta - if you
want to play with it as well we have the
idea of machine policies and things like
that with projects where you can say for
this project and I'm if I'm deploying to
this environment I don't care that I
can't contact those machines just deploy
to the remainders you can even say
things like if that machine comes back
online then deploy it to that machine as
well so a lot more kind of elastic and
acknowledgement of transient machines
and things like that cool so I'm running
out of time I don't really have much
more content but one other thing I
wanted to mention as well is if you have
more questions you probably sitting
there saying Damian you really didn't
talk about this thing and first of all I
don't appreciate being called an idiot
but secondly I have a really good answer
for that which is that our basically our
entire team is here so there's a booth
out there we've got 20 of us still
remaining here we are also doing if you
haven't used octopus before at all we're
also doing some usability testing so if
you go up and speak to Jess who's in the
back of the room there with a hand up
we'd love to run through you know trying
to do some things with octopus to see
how easy it is to use remember we wanted
it to be friendly so it'll be great if
you could help us out with that if you
don't have a lot of experience with
octopus deploy but any of those deeper
questions you can ask anybody with an
octopus to play t-shirt or hoodie or
something like that and we're happy to
answer those questions
so that is all I have for you thank you
very much I can breathe now</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>