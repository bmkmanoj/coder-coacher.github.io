<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>CSP XXP STS PKP CAA ETC OMG WTF BBQ… - NDC Security 2018 | Coder Coacher - Coaching Coders</title><meta content="CSP XXP STS PKP CAA ETC OMG WTF BBQ… - NDC Security 2018 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>CSP XXP STS PKP CAA ETC OMG WTF BBQ… - NDC Security 2018</b></h2><h5 class="post__date">2018-02-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/scZsv_mv0Bw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello hey there we go so thank you
everyone for coming and welcome to my
talk today I'm gonna be talking to you
about CSP xxp SCS pkp CAA et Cie oMG WTF
BB Q and I can hear you all thinking the
last acronym on there which is ffs who
here knows more than four acronyms out
of my slide title Oh excellent so this
is gonna be really good talk them the
the talk title is kind of on purpose and
I kinda want to make this point about
often when we talk about security we end
up with this giant acronym soup of
things and acronyms that we talk about
so if I was to translate my slide title
into something a little bit more kind of
normal it would probably be modern web
security standards and this is what I
want to talk about today so you can
probably think about my talk as an
introduction to the first five acronyms
that were in the slide title so it's
probably going to be kind of like five
whitening talks really I want to
introduce you to these technologies and
show you how we can use them to do
things better and it's not just about
security either we can use these
technologies to make our websites faster
make our jobs easier automatically find
errors on our website have them reported
and in some cases have them fixed
automatically as well so it's not going
to be kind of tuned out hopefully we'll
get a really good overview of the
various different things we're going to
look at when they dive straight in
because I've got a lot of a lot of
acronyms to get through so I'll kick
right off with the first one in the
title which is CSP and this is content
security policy if you have seen me on
Twitter or read my blog or anything
you'll know that I'm a huge fan of CSP
and CSP is a security 2 header that
allows us to do countless different
things there's constantly expanding in
the terms of what it can do but going
right back to the start the version 1 of
CSP if you will it was originally
designed to stop something called a
Content injection attack so ever mock-up
of a page behind me imagine you have
your website on your home page you have
a really nice kind of comment or review
section and you want people to come
along and say this website was fantastic
five-star submit you saved that review
into your database and then when someone
comes back to your site
you render it back into the page except
this pesky reviewer also put a script
tag into their review comment so you
save that along with that comment
and you've just rewritten a script tag
back into the page we call this
cross-site scripting that's the
particular attack and you can see here
this pesky reviewer has put this script
tag into that comment so this script tag
is now on the home page of your website
show of hands who wants this script tag
to load on the home page of their
website so we can look at this as people
and say right so we have this script tag
and it's coming from evil calm so
already I'm pretty sure that I don't
want this and it's called keylogger is
so now I'm really sure that I don't want
this but the browser doesn't have that
kind of context it doesn't have that
kind of understanding the browser will
come to your website and load this page
it will see a valid script tag and it
will do what he's told which is to load
the script tag so now we have a really
big problem because there's a keylogger
file on our home page and there's
another sneaky way that the attackers
could do this and why it's really
difficult to mitigate cross-site
scripting is because they don't need to
load the script from a third-party
domain they could just write the script
tag into the page what we call an inline
script so mitigating cross-site
scripting can be really hard the example
here is really harmless it just although
it's a message that says hello world but
again it could be the code for a
keylogger there's some malware could be
a remote access tool it could be
anything really but the point is we
don't want it there and what we need to
do is we need to give the browser the
ability to understand what we want in
our website and what we don't want in
our website and this is exactly what we
do with content security policy so as I
said content security policy is it's
what we refer to as a security header so
it's a HTTP response header you should
see some that you're familiar with we've
got the server we've got the day they're
all kind of standard things and then
content security policy just sits
alongside them so we just deliver an
extra header along with our pages
there's nothing particularly difficult
about this and then what you do is you
put the policy you want enforcing on
your page into the value of that header
now the policy itself is made up of a
variety of different directives and the
ones I'm showing here are what we call
the fetch directive so these are the
places where you can load
different content from so in your policy
you would specify let's say the image
source and then you would provide a list
of domains where the page is allowed to
load images from you would specify let's
say the font source and then you provide
a list of locations the browser is
permitted to load fonts from and you go
on and so forth things get really
powerful with the script source
especially because now we can control
where the browser is permitted to load
scripts from so let's take a look at
basic policy this is what one might look
like so we issued the content security
policy header and off the previous slide
I've used the default source so this is
what all of the other directives fall
back to if they aren't specified so we
can be nice and relaxed and open about
this and say okay default source self
that's the CSP keyword for your own site
so you're saying I'm happy to load any
type of content from my own website and
this other domain as well so if we take
this this is a really basic policy if
there's pretty much not anything to this
but we've already mitigated the -
cross-site scripting attacks that we
just looked at on the previous two
slides because if we think about the
evil com one browser comes along it will
now see that script tag and it look
great we've got a script let's check the
policy see if we can load it
well the script source isn't specified
so we'll fall back to the default is
evil calm in the whitelist and it's not
so the browser will simply skip over
that script tag and will not load it
completely neutralized and the second
one the inline script all inline scripts
like that are actually banned in CSP
when you deploy it because the browser
can never know where it came from so
what you do is you take that message j/s
you externalize it into a file and then
load it from your own domain and then
the browser says ok I've got a piece of
information to work with now the domain
the domain will match the self keyword
so you still keep all your functionality
you still have everything working and
now the bad guys already can't put stuff
into your website but the problem is
that you probably couldn't deploy it on
your website and I know that I couldn't
deploy it on mine because we are all
load content from all kinds of different
third-party locations so you have to
fine-tune your policy so we'll start
with the default source of self by
default hopefully you should trust
yourselves to load content in your own
website
then I'm going to specify the script
source now when we specify it we
override the default so we have to put
the self keyword again and I'm saying by
default I'm happy to load scripts from
these two different locations and what
that means is you can now have these
script tags in your pages the browser
will look at the source attribute and
check to see if the domain is white
listed in the policy so again as long as
you don't put evil.com in your policy
which you shouldn't
then the evil.com script won't load and
again the inline script is blocked
anyway so this is really powerful and
you take this kind of principle of
fine-tuning and you continue to do it so
you would specify what we call a source
list for all of your scripts you'd have
a source list for all of your Styles
your images and you start to get really
specifically say right well these are
the locations that my website loads
content from and I'm going to provide
you a list of them and then you can
enforce that list on my pages but this
is not the only kind of purpose of CSP
over the years it has become a lot more
powerful and a lot more flexible so we
can actually start to control the things
the browser is allowed to do as well not
just the resources that it's allowed to
fetch and I really like the form action
we see I see this underutilized
everywhere and what you can do with the
form action is again specify a list of
domains of where the browser is allowed
to post forms to now talking about the
previous example with the scripts the
attacker now can't pop a script into
that comment but what if they inject a
form tag instead and have a username and
a password field and a submit button
we've now rendered what could look like
a little login button and form into our
sign so we specify the form action and
tell the browser okay you're only
allowed to post form data back to me
nowhere else so if somebody injected a
form tag like this completely
neutralized it's now fixed frame
Ancestors we see a very common attack
online called clickjacking where it
happens with financial sites a lot they
will load your website into an iframe
and they'll put a transparent form over
the top so the user can't see it when
they think they're clicking on your form
fields and typing in their username and
password they're actually clicking on
the transparent overlay instead
so with frame ancestors you can say who
is allowed to frame my site so
if you were to go to your site and try
and do this and put me in a frame the
browser will block it and it will not
load my site in a frame and then block
comics content came along so those of
you who have either moved your web site
to HTTPS or have a website on HTTPS you
can load things into your web sites over
HTTP it happens a lot by accident and
try giving a great example it was it CNN
wasn't it they've just moved brand-new
website we've gone to HTTPS today but
they have no green padlock because
they're loading one picture by accident
over HTTP and it ruins everything so bla
comics content would have blocked that
but it's fallen out of favor now excuse
me and kind of been replaced by
upgrading secure requests and what that
would do if you send upgrading secure
requests and you had something like this
on your website just a really innocent
image tag but the source attribute is
HTTP the upgrading secure request
directive will tell the browser to
rewrite that as HTTPS instead and it
will completely fix your mixed content
for you you don't have to go through
find all of these source attributes and
manually update them to HTTPS or to be
protocol relative the browser will fix
your problems for you so CSP is pretty
powerful and if you deploy this on your
website and let's say that you
accidentally forget to whitelist your
style sheets and you block all of your
style sheets what's your website going
to look like it's not gonna look
particularly great so what we need to do
is we need to test a content security
policy before we deploy it and we can do
it because we have a mode in CSP called
report only so it's a slight
modification of the name to the header
so you just add report only to the end
of the header and then send exactly the
same policy and what you say to the
browser is look I'm thinking about
deploying this but just tell me what you
would do if I gave it to you but don't
actually do it and the browser will pop
little error messages in the console and
say okay if you gave me this CSP I would
have blocked this image and I would have
blocked this style sheet so you can
check what it would do before you
actually turn it on now this is really
handy but nobody wants to fly around
their website with the console open
looking at error messages so there's an
even better way to do this and it's
called CSP reporting so again it's the
same
the same report only mode and we've
added a new report your eye directive to
the end here and you specify a URL there
and one this ace to the browser is
instead of popping error messages in the
console I want you to actually send them
back to me
to some central collection location and
you can just stand up a little end point
we're in a service that does this and
the browser will post you a JSON payload
that looks like this and this is
essentially turning the browser of your
visitors into kind of a little security
slash QA tester because you're saying
look here is a policy my site should
adhere to this policy and if it doesn't
I want you to send me a report and these
reports are perfectly formatted they
contain all of the information that you
need to know exactly what the problem
was and that's really powerful because
now all of your visitors are going to be
constantly scrutinizing your website and
looking for problems and more
importantly if they find one not only
will the browser block it and protect
the user they'll also tell you that they
have to take that action to protect your
users so a CSP can be really powerful
there's a lot of features in I want to
quickly show a couple of these in action
now we're going to have a little demo of
the kinds of things that you can expect
to see so come on so I've got a little
CSP demo set up here and I'm going to
open up the console so let's reload the
page now I have a content security
policy set up on this side and you can
see down here I've already started to
get error messages in the console so I
have a script tag here
they said scripts source security
headers I'll let me zoom in actually so
you can see that a bit better so this I
put this script tag there but anybody
could have put it there by any number of
different means different mechanisms
maybe develop a copy and pasted
something from a code snippet maybe it's
a cross-site scripting attack it doesn't
really matter how it got there what
really matters is that if we come down
here we can see that there's an error
message in the console and the browser
is saying I refuse to load the script
because it violates a following content
security policy directive so this is CSP
literally in action he's seen this
script tag on the page and
security headers the i/o which is a
slightly I'm using the Xhosa file is not
in the whitelist then we can go over to
the network tab and look at the policy
itself so I have a pretty gnarly CSP
don't let this put you off you start
with a small CSP and you work up this is
one of the common things that I see but
the domain that we're loading the script
from is not in that whitelist so the
browser will refuse to load it same
again for an image here using HTTP so if
I look at this particular image file and
we take a look at the source attribute
of that image that image is being loaded
over HTTP written straight into the
source actually bought by the zoom back
out have a look up here
I still have green HTTP and all of the
indicators normally if you loaded a HTTP
asset into a page like that you would
have those indicators strips away but I
don't because I'm using upgrading secure
requests so if we look again at the
network tab where is it here you can see
obviously didn't load because the image
doesn't exist but the browser made a
HTTP request so the upgrade insecure
taxes the browser's coming through and
rendering the page okay we need to go
fetch this image abba wait
it's on HTTP and he said upgrading
secure request make a HTTP request
instead and this is a simple as CSP
needs to be and I also mentioned the
form action one so I do have a form
embedded in this page we can take a look
at this here
so again
doesn't matter how it got there might
have been put there by accident could be
an attack but we don't care there was a
valid form in this page and it's going
to post surf a file called steal
password dot PHP hosted on evil com so
I'm actually I'm gonna do this I'm gonna
put a real username and password in here
don't try this at home folks so in most
normal scenarios if I was to hit submit
here would we all agree that the browser
should fire a form a post request at the
endpoint specified getting nuts okay no
one disagrees that's good so note that
we've got two areas in the console I hit
submit
obviously one password asked me to save
it I don't want to
if we come back down to the console now
the browser is saying I refuse to send
form data to evil calm slash deal
password because it violates the
following content security policy
directive and I have form action self
because if a formally submitted on my
website there's only one place on this
whole planet that I want not to be sent
to and the question that you have to ask
is if I have a form on my website do I
want it to go anywhere else when it
submits and hopefully the answer is no
but even if it's yes you just specify
those in your form action so you say
okay forms can post to me and it's one
of the location or these two of the
locations but you get to control that
and this is really powerful because you
can start to protect your users using
these mechanisms but also you're kind of
protecting yourself yes the user would
have lost their credentials here but if
this happens on one of the services that
I run we also don't look great as a
service provider so these things will
help you protect your data and make sure
that it stays within the locations and
the places that it should now for all of
those things that happened I also
mentioned CSP reporting and what you can
see down here is that every time
something on the page violates that
policy something that happens that
shouldn't have happened the browser will
send one of these post requests and the
address is whatever you specify in the
report URI directive and if we zip down
to the bottom and have a look here
you'll see that it was a post request
and this is the payload that the browser
sent so we get the we get the document
URI here which you can see is the
address of the page that we're currently
on so when you get this report you can
say okay on this particular page there
is a problem and you can see the problem
the one I'm looking at here effective
directive image source so already I know
there's an image on this page that
shouldn't be there or something was
wrong with it it tells you was the
policy enforced or are you in report
only mode if you're testing and then we
have the blocked URI what was the thing
that was trying to be loaded so you have
all of the information here from this
one single JSON payload that came to you
very post requests automatically from
the browser and then if you stand up a
service to collect these is a default
transparency this is my service
you can just collect those graph them
run stats on them monitor them and you
can do really cool things like checking
you know if you deploy into production
one day maybe a test asset sneaks into
production that shouldn't be there and
you'll see a huge spike in your report
and you'll be like wow okay there's
something pops up on this page on this
particular day that shouldn't be there
or maybe it's a genuine attack you know
anything that's there that shouldn't be
there or anything that happens that
shouldn't happen and the browser will
call back to you and it will tell you
automatically in real-time so this is
really handy I think it's fairly easy to
stand up these endpoints you know you
can use free services like us to do this
and you can monitor for many different
sites and you can see there it is so
that's the one from the demo that I just
gave you on the website on the page that
were on there was a forum action that
tried to post there so my browser has
sent that back to our service it was
processed and rendered into the
dashboard and I know if this was real I
have a really big problem in that
particular page and I can immediately go
fix that so reporting is hugely powerful
especially because you can deploy in
report only mode and test your policy
before you go live with it so there's no
reason to fear CSP you can deploy and be
completely safe and confident but there
are many other headers that we need to
talk about so I'm going to move on to
the next acronym in my slide title which
was X XP or the X XSS protection header
as it is commonly known now the access
header controls the auditor built into
browsers every browser has an auditor
inside it that will try and detect
attacks and issues on the page
specifically for cross-site scripting
and I'm not going to kind of get into a
discussion about which browser has the
best or the worst auditor I don't think
that'd be very professional of me so
we'll have a look at what X XP is and
again it's another security header you
deploy this on to your website as just a
standard HTTP response header and then
you put the policy that you want the
browser to use into the value of the
header itself now the good thing I like
about XP is that I can actually show you
on the slide all possible combinations
and values because it's very simple and
very easy to configure so the first one
is just zero
which tells the browser to turn off its
native defenses turn off the XSS auditor
don't try to help me leave me on my own
now that signs sounds kind of a bit
crazy and it's kind of a bit crazy
really there's very few websites that
I've seen out in the wild that actually
used its the most notable that I can
tell you is Facebook Facebook actually
disabled the browsers native defenses
because they are so confident in their
own abilities to mitigate these kinds of
attacks they don't want the browser to
try and help them and get something
wrong and we have seen it in the past
where attackers have tricked the auditor
into doing things that it shouldn't have
done because they made a mistake so if
you are a hundred percent confident in
your own defenses you can disable the
browsers native defenses but I wouldn't
recommend that the next policy value is
just one and what this says is turn on
the auditor and run the auditor to try
and detect things and help me and this
is actually the default value if you
don't specify the header from all of the
browsers that I see that have auditors
they will be enabled and try and do some
kind of protection by default so whether
or not you set it this is actually where
you are the next setting then is to take
things a little bit further and you can
configure it into what we call block
mode instead now when they seem just
mode one in the default mode the browser
will try and cut out malicious things
that it sees inside the page so if we
sees a script tag that it thinks is
hostile it will take out just that one
script tag and say okay I think I've
neutralized the threat you can have the
rest of the page I'm going to take this
one thing out but I can be abused and
utilized in different ways sometime when
you're in mode block if the browser
thinks there's a problem in the page or
some kind of attack it will just stop
the page from rendering and say look you
can't go to this page because there's
something wrong in it I found an attack
and the last value is actually just the
same as this but again a common theme
throughout this you can ask the browser
to send you reports if a user comes to
your website and their browser detects
that some kind of attack is taking place
and has to take action to save them
would you like to know about that and
hopefully the answer to that is yes and
the browser has these built-in reporting
mechanisms and they're free you don't
have to buy any software you have to
install anything you can
turn it on and say hey send me a report
when something bad happens pretty much
all browsers support this and the good
thing is even if all of them didn't if
one or two people report a problem on
your website you don't need everybody to
tell you you actually only need one
person to tell you so support is already
at the point where this is really useful
and these reporting mechanisms should be
utilized more than they are so again I
want to kind of show how these things
work so we're gonna do a quick demo for
xxp as well so I have a demo here if i
refresh this page we can see that there
is an alert on the page and this is
exactly as it should be we'll inspect
the source here and just take a quick
look at this script tag so you can see
there's a script sake I'll zoom in on
that for you there's a script tag here
that's been loaded and this is what pops
the alert so let's have a look at the
script tag you can see it's really
innocuous that's literally all it does
and it still says London cuz I gave this
talk a few weeks ago a few days ago
sorry in London and the access auditor
is configured in the default mode here
and what I want to demonstrate is how
the auditor can actually be tricked so
if I take this script tag I'm going to
take a copy of the actual script tag
itself what I'm going to do I'm gonna
come up here I'm just going to make up a
get parameter and set the value of that
get parameter to the script tag itself
should this change anything when I
submit this do we think there will be
any different behavior on the page so
I'm gonna submit that and the page is
now reloaded I'll do that again command
R reload the page where's my alert now
you may have noticed as an error has
popped up in the console and we'll go
take a look at that and it says here the
XSS auditor has refused to execute a
script in this page because it violates
because the source code was found within
the request so what this means here what
what the browser things is happening
because I passed that script tag in the
request and the browser knows that
the browser then got the response from
the server and it saw an exact copy of
the script tagging the request in the
page so the browser now thinks that
because you've put it in the URL the
server has as a result put it in the
page so I want to take that out because
this is a cross-site scripting attack
and we tricked the auditor into doing
something we tricked the auditor into
removing something from the page and you
can do this on any side with any script
tag in it go to a website look at the
source code find a script tag and put it
in the URL as a get parameter and reload
the page and the browser will strip that
script out of the page and then you have
to start thinking well what does that
script do what I was it there is it
useful should the attacker be able to
filter those things out of the page
itself and this is why I'm not familiar
I'm not fond sorry of the of the default
mode this page here is exactly the same
page except I have the order to
configured to block mode just so you can
see what happens so same page we get the
same JavaScript alert and I'm gonna go
grab a copy of that script so we can see
it so an area down here here we go
anyway so let's take a look at that
we've got the script tag I'm gonna do
the same thing
copy the element let me go up to the top
make up any get primary two again the
server he's not expecting like a
particular get parameter you can just
type anything in there copy paste except
this time page hasn't loaded because
we're now in block mode so the browser
has detected the same issue the script
tag went in the get request and it came
back in the page we think this is an
attack except now assuming again so you
can see down here they saying the page
load was blocked by the XSS auditor and
this is the difference between the two
modes one in default mode will just take
the script tag out let the rest of the
page load in block mode it will throw
out this error messages and say well
look there's something wrong with page
so let's just rather than try and fix it
and maybe do the wrong thing let's just
stop here and we'll send a report so
that's the XSS auditor and I think the
biggest reason that I recommend setting
this is that I don't think we should use
default modes and default settings
because those defaults
they also be different across different
browser vendors so even if you want to
set the default value we should be
explicit about that we should say look
we've made an informed decision we're
going to set this header and this is our
configuration don't depend on the
default and the default may change the
default action in one browser may be
default it may be different to the
default action in another browser as
well so I think we should be explicit
about how how we do these things in how
we use these different technologies so
that was xxp and the next acronym from
my slide title was STS and again this is
another HTTP response header there are a
lot of these that you can use and strict
Transport Security is something that you
should absolutely be deploying if your
website looks like this so many websites
are moving to HTTPS now I regularly scan
the top 1 million websites on the planet
I scan them every day and I track
various different security metrics about
them and one of the things that I do
track is the percentage of the size that
redirect to HTTPS that force you on to
HTTPS when you arrive at them and the
interesting thing about this is not only
are we steadily increasing the amount of
sites that are on HTTPS we're actually
increasing the rate of adoption this
graph gets steeper as we go through time
so we're seeing HTTPS adopted across the
web right now a rate that we've never
seen before in history but most science
deploy HTTPS and then just stop there
and there's actually one more thing that
you need to do before you can say that
you are finished with your deployment
and it is to deploy strict Transport
Security we refer to its HSTs because
this is HTTP strict Transport Security
so STS is a wider range mechanism and
we're looking at specifically today in
the context of HTTP so standard browsing
scenario you open up your browser you
want to go to Twitter what do you type
in the address bar most people pretty
much everybody I know just types in
Twitter comm and hits the enter button
now the user didn't specify the scheme
but to make the request the browser
needs one and every single browser even
today right now on all of your devices
if you type in the domain without a
scheme will default to hate
ctp because that's the default protocol
of the web at one point it was the only
one that we had there was no other HTTP
didn't exist at one point so browsers
have always defaulted to that and they
still do to this day now that's not so
bad I guess because we'll send that HTTP
request to Twitter and Twitter they use
HTTP they of course will send a 301 byte
well send a redirect back and say hey
look we don't do this HTTP thing
please come back over HTTP the browser
will receive that redirect and then it
will do another request and follow the
location the only problem is we spend a
lot of our time in this conversation
talking over HTTP and one really crucial
thing came back to the browser over HTTP
and we have to remember HTTP is not
secure anything we do or say over HTTP
can be seen by an attacker can be
changed can be modified how important in
the upgrade process do we think that 301
is that 301 is our upgrade indicator
this is Twitter saying no go away come
back and do it securely how are we
sending that to the browser we're
sending that to the browser over HTTP if
we send over HTTP what does that mean
means it can be viewed means it can be
modified means it can be changed so we
already have a problem because we
started the conversation insecurely
meaning someone could meddle with our
communications so after that after that
first get request is send the game is up
because we can't ever rely on getting
the redirect back so what we end up with
there's a tool out there called SSL
strip and we end up in a situation where
the attacker Caesars make that HTTP GET
request and they just pretend to be
Twitter but then on the other side they
proxy our request to Twitter over HTTPS
to keep Twitter happy so because the
browser opened the conversation on HTTP
and never saw the 301 the browser
doesn't think there's a problem and as
far as Twitter is concerned the browser
is speaking HTTPS they don't know that
we're being proxied and neither does the
browser and this is a really big issue
because this is a trivial attack when
you open your browser and go to a
website we all know our 301 czar we all
know what redirects are they're there
for a reason but the attacker will seem
throw that away they're not gonna let
that come through because it will defeat
what they're there to do which is to spy
on us look at the things that we're
doing so to mitigate this this is really
simple this is a really simple attack to
launch well fortunately it's really
simple to fix as well and what we do is
we issue another security header and
this one is called strict Transport
Security so again just like all the
other headers you issue it and you put
the policy that you would like enforcing
inside the value of the header and again
the other thing that I like about SDS is
that it's really simple these are the
only possible different values that you
can configure the only directives that
exist and the only one that you actually
need is the max age
so that's the only required one for a
valid policy and this is the number of
seconds that the browser should cache
this policy for includes subdomains we
apply STS to a domain and you can also
include subdomains if you wish I'll talk
about pre-loading in just a second as
well so you want to issue this STS
policy the strict Transport Security
policy this is all you need for a valid
policy the max age and the number of
seconds you would like it caching for
once the browser has received this in
cached it it applies a really simple
mitigation to everything that I've just
talked about this tells the browser you
will never speak to me again
over HTTP for the duration that I have
set in the max age you're telling the
browser to default to HTTPS instead of
defaulting to http but not only that
it's actually a little bit more powerful
than that because now if the user opens
the browser and you actually type in
HTTP colon slash slash as the user the
browser will override you and that's a
really powerful thing to have we don't
often get to override user input in a
user agent if you click a link on
another website that links to your site
if that link says HTTP the browser will
say nope we're gonna do HTTPS instead
bookmarks are another common one people
made bookmarks a long time ago and they
stay HTTP the browser will force it to
be a secure connection so end up in a
situation like this using the same
example as before the user opens their
browser and types in twitter.com
historically the browser would have
defaulted to http but of course Twitter
do use eight
ts so the browser says no and the
browser will say no in any scenario that
it would do in secure communications it
doesn't matter whether it was a link of
bookmark whether you typed it or what
nothing that he's insecure will ever
leave that browser and go to Twitter the
browser instead rewrite the request as a
HTTP request and send it and what this
means is our whole conversation now
happens over HTTPS instead so we can
actually just throw away that HTTP
request because it's never even made it
no longer exists and not only that it's
not possible to make one you can't make
the browser do it so SCS is really
powerful and everybody has to use it
because that SSL stripping attack is so
simple and easy to do you go to all this
trouble of deploying HTTPS on your
website to keep your stuff private and
secure and attackers can get around that
quite easily actually
so this want to show again another quick
example of what this would look like how
that guy stops drilling soon so just
load up my page because I want to get
the dev tools open so let's have a look
at the network tab here and I'll
preserve the log so that we can scroll
through it I'm gonna go to a website
that I know works on HTTP a good old BBC
in the UK they still can't secure all
the things but I'm gonna sit right back
to the top here because we made a HTTP
request at the beginning so we sent the
HTTP request and they can and do so
securely now so they send us a 301 back
and they say no we don't want to do this
insecure thing anymore we would like you
to come back over HTTP but again the
location header here they have a nasty
redirect chain but it's happening over
HTTP so they've just sent us the
information to go secure over an
insecure Channel which means they would
never get to us if there was a hostile
bad guy on this Wi-Fi he would just
throw that away why am I gonna let them
go to HTTPS when I can't see what
they're doing then we'll just put a stop
to that thank you and then we'll keep
watching you on HTTP so eventually if we
follow through the redirect chain we do
finally get to a HTTPS page all
the redirects happen on HTTP and they're
pointless because HTTP is vulnerable so
if I clear this and again I'll preserve
the log and this time I'll go to my
website over HTTP and again no in the
address bar I'm specifically stating
HTTP here I'm the user I'm the boss I'm
asking my browser to do a specific thing
for me let's see what happens
so we've got our HTTP request at the
start as you would expect
it's requesting my home page on HTTP
except this time we've got a slightly
different outcome the status code here
is 307 and then it says internal
redirect now that's quite an odd one
because we'd normally expect a 301 or a
302 to come back here but if we look at
the 307 the reason that this happened
was because of HSTs I of course I'm a
security guy and if I didn't have this
everyone just yell at me on Twitter I of
course have HSTs setup on my site and
because the browser has remembered dice
forced the communications to be secure
so the browser actually redirects the
request internally it doesn't have to
send it to the network to the site to
get the redirect it already knows and
then if we look at the next request that
is the HTTP request to my home page now
that first redirect as well the other
thing I like about this is it's really
quick because that's an internal
redirect it takes like a fraction of a
microsecond if you were to go out over
the network and do that and come back
it's probably going to take in a region
of a hundred plus milliseconds so I also
just took a hundred to 200 milliseconds
off my page all the time by skipping out
on the redirect and I've just served one
must request because I didn't have to
answer the HTTP request either so
there's lots of benefits here there's
basically no reason if you're on HTTPS
already that you should not be using
this so that was STS and hopefully
everybody now kind of understands why
that's so important those attacks are so
trivial so easy to launch we have to
mitigate against them simple HTTP
response header will do that for you so
next up pkp was the next acronym in my
slide title in contrast although the
others pkp is actually quite
a complex mechanism in it protects
against a pretty big problem but it's a
lot it's a lot to get your head around
so let's see if we can do it when you
want to set up HTTPS on your website you
have to go to a certificate authority
and get a certificate so you go to your
CA you get a certificate you install
that on your website and then you get
green padlocks and all the pretty things
in the browser CAS have processes in
place when you approach them and ask for
a certificate they're supposed to check
that you actually own the domain that
you claim when I go and say hey I'm
Scott home doctor at UK and I'd like a
certificate they get me to prove my
identity I have to show them that I own
that domain
who here has perfect security nobody do
we think certificate authorities have
perfect security can they make mistakes
could they be tricked could they be
compromised from a security perspective
of course they come so on the screen
here what I have is one certificate that
is mine I obtained it and it's
legitimate and the other one is one that
an attacker obtained by tricking a CA
into believing that they were me which
is which and this is the problem right
if you can get a certificate for my
website as far as everybody in this room
is concerned you are then me and you can
prove that because you've got a
certificate and this is a bit of an
issue because now if I was PayPal calm
we have a real issue just you know it
was the one on the right nobody got it
so we can use pkp to defend against this
we call them rogue certificates when
someone gets a certificate that they
shouldn't have it's called a rogue sir
and pkp will protect against this and
again sorry for the common theme here
but it's another security header really
simple mechanism you turn it on you
issue the header and you put the policy
into the header that the browser will
enforce and again really simple pkp only
has three directives hopefully the max
age and include subdomains will be
familiar they're the same as what we
just had in STS the number of seconds
the browser should cache it for and
should we apply this to subdomains under
the current domain the pin value here is
the new one and you actually have to
have a minimum of two pin values in your
policy now what we do is when you deploy
HTTPS on your website you have to have
an encryption key on
so that's what we do the encryption with
so you take the hash of that key because
this is your key only you have it you
take the hash and you put it into the
first value of this header and say look
this is the sha-256 hash of the key that
I would like to pin the second one is
required because hopefully you have to
go offline somewhere generate a new key
and that's your backup so you take a
hash of that and you put that into the
second value and what you're saying to
the browser is look I have this one key
and I also have this other key which is
my backup and when you come back to my
website I should be using one of these
two keys check that they match this
because if an attacker compromises the
CA and managed to trick them they'll be
using their own key which is different
to mine and the hash values would not
match so we agree we're giving the
browns of the hash to check that I am
using the keys that are in my possession
when the browser comes back to my site
now for those of you slightly more
interested in the PKI
and kind of certificate side of things
the pin itself is actually the hash of
something we call the spki which is a
subject public key information we don't
need to worry too much about this unless
you're really deeply interested in the
PKI side of it but we hash a part of the
key itself and the other interesting
thing with pkp is if you do want to go
away and look at this the other thing to
consider is that you don't actually have
to pin your own keys if you don't want
to you can hand the responsibility over
to other certificates in the chain which
includes the intermediate and the root
certificate as well so if you don't want
to have to look after your own keys and
handle the rotation and the backups you
could pin at the intermediate and say
okay when you come back to my website
essentially what you're saying is this
should be the intermediate certificate
that is used so if the attacker goes and
compromises a different c CA so I'm
using less encrypt here let's say they
go compromised Verisign the browser will
come back and say well hanging up in it
this is the very science earth scott
only get certificates from let's encrypt
even though it's valid I'm not going to
accept it there's a lot of different
ways you can configure this and there
are a few more caviar so do you look up
into this if you want to go ahead and
deploy it now again this is a very
powerful mechanism you want to make
absolutely sure that your pin values are
right before
you deployed them because if they're
wrong you're gonna have some serious
problems so we have a report only
version of this header here is my policy
how does this look what would you do
would you turn off my website and block
everything or are we okay deploying
report on the mode and you get those
errors in the console if you don't want
to do that again we have another report
directive here they report your eye
directive and you can say look if you
come to my site there's a problem I want
you to call back and tell me about it
and you get a nice JSON payload and it
says look you've told me that you would
have these keys but instead I found
these ones so there's a problem now I'm
not going to demo pkp because if I demo
pkp I'd only have a couple of minutes to
do it and that's kind of like giving you
a two-minute tutorial on how to handle
weapons-grade plutonium it's really not
going to go that well so I'm gonna skip
over that if you do want to have a look
at pkp the way that you can tell whether
this is for you is to answer this
question if you could go to a
certificate authority and you could get
a certificate for any website on the
planet any domain who would you get a
certificate for so any song child what
would you get a cert for you can have
any certificate in the world for any
site that's one so one shout them out
why are they gonna be banks Google
Amazon PayPal Facebook if you are in
that list you don't need this this is a
really high value site government sites
financial sites for really big
organizations if someone compromises a
CA they're not gonna get a certificate
for you know Joe's pizza shop com they
you don't need that so that's the metric
by which I usually gauge whether or not
you need this now the last one on here
is CAA and the interesting thing with
CAS PK P's kind of falling out of favor
right now and I see pkp being replaced
by two other mechanisms of which CAA
is one of them is trying to address some
of the things that CAA addresses without
all of the risk of completely blowing up
your website so CAA controls who is
allowed to issue certificates for your
website you want to set up HTTPS you get
a cert and then you get the pretty green
padlock that we all won
now I only use one CA to get my
certificates on my website and that's C
I use let's encrypt and they issue free
certificates by the way so if you're
paying for these things you really don't
have to anymore but if somebody goes to
a different CA it could be anywhere in
the world the China post office is an
example is a CA for whatever reason if
somebody went to them and could trick
them into thinking that they were me
they would be issued a certificate for
my site and the problem is there's a lot
more than just my CA in the world
there's hundreds of these organizations
all around the planet so if you want a
certificate for my site you could come
over here and try this one I say okay
I'm Scott can i trick you no rats
okay next one let's go to this different
company and see if I can trick them to
give me one maybe these guys have got
bad security and we can hack them and
get in but the point is that any of
these organizations any of these CAS
around the world can issue certificates
for my site if they can be tricked or
compromised and what I is the domain
owner would like is a way to say look I
only want to get certificates from my
domain from this one place
nowhere else nobody else should be doing
this and that's what CAA gives you gives
you the ability to specify your
preference and we do that with a new DNS
record that has been created
specifically for this so hopefully
everybody is familiar with DNS records
we've got a records for our IP addresses
quad-a for ipv6 tax records there's a
whole bunch of different ones a new CA a
record was created just for this purpose
and what you can do is now specified the
CAS that you authorized to issue
certificates for your domain so we have
the issue directive and I put let's
encrypt org in that because I oughta
write them to issue certificates for me
I also authorize them to issue wild card
certificates for me and then really
nicely we have this io death reporting
directive and what this says is look if
someone comes to you and tries to get a
certificate for my domain and you reject
it please tell me please send me an
e-mail or you can put a URL and have
them post a record back to you and say
look if someone's out there trying to
get certificates for my domain I am
pretty sure that I would like to know
about that so do tell me
and that's all there is to CAA you
literally just create a DNS record so I
want to take a quick look at these as
well because it's really quite simple in
the thing I love about these mechanisms
is you don't have to buy specialist
software you have to install anything
we're talking about HTTP headers and DNS
records so Google has a dig tool here I
won't do this on the command line so
let's have a look I've got my a record
I've got my quad-a records and we
literally quite simply just have a new
type of DNS record so in here you can
see the one that I have set which is my
let's encrypt certificate I also use
cloud flyer for my DNS and as part of
their Universal SSL offering they also
whitelist their own CA so that if I need
they can obtain certificates so you can
see that now these for CAS are allowed
to issue standard certificates so that's
a certificate without a wild card entry
and these three CAS down here are
permitted to issue wild-card
certificates for my domain and that's it
if you now go to some other CA somewhere
and think right okay I want to see if I
can trick them to issue me a certificate
for Scott's ID and you go to them and
say right hi I'm Scott helm I'd like to
go through the process and get a
certificate last year's gonna look at
this and go nope I can't do it anyway so
why even start the process because I'm
not authorized to do so so they will
stop at that point
and what this means is that you
basically now if you want to get a
certain form I cite you would have to
attack one of those CAS on there and
they're very strong reputable and
hopefully secure c8 so you've reduced
the attack surface from the 200-plus in
the whole planet to just the ones that
you allow in your CAA
records if you want to generate these
records you can do it by hand but I
actually prefer this tool here it's
really kind of nice and simple dead easy
you come to the tool and whack in your
domain name so that's me and then you
just have a big list here of all the
different CAS that there are who would
you like to issue search for your
website so we'll go for a Mizzou oh
we'll go up a bypass there they're
Norwegian CA right yes they are aren't
they yeah so I'll let those guys do it
and when it's my favorite
now they are gotta have a bit less
encrypt in there if your light report
sent to you you can just specify your
address and then down here that's it
those are the records that you need to
set if you would like to have that
policy and force for you so now you just
need to go and create three six DNS
records and you're done and hopefully
setting a few DNS records is going to be
free for pretty much everybody out there
and I like these mechanisms they're a
really easy method to deploy there's
there's virtually no side effects of CAA
if you deploy CAA and it's wrong and it
breaks something you just remove the
record and it's fixed there's no long
lasting effect that was one of the
issues with pkp it has a max age it has
what we call the memory effect so if you
deploy PK pianist wrong you're stuck for
the length of max age if you deploy CAA
and it's wrong you just delete the
record and it's fixed so I like that
there's it doesn't offer quite the same
level of protection but there is also a
much much much lower level of risk so
let's jump back in here those are
hopefully the five acronyms from my talk
title that you didn't understand if you
don't understand the other four I can't
help you there's not much that we can do
here so a quick overview of these things
because there are quite a few little
kind of anecdotes that can help here a
lot one of the things that I see with
CSP is that people will look at a
website out there like mine or like
Twitter's Twitter has actually just
published an article about it twitter
has a quite large DSP and people will
look at that thing well we've got like
this massive big complicated policy now
that looks like a lot of hard work maybe
we won't do that
start with one feature of CSP look at
the features of CSP because there's more
than the ones that I talked about and
just look at the one that you think is
the nicest and just deploy that and
start with one a lot of people are put
off by like these huge big complex
policies you can work up to that over
the next year so don't look at it and
think you know it's too much it's too
complicated just start with upgrading
secure requests as an example maybe then
go to the forum action because that's
the next kind of most sensitive thing
you don't have to go from nothing to
crazy insane policy on your first
diploma
build it up over time as you gain
confidence do starting report on the
mode I will say that and also do use
reporting you know even if you'd only
use the service that we run it's not a
sales pitch stand up your own end point
to do this but I think it's really
important that you get that feedback
from the browser next up was xxp super
simple really easy the main thing with
that one there was just don't depend on
the default I think we should be
explicit in our configurations and you
should know what the browser will do in
certain situations and control that
again
there was another reporting mechanism
there at CES if your website is on HTTPS
and you're not using this you really
aren't done I hate to say that but
that's most websites out there they're
on HTTPS and that's a fairly low number
as it is the browser's even today in
2018 will default to the insecure
version to http all of the time STS will
force the browser to default to HTTPS
you'll cut out those three or ones
that's an extra round trip on the
network before your page loads make your
pages load faster less requests hit your
servers then the dark one pkp it's kind
of like a bit scary pkp as I said
there's a kind of falling out of grace a
little bit with the browsers now and
there's actually talks of chrome
abandoning this unfortunately HP KP is
widely referred to in the security
industry is the HP KP gone because
if you deploy this and you get it wrong
you can do some real harm to your
website essentially you'll just get a
big error message for the duration of
max age if you had max aged up to three
months and you've got it wrong your
website will not be accessible for three
months so I kind of see over the next
probably year June 2018
especially anyway pkp will probably be
replaced by one of two other things as I
said CAA was one of them this is
certificate authority authorization
that's those DNS records set those
records it's basically free like if
someone tells you they're setting a DNS
record is going to cost the organization
some kind of money there's probably
something else that you need to go fix
first so have a look at that take
control of it and you know this is your
site this is your domain you should have
the authority to say these are the
people allowed to issue search for my
domain hey they've got my name in them
for me take control of that specify who
you would like to have them and if you
are interested the other thing that I
see replacing pkp is something called CT
which is certificate transparency if you
haven't looked at certificate
transparency the deadline is coming
first of April this year so I highly
recommend you go and have a look at what
that is and it's also actually really
cool because you can look at every
certificate issue by a CA on the planet
and that's actually pretty interesting
so overall that the main purpose of
these mechanisms is security
they are security features they are you
know security oriented but there's a lot
more that they can do for us
things like CSP fixing week's content
sending us reports when stuff on our
site is broken STS fixing the need for
three are ones there's a lot more above
you know kind of what I've talked about
here as well as I said these are
probably best thought of as lightning
talks introductions to these
technologies look at these and think you
know is this one of a particular
interest in my organization maybe
there's only two things on here that
you'll take away and deploy but my hope
was to introduce you to them and at
least make people more aware of the
things that are out there to help us
thank you very much
so I did leave three minutes do I still
have them I do
questions yes so if what kind of
scenario ie
you'd kind of forget it Runkle wanted to
remove them or you're a bad guy trying
to get in okay so the question there was
the max age values set in SDS mpg ap the
browser remembers those for the duration
specified is there any way to change
that maybe force them out or remove them
kind of thing so we have seen a couple
of attacks they were kind of late last
year actually where I think it was
Firefox would only store a maximum
number of domains in the HP KP cache and
what the attackers did was they had a
piece of script that would load
subdomains on a domain they controlled
and keep setting these policies and the
idea was they push all of the legitimate
and she's out of the bottom so there's
always going to be kind of like novel
ways that people can break these things
and undo what they're there to do but
from a general point outside of some
kind of novel attack like that know that
they're pretty much in there you know
you'd have to have physical access and
admin on the machine to wipe the local
cache and get rid of that it really
depends so again the question now is you
know if you run something like ccleaner
or a tool that will wipe tempra caches
it really depends on the browser and the
platform because they all operate in
different ways and they all store the
the cache information in different
locations some of them yes would be
wiped by things like ccleaner if you
completely purged the applications
temporary storage so again it depends on
the browser and it depends on the
underlying platform question
okay okay so the question there was
obviously CSP we have this lovely config
and we must deliver that to the browser
we must deliver the policy essentially
kind of how do we look after that make
sure it's not manipulated to do bad
things what I would say there is that
CSP reporting it was on the slide and
you can go back and catch this I'll make
them available after CSP reporting when
the report comes back to you it includes
the original policy that the browser
received so what you could possibly do
there is on your inbound reports look at
what the browser said 'i got and and you
can then say well okay this is what the
browser received is that what i thought
i send so yeah you can kind of integrity
check you deliver the policy out and
then when it comes back in you can see
was the browser working with what i send
and if it wasn't then maybe someones
misconfigured it maybe something added
they'll change something that they
shouldn't so you could monitor that on
an ongoing basis with that yes okay so
yeah if someone had manipulated it and
added like evil.com and loaded one
script from there that script wouldn't
trigger it bought any other report would
also contain the original policy so
unless and it's virtually impossible to
have a perfect CSP I don't have one even
Troy doesn't have one so you would get
reports that would contain the original
policy value so could they change the
report URI if it really depends where
you set the header there's a many
different places that we can set headers
you can set a header in your application
code in PHP we have the add header call
you could set a header in server config
so if you're setting your CSP in server
config and your WordPress installation
goes parked they can't change that
because it's further down so it really
depends if you're setting this in server
config and someone has the
to change server config they probably
shelled your box and you're screwed
anyway and I can't help you with CSP so
it is it's hard to answer because it
really depends on how deeply you're
compromised questions yes what's the
adoption of CAA I actually started
scanning this in my daily top 1 million
crawl I think was like 12 people yes so
actually so the question was what's the
adoption of CAA and there's about 12
different websites then the next
question was which CAS actually all CAS
have been mandated to respect CAA
records since the 7th of September last
year their governing body called the cab
forum have mandated that they must all
respect that and if the CA issues in
breach of CA a they could be penalized
for that there was one more thing we
have time for yes yes is what sorry so
which one specifically something like ma
staple yes a revocation is still broken
completely unfortunately so we're hoping
that most staple might fix that Firefox
currently has support no other browser
does but the biggest concern is that if
you turn on if you obtain a most staple
certificate and then you're stapling
implementation is wrong your website
stops working and right now it's like
the one thing that is is good i stapling
sorry i always said that because it's a
Microsoft employee in the room so Apache
and nginx do have some problems with
their stapling implementations and I
think once we see those patched more
widely and more reliable implementations
of stapling will probably see browser
support increased for that but chromium
are actually holding back on it now
because they don't think the wider
ecosystem is ready but that is time
everyone sorry see if there are more
questions I'm hanging around please do
come and find me thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>