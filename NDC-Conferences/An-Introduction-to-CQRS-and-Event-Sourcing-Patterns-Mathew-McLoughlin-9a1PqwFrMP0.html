<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>An Introduction to CQRS and Event Sourcing Patterns - Mathew McLoughlin | Coder Coacher - Coaching Coders</title><meta content="An Introduction to CQRS and Event Sourcing Patterns - Mathew McLoughlin - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>An Introduction to CQRS and Event Sourcing Patterns - Mathew McLoughlin</b></h2><h5 class="post__date">2017-02-16</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/9a1PqwFrMP0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">ready to slap okay okay so first of all
I'd like to welcome everybody in the
audience a pass from one person to the
talk my name is Matt mcLaughlin I'm here
to talk about something called secrets
and event something I just want to make
a couple points up front for those
you've seen these two terms you've
probably also seen them in conjunction
with another term sheet EDD automative
indesign not really going to be covering
that much in this salt I'm just going to
really focus on sea curtain and then
sourcing another point to make is that I
bought a surface book about two weeks
ago now I don't know if you guys have
seen them with the pens and everything
so far hey it'd be great a deal
hand-drawn my slides would be a lot
quicker it's really not a single edited
or I must have written this single slide
maybe 20 times for ago right also turns
out go horrendous handwriting also turns
out I've got a render spelling and no
spell checker so if there's any spelling
mistakes I think there may be a couple I
apologize in advance but yeah so it's my
talk I want to talk about secrets and
event sourcing why this talk well I've
been working in fully or partially
event-driven events all systems for a
few years now and then over that time of
status see they've become more popular
and more people become interested in it
sharing is pretty apparent by the number
of people who turn up to this room which
is kind of daunting but there we go and
I wanted to give a talk but kind of goes
over the basic principles of these two
ideas and talks about can I have a base
level architecture but you can build
using these two design patterns too so
you can go away and start building this
stuff yourself and also since I've kind
of got into this when I see new people
come along the most commonly asked
question is what framework can I use or
framework there's out there to build
these kind of applications and there
isn't really one out there and if there
is it's not particularly good and quite
frankly you don't need it but principles
are pretty simple and once
actually start a rider stuff yourself
you realize it doesn't pay up and
worship your codebase I mean I will blue
into the basic example in a few hundred
lines of code at most so looking for an
architecture probably not worth it
better to write it yourself when you
understand it better so what are we
going to cover well first I want to talk
a little bit about events awesome and
the theories and the ideas behind vadym
white goods right a good thing to do in
wage that language is lie then I'm going
to talk about CQRS and how that works
and the advantages of that brings then
I'm going to talk a little bit about how
the two interact together will then go
on to look at a typical architecture but
you'll you'll see time and time again
and then hopefully successfully well
I'll demo some code which will kind of
give you a little bit of an idea of how
you can go ahead and build these things
hopefully that'll work we'll see most of
the codes gonna be written in C sharp
and it translates well to most other
languages so shall I'll be fine
now currently I work in the north of
England she comes out by Max and round
bat leads Yorkshire and and I work for
the Leeds NHS trust release trust and we
have this idea of something called an
encounter or an episode which basically
it deals with a patient's journey
through the hospital so it deals with
when they get admitted and how they get
admitted which was they get transferred
to which doctors they see potentially
and also and hopefully when they get
discharged all right so that's kind of
the domain the small section of the
domain but I'm going to be using 4 as an
example throughout this talk so just an
explaining right up front so events
asking who said of it
ok fair enough that's got a lot of
people that's good the basic idea band
events the events all seems pretty basic
idea Eddie start and if you if you ever
seen any of Greg Young's talks you'll
know he's been around for quite a long
time in other industries it's only been
recently but we've really started
playing it with an hour
and if this very basic nature's just a
different way of starring the
information within your system in a
traditional application you normally end
up with something like this you may end
up with a and encounter object which is
like I say what we're going to be
talking about and upon that object
you'll have a number of methods you'll
have one to admit the patient wants to
transfer the patient and want to
discharge the patient you may have one
you will have mark and each time you
attempt to execute one of these commands
if it passes a business validation it
will result in you starting some state
in the database are some documents start
right so if you look at this example we
can see in the first instance we admit
the patient we've committed a gentleman
called Tony Ferguson toward 10:00 and
then we had mr. Flagg accept true when
we transfer them we vent update the ward
we've moved toward 76 when we transfer
him again to what's very far finally
when it comes to discharging them but no
other awards that we set out to null and
say is admitted is false events often
works in a slightly different way in
route rather than continually updating
the states what you actually do is you
star the events that are the result of
that command being executed so again
looking on the right hand side you can
see when the patient's been admitted
when you have met the patient you can
see the patient admitted event when you
transfer the patient you can see the two
corresponding patient transferred events
and finally at the end you can see the
patient is being discharged a couple of
things to note here
it's common practice to refer to the
events in past tense because once the
event has been generated then it's
already happened so it's just a good
naming convention also it's often the
practice to just store the information
relating to that event with the event as
close to siren the entire object every
single time so yeah so that's the idea
behind it incidentally would be an
original way building if you you often
don't actually end up with admit patient
and transfer patient and patient
normally end up with a method called
update patient so it tries to do
everything I don't know why it is that
in this industry we seem to
limited ourselves are just using get
create update and read as number of
events yes so for each of you encounters
we star a number of events are relating
to history about encounter and if we do
this we use this technique for all the
objects within our system we end up with
the stream of events to go back to the
point in which we which in which a
system was created so you end up with
something looking a little bit like this
now this isn't relating to a domain but
this is a piece of software called event
star which is a persistence mechanism
purposely built to start event and you
can see here it's obviously relating to
some fraud checking software and you've
got a number of events that happened
over time to a number of different
objects right so you end up with a
stream of events but why do you want to
do this why do you want to go to the
effort of storing the events for a
mistake because it does take a little
bit longer it takes more time and
Marines one of there's a number of
domain-driven design reasons why you
want to do this it's useful to think
about your system as a series of events
in certain situations but it also brings
with it a couple of technical reasons
why it's good and the first one and one
of them the primary reasons is around
auditing so if you think back to this
example we had which is patient admitted
transfer twice and then being discharged
if we only ever star the states will
lose the record we lose the fact that
they've been there on what 10 whereas we
store all the events that have happened
then we'll have that information forever
in this stream of events that we've got
within our system there are other ways
to do it who's done this as a method of
auditing tables I'm pretty certain not
everybody who's done inputting a handle
right now because I know I've done this
and I've either been using database
triggers which is potentially the most
evil evil thing ever so the idea with
this is that each time the patient is
updated you take a record of you record
the original record and then insert or
update a new one often in some other
patient audit tables are the like Navis
our local work has a number of problems
firstly you're starring a lot of
information if it's not necessarily
important so say for example when you
change your wad you don't really want to
be duplicating the record so although
space isn't often a premium it makes
sense to just kind of remove that
information also to actually work out
what has changed you end up comparing
you grow to one below it see which
values have changed that can be quite a
tricky process and also because this
happens after the fact after and because
this happens after the patient is
actually being inserted you can never
really be sure that it's right it might
be the triggers fails and as you move
the trigger it's not reliable and
finally and probably most importantly is
that although this will tell you what
information has changed it doesn't tell
you why it's changed you know it could
be number Suri's numerous reasons why
the wards they move rods if you start
with events you stole why it happened
and what happened oh sorry what happened
more changed and when it comes to
getting audit I'll just advise there's
quite a powerful things because the
first thing you get asked is well why is
that change and if you just star in for
an ordeal anguishing you've got no real
no way of knowing or maybe going back to
some transaction logs are or
interrogating some web api logs or
something like that so that's fine we've
got the idea we start of extremely
events as opposed to just updating the
state but how does that actually work in
the code so in order to be able to make
a business decision to be able to
validate something on the object you
need to have you still need to have it
at its current state right in order to
do that you need to within events our
system you need to replay the events
against that object so in the case of a
patient has been admitted that's pretty
simple it's the start of a the encounter
so we just saved that single event when
we want to transfer the patient well we
want to make sure they're admitted first
so in order to check that we have to
replay the patient admitted events and
then we can attempt to transfer the
patient equally with a second one you
pay replay the patient admitted patient
transfer them and try and transfer them
again
and then finally when it comes to
discharging the patient we play the
first three events and then you can
attempt to buy the patient discharged
event on the end of it now this does
actually bring with it a number of
problems which are pretty apparent
really is that if every time you want to
look at the subject you need to replay
all the events that's going to get quite
expensive now for the purpose of just
updating the encounter that's not so bad
because most systems are 20% right Apes
and read and also you're only working
with a single encounter now if your boss
comes along and says up which is a
typical requirement I want to see other
patients and which words they're on
doing it this way would require you to
pull out every encounter replay all the
events that I've ever very existed
against those encounters google them
together in towards and return them as a
view back to the to be user to the
customer which is not very efficient is
it takes a long time and that is where
speak to our S comes in two things now
see QRS is kind of an extension upon a
an idea by virtual michael cqs which is
command query separation and that's the
whole idea that a method should only
have been responsible for executing a
command against an object or it we
should be responsible for treating
information from real objects you should
never do both that makes a lot of sense
because if you have another method that
queries of data and also changes it as
it's coming out well I mean that's going
to be an absolute nightmare to debug or
manage especially if it's a third party
API that's happening behind the scenes
and it has done in the past for me that
can be incredibly confusing to the book
so CQ IRS which stands for command query
responsibility separation or segregation
I can never remember which one it is
takes that a step further and it says
that you should have a separate object
for your commands and a separate object
for your queries okay and when you think
about events else in that make sense
you've created this object that's great
for writing it's perfect for writing but
it's absolutely horrendous or reading
for querying so it makes sense to look
at creating a new model
to view and you've probably done this
before anyway if any of you ever used
entity framework for writing information
to the database and then maybe use SQL
view for reading from a database so it's
the same sort of idea but when it comes
to events arseling it does work with
really well with CQRS because you can
actually make use of those events to
generate your read models so these are
the events that we had earlier in the
system
we've got patient admitted patient
transfers concert again and patient
discharged right there's no reason why
we've in your system you can't build a
mechanism but when it sees this event it
can be used to insert a record in a row
so then back to a previous example we
want to see every patient on every ward
when a patient gets admitted we can add
a row to the table on the document star
whatever you choose same with Toni
Ferguson's been admitted when it sees a
patient transferred and then there's no
reason why we can't use that find it and
build a mechanism will then update the
ward similarly with the second time or
gate what's very far and finally when it
comes to discharging the patient we can
actually just delete a record from the
table because we've got it in revenge
stream right mark them and not we'd end
up doing something like a softie league
right it is admitted false we don't need
to do that it's in the stream so it's
very powerful thing right to be able to
build these views off the events now
when you brain starts to go to that area
and you start thinking that right I've
now got a right model and I've got a
read model the next logical step is to
say well why can't I just create
multiple read models right you know
where they want to see this data in
multiple different formats multiple
different projections in different parts
of a system why can't I just look of a
patient admitted event and use that to
generate two views so on the Left we've
got a ward view which shows the patients
on the ward on the right with other
demographics maybe shows the ages of
all the patients that have been through
the hospital okay
now combining these two things is
incredibly powerful because building
your event air your projections of the
data from your events allows you to do a
number of different things firstly if
for some reason your ward view gets
defunct
it becomes corrupted information it is
wrong maybe you've introduced a bug if
there's nothing stopping you from just
deleting all the information within your
ward view fixing the bug and then just
replaying all the events within the
system against that world view and
building it again from scratch all right
so that's incredibly good for fixing
bugs it's incredibly helpful also
there's often the situation where
somebody will say okay that's great Book
Award view but what was it like last
week so in that situation you could have
it to create a new view and replay all
the events up to and including last week
and then you'll have your word view as
it is as if it was two weeks ago what
week ago and finally and this one has
helped me numerous times in the past is
excuse me so often is the case that you
have a system in production and your
boss comes along and says yeah it's
great I'm happy but I want to see the
demographics now you haven't build this
report it doesn't exist I won't see the
demographics of everybody's being true
because again because you've got a red
event stream there's nothing stopping
you at a later point in time building
this demographics view replaying all the
events again in your system against it
and it'll be as if it is there since the
beginning of time which is great now
that saved my bacon
numerous times so you can literally go
well not crazy but you know build a such
specific views of the information you
don't have to be generic about these
things at all if you've got an index
page you can build a projection for the
index page a detail page it requires
more information so you can have a view
for the details page it really is quite
powerful so that's kind of how CQRS and
then sourcing load together right
so the next step but I want to go on to
he's talking a little bit about how the
architecture actually looks for these
things it looks with these things my
drawing is really horrendous so there's
multiple derivatives of this kind of
architecture but essentially we all end
up looking pretty much language people
customize the ideas for different
situations but essentially you'll have a
client which is some kind of web api or
a mobile app lying WinForms if you're
unlucky anyone some developers know we
spend a hand-up I live in alright we've
also moved on developers sorry guys it's
unlucky yes so with your client be an
MVC application whatever issues commands
which go through a bit of a pipeline and
interact with your domain your domain
when produces a number of events but get
saved against an event star then you
have a projection manager really don't
like using the term manager I think it's
too generic but whatever it's gone with
it on this one which then tells gets
which projections you're interested in
those events and then produces some view
which one can be read or queried by your
client so to go into in a little bit
more detail we saw and saw we admit
patient commander earlier on now
although this patent isn't really part
of event sourcing and CQRS when you
start thinking about your system as a
series of events it also makes sense to
start thinking about the commands which
generate those events so this is a
little panel you see off quite lock
which is dispatcher it's kind of a
mediator pattern and basically you have
an emit patient command which says what
I want to do and provides information
but it needs to do it but dispatcher
will then say okay I've got an admit
patient command which Ambler do I need
to process this command so in this case
it looks over the admit handler we said
admit handle have been
I needs to interact with the encounter
right so we encounters got a couple of
responsibilities a few responsibilities
the first thing is it needs to be able
to star a list of events that it
produces so if you execute a command
against that encounter it needs to be
able to star be event that gets
generated as a byproduct of it it also
needs to be able to keep a record of its
version which I'll come back to in a
second and it also needs the ability to
apply any events that are already in the
system so if you start free fr event
sorry again sees countering needs the
ability as we showed in previous slides
to be able to rebuild itself from those
events now the reason the version is
important is to do with concurrency
problems so imagine a situation where
two users both access the same encounter
at the same time these encounters have
already had five events applied against
him so we're both at version 5 the first
user executed the command against it it
generates a new event anybody attempted
to save it back to the database to the
event saw and it says ok I'm version 5 I
expect the next version to be version 6
and he says yes next version I expect it
to be version 6 year ok you can save the
second encounter which is currently
still in progress when he then tries to
save the to the event star it goes I
expect the next version to be 6 but it's
now 7 so a throw an exception and you
can bubble that back up to your user and
handle a however your business sees that
it might be that you just get them to
retry the command or give them an error
message or whatever works ok so that's
why the versions important so we've now
got a series of events in our repository
our in our event star the next thing we
need to do is actually start to generate
the view from these events right because
as we've said those models aren't great
for query in so not dissimilar to the
way the the command mediator works is
that we have a patient admitted event
comes into the system a projection
manager will then figure
which projections care about that event
and then it will give them at events
that what view projection as it is here
will then process that event and
generate or update the live you there's
another concept it's important to take
note of here which is checkpoint in now
there is a very good strong possibility
that your application is going to fail
it's going to you know it's going to
grow up it's going to crash at some
point when you start up your application
again the last thing you want to do is
start from the beginning of time and go
through all your events again
so the idea here is that every time you
process event you just mark a checkpoint
off somewhere so in your application
crashes means that it again it will
start from where it left off okay now
we're is still a bit of a problem with
this architecture and that is the fact
that if you start building your
application like this and a user comes
to interact with it and they issue a
command to and admit the patient they
then have to wait for all the events to
replay then it flies an event on top of
it which one gets saved to the event
star you then have to wait for what we
have now potentially tens of different
views to get updated before it can been
returned that this command has been
successful that can be quite slow can
make the application quite unresponsive
so there is the option to take this
projection management and push it off
into into a different process be that
Windows service or a console application
or something simple like that and how
about process the events on its own
independently well that does bring a
problem with it which is this word to it
eventual consistency I think I've spell
it right yeah anybody okay and the idea
is as it says that your system will
eventually be consistent but it's not
guaranteed to be consistent any point in
time because you're processing these
events in a separate thread it does lead
you to the possibility that when a user
issues of command you then now returned
successful when the event has been saved
because the events getting processed in
a separate Fred's paper they never think
it's been successful but then they try
and look for that information it may not
be there yet because it still hasn't
processed in all the views this is kind
of a scary term to a lot of people they
get worried about this and especially if
you talk to front-end developers they
don't like the idea but when you issue a
command the views not very instantly
right realistically in most systems the
time it takes to process an event is
minimal I mean in our system it's it's
under a second so the chances of it
happening out pretty slim but it's just
something to be aware of and it can
catch people out and as an industry
we've almost like we've read people to
think that as soon as they issue a
command that it propagates out across
the world and everybody has that result
instantly and when it is slightly
something we've been forced upon
ourselves when it doesn't happen using a
little bit confused in actual fact if
you go back to paper-based systems the
eventual consistency was days and that
before the farm got taken down we offer
to an office Tamara down the corridor or
what have you so it's just something to
bear in mind and it does catch a lot of
people out okay this is the scary part
cuz I do a demo okay now I say this in
every single one of my talks because I'm
always nervous but if you have been in a
situation where you're sat in your
office and you're happily typing away
you get on with your work and also a new
colleague will come up and stand on your
shoulder not actually literally standing
shoulder that'd be a bit crazy but
stands behind you and all of a sudden
you completely lose the ability to type
you think instead of sausages right in
fact you've never used to keyboard
before in your entire life okay
standing opens on stage in front of all
you guys and doing this is like that
times 100 okay so I'm going to make a
lot of mistakes but hopefully we'll get
through it and I won't make too much of
a fool of myself okay so
can everybody see that that's great okay
it's a little bit small but increase the
font size
hopefully that's okay um so my solution
I've got three separate projects I've
got a patient management project which
apologize again it's pretty small as it
contains the admission and discharge
transfer namespace which contains all of
my business logic and then it's got the
framework which saw the infrastructural
code around this these architectures I
then got a separate projection manager
this is a bit as I mentioned earlier but
it's responsible for taking these events
during the event star and generating a
number of views from back of it off the
back of it and then finally the bottom
there is a very very small looking test
console which just attempts to admit a
patient transfer him a couple of times
and then discharge him so let's start by
looking at a command now is that better
can people see that at the back yeah not
great so this is the admit patient
command that I talked about in the Kin
the insides 8 he says what it's going to
attempt to do and it also contains the
information required to do it so I've
got a patient ID the patient name their
aging years the time of admission and
wad numbers I'm also using a constructor
to create this it turns out that they're
not just for dependency injection you
can actually use them to make sure that
your objects in a valid State it turns
out I was pretty useful um sorry
annoyance of mine so we've got this
admit patient command we vent need to
handle this and if we come into the
handlers you'll see we've got two
handlers here we've got one for
admitting the patient and we've got one
for discharging the patient in the first
case I mean the patient is a start to
encounter so we use the constructor to
create that and in the when it comes to
discharging the patient we have to get
the
encounter out of the star so we actually
look on this method here will see that
when retrieving an encounter the first
thing we do is we create an instance of
it you then get all the events that have
ever existed for that encounter based
upon the type of object that it is and
the ID and then for each of those events
that we've retrieved we're gonna try to
apply it to the encounter so that's the
whole idea of rebuilding the account of
current state so that it can be worked
with okay then when we've done that we
clear all the events and we return the
aggregate the next thing we do is then
we try and execute a command against the
aggregate against the encounter so if we
go in here you can see that we need to
discharge the patient first thing we
need to do is chamber admit to this and
not admitted can't really discharge them
if that's successful
well we raise the patient discharge
event the only information we need in
there is the ID because I see on the
Finglas relevant I mean okay so it might
be a case that into my advanced system
we have the time they would discharge
the other reason we were discharged but
over moment we've only got the ID okay
so we generate by a new event and when
it comes to actually saving the event
again as explained in the slides we pull
all the events out of this bit result I
haven't explained this is the term
aggregate root which comes from the main
driven design it's not so much relevant
here the actual naming of this but as it
says it's a route to an aggregate but
anyway we get the events out of the the
aggregate root in this case encounter
convert them to a suitable format and
then we save them back to the stream and
you'll notice on the end here we also
pass in the version when the saving the
stream so we know that nobody's updated
it in the time that is taken us to
execute the command
okay so this is great we've got the
admit patient with other discharge
patient but we don't have the cancer so
let's create that now so where I'm
attempting to type so we want to
register a handler to transfer patient
we accept the command
and then close it off if you've already
made a mistake
yep
very good caecilius hand
okay so when we transfer a patient the
first thing we need to do is you need to
get the encounter now the system so we
get it from repository we get it by the
ID of a patient then we need to execute
a transfer command against it and we
need to give it the ward number
Excel then the last thing we need to do
as below is save we encounter back to
the system right make sense need some
knobs okay good so let's create the
transfer command I'll transfer the meta
craft
and you guys usually schiappa in videos
video I literally couldn't couldn't use
it without so if any of you guys use
righty yet by the way all right so I was
going to give this demonstration in
writer but it just turns out with the
current license expires today and when
it expires it's not like I won't let you
log back in it literally go shuts you
straight down there and then so I just
add horace thoughts that you know I
protected away and all of a sudden nope
you're done so unfortunately I switch
back to visual studio so we can serve a
patient first we need to do is make sure
we were admitted so check patient is
admitted how many four admitted then we
need to raise an event or patient
classes all right and we give it the ID
of a patient and the ward they've been
transferred to
renewing that okay so it's pretty clear
we've got a handle if it handles that
event when it comes in we check the
patient is admitted if it's if it's
emitted if they are that is pretty
simple raising you event which can then
be saved back to the event star we also
need to be able to handle the fact that
this we all need to rebuild this object
using that event now so we need to
create an additional method that does
handle that so we can say when the
patient is transferred you want to send
reward equal to the ward number so all
happen now try to put it with the others
okay is that when we rebuild this object
whenever it sees a patient admitted
event it will call into this miss boat
method whenever it sees a patient
discharged event will call into his
method when it sees a transferred event
it will call into this method and
gradually build the object back up to
its current state just need to register
it at the top as well
right that's pretty much it buffer goes
on in the background so say for example
these patient discharged and transfers
events when I'm calling Miss register
method I'm building up a map of the
event to the when method that it needs
to call so that's just my way of linking
it up so that when I see those events I
know which method to call it will show
up so in here when the register method
is called all I'm doing is adding an
item to a dictionary which is type of T
which is a command and then a little
delta method that actually executes that
okay so that's kind of how the command
side of it works let's have a look of a
projection side of it so if we look in
the main program it was a bit of setup
around here most of its not important
the bits that are important are creating
a new projection manager where I
question a couple of dependencies along
with all the projections that I actually
want my my manager to run right so here
I've got a wide view projection and if
we take a look at that we can see that
we've got a number of handlers again
slightly command analyst but in this
case we're handling events we've got one
that handles the patient being admitted
got another one which handles the
patient can transfer them finally when
they get discharged we actually have a
look at the code in one of these so
let's take the admitted event we're
basically saying when we see this
patient admitted event we want to
connect to in this case Raven DB and
insert a new patient into the ward view
and then save the changes at the end
when it comes to the patient transferred
in this situation we want to load the
patient out of the database how to Raven
DB change the warden number name and
save it back and finally when we get
discharged we load the patient out and
we when delete them
unfortunately there's there's no easy
way I don't think of deleting your
records from Raven DB without loading it
first there we go maybe something I know
and that's kind of how a basically how a
projection works this is those events
passes them off to the right place and
off it goes to actually look at the
projection manager when we start our
individual projections so this method
here you can see the first thing it does
is it gets to the last position but it
was at and then subscribe to all these
events from that checkpoint and when he
actually processes the events here the
first thing it does is he checks that
the projection can handle that event
puts it in a suitable format and handles
it and then at the very end as I
mentioned in besides it'll dates the
projection to make sure but when we
restart the application it's not an
invalid it starts from a correct place
so we set this running firstly so with a
little web application here which is got
a couple of pages on it the wide view
we've talked about that throughout the
talk it's set this running
because across history works not nervous
okay so acceded the event style with a
number of events which is now processing
through visa all the patient admission
events if we go back and refresh the
wallplate Ward view you can see you can
see that he started to admit all
patients to what so this is replayed all
the events through time but we've had
within our system it's not currently
correct because I've only played through
about half of the events right as you
can see here we've now hit a patient
transferred event so it drops in and
attempts to it will attempt to update
one of the warden was so we move up and
keep going and eventually so working on
the transfers
I think added too many in here please
appreciate my uncomfortable silence my
long uncomfortable silence okay we get
into our DNA our first surface book yeah
so now that it's gone through all the
events it's now to its current point in
time now and bago can you see the what
view as it is now right
so we also talked about the idea that we
want to be able to create a projection
at a later date and the power that
brings you but you can build up views of
the data as if it's been there since the
beginning of time we also talked about
with demographics and my boss has now
asked me he wants a chart showing all of
the other patients that have ever been
admitted to our system so let's go and
build one of these so you once all the
age you want see old patients that have
been admitted to a system but grouped
into age ranges of 10 years so I've got
a little bit of a dirty class here which
will allow them to look it up job is a
better way of doing it but all we're
going to say is when I see a patient
admitted event
the first thing I want to do is find out
what age ranges person falls into so I
can say
range lookup gets and we'll give you the
patient age which is out of the event I
can then make a connection to my
database
with that attempt to load a range
because it may already exist
using the range lookup name to find it
if I have one or if I don't have one
then I have to create a new one so we
can say star a new range where the ID is
the range look at name an accountant
will be one and then if one already
exists then I can just increment to the
count and then finally save the changes
right
does that make sense for something now
I'll put in a little console log so we
can see actually working
and so they stabbed with the actual kemp
okay so now we've created a new
projection we want to be able to see
this as if it's been a sense meaning of
time because we've got all the stream
which stream we can do that we could
just meet added into the actual list of
projections that we wanted to run now if
we start with running again hopefully
we'll start seeing it process the event
okay cool so you can see it's running
through there recording the ages all
patients if we were to stop this so it
stopped when we had about philly records
in each movie started again
starts from where left self so this is
the whole idea of checkpointing means
your system can crash and you can bring
it up again with no problem each
individual projection would have its own
check point as well so because they all
need to manage their own stream and
finally if we go back just by magic it
refreshed for some reason I don't know
you can see that we've got all of the
all of the data there but from the
projection if it's been there since the
beginning of time so that's kind of the
idea behind the architecture just to
show the dispatcher very very quickly to
explain how that works if we have a look
in this test console application we can
see here's an instance of is actually
creating a little bit patient so we
create we're trying to admit Tony
Ferguson now a toward 10:00 the whole
mediator pattern the way it works is
that you basically solve a dispatcher
and passing that event within there
you'll see that I've created that
effectively a registered and map of all
again of all the commands to the code
that handles them over dispatch it does
is actually gave a write handler for the
command and pasok land into it so it's
really simple but it's a really good way
of kind of like abstracting away
executing and working with the domain
from whatever your client is be it
let me see our Web API right now this is
a pretty simple implementation and CTRs
and events are thing there's certain
things additional things that you're
going to want to add to this over time
so it kind of makes sense that when you
execute your command before you do that
you want to validate that your command
is successful oh sorry is correct you
may also want to add in some
authorization so that only certain
people can execute certain commands so
you can kind of put all that in the
pipeline of dispatch in the command
equally with a projection manager for
one thing that's important there is that
is to do with ops and monitoring so you
want to be able to see
that your your events prevent
projections at all processing and look
just up to date we're not falling behind
because then it'll make your system seem
slower so you probably want to build
some some monitoring tools around that
make sense to do so this is also if it's
not really included but it's things you
maybe want to consider right so when do
you want to do this as much as the
patterns and the ideas are pretty simple
very still air overhead with managing
this stuff especially when it gets into
production and it's only really suitable
for certain systems I mean if you are
actually working on what is effectively
data and cream which is you know you
either create a patient or you delete
the patient are you okay your patient
you're probably not going to get much of
much benefit from this pattern but if
you're actually working on a system that
has real process real interaction
between the various users and in a real
timeline then in real world events you
know you look for real within a hospital
there's lots of event that takes place
and it makes sense to map those to the
code that's when it becomes really
powerful I've seen it so often I've seen
people build and it's insulting I've
seen people build can be systems where
you see the commands new cv events and
me they eventually do become create
patient patient creators of date patient
patient updated when you start doing
that if you find yourself doing that
that's when you really want to start
looking at domain driven design because
I'll help you break your system down
into a series of events that are useful
because creative patients not really
useful create update patient it doesn't
really tell you anything that's been
going on so when it kind of satisfies
all those things then it's worth
building and and also you don't have to
build an entire application this way
this is the other problem that I've seen
happen so after these are people that
have a large-scale application they need
to build and they'll say right we're
going to invent sauce this we're going
to invent the entire thing and that's
kind of when it fails
because the certain parts of your
application that are just good base with
certain parts which are event-based
so a very good example of what shouldn't
be events elves potentially is user
registration that's always a big one
there's not much benefit to that but as
again tracking a patient's journey
through a hospital in that situation it
is it is pretty good so that's pretty
much my talk be the demo but I've given
that I've changed a little bit so I will
push it up on the github eventually so
you'll be able to have a little bit more
of a look of it there's some links there
if you want to take it a bit further and
actually investigate this yourself it's
a Google group the DDD event saucing and
seek Eulerian CS told you those words
are always together you'll appreciate
that actually tagged to these links out
so you can actually read these ones
because these are the important bits of
a top bit so you have as a Google group
there's also of a slack channel which
started up maybe six months ago and
that's incredibly active there's people
on there all the time we've got hundreds
of people registered on there now
finally at the bottom is a couple of
links the first one is a link to Greg
Young's code on the beach talk I think
it is which is purely about event
sourcing and it's an excellent talk and
it will give you Marvin insight interval
where al came from because Greg Young
was kind of the guy who popularized on
all this right and then ever bottom
where he also does a series of online
videos and I know he's working to
improve them at the moment and they are
paid for but I've seen them and I can
highly recommend me you take a look at
those with you if you willing to part
with the cash so finally again but we've
the link to the github repo and at some
point late today when I sheriff in up so
that's that's pretty much it so I think
rather than keeping you all there longer
when you need to be in it as people
don't actually want to listen to
questions I was fine to go but if you
want to speak to me afterwards I'll see
the code in a little bit more details
and by all means come to me afterwards
our after start thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>