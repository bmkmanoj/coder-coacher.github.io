<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Working with C++ Legacy Code - Dror Helper | Coder Coacher - Coaching Coders</title><meta content="Working with C++ Legacy Code - Dror Helper - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Working with C++ Legacy Code - Dror Helper</b></h2><h5 class="post__date">2017-07-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/qSrhVt0654U" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">good morning I'm tall helper good
afternoon I'm low helper and this is the
walking with superstars legacy code
session and before we start I thinking
introduction is in order as I said my
name is dog helper I work as a
consultant in a company called Cod value
I've been developing in software for
more than a decade this is being a
sitter space room I guess I'm not alone
right and I'm being using Delavan
development and clean code since 2008 I
guess where I learned about those and
I've been keeping that ever since I help
developers write better code and have
encountered numerous legacy code
situations
I'm also applause I thought oh I just
released two courses in C++ unit testing
would catch and deep dive into mocking
insider starts with Google mock and I
suggest you check them out I also have a
blog at helper called calm where that
about anything I find interesting and I
have Twitter be helper so feel free to
tweet say what you think will
exclusively develop in C++
jesse plus plus nothing else no one
dotnet developers in the code Java the
rest I'll product managers I guess I'm
doing currently to my job I get to
consult in Java C++ and.net and that way
I can draw lines between the
similarities and the differences between
them and I think we got it
better in C++ to tell you the truth and
I'll explain why but before that we all
came to talk about legacy code right
what does legacy code means does anyone
has a good definition of legacy code
I'll tell you my definition
it's the feeling I get at the bottom of
my stomach when I look at the code base
and understand I need to walk with it
right it makers it's a very emotional
term legacy code it causes fear and
distrust and well you know you don't
you're not going to have a good day when
you see that code the first time and we
all know we probably
talking about this old code written in
the days of the dinosaurs by someone
using bad practices and obsolete methods
right not a good developer like everyone
else in the room and we probably ate
this guy as well but there's no clear
definition for legacy code
the only thing close the definition we
have is what Michael feathers wrote in
his book walking effectively with legacy
code which if you haven't read that
before you should wear it says legacy
code this code without unit tests and I
get it
and but it's not really a full
definition I wish there was a word a
sentence I can say about legacy code
other than legacy code that will explain
exactly what it means and fortunately we
don't have that but what I do have is I
noticed a few properties of legacy code
some things that are true for every
single code base I got to look at which
was in this indian essence legacy code
the first of which is that it is no
longer engineered just catched right
when we start a new project we have an
architecture team or an architect who
come up with this amazing design and
then we build and we take the the
components and break them down and we
have lengthy conversations about the
best way to implement the code right and
then we ship the product and forget
about that and the next guy in line
usually it's someone else get to patch
the code because what I notice
developers do with code that they have
no idea what happens there Wood legacy
code is that they put a breakpoint so in
the code run line by line until
something that looks similar to the bug
they want to fix or a place to put the
features in place and then they write
the code immediately compile build and
commit an done way right and this is the
case with legacy code
another thing about legacy code is that
it's very fragile it's easy to break
legacy code especially after awhile as
pastor still a few years if you get this
code that was written eight years ago
using all c-plus class it is almost
impossible to change anything without
breaking some functionality and and this
is the good case scenario because the
best case scenario is you break the
functionality but you're not aware about
it I had a client a customer called in
the middle of the night
something very crucial important in this
process stopped working and after a lot
of begin log reading and debugging we
found the problem it was a change that
was made two months before that they
changed the code the code ran for two
months and only after two months someone
noticed that there's a problem and that
is usually the case and that's why we
feel this called so much because we
don't know what will break we are not
even sure whether or not we'll be able
to catch the bug once it happens the
next thing about legacy code is that
obviously it was written by someone else
I am last year in NBC anyone was in NDC
Oslo 2016 okay me too and I went to a
session by Caroline clever in which they
did a survey about legacy code as
developers for the definition of legacy
code 3% of those developers said legacy
code is any code written by someone else
and I left because that's that's like a
very funny definition and they thought
about it and it's very true because what
usually happened with legacy code is
that the person who wrote it and
understood what is doing left Italy
moved to a new project Italy moved to a
new company and there's no one to ask
what to do this one to tell me what was
the original thought the original
decision he made when implementing the
code and which make it easy to break his
code because I have no idea what he had
in mind now in some cases some real
cases I managed to find this person he
has no clue because he forgot we talked
in five years ago he has no idea what
happened I barely can remember what
happened last month and that's a problem
because usually the people responsible
maintaining legacy code another one who
wrote it and lastly and very importantly
legacy code has uses and those users are
the sole reason you came to this session
because legacy code without any users
you can
it is immediately and forget about it
but usually the code we're walking on
someone really really care about it and
once you use it and he's really needed
to keep on walking the bug fixes and you
need the new features some of the time
they even got used to the bugs and eat
the same bugs to continue walking in
that specific way because they found
some metal to walk around them or with
them and you can change that because
they pay money or they need it to the in
order to make money and so we need to
remember those user whatever we do so
having defined some properties of legacy
code they have good news and bad news
starting with the bad news everyone here
works in C++ right to some degree which
means that you might have a problem
because in C++ there's quite a lot of
legacy code in relation to other
languages I don't have the any numbers
whatsoever but I have a feeling that
more than in Java or.net the reason
being that it'll pass has been around
for many many years and a lot of systems
were written using C++ and so we have
quite a lot of legacy code there
the second dead news for you which we
might have know already is that you
probably walk in with legacy code right
now right because in C++ these days
either you get to implement some cool
algorithm or multi-platform a
voice-over-ip seen all your working with
legacy code that you need to keep on
maintaining and fixing and the last
thing is that which simplifies is very
easy to make very big mistakes memory
allocation problem but all the flaws you
name it you all know you're been there
and that makes it hard to work with
legacy code because we can break
something in a very critical problematic
way but I have good news for you
the good news is that like that working
with C++ you have quite a lot of power
in your hands and C++ enabled me to do
things with legacy code that I can do
with Java or.net in fact when going into
java.net say
places I wish I had some of the features
obstacles placement enable me to fix and
improve legacy code and I'll I'll show
you a few of them so what can we do with
legacy code three simple steps now
simple to say not to do first thing is
understand what the code does seems
trivial right but we all know that
sometimes each cell will feel as if it's
better just to jump into the code and
start fixing things before fully
understanding what it does and sometimes
it's really hard to understand what the
code does reason being that again we
don't have anyone to ask and there's
quite a lot of it but in order to work
fully with legacy code we really need to
understand what it does beforehand I've
been in two companies in which as part
of fixing their existing problems I do
diagrams workflow diagram so how the
system works and it was the first time
anyone in that company really understood
what the system does and that's a shame
that you need a consultant to do that
but what can I do and in fact in one
companies were so successful that they
took that diagram and continue
implementing new features in you in
other platforms based on my diagram that
I drove just to fix a bug so we need to
understand what happens once you get a
clear understanding what that piece of
code does now you need to make sure that
it keeps on doing that doesn't break
which is also very trivial to say very
hard to do because there are users that
want your code to keep on functioning
the same way and lastly once I achieve
those two points the next sort of
business is to start improving now I can
refactor code now I can make fixes
because I know what the code does and I
can fix that this is the end of the talk
right you don't need to know anything
else now before that there's one tool
that helped me do that although I am
pretty biased but I noticed that after
undoing the diagram and use the static
analysis tools and I understood what the
tool does what their code does and I got
a few people to talk to me and explain
what they wish
did writing Unitas can really help me
heal because unitest
help me first of all define what the
code does I need to write code that
executes it and by defining what the
code does I learn things about it and
once every unit has in place I can debug
it instead of taking the whole project
and running it and trying to debug the
specific scenario I'm trying to
implement the test Hill which in the
most system big system enterprise system
is variously helping to do sometimes I
don't have the environment to get the
old project in place so I want to add
just a few points of it if you pieces of
it and once I have those tests in place
I know I can change the code without
breaking it it's as simple as that and
this is what a unit s look like anyone
here that we use Google test before okay
thus does amount that's the same amount
of people are get when asked about unit
testing in a dotnet
so that's fine unit s essentially is a
method it's as simple as that it's just
a method that I get to run my code in
and that's it and everyone you know how
to write a method and write and in this
case I'm going to show the demos with
Google test and Google mock not because
they're better or worse in other unit
testing frameworks just because in this
specific environment it's easy to talk
about them they are widely use okay
easily acquired if you want to learn
about other unit testing Cermak and
mocking so MacNeill what i think about
each and every one of them i have
another session tomorrow so what do we
have you usually in the sixth class unit
i've seen there is a macro like which is
this guy over here let me try
that is the test my code basically does
three things first of all define a new
method this is like writing a new
function the second thing it does is
that it creates a class in the
background if you go and dive into that
code you'll see there's a class class
created here because want and class
around my method and the last thing it
makes sure that when I
the whole their project with the unica
seen the unitive will be executed so
essentially that's a platform to
encode that's it nothing more nothing
less
other than that I have here there we
this is also known as the test fiction
name but what we C++ developers
grown-ups this is the class name that
will run the test and the second thing
of the hill here we go
is the test name and the test name is
what it's called and what it does
usually I will give it a good name that
is seeing a lot Hill and in the middle
is the importance today a bit the
important bits is the actual code I get
to execute this is this part over here
first I'll initialize whatever I need to
initialize and then I'll run the code
I'm trying to test and usually in the
end I have another macro depending on
which unit testing some okay I'm using
that we'll check the results in this
case I'm checking that when I call night
dot say I'll get back me and if that's
in fact is the case the test will pass
otherwise the test will fail it's as
simple as that and that basically is how
you write a unit test in C++ is in
Google test but it's not as simple as
that because no one ever old code that
looks like this right we are things in
our code called dependencies other
people classes we have server and
databases and filled party libraries
that are executed and run as part of our
code and usually with old code we have
moved those usually the code is not well
structures is no clear definition the
classes are not divided we have a big
mess and taking a big mess and trying to
test that is nearly impossible and so I
need to make a few code changes and then
I hit a problem because the code has
dependencies and if I needed to change
that I'll most likely 78 on three
percent as they say 33 percent of all
the statistics are made up as well as
this one so I'll probably break the code
if I try to change it just to test it
and if I'll break the code I know one
thing for certain I'm not going home
today I'm going to stay over the weekend
or late at night to fix the problem the
problem is just created and that's not a
good thing to do I don't want to do that
and then so I need to find a better
solution and when usually have this sort
of a problem I always look for a Wiseman
who already solve that kind of solution
in this case okay in this case Jim
Carrey who said my focus is to forget
the pain of life forget the pain Mock
the pain reduce it and laugh and
obviously was talking about unittest
because in unit tests I have two
problems I need to solve I have a
sensing and separation problem when I
write the unit s with the some sort of
dependencies hyah
the first problem is that when I run the
code in this case the left side send
email to user an email will be sent to
the user and I have no way to verify it
actually walked this is a sensing
problem there's no code I can write to
make sure it email was sent I'm not
going to pull my email account my inbox
in order to get to know if the tests
passed or failed and I also have a
separation problem I have very important
kind of logic downhill unfortunately for
me there's nothing in the way that is
going to for an exceptional crash in
some amazing spectacular way and so I
don't get to their code I need so going
back to mr. Kelly's suggestion I'm going
to use mock objects and mock objects in
a way something that every single
developer you know r2 right anyone here
ever use a mock framework and mocking
same book they saying some people didn't
raise up the answer about the Google
test just like there ends up which is
strange but okay and essentially
something everyone you know what to do
and let me ask a different question will
you ever call the database raise your
hand
we will never call the next ourselves
and again you didn't although no one
here ever called the database I said
carefully because this is a successful
and I might have some people who
actually wrote database logical and but
well but we don't call that abase we
call a class that does the actual thing
of calling the database and in fact
mocking that class is just a metal of
inheriting that class other ID in all of
the method and I got a fake object that
fake objects is an essence the class
that does absolutely nothing and that
class does absolutely nothing can be
used in the test in order to get all the
things I don't like in the tests outside
of my test and isolate the code that
will care about the logic uncertainty
test and then I get to decide in a
specific test what I want to do with it
now
we can write those by hand we can just
inherit any single class we want and
although I the method write a bunch of
code will developers in order to write a
lot of code not just this simple trivial
code unfortunately that's not a good
idea because once I start writing code
just for the test and every test need
the specific environment and the
different kind of behavior I'll end up
with a lot of code in my tests which I
need to maintain and I don't like that
and I might even write a few bugs on the
way and break something and I don't want
to write a test to test my test so I
will use a mocking framework and this is
all do that using Google mock now in C++
unfortunately no reflection yet and so
I'll need to inherit the class in my
class the fake rest API client is I have
a REST API client and in Google Care in
Google mock I'll just override a method
by using mock underscore method with
some number after it in order to create
an obviously I'd method of that method
I'm trying to change now it takes a
while but we you know everyone will so
wall syntax it's not the walls I can do
essentially the macro the number is how
many parameters that method has this is
the name of the method this is actual
this in will be converted to a new
method other hidden in the background
compile-time of HTTP POST which returns
no argument and have two arguments of
type reference to a string to a CD
string the same heel goes here would
actually be get returned the string can
get in received one string okay any
questions so far so good
how do I use those classes now that I
have them in hand let's see let's see a
small demo so basically here I have a
distributed calculator I always say that
in India scene I will like to show
calculators are very simple to explain
forcing don't look like the real code so
I use a distributed calculator that
calculator has a database in which it
gets the data out of the database it
will return the title with two numbers
and then I'll stick them together using
some string magic and called the client
an HTTP client real HTTP client would
actually be get and get a result back
out convert it to an integer that's very
nice things to do but let's say it works
and that's it now want to test that code
and I have two problems right the
database in place another client in
class I want to remove those so using
Google Mach I can remove them and that's
really important by the way all those
mock objects I just write them in the
part of the code that that is the test
not in the real production code and if I
go here I have the fake lines to make my
life simpler I'll just use the mock
method for HTTP GET which is a virtual
method and have the effect that access
and here it's a cons method soy mocha
transmitted of get data and that will
return a pair of twins no parameters and
that's it now we can write a test how
can I write a test very simply you'll go
this is the tests will go line by line
as I said I'll mark it as a test so I
can run it now and I have
dissipated the calculator test whatever
I'll calculate return to valid numbers
someone will call the server so in the
fact I'm doing two things you first of
all need me to make sure that the
database returns to valid members second
of all I want to make sure that the
client was called with the right
parameters and using Google mock I can
use this macro expect hold that's my way
of telling it I want you to expect that
method to be called for the fact that
the access
the method is called get data and always
no matter how many times someone will
call you just return the data what is
the data two numbers one in two and then
I will create the fake clients with some
dummy URL I don't care which because I'm
not going to actually execute it and I
write another expect call the same for
that clients and when actually get
called with this specific parameter I
expected to happen at least once and for
the test not to crash
I'll also return the number three
although in this point I don't really
care what numbers come back because
testing this specific number is useless
I just told him to do that and if we'll
run this code you can see what happens
we get here to the calculated test now
we are here the data access I'll just
this data access inherit from the real
one but in fact this is a gene Mauch on
whatever data access this is my secular
such as created and if I'll jump
slightly on the side there's a fake line
called widgets HTTP GET and I'll return
the result free which I don't care about
in this point that has just ended
whatever happens after this point is
useless to me because I just told him
what to return right this is the magic
of fake objects and what happens with
Google mock is that once you go out of
scope it will check whether or not what
you just told him to happen really
happened so in effect when I go out of
scope it will check that this method was
called at least
once and if I learn it all the way to
the end we can see the small V mark here
telling me that it work if this wasn't
the case if I'll change it to at least a
twice and run it quickly again I can
find the I'm using the sharpest of C++
in this case but you can run it in
command line as well we can see that
it's fairly says too few actions
specified expect call happened you
expect it to be called at least twice
but it only was called once so you have
a bug and this is my thirty second
introduction into mocking there's quite
small to death but that's the basics so
now you know how to fake external
dependencies which is very useful but
obviously this is still not the big
picture this is not the whole story
right I just show you a very trivial
situation which in legacy code will
probably not happen in logistical things
are more complex and I just used
dependency injection I use the
constructor to pass the dependencies in
which also doesn't tend to happen in
legacy code usually I need to find a way
to somehow push those fake objects from
outside to the inside of the class and I
don't know how much code is so that
actually does that in C++
but if if it's as simple as just
creating a new constructor that they get
all the dependencies instead of
initializing them in the constructor
inside whoa I'll just override the
constructor and I'm done
if it's the measure of just doing
something called the functional part of
the injection which is creative hole in
my method a method that is set client or
something like that that I can call
maybe that's a good solution although it
says some problem with it but most of
the time is not that simple right most
of the time I need to work extra hard
also you might have noticed that I gave
myself a few discounts on the way my
class was over writable right
all of the methods in the classes are
just faked if we go to the real classes
here we go well you the rest idea client
has a virtual method how many of you
owed virtual on any every single clear
method you ever wrote written right it's
not often we do and it's not always this
way they are in fact several
dependencies which are harder to fake
which Google mock won't work for you
because it can't override the method
ously we can't override the methods we
have the problem and there's a group of
those kind of dependencies the source
which is methods which are not virtual
the second of which is classes I cannot
all find it very hard to inherit all
right that's C++ we can do whatever we
want we can there are several shrieking
superstars that will enable me to make
the class impossible to inherit right I
can make the constructor project I can
make the constructor very difficult with
a lot of dependencies there are quite a
few of those static methods static
methods cannot be overridden because
they do not belong to any class and
singleton goes through the same kind of
place infinite on I make sure that one
no one can override my methods because
what's the purpose of a singleton if
someone can change the behavior and well
internally instantiated is the most
common situation which in the method
someone calls new and create a new
instance which means that I can take the
fake object from outside and shove it
into my code and lastly heavy classes
heavy classes are big classes that do a
lot of things not a single
responsibility to kind of classes those
classes usually called the database
called the client and do all the
calculation inside in hopefully in
different methods and those things were
the dependency in the actual logic on
interwined one within the another are
very how to fake because if I look fake
that class I'll fake away the
implementation I care about
we'll start with Singleton's this is one
implementation of singleton being a
superstar film you might find a few
problems with it and that's fine I'm
just trying to make a point and this
singleton has the end instance which is
initialized exactly once using the code
once flag and a private constructor just
so no one can call me on that singleton
now the switches situations when using
single tones in code there's the good
way to use single tones in which I'll
implement a singleton and use it outside
of the code I care about and pass that
instance as if it is an instance of a
class and no one inside the code should
know otherwise and then I can fake it
easily but in many cases once I have a
single tone you'll notice people calling
it from all over the place cause
throughout the system the good news with
singleton is that if I managed to change
the instance I don't need dependency
injection because singleton in essence
is a dependency injection right if I'll
change the instance is something else
every single place that uses that
singleton will automatically get my
instance I'll just need to find a good
way to do that and in fit of us we have
something very powerful that we can use
and it's this friend keyboard which was
there for ever by using the friend
keyboard I can make sure someone else
can call my private methods and yes it's
it says that I going to change now
production code in order to test it and
we'll get to that in a minute
but if we have a singleton here we go
here I have this is the trip service
cutter you can find it online in github
I change the sit assess implementation
I'll do a pull request later on but the
idea is that I have two powers either
method get' flips by user very simple
method ago it receives a user name a
user instance and first of all it checks
whether or not I log in not the user but
I'm another user and it checks whether
or not I'm logged in
using a single term if the session get
instant get clogged the user obviously
something bad will happen when I try to
test that if I'm logged in then I want
to get all of the friends of that user
and all of and check whether or not I'm
a friend of the user just past in the in
the method beginning and if I'm a friend
if he authorized my user then I'll go to
the database and find all the trips of
that other user and return all the trips
so I can see if my friend is currently
going to a Y or something like that to
problems with us with this piece of code
the first being the singleton who knows
what the second one any one time to wake
up we have a static method called down
downstairs here and a static method call
is another problem this is another form
of the of using something I can't easily
fake and I want to fake the singleton to
start with because there are a bunch of
tests I can write but I can check
whether or not I'm not logged in if I'm
not logged in I should get an exception
if I am logged in but I'm not a friend
of that user that's cool that's cool
that's good enough then I should get an
empty list back right that's two tests I
want to write and I can do that because
if I write a test immediately it will
call the instance get another sense
exception and nothing good will happen
out of it
actually it beans it'll start probably
be some exception happen please read the
code UMP and the solution is quite
simple without changing the code too
much but a bit I can go to my singleton
class over here this is the singleton
class as you see the methods are
specifically written to for an exception
because I don't I want to make sure I'm
not calling those in the real code it's
probably going to some user session or
whatever and here in the single class I
did two things I did a foreword
Declaration of two new classes which I'm
going to implement in a different place
in the tests
till for fakie the session that will
replace the reviews accession and the
user session accessor couldn't find a
better name so and I made sure that both
of those are friends in the single of
the singleton class having done that I
can now write the fake user session
classes in Google mock here I go
fake user session has two method is
either logged in returnable in value get
a user get logged user with a pointer to
use it that's it
and I'll write another class called the
user access all which are the single
method sets that world's up to you what
you do in this specific clients I wanted
to make sure that there's no previous
instance and I was a bit lazy so what I
do
I'll call get instance for the instance
to get initialized and immediately
deleted not perfect but walking and then
I'll replace the instance with my
instance and that's it it's as simple as
that
once I allow a few things and then Evert
I'll go to my test here is the test
shoot for an exception Wiesel is not
logged in when the user is not logged in
I wanted for an exception I'll create a
fake is a session and when Colleen
affected a session get logged in will
return not logged in user
essentially null pointed and I'll create
a real trip service that has no
dependency injection whatsoever but
beforehand I'll make sure that to set my
fake user session now every place in the
system that calls user session that
instance will get my fake object very
important when you do with those kinds
of tricks to make sure to clean
afterwards you need to reset that thing
after you they finish airplane with it
and now I can check that I'll get an
exception a sub falls means that when
the method is called an exception will
be found when get Sharif's by user I
don't care about which user I suppose to
get user not logged in exception that's
this test second test I can write that
when I'm not a friend of the user
which is fine then the number of ships
returning is zero and I did it by
creating and not using and passing it on
and I make sure that when get logged
user will be called it returns some user
which is not the friend of that use it
okay and I get zero and although the two
tests second height
I want to write more tests obviously I'm
until I do it interesting that the
interesting test says that when my user
is in fact logged in then I want to get
these trips back and I did it he'll I'll
create the successions replace it with
service here we go this is my friend and
my friend is my friend Teja he has two
trips and when I call get treats by user
I should get the fees back in fact
that's not what happens what happens is
I'll get an exception right let's let me
run it for you and hope that nothing
that happens because demos in a session
might be problematic where are you
as I said things turn to
interesting okay unfortunately for us
but this being C++ we can hack our way
around using the command do it real
quick debug let's see whether or not in
Google to test when I use it what I'll
end up with is an executable I can run
and this is it Dell's out the test so I
can go here in run trip service test and
I see that to test has passed those two
test test okay but I get a failure
without known seedless last exception
will surplusage be in C++ and so to test
pass want a cell because I haven't done
anything about the static method and
which we're going to solve next static
methods belong to a group called
unfuckable methods unshakeable methods
are methods which are impossible to
override static methods is one of them
how to are impossible to instantiate
class our second one because I need to
instantiate the class even if it's a say
class if the constructor calls the
database that is a problem for me and
unreal chole methods and if I can
inherit them I can take them in fact
this is true to any other different
static language c-sharp vb.net java
cannot fake using this method but c plus
or scan because in citruses we have a
lot of power and in fact c++ will enable
me to fake unshakeable methods this is
the power I wish I had in other places
and the solution for which is using a
kind of duck typing that happens during
the Bible in a compilation time using
template magic I can create a different
class that look exactly like the class
I'm trying to replace and by using this
template class I can tell him to replace
the instance that is currently using
with my instance and take unfixable
classes
and I even can fake the classes that are
internally instantiated without having
any other dependency injection well if
we go to trip service by the way this
one is on github and not jump to head
what I did here is changed the trip
service class a bit I made it a template
class it's a trip service of type T if
this was in fact production code real
clients I would inherit it just so the
client want me to define which that is
using all the time but I'll leave it
like this and the T happens field where
I have the static method call all
they're all in case it's an instance
method call button virtual the same
thing basically even if it was new T
would work as well all I need is some
type that implements find Suites by user
in order to get completion to walk and
now I can go here and create a fake trip
data access object class doesn't inherit
anything not virtual and it has a static
method find treats by user with some
dummy implementation in this case and
now I can take this class back to the
test that failed before hand over here
and all I need to do is is set it to use
the fake trips that are access object
and that's it
I just it went into the class and
replace whatever happens inside without
doing too many changes I haven't broken
anything because the old code keeps on
going the same way it worked before and
now this test will pass because it will
call the fake trips that aux object and
that's it and that's cool that's
something I don't have in any other
language other than dynamic language but
there has many more issues with legacy
code than I have here because it's the
Namek and if I want the same code again
it passed if you ignored arrows in the
end this is a Google test trying to send
me for myself
yeah and that's it and I can do that to
a multiple kind of methods in fact this
is this became my go-to operation
whenever I can't easily inject the
classes and I can do that in the shop in
fact in c-sharp and Java what I used
something called extract and override
I'll extract the extract of the logic to
different methods and then inherit that
in a class in my tests and override a
method but this is much easier so simple
now some of you might feel that it those
are not good solutions because I have
changed the code I have changed the
legacy code and in order to support the
test and I have an answer in a story to
explain why why it's okay the answer is
that I will do anything I can in order
to get that code on the test because
otherwise I can't walk I can't advance I
can't change it I can improve it and the
second one the story is that a week ago
I was late to walk the reason I was late
to walk is that city all decided that
the junction in the end of my street is
where we have a big roundabout there
with one lane and they want to change
that to a multi Lane kind of Junction
with headlights and everything and there
was a big tractor blocking the road and
construction workers walking there and I
was stuck there for 20 minutes and I was
not happy and I was stuck there ever
since because they are still doing
whatever they do in there and I guess it
will it will be like that for few weeks
or months but I know one thing as much
as I suffer daily right now in a few
months when they finish my life will be
so much easier I couldn't leave home
later because I will not be stuck in
traffic because they will improve
everything and what I have to pay right
now is a slight hiccup on the way in
other words with legacy code
things will get a bit Wars before
they'll improve and that's something we
need to remember that's something that
you need to explain your boss or your
clients because they'll probably be
angry the beginning once you get a style
change in corner IQ test but after a
while you gain so much confidence and
control over your code that you forget
it
if I get all bad it was and I'm sure
that if you'll talk to me a year from
now I'll be happy about the way the
street stood out to be in that something
is very that is very important to
remember there's a another very cool
thing I can do with Hitler's passing
year end inheritance
sometimes the methods the problematic
method especially when dealing with very
big classes is infective private method
if I have a big class usually someone
who didn't think about solely the
principle and the single sponsibility
principle what all the logic in a single
class or is one developer told me when I
told him it usually the question starts
when people ask me how can I test
private methods it was in Java but I get
it in any differently as we learned
which other and when a developer asked
me about how to test a private method
returns a small light bulb in the back
of my hand and I asked him why on earth
would you want to do that and he says
that's because most of our logic is in
private methods when looking at that
class usually what I will find is that
the class have some generic name
something's have been service utility
whatever and it has a single public
method called execute or run or
something on those lines and all of the
logic is shoved into that class and we
get to see those quite a lot and usually
I'll I try to explain to that developer
that you need to factor that class break
it into different classes and last time
I did that I got an answer very
problematic answer that made me laugh
inside because we don't want the laughs
in front of the plant and he told me my
team leader does not believe in breaking
things into classes
so good luck with that
but even if it's what if I do believe in
classes this abstract the mythical
creature sometimes I need to test this
thing before I break it into classes
right and so I have this private method
that save to the database and that's a
shame and I want to fake only that
method and in C++ I can because all I
have to do is in any that class and
declare all the classes public and
that's it I can change the accessibility
of methods in C++ by narrating that
class and I can fake the private method
the protected method the problem
whatever I want and this way and it's
not a healthy situation to bill with in
but once I get this class on the test
the part that I haven't faked I can
break it up to different classes at
least I have the confidence that
whatever worked before will continue on
walking and you can do that with any
other language other just Acosta's so
that's the cool things
so to summarize taking control of the
legacy code we have a legacy code
situation which is not the perfect place
to be but unfortunately most of us get
to see that from time to time or all day
long so first thing we need to do is to
write a few tests understand what the
code does for your code document the
code for your code and then once I have
a few tests I'll probably hit a brick
wall the brick will be in dependencies
and then I'll get to employ those fake
objects or to mock objects in order to
test without those dependencies and once
I have that in place I can replace it
actual dependencies with my classes that
does what I tell them to do and I can
refactor and clean up the code now if
you was about recycled a few definition
for the factoring does the right
definition bin I'll change what the code
does without I change what the code how
the code does something without changing
what the code does the second bin I want
to rewrite the code but my boss won't
allow me so I'll call it with facto and
not talking about that one but you can
once your test in place and once I have
all of those well lucky me have
maintainable code and this is the
process that will take something the
- interviewed a few weeks - a year or so
depending on the code but you'll get
there as long as you persist and and be
certain that what you're doing is in
fact improving the code that was my
session thank you very much by the way
if you like to learn more about unit
testing come to melt in my session and
you can also go to Pluralsight I have a
few of those here if you need a few
weeks there because I have to cause us
there which are more extensive than one
hour we'll talk and if you have any
question I'll be happy to answer them
all right now</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>