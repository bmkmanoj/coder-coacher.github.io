<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>IdentityServer for ASP.NET Core 2 - Brock Allen &amp; Dominick Baier | Coder Coacher - Coaching Coders</title><meta content="IdentityServer for ASP.NET Core 2 - Brock Allen &amp; Dominick Baier - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>IdentityServer for ASP.NET Core 2 - Brock Allen &amp; Dominick Baier</b></h2><h5 class="post__date">2018-02-12</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/TZzFPhVkzo4" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">I'll be on can you hear me
definitely here Oh excellent good
morning come on guys good morning yeah
welcome to NBC I think we are the first
talk after the keynote right so who do
you think I am a spirit core version -
okay and who do you think I'd NT server
version to a couple of people
so basically Brock and I run this this
open source project and thanks for - NDC
for forgiving us you know them the space
and time to you know do open source here
and not only you know commercial stuff
so once a year roughly you know HP
nerdcore has a big release right or net
cause a big release and and identity
server is a library which sits you know
very closely close to the metal in a
spinet core on the HTTP runtime so it
turns out that whenever taken a big
release we also have a big release as
well right because they tend to change
stuff yeah I'm not using the word break
here maybe okay so that's that's what
happened so basically this talk is about
giving you an update of everything that
happened so to speak in the last year in
in identity server and and the ecosystem
around that oh by the way because I
always forget to say that at the end we
have stickers so if you want stickers
come come here at the end of the talk
there are plenty of them I think just
that I got that out of the way let's
proc by the way I'm Dominic if you could
so we have a lot of things to go through
a lot of little improvement sort of big
improvements a lot of you know new
things and so on but the the one thing I
want to really focus on
which is what effects everyone when
moving to a SP nerdcore version 2 is the
new authentication system yeah so as I
said identity server itself think of it
as an extension to the authentication
system of a spinet core to give you you
know protocols like Open ID Connect
support and ooofff and you know that the
server side of these things so we are
really as I said very very close to the
authentication system so and when we had
to rewrite that again last year actually
that the funny story was that you know
Microsoft typically is very vocal about
when they gonna release stuff and it
typically coincides with some Scott
Caffrey keynote that they release new
things this time it was different so
that was actually at NBC in Sydney so in
the morning I came from breakfast I went
to the elevator and I met Damien and
Barry from the agent that team and I
said oh here's a USB stick here's the
new version for a spirit core we just
released it we didn't tell anyone so
that was kind of short notice yeah so I
think somewhere in between would be a
good anyways so yeah we had to rewrite
our stuff so when I thought about that
how often we had to rewrite our stuff I
thought I give you a little you know
next door Richard Campbell is doing the
history of dotnet let's give you a
little history of dotnet core of a split
authentication okay so who has seen this
in his life so the the free sticker
question how many of these
authentication methods that you see on
the screen actually work
well if you don't count none only two
right so has anyone ever used passport
authentication there was a thing that
actually got pulled before asp.net 1.0
but it was too late remove it from the
enum okay separated came in in dotnet
four point five where they had plans to
make federated of indication of
first-class citizen in asp.net but they
changed their mind but it was too late
to change the enum so actually you know
in asp.net you only had really two
chances or choices forms authentication
or Windows authentication and if you
wanted to do both basically you were out
of luck and if you wanted to do anything
that is not forms or Windows you had to
go back to none and re-implement the
whole thing okay and that is just an
artifact of how did the HTTP modules
architecture worked in a spirit net so
when they move from a to a net to katana
right they changed the whole
architecture and suddenly everything was
middleware yeah you can have as many
middlewares in your pipeline and one
attempt in katana was which was the the
biggest limitation of asp.net is to
support more than one authentication
method at the same time right which is
something that in identity server you
really want right you want to have a
server that can send out to as many
external identity providers you want
right so we need support for more than
one authentication method so you know
all I had to learn middleware is is so
easy right it's a linked list of modules
running in the exact order in which you
wire them up right so when they came up
with their new authentication
architecture they present it as
something called passive middleware so
it's middleware in the pipeline right
and all we know is little bear runs in
the exact same order as you wire it up
unless it's passive then it doesn't run
okay so the idea was to basically have
one active of indication middleware
which is your primary authentication
method like cookies for example and then
as many
if once as you want which you know can
be alternative of indication methods and
this made my head hurt pretty bad right
because then these things were in the
pipeline but didn't run but you can call
back to them like like go back in time
from your code and invoke them you know
after the fact and guess what happened
if by accident you configure to
middlewares to be active it was pretty
much undefined behavior it depended on
the order in which they are wired up on
in the pipeline okay so this was not
very very very intuitive to use so you
know in HP nerdcore they had the chance
to make everything better right so
that's when they came up in a spirit
core instead of just having active and
passive you could now make them active
on the way in and pass it on the way out
which made my head hurt even more even
more yeah so they had something like
automatic authenticate equals true means
that's your default authentication
method an automatic challenge was
basically the thing that sent the user
to a place where he can authenticate and
they changed his default values over
time many many times that I in the end
even didn't know anymore which
mittelmeer was passive which one was
active and which one was true or false
and so on and guess what
what happened if by accident you said to
bitl where's meter has to be automatic
authenticate undefined behavior again it
depended on the order they wired up
right and but this time it was even
worse because the order was affected by
in in both directions okay so yeah now
we complained about that a lot and and
finally between 1801 and 1802 they had a
time to actually rewrite the thing from
scratch yeah and this looks much better
now because in HTML core to what we now
have basically is a support for
dependency injection in the
authentication system so the idea is you
have a hand
a so-called handler which takes care of
one of indication method right there's a
cookie handler and there's a Windows
handler and a Google handler and
Facebook handler and a nobody connect
handler and so on and you just throw
everything into the di container that
you want to support okay and then you
have exactly one middleware in the
pipeline which is the authentication
middleware and this will basically go at
runtime to to the DI container to get
your default handler okay that the one
that you want to use as your default
authentication method so that means you
have to configure basically that the AI
container okay and that's what that
looks like now so it turns out it's not
a trivial problem to solve okay so you
now have a default authenticate scheme a
default forbid scheme a default
challenge scheme a default
sign-in scheme and I forgot one right
and the sign out scheme okay and this
actually is not an uncommon
configuration right so you have your
cookie handler being the primary of
indication handler in asp.net core - you
know like issue cookies validate the
cookies coming back but when you wanna
send the user to a login page the login
page is not local it's on your open ID
connect provider so you have to set the
challenge scheme to OID C right but when
you come back from the OID C provider
you might not want to sign him directly
into the cookie but in into a second
cookie that's why the sign-in scheme is
10 okay does that make your head hurt
you
good yeah the other thing they change in
every single version was how you
interact with that okay and you know
despite making fun of that I think what
we have today is it's the best thing
that we had so far okay we ordering
issues are almost gone Microsoft
banished to add ordering issues to the
DI container which is a different
problem
but basically they you now have five
methods hanging off the HTTP context
yeah
for the five verbs if you will that you
need to interact with with the education
system sign in sign out challenge for
bid and authenticate okay
signing in the user signing out the user
sending a user to somewhere where he can
sign in sending a user to somewhere
where you can tell him that he is
forbidden
now and authenticate means basically
take a credential and turn it into a
claims principal okay these are the five
the five methods you have you can see
that every method here has two versions
yeah
one way you pass in a scheme right every
handler needs to have a unique name
that's what they call the authentication
scheme or if you don't pass in the
scheme just go on back it basically uses
whatever you have said as a default
scheme okay and that works pretty well
okay so that was the big change we had
to basically react attack the dentist
service or maybe you just want to show
how we deal with that sure so here's an
example of identity server being hosted
in and they s been at core application
here's our startup file where we're
configuring our di container and then
here what we do is our configuring
identity server right now we're just
pulling in some some test users and some
configuration and what we can do is then
if you want to control the cookie
because it is confusing yeah we when you
run on the console we actually print out
all the scheme configurations okay so
that you actually know what you're
getting yeah so if you don't configure
anything related to authentication then
we'll basically use an an internal
scheme name called ID server right okay
so we're gonna wire up a cookie handler
for you by default with some default
settings and we're gonna fire up a
second cookie handler that you can use
for external authentication and we made
it the decision to only expose you know
rudimentary configuration options yes so
quickly show that so basically all you
can do while by our configuration system
is basically set the cookie lifetime and
if it's a sliding cookie or not okay
and that's totally fine because by using
this new of indication system from a
spirit core you can easily buy up your
own cookie handler and just replace ours
that that's the beauty of being di based
now okay right so these are our own
built in cookie if you don't want that
then and want to control things like the
cookie name for example what I have is
some snippets I can paste in here and if
you go configure this now or you're
adding your own custom cookie handler to
the DI system alright this is the cookie
you want for your login page at identity
server you have all the options that you
want to configure with the cookie give
the name your own sliding expiration or
wire into any of the other plumbing that
they provide you here and then what
you're doing is by using this version of
add authentication right this is the
shorthand version where you're setting
what you want the scheme to be by
default for everything so that's not
only sign in but sign out and so on and
so forth okay so now we run this so now
we're using our custom cookie instead of
the built in identity server cookie at
this point the identity server cookies
not used at all and then if we go to the
local identity server and actually log
in you know if if you have requirements
like custom domains custom paths you
know things that you know you want to
directly configure on the cookie handler
just just insert your own in the DI
container replace ours and we just want
to use yours yeah so you have total
control over the cookie that gets used
that identity server in that that login
process cool so let's say we want to add
something that Google sign-in okay same
idea just just to show them the pattern
here basically what you do is you go to
your di container you throw in a Google
handler right you configure it Google
you know every handler has like provider
specific configuration options and in
that case you have to set your your
client ID and your client secret from
from Google and also can just fill out
the first parameter before the options
the first parameter after before the
options is basically the unique name of
the handler because later on in your
code you want to call it by name right
you want to send user to Google
and that is the name of the so called
authentication scheme okay
the Google Handler happens to default to
Google internally but if you want to
give it your own unique name you can
pass in whatever you want foo whatever
and the second one actually there's a
second parameter as well that that's a
display name yeah so if you want to
basically give the UI a hint how it
should maybe dynamically render the
Google pattern for example you can set a
display name as well and again that is
not specific to Google it's just how the
new of indication system works you can
you know scheme and display name and
options and that's how you you know wire
up your authentication handlers so what
what our UI actually does this maybe you
wanna quickly show that there's
something in the DI container called the
eye authentication scheme provider and
that is and that that's an API that you
can use at runtime to query the
authentication system so maybe you know
you you want to dynamically render your
UI based on who what handlers are wired
up in in the DI container so you can use
this API to get all the hair the scheme
names the display names and so on so you
basically need to know everything at
runtime how to invoke the handlers
dynamically okay and that's actually
what our UI is doing so just
so this login page is basically just
querying that interface querying the
authentication system and showing what
we need to show dynamically to the user
that's our just boilerplate code you can
totally come in here take this over and
show it however however you want to for
your login page and now Brock signed in
using Google okay so we can even show
the Diagnostics sure yeah so this in
shows fact in fact shows that I've come
logging in from Google okay so yeah so
yeah and actually their Microsoft ships
with support for Google Twitter
MSDN account and Facebook okay so these
four come from Microsoft they're dead
there is a contra project on on github
it's something HP dotnet dot contrib dot
o off providers I think it's called and
they have like thirty plus more handlers
that all follow the same pattern so if
you if you know how to wire up on hands
are you know how to wire up them all
okay and there you'll find essential
things like you know betel net untapped
and other really important identity
providers okay
so what else is new one of the biggest
you know like that the most common
question we got from customers is you
know especially the enterprise customers
that that had that have a TFS deployed
is what about a DFS support and it's
actually to be honest really a shame
that Microsoft took so long to build off
indication support for their own product
okay so lwith Federation was the thing
that was missing ever since ya know no
one had time to to port that or it
wasn't per prioritized high enough
because hey you could you could go to a
show instead right so we have W
Federation support finally okay so if
you're running a working a company like
like to be banks you know insurance
companies these kind of companies they
have double use Federation in use it's
finally there
almost promised really is really soon
really promised yeah and if you are not
seeing it anytime soon
just tweet blow dad he is in charge for
that but yeah it should be it was
promised to be released last year I
think they are really really close now
so you just want to show them yeah it's
unfortunate that that's been the blocker
for many people adopting actually that
was the plaka for many people moving to
a through net core in general yeah
because their their enterprise of
indication system wasn't supported you
know same concept you basically say add
double use Federation give this guy a
name some provide a specific
configuration and by virtue of this I of
indication scheme provider it
automatically shows up on the login page
you can click the button so I have a
hyper-v here running with a you know
ad FS server so that's what we're gonna
use assuming my network connections
gonna get there go back into identity
server which oh you're right we do
actually the one thing we do need is to
run under HTTP for this to work because
a DFS won't let us use that otherwise
good okay we can go login here
now our WS Federation shows up again you
could change that display name and the
same approach is the other one and now
here we are my good corporate login like
that I should hand us back to identity
server beautiful here we are yeah there
you go yeah yeah I think that that's the
that's the second biggest blocker for
many companies the first biggest blocker
for well they're equally big I think is
support for sam'l to P right that's the
other enterprise protocol that that
companies are using again especially
banks government yeah insurance
companies you know assemble sam'l is a
really really popular protocol
and saml used to be only popular in the
java space for a while because Microsoft
was favoring WS Federation right
so they'd equated their own version of
sam'l which was not well conceived
perceived by the Java community so and
Microsoft will never ever support Cemil
because they that's just not what they
want to do right but there's luckily as
a guy from Sweden we all have to thank
him under a blow and he's mr. mr. Sam oh
yeah so whenever I have a similar
question I am I I haven't been Skype so
I can ask him Ian so he's working on
assemble handler for a spirit core
version two so that means you can now
plug in this guy in a spirit core and
connect to your sam'l providers like
education use a similar lot right like
universities and so on a healthcare I
use it a lot that's why he actually
wrote it in the first place let's show
that so we have his nougat package
installed already the configuration
again same pattern as everything else
pop this in here we have to get the
indenting right so there's some you know
configuration about which identity
provider you want to use I'm actually
using his he has a test one up in the
cloud that Anders rotes
wrote and maintains so we can check this
guy out
hang in here and now same l2p shows up
okay and that has now crafted the you
know sam'l 2p authentication request
over to this provider he has a little
test UI that you can use to to say who
you want to be you can even say hey my
name is uh my name is Joe their claim
here email is Joe Joe calm of course
login right sends us back and there we
are
we're logged in as Joe now into your app
or identity server is anyone you think's
mo to appear at work
okay cool
the last thing we want to show is
support for open that you connect right
so more and more companies are moving to
open early connect so assemble and W set
are actually legacy protocols if you
think about it part they are widely used
still right and they won't go away
anytime soon but more and more companies
are moving to actually using Open ID
Connect and one one example would be a
char ID but there are many many others
out there that now use OpenID Connect so
let's add that as well okay should we
actually use identity server with one of
our client applications yep yeah so
actually over here in our sample we
actually have some some actual clients
going through identity server and again
this is a very common configuration is
to have your app only trust your
identity server and then identity server
deals with going to sam'l or to Azure
Active Directory for example so just
quickly in our sample just to show you
how that's configured the beauty is
again same thing asp net core - really
simple the the consuming app the the
beauty of this architecture is that the
consuming app only cares about your
local identity server so in terms of
getting your users logged in so I'll run
the sample app it's gonna go to identity
server to log in okay when I hit secure
identity server then this is the same
login page that we've been using for the
last few minutes and so now in this one
maybe the user wants to go to Azure
Active Directory oh I'm gonna need to
get my one password out okay I'll pick
my account and Oh bit of a problem okay
and have you ever seen this problem
before okay yeah a couple people so it
turns out that especially so the way
these protocols work you see that
basically one is calling yadda and it's
calling the other and you might have a
bigger chain that there is some state
keeping necessary and by default
Microsoft in the open MediConnect
handler uses the URL for state keeping
it as a special parameter called state
on openly connect where you basically
can round-trip state now if you only
have one hope
that's good but if you have to Hobbs it
turns out there's a magic number we just
hit what do you think that is two
kilobytes okay so a couple of problems
with two kilobytes yeah one is our
favorite browser from the North West of
the u.s. right the one with the two
letters only supports two kilobytes in
the query string okay that is you know
they're interested okay just don't use
IE but the other problem is as it turns
out that when you're opening when you
are creating a HIV M or Asha web app
they are wiring up a little firewall
basically in front of your application
and guess to what the maximum URL length
defaults to two kilobytes guess on which
clouds a charade is running I think so
that's not an Asha only problem but we
found it with Asha yeah and you know
that the root cause is really that
abusing the URL it's not really the best
way of doing state management okay so we
we told Microsoft they I don't know they
didn't care because they didn't fix it
so I guess that's what it means so
that's what we did okay so what
Microsoft gives you is an extensibility
point when you're using like Open ID
Connect and instead of serializing
everything into this parameter in the
URL they can call in to your code and
then you can be responsible for managing
the state okay so what you do is you
store it on your server somewhere and
you return a grid or an identifier for
that state and so they will then put
that in the URL instead so that's a way
to shorten up the URL writing that code
is you know and not trivial I would say
so but it's you know it's a hassle and
that that goes along with another
feature in a speed core which i think is
quite nice is that by default you have
support for caching okay that there's an
interface called I do
spirit cache and they have a default
implementation for that which defaults
to in memory right so that you you can
assume that there will always be an
implementation of this caching thing
available to you and then you can plug
in your sequel server or your Redis or
whatever and you will have a proper
disappeared cache so in other words the
right bit right way to do that is
actually take that big URL and just
cache it right instead of sending it
around the globe so for this particular
provider aad
the azure one what we're gonna do is
we've provided a little helper that will
implement that extensibility point for
you okay so all you have to do is go up
somewhere in the DI system and use our
little ad open ID connect state data
format or cache nice name yeah exactly
tell us exactly what it's doing you
indicate which providers that you want
to register this for and now when we use
Azure Active Directory we should have
more optimized URLs so if we go back to
our client or just in general right if
you have to the scenario of having
multiple hops from between the client to
the final identity provider that's
something you might want to use to not
run into problems because maybe your
customers are actually using ie right or
you don't know up front which oh there
we go now it works
I just don't own my password excuse me
well I click the wrong button there we
go excellent okay so that's another nice
thing actually now you know it's pretty
cool yeah that you can just add hand
right hand left hand right hand line and
it all keeps working right I think
that's that's quite nice that was way
harder to achieve in in pre eight-minute
core two days cool oh yeah so welcome
back so regarding Sam oh and us Hestia
handler which is available on github we
have
partner company here in the UK that
produced the other half of the same l2p
support yeah so let's say you have an
old application that only speaks ml to
pee and you want to hook it up to your
new opener econnect based infrastructure
you need something that implements the
IDP di di di dental provider part of of
Cemil and they have a plug-in now for
identity server that you can basically
plug in well and that gives you the
service life support which means now you
can basically have a single sign-on
session across oak MIDI Connect based
applications similar to Pia applications
and on github we have a plug-in for
double use Federation as well so you can
have one big single sign-on session
across all free protocols now with
identity server which i think is pretty
useful good next one the other one that
we got asked about very very often is
how can we extend identity server with
our own API endpoints okay and again
that wasn't easy to do in Prior versions
because of the because of how the
authentication system work right default
authenticate default challenge if you
messed with these parameters in the
wrong wrong they were like you know
unforeseeable side-effects okay given
the new of indication system it's now
super easy to basically add support for
API endpoints which are protected by
identity server itself okay and all you
have to do is add a handler right we
used to say just middleware for that
there's a handler for that now okay oh
good and and it's basically that the
handler for Chase and web token based
authentication know so again this
scenario what we have is an API that we
want a co-host with identity server
rather than setting up your own project
alright here's an example of this
particular API and it wants to use
bearer tokens for their authentication
as opposed to the cookie that the UI
would be using for identity server so
great there's an API I have it's already
registered as part of MVC so that's all
ready to go I actually have a I guess
this JavaScript client here that's gonna
invoke this already
nope I didn't have the handler let's go
do that good point that's a subtle point
yeah remember that you have to give
every handler a name right
the authentication scheme so we called
his handler bearer but you can call it
whatever you want yeah and then on the
authorized attribute as Brock just said
you can say explicitly use this specific
authentication handler from the DI
system and not whatever is configured as
to default for the application which
would be cookies right and dad what's
what's allowing to you know make api's
and web applications coexist now in the
same host having separate off indication
methods that's quite nice
so this helper extension method that we
have to register the bearer token scheme
so this will register bearer which is
the one again as Dominic just said we
are indicating we want to use here like
so you specifically don't want the
cookie at the API you want the bearer
token so that's now registered we should
be able to invoke this run this and then
go find my JavaScript application I
think that evokes this directly so what
I have here is a JavaScript application
actually let me just run the UI and then
I'll look at the code real quick so this
JavaScript application is going to go
log into identity server come back get
an access token and when I click one of
these buttons here call service this is
gonna actually invoke the the Web API
which I have the code here real quick so
the URL is I here it is there's the URL
hosted an identity server and again the
important thing I want to do is send
along the access token to secure that
call right so I will go login I think
I'm actually already logged in because I
did Azure ad a minute ago
oh no maybe not who are local user and
then I can now invoke the service accept
JavaScript applications trying to call
api's that are running somewhere else
yeah yeah the same origin policy in the
browser so yeah of course yeah right
so yeah that's not going to be allowed
by default so you do have to set up
cores in the API to to make that work
now again this is all hosted and right
now an identity server we decided to put
the API there that's fine you can set up
the cores middleware in asp net core
like you normally would in any other API
project identity server though already
has support for cores because that
javascript client had to connect to it
and you know to do the protocol work so
what we could do is actually just
leverage identity servers existing
course feature to configure that
so in identity server we already handle
cores at certain endpoints that that spa
application might want it and you know
interact with so you can just come into
the identity over configuration say oh
by the way include this other path into
this hosting application for the your
built-in core support so our cores paths
or things like the the discovery
document and things like that so this
just adds your custom endpoint as one of
the other you know cores endpoints in
other words you can leverage our
configuration system to to create a
cause policy so you don't have to
specify the origins again because they
are already yeah we already have this
for the spa application in our
configuration over here somewhere
so I've already done that for the spa
location okay
so it's kind of a poor man's version of
using the built in middleware and the
coolest thing ever just one thing to
show you it off off script surprise what
is this go go to startup and identity
service yeah okay and go to the options
and do option start discovery dot yeah
add a custom entries or add and you can
now also add your custom API endpoints
to the discovery document of omadi
connect so that your clients can
basically programmatically find these
and if you do tilde something then it
will actually also
use the base URL then chose a redneck or
beauty at the end hey hey wait all the
API so where's my spa here we are I
guess this guy I should now just be able
to hit this ah there we go here are the
results a refresh that have to call the
service UD so yeah so the back the
background is that some people want to
add you know additional inputs maybe
maybe you know that they have
applications that need to download a
list of you of users you know something
like that where you think that that
actually should belong to the identity
system so in Prior versions you tended
to create new API for that now you can
just put them into the identity server
make it one deployment I think it's it's
useful for certain things okay Wow yeah
lookout is hard
did you know that so it turns out that
lock out is so much harder than then
doing log on right not everybody
realizes that because you know Oh Logan
it's working job done right but we have
many customers where you know they had
their assumption is if you log in to
five of the applications and they press
the logout button in one of them if you
want to make sure that all of the data
is getting cleaned up right and I heard
a really wise saying recently it says
the data is the pollution of the
information age right it's much harder
to delete it than to accumulate it and
that's exactly why logout is hard it's
much harder to get rid of all that state
floating around then just create new one
right so that's why the oak MediConnect
spec actually has free specifications
talking about logout yeah and why free
well because some one or the other might
work better for the type of application
you're building yeah so one is for
travel as sparse as we call him today
right JavaScript based applications that
was the actual actually at the very
first one day
Road and then people said yeah but I'm
not I'm not doing spas I'm just doing
conventional you know server-side render
web applications like MVC so the Edit is
thing called front channel notifications
which was very much how seminal and WS
Federation did things and then some
people said yeah but there were some
issues with front channels where they
added a third one which is called back
channel so we we used to have support
for the first to just show the front
Channel real quick so that the way the
front Channel works is is that in
identity server we basically keep a list
of all the applications you locked in
and when D and then Ed logout time you
tell the server to lock out the user we
actually on the log out page where it
says you are now locked out basically
yeah we have to render under the covers
an iframe for each client application
you logged in in in that iframe we have
to hit their log out end point so they
have a chance to clean up all of their
cookies and data and caches whatever
does that look like a hack well you
probably right but that that's the way
it works yeah it's officially how the
spec says you should do it okay now
there are a couple of issues with this
approach it's a best-effort approach
right what happens if you you know like
that the browser only has a limited
number of outgoing connections at once
right I think six ma'am so let's say
you're locked into ten client
applications then we will render the
first six iframes we have to wait until
the day they come back right and then we
can render one after the other so we
have to queue it up what happens if the
user is like nervous or impatient and
goes away from that page before it's
completely loaded it will not be logged
out everywhere right so that there's a
chance that some application you are
still logged in IE again has this weird
feature of sones network zones right so
when let's say your IDP is in the
internet zone and your application is in
the intranet zone you are not allowed to
open an iframe across that zone for
example solo god will fail
okay any other problems as this
problematic all over so it's they call
that a best-effort approach you know
what to be honest with you that the best
lockout feature is built into every
browser it has a like a red cross in the
top but you can close it that's the my
my preferred one yeah now there's a
third approach which is called the
back-channel notifications and that is
considered to be more reliable generally
speaking because you're not relying on
the user's browser doing the right thing
for you okay and the idea is that an
application in its back-end provides a
lock out API endpoint okay and then at
logout time we can call this Lookout API
server to server so to speak yeah send a
special Chase in depth token that tells
the the application which exact user the
subject claim in which exact logon
session you want to log out and then
what the claw at the backend has to do
is it needs to remember that and
basically that the next time it sees
that user coming in kick him out okay
it's more work for the client
application but it's generally
considered more reliable if you have
this strict requirement of a clean
logout okay the other problem I mean the
problem you have with this approach here
is obviously there must not be a
firewall between your IDP and the client
application right otherwise this won't
work okay so I guess the summary is none
of them are perfect right you have to
use whatever works best for your
situation so just one note about this is
that the Microsoft in if you're building
the client the MVC application that's
using the Open ID Connect provider and
you're using ASP net core the Microsoft
Open ID Connect handler supports the
front Channel but the back channel again
came along later this just recently got
completed as a specification so
unfortunately you have to implement this
manually yourself in an MVC application
okay we do have some sample code for
this do we have time to show that
or not we have 15 minutes yeah so
identity server when you're configuring
your clients okay we have a couple of
different clients here so we have one
that is doing the implicit flow and if
you want this to participate in the
single logout event you can configure
the front channel logout URI and if you
see here it follows kind of the pattern
that Microsoft's done for all of their
authentication system sign-in - Google
sign-in - whatever so this is the sign
out endpoint and then for this other
sample that we have here we don't have a
front channel oh actually it looks like
we did configure front Channel but we
also configure a back channel and this
is would just be some custom endpoint
that you would have to write yourself at
least today in asp.net core so our back
channel logout endpoint basically gets
this logout token there's some
validation that you have to go through
and our sample does all the validation
but ultimately what we do then is once
we validated it like Dominic said we
keep track of who the user is and what
their session identifier was and we keep
some state in the server because I'm
this back channel call we can't clear
the cookie that's in the user's browser
so we have to store this information and
then the next time the user comes in
what we've done here then is on the
cookie plumbing we register for an event
and whenever the cookie comes in we
handle this validate event to make sure
that the user is not on the recently
logged out list so the incoming user
from the cookie the cookie as far as the
built-in plumbing is concerned the user
is fine and then we look and say oh that
user from this cookie does it match our
recent logout list if so we have to
reject the principle which says ignore
the cookie as if it's not there and then
we actually have to explicitly remove
the cookie so sign them out get rid of
that cookie in the browser this would
also work for API backends why do you
would just reject to call it in yeah
okay so a little bit of work but that
codes at least a starting point for you
cool next thing
templates so we've been extending the
templates again we got feedback that
it's sometimes a little bit hard to get
started because there were so many
moving parts right you have to do
protocols and the token server and the
UI bits and an a spirit koi itself right
which we just sit on top and leverage
and so on so we created some templates
that you can just install from the
command line
you think dotnet new and then we think
we have a good mix of what's useful one
is empty just gives you a basic identity
server with all the hosting pips but no
UI okay then we have one which has only
the UI and if you would put them
together you would get something that
was working actually yeah we have one
with a spirit core identity as its
backing store now so again that's a very
common scenario and we have one where
all the configuration you know like
clients and resources are now in in a
database as well again common
configuration so you just when they
install sure so right now if we do net
new on the command line these are all
the built-in templates provided by the
SDK from asp net core so we don't yet
have the identity server templates so i
have the URL for that so i can copy and
paste it so actually this is up on
github
all of these templates you can go take a
look at them if you find a bug feel free
to submit a PR and templates are
actually just NuGet packages so if and i
think they are really useful so like if
you want to in your own company create
some internal templates for certain
project types you're creating over and
over again like api so yeah just have a
look how that works it's actually pretty
simple it's just a normal project with a
with an extra file that has metadata in
it basically so the name that we're
passing here is the NuGet package
alright and so this is going to go
download the new get package and cross
my fingers that the connection works
yeah looks good right
and now we have alright any server
templates here just for giggles open to
the born with a teen identity for
example this first creates the template
and then we can basically create a
sample database which has test users
like Edison Bob obviously right and
justice graves at their database and
then you can just do torrent run and
that's it I tell you you have something
to play with
am i running elsewhere already yeah good
so that's a new copy of identity server
running and I should be able to log in
now Ellis Oh Bob alright so just let you
know you thought the to test queues as
we put in there good
that's working and they live right now
in sequel like database okay if you want
sequel server just can't change the
connection string and the provider
you're using okay so it's just using
entity framework so you can plug in
anything else Postgres they all work
yeah the other thing we've heard a lot
is that especially for you know
development time the number of options
we have like configuring a client you
know configuring resources it's a bit
overwhelming and I'm sorry for that
that's just the way it is I guess we
have many options we are pretty flexible
so there's a company in here in Crystal
that have a commercial product called
admin UI and think of it as a
full-featured basically web-based UI
tool where you can do user management
create users you know reset passwords
assign users to roles assign users to
claims and on the other end setup client
applications like you know and the day
they've like a little wizard interface
for sparse and native and
the one 4/4 so we asked them basically
if they were OK to create a Community
Edition for that last it says something
for free and basically they did that it
has some limits right I mean they want
to actually you know sell the thing as
well so but for development time you
know you have some test users to work
with you can set up some clients to
actually and you know don't have to
learn the configuration system first
before you can do anything useful with
identity server and the nicest thing is
I guess it's also part of the templates
right so you can just basically to.net
new is for admin and you're basically
getting the same identities of a part
with an embedded admin UI ok and when we
run that it does all the necessary
sequel magic under the covers yep
yes the admin you I'm just pretty quite
a user maybe just to see how that looks
like that's one thing you can do the
other thing that's very common is you
want to create a client application for
example yeah so let's add a spa whatever
okay and here basically is your UI
client ID display name I think that's
that's all that's all optional that is
not optional
look how do you arrive well whatever
okay and then now you can configure to
which resources does this client
application have access to and and you
know all the things basically yeah you
can create new resources and so on so
yeah if that's something useful to you
you know just want to play around with
that without having to learn all the
little nitty-gritty details of the
config system I think that's that's
that's something nice okay next one so
the very last thing is again we got
feedback from people saying we'd love to
contribute to identity' part it it's
very hard and yeah again I'm sorry I'm
it is definitely a difficult topic but
also to be honest we didn't make it
super easy because you know we are used
to work together for so many years we
will be sometimes just added some github
issue as a reminder for ourselves
basically like oh yeah we have to do
this so now we for you know our New
Year's resolution if you want is to
break up the tasks into smaller pieces
we registered at up for craps that's a
website which takes care of basically
all the open source projects out there
that invite new contributors basically
we have a label called Help Wanted so if
you wanna you know just play around and
maybe look how it's how it is like
contributing look for that label
there were there were right now five or
six issues that we think are good to get
started so that's one thing if you wanna
help other people Stack Overflow is a
really good place there are many many
people are having questions or on
addenda server and there are already a
number of people actually really really
active so if you know if that's
something you want to do that's
appreciated you get also points and
patches you know that's really the
important part here and if you work for
a company that uses identity but
commercially you might want to talk to
your boss or whoever and ask him if he
wants to sponsor the project right
because we make you know we need to find
a way to make that sustainable with the
crowing number of users we have so
there's a patreon page where you can
basically officially sponsor the project
and actually there are also some nice
advertising options so if your company
wants to be you know presented as
open-source friendly and the very last
thing is how can we help you we do
training and consulting which I see the
workshop yesterday and the day before we
have a brand new website because many
people said like yeah it's really hard
to sell identity server to my company
because you don't have a list of
reference customers we finally fixed
that because you know normally these
projects are under NDA so we asked all
of our customers do you want are you
okay with you know being publicly named
so to speak so if that helps you making
the project you know more attractive to
your company you can go there and and
also related to that if they want to be
listed as well I mean that's okay yeah
and the last thing is if you are running
identi server in in production or if
that is something that is you know you
know you want to do we have an
infrastructure now to give you basically
production support with an SLA you know
like
guaranteed response time and and these
things okay I think that's it that was
the last year work thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>