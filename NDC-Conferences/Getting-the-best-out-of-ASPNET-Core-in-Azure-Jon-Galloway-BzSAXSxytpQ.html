<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Getting the best out of ASP.NET Core in Azure - Jon Galloway | Coder Coacher - Coaching Coders</title><meta content="Getting the best out of ASP.NET Core in Azure - Jon Galloway - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Getting the best out of ASP.NET Core in Azure - Jon Galloway</b></h2><h5 class="post__date">2017-02-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/BzSAXSxytpQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">who here was in our asp net core class
anybody all right this is all new stuff
mostly compared to that there was a
little bit of stuff where Damien just
went off about app service because he's
an app app app insights because he's he
wants to be an evangelist for a paean
sites but other than that this all new
so I'm gonna be talking about getting
the best out of a spinetto Azure when I
originally signed up for this talk I
thought well I know a good amount of
stuff about asp net core and i know a
good amount of stuff about azure and so
the Venn diagram there's there's gonna
be enough for an hour and it's not
really gonna be that difficult and all
that then as I kind of dug into it more
there's like all this other stuff
floating around out there and what I
really ended up with was that there are
not just you know a few different things
but there are a lot of things and what's
really the interesting thing is all the
interconnections and how they all fit
together and this is all completely
impossible and we're going to die so
it's what I did that what I took another
look at was I came back - what are some
things that are useful to know about so
this obviously it could be a week-long
course I'm gonna talk about some
high-level things good things to know
about so we're gonna work across
deployment options troubleshooting a few
performance tips security tips and
monitoring and diagnostics I'm gonna
spend the majority of my time on
deployment options and monitoring and
diagnostics and I'm gonna try and point
you to resources things to know about if
you wanted to dig deeper into them so
let's start with deployment options I
love to use the slide because this girl
is calling a cloud or she has an
umbrella shaped like a cloud or so and
she's on a moped and I just think it's
great so we're gonna talk about
deployment options first so you know the
easiest one of course the simple one to
start with is a visual studio web deploy
and so there's there's two ways to do
that and one is file new project deploy
and the other is a self-contained
deployment
and whoa I thought I had a demo slide
that's fine Visual Studio web deploy I'm
actually going to just start with that
and I like to you know have a short time
to first demo so I'm in under three
minutes and that's pretty good I'm going
to be using Visual Studio 2017 RC and I
usually tend to use community I want to
show things that you know this is free
and and not have that be a barrier who
here's using Visual Studio community
sorry Visual Studio 2017
you ready okay cool I'm enjoying the it
is running side by side with 2015 fine
for me with there's one exception where
it can mess with your path or that's
pretty well-documented but and I'm no
longer projecting so that's good too I
have no longer been projecting for a bit
now right and you guys are just you're
just gonna let me do that wrench you for
the entire the entire rest of the hour
then as I walked out I'd be like oh
alright so so I'm gonna start with just
simple file new and I'm just gonna walk
through this amazingly quick so I'm
gonna do file new no authentication web
app I'm not going to turn on Dockers for
it I'm going to talk about docker in a
bit and I'll forget to mention this
checkbox so I'm mentioning it now
there's this checkbox on there we click
on that and you can turn on docker
support to run locally and deploy set up
your doctoral files and do all that
stuff so I'm just going to say okay I'm
creating a new web app this is using the
the latest preview for that that goes
with that goes with Visual Studio 2017
as Damien mentioned then he wasn't
supposed to but there's a new release
coming very very soon and so I'm just
going to go straight from here and I'm
going to say publish and then from that
the dialogues changed around a little
bit but so the general idea is oh right
now
I should have a profile I can say oh I
guess I'll need to create another one
fine so I can select existing so that's
it so I'm gonna go ahead and create a
new one so I select on app service and
these are all the different things you
can publish out to including I'm not
going to dig into this but you can also
do a deploy to a virtual machine if you
want so that is one thing so then the
the idea of filling this out you know
you go through you give it a highly
descriptive name as you can see I've
done you go with a so I just general tip
I tend to create tons of resource groups
when I was first when I first saw
resource groups I was like I don't want
to hassle with it I threw everything and
you know I just didn't want to think
about it I tend to try and give things
descriptive resource group names and and
create a ton of different ones now in
this case I've already created one
that's NBC London I believe but I've
found that that's really helpful and as
an example especially as I'm just trying
stuff out I can go through try it see
how it's working for me and then delete
it and what's nice with that is if I'm
creating something like say a Azure
container service where there's like 95
different resources when I say delete it
it all goes away
so that's kind of a nice handy way to
make sure I've gotten rid of everything
I'm not sure at all that looks great
nope I guessed wrong there we go
and I'll say create alright so this is
setting up a deployment profile and I'm
expecting I think it was just a few
seconds when I did it after that I'm
sure who here has never done this deploy
from visual studio to Azure
alright that's worth running through it
because it's pretty darn quick so now I
just click on publish and this goes
through and uses web deploy and deploys
it directly up so what it's doing then
is creating the resource for me it's
already verified that the the name of
the site is available and all that and
not seeing it publishing which is neat
let's try that one more time
what a Polish activity there it is it's
going it just didn't want to tell me
about it that's fine
so it goes through it copies everything
up it makes sure the build runs and all
that and the site pops up right so that
is kind of the very simple quick thing
I'll let it keep going
but the finale is you see a web website
running up and Azure which is you're
probably not gonna be that surprised
with that so I'm actually gonna skip
onto the next thing well it's doing that
and that is the idea of self-contained
deployments so I was talking to David
elbow who's the who's the PM for a lot
of this stuff on app service the
deployment infrastructure kudu and all
that and he was saying that you know one
thing that might be kind of interesting
is the idea of bring your own framework
so for instance when you're running on
app service you are relying on what
they've deployed to app service what
you're relying on their kind of
custom-built
you know images they call them stamps so
you're you're waiting for them to
release the latest asp net core and if
instead of waiting if you want to you
know release a specific version that
they don't have deployed up there you
can do that pretty darn easily so the
idea is if you go to what's called a
self-contained deployment so Scott
Hanselman has a post on doing that and
it's really not a whole lot of steps the
main thing really is that you are going
through you're specifying your runtimes
that you're going to support so that's
that runtime section and then here you
do dotnet build a char and you can build
for a specific thing right and then you
publish so your dotnet publish - see and
you release you you create a release so
it is a specific you know key - in a
certain oh s and so instead of just kind
of publishing it up - as your app
service and saying you build it you know
figure it out for me you're saying I am
building this thing and it includes all
the dependencies with it so in this case
this is going to look like not scrolling
which is interesting so there it is so
you're gonna end up with a folder that's
that's got all the stuff in it they also
have this is the project json-based and
they also have one this out on the if
you search for self-contained deployment
you'll probably find it but this is in
the official asp net or dotnet box and
the self-contained deployments here
spells out what you need to do for that
so in this case this is actually a it's
not the newest newest asp net core but
i'm assuming you're not all immediately
rushing out and deploying the newest
newest every day anyways but this the
general idea here they walk you through
doing it and it's the same sort of idea
you set up Property Group you know which
which you list out who you're deploying
it to and then it's the same dotnet bill
of dotnet publish when you do that you
have all your files and you can deploy
that all directly up right you can do a
simple you know FTP or whatever so
that's the idea there see what's going
on there and I think you are done that
cannot fail simple demo and it's already
off the rails so let's go on to do
deployment scripts so the idea with Q do
deployment scripts is the who here has
no idea what I'm talking about when I
say Guddu okay there's probably more of
you so kudu is this kind of secret
behind the scenes deployment engine that
can handle deployment and it handles all
this like continuous deployment and so
for instance I think actually have a
next one they're in a it's after that
these are my demo slides I always like
that continuous deployment is the idea
of I hook up my I hook up an azure app
service to a repository right so in this
case I'll go and do that so since the
visual studio based demo is not going
well I'm gonna I'm going to switch
around and do an ad your app service
based appointment and that's not
clicking either let's see
No all right
can't stop me so what I'm going to do is
I'm going to create an app service and
then I'm going to point it at a repo and
what this the advantage of doing that is
every time I push to that repository app
service is watching for that kudu is
watching that specifically and it goes
and it will pull the changes and it does
or us build it's it's got a very smart
sync system where it only pulls what it
needs and yeah okay I see ya all right
let's go to Chrome then one strike
you're out so and never mind those okay
totally gonna work okay so so kudu is
that infrastructure and it's actually
relatively complex what it's doing is
it's checking out the files it checks
them out actually to a share it's not so
there's actually two different drives
associated with app service every app
service you have there's a local and
there's a home and local is a fast drive
but it's not permanent and the reason
for that is if you scale up or down if
you know app service has the ability to
kind of move you around to different you
know if one thing needs to be shut down
another will be brought up so those
local drives those local instances are
not going to be permanent also anyways
if I scaled something up the new local
drive is not going to be the same on
each one right so the way that that
works then there's also a share and it's
called your home directory and what
that's doing is that's actually running
on a blob storage and it's using a a
symlink and it's pointing over to that
so kudou is doing this thing where it's
checking out the files it's using that
share it's doing the build and it's it's
copying the stuff over that you're going
to need like for your dub dub dub route
etc onto your local drive all right
let's see if this see that one's working
nice alright so I'm going to create a
new web and mobile web app I'm gonna
call this Thank You your face it's
available she get monkey face comm okay
we're gonna do existing
there we go I'm not turning on insights
just yet but we'll let's go with free
Northern Europe sounds good okay so this
is spinning up normally this is going to
take like 30 seconds or so right so once
that's done what I'm going to do is
click through to my deployment and say
instead of publishing this directly from
Visual Studio up to a vApp service
that's that's fine for something quick
or you know honestly if it's your blog
or you know if it's just something that
only you know one developer is using you
can kind of get away with that but in
the real world you're really going to
want to be doing continuous deployment
and so there's support for for
continuous deployment from github other
get endpoints there's visual studio team
service you know all kinds of different
endpoints you can use right so I'm going
to go through and click on deployment
options configure required so these are
some of the different ones there's some
interesting ones here like you can have
it deployed directly from like onedrive
or bitbucket etc Dropbox so I'm gonna
point it at github and it should out its
I haven't logged in yet on this one so
it's going to make me do that
let's see if I authenticate it on github
here recently good I have okay
so it understands the different
organizations I'm in the different
projects I've got one here asp net core
app service for this one literally all I
did was this I created a new repository
and github I cloned it locally I you
know you can go either direction but I
cloned it locally I did seem to have a
thing for my keys I did dotnet new you
know st for template web and then so I
did I get a git clone get add get commit
what uh whatever and then I did a get
push right so that's all the point is
that's all that's there it's there's no
special kind of hook up of anything
right so that repository is just a
repository that holds file new project
of an MVC application so this is going
to go through and start that deployment
ace compared to classic asp net the asp
net core get base or ya get based
appointments are taking a little bit
longer in general they are working to
improve that quite a bit
but they do take a little longer maybe
than you're used to so let's go and see
where that's at
deployment succeeded
so now if I click through again on
deployment options we'll see where
that's out so yeah it said created and
it's now building okay as its building
I'm gonna switch over and show the idea
of a custom kudu deployment script and
the idea with that that's a more
advanced thing but that allows you to do
quite a bit more with customizing what
exactly is going on with your deployment
so they have all these hooks and you can
create ones this is a deployed ps1 and
the reason the reason this developer
created this I'm pointing actually this
is on a an issue on the this is a public
issue on github and this was an is an
issue that's been closed because it's
been fixed but with the asp net core
module and the problem was there's this
app offline HTML file that's used as a
placeholder so when a new deployments
happening this app HTM or offline HTM is
written the site knows it's offline it
just serves that file the problem was it
was case sensitive so apps or so it was
being written by deployment as capital a
app service but the asp net core module
was was watching only for lower case and
it wasn't seeing it so what somebody did
here is they said you know what I can
solve this and actually created a
deployment strip and so this is this is
very easy to plug in and what's kind of
neat with this is they they just as part
of this deployment they copy from a
template and they set a new they set a
new output what's what's cool if this is
they actually created a separate
template and they're able to customize
how exactly their offline script looks
right so that that's kind of a more
advanced interesting thing you can do
let's go and see if this is done still
building all right so so there we go so
that's continuous deployment yeah we
just like to get hub one other thing to
be aware of and kind of I actually did
this on purpose this way because the
deployment is like I said is a little
bit slower it's still
a few minutes but it is a little bit
slower another option you've got is to
use something like continuous delivery
so the idea is I'm deploying I'm going
to want to use deployment slots who here
knows what a deployment slot is okay
cool so so that's actually let me pop
over here again you have this thing okay
so so it is actually live now right so
the site I've deployed is live I can go
through and click on it and we should
see the file new project for asp net so
it was deployed but it was not spun up
this is another issue right so for the
first hit even of a deployed website
it's got a you know it's got to spin up
it's got to wake up and and do their
kind of first initialization stuff right
so there's a few ways around that one is
to use deployment slots so the idea with
deployment slots and this is on a free
plan but you click it and it says what's
the name of the slot you can you just
start filling it up you can have as many
deployment slots as you'd like so you
don't just have to have two but a common
ways you'll have one that's staging and
one that's production and the way you
set it up is you deploy to staging and
then you have an internal private URL
that you can hit and it's it would be in
this case monkey face - staging dot as
your websites dotnet and then I go out
to that hit it make sure that it looks
good when I'm ready then there I click
this swap button at the top and that
switches positions and it makes the one
that I deployed to a staging it promotes
that to production and takes the
production one and takes that back to
staging what's there's a lot of nice
things with that one and I'll get to
some more of these later talking about
configuration one nice thing is that I
can preview it make sure that it works I
can always look at the offline before
putting it online so I essentially get
two sites for free another nice thing is
that I can have slot specific settings
and one final thing is that I can
preload in
you know like a lot of the time the
first hit on the site like we saw there
took a few seconds for the site say like
yeah I'm here in just a sec let me get
that page for you so if I can pre-warm
that and maybe my first load of the site
is seeding data or it's it's doing some
other you know caching and that kind of
stuff so I can do that first hit before
before swapping it to production and
making it making it just pop up
immediately so I can do that stuff
manually I can do that using a using
things like kudu deployment scripts
where I can you know go in and ping it I
could even get creative and use
something like Asher functions and and
do some sort of automation in there I
mean I've seen people do that here's a
here's a kind of more holistic way of
doing this this is definitely more of
the if you're living in the visual
studio team services world but but
actually this does have support for get
as well so it's not totally true but the
idea is you you have this whole cycle
where you have code build test and
deploy and so you have automated tests
that run and those can include things
like verifying the site is up that's
that you know the response time is okay
and all that and then it will
automatically swap into production so
make sure that everything is up and
running and then switches it around cool
alright so that is the standard kind of
app service stuff another interesting
thing is app service for Linux is anyone
used to app service for Linux yet no
good I didn't think so actually it's
very new so it's actually kind of
mind-blowing app service for Linux is
running in Linux and it uses docker and
the idea is that you know it uses docker
containers which gives a lot of power
for you can have multiple containers you
can have different images and all that
it's it's a pretty efficient way for
managing that kind of thing that I was
pointing out that Kudo is doing the
interesting thing here is there's
support for two different ways of using
ASP net core under app under app service
for Linux so one would be if I go in I
can create a new one
so I could say web and mobile and say
app service web app on Linux so
okay and then we'll say existing again
I'm gonna pop it in to the same one
there it is
okay cool so here where it says
configure container
there's a bunch the the kind of the
customer requests that really kind of
drove them to build this was more PHP in
node those are there's some things that
are in the PHP in node world that really
kind of work best on Linux and they said
that's fine if that's what you want to
do you'll see down here at the bottom
there is this option for dotnet core and
so I can go in and I can I can create it
using that so what's also interesting
though so that's the kind of I want to
spin this up and then I have to create
my docker container and remember that
checkbox I said I'd forget but I
actually remembered that is in Visual
Studio so if I'm creating a docker
container I can push that up looks like
I'm gonna be late for a meeting
and and so that works but I can also
point it at a docker repository so I
could go in and I could let's just go to
quiet hours cool I could point it at a
private repository or I can point to
something on docker hub so in this case
the PM for this is created he did
deployed NBC music store up to docker
hub so his name is Nazim Nazim voila and
it's Music Store so then I click OK so
it's going to validate yes that exists
and then it's doing this docker
deployment so it's pulling that image
down from docker hub it's 114 megabytes
for this image so this is a pre pre
baked image that has has kind of
everything in it that's that's necessary
and I should have clicked create so
before you know talking so the
deployment on thing is I'm actually
seeing this is really fast this they go
through and and usually go go pretty
quickly so
there it is - succeeded cool and so so
again those are the they kind of all of
these the whole system for app service
on Linux works with docker and I can do
it by you know going through and saying
this is my thing and then uploading my
docker you know pushing my docker stuff
from visual studio or uploading however
but I can also just say don't you worry
about it here's my docker image and a
neat thing with that is that that docker
image it doesn't actually it can be any
docker image like as long as it's a
docker image that will serve a web app
there's examples where they're serving
Ruby on Rails or whatever so that's
that's you know kind of an interesting
thing and then here this is just kind of
the standard NBC music store example
right so kind not kind of but it's it's
different so and I'm glad you asked that
because I was going to forget to show it
there's in kudu there's a whole kind of
system where you can go and see what
it's doing and how it works the short
answer to your question is not really as
soon as I go in and configure it
pointing to a docker instance then if I
go in and say deployment options here I
believe it's gonna say oh so there's
ways where you can go through and it'll
say no you can't do that anymore because
you use this other one but in this case
yes I can point it like github right so
where was I what else was I gonna say Oh
as far as kudu goes so kudu has this
whole kind of deployment system but it
also has kind of a back-end where you
can go in and look at what's going on in
your app so anyone use this before the
advanced tools stuff that's pretty neat
so this will go through and it'll show
me what's going on in my environment
this is very handy for diagnosing what's
going on in your
dot NetApp's so i'll show you more of
that in a second but I also can go in
and do things like in this case because
it's running on docker so it's a Linux
instance so I can go in and I say LS and
I can start start doing Linux stuff and
get myself in all kinds of trouble
I don't know start deleting bin or
whatever so anyways that's that's kind
of the whole Koo do you think so the
well the kind of infrastructure stuff is
different the idea is that you know the
the app service what it looks like to
you as a consumer should be the same so
that's kind of the idea all right so
that's that's app service for Linux and
the idea there is this works great for
single docker instance so if I have one
single docker instance I want to deploy
it I can auto scale but it's going to be
just that one docker instance so the one
other thing is if I want to get there's
that if I want to get a little bit more
fancy there's the azure container
service is anyone using Azure container
service okay and cool as your continued
service I actually I debated back and
forth and back and forth about doing the
demo on this it's not super hard but it
is time consuming and it's I don't think
it's super worthwhile in this case but
let me see if I can there it is there's
good documentation on it actually if you
go on to let's into the docks for Azure
container service I love Anthony choose
post on this though he basically walks
through how to do it so once you've got
a docker the idea is as your container
service is a whole service that can host
multiple different things it has
advanced stuff they recently introduced
support for kubernetes there's also dr.
swarm and mezzos docker swarm is
probably the simplest if you're used to
docker because you basically just run
your standard docker commands and it
farms it out to the whole kind of swarm
so I just say docker you know doctor
billdocker run and it says fine and it
runs it on all of them but there's also
like I said support for kubernetes etc
so the idea here is I can I have to SSH
that's the one thing a simple way of
creating a doctor thing is to use yeoman
so if I do yo asp net it will create a
docker file I can also inside a visual
studio I can create a docker file just
right-click add docker support or click
that checkbox when I started the docker
file here they're showing how to monkey
with the docker file to make it work you
don't have to do that anymore it's all
set up so it'll just work and then you
do docker build docker run it things for
a second and then you you get your your
endpoint to the swarm from inside of the
inside of there and then it runs it does
the whole kind of spin up of the
container service takes me a good say
five minutes because you're maybe a
little more you're spending up virtual
machines there's load balancers there's
all kinds of stuff going on so the idea
is again that if you want just simple
simple docker instance not you know
that's it and you might scale it to have
many instances but there's there's not
really much going on you would you could
use app service for Linux if you want
more advanced things if you want to like
something like kubernetes or meso source
warm you can do some orchestration where
you can say I would like you know this
group of these things to hook up to this
group here I have networking in between
them all I can have this as my you know
whatever data services cluster and this
is my web tier cluster and all that and
I can I can manage that and that's where
you'd go to something like as a
container service
all right we're a half hour in and we've
covered one of the five but that
actually was kind of a I wasn't I was
planning on focusing on that so let's
talk about deployment troubleshooting
and an important point with deployment
troubleshooting one of the key things is
to know how it's actually being hosted
under app service or is really and the
whole thing is asp net core module or a
MCM and so
the idea with this is actually your
request comes in to iis which connects
to the anc m asp net core module or is
runs asp net core module and then the
asp net core module spins up kestrel and
there's this connection between them and
then kestrel is actually running inside
your application that that's actually
something that took me a little bit to
realize Kestrel is not a separate
executable it's not a separate server
running somewhere it's actually a new
get package you pull into your dotnet
application once kestrel is inside your
application your app that gives your
application HTTP serving capabilities
right so your dotnet app is now a web
server it's not a battle-tested super
secure web server it's a lightweight
HTTP server so you don't want to throw
an app with kestrel out on the internet
because it's not it's not battle tested
right it's not you're gonna get hacked
or you're not it's it's not tested for
high performance secure web serving is
is HTTP sis listener is but but not
kestrel itself right so anyway the idea
is that you've actually got this reverse
proxy thing going on and one of the
mores most trouble prone areas is
actually this connection when it
connects over and wakes it up and says
are you you know startup when you're
when you're when I have a response for
it from you what's the port we're
running on there's a handshake that kind
of goes on and then it then there's this
connection over HTTP between is and your
app ok so one of the more common areas
where you'll actually find something
going wrong is in that step and a
there's a great post on this and it's
there it is radiologic so this guy is
actually on the team and he I if you
remember nothing else from my my talk
really I recommend you go and look at
this because he does a great job of
explaining the whole kind of dance of
how it loads up and gives
of a checklist of here's what I pointed
out as far as how how they kind of
connect together and then there's this
interesting stuff in here as far as
what's going on inside your app as far
as how I asked knows about Kestrel and
they is peanut core module so there's
actually a handler this asp net core and
that's where that module is kind of
mapped in so we originally told you with
asp net core that you weren't going to
need web config and that's mostly true
and they're actually doing work to
completely remove this again and make it
just magically work but the idea really
is by default file new project you will
get a web config but it's just these
lines that just say like hey IAS or app
service running iis point you know this
is how to run this module that it
connects over there's some interesting
stuff in here too because asp net core
this thing here has these arguments and
some in there include things like
logging to a standard standard out so
you can log that to a file and that's
that's something that can be useful as
far as troubleshooting so anyways that's
kind of the idea of how that works he
goes into a lot of other things and he
points out some things as far as
troubleshooting make sure that the
module is installed you know that sort
of stuff so very very kind of detailed
check of how to do that cool so anyways
that's kind of one of the kind of key
fundamental areas is understanding how
is and app service are both connecting
into your app and it is a difference if
you're used to the old model where is
pretty much directly hosted your
application it was kind of is and your
app is inside it and here it's now is or
nginx or whatever is the the proxy web
server that's pointing over to your web
application so as I mentioned there is
that log to standard out and that is
really helpful for if there's something
with asp net core module unable to
connect when you get
this they call it the white screen of
death where you get this HTTP 500 error
and it's basically asp net core module
saying like i don't know what happened
and what's what that means is that this
handshake didn't work like nine times
out of ten that's going to be the issue
is asp net core module tries to connect
over to your application and there's a
problem in the handshake there's there's
a there's a I forget it's not a secret
but there's kind of like a handshake key
a token that's it so if the token
doesn't match up if the port doesn't
match up etc then it'll say hey you know
this sorry couldn't start and the
probably the best way to find that is
turning on those logs to standard out so
how to do that you can do that directly
in your application it's still canceling
so I can go into here and I could go in
and say standard log standard out change
that from false to true I can also go in
in my service I've got an existing it's
not gonna work yet that's just gonna get
confusing if I have to dashboards open
right so if I go in here I can turn on
things so this one's on Linux so that's
I'm gonna switch over to my other one
Monkeyface
okay so in this I can go into my
application and I can start turning on
that logging stuff and there's actually
some some changes we just recently did
in order to make that easier to track
and so that is under under logging
so I have settings here log
there so here I can go in and I can say
which by the way I don't know if you
caught that there but that list gets
kind of long you can just search at the
top for it and it'll narrow it down so
here I can go in and I can say
application logging and I can I can also
show in and I can set the different
levels and application lobbying logging
to blob and I can start controlling
where that stuff goes as well so and
then logging to blob storage obviously I
have to can configure a blob storage so
there's also the koodoo console and i
mentioned that a bit before and i showed
it in the context of the linux app but
in here I'll show you what it looks like
for the kind of Windows based one so if
I go in to the console area so this is
really pretty interesting there is a
console here and I can do you know I can
go and I can start you know messing
around on it I don't like this console
as much as the one that's actually just
in the advanced tools and there's also
this editor preview so they used to call
it Monaco you can go in and you can
directly edit files right so I could
also I could go in here go to my web
config and change that log to standard
out as well but I'm not going to do that
what I'm gonna do instead is I'll just
bring up this advanced tools so this
advanced tools if we zoom in on this the
URL for that you you just take your URL
and put dot s cm so Monkeyface dot SC m
dot as your website's done that and then
this is kind of backstage thing who here
knows has used kudu a good amount like
okay yeah it's it's one of those things
where like once you know about it you're
like yeah that's cool a lot of people
when I show it to them they're like what
I never heard of that before so you can
go in and you can do you can go into the
environment and you can see all your
environment variables this is really
handy for seeing things like you know
specifically what's going on as far as
like what never
what's my path all that kind of stuff
right so that's handy I can also go into
there's this process Explorer and in
this case I'll see it's taken a bit to
refresh here I believe there it is
so you'll see here I've got some I have
note on this I have the dotnet exe
running on you know being connected to
by the
w3w C or whatever that guy and what's
interesting is I can go into here and I
can do things like I can start profiling
but I can also click on properties here
and I can see things like environment
variables and there's some specific ones
you won't see in the main environment
variables but you'll see this here and
there's this asp net core and there's
this thing where this is the port that
the front-end is is is connecting to me
on this is this internal port and
there's this asp net core token and
that's what it's using to kind of agree
on that handshake between them right so
there's a ton information in here as far
as diagnosing and debugging as well one
other thing that you can do if I go into
the debug camp console there's a there's
a PowerShell and a simple command base
one and I can start going through and
doing stuff like I can say see if this
works ok so here I am running I can see
the site this is the home drive this is
the shared map drive right so this is
every instance if my site scales every
instance is pointing to this one share
so the advantage is that's all
up-to-date that's always you know I can
push to one place and those files are
served everywhere and all that the
disadvantage is there is some network
latency on that and so there's actually
the sync process where copies stuff over
so if I go to
okay so here's this local and inside of
that I can go to there's app data
there's kind of this is all the local
stuff where it's serving from right and
then you'll see back here this same link
D that's the one pointing back to the
other one
right so it's there there's kind of two
of them and that can be helpful to know
about as well so what am I going for
home
so anyways in here I can go and I can
say like dotnet right and I can see
what's going on I could actually do I
could probably do like dotnet new or
something I have no idea what that would
do but so you know I do have the ability
to do that stuff I also there's even in
here there's some crazy other stuff like
I can you know do local stream I can
download my deployment script so if I've
published a custom deployment script
like I showed you I could go in and and
mess with that
there's some neat stuff on here too if
you go looking around and again this is
on every app service site this is this
is running in the background so you have
all this ability to kind of go digging
around in there if I go so this is this
is the actual site so here I can see
things like you know I can that's all
the stuff that's in dub-dub-dub route so
that's kind of interesting it's got all
this these dll's logo and it also will
have the like local static files as well
right so if I go
yeah okay so there's one other one and
it's it will take me just a second you
can go in here and there's an actual
dotnet cache there it is so dotnet cache
and that dotnet cache again just for
troubleshooting you can go in here and
you can see specific versions you can
see what all is installed in there right
so you make and of feel like app
services this thing off in the cloud
that you don't have much control of in
fact you can pretty well dig in there
and see quite a bit of what's going on
so that's the kudu console
here's that post that I just pointed you
at so in the slides that are gonna be
with this or if you just want to copy
this down to AKMs asp net core hosting
post so this is that post where it kind
of goes through and explains all the
troubleshooting steps and how they're
all hooked together and stuff alright
security just a few real quick tips on
security one is you should be using
environment variables so you know the
days of putting passwords and stuff in
our web config files and then we would
you know have a production one and a
staging one and we'd hope nobody ever
saw or production one or with all those
sorts of things you don't want to put
those things in config you want to get
those out right so config is
configuration not secrets so the real
kind of you know the what you want to
move towards is you have environment
variables local you can set them
directly in Visual Studio there's also a
thing where you can use user secrets
I'll show you in a second and then in
production you fill in the blanks here
inside of your app settings and these
are slot base so I can click on one and
say this one is specific to this slot
every time I switch them this setting
will move with this slot so some will
move with and some won't you can you can
set that up so the idea is that you can
go in and put and put your connection
strings and and all that sort of thing
in there in
stead you can also go in here and if I
right-click on this and I say it's gonna
be on here somewhere manage user secrets
right so this is how I could set things
up for that's how I could set things up
for locally so here it's got a secret
station so I can go through and do the
you know setup whatever stuff these are
my local dev settings I should not put
anything important here and I probably
exclude this via get my good attributes
or get configs you know don't allow this
to be checked in but this is kind of
where you can set up here kind of low
level dev base secrets so then you've
got dev or you can also set them up in
visual studio here and then you've got
your production settings and you can
have because they're slot based I can
say these are my this is my cue a
database setting this is my production
database setting etc as an example to
see more of that if I go to the live dot
live dot asp net site so if any of you
watch the asp net community stand up
this is the code that runs that site and
here he's got instructions on you know
here's how you set it up to run locally
so I showed you that Jason filed there's
also you can go in and there's this
dotnet user secrets you can configure
that and you can push your secrets
directly in there as well so this is the
I'm setting up my you know local dev
settings and then my production settings
are up in the cloud you're never
checking those in that that's probably
the most important thing you're not
checking those settings into source
control so that's that so this is see
kind of like it's simple enough you
should start doing it today it's just a
bits it's the best practice and it's so
easy you just do it right here's the
kind of more advanced you can use Azure
key vote actually is anyone here using
Azure key vote okay cool so the idea the
idea with Azure key vault is it is a
you know it is a real way it is an
advanced secure way of storing your keys
it's cryptographically secure it's been
audited it has support for things like
rolling keys and key expiration it has
support for you know security of who can
see and do what etc so it's it's a
pretty advanced thing you for your
application to connect to it you have a
few different things you have a client
ID client secret so your login stuff and
a secret URI and then that is your this
this is all set up in production you set
those environment strings and then in
your code you write a few lines of code
to read a setting directly out so that's
how you used to do it and if you
actually look at the docs they they say
here's how you read a setting out that's
it's just a few lines of code but it
basically says connect to the vault get
this value casted as this etc but the
cool thing is they actually just created
a key vault configuration provider for
ASP not core so we just shipped that so
the nice thing with that is the set you
can just say configuration settings and
you've got this listed as one of your
things and you just read a configuration
setting so that's pretty cool so it
really makes you know you got a setup
key vault
you got to configure your keys and stuff
in there and then you configure this
here and then inside your code you just
read your configuration settings alright
so that's pretty neat and that asp net
core excuse me the configuration
provider for key vault you do need to
have a few lines also the same three
lines client ID a secret and secret uri
you do need to configure those right now
this is the level to the level 3 for
overachievers is you can configure key
vault to use a certificate for
authentication right so your app service
you can configure a key cryptographic
key for your site and you configure this
over with key vault the to connect via
keys and there's no kind of exchanging
you know there's no environment settings
or anything else you need to set so
those are kind of the things these ones
that keep out
definitely more advanced but this thing
here just do it like this is the way to
do it if you are writing down any kind
of password any kind of thing that you
think would be a little bit damaging or
you just wouldn't like to accidentally
check into to a repository and make
public it should be in here okay and
those things - these environment
variables there's all this stuff the
configuration providers just read from
environment variables that's kind of the
plan for how that stuff works all right
let's talk some quick quick one quick
performance tip actually there's tons of
other great asp net core performance
tips Damion showed some this morning
there's all kinds of things you can do
like pre compile your views etc not
going to dig into that I'm going to show
one thing that is specific for asp net
core and app service and this is the
cached web root file provider so this is
actually something that damien just
recently set up on the live asp net site
and the idea with this is that remember
I told you there's those two drives
there's a slow mapped network drive and
it's not that so but it's slower right
and then there's the local fast drive
that your app actually starts and runs
off of and so if you are frequently
serving up all your static files you
know that includes your CSS your
JavaScript your you know images all that
stuff that it's actually serving up
through the static file middleware it's
got to read that stuff from disk and the
first reader and the reads are a little
bit slower so what he went through and
did here is created this cached of
course it's not gonna scroll for me but
it is a cached web root file provider it
is a few lines of code this was actually
he live stream this thing on YouTube it
was pretty fun where he kind of wrote
through and got stuff working with it
and trouble shot it but the general idea
is the point is this is out on github
and you can grab this and you can use it
there's a good chance we'll ship this
going forward but what this can do is
it'll say four files over a certain
amount just cache them in memory and we
handle all the stuff in there for
eviction for stuff that you know has
been in too long and it's
but the idea is it's just as files are
loaded it'll it'll go through this file
provider and they'll say do I have this
one nope okay read it you know save it
in memory and serve it and then the next
hit just get served out of memory uses a
file watcher to detect changes etc so if
we push a new file if I push a new file
up to that that slow drive then it's
going to detect that it's different and
it's going to reload it on the next hit
right so that's that's just a nice
performance tip there's tons of others
that are more asp net core specific
there's tons of others as well that are
apps service specific again if this was
a week-long course we'd dig into all
those but this is one that's kind of
that nice intersection of both all right
we're gonna we're gonna end up with
looking at some of the monitoring and
diagnostic stuff i've touched on a few
of these one one that i pointed out
before was logging and there's this
really cool thing where you can just
inline you say use Azure app services
there's a package for an app service
logging provider and so it's a single
one-liner in order to configure that and
when you do that that's actually where
this thing that I showed you before the
those logs that I flipped on that that's
actually what the what sets those up
right so that's the thing when I click
on logging that well the the to
integrate together so if if I've turned
this used off servicing and I flipped
that switch then it's gonna write out to
that and that was something that was new
in one one this app service integration
stuff so another big thing is app
insights so app insights is a pretty
in-depth thing that tells you a ton of
what's going on in your application
pretty easy to hook up and it'll like I
said it's at the very simple level you
do one or two lines of code in order to
configure it and then it's going to
start monitoring all kinds of stuff uh
including everything I'm logging and
just kind of general startup and
failures I can also then instrument it
quite a bit more so I can start turning
on additional things I can
add write additional things the logs and
then pick it up but the very simple like
click a couple of switches is is kind of
a no-brainer so so let's go and look at
the site I just did so I'm gonna look at
okay so here's an example if I say of
why I do that stuff with resource groups
I can go in here and I can say here's
this resource group that I created and
this is all the stuff that I've spun up
under it right so I have one in here now
the thing I didn't count on is which is
the one that's this one here because it
has app service hooked up so here's a
web app that I spun up yesterday
afternoon and I configured app service
for it and in order to configure app
service I did just a few lines of code I
did they have this kind of walkthrough
thing of here's what you need to do you
when you sign up or when you configure
app service it gives you kind of a key
if you click through on here's how to
configure it it'll give you just a few
lines but it actually so it and this is
your this is a key that you'll add to
your app settings Jason and it's just a
simple instrumentation key so if I go I
think I might have it running still if I
go in here and look at my app settings
there it is
there it is so that's just a key that I
popped in there right but this has
actually gotten a little bit easier
because in the newest newest thing with
this - Oh beta one the older one had
said like go here go to your you know
can register this service do this other
thing now it's really just a couple of
lines I'm gonna go so zoom this way so
in your view you'll add this thing and
you'll say HTML raw in order to kind of
this is all you need to do you inject
this into your one layout and then this
is tracking all your JavaScript stuff
and there's also this there's one line
of code I'll just show you the code of
route if we go into program now start up
so in start up I add the services add
application insights confited telemetry
and so that's it
okay so now let's look at some of the
stuff that we get out of that and I'm
just about out of time but this is
really quick to show so this is once I
do that I'm going to start seeing all
kinds of stuff as far as what my apps
doing I can see and you can spend like
hours and hours going through all this
this will show me all the kind of what
the hits are what what loads are taking
too long
Ison start drilling through and seeing
specifically why when I was guinea you
know I can look into a specific request
I can set alerts on things so I can say
if I start getting requests that are
taking this long or whatever then I can
kind of drill into that here I can have
dependency tracking so for instance if
I'm making a service call or you know a
databases call is slow etc it can look
that up and the one other thing that's
kind of neat is there's actually this
entire analytics thing and I can go into
here and I can write advanced queries so
you know I can go in and I can say over
the past you know whatever length for
after every application start up what
was the slowest thing and
can start really drilling into all this
stuff so here's examples of you know
where it'll go through and it'll start
showing here's all my logs and I can
start parsing them out and it also does
visualizations and reports so really
kind of complex
you know advanced insights into how my
application is performing and the kind
of setup for it is like five minutes so
it's really kind of a pretty quick
no-brainer to do that okay so let's look
over or let's review what we did we
talked about deployment options all the
different ways that I can deploy an asp
net core app because it runs
cross-platform we showed up both running
on the kind of window space app service
as well as app service for Linux and
Linux and docker and everywhere docker
goes we talked about some deployment
troubleshooting things remember that you
can go into kudou you can do your dotnet
diagnostics you can log standard out you
can look at that post and understand how
asp net core modules integrating in with
is one one quick performance tip I
showed you is that local or that static
file caching middleware security
remember use your environment variables
and finally that monitoring and
diagnostics some logging stuff and then
definitely application insights that's
all I got
thanks a lot</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>