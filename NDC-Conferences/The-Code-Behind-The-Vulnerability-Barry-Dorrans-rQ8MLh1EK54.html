<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>The Code Behind The Vulnerability - Barry Dorrans | Coder Coacher - Coaching Coders</title><meta content="The Code Behind The Vulnerability - Barry Dorrans - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/NDC-Conferences/">NDC Conferences</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>The Code Behind The Vulnerability - Barry Dorrans</b></h2><h5 class="post__date">2017-09-25</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/rQ8MLh1EK54" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all righty it is 20 past 10:00 on what
apparently you all call a cold winter's
day I have no idea what is wrong with
you people this is this is summer for me
although I was told that if I presented
in shorts everyone would look at me
stranger than they normally do because
of these shirts thank you all for coming
my name is Barry dorans I am the
security PM for dotnet which is a
generally very unhappy job this is my
fun presentation if you want actual
technical content that's going to be on
Friday so is the security p.m. it
basically means I get to lecture
everybody in.net try and tell them how
to do things properly hopefully they do
do things properly and then I have the
unfortunate but the the unfortunate role
of trying to deal with things when
everything goes wrong when security bugs
are reported to us if you want to follow
me on Twitter I am at blow-dart there is
even less technical content on my
Twitter feed then I do in this
presentation so just be warned you can
see a complete rant about Australia when
I was jet-lagged on Thursday which
apparently some people find very funny
so today I am going to go through four
nsrc bulletins nsrc is the Microsoft
security Research Center and the code
mistakes that caused them and then I'm
going to talk about a few things that we
have caught in various pieces of dotnet
or in code that uses dotnet before they
created an nsrc so the the rare cases
are actually doing my job right and
these are going to be things that you
may indeed be doing in your own software
right now and then I'm going to follow
up with a couple of scary demos that our
lawyers say I have to warn you about now
so if you are a nervous disposition you
should leave I will warn you again
before it happens so it takes a long
time for us to produce patches as I'm
sure some of you are aware and you may
be asking yourself why does it take such
a long time to produce patches sometimes
it's because I'm spending a week in
Australia
and I'm just not answering emails but
generally what happens if someone will
report a vulnerability to secure
Microsoft comm an MS RC open a kiss in
their security database which is in
dynamics anyone that has used dynamics
will realize that this is completely
horrible and that does slow things down
because the UI is awful but never mind
I get an email from the product group
security rep in nsrc and they email the
product group security rep for dotnet
which is me and only me
which is why me doing conferences does
delay things and so what I do is I look
at the vulnerability I look at the
description hopefully the finder has
produced some code that I can use to
reproduce the problem otherwise I have
to try and remember to code again
because when I move from being a
developer to a PM they basically cut the
developer parts out of my brand
it's the scars have healed though so
it's fine
so I attempt to reproduce it and when it
reproduces I swear loudly I panic and
then I go find the guilty developer and
stand over them and go what have you
done so they then try to reproduce it
and then comes the first part of the lag
we have to reproduce it against every
single supported operating system and
software version of.net now when I say
every single operating system I don't
just mean Windows 7 Windows 8 Windows
8.1 Windows 10 and server no I mean in
every single language that we support
and again we have to try it against
every single version of.net on those
languages so as you can imagine the test
matrix for this is huge
I have a desktop that runs about 64 VMs
and that is not enough so I have a bunch
of VM servers sitting there that have
you know Australian English versus u.s.
English because sometimes that does make
a difference so that reproduction can
take honestly a week then the fix is
developed and that's the quick part
developing the fix maybe takes a day to
a week depending on how complicated it
is and then we go away and we look for
variants of the same thing and that may
add another week so two weeks to develop
the fix
we test it we honestly do tests I know
that some of the quality of the things
that come my over windows update might
indicate that we don't but it is tested
then I spend a day trying to write
instructions on how to update things
which is easy for dotnet framework I'm
really stupidly complicated for dotnet
core we then deploy defects internally
to selected machines within the Redmond
Amman
probably about ninety percent of
workstations in the Redmond demand will
get forcibly rebooted about three weeks
before Patch Tuesday just to make sure
that nothing breaks and at the same time
we will give the patch externally to two
or three victims or as they'd like to
see themselves trusted partners to see
whether we will break their stuff as
well and then finally on Patch Tuesday a
button is pressed and everything
magically goes live because we had
uploaded it the week before so that's
why it takes about six months I am going
to go through four security bulletins
only one of which I am responsible for
the rest were before I joined the team
although I'm not convinced I would have
caught them either so the first one we
have is a glorious denial of service
attack through our hashing functions and
dictionaries which was in 2011 and this
was hilarious this one got Scott Guthrie
involved which is never good it is
caused by the way we calculated hashes
in the.net dictionary classes and so
when you send a forum post or a simple
get request to asp.net we will split
things apart we will take the the form
input and we will use the title and that
will go into a hash table we will use
the title of parameters and it will go
into a hash table and the problem was
that the hashing function that we used
was easily calculated so you could do
hash collisions now I'm sure some of you
have gone into job interviews and I've
been asked to write a hash table from
scratch at which point I generally walk
out with the
interviews cos if you're not gonna use
the ones that are in the library
seriously what is the point so for those
of you that haven't I'm gonna try and
explain this using cats now I make this
perfectly clear that I am a dog person
how many people here are cat people you
are wrong so when you go on holiday you
cannot leave your cat in the house alone
because cats are evil and they will
destroy everything so you take your cat
- a cat vacation home and you go to the
vacation home and go here is my cat
please store my cat for the week that
I'm away and I will come back in a week
and I will get my cat back and hopefully
it will be the same cat so there has to
be a way of classifying and labeling the
cat's so you can make sure that you get
the right one back again so I'm gonna
give a simple example where the cat
holiday home has 26 rooms and if your
cat's name is a it will go into the room
labeled a if your cat's name begins with
B it will go into the room labeled B and
so on and so forth we are taking the
name of the cat and we are hashing it to
a common value so we know roughly where
in the home or in the hash table our cat
is located so when we come back we can
get it quicker rather than just shoving
everything in one room and having to go
through every single cat when I want to
try and find a cat named Allan does that
make sense
yep okay we're good with that so far
this is them where I show my disgust
with cats so an attacker comes along and
he has 756 cats in a bag and he says
they're all named Allan and now you have
a problem because you're hashing
function goes okay well I'm gonna take
Allan and he's gonna be reduced to a and
I need to put him in the a room so in a
room you shove 726 cats and you are
scratched and you are bitten and the
room is very full and you have to push a
tail in before you can close the door so
this causes problems because it takes a
long time to shove all those cats into
the a room and this illustrates our
denial
attack because a hash collision spikes
cpu so you can think of the amount of
time shoving your cats in as being
equivalent to CPU time and then when the
attacker comes back and says hi I'd like
Alan ight you have to go back into the a
room which has 726 unhappy cats hissing
and spitting and scratching and you have
to pick up each one and take it back and
go is this Alan no okay put it back pick
up the next one and if you're unlucky
you'll get it right the first time if
you're unlucky you're gonna have to go
through all 726 cats again spikes in CPU
so I can demonstrate this oh here is a
link well a description of the original
paper which was in from the chaos
communication congress which is a
horrible hackers conference that takes
place over Christmas with no respect for
anyone's holiday so when things happen
at that conference I generally get a
phone call when I am trying to stay
upright on the ski slopes because I am
NOT a very good skier but I still try
because the wife likes it so yes I've
had to come down off the ski slopes for
things from this conference this
conference originally it talks about PHP
security vulnerabilities and PHP should
not be a shock to anyone Java Python and
JavaScript the same for JavaScript
security problems in JavaScript should
be well known by now and then someone
decided that wasn't enough and they
decided they wanted to make me unhappy
and they ported it to c-sharp and
asp.net this is why I Qin smoke because
I want my pin to end so I got a demo
this you will see my wonderful UI skills
with each of these demos so let's switch
to the hash dos one and we will start it
and I'll show what we're doing here
we are taking a string and we are going
to shove it into a dictionary which is a
hash table and then we are taking
another string and we're going to shove
it in but the other string is really
stupid how many of you override get hash
code in some of your classes
yeah I'm about to make you really
unhappy so get hash code here returns a
fixed value because this is the dumbest
string ever so if I run my little demo
and we can see my wonderful UI skills so
as I was talking it had gone through
putting the the million strings into the
hash table and it took that long and now
instead of putting a string in we are
going to put our bad string in and if I
leave this running this will run
throughout the entirety of this talk and
beyond
I used to present from a surface pro 3
and I could put my hand there and I
could feel everything get warm and you
could hear the fan come on every time I
did this so we fix this eventually and
what we did is we now use a randomized
hash code for a string when a process
starts up we will set a random value
just for that process and we will merge
it into the hash for the string so you
cannot precompute because that seeding
key is going to be random each time I
guarantee none of you who put your hands
up saying yes I override get hash code
or doing this are you I don't want to
say that they are oh good none of you're
gonna like okay so if you have
overridden get hash code and you are
constructing these classes solely from
user input and you're shoving them in a
dictionary you have a problem and you
need to do this randomization if you're
constructing them but not taking them
from user input it doesn't matter so
much
so the hashing algorithm that you should
use is probably an authenticated Mac
Shou on H Mac is the one that we use it
doesn't have to be particularly secure
you don't have to go to char to five six
or a 512 just as long as there's enough
randomization there that an attacker
cannot pre compute so that is nsrc case
number one which was glorious number two
is a padding Oracle attack let me start
off by saying encryption is hard
we have crypto people we have an entire
crypto
including people that write the own
algorithms for fun and then get them
approved for use by pushing them out
through the the cryptographic community
and frankly my meetings with those guys
are never Pleasant because they will sit
and they will pick holes in every
implementation or how we want to use
things and then I have to go away and
redo stuff and then come back a week
later and they pick more holes and so on
and so forth the only time it's fun is
when I'm sitting there but I'm not the
one with the use and I'm just sitting
there in the audience going that could
be me
so a padding Oracle attack we're not
talking about the database here an
Oracle is something that gives
information away in a cryptic form like
the Oracles at Delfy like ministers and
priests anyone that wants to speak on
behalf of a higher power you will notice
that the answers that they give never
really are straightforward so appalling
Oracle in this case give away
information that the padding on an
encrypted string was wrong so I should
explain what padding is a lot of
encryption algorithms are block
algorithms and what they do is they
split things into blocks and so it takes
the first block of data encrypts that
and then feasts the results into the
second block and then the third block
and it goes like a little sine wave and
the blocks have to all be of even size
so if they're not the right size there
is always padding at the end and so what
an encryption algorithm when it tries to
decrypt first is it looks for padding at
the end and if the padding is wrong it
stops and that operation is really
really quick in terms of time so you can
detect that there is invalid padding
just by watching how quickly you get an
error back and because you can detect
this what you can do is you can use this
speedy return to start trying to craft
strings that will eventually be
decrypted properly and so you take that
padding byte at the end and you tweak
each individual bit
and until you get no know the timings
slightly different so that bite must be
right and what's what someone did was
they use this capability and they fed it
into a file called script resource ax D
which was part of web forms how many of
you are still using web forms how many
of you are still using web forms who are
not in government banking or health yeah
okay I am so sorry by the way really
just try and force them to move with the
times
so script resource that IX D was
supposed to be an asp net handler that
would allow you to serve javascript out
of dll's where they were embedded as
resources 'm fortunately it was a bit
stupid and it would allow you to serve
any file whatsoever which didn't seem
that bad because we were encrypting the
parameter that was sent to it using the
machine key that's in your web
configured a bunch of other stuff
unfortunately it was just encrypting the
right way to do encryption is you
encrypt and then you sign and you in
sign with a authenticated mechanism that
shall one edge Mac that I talked about
slightly earlier but we were not doing
that so we exposed the Oracle because we
had no signature and we just took what
we were given and shoved it straight
into the decryption methods if we had
had a signature the first thing you do
is you check the signature and you
compute what has been sent to you in for
the signature does not match someone's
tried to change it and you just reject
it entirely and then you don't have a
padding Oracle attack so what this guy
did was he attack script resource dot a
XD and he managed to get it so he could
have the file path encrypted correctly
for web config and so script resource 2
XD because of this padding article he
could script the encrypted string for
web config without knowing the
encryption keys just detecting this
slight change and the change in speed
and he feeds that in script resource dot
XD and lo and behold it served up your
web config file
so that means all your connection
strings that are in there including your
usernames and passwords are now exposed
to the Internet and if that wasn't bad
enough if you have set a machine key
well the machine key was used to encrypt
not just the script resource to XD stuff
but it was used to encrypt viewstate and
we'll talk about why that's bad in a
minute but it's also used to provide the
protections for cookie authentication so
once I've got your machine key I can
pretend to be whoever I like in your
application because I can craft a valid
authentication cookie for that user
because I know what key is being used
this is a bit of a big deal so we fixed
it by finally doing the right thing and
shoving a signature on the end of the
parameter the ghost of script resource
to XD and we fixed it so it would only
ever serve up JavaScript and no more web
config just in case we messed up the
first half of the fix so this was
originally presented as an attack on SSL
which is great and then someone made me
really unhappy and expanded it out to
asp.net and you can go and look at their
presentations and the the papers and the
very heavy mathematics behind this thing
so the way to fix this is you just don't
expose any of these padding Oracle's and
you add signatures to all of your
encrypted data and I will keep saying
this again and again when you are
encrypting encryption it's not enough
you need to add an authenticated
signature to your data sharepoint
sharepoint is the bane of my security
life because they base themselves in
asp.net and when they do something dumb
they blame us
this was the dumbest thing I have ever
seen I love it when the SharePoint
people watch recordings of these
presentations because I get emails so
this was remote code execution via
serialization those of you that are
still on web forms and those of you that
have used web forms in the past will be
aware that there is an enormous hidden
input field inside every single web
forms page
called viewstate and what you said is is
binary data that has been pushed through
binary formatter or other types of
serialization and for matters that Holst
it for a bunch of other things when we
read the page we deserialize that and we
can't restrict it to individual objects
because we don't know what you've put in
there so we DC realize it and say okay
tell us what you are we'll create that
object for you and then we'll populate
all the properties that you need to have
that was an incredibly stupid idea to be
perfectly honest however we protected it
by signing views there with a view step
Mac SharePoint in their infinite wisdom
decided they did not want the
performance hit of having view step max
turned on and they didn't want to have
the complications of setting keys in web
config so they turned it off and I can
demonstrate what happens when you turn
this off so let's see if you stick so
the donor framework has a bunch of
classes that are marked serializable
that frankly should not have been and
one of my favorite ones is temp file
collection which hides away inside code
um and what temp file collection is used
for is when code um is compiling code it
creates a bunch of temporary files in
your temp directory then spawns off the
compiler rather than doing everything in
memory but that's what we have Roslyn
for now and then it cleans itself up so
it's a way of tracking all the temporary
files that it has created and the way it
does that is there as a property for all
the temporary files and when that object
gets disposed it goes and deletes all
the temporary files which is great until
you say that one of my temporary file
names is web.config and so what happens
is eventually when this object exists
with web.config and its temporary file
name and the garbage collector gets to
it it deletes web.config and your
sharepoint psycho starting which let's
be honest is a blessing because it's
sharepoint so here's what we're going to
do I'm going to create a temp file
collection I'm going to add web
configure to it and then I'm going to
just serialized that temp file
collection and then I'm going to bring
it back in again
and refused it just does a
straightforward binary format or D
serialization and then I'm gonna force
garbage collection which of course you
never do in your own code but no one
wants to wait 20 to 25 minutes for this
thing to actually work so let me bring
up Explorer and you will see that there
are three files in here and I'm gonna
hit start and it's gonna create a
temporary web config which is here and
here is my view state and I'm gonna do
what view state does I am going to read
it in deserialize stuff and then I'm
gonna force garbage collection and lo
and behold my web config has vanished as
it's my attack file because I like to
clean up after myself and your
SharePoint site goes down
so we fix this by introducing the first
ever breaking change in asp.net for
security which made me very happy when
you try and tell asp.net now that know
you don't want view step Mac on your
view stick we ignore you it's always
going to be there whether you like it or
not so when SharePoint turns it off it
doesn't matter it has no effect so we
will have this signature so we will know
that the data that has been put
interviews there and round-trip to run
tripped to the user and has come back
again has not been tampered with so when
you run trip stuff to a user you need to
sign it and you need to sign it with an
authenticated signature because
otherwise someone can just compute you
know a straightforward md5 appended on
the end and it doesn't matter it has to
be authenticated you have to have a
private key that feeds into your
authentication mechanism
the other interesting thing to know is
you should not publish your signing key
I love github so much because I can
search for web config and look for
machine keys that are fixed in web
config after the viewstate stuff came up
someone expanded this to point out that
it didn't really matter if we turned
everything on by default if you have
published your signing key so lots and
lots of software delivered themselves
with web config with fixed machine keys
so everyone's machine key no matter who
they wear for this individual piece of
software was the same so we had six
months of going around and telling
people this was an incredibly bad idea
and they needed to remove it and we
would demonstrate what the problem was
and bring their websites down and then
they go oops and they'd have to redo
everything and reissue stuff and it was
a lovely cascading set of security
bulletins from various other
manufacturers it's nice when I can share
the pin to be honest regular expressions
this one I was responsible for or at
least for not catching how many of you
use regular expressions in your everyday
code you are bad bad people how many of
you use regular expressions to validate
user input you are even worse people
I despise regular expressions when we
redid everything for dotnet core I went
on a crusade against regular expressions
and got every single one removed except
for the one in routing where you can set
a regular expression for matching
routing because we didn't want to drop
the feature simple regular expressions
are fine well they're not fine because
they're still really hard to read and
understand but complicated regular
expressions that go backwards and
forwards and backtrack and forward track
they are basically a program and with
certain types of regular expressions you
can send that program into an infinite
loop and that's not something you want
to happen when you're validating data so
you can guess what happened here we will
skip across to regular expressions
here we have an email address and I'm
going to split it into a regular
expression that someone thought was a
good idea to put in our data validation
classes we should probably look at the
regular expression would would anyone
who said that they were using regular
expressions for validating user input
care to explain what this does let me
keep going still still well yeah okay
that's that's longer than the break
between England winning the ashes each
time so this is a bad regular expression
any of you have written something like
this you need to be ashamed of yourself
so what I am going to do is I'm going to
put a valid email in and then I'm gonna
put in an invalid email and you can
guess where this is going by now testing
is good value testing against the bad
value again like the hash code this will
pretty much run for the entirety of the
presentation but unlike the hash code
which would eventually end this will not
because I have sent the regular
expression into an infinite loop this is
why regular expressions are bad because
it is incredibly easy to write a regular
expression that can do this but really
really hard to spot at least that's my
excuse for not spotting it so this was
reported to us by someone that worked
for Nitto which is really embarrassing
when you get an email from Widow
I think it's Nate ODU and you're like it
starts with security vulnerability am I
oh so that's that's not good so there
are ways to fix this find something
other than regular expressions to
validate your input yes it may take more
code but I guarantee you it will be more
readable than something like that
monstrosity if you feel you have to use
regular expressions because you're the
only person in your company that
understands them and it gives you job
security which is the only reason for
using them you should set a time out on
your regular expressions now dotnet is
dumb it does not set a time out by
default and I cannot change that because
of backwards compatibility because every
time I try and improve something that
breaks backwards compatibility I
guarantee you that a large customer will
shout at me and then management gets
very upset I upset management enough
without having customers do it as well
so you should go through all your time
are all your regular expressions and
make sure there is a timeout that is
work for all of you that raised your
hand earlier there is a shortcut if you
are using the.net framework not dotnet
core but if you're using the.net
framework you can set a default timeout
for all your regular expressions by
using an abdomen setting up there this
does not exist internet core because we
don't have abdomens because they were
silly but you can set that the problem
being of course that some of your
regular expressions may need to run
slightly longer than others so you're
gonna have to go through and fix those
and if you're going through and fixing
those you should just set a timeout for
each individual one anyway so we're
gonna move on to mistakes that we have
seen putting user input into HTML is
easy
we all know that we should call HTML and
code right we're all anyone want to
admit to not calling HTML and code ever
if you do want to admit to that could I
have your website address as well the
problem comes when you
to put user input into JavaScript into
an HTML page so this looks like it's
doing the right thing because we are
calling HTML and code but all Mouse out
the the pieces between the quotes and
almost out is JavaScript
so I'm HTML and coding but I should be
JavaScript encoding and we can't detect
when you're inside JavaScript not even a
razor so really that should be
JavaScript encode and then it should be
HTML encoded because you're pregnant
into an HTML page and if you get the
order wrong well then the encoding can
fail miserably and you either get
JavaScript errors or worse you get XSS
because you haven't got them in the
right order so encoding is contact
specific you have to use the right
encoding method depending on when you
are putting data and so if you want to
take user input and put it into
JavaScript do this instead have a div
tag have a bunch of data parameters on
it and shove the value into the data
parameter now immediately this gives you
a little more work because you have to
write some JavaScript to pull that out
before you can then use it elsewhere but
this is the safe way to do it URL abuse
I like this one so I I call this rest
abuse because I like annoying everyone
that gets religious about what rest is
and that's a lot of people but you can
imagine that you have a site that has a
user administration page and because
you're trying to have pretty URLs and
beer estephe ID you can hit a delete URL
which is great and you can struck the
delete URL like that so if I create a
username with dot slash admin what
happens is when the browser gets that
URL it knows there's a dot slash and it
knows it has to never get up so it
removes it before it sends it dying so
now I'm ending up actually deleting my
admin user which is nice if you were
constructing URLs some user input only
do it for the
Roman character set anything that is
going to be fancy anything that has
weird characters or exclamation marks or
any sort of punctuation or accented
letters or Russian or Japanese or
whatever stick it in the query string I
know people like having fancy URLs but
fancy URLs are sometimes not safe
anyone Turkish in the room I've had
someone say yes to this once so what
would we like to guess that little
snippet of code does there are only two
answers so come on someone can check out
something you're not european europeans
do not interact especially Scandinavians
in presentations someone chart out your
false false in Turkey well done because
I mentioned Turkey I'm what then is it
in Australia
true well it's true but it's upside died
okay so people make security decisions
based on string comparisons and let's
prove this you see Turkey is a very
strange language it has multiple ways of
doing an uppercase will you stop there
we go look denial of service attack on
myself said a startup code so I am just
going to do a compare an a nice waste of
Turkish and as you can imagine because
all my demos end up doing the right
thing first and then something that goes
horribly wrong they're equal and then
they're not because Turkey has three
different ways of up or kissing the eye
which has actually caused murders not
kidding that the person actually said
yes I am Turkish then went on to
describe this to me where there are
certain words in Turkish where the
change of the capital letter I changes
from a compliment
to an insult and someone had texted his
girlfriend's brother to say something
nice about his sister and it used the
I and the brother seriously got upset
and stabbed the sender Soho yeah
globalization is complicated and you're
gonna get stabbed so when you're doing
string comparisons always compare using
ordinal ignore kiss because that will
get away from all the globalization and
just use very simple upper case things
so you know interesting and interesting
would be equal my name if you turn on
your code analysis rules in Visual
Studio pretty sure at least fifty
percent with people at risk our hands
are lying because my god they're
annoying I know that people turn them
off because they're very annoying but
there is a specific code analysis rule
for this so I would suggest to you that
you turn on CA one 309 recompile
absolutely everything and then put your
head in your hands because you've done
lots of string comparisons that aren't
using ordinal ignore case and then go
and fix them once you stop solving
Unicode I had this one emailed to me
from one of our developers of Microsoft
IT Unicode has this weird thing called
full-width characters or as I like to
call them American characters because
know that I live there I'm getting a lot
more full-width so I know it's a little
bit hard to see but on the left hand
side we have a normal less than and on
the right hand side we have a full-width
less than that is bigger and wider that
actually is two Unicode code points
because you don't have characters in
Unicode you have code points browsers
will ignore it so this script which is
written in full width will not execute
as JavaScript however yri people were
doing was they were storing this input
in a bar chart field in sequel not an N
varchar' feel like anyone sensible but a
varchar' field and sequel rather than
say i'm going to lose some information
here and stop it decides to be really
helpful and it took
those white characters and switched them
to their skinny characters so someone
could do a white character script sequel
woods convert it you would not have
persisted XSS within your database so
don't use Unicode columns our non
Unicode columns to store Unicode
characters I don't trust anything that
comes from a database look I know you
may feel the DNA base is underneath you
there is um under your control you still
shouldn't trust it because it may not be
someone could have inserted things into
your database that you are not expecting
it to be their crypto mistakes this is
from an email that I was sent which now
everyone does because they think it's
funny because I got absolutely furious I
get furious a lot this was from a p.m.
on an azure product team who will rename
that the team will remain nameless only
because their developers followed up
three seconds later went no that's not
right this is how we encrypt it so
people make mistakes between encoding
and encryption people also do this that
interesting was the same as your team
about six months later in a different
developer that product was fun
people reused their keys far too often
and they were reuse their initialization
vectors so you know I was talking to how
blocks work with the little sine wave if
we take the first we split everything
into little blocks we take the result of
the first encryption of the block and
feed it into the second one which is
then a seed in that waves like that but
there's kind of something missing is
what feeds into the first block because
there's nothing before that and what
feeds into the first block is called an
IV or initialization vector and it is a
bunch of cryptographically secure random
data which means don't use the random
class use the ones and systems or
cryptography but people reuse this you
shouldn't reuse it it needs to be unique
for every single value that you are
encrypting in much the same way like if
you are
hashing you need to use a unique salt
each time so people reuse their IVs and
that's a huge no-no and people reuse
their keys for different things it's
like well I have one master encryption
key I don't want to manage having 37 so
I'm just gonna use the same key for
absolutely everything which is also a
bad idea what we do in asp.net is we
have a master key and then we have this
thing called purposes so going back to
web forms we used the key in web config
for signing your authentication cookie
and for signing viewstate but what we
did was we took our master key and then
we added a purpose to it and we derived
a key from the master key in the purpose
so the keys would actually be different
depending on what they were going to be
used for so don't reuse keys and like
I've said encrypted did it needs to be
signed with a message authentication
checks if you're gonna concatenate
strings and encrypt them stick the
length in because otherwise while
built-in and securely is equal to
built-in securely if you can kinda get
the two together you're never gonna be
able to tell a difference so if your
concatenate put the length thing and if
you're validating signatures never
validate by hostname alone we all have
certain in our browsers now even an edge
and I believe in IE you should be
looking at the issuer of the certificate
and in the sample code for this I have a
little console app that will take a
certificate and calculate the spki which
is what generally people pin on so you
can see the code to do this in your own
code hash comparison should be tank
assistance and when you are comparing
things that are hashed you don't want to
exit early just because something
doesn't match because now we're getting
into timing Oracle's not just patting
Oracle's there are timing articles so
that is a correct way to do hash
comparisons honestly you don't need to
take photographs of all of this the
presentation will be on my website in
about 30 minutes if I can get the darn
Wi-Fi to work which is really hard here
mass assignment MVC and web api use
binders and binders take the input that
is coming in and
quest and bind it to an individual
object for heaven's sake use view models
because if there is a property that you
which is on your class an entity frame
where classes are great for this even
though there's not an input field on
your HTML page if I know what that
property is an ID is usually a good one
or owner I can just insert a hidden form
field of ID or owner and the binder for
MVC will bind to it even though you've
not got it as a displayed input form so
you use view models use something like
Auto mapper to copy your properties over
between your view models and your actual
entities if you don't want to do that
and you should if you want to be Lizzie
you can use bind include so you can say
that I only ever want to bind to these
properties on my model
don't use bind or exclude because I will
tell you why how many of you trust your
co-workers yeah no one all right see
that's that's right if you use bind or
exclude and you say okay so I know which
things in this class are unsafe to bind
to and your coworker comes along and
adds a new field and you don't know
about it and they haven't updated banged
or exclude well then you're buying dot
screwed so always use safe lists use
include path transversal if you how many
of you are accepting uploads in your
websites yeah I'm gonna make all of you
unhappy
you don't ever believe the file name
that comes through of course I'm not
even gonna ask even though that the RFC
says that you should only ever get a
file name that does not have pass well
you can just ignore that and use
something like fiddler to send dot slash
dot dot slash dot dot slash and the path
name so if you believe that you're the
mess how many of you who are accepting
file uploads are accepting zips and
unzips
yeah so
I have something for you guys to do
against your development environment not
your life environment I want you to go
back search the internet for 42 dots if
turn off your antivirus which I never
recommend normally and download it
because it will upset your antivirus
well $42 is is a 42 case it file and
because zip files are recursive it
expands into 4.5 petabytes of data so
you to that put your hands up really
need to think about different ways to
unzip the way we do it in Azure and the
way that we do it and you get as we have
detonation chambers we spin up VMs
specifically for unzipping we copy the
zip file into it we tell the VM to unzip
it and if it hasn't done it after five
seconds we just throw the damn thing
away because it's just not trustable now
okay you may laugh at those two that
we're accepting zip files how many of
you are accepting XML files because it
has exactly the same problem this is ten
entities which are defined of tenancies
of the previous NT and so on and so
forth this when you parse XML will turn
into 1 billion entities that contained
lol this is preventable by turning off
DTD parsing so you should do that when
you're parsing XML so great you're gonna
run through cuz I only have a couple
more minutes now like I said I can't
break as many things as I want because
of back compatibility and the same
people that are on web forms probably
have employers that would be upset if I
broke things due to security so with
each version of the.net framework we add
more security in and we fix stuff but a
lot of these things are what we call
quirks and you have to opt in to using
them so for example we added a bunch of
stuff in Internet 4.5 but you have to
move the framework that you are
targeting to 4.5 to get them and it's
same for 4.5 point one four point five
point two and so on and so forth so when
we release a new framework
either update your targeting framework
or change your compatibility mode and
that will opt you in to all the latest
offenses that we have added which
includes string string hash code
randomization despite us saying in all
our documentation that hash codes may be
different from one run to the next some
people do not read our documentation
especially things where we say don't do
this it's dangerous and so we can't turn
that one on by default but all of you
should go back and turn on that runtime
switch for the.net framework in dotnet
core because I could break things
because we were breaking the world with
on that core this is owned by default
and you can't turn it off so haha stated
protection um asp.net for had machine
key to encode a machine key decode which
were silly they would actually allow you
to do encryption without signing which
is why SharePoint go in such a state so
we've replaced those with machine keys
don't protect some machine key to UM
protect so you should use those to run
trip data to user space and validate it
when it comes back and don't Annette
core we have a data protector which
replaces everything you don't have
machine key anymore you have a keyring
that you can store in various places be
it sequel be at this local file system
be at Redis via a jerk evil I like as
your key vote for these things how many
of you have encountered partial trust in
your websites not if you oh okay I can
skipper for that it doesn't work we
killed that five or six years ago and
again no one reads the documentation but
what it was doing it was supposed to
remove certain types of permissions so
people would say okay go run this
website in medium trust because I don't
trust some of the code and that's not
gonna be able to start a process or go
wandering around the internet on its own
it is broken
it is not getting fixed it is not
internet core request validation should
be part of defense-in-depth that should
never be what you solely rely on and
again we throw it away and down that
court because it's kind of broken and we
can't fix it
so I can show you breaking partial trust
because this is funny and hopefully it
gets the the point home because I'm sure
some of you know someone who does this
so here we have a good old web forms app
because they're really easy to demo with
and I'm going to do process that start
and try and pop a Comanche and then I'm
going to do it in another way
so partial Trust is set up in your web
config and here we go the trust level is
medium and that should not allow me to
start a process so I hit launch a shell
and I get a security exception from
partial trust if I go you know do it
then we have problems partial trust was
a great idea however it was implemented
in the wrong place
permissions should frankly be enforced
by the operating system which is why
containers are good all right let's stop
that okay so I have one last demo it's
not bad enough that you can delete files
via serialization this demo is taken
from a presentation at blackhat this
year which is the security conference to
go to
which is full of the grit and unwashed
I'm not even kidding
it's literally unwashed people sometimes
you can find it on YouTube by searching
for Friday the 13th juice and attacks it
even mentions just and done that the
owner is nodding I told you to remove
that switch but they did point out that
I will be fair Jason dotnet is secured
by default you just have to set an
option that basically says I'm throwing
caution to the wind and if you do that
it's your own fault so I I warn you that
this is not going to be pretty okay and
I because I've warned you I do not want
to see any
red things in the bowl just because this
demo has upset you okay so normally what
I do in a country that has decent
internet is this talks to the internet
cannot do that here so I spent last
night basically spending 15 minutes
downloading a single image and then
running it on a little host web server
so I'm gonna start my little web server
up but you know in a country with decent
internet this would talk to an untrusted
web site all this is doing is it's gonna
serve up some code nothing very exciting
alright so we'll just minimize that and
then we have serialization exploit demo
binary formatter is bad
in all seriousness go through your code
and look for instances of binary for
matter and then rethink and regret your
decisions because I see this far too
often binary formatter and Jason
formatting if you have turned on the
really silly unsafe option what they do
is they include information on what of
what an object is and then the data so
like I said with the temp file
collection I can say what type of object
you're going to deserialize into so here
we have a payload file and I have a file
stream and I'm basically just going to
deserialize it so let's debug this start
new instance so one web server is
running look no hands powershell started
it's doing oh my god that's horrible
i tried to think of the most shocking
and disgusting thing for an australian
audience and that was either this or a
link to the BBC article that proves that
pavlova comes from new zealand
which is apparently where you all stole
flat whites from as well just stick to
claiming that you invented lamingtons
because frankly no one else wants to
claim those okay so binary for matter is
bad
trusting data that comes from an
untrusted user is bad sign everything
sign it with an authenticated signature
and keep the key for that authenticated
signature private don't publish it on
github okay so and like I say opt into
all the new protections that we give you
by changing your framework version every
time that we release one don't use
regular expressions don't opt out of all
the protections that we give you by
turning view stamp back off because it
makes me very unhappy all right so as
you can see this is slide from I think
jacket there is no microphone we have
five minutes for questions which is
better than normal because I normally
waffle on for an hour and a half but
I've actually kept time does anyone
apart from James have a question hello
sir
oh there is a mic oh my goodness thank
you
just to clarify when you're talking
about keeping your signing keys secret
you're talking about sort of
certificates you're not talking about
strong signing okay the question is when
I'm talking about signing keys what am I
actually talking about honestly it's
everything in this case I'm talking
about signing keys for your check sums
so you use message authentication code
and what that does is it checks um sure
did it but it also takes a key and it
merges the two things together because
if I just use a normal md5 as a way of
validating stuff well the attacker can
calculate the md5 there's no secret
there but if I use an H Mac I have a key
that feeds into that H Mac so an
attacker cannot reproduce the check sum
because they don't know the key unless
you publish it on github which is
roughly what machine key does in web
forms also yeah you shouldn't you know
upload your certificates to github
certainly not with a private key
strong naming strong naming is one of
those security things that we've gone
yeah this is not security anymore and it
is just used for identity and if you
will notice if you look at the dotnet
core repos we actually publish our
strong name keys because they're not for
security they're just for name
resolution so I honestly don't care if
you up let us upload those to github
does that answer your question anyone
else have a question
no okay you're all too shocked by seeing
England win the ashes all right in that
case thank you very much everybody
remember no red post-it notes just
because England won the ashes a few
times I'm Irish I honestly don't care
all I care about is the rugby and I'm
not gonna talk about Ireland versus
anyone else in the rugby thank you very
much for coming I hope you have a great
rest of your conference if you want to
see something that actually has proper
technical content I will be talking
about security in asp.net core 2 at some
point on Friday unless a drop bear gets
me thank you very much
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>