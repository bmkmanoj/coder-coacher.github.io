<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>1B+ Pages AMPed, with Pinterest (AMP Conf '17) | Coder Coacher - Coaching Coders</title><meta content="1B+ Pages AMPed, with Pinterest (AMP Conf '17) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/The-AMP-Channel/">The AMP Channel</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>1B+ Pages AMPed, with Pinterest (AMP Conf '17)</b></h2><h5 class="post__date">2017-03-28</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/xTn-Ph864EQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so I'm Sam and have the Dean here with
me today to talk about what we've been
doing with amp at Pinterest so the title
is a little bit sensationalist but we
actually do have about a billion pages
that we're serving on amp right now and
next I want to go and talk a little bit
about what we actually do at Pinterest
so Vadim works on user acquisition ie
introducing new users to Pinterest
getting as many new users to Pinterest
as possible myself I work on performance
so performance on the web performance on
our you know mobile apps back in
performance you name it so for me
personally amp amp is a real boon speed
matters next up I want to talk a little
bit about Pinterest most of you probably
have some idea of what Pinterest is but
it's always kind of good to talk a
little bit about how we actually view
Pinterest so for us Pinterest is the
world's catalog of ideas we have about a
hundred billion pins of Pinterest each
one of these represents some piece of
content those pins have been organized
categorized and curated by our users
into about 2 billion boards and this
kind of categorization or this that this
platform allows us to help people
discover things it allows us to help
people find things they love and want to
do and that's kind of how we view what
the mission of Pinterest is and so next
I'm going to talk a little bit about amp
a Pinterest so why amp and this is kind
of a theme that you'll probably hear
over and over again during this
conference so our primary reason for
doing amp is all about speed so we're
not the first people to discover this
obviously but faster loading pages mean
more engaged users and and/or a better
user experience in general but not only
that speed also does matter for search
ranking and similar
things so faster speeds also drive more
traffic for us and so how are we using
amp at Pinterest so it's primarily
served to our off and unauthenticated
users and it's currently primarily for
our pin pages so what are pin pages pin
pages are the pages that are centered
around a one a singular piece of content
and contrasting that we also have other
types of pages which we typically refer
to as collection pages and these are
things like boards as I mentioned
previously where users have curated
content but we also extract signal from
user curation and aggregate further
around other keywords and things like
that but for now we've started with pin
pages and will probably begin rolling
out amp to other page types over time
and so these types of pages the pin
pages get traffic primarily from various
referral sources so we've got Google
Facebook Twitter other search engines
and most importantly this is how a lot
of our new users end up discovering
Pinterest you search something on Google
you find a result on Pinterest you click
on it that's kind of your initial user
experience so it's very important that
it's fast gives a good impression to our
users so what does this actually look
like in practice so am i right you can
kind of see how where we started this is
our naanum mobile page on the left is
where we landed with amp for these pages
one of the main differences here is that
we've decided to treat the content
slightly different so the non amp
version does have the first pin which is
really the main piece of content for
this page as part of a grid or a masonry
style layout and it doesn't isn't very
highlighted but looking at the ecosystem
and looking how amp is being displayed
and and used right now we figured it was
really much more about the singular
piece of content so we decided to for
amp to go and highlight that much more
bigger image and below that there's a
whole bunch of metadata that you can't
necessarily see so we may have
structured data in there as well for
recipes for example you might have a
list of ingredients and then below that
we actually serve related content so you
get the main piece and then in the
second screen over these are sort of the
related peated pieces of content that
we've associated with with the main
piece so how how did we actually do this
so first of all in terms of rollout
even though this is not on the slide we
started basically with creating a
separate path for URL path for amp pages
and then through an experiment kind of
rolled out the link between our original
pages and the amp pages and kind of
checked for our typical metrics and
deemed we'll be talking a lot about our
metrics on how amp was performing versus
our normal pages now in terms of
actually kind of getting an amp page
rendered so Pinterest started a journey
about a year and a half ago to switch
all of our web stuff to react we're
pretty close to the end of that journey
but since you know that's kind of our
web stack and we were already doing a
bunch of server rendering for react that
felt very natural for us so we end up
producing amp on the server using server
and react we did end up working our code
base to do this primarily because the
way we were doing CSS and our regular
code base wasn't actually compatible
with amp amp elements I think we could
have dealt with but the CSS handling
made it so that you know we couldn't
really necessarily reuse what we had
exactly as it was that said over time we
may consider at REE converging our code
the second thing is we also have to
create a new render path so typically
our developers don't really go and
implement entire pages they go
implement pieces of a page typically
just within the body so developers
typically don't really get control over
the entire page so four amps since
there's boilerplate and similar things
we have to go and create a new path for
that we also end up wrapping some of the
amp components that are out there with
our conventions so what that looks like
you know here's it's kind of a trivial
example but this is how we end up
calling amp pixel so we throw in a whole
bunch of parameters in there that we
always use and also ultimately I think
do a bunch of things here although not
with this one to make it extensible this
kind of capturing convention possible
there we go back button was hard to find
and finally there was sort of there was
a minor issue with reacting amp so react
likes to swallow attributes it doesn't
really recognize so we had to go and
globally whitelist some of the amp
specific element attributes and so next
I'm going to talk about what it took to
actually port our features and the major
issue there I think most of our pages
are fairly straightforward
but the major issue there is what do you
do with the Pinterest grid and to begin
with what what actually is the Pinterest
grid so it's a masonry style layout you
can sort of see examples all over the
web but in practice there are some
things to call out that aren't
necessarily always considered so it's
responsive so different screen sizes
different orientations change the layout
it deals with variable height content
and this is important because typically
you actually have to render this
client-side to be able to measure the
height of this come of this content and
then it's it's also filled the shortest
column first so typically the way
content ends up on the grid is you go
across the first row and then you pick
the shortest column after that and then
you
and the reason why that is important is
for is twofold one is that the we we
like to rank our content right and so
when you fill it this way you end up
with our most highly ranked content
first and the second reason is that it
gives you the least ragged bottom in
some ways although typically in our case
we do infinite scrolling so you
hopefully don't really get much of a
bottom but it's nonetheless important so
how did we take this to amp so you need
the height and height of items but but
you can no longer really measure it
using JavaScript on the browser so the
only way to do this is is ultimately
through CSS and so we took a look at a
bunch of different mechanisms out there
for achieving this the first one was to
use CSS columns and you know they're
they're always going to be some
trade-offs with these approaches but in
this case is filled top to bottom so
first calm down second etc and then left
to right right the result of this is
usually the last column looks kind of
pretty awful but that wasn't really such
a big deal we could have lived with that
ultimately the the killer though was
that it turned out to not really work
that great on iOS so you kind of scroll
but the image placeholders in my ass
would actually never render an image
and yes there are workarounds or there
were workarounds there are workarounds
for this but they are not very
performant workarounds so we ended up
abandoning this approach and instead
ended up here so we made some trade-offs
with respect to how we deal with
variable height parts of the content and
I'm kind of estimated the height and put
the height in a fixed height container
where we get a serve a bunch of buckets
height buckets essentially that we
categorize the content into and then
based on that height calculation on the
server we're now able to calculate the
absolute position
of each individual piece of content for
each screen size that we care about so
we have to basically worry about each
column stop
so typically we deal with anything from
2 to say roughly 12 columns so we do
that calculation for every one of those
column widths or home number of columns
and this worked fairly well especially
since in the meantime we've kind of
looked at our representation of content
a bit more and optimized it somewhat
more for conversion and on mobile we end
up with something that you see here
which really doesn't have a whole lot of
variable height elements in here so that
kind of took away a lot of the problem
as well some other things we did look at
we also looked at at flex box I mean it
has the same fill issue as as CSS
columns but more importantly since it
requires wrapping you still have to
actually figure out the height of view
of the overall container so it doesn't
really actually buy you a whole lot and
then finally we also took a look at CSS
grid the CSS grid spec the problem there
is that I think that would give us a
workable solution but none of the mobile
browsers actually supported yet all
right next up so what did we actually do
about infinite scrolling and don't
really have JavaScript and the the dead
simple solution here was to just put
more content on the page
you know it's what what you can do in
practice so we end up on a typical
mobile page we typically I think put
something like 8 pieces of content on it
for amp we decided to go with 50 pieces
of content the way there's still the
reason for why this actually still works
fairly well is that amp Blasi loads a
lot of things below the fold
and so from a page weight perspective
you still don't end up loading a whole
lot of images with the page the page
still of render is very fast we will
take another look at this though and do
some analysis of how many users actually
hit the bottom of this page if it turns
out that there are a lot of users that
that kind of really would like more
content and will probably go back and
try to figure out a way to make this
work within the amp project itself
through some sort of contribution so
next up is my colleague Vadim who's
going to talk about what we ended up
doing to integrate with metrics thanks
I'm going to start from talking about
the metrics integration forum and at
first let's take a closer look at
Pinterest Pinterest is a metrics driven
company we've a lot of data and a lot of
users we have more than 158 million
monthly active users and more than 100
billion pins more than four hundred
engineers heavily rely on internal
components to do the measurements and
internal tools for analytics and
experiments for our team we have three
key metrics the first one is sessions it
is amount of uh notification accusers
visited Pinterest the second one is
conversion rate it is amount of unique
identification the second one is
conversion rate its amount of unique
users registered on Pinterest divided by
session and the last one is page load
time we measure how long does it take
for a user visible part of the page to
load let's go let's go over details how
they will measure miss matrix to do that
we use in house analytics system and
sessions are measured on the server side
we log every request and analyze it
later conversions are measured via
tracking users lifetime its diet the
signing every user NID and store it in
kooky as well as tracking when they
install the Pinterest mobile up register
the arable website performance metrics
are measure T's in JavaScript on the
client side and reported via the
Pinterest analytics API to improve these
and other metrics we run a lot of
experiments and we can do it on a client
side or a server side but also support
classic a be experiment as well as page
level experiments when we started to
migrate to amp we've discovered but it
wasn't an equivalent for everything
there is no way to measure session
server side since amp pages are
delivered from Google's amp cache
conversions can be tracked via amp
client ID but there is a risk of double
count in the users because because there
is no easy way to bridge the client ID
below internal user ID and unifies users
amp and non of obsessions performance
measure can be reported to your amp
analytics and on pixel but don't provide
an exact equivalent for our custom
metrics client side experiments could be
relative amp experiment but would
require reporting data back to us server
side DB experiments are not available
and we need to find the workaround for
it to sum up on pixel and up analytics
have three big instrumentation
challenges which we needed to solve
before making a full swing storm the
first one is to figure out how to
replace server-side metrics and DB
experiments the second one is that due
to third-party cookie restrictions in
some browsers we can have unified am
going to Indy and internal Pinterest ID
for new users visiting on pages 1 amp
client ID could have multiple Pinterest
users IDs and I'm client IDs couldn't be
passed to deep links and Pinterest URLs
makes impossible to correctly attribute
up install storm sessions and users
could be double counted we need to
bridge beside these to correctly track
users and conversions the last one is
that since Pinterest uses custom
performance metrics which are measured
by JavaScript they should be added to
amp HTML project now let's talk about
how did we solve this challenges and
what
does it require counting sessions was
the easiest issue to resolve we
introduced a new endpoint on Pinterest
and use antiques or chocolate the ko
creates a new synthetic request entry in
our logs which we use the carbon share
amp page loads for server-side EB
experiments we have two options and we
can pick one of them based on the
experiment in question the first option
is to convert the experiment from a user
base TB experiment the page-level
experiment this way we're still be able
to control it on the server side
but whose the benefits of a classic a
bee experiment ligated statistical
significance metrics differences ii
often use plain sight of experiments
let's imagine what we need to slightly
change every image on the page since
there is no JavaScript the only option
is to fully replicate all pins and have
both control as well as treatment data
stored inside the page it would slow
down page generation Pintrest
server-side since we need to get data
twice for birth control and treatment
and would significantly increase page
size which becomes slower and it could
affect search traffic and user
conversion metrics also worth mentioning
that in both approaches there is a
downside but there is no easy way to
instantly start or stop experiments due
to UM propagation delay or time for
which pages are cached in Google's app
cache my next thing we needed to solve
was how to not double count users and
bridge the amp client ID with Pinterest
user ID this problem exists because
Pinterest domain becomes a third party
the main two arm pages in this case arm
pages do not have access to Pinterest
cookies and Pinterest may not be able to
certainly cookies due to browser
settings this means that we can't rely
on our own user ID anymore since one arm
client ID would have multiple Pinterest
user IDs and to calculate conversions
correctly we now need to have the
ability to pass on client IDs as a
parameter to Pinterest URLs and deep
links this capability was not available
right away
and will work together with the UM
project team to make the required
changes these changes were released
recently and were written our internal
data workflows to account for our client
ID
blasting we need to resolve as
performance metrics
our internal key performance metric
measures when user visible elements in
the user's viewport a finished loading
in amp
images a lazy loaded below the fold and
at first we've decided to use existent
DOM complete metric as an approximation
recently a new event in your load was
introduced in analytics the triggers
mechanism it allows to measure when all
elements above the fault
finished loading and its
exactly what we need let me sum up we've
solved how to parent sessions measure
conversions and performance as well as
how to run different types of
experiments we made some trade-offs as
part of this but we'll keep working on
improvements and for now we have
solutions for everything to keep
iterating enough experience let's cause
we're talking about results of this
effort and our future plan forearm as I
mentioned earlier we focus on three page
types being amped at first
95% of pin pages are amped and we're
keeping the 5% holdout or non amp group
to measure the effect of a change
overall with amounts for more than 1
billion pages which are available for
Google to be indexed from the conversion
standpoint we have reached parity on
this page type and are my pages twice as
fast as before we believe that these
numbers could improve after we figure
out how to make pagination for infinite
scroll and work from all collection
pages are still being evaluated we have
an initial employment ation but it
doesn't convert as well as our regular
mobile pages we will need another couple
of iterations to fully ship them in the
near future we are planning to ship up
to 3 page types mentioned in this
presentation but it's fully pinned page
and all collection pages who work to
implement pagination and add more
interactive elements on Pinterest on
pages longer term were planning to ship
optimal page types and start
experimenting with progressive web apps
since having our pages often replaced
deep links in Google search results we
will need to have an under difficult
experience for users coming to Pinterest
there our on pages progressive web apps
are a good way to do that</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>