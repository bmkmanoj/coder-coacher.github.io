<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>AMPing Airbnb: A Magic Carpet Ride (AMP Conf 2018) | Coder Coacher - Coaching Coders</title><meta content="AMPing Airbnb: A Magic Carpet Ride (AMP Conf 2018) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/The-AMP-Channel/">The AMP Channel</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>AMPing Airbnb: A Magic Carpet Ride (AMP Conf 2018)</b></h2><h5 class="post__date">2018-02-14</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/7v40GIddsl0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right my name is Gil Berman I'm a
front-end engineer at Airbnb my name is
Brian Tom as he OPM and everyone be
let's get started so welcome to Airbnb
and this is what we had to go through in
order to enable a app onto our website
so let's start off with what is Airbnb I
think many of you guys know that it's
just a home sharing platform I'll just
leave it at that so this is our P one
this is our home page so for a reference
we call our home page and everything
else special name so home page is p1
this is where you go and enter your like
your location so if you want look for a
place in the afternoon you type in
Amsterdam this is our p2 this is our
search result page so this is if you
type in Amsterdam these locations you
get we type in San Francisco and the
next one is our p3 page so this is the
actual listing page so just remember p1
it's a home page p2 is the search result
page and p3 is a listing page and with
that let's get started talking about amp
so with it so with amp we have to talk
about like what should we actually amp
and to do that the couple of challenges
that we needed to figure out about which
pages we should consider the very first
one is impactful miss this is traffic
you're not just like getting random
traffic into our site this is about like
high intent traffic which traffic or if
PR is actually gonna end up booking on a
website the second one is page
volatility and they're being BB push out
code every 30 to 45 minutes so the page
is continually changing what this means
for amp is that a page might just
randomly break aunt validation and we
don't want that happening technical
challenges how difficult would it be to
amp the page at the time some of our
pages that we were considering or still
in a legacy framework and that would
make it more difficult to amp the page
and page ownership do we own the tape
page or do other teams have a stake in
that page if we own the page it makes it
easier to amp the page you need to go
one more so the big one so page
ownership guide books this page occupies
our things to do in Amsterdam or things
do in San Francisco now the SEO team
actually built this product from the
ground up so for SEO is it works but the
big problem is that like the traffic is
kind of low and then in
ten foot people coming in isn't very
high so for that reason we decided let's
not amp our guidebook pages
p1 our homepage this page is the highest
traffic's page on the site so it would
be high impact if we amped it
however this page goes through a lot of
changes and ownership made it difficult
to really choose this page so we decided
not to amp p1 and this is p3 our listing
pages so the exercise of working on p3
for about 2 weeks before we decided to
stop nice thing about p3 is that there
was only one other team working on it
and the conversion rate is super low now
the careers being low is really great
for us because of the amp it we might be
able to get the conversion rate paired
with p2 unfortunately it's built on the
legacy framework so we and the page was
in constant flux because the other team
is refactoring it so for that reason we
decided not to go with P 3 and finally
p2 our search results page this is also
a very high traffic page it would be a
high impact a lot of people work on this
page but through process of elimination
we decided this was the page that we
would amp and here's a look at our
traffic breakdown things to do as you
can see is only 1% of traffic it would
have been very easy to amp that page but
that's why we didn't choose to have it
because it so it's very low traffic well
that's like well the amp my minimal
Viable Product as much as I hate that
thing so first question asks how does
amp work within our existing framework
how does amping p2 interfere interfere
with our website infrastructure what is
amping p2 due to the work flow of other
developers in the company how does this
impact design experience and the overall
product so these basic questions that we
want to answer there also
quite a few other questions that we
decided let's procrastinate and let's
not think about it for now the first one
being like how do we integrate this into
a fully functioning product and the rest
with the rest of the company well the
problem is you're pretty minimal Viable
Product so there's no reason to worry
about how a fully functioning product is
going to work with rest the company we
didn't want to address all of the
complexity concerns like validation
although along the way we did actually
up have to address some of those and
we'll talk about that later we didn't
want to worry about getting bind from
other teams we wanted to create the MVP
and the team to actually see how it
worked in order to get them to buy into
it and how do we integrate amp into our
experiment experimentation framework the
last one is who's actually going to be
owning amp I mean the SU team is
creating it but in the future is the
ester team would be maintaining it are
we gonna create a special amp team or as
maybe website infrastructure gonna
handle it obstacles so one of the first
major obstacles was that our page was
timing out server-side rendering it was
timing out sixteen percent of the time
compared that to less than four percent
for a canonical page and when it times
out this is what it looks like on the
right side here it's just a blank page
versus what it's supposed to look like
on the left now normally this wouldn't
be a huge problem because Google is
supposed to link to the canonical
version of the page if the page doesn't
validate however there was a bug and
this is actually what users saw so how
do we actually solve this problem well
we implemented CDN caching that means
our never whenever Google calls our amp
page the first time that it actually
renders so it may fail fail the first
three or four times the first time it
actually renders we go ahead and cash
that in see the end level and then from
then on for the next 30 minutes Google
will continually get serve the CDN
version so this effectively drop a
timeout rate from 16% to virtually zero
new features broke amp if an engineer
added a single image to the page that
would break em validation another hand
on engineer might add a feature that
didn't break validation but it still
created a really bad experience here's
an example where the entire search
results just rendered blank architecture
solutions we wanted to make our pages
and compatible without having to
recreate a separate version of the page
and we also wanted to be able to use our
resisting framework which is based on
react so why is this so hard well for
security and performance reasons amp has
a lot of limitations or a lot of
constraints so here it's specific to us
amp doesn't support important our CSS
and J's frame library that we use called
aphrodite adds important to every style
and doesn't support inline styles and
with reactor uses a lot of inline styles
and only supports style tags which
appears in the head and aphrodite
inserts the styles in the body and aunt
limit CSS size to 50 kilobytes as and as
we added more features we ended up going
beyond this limit so inserting heads
into the style Styles into the head so
hypernova is the name of our server-side
rendering service it's an OGS service
and the way it works is that the user
makes a page request rails renders in
the ER be template and the ER be
template makes a call to hypernova via
this call to render react component and
this is what it looked like before and
then this is what it looked like after
so now we're using hypernova to render
the entire page and this way we can
install we can insert styles into the
head we publish this as an open source
project called hypernova amp important
this is what it looks like in react when
you install when you insert styles into
a div using the CSS function now I
should mention if you don't know it see
our CSS and J's is or react this is this
is JavaScript code or it gets transpiled
into JavaScript code it's not actually
markup and this CSS function ends up
generating the eventual styles and this
is what it looks like at the end after
it's been generated into actual markup
so what we did is we added a nodejs
environment variable and conditionally
rendered important or didn't render
important depending on whether or not we
are rendering
Paige what this also means is that now
we have two bundles one bundles for amp
and one bundle is for the canonical page
inline styles this is kind of a
simplified version of how this works but
the idea is that what you pass into CSS
that's what Arg is here and there's a
factory function for creating
class-based styles so we recursively
call this function in order to convert
any inline styles into class-based
styles the 50 kilobytes CSS limit so one
of the things here is that we actually
weren't generating any extraneous Styles
aphrodite actually generates styles on
the fly so that every single style
that's being generated is actually being
used in the page but still is there a
way to eliminate some styles or get the
style the total number of characters and
the styles to be less so this is a look
at what the intermediate object looks
like when you call the CSS function and
the cool thing about this is that since
it's just a JSON object it's easy to
transform and the result the resulting
Styles look like this on the right now
notice here that we have max width 743
pixels these styles will always be shown
in an amp page so it turns out we can
just eliminate this line of code so the
rule here is if max width is less than
or equal to the mobile size you can just
remove the media query and preserve the
styles here's another example now we're
using min width notice that none of
these Styles none of none of these
styles will actually be used on a mobile
device so in this case we can actually
just eliminate all of these styles and
we got a bigger reduction in CSS as a
result of this logic so the rule here is
if max width is greater than mobile size
you can
eliminate the rule finally we did one
more thing class the class name
minification originally our class class
names looked like this and then after a
minute we got them to look like this
it's it's like Hello style was what was
in code and then after that it is a hash
that's appended automatically at the
aphrodite and we added this as a feature
- oops sorry about that
anyway ant validation so utilizing an
HTML Vatel validator which is available
on npm by made available by google we're
able to start off with a mock data
object which we capture by doing a
regular page load now the cool thing
about react is that your entire page is
represented it's just a single single
function in this case magic carpet
bundle and it just takes in the argument
which is the data that you need to
display in the page so we can just treat
the entire page as a unit in a unit test
so this is a really easy way to
integrate validation into our continuous
integration system the only downside of
this is that it's a very heavy operation
most unit tests don't do something this
like extensive and it did caught it has
caused unit tests to timeout because of
the threshold that we set on unit tests
and this is a look at our react
component sandbox
this is storybook it's an open source
project we didn't create it but we use
it and we customized it for our needs
and when you develop a react component
it makes sense usually to develop that
component in isolation as opposed to in
the context of the entire page and
that's what this component sternum box
is used for and what we did is we added
a tab called amp that simply renders the
component just the component using the
amp render
and this is a really easy way for
engineers while they're working on a
component to also check to see if that
component works with a.m. and it's
actually not in this screenshot but you
can also just open the dev tools and see
if there's any validation errors and
here's an overview of the open source
projects that we use the ones in white
are the ones that we didn't create
hypernova amp is what we use to rent for
server-side rendering and react with
Styles interface amp Aphrodite is what
does the style and elimination and we
added a PR to Aphrodite as I mentioned
earlier which is what does the class
name minification so with Gail going
over a bunch of the technical issues I'm
gonna go over some of the public issues
that we did run into with amp the very
first one that we did you might be
completely sure that'd be easier the
very first thing they ran into is user
flow issues so useful works really well
with amp as long as you're logged out or
a first-time visitor the problem starts
appearing when you have login visitors
and that has now dropped into a very
very confusing experience people that
are returning visitors are used to
seeing p2 they're used to seeing a more
customized version of the landing page
or of the search result page and they're
used beyond check the trips and their
messages and we're not able to offer
that with amp so yeah so just a really
the initial page load is just a lot of
experience and like we need to figure
out how to get the log danvers' from the
p2 for people to actually use another
issue is with deep linking as we all
know we have amp enabled it requires a
second click for you to actually get
deep linked into the app so I never even
be we care a lot about the user flow of
a user journey and being and being
unable to dictate when users are able to
go the ad versus when actually go the
amp page is good is an issue for us so
so there's very very polarizing ideas
about whether or not this is an optimal
user experience or sub-alpha only user
experience another issue is just
iteration and makes it very difficult
for us to experiment and we live and die
by experimentation framework and we have
an in-house experimentation framework
that we use and amp doesn't make it very
easy for us to start integrating with it
so in you know as we on experimentation
another domain is extremely difficult so
iteration with amp was a pain for us and
the last one is stability while we were
testing amp and running experiments and
trying out new things a lot it's a lot
of things kept on changing where
developers would randomly break either
Empire like deal said like adding an
image tag or in or in other instances
they would actually introduce new
features into amp on accident number amp
valid so while unit tests can go ahead
and capture all the errors that you have
if somebody introduces a working
component into amp then it doesn't
really matter like it's gonna get
introduced and it screws up our test
data so on that end like stability was
also another issue so what did we
actually learn from all of this
that one communicating with outside
teams outside the SEO team is very
challenging that while Gil has overcome
many of the technical hurdles the
experience as a whole feels fractured p2
is it gonna be the greatest experience
so you know what do we do with this well
how do we go and address all these
problems with one fell swoop this slide
doesn't actually matter this one does to
answer the question let's dial back so
when we first started on amp we first
started working on amp we also started
work in a new product we call it magic
carpet and magic carpet there's our
landing page this and that we designed
and magic carpet is a page that it's
created specifically tailored for
first-time visitors coming in from
search engines and here is what magic
carpet looks like on the left is a
regular PC page you can see the search
results and it'll tie in a small little
search bar on the right you can see
magic carpet which has the same content
has the same results but the biggest
difference is that it has all of these
like it has a very very strong call to
action that tells users exactly what to
do now what does this actually do well
one it redefines the user flow it
redefines the booking flow because
people coming in this page now know
exactly what to do rather than going
into a p2 page it being a little bit
confused
now they're entering entering a p1 like
experience they're coming in they know
that they need to search
we limited the exposure to a certain
demographic and we focus a product
design for that demographic and then we
end up having much more polished
experience now how does this relate to
amp well after you launch metric carpet
we actually increase conversion rate for
SEO bookings by six percent this is
before we introduced amp to the page now
this page seems perfect for amp since it
is by default a long out experience
because it is a landing page system so
right now we have we've enabled amp on
the page and we're undergoing testing or
in order to see bookings conversions on
the plus side we have seen like a
drastic increase in title on a page
drastic increase on pages per session
and a drastic decrease in bounce rate
now I'd be minutes to talk about amp we
didn't talk a little bit about logging
and experimentation
now there's three types of experience
that we would want to do and there's
just a time I'm not gonna go over
traffic for the first one being traffic
the segment being bookings and the third
one being downstream metrics you wanna
be looking at the amount of p3 views how
many people are searching with dates so
let's talk with a deep link problem
let's say we run an experiment for four
amp so we have some treatment will have
amp in the control will have regular
pages so if you go ahead and amp up a
page the user journey goes like you go
to Google you hit amp and you perform
the same click and then you get deep
linked into the app the second step or
for control you click on the you click
on the result and then you get taken
straight to the app seems like a pretty
simple experiment right so what's the
problem here is that actually leads to
the artificial inflation and metrics now
why do you why does it do this well the
big problem is that we are unable to
track the amount of users coming in from
deep linking now why is this an issue is
because is an Android don't have a
strong enough I like they don't give us
live or further information they don't
help people that are coming from Google
now how this works with like paid search
is that you have a URL parameter that is
admin people come in but people come in
from Google you're unable to actually
like you can't add in your URL parameter
to a Google search result I'm
you could but that wouldn't be great for
SEO so as a result we can't actually
like experiment with traffic we can't
see if like if there is a incremental
increase in traffic because of this
issue because you'll always have more
people that are going to be hitting the
amp page because we can log that
impression but unable log impressions
coming from deep linking so while the
Divis may be one or two percent like in
why don't you present an experiment
that's a big deal so what what are the
solutions for this well their very first
one is to actually port them over to the
Airbnb page first so they'll go when
they hit the air B&amp;amp;B page then recaps
the information of me instantly do you
think them over so there's a really
quick context switch and that's great it
works but everybody again like user flow
the design the behavior matters a lot so
we actually need to go undergo testing
to make sure this doesn't impact
bookings and a sub optimal solution in
the interest of time is that we just
wait because as we know you go like
browsers will end up supporting amp to
show the actual canonical URL so just to
recap I know this is all the product
issues and all the technical issues we
came up with amp and these are the
solutions that we came up with but I'm
Brian I'm Gail thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>