<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Going offline with Service Workers w/Phil Nash | Coder Coacher - Coaching Coders</title><meta content="Going offline with Service Workers w/Phil Nash - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/BeMyApp/">BeMyApp</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Going offline with Service Workers w/Phil Nash</b></h2><h5 class="post__date">2016-07-26</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/sTgN5rDC49A" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hi everyone and thank you for coming
we'll be starting in two short minutes
you
you
welcome ladies and gentlemen to another
beam at webinar it is awesome having all
of you folks here again my name is
Fernando and for today's webinar I had
the pleasure of introducing you guys to
fill
here's developer evangelist for Twilio
and he's gonna be going with us actually
showing us going offline with service
workers as always if anybody has any
questions please please be sure to type
them down in the comment section and
vote further delay I'll let the man
speak for himself Phil you have mic and
screen sir thanks very much thanks for
ending and hi to everybody else let me
just share my screen now so you can see
what I'm seeing and we can get kicked
off cool all right so good afternoon or
it's afternoon for me at least and
wherever you are in the world
good day tea or whatever my name is Phil
Nash and I'm a developer evangelist at a
company called Twilio Tullio is a
communications platform for your
applications to communicate with your
users via voice video or messaging and
using the tools languages or frameworks
that you already know if you ever have
any questions about that do find me
online at any of these places I'm at
phil nash on twitter and github and all
those internet places or i'll drop me an
e-mail at Phil mash at toyota.com
cool but so I wanted to talk this
afternoon with you about going offline
with service workers it's a really
exciting part of the web for me I think
and I hope to share that with you at
this afternoon so firstly I just want to
start with a quick introduction to what
the Service Worker is and I kind of
wrote it down or don't thought was a
relatively synced way and I hope you
agree and that service workers are
scripts JavaScript that intercepts
Network requests so that web developers
like ourselves can treat the network as
an enhancement and then provide offline
experiences for users or web
applications and that's basically it for
me it's I think it's an exciting thing
but we are able to produce these offline
experiences I'm gonna try and show you a
few of those today as well there's be
interesting because I can't obviously go
offline as this is a webinar and if I
did
you wouldn't hear me so we'll see how
how that kind of thing works out as we
go through this but come and come and
join me on that journey so first of all
for me
this is a great feature of the internet
the xml httprequest it was invented our
way back in kind of Internet Explorer
five point five or five or something
like that when the when the Microsoft
Outlook online team said hey what about
we you know we're able to change things
on on the page without doing a whole
page reload or using frame sets and and
a horrific API was born a horrible one
really when you think about it I mean
that even the API itself doesn't make
sense like why isn't tdmp
capitalized in this like but what it
brought about was this ability for us to
make these interactive applications
online and that just was really exciting
back then and and nowadays I can imagine
it can you even imagine a modern web
site that doesn't use XML HTTP requests
via Ajax in in some way I don't think so
you know only the very simplest kind of
maybe content sites that just have just
have documents just have maybe blog
posts even that kind of thing is is fine
without Ajax but most modern
applications these days will use that
kind of thing and I believe that in the
future we will wonder how we coped
without service workers and without this
ability to make sites work offline and
make them work better for users in that
way so what does this serviceworker
really do
well again rather than just tell you
about it now I kind of like to show you
and so I have an application right here
running it's the simplest possible
application that just has an HTML page
and some CSS in fact this is a template
from bootstrap because I wasn't going to
design a page for myself but I'm gonna
make it go offline I prove to you right
now that it won't work offline because
this is the server that's running that
page and it's now offline and if i
refresh this page
we go with it's gone now this is faking
offline so we don't get to see the the
dinosaur of disappointment the little
game that you get when you really are
offline with chrome but this is the
equivalent of this site being offline
let's start it up again just to just to
prove that there we go we're back so
let's go to the code for this
application and that is not good this is
right here so you can see this is you
know offline apps rock that's what I'm
talking about
and right down here I've got some I got
a script tag so I can put some
JavaScript in and install the
serviceworker and for the serviceworker
itself lives on the navigator object and
and it's right there and that's what you
can kind of do a test if you want to
progressively enhance just kind of test
you know if serviceworker in there
service worker in navigator it can be
that kind of tech so that we don't break
things for people who don't have the
serviceworker
and then we can use it and what we need
to do is register a serviceworker so the
serviceworker is a piece of javascript
that lives outside the context of the
actual page the website that you're
looking at it runs in the background and
so we need to connect we need to install
it we need to register it with the with
the browser to say hey this is a this is
our serviceworker and we want this to
deal with stuff and all you need to do
with that it's just point it towards the
cause that serviceworker javascript file
and we'll take a look at this file in a
minute you can add some options to this
such as a scope and you can maybe scope
this to part of the website if you like
this would scope it there anything that
starts anything with the path that
starts with slash admin but we're not
going to do that right now because this
play at this website only has one page
so that would be very little point in
doing that in fact it just wouldn't work
cool so what when you register it
another thing that service workers use
quite heavily is promises this is not a
callback based system this is all very
modern new and promise base
so when you install the register the
service worker if that registration and
installation is successful then you will
receive a callback with a registration
object and right now we don't need to do
anything with that registration they
will look at things we can do with it
later
about what we will do is just log some
kind of excitement because it worked
similarly if the service worker actually
fails to install you can catch that
error because the promise will reject
and at this point we'll get an error and
at that point if everything's gone
horribly wrong
we probably want to know about it so
let's log that out as well and that's
all you need to do to get started
registering a service worker now we
should probably go and build that work
that service worker so service workers
as I said run in the background and
they're not running all the time they
actually listen out for events and that
that triggers code for them to run very
very much like anything else you do in
JavaScript so what we get is a number of
events and the first one the service
worker will receive is the install event
and that it gets when you make try make
this registration happen and this is
where we can you know pass or fail that
thing now since the service worker is
running in the background they can
actually kind of get killed at any time
as well like the browser if it decides
it doesn't need it right now can kill it
off so we actually tell we can tell the
browser hold on we're doing some work
right now can you wait for this to be
done and then we're good and you do that
with this event or wait until and wait
until takes a promise as an argument and
when that promise resolves the event is
over or when the promise rejects the
event is over so we're just gonna pass
an event in here and then we're gonna
look at one other API for now because
we're gonna look at the the caches API
which is also fairly new with with
service workers and the caches API
allows us to open up a cache put some
static files in there and then retrieve
them later and so I'm actually rather
than using a string there because we're
going to keep using this cache name all
over the place
I'm just gonna write I can cash name up
here this is just me more flying rocks
why not and we're gonna open that cash
name I open that cash the cash called
offline rocks and if it doesn't exist it
will create it and that unsurprisingly
returned the promise
pretty much everything does at this
point in the serviceworker
and that's gonna return when the promise
resolves it's going to resolve with the
new newly opened cash and so we need to
then add some files into that cash now
you can add them individually using just
add or put but if you use cash to add
all this actually takes an array of
objective strings array of paths and
hashes all of them and if any of them
fail then the we promise rejects and if
they all successfully cash the promise
fulfils resolves and and the
installation finishes successfully so
we're just going to add an index.html
and then the rather grandly named dot
CSS this is hardly an app I can tell you
but that's what I called it in the first
place and we just can do that so that's
our install event and and when we run
the serviceworker on the front end and
we install it this bit will get run in
the back end and i like to call it the
back end and it's definitely not the
back end the serviceworker to me is
always the middle end it's very strange
so i end up calling it strange things
and when i say the front end in the
course of this the cause of this talk
what I really do mean is the the browser
itself in a page that the JavaScript
that your normal JavaScript is running
in and so when you register the
serviceworker on the page this is the
install that will run and this is and
this will only succeed if all the
caching in this particular case succeeds
but this isn't enough to just go offline
we've cached these files that's cool but
we need to be able to return them as
well and like I said the the
serviceworker
responds to network requests and that is
where we get the fetch event
and so every time the page makes any
request and that's to your server or to
external servers you're going to receive
a fetch event in the serviceworker and
then we're going to have to deal with it
somehow so in this case we're actually
going to use event respond with this
also either think is a promise or a
request object and we can actually
return a request object here we can make
one of ourselves in fact and that would
just return hello world for any requests
which in this case would only be the
first request for index.html because
we'd never request the CSS because all
we'd return is hello world so it's a bit
boring instead we can actually say
request it's a response sorry it's a
response object obviously and sorry it's
not obvious I'm talking about it but we
return a response object with hello
world in it and so event not respond
with kind of return that response or a
promise that resolves to a response and
we are going to get our response from
the cache and I hope that's
unsurprisingly so in this case we're
going to open up our cache again and
instead of putting things into it we're
going to get things out of it and
actually all we need to do is return
cash match on the event request and that
is a request object so the cache matches
incoming requests and then the returns
the response which is part of a response
object cool so that is actually all we
need to do in this case there's some
semicolons immolate a really matter in
this case as long as I don't break
anything not putting this in my coat on
inside respond with is the important
thing because that's a promise and not a
function or anything like that cool so
what I can do is go back over to the
offline page oh the currently online
page and refresh it and I have dev tools
open on the right hand side of my screen
here and you can see here and so this is
a Chrome Canary so it's the latest kind
of version of the dev tools for service
workers and the application tab up in
the top
there and you can then look at the
service workers that you have and we can
see that over here we've activated and
running this service worker so one that
should mean is that I can kill the
server off and the service worker will
take over and I'm refreshing the page
there and I'll click refresh as well
just to show it on screen but we are
still seeing our page all of the things
are still getting returned to us because
they are now cached and offline and we
can actually see that cache here is that
offline rocks cache that we made and our
app CSS an index.html a living in there
cool
so that's go back to the slides for a
second because you might now be kind of
asking why why is this important why do
we want to be able to make things work
offline or I hope you're asking that as
well is just doing what I say is a
terrible idea most of the time so
hopefully you're asking why and for me
this kind of is a bit of a question of
web versus native this is a question
that many people ask how many people
argue about quite a lot but this is this
is my view on it and I feel like the web
and native have native applications have
very different kind of abilities and to
I think are very important at this point
because the web has always had this
thing that is online by default and this
is it's this is maybe it's problem right
because every time you need to use the
Internet
even if you have cached files in say the
HTTP cache in the browser it's unlikely
that the website is gonna work if you if
you go offline if you lose your Wi-Fi
connection if you are on a mobile device
and you go into a tunnel or underground
or whatever like that you're unlikely to
get hold of that internet page that
website
whereas native applications are
absolutely offline by default once you
do that original that initial install
from the App Store your application a
native application should have all the
files and all the assets it requires in
order to run and give the user some sort
of experience by default now it is
possible
that a native application developer may
have have programmed their applications
such that it requires a request to the
network straight away but I you know
that's their fault that was their
problem they have spoiled their their
advantage in this case and that's not so
great
but all native application developers
have this ability to be offline by
default and give an experience to their
users on the other hand the web has
discoverability you know we are we have
search engines that the point people to
our sites and we have links that you can
share and the link truly is the the best
part of the Internet as it is the you
know it is that thing that networks and
joins all different parts of the of the
web up and you know you don't have to go
through any kind of app store or any
kind of gateway at all in order to use a
website on the other hand native
applications have the worst kind of
first-time user experience you can
expect from any kind of application and
that's because you have to go through
the App Store installation now perhaps
you are on the internet and you're
trying to get something done and the web
site you're on is says hey how about you
install our app and you go okay that
sounds like a great idea first you have
to you know knockout into the App Store
itself or the Play Store or whatever
store that your device is on you have to
you probably link through to the actual
application at that point but then you
have to click the install button and
agree to a bunch of stuff and and sign
in to your account and all sorts of
things like that then you go through a
download and typically I've found that
applications particularly important and
decent ones are much larger in size to
download thinner than a web app I mean
even if we take the average size of a
website in the top thousand these days
as two megabytes or 2.2 megabytes which
I think it is apps are typically larger
than that at around six I think was the
last six megabytes per application on
average was it was a stat I saw but that
thing that came from 2012 so
it's probably larger by now and you know
you install this application takes a
while to download and finally load it up
and the app has no idea what you
actually came to do there in the first
place
meanwhile the website you were on still
knows what you're supposed to be doing
but now you have this application
installed and it it's it it's like a new
person you're like a new person to it so
that's you know app store installation
it's a horrible thing if you ask me it's
particularly horrible when you're trying
to do something on the web and somebody
pops up that little thing saying hey
download our app because that just ruins
the experience for me and so I think
that you know we're looking at service
works and this ability to mid take the
internet offline take websites offline
and that is where we get to change the
game in this comparison because we can
now make our websites work offline first
and produce an experience for our users
that will work as if it was a native
application but without kicking them out
without making them go through an
installation and maintaining the
discoverability that we have from the
web and from links and from all the
sharing you can do like that so that's
why I'm excited about it but maybe you
don't care about offline maybe you don't
want to take your entire application
offline there are still things I think
that the Service Worker can do for us
and that's that's why I think's exciting
because think about performance for
example if you've just taken your static
assets and and cash them into a into the
serviceworker cache which is something
that you have control of and something
that you can pretty much guarantee
they're going to be they're unlikely in
the HTTP cache then you are able to
serve those assets ridiculously fast
from that cache and just have to load
the rest of your data or maybe just the
HTML page that's sat on you could also
pre cache some things so if you you know
if you land on your home page and that
doesn't contain all the CSS for your
application or all the JavaScript for
your application then you can start
loading that in the background in that
install event and and then the rest of
the site is going to work so much
quicker
similarly fall backs are pretty good as
well so I'm talking about experience a
lot for for users and and being able to
use an application whilst it's offline
is a great experience and the worst
experience is either where you go to
refresh a page or go to the next page
and the browser hangs with a white
screen saying I'm trying to get this but
I can't I can't get hold of this page
right now and or you know the browser
believes it's completely offline and if
you're in chrome you get to play that
great dinosaur game but you're not
seeing the application you're not seeing
the website that you visited in the
first place and we can do better than
that we can keep people we can still
give people an experience even if it's
not the intended experience for the site
by giving them some sort of fallback and
one of the best best examples of this
I've seen as an experiment done by the
Guardian developers on their blog and
and if you are on I believe it's still
an experiment so you have to go to the
actual developer blog in order to enable
this but if you go to the developer blog
and you have a browser that that
supports service workers and then you
disconnect from the internet somehow you
will you don't get the dinosaur of
disappointment you don't get any offline
pages you do get this nice page here
which says I you you're you're unable to
connect to the internet but in the
meantime how about a quick crossword and
and what's great about this is you know
if you're offline in this on this page
you're offline on everything else you
might be on any other tab you have open
on in your browser and so there's no
point going somewhere else
so this crossword kind of keeps you
where with the Guardian and you know
perhaps this is something that works
particularly well for commuters if you
go through a tunnel and you know they're
reading the news and now I can't read
the next page but don't worry there's a
cross ride to enjoy in the meantime I
just think it's a really great fallback
experience I mean there could be a
simple a fallback experience which is
something like just saying unable to
connect to the internet but you know
don't worry I'm sure you'll be online
again soon but this is a particularly
nice one I thought
and there's more there are more features
to the service work and it's just in
this offline capability and I will touch
on a few of them later and we'll see
them in action hopefully so I guess at
this point it's important to ask how are
we going to do this because clearly the
code I just wrote for that simple
offline website is just a little bit too
simple and you'd be right because if I
were to go and say change something on
this page let's let's go and change the
title say be my app and then I go and
reload this page it doesn't change and
that's because Mike serviceworker has
cached all my files online and it never
reaches the the actual server again so
we've got to do something about that and
I actually want to just introduce you to
another example application that I've
been working with recently in order to
to discover various bits about service
work and going offline so this is an app
I'm writing it's a website it is using
Google's material design so and material
design lite framework so it looks like
it might be a real application but it's
not it's definitely a web app and what
it does is it uses the Twilio api to
send a receive text messages a very
simple idea but and everybody has an SMS
application but this one is one that
would work for a for a Twilio number
which doesn't actually doesn't really
exist in the world or not without paying
for them anyway and so my idea here is
that this this application should be
able to work you should be able to read
messages that you've got you've received
if you're offline you should be able to
send messages when you're online and
receive other messages on your own line
and that's what I've been working on
right now and so this has kind of led to
a bunch of the things I've discovered
about service workers and about making
offline applications and I say for
of Enhancement right now because I built
this application without any JavaScript
to start with oh it has the JavaScript
for material design Lite so the the menu
does a nice pop in from the side and
things like that but that's that's the
only JavaScript it started with and I
was really pleased to be able to do this
because it it truly proved to me that
service workers worked very well with
progressive enhancement the idea that
you can take an existing application
something that's been built to a decent
standard already and add in offline
support without having to rewrite the
whole thing from scratch is just really
exciting and it means that all the
applications out there all the web
applications out there can benefit from
this without too much work obviously the
size of the application will determine
the work but it is not a ground-up
rewrite that everybody needs and that's
cool
I've always been great proponent of
progressive enhancement on the web and
this is no this is not time to stop with
that in fact it the progressive
enhancement using the serviceworker is
absolutely brilliant feature so what do
we need in order to create ourselves it
create an offline experience for our
users what do we actually need I think
there's five things I'm kind of talking
about today there is a base experience
like I said the existing application we
need to do something with our static
assets we need some way to make the rest
of the pages work offline background
sync is a fantastic feature that is very
useful in situations where you want your
user to perform an action but they don't
need to they don't they shouldn't need
to care whether it completes or not at
the time if they're online or offline
something that will eventually happen
and then finally push notifications
which I think are one of the most
powerful things that the serviceworker
also brings to us and is is really
another thing that's having me very
excited for quite a while since since
seeing that this was going to come out
and it's nice to grab that base
experience good news like I said we just
need to work from our existing websites
you have a base experience if you have
built a web app a website you have this
base experience already and hopefully
you've built it in a good way in in a
progressively enhanced way but basically
it doesn't matter we can start building
on top of our base experiences enhancing
our sites with a with a serviceworker
progressively whenever whenever we want
as soon as we want to and and secondly
that I mean this is a second exciting
thing is you know that if if we don't
part this serviceworker check in our
JavaScript then we can actually we don't
we can just forget about things and the
site will continue to work as you
expected it to in the first place it
will continue to work as it did as a
website that doesn't work offline which
is fine that is great for any any
browser that doesn't support service
workers because that's all the users are
expecting and we just have this ability
to surprise users by making it work when
we are online so cool let's do the rest
attic assets then so we saw that I've
already broken this site because I
stored all the static assets offline and
and now I can't change anything but
let's make let's make a change let's
make that happen
so if I just changed the cache name to
offline rocks one this makes a change to
the serviceworker itself and that means
that the browser is going to the browser
continues to ask for the latest
serviceworker even if it's ignoring the
index.html in the app CSS and so if we
do that and i refresh the page we can
see that's interesting it's disappeared
we got an area that doesn't seem right
because I'd kind of thing offline that's
why
you have to have the site online in
order to make that work let's try again
and what we see is we've got a new
serviceworker and we're waiting to
activate it and this ties in to the
service workers lifecycle so I'm just
going to show you that website all
because it goes through a number of
events we've seen some of these already
so when you register a service worker in
the first place we go to the installing
event and this is where the install
event is fired and the state of the
service workers installing then once we
complete that install event the service
worker is installed
however it's not yet running it's not
yet activated and that's the position of
this number nine nine four you can see
in the dev tools it's currently in a
position where it is installed but has
not yet activated it's not running yet
and we can actually see if i refresh the
caches we've got this new cache offline
Rox one because we've gone through the
install of this Service Worker this new
service worker and we've cast all the
things offline and this is going to be
in next HTML that has has the text in it
that says icon that says hi be my app
but it's not yet active and so then the
service worker will go through an
activating event and this happens for a
number of reasons firstly you can see
there's a link next to the waiting
directive 8 Service Worker which which
says skip waiting and that is a method
you can call on the service worker and
I'll show you where that that will come
into play later or if you were to have
this button at the top of the dev tools
here checked which says update on reload
if you have that checked then this is a
great thing to check when you're in
development and writing your service
worker because it will instantly like
replace service workers it doesn't go
through this life cycle anymore with a
natural way for it to actually happen is
if you were to close all the tabs that
have this service worker have a page
which which is controlled by the service
worker in running
so I'm just going to close that page and
then open up open it back up again
that's my tumblr home page and now you
see it so it might be my app and out
serviceworker number nine nine four it's
activated and running and so that's what
happened there
we we replaced our serviceworker because
all the pages it was controlling we're
dead and so it had nothing left to do
and the new serviceworker took over when
a new page was requested and we got the
latest cache so that's pretty cool one
problem is that we actually still have
the old offline rocks cache here as well
and so we should do something about that
let me just finish so we have activating
and activated is that point where the
serviceworker then takes over by either
when you click skip waiting you call
skip waiting on the serviceworker object
or or all the pages are closed and the
new one is opened and finally there is a
state of redundant and that is in the
case of a serviceworker that never
actually gets to to activated because
it's taken over by a different
serviceworker that's changed in the
meantime
cool so as I said we are we still have
our caches that we had already so we
need to look at some cache invalidation
as well and if we go back to the code
here I'm just going to write some more
stuff in our serviceworker file but we
don't want those caches hanging around
forever that's just going to clog up a
user's device so we can listen out for
the activate event and do stuff with it
and in this case what we're going to do
is just clear out the old clashes that
we don't want anymore so we don't take
up too much space it's a great part of
the this is a great part of the life
cycle of the serviceworker in order to
invalidate those old caches clear stuff
out that you no longer need because the
old service workers have gone away now
and and that's what we can do so first
of all we're going to tell the event to
wait otherwise we might get things
killed and into that when you could pass
promise that's why I'm going to actually
use the caches API and get me caches
keys method which returns all the names
of the cache
we have as you see I actually have three
in here as I was as I was going through
this demo before and this is an old one
so we've got LW s - we've got offline
rocks and offline rocks one now flying
rocks one is the one we want to keep and
that's for me having cash name here so
we want to filter through those keys how
long do so keys returned the promise
which resolves with the an array of
means of caches so we get the names
there and in there I'm actually going to
wrap this in promise to all I don't need
a an array for that in a Rapids I'm
promised at all because eventually we're
gonna return promises from this array of
names so first of all we're going to
filter the array because we don't want
to include the cache name that we want
to keep which is stored in our cache
name variable so basically we want to
return any we want to filter out
anything that's not our current cache
basically that if the name is not equal
to cache name and then and we're going
to map over the names and return
promises because we're going to try and
delete the name so that will return
promises to promised at all and when all
the caches are successfully deleted
then from stall the resolved this outer
promise will resolve an event wait until
we'll get a resolved promise and
complete so we need to go through our
update cycle again and in this case
actually just going to check check that
update on reload button so this means
the second serviceworker is going to
take over and activate straightaway
should we see that happening or did I
get an error nope have I taken this
offline again that's always a good
question
check that and see what's going on
what's going on serviceworker so in
inside this dev tools here you can
actually inspect service workers at the
time that's pretty cool and I don't know
what's going on with that this is great
fun it doesn't seem to believe that and
there's anything different which is
interesting so I can look at the source
and it still has the old one which is
very fascinating I'm just going to close
that page and try and open it up again
maybe that will work look at application
which don't have nine nine four running
I'm going to stop my mine for because
and then unregister it because i'm
unleased with it and it's gonna so we do
have an error somewhere
an unknown error which is totally
unusual so let's work out what's going
on I need to return that price at all
presumably okay that have I through me
and I'll put anything in that wouldn't
be normal all right I'm gonna have to
move on from that what would have
happened is we we'd see our cache
cleared out with that application and
that active activate thing runs and I
will discover what happened to that
later and I will publish the code so we
can all see about that because that has
worked for me several times before I do
have a backup here which has the same
thing so is that what I've done wrong
I'm just going to copy
one into place didn't see anything
different there but it's still not happy
with me so I know what's going on there
that was an existing thing that worked
we'll move on from that and get back to
the slides you can just trust me that
that should work because we have more to
think about when it turns it comes to
that cache invalidation of taking over
service workers because we don't just
have to we don't have to wait for all
those tabs to be killed and obviously we
can't expect users to click skip waiting
inside the inside the dev tools so what
you can actually do is is when you
register the service worker as part of
the install script and when that when
that resolves successfully we'll get
that registration you can listen to the
registration for an update found event
and if there is an update for an event
it means we've got a new worker that's
installing and so we can go get that
worker and then listen to it so listen
to events on that including the state
change and once we get to the installed
state when we have that worker ready
it's ready to go and this is a point
where you can decide what to do with it
and one option you can make at this
point is to use the postmessage api
which just it lets you send a message
from the page down to that service
worker and if you send something like
action updates you can send other
actions at other times if you wanted to
but right now if you if you send that
you can you can get it to skip waiting
and this is the same as that link in the
in the dev tools this is basically all
it's calling and so you can listen for
those messages in the worker and if you
get that update action then you can call
self dot skip waiting and the service
worker will take over everywhere and you
can then notify the front page that the
pages again in fact you listen to the
existing service worker and if you
listen for the controller change event
you can know when when the service
worker has been changed underneath the
underneath the page at that point you
can decide what to do if it's a very
small change you might not need to
reload the page you could just
perhaps update some things in your
JavaScript or the simplest and kind of
most comprehensive way is just to reload
the whole page which will load all the
new assets the new serviceworker and
everything else so this allows you to
take back control over your site over
your caches and over your serviceworker
I think it's pretty useful to know that
kind of stuff cool so let's talk about
offline pages then because we've seen
caching static assets and in fact you
see me cache the index page which is
maybe not the sensible thing because on
a website we tend to have data and an
static file static bits in the case of
my sms application you can you can
definitely see that the data is the
messages the messages sent to and from
various numbers however we also have
obviously CSS and JavaScript on that
site those are files static files we
also have there is also a new message
form in which you can send a message to
any number and that doesn't actually
have any extra data with it it's just
simple form with a couple of fields in
and so that could be static as well but
when we're doing this with our
serviceworker we need to think of ways
that we can get that data stored as well
and this is where I've ended up reaching
out to indexdb and I don't know if
you've tried to use indexdb before but
most people's response to it tends to be
a bit of shock a bit of horror and
revulsion as the API for indexeddb is
not the most pleasant it has all sorts
of weird callbacks based on them on how
it's how it works and is because it was
designed before the promise api was
properly designed and implemented in
browsers so we ended up with a lot of
weird callbacks that you don't tend to
want to have to deal with however the
world is a lovely place and people do
how people have produced libraries with
which to use indexeddb and this is a
makes things much nicer for us and so
first off I just want to mention a few
of them because I'm going to be taking a
look at one of them quickly but first up
is is the simplest it
is called IDB promises written by Jake
Archibald who also wrote or helped to
write spec for the serviceworker and an
ID B promises is just is basically the
same API as indexdb except all the
callbacks are replaced with promises so
it can be used in a more same and
promise like manner it still follows the
rest the API and it's quite good if you
want to learn how index DB works
properly but would not have the the
horror of crazy callbacks local forage
forage local forage as a as a library
written by Mozilla and this replicates
the local storage API over indexdb that
might sound redundant as we have the
local storage API but in places like
serviceworkers or in Saratoga is
particularly they've been tasked to only
use asynchronous API and local storage
is a synchronous API so local forage
allows you to use a key value store in
index DB with this simple API of local
storage and it will work offline as
three and it will work in a
serviceworker
asynchronously exe is a slightly higher
level than ID be promises still has a
feeling of the indexeddb api but is it
is much nicer it's a it's a lot more
syntactic sugar that makes it a pleasure
to work with and finally pouch DB I
think's an incredible piece of work as
it effectively replicates the entire of
couchdb the rest based database in
JavaScript over index DB but it also
actually does it over web sequel and
local storage as well depending on the
capability of the browser in this case
we want it for index TB but it's built
the workers in as many places as
possible and what's brilliant about it
is not only is is it a nice way to store
things in index DB it also can it also
comes with the CouchDB sync protocol
which allows it to sync to external
databases
as if they were just another
installation of couchdb and so this is
great for syncing data back to the
server from your users or back to the
database really and very useful but a
little bit too too much work in terms of
the applications I'm thinking about at
the moment so I've been looking at Dexy
mostly which has been there it's been
fun to work with and so this is how
you'd work with that I don't have time
to write this right now but um you just
get yourself a new database you call it
something message store in this case and
and I use the auto open true option
there so that the database just opens
straight away at that point you can
start kind of migrating the database up
and so with indexdb you do have to keep
all the history of the migration of your
database from version 0 to version
whatever you got to so that's any
browser at any time coming to that
coming to that page and using that
javascript will be able to replicate a
whole database or at least its structure
and in this case we just need version 1
and we define the stores that are in
this version and so I only have one
store one kind of table of messages and
that has two named indexes these aren't
the fields that are in the store they
are just indexes the plus plus in this
case is a hidden auto incrementing key
because I didn't really need a key value
key for for this particular application
and then the created at field means that
I'll be able to store a very sort and
and search on the kind of created at
date of any message and then this is how
you'd add a message into that database
indexeddb works with transactions all
the time so you have to open up a
transaction and the W at the top means
it's a rights transaction in this case
and you have to name which tables you'll
be using during this transaction we only
have the one but we still have to name
it at this point when that transaction
within that transaction we just use the
dbo messages and put an object into that
message into the into the database
and that's all you need to do really it
returns a promise which resolves when
when that's successful and there we go
we just we just put in the data we need
and you can use arbitrary kind of
objects in this particular case and then
when you ought to read them out you just
do a read transaction on the database
and you can just call each over all the
messages in this case and you'll get
each item and then you can render it out
somehow I don't care how you render than
things you might be using the fanciest
of new framework so you might just be
writing HTML with jQuery but this is the
kind of place where you would render an
item like that so I'm talking about
rendering on the front end at this point
but I want to make it key that when
we're dealing with stuff like this it is
best pretty much at all times in terms
of both performance as well as
accessibility and even SEO to render
things on the server render your HTML on
the server first because van is going to
get that HTML to users before the
quickest and get them using your
application as fast as possible and so
this is what I'm doing in this
application right now the API is called
in the back end and we render HTML but
then you might be wondering you know how
Willian deal with this this database
that we're using and in our client side
and this is where we come to the app
shell architecture which which is being
pushed by people using service workers
quite well the idea of the app shell is
simply to produce a different bit of
HTML so don't store your just index.html
because that has all the data in it but
just a different thing that has the
outside bits of your application such as
the header the navigation footer if you
have one and then fill that in
afterwards when the so you return this
app shell for any requests for HTML from
your service worker and then based on
the path based on the URL fill in the
application with the bits that you then
expect
and so your application will have to be
built so it can bootstrap that data from
either the page extracting it out of
either the HTML or by including adjacent
objects on the page as well or from the
database in the case of when you start
from the app shell and at that point
once you've bootstraps the app should be
able to work as as as normal it just
needs to bootstrap either from either
from the HTML or from a database and
this is kind of an idea of universal
JavaScript I guess like rent the ability
to render the same thing both on the
server and then on the front end and
there's some great frameworks that are
doing great work with that right now I
want to go quickly into background sync
because I think it's a very cool feature
and I have a demo straight up for you
I'm running quite quite over in time
right now so I was going to show you a
demo using this application which I've
killed you're actually pretty good on
time
pretty good on time I hate call Thank
You Vandy
I appear to have killed the application
it's definitely alive there okay because
I wasn't working earlier anyway because
it's not quite offline able so I want to
I want to show you what I was going to
do is show you the messages and the
ability to send a message whether the
application was online or otherwise
which i think is quite useful but
instead what I have here is an example
from Jake Archibald this is an offline
Wikipedia demo and he's just built this
kind of shell of an app as you can see
there's the kind of app shell
architecture here with the header and
search is all you really need in order
to start this up and then we have this
index page which has anything that's
cached offline which is kind of cool so
I can just go straight to that and I
have this offline page about folio but
if I then make the site to go offline
and I'm doing this using the
serviceworker dev tools again we just
don't exactly work as you'd expect but
let's see I'm going to click just on
webrtc here which is a great feature in
the in the browser real-time streaming
of data T appears and because it's
offline it's been caught the the site's
caught it and said hey I can't do that
but we can say alright let's load that
in the background then and what that's
done is register an event to say to the
serviceworker when you're back online go
do some work and and so if we we can
click around to our existing offline
things but we don't have that yet if we
uncheck the offline box we go back
online but I don't what I found so far
is that this doesn't trigger that sync
event like really going back online
would do but we do have this ability
this little thing over on the right
that's going to trigger a sink for us so
if I hit that what I will actually get
is robot CC ready and a push
notification here to view the article
and now I have the article on WebRTC in
this offline thing and that is how
background sync works so let me just
show you the the API for that because
it's it's very straightforward if you
have a registration this is what you get
when promise when the promise results
when you register the serviceworker and
if you have the sync object on that
registration then you can just call
register and as I said I was using the
message or trying to use the message
example from my SMS app which for some
reason has died but you register for a
particular tag in this case sent message
and that just says alright I would like
to know when we're back online and then
in the serviceworker all you have to do
is listen for the sync event which will
be triggered when you're back online and
then do the things you wanted to do and
so that that's where in this case in
both the case of Jake's demo and my own
we both put things into index dB in fact
this key value store and so I'm just
going to do the same thing again just to
show you that works or offline we're
going to Tulio and then we'll
in C webservice right we're offline load
in background I'm just going to look
inside this key value store here I think
because this is a key value store I
believe that Jake is probably using a
local forage for this one and as you can
see there's just an array of web service
because this is the path of the URL that
we'd want to get from Wikipedia and so
when you sit when you register the sink
you should also put something into
indexdb that you can collect later when
you get the event and know what to do
and so this is the point where you'd go
and download the thing from download the
thing from Wikipedia and then when
that's done with send the push
notification back to say that was
successful
yes and then finally as you saw in that
example in fact we have push
notifications working as well and so I
won't show you that demo because you
just saw the push notification work but
the idea there is very much the same
almost what you do is we have
notifications and I'm just going to
change the permissions for those
notifications of the site right now
which is offline I'm going to put it
back online and then I'm just going to
go do the same thing again I'm going to
go get a page that doesn't exist loading
background at this point you can ask
permission to use those notifications
very much like if you wanted to use the
web notification API in the first place
you need to ask permission so if I can
allow that and then so this means that I
get say I get I get given an endpoint to
send notifications to as a developer for
that user and it uniquely identifies the
user and the browser they're using and
then when you you can then use your
server to send a push notification by
making a post request to that URL to
that endpoint and the web and the
service worker at that point will
receive a push event much the same as
any of our others will actually receive
a push event
and I just if we just have a quick look
at what that might look like I'm not
actually gonna run this particular code
but you get the push event at that point
you know I forget to wait but we can
actually just use the registration of
our serviceworker which will have a will
be able to call the show notification
method which takes both a title and then
an option of sorry object of options
which can include the body and some
other bits including an icon and an
image to show in that notification so
that's just that's how that would work
and then so if we update the sync we're
not flying in are we if we sink yet the
push notification and it is important to
note at this point there's a little
Settings box there which means you can
go and turn off push notifications for
anything right here how would you do you
know so you should be able to block it
there we go so you can go and block push
notifications right here so if you do
decide to use push notifications at all
be wary that they're very easy to turn
off finally you can program it such that
when you click on the notification we
then open up a new tab or open up an
existing tab make that live and that's
how you'd use push notifications cool so
that's kind of what I've been thinking
about when we're going offline with
service workers like this and I think
it's an exciting place to be and I you
know the things we need in this case are
that base experience that we should
already have as a site some way to cache
those static assets so they can just
work offline some way to keep our pages
working offline either by storing our
data in a database or caching other
fragments and using that application
shell architecture
background sync so that you can let
users perform actions and it was doesn't
matter to them whether they're online or
offline it will get done in the end and
then push notifications which are very
useful for notifying things like when
when the person is offline sorry when
the person's come back online like in
the Wikipedia example or the example
I've been working with with my SMS
application is when an incoming SMS
comes to my Twilio number I will send a
push notification to alert the user and
as I said at the start I do believe that
in the future we will wonder how we
coped without service workers and I hope
you do too because they are magical
wonderful things that deserve an
explosion to finish this kind of thing
awful and this is actually a this is
just a clip a gif caught from the end of
a video which advertises a course on
Udacity that teaches you everything you
might want to know about offline
applications and I highly recommend
checking that course out on Udacity so
that's all I've got time for I think
this afternoon I've one tiny plug before
I finish because as I said I work for
Twilio and we're running if you're in
London or Europe or even if you fancy
coming all the way over here from
anywhere else we're running a conference
ourselves in September on September the
20th called signal signal London in
which we're talking about communications
and it's everything from this you know
very basic stuff we can do with SMS
these days all the way up to WebRTC
video chats and and chat BOTS and other
things like that so we'd love to have
you there
and so if you are interested in that
please do use the use the code penis 20
and you can get 20% off over the price
of a ticket and you'll make me very
happy
but otherwise that is all I have time
for and all I have for you today I'm
very happy to take any questions right
now so thank you very much
perfect filled thank you very much for
that
I think everyone pretty much understood
it I think nobody got lost I think
everybody was well on track
folks is always so people are coming
late I usually mentioned to everybody
else that if you have any other
questions when you're coming
late we do feel free just to type in the
comments section because we're always
checking them and I will always be happy
to email them to Phil if you ever have
some spare time he can oh absolutely and
as you can see I've popped my details
back up on the screen as well so do hit
me up on Twitter or email if you have
any questions as always the airport
until the people that are watching it if
you really want to if you guys want to
watch it again just feel free to refresh
the link and to everyone else I see a
thank you a big shout out again to
Twilio in to Phil man I really
appreciate you coming down and showing
us the works again folks and don't
forget about his promo code which I
think was a pee Nash hey Nash 20 you
know explain you go ladies and gentlemen
thank you very much for coming and have
an awesome day cheers folks yes right</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>