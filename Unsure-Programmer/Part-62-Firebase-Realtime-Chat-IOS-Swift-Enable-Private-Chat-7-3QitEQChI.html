<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Part 6.2 - Firebase  Realtime Chat (IOS Swift) - Enable Private Chat | Coder Coacher - Coaching Coders</title><meta content="Part 6.2 - Firebase  Realtime Chat (IOS Swift) - Enable Private Chat - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Unsure-Programmer/">Unsure Programmer</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Part 6.2 - Firebase  Realtime Chat (IOS Swift) - Enable Private Chat</b></h2><h5 class="post__date">2016-07-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/7-3QitEQChI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so the way we're going to do that is
firstly we're going to make these
clickable right now if you click these
nothing happens so let us do that let's
go implement the method required for
that the method required is when we
called did select item it index path
here we're gonna have to perform segway
without enter fire and go to the
storyboard which shows the particular
use in allows us to chat before we do
that let's go to the main story board
and create a new view controller flag
that in as always set it sized for SMS
seven inches and embed it into a
navigation controller control drag from
the UI connection we controller to the
navigation controller design model click
on the segue and let us leave that chat
okay coming here let's reset the title
to a generic name which is when we users
name this way we'll update the users
name we will also add a button which is
going to allow the user to go back to
the you correction you controller come
back to users correction controller now
let's perform the segue self-taught
perform segue with identify the segue
name is chat and the sender is going to
be the particular user let's clicked on
this will be prepared so as well now
we'll be able to click on the user and
go into the particular users page to
chat with the user but we also want to
pass some data along with that so for
that we're going after override the
perform will segue function
first we'd have to call the super
prepare for segue method and just leave
that as segue and the sender is going to
be the sender that is passed along with
it that's called a navigation controller
nav view controller since we have an a
view controller the middle will have to
go via the navigation controller so once
we get set that up and let's call the
chat we can throw to the chat VC the
first controller in that and we're going
to call it chat view controller and
we're going to data that we're going to
pass is the sender's ID which is going
to be the logged-in users ID we need to
know we choose a is trying to chat with
the with a particular user and will also
pass the data off the user that we want
to chat with which is going to be chat
which will call receiver data and will
be equal to the sender what we need to
do is now since we do not already have a
chat view controller setup you have to
go and create that
let's call this chat view controller and
is going to be a subclass of the UI view
controller Winnie the main story board
select this new view controller that we
created and set its class to the chat
view controller
as of now we don't have a sender ID
variable set up in the chat view
controller and neither do we have the
receiver data so now our job is to set
these up in the chat view controller
let's go chat view controller so
basically the chat view what we're going
to do is equal to use this library
called j SQ messages view controller i
will put the link for the github
repository of the j SQ message
controller in the description basically
what this desert gives us a nice UI for
the chat application and start off as
implementing it ourselves we can just
import this and use this also to
implement this there is a very nice
tutorial by Raven Tillich for which I
will also put in the link below in the
description will tweak this to suit our
application and use it in a real-time
example so let us begin I will walk you
through how we're going to do that the
first thing we need to do is open up
item go into a project folder and open
the pod file in the pod file we're going
to have to install j SQ messages view
controller so let us do that that is all
we need to do save this exited and pod
install i am sure you're familiar with
this so now we have to do is we have to
rebuild our application in order to make
this available in the application but
before we rebuild the application let's
go to the users collection controller i
will comment out these two lines because
of this error the app will not build
come back to the chat view controller
and to build the application we just
press command B now that the build is
six year we can import the j SQ messages
view controller also going to change the
implementation of the chat view
controller to be of type j SQ messages
view controller now let us look at the
code that we need to set up
a message view controller I will start
by setting up the data source in the
delegate like you see a to display
messages you need a data source to
provide objects that conform to the j SQ
message data protocol and need to
implement a number of delegate methods
so let's start by copying this line of
code here this basically declares a
message is variable it is an array of
type j SQ message then we need to set up
a delegate message methods of third j SQ
message data protocol will put them in
here at the bottom basically the first
method returns the message and the
second method returns the number of
messages the next thing we need to do is
we need to set up the color of the
message bubble depending on what color
and outgoing message we'll show and what
color an incoming message will show so
we set up these two variables outgoing
message bubble image view and incoming
bubbled image view next we'll set up a
function called set up bubbles all this
does is basically it uses in will fact j
SQ bubbled image factory method and it
sets the color of the outgoing image and
in going incoming image as you can see
the outgoing is going to be colored blue
and incoming is going to be colored
light grey next we need to do is we need
to set up call setup bubbles in the view
did load
set up the message bubbles now we need
to check that every time that a message
is displayed we need to check if it sent
by the logged in user or it it it has
been sent by the person the user is
chatting with so let's copy this method
and paste it at the bottom the first
line gets the message the second line
checks if it is sent or it is received
and depending on that if it shows the
appropriate color of the bubble next as
well now what we'll do is we are not
setting any image for the user so we
just put this in what this does is this
will not display an image of the user in
the chat and also will remove the app
thoughts by putting this line of code in
the viewdidload you guys want images in
your chat you can change this code
accordingly
so now let's come to creating the
messages for that we can use a simple
function called add message which will
put at the bottom again let's get rid of
this code and let's put an add message
add a new message basically what this
method does is it gets the message which
basically passes the sender's ID the
display name is blank we will display
the name in the title bar of set of the
chat page and if this gets the text of
the message and then it appends it to
the messages a day just to show you how
it looks we can hardcode some messages
into the view data pure method so below
the view did load let's call the view
data pure method number for it s is out
if you remember when we click on the
user and the users collection view
controller we are passing some data
which we had commented out so let's
uncomment that also this receiver data
variable is not been set up in the chat
view controller this is not that in the
reminder look tutorial this is what
we'll be using ourselves so let's put
this up here we call it wire receiver
data is equal to any object also there's
one more thing that we need to do here
we need to send the sender's name so
let's do that so basically sender
display name is a variable that is
required by the JS message view
controller if you want we can set this
up in the chat view controller but since
we know the sender's details we can pass
it in from here only so let's do that so
we Louise sender dot object for key name
and then show that it is forced down
classes a string so now this is that
this is done we can also come back to
the chat view controller and here we can
save title equal to sender display name
so that it updates the title in the chat
page now let's try and run this now if
you go to the users page click on a user
there we see the name of the users
coming in the tidal and we have these
hard coded messages we can use a quick
fix change the color the text to make it
more visible so let's do that coming
back here that's it there's this method
which is basically the default method we
have for a collection of you sell for an
item at index path we don't have to
override any method of the j SQ messages
view controller to do this so we just
use this method will copy it and i will
walk you through it let's just pace this
in here basically what this method is
doing is it sets up the cell as a j SQ
message collection yourself gets the
message checks is the sender ID is a sin
is the logged in user and changes the
color to white if it's a mess incoming
message it changes the text color to
black now if you can clear on this and
have a look they see if the text is more
visible so as of now we can only see
hard coded messages now is the time we
actually connect to a firebase database
and actually send and receive messages
and store the conversation of firebase
database which can be accessed at any
time to start with that let's create a
reference to a firebase database for
that first let's import firebase
database into our app then let's create
a reference to our database or dirt
let's go to root ref if I our database
dot database dot reference that's right
the actual methods that we need to send
and receive messages so the method that
we need to send the message is given
here which is basically it's called did
press send button let's copy this method
so what this method method basically
does is it creates a note on our
database where the message will be
stored we're going to change this to our
custom node and then it basically the
stalls the message it stores the text of
the message and the sender ID sets it up
at the database this method here plays
the sound and this ensures that the
message sending is complete so let's
change this up let's remove this and
change this to let item ref equal to
root ref which is the reference we
created dot child and we create a node
called messages inside that under that
messages node will create another node
called which will basically be a unique
ID for the conversation so that is
called that convoy d reference to it
itself because we declared outside we
haven't declared it yet so it will give
us an error and under that let it
automatically add another ID for each
message so coming up to the top here we
need to declare a variable called convo
ID of type string and what we will set
the convoy d2 is is basically in the
viewdidload we will set it as account as
a combination of the receivers UID and
the sender's uid so that is unique to
only those two users so let's do that
let receive ID equal to
remember we had passed and receiver data
from my users collection view controller
your object for key and you ID and
string and let and because using the
whole you ID is going to make it very
long let us take the first five
characters of the UID so let us say let
us see why d 5 equal to equal to string
receive ID dot characters dot prefix
five same thing for the sender ID since
we already have the sender ID available
to us in the j SQ messages view
controller what we'll do is we'll say
let's and I d 5 equal to three sender ID
dot characters dot prefix and five now
let's combine these two so let's first
check if ifs and I d 5 is greater than c
yd five set the convoy d equal to sender
ID five plus c yd five as surf tour
convo ID equal to b c yd five plus
sender ID five this ensures that the
order of the two combining always
remains the same ok now coming here the
convoy d error has gone and now if we
send the message it should get stored
into the database that's one this we
should delete these hard coded messages
but let us ignore that for now so let us
send a message as you can see the
message got sent but there is nothing
displayed over
let's go check in a database so that you
see there is a messages tab that is come
up it is a combination of the first five
IDs of one user ID and the other user ID
under that we have an auto-generated ID
and there we have the sender's ID and
the text now we have the messages
getting stored but we need to also get
the messages real time from the database
to display them so for that we will put
in the next method which is this
function over here let's copy this come
to the bottom paste this in here so
we're going to have to change this up a
little bit basically we're going to
first have to create remove this line
and what we will have to add is this
line is basically getting the last 25
messages but it is referring to the
route which we need to change to make it
refer to our route in our database so
that is what we're going to do you call
it let message message is query equal to
root ref you want to want to go inside
the child and the message is self-taught
convoy d-force unwrap that and then
limit the query to the last 25 you can
limit it to whatever you want to not
limit it according to what you like and
we're gonna have to change this method
up as well because it requires a with
block so we're going to say messages
query dot of event type of type child
added any time a message is added you
need to update it with block and call it
snapshot in
and we're going to end this out here and
get rid of this line
what it's going to ask us to do is going
to ask us for Sun wrap these let's force
unwrap these and once we have the data
let's add it back to the ad mess using
the ad message and finish receiving
messages let's also get rid we have to
make sure that we call this method the
view did appear method let's go into the
muted appear get rid of his hard coded
messages and instead call observe
messages let's run this and see see Isis
hear the message hey that we had sent
earlier is here as well how are you and
the message is getting sent you are not
being able to gather sound of sending
the message because I made phones on but
you'll be able to hear it when you do it
similarly when the other user sends the
message back to you you will be able to
see it real time now the only thing that
is left is to show an indicator and the
user is typing ray is covered that in
this tutorial but it's only for an
anonymous chat so we're going to change
this up a little bit tweaked it to our
application start with what we need to
do is just copy this paste this here
let's change this up a little in this
too is equal to any object of your this
line of code over here is doing is
basically it firstly we creating a
reference the tracks whether the local
user is typing then we store whether the
local user is typing into a private
property which is called local type in
here and then basically we update user
is typing wrath each time we update this
property of is typing this change is a
self-taught you dress typing ref and
force unwrap this
next basically we have to add a method
let it is called observed typing let's
paste that into the bottom over here
basically this creates a reference to
the URL of typing indicator which is
where you will update the typing status
of the user and since we do not want
this to be remaining after the users
logged out we can delete it once the
users left using the on disconnect will
remove value but we're going to change
this already this is directly putting it
under typing indicator let's strain this
and put it under a particular
conversation let's change this up a
little in this 2 is equal to any object
okay or this line of code over here is
doing is basically it firstly we
creating a reference the tracks whether
the local user is typing then we store
whether the local user is typing into a
private property which is called a local
type in here and then basically we
update user is typing ref each time we
update this property of is typing so
let's change this is self-taught user is
typing ref and force unwrap this next
basically we have to add a method let's
it's called observed typing let's paste
that into the bottom over here basically
this creates a reference to the URL of
typing indicator which is where you will
update the typing status of the user and
since we don't want this to be remaining
after the users logged out we can delete
it once the user is left using the on
disconnect will remove value but we're
going to change this already this is
directly putting it under typing
indicator so let's change this to route
ref dot child messages self-taught
convoy ID under that will put it inside
typing indicator
then what we do is say let users typing
query equal to typing indicator ref dot
query ordered by value dot query equal
to value true then we basically set up
an observer for changes to value to any
value and this will give us an update
anytime anything changes so users typing
query dot observe event type dot value
with block snapshot fi our data snapshot
in if snapshot dot children count is
equal to equal to one and self dot is
typing and don't do anything basically
you will check that if the number of
people typing in the conversation is
equal to one and that person typing is
you then do not show any indicator else
check if the other user is typing so
we'll do that by doing self-taught slow
typing indicator equal to snapshot dot
children count greater than zero and
sell top scroll to bottom animated equal
to true so basically if there are more
than 0 users and the local user isn't
typing it's safe for us to say that the
other user is typing and we should show
the indicator now let's try and run this
out and we should see the indicator
updating type hey
as you see we got an arrow over here
because observing the typing is also
observing messages because we said any
changes to the typing any value added
under messages will give us an error so
we need to make sure over here let me
clarify that you since the type in unity
kata is getting added on the messages
this observer will also run so we need
to make sure that we check for the value
of snapshots so if snapshot dot value
sender ID is not equal equal to nail
only then run this line of code that
means only it will only run if a message
is actually added and not when a user is
typing let's clear this up and let's run
this again off you type over here so
those we type here okay so we're not
getting an error but if we go here and
see this is got updated to typing
indicators getting updated to true so
let's just copy this and add it inside
typing indicator and set its value to
true there you see the indicators come
up if you set its value to false it
should go away and we set back to true
it comes again and when we type it gets
updated over here but nothing happens
over here and even when we move it goes
so suppose we send a message here saying
test it moves up the message gets added
and the type indicator still showing
true because the other user still typing
so let's just remove this false again
and that works again so what we've been
able to do in this tutorial is we've
been able to create a system by which we
can see whether the user is online or
offline we can also chat with that
particular user in a private chat at the
same time we can also see when the user
is typing it's taken a long while put
all of this too
other but I think the outcome has been
pretty good the only thing that's left
now is to show when the user was last
online I think this is a challenge for
you guys try and figure it out as you
guys all to remember that when the user
logs in we've already passed a timestamp
along with the connection stem and you
can see the last online tab of the user
inside the connections all you need to
do is bring this time stand back and
convert it into a date the last thing I
just want to show you before we go is
how this actually works between a real
phone and a simulator so I would like to
use in onto my phone and I'm going to
send a message from there so you should
see the message coming up now there you
have it I just sent a message from there
now I'll start typing and you can see
that the typing indicator showing up and
they are deleted in the typing indicator
disappears so I hope you guys enjoyed
this and we will dig into something new
in the next video and thanks for
watching</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>