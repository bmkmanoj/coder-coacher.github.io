<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Services Assemble! by Mark Heckler | Coder Coacher - Coaching Coders</title><meta content="Services Assemble! by Mark Heckler - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Services Assemble! by Mark Heckler</b></h2><h5 class="post__date">2017-05-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/XB8Jf2Xruu8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Birgit you play kids do it thanks s
welcome to this afternoon session I like
to call it services and simple you'll
see soon why or more in depth applying
Minimum Viable Product principles to
create cutting-edge micro services
without chaos hopefully using spring
cloud and Netflix OSS I'm Marc heckler
I'm a principal technologist and
developer advocate with pivotal soccer
Inc pivotal are the makers of good stuff
like Spring Framework spring boot rabbit
and Q red a screen plum cloud foundry
huge contributor to Apache Tomcat and a
handful of other things we like to say
we're a tiny little star startup in
Silicon Valley not so tiny but pretty
nimble still i blog semi-regularly at
the hecklers org and I tweet very
regularly a 10k heck is anyone here on
Twitter okay couple people that's not
bad
highly recommend Twitter it's got a high
signal-to-noise ratio it's not like
there isn't a lot of noise but you can
filter it out pretty well much better
than those other social networks so I'm
kind of fond of it and I live on Twitter
from kind of sunup to sundown and a lot
of time in between even sometimes lying
in bed and tweeting so for what it's
worth I have no life you'll see that
soon but for those of you who are not on
Twitter I'm also a member of the
slightly older and more established
social network called email is you know
anyone on email okay a couple more you
know I like everybody else have a half a
dozen email addresses so I always just
point to my personal unmarked at the
hecklers dot org so you used to remember
so if you have questions comments
feedback whatever I welcome those if
they don't fit into 140 characters or if
you just hate Twitter for whatever
reason feel free to email me I don't
check it as often as Twitter but I do
check it periodically so so Who am I
well I'm the author of several blogs and
blog posts I've co-authored one book I
have another one in the planning stages
as well as a couple other neat projects
hopefully I'll be able to bring to
fruition by the end of the year I'm a
frequent speaker kind of around the
world thanks for inviting me here thanks
for inviting me back I mean I can't
believe it I got to come back that's
great DevOps UK is a really great
conference
as as you all know is any first-timers
okay
let's cool comeback because it just
seems to get better and better and as
you're seeing it's a very well run event
so I am a developer obviously and as you
can probably tell from the next bullet
point what most of my expertise is in
Java I was recognized last year as a
Java champion for contributions to the
greater Java community so if you had
anything to do with that thank you very
much I really appreciate it for the vote
of confidence and as I like to say I'm a
survivor of many monoliths I was a
reluctant convert to micro services I
when you are familiar with something you
know all of its good and bad you know
the works you know where the bodies are
buried
you become pretty comfortable with it
and I'm a human being and all human
beings typically resist change to some
degree so I Samara reluctant convert but
I am a convert and I think there's very
very good reasons to be excited about
micro services as as well as a seeker
who better way which that kinda ties in
with the previous point so so this is
what we're going to be talking about
today right I think this is a great
example of micro services because you
you have very distinct capabilities very
distinct units that all come together
and you know the vote you've probably
heard the expression the the whole is
greater than the sum of the parts when
you you try to if you were to try to
create one giant superhero is anybody
here a comics nerd please anybody oh wow
okay I was hoping for a better response
than that this is just that it's going
to go downhill from here folks but if
you were to design one massive superhero
who did everything we'll call it
monolith man or monolith woman if you if
you choose it becomes pretty difficult
to kind of fall it all into one and it
probably is not going to do all things
equally well right when you bring unique
strengths to the fight it actually helps
to accomplish far more than you would
expect and that's my shameless high end
to the Avengers love The Avengers as
well as a few other players here so so
anyway who here is a Java developer
wow that's great that's so awesome
anyone you spring yeah
also good spring beat JavaScript oh come
on come on and you fell for it turn
yourself in just leave now I'm just
kidding
if anyone here familiar those twelve
factor apps the twelve factor manifesto
and what have you okay
concept of cloud native okay I just kind
of like to gauge kind of where
everyone's coming from let me provide a
little bit of context with a monolith
I'll shamelessly steal one of Adriane
coke Roth statements I've said it many
times but he's far more important than I
am so sounds better to actually
attribute it to him which is true he
said monoliths only appear simpler from
the outside because if you have a
problem with a large monolithic system
you know where the problem is it's with
the monolith when you have a problem
with a distributed system you don't
always know where the problem is it's
not only easy to find where the problem
is so it adds a great deal of complexity
at least from the outside looking in
from the inside looking out it actually
simplifies things greatly as hopefully
we'll see as we go through today I work
for pivotal pivotal contributes greatly
and and stewards spring to spring cloud
a lot of other things as I mentioned the
Spring Framework came into being because
Enterprise Java was very difficult
difficult and cumbersome to use in the
old days if anybody's a survivor that I
won't ask you to incriminate yourself
but you're probably silently nodding
yourself and weeping as I say this
spring framework came into being to
address some of those issues but over
time of course the Spring Framework grew
and expanded to take on a lot of
capabilities and over time of course it
kind of gathered the reputation as well
as being rather large and cumbersome
maybe unfairly but but it is what it is
in 2013 I guess it was a spring boot
general availability spring boot if
sometimes referred to as a micro
framework I really hate that term but I
can't think of a better one so we'll go
with that but in essence it allows you
to take all the capabilities of the
spring framework and more and put it in
and bundle it in a very easily
consumable package for developers so it
gives you things like Auto configuration
makes rational judgments based on things
in your class path and your code and
your annotations in your code to to kind
of determine what you might need in
terms of supporting beams to provide the
capabilities you want to provide for you
you can override anything but of course
it gives an opinion it says hey if you
have this in your class path and you
have this in your code we kind of figure
you're going to want that so it
dramatically speeds things along it also
gives you the ability to clean up your
dependencies you know much more rigorous
dependency management version
synchronization things like that so it
really does allow you to go from here to
app in under five minutes it also brings
everything together neatly into a fat
jar so you can have nested jars not
shaded which brings its own set of
problems as well but allows you to
deploy your application is one unit
anywhere there's a JVM so it simplifies
that a lot as well spring cloud as it
says design for fragile infrastructure
and partnership with Netflix now Netflix
sometimes will produce something right
out of the gate and open source it but
Netflix deploys specifically at least to
date on Amazon Web Services so many
times our engineers will work after the
fact with something they produced or
work with and from from the initial
stages to produce something that has
broader applicability and release it
under this spring cloud name as well so
we love Netflix they have great stuff it
has a lot of applicability hopefully
we've expanded that as well I'm not
going to go too much more deeply into
that because time is short and I'd like
to get into actually showing you some of
these concepts because I think they make
a lot more sense when you see them in
code I will say that I will I've got a
lot of material I would love to cover so
thanks for for signing up for the three
hour session I really do appreciate that
I'm kidding it's only 50 minutes two
points 50 minutes is a very short time
so I'll be covering a lot of things as
many as I feel like a reasonably can
cover pretty quickly but our time
afterwards that's the bad news the good
news is there time after word is nearly
infinite so if you have any questions
comments feedback maybe I covered some
too quickly for your taste that's great
maybe I didn't like how quickly I
covered it either please just let me
know
ping me happy to discuss this at length
afterwards
tomorrow any time in the future that's
perfectly fine I will warn you right now
my wife tells me that I am
unintentionally funny
meaning I'm the only funny when I'm not
trying to be and I do have a few I think
humorous remarks learned in here so I'm
warning you now you'll probably groan
but if if you go and I take that as a
positive feedback - so that's fine and
if you do throw out a pity laugh I take
that as well so so some of the
components that you typically need I
mentioned in a blurs when you deal with
a microservices architecture I feel like
there are two kinds of enablers that you
really need to get your hands around it
one kind of enabler is the enabler the
enabling component that allows your
microservices to interact with each
other and the other side of that is an
enabler that helps you to reason about
and manage and monitor your
microservices so you know what's going
on in your system you'll actually find
some components do both and I'll point
those out as we go as well but you
definitely need both because otherwise
you have this dysfunctional system that
doesn't talk to itself when you look at
it in the macro level so we start with a
centralized configuration now we don't
want to insert a new bottleneck we don't
want to distribute a monolith right so
we need some mechanism that helps us to
manage our configuration without
inserting a new bottleneck into the
entire system if you have one massive
monolith you may have configuration
strings set up within your code that's
not great but it's a monolith so there
in one place you may have externalize
them into your environment that's better
but when you have multiple micro
services with multiple instances of each
that gets to be really cumbersome to try
to manage yourself so a centralized
configuration resource gains you a lot
of manageability as a human being we
typically point to spring cloud config
spring cloud config will read in
properties usually key value pairs or
gamma whatever whatever format you
prefer and use that to supply
configuration settings to any of your
micro service
that contact the config server for that
kind of configuration spring cloud
config obviously is dealing with text
you know key value pairs basically so
how do you version control that how do
you audit that we do that all the time
with our code right it's just text so
why not a DVCS spring cloud config and
can rest on top of a git repository SVN
console doesn't matter it's just there
to supply those configuration settings
to your micro services I'll show you
that as we go to that's one of the
twelve factors right externalizing your
config service registry and discovery is
typically provided by Netflix Eureka
there are other options again console as
you keeper what have you but you need
some the key point is that you need some
mechanism for your micro services to see
and be seen by other micro services in
the old days of is anybody remember the
old days of phonebooks what five six
years ago now wow that's old with a
phonebook you when you went to a new
city and you knew a friend there you'd
look up their name in the phonebook find
their number and then you pick up this
old fashioned device and tap in some
numbers and you call them the phonebook
didn't provide the conduit for
communication it just provided the
lookup and that's what a service
registry does it's not an ESB it just
provides a running track like as allows
you to keep a running track of where
your micro services are running at any
point in time if you have ten instances
of a particular micro service running
and one fails your platform will
probably hopefully spin up another
instance to replace it it may not put
that in the same place and you need some
mechanism for your other services to be
able to discover where those locations
are and to access them that's your
service registry you also have things in
a distributed system that you will need
for full robustness for resiliency
things like a circuit breaker and just
like your house if you have a wiring
issue in your master bedroom
hopefully you'll just lose power to your
master bedroom
maybe you'll lose power to your house
but hopefully you don't lose your house
right so it allows your capabilities to
gracefully degrade and that's what a
circuit breaker does Netflix have
histories and I will show you that as
well here shortly
but it allows you to
you set multiple levels of degradation
so you can continue to keep the lights
on and running even as parts of your
system may be failing and then coming
back online ribbon provides Netflix
ribbon provides a load balancer a
client-side micro service load balancer
that's important so we don't insert a
new bottleneck once again not that
server-side load balancers aren't
important but this is what we're going
to be focusing on today and then of
course your intelligent routing which
allows you to externalize your routing
so you're not embedding locations of
backing services within your consuming
micro-services code because if that
happens and something fails you have to
do a rebuild retest redeployed just to
rehome to a different data store for
instance also things like asynchronous
messaging provided by spring cloud
stream distributed tracing very
important again because if something
fails you need to know where it is or if
it's just slow you need to know where
the slowdown is and of course security
with spring cloud security providing
capabilities authentication and
authorization and much much more now
again our time is very limited so I'm
not going to be covering all of those
even-even personally I just wanted to
kind of point out some of the minimum
things you need to consider when you're
talking about a micro services
architecture in order to get even to get
started so let's smash this right okay
so let's let's do some coding I'm going
to switch over to mirror my screen
hopefully if all goes right down BAM oh
that's better
okay so we'll leave that like that let's
see let's enter that and actually let's
blow that up a little bit let's just
maximize it them okay and I don't
maximize that and that is just not
readable so let's whoops there we go
let's in begin this all right so that's
default is bigger enough you have to let
me know in the back can you see that
come on there we go beautiful not
probably not okay let's let's take this
level up to 11 make this in big inist
better okay so what will work that
alright okay so the first thing I want
to do I guess let me let me kind of go
back to here and we'll start with this
blow this up door it's a my readable
okay if you're if you're creating
microservices using spring boots this is
kind of your starting place on the web
right sometimes referred to as start
spring Bioforce web location you can use
the spring command line interface to
access this you can use curl I like to
go to the web page because it's a pretty
and it makes me happy okay it's not very
pretty but it does make me happy because
it's really well designed spring is
sometimes referred to as an opinionated
platformer right and I always kind of
wondered what opinionated means well
opinionate it just means that if your
use case falls within that eighty to
ninety percent use case we try to make
it just dead simple for you to get
something done quick if it falls in that
either ten to twenty percent use case we
still want to allow you to do it we want
to get out of your way and help you get
it done quickly it's just not quite as
easy as that eighty to ninety percent
use case kind of the battle days of
frameworks there was one way to do stuff
and you either did it the framework
where you didn't do it that's not what
this does as you'll soon see the
initializer gives you the chance to get
up and running quickly but if you really
want to switch to the full version and
choose a lot of it for different options
you can for instance you don't have to
bundle it as a fat jar you can package
it as a war so if you're still stuck
with an application server you can't
ditch the you're still able to use that
that's perfectly fine we do always
recommend the jar file because again
that twelve factor manifesto write a
couple of factors in that I always kind
of point to three of them as being the
first among among equals one is your
externalize config one is your
dependencies where you bundle your
dependencies and one is pork binding so
you expose the port's you need the
functionality you need from within your
application that allows you to use your
application your
backing micro service as well and not
had external dependencies that can break
out from under you very nice so we'll
assume we're going to go at the jar you
can choose your version of Java support
it anywhere from Java six to Java 8 you
don't even have to use Java you can use
groovy or colander two and one ease Java
right hey okay no play along anyway so
has anybody ever played dependency
whack-a-mole where you have a problem
and you can't figure out what's going on
maybe you don't get a good stack raise
maybe you don't get any kind of
exceptions or errors at all and you're
just lost so you do what you're supposed
to do right you hit Google is that
overflow
you're not seeing anything and finally
you start kind of experimenting in
troubleshooting and you figure out due
to some trial and error and several days
of swept that version three of library a
doesn't work with version 7 of library
be all right nobody's lived that dream
you will if you haven't you will that's
really frustrating and and when you roll
back library B to version 5 everything
works it's it's it's wonderful but you
realize that you it's now Thursday and
you start on this problem on Monday and
that's that's incredibly frustrating
with the spring initializer anything you
see here or let's say version 1.5.2 a
and spring boot has been battle tested
with that version so if you choose to
bring in WebSocket WebSocket dependency
or Jersey or what have you you know that
that has been battle tested with spring
boot 153 it takes that out of your hands
you can override it should you want to
but you don't have to which is really
nice
streamlining typically I don't go
through the eye chart because it is
quite a bit of stuff to try to go
through and by the way you can bring
your own library specify your own
version doesn't matter but again don't
have to but I typically just go with the
simplified version and get up and
running quickly so we'll go back to the
simple version I do want to before I
start creating the stuff that we're
going to see I want to fire up a couple
of other things and I do want to ask you
to if if you would because in trying to
repackage this and just still the
absolute essence I skipped a couple of
parts that I usually like to live code
but I think it's important to try to
focus on the media
our topics so if you feel like maybe if
you can give me some feedback if you
felt like I should have coded the first
couple of things that's great
happy to hear it and happy to adjust so
I'm going to go ahead and start the
config service which again this is
spring cloud config and while it's
starting up I'll give you a little bit
of an explanation see spring cloud
config again rests and rides upon
typically a git repository again console
SVN notwithstanding so you can create
different key value pair files or yamo
files which will list your various
different configuration properties that
you want your config server to serve up
to the various micro services of contact
and request such so if you see here you
have an application demo file and that's
for properties that apply to all micro
services you can also specify by profile
so application - cloud in this case so
when you specify the profile in your
micro services that is running in a
cloud environment you will get these in
lieu of the generic application
properties if you provide a name with
your micro service to the config service
from your requesting properties you'll
also get properties that are specific to
that micro service so things like edge
service you'll get the edge service
properties as well as the properties
that apply to all micro services so let
me show you kind of what that looks like
if we go to here and blow this up now
doesn't matter there so we'll go to
localhost 8080 88 where I'm running this
and these are just a hint of the
properties that you would get for all
micro services any micro service the
context the config service gets these if
you were to contact the config service
and say that you are for instance an
edge service you would get a different
set well an additional set which are
property specific to edge services as
well as the properties for all micro
services so again not not very sexy but
it's certainly very useful for your
micro services as well as you because it
gives you a central way to manage all of
those very easily so the next thing up
would be
a service registry I'll go I can kick
that off and again this is a place for
your services to register and to locate
other micro services so it started up on
port 87-61 it's getting its config from
the config service as well so then if we
go to local host a 761 this is the
Eureka dashboard and that's a little too
much eureka itself provides capability
to enable your micro services but the
eureka dashboard is for us the meet
where we like to see what's going on we
need to understand what's going on and
there's a lot of good information here
but the two key bits are where all
locations that Eureka is running in this
case we're running it exactly in one
location so no redundancy at all bad bad
bad but for demo it's fine
as well as here and this is where your
various instances of micro services show
up right now we have none so that's kind
of where we begin our journey right so
back to the spring initializer this
gives you different options it doesn't
generate code per se it generates your
project so it will create a shell
project for you based on what you
specify and it does create your main
application class and main method but
but basically it gives you that jump on
developing the code the way you want to
and takes a lot of the crust out of the
way to begin with so if you're a maven
developer it'll generate a maven project
if you're a hipster it'll generate a
Gradle project right wow this is a tough
room they're not going to get I tell you
what my jokes are not going to get any
better there they're only downhill so
you know yeah save yourself leave now so
with the initializer typically you have
the current version of spring boots as
well as as a snapshot on either side of
it as well as a couple previous versions
now here you see boot 2.0 snapshot which
is the way that you can play with some
of the reactive capabilities that my
colleague Josh long talked about this
morning so that gives you some neat toys
to play with as well when you're
entering the reactive space but we're
going to stick with the production
version right now and I'm going to
create
a quote service does anybody here like
movie quotes or 50 coats of any kind
really no one okay what you're my new
best friend so what's your name Oh Josh
excellent well that worked out really
well I won't have to trade out all my
t-shirts that I have that I love Josh on
them okay good I know I believe lead a
pretty lame life you don't have to rub
it in but I like quotes I like movie
quotes you know really cool stuff and
seriously you guys don't so I'm really
feeling bad about myself now so Toph
you're going to see quotes self-created
quote service which will give me a
random quote right so every time I hit
this I want to pull back a random quote
of some kind to inspire myself or to
make myself smile because not every day
can be all sunshine and daisies right so
I'm going to provide a list of
dependencies that I want to bring in to
my project so the first thing I'm going
to do is bring in the config client
dependency so I can access my config
service to load my properties and then I
want to add the service discovery client
so I can access you know talk to Eureka
register by services what-have-you and
then I'm going to bring in Lombok
because I'm a lazy developer and that's
good right you don't want to waste a lot
of time doing stuff that others have
done for you so you on here like Lombok
you okay I have a love-hate relationship
I loved it
then I hated it now I'm back loving it
so you're going to see Lombok today but
it allows you again to cut down on some
of the boilerplate because who likes
boilerplate right and then because a
quote repository a quote service isn't
very good if it doesn't allow you to
store and retrieve quotes so I'm going
to use JPA for that not because it's the
best option but because as another Josh
likes to tell me sometimes I make poor
life choices so I'm going to use J APA
and I'm going to use h2 as an embedded
in memory database that again anything
JPA is fine my sequel Microsoft Oracle
what-have-you or not even a sequel
database because we support out of the
box Mongo Couchbase neo4j
and you can bring your own doesn't
matter but I'm going to choose h2
because it's easy right and then I'm
going to include a dependency for rest
repositories
because I'm going to be leveraging
spring data to act as my proxy for my
data store and rest repositories allows
you to explore it it actually handles
this for you exposing those domain
entities as rest endpoints very nice and
then let's see what else do I want to
bring in because I'm a crazy optimist
I'm going to bring in stream rabbit and
probably zipping client because that
should give us the ability to do some
tracing should we have time probably not
but again I'm an optimist so so I'll
generate the project and I save it down
and then let's see we'll navigate to
there and I'll open this and open in my
favorite IDE don't even want to go to
find out whose IDE is what everyone's
favorite IDE is I doesn't matter I mean
you can use spring with any of them
NetBeans eclipse we even head of a
special build of Eclipse called spring
tool suite which is really awesome and
has some really neat cloud deployment
capabilities but I love IntelliJ so is
what it is so the first thing we're
going to do is go to our application dot
properties file this is the profile that
spring food applications will look for
upon initialization when they're
creating the application context they
look for this file to see if you have
any sensible default properties defined
in there we actually kind of want to get
out ahead of that cycle we want to
before the application context is
initialized we want to find a way to
link to our config service and use it to
bring in our initialization properties
right so the easiest way to do that is
to take the application up properties
file and rename it to bootstrap not
properties because we want to do this
during bootstrap so I'm just going to
add a couple of things here like the IOC
spring application name and we call this
cleverly enough quote service and then I
want to point to our spring cloud
configure II where our config server is
running and I'm running that locally
because I learned a long time ago never
to trust conference Wi-Fi even though
it's been awesome right but you know
it's it's really a drag when you can't
get out and you're you know running
everything in the cloud remotely so
anyway so I'm going to go to the main
application class
and I'm going to enable discovery client
and this is an app this is a fully
functional micro service that we can run
now it just doesn't do anything so we
need to have it do something and is a
quote service we probably figure it as
something to do with quotes right so I'm
going to create an entity and this is a
JPA annotation because again we're using
JPA and i'm going to define it using
Lombok because i'm a lazy developer and
instruct Lombok to give me a no artist
constructor and an all ours constructor
and maybe even a two string method and
we'll call this class quote didn't see
that coming right since this is a JPA
it's the I'm going to assign or annotate
my ID field and give it a little nudge
with generative values so we can define
our long ID and then I'm also going to
create other number variables for my
quotes things like a quote text lips can
myself quote text and a quote source and
since I'm just crazy about constructors
I'm going to add an a to our constructor
for text and source so that gets us our
domain entity pretty easy right very
little code and next I'm going to define
an interface called quote repository
repository I should have warned you
those of you in the front row
occasionally I will insert typos just to
see if you're awake okay it's completely
intentional but if you spot a typo let
me know and if you don't spot a title
it's on you okay so no pressure right so
I'm going to extend the credit curd now
it's a different repository the crud
repository interface in spring data and
define this for object of type quote IDs
of type long and that gets it started
but I'm also going to annotate this as a
repository rest resource so what we had
here is that by over or right extending
it should say this interface defined in
spring data again spring boot is auto
configuring right it sees that you have
JP and h2 in your class map it sees that
you're extending an interface as defined
in spring data so it makes the crazy
leap that you're going to want to have
data access so it provides a proxy beam
here we're going to then turn tell it to
go ahead
suppose that our collection of objects
our collection of quotes as we quotes in
point so very nice very neat and that's
really cool without a whole lot of
effort on our part again but we don't
have any way to verify what's going on
all right we have no visibility which is
always kind of sad so I'm going to
create a meme using command line
interface in spring boots is anybody
familiar here with with functional
interfaces single abstract methods okay
good
command line Runner is a functional
interface I in spring boot and I'm going
to inject quote repository and what I'm
going to do with this is define return
the lambda which implements the single
abstract method right the run method in
this case and since I can't spend the
next 19 minutes
typing picky quotes because then we
wouldn't have any time to do any fun
coding I'm going to copy paste these and
cheat a little and also because I like
to see what's going on I'm going to take
the repository do I find all do a 4-h
and we'll take that to system and that
line there we go okay so let's fire this
up and see what we have what we should
have is a lot of capability for very
little code as you have seen so this
starts up and while this is starting out
I'm going to go ahead and assume this
works not always to say think do oh well
it's done anyway okay so as we see here
we have some quotes in our quote
repository so really really good movie
quotes okay makes you want to go home
watch movies tonight okay so it looks
like it's working so let's go out and
see if it really is because proofs in
the pudding so we're going to go to
localhost 8080 eight quotes and we're
going to blow that up so it is actually
blowing up pretty well so you can see it
so we see some really good movie quotes
here and that's good because it gets you
the whole collection of quotes and you
can even drill in and look at an
individual quote and that's good too but
it's not random right I mean it's not a
very good quote service because you see
the same quote every day or receive
the whole bundle of coats every day is
not very gratifying so what I'm going to
do is add that capability for some
randomness I'm going to create a rest
controller and we'll call this cleverly
enough again quote controller oops
typos I just saved the front row turn it
ok I'm going to let's see inject a quote
repository using constructor injection
is again that's better for testability
right and then I'm going to create a get
mapping for I random endpoint random
okay and we'll make this public return
quote get random quote and we'll do a
return this oops
this quote repository dot and this is
where we we kind of hit the wall right
look at spring data gives us a lot of
capabilities but it can't read our minds
we have to provide some kind of hint in
terms of an implementation we'd like
when we're in that ten to twenty percent
use case so what we're going to do is
extend our interface a bit and we're
going to give it a hint something on
lines of select cue from quote from from
quote cue order by Rand which should
return us a random order list right of
type quote and and we'll call this
method get quotes random order and then
that's enough for spring data to grok
our intent to use the the J pql query to
flesh out our method for us so then we
can do a get quotes random order get the
first one and return it so if all goes
right and no typos for our oh we should
be up on adding with our randomness and
we're doing okay on time which is good
because again I have a lot of stuff I
want to show you please take questions
to the end or afterward or anytime there
after that because I'm really hoping to
get through some some kind of cool stuff
here so let's let's go back up here and
we'll go to our quotes
of course we still have same
functionality always good to check that
you haven't progressed right so let's
hit our random end point and it's
working hello my name is inigo montoya
okay is anyone recognize this if not
here's your assignment go home this
weekend and watch The Princess Bride it
is a classic okay so you're welcome I'm
going to refresh Cool Hand Luke
another classic Back to the Future
anyone really Toy Story wow I thought I
needed to get out more okay the dude
abides anyone haha okay Wow again it
doesn't get better okay so we're going
to now take our backing service are
quote service I should say and make it a
backing service we're going to consume
what it produces so we're going to
create an edge service that allows us to
show some of our other features our
circuit breaker our load balancer or
what have you
typically with an edge service what you
do is you gather inputs or you marshal
inputs and unmarshal
going the other way when you're you're
trying to streamline a connection
streamline a capability that you're
providing a subset of data and
capabilities you're providing to maybe a
mobile client for instance but I'm
actually staying pretty close to a
one-for-one just for the demo so you'll
see a lot more of the pasture and it
gives me an excuse to show you some of
the visual stuff as well so I'm going to
change this from quote service to edge
service again namings hard and I'm going
to remove JP a h2 and rest your posit or
ease because we need those for our
backing services but we don't need them
for our edge service but I am going to
add in dependencies for hystrix because
again we want to do some circuit
breaking here and I'm going to bring in
ribbon for client side load balancing
and Netflix dual for intelligent and
programmable externalize routing so
you're not embedding that in your in
your application code and then I'm also
going to bring in web dependency so we
can define a web api we had that
actually as a sub dependency nested
dependency and our rest repositories
before and I'm going to bring an
actuator not that I am sure I'll have
time to do this because again I'm an
eternal optimist so and let's generate
the project we'll save it
and we'll go pull it up and open it
there it is
and we'll open that in our favorite IDE
he was supposed to come in and spell me
at this point and take over good help
so hard to find alright so the first
thing again we're going to do is go to
our application properties file we're
going to rename it to boot strap up
strap strap about properties did I get
there right how good it is right okay
and then I'm going to give it
well first I'll point it to the spring
cloud configure II which again is HTTP
colon slash slash localhost 80 and 80 8
and then I'm going to give it the name
of again cleverly enough edge service
and then we'll go to our main
application class and I'm going to
annotate this as a Zul proxy
you're probably wondering at this point
why I didn't annotate this as a
discovery client like I did the other
service that's because the Zul proxy
annotation is actually what's a meta
annotation because zoo is Yuriko we're
right so it kind of assumes you're going
to want to use the Eureka service or any
kind of discovery back-end if you will
so it enables the discovery client
annotation in with it as well as circuit
breaker so you get kind of three for the
price of one with that which keeps your
code nice and neat now as it is I can
run this and this will register with
Eureka and this allows me to show you a
little bit of a hint of the power of Zul
keep you familiar with Zul Hittite
mythology no ghostbusters ghostbusters
ok yeah big nods yep
ok well it's like cool or when you read
it but you're see it and go special
something read about it anyway so so we
see that we're started up on port 8080 6
so we know that we have a successfully
contacted our config server and got met
information from it so now if we pull up
another browser tab because you know you
can never have too many browser tabs
right and we go to QF quotes this looks
awfully familiar right in fact it looks
a lot like
that well except I again typos computers
are so literal okay so if you look at
these two you can see that there's some
URI translation going on and that's
pretty cool because all we did if we go
out here and take a look at our edge
service properties we can see that we've
defined some Zul routes so the first
store in particular is important we have
anything when we're hitting our edge
service in referencing a path with qsr
in it dual will our sole proxy will will
in turn route those requests to our
backing service by the name of quote
service one of our instances of quote
service in this case we're only running
one so that simplifies things a bit but
again it's it's eureka aware so it will
find that in that in that manner whoops
let's see let's zoom back out we'll go
back oh I thought I thought we little
bulb or something there
and you see that it actually works
equally well for anything you can
address from our backing service so we
can even get directly to our random
quote in point now that's what's called
a micro proxy so if that answers your
use case you're done you have really
little to do in terms of edge service
and how to deal with it
but in most cases it doesn't because
again you're going to be gathering data
from multiple backing services and
munging them and manipulating them and
consolidate him in a way that's very
tight and compact as an edge service so
we'll assume you want to do that because
that makes it a lot more fun anyway I'm
going to go ahead and again define my
quote entity here so let's see data will
do a new artist constructor all are just
constructor to string and we'll call us
again cleverly enough class quote
private long id private string text and
source and just to be safe we'll go
ahead and create our to our constructor
and now in order to access this I'm
going to do something that isn't
typically what I do is try to stay close
to best practices but sometimes I veer
from that just to make it a little more
apparent what's going on behind the
scenes this is one of those cases so
what I'm going to show you is a little
bit of the long way around the barn so
to speak so please don't say that I said
this is the best practice and implement
but it is kind of instructive I think so
I'm going to again well I'm actually
going to create a load balance beam
and this is using ribbon for our client
side load balancing and we'll create a
rest operations
Beansie rest operations return a new
template and you write to the interface
right so that gets us our rest input
that then we can use here I'm going to
create a class called quotes controller
and private secret rest see past
template actually you know what past
operations test operations and
constructor and then we'll do a sea rest
controller trying to go so fast because
I want to make sure that we cover up to
a certain point and I'm racing the clock
here so we'll do a get mapping and we'll
call this endpoint quota Rama because
I'm really bad at naming things so and
we're going to make this a public method
returning quote get random quote and now
we will do a return this rest stop up
rest operations dot get for object HTTP
colon slash slash quote service slash
random and you're probably noticing at
this point that doesn't seem like it
would be a valid URI right but remember
this is a rest template that is Eureka
where so we have a Eureka lookup
built-in so since we've registered our
quote service a microservice by the name
of quote service and instance of it
anyway
with eureka we can locate that via our
intelligent intelligent routing we our
client site load balancing and what
should happen at this point is that if i
restart this we should be in business
and i'm going to go ahead and add
a couple things here while that's
rebooting restarting excuse me okay now
while that's coming up I do want to
point out one other thing I've defined
another Zul route I call it demo but it
doesn't really matter what you call it
the important thing is that I'm
specifying a path for my edge service so
if you have slash quote in your URI in
your edge service it should forward to
in this case a local endpoint called
glaucoma you can also as you see down
here point to any public API it doesn't
really matters it was smart enough to
handle that so now that we restarted yeh
successfully let me go back to here and
we will now go to quote Oh Rama
quote Oh Rama and we see that our local
endpoint is working always good to
verify right and we'll hit our quote
endpoint so now we see that everything
is routing properly I probably will not
have time to get into showing you some
of the routing via Zipkin views spring
cloud sleuth but what I really want to
do is show you that circuit breaker
because I think it's a really nice
wrap-up as kind of the key bits that you
really need again for that Minimum
Viable Product so let's go back to our
code and let's see here we have our
method for retrieving a random quote
from our edge service what happens if
that backing service goes offline what
happens if all instances of that backing
service go offline you'll get something
that really looks ugly right you don't
want to pass on errors directly to your
end users or end-user applications so
what we're going to do is leverage
history and we're going to designate
this a history command with a fallback
method now in order to designate a
fallback method obviously we need a
fallback method so that's our next stop
get default quote we'll return new quote
and we need a new quote right as luck
would have it I've defined a default
quote in my properties that the config
server is providing to our edge service
so I'm going to access that value using
the app value annotation in spring and
we're going to point that to our
quote property and assign that to
default quote and then we can create a
new quote using our default quote and
let's say you me and everyone this is a
good quote right everyone will want this
quote so now the only thing we have left
to do is take our method name and assign
that as our fallback method for history
right so ah let's see three minutes we
have time I'm going to just put that now
oh gosh yeah oh no wait who said that
you're not even in the front row you
that's amazing
if I had a t-shirt to give you I'd give
you one right now so okay I see I get
excited and I just skip over stuff
wholesale so so this should work I'm
going to go ahead and start this and
then I'm also going to find my history
stash board so I can show you something
kind of cool with that so I kick this
off at the same time what could go wrong
right live demos everything always works
perfectly so once this comes back to
okay that started so now if we go to
here and we will refresh so we have a
quote we're getting our quotes just fine
everything's great I'm going to
localhost a t10 history and that's
gorgeous
all right really sad that again not
designers he made this localhost:8080 6
/ quote all right edge service and we'll
monitor the string Oh silly me I
actually need to do History X stream
that works a little better when you tell
it we're to monitor right okay so now
I'm going to peel this off and jam this
against this side and peel this off
and jam this against that side so so now
we can take a look at these so what
happens when everything is working right
right so I'll do a refresh and you'll
see the green ball grow and you'll see
the number of requests servicing grow so
everything is working fine your
distributed system is great but what
happens when you kill that backing
service because he likes that backing
service anyway right so I'm going to
kill that it is well and truly dead so
now what happens so when i refresh this
we get our default quote which as you
might have wondered what that was
whatever the question coffee and
chocolate are always the answer I
personally can just go with coffee but
that's why chocolate works for people so
we'll refresh as you can see we get a
lot of read requests right once you gets
past a point of so many failures and so
long a time which right now it's set for
the default value I think 20 failures
and 5 seconds it will open that circuit
now what happens when a monolith fails
all of that demand backs up right and
then when the monolith is brought back
online what happens to the demand it
just hammers the mana lamp so you get
into this weird cycle of the monoliths
up come on let's down come on what's up
the monoliths down and a good circuit
breaker will take care of that for you
by slowly restoring the capabilities so
what happens with history is once every
so many requests again configurable
it'll go out and try to send a request
to the failed backing service when that
circuit is open it goes and tries to
reestablish it and once it does
reestablish it doesn't just shove all of
the traffic to it it gradually restores
that traffic so as you can see here
you'll start to get a few requests
coming in and by the way the default
timeouts as far as notifications go is
on a 30-second notification so it may
take up to 30 seconds for your banking
service to notify your Eureka it's back
online and up to 30 seconds for the edge
service to pull it again that's the
default you can change it however it
suits you I just left it as the default
so again it takes a little while to come
back up and of course it's not going to
come back up in time for me to to do
this before I cut back to the slides but
we'll go back to the slides here
then let me switch back because I'm out
of time sadly and we want to wrap it up
I always all right sometimes forget to
do this so I want to make sure you get
these
so some helpful links I always start
with the spring i/o guides because the
guides are sometimes very long and
in-depth and give you a lot of good
information but sometimes you just need
to go and get a bite-sized chunk how do
I use Redis the spring boot how do i
leverage histories and they'll have 10
to 15 minutes short you know snippets
projects for you to do and quickly come
up to speed that's kind of nice again
all of the code is open source so
download the bits and play with them but
download the code if you want to and if
you see something that's not working
like you think it should reach out and
ask questions we run getter as well
maybe you're not using it right it
happens or maybe you are and you've
identified a gap that we're working on
and that's great
or maybe we're not working on that yet
and you could start working on that as
well because we do take pull requests
and we're very community driven but do
ask first so you don't waste a whole
weekend working on something and
somebody says yeah it's coming to the
next release we already have it coded
and then of course finally is the the
repo for all this the meta repo that
points to all these and more so in
summary micro services can be hard but
they don't have to be leveraged the
enablers that help both you and your
micro services get along and understand
and keep track of everything in your
system build for speed and resilience
and remember Netflix does it so can you
a lot of folks say well yeah but that's
Netflix we don't have those kind of
engineers in my company - which Adrian
Kokhba frequently would respond what do
you think we got them so you can do this
stuff it's not that hard being other
Netflix so thanks thank you so much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>