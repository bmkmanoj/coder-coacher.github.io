<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Connect and give sense to your big data with Apache TinkerPop and graph databases by DuyHai Doan | Coder Coacher - Coaching Coders</title><meta content="Connect and give sense to your big data with Apache TinkerPop and graph databases by DuyHai Doan - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Connect and give sense to your big data with Apache TinkerPop and graph databases by DuyHai Doan</b></h2><h5 class="post__date">2017-08-30</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/k5bMuAcfcmI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so welcome in this session I will show
you
Apache tinker pup and also some demo
with its query language gremlin who
knows a little bit about graph database
here raise your hand okay cool
who is familiar with gremlin query
language
okay let's people go so let me introduce
myself my name is Rehan
I'm working as a technical advocate for
Apache Cassandra at data stacks I'm also
committed for Apache Zeppelin and I am
the maintainer of the Zeppelin cast on
her interpreter so the plane is just a
unknown book like this right I am
working for data stack so who is data
stacks we are company offering data
stacks at the price which is the
commercial distribution of Apache
Cassandra the open source project so
data stacks Enterprise is we take the
happens open source product and we add
extra features and we also offer the AC
graph which is a graph database built on
top of Cassandra so Y graph databases
today in 2007 17 anyone in this room
knows I'll use one of those applications
right Twitter Facebook YouTube and so on
and with graph database the major use
cases is how you have a lot of
information and how to find a specific
information inside this stack right you
can also use graph databases to find
patterns to detect patterns to look at
the big picture
another interesting use case is to
analyze the root causes
because in graph database everything is
connected so you can navigate okay from
one node to another one through
different paths and you can also use
graph databases to study how one vertex
can impact its neighbors and about the
popularity of grabbed database we can
see here so I took a screen capture of
database and genes which is a famous
website listing all the no sequel
technology and craft technologies so
graph technology is becoming more and
more popular nowadays how do we compare
graph to relational so with relational
database you define relation so here we
have a Newser table right person ID
first name last name a movies table
movies ID title cont country and to
create the relationship between the
users and the movies we have the view
table so which person has watched which
movie at what time so relational
database define relationships between
entities and you store the entities and
relationship in a normalized fashion
right joins labels we've graph database
we have this you have a vertex either
you have a vertex movie and you have an
edge view which define the relationship
we of course in graph database we also
store entities than relationship but now
we've grabbed database you can explore
your data and you can also discover
unexpected relations in fact the value
of your data it is fine by how many
meaningful relationship you can find
between them right so in this in this
graph you can see on the Left different
topology of databases you have key
values no sequel database it is very
simple you have a key you have a value
in terms of complexity after key value
you have tabular no sequel database so
you have a key and a lots of values like
Apache Cassandra then you have document
databases where you define your document
with their properties then you have
relational database that everyone knows
and at the end of the spectrum in terms
of complexity and values in relationship
you have graph databases any questions
so far so let's move on
Apache tinker pop so what is Apache
tinker pop so tinker pop is an opposite
graph computing framework right
computing so it is not a database it
does not store your data it's only help
you to compute your graph data the
project has been started in 2009 by some
people and they join the Apache Software
Foundation two years ago so now this is
an official Apache project so what is
funny with tinker pop is you have some
cartoon characters here the most famous
being the gremlin this bright green
sorry
so in fact tinker pop is in fact a stack
a stack of different components on on
the top you have the gremlin server so
it's a server which help you to query
your grab database you are using the
gremlin traversal language here in green
to query your data and in fact because a
pachinko pop is a very generic framework
each graph database vendor can provide
specific strategy specific
implementations you can define also a
news a DSL query language specific to
your business do this query language we
use the copy I called blueprint and in
fact you you have two engines to query
your graph data the real-time engine
OLTP and the batch engine all up so with
tinker prop most of the time the batch
engine is using Apache spark with graph
frame so today I'm going just to show
you the real-time engine write some
quick definition in the graph database
is familiar you can find two type of
graph database rdf based on the resource
description framework and property graph
so for RDF database you have a little
graph place graph Anto text etc and for
property graph you have no for J for
example Titan this affects enterprise
graph or NDB and this talk will only
focus on property graph so what is a
property graph
a graph is defined as a set of vertices
nodes and edges which is which are the
arcs are so the formal definition is a
set of four this is an edge an edge can
be directed so there is a direction from
one vertex to another one an edge is
linking only two vertex what is this
so you you cannot have an edge that can
link three vertices so it is a binary
edge binary direction of course an edge
can link a vertex to itself each edge
and vertex can have attributes right
here on my user I have the name
attributes and the age on the movie I
have the title attribute and I have also
categories which is immunity value
attributes and the same on the edge
so a vertex adjust the topology just a
node and we how can we distinguish
different vertex between them so we
assign what we call a vertex label right
so user is a vertex label movie is a
vertex level it's you can understand it
as a category of vertex and the same
from edge you have H label so view is a
category of edge and nose is another
category of edge edge properties now
let's focus on the gremlin traversal
language on the left you have the graph
definition and on the right you have a
metaphor to the hardware a graph is just
a bunch of data on disk the traverser so
this gremlin cartoon is in fact the CPU
one CPU as Fred right and what we call
the traversal in fact it is your program
it is your query so let's give some
example this is my graph here I have a
person I have movies and have users
right so one movie so one person can be
an actor of a movie and can be also a
director of a movie so I want to know
all the movies in which Harrison fraud
has play as an actor so what is my query
how can I query my graph database using
rambling to answer this question so I
start with G G means graph this is my
graph right it is an alias to my god
J dot V V means oh now give me all the
vertex vertices in my graph
so at this step J dot V the answer of J
dot V is all users all person all movies
because I didn't specify what kind of
the text I want now let's be more
specific J dot V dot has labeled person
okay now I'm not interested by users or
movies but he says but only by person
vertices mine has label what person so
now I specify the type of vertex I want
first name
Harrison thought it corresponds to a
filter right I only I am only interested
interested in person vertices whose name
is Harrison phone and now from the
person I want to navigate to the movies
I want to know to fetch all the movies
of Harrison form in which he was an
actor so I'm using this edge out actor
so from person I'm going out of person
using the edge label actor you specify
the direction right out and not in so
I'm going out of person into movie using
the edge label actor okay so now from
Harrison fraud I access to all his
movies as an actor and that is the
answer of my question so I will have a
collection of new movies in which
Harrison Ford has placed as an actor now
let's make it a little bit more
complicated
give me all movies in which Harrison
Ford has play as an actor with the mean
rating greater than seven so because
each movies is rated by
users and I want only movies with the
average rating greater than seven so now
I add an extra filtering the we're close
so we're so now at this step out actor
we are located here right the Traverse
sir is here is that movie that he sees
now I said we're in edge like so take
all the incoming edges with label like
compute fetch the value rating compute
is average value and put a condition on
this average value so I want only
average rating greater than seven so
this is a little bit more complex
example and in fact you can see that
with rambling you are navigating
visually from one edge of vertex to the
another one you are describing your
navigation in the graph so let's give me
you let me give you some more example so
it's the more time in fact most of this
talk is based on practical demo
select column so this is my schema I
have another schema I am using data
stack studio which offer me a visual
notebook to play with my graph so this
is my graph schema
I have product items orders customers
and so on and for each gremlin query I
will show you the equivalent with SQL
and the equivalent with Java stream
functions so for example select star
from categories I want to fetch all the
categories of a product this is the SQL
if I was using Java stream Java 8 I
would say ok from the stream of all the
latest vertices I filter I only take the
vertices which are instance of category
and then I want to display their to
string assuming that to swing will print
all the internal fields right and then
for each of those ordered categories I
print and the gremlin query language is
very simple G dot V all vertices of
label category give me their value map
which are their properties so here are
all the categories their name the
description the ID what is simple
next now what if I want to select a
single column select category name from
categories okay in Java in the map
method instead of calling to string I
will said oh I want to only take
category name so Catterick dot get name
and then print print out the values with
Grambling the beginning is
the same now instead of calling values
map I call values name so give me only
the name of the category okay you can
also select multiple columns category
name and description so here has label
value map name and description
what if of so if we look in the row the
Road result set it is a collection you
see F name and description what if
instead of using value map I use values
let's see what is the output okay now it
is a row list of text in fact when you
call value map you have as an output a
collection of map the key the properties
of your vertex and the values are their
corresponding values whereas when you
call just values gremlin will put all
the output into a single list that is
the reference okay here you see the map
key value key value now let's say I want
to compute some operation on my column
so select length what is the length of
each category name
so in gremlin you have some extra step
to do so when I fetch out the value now
I want to compute the length of each
name of the category so I use the map
operator I transform the name
into an integer so it is pure functional
farming map IT it it in Grambling means
an option of something so an option of
currently it is a string which is a name
so it does get you will give me the
string and then I compute the length
method okay see now how can I do select
distinct I want to have distinct lengths
for each category name well for select
distinct it is very simple I called it
up to remove duplicated values now let's
look at filtering okay I can select some
columns now how can can I filter my
values so select product name you need
in stock from products where unit in
stock is equal to 0 so give me all the
products which are out of order right
the beginning is the same as label
product now we add a condition in the
property unit stock of each product
vertex has unit in stock equals to 0 and
then we fetch out their name and unit in
stock pretty simple you can also query
by range so where you need price between
5 and 10 so instead of having the equal
condition now we have a between
condition so has unit price between 5
and 10 okay
and if you want multiple condition
multiple wear closes where this
continues is true and you need in stock
different than zero you can just chain
the highest step giving all products
which we're unit in stock is not equal
to 0 and this continue is true so
there's a bug in the display here
because in fact when I switch to the row
display I can see the the value of this
continue all of them equals who through
so there's a little bug here now what's
about ordering select where proper order
by so give me the top ten product name
you need in stock from products order by
unit price descending uh-huh so first in
Grambling I fetch all the products I
order by other than by what by unit
price or descending sorry desk
decrementing order I take their name
unit price and unit in stock to display
and limit ten
so you see here the 10 most expensive
product right we can also do grouping
equivalent of goodbye in Kremlin so
determine the most use unit price so
this is the D SQL query
you haven't nested select so select unit
price count star as count from product
goodbye unit price so for each unit
price we count the occurrence and then
we select the top one unit price order
by count this is the SQL so the Java
stream is horrible right
if I was to develop it in Java using
Java stream I need to do all these
complicated steps and with gremlins or
let's see what how I can do this with
gremlin give me all product vertices so
at this step I put in a comments here
what is the result the output of the
step so G dot V has labeled product the
output of this step is an iterator of
product you have an internal product
okay GUP count by unit price this is a
special operator so it is account
combined with good bye so good count so
I go by unit price and I count the
output of this step is a needed iterator
of map decimal long oh yeah this is more
long the key of the map is the unit
price because I group by unit price the
value of my map it is just the count the
count and in fact what is interesting
here is even though we have a needed
iterator of map there is only one single
element in this iterator
so I have done my group count then I
want to order order by what order by
count desc
so please pay attention here there's a
trick if I do a global order if I do
that order by value - decrementing value
well my ordering will be applied to the
whole iterator itself and that not what
I want what I want is I want to order by
the value of the nested map for each
month so I need to put a local keyword
what does it mean all the local means
for each occurrence of map inside my
iterator order this map by its value
decrementing so order the map by the
count desc
so once I order my map I select the keys
of the map which are the unit price and
also I want to take the top one so again
I want to limit the output and I need to
put the local here because if I don't
have local keyword it means well limit
like the first element of the iterator
which is the map itself and in fact
there is only one element in the map so
these are no up let's see the result if
I remove the local keyword what we wish
we will see is the map itself right okay
because I remove selection don't do
select
okay this is the map itself and the map
is Aurra you can see by the value but
that is not what I want what I want is a
limit local so just take the first
element of the nested map aha
now we have it and then I put back
select keys so I want only the unit
price and not the count here we are so
it is really important to understand
with Gremlin at each step what is the
type of my data here I have an iterative
product with the group our group count
it becomes an iterator of map the same
along with only one instance and so on
this is Graham didn't basic now let's
see what we can do with advanced
Grambling oh we can do joins aha
welcome to joints in your joints so this
is my schema I put a picture of my graph
schema so we can understand where we are
going so the idea is get all products
from a specified category so in SQL it
is very simple simple joint so select
product product name from product inner
join categories on categories ID equals
to product not category ID where cattle
range name is beverages so I want to get
all products of category beverages so I
just show you the same code in spark
already big piece of code and in Kremlin
so G dot V has labeled category we start
from the category
vertex so the output is an iterator of
category hast name beverage it is just a
filter right
select all category vertices whose name
is beverages so in fact after this
wintering you have only one vertex in
your iterator in in category what does
it mean in so now we start the traversal
let's have a look at category ways it
okay here from category we have an in
inbound edge in category so by saying in
in category I am I'm moving from
category to product right so now the
output of the step is an iterator of
product and then take their name values
the name the output is a list of string
so let's execute this okay
this is all products of category
beverage
alone so a left join combined with good
wine and count it started to be
complicated so the SQL is select up 10
customer ID count orders order so the
idea is count the number of orders for
each customer so let's go is select up
1000 for each customer and take the top
10 customer customer ID count order
customer order order ID from customer
left join group by customer ID soft buy
count order desk now we have something
interesting with Kremlin this is a quite
complex query I want to express it in a
very simple manner so we have pattern
matching I say okay I start with
customer G dot V hands label customer
now I want to put how much that much as
C so for each gutter customer we label
as C get the customer ID values and
store it as customer ID and for each C
customer so the trick here is as we give
the same alias for each condition the
conditions will apply on the same vertex
so for the same customer where we fetch
the customer ID now out order so we are
navigating from customer out ordered so
we are going from customer to the order
vertex we count the number of order and
we save it as orders and once it is done
we do a select so select customer ID
which is my ideas here and orders which
is my ideas here the output of the step
is an iterator of map string object
each map is of this form customer ID and
others I want to order those Maps
how by orders descending so I have a
lambda step here
each map I get the order and I put the
minus in front so this is an descending
ordering on the value of order which
should be counties along something like
this and then I take the top ten so
let's see the result okay here we are
the top ten if I remove the top ten I
will have all customer with each of them
their total number of orders okay and so
on so I have like 90s customer in my
graph database right now yes
I don't think so we have limit we have
also we can take the first 10 on the
last 10 but I don't think we have some
kind of paging something like this
because in fact when when you execute
this query it is lazy it's like an
unfortunate programming and Java stream
it is lazy by default so it's start by
the end and then it pull all the step
backwards so if you say oh I want the
next page it means that you need to
compute the first page so yeah there is
no magic week we cannot compute the next
page we've done computing the first page
oh let's do something really crazy
recommendation engine Wow so how to
recommend fry products for a specific
customer so for a given customer we want
to recommend five products and how which
products are they the product are chosen
as follow we determine what the
customers has already ordered we
determine who else order the same
products so those people we fetch all
the order they have done and we subtract
from the order that has the the products
that has already been ordered by the
initial customer and then we rank the
products by the number of times they
have been order so the select the SQL
query is something crazy like this so
don't try to understand just to give you
the idea okay if you were to quit to
answer this question in SQL it will
finish like this and now how can we
answer this question with gremlin so
stay with me it is a complex query so we
will post it step by step G dot V has
customer ID customer ID of alpha key
so I just take a random customer
so we start from this guy this customer
with this cutter ID we save it as asking
out order so from the customer we are
going out order so we are going to the
order vortex eater order order of alkie
out contains so from order we are going
out of contains so we are going to item
all the items order by al-faqih out is
all the product order my auntie I could
not navigate using this edge because
this edge is about the rating I'm not
interested by the product rated by the
customer I'm interested by the public
order by the customer so I need to go
the long way from here to here to here
back to here right and one I reach this
step so all the products order by algae
I call the aggregate function this will
save all the products of algae into a
collection name of key products so the
name is given here it is an alias right
then I'm going back so I start from
algae I'm going this way now I'm at
product now I'm going back but what back
to Alf key so in is in contain in order
so from all the products I'm going back
to customer and now I say now I want to
take all the customer which are not so
which has order the same products of
course but which are not asking so we're
not equal to a few okay
and now I'm doing my traversal once
again so those customer which are not
asking what they have orders so out
order out contain out is take all of
their products the products that they
have order which are not the same as the
one a ski has order so I save those
product here with an ideas to be used
here without so it is like a subscribe
operation I have a collection of order I
subtract from this collection the one
the products algae has honor and now
group count by name so from those
product I hope by product name it give
me an iterator of math of string long
with only one single element map key is
the product name mat value is the
protocol other local again because I
want to order inside the map and not in
the iterator by value which is my
product ounce descending now I select
the keys of the map so I take only the
product name I ignore the count
Anna meet local five and forth here here
are the five products I want to
recommend to alkie oh.why unfold so here
in the row display we have this if I
didn't put unfold
I will have this
so just for formatting so as you can see
the same complex query with SQL in graph
it is just defining your path I'm here
I'm going to here here
put some conditions go back put some
conditions and then extract the
properties of the vertices you want to
display and doing some other group count
and that's it so it's very visual and in
fact when you are creating Grambling
queries Grambling traversals you always
need to have the schema in front of you
to understand where am I in my graph
let's say oh how can I have the top
three biggest buyer right so a buyer is
a customer has label customer out order
as order select so for each customer I
want to have his orders
select so this is a very weird syntax
select customer or by name ID so the
name here applies to the first parameter
in the Select clause ii by applied to
the second parameter so select customer
by name and order by the ID so if i stop
here i would see something not very
interesting so for each customer the
order ID right if i step my my query
here now I continue with group count
because after a select you have a map I
want to group count so goodbye goodbye
what goodbye sir a customer so I want to
group by customer and count the number
of order
of course
each customer there are number of order
now order by values of order by the
number of order disc sending limit free
to take the top three here we are the
top three biggest buyer in fact this
query I can do it with another way the
same Optima the same query right top
five or top trees is same thing but
optimize now select customer as now I
give two ideas to my customer as
customer and as auto car why because now
then the the graph traversal here I do
my graph traversal here directly and now
I want to do my graph traversal inside
the Select clause so select customer
customer by name customer name and by
customer dot out order count
aha and then the ordering Clause itself
so with gremlin you have different ways
of answering the same question as in SQL
some Korea's more optimized and order
the top three most rated products has
label for that so the same idea I do my
travels all inside the Selleck buy and
not outside product has named an average
rating select product by name and also
by Oh laser local here what does it mean
for each product I want to compute I
want to go to in edge rate it so for
each product where is my product here I
want to go to the edge call rate it and
take the rating take all the ratings for
this single product compute the average
so why do I need this transformation
into integer because I made a mistake in
my schema the rating instead of using an
integer type I use a text type so to
compute the average analytics it's not
possible so I need to convert it to two
integer first so for each product I
fetch the rating values from the rated
edge compute the average and then I
order by average rating limit 3 ok so
this is the top average rating ever for
products but in fact there is something
weird you see 10 the 10 is the maximum
rating so why do we have 1099 in fact my
query is not very well designed because
imagine that you have some product which
has only one or two ratings it's not
interesting I want only to take products
with a lot of ratings because if you
have a single rating of 10 they are
is ten right so I want to exclude all
those product which has only one or two
ratings so how can I do that with a
we're close to filter so give me all
products now we're in edge rated count
is greater than ten so all the products
which have more than 10 rated incoming
edge let's see the schema all the
product that have more than 10 incoming
edge rated is my I'm lost
oh I'm here and now the result is very
different
aha now my top three most rated product
is more sensible I think we are running
out of time so I will not show you the
other stuff so you have any questions so
far yes
Oh Apache tinker pop is a framework and
in fact right now you have many graph
database vendor which support tinker pop
so in my I think in my first slide I
listed some of them so now for J support
you can do this kind of query with Nell
for J because therefore J support up a
cheating kappa titan DB's support a
vegetable of course later tax at the
price support think about because I'm
doing my demo with data tax and a
paragraph or indeed we also support
Apache think of there is some thing you
should know is the kind of support some
time the support is 100% sometime they
support only a limit a subset of the
feature so you need to check on the
question yes
oh it is groovy yeah oh yeah it is a
filter it is it is a filtering I have
done this in um in the first a notebook
it is basic rambling yeah this when you
say has label so G dot V is all give me
all the vertices all all of them so you
can have millions of vertices now you
say has labeled category it is a filter
like oh this vertex instance should be
of type category so it is a kind of
filtering but a special filter on the
type of the vertex and not on its
properties is it clear yes
a vertex has a multipolar label no
because in fact when you put a label to
a vertex you define its type so you
cannot have a vertex being a product and
I don't know something else it's weird
you can have multiple properties but the
label is a single one oh no question no
yes
yes
excellent question what about
performance okay dot profile we have the
same thing like in SQL profiling okay
for each step you see the oh you also
see the the SQL query in in Cassandra
because the AC graph is based on top of
Cassandra which is the storage engine so
when you call the profile step it will
show you the profiling and you can see
what kind of query is done internally
so you can understand all this is are
not unoptimized so this is optimized and
so on we also have explained so this is
profiling for for performance you can
see each step the the duration in
milliseconds for each step and you can
have also explained explained so you
have all the tools to to optimize your
query all the question
thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>