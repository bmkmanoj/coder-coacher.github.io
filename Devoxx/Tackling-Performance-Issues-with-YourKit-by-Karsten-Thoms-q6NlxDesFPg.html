<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Tackling Performance Issues with YourKit by Karsten Thoms | Coder Coacher - Coaching Coders</title><meta content="Tackling Performance Issues with YourKit by Karsten Thoms - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Tackling Performance Issues with YourKit by Karsten Thoms</b></h2><h5 class="post__date">2017-04-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/q6NlxDesFPg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay thank you guys for joining armed
good afternoon my name is cathlin and
I'm working for German company called
items and today I want to talk about you
about a tool called your kit Java
profiler
arm so why we do and do we need such a -
I'm always curious that something that
won't behave tasks or L consumes much
memory and don't know what it's doing
then I see just a symptom of of usually
off of the typical problem what we
expect is what we experience is just top
of the iceberg what can we do that yeah
we can look at the code and try to guess
where are the performance on goes away
and this is typically what what people
are doing they're discussing and say
okay yeah that's your quota which is
which doesn't behave fast or that that
are part of the curve which doesn't
perform and actually are not not the
right way to do unless you're that guy
yeah and so you could use them of course
- they're free tools available like jv0
vm you may know that's coming with the
JDK or Java Mission Control you could
use these tools on there for free they
come up box and actually can today can
also help you to solve these kind of
issues but I'm talking about commercial
- no actually it's normally not that way
that I talk about commercial things I'm
I'm a really heavy user for free
software and contribute to our - also so
fear I'm heavily but for solving these
kinds of issues it is really where to
have a good - because around pipe on a
box or single user license and today we
get author and a 10% discount if you
want to use that tool and I will show
you why this tool is really
good and better than what comes with j-b
here at the end on are the tents so all
that we needed some kind of use case arm
other which has twelve arm I returned a
small program um it's called
the p2 browser on either done you don't
need to know that too all it does is
displays on the content of a p2
repository they clips format for
deploying artifacts um I think it's for
me and to make this a little bit bigger
arm actually it's just on here the
oxygen Eclipse oxygen and poetry and I
can open that and see what's in there
yeah and behave totally normal
um as I press this button here that
should expand all the notes I would
expect that just artist behaves quite
first let's do that and so nothing that
was beach ball of death and takes some
seconds or to do something yeah what
does the application do right now so now
let's have a look at your kit first of
all this is to yoke it and we see here
on a top left on all the application
processes Java processes that are
running and I can connect to these
processes on I see there they're
different status some of them are green
which says there's a Java agent running
on that process and you use this
programmed an agent to connect and talk
with armed with a profiling to UM this
you can actually install on any machine
and also remotely on profile
applications and therefore we have
different kind of iterations for typical
application servers and you can also
integrate this with your favorite IDE
like a clear
IntelliJ NetBeans we use NetBeans um
okay and so I can connect to the p2
browser and our let's look what's
happening so on going back in the
original state collapse everything and
we're different kind of ways to profile
that application I can profile the CPU
time so what where is time consumed and
we can do memory analysis that's not
what I want to have a look at the role
of moment I have a performance issue um
and therefore I can enable now CPU
profiling and we see the two modes are
actually our sampling error would hassle
um yeah Luke's where performance is gone
away which methods are taking which
amount of time we will see this is under
second called counting
um just currency implications and
tracing that both but Buster comes with
no bad let's first do the core counting
so starting and we have immediately see
arm that's just a preview here how many
times certain methods are called
let's do or expand the old button and
what's happening here were sixty million
times unlit million times okay - code
method so quite a lot sir are those
variable to search now wondering why
this takes some time so um we now see
that the sevens method are hits very
often but let's see where the time goes
and when time is lost
so I'm stopped strolling laude a
profiling result when it came to the
added some roughly six and
650 billion times that it calls this
method and we stole a nice natural that
we can evaluate data I'm not really
interested in that at the moment because
I want to do now the tracing at the
sampling mode so let's see what happens
we collapse again and now we do expand
and while we're doing this we can
already see on some estimations on on
web time girls and I can see a con
service maybe by the time this consumed
by the method itself on this good hinge
with where we actually have to search
for methods that consume time for
themselves
um that's not very accurate at the
moment we have to wait until yeah the
action happened and then we make another
snapshot and look into that snapshot try
to analyze this a little bit or what we
can have a look at so still in that
snapshot and now we can go a little bit
into deeper so on on left side arm we
see that there's an option called
hotspots that's the first thing I that I
usually open and it will say me okay
these are the methods that you might
have a look at and I know this
interested in both um part of the
application which is really really not
the base frame budget why because
usually the base frame lyrics don't have
performance issues on the application
themselves so this is actually a method
from the application the installable
unit content provider and there's method
called to view notes which looks
suspicious and you can see here in the
UM the hello around view arm who calls
this method and we can build that the
old through
II and see okay who called that method
and that method and how many time how
many percentage of the time goes into
into these codes
what you have to cleanse here's our what
does the method call so that's the other
other vehicle is list and I see gate on
a course very often hashmat gap okay so
what was what does this method actually
do so let's have a look into this method
you can arm directly open the method in
our IDE utility arm due to DM adding
integration so and well methods does not
believe them another image suspicious
okay there's some things about it that
we actually can do about this methods
what does it do it could transform the
collection of units to a collection of
notes
therefore in instantiate an ArrayList
iterates over units and creates some
notes is that they are not in a hash map
and store some cash them actually we
already know how much many a time
elements will go into this list or
intervals that harm you resulting array
actually I can also immediately create
an array with a certain size and put
them the notes into that and don't
instantiate our ArrayList all the time
the method itself will not be on so on
expenses but it depends on a number of
units that we get into this method and
the amount of times that it is called so
let's have a look back into our coil
current and we can search for the method
here in the chemical called view until
actually type
to view notes of something to view notes
so how many times is three two units
called 43,000 times so that's quite a
lot so it's worth optimizing this a
little bit so I'm noticing that we can
see here is arm that we current 300
million times on the hashcode method of
that class it's thurible unit
let's have a look into this method um so
sorry
did okay also that's what looks
suspicious but if it if this method is
actually called 300 million times then
even this code can be optimized because
a hash code does not change one unless
those two information change the ID and
the version of it install the unit but
that's actually immutable so actually I
could also arm make a field for storing
the hash code and whenever I changed the
idea of the version that it gets
resented and recompute
this will be faster so you can also do
micro optimizations if the method is
actually called that me arm often it's
not that are that this is here actually
the problem that we have but just to
give you an imagination how you could
think about a hash code it recouped by
computing of course yes
um yes but it has to call get versions
of getting the version and then
computing the hash button on that on our
object it cannot go on optimize this
notes actually need again object it's
it's mutable what is logic that you call
and commit
it's just yeah and you have a complex
object and you compute hash code all of
that and if you recompute this all the
time and and use on the hashcode method
often by storing that in hashmaps and
accessing that from there um then this
can become expensive actually I'm not
sure what what the JVM does yeah I know
I but you can be sure if you call that
or that often and it's you can improve
something and I'm going to get go to too
much on this detail on what shields or
another use case um actually um what the
problem here is with it armed with that
use case is not the hashcode method and
it's also not really are the method bets
are we were pointed to so it's actually
just it on yeah some interest some hints
where we could do something if that is
called that all the problem here is it's
called two of them actually we just
expands the note and then we have an
algorithmic problem and on this you
can't directly see from the two it just
gives you hints so what actually can be
done there's um that yeah these there is
a hash bear there's a cash missing in
this in our in this coach and
if we optimize this a little bit then
the method is not called that often
anymore and so this is the actual
problem here okay um let's another look
and we maintain our memory snapshot what
can we see their arm so capture memory
snapshot and then we can see how much
objects are actually on in the memory
and let's have a look at that
so what you can see here is um well of
course we have many objects and because
it's hard of the inner of the system
argue of this application to to manage
installable units we have many of them
and we can see two different sizes here
on one is the so-called shallow size and
the one is the retained size on channel
size is the object itself so they object
with its fields retain size means most
objects are only reachable from that
object so the transitive cloud of
rounded object arm this is not
completely accurate but we can continue
to the correct size of the arm of that
object so the vector problem will not on
depends on your use case on based on
what we can do then on this on the memo
step shortest also do some inspections
there are inspections to run arm and we
can detect duplicate strings for example
we see on that certain screen is um yeah
duplicate it 20 thousand times so
actually we can improve that um it's a
way for 2 megabytes okay it's not not
really the problem here I will show you
another use case where we have a problem
um we as you can see here is duplicate
objects so we can also investigate that
a little bit more so we see it in the
string and with that function calculate
path you can also see who uses this
object and go back to that and let me
see okay that's used by an item element
and actually this is that makes a large
percentage of that and then we can in
our investigated okay how could i
optimize this class to use the single
object for a single string and then we
can it optimizes a little bit or zero
length arrays on let's compute pass here
and so we have our empty child raised
arm and we can see also here we are the
item element is the most dominating
object which are the application and B
strings so let's have a look at that how
we can invert our investigate or
actually the problem here so opening ID
doesn't find that so I have to open that
myself just a second okay
so the item element then don't fight
that adamant sorry for that so it
doesn't matter that's on circulation but
what could be top there is it creates a
string better and append but as depends
things depending on the state but
actually almost the state is just empty
and the returns Venice in the anti
string buffer and at the end of that
message we could just say okay are the
stream of is empty return and D string
this single constant so we could impound
avoid this waste um we can also do
mineral analysis on our album where do
we have null fields observed if there's
an object that are sparsely are
populated if you have large objects and
it could create different subtypes some
of the one those class which only
contains the most frequently used on our
fears and then based subtypes are with
more fields which are not that
frequently used okay um I will show you
another use case and it's actually a
real world who use case um for a banking
application and let arm the problem with
this application that it was performing
badly when it was got input into
production
everything was fine it hits are the
three performance requirements and yeah
the users grow and the desert girl and
so and actually we are we had some
issues um and therefore I will now show
you
not now review on the first view we can
actually see what happened in the in the
threat and we see here some arms
locations where we there are red marks
and burning fire and so what's actually
happening good we can actually select
this and below we see this tech trees
and it's quite interesting what does it
do you see base cloud cloud float ignore
class and it's blacked what does it do
this year marshalling object interesting
read object so we're trying to
materialize an object and during this it
loads classes and the traveler is
blocked the thing is this was on a
machine which already rent for some
years and that was the belly application
in production the arm it is very hard to
do upgrades with or without a meat and
we had to prove that we actually have a
specific problem and this problem that
we saw here is actually unknown gave us
back in the class loader there was a one
version in the arm of the class holder
which had a synchronized or block during
our the others load class function and
so on if you help us blast loading with
many many threads at the same time then
you run it actually in this issue and by
exchanging on the class loader job we
could actually solve that another thing
that we also here tarsiers the dream arm
become buttons it's not really black but
on wherever I click here on this green
failure I see actually the same stack
trace and the step press is indicating
that we are doing something with
methodologist and if we look little bit
more down the stack then we see it's
checking passwords and so therefore it
digests the password and compares it and
defended for every every call and this
happens on in this application very
frequently and actually the arm others
could be optimized by catching the the
past verge here internally and therefore
we could optimize this away
okay so what can we also see here we can
also run inspections on right on that
here and we can see maybe issues and
actually I'm not not really issues we
can see which files are not closed arm
which sockets are not closed and you
will see that yeah the typical locks are
not closed at the moment um so what we
also can do is actually inspect what
it's happening here on SQL or on the
sockets and here can be invented a like
in there for example just look have a
look what's what's happening in SQL by a
deselect any other things so and now I
see our what appears actually I executed
and I could solve them and see okay
which statement performed that our worst
when is it actually cold in that scum in
that timeframe and I could select um
sort by details so I can estimate which
statements are repeating okay there
between it began lower pointed seconds
this is Janey I and okay I see it
multiple times the same statement so I
could have a look on that that okay
actually there was not okay and what we
sorted out here's our that whenever the
user locked off the complete preference
tree was thrown away and then inserted
again and these were some thousand
entries and this was just not necessary
the only thing that we had to store is
the difference of a preference change
then they are actually usually zero so
this was also another issue that you
that we could see here okay um what I
can also see here in this snapshot is
exceptions usually the exception that
you do not see
catch somewhere but so many unnecessary
you had sixty three thousand on null
pointer exceptions called somewhere so
you can ultimate that also but actually
the most of these are now pointers are
called
at least 85% gives you the arm break
hold here from on the transaction
manager
so it's an underlying library that where
we do not have direct influence on but
you can actually analyze this library
and report back to them that there
should handle that this most normally
it's not necessary actually we have so
many exceptions occurring internally
especially the easier our index out of
bounds or no pointer and the typical
things so yeah um that's actually what
what I wanted to show you and Phyllis
and repin thing that we had experiences
our garlic election and we see here the
outage of seventeen seconds and actually
these there are these outages where of
differ world with J visual BM they just
showed normal behavior in this
application and the effect that we are
just experienced grant and worst are
that the client which was actually Java
swing client communicated with it with
the Java server got a connection did
something and while we are got the
answer the connection was closed and
this was really annoying for for the
customer and there was no way to really
see that and then we installed the agent
may be Jaden yogurt agent on that
machine and yeah took a snapshot then
they are then it would became obvious
yeah these garbage collection process oh
we did not really expect it because when
we put on when the application got in
production on there was much work spent
on filing the rights or jobs or garbage
collection
and the right garbage collector which
fits the needs of the education event in
town of violence changed and then we got
into this problem and of the story was
we just changed the garbage collection
um we went to a newer Java version and
we have been a possibility to use a d1
GC and with the garbage first garbage
collector problems disappeared okay what
you also can see you can optimize memory
consumption on and we try to optimize
just one object and reduced from the
share size and we could reduce that for
the same use case by one foot so
hemisphere the tool can not really give
you the Advocate problems that can only
help you to ask the right questions you
have to in order to use that data and
then explore and try and so and yeah and
then you actually figure out what your
problem is but without this tool it's
just not possible okay um so my
gluttonous are bad blips you know not do
not really see where they are really um
you get in the wrong direction so you
just have to figure out what where where
is actually the problem and you have to
use all this too and yeah thank you very
much for your attention
so I have a little bit time for
questions on some one question is what
is about the Oviatt of yogurt that's
actually are amazing it's almost nothing
especially if you do not something you
can just on that the agent run and you
will not have any overhead so we can
actually use it in production and once
you have an issue to observe and you
connect during the arm a small amount of
time to be agent and use that and even
then for core accounting and sampling
the event is still almost nothing only
tracing which combines you have the core
count with a sampling and has very
accurate measurements this will have
yeah meaningful over because it also
instruments the classes and inject code
that really does yeah get the data so
this is I would not recommend but
usually samplings often is often a good
enough to get and get to the right
points of where the problems are no
actually I don't question what's up what
does it go will it compare just to press
I'm actually I do not use per so I don't
know
mm thing is um is how to debug native
code yeah I'm not usually not debugging
native code
so what about Goethe and if it changes
something on that this confuse um well
actually I'm not really because it only
gives you all the only a hint where you
have to look where which methods are
really the obvious things away and where
performance type loss but this doesn't
depend on object or not
no again I we see that on the accessible
eyes just used is such a production arm
situation and it pointed me to the right
places
what do you mean by unload this
no I don't think that it really unrolls
our inline code yes of course you just
see the other big actually I also don't
know become and I don't have to level up
a detailed armed wrong level Peter for
me um yeah um last question
so on question is arduous ER cause
across multiple fits but they don't see
but but what I could see is the frets
themselves are which are spawned and
when they are spawned if they respond so
I can make a selection on the fret I can
be able to friends with that name and
let's have a look and I can see when
they fell for it I've started when there
and it's my room and are not across our
cords so I don't have this connection
okay um thank you for the question so to
arm I'm still available or fortunate I'm
here um yeah
thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>