<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Onion architecture with stereotypes by Alain Sahli | Coder Coacher - Coaching Coders</title><meta content="Onion architecture with stereotypes by Alain Sahli - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Onion architecture with stereotypes by Alain Sahli</b></h2><h5 class="post__date">2018-03-12</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/XOyyLwyrBQU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay hi everyone thanks for taking a
part of your lunchtime to listening to
my quickie about onions not the
vegetable but the architecture and
especially also a deeper loop into
stereotypes that we can achieve with
stereotypes I would like to do this talk
especially because here at Vaux days we
have a lot of technical talks focused on
non calf:cow and databases on new Java
frameworks new programming languages etc
and we are really living in a time where
technology is evolving search quickly I
mean you can do your angular 2 project
and since six months later three or even
four is starting to come on the market
you could say yeah let's do now a graph
a graph well API instead of a REST API
and then you see oh but there is now
this proto buffers stuff from Google so
actually everything you do when you
start to do it once you are done it's
almost all already and developers in
general passionate developers all I want
to use the new things and on the other
side we have the business and the
business I don't I don't want to say
that business looks like a slogan that's
really not what I want to say here but
business is slower and if you take any
business let's say we take insurance we
an insurance is insuring cars and the
car is a car and the model for insuring
a car is almost the same I mean what
they change in the last 20 20 years is
maybe they added a little crash recorder
so you could have to pay a little less
for the insurance but basically we still
just insure a car and the same is for
banking if you buy stocks yeah you buy
stocks it doesn't matter if you buy is a
BB stocks or UBS and even when new
features are coming like
cryptocurrencies now it's a totally new
product the business itself stock
trading is not changing ok and what I
to show you today is how how you can
build an architecture where the business
is kind of sealed and protected against
technological changes so that you have
to define once what your product is
doing what what's important for the
business and then you have the freedom
to change the technologies at the pace
you want and to introduce that I would
really have a short look on it three
slides about the three-tier architecture
just I'm curious who uses this
architecture in his daily job yeah quite
a lot I mean that I would say that's an
established architecture where we have
well-defined layers we have a
presentation layer the presentation
layer displays information if you have
more an application with with some SPS
then you would typically have some rest
services or if it's a little bit older
than you would have server-side
rendering or you already use the new
trends again server-side rendering then
we have the application tier and the
application tier is more or less the
layer where you would put a business
logic your domain model you would
integrate technologies ideally if you
have to listen to a JMS queue if you
have to communicate over soap with other
services this would typically be done on
this layer and it's more or less an
orchestration work like you you are
getting data from the data layer maybe
from you take two different objects you
mix them a little bit give them back to
the presentation layer and the
presentation layer is returning it and
that's that for me the biggest issue in
this model I will come back to that and
the last layer is the data tier and it
contains the data access objects and if
you read on Wikipedia the definition of
the three-tier architecture it's
explicitly stated that in this layer you
shouldn't have any domain logic okay so
it's really just objects that contain
data no domain logic at all
and for me the biggest problem is that
in the application layer is the layer
that becomes really huge and in the end
it's the layer that contains the whole
business logic but it's not
well-structured because you have your
services and it's more an orchestration
layer that gets data merge them maybe do
some transformation and returns it and
if you have a look to other
architectures for example the domain
driven design which is in my opinion a
perfect fit for an onion architecture
domain driven design does exactly the
opposite they say you have a domain
model where the whole business logic is
encapsulated inside your model and
completely independent from technologies
and to do that the idea is to have a
domain so you really have pure Java
classes usually when I do a project with
an onion architecture in the domain I
have no frameworks at all it's just the
JDK and my goal is to implement all the
needed features really all of them just
in this domain so it's much easier to
test of course because you have no
external dependencies and especially you
can see exactly in your code
what's the businesses you have really a
clean code that expresses the the
business and then you have an API layer
and it's not an API in the sense of REST
API layer but it's a layer of classes
that provides an API to interact with
your domain okay so from the outside
from the infrastructure layer you would
call these classes to communicate with
your domain and what's special and
that's why they say it's an inversion of
dependencies the dependencies come from
the outside to the center and that's the
way we can protect the domain so the
domain has dependencies on on no layer
from the outside so forth from the
developer is not even able to for
example access arrest arrest controller
from
the domain layer and that's really
really the key ideally if you work with
maven or any other packaging tool you
can make sure that it's separated on a
class path level so you are sure that no
developer is ever going to access some
infrastructure service out of the domain
layer and what's really hard is is to do
this this mindset switch and work in the
domain with pure Java and I did some
experimentation with with projects and
new developers and I told them just do
it by ignoring everything you ignore the
database you ignore if it's open or if
it's a synchronous you've write your
domain model so that it works in the JVM
and I would like to be able to run every
business case we have to cover on the
API layer from the domain I don't want
to have a dependency on anything and I
had interesting discussions because we
are so used to think about oh but the
database orbit right this is going to be
a synchronous etc and I always told them
no ignore it and this is a problem we
will have to deal with in the
infrastructure layer it's not the
problem of the domain because the domain
is is a representation of the business
it's not a representation about
technologies and as an example if you
would have your classical application
tier and we would read we have a chat
service and we have to mark chat
messages read what we would typically do
is use some repository get this message
out of the database set the read flag to
true and then maybe we would have a push
notification service to notify the other
devices that the message was read and
that's I mean that's a business
operation in the sense that the business
will tell you hey I would like that my
people chatting are seeing when a
message is read or not that that's a
business requirement but here we are
mixing already with push notification
message repository
and especially the this business logic
is not part of the chat message it's
extracted into an application service
the DDD way would add a method with
semantic mark chat message as read on
the chat message itself and would
encapsulate the business logic in there
and you can see that in the markers read
method in the chat message aggregate we
are using a notification service without
any assumption how the other devices or
other users are going to be notified we
just say we notify the other users but
if it's a push notification some
WebSockets um whatever message pass you
want used it's not relevant from a
business perspective right just need to
know that here the same is for the
repositories in your domain of course
you have the requirement that when
something is created then it has to be
persistent and it's not deleted at any
time but the way it's persisted is not
relevant again so what you would do in
your domain is have a message reporting
interface there you define all the
methods you need to work on your domain
model so you would typically have a say
find get and so on but if it's
implemented using a text file or some
document based database that's not
relevant again and even if you know it's
sequel
it could be JPA it could be joke it
could be whatever framework you want and
here you already see a little bit where
it's going if in your domain you have
just the interface and you express what
you need from the repository layer but
you're not actually binding it to some
technologies and you want to do a switch
for example from JPI to pure JDBC then
you would have to do that only in the
infest infrastructure layer and you
wouldn't break any business rule because
the business is in the domain and you
won't touch the domain if you have just
would change the technologies and here
again I did an experiment
because developers are very resistant or
reluctant to do that because it means
more work and this work pays off if you
have to maintain the app for ten years
because you are sure that the domain is
stable and they ask me but could we at
least use JPA in the domain the
annotation because it's really annoying
to do this mapping outside and then told
them okay then if you won't try it out
they did it and then a few months later
they came to me and told me but with DDD
actually it would be much better to use
a document based store because then we
could save whole aggregates at once as a
document in in MongoDB for example and
we said okay then let's do this switch
it's just a technological switch but
they had to actually change the whole
domain because they use this JPA so
intensively in the domain itself and
that's why I really try to have no
dependencies at all in the domain then
there are cross-cutting concerns like
transaction services etc and there we
use the euro types so usually an
application service which are the
services on the API layer is annotated
with an annotation application service
in this case and this annotation is
again not something coming from the
outside it's a notation created in the
domain and then we can from the outside
use AOP or advices to add transaction on
every method for example you can even
play around with naming conventions to
know if it's a read-only transaction etc
so we try from the outside to make map
technologies on your code using
stereotypes and if you work with DDD
sorry then you have all the tactical
patterns like repository domain service
aggregate etc then for the security what
we usually do is authentication is a
technical thing again because it's not
relevant to the domain if you use or out
some basic authentication and then we
separate the authorization in two levels
we have of course
security on the data level and this is
something you have to do in the domain
but most of the time these are
requirements from the business let's say
a user is only allowed to see tasks that
are assigned to himself that's a
business requirement and can be
expressed directly in the code so it's
really clear what what what's the
purpose and the more higher-level roles
can be directly set on the
infrastructure layer and again if the
domain needs to know which user is doing
what then you can use the same pattern
as for the repository you have just an
interface that gives back the actual
user and the implementation where this
user is coming from is in the
infrastructure layer I have to hurry up
a little bit then what's really
interesting is when you have this onion
and all these stereotypes you can also
start to check that your architecture is
respected throughout the code in an
automated way and that's really
something important as an architect
because you don't want to spend two or
three hours a day reviewing pull
requests and finding out illegal
dependencies between packages or between
layers and check you assistant is a tool
a maven plugin that parses the whole
code and writes it down in the neo4j
database so you have a graph over your
whole code you can know you can say give
me all classes annotated with this
annotation or give me all classes that
have a dependency on this other class
you can really find everything you want
in your code and then once this code is
parsed we can write queries to check
violations so the idea is to say for
example an application service is never
allowed to return an aggregate root and
then you could write a query that checks
if there is any application services
that does that and if one or more result
is coming back back then your build is
breaking so you don't have to check that
by hand it's just on on every build and
what's really really nice with Jake
assistant is that you can define these
rules in an ASCII dog document so as an
architect you can say okay these are the
concept in my application I have
application services I have aggregate
routes you can write some text to this
concept to describe what's this concept
and a piece of mail for jQuery that will
actually represent this context concept
on the database and then there is
another part where you can define the
constraint so for example this
constraint I told you before an
application service is not allowed to
return aggregate roots you can define a
query that makes sure that this never
happens but you can also have some text
that explains why you want this to be
respected so here I have wrote concepts
or I say I want all the Java types in my
application that have a Java annotation
of type application service I set that
in in no Forja you can define so-called
labels and once this code is run then I
can always refer to this concept just by
saying application service I don't have
to rewrite that
and then I can define a constraint so I
say give me all the application service
it give me all the methods of the
application services that return an
aggregate root and I define another
concept what's an aggregate root and I'm
only interested in public methods and I
just return all these methods that
return in a ban aggregate route and if
one guy in my development team is
returning an aggregate root in his
application service he would get an
error in the bill and he would also get
the text that belongs to this error so
he sees oh I broke something and he can
read why he broke it and why it's
necessary to enforce that so
I know it's very very short I could have
going deeper in Everest every subject
here if someone wants more details you
can just come by by the me Macomb booth
I am really happy to show you I can also
show you live or you can query your code
and I think have a time for questions or
no way right
okay so then have a nice lunch thank you
for listening</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>