<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>DROP DB – simple event sourcing for simple aliens by Jarek Ratajski | Coder Coacher - Coaching Coders</title><meta content="DROP DB – simple event sourcing for simple aliens by Jarek Ratajski - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>DROP DB – simple event sourcing for simple aliens by Jarek Ratajski</b></h2><h5 class="post__date">2016-11-11</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/n_NXUk6POgY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello will rather welcome to my talks
rotate database even sourcing phones for
simple aliens so I don't have much time
so I'll try to make it quick let's start
from a real life story the real life
story is like that there is one galaxy
and in this galaxy there is a
businessman and he has a dream of
building a galaxy-wide
pizza delivery so his domain is like
there are 10,000 planets in the galaxy
where are living creatures that possibly
want to eat pizza and he wants to
deliver them three kinds of pizza and
three sizes of pizza and he hires one
pizza boy with his spaceship so and this
pizza boy should be able to deliver all
those pizza the spaceship is very quick
and the only problem is that the fuel
costs a little bit so he has to deliver
first beats us to the planet that
demands my most not to the first us that
people that audience that ordered the
pizza but to those planets there are
most demands for pizza ok so this is the
business garlic pizza so the businessman
gathers the developers and in this
galaxy he found some Java developers so
the Java developers started to implement
service so what is a Gallic pizza
service it's a service is something that
probably you have something like place
order so it means that customer can
place an order for a planet oh sorry let
me get one once again I see some issue
with screen so we have a place order
with size okay then we after having a
place order in interphase I hope you see
that we have something like maybe take
orders for best planet that's a that's
the interface for delivery so we select
the best planet and which kind of what
kind of orders are there then you have
something maybe for the businessmen to
see how many orders are in the queue
comes donek orders and then you have
something like yeah a debug function for
developers
to see what kind of orders do we have
right now in the system okay so that was
this for functions so how can we what is
an order so an order is something that
probably what has an order is something
that has a planet name in this in this
galaxy planet name is enough to to find
someone who needs a pizza planets are
small you know so and something like
variant and size that's makes us what is
an order so we define this yeah and then
we have to define maybe what is a
variant of pizza of course we have three
variants of pizza the most interesting
is how I then margarita and then
vegetarian one so I think everybody
should be happy with that and the
resizes of pizza like those ones that
conclude something that is good enough
for everybody
so now let's implement those services so
those guys in this galaxy had no idea
that something like databases exist so
they found what how can we store things
that there are orders for pizzas for to
some planets so and they found out
quickly that the solution for that
after first writing something with
sterilization would be to store that in
map so they used met from string to
planet orders by the way planet order is
simply a list of orders that's for
simplicity because we want to hide
something working with a list would be
tough so let's see this planet orders
class look like as follow is simply a
wrapper for a list where it's where we
expose only some selected metals like
size or assign order is basically add
and we also have comparability so we can
select by size which planets have the
most orders or we can we have method
that mutates is it simply gives back all
the orders and clears the list so that's
the planet orders so let's implement it
further so we have this cache map of
this and they use concurrent hash math
because they want to have the
concurrency problem solved they think so
and they use atomic long for all the
total orders that the system contains so
it's like this so let's go
how can they implement place order so
place order to the planets to the
variant to the size oh come on that
should be easy we create an order so the
aliens alien developers created an order
like this because you see that was a
simple class order and they they have to
assign it to hashmap how do you assign
something to hashmap you know what is
the method to assign something to
hashmap smart put now compute if absent
because maybe okay
pooty say would we around a good answer
but we have the problem because if do we
assign a new order some something
already may exist there so we have maybe
to get something first from their map so
that solves compute if absent it means
simply if there is something exists in
this hash map take it if not created
with this recipe new planet orders and
then we can assign to it that's the
smart way how to assign things to the
hash map with since Java 8 the oil in
developers knew that us Java developers
probably should learn this also it
really saves you one if and some
troubles and by the way then at the end
they incremented the orders total
counter so how many orders in the queue
now interesting function how to select
the most demanding planet from there
from this hash map so for which planet
are the most orders so let's do it
let's blah blah blah blah blah list or
take orders from best planet how do we
do it let's say orders so list all this
result would be we take orders
we take entry set and from this entry
set we make a stream and then let's sort
it this stream this is a kind of tuples
entry set so we sort it by value the
biggest one on the top as you may be you
remember that those values are
comparable because of those are those
planet orders with lists of orders
insights so we've sorted now we find the
first one so the best planet out of that
once we found it we can simply take the
value from that and then we can call the
take orders in case it's by the way it's
optional in this moment from find first
so it's monadic approach the alien
developers knew how to do that so if not
in no planet was found in this area
because there are no others in the
system then we simply return empty lists
and it's like and then we decrement the
counter of orders because we know how
many would be delivered it's very simple
so there are also two most interesting
and business functions so let's go
further we have count standing orders is
how many orders are in the system
businessmen wants to know so this is
very simple we have this we have this
all orders total here counter that we
increment and decrement here so it's
very simple so right now the debug
function I don't have much time to
explain that but the developers wanted
to take a look at the system every time
so they want just to want to peek what's
there inside so simply they created some
supplementary structure it would be at
Apple if they used java slang but it
they didn't so they made it manually and
they had something like at Apple here
so by the way Planet Sumari sample this
class it means planet name and counter
how many pizzas so that they see at the
end what's there ok so we have four
basic functions place order take orders
can standing orders all done on a
hashmap so this system works in a
hashmap
and then simply we have some other we
have a server for that the alien
developers created a server with
rat-pack
by the way the great way to define
servers so with rest services that
answer to those four interesting
functions we don't have time to dig into
that anymore and then some things to
convert the inputs and outputs to
generation and some strange gaelic
pizza' wrapper that I will explain later
so at the moment they have system that
basically works on a hash map so let's
say let's see how it works
we'll go I have this system already here
in this this is exactly this code in in
the IntelliJ so that I will store it so
the system is started and now let's see
how it works so this is this is how it
works just a moment we should see
something on the screen
now the system performs quite slowly do
we see something or is it just a moment
oh we see that's the system so we can
not right now order somethings there at
the right side in the gray we said see
the dead back so let's order some pizzas
to earth so maybe I like Hawaii of
course the big one so I will order try
to Hawaiian pizzas you see there are two
pizzas to earth and maybe let's order
something to Mars maybe a margarita what
should they eat on Mars by the way so we
have like three pizzas and then maybe
there is a planet devoxx somewhere and
we devoxx will surely eat vegetarian so
so if we have like I don't know three
four pizzas to devoxx five pizzas I've
ordered so many so we have totally eight
pizzas in the system the pizza boy
should go to the most demanding planet
first so if I click here I should see
that he delivered to the box and you see
the delivery to devoxx argh done okay so
far so good
well this system working a hashmap it's
okay for them it works so you may ask
what would happen if if there is a
problem with a power like for the moment
I've just forgotten about plugging this
thing to my laptop so you know what
would happen normally in the system this
week so nothing wrong because after I
connect it and restart the system yeah
what would really happen is nothing
because the memory nowadays is
persistence so you see as everything
there about okay you may see okay sorry
that's a stupid trick who has a system
that runs constantly and you never stop
it because there are system failure
maybe windows need an update and restart
so of course system needs to be
restarted so let's restart this system
even though the memory is persistent so
I just stopped the system maybe I go
here I should see in a moment some kind
of errors so let me oh you see their
error the the angular application is not
able to receive the data from the back
anymore rabbit let's order something to
the planet I don't know Pluto and maybe
Hawaii large it in fact didn't work so
the system is not working you can trust
me
but let's now start it with IntelliJ so
I start it again and what I see oh my
god
the all orders are there so of course
there is nothing for Pluto because the
system didn't responded it wasn't a life
at this moment I can order it right now
but the data is there why you think why
was hash map persistent because of
course I lied to you so I skipped one
interesting thing called Gallic pizzas
so after they implemented this garlic
pizza server with on the hash map with
four methods they also implemented these
Gallic pizzas service these four methods
once again but this time very simple
with using something called persistence
controller for the project from project
element which and basically each method
like I know place order they use it in
this way on the controller they execute
simple lambda which basically delegates
this call further and nothing more so
you see that every business method like
take orders from base panel count
standing orders or get balanced summary
is some kind of delegation either its
execute execute on quark and query or
query and what is really does it in fact
stores this lambda with all parameters
on disk so you know I can even show you
that on a disk there is a folder called
Pizza where you see journals and
snapshot in the journals are simply
written that place order was called with
these parameters it's simple like that
is a Java sterilization of lambdas and
when the system is restarted it looks to
this folder and it if it sees something
in the journal snapshots then it simply
does it once again so it's it's simple
even sourcing if you know this term so
but then comes the another reality what
we have to change the system so the
businessman doesn't trust pizza boy and
more he wants to know where all those
orders were gone because if we look at
the system we see what our orders for
now but he doesn't know where the
delayed delivery I don't know like
yesterday so we can try to do this let's
here implement a function I don't have
time to configure something like
database or file so I simply print it
print in August screen every time the
pizza is delivered we'll simply put it
on the screen oh sorry that would be
looking stupid okay right now we have
some system.out.println so I will just
synchronize it with the IntelliJ and
right now I will stop system in IntelliJ
I'm sorry for a moment and you should
see this code here it's right here this
pizza delivers do and I will do one
funny things I will delete something
called snapshot snapshot is the recent
state of the system for performance just
just to restart it faster I don't have
time to cover this topic but right now I
will start the system and just take a
look and this you see pizza deliver two
div devoxx even though I this operation
one was done before it's not now printed
it means I can restore everything that's
happened previously so it's a very great
feature because maybe at this moment you
want to put this information to database
because you need it for reporting data
warehouse whatever and you can always do
that later even though the system is I
don't know working like phew for days
yeah and simply like that you'd never
lose any information because every event
that happens to the system is stored so
let's maybe take a look what would
happen if I you see the data is there
and again if I deliver something I know
to earth again I order something to
earth again like Hawaii median one so an
F there should be right now three pizzas
and you should see exactly that in the
console it's right now I ordered if I
click here I should see in the console
that in exactly there was something
delivered to Earth it works
so this is busy
how the system works even though the
guys didn't use any database they main
generally implemented the system on a
hashmap and it works its persistence
that is quite durable because you can
change it you can restart it
it all works so you may think that maybe
okay that performance would be not great
because looking for the best planet on
this hash map and Counting what's the
the best thing there is quite
time-consuming operation so of course it
is you can use priority queue to do it
faster and in fact in the longer version
of this talk I consider this scenario
how how performant the system could be
and that's the results I wanted to build
something that performs on this laptop
more than ten thousand pizzas per second
it means not only orders but also with
delivery so whole transaction from order
to delivery so I've implemented this in
this Java I will say Java with
persistence simple persistence Java with
hash map and Java and classically
probably that you know Java with
hibernate and MySQL quite tuned
benchmark and all the code is on a
github you can see it and that's results
with this simple approach everything in
memory with this simple persistence I
achieved something after really easy
tuning 60,000 pieces per second it's
quite an amazing result the best I
achieved with hibernate plus MySQL
without JP a really to make it as fast
as possible was thousand pizzas per
second just a big difference and it
comes to rate I was looking at this
constant accordance operations really
counting that was simple reading one
long so result is even more crazy like
12 millions to 6000 tweets per second
but in reality in normal application you
would expect that writes are five does
the worst result I've ever seen 200
times faster and reads a hundred to tile
two thousand times faster so reach are
basically better if you use this
approach simple in memory but persistent
so what I read it it's I at the price of
one server or even one notebook I have a
performance like 50 service just take a
look at this picture and without the
problems of I don't know class
connectivity and all those things or
just at one machine so it's great so are
there any problems with this approach so
of course there is one problem you need
to do for developers and it's really
hard to find some Java developers even
here that probably know about things
like compute if absent priority queue
concurrent skip list map copy-on-write
array list because typical Java
developer developer nowadays only use
getters and setters and have no idea
about such things and of course doing
Java concurrency it's stupid it's
absolutely not the language done for
concurrency so nobody does it it's a
scary and datum one thing for instance
if you have in a moment to to make
migrate data you typically are used to
write me migration script escalate which
is of course great if you would have to
do it in Java right in those kind of
system it will be scary so nobody likes
it and of course some people say this
system in one moment it keeps all of
this in memory in hashmap so it needs
huge memory so it's no-go for most of
the system all come on one terabyte
nowadays you can really order even up to
five terabytes you can order such
servers so it's really not the biggest
problem is only I don't really know how
JVM performs on one terabyte way till
now I haven't really chance but up to
hundred gigabytes it's not a problem and
you can you can count you can store a
lot in one hundred gigabytes and one
problem does those system are too fast
in fact in this presentation I used
thread sleep to convince you that
something is happening because if you
click on order anything happens
everybody's thinks that the system is
fact nothing really works so I learned
that I have to put thread sleep on a lot
of places to convince users that
something is happening behind so ok
advantages of that of course testability
that's in fact the most the biggest
advantage I see because this system is
plain Java doesn't need any machinery
so you remember TDD workshops where they
show you how to test two plus two makes
four it's so easy then you go to the
your regular job and you see oh come on
I can do it with database and everything
right now if you build system like this
you can do it with persistence without
persistence in in fact on this github
kote you see that I exactly test the
system with first standard without
persistent with the same code this is
exactly this code on the screen because
I used this common interface so I can
test all this just the logic and logic
with persistence in one place and it
works very very fast performance of
course that's that's most biggest
selling point but for me testability is
in fact way more important simplicity
you don't have dependencies to some
magic stuff like JPA hibernate
I don't know MongoDB whatever you you
think of and you can always as I showed
you modify the system later if you for
some reason need some data to put stool
I don't know reporting somewhere to data
warehouse you can always extend those
events how they process and store
something to database okay and by the
way this in some people some of you may
be held this system is exactly that's
even sourcing but I call this poor man's
even sorting is very simply than
sourcing and it you might use this as
introduction to the full CQRS you can so
sick or even DDD
so because it's it's way easier to learn
it with that simple upload approach so
there are alternatives by the way
because this is very simple system the
really interesting alternative that's
created who has heard about lagom okay
great so it's a Java framework
microservice effective blah blah blah
blah blah who has used flagon already at
least a little bit doesn't have to be in
production okay great so by the way it's
for restful micro services but at the
end use uses secure s and even sourcing
so if you if you work if Lancome you
basically work at the end with the same
approach and a couple distance is of
course the same things out salsa from
alignment in fact the session hour ago
was describing this persistent for actor
also user use even sourcing so it works
in the same way that we store even so
some people say oh that's just another
no SQL approach where you have
everything in memory but I there is a
big difference how you design the system
so from my perspective because in
databases if you classically or no at
squall SQL you concentrate on modeling
the state so that's my model entities
will relax
blah blah blah and that's my state and
that's how I would share it and this of
course is this problem if sharing state
is a performance and error problems
because it's quite error-prone even
something you concentrate on events then
you store events and you replicate
events and models you have more models
that are optimized for reads because of
that it can be incredibly fast and in
the system I found my model was in
memory projection of those events that
exist after every system I can every the
rest out of the system I can recreate ok
and I call this approach no DB or drop
DB that's my naming I used it for more
than 10 years and but people call it
simply even sourcing so you may find it
under this name and my summary for you
so who uses JPA so I my message if you
use JPA you are exactly saying you don't
want to mess with database great because
you don't need it because if you needed
database we will probably use something
way better for SQL like jlq or i parties
that you would use the real power of SQL
if you are trying not to touch it then
exactly you don't need it you don't need
a database maybe you need something fast
that works fast
and you don't need database specific
features you just need persistence and I
showed you how to do it with simple Java
and it's what I wanted to show to you I
have some of course you can start quick
and small with this arimin framework
it's on the github code is very small
it's something I would say this
framework for storing these things on
the disk is something you could do in
two weekends just like this it's really
not big code and if you are working in a
company that's I know service insurance
banking they will probably not be
convinced to do such to use such so
simple because that would be a problem
with too big productivity of the
developers so they would probably want
to use something like leg on dragon or I
don't know I can't persistence so thank
you are there any questions because I
have one minute yeah
mm-hmm okay so deliver expired but okay
how would i I probably don't know don't
understand the question how great this
problem is self in fact I haven't done
to show you on the gift card you see it
I store every time with an event its
original time stored and you can access
this time so it's in fact there is
execute method has you can use the
bigger version of that that has second
parameter the time out original event
creation so you can use that so exactly
the same problem is with things like
random you have to make the system
totally how to reproduce through this
bar in the in the same reproducible and
you you have to remember about storing
the time but it's done automatically by
this frame okay that's the problem I
know
so okay I don't have more time yes you
have to know how Java works and you have
to take care about this but by the way
the system doesn't have to be
deterministic it has to do your business
logic and in fact for some systems I'm
changing this so after restart they work
differently because that's a bug bug fix
so it's then I restart the system that
works differently because using the same
events it produces the different the
different value but that's mostly the
thing I want not the mistake
that's typically how I do break bug
fixing because I have all this scenario
which leads which leads to the back
start on the disk okay thank you if you
have more questions just ask me later
and with this shirt so it's fine too
it's easy to find me</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>