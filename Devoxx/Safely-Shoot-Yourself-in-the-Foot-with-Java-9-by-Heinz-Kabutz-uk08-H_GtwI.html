<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Safely Shoot Yourself in the Foot with Java 9 by Heinz Kabutz | Coder Coacher - Coaching Coders</title><meta content="Safely Shoot Yourself in the Foot with Java 9 by Heinz Kabutz - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Safely Shoot Yourself in the Foot with Java 9 by Heinz Kabutz</b></h2><h5 class="post__date">2017-11-11</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/uk08-H_GtwI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so I've been asked to introduce the next
speaker here if you don't know him this
is a mr. concurrency or dr. heinz
kibbutz all the way from the island of
crete to talk to you about how to shave
safely shoot yourself in the foot with
java 9 now Heinz is very famous for
tearing things apart I think one of my
favorite newsletters of his is how to
make java look like basic and and bubble
sort and basic and bubble sort and basic
and things like that so warm welcome for
Heinz and I'm sure you won't be
disappointed with this talk yet are
there so thanks good let's have a hand
for Heinz so these are the goals of
project jigsaw not enough Marcus still
around but there four goals the first
goal was to make the JVM smaller so that
we can fit it on - I don't know a pen or
something I'm gonna a toaster right the
second was to include improve the
security and then improve application
performance and make it easier to to to
maintain and work with it now that the
first one to me it's not really that
convinced that it's so necessary as they
might have thought because we've
basically lost the war against the
against the phones and yeah you know
there might be some small devices and
you know even for micro services you
really want to reduce your memory
footprint and classes are loaded on
demand anyway so you know so but the
second one I think is the real reason
why why we did this all through the real
the real selling point is to make Java
more secure and they gave us this
wonderful s security wonderful module
system and then we were just complaining
from the beginning until the end that we
wanted to break it right but we want to
have unsafe right we want that stuff and
so they they've sort of given on a
little bit for us and and we'll I'll
show you how to how to get around at no
ma'am it they also said that we want to
improve application performance
obviously they would say that they're
not going to say we give me something
it's gonna be slower right so you know I
don't really believe that too much well
there are some parts which are faster
and and they make it easy to construct
and maintain yeah of course again that
sort of the sales field of course they
would say that they would say they're
not gonna say it's gonna make it worse
and terrible and slower it must make it
something must be better otherwise you
wouldn't go through the pain of doing
this so what can we do well in the
beginning Java was supposed to be you
know really really safe and secure and
you couldn't get out of the sandbox and
I remember 16 years ago 6-7 Hoffy I know
really well because my daughter was
wasn't born yet my first order and I was
asked to do a course in Mauritius Island
off Mauritius and one of the topics I
wanted was how do you do how do you work
how do you do how does how do you
configure the co security manager and
Java how do you write a policy file and
that was the last time anybody asked me
how to do that right we would have done
K for this there's wonderful technology
for specifying exactly who can do what
who's not 2d perfection and who can't
and we don't actually use it because
well you know should work you know let's
just use it and so even though we've had
a lot of security in place from the
beginning we didn't really use it too
much now I'm in the early version of
Java you you were a bit stuck with if
you want to do campaign swap and things
like that you actually to write China
code and they didn't want to do that
anymore so they added I'm not sure
exactly which version force Java 3 or 4
something on they the editors pass
called sundar twisted unsafe now you've
obviously heard that name before
everybody's heard that name and if that
called it something like call but boring
dot network transfer no one would have
looked at the class right but because I
call it some miss can say everybody says
how do I use this I want to try this out
and this sounds really cool there's
another class called shade secrets dad
who's out of shape my own the student
agenda right if you've heard of it and
what you can do a shade secrets is you
can construct a string that has a
pointer to an existing char array
yeah that sounds interesting dealer it
doesn't actually work into have a nine
anymore because int over nine left
replaced chareyre with byte array but
the for Java nine you could actually
have two two strings that point to the
same char array and then if you change
the char array of course the string
would also try also change without any
security violations except for you know
well you shouldn't be using shared
secrets now unsafe was added in the JDK
in order to help the JDK developers to
do things like create objects without
calling any constructor to throw
exceptions even though you're not
supposed to like for example the new
instance method of class does that you
could make large blocks of memory in LA
and deallocate those as well you could
even you could contain swap of course
though some of the primary reasons where
this was being used
you could set fences that's relatively
new and in Java 9 no funny Potter's even
though they've told us you're not
supposed to use this stuff they added a
new method in Java 9 so you can release
native buffer resources so map byte
buffers and things like that so that's
that's of course another way to really
shoot yourself in the foot so how did we
get to notice unsafe as I said if that
call it Corbin or anything we wouldn't
have looked at it but um what happened
was there was a class called is this
class called concurrent linked to queue
and concurrent think you had a rather
boring implementation of using atomic
reference field updaters no these filled
up data's and suffer from something
called amnesia every time you call it it
has to see a I'm not sure molecular to
do this or not
alright and so it checks every single
time you call it if you allowed to do
this and so that of course is expensive
and and costly to always check whether
or not you're allowed to actually call
this method and so in Java 7 they
replaced this mechanism which worked and
with this new one which with class could
unsafe now unsafe had this mechanism to
protect it against
programmers where we need called unsafe
decane unsafe if your class wasn't in
the boot class path it would throw an
exception so what we did it was we
simply accessed the the the unsafe
instance using deep reflection so we
just bypassed the gate on safe method of
course this is all very nasty but and so
when this appeared in Java 7 all of a
sudden we saw wait a moment there is
something better than atomic references
filled up data's which by the way they
have improved them now now they actually
are very fast to but at the time there
was there was no this new alternative
and what we do is we say unsafe the
campaign swamp object this points to the
actual object and then we have an item
often what is this item offset
oh what's this here put ordered object
hmm that might be quite interesting
it's cheaper than volatile so you can
write some cool code with that too and
the offset is basically a pointer into
your other than the number of bytes from
the beginning of your object until your
field appears so it's nice point
arithmetic and you should try to get
this right if you if you make a mistake
you're going to change random places in
your memory which isn't very healthy so
this is how the code works and um once
the genie was out of the bottle it was
very hard to contain it to say guys you
shouldn't be using unsafe and peppiness
it but we but we want this stuff we want
to do this this fast campaign swap so in
Java 9 they clean it up so we've now got
something called a var handle and this
voice handle is is basically what we
call enhanced volatile it's it's one way
of cooling it it's enhanced fields and
it's basically gives you something just
like the atomic reference field of data
but without their media so what you do
is upfront you call method handles
lookup and it finds out from the context
of where you currently are whether or
not and you have got permission to see
that to see that plus and if you don't
have permission then it just throws an
exception and you get to have some I
think access it
option or something and then you'll
throw an error after that now the once
you've wanted to determine if you
actually love to do that then you can
use it and a performance is going to be
just the same as unsafe and so this is
how we set it up sort of just a few tips
normally we rename it by the same name
as the field but capital letter so item
is item capitalized pointing to the
volatile field item over here then we
can do campaign safe we don't have to do
the point arithmetic anymore because
we've now got a bit more but safer
mechanism to and I mean we can't
accidentally change completely random
places in memory or deliberately now and
the the wonderful points of Java at over
nine was to get rid of unsafe and so
initially they put it some secret
package and they forbade us from using
it em and they the whole point was to
try and get rid of it from Java to
concurrent because as you can see this
was in Java 7 the biggest culprit of
using unsafe and of course there lots of
people who like doing concurrent code so
we were all copying this and in Java 8
it actually got worse not better
you know we've got more classes in Java
8 and more uses more classes using this
thing called unsafe and and so when you
go to Java 9 the thought let's get rid
of this usage and it's let's make it
really small so they got rid of all the
uses of unsafe well actually it's not as
bad as it looks because inside java.lang
obviously using a lot because they've
got the VAR handle as a sub-sub package
of java.lang and var handles use unsafe
so this it doesn't look it's not like I
know it looks a bit bad and if you look
at the one you should look at is
concurrent and they they really have
have have gone for with a good example
they couldn't always get rid of it
because sometimes they've got a
bootstrapping issue where you you you
need a particular ass before the ball
handlers have all been initialized and
so you you know sometimes they have to
use unsafe anyway so um Java and var
handles
have the following they they allow you
to do sort of different strengths of
reading and writing on fields there is a
plain reading and writing it's like
writing a normal field and this on the
other side of the spectrum there's
volatile which is our strongest and in
between II for other ones you've got get
acquire set release which is not as
strong as volatile and then gets it a
take this one is quite weak
you do have for example tonic updates
are you sure that if it's a 64-bit value
that's written atomically not with two
halves unlike a plain field but you
can't really as gets it a peg four into
thread communication so you can't really
write the cue with gets it a peg but you
can there are other places where it's
used there those are a bunch of fences
and if you want more information there's
this document that Doug Lee wrote with
some friends now one of the interesting
parts of this is in how long adder works
and long adder is a class which is based
on another class quartz type 64 and they
use something called lock striping to
achieve very good parallelism and low
contention on updating the values
basically the way it works is that if
you make it long ad and you update it
from a thread because there's no
contention if there's only one thread it
would just have a single cell but as
more and more threads use this long
adder
every time you get a compare and swap
failure Kerr's failure it will increase
the size of the array until you've
reached some maximum which is somehow in
relation to the number of Hardware
threads you've got in your system so and
the soul objects are also marked with AD
contended and so I'll talk about at
quantities a bit more in a moment
another way to shoot yourself in the
foot and now one of the things which is
interesting is that the threads are
allocated to a particular soul but they
want to do it in such a way that it's it
that you don't have multiple threads
using the same soul with at least not
that often and of course you could use a
thread ID but the thread ID is just the
number which would increment and it can
actually be reused eventually at some
point so it's it's not that reliable so
the question is how does actually go
and and do it now and if you look inside
the Java 8 plus of stripe 64 so if you
go to long adder and you go up to stripe
64 they've got something called a probe
and this probe is used to decide where
it's somewhere some mathematical genius
stuff and then they decide it must go
into this part of the array now where is
a probe from or the probability from a
class from it gives it skips yanked out
of out of thread local random all right
now in Java 7 3 local random was a
random number generator based on the 3d
logo class they honored thread local so
each thread has had his own instance of
this of its own thread Locker random in
Java 8 they changed it and drove eight
the problem with having each thread
having its own is that you have to have
a hashmap look up every time we call
current on the thread local random so
they changed from Java 8 to instead have
a singleton of three local random and
they decided to store the information
for working out the next three dollar
random value inside the class thread ya
know that you're shocked now but it's
true so if you look inside thread
you know cyan't you'll see there are
there are some fields in here which are
used for for doing random numbers
sitting inside thread so there we go and
begin contended we'll talk about that a
little more later and
this thread like a random probe happens
to be a good mathematical number to use
for for forgetting a good distribution
of the threads throughout this array so
how do you get hold of this feel because
remember we need to get hold of it
really quickly we want to be able to
read the value as if it was a local
value as if it was part of our class it
mustn't have like expensive reflection
you know so it must be as fast as
possible and so that for that they used
unsafe and this isn't stripe 64 this at
unsafe
get int and you can see the probe they
did here with point arithmetic
access it now this is how they did it in
Java 8 and the the point of this of
course was was again to improve on met
the random numbers if you need ran
numbers you never use math.random
anymore that's a it's been bad for a
long time and and the the problem in
Java 9 that didn't want to use unsafe in
the early versions that did use unsafe
and then one of the things they did was
they moved over to having a method
handles lookup that was like a complete
you know God lookup could do anything
and access any values and they got got
away from that and now they actually
give us a method called private lookup
in right so typically you can only get a
VAR handle that's inside your class but
with private look at in you can actually
get a lookup that allows you to to see
fields outside of your control so let's
try this out I've got to drive a nine um
and we'll try and play with a bit of do
a string demo here so string demo and
we'll say var handle value equals method
handles those dot private look up in now
we're looking inside the class string
and the lookup here is the context from
which you're looking it up so this will
check whether what permission to do it
so basically we know I don't really have
the permission to do this and so is this
at the moment in Java nine will not
throw an exception understand we throw
that okay so then I need to do some more
work and it went through an exception
but it will print a warning
so private maker lookup in method hands
lookup and then we can say find var
handle on the class string sort of
string dot class and the name will be
value and the type of mention authority
is a byte array dot two plus because of
course Java nine the uses byte array
rather than char array
so a bunch of exceptions but basically
this gives you a voyeur handle know with
the vai handle opens its gonna ignore
those exceptions those warnings so then
what we do is we can save value not see
it we can say hello and then we can say
we're going to replace the value off the
string hello with the value
cheers alright and then we're going to
print out hello okay so what do you
think happens when you run this code
okay no it doesn't it doesn't print
cheers because you're not allowed to
change final fields with four handles
which i think is fantastic
I'm really happy that that did that so
they they're basically said you you you
can't change final fields you can read
them but when you try and change them
they complain and they say it's
unsupported operation you can't do that
we're very sorry well they're not really
sorry and there shouldn't be sorry so um
so there's another way we can do this we
can say object hello equals value dot
get hello
and then cheers now of course you know
what it is the object is actually a byte
array so now we're gonna do is we can
say system dot array copy from the
source is going to be cheers from
position 0 to hello from position 0 and
the length we can set array dot length
what Smith said no that's wrong one
thought get length of cheers which
happens to be six I think and then we
will print her to low then in fact we do
get cheers okay there we go so what I've
done is I've copied the bytes over from
the one array to the other right now
obviously you shouldn't be doing this
right please stay
don't take a fight off the slide please
if you don't fight don't do this don't
do this this is how you shwah how you
shouldn't be cutting job now this one
problem with this code anyone right who
knows what the problem is
yes no no no no none of that now the
problem is that it shows warnings that's
the problem right we don't see these
silly warnings so how do we get rid of
these silly one in so this is an easy
way you can just say add opens but
basically says you know I've put my
class into in turn into no packet and
it's no package no module so I'm gated
to say that anything in java.lang I can
play with as much as I want so let's do
that and then this annoying warning goes
away and then it will work much better
so let's run it again and we're gonna
say yeah and see now it works perfectly
problem solved right okay now another
cool thing we have in Java 9 is Jay show
when I first saw it I thought this is
going to be completely useless but it's
not as useless as we think and what you
can actually do is you can actually do
things you can actually write scripts
like like bash scripts in Java now I'm
going to show you a quick demo no moment
one thing that you need to do is set up
the editor vironment so that you have
you have your real good editor and also
the sloth up is quite slow especially
for you to start up with lots of
different imports because it does a
whole bunch of backward compatible Asian
now the startup speed is slow if you
compared to something like Python but
the run speed is blazing me fast
so for full scripting perp I know that
it's not desire to be scripted and I
listened to the talk yesterday but it's
you can still do it and it's pretty cool
for example what you can do is you can
make your first line to be a Java
comment alright drop a comment and then
you put in a the path to Jay shell so
dollar Java home binge a show and then
one of the disadvantages with the
standard J shell is it is that you can't
return a number from the from J shell
which you need if you want to do is
script
but if you say - - execution local then
you can if you says system exit then it
turns a number so if you want to use it
in scripting you can do that then you
say - - startup default printing is
quite a good idea and then I've got
another another file that I've called
exit which just contains the line slash
exit and to exit the script at the end
and if you start like that you can do
some beautiful hello world
just with jscript and here's my hello
world let me just get rid of this loop
here and it basically does mmm okay
looks a bit this exit on the first times
actually just wrapped around from the
other side but this is the first line
and if I if I do hello world now if I've
got Java 9 then it works very nicely it
prints out hello world and you can I
mean I know if you guys are competing
like dazzled by the speed of this thing
so let's try and time it hello world and
this interesting number that comes out
because the real time is 3 seconds but
the user time is 11.8 seconds because
it's doing the compilation of the f16 53
in the background with lots of threats
and lots of threads going on but you can
do some cool stuff for example you can
say new server socket 8080 and you don't
have to clear anything done it then
maybe semicolons that's the rate
European friendly thing I know your
semicolons are really annoying and good
Europe so then you can say dollar 1 dot
except which is waiting for a connection
and if I now make a knife and I say tone
it localhost:8080
then it's made a connection it's my
dollar dollar - and thanks to Patrick we
can now say dollar - dot Tron get input
stream dot transfer to the strawberry
nine dollar dollar to get
put stream and then if we go back to our
tal if we can say hello world and it
echoes everything back there pretty cool
so let's let's stop this icon press
control-c let's just kill it
percentage 1 it doesn't actually die
okay say there are a couple of little
things here and there but generally it's
pretty cool okay okay oh I've got a if
you like Java nya and Java I have got a
course in that there's another link at
the bottom so I want to spend time on
this okay so and you can also now in
Java Severn age we had this effect since
Java for we've had this problem that you
could map a file so you could take a
random access file get a channel you can
get a map byte buff and you can work
with that
so mapping was easy but you couldn't
unmapped the file which caused issues
sometimes and so you could accumulate
these things and they wouldn't
automatically cleaned up so there was a
way to do it in Java 7 &amp;amp; 8 but and
before that but it wasn't really very
safe but we aren't talking about safe
things here so I think I can show you
basically if we take this code and go to
Java 8 and we copy this in here let's
make a class called mapped test and
inside there we've got our random access
file I'm not going to close it because
I'm a Java program I don't have to close
anything and then we're going to say
here come on
ok throw the exceptions and import this
almost there
and in more exceptions naught comma
thousand so now here I've made the
random access file and I'm pointing map
byte buffer on to the first thousand
bytes of this far if it doesn't exist it
I'm going to create it and create a file
of a sort of size a thousand no and
let's say like I can say raft or close
closable if I really wanted to but I
can't say bath dot plus of course I
can't say buff dot unmet but let me say
map
this is kind of annoying so I've let's
I've got a little thing called clans
console which is waits for enter it's a
greedy modern code here and and if you
run this code and any connect with JVM
which fortunately still is in my path
path because they haven't taken do they
have taken away them driver nine but not
in twelve eight um now you can connect
to map test and there's a plugin you can
install that will show you the buffer
pools you can see here that I've got a
thousand bytes used by the buffer pool
so um even if I close now at the moment
I haven't actually closed it but even if
I close it this done that this buffer
the pool won't actually be released so
if I say here ref not close and in fact
if C dot close the mat byte buffer will
still not be actually released let me
close this here and restart it and
you'll see now if you go back to divert
a vm that even though i've closed them
it's not it's it's not a unmapped that
so the only time it on maps it is when
the phantom reference or the cleaner
gets gets activated and then cleans this
buffers the buffers still in use even
though I've closed the file it really
shouldn't be like that it's of dangles
around there so what I can do is after
us I wait for enter I could say buff
equals no and then you'll see what
happens when you do that let's run it
again so after then
so it's waiting now now if I reconnect
to this buffer pool I think it's there's
this one hmm
let's just restart this quickly it's not
working
and there we go that's the right ID open
and if we connect and we'll see that
it's going to have a thousand right now
I'm going to press ENTER which is going
to this is going to set it to null and
you'll see it's still a thousand if I
now go in our force a GC then it's gone
down to zero okay and then one of our
points one of the things we try and do
is to minimize GCS all right and so sort
of the one thing we try not to we really
need to do to clean this thing up so
there was this there's a streak which is
pretty terrible which we can say mapped
let's take the buffer and we cast it to
the action permutation plus so direct
buffer buff dot cleaner and then you get
the cleaner object back and then you can
clean it so I didn't have to set it to
none anymore we can just say let's just
get the cleaner from there and maintain
it now this is again a very very bad
idea but most of my stuff today there's
a very bad idea so we are keeping an
inline with what I'm doing already okay
so here we go it's it's connecting let's
open to this PID game and you'll see the
buffer pool is still there
and now when I press ENTER it has
cleaned so brilliant I've solved the
problem of the map bad buffer well not
really because you could shoot yourself
in the foot again with this quite easily
if for example after you say but I
didn't want to say something it's like I
gave people this this offer for my mine
job and I are course and people didn't
the day late who said but I really
wanted to subscribe and I said well why
didn't you you know so if you if you
press ENTER and again then anything
could go wrong I mean I'm basically
writing to some memory that doesn't
belong to me anymore
all right and if this was Windows well
okay
anyway luckily I'm not using witness yes
sir my machine is still running which is
cool now in Java 9m you you don't want
to use the teen in fact you if you
wanted to do this which you shouldn't
but if you did want to do this there's
another way you can do it in 2 over 9
which is like this first over 9 and
almost as quickly grab this class from
Java 9 8 which I won't show you ok and
so basically what you're going to do is
inside here instead of doing the cost
you can say unsafe don't get on safe but
if actually got inside unsafe hold it to
get that for me and then there's invoke
key Nemeth Adam drama night I'm in
Belgium right ok this is very bad code
and it was added in Holland so so it's
the same type of thing I invoke cleaner
it does the same it doesn't some extra
tricks but it's still s unsafe as before
and if you say put int then it's going
to again where I can burn right in the
same where but now because I'm using
unsafe it gives me a bit of a warning
through the fat goes didn't need that
anymore it gives her some warning it
doesn't matter
it sure did why doesn't give me money
and thought of gives you warning and
it's still it's still crashes oh because
I've turned off the warnings that's why
it doesn't give me a warning remember
remember I think I'll turn them off
maybe maybe they're just being kind to
us
okay now cherish the fame is also gone
and Java 9 which is the real pity
because it was a great tool that we
could use to find one or two interesting
things
it was certainly better than j console
well marginally better and and they're
all stuck away ik minus x1 h prof which
might surprise you because that's
actually also quite useful you don't
always have the possibility of attaching
something like Java dream to your system
but on the good side one of these days
we're going to have flight recorder and
to our mission control open-sourced and
then we can switch over to that so I'm
looking forward to those days now one
thing I try to do
of course I shouldn't be doing but
that's how I am is I wanted to mark my
own feel desk intended and you can at
contain that means that it's going to
make your feel bigger in order to avoid
the situation where you've got two
objects which are actually not related
to each other or maybe they are but
they've not supposed to be updated
together two different objects living in
the same cache line the cache line 64
bytes so if you have two objects in
there that can cause performance
degradation so there are some cases not
many but there's some cases where
there's a high probability that objects
will be constructed together for example
with the cell array when you're making a
cell array there's a very high
probability that the objects will be
constructed together in the same because
all being happening at the same time so
for that you want to make them a bit
larger so that they each cell has its
own lives in its own cache line so if
you if you want to do this yourself in
the past it will just be son miss
contended and it really was happy with
that but now if you have got your own
field here the compiler doesn't seem to
like it very much anymore they say
something like the JDK internal via
meditations not visible some others
Donna and and so we really saw that you
can do deep reflection and deep
reflection is we are accessing private
fields of other classes which of course
you shouldn't be doing but you know and
but this is different because here I'm
compiling against a class which actually
was public oh is public it's just that
we can't see because of the modules so
instead of doing deep reflection we
aren't we can do this on at the compile
time so this is what you do
you'd say minus minus add exports so
very similar to add opens we say add
exports and this thing allows you to to
have your packages or your modules being
able to access the the java-based attica
internal VM annotation and when you run
it you also have to specifically say
that you want to use it for your
code now you don't have to do this if
you want to have contended there's
another way which is incredibly tiresome
and boring a lot of a lot of work if you
look inside the black hole class of jmh
there's an example of how you can do
your own contended too you know but it
is a lot more work than just saying at
contended so add opens allows you to do
deep reflection add exports allows you
to have access on public classes methods
and fields
so add opens means you can do anything
you want basically and it implies add
exports and exports as only add opens as
only at runtime and exports is also it's
if compile time so both to be Ruby rused
in a version of Java maybe in our
lifetime some other changes Java 9 we've
got an ER doctor deprecated as he
doesn't agree Java 9 changes we've got
some new methods for streams which are
another nice way to shoot yourself in
the foot up to now if you wanted to fit
in a stream um it really didn't matter
if you did a sequential stream or
parallel stream either an autism
wouldn't it always be exactly the same
because you could do things at the same
time but it would it would work and it
would work whereas now it's not
necessarily so anymore
if you take a sequential stream and you
make it parallel with one of these
methods take wall or drop wall you can
have some really weird effects one case
sort of got a nice big out of memory
error and it's actually in the Java
Doc's so you can't even say but but you
shouldn't be doing this because they
said well you know it's but like people
asked for these mesas and let them
really one give it to us and innovations
that are kept just take these methods
but at your own risk
GC changes now these are fun and so in
Java 8 they're deprecated incremental
CMS and a whole bunch of applications
actually need that type of stuff now I
do understand why because they don't
wanna maintain a whole bunch of GCS that
not that many people use and but in Java
9 they threw down so it's gone no more
incremental CMS but we still had CMAs so
um that was deprecated in Java 9 so now
whether you like it or not you get to
have to learn to configure a system with
the g1 until something else comes along
because CMS is deprecated and who knows
Ben that will be gone now it's very easy
to configure g1 all you do is you sit
the maximum post on max me and you're
done
right okay that's not quite true but if
good luck with that one okay one last
thing
mmm quite a cool class to be half as big
integer and by the way Java 9 is now
able to work out a square root of big
integer which wasn't possible before and
with begin teacher they've got this
method called square but squee for some
reason they made private I mean who
wouldn't want square right but they
don't want a step square so their
squares only for them right but we once
Square so how do we make square public
that's the question
now easy we're in Jove 8 we could simply
copy and paste the class and then change
it to be public and then change pattern
this new version using boot class pause
drama line is a little bit more
complicated there are three steps you
have to do so let's have a look the
first thing is you to the copy and paste
now if your boss pays you per line of
code this is a good way to increase your
bonus okay so I've got a package a big
math and of course you need to make sure
that your licensing will work for this
and you can see here that I've got big
integer and I've got these square
methods of math they don't work because
of course square is private but we don't
really want to keep it that way so we go
to begin to Jerry we say come on a
control C and then we go here and put
control V and we've just got our weekly
bonus now there is a method called
square in here and squeeze is private so
to make it public how do you do it
what's easy to just make it public right
now it's public and then if we go back
to our code becomes a test you can
notice that it still is really annoying
that it marks it as not working so
there's a way around there too and you
go to your project settings and you
simply drag this to the top there we go
and now it's happy fantastic
doesn't actually work it because they'll
have to compile it and patch it a bunch
of other things but it's generally
fairly happy with us now so let's go
back to this so there's three sips I
have to write them down because I've got
to can't remember them all basically the
first thing is we have to compile they
have to begin to diversion because if
you try and compile it normally it's not
going to work which is of course great
they don't want to make it a little bit
difficult for people like me to do what
I want to do and this actually is
awesome the wrong package I think so I
need to move this and that was a mistake
let's move that into Java myth okay so
if I compile this normally recom public
integer it's going to complain bitterly
about this and say you can't do this
whole bunch of things it's not visible
and blah blah blah it we don't really
care about that and so what we need to
do is in the in the command prompt we
compile it and we create a patch and
then we want to use that patch in order
to run our code so open to compile our
code because now the second step is to
compile our code against the patch
integer again I'm going to copy and
paste this because I can't remember all
this stuff so copy and paste this not
compiles our code against big meth
against the patch we've created and then
the last step is to run our code against
the patch it used to be a lot easier in
Java 8 fact I'll show you the job wait
we've got time for that too and but this
is the Java 9 wisdom and here you can
see the big integers now generated with
a very big number that's the square
square square square square so it's a
lot lot more difficult than Java 8 and
Java a you could have simply done the
following let me just copy this big
integer test over and then we'll show
you in Java 8 ah easy does so maybe go
and again I've actually got the Java
meth in the wrong place so I'm not going
to show you it's it is a lot easier all
right and so any questions
got a few minutes
ah Kirk would like to ask Commission
we'd like to take a microphone please
Jeffers of him you want to say that
they've got a you can get it off or get
up or something
Jay visual VM gone visual VM still in
github right I'll get it from there
still a NetBeans project so the visual
VM is still around I'm not so sure
though whether it was necessary gonna be
vital to develop very much in the future
going forward so no it's so it's still
being developed okay so visual famous is
available via github but Gerogia famous
is gone any other questions or comments
yes good oh no it wasn't Java 8 right so
Java 8 you could you could get the
question about getting direct buffer
visible you see that they tried to stop
this in to have an island and they did
actually I think for most cases let me
go back to the Java 9 version and Java 9
if I did this if I did what I did before
which was to take the buffer and so I
cast it to a direct buffer and buff
cleaner clean this is Java 9 and I it's
it complains that it's not visible right
yeah I drove it it's important Java 8
anything do whatever you want you know
girlfriend but Java 9 they try and clean
this up to stop you from doing silly
things like this where you can end up
you know crashing your virtual machine
but I don't know it might be possible to
get around it with with Sun dot you know
importing or add opens exports but
really of course you shouldn't be doing
this but in fact this whole thing is
flawed they should have had a better
take
where you can actually unmapped and when
you unwrap it then you just get
exceptions rather than a crash if you
try and use it so that's would be better
right well any other questions about
java 9 did you know that in java aids ok
here's a puzzle for you it's a puzzle
seen before the funeral for another 5
minutes here's a puzzle and so here's a
class called sorted hash set right so
what I'm doing is I'm making a hash set
and I'm I've got a length of ten
thousand thirteen thousand numbers and
15,000 others in there and then I say
numbers the to string which iterates
over and generates a string for us and
then after that I make a tree set we
know the tree is a sorted set and then I
print out the length and I compare
number string to tree string did you
know ok this loss question who thinks
that this is going to come back as true
in Java 8 right who thinks it's gonna
come back as false and Java 8 ok and
some of you are like in the Select
undecided side which is okay and when
you run this code it actually comes back
that's true then job 8 surprisingly
right quite surprisingly because we all
know that hash sets are not two sorted
set but it appears to be a sword at it
and and the reason I'll talk about this
is I I spoke to some people at a course
and they said oh but it's actually
sorted and I said that's not and they
showed me no 200 it was sorted as a rare
moment and because it appears to be
sorted but of course it isn't it's the
way that they're doing the rehashing if
you take the same the same code and you
say Java 7 so 7 and you say Java C
sorted hash say
and he run it in Java 7 it comes back as
false as it has been since Java 5 it's
always been false since Java for know
since drop or two so Java - it's always
been false but now it is it is true
because they've they've changed the way
that the the hashing the hash map works
we into native and I have a tree when
the elements gets too large so you don't
have the problem anymore where you can
get a denial of service attack because
you've got too many entries inside one
bucket inside the hash reward it's a
it's less likely to cause a divide n off
service attack so umm a side effect of
that is that they've simplified the the
hashing function inside the hash map to
assign your hash code into a bucket
alright and but because I've simplified
it if the numbers are relative if it's
relatively small numbers up to about
65,000 you're going to have them being
in a row if it's integer cuz it's just
not one two three so if it's above
65,000 it's going to be false
Butler 7 if it's 65,000 you can actually
be true
now the reason I'm gonna mention this is
not to confuse you because a lot of
people might look at hashed it and say
oh that's cool Java aid I don't know
this is the definite made it sorted as
well but it's not right it's just it's
just a weird side effect off of the way
that they they're doing things and
something that Stewart mentioned his
previous talk was the idea of
randomizing hash said I think that's an
excellent idea to get rid of this type
of behavior people think oh this is cool
I don't know that he can do this that's
nice okay so that's it thank you very
much for listening to me</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>