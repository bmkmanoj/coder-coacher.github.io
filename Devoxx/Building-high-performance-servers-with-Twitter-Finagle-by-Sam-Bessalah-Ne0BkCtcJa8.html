<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Building high performance servers with Twitter Finagle by Sam Bessalah | Coder Coacher - Coaching Coders</title><meta content="Building high performance servers with Twitter Finagle by Sam Bessalah - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Building high performance servers with Twitter Finagle by Sam Bessalah</b></h2><h5 class="post__date">2015-11-11</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Ne0BkCtcJa8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello everyone so welcome to this talk
so my name is Sam bizarre my software
engineer i work as a freelance doing
distributed systems working with big
data huge small data soy yes so i'm
going to talk about delivering high
performance servers but that was the
first title of the talk so in the end i
came up with actually talking about
building high-performance or PC on the
JVM using vinegar so every time I talk
about our pc today people turn to
especially developers the time to look
at me with big eyes I mean what are you
doing doing RPC we have rice we have
Jason we would have XML I mean why I
want to do things like korba I want to
do things like rmi I want to go back to
this kind of stuff that's yes I'm going
to talk about obviously to people that's
the first thing that comes into mind
which is good old middleware or PC but
that's not the kind of RPC that I'm
talking about so why would you want to
use or pc today I mean there are still
many cases where we use rest I mean
that's I'll bet that's the wrong way to
use rest but that's still most of the
people many people are still using rest
as being an RPC using JSON as a service
station format and that's really not a
good way to go you want to use our pc
when you have full control over your
environment when you know your clients
because in a any distributed systems
clients that always the one actually
bring trouble when you can control your
servers when you know what you're doing
you know exactly I'm in private network
or in a network back control I can say
exactly what i'm showing to people to my
client I can control my servers I know
how my client can behave because you
never know what's going to happen anyway
so in that way using obviously makes
sense another way is when you need
predictable performance we want to know
exactly at this threshold I can I want
to have this kind of performance when
you on the internet you can predict that
kind of performance because you only
internet you don't have control over
your network I don't know exactly what
you're doing is a bit hard to do or pc
when you on the web but when you're in
an intranet on internal services it
makes sense to actually use or PC and
one other way to use obviously is when
you want to communicate between
different clients within different
languages weatherby you have it server
in Java involving scalar I'm gonna call
Jeff and scar you won't talk with Python
servers you don't want to use g'zone
over over the wire you want to talk with
PHP servers if you hate yourself that
much but that's really in that case well
it makes sense to actually use or PC and
one thing that RPG RPC brings is
isolated computation we can say okay
this kind of computation I can isolated
in the network and know exactly how it's
working there I so that way it's a bit
hard to do that with rice department
doesn't matter what from working but yes
we've obviously can do that and when you
have things like fan out and find in
distributed systems I come back later
about fan out and find out finding
systems so the RPC system that I'm going
to talk about this vinegar vinegar is
something that came out of Twitter so it
was meant to solve one problem one huge
problem that we had I think you guys
remember what it was was what will fail
whether where you could go at will ten
times in a day and still going to a
server to a system that's not working
that was a real pain because they had
this monolith in Ruby those heating
little database behind without not
thinking about the architecture that was
a big pain like them so they come up
with a solution that to use micro
services but you can see clearer that
you have a timeline that tendon calls
multiple systems down stream down with a
downstream is that systems meaning that
when you're hitting the 30 APR you
reading a graph using the user service
affordable service using a search
service you actually find it out you're
right from the API one core makes
multiple calls and those calls are
admitted between your timeline to combat
below with Fanning in your weeds and if
you don't have the proper
the story if you want to call these
services one by one it's a bit troubling
now you can think that ah yes but I'm
not clear but in many application this
is actually what you do you call in
multiple services and we have to compose
them to get a result which happens more
often than we think and in this case
using our PC is something that you can
compose make sense so Taylor came up
with vinegar so let's go to vinegar
vinegar is an acid furnace non-blocking
protocol agnostic meaning that i can use
JSON XML whatever I like as long as I
can support myself and plug it into
vinegar and it's a full stack platform
to build RPC system the good thing about
it is that unlike what you already have
in the job in the skull award things
like a car spray play they build on top
of actually high-performance transport
networking system coordinated this is
the fastest time the most use a
high-performance networking layer on the
JVM which is neatly not going to dive
into nitty but that you have a lot of
things that you use may today whether
from vinegar or you have web frameworks
if you a lot of services to the app
built from high hyper hyper from high
frequency trading to banking to
real-time bidding sewn it is really
provide answers it's really fast so they
built vanilla as being a way to compose
your application on top on fast reliable
and high performance net transporting
layer we come back to it level and the
guys I mean one of the guy actually
we'll start with vinegar Twitter his
name my wrist and bitch son and he came
up with this paper that is called your
server as a function when I vinegar is
written in Scala and it tried to be as
much as functional close to functional
programming poetic most possible
function are becoming comes with
drawbacks but yes in funeral to try to
keep those drawbacks a little bit i'll
have it to have your little less
consequences in the way use it in
productions they can remove this paper
what explain exactly how you bring the
server by composing functions
that's exactly what finna grip brings to
you we go we see a little bit later but
this is an ID paper to read if you can
go back it explains the philosophy
behind vinegar and vinegar is not just
the way to build high-performance
servers but it's also really prediction
already distributed for distributed
toolbox for distributed systems it comes
with a lot of features are not going to
dive into a lockdown that you have load
balancing way to handle bad pressures f
way to handle failure detection fail
over how to pool your resources and how
to depressing with a lot of frameworks
so if any girl is not just elaborate but
actually a whole ecosystem of seed of
libraries build on top of all the core
that is vinegar itself so it's not is
used by a lot of company two days and
this list this is just recent warm that
is our lettuce people actually advertise
that they using vinegar but you have a
lot more of them people either use
vinegar for something when you have to
build a proxy or something what we
handle a synchronous coordinating and
then dip use something else for the
website of the framework of the
application so like I said vinegar is
actually a set of application week on
top of natty as a networking transport
layer so what you have is actually a
transporting layer here on the type of
transport on top of which have a disk
picture that dispatches audio request an
audio incoming data to transfer them
into the layer you have a pool of
connection that handle the concurrency
of your connection when they come into a
vinegar they also have a way to a way to
bloat balance inside vinegar for your
clients when they connect to a finial
application and a way to build services
this is actually a a set of both one of
some of the main functions built into
thin air and the networking layer is
just a Nietzsche which is built itself
on top of Java mio it shows a pool of
connections between vinegar and needs
the pool of connection that is called
the event loop
and with these poor you have protocols
obviously some filters we come back to
this later on just to give you an idea
so you have nity a pool of connection to
handle connections that are shared
between I've never this is the
networking later so you don't want it
used to be that you would see need capi
creeping out in to finagle but this
exchange a little bit so we still are on
how we can watch services with mega so
like I said if you like the building
blocks when what code application you
have free concepts you have the concept
of futures services and filters I think
everyone is familiar with features here
right who knows features yes almost
everybody so it is actually a way like
if you know a kyle you have actors
actors to build a application as a way
of doing concurrency future is actually
a place whole world to do a synchronous
computation so basically have them in
the JVM in the Java API as well but the
futures infini galah found themselves
different from the future from scala
this can be a bit confusing at times but
they just what you have as feature but
implemented dutiful way they one of the
advantage that you have is way the way
the handle complex region and its dick
tend to be more performant in some cases
especially when you have to compose them
compose a lot of futures compared to the
one you have with you will like a future
or even with the Java future unless
using of course the complete about
futures that you have in the JVM today
and the bear are also our exceptional
error handling this is a feature that's
really interesting compared to what you
have other futures but see a lot of
things that you see in futures in
Twitter futures today are coming from
other other application it's a bit of a
pain to to maintain those kind of two
but with Nagel you will see that you
still have to keep your brain a bit
little bit split so to handle between
the scale award and the funaga were even
through the written in scalars one thing
you can do in future is that for those
with the functional programming they
basically monad so you can compare you
can compose them you can appear apply
functions like map flatmap and and
rescue to handle exceptions so a service
is just
it functions that take your request and
gives you back instead of a response but
a future that holds our response so it's
waiting for a computation to be done and
then you get that response back that's
how you write the service this is a
simple way this is the me service so you
just extend this color code you just
extend the service here you have an
applied meter as well and you build you
wrap your result into a future so it's
not blocking when you can't get from a
client point of view so this is what it
is and they a protocol agnostic and like
I said you can compose them fairly
easily so here I have 11 here oh sorry I
jumped the shark here a little bit my
slider a bit intertwined so filters I
said about 80 provide services that
filters actually adjust rappers between
inputs and outputs so you can give in
any protocol rapids do your
transformation and give something back
in return and they also protocol
agnostic so they can come from HTTP you
of rift or whatever else and like huge
roots decomposable as well so here how
it look this is I on implementation of a
filter this is how a filter is
implemented in finagle so come on yes
okay so just watch the last one type 5
filter here basically the request and
the response take the requests wrap them
into a service and give you back if you
sure that's holding your response if you
want to explode that one you can see
that the future is actually I said that
has four types you're in entry and
entering request that's right in your
response out that's done after working
is done a request out and gives you back
a response in so you work between two
and that there's some transformation and
give you back who is your way to see
them this is how you can handle if a
filter like say you want a timeout in
your application you want to call a
service and you want to
you just empty motor timer this is one
of the filters as I actually implemented
into vinegar but of course you can
implement your own and you will be right
to service this is the one we did here I
just creates a new service that this is
a dummy service and my server is going
to have a timeout filter and my service
and I'm composing the filter and V
service with the emden keyword so that's
a way i can compose my services and all
my filters to build out and to launch
myself i had just launched a future to
wait for the server to this is an HTTP
server so i just start this one and wait
for the server until it's closed this is
how you're not you think so filters are
really useful for example if you want to
implement retries you want to add a
logging filter want to add a specific
civilization what if you guys don't have
a lot of use of things that you can do
with filters basically is a way to add
things into Finnegan so clients planet
I'm not sure is clear so good plans in
Vidigal are actually full stack services
they actually some of the most important
places because they come with a lot of
features already you have load balancing
they have the own way to handle session
timeouts you have a way to monitor and
twist them and it did really come move
services where you can plug in whatever
you like but you do have some good
defaults on top of which you can build
so here how your implemented clients
basically it's just another service you
can serve it like as if it was another
server but the client is a server that
comes with a lot of bundled in features
and that to see how it looks like in the
end is that you have clients that hits a
filter that filters from the request
which ones from bit call the server the
transformation and do this we should
reach in back in the end that's a simple
way to compose actually services with
vinegar now vinegar like I said it is
protocol agnostic but of course it comes
in with some pre implemented
protocols one of the men protocol of
course is HTTP so that's an easy way for
you to bleed HTTP services that
sometimes you don't want to use HTTP
like I said when you an internal server
I want to use some really low or PC
protocols like the woods we have with
thrift for example which comes with its
own or piece implementation which can be
plugged to actually protocol now fifth
is natively actually supported by
teenagers so you just plug 15 to enter
vinegar and it used to be that to build
application within probably services
within finagle you had to go through a
different API so hopefully this is
changing so you have this message for
for example you want to build mice my
sequel services there's a way to
actually improve my sequel and call my
co new service that's the way they
actually converging to a new API where
you can actually have pre implemented
protocols called protocol the name of
Peter Paul for example here while I
called HTTP I just called HTTP X new
service and there are ways coming
actually to do that so fina girls
actually support all of these protocols
thrift memcache protocol readies HTTP
SMTP my sequel zookeeper the vinegar
uses eq zookeeper for a lot of things I
come back to it and another protocol
which is max max is actually our way to
the multiplexing of different protocols
for example it's it's a bit hard
sometimes when you have servers we want
at one end point to receive different
calls so different calls from different
protocols so for example have one
endpoint here I want to read data coming
from a Facebook API in fifth from
another Facebook up here that's flowing
at me G some data from another google
api and doing them doing them a
synchronously and not blocking and
that's something that's a bit hard so in
order to do that you need to go into
allen if he knows will OSI layer
networking layer that's filled with a
seven layer she's at the session layer
actually so it's it's a protocol that
sits there and in that lets you actually
handle multiple connection and
beautiful protocol into one single and
fun and it has some really good things
billet alien-like way to manage head of
line blocking which can be with hard it
bit hard sometimes to manage because
that's things that really comes to that
would cut that we that we have a problem
in production services and it helps you
actually maximize the way you're using
your bandwidth so Finnegan works is
actually an implemented a 944 lepra
interface on top of which we can build
other protocols so one of the men
protocol today built on top of niagara
milks is free max so you can multiplex
using the 5th server itself different
protocols on top of on top of vinegar
that's if you think and another one that
i want to talk about is vinegar cereal
cereal is actually a short word for
serialization basically only when you
inside behind the eye firewall or you in
a controlled environment you're doing
the RPC you don't want to do that with
Jesus and you want to use binary
serialization format so whether it's
Avro portable thrift I don't know
whatever you want fina go let you
actually plug your own serialization
format so you can have a rule protocol
buffer and vinegar syria is the library
that lets you do that for those who do
skala that's something called s codec
they let you actually do the same thing
and ESCO they can be plugged into
vinegar Syria as well so you can
multiplex over skylab a civilization
from so yet is what I was talking about
why you want to use binary format well
because if you use text based former you
spend a lot of time actually just doing
Jesus and civilization dissertation so
if you can't avoid that well you don't
do and one other thing in Finnegan is
service discovery Finnegan has a lot of
projects one of these is called
spherical silver sets so it's using
zookeeper instead to do service
discovery so basically you register a
service within zookeeper and you can
actually rutila look it up by using
server sets a with
acts as a naming service or something
close to that built in top of zookeeper
but nothing nothing like four B's
forbidding you to actually build service
discovery on top of the on top of other
platforms so finna go like that we've
seen there are a lot of things in
cynical but physical if you want to go
if you want to build service we can
finagle it can be a little bit hot wire
all the services around you want to have
administrative and that means an admin
interface you want to have a different
things to actually build that so Twitter
came up with something called Twitter
server which gives you a template of
service builds on top of vinegar so this
is how to rebuild the server and it
gives you flags for configuration a way
to do proper logging and way to monitor
your metrics and give you an admin HTTP
so for example one way you can see okay
okay so this is for example a this is
adam is something that pull up from
production services just removed if you
stuff so this is a twitter server which
is built on vinegar so I'm not seeing
anything called vinegar on it and using
the max protocol but for HTTP I've added
some handlers so I can have multiple
protocols here but I'm just going to try
one and I have a service this is a
service that takes a string in Jason
does the transformation and gives you
back your last string this is not
efficient but just for the sake of the
to see how it looks like so I've
implemented the service this is a reply
method address the world here gives back
a future will good so let me start this
oops will be too small so here I'm gonna
launch the server let's hope it works
please go good its color so it takes its
time to work it's not really in a rush
good so here I have started if you
negotiate with your server you have an
added you can see that a lot of Adam
endpoints showing up here and I'm gonna
heat it with some some requests for
example but before I hit your request
i'm going to come here DC here i have an
administrative actually interface that's
building to finagle so i can see in
prediction life behind see what it looks
like so for example you have a lot of
matrix jvm uptime number fred collins i
mean a lot a real ton of matrix so i'm
not gonna go into hole into all of them
but just to see him live what it does
this is a way to do tracing its using a
framework called Zipkin but i have not
plugged so just to see i can monitor
over the GC have a DC load in real time
see what what's going on in the heap the
number of a precise of heat that's being
used right now in real time let's hear
it we have some we saw with some with
some requests ok so now i can see that
it's changing this is the number 11 size
of a hip that's being used in real time
and in the meantime I can look here why
Cannot ok ok Dec the garbage collection
so you can do some guy some GC dumped on
analyzing me with another tool that's
provided it's called pc pc proof and i
can see how my server is behaving in
life so this is the load each other you
how to surf is being loaded how it's
changing but number of requests that are
coming in so you can see in real time
how it's going this comes really handy
especially we want to deploy
microservices and you want to tune your
services in real time so i have
something like what 10 file 15,000 to NC
the number request actually coming in
again if you're running things for
example microservices independent going
to occur where I run services in
measures most of the time so I want to
know exactly to troubleshoot what's
going on at your own service I can hit
one of these endpoints and see exactly
how it's working so I leave it at that
and go back to the do is slow
okay okay that was Peter server that
what it gives you and I've seen that
work a lot about finagle and Scala but
you can of course you can do to vinegar
with Java as well this is what it looks
like this is not java 8 so it's not as
fancy with long does and yes but still
so this is a way you can read maybe this
is the old API often a girl actually
because they haven't changed with Java
API yet so if you want to be safe just
use with scholarone it's a bit hard who
I or all the all the vinegar will appear
now finagle of course can be hard one
you just want to build API services or
HTTP he arrest if he as you want to do
something else something they want to do
it very easily don't want to build or PC
nothing aguila to build this kind of
things too so Twitter came up with this
little frame open library called
fenêtre I don't know anybody knows
Sinatra here not the single one not the
single guy I mean the framework in Ruby
that does yes so basically is inspired
by by sinatra so it lets you build HTTP
services on top of henegar so it's a bit
its speed search for a bit a little bit
hard to maintain in production but it
does the job so it can it has this idea
of controllers and service and servers
so this is a simple API that lets you
build the control that says hi into an
or gate 10 / and then point and the post
and let you post hi this is exactly how
you do it in Ruby if it was really but
something close to that you would
control it's a bit easy and you with the
server by adding filters like infinity
edges to them with logging tracing and
all the things you have so it's not that
hard and there's another one called
Finch which sits between finna try and
finagle which is for those who really
like functional programming if you're
into things like shapeless generic
programming the way you handle your your
data in a very functional way this is
purely functional wrapper on top of
vinegar HTTP so it lets you build rest
api is just for HTTP i didn't say but
that for is
for red for HTTP but also support
thrifts so you can do both but Finch is
for stp all right rest aps and it has
performances are really close to up to
finagle to finagle itself so it's really
fast one other thing is Zipkin Zipkin is
a way to distribute trace and i think
it's it's built it was bit by twitter a
long time ago but now it has moved to
something called opens it kin so it's
really open source is not controlled by
twitter as well not much control
bacteria so it's an implementation of
the google paper called dapper so it's a
way to trace how where your system is
slowing so this is what it looks like so
basically you have multiple services
over there and from each services it
gets a sample of all your log and all
your requests and let you say like and
let you see exactly water your service
is taking too long to be here took to
complete so you can trace all of your
system so it's it's a nice tool to have
and it's built in within peter server
you just have to launch it local
container and actually see how it does
the job so you can plug it it well as
well into the eight-minute rehearsal
twitter0 so nice to have button algo is
not perfect of course it's a bit it has
some really not so up healing properties
or for example because it's stuck to all
versions on native this is due to how
twitter is slow to move to new version
the big house or since the metadata
primary developers of vinegar so
curently vinegar is packed with nicci
free but it's moving to nietzsche foo
but Nietzsche already have 95 in beta
but hopefully we would what's nice is
that when nate see developers actually
contribute back or port back a backboard
most of all most of the work that's done
on 85 into native free for example
security features and one of the men
developer of networks at Twitter on the
funaga team too so the one something
happens exactly he knows that the fixed
up in the last versions since were six
number six that x versions so you have
some changing or some changes of api so
it's moving into a you don't have the
even need CPL leaking into vinegar so
that's a really nice so it's slow to
update and documentation is not so nice
so hopefully the meeting this is quite
vibrant and get aureum in on github so
people are very responsive and you
seeing a lot of a lot of things actually
being built around finna go like many
project so sometimes it's a bit hard to
find it together it is way around it but
yes it's moving quite well right now
really good so that was the demon I
wanted so so if you want to go to RPC
want to try something different if
you're doing scalar a guy's great a la
vaca if you love play or of spread as
nice but try finagle as well it brings
in we want to really go into Rho
performance it's really nice that war
that's what I had thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>