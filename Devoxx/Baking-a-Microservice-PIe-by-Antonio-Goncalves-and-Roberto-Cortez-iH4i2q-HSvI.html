<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Baking a Microservice PI(e) by Antonio Goncalves and Roberto Cortez | Coder Coacher - Coaching Coders</title><meta content="Baking a Microservice PI(e) by Antonio Goncalves and Roberto Cortez - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Baking a Microservice PI(e) by Antonio Goncalves and Roberto Cortez</b></h2><h5 class="post__date">2017-11-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/iH4i2q-HSvI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello ladies and gentlemen hello welcome
to our session making a micro-service
pie so as you can tell there's a play on
words the pie and the pie hope you've
got it
yeah welcome to Devil's Belgium hope
it's not too early for you it was a bit
early for us because we had set up all
these things so we were here at a very
early stage this morning I detect some
time to set up and we hope that you're
ready for this three hours deep dive
session thanks for joining us
hello guys my name is Alberto I'm based
in Portugal I work for this company
called Tommy tribe I'm not sure if you
heard about it but basically we one of
the companies behind Apache Tommy
other than that I'm being working a lot
on the software industry for like the
last 10 years mostly working with Java
technologies most Java EE in the last
five or six other than that I run my own
Java user group in Portugal Queen bruh
that's what I'm living at the moment I'm
also Java champion have running the Vita
book winning club we're gonna have a
session later in the afternoon if you
want join us as well and I think that's
it my name is Antonio I'm slightly older
than these guys so I've worked slightly
longer than this guy he runs the Coimbra
jerk somewhere in Portugal I run the
parish jug in the central of the
universe in Paris and I'm also a Java
champion and also come from the Java EE
background so today we're here to to
tell you a story actually we will this
three-hour session
it's basically talking
about our journey through the
microservices architecture like most of
you we will see later but we go from
customer to customer we do micro
services it's the new trends the new
place to be and we are always surrounded
by people
there's always an expert on the database
there's always an expert of the network
there's always an expert on security
there's always people around so micro
services tend to work if there's more
than 100 people involved but we actually
wanted to be what's so-called a
full-stack developer so we took those
raspberry PI's with all the network
cables with all you know with all the
things that can go wrong simulating data
center and you know we will explain and
show you and we will put you know micro
services into play in those pies with
network issues with the security issues
the load balancing and all these
problems and doing micro services when
those there's only a small team can be
quite tricky mm-hmm so we will
progressively build micro services
architecture as you will see it's quite
simple in terms of business and the
three hours will mostly be trying to
solve all the technical problems so we
have 9 demos and we will go from one
problem to a solution and then we will
eat another problem and we will try to
find a solution and we will eat a
problem and a solution yeah I know I'm
probably gonna end in a problem
so we will end up building a very basic
app we will show you but totally
distributed scalable etc etcetera
because it's a three hour session and we
will be covering a lot of technical
topics if you have a question ask it now
because if we wait for the very end and
you ask something from the beginning it
might be out of context just shout if I
have a question
interrupt us whenever you want we'll be
happy to answer any anything that you
might want to ask us right on the stop
on the on spot so I'm gonna show you the
final demo so this way you know what we
will be building as you can see here
there's a few colors as there are on the
raspberry PI's so I don't know if you
can see guys but we have orange red
purple and black so this is what we're
gonna put at the very end of the demo so
basically the black pies at the very top
are the clients so there's an angular
app but there's three injectors so we
have the three pies here in the middle
the black boxes are clients injecting
load then on the red ones we have one my
a one micro service the book API so it's
an API to create books very simple
there's two of those the book API is
when you create a book this API needs a
number so it goes through the orange
boxes where we have the number of API
it's an API that gives you a number okay
so in terms of business we have the read
the book API that needs the orange the
number of API of course we need a
central gateway we will show you why and
as you can see the purple we
you have the Gateway on the purple and
console on the on the purple we will
explain you what those elements are and
we have y el caso elasticsearch log
stash and cabana running on the map
because it can't run on the Raspberry Pi
yeah do you have any out team over here
no oh we have a couple of people from
the alkene right can you help us run the
Alcon Raspberry Pi because we need to
Jake to run to run it so it's kinda
impossible we got to run it on Mac so
the lk e is on our box okay so those
guys are sending us logs okay so i'm
going to show you the demo okay so this
is what we will be building in terms of
UI we try to made in you know an effort
so it's bootstrap as you can see it's
very nice as you can see and it's
angular so here I have this famous
number API so as I said it's a public
API I don't need to login and basically
if I heat it it just gives me a number
okay very simple so this API is running
there's four instances running on on the
orange pies then I'm going to create a
book so I need the book API here as you
can see I can view it so I do HTTP GET I
can edit it change things around so that
will be a put and a delete and I can
create a new book so here I'm gonna
create the Lord of the Ring author
Tolkien and as you can see there is no
ISBN number but when I create it there
is a nice a nice being number why
because the book API needs the number
API
that's it in terms of UI and business
now we have different things first of
all we have console we will show you why
we need that the console tells us where
all the bouquet P is and the number of
AP eyes are so what you can see it is
less to here there's not 8 this forward
to book API F and for number of years
these guys are sending us logs so we we
have a dashboard that tells us through
Poots exceptions error codes and it
should change every 5 seconds because as
we said the black PI's our clients doing
post put and delete so the clients are
creating books and deleting books
updating books that's why the dashboard
is moving and finally we will show you a
gateway because some API is need to to
be authenticated others are not so we
will show you how this works so that's
it okay in terms of business it's quite
simple and and and then we will mostly
have concentrate on the technical parts
back to the slides so that was the final
demo and we will be building that block
by block and we'll give you more detail
about the final me more when we get to
it so in terms of architecture of course
like everybody we do micro services we
have monitoring with LK you know a
configuration also we can change things
on the fly we will show you why
discovery load balancing the
architecture is completely stateless so
we can go to one API or the other okay
there's a load balancer there circle
breaker because we will show you that
sometimes things can go wrong and how to
fix that we will plug in unplug cables
and security Vaz I said some api's are
public others are not in terms of
hardware we need our Mac mostly because
we need to show you slides some demos
and because of LK you know that consumes
huge amount of memory and it will not
work on the Raspberry Pi and a way to
control all the raspberry PI's and we
have 12 pies each why each because
things can go wrong
yeah so we have 6 service that's the
orange and red pies we have the two
purple the infrastructure then you can
come at the break and have a look at
them if you want we have the four
clients that he load in the angular app
one router three switches and dozens of
cables that we will plug in and click in
terms of software quite basic Java for
the backend angular for the front-end we
stuck to the micro profile with some
extensions so in terms of service we use
Tommy and wildfly swarm for the web part
we use engines for the angular LK in
terms of software we will mostly use the
Netflix you know stack with Easter eggs
and ribbon so we will show you how
console for the registry and the access
gateway for the security using x three
access gateway and for the
infrastructure i pre at OS is running on
the PI so it's a very light OS mostly
suited for docker images
so that's what exactly allows you to run
docker images on on the PI so these guys
from my period came with is really small
image that you can flash to put it on
the PI so it's super useful to run any
docker image over there the only thing
that you have to worry about is that
since the Pius needs to run on a
different distribution you need a
specific docker image to run on a
pass-off for instance Java you need the
Java for raspberry pi to run over there
so you cannot just run the regular Java
same thing for other services so mostly
those PI is run Ipreo toys and all the
demos will be as building dock images
and pushing them pushing the you know
the images to the PI's
thanks to ansible so we will also show
you ansible we rely a lot on docker
docker compose too we might do a few
demos but that was mostly for us to help
us in terms of database well you know
there's enough trouble with the cables
and the raspberry PI's that we didn't
want to put data at the very end we will
tell you what we've used and what we
didn't use and we didn't do any heavy
data business logic DDD you know keeping
simple not concentrating on the on the
technical aspect so that's what we will
be using and building during these three
hours okay
let's start by quick introduction on
micro services have you heard of micro
services okay
oh and probably Museum to us who haven't
heard about Michael who hasn't heard
about Mike I know one that's awesome
do you know how big is a micro like when
father
month of gold no five hundred two
hundred ten to one just one single line
like place with microservices on a day
to day life okay you who runs micro
services in production okay you yep who
would like to run micro services in
production who would like okay we will
ask the same question after the talk
yeah and we will see let's see let's see
if you would like to do that who likes
micro services yeah because you can
charge more your customers yeah yeah who
doesn't like micro services no only only
two of us only well only two of us who
suffers with micro services just a few
okay so why what do people mean by micro
services and I think that you know we
don't have an answer and nobody has an
answer so we just went online and took
all the answers of the planet so a micro
service is a small autonomous service
were working together small enough but
not too small I love this one can be
written in two weeks not three two not
one
nope two single responsibility principle
Domon driven design examine all
architecture but I gonna mark attention
I don't know but I love it anyone know
what's an exec an architecture is oh
there's a please guys come over here and
we'll explain you but the the best line
I like is the one I wrote at the very
bottom blah blah blah so we won't be
talking much about micro services
because first of all we don't know what
it is there's also these two pizza that
fit in a you know a team but yesterday
night we had one pizza each so so let's
be actually think people see what weeks
and we're not eating yeah that's true
so let's be
series 4 just one slide why are we going
in that trend it's true that when you
isolate things and you make them small
but I don't know what small means anyway
but it's true that you can iterate
quicker deliver features quicker you
because it's smaller and the the team
can be more agile and go faster and you
can you know have everybody with you the
DevOps guys the database guys etc etc
you deliver business as a feature you
know was a service sorry that's what we
did you know even in our small example
one focused on one API and the other one
focused on you know on another API the
good thing and that's what we done is
you can scale services independently we
have four instances of the number of API
on the orange boxes and two vu KPIs on
the red ones so you can do that
depending on your load you have all your
logs you have all the metrics and more
and more littering and then you can
fine-tune things address unpredictable
loads that's exactly that you can
because the architecture is completely
stateless if we need more pies it's just
a matter of piling them and it will work
and also when you go to the cloud even
though you know the cloud can be an
expensive place so the more services you
are the more you pay but it's also good
nerve for that and we will end up you
know telling you where not to use or
micro services to because as you can see
as you will see it can be a bit of a
pain okay so let's start simple we have
shown you the final demo with everything
now we're going to be building blocks by
box and we'll tell you what problems you
didn't run to yep
each each section will end up with with
with a problem and the section after
trying to solve this problem
so let's that simple we're gonna start
with one API the number API and we have
one and you know regular client we can
do curls but we wanted something more
visual and we need the UI so we use two
pies one pie will have the number of API
running on wildfly swamp and another pie
will run the angular app running on
engines and now we're going to show you
how to develop run and deploy this
simple first step on those pies so the
architecture will look like that the
client will be running on a black tie
and the orange that's for the number API
raining will wildfly swamp so there's
several ways to develop my micro
services you know I don't know he does
drop the wizard drop with our users
couple Lagoon no lagoon just one okay
the relay detects that's quite popular
okay couple cool sprinkle boot oh yeah
okay a lot spring would we have to call
Josh longer then yeah
micro profile to profile not that many
not that many others I know you other
other other thing okay yeah we don't
there's a couple of other things that
you can use but we try to pick the most
popular ones maybe we forgot something
but so we took it simple for us because
we come from Java EE well we wanted to
be honest at the beginning we wanted to
write a few services written with all
different technologies now even know but
even know jazz because when you go to a
my
servus talk you know you have all these
beautiful slides saying pick whatever
language you want yeah I don't like I
don't I don't know how to write note so
if you have a team with 100 people
that's fine but to be honest the more
languages you have the more technologies
you have the more databases you have the
harder it is to integrate them so we
just stuck two very basic micro profile
because it comes from Java EE and we
only use you know in terms of code we
have nothing so we use jax-rs CDI and
J's and P because we send jeezum and the
micro profile comes with extensions but
actually we didn't take them all
we took the configuration we will show
you the micro profiles come with the
security else check circuit breaker but
we didn't use those we used the Netflix
things a basically the micro profile we
took the jax-rs endpoints and
configuration because we need to
configure our endpoints so that's why we
choose but and but again you know we are
not here to talk a lot about Java it's
mostly how to integrate those things and
so even for most of you that are using
spring boat you'll see that it will be
very similar on what we will do on a
screen good maybe we can change the
presentation or the constable screen
good yeah so number API let's start
simple a jax-rs endpoint in a race
number okay so it's a matter andum no
nothing special and we just do an HTTP
GET unnumbered slash book that's all
it's running on port 8080 for on the
local machine and then we will see how
we deploy them on the raspberry PI's
sorry guys it's for the voter Thanks
thank you
and that's important we won't be if
you're showing everything but this
number API will have to be accessed by
the angular app as well as the book API
so what we did is we created a swagger
contract and we generated the angular
and Java code we will show you so in
terms of code that's it you know the
number API is just an HTTP GET on slash
numbers slash book and it returns
math.random that's it and if the
microservice taro needs to be small yeah
and we build it in two weeks someone I'm
not free you know as I said in terms of
business we are you know it's quite
pretty simple we are running it this one
we are running it on well fly swarm so
for those who don't know well fly swarm
comes from while Phi J Bo's read at it's
open source modular that's the good
thing with Swan is while Phi so I'm
sorry it's it's split into fractions and
in this case we just need the jax-rs
fraction so think of it as a JBoss but
pretty small and at the end we will have
an executable jar instead of a building
a wall and deploying into JBoss we took
it upside down and we have an executable
jar I kind of kind of like spring good
with it yeah yeah same thing if we
have time we could you know even you
know tell you why jars are better in
development but terrible in production
when we use docker pick cetera et cetera
but because the images are small we took
that because it's simpler for us in
terms of development so that's the back
end one service running on wildfly swamp
and for the front hand I have a pretty
big experience in angular now
so I thought let's do those pages with
angular not me no so we choose angular
with bootstrap so it doesn't look too
rubbish because we had bad web designers
so the angular app will will be running
on port 8080 again we will deploy it
will slowly change ports and everything
it invokes you know it just does it
invokes the number of API through our
HTTP thanks to the swagger contract
swagger it's an important piece in our
architecture it's now called open API of
specification and basically it's a way
to document your api's so what do you
call what are the parameters that you
call what are the status code that it
can bring back so this contract
describes your API and its construct is
this contract is written either in jizan
or llamó and there's even extensions
you know one rotations that we can put
on our code either jax-rs or spring boot
and it generates automatically the
swagger contract so what have we done
we've just added API ok saying to
swagger this is the API bla bla bla bla
bla and we can give it you know
descriptions and so on and here we say
that we have one operation and again we
can give it a name each returns the
string or it returns an object it can
return a for for 200 so we pack
validations like that on our code and it
took us two weeks to do that and not the
very end it creates a swagger contract
so here we have the number API on
localhost 1884 number API slash ap
and then and then you go to numbers and
then you do HTTP GET and that returns
text/plain informs of a string so we
have documented those those api's
because then we have an ecosystem of
tools and you eyes and text editors etc
etc so the swagger swagger is quite digs
in terms of tooling and and the
community is quite big and so on so what
we did is we use swagger cogent so Swank
Oh Jen takes a swagger contract and it
generates code either client steps or
service in several languages because
we're gonna use the same contract to
generate typescript for the client and
Java for the book API so they can both
call the number API one line you know we
have the swagger code gen we give it the
swagger contract we say please can you
do some typescript for us and main it
creates that
so in our typescript you know what you
can see there's the URL of our API and
it creates a method called generate book
number because it takes the same name of
the swagger contract and here it does
initially beget and if it's a two or
four returns undefined if not it returns
the book number so we took this visit
this bit of code and put it in our pages
on our angular you hit the first wall
very very quickly cause you know think
of it we have one client running on one
server and the book API in another one
and you have the browser
and you want to Laxus the angular app
that calls the book API so the first
problem that you eat is cause
cross-origin resource sharing that's
like that you know we cross the
boundaries or the server and the first
thing you're gonna get is it doesn't
work and you look at your logs and you
go are ya it cause because number api
and the angular app are running on
different service there's several ways
of solving cause you know you can put
proxies you can do things if you stick
to jax-rs you can even put a filter each
time you evoke an endpoint it will add
cause others we chose the sublet filter
because it's easier and it's and it
allows to put cause you know adders on
everything not just rest so this is what
we've done on the on the number api we
created servlet filter and we just add
all the access controls and with that it
works
we just need to allow it on the web.xml
demo demo time i'm gonna do it locally
on my mac and then we will deploy it on
the path so what do we have if I go so
all the code is on github we will give
you the URL
there's demo one two three four five six
seven nine so we aren't demo one and
basically if I I'm gonna switch to the
so I'm not gonna show you all the code
because you know we just took small bits
on the slides so here I'm running ng
serve so actually the angular app will
be running on engines yet it's on
Express it's easier to to develop and
then we will package it into engines and
here I'm on my service so I have the
number API I'm gonna use maven and of
course I'm going to skip the tests so we
use wildfly swamp there's a plugin a
wild fly swamp plugin that will package
your war file into a jar file so here if
I look into target I have the original
wha
there is 769 Kay's you can take this war
and put it on JBoss on valpha all and
that's what we've done
swamp creates a fat jar with j JBoss
inside that's why it's 93 mates so if I
do Java jar and I run this this
executive all job for those who are
familiar with JBoss in well 5 we can see
you can see the same logs while I swam
is ready and I could do a curl but
because I'm very good at angular I
created a couple of web pages so I go on
port 4200 whoo-ha and here I just have a
blue button and when I press it it does
an HTTP GET at this stage I think you
can applaud because that's awesome to
get the button the right size there was
a big five to say
longer than do everything else and here
i can you know i show you the swagger
contract so you know as you can see i
can do a get on numbers so the Deemer
one is very very very simple okay so now
I'm gonna give you know I'm gonna give
well control to me yeah and Roberto will
show you how to take those things and
deploy in there on the PI's okay switch
awesome okay so for deploy is as we
already seen we have a bunch of
raspberry PI's actually have 24 of them
so what we already told they're running
appear to us so if you have some pie
starts at home they're very useful to
run this this this kind of things so
when you just do like a parentheses over
here I do love to develop on this
particular setup because that allows me
to quickly deploy stuff over there
probably is much quicker to deploy stuff
over here then deploying on Amazon Cloud
and it's much cheaper so like using tire
stacks probably like 500 dollars and
it's yours forever and you can do
whatever so you can just go and unplug
tables and see what's happening so it's
very useful to do stuff over there
especially when we packed with with
docker but we we've seen before we do
require some specific docker images to
run on the PI's because of the Linux
distribution and that you have to run
over there but other than that Java runs
fine pretty much all most of the stuff
already has raspberry pi images to run
over there so the iPod guys they have a
name jinx Raspberry Pi image they have
my sequel Raspberry Pi image they have a
console Raspberry Pi image so and if
there is none over there you can run
your own but most of the times you're
able to find a Raspberry Pi image on the
back or hub to run whatever software you
want one one thing that's important over
here is that we do use a local local red
three so I'm gonna give a little bit
more detail about that but basically for
us to push stuff into the points we use
ansible as well who here knows about
decimal okay a few a few of you just
gonna do a couple of ansible stuff for
people that don't know about it but we
end up being against four because they
have a good support for a talker they
have a these doctor plug-in that allows
you to push images to whatever wherever
already you have so it works very well
and so we're happy with that and the
doctor the doctor or the IP artists also
supports doctor swarm so we could
definitely have used both local swarm
over here but we prefer to use more and
more manual estable scripts with just
darker so we can exactly control what we
were deploying on each by for for demo
purposes but if you're doing like all of
these in production and if you don't
know what you're doing it cool
definitely have you stalker swarm over
here so the raspberry PI's we already
been for that so I'm not gonna repeat
that so for docker or build also
generates docker images for a number api
for the angular app so the inner wrapper
actually is packaging you into anjing's
docker image so you can serve all the
HTML and javascript and also on our
build we do provide a docker compose
file so you can run that locally or the
instable script so you can deploy them
on on the bias if you want to like have
that setup or if you want to run your
own setup you can you can definitely do
that and yeah for for building all the
docker images you use maven fabricate
plug-in so it's very useful plugin
allows you to like build multiple images
at the same build and deploy them to to
sucker a docker registry so doctor
registry we don't feel stuck up
especially because we're doing these
demos and within we do need to have a
first correction so basically each demo
that we're gonna do we're gonna generate
a darker image so I'm gonna do I'm gonna
do this for the first couple of demos
and then I'll do it offline so we don't
you don't see it all the time but the
idea here is that if you're running your
doctor right used to be locally then you
don't have to go online and grab the
doctor images to push in the pie so it
could be like insane thing I'm like I'm
generating doctor image here I have to
push it to docker hub and then I have to
grab it to docker hub to pull it back
here again to put on the pies it's kind
of like a way way too big of a travel to
have over here so doc Crower think with
is too slow for this kind of demo so we
choose to have a docker registry for
that and basically speeds up your
deployment you can just apply that to
basically pores like your own local
maven repository but for for docker
images and this one's on on port 5000 so
for building and I'm gonna switch over
here so I'm gonna start the build right
away I know this is black that lets me
so here we go I'm just gonna increase
this a little bit okay
so here I am preach at the top maybe
yeah oh yeah so this I'm here on on on
my demo one and here I'm just gonna do
like a plane so I'm just gonna run that
one over there so that's just an analyze
to run mvn clean install no test doesn't
matter but basically here is running so
it's pretty boring but just gonna do
this this one time and this basically is
building number API it's going to
generate docker images for number API
both to run on a regular box and to run
on the PI so we have two separate images
just for the base image because of the
linux distro but other than that the
images are exactly the same so so now
it's pushing two to the local jail well
when you see over there that's
pushing to the to the tour docker
registry and and also as you probably
seen maybe not
I'm running these in parallel built so
Chavez already done while note is still
building yeah well so basically you're
waiting for nodes over here and then
there you go
so so what we did over here we just
generated the distribution file for this
demo one which was what Antone is
showing show you on your localhost now
we have the docker images to run both on
your on your box are on the pious both
of the images were pushed to the doctor
registry in the drawing locally over
here and then when we push the animal
script for the pies the price will go
try to grab the docker images from the
local docker registry will just grab
them and update whatever is running over
there so I'm just going to run that
right now this takes a little bit of
time so I'm going to show you the the
estable script as well I'm glad she's
gonna leave this running so but
basically what what we're doing over
here is just gonna connect to whatever
PI I'm running on the angular app and
whatever PI I'm running with the number
API it's going to go over there it's
going to see if there is a docker
container already running if it's there
it's going to stop it it's going to
download the new version you can update
it's going to start that talker
container so well that's well that is
running I'm just gonna continue here on
the slides a little bit so oh can you
show the doctor yeah registry maybe yeah
of course so buckle registry so they the
docker guys they have let me open a new
tab over here so they have an image that
you can use so you can create your own
docker registry locally so it's not
anything fancy so if you go over here
you can see the catalog of the images
that are around the repository which
basically is just a JSON response so at
them at this time you have a
posit Oracle by killing baking angular
baking book API baking number API the
biking simulator and one image with the
try stream access gateway one of the
things he also done over here to
simplify that we didn't version or
darker images so we cool I've done that
for a version for each demo but the the
idea or there is that we will just fill
up all our dock arise to get all these
versions so what we do is we'll just
smash whatever the community is there
with a the latest version and it will
work with just fine
so let's see if these are is already
done so yeah so the communities are
already pushed to the pies I'm going to
show you I can see this winner in these
two images yeah so you see you see like
sphere in green and yellow so the yellow
ones are the ones that were up there is
and the green ones were not up there it
is to this syntax or this is behavior of
ansible
I'll gonna tell you a little bit about
it so let's go here to the slides again
so for in suppo we can definitely
automate all the tasks with that so
let's just say if I want to see all my
pies I can definitely do like a ping all
to all my pious and I see if they our
hour running so it shouldn't take long
hopefully there you go so we have 12
pies I'm gonna definitely able to ping
all of them and and then you use a
playbook so the playbook is just a list
of tasks of ansible
that allow you to just say hey i want to
run this playbook and I want to run this
list of stats tasks over there so
sometimes it includes not only running
it upper image but sometimes creating a
folder to copy files over there then we
can expose the docker volume and stuff
like that but for this particular demo
it's just very simple just in docker
image that we put over there and that
that's it so this is just an example so
for those that are not familiar with
ansible you start with a with a host
group so
host groups is you have something called
a host file and in the host file you can
I'm actually gonna show it over here so
it's just a little bit easier there you
go host nice time for idea to do some
garbage collecting okay I nevermind
let's see if we different covers No
anyway the host files just a way that
you can set up let's say you have like a
group in this case called services and
that services section I can say the
services are PI 1 2 3 &amp;amp; 4 those are the
host names of the PI's and then over
here I can say for all the for all the
the PI's that belong to services I want
to run this task which is diploid number
API and then it uses the docker
container plug-in offensive all you can
just set up every every every slide
instead up on the on the docker command
line you can set up over here so you can
set up the docker name of course set
what docker images you're going to use
but set up the container name if you
want what's the state of the docker
container if you started it just gonna
we start so you cannot see it over there
but it's a pool so the pool equals true
means that okay awesome
learn your thing over here but basically
the pool will tell you ok I want to try
to search for a new image of these
docker image on the docker registry and
if it finds one it will just download it
and and update it and in the end you
have like a 1 so it will just basically
it will fix this deploy to that
particular host name on the on the
Python this case will be point 2 pi -
Graham - servers tosh.0 one and the
restart is important because when we
push a docker image into the PI we want
it to to start yeah
so so the point of the pies we we built
these these deployed gamma file which
basically just imports that that
particular one so it will be important
for the later demos where we have
multiple things being deployed and then
it just use this command and Sybil -
playbooks you say it
what's the llamo file which has all the
tasks that you want to run and you say
which what are the host files that you
want to use so you can have like
multiple host files as long as they have
the same groups then you're able to
change the host names very easily on
where you want to deploy so we're going
to show over here on the pine exactly
the same thing that Antonia shows but
hopefully it will work on the PI's so
now I'm going to go over here to the
store and okay not found but this is to
be expected just need to refresh it a
little bit okay so I'm not sure you can
able and you know I'm not sure if I'm
able to increase this but there is fine
- point dot zero one over there on the
on the address and we have stored in
more one over here so I can do exactly
the same that Tony was doing I can grab
some numbers over here and to actually
show you that this is actually running
on the PI's what I'm going to do is I'm
going to this other terminal and I'm
gonna SSH to one of the to the pilot
world where that is running so as you've
seen on the a civil script that was
running on PI - Brown - terawatt one so
I'm going to search over there and gonna
put passwords ok so are you guys able to
see this yeah okay so I'm gonna do like
a talker yes
now I'm able to see that I have the
biking number API which has the version
raspberry pi in it running over
here he is coming for a locker from
docker registry the local da graça sera
that we just created over here set up
things running on port 8080 for and
let's let's show some locks so let's do
dr. log staff so generating a book
number this was at eight thirty five
fifty nine let's just generate a couple
over here to see if that log changes
yeah so from 35 to 37 so we are not
flying yeah we are not line is running
on the PI these are all running on the
PI actually not sure which I'm gonna I'm
gonna do like a small trick over here
I'm not sure which are you mad and maybe
you don't do that the network
never fails okay let's see if I'm able
to grab a book number now let's go
numbers and fantastic it it felt
fantastic just the cable so well that's
just to prove that I was actually
running on the pine don't know what the
very end we will plug in and plug things
with the load it so no actually it was
about to recover so I got the book
number now Wow how clever we are okay
so as we said we are building things
slowly then it will go at a faster pace
but we want you to two of the bases
settled we have one API and one anger
app then the entire idea is we want one
micro service to talk to another one so
we have one number or API that gives us
number now we're going to introduce the
book API and we and remember when we
create a book when when we do an HTTP
POST on the book API it invokes the
number of API to get a number
book API invokes number API and we still
have the angular client because it gives
you a bit of visual and I'm proud to you
know do angular and show the world that
I can do front-end design and so we're
gonna use three three pies how do we
deploy and make it run so the
architecture now will look like that we
still have you know the clients had the
black pies so we have the angular on the
black now the angular will be able to
still go to the number API but what we
want now is to go to the book API
running on the red PI invoking the
number API so that's the architecture of
the of the demo to so microservices
needs to talk to each other there's
plenty of ways of doing either
synchronously or asynchronously reactive
messaging in our case we you know we
made it simple we just do HTTP GET okay
so the two services talk through HTTP
how do we talk being HTTP from one
service to to another one well there's
several ways to choose from you can do
it by hand use just an HTTP call you
know what Pachi as the famous HTTP
client there's of course a jax-rs client
api that we could have used because we
are using jax-rs but we didn't we use
next flicks fane and we will show you
why because you know at the very end
you'll see how well it integrates with
each districts and ribbon so we didn't
do it by hand or using the jax-rs api we
are we are using Fane for for this call
what is fine
fame is a Java to HTTP client you know
it's written in Java and Netflix has
plenty of tools written in Java it's
inspired by all the guys you know the
HTTP client from Apache the jax-rs you
know
just an HTTP call but as you will see
it's slightly more clever it reduces the
complexity as you will see just one line
of code
it works with juror jersey which is our
implementation actually and it works
with rest and soap we use it with rest
so the book API
it's a jax-rs endpoint like the number
api same same same kind of code it does
crud on books so actually there's an
entity and a database in you know it's
in memory but there is a DB so we do get
post put and delete on slash books and
the book API is running on port 8081 so
we have 80 81 the API 8080 for number
API this is what the book API looks like
so for those of you know jax-rs we go on
slash books we inject the repository
because we need to put stuff in you know
in the database and when we do get with
an ID we get one book when we do a get
it returns all the books that what you
see on the page and what we will be
using later is the post so at the moment
you know we just I take the book I
persist it in the database and return
the URI of the book and it's here that
we will put the code that invokes the
number API so a basic rest endpoint this
one is running on Tommy
so number API while fly swamp book API
on Tommy
Tommy for those of you don't know come
from the Apache world so Tomcat and all
the Apache be Val and open JPA and so on
it's open source and it's supported also
by those guys the community but also
Tommy tribe
and same thing we will be using the fat
jar approach because it's easier in in
development it's a you know it's not
good for deployment
but for development it's easier and
again we will have a swagger contract
will generate some code for the angular
we do the same so here the swagger
contract is longer because we have post
put and delete oh and it's the generate
book number so there's a typo here sorry
this time we will again use the swagger
code gen and as you can see swagger code
McCutchin can generate typescript as we
did Java C++ and all these things but
also it can generate some fame code so
that's nice we don't have to do much and
that's what it does it generates an
interface with the generate book number
so the idea is the book API will call
this method and this method you know
there's a bit of Fame magic but it does
get on numbers book so somewhere you
know externally oh sorry
and then so that's the a the interface
and the implementation is just a feint
builder so here I'm saying you know
again I'm on the book API side and I'm
saying well if you want to return a
number API interface build it with fane
using this base path so here it's art
coded this is where the number API is
and that's it so now on the book on the
book API side it's quite easy to invoke
an external service
I just go please build the number API
interface it has a method that returns a
string so the in this way I can set the
ISBN number on my book so swag swagg Wes
Welker Jane creates all the plumbing and
the bouquet P I just need a couple of
lines of code to invoke an external
service demo
okay local demo oh that it's a bit funny
hmm I'm gonna do that here on my laptop
so now I will go to demo - yeah
sir
okay the question is the number the the
call to generate the number API is
synchronous yes at this time yes so I'm
gonna go to the client the angular I'll
do ng serve again so it can hear I'm
gonna go to the services and now I have
two services so I'll start with the
number API I do a maven clean install
it's gonna create a fat jar and now I'll
go to the book API again
maven clean install on one side I have
one fat job running wild fly swamp so I
just go Java jar and now the book API is
Tommy but also was a fat jar so now I
have Tommy running here wildfly so I'm
running here my angular app running here
so if I show you so I go back to local
host okay so now I have a couple of
extra pages I still have the number so I
can still go straight from the angular
to the number but also I have the the
book now so as you can see I can do a
HTTP GET on one book here I can do a
post John and more importantly is when I
create a new book
it creates ISBN number because it
invokes with faith the other service and
I even have the swagger contract of the
book API which is bigger because I can
do get post put and delete on a book so
now the question is
released oh can you do that on the pies
I'll try
go for it but lazy clap clap he was able
to do that you know and have you seen
the blue button how nice it was I'm an
angular mass okay so let's see let's
let's let's let's try to do it on the
part so I I did save you some time I
didn't want like put you over the
trouble of going for the moment wheels
and the a simple script so I already run
that so let's see let's see if that
works on the PI so now we have free pius
involved so one is running the client
the angular client as we did before
another one is running the number api
service and now we have a new service
you just Boop API that's running on
another PI so the yellow ones are the
ones about updater so I'm running the
angular on pipeline one the book on PI
gram load balancer probably is not the
best name but that was the one name that
I had at a time and the Graham server
one is running the number API as it we
had before so now if I go here to my my
store so now I have I have the store
demo 0 tool so that's fine it's over
here that's running on not sure if
you're able to see that what's running
on pipeline 0 1 80 80 so I'm going to
books number yeah I mean cool works
right right now so let's see I think I
seem to have some books over here
already
Oh beginning Java EE 7 are very old book
oh I wonder who that guy is
and let's try to create a new book to
see so I'm gonna do like this awesome
book and the art is gonna be me I want
to write the book as well and yeah
probably 2020 yeah yeah I don't know
maybe maybe that's one probably just one
I write a book and I don't know maybe
maybe a drama one yeah traumatic
save
Oh corpse Oh what happened over here so
I have like something over here I have a
well I'm not able to increase this I
think but I have like a 500 I wonder why
so let's see the respawn so but this big
of a stack trace oh no what what should
I do
oh let me see what's happening on the
logs so now I'm gonna have to go here to
my what I'm running the the book API so
I think it's these box dr. PS these
running book API so let's see let me see
the logs okay and there's exception over
there connection refused mmm
that's when service invokes
localhost:8080 for but Antonia we're not
running the API on the same box yeah
it's a video video the the host name yes
I did how those name is that bad run
that on the PI yeah but you can look at
the logs you know awesome
yeah well it's stop pain I have to like
Shels people know on the on the path and
then have to look on that well okay so
as you can see now we start to run into
the same the the the first few problems
right so it does work on my on my box on
Antonius box right works on my machine
but it's not working on my own on my PI
so yeah definitely gonna have to fix
that and the problem now is there's one
pi and we knew more or less where the
services but when you live in a micro
service world you're not gonna look at
all the logs of all your service yeah
now imagine that for some reason you
have these running on twenty boxes and
then for you forgot change on one of the
boxes and now you have to like manually
going on every single box to see the
logs see which one is failing that
that's crazy so I think it's time for
demo 3 then well yeah definitely let's
let's see what we have over there so I'm
gonna have so if you guys don't mind I'm
just gonna
I have these running first clever yeah
so just gonna run in the background
while we're gonna talk a little bit
about demo free so what's next so
basically we have two problems over here
we think so we have an issue where we
have our coded host on our on our
services we definitely need to fix that
when we call done it done that right now
but we think that's very if we start
monitoring our system first
so you actually got that exception it
was easy to to understand but we prefer
to start monitoring first then we can
fix whatever issue we we find so for
monitoring now we have several micro
services we only have two data point two
boxes we can have the deployment on
multiple boxes and they are running on
several pi so in this case you're only
running tree but doesn't matter you can
oriano them something might go wrong
let's see how we can monitor all of them
so this is our architecture at the
moment so it doesn't show that in the
bottom but basically one of the things
are gonna do over here just kind of put
like one monitoring stack it's gonna run
on our Mac maybe maybe if you chose
another thing can run it on the pies but
we were very happy with what we choose
so central monitoring that we need so we
have all these pies you won't like have
a place where you can check what's
happening all the time so we don't have
to manually go in in each one of them to
see what's happening so there is a
couple of things that you can do over
there we want to centralize logs they're
easier easier to see not only lost but
you can definitely have your API send
some kind of events to whatever
monitoring tool you're using so all of
them log to the same place which is our
Mac or whatever what you're using and
definitely we're able to see what what
failed very easily without having to SSH
into the into the machines so
a couple of things that you can use you
can definitely use your home Mays custom
logs and put them over there maybe
collect them and put them on a folder
and that you have to look some grabs and
try to find some stuff over there F is
log of course swing D Splunk also a very
good tool about logging and a few others
but in this case we end up using out
it's a very known tool or very known
tools that you do the kind of scars and
with qivana it allows it to do these
dashboards that we showed in the
beginning to monitor your your stack so
about locks - so locks - by the way does
anyone here familiar with ELQ a few most
most of you ok
so whose years using ELQ the monitor
stuff ok like half the room you can
definitely use other stuff but we ended
up picking this one so locks - allows
you to centralize transform the data so
you're able to just feeling log in to
log stash or basically what does need to
be log just whatever data you want to
feed over there and then you can
transform it and put it into
elasticsearch so elasticsearch then
allows you to query that data and see it
yes it's not the processing timeline and
there's a lot they have multiple plugins
that allow you to use multiple things to
filter the logs for wherever the events
you can have multiple sources so in
particular if you're only looking to the
logs generated by the servers like the
wild fly swarm and Tommy and later on we
also going to monitor logs that are
being from my console and then basically
going to push these to elasticsearch so
we can query them and see what's
happening so lets it search just like a
search engine to analytics on that data
so you can look what you're doing over
there you can I mean you're losing
mustache over here because it's already
convenient it's already they already
have these diff stacked together but
definitely you can feel it other stuff
so
there are some other projects that you
can use to fix stuff they have REST API
and you can definitely have you can
Nestle build your own API that will push
events directly to elasticsearch so
let's just say when you have that rest
endpoint you can definitely push
whatever that you want to elasticsearch
directly instead of going from from from
walks - don't you have divine ity not
allows you so antonio really show that a
little bit in the beginning what you're
going to look a little bit into more
detail in demo in demo free yes allows
you to see the data that you have on
elastic search always to search for that
allows to query for data you can do
couple of dashboards and monitor your
server right away
so another thing you're using is Gulf
so Gulf is the great log extended log
format we ended up picking Gulf because
love stash has a plug-in for girls and
dr as a plugin for for gulf so we were
able to set up docker to push directly
the docker logs into log stash using
both both Gulf plugins on docker and the
plug-in on on on unlocks - so it was
something we ended up using that because
it's most the most easy setup that we
were able to find to push the logs are
being generated by the docker containers
directly to log stash and the one one
one good thing about about gals is that
they already provides a structure for
the log so they already as stuff like
the hostname that's being generated log
date and time IP addresses the docker
container named token container ID and
we all will see a couple of that in the
in diviner
so for the lot so you have like these
log stash cones so this is just tell log
stash how is going to I grab the
information so the input is very simple
so that's where the inputs coming from
these coming from Gulf
these will open up a port on unlocks -
and then the docker container plugin for
four bells
it will just connect to that to that
port and it's gonna push every lock
that's generating over there and then
four filters so these this one over here
is just a pattern to transform the
exception stack traces it's just in a
single event so if I didn't have over
there all the stack traces will show up
in a different event or a different line
into elastics are into elasticsearch and
then it will be painful to see the stack
traces and while the output will be
elasticsearch so golf or Locker compose
it's over here so you have an option on
on on docker command line and also
present on the dr. plugin for instable
which is logging so i'm logging you can
pick the driver that we using so the
default route the default router will
just log directly into your your
filesystem
but they have a couple of other drivers
and this one over here will just use
golf and then you have the address over
there so if the here is art colors for
localhost but when we're doing the dance
of all scripts you'll just change that
to this machine so it will push directly
over here and let's let's do the demo so
since I was doing over here so now it's
gonna take a little longer to do the
deploys I'm on demo free now I'm you
have a yoga running well I have out
running in my box let's see if I still
have it running so at the moment I have
no results over here let's see these no
results over here as well sometimes
sometimes there is a little bit tricky I
have to check the date times but since
I'm not generating any logs yet
so the tricky part over here is that
sometimes the if the raspberry PI's are
not on the correct date they will send
you the date which they have over there
so what you say they have like one hour
behind and then you have to like play
around with the date times on the on the
diviner search to actually find the logs
because when you know the raspberry pi
doesn't have a battery so when you plug
and plug it for quite a long time the
the timing is not right
what hopefully the network guys just
saved us because we do need wiring
connection to the PI's
you definitely to grab a like Wi-Fi
thingy to to feel the router but if we
have internet connection on the PI's and
they're able to grab the time from from
the internet and there's a lock right so
ok didn't took that long I was I wasn't
hoping I had two tents to entertain you
guys and this deployed and starts the
application on the PI's but to be honest
there it takes a bit of time to to
actually start yeah I mean so that's why
the logs usually take a you know a bit
of time is the is the angular app up and
running it should be let me just change
these for last hour okay I think that
the PI's are probably like one hour
behind so it's like are these these
probably from a while ago so let's see
if the yang Gor app is running it should
be demo 3 now movie awesome so he's up
and running let's see so the numbers API
also takes some time to boot up so it's
not up yet now one one one thing that I
want also like to tell you guys about is
in this is I think it's a limitation
there on docker I found like a github
issue for that is whenever you set up a
logging driver to the docker container
then you lose the box
on the docker box command so basically
you're not able to have like multiple
logs plugins set up on docker containers
so if I try now my book could be at
cedar logs since I changed the
configuration of the docker container
and I'm not able to see the logs
directly onto the box which is a bit of
an annoyance sometimes it might be
useful to go directly to machine to see
the logs but since we have elasticsearch
over here we shouldn't need that the
number api still not have been running
okay so it's a little bit slower so just
one more detail so we were actually
running the oracle vm JVM for the PI
there is open JDK as well you can run it
but it's much slower than the Oracle VM
so for instance well flying here takes
like one minute startup on the PI and on
the Oracle VM we the open JDK is like 10
minutes
so good job Oracle okay so now let's see
now if you create a book well I'm still
not the exception but at least we could
see it hopefully that see if I still if
I yeah I don't have any laws because I'm
probably not you know it well yet so
let's try yeah book wooden book
number let me see over here no time
right on cabana I see sometimes takes
some a little bit of time to update okay
so now starting with some real problems
until now it was fake problems yeah
making problems sometimes we have real
problems
because when we arrived here this
morning the pies were set at the at the
time of yesterday but then we managed to
to plug them to a real cable to the
internet so they could synchronize but
still they're on English time so they
are one hour behind us - I was the UK
god this breaks it is really hard
gee it was one hour before no no it's
true they really want to leave that
stick to the American American time soon
yeah well you mean give me a couple of
minutes to see if I'm able to figure out
okay so what shall I do then and I will
can you dance to entertain the audience
okay I can do that so now but I can
maybe show tell you a bit of story
Roberto is in Portugal and I'm in Paris
so we've been doing that you know
remotely doing all that so I have my
pies at home yes the pies at home and
you know when there's a problem you know
you just have to take the webcam of your
laptop and show the pies cec you know I
can't see the light so it was a bit
tough so that's why we arrived here on
Sunday morning and we just got locked
into a room for two days but yeah you
you know it's a nice toy you can come
and have a look at it
but it's it's it's very particular you
know anything can go wrong the router
you know I think we spent more time
configuring the router than writing code
oh I'll try to check that on the on the
break so that the sound logs are not
being pushed for some reason I don't
know why but the idea here is that you
will be able to see the logs here on
lock's - so
I can show you so of course I have this
running right before the session and now
if not working for someone if you want
to switch and we can show my board
because you still up and running so yeah
I can show I can show like the the my
old data over here which was right
before the session so I'm not able to
show the exception because I don't have
that this section I want to show because
I don't have that yet oh but what we
wanted to show you is now that we have a
board we can actually see the alias
Epson actually actually I think I think
it's probably just a little bit floor
I've cuz I see like the the talker
generated numbers over here okay let's
try it again
yes right again so let's do so this was
at nine so generate some some numbers
see we see some you just put like one
hour
no sorry for hours not one hour okay
because I have a couple of them over
there store so let's generate some logs
okay I think it's sometimes takes a
while to update for some reason oh I
think they're in there over there so
they are over here oh so it's 50 minutes
behind and something like that so let me
try to generate that exception that's
too quick last 15 minutes like one hour
okay yeah so it's so they're over there
okay so now let me try to have the same
look now yeah book let's go create a
book title my awesome book vertol your
Oh drama still draw yeah you hooked into
drama yeah so yeah there's no failure so
there's a failure but now hopefully we
can go to cookie Bana
okay no see it okay there you go some
exceptions over there so let's try to
open this up okay so there we go
connection refused the one that we were
having and now it's much easier natural
connection refused let's expand this
let's open these logs a little bit and
there you go the localhost so basically
yet now so come over here and I can say
exception come on okay so now I only
have my exception so it's just easier to
search for so if I if I know they're
having a following my Colo th I have all
blocks being pushes over here so I can
just go over there and search okay I
want to search for exceptions and now I
have the exceptions that are getting
being thrown by our booth API because
not able to find the number API hostname
so there now you're able to see the
exception of not sure if I'll see it not
sure if I can increase this a little bit
but yeah so very low switch
so finally we see some logs but what's
the problem
the problem is we've used fixed IP
addresses so this you know plenty of way
of doing that we actually configure some
IP you know what addresses so we can
change them around but we also played
with with the hardware when we
customized the router to load load load
balance using alias so we gonna show you
what we did in terms of configuring IP
addresses so where are we book API has
out coded IP addresses on number AP is
we have several land environments so we
have local host on Mac but we also use
docker composed because it's easier and
we we have the pies
so we need to configure and those oaths
the architecture is the same so now
we're just gonna make it run hopefully
cut configuration we need to configure
parts of our code there's business for
config if you deploy one app in one
country and to the other one you might
want to configure the VAT rent but
there's also a technical configuration
that's what we do so we have different
environments different IPS we also going
to use a timeout later to show you when
things go wrong so all this is
configurable how do we do that by hand
with environment variables that's quite
a good one actually when you put an
environment property files of course
you're using XML G's in Aoyama the
database is also one thing jndi if you
come from the Java EE world or of the
console or Eureka or things like that
spring config and because we use the
micro Pro profile we took the
configuration bit of the micro profile
so the way it works the micro profile
use what we call the configuration
sources you have several sources today
that Jada Bey is the property files and
the property the same one can be in
different sources ok so you can say
first grab the property IP number on the
DB and if you don't find it take it you
know on the file and if you don't find
it apply a default basic stuff and the
good thing is you can change that at
runtime so your you know environment is
running and you can change things on the
fly without restarting the app
so that's what we did remember our Fame
client the faint Alliant has hard coded
IP address now we slightly change it we
said we use the config of the micro
profile and we said look for a variable
called number API ousts if you find it
good put it on your base oast this one
if not check the default one so this
demo is just we just changed the Fame
client you have to use the config
instead of hard coded IP address and the
good thing now is on the docker compose
we we can do that so on local we don't
set it up so it's localhost on docker
compose it's that one and when we build
our image it's a different one demo time
okay let's see if this works I just
finish up the the deploy for edema for
so you guys don't have to wait for that
so now I have my stored in afforable
here book number didn't start up yet but
should be should be almost there
hopefully yeah ever as we say while
flies swarm is slightly longer to to
boot because of his java thing on the
pipe well now if you actually see some
of the wild flight logs over here as
well what seeing what she's doing
so we set up at nine flat five form is
ready over here okay cool well five
Swami's ready so we should have the
numbers now hopefully here you go
okay so I was not able to create the
book a while ago let's see if I'm able
to create the book now oops
with this demo for so let's go to the
books again so oops shouldn't have done
that
okay so let's go to books
let's create a new book my awesome again
oh yeah I I really want to write a book
this time so I spray it by 250 maybe
fatter this time so that's it saved oh
yeah awesome so it works because now
it's localhost on my on my machine
and there we set up we have configured
the we configure and the IP address good
but we're gonna move things around know
this IP address is configured but still
fixed we are saying angular on raspberry
orange please go to the book API on
raspberry red now we want to move things
around we want to move our services from
one pi to another one that's when we're
gonna had registry registry so we have
two microservices book API and number
API can be deployed on any PI so you
know it can be on what IP or the other
one how do they look for each other so
now we are it's a bit sad as the image
is plenty o ml is cool but it's
difficult sometimes so there's there's
the ER e lk at the very bottom okay we
we introducing this purple
so it's going to be on the purple pie
it's needs console so everybody
including the angular app will register
on console and look for the others on
console and ELCA is still at the bottom
okay service registration and discovery
think of it as a D you know what DNS I
need to ask someone where is the other
service a service now registers with an
ID okay a name an ID and and then I will
look for this name not for an IP address
and another service looks for it by the
name and we will see later that we can
have several instances of the same
service how do we do that how we do
register and look for things well if you
come from Java EE well there's J and di
it has been on for 20 years now so
keeper also Eureka but actually we
didn't take this one very hard to set up
we took a console we wrecker as we said
we use most of the Netflix stuff Fame
hystrix we ribbon we found this one a
bit difficult to set up and to be honest
Netflix makes money out of movies not of
code so the documentation is poor
everything is poor so sometimes you you
eat a wall so in our case we took a
console in that case what is console a
solution to connect and configure also
application so console you register each
other but you it's also a key value
thing like jndi so you can put no config
into console
it's distributed and I valuable we only
have one console but we could have you
know several and plug and unplug one so
actually your console is our stuff
there's only one and everybody needs it
so if you unplug one cable or everything
dies but the console can be distributed
and you can have different instances you
have runtime configuration and so on so
there's two things that you need to do
so all our services need to register and
that's again is it's quite easy you have
the console a builder we with an agent
and once you have it you do to two
things you register your service with a
name so here we put a number of API name
and then the good thing is you can give
a check so here we have an HTTP check on
each of our service we have a health
check that goes on alive and the console
will ping those endpoints every 10
seconds so in console I register myself
and I tell a console please ping me at
this endpoint every 10 seconds and see
if I am alive or not
that's when we can start to plug and
unplug cables because a console knows
who is up and who is down so step number
one are register to console this way I
give him an else check so in this case
we in in our number API and book API we
just have a else check and return the
200 very easy and then the book API
needs to discover the number of API
giving a name
so again I use the console builder I ask
him only the health clients you know I
don't want the clients that are dead not
answering and here I tell him please
give me all the healthy instances of the
number API giving a name not an IP and
then that gives me a host and I use fain
we you know here it doesn't change I use
Fame giving a host name and this OHS
name is giving by console okay and we
have a lovely board that we're gonna
show you our console comes with a nice
board demo time okay okay so again I
already deploy things for you so you
don't have to wait
so in here now we have our store which
is demo 5 it didn't we didn't change
anything your Mac lucky over here only
where we gonna retrieve the service from
so KP I am Not sure I think it's not
really working right now but the idea
here is that now here is the the console
console so every time a service comes up
it will register this on on console over
here so now you are about to see for
instance book API is here let's see a
number a P I I think it's dead but now
able to see that the boo KPI is over
here it's running so we can we can see
the health checks that are being
performed over there and when number API
comes up it will also be registered we
go there we go
so it's orange because it's up but
console hasn't made a call to the else
check yeah no no it's me now it's green
because he contacted the hell's point
yes our number API is a little bit
slower to start up now we have both
services you're registered on console so
we able to see whenever they're up or
down so now if I go back to my app I'm
able to retrieve book numbers again
and hopefully if you go here to console
so book API is running on the one of
these red ones so just kind of unplug be
some trouble here
and if i refresh you'll whenever it does
an l check it will the else check is
every ten seconds it will hopefully say
it will it is down oh maybe maybe it's
longer are you sure you unplug the the
right - sure
there you go it's orange now yeah so now
it's orange so if we go here on the
detail you see that the health check is
failing so of course the server will not
answer for that now if I plug these guys
back in again and hopefully a console
will detect that's up oh it was much
faster now so now the service is green
again so I'm able to use it properly and
again if I come here to my book AP I
come here to read an awesome book no
probably not so awesome Oh awesome book
that's a drummer yeah that's the drama
so what's probably - it on 2020 now
drama it's save and there is my book
again oh yeah on the pit - himself you
didn't change much but now the using
console to do rushing the services and
then look them up with something very
important on the microservices role
because now it's easy because you only
have one of each but when you start to
have multiple of them you need to know
where they are and it's kind of
unreasonable to have to pass in all the
servers that you're going to use on
system properties or environment
variables or wherever ladies and
gentlemen let's have a twenty minutes
break and when you come back we hope
you'll come back we will hopefully talk
about circuit breaker because we're
gonna unplug things we have to fix that
scaling we will use other PI's security
because you only do you always need that
and load so we will put pressure on the
PI's
see you in 20 minutes thank you guys
okay we're back thank you so much guys
for returning to our session no oops
okay
thank you for coming back so there's one
hour left
now we we're gonna start playing with
failure and scalability security and
load so why the very end will you know
the last demo is will put pressure and
we unplug everything everything will
work hopefully hopefully so let's talk
about an important pattern in the
circuit breaker we have two micro
services okay Buch API calls the number
API but number API can fail how does the
book API Endel in this failure the
architecture doesn't change but now the
book API needs to be clever enough to
say I'm calling the number API it's not
responding what shall I do well you can
use a circuit breaker
so when services collaborate mostly in a
synchronous way when it's asynchronous
you can handle it in a different way but
when the Endel synchronously things can
go wrong either the service is not there
or the box is totally under load we're
gonna simulate that with a timeout so
the service is there but it's bloody
slow what do you do do you wait and if
you wait so if you know that's what's
gonna happen the number of API will be
slow giving you the numbers
if the book API hangs well now we have
another one hanging and the client will
hang and the entire chain hangs so
that's why it's called a circuit breaker
you know you should cut open the circuit
how do you do that how do you use the
circuit breaker you build your own
actually there's a when you come from
the city from the Java EE world there's
a few implementation using CDI there's
another one but it doesn't be maintained
it's called J rugged the micro profile
actually has one or will have one in the
next version the 1.2 I think we we will
be using hystrix you know again as we
said we use fame fame client because
flat fame integrate well with districts
and ribbon that we'll see later what is
Easter eggs well it's the Netflix
implementation of the circuit breaker
and the way it works is you construct an
Easter eggs command we won't be even
doing that because the command can be
complex and as you will see ours is
quite simple so we don't even use it but
the idea is you create the duck the
command to execute so I want to call the
book API but but instead of invoking it
you invoke it in an Easter eggs command
and then you execute this command the
meaning if it's ok it will go to the
book API so the district's command is
clever to see if the circuit is open or
not if the circuit is open so meaning
you know there's a failure it will do
something else if the circuit is not
open you'll proceed
oh and integrates with Fame as we will
see with the fame eastery
client so this is our number API failing
we will of course and plug a cable but
here we configure a number of seconds so
here there's a fate timeout so again we
use micro profile configuration to set
it to a different values and we wait so
the service is here but it's not
responding so that's the number of API
failing now the book API needs to fall
back remember we still have this API
client builder so we use Fame to create
a builder to give us a proxy to the
number a P I so thanks to Google console
as we saw we have an IP address and as
you can see here this is our E string
server command because it's just a one
line we didn't have to put it in in a
command but what we are saying is here
is the fall back in the fall back in our
case return the string and now instead
of using a Fame builder client builder
we use hystrix
failed and that's all we do the same
thing console gave us the IP address
where the number API is and we just
passed the fallback so the magic here is
hystrix Fame client the fallback and we
give it here meaning if we call so if
the client call the number of API and
the number API is not there our book
number will be fall back ISBN number and
then we have to do you know something
else the good thing is the entire chain
will keep on working
but then in a business point of view
that's different you know maybe in a
business point of view I have to go back
in ten minutes and take the fake ISBN
numbers and change them with a different
one you know again in terms of a
business it can be quite complex you
know technically it's just a few lines
of code demo time let's go so far the
demo gods are being merciful on us and
we have 24 gods okay so let's go to the
mo six so now as you can see I'm on demo
six so let's go over here on my number
so I'm able to grab the number it's fine
so so if you create a book I'll get all
the all the notes are healthy over here
on console so let me go in and create a
book so let's see boring book no write
that now yeah I'm gonna write it this
year definitely and a romance seems fine
say okay so the number is B B K so we
took number so yeah so by the P there
was nothing new over here so it was just
creating number the book as we did on
the other occasions but now let's do
something interesting so I'm not sure
which on which demo and plug them on I'm
sure there are these ones over here the
ones on top so I'm gonna plug those two
PI's let's go to pencil and see okay so
now one of the one of the books or one
of the number API is is not buying so
let's go back here to to my to my store
so if you go to the numbers and we try
to retrieve a number we're not getting
any response back so the the request is
just waiting for something but that
doesn't mean I'm not able to create
books anymore
so if I go as Antonian standing now we
have
the secret bracket over here so if I try
to create a new book so let's call it
the boring book version 2 and I'm gonna
be the author of course now it's gonna
be released to me next year and it's
gonna be wrong once again so that's it
save just yeah so now we see that that
we fall back to the fall back ESPN has
on Tony shows on the code so now the
services down that doesn't mean they're
not able to create any books of course
we can discuss that that's not the
correct SPN but we you can make it much
more smarter and actually generate a
real one if the service is not really
running now if we plug these guys back
in again we should get back or number
API
so let's look into console so you didn't
said you didn't set the timeout on on
the number API don't wait for a minute
or something like that
no no so yeah no number API is back on
over here so if we go back to our store
and go to the numbers and we strive to
generate progress we have numbers again
so hopefully if we create a new book oh
and if you read it it sorry I know we
didn't implement that yeah no I thought
you just said it the book change it and
we'll analyze B address so let's say
boring book version free and the outdoor
it's gonna be that year another romance
say and now we have black or yes beyond
coming from number API and we will
actually you use that later on the last
demo will push pressure on the pies and
will plug and unplug things and the idea
is that the entire application should
keep on running and we will see a lot of
fall backs
okay okay so what's next well we have 24
pies so far we've been using two so
let's scale the architecture and you
will see that we're gonna need a load
balancer so we need to scale our
microservices you know a lot of people
are buying books so the good thing with
micro-services is now we can you know
the architecture is completely stateless
so we can have as many as we want so
we're gonna start killing the number of
API so we still keep one book API now
they still have to be registered you
know we're gonna have four number api's
running on the orange so then the four
instances need to register on on console
they're deployed on for pies which
instance to choose from the four pies
are registered in console number API one
number API two three and four what is
going to do the book API the book API
needs to pick up one so that's how you
know the architecture is gonna look like
that and now on the red bit on the book
API we need something clever to first go
to console and take the 4 number api's
and there's choose one that's what we
call a client-side load balancing so we
have several instance of the same
micro-service and the idea is console
gives you all the healthy ones it
doesn't tell you keep this one you know
take this one or the or the other one so
the client the book API gets all the
instances the four instances and then
choose among those four instances which
one
and that's when load balances can be
more or less clever which one will I
choose well round robin pick number one
and then number two and then number
three all things more clever if you have
different data centers you can say go to
the first one and if something really
goes back then go to the number two but
as you can see now it's the client
choice console is just there to give you
all the instances how do you implement
this clients load balancer well
choice number one you can do it yourself
if you are on Amazon day of your day on
but only works for Amazon as far as I'm
concerned then you can always you know
use load balancers and do when do the
trick so httpd edgings also does that we
are gonna use ribbon so we're gonna rely
on the Java code not not on the
structure what is ribbon the next clicks
again implementation of the client-side
load balancing so it's quite a clever
Beast you can you know again ribbon you
can talk to all the ribbon instances it
we use the HTTP but it can support all
the protocols and we use synchronous
model but it comes also with an
asynchronous and reactive model and it
has caching so he also tries to cache
thing to be a bit clever to not you know
try to pull all the instances each time
and the good thing is integrates with
failed fails from Netflix so as you can
see each tricks was just one line of
code and ribbon slightly more
complicated but on the fence side is
quite easy
so the first thing before we had one
instance of the number of API so we
registered in console giving a name and
no ID you know so it was ID 1 now ID has
to be unique so what we do is we still
register the number API with the same
name because we want to ask a console
give me all these instances of the
number API but now we must have a
different ID for all these instances so
we use the UUID so when we register
services to console now you will see a
random ID that's the different do you
want to explain this one cuz yeah
definitely yeah so for registering
driven load balancer into your Pookie
API so what we do is we start we start
up with the with the ribbon from robin
rule so you can have round robin load
balancer and actually gonna use
something that they call a dynamic
server list load balancer so there are
mcstarley stalled balancer is something
that basically updates its hosts basis
on a rule that we might have so this
just to have a some set up and then we
have a configuration that allows us to
say hey we're going to refresh all the
servers in each ten seconds so it's 10
seconds everyone's going to try to
update the servers but you're not going
to do so we was not going to do a health
checks that we're going to do actually
is when a call console to people's the
healthy list of the hosts which he
already has because console is doing the
health checks for us and it can retrieve
us the healthy list of the servers so
now in here are just registering my my
load balancer and
oh I think we're missing a little piece
of the coal here you know because we
need to register the load balancer so
it's code invoking this one yeah I know
saying the the server server list the
one that not sure if it's all over here
no my not then I'll show that really
quick over here hopefully
so this one is on demo scale services
book so just like a little piece of code
it's actually important resources rest
console management presentation mode was
already in okay that was the piece I
want to show you so basically we
register here something called the
number api's which implements a ribbon
interface and here just has two methods
one called
get initial servers and another one
called update least servers and these
are the metals that we one's going to
call when it starts up the initial ones
and then people called the update list
of servers each 10 seconds and while in
here we just don't care which is called
the initial one over here but what the
initial the initial method does is it
just do a call to console to grab all
the healthy services that are available
and then it will see that into ribbon so
ribbon always has the the healthy list
of servers to pick from
yes sorry sorry about this change I was
updating this slide and the flying okay
but I think that yeah if anything much
more but then how we gonna use this load
balancer with with our call so as an
Tony mentioned we have there is a
project or a module in insane with does
integration with ribbon so it's very
easy to use
you still use the the district's fine
builder to have the fallback still but
instead you're going to just wrap your
call into these load-balancing target
and you're still going to put whatever
endpoint you're going to call over there
but now notice that the the endpoint
that we're calling is something called
numbers - API and if you know we should
have called over whoo-hoo bar and if you
notice over here we have something
called number - API so what happened is
when we register the rerun load bouncer
it will be registered on virtual HTTP
host name called number - API
so when sorry so when sane and the fine
and fine ribbon is calling our number
API it will look for a low bounce at
register on this host name and okay now
I have my load balancer I'm on ribbon so
now I have all these lists of servers I
pick one on the run robbing algorithm
and after I have one I'll just gonna
rewrite this address with the actual
host name of the server that I'm going
to call and yeah let's do the demo now
okay so now we are on our store again we
aren't on demo 7 so we didn't change
anything in the app or this on on the UI
size we do change a little bit on how we
call the book so I already do all
deploys for you guys as you can see over
here we have a couple of other changes
so now not only I updated all the other
so the angler the book number and the
number API but number number number is
now deploys on for pies so now we have
all all the orange ones are running
number API so if I show you console over
here so
all the servers are up but if I expand
this then I'll see that I have four
services running so hopefully if I'll
disconnect one of them if will one of
them will go orange should I put like a
smaller timeout okay so now one of them
is orange but that doesn't mean you're
not able to create books with the right
book number because we still have free
endpoints we have three servers that are
still giving is the number back so if we
come here to our bookstore let's go to
the books again let's create the book so
boring book and the author let's put it
down 2020
doesn't really matter save still got I
still got two right still got a book
number over there so that that worked
fine now if I do one plus a few more so
what that mean plug this one and let me
unplug that one over there so let's go
to console again
so hopefully console will update so now
yeah so no one oh you already noticed
one of the hosts is down so he's not
going to give that host anymore two
ribbon
so now three of them are down but I'm
still able to create books so I'm sure
that you will believe me but that's with
much much quicker now doesn't matter I
still got the book number correctly and
of course if I disconnect the final
tables so I don't have any number api's
anymore so that's looking to console to
see
when that turns down so still up still
didn't notice so now all of them are
down in Cabana I can receive anything
yeah Thank You Man you can run a we can
see we can see some some things over
here so we do have what happened okay so
in Cubana we do have a your dashboard
and basically if you know if you'll see
let me try to increase this a little bit
doesn't look very very good but as I can
see here we have a disgorge that
basically is counting the the health
checks that were okay so at this time
it's unrest because we don't have any
number at the ice left still have a few
pounds because they also monitoring the
book API and the book the API is running
a perfectly because I haven't disconnect
the cables for it but now if I so if I
come over here sorry I'm always messing
the tabs out so now if I create a book
over here this will go to fall back my
yes yang
sorry connect let's connect two of them
sorry if coastal is down yeah well we'll
just pack our stuff and go away now
that's what we said
console is actually you can distribute
it as you know what several instances
they do L checks all together so console
will work the same way though you're
able to have multiple consoles instances
and they will update with each other
they will share whatever is up so for
these two not over complicate things and
because we didn't have that many piles
we only have one but we can definitely
have two of them and if I disconnect to
console one you still have the other one
to give the the health chat console
becomes you know stuff so you ought to
be careful because if every time you
invoke you know one one micro services
and you can do that there's several
times a second then your console or you
recover
or something else become a big spot
that's why you are to distribute it yeah
so now as you can see my god as it is
yellow so it does tell me somehow that I
do have my cluster seems to be more or
less working but I might have some
failures so now since I have the other
two I'm still able to create books with
the proper book number but I definitely
have two surfaces down but let's just
let these guys back in and hopefully or
our cluster will move to green so it's
already increasing a little bit and all
the all the clusters will be fine so if
we look - if you look into console now
again let's do a refresher here they so
older all the number eight guys are up
and now my my my god you know it's
approaching the entire green number see
that everything is healthy and
everything is working fine good day so
we've scaled number api's we will end up
scaling book api's but there's one thing
we still do securing micro-services oh
yes sorry one question
we do have we're going to have server
size ball bouncing as well in this demo
or actually the other demo which are
trying to show sorry is just trying to
show like multiple ways to do things at
the beginning we wanted to to use all
the Netflix stack Eureka was a bit of a
pain so we changed that bit like a
console you can do configuration too so
we could have put our config into
console
no but this micro service the right you
should use all the things that you can
use yeah yes okay so now we're going to
add security on the book API the number
API is a public API anybody should be
allowed to use it but not the book API
we're gonna secure the HTTP POST put and
delete not to get security number api is
public book api gets a public post put
and delete need authentication to make
sure that each time someone in the
cluster invokes HTTP POST we need to
send to centralize those requests we're
gonna use a gateway so this gateway will
filter you know all the requests will go
through the gateway and this gateway
will go this one can pass this one can
pass oh not this one okay so the gateway
will configure the gateway on on the
urls and the verbs and the gateway will
say oh you want to do a post on on this
service
give me the token so we're gonna have a
purple box called the gateway again the
gateway in our architecture is a stuff a
single point of failure
this gateway like a console should be
distributed just to make sure it doesn't
fail the entire application so we got to
put the gateway in the middle and
actually it's not completely right you
know it is in the middle we put it on
the top but again
plant plant UML was giving this diagram
but the calls between the book API and
the number API go through the gateway
the diagram is not that correct so the
idea of the Gateway is we need a
centralized place where all the requests
go think of it as a proxy and those
services are exposed through this
gateway we call the Gateway first and
then the endpoint and the Gateway
intercept the request and goes yes no
apply authentication several gateways to
choose from you know again if you are on
the Amazon world they have the you know
one is own API gateway a PG gateway we
use the tribe string access gateway
because he's from new Tomi tribe so it
was good to have access to all the all
the R&amp;amp;D guys so do you want to talk
about it yeah sure so it's fine so the
trash stream access gateway is one
product that so I'm not sorry I'm not
trying to do this like pitch sale but
basically trash stream access gateway is
a product that Tommy try has been
developing over the last year and the
idea of the trash streams gateway is to
allow to make API security for micro
services we pretty much support halls to
charts ICP signatures out-of-the-box so
yeah is that you're able to secure your
micro services using any of these
security approaches
we allow you to route your microservices
so you can pick whatever security you
want using routing and we also have a
lot balancing in their support server
side load balancing the JSON web token
I'll put that to you well just if you
don't know what a jot is the idea is we
authenticate with a user and password
and the Gateway will give us back a job
and this token is lightweight enough to
go back and forth back and forth back
and forth the good thing is with this
token you can put some some data in it's
not like a cookie it's not just a random
ID we can you can actually put data in
it it's encoded in base64 and can be you
know encrypted as well and the idea is
you pass these token on every request
this is a token so this is what you have
on the HTTP error so in the
authentication era you are this bearer
if you look carefully at it there's dots
so it's actually made of three parts the
blue the orange and the green and
because it's based 64 we didn't equip
this one
well you just plain text so the the blue
part the adder gives you the algorithm
used to encrypt then you are the payload
that's where you actually can put the
data here we put the subject so when I
log in there's my name the the issuer
the issue is the gateway and then you
can expire in one minute or in one day
on one year and you can put as much data
as you want the idea is still to leave
it light so we can go back and forth and
signature to verify at the end so the
angular here I'm showing you the angular
hub
what are we gonna do is now we have a
screen where we enter the user and the
password it will go to the gateway do a
HTTP POST
and the gateway will bring the token
back so on the typescript side we pass
the username and password in clear I
know but the idea is when we do this
HTTP POST we pass the login and the
password the Gateway receives this post
and goes yes it is the right guy and
sends the token back so here I take the
token out of the error and I'm gonna do
something you know pretty easy I'm on
the browser so I will just stock the
token on my local storage in Chrome one
way of doing it so when you log out it's
actually deleting the token you know the
token will eventually be expire but
that's you know I'm killing the token on
micro so that's the angular part please
give me a token and then I need to pass
this token around when I do get if I
want not in our case but now I will get
the jobs of token that is stored on
Chrome and I will add these token to the
authorization error and then I will do a
delete I want to delete that book and I
show you the token so I should be
allowed to do a to delete a book Roberto
demo time only two left and so far so
good so you're gonna show us the Gateway
I can figure it yeah so the demo seven
now if you show if you want to create a
book it will the mail yeah so let's
let's let's do that first probably so
I'm here with my demo wait now oh wait
sorry
yeah then wait so again I'm still able
to
number API is public public public I'm
able to call it books well let's see
let's see if I'm able to create a book
so just put something simple now let's
clear this out
that's it save okay now now I have a 401
so how is not really very visible over
here cause he didn't log in he does no
talking I gotta gather 401 so and this
in our in our in our in our application
we were able to retrieve books and get
books so I'm able to to see oh you
actually have a old token that has
expired logout oh yeah that's right that
was a very interesting thing so I I was
already logged in but I have a expert
token so yeah but I you can do that same
again so I'm able so viewing books and
we ain't seeing the books list you're
able to do that but of course creating a
book and you're eating a book and
deleting a book so again I got the 401
over here so now how do we do this so as
you probably if you notice we we didn't
have any authorization codes on the on
the micro services so the idea here is
that the great way will handle that for
you so for that so we be able to do that
instead of calling the service directly
you're going to proxy the calls through
the Gateway indicating will apply the
authorization to you and if it's able to
pass the authorization it will call the
service back and if not it will return
you a 401 or for free if you don't have
any roles so internal saying we're using
reusing judge so we do have something
here what we call the security profile
so on the security profile we're able to
have we're able to say how we're gonna
generate token so when Antonio is trying
to grab a child token is going to do a
call to the tour to the Gateway
so the gate it will return him the token
sum here just gonna
have like a simple token that's the
token end point where you can retrieve
retrieve that and we're not going to
allow we're not gonna require the client
ID but the seal requires a username and
password so in that and for that for
that reason you do set up here an
account so there is Antonio account over
here you can set up a password for him
also any kind of public key public or
private keys as well but also to grab
the accounts from LDAP and database or
any other API you might have but make it
easier we'll just have the users writing
to the application and finally we have
here what we call the route so this
route is called like Pook API not sure
yeah you think if we're able to see this
a little bit and here I'm gonna use
these mod rewrite syntax from from
Apache I'm not sure is anyone familiar
with mod rewrite yeah I feel them so we
probably recognize all of these and I'm
creating some rewrite conditions over
here saying I'm actually missing the
delete one over here but doesn't matter
was it I'm saying if my request method
is the post or if my requirement is to
put then every every address or every a
call that's I'm being called to slash
books
I'm gonna call book API slash API slash
books and you've probably noticed over
here these api column slash slash book
this is our way to do a load balancing
so let me just go over here so this is
the server-side balancing that I was
talking a while ago so we have these
something called connections we have the
book stuff and I can set up here the
load balancing so yeah now but load
balancing the book API between these two
pies the trololol bouncer and the ground
load balancer and there on that
particular route I'm able to say okay if
these condition passes the
call these endpoint on these load
balancer and load balancer will handle
whatever hostname means to call but how
do we apply a procession so the mod
rewrite has these flags that you can
apply to to rewrite rule so in this
particular case you have a P in a name
so for people that know the mod rewrite
it doesn't really exist on what we write
it was something that we added and P is
for doing proxying so as da is to apply
authentication and authorization here in
the in the bottom of the page
now you can say okay I have I did create
that security profile for the for the
the token and here I can say I want to
apply the walls over here and when I set
this flag a it means that it will apply
that that particular token authorization
to the test particular rewrite rule so
in the end it will mean that for every
post or put this will be applied and I
want to apply this authorization also we
have this basic cost profile that I'm
using for so the one that the angular
client is running on the run on the
tokens and actually the loading that
we're going to do is actually just doing
a basic cost so you're also able to say
I have multiple security profiles and
then I I say I won't require any of them
so as long as you're able to
authenticate on any of them and the
proxy will give you a correct response
or you can say all and you have to
indicate on all of them then finally
since you still want to have people
going to the the public API which are
the list and the gap I did apply the
exact same rules without the
authorization flag and I just have like
an exclamation mark over here so you can
negate the method name so if it's not
post or is not to put so meaning if it's
a get or delete which basically is wrong
so I'll have to if I come over here and
just copy this and put a delete people
work just fine but basically that that's
the idea so now if I'll go again to my
to my demo and let me sign in so let's
sign in with Antonio I think this is the
password and gonna login so this will
call these owls endpoint and as you can
probably see over there you have the
token that was given back by that
endpoint so now let's go again to the
books let's try to create one so just
gonna make something really quick over
here save and now the book was created
it went through the proxy proxy applied
authorization authorization was okay it
went to the book API book API call
number API retrieved the book number and
then we have it in our store yes only
one more in student break yeah we're
gonna move to the final demo you
remember the Jimi Hendrix on stage but
burning his guitar that's what we're
gonna do we're gonna burn the pies and
it will keep on running no that was just
the final demo so actually we're gonna
stress a little bit this architecture
for a few minutes we're gonna add
clients you know we we have UI to to
show it's beautiful but now we're gonna
had clients to handle a bit of load so
this final day demo we have micro
services all over they depend on each
other they have several clients so I'm
not no talking about the angular the
angular is they're on the black one
we're gonna introduce three clients so
on three pies
then we'll rent randomly do HTTP GET
post and delete
several services and things can go wrong
things always go so this is the way it
looks like now we have the you know the
four client are you know at the top one
is angular and the other one the three
ones just Java client pushing we
actually put two book api's for number
api's the console is there the ELCA is
there everything is there so I think we
should if my demo is still up and
running I might have a few logs I'm on
I'm on demo your warranty mo9 already
yeah I was on demo 9 so I'm still
deploying mine so so yeah the demo 9 is
still there okay
I actually the clients so and you
probably does he's not able to see it
but all the blinking for all the
flashing lights are blinking over here
router switches all the raspberry PI's
with all loads going around console is
still the Cabana is saying that yes so
there there are things happening I have
the same board as you with the same
routes and everything yeah so the demo
machine the demo it exactly the same as
demo 9 it's just that we just put more
services around on all the piles and we
have coins having loads so sometimes we
don't see books because there you go
that's one because our clients are
creating and deleting books and it looks
like we we are we are deleting a lot of
books more so the number API still
working books Oh has been deleted I
thought yeah as well sometimes you get
from books and we try to create more
books than delete books so the working
clients are basically doing
get post put and delete operations and
you able to see them right here on this
dashboard with without labels explained
as what's up de re are you able to put
this a little bit bigger maybe command+
yep okay so what we have over there oh
parented by Graham server one is having
too many calls but anyway so we have
these on the on your left side we have
the number API per host graph so
basically all the calls are being made
to the number API to with three put
numbers are being logs over there so for
some reason maybe other maybe it was a
hiccup or something but the load okay
now it's probably locked bouncing a
little bit more because using
round-robin so remember when we had just
the the Netflix round-robin with ribbon
or now no it's perfect awesome
so basically were load balancing between
all the number API through the the the
the number so in there we have the calls
that are being performed over there no I
know boost yeah well is it sometimes I
get books and some say they they remove
books I ask Fargo I'm not logged in yeah
well nevermind maybe you didn't update
the code no no I need to login okay
and now if I create a book should be
there yep you know it will be deleted
but delete it because the clients are
happy I don't like to have books in
there anyway so that's the number API is
a number but and on the right side here
in the bottom we have the the amount of
calls are being performed to the number
API so basically we're roughly creating
17 or 18 books per per minute and
basically that also means they're also
deleting all the books per minute and on
the other side so we have the status
codes of the of the coins that are being
that are calling or cluster so
most of them are 200 because those
includes the gap by Aggie and that we
are doing and find all to have the
entire list and then you also have the
201 for when you when you create
something but we also done one
interesting thing which was we set up
our load to try to generate a couple of
different addresses so that's where you
have the 404 and of course we also have
a couple of clients that don't they
don't have any authorization on the
gateway so they will throw for a1
sometimes you'll see some for fries over
there because our clients don't have any
any any rolls so there is the the roll
things over as well table right yeah so
now we shall see the load balancing one
of the server's who shall disappear from
here so you already see that these
bigram server is it's shrinking so now
it's even more so I look to number API
okay you'll be unplug - number two -
number api's and you also see that our
god is also decreasing so now it starts
to yellow you know one of the number
api's is gone now you only have free so
one of them will go away as well so that
one so it's PI grams server one it's
also going going to go away and God is
also decreasing so if I unplug oh the
number api's the book API is should
still work because we are falling back
yeah so you're still gonna be able to
see to 201 and fill layer to see this
the 200 so now the amount of books being
created is cramming really really low
well actually we're still creating we're
still creating books but we're just
counting number API calls so we should
have come to the fall back as well yeah
if we go back to a way they still know
books
let me see the note of a green tune so
now I have a fallback okay so the
application steelworks the clients God
as soon as I create a book it gets yeah
I think let me change the mine I think
money as like oh that's better look a
bit better yeah it's better okay it's
better now yeah yeah I don't know why
but it's creating a few a few books it's
pretty random so as you can see they're
all full fullbacks now and so I'm gonna
plug those guys back so boo KPI which
one you want you want me to unplug don't
say the purple ones console really get
away now we can plug up the book you try
the purple one I have my setup working
if it breaks so redundancy we rely on
electricity that's right
IT guys always say you know the planet
is ours everything is IT you know
there's ite everywhere but you need a
plug yeah so ok time on wrap up now I
love slides left just to wrap up slide
up what's next
much much much more better we don't have
time oh sorry
so as a recap we want to quickly go go
back and show you what we did has a
recap because the architecture evolved
through demos remember we started very
very simple one angular app talking to a
micro service then the angular app
talking to one micro service was talk to
another one and we thought oh we need a
lk sorry it's at the bottom because we
couldn't see the couldn't see the logs
and our problem
because we need to configure our code to
suit all these environments then because
we were moving things around we need we
introduced registry so we could register
the the services and look up for them we
introduced districts so we had fallback
and then with ribbon we could have a
client load balancer because we deployed
the four instances of the number API we
introduced the Gateway because we need a
central way to to go you allowed to do
this and you're not allowed to do that
and we ended up you know scaling with
with clients we use many of the micro
service design patterns but there's more
we didn't use them all if that the if I
don't know one maybe
okay conclusion lesson learnt throughout
these journey
micro services are hard micro services
are bloody hard when you you know again
that's what I do on my day to day life
at customers I have a fantastic team of
network experts I have a fantastic team
of DBAs fantastic teams of everything
when we play because that's just a play
game with PI's it is really difficult
you know the full stack developer the
full stack dev is not born yet
and will never be the integration is
very difficult we run locally with
docker compose on the PI's we have two
clusters that are slightly different the
more technology is the harder the more
languages the harder every time I go to
a bloody conference about micro services
you have those beautiful slides saying
pick up whatever you want
hey you know integrating Java code in
angle in wildfly Swan and Tommy was
difficult they don't handle some
technical aspects at the same way so
imagine you know you have one team
during Ruby etc excetra fine but if you
are the guy doing all that and
supporting all that and integrating all
that it is bloody hard it is and you
know and we were full of ideas in the
beginning when to have like no services
PHP services and yeah all that stuff
when I start and again when you go and
see a demo on micro-service they tell
you the good thing is you are these
micro services it's running well don't
change it focus on that one now it's not
true we know it's not true the operating
systems must be upgraded because for
security reasons the JVM needs to be
upgraded for security reasons your
frameworks need to be upgraded for
security reasons and other reasons so
know this idea of you have a micro
service and leave it yeah but if one day
there is a security issue and you need
to upgrade your entire stack it it's
gonna hurt you back so what we do at our
customers is we use the same pom.xml you
know everybody has the same versions of
everything it's hard enough this was
hard no we didn't have day databases now
we have in memory yeah in memory but one
idea was to put pause rescue well in
that we didn't have business logic you
know the entire microservice thing is
your business is complex split it into
two
well my customers don't do it Twitter's
or don't send emails they have serious
business case and splitting a business
in two
well you have to be good in DDD no we
didn't have two complex networks you
know we try to build a bridge between
those two and we stop
do duplicate the gateway nor do we
duplicate the console you must do that
we didn't choose the soccer news events
which is also very very good but adds
complexity of course
oh and testing you don't want to test
that and we didn't do tracing that was
one of our ideas that we did enough
times and weight limit also you know one
idea was to leave one client doing crazy
push and gets and putting right limits
we didn't do that but you should
that's how complex things are and
because we were thinking are we the only
two guys who think micro-services are
complex and you shouldn't do it so let
me let me try something here so for the
people that wanted to use micro-services
before when we asked you in the first
place he wants to use micro services so
the feel of people although you're brave
guys you're right there remember to
charge a lot of money to customers and I
mean well we have all these things
simple things I mean was just like a
book and a number a P I and we only
wanted to sell some books and we felt a
bit lonely thinking are we the young
guys gonna go you know on stage and say
careful it's odd why well everybody says
it's the whole we know the Holy Grail so
we asked the planet we asked Twitter
some people make it more or less
explicit yeah yeah so I don't know if
you've seen if you've seen the movie but
it's actually I dare you it's say
microservice one more time
but because it was on the internet he
said he tell you it was me it didn't
have a in there so I didn't
have to to read it but yeah I like this
one one day my microservices will share
some leaves and there will be called
servlets again
I love this one our collegues dreams you
know that fits on one slide
developers nightmare yes you know my
customers are not gaffer I don't work
for gaffers so you know when the
business is complex things are complex
what I'm trying to do now at my customer
is actually introducing micro services
for performance reasons and that's a
winner
you take the bit that you know costs a
lot of you know what CPU and you put it
in another box and that's a winner
but my customers are not Gotha so yeah
you might not need it and I will finish
with Simon Brown who talks a lot about
that if you can't build a monolith
correctly why do you think putting a
network in the middle will help by the
way you could have done this as a mono
little what just yeah remember when you
have Jace P's and yeah remember the good
old days JSP is one server so of course
there's plenty of advantages we already
talked about it and I'm sure there's
plenty of talks that will tell you how
good it is we just wanted to focus on
how difficult it is so remember use this
type of architecture if you need it
because it brings you advantages but
also it comes with a power so not
because the others are doing it except
if you wanna have fun and charge a lot
of money to your customers thank you
thank you guys for coming we already out
of time
we don't gonna have any time for
questions but please find us around and
we'll be happy to talk to each one of
you and I would like to personally thank
tommy tribe who gave me one of those
clusters and i'm not even part of the
company so thank you guys yeah well
pleasure the code is there so all the
demos all the slides are there and we
will be more than happy to answer
question right issues if you want</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>