<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Hiding secrets in a Vault by Stjepan Hadjić | Coder Coacher - Coaching Coders</title><meta content="Hiding secrets in a Vault by Stjepan Hadjić - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Hiding secrets in a Vault by Stjepan Hadjić</b></h2><h5 class="post__date">2017-08-30</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/G-w90B0M70U" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello everyone my name is Japan and
today I'll be talking to you how to hide
your secrets in a vault so I work at
them phenome we are based in Zagreb
Croatia
and I'm a team lead of becken team that
does mostly rails we started to dip our
toes into a mixer and go and we have a
sub team of DevOps that handle and
maintain our infrastructure so who here
has heard of 12 factor app some of you
have for the others it's a like a
documentation written by the guys at
Heroku and those guys were directly and
indirectly involved with building and
maintained in developing thousands of
apps so they know what they're doing and
it's a method of methodology of what you
should and shouldn't do in your web apps
you can think of it as a guide of how to
build a better web services it has 12
points hence the name and those points
vary on different subjects like how you
should use your revision control to
store your code how to deploy and build
your applications and how to treat your
logs and stuff like that I'm gonna focus
on chapter 3 that says how you should
separate your config from your code and
you might be thinking why should I do
this my coding runs just fine with my
conflicts hard-coded well first off you
might be having multiple environments so
you have your development environment
you have your production environment you
have your staging environment and those
environments need to connect your
database and you're not having the same
database fault
environments so you have multiple
usernames and passwords so we need to
separate somehow separate them somehow
you might need to connect to connect to
different services like AWS s3 or
Twitter and so you need different
credentials for different environments
also like peppers and salts you
shouldn't be using the same in all of
our environments and if you hard code
that in your code there's gonna be a lot
of ifs like a lot of ifs in the code
itself depending on the environment
second reason why you might want to
separate your coughing from code you
might want to make your project
open-source and that means that you
don't want everybody else to see your
config files your config secret and by
the way those the config imaginarily
those of the secrets we're trying to
save trying to hide okay so you might
want to open source it or even sell it
like take a look at github it's an open
source project get lab it's an open
source project where you can download it
and install it on your own server and I
can't imagine the guys go through all of
those all of their code and deleting
everything before shipping third reason
is that we need to explicitly trust our
external services services like github
very store code even though you might
make your projects private they're
stored somewhere that github has access
to them and you need to trust them
explicitly if you want to store your
like if you want to hard code your
secrets if you're using code checkers
linters online services runners
everything that basically downloads
clones your code and runs it somewhere
you need to trust them as well and if
you're still not convinced you should
separate your secrets and store them
somewhere sale safe this here is
Brian he's a wordpress developer and
s/he used open source for all his life
he wanted to give something back to the
community and one day he he he did that
he open-source his own little blog
project put it up on github and he went
to bed happily he was happy for that
when he woke up he woke up to a
nightmare so he got an email from Amazon
saying that his Amazon account might be
compromised he should take a look at it
what he found out is that there were 80
instances of ec2 running on his servers
actually he didn't check all his regions
and there were like six hundred
instances of cc2 running so what
happened there are BOTS all over the
internet and some of them are
specifically targeting github and public
projects in in a way they're trying to
find your secrets right and some of
those bots are specifically looking for
AWS keys which can they can exploit and
create ec2 instances to mind Bitcoin and
even though Ryan checked before he
pushed his commit and there was a config
file that somehow he backed backed up
and which ended up in the revision in
his gate so it got pushed everyone could
see it and 16 hours later he got a
$6,000 a bill from Amazon and if you're
saying to yourself
yeah but I'm using my private
repositories that's not going to happen
to me right well this is Karla
he's a.net developer and as such uses
visual studio for to do all his coding
and one day he was trying out the the
den new visual studio 2015 it can it
came with
all new nifty features and one of those
features was a gift integration and
especially here a github integration
where you could from the visual studio
itself create your reporters and he
wants to try that he created a new
private repository with his own with his
own for his own project and ten minutes
later he got the email from Amazon
saying you should check you should take
a look at your account it might be
compromised so what happened turned out
there was a bug in the github plugin
where even though you specifically said
to you to create a private poster he
created a public repository and his
Alexa credentials was were exposed yeah
he also got a bill pretty huge bill for
all of his efforts the good thing is
Amazon is good it usually will refund
you those kind of errors but you
shouldn't like you shouldn't depend on
it so take away from this you really
should be like really careful with your
secrets right so how do you do that how
do you make them safe first an obvious
step is stop hard-coding them so there
are there is no need and there is no
excuse for you to hard-code your secrets
and the best thing is put them in
environment variables and there are
tools for each language that can extract
those variables in your code and there
is a tool in every language that can
help you with specifying secrets per
project per environment wherever you
need second step is to stop committing
that extract secrets file
in your repository match or else things
like the same thing that happened to
Ryan and Carlos will probably happen to
you
we tried that as um as a test I created
a fake basically created a user account
on on our Amazon account and we didn't
give him any permissions and it took
like ten to an hour ten minutes to an
hour to for something to for someone to
try to happen right there are tools to
help you with that
this is select the get secrets project
is a tool which which is a good hook
that you install locally and that helps
you that prevents you in even a that
once you in even prevents you from
hard-coding any strings that might look
like a secret so you extract you stop
hard coding that the hard coding the
secrets you extract them from your git
or your repository of choice and now
your secrets are safe and now we come to
the hard part imagine this scenario so
you start working on a new project and
you're happy because all your secrets
are your own and you don't need to share
them with anybody
then a new developer comes along to help
you with your work
now there's you need to find a way to
share those secrets right are you gonna
do them to email through slack to
something insecure probably yeah because
if you don't have the time to to work
anything out but maybe you wanna because
you're using your own same network you
might want to airdrop the files
that's pretty good and your problem
solved now the third developer comes
along he's a front-end developer he
works remotely so our job here doesn't
work and now you might you're trying to
figure out the best solution you might
want to use Dropbox for this but let's
say a fourth developer comes along and
he has some issues
with Dropbox and refuses to make an
account so that's the problem how do you
share your secrets with your
collaborators so let's say you shared
share your secret somehow now you
created your continuous integration
service for example drivers or Jenkins I
heard you'll use most of you use use
Jenkins here we use sound for if anybody
heard of it it's called
so most of the CI Services has a way of
handling environment variables there's
probably a web UI where you can enter
your variables and some of them even can
be encrypted although you don't know
that if if it actually is encrypted on
the backend and there's there you know
there is a way to decrypt them because
your project when when the CI is running
test is using the right environment
secrets so there is an explicit trust
here that your CI service won't use your
secrets against you there there's
nothing holding them back right okay so
you move on and now you need the server
because what's the point
elsewhere yeah otherwise let's say you
chose Amazon you to you created ec2
instance for your server you installed
the program of your choice horse is Ruby
because we mainly do rails you deploy
your app create the environment
variables global variables and
everything is good but then you need a
new application environment you need
like staging but then you might need
another environment like you Etienne
pose
so what then so then you start you need
to deploy more applications on your
servers what shouldn't what shouldn't
one server handle more applications
right then you do a java application and
let's draw a phoenix application just
for good measure
there are ways in in Linux to handle the
two separate the environment variables
easily let's say each application can
have its own user and its own
environment variables if you're using
something like nginx for your web server
there's a way that there are ways to
encode those secrets directly into the
config files of nginx but we're trying
to find something simple and secure to
share our secrets so the humans the
developers and machines can use the same
thing and work in harmony so what are
our options first an obvious choice is
something like Dropbox Google Docs
you'll create your own VPS just to store
those secrets but there is a problem
here because even if you use something
like Dropbox those secrets are not
encrypted and you want an encrypted
before storing them somewhere because if
somebody gets hold of your Dropbox they
can read it so there's a new problem
here even though you encrypt your
secrets before storing them on something
like this you need to find a way to
share it the master key for the
encryption or if you're using something
like puppet or chef similar some like
ansible chef has encrypted data bags
puppet heads encrypted here and so on
each of those managers has a way to to
store to handle secrets but there's
still a problem of sharing that master
key that they are using to encode those
secrets of course amazon has its own
services like kms in and even though kms
is more focused on storing the master
the encryption keys for the cryptic or
cryptic a cryptographic operations
recently they announced and released
something called system manager
parameter store which is basically a
store that can store arbitrary key
values to key value keys and it's using
commas to decrypt and encrypt them and
as with all Amazon services it's more
it's primarily intended to be used with
other Amazon services so we moved from
that there's a new thing called
confident the developer set lifts
created this it uses commas for
encryption and uses dynamodb for storing
the secrets something new we haven't
tried it yet but it's young and might be
something clocked look to look out for
okay now we come to the baganz kiwis is
a tool built by the guys at square it's
a complete secret management solutions
it runs in Java it has a CLI and web UI
it uses a fuse based file system and a
TLS for authentication and when we did
our first like R&amp;amp;D we skipped over give
ease because the next option the next
solution was better suited for us and at
last we come to volt the the thing we're
here for who here has heard of fault
it's built by the guys at Keshe Corp and
if you don't know them
they built vagrant and console so they
know what they're talking about so what
is vault vault is a tool that's written
in go and it can be used to store
arbitrary key value secrets and it's
secure but it because it stores
them because it doesn't trust any
storage back-end then you choose so it
encrypts those secrets before storing
them and even though somebody breaks
your database just gonna get jabbers for
encryption they use an a AES cipher with
the girliest counter mode and the master
key sharing is I think done in a cool
way so when you so volt uses an
algorithm called
Shamir's secret sharing so it creates a
master key and then it splits it into
shards so during when you initialize
your vault it creates the master key and
splits into something called unseal keys
and this is the first and only time
you're gonna see all your keys in one
place so you should distribute them to
the developers who trust to the people
you trust and every time voltage starts
or it restarts it starts in a sealed
mode so you need to unseal it because if
it's in sealed mode sill mode the vault
can read from the database from the
backend but it doesn't know how to
decrypt the secrets so you need to
unseal it and to instill the vault with
the shamers
Shamir's secret sharing you need to have
a threshold number of keys so for this
example we created five unseal keys and
the key threshold is three so that means
that if you want to unseal the vault you
need to have at least three keys for it
to be unsealed and that's good that's
kind of cool
also you can see here the initial
process generates a root token so that's
that's the talk and that you should be
using only for initialization and
initial setup and probably throw it away
later because it can do anything and I
mean anything so you don't want to use
that so where can both store your
secrets there are many many backends to
choose from these are just some of them
you also want I want to somehow
authenticate your users here I can like
point out github because that's the the
one reason we we chose vault over TVs
and it's a it has a cool feature that
you can enable two-factor authentication
which i think is cool
also you need need a way to log the
usage of your Walt you want to see what
users what your users are doing there
are not a lot of options here but this
should be fine this should be enough and
you can even pipe it into something like
elasticsearch or elk stark org
Greylock so among there are other
features vault has one of those are is
dynamic secrets so you can vault can
generate on-demand secrets for some
systems like AWS you can create a SS
keeper and it adds it initializes them
with Elise so you can use the the
keepers for something you want and let's
say after an hour you just revokes them
so you can do that on the fly
it does data encryption which means that
it can encrypt and decrypt data without
storing them you can also look at it as
cryptography as a service we haven't
find a way found a way for to use that
but I'm sure some of you will it also
does leasing and renewal secrets it does
token revocation all you need right for
your enterprise secret management to be
complete it also has a Pro and
Enterprise editions
it adds web UI it adds some health
dashboards backups and stores
unfortunately I can't show you that
because it's you have to request
permission you have to request from the
eff for the guys to give you access and
we still haven't done
so yeah I'm going to show you how to how
it's easy to install fault on your
server so Walt comes in only one flavor
it's a binary file that you can download
from their server and it has bindings
for all the major OSS including FreeBSD
solar Solaris and of course Venus
Windows and Mac and you get that single
binary you put it in when the well-known
path and it contains the client and the
server so there's no separation here you
also need to choose your back-end where
you want to store your secrets here we
choose console and this is a simple
configuration of vault everything you
need to do for vault to be running so
you choose a back-end and you list
listeners where you want DeVault to
listen for the API requests and this
here even though it looks like Jason
isn't Jason it's a hhcl
or hash she called configuration
language I don't know why the guys made
that why I didn't just use Jason because
it's a superset of Jason but hey it
works and it's pretty easily readable so
now you have your configuration you
start the server using that config file
and your service is running right this
is the part of the the server part of
the binary so now that the services the
server is running you need to initialize
them we went over that already you need
to unseal it this is the process you
enter one keys it increases the progress
count and so on until you enter at least
three the cool part here is that it
remembers which excuse me it remembers
the progress so if even though if you
entered wrong key just will say unseal
progress one so that's cool um but
before you can use it before you can
store and read secrets you need to
somehow authenticate yourself to devote
that you are the user who has the
authorities who has the authority stood
to do that so we here enable github as a
identification back-end the default back
and it uses for identification is simple
token identification so you can use your
root talking out of the out of the box
and here we we map organization on
github called awesome Corp to our vault
which means that anybody who's in our
organization can use vault and that's
cool because ok I'll come to that later
and final thing final key keyboard I
need to introduce you to is policies so
here we have a simple policy so anybody
who has that policy associated with them
can read and write on path to secrets
path so that path is arbitrary you can
put anything there and anybody who has
that policy will it can read and write
from that path and you have a policy you
created the policy you have to map it to
something so we mapped our policy to a
team on github called dev team so that's
a team in our awesome Corp organization
on github so everybody each person so
here's the cool part so when you create
a project you create you map these
policies right your dev Ops guys creates
these policies maps all he needs to map
and then you just need to drag and drop
to a you need to add persons the
developers who need to use those secrets
in a github team and he just has access
to to those secrets
and there's an added benefit here if
somebody is some developer is going to
leave your company you know in each vari
in each team he was in you just need to
regenerate those secrets you don't have
to regenerate all of them so that's cool
and before we can read and write from
vault of course you need to on Teta kate
yourself you get you generated token or
get github and use a method github to on
dedicate yourself and here we see that
you're authenticated and you're given a
token so you're all your next reads and
writes are using this talking and that
talking has a duration list so when the
duration expires your token is no longer
well it and there are policies
associated with that token so this token
can only read and write from default
policy and their policy and now you can
write and read who but really is pretty
simple and it's fast to start it up so
here we have we see that so there's both
read and write you write to a path
explained earlier you read two paths and
you write arbitrary key value bellies so
we here we are going to store four
equals bars of whiskey bars value to a
path to secrets path and everybody who
has access to it can read from that and
they're gonna get full bar right so
here's a here's a workflow to better
like visualize visualize so the upper
goes to github gets his github token and
then does a vault out to authenticate
himself with Walt Walt then asks github
what what team is that user in github
responds with some try this
so he's in those teams then Walt look in
his own policies to see which policies
are associated with that with those
teams he gets back
array of policies and you get a talking
back that's associated with those
policies and now that you have a token
you're gonna read and write so here we
try we're trying to read from path to
secret Paulding goes into policy sees if
that token has a read permission on that
path and if yes is going to decrypt the
secrets and it's gonna give those
secrets back to the user
any question on this no go so here we
have our image from before where we can
see now that our users all of our
developers can read and write from Walt
and our servers and our CI services
mainly only needs to do reads so before
each build you need to find out you need
to read you need to download the secrets
and before every deploy you need to
download to see the secrets so your app
can run okay so I'm gonna show you so
here's the thing as I said before those
parts paths are arbitrary so they can be
anything you want okay not everything
you can try to sis because this is it's
a part where both sources conflicts but
anything else is acceptable so how are
you going to communicate with your
colleagues and your servers where'd
those secrets are stored I mean the
logical explanation here you can just
write in readme but we add in phenom are
working with hundreds of projects and
naming convention is a must here so we
use something like this so the the first
part of the path is technology so let's
say rails the second part of the path is
a git repository name mainly because
it's a name associated with your project
which doesn't change and once
once it's initialized it usually doesn't
change right so let's say it's an
awesome app and the last path of the
path let's part of the path is
environment because you have multiple
environments so let's say production now
we know that in that awesome app project
there are there secrets stored in
production development and staging and
everybody knows where they should look
right I mean you can still write them
and read me but do because it kind of is
a tedious somehow tedious to remember
all what you need to do that you need to
authenticate before you can read and
write of course we did a little open
source tool for that
that's called secret CLI it's a ruby gem
because we do Ruby and it uses the
official Walt Ruby client and it
simplifies your workflow for the
projects so it has three main commands
the first one is in it where you in your
project you run secrets in it and create
a simple config file we just says what
file you want to store in secrets
involved and which path you're gonna
store it in you might notice the last
part is missing because we assume it's
an environment it knows that from your
environment and of course that that's
the secret config file you're going to
store in gate because nothing really is
written there there are no secrets here
but I your servers and your other
developers need to know where they are
stored so exactly there's secrets push
where you push your secrets we did this
deep think because volt doesn't have
versioning of your secrets and there's a
github issue for it but they said that
not there's probably not going to
implement it because it's hard
so we did this like DIF check before you
actually they are actually stored so you
don't overwrite something crucial and
you might have noticed there's no often
authenticate here so each of those push
and pulls does authenticate before it so
it's totally hidden from you so you
don't have to remember that yeah and you
pull from them from the secrets and
basically that's it
that's fault so as I said earlier I'm
from in phenom we do we are in the well
the we are independent design and
developing agency more than 100 watts we
do some other cool stuff so you can
check us out and that's it
are there any questions yeah yeah so you
beside your beside your application you
install let's say you're using our
workflow with secret right or even if it
fault you need to install vault on your
server let's say you're using secrets
because it's an easier example so you
beside your app you need to install the
secret so it's just gem install secret
CLI and then you just do secret spool
because in your git git files there's a
there's a config file that secrets can
read and he knows if you specify the
you're gonna specify which environment
production you're gonna use it just
downloads the files directly on the
server where your application can read
it no it's not because you have your
script you're heavier builds right you
have your scripts which build your
project we use rails so we do all our
scripting on that we use script tool
that just clones argue it and thus some
linking and in the middle of that it
pulls from from vault the secrets from
vault
if you don't know how exactly how Java
is built but before you build it in your
jar I suppose you're gonna download the
secret somewhere on the server where
that jar can read it yes that yeah
that's right you need I mean you can do
it either way you can do this before you
compile your app right on your local
machine you can pull example elixir is a
so it's a compiled language when we
build our application let's say on we
have a CCI server that builds our
application right the CI server does the
pools D pulls the file from from vault
and it compiles everything in it and
just pushes the artifact on the server
or if you're using something like rails
where you don't have to compile anything
you can just do that everything on the
server and it's automatic every time you
just need to add somewhere there you
need to add a line which says both from
vault or sorry or if you want yeah yeah
that's basically it I mean you can this
is one example of Fitz use of its usage
you can there are many more clients for
vault I think there's a Java client for
vault and you can actually hard code the
downloading part of secrets in your
application if you want right okay sorry
yeah there's also there are tools to
help you with that
basically um there's a sorry
so the question here is the listening
part of the of the vault
doesn't have to be access externally or
internally basically that depends on
your usage you can install vault
directly on the server that your
application is running then it can be
only internally but we set it up so it
can be exits from the outside so each of
our server which are who knows where you
can access it know so you can have a
cluster of faults and they're there you
can put multiple listeners on them and
also their there is a vault promised
assume the high availability feature so
if you're using something like console
so you can have a cluster of consoles
and a cluster fault to handle your
request right yeah you can have a like I
don't know nginx behind it before it and
it can load balanced your request
because at the end it writes in the same
database okay yeah
until yes yes every every server needs
to be unsealed before it can be used
yeah unfortunately yes
so the question was if one of those
volts volt service fails or crashes when
it starts up it starts in the seal mode
and you - you need to go there manually
to unseal it
that's the secret that's the secure part
of vault you don't want some kind of
random power failure to give it access
to to everything else right anything
else any more questions
cool yeah that's it done thank you for
time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>