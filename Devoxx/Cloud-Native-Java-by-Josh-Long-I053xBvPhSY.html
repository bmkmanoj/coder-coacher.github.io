<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Cloud Native Java by Josh Long | Coder Coacher - Coaching Coders</title><meta content="Cloud Native Java by Josh Long - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Cloud Native Java by Josh Long</b></h2><h5 class="post__date">2017-06-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/I053xBvPhSY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay my friends welcome everybody thank
you so much for coming we have so much
to go through and so very little time
what time is it now it's a 1106 it looks
like so let's say 1106 we're going to go
to we have 55 minutes to twelve o'clock
basically 12:01 is what I'm going to
endeavor to be done but we'll see how
that goes
we're going to go through a lot of stuff
today and I worry that you are going to
feel like you have to follow along with
everything that we're going to do and
that it's just not that's just simply
not the case instead I would hope that
you record that get repository URL up
there keep that repository link for your
own edification for your own reference
for later on we're going to go through a
lot of stuff but you don't have to keep
it all right now it's just for later
it's a reference right the goal is to
understand what is possible not how
exactly to do it and I'm sure you'll get
most of that but just in case just
understand the goals right I am happy to
answer questions if you have them I'm
always happy to engage I love talking to
the beautiful community the beautiful
community that works in there and the
ecosystem so if you're out there and you
have questions comments feedback
whatever don't hesitate to reach out to
me I'm on Twitter how many of you are on
twitter twitter twitter 2017 twitter all
right well the rest of you get on it
it's a great place to be it's a new IRC
it's where all the development and the
people that power the open source that
powers our businesses are so if you want
to engage find us on Twitter we're happy
to help out what about email e-mail
e-mail Imai you'll email each email
anybody no well okay that's the thing as
well and your app if you're there I'm
happy to engage there it's not my
favorite place to be but it's certainly
an option so don't hesitate a little bit
about me my name is Josh long I'm a
spring developer advocate on the spring
team I have been for the better part of
the last seven years I'm sorry all eight
years now I am an open source
contributor I am the number one top
ranked most visible most prolific most
highly lauded most acclaimed contributor
of bugs but still number one number one
contributor of bugs to all these
projects spring boot spring cloud spring
integrations bring bad BOTS and timely
activity more
bugs per commit than any other engineer
on the team not thank you thank you
exactly I should stress I didn't fix
them I may have created them anyway
whatever there's that and I'm also a
book author I do blogs and articles and
whatever I can to help people find a way
to spring so I've just finished up the
second edition of my videos building
micro services with spring boot live
lessons with my friend the one the only
the amazing the inimitable Phil Webb the
co-founder of spring boots I have just I
mean like last week I just finished up
writing and editing cloud native Java a
book for O'Reilly that'll be published
very soon it's all about how to build
applications that survive and thrive in
the cloud for those of you wondering and
I can I can see it in your eyes I can
see the curiosity welling up in your
eyes that bird that bird is a blue eared
Kingfisher it's a bird and this is
particularly salient given our location
and our proximity this is a bird that is
indigenous to the Indonesian Java Island
in English we would say that it's native
to the Java Island and it's a bird in
birds birds fly often through the clouds
so this is a bird that is native to Java
it's a bird that goes through the clouds
and it is native to Java it's a cloud
native java bird thank you thank you
anybody who knows anything about
O'Reilly books knows that the most
important thing is the animal on the
cover nobody even cares what you write
in the middle it's just a cover animal
that's the most important part seriously
we have you know we had to like contract
negotiations who cares we argued about
the bird so there's that and I work at
pivotal and this artwork by the way is
drawn by my teammate the one the only
the amazing ashley method tomorrow great
artwork I love these I love the
iconography it feels like the sort of
pivotal logos and opens there's projects
that we care about drawn as you know as
drawn by the Simpsons I think that's
great now there's a these are just some
of the projects that we have a pivotal
including Cloud Foundry spring of course
and
Apache Tomcat RabbitMQ lots of great
stuff right all this great open source
stuff but let's be very clear this is
not the reason that anybody any of us
work at pivotal it's not the thing that
we care most about instead what we care
about it pivotal more than anything else
the thing that helps us and spring out
of bed in the morning is our ability to
help customers and community members and
organizations deliver value quickly and
safely to production to go through the
workflow from concept or concept all the
way to cash into production basically
write profit we want to see value
realized in a production environment we
know that a lot of organizations want
that as well they struggle though they
want to go faster they wanna be able to
deliver software on the same sort of
timelines as these sort of internet
luminaries the likes of Netflix and you
know Twitter and Google and eBay and so
on and and ruber these companies that
are delivering softer faster and faster
and faster keeping themselves well ahead
of the competition they know that they
need to go faster and they need to build
to capture that agility but they
struggle with exactly how a lot of these
organizations are very lucky
they have software that predates the
modern era the era of cloud computing
and the economics of cloud computing the
software was written 10 years ago more
than 10 years ago the software is a
great problem to have it's software that
has represented value for their
organization that it served them well
but now today because it is so large and
so successful it requires a lot of
people to make any changes it takes a
lot of people to move the proverbial
Titanic so these organizations struggle
they know that they need to go faster
but they had these large successful
let's be clear allocation but now that
largesse that girth is making it hard
for them to be able to evolve the
application to change the application
and to compete in an ever dynamic ever
accelerating marketplace so they look
for ways to decompose that application
they realize that the secret to agility
lays in how you deliver the software how
quickly you can deliver the software
even Google and Twitter and you know all
these other companies they are large
companies but they still deliver
software as though they're very small
and the way they do this is they
decompose their large applications these
large giant monolith monolithic
applications they
decompose them into smaller batches
smaller chunks smaller batches of work
that require less people to make any
changes to see any changes reflected in
output smaller batches of work that in
smaller groups that people can work on
to sort of device features to deliver
the features to test them to reason
about the impact of those features this
decomposition is important and the
question of course is how do you do that
well Eric Evans wrote about domain
driven design in his amazing book he
talks about this idea of a bounded
context a bounded context is a part of
the domain model that stands unto itself
internally consistent it's reusable it
doesn't require any other dependency in
order to do its job if you can identify
in a bounded context if you can identify
bounded contexts in your application
parts of the domain that can be
extracted from the rest that can stand
by themselves then you have a natural
place to cut or decompose the
application to break it into smaller
pieces this can be a service we call
this a micro service and micro service
is an organizational hack it's
optimizing you your organization so that
you can as a team deliver software
without the constant cost of
synchronization across team members it
reduces the cost of synchronization
because now each individual team can
focus on just their thing and stay in
her own proverbial swim lane it allows
them to go faster we call this a reverse
call a manoeuvre names of course from
Mel Conway in the 1970s he said that he
realized that software is a mirror image
of the organization that builds it if
you have a crack organization you'll
necessarily have crap software the trick
then so not have a crap organization
this is what micro services are and they
give us benefits but they have costs as
well there are two big pains I call
these the hemorrhoids
you know the pant a hemorrhoid is my
friends a hemorrhoid is a real pain in
the the first hemorrhoid of
microservices is how quickly from zero
to 60 or zero to whatever 120 km/h how
quickly can you build a production
worthy service how quickly can you build
a service that is worthy of being in
your production environment and all that
that implies DNS load balancing
heartbeat detection
purity observability monitoring all of
that stuff it's a very very high cost if
you can't do that then you won't bother
it'll be too prohibitively in too
expensive so you'll just put everything
inside of a giant big ball of mud
monolith you need to make the cost of
standing up a new service as cheap as
possible for operational concerns things
like observed things like Venus located
Venus you know scale out all that kind
of stuff I recommend something like
Cloud Foundry a cloud platform that's
optimized for managing applications at
scale for application concerns like
security and monitoring I recommend
something like spring boot makes it
simple to get past those sort of
checkbox requirements most organizations
then again most organizations not yours
surely not yours but most organizations
that I've been to have the dreaded wiki
page the wiki page with 500 easy steps
to production that wiki page is the
enemy of velocity is all the things that
you must do the derivative or working
software so you have to get past all
that that's the first hemorrhoid the
second hemorrhoid is once you've done
this once you've built a distributed
system where things are talking to each
other over the network across potential
network partitions you've now introduced
the complexity of building a distributed
system into your life and you need to
get past that as well so that's what I'm
going to focus on today is this second
hemorrhoid I'm hoping that some of you
have familiar with spring boots but I'm
not sure and we'll go through it over so
briefly today but that said you can find
a number of talks look for my beautiful
applications talk with my name so what
we can do is when building your
application here it starts out spring
deny oh this is my second favorite place
on the internet can anybody tell me what
my first favorite places thank you my
first favorite place on the Internet is
production
I love production you should love
production you should go is early and
often as possible bring the kids bring
the family it's the happiest place on
earth it's better than Disneyland
I love production so should you but if
you're not already in production you can
begin your journey here and start that
spring that i/o bookmark it keep it
close to your heart keep it under your
pillow
if you want for inspiration the early
morning before your cup of tea or coffee
start that spring today oh if your
children are restless and can't sleep
start that spring but I oh and if you
suffer from indigestion after a long
night of alcohol abuse and PHP start
that spring that I oh so we're going to
do today is going to build a very simple
application I don't want to sing spend
too much time on the application but I
want us to manage an application that
manages I want to build an application
that manages entities of type
reservation so we're going to use h2
which is an in-memory embedded sequel
database it's in memory and it's
embedded so it's going to lose all of
its data on every single restart very
similar in this way it's a MongoDB it
just loses the data all the time for no
reason all right very very similar when
use JPA the Java persistence persistence
API because I make poor life decisions
will use the config client for
centralized configuration will use
Eureka for Service registration
discovery Zipkin for distribute tracing
we're going to use a rest repository
support as well and the web support and
actuator for operational concerns now I
think that ought to do it that'll give
us enough but I encourage you at your
own leisure to peruse this list at your
own time and find out all these other
options lots of great choices and I
encourage you to make them when you can
I want to briefly ever so briefly take a
moment to look at these last three or
last two drop downs right these two drop
downs or what I like to think of as non
choices these are choices that you could
make but that you should not these are
choices in the same way these are
choices in the same way that stripping
naked and running in traffic is a choice
you could but but don't these are what I
think of as non choices and that's not
just Indian bread my friends
so the first choice of course is what
version of the JVM would you like to use
well of course in 2017 there is no
choice
both 1.6 and 1.7 or end-of-life expired
past the prime no longer supported not
available except for security updates
and even then only if Oracle is nice and
generous so no no choice at all really
the next choice is packaging a lot of
people get confused by this if by some
freak fluke of physics some terrible
accident of time-space you find yourself
somehow transported to the distant
distant past far far far far beyond
modern help then choose dot waar but if
you're here in 2017 in Singapore with me
today then choose jar this is a big part
of my overarching guiding personal
philosophy of make jar not water someone
hit generate and I'll give it I'll be
given a new zip file here I'm going to
go to my downloads directory here and
I've got the new zip file I'm gonna say
unzip reservation service CD reservation
service and I'll open up my my build
file there ok and we're not going to
spend too long building this application
what I want to do is I'm going to build
an application that manages entities of
type reservation it's just an entity
that we're gonna store in the database
and we don't really care all that much
about the entity what we want to talk
about are the sort of supporting
concerns now I'm using IntelliJ it
doesn't matter what IDE you're using how
many using IntelliJ I'm just curious
good stuff hot sauce well done what
about eclipse I'm gonna be using an
eclipse grant very cool what about knit
beans who's using a NetBeans NetBeans
anybody ok well it's still awesome as
well we're good Emacs are you here sir
Emacs guy where is the Emacs guy every
single country city and continent that I
go to there's one guy that's the same
human it's the same guy
same object identity I say who using
Emacs I do and then he leaves presumably
to go to the next conference to troll
again
whatever so let's see my friends can you
see that font let's make this a little
larger huh font more bigger okay there
we are so what we're gonna do is going
to have a an entity that manages type
types called reservation and I'm going
to make this a entity here I want to
make short work of generating getters
and setters and all that stuff so I'm
going to use the Java compile time
annotation process are called Lombok
right which is also a interesting word
in this part of the world in it so we're
going to say we're gonna have an ID
called private long ID it's going to be
an ID or we'll say it's going to be a
generated value generated value there we
are I'm gonna have a screen here called
reservation name and that's the entity
and I could generate getters and setters
and all that stuff but instead I'm just
going to use Lombok to do all that work
for me at compile time so these won't be
kept around at runtime and the result
isn't now when I go to my code I can say
reservation our reservation dot get
reservation name hash code set idea set
reservation name etc all that comes for
free by those annotations and what I
want to do is on to save instances of
this record type into the database I
want to say that I want to persist
records using the spring data
Jaypee a repository support and this is
an interface I don't have to implement
the interface or do anything in
particular to support it all I need to
do is to provide this interface
definition and I get support from
finding saving flushing deleting find by
ID all that kind of stuff right and what
I want is I want to turn this into data
I want to use that now to write data to
the database so I'll say sample data CLR
implements command lines runner okay and
what we're gonna do is when to create a
bean to just write some records to the
database at component and we're going to
use the repository here private final
reservation repository and I'm going to
tell spring to inject this as a
collaborating object in the constructor
and I can then use that now to write
some data to the record write some
records to the database right so my name
is Josh it's nice to meet you I've got
my buddy we learned in the front there
got my friend Jade as well
I've got Michael Nicola who invited me
very good I've got a manual I've got the
yeom
oh my Kristen okay Chris they're sorry
and we need one more who wants to be my
guinea pig I mean my friend well don't
all raise your ends at once now what is
it how do you spell it my friend
ve j PE j like that man like that nice
to meet you very good so all of us we're
gonna write these records to the
database we're going to say new I want
to save these records to the database
numbers can confirm that everything's
working by getting the response and then
iterating over each record using a new
technique that is only powerful in the
most modern of modern languages the most
modern and progressive of languages
languages like C COBOL small talk Lisp
Perl etc I'm using a method reference
right so a nice feature for last 50 60
years that in Java we just got two years
ago so there's that now what I'm going
to do is I'm going to run this code and
we should see it run it's going to start
up and is going to try and do its work
it's going to well I just compiled it
now I wanted to control
there we are so it's going to start up
it's going to print everything to the to
the database and the Corvette and
reflect that in the console there and of
course this isn't this is nice but it's
not nearly enough right there we are
there there's our names but we need a
REST API so let's build one I'm going to
say at repository rest resource and then
we'll just restart the code again this
time with our spring data interface and
I could use spring em you see here but
spring data makes it easy to build that
API for us out of the box so
localhost:8080 forward slash reservation
hello there we are there's our REST API
there's all the things that we care
about and I can do you know put post get
delete I've got hypermedia these are
links that support self discovery or
consensus client-side the auto detection
of API and rest endpoint it has stateful
information as well this is part of a
design pattern how do sha hade EOS
hypermedia as the engine of application
stage it's the idea that every resident
resource have enough information for the
client to further manipulate that
resource without any off priori or
upfront knowledge now each of these
payloads is an envelope it's called a
resource this is a resource object it
has a payload of type reservation as
collection of links so am I done
of course not right I got a nice API but
they're still concerned that I need to
care about right I need to make make
it's observable I need to be able to see
what the application is doing and to be
able to use the information if there's
an incident if there's some demand for
an incident response right if something
goes wrong doesn't matter what company
you talk to in Silicon Valley all of
them have basically the same response
procedures and it's all human driven
human beings need to see information
present status information and use that
to be able to make decisions and go
forward right so I have now my endpoint
here and I'm going to use that use all
this information to visualize what's
happening I can go to metrics for
example to see the current state the
metrics that eat the uptime the class is
loaded I can go to env that shows me the
environment of the application I can go
to health and this shows me the sort of
things in my application that could fail
the dependencies like my file system my
data sources cetera so this gives me a
lot of insight into what the application
is doing and supports a smart response
right if something goes wrong this is
provided by the actuator framework and
this is inspired by other companies like
Google Google says doesn't matter what
the nature of their services doesn't
matter if it's big data machine learning
artificial intelligence bad web whatever
they have standardized HTTP endpoints
that they're centralized monitoring
infrastructure can use to corral all
that into the single places in time
right it supports it supports that ever
important single pane of glass that
dashboard and we need that in building a
distributed system right so this is
certainly very nice but I want to change
things about the application I can I can
show you that I can change certain
things here the properties I can say
server deployed equals 88n example and
then we start and they'll start up in
port 80 10 and that's certainly a good
start but it has a few limitations
definite it has a few limitations
because it's limited to the file itself
in the product end up in the application
if I'm going to change the port when I
moved it binary from one application to
another I don't want to have to do that
I don't want to have to recompile the
jar so instead what I can do is I can
kill this code here and I can say maven
- T skip test Yolo clean install
okay and we go to the target directory
and there we are there's my so-called
fat char or you know my self contained
jar and it's got everything I need there
to run its 51 Meg's I can put that an
email I can send it to my dear Grandpere
grandma and grandpa they're very smart
but they're not super computer literate
they can still run this they have
applets right so that's all you need so
if you're up if your operations teams
have trouble deploying this if they need
websphere tell them to call my grandma
she's very smart and she has cookies
she'll help them to get to production
faster write Java - jar reservation
service that jar there's my application
but I want to be able to change the
configuration like I said so I instead I
could say I could say - peas server dot
port equals 8020 and this will override
the configuration in the property file
now this is a good start I think
certainly a good start but it falls
short of for use cases what if I want to
reload the configuration of all the
services running what if I want to keep
all the configuration in one place how
do I support simple secure encrypted
passwords and properly locators things
like that I don't want that in the file
system laying around unencrypted do it
and then finally how do I support
auditing and journaling how do I see who
changed what and when and if necessary
to roll that configuration back for this
and more well this is a good start it's
not enough is it so what we need to do
is to to use something a bit more
sophisticated we going to use the spring
cloud config server right so here's this
the spring cloud config server come on
why fight there we are so I'm going to
use the spring tide config so we're just
going to build a new one once a config
service config server I'm going to build
that and then I'll give us a zip file
downloads unzip config server C config
service idea palm that XML oh did you
hear that that's amazing I just cracked
my neck and it felt so good so here we
go application up properties this can
fixer is a micro service it's going to
manage our configuration it's going to
manage a configuration directory and so
we tell it to start up on port 8080 it's
going to manage the directory that we
give it so we have to tell it where to
find the configuration directory and the
directory is going to be based on git
you have lots of options today in 2017
for reliable version control of your
directory you can use git git is also a
nice option I've heard good things also
about git you can use that as well lots
of lots of great choices here just get
or get or get right so I encourage you
to take a look at one of these fabulous
technology they're all well supported
what we want to do is make this a API
that manages our directory in the
directory of course it's going to be a
get version directory full of property
files like this one I'm going to clone
this directory onto my local machine
like so okay and we'll say CD desktop
get clone to the considered directory
it's just a bunch of property files and
so we're going to start this application
up here we are good and it's going to
respond to requests from other micro
services so imagine you have a micro
service called the reservation - service
when it connects to the config server it
will see these two property files
reservation service type properties
which is only for that one micro service
and application of properties which is
for every micro service there are two
keys and values that we care about here
server port equal 8000 and we care about
this message that to the hello world so
let's go back to our reservation service
here get rid of all that we don't need
it we need to give our micro service now
a name so it's going to be call the
reservation service and it also needs to
know where to find the config server
like this you can say localhost 8080 and
that would be fine but this is the
default value so i'm only showing it to
you now because I care I'm a giver
but I may forget for the rest of the
talk and that's okay this is going to
work by default unless you change the
most important okay now let's use those
keys and values let's connect our
reservation service to the config
service and tell it to grab the message
that we said the hello world right so
private final string value and we're
going to inject this in a constructor
like so so at value okay message I'm
going to create an endpoint here at get
mapping forward slash message string
we'd return this dot value very good so
those are our rest controller our micro
service that's going to use that rest
controller I can imagine one thing to
change this later though I'm going to
make this being a quiz fresh scope so I
can reload the configuration instead of
having to restart the process every
single time let's confirm that this has
worked by going to port 8000
reservations that's working and there's
our message helloworld that's working
good let's change our configuration
though I think this configuration value
is good but not great so I'm going to
use Emacs because I'm not a savage
alright so I'll say Emacs
reservation service type properties and
we'll change this message to be
something much better not just the world
but Singapore right so extra exclamation
marks okay get commit - a - M Yolo
very good so to go to our config server
it sees the new value immediately where
our microservice has no idea we need to
tell it to redraw its configuration and
we can do this a few ways the simplest
is just a call the actuator endpoint
called refresh so you say localhost 8080
there's 8,000 forward slash refresh and
I'm going to send an empty HTTP POST
right like this so before I before we
actually do this let's let's line it up
right so here we go I've got the
terminal on the Left I'm going to make
I'm gonna hit enter and then it's going
to make a request of the actual web
service on the right and as soon as it
can it's going to refresh that one bean
and I'm not going to you know I'm going
to try and be it I'm gonna play this
game that I always lose like that
terrible game Angry Birds
I'm going to play this game where I
always do is I'm going to try and beat
the system to the browser to get it
before it's refreshed it
yeah oh okay
one two three Wow nevermind I lost the
game so I hit enter and as soon as I hit
enter I hit refresh from the browser and
the key was a video immediately visible
didn't have to restart didn't have to
recompile didn't have to redeploy that's
because of that refresh scope annotation
here this annotation tells spring to
recreate this one beam this is great
because now I can see that new value it
gets a message key re-injected from the
config service the config service is
also I can secure every link in the
communication from the config client to
the config server and from the config
server to get repository all of that can
be SSH or you know certificate based or
h-2b basic authentication and I can also
say to the client enter again to the
config server if you have the same key
then you can do symmetric encryption and
decryption you can have encrypted values
in the property file that get decrypted
on the client when they do a handshake
so I have a lot of power by introducing
this config server and it supports
things like feature flags and I can now
deploy I can now get couple the
deployment of software from the release
of that software it makes it easy for me
to you know activate certain features or
to keep them dormant in the code until
it's time to turn them on from the
business or whatever right this is one
useful feature the next thing that
becomes useful when you move to a
distributed system is making it easy for
one service to find and work with
another this is a very very interesting
use case because in a dynamic cloud
environment things come and go all the
time
they're not available all the time right
they may go down based on lack of need
and then they may scale up when there is
more needs so we have to make it as easy
as possible for one service to find and
work with another service even if that
location changes of this location of
that service changes DNS is kind of an
okay option but not really right in a
dynamic cloud environment there are
several limitations for DNS first of all
most cloud environments have public and
private DNS so makes your code more
complicated
second of all DNS is a very simple
protocol it knows where the service
lives it doesn't know if it's alive
think about it as like you know you know
where your friend lives but you don't
know if he's out outside you know at the
mall or something like that right it
could be at home but it could not be I
want to be able to ask the question is
that service there if I make a request
will it block or will I get a response
right if it's going to blow
then I don't want to call I want to do
something else I want to degrade
gracefully and another problem with the
NS is that clients are pretty stupid
about it right Java for example is now
21 years old it's old enough to drink
alcohol in the United States Java caches
DNS with entries so when it goes to a
DNS server it gets to get the IP address
from the DNS entry I keep that IP
address and then it called the IP
address again and again again it doesn't
go to the DNS server again so if you're
using a DNS load balancer you have just
broken your load bouncing the first IP
that you get will be unfairly done piled
it'll be prioritized right so these are
bad behaviors and you can you can change
all of this but you have to know a lot
about everything and yet to care about
all these things to get that result so
instead we're going to use service
registration and discovery and a lot of
good service registries out there a
service registry is a logical mapping
from service ID to to the services IPS
and other stuff but and spring cloud
provides an abstraction that you can use
it makes it easy for you to talk to
these different service registries I
happen to be a big fan of Eureka there's
a lot like I said a lot of them that you
could use but Eureka is a nice fit for a
couple reasons
first of all it's easy enough to get set
it up and using usable for demo and
second of all it's been used at scale if
I want a large websites on the planet so
we know it works right now again this is
just Eureka I'm using a week up you
could also use you can use a patchy
zookeeper you can use hash encrypt
console you could use HD use cloud
planner itself I mean there's a lot of
options here right but I'm going to set
up a you week of service and we'll start
that up and that's going to start up on
port 87-61 okay
there we are there's our registry
there's a few things going on about this
a few things we should care about first
of all very well done mouse over that
took a long time we have doctors on the
spring team people are very very smart
PhDs they worked in nuclear physics so
it makes me very happy to imagine it
someday somewhere somehow there was a
github issue that said damn it
we need good mouse overs look at that
huh that took a year anyway
uma um we have no applications
registered yet either no applications in
the registry not available for
consumption so we need to go back and we
need to teach our reservation service we
need to tell it to register itself with
the registry and this is possible
because we have the discovery client
abstraction in spring cloud and that's
supported by this implementation for
Netflix Eureka so all we need to do is
to say a table come on
at enable discovery client and then we
start so let's go to raise to 10 it's
going to say I'm here if anybody needs
me find me here this is my P this is my
name this is my port etcetera and now we
can build a client something to talk to
our service then we're not just building
a client for the built for the sake of
building a client we're building what's
called an edge service right an edge
service is the first part of call it's
the first service that gets called when
requests come in from the outside into
your application so we're going to use
the web support when you use rest
repositories I'm going to use Lombok
we're going to use sane for declarative
REST API is we're gonna use actuator for
observability we use the history circuit
breaker when you zoom for the micro
pocket support we're going to use the
the zip contribute racing and you recap
for service registers and discovery and
use the config client and I think maybe
for now that might be enough
maybe OAuth you want to off we're not
much of preemptive time we'll come back
to it maybe so we'll hit generate and
we're going to do is going to build a
client as I say that's going to be the
first port of call for requests coming
in from the outside world and this is
important because remember in the world
there are all manner of different
clients right all sorts of different
ideas of client and if you have to
change every single micro service
every time you add a new client your
system you'll constantly be deploying
and redeploying all of your micro
services each time you add a new client
that's a not that's a non-starter right
even the most boring of organizations
today support iphone android and html5
guaranteed right that's the most boring
you can at least you can do today in
2017 three different clients already so
you're building they're very much in a
client centric world right here in
Singapore your roads have IP addresses
they feed into a cloud they are they use
them for traffic shaping right for
actual traffic shaping that were not
network traffic jamming
like car traffic your your roads our
clients to somebody's service right
there are human beings walking around on
the planet with organs prosthetic organs
or synthetic parts of their body that
have IP addresses right so somebody's
organ is a client and somebody's service
you know you bet Playstations your Roku
is your smart homes or TVs or Smart TVs
here you know your Xbox is all these
different things that have IP addresses
and they can be clients html5 is a very
common example html5 browsers today are
super powerful they can do a lot of
really cool things but they run in a
sandbox and that sandbox makes it very
hard for them to talk to other services
on a different host important right this
is the single origin policy right so
what we want to just want to make it as
easy as possible for html5 browsers to
talk to other services so we could add a
access control header to the downstream
microservice and the downstream
microservice can say I expect and and
accept requests from this particular URL
in this URI that's most important I can
do that but I would have to change my
service just to allow the html5 plan
that's a non-starter I would I don't
want to deploy all my services again
just because I added an html5 browser
experience to my service to my
application right instead you can create
a micro proxy a proxy is just a nice way
to you know proxy the requests inside
and outside from the outside into the
downstream services and we can use dual
now so of course was created by Netflix
it's also for the first Ghostbusters
movie that's dual how many of you
remember ghostbusters there is no Dana
only Zuul right this is dual the monster
he he or she or it or whatever is a
guardian a gatekeeper to the underworld
to the inferno it's a proxy to then the
world get it the door in their mind is
it fine give it time
give it time so there's that and Zhu
works in conjunction with our sprinkler
discovery client abstraction so here are
the services now they're registered in
the registry reservation service on this
IP does service ID in the sport and now
I can use that service name as part of
my proxy lookup I can go to 9999 and I
can say let's call the reservation
service using this URL and says
localhost 9999 reservation - service
forward slash reservations this is the
proxy URL here's the actual URL right so
actual versus proxy actual proxy actual
proxy actual passing actual proxy actual
proxy actual a proxy actual
proxy actual proxy you can see a few
things that are different about this
first of all the URLs have the service
ID in the context path that's how the
client the proxy is making the decision
about which node to call well it knows
which service to call in a way but it
doesn't know which node does it how does
it know to call this instance instead of
that one there's no load balancing
there's no there's no load balancer and
playing here is there the load balancing
happens on the client thanks to
something called Netflix ribbon Netflix
ribbon is a client-side load balancer so
if you want to do more sophisticated
kinds of load balancing you can do LRU
or least recently used kind of load
balancing you can do round robin or
sticky sessions of course but what if
you want to do you know Oh off token
aware load dancing I have a token coming
in from a client and that token belongs
to a user that has some sort of ongoing
job that's running on this node where's
the where's the check box in your f5
that supports that all right there is no
such thing you need to write that code
and you can do that thanks to Netflix
ribbon the ribbon load balancer runs on
the client in this case it's running on
the proxy before the request is made to
the downstream service it goes to the
service registry it gets all of the
service instances for a given service ID
and it passes the collection of service
instances - ribbon which stem says you
know I choose you like a Pokemon right
then it finally makes the request and it
comes back all in the heartbeat all in a
very very blink of an eye so you get the
request the other thing you may have
noticed is that the URLs are correct the
URL here is actually relative to the
edge service not then not to the actual
originating service so the URL here
short long short long the origin service
the edge service the proxy is making a
request to the downstream service and it
passes an origin URL in the headers for
the downstream service sees then it's as
though I'm going to rewrite my URL so
that it looks like it came from that
node the browser client or the html5
device or whatever doesn't care doesn't
know that that service was actually
generated or that response was generated
in some other node so okay maybe this is
enough if I have homogeneous HTTP based
services maybe I've got everything I
need here but a lot of times I want to
do more sophisticated things I want to
transform the payloads from one service
to another I want to translate them I
want to enrich them I want to you know
change the protocol maybe I want to go
from HTTP to you know Google protocol
buffers
thing like that right from JSON into
Google protocol buffers whatever the use
case is this is an this is the right
place to do that
so instead of just proxying data back
and forth right I could deploy mhtml
file browser device right now the client
and it could talk to my zoo LaMichael
proxy that's fine but instead of just
proxying stuff back and forth I want to
actually transform the data from the
downstream service and create a new
synthesized view of the data maybe I
won't have an endpoint that just has the
names so Josh and we ran and Jade and so
on just the names we can discard the
surrounding and supporting Jason strata
we don't need that we just want the
names right so let's go here and create
a new end point called the reservation
API adapter wrist controller right and
this is just going to be a controller
that's going to live here at at a
forward slash reservations and the
endpoint will have an endpoint here will
have a get endpoint that returns just
the name so it'll be localhost 9999
reservations for slash names this just
going to turn a collection of strings
right so when I return a collection of
strings I could use the Spring Framework
rest template right the the rest
template is a HTTP client that works
very nicely with you know web services
and this is a good choice but the rest
template doesn't know about our ribbon
client side load bouncer doesn't know
about our service registry whether it's
Eureka or apache a zookeeper or whatever
so we need to tell it to to do so to be
aware of that by adding a load balancing
interceptor and if I did that then I can
say well I want to call that data risk
template that exchange HCB reservation -
service forward slash reservations etc
etc right make an HTTP GET call blah
blah blah that's certainly one option
but I think this is a little low-level
right I don't want to spend so much time
writing code so many plate HTTP payloads
back and forth that's going to make it
expensive for me to to move data back
and forth it can make it cognitively
expensive if I have to rewrite all of
this HTTP marshaling back and forth so
instead I want to move up a little bit I
want to move up the abstraction stack a
little bit I'm going to use something
called fain fain is a way to build
declarative
ask clients it's from Netflix it's um a
you know it's based on the English word
Thane in English
Thane means to pretend it means to act
as so if you see an animal in the forest
I know you don't have those here but if
you did if you see an animal in the mall
and its head is backwards like this and
you can see its poor little heart it's
scared it wants you to leave it alone
it's pretending to be dead
it's feigning dead it's feigning death
it's not actually dead it's just
pretending to be so that you'll leave it
alone in the same way that websphere
pretends to be useful it's feigned
useful it's not it's not useful of
course not it just wants you to leave it
alone it's scared right so what I'm
going to do is I'm going to create an
endpoint that returns a collection of
reservations in the envelope object
remember the hypermedia api that we paid
earlier it's got a resource payload a
resource root and that resource room to
have a payload of type reservation and
it has a collection of links well I
don't have this type here do I don't
have the resource I don't have the
reservation type on the class path here
so I could copy the one from the service
that would certainly be an option but
that would unnecessarily couple my
client to the implementation details on
the service and in particular it would
couple my client to the fact that the
service is implemented with JPA so I
don't want to do that I'll just create a
client Aditi oh but you can use things
like like contracts for example to do
the work instead so here I'm saying call
the reservation service load balance
request across the different instances
in the registry and then pick use it
whenever somebody makes the request to
calling this method they can h-2b get
called to the reservations endpoint in
the reservation service IP that we've
gotten back there and now I can rewrite
this code I can say let's inject this
reservation reader and use that to make
the call
so read get content dot stream map and
all I'm going to do is I'm going to just
map from the hypermedia api to the
payload and then from the payload to the
collection of links capturing all that
in the list so there we go there's my
little client I'll take I'll run that
and that'll certainly work I suppose
right that'll certainly get us part of
the way there
but it's not going to be great is it I
mean it's gonna be it'll do the 80%
Kings wanted it'll do the 80% case
localhost 9999 reservation names there's
there's our names that worked okay but
it's missing that 20% case this is going
to work fine if there are one or more
instances of that service in the
registry what if there are zero
instances in the registry you can't load
balance if there are no instances right
that's like dividing by zero and we all
know what happens if you divide by zero
don't we what is zero divided by zero
what is zero / oh wait a minute what is
zero divided by zero imagine that you
have zero cookies on you split them
evenly among zero friends how many
cookies does each person get see it
doesn't make sense and Cookie Monster is
said that there are no cookies and you
are said that you have no friends it's
true
don't make Cookie Monster sad don't try
to load balanced by zero it's just going
to blow up into clients face and that's
not a good experience right we don't
want our iPhone users getting a big fat
Java stack traits in a client in a
sufficiently distributed system services
will fail it's not a matter of if it's a
matter of when and it is our job to
build systems that do the right thing in
the case of that particular degradation
so in this case I want to make sure that
if something goes wrong in the
pejorative sort of least common case
that we degrade gracefully one way to do
this is to use a circuit breaker to do
it so I can use a circuit breaker and
I've got this on the classpath it's
called hystrix the circuit breaker makes
it simple for me to specify fallback
behaviors so here's my I'm going to say
whenever something goes wrong and is
read method call my fallback method here
public collection of string fallback
right return new ArrayList all I'm doing
is I'm returning an empty array list if
something goes wrong this is not just a
try-catch handler though this is much
more intelligent its stateful so if
enough time if enough requests come in
and they all fail that circuit breaker
is going to see oh this is not working
it's just going to move the train tracks
it'll switch the train tracks to the
fallback pathway it's not going to call
a constantly that service that isn't
responding it'll eventually try again
it'll heal itself and let request go
through again it'll try to but if it
keeps failing it'll go back to the
fallback method alright if you're using
carpentry right if you have something
like that then Cloud Foundry will do the
right thing
it'll make sure that when you call
downstream service that isn't there if
the service fall down it'll move heaven
and earth all day and all night to
restart that service all right it'll
wear the proverbial pager but it's our
job as developers or architects to build
a service that does
right thing in the face of that failure
this is what we're doing here that
circuit-breaker degrades gracefully it
gives us this empty rlist
eventually when we restart the
reservation service let's pretend we're
cloud vendor right now when we restart
the reservation service it's going to
re-register it's inert startup it's
going to re register with the registry
the registry is going to send a
heartbeat event out to the clients the
clients are then going to invalidate
their local cash perspective of the
state of the service registry and
they'll see the updated entry for that
reservation service in the list of
services that are there and then we'll
let request go through it'll heal itself
but it's our job to do the right thing
here we all know that if a web service
is performing poorly that the best thing
that you can do is to refresh the
browser a lot right of course not
same is true for your distributed system
we want to pound our web service when
it's trying to come back online do eet
so this gives you that ability to
degrade gracefully to heal your services
then eventually you know after 30
seconds or so this will come back online
and everything will be fine now we have
our endpoint we have our service we've
used that stroke that circuit breakers a
as a way to protect our downstream
system come on
Oh zip it that's not related there we go
so there's our service it came back
online you can set up this you can
reduce the threshold therefrom to be
much less but I've got it set to the
default so now we've got that service
we've got the we built a system that
does the right thing in the face of
failures for the reuse case for the
right of course you should look at
things like eventual consistency if you
things like spring clouds stream this
helps you build systems using messaging
like Apache Kafka RabbitMQ so that if
you do a write and the downstream
services in there the broker can absorb
it and it makes it very simple to write
this code without worrying too much
about the plumbing of messaging code now
in this last sort of 10 minute stretch
here I want to focus on building a
system and talking about observability
we saw in the very beginning of this
talk that we looked at actuator we saw
actuator and actuator supports observing
the state of a single service but we
haven't really talked about systemic
visibility and observability remember
when I walk here in beautiful Singapore
if that's the same thing I'm walking on
the streets of I'm on Arjun road walking
through all the malls is that the same
thing as looking at the Google map can I
can I get the same feeling the same
effect of looking at the Google map for
Singapore as I can by actually being in
Singapore isn't one much different than
the other I would say of course yes it's
much different being here in Singapore
is far more alive far Mountain moment I
started after five minutes after so
being here in Singapore is far more live
far more vivid far more interesting than
being then looking at the Google map you
cannot appreciate one from the other the
map is not the terrain right and this is
true for a distributed system our
architecture diagram is not the same
thing as our distributed system we can
only appreciate the image the
distributed system by monitoring it by
being in production with the system you
can't just make assumptions about it by
looking at the architecture diagram
there is a merchant behavior that we
need to capture that circuit breaker is
a nice place to start that circuit
breaker represents a connective tissue
from one service to another as we make a
call if that downstream service isn't
there our circuit breaker opens up and
that stage is there and we can monitor
that state use it as a proc
for the downstream service I am a very
very you know I'm a lifelong optimist
I'm a very happy guy
I know as an optimist as an optimist
that is very happy and has a lot of
faith in humanity I know that everybody
will fail me all the time and that they
cannot be trusted to write code at all
they'll go off and do terrible things
using MongoDB and PHP and they're going
to expect me to talk to it I know that
humanity cannot be trusted at all their
terrible terrible people that's the
optimistic perspective the pessimists
would say there's nothing that I can do
about that
and I'm not a pessimist I can protect my
systems against their terrible terrible
terrible life decisions
so that circuit breaker is one way to do
that if I cannot change their code I
cannot add my monitoring infrastructure
to their systems but I can monitor that
circuit breaker that circuit breaker is
like monitoring their systems and we can
do that using the circuit breaker
dashboard hystrix dashboard config
client Eureka hystrix dashboard hystrix
- no come on here we are good hit
generate downloads unzip hystrix
dashboard CD hystrix dashboard ID upon
that XML okay and what we're going to do
is we're going to monitor the state
that's coming off those circuit breakers
thanks to a stream that each circuit
breaker gives off right so let's go to
our code here and start this up at
enable hystrix dashboard at naval
discovery client okay we'll start that
up and what that's going to do is it's
going to expect a server sent event
heartbeat stream stream that it can use
to visualize the flow of data through
that circuit breaker all right let me
how's that okay
this circuit breaker localhost
reservation names the circuit breaker
goes on
come on
maybe I have to use Firefox
that's so disappointing okay now
well the circuit breaker scream goes on
and on and on and on and on forever and
ever and ever and ever it is endless it
has no end
is like the oceans and the skies and the
stars and the bugs in your code just
infinite just endless and so whatever
you do my friends whatever you do do not
and I cannot underscore this enough do
not curl this endpoint so I'm going to
do is I'm going to take this endpoint
here go to the load I'm going to go to
the circuit breaker dashboard localhost
a t10 HTM in strict Edison L I'll paste
this value in and I'll make some
requests on the left as I make requests
on the left you can see the moving
average trending ever upward on the
right it shows me that I've made 25 31
37 requests that the circuit breaker is
closed but if I were to kill the
downstream service this would show we
open I can see the moving average of
flow through that circuit a request to
that circuit I can of course multiplex
all of the circuit breaker dashboards
into one all the circuit breakers rather
into one dashboard using spring pod
turbine right this is all easy enough to
do this is one way to get that emergent
behavior
another is use distribute tracing and
distribute tracing in theory is very
simple for every request that goes into
the system whether it's in the same way
whether it leaves by the same time to
the rest template or the the RabbitMQ or
you know Apache Kafka or if it's using
them the the zuo micro proxy of is using
spring ABC or the spring data rest
endpoints or whatever the end point is
but no matter how it comes and goes for
every service for every quest for
everything that happens I want to make
sure that I visit that request and I
make sure that if there is not already a
unique correlation ID present in the
build or sorry in the request that I
then add that unique ID so that it can
be perpetuated later on right I want to
be able to constantly add that unique ID
and if it's not there I want to I want
to add it and if it's
if it is there then I want to perpetuate
it right so what I'm going to do here is
I'm going to add one more dependency
here because I forgot it on the start of
there so zip conserver good and the zip
conserver so what we wanted to see what
we need to do is distribute racing just
to make it easy easy as possible to
support that and the theory it sounds
very simple but in practice it's very
painful because you have to for every
place and the code that you have to do
this you have to remember to to to add
this handling logic sister narak
interceptor logic and so instead of
doing that we can use spring cloud
sleuth spring cloud sleuth is a
distributed tracing abstraction and it's
already on our class pass for the client
that's why you've seen those exceptions
before because it's trying to call to a
service I've got an implementation of
spring cloud sleuth called spring cloud
Zipkin Zipkin is a distributed tracing
server from from Twitter we're very
lucky to have on the spring cloud team
contributors and committers from from
Twitter and from Netflix right let's see
oh whoops
application the puppies spring lipkin -
service start
okay there's our distribute tracing
server it is can't close this
make some requests that go through both
nodes go here there we go so as I make
requests you can see that it's aware of
both the reservation client and the
service right it's a little larger
there's both of them there I click on
any one and then I hit find trace it
shows me the time then I can see all the
requests that have been made into the
system and their timings right and the
relative timing so I can see here's a
waterfall graph that that I had a
request that started the reservation
client it took so many milliseconds then
I went to the reservation service the
request for the reservation you know in
the reservation service the processing
lasted from here until here so it took
so many milliseconds the total time was
thirty two point one no seconds if I
click on any one of those nodes I can
see the request log the in-and-out for
each request as well as a context for
that request the tags that I used to
identify or which components handle the
request what information was present at
the time and so on and you can add your
own custom tags well your own custom
context things like the customer ID the
order ID etc this is very useful but
let's be very clear this is not about
warehousing
and reporting this is all about online
telemetry how much money did we make
last quarter I don't know don't care but
I can tell you what the average latency
has been on the websites in the last
hour both the history dashboard and the
zip and distribute tracing service
support online telemetry they're all
about right now present status if you
had to design a dashboard with three
colors blue green or red what
information would you use to decide what
color to assign it's that kind of
information that we're assigning here
right now should we worry is anything
okay is something about to be wrong this
supports your ability to respond
proactively and if needed be retroactive
Lee right it helps you build support
services that do the right thing so
today my friends we looked ever so
briefly just a few things they looked at
how to build an application a cloud
native java system using spring booting
spring cloud that is agile it's easy to
change it is robust in the face of
service outages and topology changes it
is elastic it takes advantage of the
cloud and it is observable both of the
system and the single node level right I
have talked about just a few things here
and I hope you liked some of this did
you like it in it's just romant curious
very good I appreciate that I hope you
got something out of it I'm a big fan I
love spring I'm a big fan I have the
spring t-shirt I have the spring
underwear of Cour
of course I am a fan of course I'm a fan
but you do not have to take my word for
it there are lots of interesting
companies out there doing amazing things
with the pivotal stack with cloud winery
with spring boot and spring cloud
there's a small company in the West that
we've talked about a few times in this
discussion
they're called Netflix and they are
using spring boot and spring cloud at
production scale they've talked about it
in their discussions at keynotes at
conferences
they've been very proud about how
they're using spring cloud not just the
individual components that they built
they're using spring cloud as a whole so
you reuse their own components imagine
if you built an API or library and it
used something from Apple and then
apples like yeah that's way better we'll
use your thing to use our own API than
our own thing that's what happened here
that's another company I you know here
in the East here in Easton just kind of
up up in a little bit for the east
there's another small company called
Baidu they're a search engine in China
they serve 600 800 million people day
they're using Cloud Foundry spring
Boonton spring cloud production scale
alright there's another company another
small company in China called Alibaba
they're they're an e-commerce engine and
I believe that they're going to be big
one day just give them time
they've only got a billion items in
their catalog I guess that's bigger than
Amazon but you know one day they could
we become really big they're using
spring Boonton spring cloud and they've
talked about it in conferences magazine
articles keynotes and so on as well
there's another company even further
east in Japan called racket ENCOM their
other like if you know if amazon.com is
the Alibaba of the Farwest then rocket
ENCOM is the Alibaba the Far Far East
right and they're also using Cloud
Foundry spring Boonton spring cloud
Yahoo Japan is using cloud vendor for
example I think they're starting to
spring the point is these organizations
and many of these besides banks why I'm
here actually because I'm going to be
talking to customers banks here in
Singapore you know financial services
companies of all stripes and shapes and
you know insurance companies media
companies all these startups in Silicon
Valley and these giant Internet giant's
all of them if they need to solve these
problems they could do it they have
really smart people most of these
organizations that I've just mentioned
certainly have the money they have the
smart people they have the necessity
they could solve these problems by
themselves if they had to but for them
and many of these besides they don't
want to do that
rather use the pivotal staff because it
helps them get to production faster at
the end of the day that is all that
matters
I want to thank you so much Singapore
thank you so much for having me if
you're here I want you to go to Pebble
to booth we're hanging out there I'll be
there for a while we can talk to have
questions I really appreciate it thank
you so much Cheers sorry I've kept you
for lunch</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>