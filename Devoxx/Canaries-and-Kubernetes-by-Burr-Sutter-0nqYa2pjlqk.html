<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Canaries and Kubernetes by Burr Sutter | Coder Coacher - Coaching Coders</title><meta content="Canaries and Kubernetes by Burr Sutter - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Canaries and Kubernetes by Burr Sutter</b></h2><h5 class="post__date">2017-05-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/0nqYa2pjlqk" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Birgit you play kids do it thanks s okay
we're ready to go all right we get 15
minutes to cover a lot of ground
normally this is about a two-hour
presentation we're going to do in 15
minutes but we're specifically going to
focus on the concept of the canary
deployment in the context of kubernetes
so how many people have actually
experienced kubernetes hands-on
kubernetes at this point okay well you
know a handful of you so let's go ahead
and get started and we'll get right into
this so if you're a Java developer your
primary familiar with this concept of
using some like drop wizard or spring
buddha walk by swarm or vertex and
basically the concept of the fet jar and
deploying your application so on the
Java side of this things have gotten
super easy deploying a Java app is
really not hard there's so many ways to
do it at this point in addition to the
traditional Java EE way what's more
interesting is when you pack that jar
file and put it into a docker container
and throw it into kubernetes so that's
really what this presentation is focused
on and this diagram here kind of
illustrates what's going on in the
kubernetes universe the read
specifically is where we've added value
on top with open shift so you're going
to hear something about three different
projects in this little session you're
gonna hear about fabricate which is a
maven plug-in that I'll be using you're
going to hear a concept of kubernetes
and of course that's based on docker and
an open shift which is our open source
project that contributes to kubernetes
so fabricate developer experience on
kubernetes and open shift OpenShift
additional capability like builds and
image streams build management on top of
kubernetes and then of course what you
see in the traditional kubernetes world
the idea of course is that you can build
an entire cluster I'm working off a
single node cluster here on this laptop
and we're going to choose that for our
demonstrations assuming the internet
holds up now the concept of the canary
started with this concept here and the
cons the idea of the coal miners so the
coal miners would actually carry a
canary into the bottom of the coal mine
and if the canary lived they knew where
they were okay if the canary stopped
singing and fell off its perch right
dead they need to get the hell out of
the coal mine so the concept of the
canary in the coal mine has been a kind
of a meme if you will a theme for many
many years we refer to it often in all
forms of not just software but primarily
in the concept of you know when certain
types of animals die in the universe
what does that mean for the ecosystem
kind of thing it actually was I found
this image online - it happened here in
the UK right so there's an actual Welsh
coal miner carrying an actual canary and
okay
age down with him and of course he's
wearing the the gas mask there to make
sure that you know he doesn't poison
himself so the whole idea is that you
basically put up something a little
something into production if it lives
good roll it all the way into production
if it dies get the hell out of the coal
mine kind of thing all right so the
canary deployment in my mind is one of
the coolest things you can do from a
kubernetes perspective it really gives
you a superpower you didn't have before
so we're going to walk through that just
briefly okay so you have the concept at
SCM your source code control repository
you're going to check into that it's
going to produce a new build of that fat
jar let's say your vertex app your
spring boot app through a well fly swarm
app it's going to wrap it as a docker
container and push that immutable image
through the pipeline we're not gonna
focus on the pipeline here in this
session but the idea is it reverses the
pipeline going through the steps that
you need to push something to production
and when it lands in production okay it
just takes on a little bit of traffic
from the users so a little bit of
production traffic not all the traffic
just a little bit and you decide what
those fractions ought to be and then you
decide to grow it and if it continues to
live and succeed you continue growing it
to takes over the entire production
traffic environment if it fails along
the way you roll it back that makes
sense
pretty straightforward so if you live in
a kubernetes world you're going to end
up looking at these kinds of things this
is an example of a deployment yamo so I
defined a deployment object here you can
see that at the top alright and I can
see I put we have a label on it give it
a name space how many replicas do we
want there's a look there's the concept
of the selector right here that's that's
important because but kubernetes
separates the concepts of services and
pods or the pods are your runtimes your
runtime containers the service is
basically the virtual IP this is on top
of that which means you can have
multiple containers running on the
background behind the exact same service
but doesn't change even though the
containers are changing all the time
and the selector is the piece of magic
that makes a lot this work okay
so we'll show you that in a second and
then another piece of the magic that
makes it all work is this concept of the
readiness probe so that's how you burn
Eddie's knows that your component is
ready to go from at least a business
logic standpoint it is responding to
HTTP requests and therefore it can be
acceptable to send traffic to it so
let's kind of let's kind of see this in
action
it's more
and ecstasy demo of it I have a lot of
demos here and there's not time to walk
through them all but they're all out
there in github so at a minimum you
should have a pretty good understanding
for how to pack up your application in a
docker container and deploy it on
kubernetes and actually if you look at
the hello boot application we have
specifically here it actually uses the
fabricate pom.xml so my tommix not my
fabricate plug-in here right there and
that means all I have to do is say maven
fabricate deploy and it basically takes
everything that I had my java
application decides what base docker
image dissociative that with build the
docker image to give me the deployment
yamo that I need and deployed in the
kubernetes so it's kind of magical we
make some assumptions about what you
need to do based on the type of payload
you've given it spring boot out we not
have treated vertex app we know how to
treat it well apply swarm or even a
traditional Java EE app we can make
decisions around all of those with the
fabrication maven plugin so do check out
the plug-in but we're going to focus on
something a little bit more advanced
than that and this session make sure
that we don't run out of time okay
let's go here let me show you this
alright so I have a little application
here we call it Aloha it's a little red
X application and actually here - let's
bring up a code real quick cool thing
about vertex is super simple super
lightweight and you can see you here I
have router if you get the root of that
it's going to return Aloha X right now
but that it that is my canary version of
this if I go back over here and let's
just pull this endpoint okay run the
polar you can kind of see your list of
refresh over here alright so that's the
one that's currently live you notice we
have two pods out there running already
so that's two docker containers that are
running they have this kind of
interesting naming convention here you
can see that's the name of those two
pods and if you look at my polar you can
see it's returning because the polar in
this case does not maintain the cookie
it does not maintain the session if you
will it's simply just returning what
those two pod names are okay
hitting that endpoint but if I come over
here now and roll out the canary build
actually let's do this real quick let us
change the code so let's call this
devoxx UK make it pretty obvious that we
change the text there
go back to my command line and let's see
here
okay I'm in the right spot and I'm going
to just run a well let's do this we
always forget to do this part you run a
maven clean compiled package you got a
package up your fat jar okay
now normally you build your your fat jar
you put it in docker container you load
the kubernetes but we have some other
tricks and one and i'll show you this
one it's going to call OC start build
and specifically that will run a build
against the environment okay that did
look I did something wrong there that
deleted too much there we go
alright so we're going to build you can
see it's triggering a build now but it's
building specifically the canary option
right so the users are not seeing that
option at all it's building the canary
deployment at this moment and what we
have do is move traffic to it so it's
doing a build right now looks like the
build is done let's actually crank it up
okay
and my message is related the fact that
my clock is off on the system so there
we go and there's a lotta box so
basically I'm just using something super
simple one of three thirty percent of
the traffic is now getting the canary
deployment and you can see right here it
says a load F box and that's every third
request so that's a super simple canary
now there's another type of canary
that's kind of built into kubernetes
alright so this case we're just
manipulating the service the service
selector and routing traffic accordingly
there's another piece that people would
like to refer to at the kubernetes level
and then is if I make a code change
let's go back over here kind of a code
change
I was just call this to make it super
simple right so that's just a code right
there and now if I do a start build nope
let me do them let me do a maven compile
often I forget to do that so that will
do compile the code and then do the
maven build okay it's going through its
build process right now you can see it
animating here this is the open shift
console that sits on top of kubernetes
and you know and we're going to do it's
doing its build and then if we did it
right then make sure my puller is
correct okay there it is so we now
pushed another change into production
again only using 30%
traffic from the end users in this case
so the concept of that readiness probe
allows kubernetes doing its rolling
update procedure to ensure that the pod
the container is ready to go from a
business logic standpoint because you
write that code you determine what you
need to do from hitting a database
talking to message queues are all these
other resources available and accessible
if that's good you return a 200 and then
that basically says now route traffic to
me now that's something you get for free
in kubernetes by default and what we've
done here is simply just take advantage
of that
so the rolling update with the readiness
probe you've got a canary right there
the magic of doing dealing with a
service selector you get a canary right
there now what most people do when they
see this because I've done this
presentation a couple times they're like
great
that's easy you have a stateless
application so therefore you know that
works for anything and of course that's
a 12 factor principle be stateless but
can you be stateful and so we had to
think about that
and so several members of the team got
together and we worked on that so let me
go ahead and I'm going to roll that back
down take the canary out of production
right so the canary is now gone so that
you know kill it don't need any more
let's say I didn't like that change but
let's go over here now and let me show
you something with a different cube CTO
get pods
Zozi project rubies I'm going to switch
roles here over the cube CTL get pods
okay all right so we're in the movie
section and begin to the movie store
okay now this is where it gets
interesting one things we've done is we
actually have mapped the spring boot
session into a technology called an
finis band another open source project
that we have and what this means is
those pods that are running those docker
Linux containers that are running they
basically keep in memory state across
the two pods so in this case if I go
over here let's look here you can see
there's two pods running and it's
basically load-balanced the state across
those two and then you can see I have
things on my shopping cart so I come
over here and hit add and add let's say
add this movie to it okay what you don't
want is your shopping carts to lose
their data right that's the kind of
thing we always want to have in a
typical web application world so if I
come over here let me get all my windows
up
all right okay they all look good let's
go look at the code in this case let's
just make a change today CML so it's
super obvious so let's go with devoxx
movies devoxx UK movies alright in this
case I'll use the maven plug-in to do
the update yeah let's update that one
okay so it's going to go to the process
of doing the update again that maven
plug-in is not only in this case
compiling the code is producing the
docker image updating kubernetes and
pushing it into the environment all that
is happening kind of automatically and
then it's going to go out there and
update the environment so we're we go
okay let's go here you can see there's
the build happening right there it's
deploying this one underneath here which
is the canary and if we go look at it
now nothing's changed because if you
notice my canary still sits at zero I
didn't actually say make pods available
you know make containers available so
I'm gonna go and roll it up okay and
again the air is because my clock is off
but you know who will fix that in a
little bit but I'm basically said now I
need two more of these come into
existence and if I have my other little
polar where my little polar go here okay
what you'll notice is as those guys are
coming to life these are the two pods
that are already out there that are part
of the cluster the stateful cluster that
we're talking about and what's going to
happen now is as those two guys join
you'll see them and this actually is
taking a little longer because we have
it set to basically ensure that it does
everything correctly you know it'll join
the cluster you'll see the state rotate
over to the new guys and you can kill
the old guys is kind the idea all right
so there's the first canary that's
joined okay
and then now we have two Canaries if I
come over here now kill the original one
if I want to let's see here this if I
did this correctly alright and this one
okay there's a deaf ox UK devoxx UK and
where's my other one so in this case
it's sticky sessions based on spring
session and we've maintained the entire
state of everything that was in memory
across a rolling update in a kubernetes
environment
Senate canary deployment if I decide now
I want to roll back I can roll it right
back so the concept of the canary means
we can test in production and do some
pretty amazing things from a kubernetes
standpoint so if I want to come over
here now and say okay let's go back to
the old one I do have to wait for the
new pod to come up before I send traffic
over to it but all that's based on the
liveness program readiness probe that's
built into kubernetes proper to kind of
show you again I have numerous examples
of this but to kind of show you what a
more advanced version of the readiness
probe might look like right right here
in this case we're actually going to
check the health of the distributed
cache note that the cache is good all
the members have joined all the data is
there then we can tear things down or
build things up it's pretty
straightforward once you have the
concept of liveness probe in readiness
probe and afternoon session we'll go
into much greater detail on these topics
and you know we'll actually walk you
through it so again that one's coming up
look let me tear this one down let's
just go ahead and go for it go all the
way down all right and if I did that
correctly let's see here yep come on new
distant done there we're back to the
original one like that so you can make
production changes and I believe you and
I roll them out see that people are
happy you're not getting Twitter storms
and people hating your software and if
it's good you roll it back or keep it
out or roll it out or you know roll back
anything again an afternoon session will
go into greater detail is about all
these different principles you know the
doctor the kubernetes and specifically
how you do a lot of these things but if
all you need is just access to this code
you want to try it yourself please do
okay
we've met we showed you then finished
band piece and then I have a wrap-up
slide here I'm doing all this on
something called mini shift there's also
something called mini cube they both
work the same way you know basically
everything we do from an open show
standpoint is based on kubernetes you
can layer it on do check out the
fabricate maven plug-in the trick here
is really about the liveness probes and
the readiness probes that's pretty
straightforward stuff and then of course
if you need these demos they're all
right here at this URL and I'm at a time
thank you so much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>