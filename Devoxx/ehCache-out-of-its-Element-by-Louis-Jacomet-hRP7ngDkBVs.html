<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>ehCache out of its Element by Louis Jacomet | Coder Coacher - Coaching Coders</title><meta content="ehCache out of its Element by Louis Jacomet - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>ehCache out of its Element by Louis Jacomet</b></h2><h5 class="post__date">2017-04-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/hRP7ngDkBVs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">well welcome it's time to start thanks
for being here in the city middle my
name is do jacaré what we're going to
do today is I'm going to show you a bit
of each cache API of the latest
declaration of the product and the title
is each cache all its elements and if
you knew the each cash to SCP I you know
that what was stored in the cache was a
nothing from the key to an element
wrapping the value and having a bit of
metadata associated with it and you'll
see that's one of the things that is no
gun the way I usually do this is by live
coding improving the pet clinic
application so of course if you want to
know about eh cash you can use casual
org and what I usually use is just a pet
clinic application as a way of
illustrating the basic things now
however given the size of the crowd I'll
be more than happy to instead ask you
guys what you want to get out of this
presentation and maybe dive into more
specific stuff so if you have specific
ID don't hesitate to shout otherwise
I'll continue with my plan scenario and
but make sure to interrupt if you want
so yeah the pet clinic application is a
simple application the idea is that we
can then focus on I've been cashing to
eat and mission you the API is instead
of trying to understand the complexity
of the application this makes the
exercise of caching a little bit awkward
of course because it's really basic but
if you've got questions we can dive down
over in half an hour you can't just
discuss all the problematic of national
3d so it's spring boot application
meaning that it has a number of
configuration I need a few tweaks one of
the main tweak is changing the logging
level so that we mostly see each cash in
from it at the info level so that you
see a little bit what's happening inside
eh cash and hibernate sequels because
that's what we're going to use to see
that caching is working with no longer
hit the database so the first thing we
need to do
go to the pet clinic application and
start adding a beam so that is a
standard spring stuff so I'm going to
add a beam of light each cash management
from cache manager and so the first
thing we did with the each cache three
epi is beside that as soon as you're
working in code we would provide a
fluent api because we really wanted the
configuration to be totally immutable
and so the way you create a
configuration is very building it with a
builder and then of course using the
cash but so first of all let's get that
cash manager created so we've got a new
cache manager builder that and on a new
cache manager is there the first thing
we do is we have a cache treats which is
going to be an owner's search cash with
a cache configuration
and what we did in the cache
configuration builder is we make sure
that you have to provide all the
mandatory attributes from feeds for
configuration and one of the big change
in each cache three is that we are
generic compatible that's also coming
out of the j cash requirements and in
order to provide not only compile-time
type safety but also runtime type safety
you have to provide the classes to the
configuration so the key is going to be
a string and the value is going to be a
collection will see immediately that
this hits the limit of generates because
effectively what we're going to cache is
a collection of owner there is no way
for me to express that here I'm limited
at the collection level and then while
the eruption to of eh cash allowed you
to by default create caches that have an
infinite that accepted an infinite
amount of entry which is not true it was
effectively limited by the memory of the
JVM here we said that no you always have
to configure a resource and the goal is
caching is effectively consuming more
memory in order to benefit from improved
latency but so you have to make the
choice of how much memory you're gonna
use however on heap memory is a
complicated matter so by default it's a
sizing in number of mappings I'm just
going to pretend in there that should be
more than enough and when I'm done with
that I'm building my cache manager and
initializing it in one go so that's it
I've got a simple cache manager with a
simple enough search cash mapping from
string to collection now the idea is of
course to make use of that and for that
I'm going to go to the owners controller
in which i'll start by injecting that
cache manager so that i can make user it
and from the cache manager what I'm
going to do is I'm going to get that
cash and here again I need to specify
the type i expect the cash to be and
this is again required for runtime type
safety and I'm going to make a field out
of that guy so that it comes that's the
owner search and of course would be
great if it was fully died here which
means that sadly I love to do an unsafe
thing here it's a bit ugly but that's
one of the downsides of type II
rehearing in Java and the fact that as
soon as you catch something like a
collection of a generic type you can't
really express it so here I know how my
cash and what I'm going to do is I'm
going to the process fine form which is
simply the method that answers a search
request and what I want to do of course
is do something different with my
results and so initially I'm going to
use that owner search cash get with the
key which is going to be another get
last name and if this is none because
that's what you get out of a cache
memory no mapping you get a know if this
is not then only I like am I talking to
the repository and of course what I
don't need what I must not forget to do
is put the entry into the cash
and so it's results like that and so
that's it with that in place I've done
what we call cash aside caching so I'm
simply looking first into my cash before
talking to the database let's see that
works a good thing so we see that up
cash is created and if we go to the
applications applications working
finding owners I'm searching with a
substring try go look he will see in the
logs that we've got a number of hybrid
queries that were executed if I clear
the labs and go back here to redo the
same search I have nothing so Wow
amazing that's caching yeah if the
database was slow which is not the case
in this central application because of
course with a thousand entries it's
pretty much the same speed but that
would be a nice way of uploading your
database with caching now of course what
we've done here is really really busy
and one of the thing that's not really
good and not really recommended
especially for something like caching a
search is that we effectively didn't say
anything about the freshness of the data
so we're pretty much saying oh well if
you search for DAV that's it you're
always on always going to get the same
result which might not be a good idea
because this application as a number of
ways to create exactly owners and so if
I ways to create someone
someone like that whatever and had him
and go back to my final earthquake or
he's not showing up and it's not showing
up because i'd catch the results for an
infinite amount of time so even if i
wait two or three days in leather shirt
in the be a week subscribe but of course
if i were to search with a different
string very sure that no problem so
caching can help but the moment you do
caching you have to think about data
freshness in validation and all these
kind of concepts otherwise you risk
damaging the consistency or application
so one easy way of doing that which
could be a very applicable scenario in
that case is to add an expiration
duration so i'm just going to make
adjustments for readability so here what
i can do is i can say that i won't
expiry and the expertise i want is time
to leave duration exploration with a
duration of let's say 10 seconds and by
just doing that change what i told my
cache is after 10 seconds whatever the
mapping was it's considered expired and
so what it will allow us to do if i stop
and reran the application waiting for it
to get started they're here so of course
that the EV person i created is gone
because the application has a fixed set
of starting data and runs in a in-memory
database i did not even bother to change
that to a permanent one but he is
clearly you see we've got the results
again we have the selection appear but
know what i can do is i can go back to
the fine owners
i bet you guys again
go back to my fine owners and Barry
showed up and the reason he shows up is
because I'm Russillo typist then I took
me more than 10 seconds to do what I
show you and so the cache entry got
expired now if I were to search again
these team shows up but what's important
is you know we've done a number of
queries however probably em yeah I'm too
late they're here it's now for 10 second
inner cash some important changes that
when the wrong expiry so what xbox it
takes as a parameter is an expiry and so
if I go look at the type expiry what
expiring eaves you is it gives you three
methods that you need to implement
expiry for creation expire if access and
expiry for update that I've invoked
whenever something happens with the
cache entry so when the cache entries
put on in the first time you get a get
expiry for creation and you can decide
about something that's why the TTL does
it will just give you a value when get
expanse of creation vote can expiry for
access is a way for you to say well I
want the value to stay longer in the
cash when it's accessed it's a bit
strange because it's effectively a way
of converting cash capacity and you
should rely more on addiction for that
but that's what it offers and get expand
hero update is a way of saying oh I may
want a different behavior when the value
is actually updated instead of just
being put in the cache and again if I go
back to the TTL what TTL does is it
returns the ten seconds here the ten
seconds here and null for that one
well-known means whatever the duration
whatever the current expiring is don't
modify it so touching the value does not
impact it affect its freshness
other cool things we have in each cache
is you have the ability to scale our
scale up your cash support by moving to
a feed memory and we do that is simply
by adding to the heap resource and a fib
resource let's say hundred male in the
moment I do that I've got a two-tier
cash where all the data is gonna leave
off heap and I eat cash is going to act
as a near cash because of course as soon
as I'd go off the cluster disk anything
I need to sterilize my data in and out
and so by having heap in front of it it
allows me to have a hard cash where
where potentially if something happens
in the application I have a few entries
that are impacted logically grouped but
I want a larger number to be still in
memory compared to in the database out
over the network something like that it
gives a real benefit so if I were to
start the application right now it could
crash and the problem is this type is
not realizable so by default each cash
doesn't know what to do with it we can
serialize serializable types because
it's java however as soon as you give as
soon as you request the cache data to go
outside of the heat that don't have
serializable key or values you need to
provide a CL either and so the way you
do that is pretty simple you just very
initializer and what I did was create an
owner's réaliser beforehand because
that's not the main topic of the tog and
so as soon as I do that I can rerun my
application everything should sit work
yes it does go back to the fine owners
again I've heated the database and if I
go back here no longer any it
what happened now is that I've civilized
once everything in our feeble and the
moment I pulled it out once it got dis
utilized put back on the heat as a just
a reference away and if I were to search
again for that entry it will now get it
get it from the heap so you really get
the benefit of the heap who are allowing
the ability to scale up the side of your
clash a whole lot because of course I'll
feed memory the main benefit is that you
are not impacted by garbage collection
so if you've got a two terabyte Ram
machine where you can decide to allocate
one terabyte of RAM just for the cash
and thats why we have zero impact on the
tone garbage collection so there and as
you've seen we were just touching
configuration so that's also very very
important thing in each cash we want you
to be able to write once you're caching
code and then play around with the
configuration without having to think
again I've going back to the caching go
this is just transparent to the caching
idea to the cache API itself and again
in the owner controller as you've seen
we just do a get which is we put there
is no longer an element of course this
is nice and good but it wouldn't be a
Java library if you didn't have an XML
format for defining lee for defining the
cash configuration so I have allies
templates to cheat effectively what we
do in eh cash 3 is we use an excess be
so that we can validate what you give us
the excess the other number of expansion
point so that we can grow each cache or
you can do extensions to it if you want
but basically what i need to do is again
specify my cash I name it
I nakida key type the value type the
fact that I want a heap often elements
and my expiry which is a yell seconds
second is the default so if I were to
read empty it would work and my knees
and happy because expiring needs to be
before the resource efficient so now
what I've done is a nearly equivalent in
order to be fully equivalent to what we
are in Java I would need to put the heat
inside a resource tag because that would
allow me to define the office under
Neath it again with a unit and 900 mags
and if I were to do that I would need to
go here to my value type and specify the
scale either because it's needed since
i'm i'm seeing a connection so now i
have effectively be acquired of course
that means that all the code that exists
here is no longer needed the only thing
I need is I'm going to create the cache
manager from an XML configuration can I
get the resource
that in a very little so that's my cache
manager with me like this with the inbox
static it's clear the only thing I need
to do here is initialize the cache
manager which was done if you remember
through the parameter of the build
method and then I can return it and
effectively I've got energy equivalent
so I can restart the application and you
know the drill we're going to load and
do a search sure that it's effective
leading the database on the first time
and not songs a long time burial so
that's really dipping your toes into the
HK API like I've said at the beginning
given the size of the crowd I'm happy to
go deeper if you've got specific
questions or if this gives you idea and
makes you wonder about stuff otherwise
the last step is really showing that
everything I've done here is effectively
not really needed in a spring boot
application because by using the je
cache support of spring boots I can
pretty much get rid of all the code I
ended up writing here
yes so the time to either the idea is
that when you configure time to either
you configure the value by default you
configure a value and when you create
the entry like if you say pentagon's
when you create the entry it's going to
leave for 10 seconds but if you read the
entry after five seconds its life is
going to again be expanded to time ten
seconds so you're effectively saying in
a way a value that is accessed as a
higher interest for my application and
should stay a bit longer in the cache or
it can be way more than that because if
you keep reading it it's going to it's
going to stay alive no it's going to be
10 seconds because it's going to be the
first to first gear and so when you use
the gonna shoot in the XML if you use
TTI here that's nice
so if i use TP i hear this effectively
means that the expiry object we create
behind the scene we give you 10 seconds
for creation and update but also 10
seconds for access and so effectively if
you put the value never read it it stays
10 second if you put the value read it
after something lower than 10 seconds
it's going to leave 10 more seconds and
if you keep reading it as an interval
which is smaller than the 10 seconds it
potentially can stay forever in the cash
so that's why we're saying think really
hard before using TTI is there for
compatibility reason because da cash has
it and everything but effectively what
you're doing in a way is trying to tell
the cash or you should not get rid of
that value just now but normally if the
eviction algorithm works well the
eviction should not use the value that
you've touched a lotta to evict values
that are not accessed and so eviction is
what happens so we sighs the cash with
ten elements so if I were to remove the
RCB stuff that means I no longer need to
see Eliza let's make that a bit longer
so that we can play around let's make
that a two so what I'm doing now is i
have only two entries that can leave in
my head and so what effectively this
means is that if i go to the application
do my search my DV the usual stuff do
another search avi i've done to
accessing the database okay so now if i
go back evi no database access the same
for behavior no data bail access however
if suddenly i decide to search something
like d I've got a database access that's
expected but if I go back to the other
two search that I had initially DAV
still there that's fine it's the last
one I accessed next time
sorry if I go to be a VI who I hit the
database and that's because that was the
whole nest entry in the cache in airway
and so when I added that third entry in
the cache it pushed out one of the other
two entries that's what eviction is
that's how you got so a cache conference
capacity remember this is a cash it is
not an in-memory store so effectively
you need to us to a source of proof at
the back where you can go fetch the
values when they are no longer in the
cache and that's where the balance
sometimes in Phoenix pi n addiction is
not always clear any other question
the idea if you were to do it in the
cache is you probably try to denormalize
the data so that the cash is really fast
because what a cache is good at is kyra
you look up so you just look up with a
single key and you get your results and
however the moment you do that if you
really want it to be like your
permission groups and never have to go
back to the database well a cache
because of its eviction it might work
because if you know exactly how many
entries you have you just sigh the cash
above that and then everything we fit in
memory and you're good to go but up but
that's a bit but the moment you no
longer have a way to get out of a
problem if the cash returns null you
will no no we are using it as a fuel
cash that doesn't mean it doesn't work
that just means you need to realize what
you've done and if suddenly behind the
scene an update to the model in which
your work working increases the number
of groups and you suddenly go over
capacity in the cash the cash will
silently drop elements because that's a
perfectly valid thing to do for a cash
so that tax again the balance but of
course if you can express it by just the
key look up it's probably going to be
faster because as you said you do the
processing once at the start about the
application populate the cash and then
use it for the duration that's also a
nice way of using a dash you use the
cash not necessarily because the
transfer from the database is long but
because you've got the bit of processing
to do on the data in memory and then you
catch that result but still you should
always have a fallback scenario two oh
crap it's no longer in the cash I need
to research and recompute the compound
no no no no so if you remember what I
did here was I replaced the code
completely with the loading of the xml
file there is no longer any code here
I'm no longer touching the cache manager
configuration builder or cash
configuration everything comes from the
XML by the way in the XML each cache 2x
at a concept of default cash which
allows you to dynamically create cash
with the default configuration we didn't
like very much the dynamic creation of
cash because it meant you should be the
title in one of the trash names you
would not see it but were potentially
talking to two caches having no command
data so what we did though is we
introduced the concept of cash template
and the idea is that with a cash
template I could move the stuff that's
common to all my clashes and just
use it that way and so the idea here is
that if I have a number of cash that I
own want to add 100 seconds dgge and
only two hip entries I don't have to
repeat that information in the external
file so now like I said the reality of
spring boot is that if you were to use
je cache which each cache is a compliant
provider you effectively need none of
what is here if I go to the illness
controller I can pretty much let me do
it there reversed it as well I don't
need any of the code I did hear the only
place i need to go is to go here go to
the App cashable add an ad kasia rule
with a cache name of whoops making the
double quotes on a search go back to
that application of properties click a
strong free cash each cast of xml will
he start the application any crashing
this is a spectrum so the reason it
crashes is sadly the caching supporting
spring predated je cache and predates
most of the caching library being pipe
serif and so it is effectively not
sticking into account the type of the
key in the type of the value at all and
je cache mandates that when you get a
cash from a cache manager you have to
specify the key in the value is the
different than object and so the way I
need to change my application to work is
I effectively to go here and tell it
where you know what actually forget
about that
can't type you anymore if I'm using the
mid the screen caching abstraction I
need to say your honor on cash from
object to object and nothing that is it
really bad well not really because if
you look at the code others he
positively no longer has an itch herb
sorry all the repository the only change
is that you're not even talking about
the type of the cashier anyway when you
see because you know that it's going to
use the key and you know what the value
is going to be but that's it so you
never type in the caching good yourself
so it's not such a big deal and so now
that I've removed my now that I've
remove that it's started to hear again
I've got my database access I go back
and it so it still works but it's a lot
less code and as long as you're doing
cash aside you're probably better off
using such abstractions like the sprint
a subtraction because at least you know
you're not going to make any mistake in
that you know get the value from the
cash check if it's different than no fun
check if it's null if it's not get it
from whatever the source information is
and then finally put it in the cache
which is the usual step you forget and
then you wonder why it's never cashed
and and then I turn the value
yes that's a good question i didn't try
that let's see if it works though I'm
wondering if spring doesn't do some
rapping of the value so you may have to
specify sterilizer which is a bit
different Carolina almost CLI I just
want to put object or by the way one
thing you can do in h cash 3 is just go
of it I don't know exactly which unit is
a default I think it's megs but so that
should let's see that worse now oh ok
its bite so my value is too small there
we go
that was it different problem
yep they're survivors and you might have
a half the time doing the same in code
because if you were to configure the
cache manager in code because you say
that the value is of type object that
you specify sterilizer that has a more
specific type it might not work that
when you have to do ugly casts to hide
it but anyway that's the kind of things
we can have the generics proper in the
API to help you get it right but
effectively this will end up if you if
you mess it up completely by always
casting to the row type this will end up
blowing at runtime there is no way
around that ok times up actually so
thank you for being here and I should
got more questions while I can take them
unless you want to go see the including
event with the jealous Iranian thanks
for time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>