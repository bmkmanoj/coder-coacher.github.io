<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Reactive Spring by Josh Long | Coder Coacher - Coaching Coders</title><meta content="Reactive Spring by Josh Long - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Reactive Spring by Josh Long</b></h2><h5 class="post__date">2017-05-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/EDB24onZxsA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Birgit you play kids do it makes us good
morning everybody
oh that was just abysmal terrible good
morning thank you very much very good
welcome welcome everybody I appreciate
it come on in I expect we're gonna have
a few stragglers but such is life we're
going to go through a lot of stuff
actually I should contextualize this I
should say we're going to go through a
lot of stuff specific to one thing right
this year normally when I do other talks
I tend to do these roving sort of tours
of whole ecosystems and and this time I
just wanted to spend a little time deep
diving on one particular topic and in
particular we're going to look at some
of the support and sort of spring 5
coming up and in the ecosystem at large
for for reactive programming so so keep
that in mind keep that in mind and if
you have questions comments feedback
whatever I'm having and to your
questions I'm here for you I'm on the
internet the code by the way it's on the
guides on them on github at those
coordinates welcome everybody thank you
for coming it's on github at those
coordinates so please don't hesitate to
grab that and follow along at home later
on I'm on the internet as I say if you
have questions comments feedback
whatever I'm very happy to hear from you
so show of hands how many of you are on
Twitter Twitter right on good stuff I
ask every year that that level goes up
progressively and that is encouraging it
makes me feel like we're in a good place
and for the rest of you get on it it's
the new IRC it's a great place to be if
you're developers using software
open-source software in particular today
and in this day and age then you owe to
yourself to engage with the people that
drive that software or that drive that
code so they're there they're here for
you as I am as well what about email
e-mail e-mail anybody is anybody using
email no ok well if you're there I'm
also happy to answer questions I'm happy
to engage so don't hesitate to reach out
to me a little bit about me I just want
to you know establish the hopefully
obvious my name is Josh long I'm a
spring developer developer advocate on
the spring team I have been to last
going on eight years now and I've also
been an open source
contributor and engineer and the
different projects for for many years I
work on lots of different spring
projects I've talked about this loudly
and proudly many times I am and this is
you know you can check github you can
see this for a fact I am the number one
top ranked most prolific most visible
most highly rated contributor of of bugs
but still number one number one in all
of the projects to which I commit more
bugs per commit than any other engineer
in this project like spring boot spring
cloud spring integration spring back
Baudin time leagues activity etc I
didn't fix a my I created him but it was
a it was an accent right mostly I'm sure
so so there's that I work in the open
source world I also do my best to help
people in you know engage in in in the
in the ecosystem to help them build
better software often in terms of the
Java platform and in terms of spring is
part of that I've done training videos I
just finished the second edition of my
building microservices with spring boot
live lessons with my friend the one the
only amazing the inimitable spring boot
co-founder Phil Webb and I'm working on
my book finally oh it's so close you
have no idea of and I've been talking
about that book for for what is in out
three years two years so it's here
almost that book is called cloud native
Java it's all about how to build
applications that survive and thrive on
the cloud or in the cloud and for those
of you are wondering and I can see it in
your eyes I can see it welling in your
eyes that curiosity that latent
curiosity that bird on the cover is a
blue eared Kingfisher it's a bird that
is indigenous or as we say in English
native to Java the Indonesian Java
Islands it's a bird and birds fly often
through the clouds
so it's a bird that's native to Java
that flies in the clouds the cloud
native Java bird it's a burden of mine
it'll come give it give it time
give it time so there's that right and I
work at pivotal how many of you know
pivotal just curious open show of hands
good stuff hot sauce so we have a lot of
great open source software pivotal we
care very much about open source but
let's be very clear it's not the reason
we are here it's not the reason that we
wake up every morning and and spring out
of bed what we care about is helping
people deliver software faster and safer
to production and we see that a lot of
organizations want to go faster they
need to go faster they know they need to
go faster but they struggle and so a
recent trend in the last say five maybe
ten years or so since the era of cloud
computing and economics of cloud
computing has been to optimize for human
potential optimize for team dynamics by
decomposing your large applications into
what are called micro services and when
you do this you run into a host of sort
of non-functional requirements things
that you need to care about in the sort
of design of each individual service and
in the coordination of those services in
the system one thing you know what will
if you've seen me before you know I've
talked about spring boot and spring
cloud is ways to address a lot of these
sort of non-functional requirements I'll
just sort of implicit complexity one
thing that we've seen a lot of people
struggle with is ok I've got my services
up and they're up and running and
they're talking to each other but I've
got a large amount of data right now
I've got not my data is now separated
it's siloed into different services and
these things need to be sort of visible
to each other they need to talk to each
other if you're dealing with a lot of
data that becomes expensive because it
means in the traditional rest sort of
HTTP based approach on the job of the
ecosystem at least that you're sending a
lot of data over a socket which is being
kept until the socket is done until they
input an output is done so that becomes
expensive and so we're looking for ways
to go faster looking for ways to sort of
reduce the cost of that input and output
at large scale
now this is where we active programming
comes and this is where the need for
reactive programming comes in and we are
by no means the first right in the Java
ecosystem since Java 1.4 there's been in
the channel in Java ni o and support for
channels has been support for reactive
or sort of asynchronous IO this IO that
now delegates all the way down to the
kernel to the lowest levels in the
operating system to handle the input and
output at the lowest levels of the
operating systems in most operating
systems there's this idea that I have a
file descriptor
and there's input and output that's
going to happen and I want to be
notified when I can read or write from
that channel from that file descriptor
that's not a new thing that's been in
operating systems for 20 plus years
in fact by default most input/output
especially network input now put is
asynchronous if you goes to the lower
levels of the operating system it's only
when you go up to the JDK or you have
this illusion of a stream and so what
we're trying to do is to reclaim that a
sort of asynchronous event-driven
approach to input an output so it allow
us to reclaim the idle time in between
actual actual data being available right
I want to be able to say ok there's
nothing happening right now let's do
something else with a thread instead of
waiting for that instead of blocking
waiting for that response
so the goal here you know in JDK when
that for and later was to sort of make
that available but the problem is that
you know when you build mod when you
build systems on top of this low-level
input and output model you need to think
about events at every other layer on top
of that otherwise you're really just
you're going to block somewhere else and
so the ecosystem as a whole has done a
lot of great things to sort of make this
available to make this possible to think
about interactive interactions with
services in an event-driven approach so
we have a lot of great companies out
there a lot of great you know
technologies out there that have come
about as a response to this requirement
to Microsoft of course did the RX
extensions for that net and that
inspired the work that Netflix did on
something called rx Java there's a
company called tight well they're called
Lichtman now they're called typesafe
when they started this they did a lot of
great work and they're clustering tool
called ACTA and they have good support
for asynchronous IO there as well at at
Red Hat now there's a technology called
vertex
so very interesting sort of approach to
reactivity and actually that started at
SpringSource right so that's kind of a
little interesting tangent at pivotal we
have a project called reactor reactor
has been around since 2011 in some form
or another but it's only recently in the
last few years where all these different
players and I'm sure I'm missing at
least one who am I missing our X Java
light Bend pivotal Netflix got that it's
only last few years anyway that all
these different players have come
together and sort of realized that what
we need to do is to extricate or to
define from these common approaches the
thing that really really matters here
the core Interop model and that has to
do with events it has to do that with
this idea that I have a thing that I
want to consume and work with
asynchronously and that became what's
called the reactive streams initiative
these different players worked to define
at the very essence the very basic
interaction model for something that is
essentially asynchronous so the reactive
streams initiative is very very simple
so the facto standard it defines four
different types it defines a type of
called publisher a publisher produces
values subscribers can subscribe to
listen to values coming off of that
publisher when they do they get a
subscription and there is something that
can do that can do both there's
something that can be both a subscriber
and a publisher and that's called a
processor that's it those are the four
core types it fundamentally you know
simplifies what we're trying to do here
it says I've got a thing that produces
values and I want to listen for them
right this is not a particularly new
idea and again if you've used any one of
these different API as you've had that
ability as well but what's that standard
with that default basic interrupt model
we have now something that different
organizations can use to talk to each
other different technologies can use to
talk to each other which means that
you're not you're no longer in a
situation where you have part of the
stack that is asynchronous and part of
that is synchronous or reactive and not
reactive so then the question is how do
I do more interesting things on top of
that I've got this really really
convenient programming model this
reactive programming model and I want to
compose I want to
work with streams of values and I want
to transform them I want to filter them
I want to do the kind of things you
might expect to do with an unending
stream of values the operators that you
might expect if you had a collection for
example on the JDK or a stream a job
eight util stream so these operators are
missing in the default sort of reactive
streams initiative and so the value that
a lot of these different implementations
can provide us to provide these
higher-level operators on top of this
base sort of Interop model the space
reactive streams initiative and so then
once we have that in place
that's what reactor does right reactor
provides that basic those operators once
you have that in place you can now
integrate all that into the parts of the
ecosystem that you care about so what
we're going to talk about today is
Spring 5 spring 5 is not GA yet it'll be
GA this summer right right soon and it
is the basis for what we're going to do
there's actually several there's the
reactor support then there's a support
in a web tier and then there's it
because we have spring 5 the ecosystem
at large this being ecosystem is also
being sort of updated where appropriate
to support the reactive programming
model and to support what we're doing in
spring 5 so you'll see today we're going
talk about spring data reactive spring
data access spring data is an umbrella
project it provides integration with all
sorts of different data stores and
persistance technologies we don't try
and provide the illusion of reactivity
where it's not possible however right so
some no sequel data stores are ahead of
the curve here they've already gone the
extra mile and they've built reactive
integration in their drivers you know to
make it easier for consumers to consume
that in reactive way and where
appropriate we've exposed that in spring
data so spring data has great support
for reactive MongoDB reactive Cassandra
reactive Redis Couchbase right but
you're not going to see for example not
for a while at least reactive sequels if
you just if you have sequel and you have
a synchronous drive and you try and use
it from reactive ecosystem you're going
to be missing out you're going to make
yourself you're gonna make life more
complicated right if you try and use a
thread pool to sort of background work
being done in a synchronous JDBC call
now you've got a much more complicated
a programming model that doesn't
actually offer the same benefits at
scale you've got invest something way
worse than JBC so we don't recommend
that we're not trying to provide that if
it's not appropriate right okay now what
we're going to do is going to build a
simple application something that we can
work with it now I mentioned earlier
that we have the reactor project the
reactor project is our umbrella sort of
integration for reactive programming in
the reactor API you have this basic type
called the publisher I told you about
that and then you have two
specializations that implement publisher
one is called a flux F Lu X a flux is a
publisher that produces a 0 to n values
a mono is a publisher that produces 0 or
1 values could I build my entire system
in terms of publisher
yes but the specialization is
interesting when you're trying to
describe in your API what the client
should expect now functionally all
clients that get any implementation of a
publisher are just going to expect to
operate on the return values 0 to n but
it's nice to know that if I if I call
this method I'm not going to sit here
waiting for a year I'm only expecting
one value right that that's this these
specializations our documentation
elasmotherium just very simple
application so we don't have to linger
too much on the domain so what I want to
do is on a build application that helps
us model movies right imagine we had
some sort of highly scalable system for
streaming movies over the internet novel
though that is some sort of network
access to watch flicks some kind of
thing maybe we could call it net flux I
don't know we've got to do something so
I'm going to build a new application
here today it starts out spring today oh
if you know me then you know this is my
second favorite place on the internet my
first favorite place on the Internet is
production I love production I hope use
of production you should go as early in
often as possible bring the kids bring
the family it's the happiest place on
earth it's better than Disneyland
I love production and so should you but
if you're not already at production then
you begin your journey here it's start
that spring that I owe if you want for
inspiration in the early morning before
a cup of tea or coffee start that spring
that I owe and if your children are
restless and can't sleep start that
spring that I owe if you suffer from
indigestion after a long night of
alcohol abuse and PHP start that spring
that il so we're going to build a new
application using spring boot to do this
is a snapshot spring boot itself will
ship as a GA version in December after
spring 5 right and so by the time you
get the GA versions of spring boot
you'll see integrated and so the in
terms of the common things that you care
about support for reactive programming
including data access including security
including the web tier etc so we're
going to cover just some of that today
ok so I'm going to build an application
to manage our our movie so we're going
to call them movies but you know we need
a service to manage movies and I was
thinking we call the the flux flicks
service which is short for ffs which
could also mean for flux sake right so
we're going to say ffs and we could also
use reactive web reactive mungo we're
gonna use Lombok which is a compile-time
annotation processor and I think that
ought to do we're going to hit generate
that will give us a new zip file I'm
going to open this up in my IDE and
again it doesn't really matter which IDE
you use I happen to be a using IntelliJ
but this is just a spring good
application and so all you need is
ideally Java 8 and them and may even or
Gradle and I'm using maven now quick
show of hands how many of you on Java 8
good to know
while the largest majority how many of
you are eagerly looking forward to Java
9 like I am right on good stuff you are
here in London at the forefront of
technology in so many ways so I'm very
curious every time I come to this
great city so ffs application here we go
I've got a new application can you see
that in the back my friends can you see
the code in the back raise your hand if
you can okay anybody can't can't
somebody says can't okay so uh font
alright bigger okay so let's say we've
got a type of entity we're going to save
this into our into our database I'm
using MongoDB I'm using the reactive
support from MongoDB because if you want
to lose your data reactively then
MongoDB is the best choice so I'm going
to go ahead and say and I've got an
entity of type movie it's going to be
stored into a document right I'm using
spring data Mongo here to support that
mapping I'm going to give it a primary
key or a surrogate unique ID and I'm
going to signal that this is a unique ID
but by using the spring data annotation
at ID I'm going to say that my movie has
a title right and and there we go I
might even give it a I think tighter
title is fine for now right so I want to
say I want to you know create getters
and setters and constructors and all
that I could certainly code generate my
way to that to that goal but instead I'm
going to use Lombok which is a compile
time code and an annotation compile time
and annotation processor that it will
synthetically generate getters and
setters and an equals method into string
and so on so we're also going to say
that I want an all argument constructor
and then no argument constructor and
I'll come with that as well and then I'm
going to save and I'm going to work with
these instances of this data using a
repository so again this should be
fairly familiar if you've ever used
spring data right so here I'm creating a
reactive Mongo repository who that
manages entities type movie whose
primary key is a type string in this
case right so the reactive manga
repository is built in terms of sort of
the reactive types that we expect from
from reactor right so you can see I've
got an insert method that returns a mono
that is to say a value a reactive value
that contains a single value or a flux
for insert that returns multiple right
same thing here I can I can provide a
publisher as well that means I can write
asynchronous I can write values as they
become available to me to the database
right and in the meantime in between
writes and between activity the i/o is
going to background it's not going to
keep that thread blocked right I also
get support for sorting and paging where
appropriate right now you get all this
is all pretty standard fare except that
it's been really worked in terms of in
the light of reactor ok so I've got our
we I've got a repository now what I want
to do I want
dudes I'm going to save some records in
the database so that we have something
with which to work so again this is just
a simple demo let's create some movies
okay let's create some movies that we
can use in our application as a demo as
a sample okay so in order to do this I'm
going to inject the movie repository
here this is a command line whether it's
a command line whether it's an object
that spring will call back when the
application is initialized and
everything is ready for work
and what I want to do is I want to save
some records into the database so we
need to create some records some names
here so I want your help this is
audience participation time I want to
find all the movies that we can find
that work with a theme of reactivity and
you know Webb flux and Lam doesn't so on
so I will get you started one of my
favorite examples was for my film my
friend Phil Webb still Webb did a he
suggested silence of the lambdas which i
think is pretty awesome right can
anybody else think of one like that
there's one Aeon Flux uh if you know
anime where did what movie had the flux
capacitor thank you what about the flux
inator
now maybe anybody else have a few yes
Lord of the flux is theirs what about in
Spanish e tu mano tambien
that means monkey instead of mama right
okay what about I guess that's enough
what do you think it's a nice simple set
one two three four five six that's fine
if you think of some just yell it out
and it's perfectly appropriate to stop
everything we're doing and go back and
fix that because I would love to have
more records there so what I want to do
is now I want to visit every single one
of these and write it to the database so
I want to say for each of these each of
these movie titles I want to write to
the to the database using this
repository so I'm going to say save a
new movie and I'm going to pass in a ID
and the title let me make the ID first
so that we can pass that instead so the
ID of course because it's a it's not
going to be we need to provide the
client-side ID so we say you UID that
random to random ID to string and then
we pass in the movie title and there we
are there we are at least that's what we
think right if you use MongoDB if you've
used spring data and I'm going to be or
indeed spring data in most anything at
this point you'd think you'd be home
free but it won't actually execute if
you run this code nothing is going to
happen and the reason is because it
returns a mono
and that mono is an asynchronous value
you can compose these reactive types you
can compose publisher's into chains and
just like it just like the Java Java
stream API you can compose them and then
the end result the terminus at the end
of the chain has to actually invoke the
whole thing nothing happens until you in
you know activate the chain basically so
even though I have started the
application we need to tell this a
synchronous type that we are ready to
consume it to listen to it so we can say
I want to subscribe and here there are a
few different instances of subscriber
there's a one call it just takes a
consumer of movie which in our case is
fine right so we can say system dot out
dot print line passing in movie dot to
string with a period hopefully okay and
that'll work but I'm using MongoDB in it
it doesn't do a great job of keeping my
data but it might keep all my data in
which case this is additive right every
single time I restart my
my process it's going to add more data
to the database isn't it and so I'm
going to have you know the flux inator
back to the future and flex learn flexes
etcetera multiple times if I run it
again we'll see that reflected
eventually well I'm actually subscribing
here but if I were to do a find all so I
did movie repository that find all dot
subscribe
system.out.print line right you'd see
the the original six and I need to see
everything all dumped out again so
you'll see at least eighteen at this
point yeah so we're getting duplicates
here so what we need to do is now
instead of just calling this one thing
we need to do a dependent call we need
to say I want to delete everything in
the database and then and then insert
some sample records right so I'm going
to say delete all subscribe and again
here I don't actually want to I don't
care about the the return value right I
just want to run some code at the very
end of the process and then use that as
an opportunity to write some data to the
database so I'm going to use this
overloaded version of subscribe that
takes to consumers one for the actual
value one for a throwable any exception
if thrown and then finally a runnable
and this runnable is what we're going to
take advantage of here
we're going to say when everything is
done call that code okay
so there we are and indeed because it's
a lambda I could actually just get into
only one expression in theory I could
get rid of that so now let's see what
happens okay there we are so oh I got
rid of the final didn't I suppose I
could leave that so movie repository
that find all but for each or sorry is
that SUBSCRIBE system that out print
line okay just to make sure everything's
working as we expected it to so it
printed it twice which is what we expect
right it's printing it once here and
it's printing at once here so everything
is as it should be now we've got data
into the database we need to build a
service I wanna have a service to work
with I want to build a REST API
eventually it's but we need a service in
order to do that so I'm going to build a
flux flick service as we talked about
here and the service
our service is going to provide us and
work with these put these are reactive
types right so I'm going to say flux
flix service say service a regular
spring component and in the service
we're going to be going to provide
definitions for a few interesting sort
of use cases one is I want to find all
of the records so I'm going to say give
me a flux of every single value in the
database that's kind of interesting I
want to find just one value so I'll say
give me a mono buy ID by string movie ID
right and then I want to say I want to
give me I want to have it give me a
stream of all of the streaming right so
imagine we are actually some sort of
online network accessible movie watching
system wouldn't it be nice to be able to
log in and see the firehose of all the
people who are streaming videos you can
basically stream all the streams right
or cross the streams so what I want to
do is I want to have that kind of
employee but we don't actually have a
bazillion people logged into my system
at at any given time streaming videos so
we don't have a live feed we can use so
we're going to just fake it until we can
make it right so what I'm going to do is
I'm going to generate a stream or a flux
of events corresponding to streams right
stream the streams right and so this is
for for a given movie we're going to
find all the movie events and so we
don't have this type in the class paths
we don't have it here so let's define
that as well in our movie event will
just contain the movie itself and the
date maybe we can have a user name and
so on but for our purposes I think it's
fine to have it just like that and
there's the data annotation no args all
args etc so there we have a simple
detail a simple POJO that we can use to
to model this okay
so what we're going to do now is going
to implement the service and we're going
to certainly use that repository because
that repository gives us most of what we
need for this implementation right we
don't need to actually do all that much
work we can just pass through where
appropriate so for now let's return it
all here and but for the BIID thing
we're going to say move your posit Ori
dot find BIID passing in the movie ID
that'll be just a pass-through right
that's fine same thing here we can say
movie repository dot find all passing
through for this last one though what I
want to do is I want to synthesize I
want to create a fake endpoint that does
kind of what we want so how about we
just say that I want to value every
single second I want to emit a new movie
event every second as though somebody is
watching a movie every second and so
this gives us a chance to look at how to
compose different streams to get one
resulting product from two sort of
factors or inputs right so here I'm
going to say that I want to create a
stream that creates a new value every
second alright so this is a publisher
that'll that'll emit a value every
second and in the time between that
we're not--we're not keeping that open
we're not blocking right this is a sort
of artificial kind of example but I want
to have two things to work with so this
will give us a give us that ability so
the other thing we want is that now have
a movie event that we can you know
synthesize every time we get a new
second a new time so we can say flux
generate or flux dot from stream and
I'll use the stream API LED I'll use the
Java age stream data API to generate a
new movie event passing in the movie
which we have to we have to come up come
up with up here right so we have to say
movie and I'm going to pass that movie
in and a time clock time so a movie and
a new day date yeah so this is no of
course that's not gonna work we'll come
back to that in a second now I've got
these two fluxes and what I really want
is I want to say take these both zip
them together take both of them and take
one value from the left and take one
value from the right and I won't take
one more value from the right and as I
have one from the left so it's moving in
lockstep I'm zipping them up like you
would two sides of a zipper right so
interval I'm going to take the interval
value here and the event value I'm going
to flat map it I'm going to transform it
from a collection of a single values of
two pole of type to two pole to to a
current
okay of type two right there we are so
those are the results will be a flux of
movie events but we'll only get one new
movie event every second because they're
going to move in lockstep right and
we're going to transform it now let's
create this movie we need to get this
movie as we said and then use that to
drive this thing down here so here we
can say movie repository actual we can
just say by ID can't we passing in the
movie ID and then we can subscribe to
that or even better flat map it right so
I'm going to say is for every movie take
the results and then return them okay
there's our our service end event or
rather ours are asynchronous sort of
zipped up streaming that we can use now
let's go ahead and use this to build a
REST API in here too this should look
pretty familiar right so flux flicks
rest controller and we're going to use
the spring address controller annotation
and this is a you know fairly
straightforward so let's see we want the
private final flux flick service and
we'll create an end point here and we
just have three end points that map more
or less to what we just did in the
implementation so I'll have one in point
public mano of movie will say give me
the movie by its ID and we'll turn this
into an end point in the second here
movie ID okay which are no we want to
have public flux movie all right same
thing as before and want to have a end
point that returns a flux of movie
events right cross the streams string
movie ID now the first two I think of
fairly straightforward they should be in
a way right this is we're going to map
this two movies fair enough okay and we
can use the flux like service and just
say give me everything and spring web
flux which is the module in spring five
that provides the reactive programming
model here will automatically do the
right thing it will emit output as it
becomes available but it won't block the
server
get on the service that's actually
writing the output if there are no
values to write it'll move that that
that thread that's being used to serve
the response back into the thread pool
and it'll keep that server socket in the
background and if there's an event that
says there's more input available it'll
bring it back to life and send more
results back but in the meantime other
requests are can it's possible to
process other requests that come in this
gives us the ability to handle more
requests with the same processing power
basically right per transaction how or
keep in mind this is going to be slower
than the synchronous approach like and
that is to say the cost of starting a
new request and then sending a response
and finishing is going to be possibly
more expensive if you're doing reactive
programming it's only if you have a lot
of data where you want to be able to
passivate in the idle gaps in the input
and output that this becomes a better
approach it becomes more scalable now
spring web sucks is an altogether new
API that uses spring MVC style
annotation so if you've ever used spring
MVC this should feel very familiar
spring web flux works on traditional
servlet through that one a you know
implementations if you want but it's not
going to be very efficient remember the
servlet API isn't reactive it's an epic
and we can fake it in some places but
it's not going to work in all places so
we actually have a net new Neddie based
runtime that's what we're using right
now this isn't using Tomcat or something
this is actually a brand new web runtime
that we built on top of an Eddy that you
know should feel very familiar so here's
a an in point all we're going to say we
want to use this one flux book service
by ID passing in the ID and it will map
this one as well say at get mapping
movies movie ID and this is just a path
variable yeah okay and then finally we
want to map this one now this one
doesn't lend itself to traditional
wrists does it it's we're going to send
a lot of data back and typical rest
clients and rest processing says ok when
the data comes in I want to wait until
the end of file so to speak the end of
the buffer and then process at all I'm
going to take the whole JSON document or
the whole XML document and then
slurp it up and then process it at one
time right it's not natural for most
rest services to just sit there waiting
for file responses that aren't there and
chunked style so what we're going to use
is server sent events we could use
anything we could use WebSockets here
right the point is what we wanted to do
is we want to have and want to send to
the client output that the client
expects to be asynchronous to produce a
value and then maybe not produce a value
for a while and then Prusa value so we
want something that supports server side
push we want to send data down when we
can okay
so we're going to say produces media
type dot text stream value and here
we're going to use the the mapping so
select click service dot stream the
streams passing in the movie ID and here
we'll give this an annotation okay let's
see if that works that should be a very
trivial sort of endpoint and if you've
ever used spring MVC and you've done
something like WebSockets or you've done
something like service and events you
know that we had to do a fair bit of
gymnastics to make it work in spring MVC
before because it's a completely
different input-output model the default
approach in spring MVC proper is to use
blocking servlet API s so you kind of
have to do this sort of very obvious
very pre-planned
sort of approach to doing asynchronous
output well here a flux is asynchronous
it's by default that's what that's what
we're expecting all the time so if
you're returning a stream of values that
we need to write out to the output
stream or you're returning WebSockets
you're doing the service and event it's
just a flux right it's fluxes all the
way down so let's go ahead and try that
ok so curl HTTP localhost 8080 for slash
forward slash even movies how'd we do
not bad
let me grab one of those IDs so we can
pass this to JSON PP which is the pretty
printer or grab this unique ID can we
grab that specific reference HTTP
localhost 8080 movies look at that we
got that one good what about the events
wouldn't we say we called it streams
events
mustn't forget that up Hey look at that
we're generating service and events and
by the way service and event is
basically Jason payloads but it's got
frames message frames very very
traditional sort of messaging kind of
approach so clients are expecting that
the the payload is there and then after
that you've got a blank the limiter so
they know that they can stop blocking
waiting for the reply right until
another one comes back so this is one
approach to building a REST API in
spring web flex its I like it if you're
using spring MVC before you've done
traditional spring game you see this
will feel very natural but there is a
separate approach there's another
approach called functional reactive
endpoints and that's actually become one
of my favorite approaches so the way
that works is you say you create a
router function and the route the router
function expects you to prescribe the
mapping and then the handler that
processes the app mapping it's very
similar to in the Ruby on Rails and the
Ruby and the Java sorry in the Ruby
world you've got Sinatra and the scholar
world you've got sculptress Parker also
very similar I think so it's a it's a
sort of functional mapping from mapping
to endpoint okay so we're going to say
router functions dot route create a
request predicate gets forward slash
movies and here it's asking me to
provide a new handler function right for
this one endpoint so this could you know
it's not all that hard to do that but I
want to use lambdas here this is
actually a nice opportunity to use
method references rather so I'm going to
say public class route handlers it's
just a component that I'm going to keep
my business logic in my MVC logic rather
and it has to meet this contract in
order to be a method reference in Java 8
naturally so we say public all ok do the
same thing again for by ID and for the
events so mono so flux re yeah mono
server responds by ID and events ok so
let's go ahead and implement this using
our flux flicks service private final
flux flick service there's that and what
we're going to do is going to say
I'm going to say server response dot
okay body passing in Flex like service
dot all okay I'm going to say that the
response is a collection of movies so
again this is going to be Jason right so
we have to tell spring webflix that it
shouldn't try and use Jackson because
Jackson expects the whole Jason document
right it shouldn't try and use
traditional XML we have to do message
framing because even if we're doing
regular rest values maybe maybe emitted
you know a minute later they may be
emitted whenever so are processing are
Jason marshalling behind the scenes is
smart enough to actually say okay this
is one record at a time we have a
thousand we have a potentially unlimited
amount of Records so it makes no sense
to wait for all of them to appear so we
actually render the JSON one at a time
whenever we can so here's the all
handler flux we're going to say server
response dot polka dot body equals flux
like service dot all sorry events right
cross the streams
and here we have to pass in the movie ID
all right so we're going to say string
movie ID equals through the server
request path variable movie ID pass this
in and do the same thing as before tell
it that we have a collection of movie
events now again remember what we talked
about this isn't a jason endpoint
anymore we're expecting to send service
an event payload so we need to specify
the content type here as well just as we
did before okay so there's a two out of
three right there's all there's the
events and finally we have this one same
kind of thing we can just copy this code
put it here okay and we can say server
response dot okay dot body server flex
flick service dot by ID passing in the
ID telling it that the collection of
movies and with that we can now use this
new route handler as a being that we as
a collaborating being that we can
reference here so right handlers
and for our last method here we can say
route handlers all ok let's create my
own to make this simpler so I'm going to
use well let me do in a second I'm going
to now chain these together we create a
new route that says I want to get the
movies by movie ID route handlers by ID
and chain it one more time
request predicates dot get movies movie
ID events right so same thing about
handlers events very good so there's our
functional reactive endpoint so again
you can use static imports so let's get
rid of that you can get rid of the
qualifier on the on the predicate there
as well so it becomes very cleaning at
that point and you know easy enough to
read so there is our rewritten code and
I think that's actually fairly
approachable if you like all your
business objects you're like all the
mapping information in one place this
can be very useful as well right so
let's try it out there's all of our
jason Jace's before let's grab this curl
HTTP localhost 8080 forward slash movies
forward slash this one for slash events
there we are so we've got two different
approaches to building our reactive
web service one is using proper rest and
Jason the other is using service and
events but programmatically and the way
we interact with it they're very similar
right we don't have to worry too much
about the differences now it wouldn't be
much of a service that we didn't build
much of if we didn't build a client so
in our last waning minutes together
let's talk about building the client for
our service I'm not going to use MongoDB
in this case I'm just going to build a
rest client that works with that data so
CD downloads unzipped
OOP unzip FFC zip see the FFC idea
Tom that XML now what we want to do
here's want to make a call to the rest
service but again from the perspective
of asynchronous blocking restclient
nothing is different about what we've
just done on the server side if we have
service end events and we've got a
synchronous blocking client that client
is going to block the server side is 3
is free to to move the the thread back
into the thread pool during their during
the idle times during that one second
gap for example but on the client
nothing is necessarily different it can
be though right if you build your client
to be smart enough to realize that
certain things are asynchronous by
default then you have an opportunity to
opt you know to make more efficient the
consumption of rest a pas from the
client that's what we have here we have
the chance to do that as well so let's
look at the web client API that's in
that's new in spring web slugs I'm going
to start at a different port ok now I'm
going to create a beam this is the
alternative to the rest template right
if you've ever used the rest template
then you know that the rest template is
the workhorse of the sort of spring MVC
HTTP client world but we end in the
spring web flex world you have this web
client which is it provides a reactive
API provides the ability to not block
when it's making requests on things that
support asynchronous responses so what
we want to do now is want to call our
endpoint using the web client and just
iterate through the values and then use
that to get the service and event and
again that's another thing that wasn't
super easy to do in spring MVC in the
rest template to call the a server sent
events endpoint the rest template by
default will wait for all the responses
to come it wouldn't start turning them
out when they're available so let's say
web client dot client rather dot get dot
URI HTTP localhost 8080 forward slash
movies dot exchange and then subscribe
let's just try that let's see what
happens
oh what's going to happen is I'm going
to get actually for our subscription
we're gonna get a object of type client
response
and so our job is to take that client
response and to tell the client how to
turn that into something you can use so
I'm going to say in this case to frame
the results to frame the data that comes
back as objects of type movie and I
don't have that type on the classpath
right so let's just cheat a little bit
I'll use these little empty entities
here as d tos on the client side
we don't need the mapping annotations
for spring data because that's not in
play anymore there we are okay so I'm
going to say give me the body as a M as
a flux of movies and then I'm going to
say just for now let's see if that works
make it wiggle you know I'm going to say
print out the results okay so let's try
this one
there we are there's our records now
that we know that that works let's try
using some of those operators we're
talking about to find the result using a
filter so going to say movie get title
that equals ignore case and let's grab a
movie title here silence of the lambdas
okay
so let's try that we should now have
just one result
okay there you are if you can see that
it's on the very bottom here are one
movie now what I want to do is want to
get the server sent events stream and
view that on the client so here well say
silence and here I'm going to use the ID
to make another client not another
client call so client get that a URI
HTTP localhost 8080 forward slash movies
forward slash client sorry silence dot
gets ID events exchange dot subscribe
and what I want to do here is take the
client response from this plant response
to and turn it into a body or to us a
flux of movie events and then print all
that so system.out.print line okay
and there we go all the values are
coming back as we expect because we're
used to because we're using these fluxes
and the models everywhere it's pervasive
our code you know it we can compose
these we can do higher-order things with
them we can build systems that are
optimized for asynchronous i/o this
gives us the ability to now think about
things that aren't naturally what we
think about things like WebSockets and
things like service and event in the
same way that would think about anything
from the client perspective there's no
you know we deal with it in the same way
we don't care that on the server side
it's actually just an array with five
elements that got returned as a
synchronous you know blocking ArrayList
because it's been wrapped in a flux so
we just have to know how to think about
and work with publishers basically the
Java the reactive streams publisher API
what we looked at in this talk and our
little time together we looked at Spring
web flux but look at Spring 5 and the
support for reactor in spring and spring
web flux itself we looked at functional
reactive endpoints we looked at the
traditional spring MVC style rest
controllers will if it's spring data and
the spring data Mongo support the
reactive spring that among go support as
well and remember this is very important
reactivity doesn't make any sense if if
at any layer you have to block you lose
the benefits down down layers so it's
important that the whole thing be
non-blocking from the request all the
way down to the data store and back all
right at any point in that I don't have
to wait for the reply if it's not there
this is important to us on the spring
team so spring boot to toe will be due
at the end of the year one of the big
features you'll see is that spring
security will have support for
reactivity right it makes sense right if
you're doing react if you're doing
reactive programming you've got a
reactive REST API but that's saying you
want is to have to do a blocking check
on a principle in a thread local for
example that's not going to work anymore
same thing for in spring clouds wind
cloud we've integrated where appropriate
the reactive API is and so in spring
cloud we have a new technology called
spring cloud gateway which is very
similar to dual it's a micro proxy so
you can use it to create proxies that
talk to other services it is end to end
reactive using spring web flex right so
we have a lot of lot of interesting
things happening here this is just a
preview
I hope you've appreciated it and saw
some value or some opportunity here I
encourage you to kick the tires to try
the bits out I'm happy to take questions
if you've got them though
and my time is up so I want to thank you
so much for coming I appreciate it very
much Cheers</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>