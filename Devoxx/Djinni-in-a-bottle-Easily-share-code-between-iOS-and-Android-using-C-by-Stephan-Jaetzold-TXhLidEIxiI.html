<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Djinni in a bottle - Easily share code between iOS and Android using C++ by Stephan Jaetzold | Coder Coacher - Coaching Coders</title><meta content="Djinni in a bottle - Easily share code between iOS and Android using C++ by Stephan Jaetzold - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Djinni in a bottle - Easily share code between iOS and Android using C++ by Stephan Jaetzold</b></h2><h5 class="post__date">2016-11-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/TXhLidEIxiI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay hi and welcome to genie in a bottle
my name is Stephanie at fault and I'm a
freelance firm making iOS apps but I
also have a long history of doing Java
work so naturally I'm interested in ways
of making the to work together recently
I worked at Dropbox and there I came
across an interesting and powerful
technology was a tool called Genie and
in this session I show you how to use
Jenny to easily share C++ code between
iOS and Android so I mainly do that was
the demo well is setting up and
implementing a small cross-platform app
from scratch
but before that I'll briefly talk about
what ten years and where it fits in and
afterwards of course a summary and I'll
mention some aspects of genie that
weren't covered during the demo so what
is Jenny its github repo States Ginny is
a tool for generating crossed language
type declarations and interface bindings
but what does this mean exactly so jenny
consists of a pretty simple interface
definition language where you describe
your types and interfaces in and then it
generates C++ Java and objective-c code
out of that but it also takes care of
all the code in between like what
functions to call and translating the
types to an appropriate representation
in the other language so in the end with
training you're only dealing with Java
code and it's types on the Android side
with C++ code and it's types on the C++
side and objective-c and foundation
types in the iOS world and it's open
source so there's no vendor lock-in to
fear here so the ideal of genius not
that you implement your whole app
cross-platform you implement the UI
still separately for each platform
because the platforms are different
after all
they each have their
the peplos user interface patterns to
follow and you want that to have a
really polished app but also many apps
have a big part that's business logic
that's dealing with data and that you
want to be the same across platforms and
with Ginni you implement this business
logic part cross-platform in C++ your UI
you implement in Java or Objective C
with the platform native toolkit and
Geney takes care of the connection
between the two but yeah this is a tools
in action talk so AFET I'm going to demo
how to fit Ginny up and use it I'm going
to not really clone but copy the github
repo locally so that I'm not dependent
on the network connection and then we'll
make an ID L file called greeting
duccini
and in that we define a small service a
greeting service that generates
greetings for us and notice the little
plus C behind interface that means we're
implementing this interface and C++ so
generating the code the jinnee command
for that takes a lot of parameters so
I'm also adding a shell script here as
you see a lot of parameters and I don't
want to remember them all they control
where the source code displays what
package the Java classes are in how the
names are generated and things like that
and was that I can run the script and it
generates the code for us that was
pretty quick usually if you clone the
repo it fetches dependencies first and
compiled itself at jinny itself is
implemented in Scala but because I
copied the directory that was
already there so let's have a look and
what it generated so it generated a
header in C++ and there that we are
going to implement ourself so make a
directory for our C++ implementation
then it also has a Java class and
Objective C class and then the glue code
in Objective C + + and Jane I so now I'm
going to create an android project but
we call android client and we of course
want to include c++ support Oh wrong
path here
okay
yeah that's all fine we can do with a
default you want C++ 11 exception
support and runtime type information is
important for Jinni too so it generates
the right compiler flags for us already
and also for code sharing you want to
use the same code for both apps like the
actual same files usually you probably
want to set it up that you're Ginny and
C++ code lives in a separate library
project for example that you depend on
but for this demo I'm just going to
create some siblings that puts the all
the directories that we use for Ginny
into our Android project so we can use
them there
let's see what it generates it for us
and where I put it in the project so
here is a directory for the generated
code the IDL file and support library
that's code that's part of the jinnee
distribution that's the generated files
use and here is our C++ code and now I'm
creating the implementation of our
greeting service let's call it greeting
service simple with the header and I
just paste in the the code there it's
still red because we haven't told the
build system yet where our C++ files
live I'm going to add the implementation
code as well first and then we edit
cmakelists which is where we specify
where all our C++ code lives and how to
package it up as a library so I'm
telling it where the support directories
are what directories our generated code
and our implement implementation lives
in and also I'm defining a shared
library here which will later include an
in Java but because it also generated a
natural Java class for us we also need
to add something to our source set so
that the build system finds that
generate a Java code let's sync then
that and then the C++ and header file
should should get green after a while
okay still running yeah so it's done now
so let's see yeah everything looks fine
here so now in the main activity
I can leave native Lib as is there
because I have named it the same and we
can use the greeting service just as any
other Java class here and just when we
fetch a reference to it like if you when
we create an the service for the first
time we need to bootstrap the connection
between Java and C++ so we're not doing
a new here instead we are calling the
static method that was defined there
which gets you the first reference into
the C++ code and then we can use that
greeting service to generate the actual
greeting okay this was auto-generated
for us we don't need that and also so
that it just looks nicer I'm going to
modify the label of it increase the font
size Center it and move down and then we
built that and run it into in our
emulator
okay so I just want to point out that
you're really using a Java screen here
and a java class and you're not seeing
that this is implemented in C++ except
for that you need to load the library
within a shared library somewhere and in
C++ you also just are dealing with
standard C++ strings and shared pointer
in all of this and you're also not
seeing that this is actually used from
Java so everything gets translated for
you for you automatically
so this should start off pretty soon now
and there yeah like with standard a
first demo app now let's go ahead and do
the same in for iOS a new project there
yes and it is fine
yes
okay and there we need to also add our
Jenny code like this on enter C++ angle
implementation we just did so adding the
IDL and our C++ implementation we can
add it to the target we don't want to
copy it because we actually want to
reference the same files and let's
organize this but with a group and there
I in Port the generated code and the
support library the support library is
in the Ginny distribution okay I don't
add it to a target yet because the
support library and the generated code
also contains Jane I implementations for
example which I don't want to comply for
iOS but now I need to modify the target
myself so I add the implementation from
the support library and then the
generated code we have the objective-c
implementation I want and then for
Objective C only a header and here as
well so actually is enough to add this
to the target
okay and because our service is already
implemented up here we can go ahead and
use it right away in our viewcontroller
and now an objective-c it also just
feels native to the environment I have a
greeting service that's prefixed in
Objective C because that's how you name
space there and I'm going to initial
initialize it the same way pretty much
as I did it in Java which is calling the
class method on it
there was no label auto-generated for us
so I need to do that manually here
and now I can assign the result to the
text property and again here now I'm
creating an nsstring literal so
everything as it should be in the iOS
world now the label needs to be set up a
little bit so that it actually appears
in our view that I prepared okay so
that's it for iOS and we can run this as
well in the simulator
okay so now I'm going to extend that
greeting service a bit to show you a few
more features of Jenny so Jenny supports
more types than string of course out of
the box but we have a few collection
types a list so I'm going to change this
parameter so we provide a list of people
we want to greet and you also have set
and map which get mapped to the
appropriate types in each language and
now I don't return anything from read
anymore instead I will add a display
reference to that service and this will
also be a Jinni interface but this time
it will be implemented in Java and an
objective-c so this is how you can add
callbacks then so you go into the C++
code and back to Java or Objective C and
can do round trips as much as you like
and this can display greetings and this
greeting will be another type that
Jeannie supports with this which is a
record and records are value types so
before you actually get references to
the object in the other language but the
value type you get copies of your data
in this greeting of course contains
message which is a string and just to
show of a few more features it also has
a color
and this color will be an enum and yeah
greetings can be either red or blue and
more things apart from more types like
bullion various types of integers
floating point and such you can also
define constants here so let's define a
constant that is a cool down and that's
very long integer and we can set that
value right here to let's say 4,000 but
maybe it's not really obvious what it
does or what what it's for so let's add
a comment here but now so this cool down
like slows down generating greetings a
little bit but that means that our greet
method now can take a long time so I
also add a comment there that it should
be called from a background thread and I
want to mention here that it's better to
not create new threads on the c++ side
and said use the native platform to do
that because they might get you into
trouble it doesn't interoperate well
with the actual platform you're on and
the Jinni distribution contains example
code that uses a genie to implement an
interface in which C++ calls to get a
thread from the native platform but here
we're just calling it right away
so let's generate the code from this
and then implement this extended service
so now that method is not valid anymore
so I'm going to add the extended version
of it and also here oh yeah actually in
Xcode or app code in this case so with
Xcode projects we need to add the files
manually the newly generated ones this
is also a reason why you might want to
put that into a separate project because
then you can Auto generate the project
fire if it's only for the genie code
for the last ones we need for the object
of seaside so it generates one file for
every type you define okay so now I
already did the implementation here so
it changed so it gets in pointer to the
greeting display the list gets
translated to a vector in C++ and this
is just reference to the display and in
the implementation I'm just generating
the color randomly and creating that
greeting object in the standard C++ way
okay let's update our view controller so
that it uses the extended greeting
service so here we now pass in the
reference the greeting display is
created as a protocol so we can adopt
that here and actually import it so that
it knows about the method in there so
let's implement that
so this greeting now has message
property which we can use to update the
text in the label and it also has the
color property which is an enum so that
means we can do a switch over it
and just
okay
and just so that it looks nicer home I
let this the label fade out and here I'm
using the constant that we define and so
you see how it looks if you're using
that and Objective C but also how we
call into the service changed a bit so
it doesn't return a result anymore
and takes an NS array as a parameter an
array of strings and also ya control we
comment here actually so it says call
from a background thread so we actually
do that call this in another thread but
this also means that when the callback
comes back here to the greeting display
we need to switch back to the main
thread
this one okay so let's run this in the
simulator
okay there we have our text it has a
color fades out changes now we get a
blue one yeah and so let's do the same
and Android this time with the
implementation already there you need to
refresh it a bit first
okay so recognize that already but also
Android needs a little bit of extra help
so it didn't recognize when you Lee
generated CPP file and for that you want
to do refresh link C++ projects up there
in your build menu so let's go to the
main activity and add the parameter the
greeting display to the create service
method but since we are on the Java side
we're not doing any protocol things here
we can actually use an inner class and
then follow this call to an actual
implementation in our main activity
so we final them and yes we can create
and since this is the same code pretty
much as on the object to Seaside I'm
just passing it in so again it gets the
message string their sets it gets the
color can do a switch over it
and here is the constant this is how it
looks on the Java side also we need to
change the way how we call into the
greeting service which is also pretty
much the same and also we need to switch
to the UI thread here this one okay also
this needs to be fine as well and now we
can run this in the Android emulator
yes so this is not the fastest machine
and one thing that which is a drawback
if you're using C++ your compile times
increase and they are also some
optimizations which you usually usually
can use by doing Android development
that don't work if you also have C++
code that you're compiling with it let's
see what it does once it's finished
and there yeah same thing just on
Android okay
so let's summarize so Ginny gives you an
easy transparent bridge between C++ Java
and objective-c it supports many basic
types already but if you need more like
your library or app has specific types
it wants to support you can add that as
well so there's the possibility to
define types you can use in geni which
are actually implemented outside of
Ginny and for example PS PDF kit which
uses 20 uses that capability to define
its own mapping of a color type also
what I didn't show is that exception
information is sent across the language
boundaries that doesn't mean
unfortunately that you get the C++ stack
trace in Android but at least you get
the exception message that gets passed
along and yeah it's open source so get
it on github if you want to try it out
and it's also used by a couple of
companies already big and small and the
demo code you can find at a github repo
of mine where uploaded it before so you
can check that out right away so with
that thank you all for coming happy to
be here and if you have any questions
come find me later or now I'm here all
week so thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>