<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Cloud Native Java by Josh Long | Coder Coacher - Coaching Coders</title><meta content="Cloud Native Java by Josh Long - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Cloud Native Java by Josh Long</b></h2><h5 class="post__date">2017-03-13</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/-Xn9T8pTbdo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">and we will be starting why we talk from
Josh long about cloud native Java Josh
well thank you very much hi everybody
salut salut and hi thanks for ever
thanks every for coming I know you have
a lot of great choices we have one
really great choice that's a dr. Heinz
caboose and you chose the lesser of the
two so thank you very much for for
coming um we're gonna go through a lot
of stuff today we have very little time
just 50 minutes so I really want you to
not worry we're going to have the code
that's available for you here online if
you want to follow later on please note
the code I'm also happy to answer
questions and so on I'm online I'm you
know I'm on the Internet so how many of
you have twitter twitter 2016 twitter
2017 ah see this is why I can't work
here I'm not that smart
uh what about what about email how many
of you have email e-mail anybody email
alright huh
okay so so anyway so anyway I'm
available to answer questions if you
have them you know I'm here for you um
also we have to take care of something
very important in near and dear to my
heart
yesterday I got to take a selfie with
the yeah exactly the CMS which is not
the garbage collector here at CERN and
it makes me it gives me goosebumps just
to think about it that's super cool so I
want to take a selfie with all of you
and so when I say homage I I want you
all to say homage with me and it'll be
awesome ready 1 or I do promise
ah that's a milky okay good stuff so we
have a lot to go to a little bit about
me my name is Josh long how many of you
have had the displeasure of seeing my
talks before anybody okay so the rest of
you my name is Josh I work on the spring
team I'm the spring developer advocate
I'm an open source engineer and
contributor I am the number one top
Rank's for seven years seven years now
more bugs I have created more bugs in
the code than any of the other engineers
in the spring projects the number one
number one you're welcome
exactly so there's that I work in a lot
of different projects like spring boots
and spring clouds spring integration
spring batch batch bharden time leaf
activities cetera more bugs than any
other engineer on those projects I'm a
job at champion and Melba you know and
I've also done a training videos and
books the latest and greatest book of
course is cloud native Java the book
which I'm still working on which I've
been working on forever
it's an O'Reilly book and for those of
you are wondering about that bird many
people ask me about that bird they don't
they don't know I know that you're all
scientists and so you you wonder about
these things that's a blue eared
Kingfisher it's a bird from the
Indonesian Java Islands it's a bird from
the islands of Java
now-now-now birds birds fly they fly in
the clouds
it's a it's a bird that is native to
Java it's a it's a cloud native java
bird it's a never mind never mind it'll
come it'll come there we go
it's fine don't worry about it it's
going to hat it's fine don't worry about
it uh so and I worked at pivotal in a
pivotal way we have a lot of great open
source stuff how many of you recognize
some of these technologies how many of
you recognize recognize them
what about Apache Tomcat Tomcat ok good
stuff hot sauce we're good
what about spring spring right on good
stuff so a lot of stuff there a lot of
open tore space we also have a platform
called cloud foundry cloud time is an
open source platform it's optimized for
managing and delivering applications to
production that's what we care about at
pivotal and we have seen at pivotal that
a lot of different organizations are
struggling with this they want to go
faster they want to be able to deliver
business value or in this case actual
value scientific value to the production
of you know sage I imagine in your case
the rush to go to production is a little
more explosive if it's incorrect right
so maybe it's not the same thing as a
lot of other businesses a lot of other
enterprises but still going faster and
getting results faster increases our
ability to to see results in to do more
experiments right very fundamental to
the scientific process so we feel a lot
of organizations trying to go faster but
they struggle they they don't know how
to take their large existing monolithic
applications applications that were
written in a time before and they don't
know how to take them and turn them into
smaller pieces smaller batches of work
we can we can take some good advice dr.
Eric Evans he talks about a bounded
context in his book domain driven design
a bounded context is a part of the
domain model that you can work with by
itself it's internally consistent so you
don't need to talk to other things to be
able to understand what that entity what
that domain means in a bounded context
if you can identify bounded context then
you can use those as the basis for your
services right a bounded context is a
natural place to divide your large
applications into smaller pieces the
benefit of this is that you can now
focus small groups of people on that
single service on that on those
different services they don't have to
all you know you don't have to get the
whole organization involved in working
on the codebase you can divide the
codebase into smaller pieces this allows
organizations to go faster now work in
the organization can go from product
management to user experiences the
developers the testers administrators
and then off into production what I'm
describing here of course is a micro
service micro services give you the
ability to or optimize your organization
and optimize for human potential so it's
a good idea for a lot of organizations
because allows them to go faster to
deliver work into production faster
without having to spend so much time
waiting for everybody to test that
everybody to stabilize and everybody to
contribute and so on their code micro
services have a lot of benefits but they
also invite pain they invite complexity
and that complexity can be daunting it
can be very difficult for people to work
with if you're not prepared there are
two big problems that people face when
they go to this architecture first of
all how quickly can I build a service
that is worthy of production that has
load balancing and security and you know
DNS and heartbeat detection and it's
observable and monitory below how
quickly can I handle all of these things
in my application these are the things
that I have to handle but they are not
why I'm here right I solve them because
I want to I want my application to be in
production not because that's what I
care about when I try to solve this
problem
very few people start businesses and
they say I'm going to solve SSL right
that's not why most of us are here we're
trying to solve actual problems so
that's the first thing the first thing
is how quickly can I do that the second
thing is once I've done this I have now
a lot of different services I have a lot
of different services in production and
they're separated by network partitions
they're distributed this creates
complexity that it's very hard to manage
and if there's anything indeed even one
thing that we can all agree on I'm sure
it's this building distributed systems
is hard and so we need to be prepared to
address that complexity so for the first
thing for that first aspect for that
first concern we can use something like
spring boot for building software that's
easily you know easy and then quick to
write and then we can use things like
Cloud Foundry to deploy and manage the
applications that's a you know common
enough approach but for that for the
second concern we need to handle the
concerns related to distribution and for
this we have spring cloud and that's
what we're going to look at here today
so how many of you heard of or worked
with or know about spring boot how many
of you have heard about it ok ok so
spring boot is basically spring with
less configuration right it's a nice
consistent way to write applications
without worrying too much now we're
going to build a simple application
today and I don't want to spend too much
time on the domain model I don't want to
spend too much time dealing with oh yeah
Vegas I don't want to spend too much
time focusing on the domain model so
we're going to build a very simple
service ok I'm going to call this the
reservation service and I'm going to
build a service here at start dot spring
that il this is my second favorite place
on the Internet my first favorite place
is production
I love production you should love
production production is the happiest
place on earth it's better than
Disneyland bring your kids bring your
family it's the nicest place but if you
haven't gone to production then you can
begin your journey here it's start that
spring that i/o if your children cannot
sleep start quest spring plan yo
if you suffer from indigestion after a
long night of PHP and start that spring
that I owe and if you need inspiration
in the early morning before you're a cup
of tea or coffee
start that spring that I owe so I'm
going to build a simple service I'm
going to call this the reservation
service I'm going to use a lot of
different technologies here I'm going to
I'm going to use H to H to them in
memory embedded sequel database it's in
memory and it's going to lose all of its
state after every single restart right
I'm not going to persist the data so
it's going to always lose its data very
similar to MongoDB it just loses the
data all the time from no for no reason
at all it's no reason no reason alright
so there we go I'm going to use JP the
Java persistence API because I make poor
life decisions so JP a oh oh oh yeah
yeah it's true though so config clan
amis config client for centralized
configuration I'll use Eureka for
service registration and discovery I'll
use zip confer distributed tracing I'll
use rabbim queue for stream processing
I'll use a rest repository support and I
think maybe that's enough note maybe
actuator as well there we go so
naturally I could I could switch to the
full version I could switch to the full
version and I get more check boxes more
things that I could add to my
application but for now I'm very happy
to leave the choices as they are I've
got enough now we have a few dropdowns
up here my friends dropdowns that people
look at they get very confused so the
choice of language of course you can
choose any language on the JVM that
supports annotations and objects that's
fine right Java groovy Kotlin Scala
Ceylon they're all great choices right
you can see that we have two more
dropdowns here however and these are
what I like to call non choices they're
not actually choices they're choices
that you could make but that you should
not their choices in the same way that
running naked in traffic is a choice you
you could but but but the don't don't so
for example what version of the JVM
would you like to use 1.9 is almost here
and both of these are end-of-life to
continue using either one of these is it
insane and irresponsible so we'll leave
it as is and then here we have the
choice of packaging and people get
confused about this they don't know when
and where to choose which so I'll do my
best to explain if by some crazy
accident of physics some freak accident
of physics you find yourself stuck in
the distant distant past as though you
have time traveled then use dot war but
if you're here in 2017 then use dot jar
this is a big part of my overarching
guiding personal philosophy of make jar
not worn again
you have choices you have options you
should do what works for you so I'm
going to go ahead and hit generate and
we're going to open up our application
I'm going to build a very simple service
I don't want to spend too much time on
the service or what I want to do is I
want to build an application so that we
have something with which we can work
all right
Oh how many ever using IntelliJ just
curious good stop
hot sauce well done what what about
NetBeans NetBeans is awesome how many of
using NetBeans right on good stuff as
well
what about Eclipse which is also awesome
right on as well all good choices
what about Emacs are you here are you
here there's that one guy every single
talk I do it's the same human being
every he's not here you kept him at the
door
he's very very fast e he comes to my
talks and I say are you here sir he
raises his hand and then he leaves just
so he can be at the next place to raise
his hand so what we're going to do is we
going to build a simple application it's
a simple application to manage entities
of type reservation right I'm going to
say at entity right JPA here and I'll
give it a primary key like this and I'll
say at ID at generated value so all I'm
doing is I'm creating an auto
incrementing surrogate ID a primary key
here right and I'm going to give it a
single field reservation name right this
is the name of the reservation for a
restaurant or a hotel or whatever I
don't care it's a very simple domain
right now this is the essence of what I
want to express but this is Java of
course so I need a constructor I need
some onion some getters right there's
that I need a two string method there's
this I need what else I need I need
another no argument constructor this is
for JPA right right here okay
and there we go so there was a little
white simple JPA entity and I want to
save data into the database so I'm going
to create a spring data repository I'll
say reservation repository extends JP a
repository of type reservation whose
primary key is of type long and what I
want to do is I want to save data in the
database this repository will
automatically be implemented for me I
don't have to implement that class that
interface spring data will do that for
me and there's other modules for MongoDB
or Cassandra or neo4j RabbitMQ not run
Redis or you know all these different
things Couchbase so use whatever you
want but I'm going to insert some data
into the database here so we have some
sample data let's see here so this is a
callback component this class implements
the command line Runner and when spring
boot starts up it's going to call this
void run method on the application
startup so let's see who's here today my
name is Josh I'm here
let's see Stephan of course the one and
only mr. hazel there we go um who else
Antonio one of me okay who else what
about you my friend what's your name
comes up okay very good
what about you buddy what's your name
how do you spell ma EJ dej like so which
one is it
this one okay okay
okay very good miss what's your name
patty Scott TJ
very good thank you uh and what about
you miss what's your name how do you
start okay
a te9 to meet you also thanks for coming
so what I'm going to do is I'm going to
visit every single record that we have
there and save it to the database then
I'm going to get every single record
that comes out of the database and just
confirm it's working now what I want to
do is also stand up a REST API right
this is a service I need a REST API I'm
going to use spring data rest all right
I've got spring boot starter data rest
okay
whoops I'm going to go back to spring
boot 1.4 so I don't get snapshots and
waste our time here today okay
so spring boots started that arrest I'm
going to add that just in case and that
will allow me to make this repository
into a REST API oh just a repository
rest resource and then that I think
should be it let's go ahead and comment
out some of the stuff we don't need
right now so we don't need this right
now
we don't need RabbitMQ right now we
don't need these things right now okay
so that'll be enough I think to go let's
run it let's see what we get now I've
got an application if you know about if
you know much about spring boots and you
know that it's easy to configure such an
application I can open up the property
file application app properties and I
can say server that port equals eighty
eighty or eighty ten for example this is
the default place where spring boot
looks for property it's right I can
change the default behavior another
alternative is to go to the actual jar
itself right I can say CD reservation
service maven - be skip test because
Yolo right clean install
and I can go to the target directory and
I can say Java - P server dot port
equals a t10 - jar reservation service
jar and that'll spin up the application
this time overriding the default port I
used a - D argument so I'm using
configuration just like here right
server that port but I use it in the
command line this is called 12 factor
style configuration that's very useful
right I can see that that works if we go
to localhost 80 10 for slash
reservations
there's our API there's some hypermedia
data we've got the deep linking records
right I'm using my REST API and I'm
using an import a t10 now this REST API
has links this is hypermedia this is an
implementation of a design pattern
called ha gos or hyper media as the
engine of application state it's the
idea that every REST API should have
enough information for the client to
work with the API without any a priori
knowledge right without any upfront
knowledge it's very important when you
move to distributed systems because very
few developers write documentation and
zero developers read it none zero so you
need to make it as humane as possible as
as friendly as possible to work with
that API what we have here is a self
describing service these links tell me
my menu of choices my options right now
I have this application this
configuration style that I just showed
you is a good start but it's not great
it has several limitations first of all
oh yeah no okay
it has several limitations first of all
what if I have more than one application
do I have to copy and paste those
configuration properties from one shell
script to another that's not very good
what about secure information passwords
locators could things like that I don't
want that laying around on the file
system unencrypted right that's that's a
big deal right especially in light of
the cloud player thing right we got to
make sure that our passwords to anything
interesting are encrypted what about
auditing and journaling I want to see
who changed the configuration and when I
want to see what happened and if I need
to I want to roll it back right I need
to be able to have that facility and
then finally I want to be
change the configuration while the
service is running so while this is a
start it's not really good enough is it
what I want to do is I want to have a
single directory with my configuration
in it that would solve the centrality
issue right now all of my services could
talk to the directory full of
configuration files that's a start
another option might be to version
control that directory that would also
give me the auditing and journaling but
what about the the security what about
the encryption and then what about also
the the live reloading for this I need
something more so what we're going to do
is going to build a a REST API to manage
our configuration right our
configuration will be based on git but
it'll be on it'll be behind the thrusts
API so I'm going to create something
called the config server and I'll
generate that on the config server it
will babysit it'll sit in front and MIDI
access to a directory full of
configuration so I need to create that
directory when I need to clone that
directory I happen to have a directory
based on git on github I'm going to
clone this here and I'll clone that to
my desktop config directory here okay
and then meanwhile this is downloading
the world config service at enable
config server and I keep forgetting to
put it back to 4 or 4 they released a
new version and I haven't updated so
there's that now Mike in my application
before it can do its work it needs to be
told to run on port 8888 right and I
need to tell it where to find the
configuration I'll say spring cloud sir
config server that get that URI equals
I'm going to point it to the directory
where I installed the configuration on
my desktop in the config directory right
so home desktop config very good so
let's go ahead and start this up now
this is going to be a REST API that my
other micro services can talk to to get
their configuration now the
configuration isn't baked into the jar
it's not compiled in the jar I can
override it and so on so all I need to
do is to use that configuration is to
use the configuration client right so
here I'm going to use the configuration
the spring cloud starter config property
or library rather and then I need to
tell spring
cloud the name of my application I'm
going to name it reservation - service I
also need to tell it where to find the
config server right I can use this
property to change the default value but
by default it's going to look at
localhost 8888 anyway so you know I can
leave it as is I'm just very lazy and
I'd prefer not to do this right so
localhost 8080 8 that's fine but
redundant in this case ok now if I if I
successfully start the application up if
I go to 1888 reservation service default
I can see that this is the configuration
for the micro service called reservation
- service and I can see that there are
several different reservations or other
property sources one for reservation
service type properties and another one
for application up property all the
micro services will get their
configuration from application up
properties and then for the properties
from the property file specific to that
service so reservation service will
identify and connect with this property
file it'll start on port 8000 and will
have access to this message helloworld
right so let's see that work let's
create a endpoint here we'll say at rest
controller class message rest controller
ok and I'm going to create a value
private string value and I'm going to
create a constructor and in the
constructor I'm going to tell spring
please inject that message from the
config server there and I'm going to
expose that configuration here as an
endpoint right now I can imagine wanting
to change this value later on it's good
but it's not great is it so I want to
make this bean refresh scoped ok that
means that I can recreate the bean lies
while the service is running I don't
have to restart the service each time
just to see the new configuration so
let's see it works well first of all are
we on the right port move in the way
IntelliJ
we're on port 8000 I think we're in a
good place
let's see localhost 8004 class
reservations there we go there's that
now here's the message endpoint that's
good but it's not great right we need to
do better so let's go to the desktop
config directory here open up this
property file and I'll say
borshu or turn xjk there we go and if I
look at the property file reservation
trips up properties it says that message
I'm going to do a git commit - a - oh
Yolo okay get status it's committed
right there's the processed the poop for
my little editor okay
goodbye to that now my my micro-service
my config service sees the new value but
my micro service does not it does not
know what happened I have to tell it to
refresh its configuration I can do this
a few ways the easiest is to trigger
what's called an actuator endpoint
spring boot has this idea of actuators
actuators are management endpoints for
things like environment variables and
for health checks and for all these
things that are contributed to the
application so for example health right
this tells me the health of the
application and so on you know but
there's another action at endpoint
called refresh like that and all I have
to do is I have to send a a empty HTTP
POST so curl - d HTTP localhost 80s are
8,000 forward slash refresh now I'm not
going to hit go yet okay we'll wait for
this to line up what I'm going to do is
I'm going to hit as soon as I hit go I'm
gonna hit enter
then I'm going to hit command tab and
then command are as fast as my aching
fingers will let me as fast as I can
okay 102 three go ah no well there we go
up come on and again and I
that was very unsatisfying use it very
fast but anyway so I'd refreshed the
configuration they didn't have to
restart the service you know this gives
me the ability to do things like feature
flags I can peek couple the deployment
of software from the release of software
another pattern that becomes very useful
in the distributed system is making it
easy for one system to find another
right so I want to be able to support
the service registration and discovery
this is very important in a distributed
system because you cannot have your
clients coupled to other systems IP so
I'm going to use the service registries
spring cloud makes it easy to work with
different service registries thanks to
the discovery client abstraction right I
happen to be a big fan of one particular
service registry called Eureka right
there are different service registries
out there that spring cloud supports
Apache zookeeper hashey core console
Eureka you know etc but I like Eureka
the most for two reasons first of all it
has been used by Netflix for a very long
time at very large scales not as not as
crazy as scale as the data coming off of
your certain devices here but still
pretty crazy right so that's part one
the other the other thing is that it's
super simple to setup and I'm a big fan
and I'm also very lazy so that helps a
lot so you Rica - service Yuriko service
application at naval Eureka server and
go okay so it'll come up on 87-61 come
on there we go so this is the cert this
is the service registry this is my
Eureka registry there's a few things to
notice first all very well done mouse
over
very well done we have people for that
that took a year anyway the other thing
is that we don't have any applications
here yet right there's no registration
so we need to teach our reservation
service to say hello I'm here if you
need me you know so we have to go back
to our bills and bring in spring cloud
starter Eureka here we go
okay that's the discovery client
abstraction implementation for Eureka
and then we just go up here we say at
naval discovery client very good so
enable discovery client and then that's
on the class pass and we just restart
okay I'll drink some water now once
that's up we want to build a client to
talk to it we need to talk to that
service through the registry instead of
using IP addresses or DNS DNS is an okay
choice and a cert in the distributed
system but it has limitations mostly
that clients cache the cache the results
of the DNS load balancer so you end up
defeating the load bouncer right you
want to be able to control the load
balancing decision on the client another
problem with DNS is that it requires
separate infrastructure that other teams
typically manage so as we move to a
micro services architecture we want to
build up control both how things get
routed in the system which is something
you do on the client and one build to
control the evolution of our service if
we change the DNS entry for a service
and that breaks another part of the team
another team in the organization then we
have to go slower in order to be able to
make sure that that doesn't happen right
so let's see we're going to build a
client we're going to use the rest
repository support will use actuator
we're going to use the random cue stream
processing support Zipkin for distribute
tracing his tricks of circuit breaker
Fame for simplified risk clients config
client your weakest support actuator
support we already got that right and
anything else anything else did you we
am I missing something obvious anything
at all read support maybe sorry thank
you yes ah son of a gun
mess feed that's so good okay so we're
going to go ahead and start this up I
think this will be enough for now who
knows we don't know what time we have so
um here we go
reservation we have to give her our
service a name so we'll say spring
application name equals reservation -
client and then we go to our code and we
participate in service registration and
discovery now what I want to do is want
to build a application that can talk to
my original service the service is the
reservation service this is not just a
client for the sake of building a client
though I'm building a special kind of
client called an edge service edge
services are the first door into your
system the first port of call if you
will for requests coming from the
outside world from your iPhones from
your Playstations from your real cooz
from your large Hedren super colliders
from your you know Xboxes whatever it is
all these things have IP addresses right
and so they have different security
requirements different protocols and
payloads and so on the edge service is
where you handle those kinds of
requirements you adapt outside requests
think about like netflix netflix has all
these different types of devices some
have limitations in the browser URL
parameters that they can accept some
have different protocol some different
security restrictions so instead of
changing every micro service they just
change the edge service they'll have a
iPhone edge service or a large header on
supercollider edge service or you know
Android edge service or something like
that or a Windows Phone for that one guy
right so we need to be able to adapt
here one thing I would love to do is to
just talk to my my downstream service
right to proxy the data and for this we
can use dual now Sewell is a Michael
proxy now it's a micro proxy from a
company called Netflix how many of you
have heard of Zul how many of you know
Zul dual is the monster from the
Ghostbusters movie anybody remember that
he's there he's the gatekeeper into the
underworld I love bass right the
gatekeeper to the demon world
he's the Gateway he is the edge served
now okay fine fine anyway what I want to
do is I wanna be able to talk to that
service so there's a lot of different
ways to talk that service I'm going to
just use a micro proxy micro proxies are
very convenient let me get rid of this
here there we go so I can't the easiest
way is to stay at enable dual proxy and
hit restart now the micro proxy is going
to
talk to the registry it's going to get
all the service IDs in the registry all
the routes that are available in a
registry like this one reservation
service it's on this URL here on this
service ID in this port but it's going
to programmatically talk to that and
it's going to set up routes for me that
I can use the reservation - service
forward slash reservation so this is the
edge service here is the actual service
on port 8000 actual edge actual edge
actual edge actual edge actual nope
actual edge actual edge actual edge
actual edge amazing so a couple things
you may be wondering first of all houses
edge service routing the request it's
got the ID in the URL of course that's a
clue we have one instance so yeah of
course it's using that one instance but
what if we add n or one hundred or
thousand or even just two it has to
choose it has to say I choose you like a
Pokemon and then route to that instance
right it does this on the client using
something called Netflix ribbon Netflix
ribbon is a client side load balancer it
provides different strategies for load
balancing the default of course is round
robin but now you can do other kinds of
load balancing strategies like when you
want to do a multi digit multi data
center kind of load balancing or if you
want to do rack aware load balancing or
if you want to do data locality or data
charting or if you want to do the the
kind of load balancing that that pins
are request with an OAuth token to a
particular node because that node is
streaming a video or something right
it's it's stateful you can do all these
strategies in the client that is a
that's already plugged in for you that
gets implemented for you automatically
you can override the load balancing
strategy using Java code you don't have
to change the router or the load answer
they have five right you don't have to
follow a request ticket for IT to update
that that particular route and do
something that it can't do anyway right
the other vendors other thing you may be
wondering is what about the URLs from
the perspective of my iPhone client or
my html5 browser this URL looks like it
was generated on this node even though
we know that it was generated on this
node
the proxy sends a request to the
original node with the URL the origin
URL so it looks like it was generated
there so the client does not know this
is a good approach I think the the micro
proxy giving us a lot of benefits but
sometimes I want to have my own
endpoints that have their own data so I
want to create an API adapter right so I
want to say class reservation names or
class reservation rest controller at a
reservation api adapter rest controller
because i am nothing if not confide
white so i will say at rest controller
and i'm gonna create an endpoint that
just returns the names right i'm not
going to i'm not gonna return all of the
data i want to return a client specific
view of the data right I wanna say
string names and I'm I'm not going to
return all of the hypermedia links I'll
just return the names Josh and Stefan
and and mark and so on all my gosh I'm
so sorry oh no it's not right he
wouldn't do that to me he's so nice I'm
Tommy oh okay I'm sorry haha
crisis averted don't worry okay so um
I've got this edge service I want to get
just the names right so I'm going to
create an endpoint here I could use the
rest template I could say to the rest
template let's make a call to that
service and the rest template would
certainly work but the rest template
doesn't know about our load-balancing it
doesn't know about ribbon right I could
create a custom load a rest template
like so I can say at load balance rift
template and return new rest template
and that would work as well but I don't
want to spend so much time writing
low-level HTTP code instead what I want
to do is I want to write a run a simple
client I don't want to spend all my time
writing h-2b code and messaging codes
for each other service that I want to
talk to different organizations have
different standards here some will say
oh well you know you can build a Java
client but you have to make sure that
the business logic lives in the service
itself not in the client others say oh
well you know if you're going to build
something at least be automatable
and repeatable that way there's no
business logic but you can still provide
the jar so that other people can use
that client instead of making every
other team write their own HTTP code and
messaging code so sane is a great
project from Netflix this is here sane
sane in English it means to pretend to
act like or act as so if you see an
animal in the forest like this right
it's pretending to be dead it's not
actually dead don't worry it's fine it's
just pretending because it wants you to
leave it alone
it's feigning dead very similar to the
way websphere Saenz utility it's not
actually useful it just it just pretends
to be dead right it's not it's not there
so we're going to use sane to build a
rest client and it's not actually rest
clients just an interface we're going to
say interface reservation reader and
we're gonna return a collection of
hypermedia
resources whose payload is of type
reservation now the question of course
is where does that entity the
reservation come from I could copy the
type from my implementation and put it
on the class path here but that would
couple my client to the implementation
of the service so in this case I prefer
to have a dpo a separate type right now
in order for this to work I need to say
that it's a sane client and it's going
to load balance it's requests to the
reservation service I'm also going to
make this a HTTP GET call that calls the
reservations endpoints so when somebody
calls when somebody injects this
interface of being implementing this
interface they can call that method and
it will call this service for them so
let's do this again private final
reservation reader and we need a
constructor naturally okay and here I'm
going to say return reservation read
read now what I want to do is I want to
get the content the collection of
hypermedia resources which has the links
in the payload I want to stream over it
I want to map from each reservation to a
reservation name and then I want to
collect the records into a list of
string like so easy right sure oh that's
nice
I'm a big fan of Java 8 so this is going
to work this will do fine in the happy
path if I have one or many instances of
service it will work but what happens if
I have zero instances no instances it's
going to blow up right it'll give us big
fat Java stack trace in my iphone it's
not nice it's no way to run a railroad
so we need to do better we need to
understand that in a high profile we
need to understand that distributed
systems will fail that's a fact it's not
a matter of when a matter if it's it's a
matter of when right so we need to build
a little bit of graceful degradation
here one way to do that is to use a
circuit breaker right there's a great
library also for Netflix called hystrix
so I'm going to I've got this on the
classpath join us so spring cloud
starter hystrix
there we are good so hystrix it's
already on the Kasbah nevermind
history I can enable this by saying at
enable circuit breaker there we go and
now I can say hystrix command fallback
method equals fall back right fall back
so what I'm going to do is I'm going to
say if there's an exception that is
thrown in this method then just call
this other method high-performing
websites do this kind of thing all the
time they'll you might go to a search
engine of shopping website in the search
engine is down and they'll say oh well
the search engine isn't working but here
are some machine learned recommendations
from across the web it's it's not
exactly what you wanted but it's better
than getting the equivalent of the
middle finger you know on the web page
basically right so that's nice we like
we like the graceful degradation so
let's see what happens localhost 99
reservation names
there's the names correctly spelled and
everything's fine because the service
exists now let's go kill our poor
service oh wow okay so now I make a call
fail look at that it gave me the empty
array list you see if I make enough
calls it's slow my goodness so slow but
if I go go go go go go go go go go go go
there we go see now each time very fast
right the circuit breaker is smart it
says I have seen that there are too many
exceptions and it moves the trailor
railroad tracks to the fallback it gives
the downstream service time to recover
we want to protect that downstream
service
the last thing that we should do is to
overwhelm it today luge it we all know
that if a website isn't working you
should refresh the browser a lot right
is that true it's not true for
distributed systems either so this helps
protects protect against that if you
have a cloud computing technology like
Cloud Foundry clouds render will start
it back up and make sure it's up and
running but you need to give it time to
recover now I've got an application and
this will eventually heal itself the
circuit breaker will be aware of the
heartbeat from the Yuriko registry the
registry will say I have seen the
service it's here it'll open the circuit
again and let traffic flow through what
I want to do now is to talk about how we
can observe the behavior of the system
it's a distributed system having
something that is robust and resilient
to failure is important for building a
cloud native system it is important to
be able to evolve the system quickly
it's also important to be able to take
advantage of distribution to scale out
but the fourth most important
characteristic of a distributed system
is observability I need to be able to
monitor the system and understand what
the system is doing by monitoring its
output the system is not supposed to be
a black box it's a bad idea if you have
one node but if you have just one
instance and one node a lot of things
become much easier if I have a null
pointer in the monolithic application
where is the null pointer not everybody
at one thank you it's in the monolith
you don't have to spend a lot of time
finding the buzz because there's only
one place it could be there but when you
move to a distribute system it's a
trainwreck right you've got a lot of
places where you can have problem so you
need to have visibility one way to get
visibility is to monitor that circuit
breaker right that circuit breaker is a
proxy for the other system that I'm
calling I cannot change other people I
cannot fix their terrible terrible
terrible life decisions I can't make
them use better technology to build more
robust systems some things are going to
be written in PHP that's just the fact I
can't I can't fix that there's nothing I
can do right but what I can do is make
sure that my system is robust when their
systems fail right I want to monitor
their system failure to protect my
system so
the hystrix dashboard gives us an
ability to monitor our circuit breakers
if the circuit is open then it's going
to go to the fallback and we can monitor
that so I'm going to say 1.44 Thank You
hist ryx dashboard hystrix dashboard
config client eureka discovery go okay
open this up oh my goodness we're almost
at a time so we say at naval history
dashboard at naval Discovery client
spring that application name equals
hystrix dashboard very good ok I'm going
to start this up and this will give us a
way to monitor the state of that circuit
breaker in the system we can monitor
mini circuit breakers but we've only got
one right now now the circuit breaker in
the code generates a server sent event
heartbeat stream it's on my edge service
on port 9999 district stream the stream
is infinite it goes on and on and on and
on and on and on forever and ever
and ever like the skies and the Seas and
the stars and the bugs in your code this
is infinite just forever and ever so
whatever you do and I cannot I cannot be
more I cannot underscore this enough
whatever you do whatever you do do not
curl this endpoint don't so what we're
going to do is Mar for that stream by
going to the hystrix dashboard here at
8010 pasting the URL into the dashboard
dialog there and hitting monitor now I'm
going to go to the edge service make
some requests is calling my reservation
service and I can see the moving average
of traffic 2835 etc etc etc so that
gives me visibility into the state of
that one circuit breaker if I kill the
reservation service this will go to open
I can see that now this is one way to
visualize the flow of data in the
distributed system the map in a
distributed system is not the terrain
the the actual experience of being in
Geneva and being at CERN is not the same
as looking at the Google map isn't it if
I mean if I'm in these places and I'm
walking around there's so much more to
see than looking at the map the same is
true for your distributed system the
architecture diagram is not the
distributed system you must monitor the
flow of data through the system itself
in production you cannot just
approximate it a good way to do that is
to use distributed tracing so there are
a lot of different ways to do this but
it's it's very painful you have to do it
yourself
what we want to do is to it's got a few
depends in there once you fast what we
want to do is want to be able to monitor
the flow of data from one node to
another as one as what as one message
goes from one node to another
I wanna be able to see that in one place
right I could use logging and channel my
output to elasticsearch but I would
still have to do a lot of archaeology
I'd have to look through my
find glass define things so let's see I
forgot a few things here zip Caen zip
kin - server ok close that I need a
spring cloud starter config and I need
spring cloud starter you wee Eureka ok
very good
zip gun service I'll say at enables zip
game server at enable discovery clients
and I'll start this up now what I'm
building is my I'm building a just I'm
building a Zipkin tracing server that
way I can visualize the flow of messages
through the system in order to make this
work I need to have the spring cloud
starter Zipkin client on the class cops
in my applications that's all right
so spring clouds starter Zipkin ok then
we are Senate should be it yeah okay so
we refresh the reservation service now
let's go to the reservation clients here
and we'll change it as well spring
clouds daughter Zipkin okay and when we
start this way as well
okay and started to fast go go go
okay fourteen
come on computers people are watching oh
that's the history dashboard because I
killed the screen okay so localhost 94
11 right that's where we did I forget to
name it Zipkin - service application of
properties that name equals Zipkin -
service so I can talk to the config
server we start again
oh I'm restarting all the things so
we're good well this is going to do is
as I make a request I'm going to publish
that request out-of-band to the Zipkin
server which is going to then monitor it
and analyze it that'll give you a chance
to visualize it visualize it in one
place
what's important is that I don't want to
visualize
every single request in my system I
would overwhelm my monitoring tool
Zipkin was created by Twitter Twitter
uses it to monitor the flow of messages
in their distributed systems they don't
monitor every single message they
monitor one out of every several million
they don't need to see more than that
right so I'll be ok go go districts
dashboards it can service good and great
ask at work come on I'm running way too
many poses use at this point come on
okay so you can see the clients are
working they want to talk to the
conserver ok looks legit let's do this
so localhost 94 11 ok there we go
there's our zip in server right now it
doesn't see any traffic so we need to go
to our end point here localhost
reservation names why we started the
edge service I've started the actual
reservation service separately right so
there's this it'll read register in a
second ok Oh No
this is running that's fine and the
client is always still starting up
registry localhost at4 761 there we go
then you should be happy this is
Antonio's fault let's see the client
needs to just go faster there's a 30
second heartbeat and I don't have time
to waste it at 30 seconds so we're gonna
go we start it quickly no don't ever do
the restart as right at the beginning of
the end of the talk I'm sorry about that
folks
so okay come on computer faster
reservation client is now participating
you can see there's going to participate
because there's this yellow output here
as it spins up come on
oh my goodness too many things running
okay
well I broke something oh well if I go
to LA I go there networking there we go
so as I make a request finally on the
client there we go I make these requests
on the client I can go to the Zipkin
server it says that there's a client and
a service click on one of those I can
hit find trace and it shows me the
waterfall graph of the request I've
flown through the system if I click on
this it shows me that I have one request
that took a total of two point four nine
milliseconds whatever I click on the
node I can see that the message entered
here and exited there here's the
specifics about the request itself I can
see the relative timing so requests as
well so I can see where it went when it
left where it arrived I can see any
context information about the request in
the service all right so what's that
awkward bit of a digression aside we've
looked today at how to build a system
that is easy to evolve very quickly with
spring boot we've looked at how to build
a system that benefits from dynamic
external configuration and twelve active
style configuration we looked at Service
registration discovery with the spring
cloud abstraction for discovery client
and using Eureka in particular we looked
at circuit breakers with the hystrix
circuit breaker we looked at a
declarative rest clients using sane we
looked at them observability with with
the Zipkin and the history dashboard
what we didn't look at could fill the
whole room
my goodness we we didn't look at how to
do distributed contracts right between
services to make sure that if I evolve
my API my clients don't break that's
called spring cloud contract we didn't
look at messaging based micro services
using spring cloud scream for example
with apache Kafka or rabbitmq instead of
using rest we didn't look at using data
flow and analytics with spring cloud
dataflow which builds on top of spring
cloud scream we didn't look at
automating your build pipeline to get a
continuous delivery pipeline on top of
Jenkins or concourse using spring cloud
pipelines we didn't look at a lot of
things we didn't look at single sign-on
with OAuth and spring cloud security
right we have a lot of things that we
could have looked at but I'm afraid
that'll have to do for another session
another time
jibber well normalcdf Avenue merci
beaucoup pour votre santÃ© young people
have the question is if an editor Pamela
Posey an enfant a of young Anglais
Melfi beaucoup thank you so much Cheers
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>