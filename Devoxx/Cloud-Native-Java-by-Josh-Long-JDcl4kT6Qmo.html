<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Cloud Native Java by Josh Long | Coder Coacher - Coaching Coders</title><meta content="Cloud Native Java by Josh Long - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Cloud Native Java by Josh Long</b></h2><h5 class="post__date">2016-11-10</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/JDcl4kT6Qmo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right good stuff here we go good
stuff so thank you everybody for coming
I appreciate that you could be anywhere
and we have a lot of great choices so
thank you very much for coming to my my
humble session today so we're going to
go through a lot of stuff today that's
that's my custom I'd like to go through
as much as possible and trust that
you'll be able to figure out the details
if you want by consulting that github
repository on the top there that's the
sort of code and it's also a three-day
lab where you'll find lots of sort of it
details and step-by-step exercises that
you can follow to them to understand
what we're going to look at here today
and there's also spring that I owe for
such guides will find all manner of
different guides topical 15 minute long
introductions to all things of spring
and spring boot and spring cloud and so
on I'm online so if you have questions
comments feedback whatever please don't
hesitate to reach out to me I'm on the
internet i'm happy to question so how
many of you are on twitter twitter good
stuff hot sauce well done so if you're
there find me there i'm happy to talk
happen answer questions i'm here for you
i would have an email email e email does
anybody have email email okay well i'm
there as well if you've got comments
questions feedback whatever again i'm
happy to engage um I wanted to just just
just just lay this out here I took a
poll and if I'm honest I didn't really
like the results but whatever so I'm
just going I want you to know that what
I'm trying to do in this talk because
I've already given i gave a talk last
year that covers some of what we're
going to talk about in this talk and i
was thinking how could I really how
could I you know there's some new stuff
and I want to show you some of the new
stuff of course but I can't afford to
skip to the new stuff without making
sure I cover the old stuff so I was
looking for ways to go faster to to cram
more in because if you've ever seen my
talks you know that I I go in a laksa
days alexic days ago sort of slow manner
and I don't cram a lot of stuff in it's
very sort of easy going right so this
time I was looking for ways to go a
little bit more a little bit quick more
quick you know and and I was going to
use Kotlin but that didn't happen so
what the heck
anyway a little bit about me my name is
Josh long I'm the spring developer
advocate on the spring team i'm an open
towards engineer and contributor and the
number one top ranks top ranked for
seven years number one contributor of
bugs but still number one number one
contributor of bugs to projects like
spring boot spring cloud spring negation
spring batch bond time leaf activity etc
etc etc I've also done opening or
training videos for example so the
lasing basis of which is called building
microservices with spring boot live
lessons it's by one by my friend the one
the only the amazing the inimitable Phil
web the co-founder of spring boot and
myself and then there's our cloud native
Java and that that book that book is a
is all about how to build applications
that survive and thrive in the cloud
very much like what we're going to talk
about today and for those of you are
wondering that that bird is a blue ear
to kingfisher it's a it's a bird that is
indigenous to the java island in
Indonesia it's a bird that is native to
Indonesia to the Java Island and now
bird do you see they they project
themselves through the air through the
clouds with the greatest of ease they
fly you see so this this is a a bird
that is native to Java that lives in the
clouds it's a cloud native Java bird
it's a bird that's nevermind it's fine
it'll it'll come it'll come it'll come
just give it time give it give it time
okay and I network at pivotal in at
pivotal we've got a lot of great open
towards stuff a lot of gate open source
software and we care very much about
very much about the open source software
by them if I'm honest the main reason
we're here the thing that we care about
the most is helping customers and
community members and organizations
deliver software quickly and safely to
production a lot of organizations
struggle with this and they wonder how
to capture that same sort of speed that
existing organizations have right the
web stars the unicorns on the internet
the the netflix is the uber is the
Airbnb etc these businesses and many
others besides our software companies
they may act like other businesses but
they are software companies through and
through
right and they deliver software in a
software time scale they go fast and
they realize that the first the first is
that is able to get to market is going
to win so the question is how can we as
you know how can we with our large
existing monolithic applications capture
that same agility and one way to do that
is to decompose your large applications
to smaller batches smaller batches upon
which a smaller group of people can can
work a small batch of work that can be
focused deployed tested and developed
and deployed into production by a small
group of people oh yeah right on a small
batch of work that makes it easier for
people to reason about what's going to
happen if you make a change to the code
base all right it's small batch of work
that can be deployed independent of
other parts of the team in the
organization this makes it much easier
for people to move within their own sort
of sort of a swim lane to be able to go
faster without having to have constant
meetings with other parts of the
organization so the question is how do
we do that and and we you know if you've
been paying attention you know that the
the answers to use what is called a
micro service right micro services are
small singly focused internally
consistent reusable bounded contexts
there there are parts of the application
that have been decomposed from the
larger application and that have been
that are optimized for small teams that
allows you as an organization to go
faster but when you move to
microservices you invite complexity and
that complexity is something that you
must address up front if you're going to
have any success at all in this
architecture there's a lot of a lot more
places where you can hurt yourself
basically when you move to the micro
services so in this talk we're going to
look at spring cloud as a way of sort of
mitigating a lot of these these are
concern so we're gonna go ahead and
build a new service today and we're
going to go up to start spring that I oh
here this is my not this again we're on
the same IP so every time I go to this
thing it makes me verify okay select all
the images with a house I don't wanna
this is happening we're doing this I'm
going to win did I win
no ah yeah I'm human whoo huh thank
goodness well so what I'm gonna do some
create a new service i'm going to call
the reservation service and this one
this service is going to use the dev
tools which is a nice feature in spring
boot to be able to reload services are
related reload applications during
development i'm going to use the web
support and spring boot i'll use the
rest repository support i'll use
actuator for operational concerns i'll
use the config client for centralized
configuration i'll use your week up for
service registration and discovery i'll
use a random q stream processing for you
know stream processing i'll use Zipkin
for distributed tracing i'm going to use
a JP I'm gonna use h2 first wrong use an
in-memory embedded sequel database and
because it's in memory and embedded it's
going to lose all of its data on every
restart so just going to lose its data
after every restart very similar in this
way to MongoDB it just loses data all
the time for no reason at all just all
the time just gone okay so so i'm going
to use h2 it's very web scale except
that only works in one node in one VM
and then we're going to use rest
repositories right and the rest
repository support will make it easy to
to to build a repository that is exposed
over the web and our repository in this
case we'll use jpa and then I think that
is that is enough for now web actuator
config you weak Zipkin dev tools could
do let's leave it there okay so what I'm
going to do is I'm going to build a
whoops I'm going to build a simple
service using this new project now how
many of you have had the pleasure of
using spring boot okay very good so I
won't linger too long I want Terry too
long in what spring bootie is but
suffice it to say it makes it easy to
stand up applications and to get results
quickly it is optimized for sort of
handling the non-functional requirements
and implied by moving two production so
for now I'm going to go ahead and
comment out this RabbitMQ thing but
we'll need that later but everything
else we'll leave it on the classpath and
what I'm going to do is I'm going to
build a a simple service here that
manages entity of type reservation and
again a reservation is just an object
that we're going to use I don't care
about the domain all that much I just
need something so we have something with
which to play for the balance of our
time together now this entity will have
a primary key a surrogate auto
incrementing ID right there right at
generated value and a tidy
and we'll create a constructor there
right we got a another constructor for
jpa and JP only right there's that
created two string method will create
some Gators there's this right will
signal that this is a JP entity by by
using that annotation and then that I
think we'll do we've got some Gators we
got a primary key you've got a
constructor we got a constructor for jpa
we need a repository now this is a
spring data repository and if you saw
all of our gear kiss earlier talk today
then you know that in a repository is
just an object that makes makes short
work of the of dealing with the
underlying persistence tier there you
know the reading writing and etc with
aniline persistence tier and I'm going
to want to be able to find reservations
but I want to be able to find
reservations by the the type of entity
by by their reservation name so i can
create custom finder methods like this
for example string RN and i want to
expose this repository as a REST API
right my repository handles things like
read/write update and delete and all
that stuff I don't have to implement the
interface bring that up with that for me
it'll give me an object and I can inject
that does all this stuff and much more
besides and so it's also in an enviable
position to handle my my rest api right
because it already knows how to do that
right so i'm going to go ahead and map
it as such i'll say by name and we'll
say at / m RN and now i want to save
some data of this type into the data
base right so i'm going to create a
command line runner and a command line
winner is an object in spring boot that
when it gets called when it when it's
perceived it will have its run method
invoked on application startup so it
makes it a sort of an enviable place to
put any kind of application
initialization and sort of anything that
lives outside of the traditional
request-response flow of the of the
application so i'm going to create some
records here right so stream of and Andy
I'm Josh nice to meet you Michelle okay
we've got Stefan that's a French one
with an accent which I don't have my
keyboard we've got all over Marius whose
talk you should see tomorrow that's six
we need a few more Donald know
just know it's been such a bad day do
you have to um yeah um sadness and
despair set in um Bob bobert okay so now
for each one of those names we're going
to write a record to the database like
so and then we're going to visit every
record in the database by just printing
it out with this find all method right
so find all for each system out print
line very good and there's my there's my
simple example right I've got some data
in the database if we start it up we
should have a rest api we should have
some sample data there and we should be
good to go so let's go ahead and start
it up and see what happens now what we
want to do in might when we move to a
distributed systems world is we want
bill to configure the behavior of the
application and if you know about spring
boot and you know that one way you can
configure the application is to to
specify configuration in this property
file called application type properties
which is in your source main resources
directory so for example my application
is now running on port 8080 ford /
reservations right so there's my rest
api it's hypermedia it's built using
spring hot TOS hot TOS hypermedia and
this is a short acronym it means
hypermedia as the engine of application
state it's a the idea that every rest
response has enough information the
response for the client to be able to
further manipulate that resource without
any sort of upfront or a priori
knowledge basically it promotes
self-describing services and these links
give you that information so keep in
mind later on that we're going to we're
actually using what is called a resource
envelope object try the resource object
that manages entities of type T in this
case reservation and the resource has
content which is your payload and it has
links which are the links about the
payload so later on we're going to turn
this JSON back into a resource envelope
object okay so there we go we've got our
we've got our REST API and we can do put
post get delayed all that kind of stuff
now I want to configure things and I can
do that in this in this property file I
can specify all different manner of
things i can say server port equals 80
10 for example
but if I want to change the
configuration I would have to recompile
the jar that's not really a very tenable
solution I don't want to keep my
configuration in the jar itself one
option would be to to externalize that
configuration to keep it for example
outside of the jar here and whoops may
have n minus T skip tests cuz yolo clean
install okay and then I could go here
and I could say I want to run this jar
this so called fat jar which has
everything I need to run it I can run
this jar by running java minus jar
reservation service that jar and then
just overriding certain properties I can
say server that port for example equals
80 10 right so there's that you know
that's the updated version that code and
it's going to work just as before
everything's going to be fine but it's
now in port 80 10 instead of the default
which is a which is 8080 right you can
see that here whoa so there's a DAT
right I want to override that default
and I can do that by using dash the
arguments that's one way to get the
result there it is on port 80 10 and i
can use environment variables to i could
say export server underscore port equals
80 30 for example and that would also
work but in my case this still falls
short of four different use cases what
if i want to centralize my configuration
what if i want to don't want to
duplicate my configuration from one node
to another t is the copying and pasting
things around what about if i have
secure information in the in the in the
property file right how do i how do I
sort how do i secure that not keep
unencrypted information at rest in a
property file on my file system for
example how do I support auditing and
journaling how do I see who changed what
and when and fessor to roll that
configuration back right and then
finally how do i change the
configuration while the service is
running for these for use cases i need
something a bit more powerful than just
having properties inside my jar and more
powerful than keeping my configuration
in a shell script that then is used to
parametrize the java command for example
or set the environment variables i could
have a directory full of configuration a
directory full of property files that
would certainly give me some of what i
want i could version control that
directory right but and that would solve
my centrality of my auditing requirement
but how do I sort of interpose the
access controller security in that model
right isn't that not not an easy way to
do that so I need something a little bit
more sophisticated I can use the spring
cloud config server the config server is
just that it's a REST API it's a micro
service that manages access to your
directory full of configuration your
directory full of configuration that's
version controlled using for example
subversion or get so I have in this talk
for you a very brand new tool that we've
got we just released called the spring
cloud CLI now the spring cloud CLI has
amazing amazing ascii art work I think
you'll agree and the ask at work is not
all it's very simple to so what this
does is you say spring cloud and then
you list the services that you want to
run right infrastructure common things
like the config server like you could
have you could say h2 or Kafka for
example all these are things that you
could run all that is already running in
my machine so I don't actually have to
go set it up though I could write you
could go to start that spring that I
Owen and build yourself a config server
so that's already running and I've got
it configured here to point to the
desktop config directory where and I've
got a bunch of property files so
localhost 8888 forward slash reservation
hyphen service for such default that's
the config server and in the end I can
fix er I can see that I've got to
property sources one called reservation
service type properties and another one
called application up properties so what
I want to do is I want to change my new
REST API the reservation service that we
just built and have it get its
configuration from this micro service
from this config server when it does
it's going to have access to this
property called server that port it'll
start up in port 8000 and they'll have
access to this to this message called
hello world so let's see if we can do
that it will say so let's let's connect
it right we've already got here spring
clouds start a config and that's gonna
that's the client the driver if you will
to talk to the config server all we need
to do now is to point it to the config
server so we say reservation hyphen
service and that's it that's the name of
the the config sir of the service by
which is going to identify itself and it
talks to the config server normally if
it was running on an on default port
you'd also have to tell it where to find
the config sir of itself like this but
it as it is running on the right
port I'll just leave it off okay so
there's that if that if that works I
should be able to inject that message
that hello world message class message
rest controller private final string
value and we'll create a constructor and
I'll inject the value as a parameter
into the constructor like so curly
bracket curly bracket message and at
getmapping message string read so all
I'm doing is I'm parroting the value
that I've injected here into the
constructor and I can imagine wanting to
change that later on so I've annotated
this beam with a tree fresh scope now
that done let's see I'm going to hit
command f 9 which is my compile thing
and I've got the dev tools on the
classpath so it auto it's going to
automatically just restart the spring
application context not the whole JVM
which means it's fairly fast right so
localhost 8000 now it's on port 8000
right that's our new endpoint not 80 80
and message there's our message hello
world that's a good message but it's not
really great you know we can do better
so we will I'm going to go to the config
the desktop here desktop config I'll
open up the reservation service type
properties I'm going to say hello dev ox
ve extra exclamation marks so as to
reinforce my credentials my authority on
reddit ok look good get commit minus a
minus M Yolo now when i change that
there it's immediately visible in the
config server but my micro service the
reservation service has no idea what
we've just done it doesn't see the
updated value so we can trigger a change
by calling another actuator in point now
if you know about spring boot you know
that actuators are things that surface
observable information or operational
information things like the metrics for
example or the health indicator right
these are things that are designed to
support visibility into the application
there's a new there's another end point
that is contributed by the spring cloud
config client called refresh which when
you send it an empty refreshed as an
empty post rather will refresh all
or recreate all beans in the application
context annotated with at refresh scope
it will recreate those beans anew in
situ so let's go ahead and line things
up here I'm going to go ahead and go to
localhost 8004 / message and I'm gonna
go ahead and hit go and as soon as I hit
go I'm going to go hit command tab to go
to my browser and then command are as
fast as my as my little arthritic
fingers are going to let me okay so here
we go one two three good so there we go
we've updated the configuration in the
rest controller immediately right we
supported feature flags live reloading
I've decoupled deployment of software
features in my application from the
release of that software I didn't have
to restart for example to see that
change so by using the config server and
using a version control directory I've
got auditing and journaling I've got the
config server it's an ideal place to
handle security I can use it to require
that clients have a certain
authentication for example and I can
also symmetrically encrypt and decrypt
values in the property files itself
another thing that I want to do in a
distributed system is is make it easy
for one service to find another you see
Oh in a distributed system services are
going to come and go as they need to
based on command a demand and capacity
and so we need to build our system in
such a way that if one service that it's
calling should fail everything still
works right I don't want to be coupled
to IPS for example at first blush this
might seem like a use case for DNS but
DNS has several limitations in a cloud
environment particularly in a dynamic
cloud environment where services come
and go first of all dns is best done
with caching but that is not a great
idea in a very dynamic environment where
that the result might be that you have a
stale reference a stale IP an IP that no
longer matches because it's no longer
there right that service may have been
decommissioned another problem with DNS
is that it's often used in conjunction
with load balancers and load balancers
are owned by somebody else right so it's
another piece of infrastructure that you
have to ask another team to control and
really the routing in your application
is saying that you should care about
it's part of your your business domain
it's part of your application imagine
your Netflix and you're you're you're
trying to route a request from the
outside world to a party
node a particular service and that
request has an OAuth token where is the
check box on your f5 load balancer that
says route this OAuth token to that
particular node there is no such thing
right it's not it's not a common sense
default but it's something you should be
able to control so what we want to do is
be able to control the routing decisions
in our application from the client
before the request has ever made not in
some sort of central dns server a load
bouncer so we can use a service registry
and a service registry is like a phone
book for the cloud there are many of
them out there there's a patchy
zookeeper there's hachey corp console
there's a TD there's a you know a
netflix Eureka need even a cloud
platform iCloud Finder can be used as a
service registry so these are all great
choices I happen to be a big fan of
Netflix Eureka for a few reasons first
of all it's super simple to set up in
that I've already got it running right
remember this and it's also um very very
good right it's been used at scale by
one of the largest websites on the
planet it's bulletproof so spring cloud
has a discovery client abstraction it's
a client interface to talk to these
different service registries and it's a
uniform interface so you don't have to
you can swap out one implementation for
another and use different registries if
you like so I'm going to go back to my
build here my reservation service and
I'm going to teach it to participate in
service registration discovery that
annotation is the same no matter which
implementation you use in my case I've
got spring cloud starter Eureka on the
classpath so now I'm going to go ahead
and hit command f nine and if we go to
the right port here eight seven six one
will see that I've got these three
things already registered but my
application is coming back to life here
come on compute oh come on oh
we'll see that it's coming back to life
and it's going to register itself there
in the registry now once it's available
it'll be available and it'll be
advertising itself and making itself
available for other clients before we
move on I want to draw attention to one
very important aspect of this of the
service registry very well done mouse
over this took a long time we have
people for that this took a year not
just a long time a year
it's so good anyway there's our service
reservation service there's one instance
of it right there it's on this IP this
service ID and this port it's available
now we could register 10 or 100 a
thousand right so let's go build a
client to talk to that we're going to
build a reservation client and this is
not any kind of client this is going to
be a an edge service so we're going to
use the dev tools we can use web support
rest repository support actuator we're
gonna use the config client Eureka
Zipkin hystrix the circuit breaker is
zul michael proxy anything else fain
because yeah Oh off because yeah all
right good so I'm going to hit generate
and what I want to do here is I want to
build an application that that manages
external concerns external client kind
of concerns right so in a typical
microservice system you're going to have
lots of different kinds of clients are
going to talk to your your system your
services and so we need to be able to
accommodate those clients in a single
place rather than retrofitting every
single micro service to be aware of
these other component so we're going to
say that we want to take advantage of
discovery client for example and one
kind of concern is how do I proxy
requests from the outside to my services
I could you know if I have an aged 25
browser client it's it's going to run in
and secure sandbox it can't make calls
to my downstream services right so what
I need to do is you know unless I add
access control headers to every single
order my microservices the best solution
is to proxy those requests through a
single node and then send them to the
downstream services instead I don't want
to have to add access control headers to
every single deployed microservice I'd
very very quickly end up in a situation
where I'm spending all my time changing
existing microservices just to
accommodate the introduction of an html5
client into the system and forget about
what we have to do for you know Android
and iPhone and your PlayStation your
Roku and your Tesla and your Smart TV
and all these other devices that have IP
addresses right in Singapore the roads
have IP addresses on this planet there
are human beings walking around with
organs that have IP addresses so
virtually anything can be a client and
rather than changing every single
microfiche to accommodate these new
clients you handle that in the edge so
let's talk about proxying right we can
do this very natural using the zoo micro
proxy right if we run this oops we don't
want to run it yet I mean comments out a
few things here
hold okay we don't want the OAuth stuff
right now because it'll secure
everything unless we tell it to and we
don't want rabbitmq just yet all they do
you need that though so spring cloud
starter rabbit okay good so I've got now
an application that's going to
automatically set up a proxy for us and
now the proxy to azul michael proxy i'm
sure you know is named 444 zool in the
first Ghostbusters movie this is zul now
zool is the guardian to the underworld
or the proxy see that would see what
they did there too it's based on netflix
and netflix does movies and that's a
movie and in their mind it's fine it'll
it'll come so so anyway zool is a micro
proxy and it takes you know in
conjunction with spring cloud in the
discovery client it's going to
automatically set up routes for us based
on the IDS of these services that are in
the registry so I can go to the
reservation client here on port 9999 and
I can go here and I can say reservation
hyphen service forward slash
reservations right and there's my my
proxied results right so this is the
actual proxy service here's the actual
service here on port 8000 whoops
localhost 8000 actual service edge
service actual edge actual edge actual
edge actual edge you see there's a few
things here that you you may be
wondering about first of all the URLs
these URLs are different depending on
who you ask right and that's because the
doubt when the proxy makes a request to
the downstream service it does it by
looking at the service ID in the URL in
the context and it makes a request to
the downstream service and it passes a
bunch of headers that tell the
downstream service what the origin URL
is the host the port the port the
protocol Central all that stuff is there
the other thing you may be wondering is
how does it make the request how does it
know to which node it shouldn't write
that request and it does that using
client side load balancing right it
right now we know there's one instance
of that service in the registry there
may be 10 or 100 or a thousand so
it has to pick it has to say I want a
particular node like like pokemon i
choose you right so it does this in the
client it has an object a strategy that
it uses to make that decision it's a
it's a strategy that you can override
it's just an object you can unit test
the load-balancing strategy you can
version control your load balancing
strategy right so you have now the
ability to do data center where load
balancing or load balancing that is
sensitive to an OAuth token or you can
do data sharding or data locality base
load balancing or whatever you want you
can say you know based on the Nasdaq or
something right you could load load
bouncer to a particular node so all that
is pluggable but we're using the default
implementation which is round robin so
that's that's certainly a good good
enough first start but sometimes you
want you want to synthesize a particular
view of the data for a particular client
right rather than just proxying the data
back and forth you want to create an
adapter API maybe you have a client that
needs a specific view of some of the
data and so we can do that as well so
we're going to say class reservation
adapter API rest controller because I am
nothing if that's succinct right so and
what I'm going to do is I'm going to
create an endpoint here it's just a rest
controller that lives on the edge
service and I'm going to create an
endpoint that returns a collection of
strings right so what we're going to do
is when return the strings from this
JSON data we call the downstream
reservation service using a rest call
and we're going to take the JSON we're
going to turn it back into a resource
envelope object and then unpack it and
just keep the the name Andy and Josh and
Michelle and so on we're going to keep
those names but we're going to discard
the surrounding sort of jason strata
keeping only the names now i could use
the rest template here the rest template
in spring is just a HTTP client it makes
dead simple to call other services but a
common thing that people struggle with
when they move to a distributed systems
world is you know they have to write all
this low-level sort of HTTP and
messaging code to communicate well there
is a way that you can get you can get
past that with rest there's a nice
library called fain how many of you know
fain so an English feign means to
pretend to act as right to pretend that
you're doing something so if you see an
animal for example laying in the forest
with its tongue hanging out and it's you
know it's just it's it's shaking a
little bit but you can see it's
closing its eyes it is pretending it's
dead it's feigning to be dead because it
doesn't want you to bother bother it
right it's fading death so that you'll
leave it alone in the same way that
websphere feigns utility it's not
actually utility but it pretends to be
right so what we want to do is what we
want to do is what we want to do is a
build a rest client that can call our
down tube service is quickly and
concisely as possible still using rests
so benefiting from the inherit benefits
of HTTP but without writing too much low
level code so i can do that here by
saying at naval fame client and we're
going to build a client interface here
reservation reader and in the reader i'm
going to describe a the kind of data I
want back I want data of type of
reservation right I want to call the
downstream service and turn it into a
reservation we'll talk about that in a
second here and then I want to call the
read I'm going to call it a read method
it could be called whatever but I get
you know you can call this a get
reservations or whatever you want right
it doesn't matter and I'm going to tell
fain that this is a Fame client by
annotating it accordingly and I'm going
to tell that i want it to to make an
HTTP call to a service and then to do
load balancing with ribbon or to an HTTP
URL in this case I'm going to use a
service similarly I need to tell it how
to make the request so I'm going to
annotate this i'm going to say request
mapping equals HTTP GET value equals
reservation so it's going to call the
downstream service it's going to call an
instance of this service from the
service registry it's going to pick one
it's going to make an HTTP GET call to
the reservations endpoints can take the
JSON and convert it into a collection of
hypermedia resources whose payloads of
type reservation now I could have copied
this Java type from the service
implementation but I don't want a couple
my client and my service to each other
so I've created a client-side dto a
client-side representation in a more
complex system you might look at things
like Google protocol buffers or or you
know some sort of schema so that it's
easy for clients to interoperate and
agree upon a common subset of the data
that they need in this case though I've
got just one field so we're probably
okay right there's that and there we go
so now i can rewrite this code i'm going
to say that whenever somebody makes an H
to be get call to forward slash names
for
/ reservations then they're going to
call this endpoint and we're going to
use our reservation reader here reader
and we're going to inject that reader in
the constructor or not come on and at
Auto wired it okay now I'll say this dot
r dot get the reservations dot get the
content which is the the links right
stream over it map from reservation to
reservation name I'm going to call the
reservation name on each method okay so
there we go there's our are updated
adapter API now if i call this API and
the downstream service isn't there if
this this this downstream service isn't
there what's going to happen it's going
to try and load balance right it's going
to call different services and it's
going to try and load balance and if
there are 0 instances in that service of
that service in the registry what's
going to happen it's going to blow
chunks right it's going to throw a big
fat exception our poor iphone users are
getting it a big fat Java stack trace in
their experience that's no way to run a
railroad my friends we can do better we
all know what happens if you divide by
zero right what is 0 / 0 wait for it
come on you can do this
it says LTE should I try with the actual
Siri on this thing what is 0 / 0 sorry
I'm having trouble no kidding imagine
that you have zero cookies and you split
them evenly among zero friends how many
cookies does each person get see it
doesn't make sense and Cookie Monster is
said that there are no cookies and you
are said that you have no friends so so
we want to avoid making cookie monster
sad okay don't don't lower bounce across
zero instances so what we need to do is
is to account for that very distinct
possibility of failure by degrading
gracefully that's a key tenet of a cloud
native system so we're going to build in
a a circuit breaker here i'm going to
create a fallback method that will just
return an empty array list right like
this fall back return new arraylist okay
and we'll say at hystrix command
callback method equals fall back okay
now i'm going to activate that circuit
breaker here i'll say a table circuit
breakers and we're going to run this now
this is very common in high performance
high performance websites they'll say oh
well you called this search engine but
the search engine isn't available here
are some machine learned recommendations
from across the web for example right
okay so that's the read use case and
we'll see that in action now but what
about the right use case what if I sent
to post to this service and I wanted to
write the data from the edge service to
the downstream reservation service what
I'm trying to do is to make sure that if
I write the data that it eventually gets
delivered I need to guarantee that it
gets delivered eventually and I think in
that in that phrasing we should find a
clue right we're going to use eventual
consistency to guarantee that that
delivery actually happens we can't rely
on rest I can't make a post to a service
that doesn't exist right so what I want
to do is use a basic messaging right I
can I own a store and for the right and
for this I can um I can use spring cloud
stream and the way spring cloud stream
is it works is that it
in a declaratively am as a matter of
convention lets you write to downstream
services that you've configured in the
configuration so you can wire together
different services using messaging
systems you can use apache Kafka or
RabbitMQ or or you know a google pub/sub
for example and by the way for more on
that you should see a talk by my friend
marius tomorrow morning and and
basically what what the way you use
spring clouds a stream is that you have
a binder in this case i'm going to bring
in the rabbonim cube binder here and
once that's on the classpath you then
described using a convention right using
interface conventions the the channels
that you want to have automatically
hydrated for you and these channels are
just named conduits their objects
through which messages pass and you can
use these this message channel object is
a spring framework ism it's the same API
that you use for web sockets as the same
API use in spring integration for
enterprise application integration in
this case this channel is like a Java
util queue when data gets put into it
it's going to appear on the other end of
that channel and then something is going
to take that message and deliver it to
random q where of course on the other
side something can then consume it so
we'll worry about how that wiring is
specified later but for now we just need
to tell spring to automatically bind or
to set up that binding for us now I've
only got one channel here because I've
only got one downstream service and I've
lazily called it output but you might
have multiple you might have products
for orders or fulfillment or whatever so
there's this and now what i can do is i
can inject that that channel here i can
inject the channel and then just you
know suppose I had a message channel
here in like that i could say send i can
send a message but i don't want to do
that again i want to be able to benefit
from declarative sort of interface based
kind of programming so i will create a
messaging gateway so we can't use fain
here feign doesn't make a lot of sense
for RabbitMQ and apache cough gun and
google pub/sub but it does make a lot of
sense but but rather spring negations
components can and the messaging gateway
support does give us the same effect as
fain right so here's how that looks we
say interface interface reservation
writer void right string RN l 0 RN and
we say at gateway request channel equals
outputs this is the channel that we
created in our configuration there i'm
going to say messaging gateway okay so
there's our interface gateway our
channel or rather a messaging gateway
that's going to write whenever somebody
calls this method it'll send the data on
the previously constructed channel and
now we can write our code a little bit
simpler we can say at reservation writer
w and we'll integrate that here we say
reservation writer w this w equals W
okay Oh wha now we say this dot W dot
write equals R that get reservation name
and we can restart now on the on the
other side when you do the same thing in
Reverse after all we need to take the
data and then write it to the database
right so we're going to say spring cod
start a stream random q we're going to
bring that in there as well and I've got
RabbitMQ it's a message queue it's
running on my local machine and then I'm
going to do the same thing in reverse so
I'll say at enable binding and I need to
create another interface to describe the
incoming messages i'll say service
channels I'll say input subscribe herbal
channel input okay and service channels
that class okay and on this side I can
just create another component I can just
say here's a component that will listen
and process incoming reservations so
I'll say I've got a component called
reservation processor and I'll say on
new reservation please do something with
the request okay thanks okay and the
payload in this case is of type string
so I can just let spring a cloud stream
automatically look at the incoming
incoming message and it will Marshall it
back and forth based on the content type
and the channel I'm listening to is
called input and when the message comes
in I'm going to write it to the data
database using my JP repository that I
have on the on the service on their very
first service that we created so this
dot reservation repository
save equals new reservation are nf1 ah
ok so there's our service and we've got
the client up and running and now we
should be able to send data so let's try
it we're going to say minus H content
hyphen type colon application hyphen
jason HTTP localhost 9999 4 /
reservations and the data are going to
send is a few of my favorite doctors
okay so we'll send a reservation a JSON
structure with a reservation name for
dr. Subramanyam okay move what better
there you go i sent that one and now
localhost reservation names there's dr.
super money right so this is the edge
service i'm reading the data but the
data was written to the downstream
service in the database if i send dr.
sire etc right so i'm now using
messaging to connect these systems i've
gotten in the configuration for they can
for the bindings I've got here the on
the client on the consumer side I've
said that if the message is if there is
no downstream service available to
process the message as soon as one
starts up it's going to retro actively
consume all the messages that are there
this is also a very useful feature with
oh sorry this is a very small feature
what this does it says only one message
consumer will get any one given message
so by default is published subscriber
broadcast but in this case we get to you
no one to one okay so that's a good way
to build a service that is resilient in
the case of failure for both read and
write all this time I've looked at you
know how to build a service that is a
robust in the face of service outages
and topology changes it's very important
to be able to observe what is happening
in a distributed system so there's a few
ways to do this for example this system
is these systems are all instrumented
with something called Zipkin right
spring card starter Zipkin zipkin is a
distributed distributed tracing server
from twit
we are lucky enough to have on the
spring pod team contributes from both
Twitter and from netflix who contribute
to spring cloud as well as others right
and so Zipkin works very nicely with
spring cloud you just have to have it on
the classpath and it's automatically
I've got it running on the side here
remember we have our spring cloud shell
here it's running the Zipkin server it's
running on the side it's automatically
collecting all of the traces that I've
got going through my system so i can
click on this i click on fine trace and
then i see down here that I've got
different traces and these are all you
know about a minute ago for example
here's the here's the the the total
request took 32.6 milliseconds the
timings are as follows the message
originated the reservation client going
the reservation names in point the names
method the reservations in point then it
left the client going to the service and
I can see it was processed here at this
timing sort of in the flow right so I
now have the ability to visualize the
sort of interaction between services in
the system right this is very good for
understanding sort of the interplay
between services in a distributed system
another place where that can be very
useful is that circuit breaker right I
showed you that circuit breaker what
that circuit breaker does is if this if
the downstream service isn't there we'll
see it return the empty array list
monitoring that service can be very
useful because I can use that circuit
breaker to call other services that may
not be available if they're not
available I still want to be able to be
able to do something useful e but I
cannot change my I cannot change their
systems I cannot add my monitoring
agents to their system so i can use the
circuit breaker as sort of a proxy for
monitoring their systems and i can say i
can monitor their systems using a
circuit breaker dashboard right which
relies upon this stream now the stream
is a service send event heartbeat stream
that's being broadcast on the edge
service it's infinite right so it goes
on and on and on and on forever and ever
and ever it has no end like the skies
and the oceans and the bugs in your code
just infinite just forever and ever so
whatever you do don't and I cannot
underscore this enough do not do not
curl that endpoint
so we're going to go to this history x
dashboard here and it's going to paste
in that URL will hit monitor and i'll go
to hear i'll say make some requests on
the left and you can see the moving
average trending ever upwards on the
right we can see that it says 24 you
know 35 etc if i were to go kill the
downstream service the circuit breaker
would open and would go to the fall back
and we'd see that eventually it would
just stick to the fall back basically it
would divert the train tracks so to
speak it would present prevent us from
day losing the service that's trying to
come back online and we'd see that
reflected here it's a stroke it is open
so these are very useful now we've
talked about building a services robust
in the face of service outages and
topology changes we've looked at how to
build a service that benefits from the
elasticity of a cloud environment we've
looked at how to observe it in the last
15 minutes here we're going to go for
gold i want to talk about that messaging
based microservice that messaging based
microservice benefits by the sort of
commodity transport between services
we're using RabbitMQ to send data back
and forth we don't have to worry about
how that's done it's done by spring
cloud stream and if you understand that
the value of that if under said the
benefits of that then you can see that
this is very similar to sort of the
pipes and filters moderate model in the
typical unix command line right pipe
standard in standard out I don't care
what the payload is right the payload is
is as long as the payload is meaningful
for the command line utility in question
then I don't care right because they can
still talk as long as I can speak
standard didn't stand it out or in this
case rabbitmq in RabbitMQ out or patchy
Kafka in Apache coffee out so if we
understand that then we understand that
there's a there's a possibility to build
complex solutions out of micro services
that are composed using messaging and we
have to support that kind of composition
a technology called spring cloud
dataflow so what I'm going to do is I'm
going to build a data flow server okay
I'll say data flow service data flow
server config Eureka hit generate and
now data flow is a service it's a REST
API and it manages it state in a
database in this case it's going to use
the default which is the h2 right so I'm
going to say spring application name
equals data flow hyphen service
and I will point this to a different
version of the dataflow server the new
one that's not quite released that's why
we're not using the one inside of the
spring cloud CLI import this and we're
going to say at enable data flow server
and we're going to run this now that's
going to start on port 93 93 and it's
got a REST API you can interact with the
rest api a few different ways there is a
spring cloud shell that you can use a
CLI but i prefer to use the the API the
the service itself so 9393 for dashboard
it whoops dash board there we are and
what I have here are the ability to
import modules that are built using
spring cloud stream so I'm going to
build I'm going to bring in some of the
Lego bricks some of the existing modules
that are provided for us I'm going to
use the rabbitmq based ones i'm going to
say bring that in here and now that i've
done that i can go back to streams here
rather to apps i can see all these
different components that will talk to
each other that do interesting things
for me and i can build solutions based
on them so let's say I wanted to Marge
our directory and then for each for a
file that appears in that directory I
want to take each line and then send a
line to that rabbitmq destination we're
saying gets delivered to the reservation
service which then writes it into the
database I can now create a stream by
composing complex bits or singly focus
bits I can build a stream that uses a
file file source right which is a thing
that produces messages I can then
transform the data from that file source
using a transform component and i'm
going to send the data to a destination
the spring cloud stream reservations
destination so let's connect these
things together we're going to say
there's that and there's this and you
know we could do this the manual way up
here or you could click on the gear icon
here and we could say for example that
the mode that we want to look at it uses
lines we want to monitor the users jay
long desktop in directory and we want to
look for files at start with you know or
n with dot txt okay so we're going to
hit OK
and then for the transformer i'm going
to say whenever a message gets sent when
it whenever a line is sent i'm going to
uppercase the line and then i want to
send that result to this destination to
the rabbit acute destination so let's go
ahead and create that stream and i'll
call this files to reservations right
i'm going to go ahead and deploy that
stream and it's going to go ahead and
deploy the stream across as three
different java processes running in my
local machine but there are other data
flow deployers that work on Cloud
Foundry and apache missiles and yarn and
kuba natives and whatever right so you
can you can mix and match and so on you
can deploy you can orchestrate across
different runtimes so run time stream
it's deployed so now if we go to our
desktop here desktop in and i'm going to
open up the atom txt file so we're going
to say Josh well say Dave Phil Spencer
marcin there we go so I'm going to save
these names here I'll say in debt or you
know hide up txt save that and now if we
go to our endpoint here we can see
there's Dave Phil Spencer Marcin so
we're able to pull together complex
solutions using messaging based
microservice primitives now for as in
the last 10 minutes here roughly we're
going to look at securing our services
because we've we've done very little so
far I want to make sure we also have a
you know when we talk about production
where these services things should be
secure I've got an edge service that's
responding to requests you can see I'm
just I'm calling this edge service
unprotected and in a micro services
world in a distributed systems world
it's very common to have lots of
different kinds of clients clients that
have different permissions and
authorizations and scopes right so I
don't want to just use usernames and
passwords if I just use using museums
and passwords I would have no idea about
the device on which the request is being
made i would only understand who is
making the request not how they're
making the request and i need that extra
information in a modern world because my
html5 browser for example is
intrinsically less secure than then for
example your iphone you know an app to
point on the air on the app store that
sign and compiled and and deploy it into
the into the firmware for example
the operating system rather so we want
to be able to coordinate ease things off
and treat them separately similarly it's
a bad idea for users to pass around
usernames and passwords right if
somebody steals the password then you
have to reset the password for all the
other services that rely on that so
instead you can use what it's called an
OAuth token the way o off works is that
it's a protocol for describing users
first of all it doesn't actually
describe users it describes it delegates
to a identity provider of some sort of
an alpha authentic authentication
service and then it provides the ability
to manage tokens for the authenticated
user so instead of me going to facebook
and then you know I'm sure you've seen
this when you go to another website and
it says do you want to log in this
website with Facebook you click the
button and redirects you to facebook com
it says do you approve of this website
of spamming your friends your family
your loved ones mercilessly an endless
until they hate you and you say yeah do
it absolutely and then it redirects back
to the actual third party service when
it does that it passes back a token to
that third party service that third
party service never has your username
and password so if it does something
malicious you can go to facebook com and
revoke it we can do the same thing so
what we're going to do is we're going to
build an OAuth authorization server
first of all this is a standard API Oh
auth when use h2 and JPA and they're
going to use the config client and
Eureka ok I'm going to build a simple
server that has two requirements we need
to teach our authorization server about
the users and that can be anything you
can integrate anything that spring
security supports will work but as we
have very little time we're just going
to build a simple spring security based
identity provider that talks to a
database based on jpa okay so we're
going to create a jpa entity here called
an account that's going to be a sort of
stand-in for our our username and
password system and I'm going to have a
username field like this and a password
field and a boolean called active and
aaid a private long ID that will signal
as an ID by saying ID and at generated
value okay good and now we need some
getters there's this we need another
constructor we need more constructors
for JP and JP
alone okay to string there's this except
for the password good now we want to be
able to read and write and manipulate
that instance so we're gonna create a
repository as usual so we'll say account
repository extends JP a repository JP a
repository managing entities of type
account whose primary keys of type long
and we're going to have to teach spring
security about this account world that
we've just created so we don't create an
implementation I'm going to adapt spring
securities it would adapt that JP entity
in that domain to the spring security
world by creating what's called a user
details service so i'm going to say
account user details service implements
user details service and this is just a
contract that is very very very
straightforward i think it's when when
spring security has asked to
authenticate a user by a user name it's
going to call this method and your job
is to give it a implementation of that
user details contract and we're going to
do so using our repository here right so
let's go ahead and inject this here and
then we'll create a finder method here
that will return an account if it's
available otherwise just an optional at
empty right so fine by user name string
username and there we go now our job in
this contract and this endpoint is to
say account repository at find by
username username if if it's they're
going to map its I'm going to will do
that in a second we'll do that in a
second but if it's not there we need to
throw an exception right we're not
supposed to return null you're supposed
to return a user name not found
exception like that okay so we're going
to say new user and that's a concrete
implementation the user details contract
and then we're going to say get username
account get password i'm going to say
account is active so this it's going to
ask you for questions all that can be
all which can be answered in terms of is
the account active then we need to
describe the authorities for this user
i'm just going to card code some users
some authorities like this role is a
user or the users are other an admin and
a regular user so there's my very simple
user detail service i'm going to create
some sample users right
sample account clr it's going to
implement the command line runner same
thing as before and we're going to go
ahead and create some some accounts here
we're going to say private final account
repository create a constructor and
inject that result in here and now i'm
going to go ahead and create some some
users and passwords so j long and spring
desire cloud p web butthese our
usernames and passwords i'm going to map
them from X to X splits right like so
oops and then we're going to visit for
each one for each tuple we're going to
save a record in the database equals a
new account i'm going to say tuple of 0
tuple of one and true because
everybody's account is an admin and a
user you're lucky good stuff now this is
a this is the basic spring security
stuff the last thing we need to do is to
integrate spring security Oh auth now
spring security oauth requires an
authorization server or just say oh off
config i'm going to extend authorization
server configure adapter and we need to
implement two of these three call these
are empty no op methods but we have to
implement two of them not this one and
what we want to do in this in this
authorization can authorize ation server
config is tell spring security can
spring security Oh auth first of all
about what we just described in spring
security right we need to tell it how to
delegate authentication in this case
just do so by using the the spring
security that we did stuff that we just
set up right they use me musi details in
and use the details service so i'm going
to tell it to delegate to that existing
spring security infrastructure by
creating an authentication manager and
i'll tell to inject that here and i'll
say that endpoint authentication manager
equals this authentication manager and
then finally i'll describe a client in
this case i'll just use an in-memory
database of clients but a lot of
websites have portals like you know
developer at facebook.com/ whatever we
can arbitrarily we can register
arbitrary developer clients you know
client client application so the scope
in this K is going to be open ID
and the granted of the author's grant
types will be password this is the kind
of flow I want to support so there we go
the the final thing we need to do in
order for this to work is we need to
create what's called a token info
endpoint right so this is non-standard
otherwise otherwise we would have it
already but it's not standard it because
of course it changes from one surface to
another so if you're using Facebook
you'll get the facebook friend graph
information right if you're using get up
you're using you'll get a you know
github information for example right so
this is different form one service to
another so we have to just return we
just have to create our own in my
configuration server I've got it
pointing i'm going to point all the
other micro services to this endpoint so
they're going to get a a they're going
to get a request that has a token in it
and they're going to wonder what to do
with that token and we're going to say
call this authorization server pass the
token to the authorization server which
is getting then going to translate it
into a principle which we then return to
the client to the reservation services
as adjacent structure which it then can
use to understand or ascertain whether
this user should be allowed to proceed
right so let's go ahead and start this
up and meanwhile we'll go ahead and lock
down our R is our edge service right
we're going to go lock down our edge
service by going here and bringing in
spring flower arturo oauth2 and we have
to do a fair amount of code to get this
to work ready at an able resource server
okay run so that's going to do is it's
going to protect our resource our
endpoint our end point it's going to use
the configuration that can fix server to
call the authorization server that we've
already got so here's this son of a gun
I'll take some water since we're what
where this this one okay I'm saying this
dot I'm dereferencing it I'm
dereferencing the current object okay
thank you though so let's open up the
browser plug-in here to generate a token
right we're going to generate a token we
should see that if I call the office
server using this this rest in point
this call i'm using i'm going to use the
browser plugin if it load ever i'm gonna
use the browser plugin to send a valid
request to the auth server running on
port 91 91 to get a token let's see if
that works there it is there's my access
token we can use that now to call that
rest service the edge service that we've
just created so we can say curl HTTP
localhost 9999 4 / reservations for such
names let's prove it doesn't work
unauthorized right now we can go here we
can say minus H authorization colon
bearer paste good there we are so now
I've protected my edge service using
OAuth tokens I built a system that is
robust enough to do the right thing in
failure fail gracefully for both reads
and writes I've benefited from the
elasticity of a cloud environment I've
done throw in a fairly quick amount of
time with great ascii art work to show
for it as well and you know we've also
looked at how to build messaging
pipelines or stream based pipelines
using spring cloud dataflow now i hope
you enjoyed some of what we looked at
here today i know that i went uh you
know not as fast as we should have but
maybe faster than maybe a you're
expecting so i want to invite you again
to to consult this URL here this is this
URL at the top there that guy that that
workshop is a three-day lab that i do
that has step-by-step exercises
introducing everything we just talked
about and much more so i hope you'll
check that out also spring that i owe
guides for the sort of topical 15 minute
long introductions to all this kind of
stuff i'm going to be doing a book
signing pretty soon i think i'm in like
10 minutes downstairs in the books book
area also the spring bath is up next i
hope you like this i certainly liked it
i'm wearing as
t-shirt and spring underwear of course I
liked it but that said you don't have to
take my word for it right there are
small mom-and-pop shops out there like
Netflix like Alibaba like Baidu like
ticketmaster like betfair they're using
spring boot spring cloud and cloud
foundry or you know some permutations of
those things in production so I'll
happily take questions if you have them
thank you so much cheers</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>