<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Cloud Native Java with Josh Long | Coder Coacher - Coaching Coders</title><meta content="Cloud Native Java with Josh Long - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Devoxx/">Devoxx</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Cloud Native Java with Josh Long</b></h2><h5 class="post__date">2017-04-18</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/cX7_I58NiAI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right he is one of my heroes amazing
you know the one the only in the middle
my friend Patrick current I think he's
leaving that I scared him don't need
okay yeah oh wow all right uh let's see
can you all see that screen if you can't
you should come closer we're gonna go
through a lot of code I want you to be
able to see that uh oh yeah let me see
that it's pretty there's a way to turn
off the lights or something I was a
deluded screen yes not okay um sorry
about that we're starting a little late
because yeah we had to set up and we ran
the last talker ran a little long which
is fine it was a little off schedule
today so um alright ever thank you very
much for coming I appreciate you coming
here and being here I know that you have
a lot of places you could be right now
there are some amazing talks by some
much better presenter so I'm grateful
for any audience I can get we're gonna
go through a lot of code today I love
code I believe that if we're gonna talk
about code you might as well show code
instead of slides about code so as a
result I tend to do well code so I
encourage you for your own edification
for your own reference to to note that
github repository there
get up calm jaw strong cloud native
workshop where you'll find a three-day
workshop with exercises oh my god with
exercises that you can follow along at
your own at your own pace later on if
you have questions comments feedback
whatever I'm happy to hear from you I
want to help right so what about Twitter
how many of you are on Twitter Twitter's
2017 Twitter anybody
okay well find me there I'm happy to
talk I'm habitat into questions happy to
engage what about email email email
e-mail anybody okay well if you're there
don't hesitate to find me there as well
that's distinctly less valuable for the
audience for the for you know it's just
you and me so nobody else gets to
benefit from that particular thread but
I'm happy to talk here as well anything
I can do to help so there's that a
little bit about me my name is Josh long
I'm the spring developer advocate on the
spring team I'm the
I'm a open source engineer and
contributor working a lot of different
open source projects not the least of
which are spring boots and spring cloud
and spring negation and spring batch and
Vaadin and time leaf and an activity and
and so on I'm I am for those different
projects for the time that I'm
committing in the period in which I've
been committing I have and have held the
dubious distinction of being the number
one top-ranked most widely recognized
contributor of bugs but still number one
number one contributor of bugs to those
projects listed there right more bugs
per commit than any other developer on
those teams that's that's all I got
really so so there's that I'm I'm also a
book author I've been working on books
and training videos I do whatever I can
to help spread the word so for example
I've just finished the I've just wrapped
up the second edition with my friend
Phil Webb the amazing the inimitable the
co-founder of spring boot Phil Webb the
second edition of our building micro
services the spring boot live lessons
training video and right now I'm
wrapping up literally as we speak I mean
the thing that was on my screen before I
sat down here was the final pages final
chapters of cloud native Java book about
how to build applications that survive
and thrive in the cloud at scale in
terms of spring boot spring cloud and
and Cloud Foundry now that bird and I
can seat your eyes I can see the
curiosity welling up that bird for those
of you are wondering is a blue eared
Kingfisher it's a bird that is
indigenous to the Indonesian Java Island
it's as we had say in English native to
the Java Islands now bird you see birds
fly often through the clouds so it's a
cloud native java bird it's a bird
that's native to Java that flies in the
clouds it's a cloud native Java and
they're mine
it's fine it'll come give it time give
it time so there's that and i and i work
at pivotal how many of you know pivotal
we're a small company with big dreams
and a whole lot of heart what we're
trying to do is to help people build
applications and move them quickly and
safely from concept all the way through
to production right from through the
workflow from product
through user experience to developers to
testers to administrators and then often
to production we have a lot of good
open-source software at pivotal but make
no mistake that is not the reason that
we are here it's not that raise on debt
all right what we care about is helping
people move quickly and safely to
production we see that a lot of
organizations struggle with this they
understand that they need to be able to
go faster they understand that they have
to capture that agility but they don't
know how all right no problem they
understand that they need to go faster
but they don't know how they look around
they see it in the ecosystem a lot of
different very successful companies
right we don't need to look too far for
supporting evidence of this what is
right now the largest taxi company in
the world today uber what is the largest
video rental services company in the
world today what is today the largest
hotel brand in the world
Airbnb right these organizations and
many others besides are not actually
taxi companies or video rental service
companies or hotel brands they are
software companies they deliver release
iterate and evolve in terms of software
timelines like software companies when
they need to change they change the
software this helps them go faster it
helps them deliver value to the customer
faster they are able to do so at a much
faster pace in their competition there's
other things involved but by and large
the excetera here is the difference is
the addition of software this is not a
new idea either how many of you have
ever heard the amazing book the inmates
are running the insane asylum the
inmates are running the insane asylum
it's a it's a book that has many great
takeaways not the least of which is that
if you add software to any existing
business any business at all you end up
with a software company you take taxis
plus software you get a software company
you take hotels plus software you get a
software company write software and
delivery of software is how you add
value to modern businesses so the
question is how do we take existing
Apple organizations that have existing
applications that were written by a lot
of people in a in a different era
ten years ago of 20 years ago software
that predates the era of cloud computing
and the economics of cloud computing how
do we take that software and move it and
these more accelerated faster time lines
people struggle with this because having
existing software is not necessarily a
bad thing it just means that you've been
lucky enough to survive to thrive
perhaps
taking an existing application and
reworking it to be better to be a better
partisan participant in this new era and
this in this new architecture isn't a
isn't a bad problem but it's a problem
right you do have to get over that
obstacle so a lot of organizations look
for ways to take their large existing
unbroken applications there are
monolithic applications and to decompose
them into smaller pieces they turn to
for example dr. Eric Evans who in his
great tome domain-driven design talks
about the idea of a bounded context a
bounded context is a part of the domain
model that stands unto itself internally
consistent in and reusable it's
something that can be extracted from the
larger whole in a way that doesn't
depend on any other part of the of the
system a bounded context if you can
identify them is a natural boundary for
what we're trying to do we're trying to
take these large applications and break
them apart into smaller pieces if we can
find these bounded context parts of the
domain that are reusable and independent
and that's a nice place to make the cut
the benefit of doing this is that if we
have a smaller batch of work that we
have to move through the workflow from
product management to user experience to
developers to testers to administrators
if we have a smaller batch of work then
we have less things to think about when
we're writing code the surface area of
the code is smaller we have less to
worry about when we do tests because
there's not nearly so many repercussions
if you make a change here it doesn't
necessarily invalidate testing results
over there it's easier to reason about
from a product management feature we
know exactly what that'll change and how
it'll affect people that are consuming
it it's easier to operationalize if you
want to scale it out you just have to
scale that one piece not the whole
application this gives gives you the
ability to optimize a whole production
pipeline all the way to production but
the question is what will I face if I
attempt this architecture if I attempt
this approach you're gonna run headlong
into a few problems when you move this
way the first big problem is how quickly
can you as an organization stand up a
new production worthy service from soup
to nuts zero to sixty right and
including it handling things like load
balancing DNS heartbeat detection
failover security and the application
itself observability and monitoring how
quickly can you do all that the second
requirement they're gonna run headlong
into is once i've optimized that once
i've found a way to stand up new
applications at our production worthy
and
addressed all the nonfluent requirements
in that now that I've done that I've got
lots of small services deployed on the
network deployed across the cluster
communicating with each other over
network partitions once I've done that
now I've invited the complexity of
building a distributed system into my
life and if there's anything indeed one
thing upon which I'm sure we can all
agree my friends and said building a
distributed system is hard so you need
to be able to address that complexity
for that first pane for that first
requirement the requirement that you'll
be able to build production worthy
services I wholeheartedly and full
throated ly recommend both spring boot
as a way of building production grade
applications and services and Cloud
Foundry is a weight of operational
operationalizing them but for the second
requirement you can't just it's not just
business as usual it's not just about
automating and optimizing what we
already did you have to rethink your
approach to building services because
these things are not going to talk to
each other in a way that didn't
necessarily have as many fail failure
modes as they did before so for that
we're gonna get spring cloud today so
quick show of hands how many of you've
ever seen spring boot okay so I won't
spend too long on spring boot but I do
want to make sure we're on the same page
so I'm gonna build a new application
because I need to okay so we're gonna
build a new application here to start
that spring that i/o which is not found
that's awkward there redeploying it
right when I'm giving my talk well
literally we'll just sit here pardon me
talk amongst yourselves I'll give you a
topic Rhode Island is neither Road nor
an island there we go
so we're gonna build a new application
that here it starts out spring day oh
this is my second favorite place on the
internet my first favorite place of
course is production
I love production you should love
production you should go to production
is early and often as you can bring the
kids bring the family it's a happiest
place on earth it's better than
Disneyland production is great if you're
not already there you should be there
but if you aren't already there you can
begin your journey here it started that
spring that I oh if you want for
inspiration in the early morning before
a cup of tea or coffee start that spring
that I oh if you suffer from indigestion
after a long night of alcohol abuse in
PHP start that spring today oh and if
your children are restless and can't
sleep start that spring that I Oh
what we're gonna do is want to build a
new application I don't want to spend
too long on the domain of the
application itself so I'll build
something called a reservation service
which is going to manage entities of
type reservation in order to do that I'm
going to use spring support for building
web applications I'll use the h2 which
is an in-memory embedded sequel database
because it's in memory and because it's
in memory and embedded it's gonna lose
all of its state after every single
restart very similar in this regard I
think to to MongoDB it just loses the
data all the time for no reason at all
right just randomly loses data so very
similar we're gonna use JPA the java
persistence api
i'll use the the config client for
centralized configuration will use
eureka for service registration and
discovery we're gonna use if in for
distribute tracing we're gonna use
actuator for operational concerns and I
think that'll do now oh I also want
Lombok they job a compiler annotation
processor right now if I wanted to I
could switch to the full version
whereupon I'll find a veritable ocean of
of check boxes things that I could elect
to add some application but for my
purposes it suffices to leave things as
they are I encourage you Alvar to pursue
this list at your own leisure later on
also I think I would do well to add dev
tools which allows me to restart the
application live without having to
recompile and all that stuff right so
there's that now I want to just take a
brief moment to talk about this these
the three dropdowns at the bottom of the
other pager dropdowns typically imply
choice and yes here you have a choice
you have a choice at your discretion of
the language that you want to use on the
JVM what language you'd like it would
you like to use any language on the JVM
that supports annotations and objects
will work just fine so Scala
ceylon java groovy Kotlin they're all
fine candidates right use them as you
will but here my friends here we have
the appearance of choice where really
there is no choice the first question is
what language version of the JVM would
you like to use in 2017 as both 1.6 and
1.7 or end-of-life not supported no
longer generally available except for
security updates and even then only at
the mercy of those select a few that
care this is the only real choice the
other question we have is the choice of
packaging a lot of people get confused
about this they don't know when and
where to choose which so I'll do my
level head best to explain here now if
by some crazy terrifying accident of
physics some freak fluke of physics you
find yourself stuck in the distant
distant distant past far far far beyond
modern help then choose dot wire but if
you're here with me in 2017 then choose
dot jar this is a big part of my
overarching guiding personal philosophy
of make jar not warren again you have
choices you have options you should do
what works for you
all right so anyway I'm gonna leave that
as is I've got a new project I mean I
hit generate and open this up in my IDE
oops try that again open this up in my
IDE while taking a sip of water
now I'm not going to spend too long in
the application itself so if I said to
say it's gonna be a JP based application
that persists an entity into a database
so let's see here we have a reservation
service okay and I'm gonna create an
entity class reservation okay at entity
private long ID at ID at generated value
okay private string reservation name
good now I need a constructor here just
for that one field otherwise I'm gonna
let Lombok do all the heavy lifting I'll
make it a data class I'll make it a I'll
give a to string method here I'll give
it a all args constructor and a no orgs
constructor and tidy for GPA right
there's that which I don't even need
that there we go that's fine so I've got
that I've got it I want to be able to
manipulate instances of this entity so
I'll create a repository spring data
repository I'll say that this is a
repository that extends JP a repository
and are many plate instances of type
reservation whose primary keys of type
of long and I want to save instances of
this data into the database so I'm gonna
make my bean implement command line
runner and the command line writer is a
callback interface that spring will call
when the application starts up and it
gives me a nice opportunity to to do
some setup anything that happens that
has to happen in the beginning of the
application before work has begun so I'm
gonna write some of the names to the
database my name is Josh Britt nice to
meet you all very much thanks very much
for coming I'm joined of course by my
buddy Christian and Patrick and James
and Oh Martin of course there we go so
that's that's one two three four that's
five I need another name miss what's
your name how do you spell it like this
very good thank you that's six that's a
nice round symmetrical number and so for
each name whoops for each name that's a
write a record into the database here
and then confirm that everything is is
as it should be by logging out the the
results okay now there we go there's my
application I want to
I want to have a REST API so I'm going
to use spring data rest as well I'm
gonna use spring data rest which I don't
think I have in a class path here so
let's go ahead and add that and spring
that a rest will make it easy for me to
export my repository as a rest endpoint
hypermedia resting points a repository
rest resource thank you I want to create
a custom finder method perhaps right so
reservation find by reservation name
string RN and I want to export this as
an endpoint as well so I'll say path by
name at per am RN very good and with
that we can now run the application and
we should be able to see that everything
is working as expected
hopefully with enough time to spare
there we are look at that we happy six
all on the console it worked
of course it worked there was a demo
what were you expecting this is always
going to work instead what I really want
to talk to you about was this this is
the a Scout rookie in spring boot this a
scout look took a long time to get right
we have people on the spring team that
are doctors PhDs people in their
previous lives worked in nuclear physics
star stuff they're very sore left our
bodies and the heavens above us were
their daily bread and butter so it makes
me very happy to imagine that someday
somewhere somehow there's a get up issue
that said damn it we need good a scout
rook I think you'll agree they did a
great job now it's at this point that
I'd like to take a brief moment to just
talk about what I consider to be a very
serious very glaring deficiency in the
intellij jet branch product for while I
am a fan I think this was particularly
short-sighted and a big problem and I
think we should do something about it
what the hell why is that there that
checkbox once selected disables the the
banner of work that's a dumb feature and
I think we should do something to fix it
so I did all of us do when confronted
with adversity and challenge and and
fear I went on the internet and I cried
loudly and I was given a message of hope
for my friend Yancy Brown who's a
software developer by passion and
IntelliJ IDEA JetBrains and he responded
thusly
well we're gonna make him don't worry my
friends were gonna make IntelliJ great
again so anyway I've got an application
it's got a rest in point let's confirm
as much localhost:8080 forward slash
reservations voila there's our there's
our data it's a hypermedia
right so these endpoints gave me the
records that we expect as well but they
also give us links and these links help
to decouple the client from the producer
of the of the API right so the client is
expecting to find endpoints and defined
data at those endpoints but in order to
for it to further navigate the endpoints
it just needs to follow these links
these links tell it where it can go the
client is no longer coupled to the URL
structure itself they can follow the
hypermedia links these are an
implementation of a design pattern
called Hadi OS or a hypermedia as the
engine of application state it's the
idea that every rest resource no matter
that every rest resource should have
information enough in the response for
the client so that it doesn't need to
know up front or a priori about the rest
structure about the API structure
this helps decouple clients from
services like I say it also provides a
navigable sort of path and lights the
path ahead for the service it helps you
convey state you might have a link that
shows you an option to check out when
it's a viable time to check out a
shopping cart for example but you
wouldn't otherwise that client doesn't
try and call an end point in the wrong
flow and the right and the wrong order
because there's no you know there's no
link in prompting it to do so so these
hypermedia endpoints give us a lot of
value and they're very useful in
particular and when we build distributed
systems because when you move to this
distributed systems world everything is
an API and very few developers and I
mean very few developers write
documentation and absolutely none zero
categorically zero read it so you need
to make it as humane as possible for
developers to consume api's this helps
you get that so I haven't I have a hyper
media API I can deep link into it I can
go to 1 2 3 etc right I have all these
records I can also go to the search
endpoint here and shows me that there's
a finder endpoint called find by
reservation name and I can send a
request in to that and I'll look for my
buddy James there and there we go right
so make a request found all the results
I'm getting all that for free by using
spring data rest right I also have in
the application I have the the metrics I
have the actuary the spring mood
actuator the actuator is a is a
framework that requires that we
lock the default security so management
security enabled equals false command f9
I'm not I'm not even gonna rebuild
anything I'll just use dev tools right
so there we go so there's the
application there's the updated
endpoints these endpoints surface
information about the application
themselves again what I want from a
cognitive system is the ability to
observe the system ID only able to see
what's happening in the system and who
better to articulate the state of that
system than the service itself then the
services themselves I can add a Java
agent to the same process to the same
node alongside the Java process or
underneath the Java as a Java agent but
I would have only a very limited opaque
perspective of the application itself
instead the actuator endpoints provide
that information in the service
themselves in a standardized way this
was inspired by the Google Borgman
monitoring approach they stipulate that
all services and all workloads no matter
what their nature whether their HTTP or
batch or machine learning artificial
intelligence or web or whatever all
surface standards HTTP endpoints in a
way that centralized monitoring
infrastructure can then Corral and use
to form that ever-important dashboard
experience so this gives us a lot of
power but are we done yet right I mean
are we done is this enough surely not
you know there's things that we're gonna
run into in this application that are
gonna be a problem only when we start to
scale that and add more instances the
first of which of course is security I
just showed you that you can change
certain things about the application by
sending properties and application up
properties I can even you know I can
even override some of the defaults by
going to the command line here whoops CD
downloads reservation service I may even
- dee skipped test because Yolo clean
install what did i do there
those guys did something to my build oh
we are not allowing that sr3 they just
updated this and my whole build is gonna
be gooey great let's see
okay very good so there's that I can
even run the application I can override
the configuration thusly I can say
target reservation service TR minus D
server dot port for example equals
eighty ten and in so doing I'm
overriding the property that I would
have otherwise specified here the heck
maven re-import thank you
I could have specified the property here
I could have said server dot port equals
eighty ten here but I would have had to
recompile the jar that's a non-starter I
don't want to have to recompile the jar
as I move the application from one
environment to another oh this is gonna
be a problem
it's an sr5 start that spree and I'll
set a thing
yeah it's a thing let's try that now
seems happy okay
looks like for my entire talk I'm gonna
have to remember to update these puppy
files up to this property - Kevin sr5
all right so that's up and running
that's certainly a start but it's not
good enough right if I want to confront
a configure application and override the
configuration I I wanted to solve a few
different problems that this isn't gonna
solve oh come on
me having a clean install right okay
there we are so why don't you I wanna
solve a few different things that this
isn't gonna solve first of all how do i
centralize a configuration so that I can
reference the same configuration from
one node to another all right how do I
version control the configuration so
that if something changes I can audit
the change and then roll it back if
necessary what if I want to live reload
the configuration without without
restarting the process and what about
security what if I have passwords or
locators or cringe holes and things like
that laying around in the file system I
don't want that laying around
unencrypted right for all these use
cases and more while I like while what
I've just shown you is a is a good start
it's not nearly enough we need to do a
bit better and so what I want to do is I
want to stand up a config service to
manage access to that configuration that
config service will solve the centrality
issue because all services will talk to
the config server to draw their
configuration it'll also solve the
auditing requirement because that
directory that it's going to use to
store the actual repository of
configuration will be based on get or
subversion it can help solve the
security issue because now I've got a
central place to interpose security
requirements all configuration must go
to the config server which in turn can
be secured and communication from the
config server to the repository of the
configuration to get repository or the
subversion repository can in turn also
be secured so M sr5 ok
and we'll say can fix this application
and all I'm gonna do to make this work
is I'm going to say at enable config
server and I'm going to configure the I
want to tell it to run import 87 SR 88
88 and I want to tell it where to find
the directory full of configuration so
I'll tell it to find the directory home
Desktop config and now that
configuration is a it's just a directory
full of configuration I'm going to store
here on the on the desktop I'm gonna
clone it to my desktop here for such
config and that done I can restart this
and it's going to point to that
configuration and it's going to stand up
a REST API that other applications can
then talk to to draw their configuration
suppose I am a micro service that
identifies itself as the reservation -
service that's the service that we just
built we'll name it in a second but
imagine I'm connecting to the config
server and I want to draw my
configuration I can see here that there
are two property sources one from
reservation service that property
which has all the properties specific to
the service and another from application
of properties that has generic fall
through sort of global properties that
are available to everybody right if
there is a conflict between the more
specifically named property file and the
generic fault to backup file the more
specifically named file will override
the default one so server deport here
would have more precedents and would
override the default value specified
here that's by design
right now if I do everything correctly
if I revisit our reservation service and
I point it to the config server it
should start up in point 8000 according
to this and it should have access to
this message hello world so let's go
ahead and see that in action here we've
got on the class path we should have the
config client right there's that so now
we can just create an endpoint rest
controller class message rest controller
private final string value and what I
want to do is I'm gonna inject that
message that we just looked at the end
of that the message key from the config
server and I can do so in the same way I
would any environment variable or sour
any property inside the spring
environment abstraction I'm gonna create
an endpoint here called message and I'll
just return the value now then value as
designed as specified is is you know
good enough but I can imagine at one
point I'm gonna want to reload that
configuration so I'll annotate this
being with add refresh scope if
everything goes to plan no I'm not
interested in that thanks if everything
goes to plan then that should spin up on
port 8000 we should be able to see the
message under four slash message so
localhost 8,000 miles further is ATS our
first endpoint okay what is going on
oh I need to tell this the config client
where to find the config server so
there's a few things it needs it needs
to know the name spring application name
that's the reservation - service and it
optionally needs to know where they can
fix or of itself is located you can do
that with localhost you know spring oh
sorry you can say spring cloud configure
I equals this now it's worth noting that
that is the default value so this will
work even if I omit that if the server
is not located that host import of
course that won't work but for our
purposes and for the balance of this
talk I may omit that particular property
and that's okay
I only show this to you because I'm a
giver and I care you should add it
yourself silently when you see it or not
see it later on okay here we go come on
computer
we don't have time good there's our end
point there's the message in point you
can see it says hello world things are
there let's go to the config directory
here Desktop config we'll open up the
file here reservation service up
properties and I'm gonna change this
message to say hello DevOps us extra
exclamation marks this is to reinforce
my credentials and authority on reddit
okay so there's that I'm gonna say git
commit - hey - em Yolo and my property
file now having been changed is
immediately visible in the config server
itself but my config client has no idea
what's just happened I need to tell it
to redraw its configuration to refresh
its configuration I can do so one of two
ways I can use the spring cut event bus
and use something like Apache Kafka or
abdomen to federate changes across also
connected members of the cluster or I
can just trigger another actuator in
point in this case one called refresh
which I'll do so here localhost 8004
slash refresh that'll send an empty HT
to be post to the web server but before
I hit go let's set the stage I'm gonna
hit enter and then I'm gonna hit command
tab which on a Mac means go to another
application then I may hit command R
which means refresh the browser and then
I'm gonna see hopefully the result in
the browser but this is you know gonna
go fast and my fingers are arthritic and
poor so here we go ready one do three
yeah there we are not bad we change the
configuration without having to restart
the application or even recompile
anything right
beam was recreated in situ I can see the
configuration mediately this can fix
server gives us allowed benefits as I
say it's central so now we have the
centrality problem all of our micro
services can draw from the same well of
configuration I don't have to tease the
copy and paste things from one property
file to another I have the budget to
interpose security both from the
configuration client to the config
server as well as from the config server
to the source you know get or subversion
repository of configuration I have the
ability to do live reloading thanks to
this the Refresh scope and the spring
cloud config client and I had the ready
to support auditing and journaling and
things too
thanks to subversion time now this is
one thing that becomes very useful in a
distributed system is is centralized
configuration another thing that becomes
valuable is service registration and
discovery for UC and a dynamic cloud
environment things are gonna come and go
based on demand and capacity as things
come to the scene and disappear I want
my services to be decoupled from the
location and the awareness of where
those things are I don't want them to
call a service that doesn't exist for
example just because we've scaled down
and thrown off a few node so what I'm
gonna do is I'm going to introduce a
little bit of indirection between my
client and my service and the IP of my
service and at first blush this might
seem like a use case for DNS but DNS is
actually a really poor fit for what
we're trying to do what I want to do is
I want to call another service and I
want to be able to make the decision
about how to route to that service on
the client and the reason is because
client because routing is itself a
business logic decision as often is not
sure you're having to load balancer can
do things like DNS or do things like
round-robin load balancing but what
about more sophisticated uses what if
you have a notion of a session affinity
or sticky sessions but you're not using
one of the well-known well recognized
types of sessions like an HTTP session
what if you using an OAuth token and I
want to pin a request from it all off
token or to a jot jadibooti token to a
particular node
what do you interpose that logic that
business logic in the router there's no
there's no checkbox and your average
common at five load balancer that says
act like Netflix right so you need to
add that logic somewhere that's up to
you
routing is a client-side concerned
especially for inter-service
communication the other thing is that
DNS has a lot of limitations that we
don't it's not it's not like they can't
be fixed it's just that they're not
really present they're not really front
of mind when we're dealing with them so
for example DNS in order for it to scale
requires that the clients
to resolve entries fair enough that's a
natural and very useful assumption for
the wide web but for interest service
communication which thing in which case
things are gonna come and go based on a
lot of sort of parameters that we can't
necessarily control having cashed
records is a bad idea it means I can
potentially call stale node something I
want to avoid I can get around this of
course by having a time to live value of
zero but that affects all that expects
the life cycle of all those that are
using that same DNS server
another problem is DNS you know you can
also you can also solve the caching
issue for specific clients right but you
need to you need to know where to do
that the jdk caches DNS so if you're
using a DNS load balancer you end up
eventually defeating the load bouncer
right if you call a DNS load bounce when
you get the IP back the first IP address
is the one that that javac line is gonna
keep on using you end up defeating the
load bound thing you're trying to get in
the first place again you want to there
are ways to get around this by changing
things in the JDK and the bow and the
battles of the JDK but it's just not
really a good idea unless you know all
the places where that's gonna happen and
if you do make a call to a node that
doesn't exist you may end up with a
timeout right you may end up with a man
of the situation a situation where
you're blocking waiting for a response
that will never come hopefully you've
all done the right thing you've all read
and internalized and applied Michael
Nygaard amazing book release it and
you've specified aggressive client-side
timeout for everything you've all done
that right for all the code in the JDK
that uses anywhere anything in the Dom
but that net packages everywhere you're
sure no pop quiz what's the default
timeout for for example java.net euro
connection it's zero right that means
it'll wait indeterminately for a reply
but that may never come so it's better
not it's better to be in a situation
where you can ask the question is that
service their DNS answer the question
where does that service live it can't
tell you if anybody's home right so what
we need is a way to ask that question
tell me if that service is out there and
if I should bother calling it I'd much
rather find out before I make the call
then after and I end up blocking so for
this we're gonna use a service registry
then spring cloud has an abstraction the
Spring Cod discovery client abstraction
that makes it dead
before you to interrupt with lots of
different service registries out there
there are a lot of great choices there's
Apache zookeeper this hash eco console
there's Cod found itself supports
Service registration discovery there's a
you know at CDE there's now there's also
Netflix Eureka and I happen to be a big
fan of Netflix Eureka for a couple of
reasons first of all it's super simple
to set up and I'm nothing if not very
lazy and second of all it happens to be
it happens to have been used at scale by
one the largest companies on the planet
so we know it works
right so we're gonna say Eureka service
so ryuko server I'm gonna use a config
client we'll hit generate and I'm gonna
open this up
oh that's the reservation service
complaining about not being able to find
a piece of infrastructure so in order
for this to work I need to change the
build again Camden sr5 maven rien port
okay and we need to specify the same
things as we did before this is a rika
service so we'll say that and that
should do now if everything goes to plan
that'll spin up on port 80 761 and we
can use that to now discover our service
artist good service that we need to
retrofit to talk to the registry to
register itself with the registry we
need only one thing to make that happen
we need to opt into the service registry
to the discovery client abstraction in
spring cloud so we say add enabled
discovery client and we start and it'll
automatically talk to the registry on
port 87-61 so let's see if that works
here we go a few things to notice first
of all no applications yet nothing there
and second of all very well done mouse
overs
that took a year
we have people for that anyway there's
our application there's our service it's
there waiting for us
there's one instance of the service
there's it's the on this IP this service
ID in this port it's available for now
it's been advertised it's available for
consumption from a client that's what
I'm gonna do we're gonna build a a
special kind of client called an edge
service in order to do that I'm gonna
use the springs web support the config
client your weakest support ship can
support Thane for distributed or for
declarative rest clients actuator for
operational concerns rest repository
support and Lombok okay and dev tools so
we'll head generate and this open this
up and again I have to change the build
okay Camden sr5 may even be important I
would be changing and even if I wasn't
concerned about the stability that
particularly I'd be changing it just
because I don't want to download all the
maven dependencies right now
so at enable discovery client spring
application name equals reservation -
client ok and this is an edge service
and edge service is an ideal place to
handle any kinds of clients specific
concerns by clients I mean things like
your iPhone your Android or your your
PlayStation or whatever right so I want
to handle things like security payload
and protocol translation and
transformation at the edge surface
rather than having to change every
single micro service in my system so as
requests come in from the outside world
they go to the edge service and there
they get transformed and secured and
enriched and processed and then sent
down to the actual Micra service in
question that can handle them one thing
it's common to do is to just proxy
requests and html5 client for example
may want to talk to downstream services
but it doesn't have unfettered access to
those services and I could given I can
give them that unfettered access by
adding access control headers to every
single micro service but that would be a
bad idea would put me a situation where
I am having to change every single micro
service just to accommodate the
introduction of a new html5 client
instead let's just proxy the request
through this this edge service and I can
do that pretty simply by using the zoo
micro proxy right so there's that if I
if I run this this will give me a bunch
of endpoints named for the registered
services in the service registry mapped
to the localhost 9999 for slash you know
service ID so localhost reservation -
service
for such reservations there we are
there's the edge service this is the
actual service here actual service
actual service edge service actual edge
actual edge actual edge actual edge
actual edge actual edge actual edge
actually anything you notice it's
different first of all the URL is a
little different right the service ID is
in there in the context of the
application request that helps the load
bound the dual proxy figure out where to
route the service request to how does it
know which instance to use well it uses
something called client-side load
balancing that is to say it picks from
the from the client code in the in the
proxy itself it picks all the different
service instances that are in the
registry and it says I want to find one
and it uses whatever algorithm we give
it by default the algorithm it uses load
is round-robin load balancing but you
can plug in other strategies including
Ana strategy that is aware for example
of a of an OAuth token or something like
that right or data locality or data
center away or load balancing or data
sharding or whatever you need right you
can do that here the other thing you may
notice is that the urls are different
right the URL from the actual service
here versus the the proxied request
that's because the proxy is sending a
request that has an Origin URL in the
header so that is showing up in the
client okay so that's certainly one
thing that's certainly one way to solve
the problem sometimes clients want a
specialized view of the downstream data
that they don't want they don't want the
data just on you know unprocessed I want
to get a synthesized view maybe you want
to merge data from different endpoints
or they want to you know transform the
results or do something like that so in
this case you can create an API adapter
right so I'm gonna say API or say
reservations API adapter risk controller
two L's and I'm going to call this a
risk controller and I'm gonna map this
controller to four slash reservations
and I'll create an endpoint here get
mapping forward slash names and all I'm
gonna do in this endpoint is I'm gonna
return a collection of names just the
names not the whole surrounding JSON
envelope right the whole this is called
a resource on
object this is implemented by or
provided by spring ha gos which we
talked about earlier right
spring adios has this idea of a resource
envelope object that has a payload of
type T in this case a payload of type
reservations which in turn has content
and links right so I want to take that
JSON and turn it back into a collection
of hypermedia
resources I could use the rest template
right we all know about the we probably
know about the rest template right the
rest template is a an HTTP client for
calling other services I could do that
but it doesn't know about our load
balancer it doesn't know about ribbon
and I can teach it about that by saying
at load bounced and that would certainly
give me what I want but this is a little
low-level what I want is to call that
downstream service and to not waste too
much time you know
ferrying bits and bytes and it should be
headers and status codes around I want
to get the benefits of local of of HTTP
but I don't want to have to spend too
much time writing that code so what I'm
gonna do is I'm gonna use fain fain is a
library from Netflix that makes it dead
simple to create declarative rest
clients right I have feign on a class
path here feign in English means to
pretend or to act as so if you see an
animal a dead animal in there and the
forest or a force that looks like it's
dead its tongue is hanging out like that
it's not actually dead it's pretending
to be dead it's feigning death so that
you'll leave it alone right it wants you
to move on it's dead but it's pretending
the beta it's feigning death and the
same way that WebSphere feigned utility
it's not actually useful it's just
pretending to be right so we want to
create a faint line that can talk to our
downstream services but I don't want to
spend all that time writing the rest
code so I'll create a vein interface
here
vein client reservation - service ok and
I'm going to okay say resources of
reservation and I'm gonna read the data
now the reservation type here doesn't
exist on the class path I need to create
that class here like so reservation
string reservation name and I'll make
this a Lombok type there we are okay now
I'm gonna say that I want to make a
ninja to be get called to the
reservations endpoint whenever somebody
makes a call on this method when I'm
sorry invokes that method I can inject
that here I can say private final
reservation reader are and checked it
into the
structure and then down here I can say
which return our thoughts read that get
content that stream dot map and I'm
gonna take the results and unpack them
into a collection of lists or to a
collection of names right so there we
are there's my reworked code and that
would certainly get us part of the way
there that would be what I want right
that's got much cleaner than then using
the low-level rest template okay is that
enough am I handling all the use cases
probably not provably not right I've
ignored robustness here I want to make
sure that if this fails if they if I try
and make a call to a downstream service
that has no instances that I want to be
able to degrade gracefully and load
bounced to another node so or to
failover to something in you know as a
fallback so I'm gonna use a circuit
breaker here I'm gonna specify a
fallback method so that if something
should go wrong it'll call the fallback
method right I turn new or a list okay
there we are there's my simpler fallback
method in order to make this work I need
to activate support for circuit breakers
okay
now the final thing that I'm going to
care about do I have this on the class
path already yes I do
so let's go ahead and see this in action
I've got now an application that'll load
balance requests across you know the
different registered instances in the
registry if there are zero instances
it'll fall back to the circuit breaker
which will then call the empty ArrayList
and return something this is very common
in a high-performance websites they'll
do they'll say oh well you called this
endpoint but you know the service is
down right now here's some machine
learned maybe instead of getting a
search result to get a set of machine
learned agents from across the web right
that's a useful performance tactic in a
high scalability system so I've got my
names here if I kill my downstream
service here
it'll circuit break I get an empty array
list alright and if I do that enough
it'll stop trying to even call the
service see it's slow right now but now
it's fast it goes directly to the
downstream service that's because it's
trying to it's trying it's it's sorry it
goes directly to the fallback it doesn't
bother calling the downstream service
because it knows that service doesn't
exist so that circuit breaker by the way
is a great place to introduce monitoring
and observability so we talked about
earlier right I want to be able to see
the flow of data in
system in between nodes I can't change
other people's code I can't make them
write better code I can't make them use
spring I can't make them use Cloud
Foundry to build or robust services but
if I monitor the flow of data from mic
my services to their code services I can
at least understand whether their
services are working or not I can't add
my monitoring infrastructure and agents
to their code bases so that circuit
breaker has to have stand in if you will
as a proxy for monitoring their code
right I can at least understand what's
happening that way so here we are what
I'm going to do is I'm going to build a
dashboard to monitor the circuit breaker
my application so hystrix dashboard and
enable discovery client enable hystrix
dashboard open up this property file
spring application name hystrix
dashboard ok and there we are
meanwhile this has healed itself or will
have healed itself if I where's my
application there's up this eventually
well there you go so the service
eventually reconnects it registers of
the registry the registry sends out a
heartbeat event the other connected
nodes get that hard to be event and they
invalidate their cache and we connect to
the registry to draw their services so
this work did healed itself if you have
a cloud platform like Cloud Foundry then
it'll automatically restart the service
for you so you don't have to do that you
can sleep easily knowing that the
platform is where is wearing the pager
for you now that dashboard is here
important 8010 hystrix that HTML and
it's expecting a heartbeat event stream
so a stream that'll tell us the status
of that circuit breaker and we can get
that from here localhost 9999 4 /
hystrix 4 South Stream one thing that I
should underscore is that this endpoint
is endless it has no end it is infinite
and without end it goes on and on and on
and on and on forever and ever and ever
and ever and whatever you do my friends
whatever you do and I and I cannot
underscore this enough do not do not
curl this endpoint so grab that endpoint
there paste this into the URL hit
monitor and as I make requests on the
left you can see the moving average is
trending ever upwards on the right we
can see that data is moving through the
circuit breaker just find the green
circles green if I
kill the reservation service again this
would turn an ominous color of red and
this would say open write the circuit
would be open traffic would not be
allowed to proceed now this is one way
to get visibility and distributed system
in other is to use distributed tracing
and that's a very good idea if you can
control the nodes in the system so what
I'm going to do is I'm going to build a
Zipkin server that talks to the config
line it uses discovery support Zipkin
stream okay
and my Zipkin server is based on the
twitter open source project called
Zipkin Twitter tip again is a way of
tracing or visualizing rather trace
information if you can intercept every
message that enters or exits your system
be it the be it via the the zoo or micro
proxy or the the rest template or Apache
Kafka RabbitMQ or the Mike the spring a
museum points or the spring data
endpoints or anything else if you can
trace every single endpoint that sends a
message or receives a message then you
can propagate a UUID a a correlation ID
something that you can use to find out
the the flow of the application so
that's only useful if you can do that to
everything all right and it's a lot of
code even if you can do it so thankfully
we have an abstraction called spring
cloud sleuth which is a distributed
tracing technology right it gives you
the ability to trace messages that have
flown through all the normal sort of
pathways that in a spring spring cloud
application let me add the UI I forgot
that zip conserver
the zip conserver is written by the
folks at Twitter it's it's very easy to
run and to use as a as a Springwood
application because well it is a
Springwood application right so there's
that I'm gonna say at enables Zipkin
server and we're gonna spin this up and
that'll start up on port 94 11 if memory
serves localhost 94 11 come on computer
time's a-wastin
awkward oh no binder get rid of stream
one oh so what we've looked about looked
at so far as we've looked at a way to
build an application that is robust to
service outages in case of the read use
case when we call downstream service
that doesn't exist it does the right
thing
we've looked at how to build an
application that is able to benefit for
the last isset of a cloud environment
it's robust in the case of service
outages and topology changes it's agile
it's easy to change and evolve over time
and we've also looked at observability
both in terms of the actuator and in
terms of the interim urgent behavior in
the system itself as we looked at the
flow of data from one node to another
via from for example the circuit breaker
dashboard and the Zipkin discrete Racing
platform which we can see in action here
if I go to reservation service this
should have it let's restart that this
does have it right yeah so Zipkin is in
play on the service as long as both of
them have it then they're gonna both
whatever the request is processed it'll
publish out of band it'll publish notice
span information to that is it been
server let's see if that's working local
host reservation names please work ok
8000 reservations there's this 9999
reservation names there's that
so it's both sides of talking there we
are so now if I go to the zip and server
I can see that I've got a service and a
client click on the service hit find
trace and I can see that these requests
have been made through the system I can
click on let me see more recent ones
know this request took a total of 27
milliseconds it started at the
reservation client and went to the
reservation service here's the relative
timings of the requests in the system
the waterfall graph I can click on each
element the waterfall graph and I can
see tags or you know information that
identifies the the particular pathway
that that message took as I went through
that node now this is not about
warehousing it's not about you know
finding out what Josh did on the website
five years ago it's more about online
telemetry what's happening right now how
much money did we make in the company
last year
I don't know but I can tell you what the
average latency on the website has been
for the last hour so today we've only
gotten to just the briefest of chances
to look at a few things in the spring
cloud ecosystem designed to support
agility robustness ease of evolution and
scale as well as observability if we had
more time we would look at how to do
consumer driven contract testing with
spring cloud contract to make it easier
for clients to talk to other services
but actually having to run those
services for integration tests if we
have more time we talked about how to do
how to make the right use case more
robust by using messaging eventual
consistency and things like the saga
pattern and if we had more time we
talked about how to compose messaging
based microservices built a top things
like RabbitMQ and Apache Kafka and build
stream processing pipelines using spring
cloud dataflow if we had more time we
talked about single sign-on and how to
secure different micro services using
OAuth tokens so you can reject a tab and
request that our unauthenticated right
if we had more time we talked about all
that and much more I'm sure besides but
since we don't I want to thank you all
very much for your time it's been a
pleasure if you have questions as I say
don't hesitate to to reach me on the
inner tubes also I'll be giving a talk
that's introducing a reactive the
reactive support inside of spring five
due this summer
later this later this afternoon so I
hope you'll join me there thank you very
much Cheers yeah it's online and there's
also that workshop is a 3d lab so if you
do if you get that get up repository
there's three days of exercises and
samples and instructions and we cover a
lot more than what's just covered in
here
thanks very much if you liked it please
vote because I don't know if they'll
invite me back</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>