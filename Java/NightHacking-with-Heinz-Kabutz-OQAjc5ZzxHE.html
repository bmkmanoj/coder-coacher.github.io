<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>NightHacking with Heinz Kabutz | Coder Coacher - Coaching Coders</title><meta content="NightHacking with Heinz Kabutz - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Java/">Java</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>NightHacking with Heinz Kabutz</b></h2><h5 class="post__date">2013-02-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/OQAjc5ZzxHE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right so welcome to night hacking
with Heinz kibbutz so thanks even how's
your how's your J focus conference
experience been doing so far Heinz
wonderful as always
how many times have you been out here at
J focus any month second time got a
great conference and the food the food
here is really good I've been impressed
with you it's fantastic
yeah it puts it puts our JavaOne San
Francisco food to shame um we won't talk
about junk okay alright so probably for
folks who don't alright so first to
introduce the show this is night hacking
you can watch the live stream on night
hacking calm and we have a live chat
here running with folks online so they
can interact with us and today our guest
is hind slit why don't you introduce
yourself tell us a little bit about who
you are what you do for folks who have
no idea about the Java specialists
newsletter or on all the greatness you
do okay so I'm I'm Java programmer I
started writing about some of the tricks
that we use in the trade about 12 years
ago and just been doing it since then we
were actually at the moment I'm on
newsletter number of 207 as the latest
one which is basically just a rant about
final parameters and local variables
which I don't like at all let me let me
show the oh yeah sure this is show the
screen as well so folks can say we go
right okay so Java specialist slot you
you can see all the well that last
edition that looks like a pretty maybe
hide that again quickly go somewhere
else time dust into sort of h1 yeah
without having to do much so say I can
see from your clothes you're also a Java
champion yeah you missed the Sun but
yeah yeah that's that's a classic
later when son was running the show that
we used to throw t-shirts at us all the
time with Oracle you know that ration it
arced over five years ago 20 shirts
have you gotten one of the jackets here
at the jacket the new Java champion
jackets are pretty nice oh yeah I got
one I think it was two years ago at
JavaOne okay what get you new a new
t-shirt look actually I prefer this
color anyway that's three nicely it was
nice to see the old Sun coming through
some way yeah absolutely
so just to give people context for what
we're gonna play with today what sort of
you had some coding ideas in mind for
yeah so um so bunch of different things
to do with concurrency there's a fork
drawing framework that I'm sure a lot of
you know and what I've got is I've got
an interesting exercise we're doing my
concurrence of course which where you
take an existing recursive function and
you you make it you make it use fork
joint so this is a puzzle and I've got a
I've written the recursive solver for
this puzzle so you can actually get a
solution of this puzzle I'll talk about
this and that's that's that looks like a
nice graphical way of sharing fork/join
yeah it's um the puzzle is actually too
small to really demonstrate the power of
fork/join because it's it's it's so
quick to solve for a computer that you
don't actually bother you know you
wouldn't really bother using that but
it's it's a nice illustration of how one
could use it but I first want to just
get get the basics of fork/join down and
then there's another class coming in
Java ape called stamped lock so on to
show a couple of idioms for that and
sure I can use it and why I want to use
it and why you also don't want to use it
because it's really hard to get right
it's just fine you want to be careful as
I was actually looking at the at my
newsletter archive enough here I've got
an interesting
go to in Java oh how to code a go to in
job and actually mmm one of the idioms I
modified to to use the go-to in Java
this is fun the other day so I'm gonna
code that up as well alright cool so
we'll do some fork/join for coat to go
to go to Java so that's that's some
pretty
that's some pretty geeky stuff I think
yeah yes sir okay thank you qualify us a
real hacker I hope so
I was actually say I noticed on your
website it talks about creep why don't
you tell folks a little bit about the
what's it called now I remember for
awhile it was gonna be the creep retreat
and yeah there was all these other names
tossed around up and then that didn't
fit so what we what we do is we get
together well first of all I live in
Crete on a hard-enough Crete in the
Mediterranean and people say well why
would you want to do that and I sort of
showed them the view from my from my
office which which looks like that that
is pretty nice and then they don't
really ask that many questions anymore
that's the question I bet I bet Real
Estate's a little bit cheaper there than
the Bay Area isn't it yeah you'll be
surprised hospital I actually paid for
this that's it really amazing right um
so if you live out there and I've got
like five thousand seven hundred square
meters of property surrounded by like
arrows and rate this estate I mean a
bear yeah that's that's like the whole
yeah that's it that's a whole that's a
whole suburb in the Bay Area so really
nice and I've seen some really nice
photos from some serious some after
hacking sessions on the beach well what
being off cliffs what we do exactly what
we do is we get together once a year for
a summer vacation for geeks in Crete and
it's um if you go to Jake rhetoric
you'll see some of the songs what we do
the idea is to have it as a very open
conference open ism we don't plan
anything we get together and we hack and
we talk about job and
we actually spend the mornings working
in informal sessions often and we spin
on the beach nice and we sort of like
this picture over here that's that's
basically there's another one work on my
screen sorry her so so this pic the Spay
over here it was Jeff Gannon her and
Kirk and a whole bunch of other guys we
were up there talking about Java in the
water it was quite fun so it's it's it's
very much about oh yeah there we go it's
very much about open spaces could also
do this uh-huh but without that works
well yeah open spaces conferences on
conference and what we've done also with
this is the idea is to to make it easy
for people to just organize us in their
own area so we've actually produced some
blueprints all open-source
for how you can put together your own
unconference nice so it's because it's I
mean the problem is we've got a limited
space it's that you see here sold out
you know it's a very expensive
conference you have to pay zero euro
dollars if you want and so we sold out
within a week of announcing it which is
the real pity that's yeah that's a shame
it's so so we just we just basically
tortured everybody here watching us but
I know a really cool event that they
can't I know you can't come you just
have to give me your name and put on the
waiting list and okay I'm pretty sure
that we will be able to accommodate as
few more people very nice because you
know things change it's August it's
really far out you know it's hard to
really know at the moment what's gonna
happen by August and I'm sure that some
people will have at least some people
dropping off and it's an unconference so
things change all the time we have a lot
of fun that's a I think it's it's there
be the hottest Java conference in August
and Crete is pretty pretty yeah yeah
that's pretty nice toasty all right so I
think I think we've done enough small
talk let's yeah I think so let's get on
to some code so
let me get to my project which was not
that not that not that where's my
project and it closed that and I'm
hopefully that's a nice background to
you you've got way too many nice
pictures yeah well okay so the first
thing I'd like to look at is but a
fork/join and for those of you who have
not really coded that I want to just
show you a normal recursive function and
then we'll convert that to recurse to
fork/join me just to show how easy it is
to actually do that so I'm gonna I'm
embarrassed to do this but I'm gonna do
it anyway I'm gonna use Fibonacci and
the reason why I use it it's because
it's easy for people to understand it
yeah okay so if you Bonacci we all know
the function its public long if int in
if in is less than 0 we throw a new
illegal argument exception if n is less
than 2 we return in so that's the case
of N equals Northam equals 1 otherwise
we say return if n minus 1 plus F of n
minus 2 so you know you know thank you
today horrible he did yes performance
was terrible it's gonna be horrible
yesterday venkat actually is Fibonacci 2
to show some of the tail recursion stuff
he was doing but he did not do the
negative you're showing him up very
naughty so so for those of you who
aren't in the audience here Bank I just
wave tide I had a nice long chat with
Venkat this morning so it's fantastic
nice so um we don't was testing this
earlier on I actually discovered that
doing it with art fork/join took 2.7
seconds and with with Fortran took 70
milliseconds
and it doesn't make sense right so I had
made a mistake and so the answer was
incorrect and when you get to incorrect
answers normally quite you can do it
very quickly to get the wrong answer to
get the right answer it's a lot more
difficult so we're gonna write the test
just to make sure that we actually yeah
get the great answer right so what we'll
do is we'll say Fibonacci verb new
furniture and we'll say verb dot F 42
which should be about two and a half
seconds we can measure that and just see
how long that takes and what comes out
so we see here as say the roundabout to
two point eight six two point six
seconds and that's my answer so you know
we could put that into unit test as well
to test it okay so that's that's that's
not convert the stuff to two fork/join
I'll just rename it and what I want to
do is I want to keep the interface
actually the same and we'll just have a
returning something mm-hmm and the way
to do with fork/join is you whenever you
you do a split like this you create
separate tasks whenever you and so what
we're going to do is to make a private
aesthetic in a class this quarter a
Fibonacci task extends recursive tasks
off along
look I mean Mississippi overwrite the
method here it says compute and we
always have to have an int condition
first of all in condition witches are
for recursion you also need to have a
threshold below which we do it
sequentially mm-hm
so so normally we do that because
otherwise you're going to construct lots
of objects and at some point there's a
it's too expensive to - to break it up
further so let's make a threshold off
ten if it's an arbitrary number so I'm
gonna say if okay so yeah we're not
we're not constructed I'm going to pass
in the in okay okay I'm gonna say if n
is less than threshold where threshold
would be a constant field it's probably
the system property so young - not it is
less than threshold then we're going to
say return and are we gonna just use the
the normal function over here I'm gonna
put that inside the furniture task and
make it static as well doesn't have to
be an object method mm-hmm and we just
go to an F of in right if it stays on
the threshold otherwise we're going to
make two tasks the fibonacci task if 0
equals new if not your task of n minus 1
and in minus 2 and we're going to say if
not dot for
and we're gonna say return if of one dot
now here we can either call invoke or
compute I think in focus is slightly
better sort of from a purist point of
view plus F of zero join so what we're
doing is we are we are potentially
starting another thread when we say if
not dot fork at least we we enabling the
fork join to actually execute that in
the second thread if you want to and
then if if one is done in the current
thread so that's the three it's doing it
if not potentially could be a second
thread doing it or third or fourth and
this should be all you need to do to to
produce a task now inside my my function
here an our need to get whole off a fork
joint for now what I can do this is a
fairly recent addition as I can say for
join pool dot common pool I think it's
Java 8 and might be Java 7 but I think
of strawberry at the common pool and and
this is this maintains a common pool
that you can use for for fork/join and
the reason why this is useful is because
the fork/join pool will try to maintain
a certain level of parallelism but if
I've got if I'm using fork to pull in
lots of different places that doesn't
increase the number of cores on my
physical hard way so I actually want to
limit it across the whole virtual
machine actually if I really would
prefer so I would say common pool dot
invoke new fibonacci task in and return
the value
like that this way I also don't have to
start up and shut down the pool that's
always available very nice
put those things in and comes out now I
would expect this to be a little bit
faster the previous one not quite not
quite twice as fast then we'll just say
here the fourth join and four join in
around us and we probably will see maybe
two seconds or 1.9 seconds round about
there you get one point nine five six
seconds the values looked look the same
and we probably want to actually yeah
assert a that assert the rival unit
district well yeah so it split up the
task on a few different threads exactly
got some more parallelism going on your
machine very nice now of course this is
a completely ridiculous video tech
example because what we're doing is
we're taking an exponential algorithm
and paralyzing it so you know n plus one
is going to take twice as long as in
that's ridiculous but I I made a
challenge a while ago that I wanted to
calculate Fibonacci 1 billion not forty
to about 1 billion and you can you could
try different approaches you can for
example try iterative and of course
iterative is really fast but you need to
use big integer to do it because yeah
long me run out of space off the bias
actually that's exactly I think had
noted yes
yesterday was tail recursion to get
iterative behavior with Biggins run
without big ends it overflowed and ended
up with zero exactly exactly so what I
want to do is to so whatever is she
doing did is use fork join and I used a
different algorithm completely to
calculate this first of all I used um
karatsuba for the filling multiplication
also use a different edge Dijkstra's
methods for doing the Fibonacci
algorithm so it
so the normal iterative algorithm
is as linearts order in mm-hmm but big
integer is his entire is also ordained a
tradition seeing up with audience
squared he can't solve it
yeah 1 billion are then took another
algorithm which is takes just sum of
squares which is login algorithm and and
so but the multiplications also audience
squared so you again end up at being not
being able to calculate this at all so
what I did was I used a different
multiplication Agra for karatsuba which
enabled us to calculate that in about 12
minutes
1 billion with Java interesting um so
let's get off this ridiculous example
because the only reason we use it is
because it's easy to explain how this
works now but if we go to just swing
worker sorry the fork/join puzzle solver
can see this this over here is a little
little graphic yep
and this is the initial puzzle now the
story here's my my son was given this
puzzle and by somebody and he took it
and started playing with it and after
about 10 minutes he solved it but it's
moving the pieces around and I said
that's impressive that you solved it so
quickly how many solutions are they
which of course if you're human it's not
easy to exhaustively calculate all the
possibilities now this is a relatively
small puzzle so 39 pieces but you can
imagine if it's 10 by 10 this could
again become quite a complicated thing
to work out and so I spent way much more
time than I should have
try to fight solutions for this the
first one was absolutely horrendous I
mean the there was this nested if-else
for loops is really really bad and I
managed to get it down to a slightly
smaller and recursive solution but
normal you know single threaded
recursive solution yeah and and you can
see here this this is a solution it
basically you need to match the
instruments together so the horn the
French horn here are matched actually I
used to play the French horn in oh
really yeah anybody the French horn
forced to try out it's more likely to
get a kazoo at a conference so so I'm in
there of course the in after all that
effort it turns out that there is only
one solution and this is just a rotation
of that one solution right yeah so
there's only one solution but but uh
doesn't matter you know I'm a geek I
want to try this art programmatically so
I wrote this code and I I just want to
show you how one would go about changing
it from being simple recursive to
fork/join recursive okay here's my my
simple recursive function and over
here's my recursive int condition once
I've found nine tiles that match I know
that this is a solution and I can return
that as a solution
and so that's my recursive end condition
we just make a comment here recursive
end end condition oh there's the comment
already okay
them and then over here I'm looking for
further solutions and now what I'm going
to do is I'm not going to have the
threshold I'm going to just create new
objects because I just want to show you
the principle of how this works so eka
and over here where I'm doing the
recursion
I would not fork off another toss okay
so I'm going to take this code and do
I'd only say copy and paste cuz you're
not supposed to do it with code but I'll
do it anyway and I'll delete the one
afterwards so we just yank out this
comment so this is my copy and paste
code and what what I need to do now with
because each action is by itself and I
can't pause and eat a piece as
construction parameter so let's make
these as fields mm-hmm that's not right
previous tiles is a array of
Tyl I believe yes yeah that was a not
helpful
I mean completion okay no I actually
didn't copy all the code this is what
happened you see I need to copy this
whole lot and I I didn't so let's copy
and paste one wrong again you know just
those in listing do not ever copy and
paste code you can cut it yes you know
actually I was working on a tidy a
project at Carnegie Mellon back in the
Java 100 days yeah and so the the guys
on the project the researchers there
they had it they had a theory about copy
paste yeah hence most methodologies they
they say copy paste is evil you should
never do it you should etc Center yeah
but they they looked at and they're like
ah developers copy paste that is a form
of refactoring we should track that as a
version of the code okay and actually
let people know that there's multiple
versions with differing semantics when
you update it okay but we never actually
implemented in our idea we wait this one
guy working for us he will remain
unnamed and he was extremely productive
you know we'd ask him add the speech and
this was an old swing edit actually had
to be T days and we'd go away and he'd
come back after you know after Tov now
and say I'm done go back to playing doom
and usually nowadays are probably
minecraft something like that yeah he
seems to generate thousands of lines of
code this guy and after you know after a
few months he started getting more and
more depressed because when if we
reported a bug he had to change it like
20 different places so he left he went
to have a cease and we we eventually
compressed his code on to I think it was
like one twentieth of the size before
and so funny so okay let's get back to
this we want to make a field previous
tiles which is at our Lorraine and our
results is going to be an list to list
off tiles so again make another field
for that list of tiles
and go back them final as because field
should be final when there can be and so
this is basically the parameter needs to
pass into the method I have to not pass
into the constructor okay and so here
you can see this is not ready this is
really done I don't have to do anything
here this is I'd have to change the line
of code here this is my recursive end
condition over here might need to make a
change over here need to fork off and
other jobs they need to say this I need
to say puzzle solver action action dot
sorry equals new puzzle action and I'm
gonna pass in the previous four new
previous tiles I think yeah the new
previous tiles and the results actually
want to just swap around these
parameters because they're how do you do
that should do it okay
so it's going to be results commonly
previous also the same parameters we had
in the past we now put into the
constructor here like this yeah so we
within fork off this action action dot
fork now whenever we fork something we
need to join it again afterwards so
otherwise got all this work which is
hanging in the air and so what we do is
before we do this whole list we say list
of puzzle solver solver action forked
actions equals new ArrayList for example
and then before we return we're going to
join the one up again so we're going to
go iterate through their actions and say
for action join now because this is an
action action doesn't return anything so
it just returns void to attend active to
return the value that comes back from
the join you know and that's what we
need to do in this action we don't
actually need this recursive solution
anymore so we're going to get rid of
that and over here in the find solutions
we can now Rd is the common pool or we
can make our in fork/join pool I'll do
it this way over here yeah the default
is choose the number of cores so we'll
leave it at that and it's a parallelism
a lot the number of threads by the way
the parallelism is not the maximum of
threads it can have any number of
threads okay you can be rather of
threads with a forked rental you can't
set a maximum and then what we do is we
say we need to make an ArrayList off the
off the results so we put that over here
we're saying this stuff tile results
equals new ArrayList we say pool dot
invoke the new recursive puzzle solver
action with the results and actually a
new tile array of tiles of length and
then we can say once once invoke returns
the entire tree of fork/join tasks has
been completed so we know that we can
now say a pool dot shut down and return
results and if we are lucky this is
going to compile and run
so I hide it all do holy thumbs up let's
see if it works and crash didn't work
okay so did something wrong somewhere
long that I'm so we found something that
should got stuck somewhere along the
line
so probably
it's fun so much
did you get any of these found some
matches printed on the yeah you see what
I need to actually let me just print it
out over here at previous tiles adding
previous tile this is of course how we
how we hacked when we really write some
code that's very realistic okay so it
does actually add the previous tiles so
some way along the line so this is this
is a solution right have cooked hold on
um lettuce is right so add previous
tiles does add them for some reason it
doesn't matter present sure there is
maybe this or you are maybe something
wrong here
and the flow
and over here we'll print out the
results and maybe I'm glad I'm better
call this the hacking of the coding
right yes this is definitely on the way
a lot of good and makes tough break side
up swifty that's part of the fun I think
exactly so alright so if we go to I
don't see that upward at all actually
did you see that up I didn't see the
results printed it didn't print out the
results at all the say you give it a
yeah well equals plus results and we'll
put a breakpoint there
this all happened to ya so that explains
why we had no results yeah the check was
in the method maybe we're creating
another results
maybe we in the copy/paste what would it
matter lion you're probably not putting
them into the right array yeah this
results is previous Charles must be
check where that is to find button yeah
so this is this results they said there
must be two result objects somewhere
around the line it's an example of
refactoring gone really whole rear ong
is that the only place results get set
I'm just wondering if this is the right
method call here it's a I think it isn't
work isn't it it is invoke I think so
it's got to be invoke and so if I pass
in the puzzle solver action ah so here's
the question does results come out first
I might have just called the wrong
method here on up there was something
here
you see this is the problem somehow I
I'm not waiting for them all to be we to
to be added before us before return so
of course that's not going to be the
right way of doing it so something along
I'm lying I've got a bug in this code
because what's happening is before I've
actually found yes okay yeah so we don't
have the foot we're not adding into the
fork - thank you yeah listen a cool
group programming not to pay forgive me
so what I'm doing is I'm I'm talking
about I'm not actually joining so all
these jobs are there they're they're not
being joined see the the the action list
is always empty thank you very much so
if we say for actions dot add action
then we're going to join them again and
that way we will over here make sure
that all the results actually together
alright so so I'm pretty sure it's gonna
work so while you're doing that it's
gonna work you let me come back up here
so we're gonna present our our audience
member what's your name Thomas very good
job helping us out so you are now a
night hacker thank you very much it's
amazing how you sometimes don't see this
stuff when you're looking at it yourself
especially when they're like you know
looking at you at the same time exactly
but you know there's like five guys in
the audience who they know exactly
what's wrong yeah you're laughing inside
at least at least Thomas wasn't laughing
inside he told us so thank you alright
so um so there we go we got the solution
back and then I'm not going to look at
the performance of it because it's the
main performance isn't drawing this city
diagram so that's the real cost
so that's really what we'll want to step
out for join them have any comments from
our also AJ AJ says hi and we have a few
folks on the stream attend our UPOV from
Jay rebel in Tallinn and Chris Wraith
great for they they haven't there's
about 20 people on the stream but
they're not very they're not very active
they're not saying anything okay so
there's something I pray for me so let's
say for example that you've got a bank
account with some talent with the
balance and you want to be able to
update that balance in a thread safe way
mm-hmm so there is the one way which is
to simply say okay we're going to make
an initial balance we can have a public
void deposit a long amount and we're
gonna say balance plus equals amount and
we're gonna have a withdrawal method
which
says the Palmers - equals a mountain
right and then a method for returning
the patterns return balance very simple
close oh I want to make a thread safe
though because this estimate is not
thread safe so one way to do is to
simply make all the methods synchronized
oh come on it works yeah okay okay so
this this will work and making it
synchronized is is actually not a bad
solution because it's it's a and now may
I ask why I say oh so when you're
synchronizing the methods like that I
think they're actually synchronizing on
the objects yes on this the the subject
absolutely and depending upon what else
you're doing I seem to remember this is
a really bad idea like even if you were
gonna synchronize on the object you're
better to create a a wrapper object and
then synchronize in a block around on a
wrapper object issues when you
synchronize them at this instance of the
object all right now this is really good
a good a good a good point because it's
a design decision how you want to do it
you see this way I'm allowing the client
to participate in the locking mechanism
yeah for example yeah that was it if you
write code which if I white this is a
once and then synchronize on it then it
causes issues so for example I could not
write a function externally to the bank
account and account utilities that says
only withdraw my me if there is money
mm-hm I could do that I could have a
billion
conditional withdrawal withdrawal okay
taking in a bank account as a parameter
the comped comma an amount okay and I
could not say synchronized account and I
could say if amount is less then the
current get balanced then account dot
withdrawal the amount and return true
else return false so I can do this I'm
not saying it's necessarily good idea
because I can also shoot myself in the
foot and your initial reaction is I
think provide quite it quite a good one
now
and another reason why you might want to
say or to this one is that whilst I'm
calling gate balance no one else can
deposit any money in that account yeah
but I'm just doing a read so I don't
have to synchronize synchronize is
exclusive no one else can can get him to
that method at the same time so a very
common paradigm or approach we use us to
do a this sort of read right at the top
of locking so what we do is we make the
long volatile is very very important
mmm-hmm we take where the synchronize on
the gate balance so now we can have
without you don't have to do a context
switch and we don't we don't have an
exclusive gate balance we have a
exclusive deposit or withdraw but not an
exclusive gate balance and this works
really nice in
however the problem comes in when you
have an additional field which is
somehow dependent on the other fields so
for example let's add another field here
that says private a private volatile
string
currency okay so this is my currency now
you will all agree especially in Sweden
that the currency is fairly important
and if if I have for example a method
that says convert where are passing a
new currency into the into the account
then I want that I want the balance to
be update at the same time and so when
you've got a dependency between two
fields it's really important that they
get updated together and when you read
them they must be able to be read
together as well yeah so I don't want to
have like go from 200 kronor
to 25 euros but actually it says 25
kronor because the current of field has
been updated eh that wouldn't be too bad
I think that's a bad one that's a bad
one the other way around okay if you go
from 200 credit to 200 euro is that so
that's okay but you don't like another
around yeah yeah I wanted to introduce
of course something which I carry with
me this is a remind off of currency
fluctuations which is a 100 trillion
Zimbabwe dollars oh nice 100 trillion so
that's a quite a quite an eight quite a
lot of money well actually not it
expired a long time ago
it is expiry date on the money and there
is an expiration here in 2008 so it
expires in a few thousand right that's
crazy inflation oh hi hundred trillion
dollars so this is to remind off
currency flux in arm area well it's okay
it's a k if we have a thin euros right
I could have Greek we want then you
devalue to be in that and occur and the
the currency to be n euros absolutely
absolutely
there we go
I could even pay America's debt with
that pretty cool so so you can see that
it's related obviously we now actually
um Anton made a comment should make the
balance volatile but the operations
aren't Atomics he actually have to sync
this stuff so I think he was talking
about he was talking about as you were
yeah enjoy show us Anton the I kept the
depositor withdrawal synchronized
because it's needs an exclusive lock all
right now in the past the only way that
we could do this if we wanted to have
two fields which belong together is to
use the readwrite lock mm-hmm now I'm
gonna just make a slightly different
example because this is this is a beta X
or an easier to code example called a
point the point has x and y okay and so
we're going to make a couple of methods
one will be move new X come on new why
whose new one and so this obviously
would require an exclusive lock now
obviously you can see x and y are
related you know if I'm moving from day
to day
I don't move first there and then there
I go straight there yeah and then I want
to have a public int calculate distance
from origin for example okay this
depends on birth but it doesn't update
them right so this does not require
exclusive lock I mean we've got another
one which would be something like move
if at origin and we have int mu X comma
into new Y so I'm going to move it to
another position if it is at a personal
specific position so again we've got two
related field so we can't just make some
volatile it's not enough we and we could
synchronize okay there to be the easy
way to synchronize everything and then
you're done right but it's not
necessarily the most efficient so what
we can do is make a private final
read/write lock our lock equals new
reentrant readwrite lock the famous one
and we can say for the move we can say
the typical I don't know if I've got
this here read like yep there you go
it's a typical idiom unfortunately that
missed of my code so here we say x
equals new x and y equals new what
so what we do is we first get the right
lock we lock up mm-hmm and this is again
following the principle that you say
this we should actually have the locks
private get some object orientation
capsulation I don't want anybody else to
participate in this so it's better the
better way of doing things so we first
get the right lock with an update the X
and the y and then we unlock the right
block and and then for the calculate
distance well we can simply do that by
saying using Pythagoras theorem you by
the way used to live in Greece yeah mmm
creep creep not Crete no no Chris I'm
not sure way exactly what not so um here
we're gonna say return math dot square
root I'll just do the square root of x
times X plus y times y okay but now I
can I'm gonna put us into a read lock in
a second you can't that cost at an inch
and so we need to wrap this with the
read lock so that we don't have
intermediate settings being being
calculated so again I've got my little
magic there all right okay
now already if you look at this code you
can see well maybe we can do this a bit
more efficiently by inside the read lock
reading the value into a local variable
and doing the square root calculation
off to it's true so let's do that let's
make in current X comma current wire
here we say current x equals x and
current y plus y and we do that off to
the unlock there you go
now the expensive squared operation is
executive deferred until you release
lock that's right and this can make a
huge difference because the shorter your
your lockers yeah
the better your speed of parallelism is
absolutely absolutely so times current
under y so they go this is a calculator
distance from origin this is with the
readwrite lock reinterpret right well
then you've got the move if at origin
and here what we want to do is we at the
moment we're gonna have to take a right
lock we're gonna say something like if X
is not and why there's not then x equals
new x and y equals new you why right now
because we're changing it we need to
have a write lock right well so we have
to put around here the right lock but we
know that a write lock is a really
expensive thing to do so um what if
we're not at the origin then it's not
man we don't need a write lock exactly
so what we could do is we could say
let's make a read lock okay get the
values out I'm going to just get it rid
of a try finally and if X is not and Y
is not then what we're going to do is
we're going to now upgrade that to a
write lock
mm-hm then do the update and then we can
unlock the the read lock so read lock
unlock we do the update and then we say
order we lock dot write lock don't
unlock and otherwise we simply say read
locked or unlocked
Wow okay
okay yep okay I can't believe you do
some try finalist for exceptions but I
don't think that codes good no no I
picked it up for this particular care
because it's easier to read and not just
that it's if the trial finally gets
completely confused but there's one
problem it doesn't work yeah yes that's
too bad because you can't upgrade
regular writing block to a write lock
that's right
you can't downgrade a write clock to
read lock and I say first other way
around upgrade I'll go around it read
lock to write lock so so for further
read lock and I try and get a write lock
it will always stop it was deadlock so
this doesn't actually work so great idea
it doesn't work okay so and with this
one also we're now get a read lock I'm
preventing a write lock from being
granted at the same time mm-hmm
so I'm actually stopping progress by
getting a read lock over here so in Java
8 we've got this new class called a
stamp lock it's going to be in the raves
very soon in the next version of Java
yeah it's the first time first time I've
seen it so this is exciting
units new concurrency classes yeah and
it's really cool really cool no it works
for stamps so in other words when I call
right lock I could just call okay this
I'm gonna call this snails we normally
call it hiss l let's see there's a
Mercedes SL which is really fast so
that's what's for this off and this
returns a stem and what are the induced
when are unlock it I would say unlock
riot
it's the stem
and then so this would be an exclusive
right look
mmm-hmm if I want to calculate the
distance from origin I I could do it
just like I'm doing here which is with a
pessimistic read lock so what I'd say is
long-stem equals I so love read lock and
by the way you can also convert the
stamp lock to read write lock if you
want to but then you only have the
pessimistic on that option and then here
again I'm going to say dot unlock write
and read I don't have to say unlock read
I came to say unlock if I want to but
it's this way it's an additional check
I'm so this this is really nice and then
I'm gonna check a case this is no
actually it's not to no trick at all
it's actually quite easy because what we
do is we we get the stamp which is
long-stem equals is sort of read lock
and now we can now we've got a piece of
mystic read lock which means nobody else
can actually can get us exclusive lock
at the same time which means it's quite
okay to check it to change it and now
what I'm gonna do here is I'm gonna say
I'm just going to add a try finally here
right because we really should have try
final ease and ended in the unlock when
I get to the unlock actually don't know
if it's the right block or read look
that I'm holding okay but you mentioned
there's an unlock which I just unlocked
the stamp exactly so I'm gonna say
unlock with just the stem so whatever it
is of a 3d lock radicals unlocks it cool
and now and now if if I actually now
what you can do is you can you can a
sort of instead of forcing and right
like we can we can try to convert to a
right look mmm-hmm
and this returns a lock a new long so
this is my rights stamp here so this is
my rights I've been I'm going to try and
convert that try and convert the
existing stamp to the right stem if it
already is a right stem it's it just
returns the same stuff
and if it's a read some it tries to make
a right stem if it manages to do it it
returns the new right stem otherwise it
just gives back zero all right so if the
right stem is not equal to zero that
means that we actually were able to chop
to upgrade it then what we do is we say
the stuff over here we write the the
value we also say that stamp equals
right stuff and we okay so that's the
one case um now otherwise if we need to
try again and so basically what we if we
can't get it what we gonna do is we
gonna say is there a progressive give us
the stamp or else no no no then what we
do is we unlock our tweets or read look
okay we unlock the read lock and we say
stamp equals s l dot lock dot right lock
so so now we're gonna let go of the read
completely and try in the right but then
we need to check the values again when
we get the right lock because we might
have changed you got it absolutely right
so what we can do is we can then say if
X da da da okay I'm going to refactor
this in moment - no I can look but more
pretty then then we we need to just do
this over here oops
yeah and that's actually we need to do
because now we're going to unlock here
again so we're going to lose that lock
again really unlock it over there so
this would actually be enough but it's a
bit ugly because we're doing this twice
over here mm-hm so a very nice idiom is
to change us to wild it and get rid of
this over here
so what we do is we get the lamp the
right rights lock over here mm-hmm
go back check it again and so I'm gonna
reformat this yeah um and then at the
and and then the second time when we say
try convert the right lock it will
always succeed
mm-hm and then we can exit so this is
what we call a code idiom sort of this
is how you convert from regular security
right lock it'll just work the right if
you already have it sir just don't back
immediately
yeah so you can it's a maximum two
iterations over here yep that's cute and
then there's a third idiom the third
idiom is a optimistic read which is
really cool really really cool if you
look in the the current stamped lock
they've got some horrible idioms they
which are completely not understandable
but this this one I'm gonna show you is
actually understandable and I think it
makes a lot of sense so what I do is
instead of having stuff sort of getting
a pitch to mistake read look I'm gonna
try and get an optimistic read lock so
here's what I did I say long stamp
equals s l dot try optimistic read at
this point I don't know if I was
successful or not
another unque yeah I'm just gonna say
int current equals x in current equals y
at this point and then I validate
whether the stamp is valid now if I say
if not validate sorry I'm Sol dot that a
red stem that it would return false if
first of all if I didn't get a read in
the first place but also AM so if stamp
is zero it will be come back as false
also if if in between the optimistic
read and my validate someone else got an
exclusive lock
then it might have changed and just to
be safe we say it's false
okay so if I saw that or not validate in
which we say as we say let me do the
read look so we say the normal it's a
stamp equals SL dot read lock try the
current and current x equals that goes X
current y equals y equals y and then we
say finally today I saw that I still got
unlock marker a read of the step okay so
we over here it's optimistic yeah
optimistic and over here as semester is
some mystic this this is mystic which
means that only one you can't have any
any writing happening a while see busy
reading and then we in again do the
calculation outside of that
yeah but locking so this is a nice idiom
that we can use and it's it's I mean if
this is fairly easy to understand I
think yeah another and that's the other
one it's nasty that's the horrible one
and I got it wrong yesterday my talk cuz
I'm a city for guys hey let me show you
how it works and I started coding it and
I made a whole bunch of errors on this
one so it's very easy in fact those two
I made another error here which we
didn't pick out however yeah we should
say break over here otherwise you have
an infinite loop
yeah so this conditional nervous is
quite difficult actually yesterday there
was a situation that we we use lambdas
for this mm-hm so I got ahold of Mark
Reynolds and we managed to do a lambda
that does this algorithm for us okay
gonna sit yeah yeah I do okay cuz then
you can you can abstract out the the
logic between the two exactly exactly
we didn't manage it for the optimist
clocking and their two reasons for it
first of all full optimist o'clock he
would have to be able to return more
than one value from a function yeah and
you can't do that in Java you can only
have one yeah there's none languages or
so she do that
yeah no ml yeah lots of language Haskell
see yeah okay anyway can anybody think
of a language which cannot do that
except for job okay so what we what I
did was I wrote to the idioms for right
lock and a conditional write like this
I've got here the the right block which
takes the same clock and a runnable I
this the first time I've ever used
lambdas probably stuffed it up somewhere
don't know but basically what we do is
we get the right clock we call right
drop that run and with the condition
right it's this whole algorithm that I
showed you with the billion supplier
that's the condition and the runnable
action okay we can see it's the same
algorithm as we had before and the
optimist agreed is that's the disaster
it really is I mean just forget about
that what worth looking at and so my
point with the lambda would look like
this other stuff stamp lock idioms dot
right look
yeah and I'm clocking it is days or a
wonderful lambda bingo nice that's
actually readable yeah very much so and
and the the move this is sorry the
distance from the move of at right mm-hm
this one here's your condition and they
0 these action mm-hmm okay also far more
readable them but we have the fall yeah
yeah definitely
unfortunately but you couldn't you can
actually make the second one
unfortunately but you couldn't okay okay
so this let's run it okay okay so let me
just do that again and we say - verbose
GC so what I'm doing is I'm I'm moving
with lambda moving moving moving moving
moving and you can see there's no
there's no cheesy happening
so this is a garbage collection going on
it's pretty cool
however the reason why we don't see that
you see happening is because our force
kept analysis if you turn that off - to
escape and Lissa's it's not of garbage
happening and you can see the same thing
with the other method which is the move
of AD move if at with system undo that
with let's move the fat it doesn't even
with the scab analysis on so I'll put
that on with a plus then it was still
actually construct a lot loads and loads
of objects and we need in concurrency
you do not want to do anything like that
you don't want to make your critical
section construct objects it sir yeah
that's gonna be your bottleneck that's
gonna be a problem
okay so the last thing I want to show
you and probably out of time soon huh
well for the live stream we're fine but
as you can see folks folks are actually
interested in attending sessions awfully
I don't know why you'd come to a
conference in intense sessions I don't
know any sessions today I think the boss
sees how many sessions did you go to and
if you didn't attend at least three a
day your fire the probably I don't know
anyway so I promised you that I'll show
you go to in Java right yeah yeah that's
scary
okay so go to in driver what does go to
in driver well what you can do is you
can label and breakout so for example
here I can jump out off a certain
position by putting a block off a block
around a piece of code and putting your
level at the top mmm-hmm and and I don't
recommend this this is yeah not as nice
edition of it doesn't like the base
practice the best running practice but
but actually to not to look pretty good
because I try to try something out and
it's if you go back to the optimistic
read here so I've been doing a lot of
performance tests on this comparing that
to read it right lock and and one of the
optimizations you can do is to try
several optimistic reads so let's do
optimistic reads times in and if we
managed it times in then great otherwise
we go to the pessimistic and this
assumptions that the optimist is gonna
be so much faster
that there's a threshold if you get it
within that time you're going to see
performance improvements so let's make
the let's make a constant for that
driver aesthetic final int optimist
stick spinning equals three for example
and quartet distance from origin so what
we do now is we are going to try this
three times we're going to say first of
all to find these up here without
assigning them optimistic times in okay
and we're going to say for for how do
you do this Viraj optimistic spin we're
gonna get the stem okay the step must be
defined up here as well of course
separate that and move that up here
you're going to assess stamp equals
optimistic read then we're gonna say and
this over here to sign it to the Easter
fields up to mystic and then um
if it's elbert validate and now what I
want to do is if I actually was
successful if it was successful I want
to jump to the bottom and jump past this
code over here mmm you know a little of
different ways of doing it but we're not
write the code I actually found it to be
quite easy to do it as follows so if
this is true what I do is I stick a
block around this whole code how do you
do that with a and I have an out over
here and I break out
see now I'm not saying this as the most
beautiful code in the world but um and
at once I exit the for loop so if I if I
get past optimistic spin and I get out
of the for loop they not jump and not
get the read lock and do the pessimistic
reading mm-hm so this way now what I
wanted to do is to is to do this with
the least possible code so as fast as
possible and that this is going to be
pretty fast cause are we here I'm just
gonna break up jump down here and fix it
and finish it and it's it's basically as
if you had here in art lab in Nice yeah
yeah go to out but you can't you go to
you don't have go to yeah unfortunately
today unfortunates okay that's cute yeah
I wouldn't write that how do you write
it I also don't think I should write
this like this but I sort of would like
to see some nicer ways of doing it there
will be s performative this
yeah so that there's a bunch of ways you
could do it but they they would all that
would involve involve another little
variable exactly
first aid exactly so now so now you'd
have to do something like billion
optimistic success equals false any
suggestions from wrong yeah I told them
if they have any questions to ask so
Chris Chris thanks for the and Norris
ray thanks you for the awesome stream oh
thanks thanks Chris
so and not optimistic success came from
boom boom then optimistic success equals
true right if not optimistic success
then do that
okay you could do it like that yeah now
of course we the compiler complains that
says that it might not have been
initialized which means we now have to
why would it not be Mishra nationalized
it should be initialized because it
doesn't know that we actually doing this
once at least so now we've got to go
play around and say your initial values
from equals Nord which I don't like it
all up I prefer to it's not to that okay
so but but this this is at this point we
would have to get some professor to to
make the final call estimates is like
okay more sample code we got a a
suggestion from from somebody you
probably know a a Peter zone yep okay a
Peterson but recommending a try try try
wanna be look yeah okay okay
try funny the book so how would you do
the try file in the book exception
well you could do that you know you
could do that yeah because you probably
it probably is not the most performant
creating exceptions as horribly oh no I
don't be entered in of is these funny
ideas come on
we'll make a private final static a
create a dummy exception makes equal
exception throw once we make it
something which you're never gonna hear
here's another idea
exit with return and return immutable
value to escape from the method yeah but
I need to you see over here but you can
have a final eight years I've got the
return I need to actually use those
values to work it out except with return
maybe and return in numerical return
ready no you cannot you cannot construct
objects absolutely no ways because this
this is this is the whole point is a one
we wanted as fast as possible so no
object construction no method calls no
ok method calls could be in line ok so
that's ok but alright so I think I think
we should get another chat with mark and
ask him to add the go to keyword back in
I'm pretty sure it's a reserved word did
this reserved word is but ok so I
personally find mine to be it was it was
pretty good it's it's the first time
I've ever used it for anything
what do you think he do you like to go
to
call the method yeah but I think I think
you want to actually um you have to you
have to defer it till you've let go of
the locks you can't immediately do
anything right if you call the method in
there then you still hold the block okay
anyway okay so the problem with calling
methods is our following some ethical
any return one value here I actually
need to have two values x and y so
calling methods not gonna work because
you need to construct objects to do that
to return the values so that's not going
to work um anyway it's a you know to me
to me this is actually a bit more
readable than then then the other option
but um I mean it's certainly pretty
efficient it's a fair benefit you can
power the bike it's efficient I think
it's I think it is and it's you know
with some of stuff this code you don't
use for general business purposes please
don't because you get it wrong some in
you got a problem
so rather don't use for business
business logic rather just this is for
if you're writing the next three pool or
the next fork joint for framework yeah
the library is where you're
encapsulating a hashmap trying to get
the that's what you want for most
efficient absolutely conquer all right
so just just so folks know you know
where do they send you hate mail like
how should they yeah I'm really easy to
find if you if you just go to my web if
you just send me e-mail to Heinz at Java
specialists for EU so that's let's say
the science at Java specialist stood EU
awesome then you come straight through
to me um and in addition to my website
we run a Java specialist symposium and
you do workshops and training all of
that concurrency all that good stuff
it's been a surprisingly popular course
I thought that so like two courses a
year and I've been incredibly busy so
yeah maybe I maybe I should take your
course - all right cool so thanks very
much for being on the knight hacking
stream thank you very much for having me
here is a knight hacking great laptop
sticker oh that's a ho cool it's a good
use no no obligation to put on your
laptop like she will put that on there
that's pretty cool if you do that's
awesome that's pretty cool and for folks
on the stream our next and last
interview of the Nordic Knight hacking
tour is going to be with Nome ten from
jay frog just in about an hour or so
what is the sign site for Nome fit three
o'clock three o'clock okay so our no
1:30 hour and a half from now all right
so I'm gonna leave this stream live if
you're on the live stream so you can
watch people walk around the pavilion
here and thanks very much for joining us
if you're watching the recording oh can
I add one more thing every I can because
this optimistic spend the question is is
it better or not right mm-hm and I ran
some tests last week whisper she's son
Sunday I think Sunday or Saturday before
I came yeah yeah it's interesting to get
thresholds when that would actually be
better yeah exactly it's it's this what
makes it it's it fun to play with the
stuff just find it quickly
Jake enjoy focus
and it would be under here and plus
sweet rice right so this is a
spreadsheet with all the results so I
tried it with the with and without and a
little bit small here but I kept so
you've got point stamped locked version
eighty-one fast which is the the stent
lock as it is with with with a current
EDM that I'm using and in the fast beat
rise
that's with a couple of spins I just by
the way I did not write stamp lock just
in case anybody's I'm just see just a
dumb use of the stuff I'm not smart
enough to write anything like that but
and so we here at the bottom okay so
that's what makes it tricky is that you
can't really take an average because
they are very big fluctuations so what I
do is I'll take the average the max and
the min and from that you get some idea
and you can't even have it like a this
is fast or this is slower it's a bit
difficult so um you can see here that
this is a speed-up of one versus the
other in fact as this label is a bit
wrong it's actually speed up versus so
it's it's a it's a spin versus not spin
and just beat up right um and so here
for example it's now speed up but this
one is a is 1.15 four times faster
this one is slower and so on and so at
the bottom wavy cease whenever you see
cool that means that there is a
difference that it actually is
noticeable for example it's here one
point five nine times faster it's almost
six percent faster and in the worst case
Nora it's actually 24 times faster so
that's really quite significant yet he
it's actually slower so it's still cool
I mean I want to know this information
right here it's slower it's faster so
the results are different they're
definitely different and you can see it
I mean here it's actually quite a bit
faster with one right and seven readers
it is it makes a difference because the
readers in fact the writer this is funny
it's sort of counterintuitive
expectation that when you increase the
number of optimistic reads your writing
increases by 70% yeah now that that well
I mean if you're if you're doing more
optimistic reads then you're probably
not blocking the write at all
exactly exactly so you just kind of
you're slicing in between when he's
writing not interrupting emphasis art so
you're doing less business this
pessimist degree reads and you can see
here this is the the column here is this
column this is pessimistic reads you can
see how my piss basic reads have come
down and volume from 14 million to 6
million 12 went to 5 million and if I do
less pessimistic reads it it means that
the right lock can almost always go
through yeah so throughput on the right
like a she goes up it's almost like you
want a priority of service on your
different yeah substitute so that the
results are interesting and sometimes as
fast times and sometimes it's slower
here's another one we have got one right
and 15 readers it's it's more than twice
as fast for watching all right so that's
that's that's very cool stuff Hynes
thank you very much having me and I hope
to catch you maybe maybe increase please
don't come down there</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>