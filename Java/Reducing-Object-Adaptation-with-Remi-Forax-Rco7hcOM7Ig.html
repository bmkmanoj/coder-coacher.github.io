<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Reducing Object Adaptation with Remi Forax | Coder Coacher - Coaching Coders</title><meta content="Reducing Object Adaptation with Remi Forax - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Java/">Java</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Reducing Object Adaptation with Remi Forax</b></h2><h5 class="post__date">2017-08-03</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Rco7hcOM7Ig" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">I have changed the title a little this
one is more yeah
punchy so I will talk about ammonia it's
a kind of it's my Moby Dick thing it's
something I think I have send 10 years
in and out to think about this
so first me basically in that this is
the order of importance I have free kid
I am a teacher at University parrot East
which is basically right in the middle
between paris in disneyland paris and i
am an expert for several gsa the ones
that produce invokedynamic
lamda module and now voila and Humber I
am man openjdk member you have coded the
GDK that was written by me so if it
works it me if there is a bug it's Brian
I am one of the developer of atom and I
will briefly talk perhaps about another
tool which is the name Pro which is a
the best green tool you can ever imagine
so the Trinities of the wall thing we
have no way to express invokedynamic in
java and so the relation between
if I have a dynamic language runtime in
the dynamic language code I can emit an
invoke dynamic there is no problem but
if I am if I am in the dynamic runtime
which is usually written in Java
I have no invoke dynamic which means
that usually the code between the
dynamic language and the code between
the runtime are interleaved but we have
not the same right and because it's a
language that run on the JVM I want
perfect interoperable
interoperability between Java and my
dynamic language but in the Java code I
can't express invoke dynamic - so my
dynamic language will be always a kind
of second-class citizen we have solution
by example this is the solution chosen
by natural if you if you have a
JavaScript object in your dynamic
language from if you want to see it in
the Java world you will see it through a
wrapper and basically what the wrapper
does it provide you a reflection like
API so you can call a method of the
dynamic language object get property and
so on but it's not the same object so
you will always have an identity problem
if you store the wrapper inside
something if you ask twice for the same
point perhaps
we love different rapper and things like
this okay
solution number two steel rapper a
little better you can dynamically
generate the rapper if you generate it
you can put an invoke dynamic in it it's
a way to see a dynamic language object
of type object from Java basically in
Java you will use the interface which is
fully type and the dynamic language
roleplay runtime will generate a rapper
and this rapper will have a bunch of
invokedynamic for all interface method
its realized Java long reflect proxy but
done right I mean the wall Java long
reflect proxies it so forth mostly
because you go into only one method the
invocation on layer the VM is not
usually able to go through an inline the
world the workings you have a kind of
provide pollution at the answer
invocation on the point so this is a
little better than the rapper idea in
terms of performance but still and you
still up the profile pollution problem
and because the invocation the invert
km3 the indi things in is a inside the
rapper so you don't have access to the
cold side you are not in the Java side
so as you you may ask several code that
will call the same rapper so you will
still have profile pollution it's a
little better because the VM is able to
push type and sometimes you don't have
the profile pollution because as a you
have a more precise type which is a push
through the rapper by the VM so it's
actually dependent and it's a it's a
good solution in a bad solution because
sometimes you have the full speed and
sometimes you have not and it depends
how the rapper is used so usually when
you analyze those so performance issue
it depends not only on some code but on
some other code that uses some rapper so
it's not a great thing last year there
was a kind of SOS by a Charlie Nutter
and the jvm language thing how to limit
an invoke dynamic from Java he was
talking specifically from the runtime
perspective at that time I was traveling
so I was boxed if in a plane so I
quickly wrote a write something which is
the ID well if charts write a code like
this in its runtime
by default it will work it will not be
performance but it will work so you can
easily test and you can use a bytecode
rewriter that will try to emit an in
dynamic for this code so basically if
you are you are writing a dynamic
language runtime you can write it in
Java with a specific pattern and hope
and you will have performance when you
rewrite the bytecode
but I fail I fail if you take a look
this is the bytecode after
transformation
you see am i you you have two parts you
have the side part which is basically a
kind of bootstrap thing and you have the
calling path which call with the
argument and so if you see um the
bootstrap part i've been removed you
have a load pop that so it's okay but
you still have a boxing you see the a a
new array so here all the arguments are
boxed in an array and every argument
which is not which is a primitive is
boxed to its that not that awful I
compared to the solution that Charlie
was used was using that and the tail of
of money right to be able to have a
better solution this is the solution I I
was using before
marnya there is another solution if you
want to generate an invoke dynamic
basically an invoke dynamic is just a
constant later under so if you store it
in a static final field it's okay and
you call it with an invoke exact
here the main issue is that you will
call the bootstrap method too early so
if you have a small runtime it's okay
it's not a big deal but it will impact
as a start-up time of your dynamic
language so first how to simulate
invokedynamic inside the java code here
are the goals I want to express
something in Java with certain pattern
and it should be semantically equivalent
to an invoke dynamic so I can use a
bytecode rewriter and use transform it
to in from dynamic it should initialize
the constant part one using a bootstrap
method the bootstrap method as the code
of the bootstrap method should not be
part of the fast path no boxing of
arguments and no static analyzes from
Adam I want a simple rewrite I mean I
just want to see all with his with code
I can directly rewrite it without having
to do some more analyzes mostly because
if you have a lot of code the analysis
you need to use require you to load the
world by foot in memory and in it and
it's slow
I will explain why that I want to be
able to do is rewriting with an
adjourned
in that case if it count for the
initialization part of of the runtime
and obviously it should work without the
rewriting for testing and as fast as
possible without the rewriting so how to
simulate and invoke dynamic inside Java
code what is an involved in ik you need
the cold side to stop to stop
target method under in some way you need
a bootstrap method and basically an
inversion emic is just you call the
target method with an invoke exact
technically you can also call set target
to reset the goal side but I don't need
all this thing basically what what is
the radio of invokedynamic
you have the coding part but I have
already invoked exact for that so the
only part I need is a way to initialize
a stable value by stable value I mean
value that doesn't change too much can
change I mean it's too boring the things
sense of value inside the material
qualified and I want to pin this value
to a specific code location
Michael site is basically a box for code
location so from the Java point of view
it's just a map that maps for a bytecode
location and object and I have to
initialize each entry of the map only
one with a bootstrap method here is the
API the wall epi
in one slide with an example what I need
is to have a special method I call it
get that take a bootstrap method which
is the bootstrap method is just
something that takes a lookup and return
an object and get rewritten this object
the whole point is the first call to get
will call the bootstrap method then the
next call to get we return the
previously stable values a previously
calculating value and so if I want to
express an invoke dynamic we just just
do amonia gasp dot invoke exact with a
parameter so no boxing I'm cheating
because I have solved the problem of
boxing by not boxing
and using in work exact but sometimes
changing the problem is a good way to
serve it okay some example Manya dog get
the with underscore arrow forty two will
always return forty-two I can use it to
do things like pattern dot compile and
hope that the pattern will be compiled
one it's a kind of bootstrap method I
can do things more complex like
simulating underscore underscore line
underscore underscore that you have in
he do you noticed a quad QAPI
are we yeah but by the way during that
talk I will use a lot of Java now in
feature just because it's fun
so the Stackpole ti-ti is a way to work
the stack and it's a public API it's in
Java long so you should not you should
know it it's in job along with
originally the code was should be have
been I released with a but it has a
performance issues so it was introducing
at the early beginning of of nine so it
works that way you have get instance
that will return an instance it's
basically your singleton and you call
work for doing the wall start walk and
walk and take a stream of factory you
see the earth it's a stream of sub trees
so here by example what I want is
to get the stack frames up start with
the name class name the class name come
from other it's the name of the lookup
class so it should be the name of the
class that contains the main and I in
the lambda that choose the stream I can
do any stream operation on it but once
as a world is finished the stream is
closed and I can't reuse it so so
basically I can execute Java code
why do you doing the stack working but
in a restrictive way because it's inside
to work thing and I get a stack frame
object and the stack frame object as a
method get' line number cool no
okay I can do more I can do the wall
invokedynamic thing so I would do a
Manya dog ass use a look up to look up
emitted under we find static in that
case I call an integer dot son with two
value and then do an invoke exact here I
need the cat for forecasting the return
of the intro feedback to explain that to
the compiler that it should be an int
and it just works obviously I can use
something a little more complex like an
existing bootstrap method so in Java 9
you have an a new bootstrap method
called string combat
which is able to do the wall
stringbuilder tap and a tap and a tap
and then so the name of the method is
make concat with constant it take a look
up a name you can provide any name and
you take a method type return type as to
be a string and the parameter type are
the parameter of the it's like the
string interpolation things the
parameter of the parameter of the object
that you will insert inside the string
and then you pass the string and you
indicate all with the Unicode one
obviously because it's a pork site I can
call dynamic invoker to see the gold
fight as a meta Rondo so I basically I
don't need to in Manya I don't need to
have a world cold site mechanism because
I can Co coincide as a meta donger so
how to implement Manya don't get let's
see the bytecode location how I get the
bytes for locations on something it's a
real question
I wait yeah the stack Volker IP I give
you a stack frame which has a get BCI
method which give you the bytecode
instruction value what kind of map
should I use it has to be concurrent it
has to be we
and how to create the lookup object
right I will run the code nuts inside
the GDK I can't say how give me give me
the lookup clear and I don't care about
the security okay so for the bytecode
location a way to get it here in fact we
will do two things at once you can get
the bytecode location because on the
stack frame you have a method get byte
code index and at the same time when I
will create my stack Walter
instead of using get instance I will use
get instance with retain class reference
which means that I can get the real
class of a stack frame something I can't
do with exception
API so now I have the bytecode
instruction and I have the lookup class
I still have an issue which is I have a
bytecode instruction but I don't know
which method because I have a get method
name but in the API
there is no get method type
oops I think it should be introduced in
ten but currently there is no way with
the Sakuma
the stack frame API to get the
descriptor of the method so I will get
all the overload I will not be able to
find which overload is used
it's worse than that because it's really
easy to implement this is how the stack
frame is implemented you have the stock
Volker it's it's just stupidity it had
to be changed don't hear about that so a
stack frame is just a mumble name and a
VCI again the declaring class can be
recur recomputed and the object mumble
name technically it's a mumble name do
you know the class Java long invoked one
Bernie yeah so um his type as an object
just because we are in Java long and not
in Java number in rogue and it's a
default class so I have all the
information I just have to bypass
security okay how I get the lookup
object from a different class again in
Java 9 on the lookup object you have a
new method named private look up in that
allow you to see a class as a lookup
basically it takes another look up so it
it will check if you have the right and
it will check if the declaring class is
in a package which is open in the case
if it's inside a module which means that
if the module is not open or if the
package is not to open like set
accessible it will fail again perhaps I
will have to bypass face
and what kind of map basically it's
something which I need the the class
I need the method inside the class I
need the descriptor I not need the BCI
so it's a kind of class value of
copyright - map of string of T it was my
first implementation it it's slow its I
mean it depends what you mean by slow
but it's slow there is a far better way
to do this now don't do that at all if
you take a look
ow ammonia dot get works
it takes a long does automata and you
all know how the long diameter factory
works a nice property of the lambda
factory things is that when you create
lambda
it's an invoke dynamic and the invoking
a McQuade for the lambda emitter Factory
and currently is a lambda miss at a
factory code generate one class by
lambda so for cold site which contains
lambda I have one class always the same
class so I can use it
as my class plus method name preset of
the script of PCI as my by fault
location
it only works if you create the lambda
inside the gap obviously if you are
stupid enough to create the lambda and
passive after it will not work but I
mean it's for language implementer it's
it's a kind of okay so so basically for
storing my whole site I just need a
class value and I will call good get
class on the lambda proxy and that is
fast thanks to John the class value
class is really well implemented at
least in term of performance I don't
want to be back this code but in terms
of performance it's very good so how to
do is the bytecode transformation as I
said I want a simple bytecode
transformation so this is a when you do
a mone objet you have an involved anomic
for creating as bootstrap method and
then you have an inbox package on manya
dot gap for the bytecode rewriter I just
have to look for Manya dot yet as simple
as that and I will rewrite it as an
inversion amock this invokedynamic is
basically something that will just
return a constant metal Andra
and I would do an inverted call to
invoke exact just after so it will
simulate the full in web dynamic there
is a check cast here which is due to the
arrival but as because there is always
written in that case emitted under the
JIT will remove the check cast at
runtime so it's not a big deal how to
write the bootstrap method of manya so
it worked that way this is a bootstrap
method I create a new poll site and the
call site is a mutable call site first
it will call init and because for the
the first call I need to call the
bootstrap lambda so the init method will
receive the bootstrap lambda i propagate
the lookup from the boot shop metal so I
don't have to recalculate it in that
case I don't even need the private look
up in things and inside the init
function I will do a set target and drop
the first argument so for the next call
I will not need the bootstrap lambda
anymore it works great if the bootstrap
plunder doesn't capture any value
otherwise as sometimes the JIT will
still evaluated the parameter of the
lambda even if it doesn't use a long
dynamo
so I have decided to restrict ammonia to
only work for a long that that doesn't
capture any value how to detect that to
lambda doesn't capture any value
no I don't want I want something simple
the lambda class weed will have no field
if you capture something you have to
store it so if there is no field it's
not it's a non capturing long time it's
okay
otherwise you will just have an
exception okay
I was very proud of proud obvious for
let's say one month until I mean once
you are proud of something you want to
use it everywhere that's why I have
chosen the name Manya and why not trying
to write a log API using Manya I mean if
you have a low dpi what you want is to
not pay if you don't log and if the lot
do and invoke dynamic I can branch it to
a method under that does nothing it will
be cheated and it's okay low loss cost
zero and and it can be a material called
fight which means that I can unable or
disable the logging it when I want if I
enabled logging I will do a set target
on the visible code side it will ask the
VM to be opt the log-dog log and to
insert the log thing so it's even better
because it's it's like an assertion you
don't pay the cost and you can enable or
disable it at runtime
that's cool but it doesn't work the main
issue is if I do amonia dodge jet with a
lambda here it's emitted reference but I
will of the lookup of the log method and
not the lookup of my M method in my
example the method that's called block
the clock okay you have the wrong look
up I mean a a it's not something awful
because the way to get as a declaring
class is to use a stack Walker so I just
have to look the stack frame just under
I can't use log in it I my by for
location two but here my logo
take another lambda so I will use this
lambda as a bytecode location so it's
not a get it's an override and a variety
it takes again lambda for the byte
location and it takes the bootstrap
method for it
for the byte code rewriter it's more
complex now it's not complex because I
don't want to rewrite the more near that
override but I want to rewrite the color
of the money a dot of the ride so I can
use the same trick that you have in the
GDK with color sensitive you have to put
an annotation to say to the rewriter
please rewrite the color of this method
again it's not a lot of line of code
Nathan I think it's something like two
page of code for the wall rewriting
things so the override on three point
I'm Reap Rab of I think it's the only
annotation which has a retention which
is retention policy dot class I mean
nobody uses it's either the compiler or
run time but here because it for my
bipod rewriter only need to have it on
class okay I use Manya in dynamic
language runtime and the people that use
it don't want me to rewrite their jaw I
don't know why exactly but they don't
want I mean it was very clear so I have
to use an adult to do the rewriting for
the photo and for usually for Manya
Doggett's I have no problem because
money and or gates are using in the
runtime it's my father I can rewrite it
but for Manya dot override I can't so I
need an agent even if the ism rewriter
is fast
my client use code generator so so they
are jaw are I don't know if I can say it
several hundred of Meg's you have we
have jaw with several hundred of Meg's
if I try to rewrite the world bytecode
at load time it takes a long long long
time and I don't do any static analyzes
just I have a lot of by phone to look at
so I need to do the transformation
lazily
so I will just tap the agent so the
instrumentation object and do nothing
why because when I call the bootstrap
method I'm able to find the the class
that we call Manya dot override just by
inspecting the factory at that point I
can trigger a transformation of the code
because I know that this is a code that
use a money a lot of a ride there is
even a better trick which is if log doc
log is a is a is an interface core it
will use invoke interface and invoke
interface is five by and guess what
invoke dynamic is also five bytes I have
the BCI's I have the method so I can
just
the bite valve really great because this
is a legend getting the frame that get
method is it's fairly easy because with
an agent you have the define module you
can redefine at runtime a module and
open it so basically I asked legend to
open the code that use ammonia dot
override Timonium it doesn't work well
because when you do the transformation
you do the REC transformation for a
world class and the VM will inspect
every method so so the world trick to
patch only one one thing is not
necessary because the VM will check
every method so it's more effective to
rewrite the world class if you have
several ramonja dot of the ride it will
be a simple call the twinkle money edit
override it will be more efficient so
basically I rewrite the world class one
one thing I don't know ok so no demo the
takeaway as you have seen we we have two
different semantics we want to be able
to express an invoke dynamic and with
Amber constable things we are able to
express them in for dynamic but it's not
enough I want my money a lot of arrived
in the GDK I just need to find a fun
name for it and prepare a sprayer I will
not I promise to not bug you with your
implementation of the pattern matching
if and by the way Manya dot override as
a semantics which is really close to
what you want for trackable Ramla it's a
little more complex than that you need
something which is ammonia to the right
which is something that will rewrite a
normal call as an inverter dynamic call
and you need something that will take
the lambda and see it as a constable
something so it will the compiler can
call a method this method will return a
constant we can use a combi to store it
and then when
map will be call it will be an involved
anomic that will talk on the as
parameter I think it's a better way than
link things because here you control the
way you you control what you're storing
inside the byte code I mean inside the
dot classing and you are separating what
you are storing and how you will use it
after with invokedynamic
ok it just for the title
can I use combi instead of Indy yes I
just have to work which is basically
update as I'm to support combi but
technically the way I use invokedynamic
here is more a condition that I mean
living and the world code is available
on github you can play with it just use
it in production but I don't form to
Nova yes any question
thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>