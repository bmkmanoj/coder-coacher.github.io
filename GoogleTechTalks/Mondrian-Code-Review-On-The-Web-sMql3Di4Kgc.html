<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Mondrian Code Review On The Web | Coder Coacher - Coaching Coders</title><meta content="Mondrian Code Review On The Web - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/GoogleTechTalks/">GoogleTechTalks</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Mondrian Code Review On The Web</b></h2><h5 class="post__date">2007-10-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/sMql3Di4Kgc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">I am Guido van Rossum and I work at
Google and here's a little bit of a plug
I should have checked this microphone
I'm a little taller than the average
speaker here
Google is a great place to work I mean
what I'm going to demo here is the
result of me having a year of fun at
Google so if you want to join me where's
my email address so I'm going to talk
about actually a really boring subject
code review I think most people probably
know what code review is in various
places you'll find more or less
formalized approaches to code review the
basic idea is one developer writes code
someone else reviews it this is a
voluntary thing now the review in in the
ideal situation is just a very careful
critique of the code where you point out
basically anything that you feel could
be done better there's usually a
dialogue going on you don't as an as a
code author you don't have to do
everything that the reviewer says but
you probably learn something now the the
main point of code review is that it is
done in a non-threatening environment at
my last place of employment we did not
do much code review so I ended up
reviewing a lot of code in a very
stressful environment that was a lot
less fun the point of code review is to
make a code better and in many places it
is a very much an integral part of the
of the coding process just like some
people do pair programming on principle
other people do code review on principle
so what what are some of the reasons for
doing code review well
of course to people no more than one two
pairs of eyes catch more bugs than one
when one person is sort of tired from
half a day or a day of hacking they're
probably too tired to catch every single
problem in their code so it's it's good
good idea to pass it on to someone else
who will have a fresh look this can save
a lot of time later on because the the
general rule with bugs is always the
sooner you find them the better and
there is sort of all these different
stages where you can find them if you
can find them while you're typing that
is the most efficient way of finding
them of course yet that doesn't always
work so when you once you're done typing
showing it to someone else who will see
these sort of the obvious things that
you you don't notice anymore because
you've been staring at it for too long
really helps another thing and that is
actually a pretty important part of code
review at Google is enforcement of and I
take enforcement in in sort of a an
informal way there's there's no style
police here as such some people would
wish there was but coding standards and
style guides if the code is more uniform
it makes it easier for others to read it
six months or six years from now when
that code develops a problem or needs to
be extended another very important
purpose of code review often is where a
junior and a senior developer work
together the junior developer does most
of the coding the senior developer helps
them understand the code base by doing a
thorough code review and pointing out
where they may have missed
very subtle often unwritten or written
up in and sort of non-standard place
conventions or requirements or
invariants and so on this makes the new
developer better because they learn
it also establishes a trust relationship
between the two developers eventually
after reviewing a lot of code from a
particular guy I will know what he's
good at and what I can let him do on his
own or nearly on on his own and where
I'll still have to help him or watch him
that that is a great way to sort of
gradually move people from junior to
more senior positions and many people
don't like the idea of pair programming
I find that code review is the best
alternative to pair programming it's
basically a synchronous pair programming
it doesn't necessarily do it catch
everything the same way that pair
programming does but there are only a
certain environments where pair
programming really works when one person
is interrupted a lot because they have
other responsibilities pair programming
doesn't work very well but if you're
being interrupted a lot may be doing
code reviews for someone else is just
another interruption that you can do in
between other stuff so of course I've
been doing code review for many many
years in an open source setting and
there you typically have the environment
where I'm I'm sitting here at my desk
someone else sitting is sitting
somewhere else at their desk we look at
the same code but on different computers
there's no no shared file system or
anything we probably have instant
messaging but the only thing you really
can rely on is email for communication
so somebody and again in my situation
I've often sort of most often worked
with relatively junior developers who
have an idea for an improvement to an
open-source project so they read the
documentation that says how to check it
out they try to understand the codebase
they find a place where they want to
make their change they compile it
hopefully it runs their patch actually
works now they have to get a checked
into
version or CVS or whatever source
control control system you use so
typically in the Python world for
example what we do at that point is we
ask the author of a change to send a
patch to someone who can review it that
used to be me there was a time where I
was the only person who could do Python
check-ins by the way now I'm the last
person to do Python check-ins there's a
whole group 30 or 50 developers who
check in more than I do
anyway there's a pretty standard process
where context ifs or these days mostly
unified diffs are mailed around and
subjected to pretty much did
line-by-line critique that we call code
review email back author improves their
their changes sends another patch until
the reviewer is happy and in open source
the typical situation is that the
contributor the author of a particular
change does not yet have submit check
information to the source control
repository so it's actually the reviewer
who makes the final decision and
implements the final step of checking
the code into subversion that's not
always the case I mean in Python we also
have plenty of situations where a junior
developer who has already received
access to subversion they can check
stuff in but they don't necessarily feel
comfortable checking stuff in before
it's been reviewed so we do the same
process email back and forth or maybe
the SourceForge patch manager which to
me doesn't actually necessarily make the
process any easier
but once the the reviewer says okay this
is fine then the author can actually
check it in that has certain advantages
because it means that later on the
subversion logs will show who checked it
in rather than who reviewed it there is
and this is actually one of the areas
where having a patch manager does help
there's a track record of who reviewed
it and what the discussion was and we've
seen plenty of situations where issues
with bugs came up sorry issues with
patches came up like two three four
years later and referring back to the
discussion that led to a particular
patch being checked in was very useful
also of course again the the intense
interaction between a submitter and the
reviewer is a great way for the reviewer
for this for the most senior developers
to find out who are the good junior
developers who should be encouraged to
contribute more and whose contributions
can at some point stand on their own
don't need that much thorough review so
how do we do this at Google now there's
always theory and practice and the
difference between theory and practice
is how do we say that it's larger in
practice than in theory I'm only going
to describe the theory that makes it a
lot easier when this thing shows up on
Google video anyway so we use perforce
it's no secret which is usually
abbreviated as p4 because it's a command
you end up typing a lot there is a
single Depot and we use branching mostly
for release management but the
individual developers do not have
individual branches of the code by and
large there are there are exceptions
there are groups that work in a branch
but by and large developers work on the
trunk and there are good reasons for
that and it has certain advantages in
there it has also sorted problems
another very important constraint is
that as soon as something is checked in
its life or everyone else because we
don't work with branches so it's very
important that we do the code review
before checking in and this is where all
the fun starts this is actually where we
sort of we created a problem for
ourselves that I spend some time spend
sometimes solving so one more detail of
the Google development process we
actually don't use the raw perforce
command-line tool most of the time we
use a wrapper around it which used to be
a shell script and by the time the shell
script was more than three thousand
lines we decided to rewrite it in Python
unfortunately now we have shell script
of four thousand lines in a Python
program because the somehow the
shell script didn't want to die but it
will eventually it just takes time like
everything and that that that wrapper
gives us the ability to add additional
functionality to perforce some of which
is very specifically geared towards you
in code review so here's what the code
code review process at Google looks like
and this is all command line and email
based so you check something out you
make changes you compile it you run it
you test it then you pick a reviewer
there's a certain algorithm for picking
reviewers if all else fails you pick the
guy at random who made last change to
the same file of course then the
reviewer has a little bit of a problem
because they have to review a change
that's not yet checked in fortunately
having a single shared NFS file space
actually helps at this point because the
reviewer in theory could just change
into the authors directory and do a
perforce differ itthere what we actually
do is
we have the the g4 wrapper around
perforce makes it little easier so you
don't actually have to change into that
guy's directory the system's finds out
where the files are and dips them for
you and there there are some other tools
like there is a nice TK based
side-by-side diff tool there's actually
also a tool for sending the email that
initiates the code review process after
that it's mostly just email back and
forth and because we have this shared
file space there's one difference with
the open-source process which is that we
don't actually send patches around
almost never you just send an email that
says I've addressed your changes have
another look so we do this a couple of
times we reach agreement and this is
this is all a very collegial friendly
process at the end the author and the
reviewer reach an agreement and then the
author can check to check stuff in now
there's nothing technically that keeps
them from checking it in before it's
been thoroughly reviewed except that
there are all sorts of things happening
in the background that eventually point
out that you have submitted code that
wasn't sufficiently reviewed so that
keeps people honest and it sort of keeps
the process working without being too
much of a burden I mean there are escape
possibilities like you made a terrible
mistake you need to check in a change
right now you can't find anyone to
review it okay well there's a hook you
can use to check it in right now and
someone else will be notified and they
will review it after the fact just don't
do that for every change because then
you'll uh you'll get a manager on your
back
so the tools that were originally
developed all Geo parts of the G for a
command wrapper first of all you you in
and this is I don't know how many people
here actually are familiar with perforce
not too many hands so if you're familiar
with subversion it's a little different
but in perforce there's actually a way
to tell the perforce server about a
change that you're about your going to
make without actually submitting it what
you submit is the metadata without with
without the contents of the change files
so this metadata has a convenient number
and it contains a description and a list
of the files and additional metadata
that can tell the tools where the files
live in the users workspace so that's a
g4 change command and basically what you
could do at that point is g4 change
gives you a six digit seven digit number
and you could mail that to the reviewer
there's actually a tool named g4 mail
that does a little bit more than that
and it also does a bunch of sanity
checks so that you don't accidentally
submit something for review that hasn't
actually been run through the compiler
yet so the tool that the reviewer uses
to to actually see what the author made
what changes the author made is called
g4 diff which is like p4 diff accepted
also can diff files in someone else's
workspace finally and this is actually
tool that we don't use all that much
most people just really respond by email
but if you would like to give a
line-by-line critique with line numbers
and quotes from the source code there's
a tool that sort of creates a template
for an email that you can then edit and
send now this process had a bunch of
problems this is the process as it's
still in use by many developers and it
was the only process we had about a year
ago
so Googlers love to work from home or at
odd hours or locations and especially if
you're on the laptop on the VPN the
tools for dipping don't work very well
you end up just you mean what you can do
is stare at unified dips dips in text
form but the tool that does the side by
side dips doesn't work very well in that
situation another problem that is
Universal is when you do a line by line
critique of a piece of source code it's
very tempting to say on line 65 please
change this line 512 I don't think you
need to do this by the time that email
reaches the author maybe the author has
already made some other changes in
response to a different reviewer because
there's sometimes multiple reviewers for
one change or maybe the the author
response to the first change requests
first and has to insert 40 lines of code
in alpha line 512 is certainly 552
that's fairly painful it also means that
if a month later you read back the
emails they make no sense unless they
actually contain in the integral quotes
from the source code finally and this
desert sort of the killer unless you
keep backups of intermediate versions
it's sort of you get you get the
standard problem I don't know how many
people here have had to do things like
review academic papers one of the
problems is either you write a paper or
you're reviewing a paper the first
revision works great as a reviewer
you're fresh to read the whole thing
from front to back you scroll red ink
all over the paper and you send it back
to the author now the author makes 500
minor changes then you get the same
thing the next time you're going to read
it a lot less carefully the third time
it's impossible to read it as an author
it's pretty much the same thing after a
while after working on the same paper or
article or god forbid book for a while
you're completely blind for anything
that's in there very much the same thing
happens with with source code what every
reviewer wants at some point is they
want to be able to do a diff between the
last version they reviewed and the
current version rather than being
between the last version that was
submitted to perforce and the current
version because that's the same issue so
if you ask someone to make a few small
changes if you could diff between the
last version you reviewed and the
current version you can immediately see
whether they did everything else
everything you asked them and you can
also immediately see whether they change
anything else which might be a red flag
that they weren't actually quite done
coding when they submitted it for review
another thing is so there's not much
workflow management it's very easy if
your inbox has 500 messages that review
requests or responses sort of get lost
and you get this very frequent situation
where the author needs to ping the
reviewer well have you reviewed my code
yet and sometimes the reviewer has to
ping the author have you read my
response yet so there is a lot of
improvement possible so and I should
mention that this idea was fully nil
norbit's he suggested this as my starter
project and it sort of got a little out
of hand as a starter product project
goes he said it would be really cool if
we could do code review over the web it
solves the VPN problem and you could
make the tool work in such a way that it
solves many of the other problems too so
I set out to sort of think about how to
do this and first feature I sort of
decided I would definitely add was
snapshotting every version that's being
under
you so you have a whole series of
snapshots another feature that I knew I
definitely had to have was side-by-side
diffs because that I mean I had to sort
of be at least on a par feature-wise
with the existing tool suite and
although it wasn't perfect the existing
tool suite had a pretty darn good
side-by-side dipping tool with a nice
colorization of the diffs and also
interline or inter region dips where if
you if you if you change one line into
something else it would show the sort of
the subtle changes that happened within
one line often if there's just one
spelling mistake sometimes you can stare
at a line for minutes without actually
seeing okay where did it change it's got
to be changed it cause I have changed
somewhere you just sort of don't notice
that some M was turned into an N so now
to make it really attractive and I
should mention that I had a couple of
people working with me who actually
ended up doing most of the work of this
feature in line comments and the idea
being while you're staring at the
side-by-side if you can just click on
any line in the code and the little box
pops up where you can scribble your text
your your review of that line you can do
that that's just a lot of JavaScript
coding so that turned out well yeah
that's that's how a lot of stuff happens
at Google
and then finally the idea was also to
make this a repository for all messages
or comments related to one particular
proposed change so that you can always
find everything back related to a
particular change all the email is
automatically sort of classified this
email goes with this change list a very
important requirement of the tool of
course was that it wasn't going to be
all or nothing I knew I would not have
any success if I told all developers on
November 1st you're all going to use the
web interface instead of command line
and email that doesn't work anywhere and
it certainly wouldn't work at Google so
I worked hard to have very good
integration with email so whenever
someone adds a comment to a change list
in Mondrian it sends an email to
everyone involved when someone replies
to that email the reply is also stored
back in Mondrian as well as in a number
of other places so at this point I'm
supposed to switch to a demo let's see
if the demo is actually working I don't
know if people in the back can read this
but this is still a very small monitor
for Google standards and the application
is sort of designed to fit on on a
regular Google monitors so what do we
see here this is what we call the
dashboard
it's my dashboard everybody has their
own dashboard when you type the URL of
the thing in your browser you actually
all you have to type is the word
Mondrian and through some DNS and
redirection tricks it'll go to your
dashboard it shows a number of different
categories so the first category is
changes awaiting your review I'm
apparently a popular reviewer it looks
like I have 10 or 12 things that I'm
supposed to be
next category is changing your changes
awaiting review which is things that I
have written that I want others to
review now actually some of these have
already been submitted but they haven't
been completely reviewed they turn
yellow when they've been submitted but
not yet reviewed they turn red when that
has been when they've been yellow for
four weeks
the red ones really need to be acted
upon so I'll have to nag mr. R Peterson
so there's all sorts of other stuff in
this UI I'll show a little bit you can
if you mouse over a particular user name
you get their picture and that's the
sort of that that was actually a bit of
JavaScript we didn't have to write
that's all well it was a standard Google
thing if you mouse over a change list it
shows you a little bit more about a
change list like the client the user who
wrote it I think if you mouse over here
you see something else so your pending
changes is changes that I haven't even
submitted for review yet so I'm working
on those things and I'm not ready to
have them reviewed yet but they're
already known to the metadata is already
in perforce and then finally other
changes is sort of a grab back that's
things I looked at recently things I
reviewed recently things that I
submitted myself recently I don't
actually look at that very often that's
why it's at the bottom but sometimes
it's really handy to sort of sometimes
when you're done with the review it's
not completely done right away and it
sort of you can follow what's going on
on your dashboard that way so if we
click on a particular change we'll see
that the view for that their change list
okay so what do we see here this is lots
of perforce metadata this is the change
description and not too interesting
here's the list of files this this
change list actually only has one
file if you want to you can quickly see
what the change was ask for an inline
diff but you can also show an actual
diff side-by-side of the entire file
which goes on and goes on and we haven't
even reached the diff yet so their
keyboard keyboard shortcuts that let you
jump directly to the diff well this is a
very small change so that that's all
there is in this case let's go back to
the change list view let's actually we
can also look at someone else's
dashboard actually when you when you're
in a sort of a customer service
situation relate connected to perforce
that can be really handy because more
often than not someone has a problem
with the change list and they actually
forget to mention the change list number
so you can just go to their dashboard
and see which change list they're likely
talking about so we see that Johannes is
even more popular than I am in terms of
reviewing he's also got a whole bunch of
pending changes I can type anybody's
name I can type what is it I think
that's an interesting one
and I can we also have a not so commonly
used feature but there is a feature
where you can assign review to a group
or a list of people rather than to an
individual you can also okay I didn't
actually click that you can also ask for
the changes that are pending for a
particular group and some groups really
use that because as part of their
process they never assign things to
individual developers they assign it to
the group and then one person
occasionally checks that everything is
is being reviewed in the right order so
going back to my own dashboard
there are a couple of other things we
can see let me take let me go to another
change excuse me that's the same code I
had in May I believe oh well so this
change list has a lot of files you can
click on the first file and see a bunch
of changes there there's also a menu for
navigation you can quickly go to another
file well we're waiting for the network
here okay done so let's look at some
changes actually so what okay there's
there's one interesting thing that we
see here there's a list of history these
are all the different snapshots that
were taken and stored in Mondrian's
database while the review process was
going on this UI can use little
improvement I'm not sure that the md5
checksum is all that interesting it's
that's mostly debug information because
occasionally there's a mix-up when two
versions of the file are actually the
same like actually we see that version 8
and version 6 have the same checksum so
we know that actually that's actually
the same file
let's look at let's actually go back to
the change list and find the one that
has the most comments this guy so I can
change I can diff any two snapshots by
checking clicking those radio buttons
and hitting the Selective button I can
also here are some couple of buttons
where I can choose how significant
whitespace is in the diff
anyway what we'll see here is a couple
of inline comments now these have
already been published so they're
collapsed that I can open them up like
this so here is a comment I wrote and
somebody's reply and I could reply to
him and start typing some more and now
I've added another inline comment I can
also go anywhere in the code and add a
comment there now these comments are
stored in the database they're not yet
visible to anyone else they're still
drafts that's why it says draft here let
me see how do i navigate to the top so
now I can go to review and I can do this
for for all files I can sort of I can
really review a change list in very
small time chunks if I if I have five
minutes I may be able to review one file
and it will save all the comments I have
at that point in the database forever
until I actually come back to the change
list and publish them at some point I'm
ready to actually tell the author about
my comments so click on review and
publish draft comments and here's a
forum where I can type some more
comments that apply to the entire change
maybe I'll say this is great except I
have a whole bunch of style knits or
maybe I'll say this sucks and here's why
so below that these are references to
the drafts
the draft comments I make and what it
shows what it shows is just the actually
now I can actually expand these things
and show the entire comments
unfortunately they weren't all that
meaningful so I'm not going to send this
comment but in theory if I click on this
submit button
it produces an email that that sends all
this to the author and the email is full
of hyperlinks so they can go straight
back to monitoring if they want to go
right to the file to the particular
comment there they want to respond to
let's see did I see everything yeah so
there's there's one more thing that I'd
like to show and hopefully this file has
some of that
wouldn't you believe in - okay yeah I
think here I have an example this one
that's a line that got changed a little
bit and I hope that the projector
actually yet projector is pretty good it
shows shows with more bright hide
lighting the part of the text that was
actually changed and in less bright hide
lighting that the part that's act of the
text that's actually the same between
both sides so much for the demo so that
was my starter project and and now it's
more than that how did I get to this
point well it seems that I develop only
one web application every three or five
years or so so every every time I have
to relearn all the web technology so
well that's yeah that's that's okay so
this time I learned some Django the
whole thing is put together with Django
templates but we don't really use
anything else of Django for example we
don't use a relational database we have
a google internal back-end for data
storage so that's another thing I
learned about how to use Google's
BigTable and service another web thing
that I learned about that I'm actually
pretty proud that I could understand it
was something called the web servers
gateway interface which is it really
actually it's a really nice thin layer
between the mechanics of actually
accepting HTTP requests sort of the
stuff that Apache is good at and your
application logic and so russki lets you
very easily switch between different
forms of serve application hosting it
doesn't require you to use Apache you
can use anything I don't know if they're
damn sure there is an I is
version also and all those things can be
done regardless of which application the
application doesn't have to to know
anything about what particular service
technology is being used it's also
pretty CGI compatible but you don't have
to run it as in CGI mode so even the
first prototype which had the
side-by-side gives but not it didn't
even have the inline comments it had a
way of commenting on a change list but
there was just a button that a link that
said go to the comment form and you
typed your comment in without any
context of a particular file or anything
and then you click the submit button and
sent an email even that primitive thing
was popular with a small population of
people and those were the people for
whom the existing command-line tools
just weren't working at all mostly
people working on all platforms like
Macintosh or Windows so I'm not going to
go very deep into the technical details
but Mondrian stores a whole bunch of
stuff it stores copies of the change
list metadata and one of the things you
can do with perforce is you can update
that you can add files to your change
list you can remove files you can change
the description I think you can change
permissions there's a bunch of different
things you can change and every time one
of those things changes as soon as
Mondrian sees your change list which it
only does when a user actually tries to
view the page for that change list
Mondrian will notice that it has changed
and updates its copy of the metadata it
keeps all the versions because the
metadata is also used to keep metadata
for the file snapshots basically it
keeps the size the M time and the md5 of
each file and so another thing it does
is it actually finds all the files in
the users workspace and does a stat on
them and checks whether they have
changed since last time we took a
snapshot or if we didn't take a snapshot
at all of course it will will definitely
create a snapshot those snapshots are
also stored in the database as long as
the files aren't too large I mean
everything at Google sort of has the
possibility of growing beyond your
imagination
so we've we've had a couple of times
where suddenly did the server was sort
of stuck back in the CPU at 99 percent
and it wouldn't go away and we sort of
deduct these things and we found like
okay occasionally someone is creating a
change list with a hundred thousand
files in it and actually the reason that
we had a problem with that was mostly
that there was a quadratic a word
wrapping algorithm in Django yeah they
didn't really need to fix that we've had
various other things I also the most
recent one of that kind was actually
where we were trying to do an interline
diff with we do actually we do enter a
chunk the intro region dips so if you
have three lines that change into four
lines maybe you refloat a paragraph of
text it will still sort of find which
words are the same in which words were
inserted or deleted and it will
separately show oh and here the
whitespace changed so what it was doing
unfortunately it was doing a interline
diff on something like 20 thousand line
file that where every single line of the
file had changed so it was one big chunk
so we decided oh actually if did if the
if the chunk doesn't fit on your screen
you probably don't want to see the
interline diff anyway so that was easy
so we should we store all these files
and file snapshots we actually encrypt
them because not we don't entirely trust
what would happen to the hard drive
where they're stored after the machine
tires of course we store some user
profile data we try to store I mean I'm
not a big fan of applications that have
lots of user user configurability
because that just makes it more
difficult to reproduce problems because
everybody has different combination of
features enables I mean I'm sure there's
quite a few Emacs users here have you
ever tried using someone else's Emacs
instance it's impossible no to emacs's
are configured the same so all those
things are stored in BigTable which is
an infinitely scalable database service
of course we talked to other all sorts
of other things in the back end too of
course we've talked to perforce server
we talked to NFS which is our way to get
snapshots from users we also talked we
also use SSH because sometimes and this
is this is one of those areas where
theory and practice are different in
practice some users actually like to put
their workspaces on the local hard disk
and then of course you can't access them
through NFS but we have we have we have
another backdoor we can actually remote
log into everybody's machine or almost
everybody's machine again not if it's an
odd platform so then we just use SSH to
go there except actually one I think one
of the changes I showed had a little
little warning message at the top and a
button that said grab snapshot that was
about changes that were on somebody's
local disk because the SSH thing is kind
of expensive and takes a long time and
we don't do that automatically like with
NFS but we just warn the user well
you're not getting your automatic
snapshots today click here to grab one
explicitly and in some cases that that
the SSH trick doesn't work either and
then you'll have to sort of revert to
the good old mail around context ifs or
unified ifs so we have an option for
that too
where the author actually has to upload
a change there's another stairs that the
whole thing actually consists of two
servers at least as far as I'm concerned
I mean obviously the BigTable services
the whole thing by itself but the bits
that that actually that are interesting
to me is the web server and the mail
server and the mail server receives I
probably like 10 or 20 emails per minute
scans the subject line looking for a
change list number and stores them in
the right place in the database so I
think I've already explained all the
snapshots including what if they're not
on NFS what if you can't SSH and now one
thing is everything is stored forever
it's always good to be able to to go
back to history even if it's five years
ago that's basically the same thing that
a revision control system does anyway so
this in some sense you can think of the
Mondrian as a revision control system
for pending changes and other people
would like to do that within perforce
using branches we didn't have that
option at least we chose not to use that
option so we had to build something
outside perforce but it's still a
revision control system of some sort so
again it just keeps everything forever
and once it's it once it's in there you
can't edit it or delete it except some
system administrator might have a
backdoor and this is of course also
important for the other things the user
interface is actually mostly very
traditional HTML we do use CSS a lot
it's all done using Django templates and
we're actually we're not using Apache
we're just using a completely
python-based multi-threaded web server
which is mostly part of Phillip eby's
whiskey ref implementation of the
WSGI standard platform and so it's just
pure Python code that reads the socket
that handles a request and since most of
the work actually goes on somewhere in
the back hand that's not really a
problem in monthly monitoring is one of
those odd applications that where if
there are performance problems they're
almost never in monitoring it self
monitoring itself has a couple thousand
users so the number of queries or
requests we get per second is really not
that big so we don't have very big
demands on the web servers the
infrastructure everything is sort of
waiting for other servers to do their
thing so we can actually handle a lot of
requests in pure Python code almost
single machine there is a lot of
JavaScript a little bit of JavaScript is
used for simple things like expand and
collapse comments or the inline dips
that I showed in a change ListView
that's a little little ajaxy thing there
when you click on the show show inline
diff link it actually makes another HTTP
request to the server and inserts the
response right there in the page so it
is it is limited in the number of
browsers it supports but it works for
all the modern browsers that are in
actual use at Google now the one place
where there's a lot more Ajax e stuff is
the file view de side by side div
because double clicking on a line is
something that it has to be done
slightly different on each browser
platform and things like keyword
shortcuts and showing a focus of where
you are and if you notice the sort of a
big horizontal blue line that moved up
and down in the side-by-side if that's
where the majority the majority of the
JavaScript code is is all devoted to
that single page handling all the
different kinds of kinds of all the
different variations of inline comment
like create an inline comment reply to
an inline comment discard one cancel
your change request and so on
and all that is very important because
when you're viewing the side by side div
of a 10,000 line file you really don't
want to have to rerender the entire file
when you made one change if you've got
if you're planning to make 20 changes in
that one page so a little bit of the
details how do we actually do those in
line draft comments the whole thing is
rendered as tables and we actually use
two table rows for each line of text the
first row contains the text and the
second row starts out empty but is where
the comments will grow if there are any
comments every cell now I should shave
every no and really every cell has a
unique ID which is something from which
you can tell if it's left or right and
then the line number that is used by the
JavaScript code to quickly find out
where where you clicked and where to
insert things and also to identify your
comment in the server another thing that
we do on the server side of course is we
associate a comment with a specific
snapshot so you the comments always stay
on the snapshot where you initially
entered them so there's not the problem
that the line numbers become invalid
over time you just may have to go back
to an old snapshot to see all the
comments so the mail server is a much
simpler program again a Python pure
Python based server turned out to be
fine for the number of the amount of
traffic that were processing was
something called SM TBD in the Python
standard library written by barry warsaw
years ago it's actually single threaded
it's a based on async or it can handle
many simultaneous connections but it
doesn't actually handle them completely
in parallel
once one particular connection has a
complete message received
it will make call back and that's where
our code gets called which then scans
the headers looks parses the subject
looking for a change list number and I
did a lot of early research basically
trying to figure out what kind of
patterns to look for in the subject
because these emails are often generated
by people instead of buys by by programs
so you can't count on all the email to
have the same format in the subjects so
there's a couple of things that we just
had to ignore because you can't parse it
out and we actually have a whole bunch
of odd email that somehow gets sent to
the same email alias that we're not
interested in once it knows the revision
number it also actually has to these
days it has to find Depot number because
there is actually more than one Depot it
just parses the email body and it does
if it's a multi-part mime format it
actually tries to look for the first
text part which is the most likely and
the most useful thing to keep as a
comment and then it saves the whole
thing as yet another comment in the
database for that change list and from
audience perspective it's completely
indistinguishable from something that
you enter enter through the through the
web user interface oh and one more very
important thing what it does that this
is the place where the reviewers to-do
list is maintained every reviewer has a
to-do list which is actually that's
almost the only information we maintain
for each user the to-do list is which
things you have to review that's the
most important part and that's that's
the only thing that we can't easily
recover by other things like you can
just query the perforce server and ask
for what are your pending changes but
you can't query the perforce server to
ask for what what is your to-do list
what do you have to review because
there's not the concept the perforce
server understands so that's what that's
all that all gets triggered by the email
so occasionally there is an issue when
the email doesn't get delivered
to-do list is out of date but we're
getting better at making that not happen
so a note on performance despite the
whole thing running on one box well
apart from the persistency the big table
all runs on boxes and I don't even know
where but the core functionality the
webserver and the mail server together
around on one box and usually the CPU
load on the box is less than 50% it's
going up because we we're seeing quite a
bit of traffic with the moment we have I
think about almost 1,400 unique logins
per day and over 3,000 unique logins per
week I believe and this is still slowly
going up I think it's it's it's just
growing with the size of the Google
engineering force and basically almost
every Google engineer is using Mondrian
on a regular basis if it's slow it's
almost always waiting for perforce
because unfortunately perforce is the
one big centralized resource that Google
didn't invent so isn't isn't all that
great in being scalable and
distributable and all that great stuff a
few other things are slow sometimes
difficult ake a long time or generating
HTML for the dashboard is actually
pretty intense because there's a lot of
information crammed in a small space
with pop-ups and everything so that's
that's a fairly complex piece of HTML
everything else is is pretty simple so
it being a multi CPU machine in practice
even if the if one thread is very busy
doing dipping for a particular file for
half a minute other users still get
decent response because they just get
served by other friends
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>