<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>GTAC 2013 Day 1 Closing Keynote: How Facebook Tests Facebook on Android | Coder Coacher - Coaching Coders</title><meta content="GTAC 2013 Day 1 Closing Keynote: How Facebook Tests Facebook on Android - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/GoogleTechTalks/">GoogleTechTalks</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>GTAC 2013 Day 1 Closing Keynote: How Facebook Tests Facebook on Android</b></h2><h5 class="post__date">2013-04-29</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/HUE_yrd8tl0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">for this next speaker up I believe has
spoken at more G tacks and anybody else
he probably does not need an
introduction but I will do one this is
Simon Stewart from Facebook and he is
going to talk to us about how Facebook
test Facebook on Android and so with
that I hand it off to you thank you
thank you very much for that
introduction yes I think I have spoken
at more of these than anyone else this
is the one where I snatch the crown from
James Whittaker sorry James if you're
watching before I begin I've been having
a fantastic day today the quality of the
talks has been amazing and the thing
that I've really noticed has been just
the awesome work the stenographers have
been doing like when I haven't been
paying attention and the signing down
here is phenomenal just blown away by
how well organized this is so well done
Google keep up the good work um yeah so
how Facebook test Facebook on Android
and I mean thinking carefully when I
named this presentation what I would
have done is I would have called it how
Facebook makes quality into Facebook on
Android because we don't just test for
the sake of testing right it isn't
something that we sit there and go you
know what really fancy doing some
pointless testing today there's nothing
I'd rather do actually sometimes I do
feel like that but it's only one is a
really slow day you know why are we
doing this testing we're doing it to
make quality into our apps right we
can't bolt quality onto an application
at the very very last minute
we can't bake security at the very last
minute II that we can't bake performance
in at the last minute these are things
that we need to be thinking of all the
way through the life cycle of the
application so yes how Facebook tests
facebook on Android
so let me take you back to 2012 it was a
long long time ago in a galaxy right
here the Facebook app on Android it
worked right it was it was kind of fun
and it also had really really really
lousy user experience you know here's a
quote from Mark here going we were never
able to get the quality we wanted
looking back it's probably one of the
biggest if not the biggest mistake we
made and why was the performance of the
application so appalling well actually
it wasn't that bad but what we were
doing is a pattern is fairly common in
the world of mobile applications and
that's to use the web views extensively
Facebook was a web company we like to be
able to release software we do it twice
a day now we pushed to our light our
lives website twice a day that allows us
to iterate on things really quickly it
allows us to make a series of chronic
and awful and terrible mistakes and
realize that we've done something and
fix it the next day problem is that you
can't do that on a mobile app right
someone downloads the app and then
they're stuck with it if you've got a
bug in that application they may never
update again which is a horrific place
to be in so we'd like to retain some
flexibility in the way we did that is we
use web views and the web views on
Android and iOS are suboptimal I think
is a way to describe it you know there's
a number of problems with them not least
of which is then like no other browser
out there right the Android one is based
on the stock Google Android browser
which is not crying unless you're on
jelly bean and if you're on jelly bean
actually the browser is chrome and the
webview is something completely
different the JavaScript engines tend to
behave poorly they're very slow they're
tedious and so what we were doing is we
were making use of these web views to
allow us to assure it more quickly and
it was just leading to a really poor
experience for our users so we had a
stop we reassessed when we did is we
were decided we were going to make
mobile a
best class experience that went the
wrong way I could do the entire talk in
Reverse by the way its start in the
final slide begin with your questions
and then just make it up from there
hands up if you'd like me to think that
there's one hand two hands brilliant
next next year right I'll be invited
back for sure after this so what we did
is we decided we were going to take our
engineers and we were going to train
them up on mobile and this graph here
has the numbers removed but there's a
total of about 1400 engineers at
Facebook not all of them contribute to
our mobile codebase but what happened is
it was all going along fairly regularly
and then we went what we need to do we
need to put mobile first we took our PHP
developers we ran them through training
courses we educated them we hired people
in who were skilled at Android and
mobile development and that's the result
we had this massive uptick in the number
of engineers committing code to our
mobile code bases that's fantastic thing
we're now moving a lot faster the
important thing though is its engineers
contributing to our mobile codebase
there are no Android team what I mean to
say is there is no longer an Android
team we tried to do that we tried to
have a group of people who were
responsible we call them to call Android
team and they were going to be awesome
and they were going to somehow keep up
with the flood of new features coming
into the web and that didn't work so
what we did is we took a step back we
reassessed again and now what happens is
each of the teams producing a feature on
that feature on every platform it's on
so if you own pictures you own it on the
web the mobile web iOS Android so
there's far easier for people to keep
things in sync
right there's probably people on those
teams who are specialized on Android or
iOS but there isn't a group of people
who are responsible responsible for
desperately trying to ape features from
the web and a mobile client and that
allows us to keep parity in place right
and that means that users get if
better experience if something appears
on the web chances are it will also
appear on the mobile client relatively
soon after that um we do have spoons so
there is no Android team do have spoons
so what's a developers day like let's
say you're on one of these feature teams
right and you're going to do something
how do we make quality into the
application I mean it's done all the way
through the process so let's begin with
how we build that seems to be quite an
important thing to do with software you
need to build it so we use git at the
moment for source control it's ad BCS
and so what we do is we have a central
repo and that seemed like a good idea
everyone works on their local machine
there are two branches that we care
about day to day Google I know only have
one and that's because none of their
tests failed because they've got the pre
submit and it's awesome we haven't got
the pre submit so people check in so
there are two branches that people care
about
the first one is master that represents
not a villain from Doctor Who but the
most recent version you can see who
enjoys British sci-fi here it's the
latest version of the code so master has
everything in it that has been committed
to the codebase so far it's a linear
history what we also have is a moving
tag called stable that represents the
last time that we were sure that unit
tests were passing so there's MRSA and
they're stable you know that's kind of
fun
and all this code is checked out for
Android at least in a single tree with
effectively three or four directories up
at the top Java Java tests because you
never mix test and Java code it's just
not the thing that you do third-party
libraries we keep those out of the tree
and resources used for Android
my drink of water here yes so it's all
one free um that's kind of fun because
we've got more than one mobile app that
we make for Android
there's Instagram in there there's a
Facebook app there's a messenger app
there's a camera app you know if you
download an app for Android from mobile
from from Facebook from mobile from
Facebook it's all been built from that
tree let's pray that will lifelike
laptop later um so yes people know that
these law and so what does it look like
when you begin working on a future well
what you do is you probably you're
probably on the stable branch you create
a new branch for your fancy feature
Hackney Hackney Hackney hack you get
commit and you create a new feature by
well you've been working there have been
n other developers also checking in code
so periodically you want to grab their
work they're doing and rebase so you're
always working on the top of the tree
you know Hackney hack hack hack hack
attack when you're ready you commit and
then you do a rebase so what we like to
do is what are they developing locally
on on a branch of your own you can have
as many branches as you want you can
have your commits all organized anywhere
you want but when we push it into master
we want a logical change to go into our
code base we don't want the individual
steps you did now there's a number of
reasons for doing that the first one a
logical change is a lot easier for other
people to comprehend if you want people
to understand what you're doing what you
need to do is explain why you're doing
it helps increase the quality of the
code when something comes and have a
look has a look at things and second of
all if we need to yank your changes it's
a lot easier for us to do that if we can
see the one logical change that went in
rather than the intermediate steps
particularly if you like me and you work
on like two or three things at the same
time so we always just squash our commit
before we run this command
so how do we write all this code we use
IntelliJ
it's Java right so there's two choices
of IDE vai or even that hangar IntelliJ
or eclipse both of them are perfectly
reasonable choices but the way that
we've structured our code base means
that IntelliJ is actually a really good
fit for us and from a massively biased
point of view I prefer it and Facebook
is small enough that actually in a an
individual choice and someone advocating
can that can can really make a
difference there so you know you're
using IntelliJ you want to make sure the
code is good you want to make sure the
code is testable how do you make sure
the code is testable you use what a use
dependency injection so when you're
doing object-oriented or object-oriented
software our software and you've got
collaborators right the class that
you're working on collaborates with a
bunch of things and there are two ways
that it can get hold of its
collaborators the first way was
popularized by j2ee back in the late 90s
early 2000s I'm a service location you
had this big thing and you went into it
in the middle of your method II meant
thing give me a database connection and
thing would look at you and go here's a
database connection I would be fine
um and then sort of button a 2003 2002
early 2000s and this dependency
injection phrase started becoming more
popular and that was the major
difference with that is that rather than
having the method go the thing give me
one of these the method signature or the
class under test
somehow accepted its collaborators from
the thing that created it so there's
constructor based dependency injection
where all your collaborators are passed
in at construction time and there's also
setter based dependency injection there
was a magic based dependency injection
where you annotate things and then guava
or spring or whatever it is that you
like suddenly populates fields that you
have no idea how I did it but it's
somehow right now the advantage with
dependency injection / service location
is in Mexico laborat is really really
obvious right it encourages you to think
about who your class is collaborating
with I remember I was on one project not
at Facebook and they were using service
location and I ripped out all the
singletons and I added every single
thing they depended on so that
constructor signature and 14 arguments
later somebody went that's a really big
signature yes yes it is do you think
we've got too many roles and
responsibilities to him I don't know we
should probably slim that signature down
somehow it's like yes how are we going
to do that thinking what we'll do is
we'll split the class up a lot fewer
responsibilities and what they said to
me is they went ah well pass in a map
so yes dependency injection a really
really useful way of ensuring that your
code is testable it makes it really easy
to swap out collaborators at test time
and that's vital so you've written your
code in IntelliJ that's nice
you've used dependency injection like a
good developer should you probably want
to build your code now we use a tool
called buck at Facebook for building our
code why do we use a tool that nobody
else in the world yet uses there's a
number of reasons for it what we want is
we wanted a tool that had minimal
overhead when we added a new library or
module to the project our original and
solution had a lot of boilerplate code
and it had lots of sub modules if you
see if you've used maven the way that
you would do a new module is probably to
have a top-level library and then you'd
have some sort of pom that would point
to it and who knows yeah
we want to keep boilerplate out of our
codebase boiler places things that
machine's should do for us
but we also wanted the build tool to be
friendly to the ideas which structured
our code in a way that actually plays
really nicely with IntelliJ and and we
don't want to lose that
we want really really fast clean builds
but we want our incremental builds to be
even faster because as was as Eric said
right at the beginning of the day doing
a clean is a bug in your build system
you should never ever need to do that so
yes we want faster incremental builds
and what we need to do is we ahead of
time don't know all the things that
people are going to try and build so we
want to support adding ad hoc build
steps so buck our build system um it has
three really important concepts in the
middle of it
the first is a builder Bruhl um now
that's a procedure for a tional read
Kearney yeah okay it's a procedure for
producing output files from input files
so you list a series of sources and
dependencies and the bill runs and you
get the output you get one output
let's seem very into the system you can
have that most one output from a build
rule a build file contains a series of
these rules and typically it's called
buck in all capitals which is great
unless you're on a case insensitive file
system so we declare all the rules in
that and if we want to have a dependency
between two rules we use a label to get
to the build rule and we call that a
build target okay so it's a string
identifier for a build rule this is what
a target looks like I like to read the
slash slash as from the root of the
repository so from the top level there
is a directory called javac on Facebook
share excellent : in which there is a
buck file UI with a build rule called UI
so this gives us a completely
declarative path to the thing that we're
attempting to build which is nice by the
way if you've ever used the selenium
build system it uses exact same syntax
as that it's called crazy fun if he
worked for Twitter pants uses I think
the exact same syntax is that right yes
it is brilliant
good I think it's because there is a
sort of diaspora of X Googlers who climb
for the amazing build system
the re talked about so yeah what does a
pill don't look like it looks like that
this is how we build a library for
Android the cool UI so that the one that
we had before we do a recursive glob
over the directory structure underneath
where this rule is declared so it's not
over the entire tree it's just over the
sub tree and beneath this we have a
series of dependencies which are
declared there and visibility so by
default no one else can see a build rule
outside of the build file you're
declared in so in app dependencies
within a build file but if you step
outside you need to make it visible you
can either make it public anyone can use
this thing or you can limit the
visibility to certain subsets of rules
in order to make it nice and easy to
have a library that you can depend on in
the rest of your code without needing to
be aware of how that library is
structured with the Java library you can
also export your dependencies so you can
say look if you depend on me then
transitively you get all my dependencies
as well which is a nice way of composing
everything who who knows - what language
does that look like it's a leading
question Ruby nope hang on is Python and
our build file is plaything um we
interpret the build file using the
Python Python interpreter we're moving
to Jason because you know it would be
nice not to have to rely on Python being
installed on the local system but yes so
so it's Python and that allows us to do
some really really nice things like if
we're missing the ability to build a
certain type of target you know if a
build rule should exist to build you
know iOS library for example we could
add it to the system using a glob of
rather unpleasant Python and then just
use an iOS library in the rest of our
build rules and then when we modify buck
we can fix it
and we can beg that into the platform
and it's kind of nice so we've got this
ability to modify the build system on
the fly in a turing-complete language in
a completely declarative build system
I'm not sure how I feel about that but
it is awfully convenient so what we do
you run your builds we build a directed
acyclic graph I was really pleased when
I started working on buck because it
allowed me to use some of the computer
science that I struggled through all the
way through University and use terms
like directed acyclic graph with a
straight face and what we do is we
analyze that graph when we build sub
parts of the tree in parallel so we try
and build everything is massively
parallel as we can right and that
enables our build to be significantly
faster and then because we know that if
the inputs to one of the previous steps
haven't changed the output won't have
changed we can skip building that step
we can just use the cached output and
that allows our incremental builds to be
nice and fast
how does IntelliJ feel about as
monkeying around on the file system like
this apparently it likes it we run a
command called bucket project and what
that will do is it will scan through the
entire files file system for buck files
and it will generate the IntelliJ
configs so what you do is you go I'm got
an intelligent going for projects point
IntelliJ at it and suddenly everything
works out quite nicely that will also
set up some exports for build rules for
test runners and things like that and
say that's nice and it's fast guys this
thing is quick because if you want
people to write tests if you want them
to be using dependency injection if you
want them to be doing all these things
that we want to encourage people to do
being slow doesn't help
again 'harry slide the the developer who
is sleeping going longer is better
longer isn't better shorter is better
instant is best actually if it could
somehow leap forward in time and give
you the results before you finished
writing the code that would be better
still but assuming we're constrained by
the laws of physics
instant is best so buck by default spins
up as many threads as it can 1.25 times
the number of cores on your machine as a
reported by Java so if you've got hyper
threading enabled on a modern laptop
that means you've got 10 parallel
builders running you know 4 physical
cores each with hyper threading times
0.25 okay and we found that by doing
this we can slash our build types our
build time when we were running in
single threaded mode used to take about
I'd like 20 minutes and we ran things in
parallel and we drop that down to 4
minutes that's quite nice it's an
incremental system so we only rebuild
what's necessary there are going to be
some changes I'm gonna make in the
future like at the moment we need to
scan the filesystem every time we do a
build to figure out what's changed if we
demonized something to watch the file
system as in turned it into a demon
rather than just told it was bad all the
time um we could go faster and and the
other thing as well is like it would be
nice to be able to do a distributed
build and if someone's built the thing
you need with the same signature of the
inputs you should be able to get the
same outputs you shouldn't need to do a
build so in 2012
what happened was we flipped everyone
from using ant to using buck and I'm
just gonna hide that pull that up to the
front can we flip to the to the Mac
please excellent so there are two
interesting things here I've checked out
the source code for buck and we build
buck with and because we're insane you
can see the Activity Monitor from OS 10
just down here CPU usage is the thing to
look so what I'm going to do is I'm
going to do stripped clean gonna just
time a clean build of buck and then
running all its tests so it's doing the
compilation yeah excellent now it's
running the test cases
it's still running the test cases and it
continues to run the test cases and
we're not going to wait because it takes
about a minute in a bit to do everything
that it needs to do so now what I'll do
is I'll use buck to run every single
test in the file system and to make it a
fair comparison I'll do a buck clean
this will because I'm actually in the
directory the buck is installed from we
may say a bit of ant output as it as it
bootstraps itself we should be fine but
look at the CPU usage over here what
it's doing now is it's parsing
everything it's testing all the tests it
doesn't do a mean right and bam in the
time it took for me to describe what was
going on is run every single test in the
buck system and that took significantly
less than the minute it would have taken
if we were using ant so that's pretty
cool right can we go back to the slides
please so at the time we did the
switchover it was quicker to pop up a
warning on the ant build saying why
didn't you go and download it you could
download buck install it on the system
and do a complete build far more quickly
you could actually do than if you
finished your ant build which is crazy
and the good news is buck is open source
you can go and download it you can go
and have a play with the build system
that we use at Facebook we accept pull
requests please send pull requests
they'd be lovely
it's pretty nice if you want to see the
documentation just head over to Facebook
github calm and take a look at that URL
sundar the Apache 2 license so if you're
working in a bank you're worried about
having to suddenly make all this source
code available because you use a new
build tool relax it's okay it is written
in Java I know it's not trendy but it is
a perfectly working like language and a
small amount of Python which makes the
Python astiz happy and it works on OS 10
and Linux and the reason it doesn't work
on Windows because nobody builds on
Windows
well none of our team currently build on
Windows I'm sure at some point there'll
be a need for it so I mean that's a
flippant comment and it was fine
um and of course we build back with end
so yes we've got this amazingly fast
build time right and that allows us to
test testings good right we get our
developers to write the tests at
Facebook
there is no se T no s Det no te no QA e
no nobody no test Department no QA
Department we just have engineers now
some of the engineers have a passion for
testing in the same way that some
engineers have a passion for databases
some of them have a passion for security
and some of them have a passion for
finding pictures of kittens on the
internet and posting it to their
timeline but we get our developers to
write tests everyone who writes a line
of code is expected to also be writing
tests for that line of code which is
nice right seems to be working all right
working out all right for us so far and
I quite like it right I always find that
companies that have a test team the test
team tends to be looked down on and not
treated with the love and respect that
they ought to be right I remember yeah
I love you guys it's okay
yeah I remember sort of getting
interviews from people going I he wasn't
good enough to be a coder but you might
be okay as a tester it's like no no no
no no you've got it all wrong
they're not good enough to be a tester
they might be all right as a coder um
and and they just go it wasn't
appreciated in the way I thought it
would be I knew that really so what kind
of tests do we ask people to write we
start with unit tests unit tests run
using J unit chem BEC works at Facebook
we're not using tests ng Cedric doesn't
work there Kent does for those of you
don't I can back rope J unit I'm Cedric
test on G um I'm gonna encourage people
to write unit tests to run locally on
the JV n because we appreciate fast fast
is really importantly move fast break
tests that isn't the Facebook mantra but
it almost is I'm in order to enable
people to move quickly they're using
dependency injection we can replace
collaborators a test time using easy
mock that's one of the libraries that we
use maketo is another choice if you're
looking to do things about easy mock is
is what we settled on at face book but
we're building an Android app and if you
include the Android jar from the from
the Android development kit and you run
a test using it what tends to happen is
any time you touch anything
included in that jar get an exception
with stub being the only message in that
exception and that's because what
they've done is they've provided an ABI
compatible jar with no implementations
because the implementation runs a dalvik
on a device that makes writing tests
incredibly difficult that's a bad thing
right we we don't like that so what we
do is we use a library called
robolectric again it's open source and
what that does is it provides stub
implementations or fake implementations
of each of the Android methods right so
what we can do is we can compile and
test and run in the IDE on your desktop
for a really fast developer feedback
cycle and that's nice because there's no
compilation to dalvik no pushing
in the machine the device or the
emulator and you can get that nice fast
cycle time and we appreciate fast but
unit tests don't cut the mustard right
you will occasionally want to make sure
that all the unit tests function
correctly and the software when you plug
everything together doesn't fall over so
on a project once which had slightly
over two and a half thousand tests the
test ran it was a dotnet project the
test ran in about two seconds it was
amazing
and the app would consistently not start
up and it's because they'd forgotten to
write integration tests and larger tests
right and they were just using more
objects and going yeah it'll return null
here and throw an exception here for
exact same method you just know you need
larger tests and larger tests there are
a handful of frameworks that you can use
you were Automator which came in API
level 16
so basically jellybean and above I think
it's there in ICS but jellybean and
above it starts becoming useful we use
that quite a lot we're writing our own
test framework to allow you to write
tests out of process and off device
using UI Automator and we call it bully
because it pushes things around I may
have to come up with a better name
before we open source it or maybe not
who knows we also use robolectric for
the older devices and there are some
tests using that we use a monkey runner
we use a whole series of tools that come
with the android development kit and
they're all quite nice but robolectric
UI Automator those are two the key ones
that we use by the way we also run
things like power tests and on device
tests and thing that's things like that
but these are tests of the standard
normal developers right rather than
crazy ones who really enjoy testing he
built the code you tested the code even
if you don't think it works right so
you're ready you're gonna push it into
master so you remember way back in that
back in the black slide
I was arc diff right what does arc diff
actually do it kicks off the code review
process right you'd write a description
of what you do you're right
test plan and if the test plan goes
wrong or they're written equivalent you
tend to be told off and told to improve
your test plan and we send it up to a
tool called fabricator which is like a
Swiss Army chainsaw of project
management so it does tasks it does code
reviews it does browsing of repositories
it allows you to do all sorts of clever
wonderful things and we like fabricator
at Facebook and this is what a code
review looks like you can see here that
the chap has submitted a reasonable test
planet it has been grayed out but it's
in purple the reviewers come back and
asked him to make some changes the
developer has made some changes that's
what the little icon second from the
bottom does and then the review is gone
this is good you can check it in now
fabricator has a killer feature and I
don't know if you can tell what it is
it's image macros in the middle of your
code review you can just take a little
line and it will insert an image into
the code review
this is American Obama which is
President Obama playing an electric
guitar shaped like a bald eagle or
wearing an American hat I quite like
that one I stare at it endlessly it's
fascinating um and ship it it's like
it's all done just ship it land a code
doing something interesting to land it
we use a command line tool arc short for
arcanist it's the command line
counterpart to fabricator
and landing there's two things that runs
a lint which can be run separately and
we use the Android lint err with
additional lint rules that we've added
so you check for things like null
pointer exceptions so we use at and
nullable quite a lot from from guava
optional as well I'd rather library
fantastic if you're not using it just
download it now and use it it's one of
the best things to come out of Google
for developers for a long long time it's
awesome and we also make sure that all
the api's for the versions of Android
that we support or all present and other
bits and pieces and we do an arc land
well art land does is it takes your
changes in your local
branch rebase is Amman to master and
then pushes your version of master into
the central one so if you take a look at
the history at the project and get on
master it's a single linear history we
don't have weird branching it's just a
straight down linear history of logical
changes right see bland did you code you
tested it's all wonderful right no hang
on we also have a continuous build
system if you haven't got a continuous
build system yet just use one I don't
care what you use cruise control go we
use buildbot right and you can see here
that most of the time things are pretty
good one developer has caused a test to
fail and so we're not going to move the
stable branch but when these tests all
go green then we go excellent and these
are sort of longer running tests so
these are integration tests end-to-end
test it we don't want a user to a
developer to run on their local
workstation because there just isn't
time in the day and if you're not
breaking the continuous build server
periodically you're probably not working
hard enough that's what one of my
friends used to say I think he's right
actually I think it's okay to break the
build periodically as long as you fix it
immediately afterwards possibly by
yanking your change out reworking and
resubmitting it so build what runs all
these longer running tests these power
tests make sure there are no regressions
and performance or anything like that
now we're done right dog crap sorry
knack am you in the bed he bettered that
I wouldn't profaned does that count as
profanity I don't know there we go
done it properly and so yes it's built
we need to talk through this thing as I
said before when you get this
application on your phone if it falls
over and user may never download it
again that would be an awful awful thing
to happen so we dog food extensively and
one of the platforms that we make sure
that we dog food on is gingerbread
problem is at Facebook many of our
developers are paid well enough to be
able to afford an ICS or jelly bean
device right and we can ask for like
your Galaxy Nexus for testing and things
like that but gingerbread is still
incredibly popular they're still
churning out devices with Gingerbread on
it and these are the latest numbers from
the dashboard that Android has on their
website and you can see gingerbread is
about 4045 percent of the market so what
we do is we make sure that people are
voluntarily using Gingerbread as their
primary device and that dogfooding our
application so they install the beta
builds and they're on their device and
they keep on using that one of the key
people using Gingerbread is their
day-to-day device is a release manager
for Android he's not always the happiest
person but he often Flags up pretty
nasty regressions that no one else is
caught yet because they only show up is
sort of out of memory exceptions on
gingerbread where the devices are more
constrained so this is the PHP hammer by
the way I don't know if you've seen it
has nothing to do with the talk I just
love the picture so you've downloaded
the beta version of the app you've side
loaded it and what it does is it
periodically at Facebook at least
contacts that build services and goes is
there a new version of the application
and if there is it nags people to update
it so it downloads it in the background
and then goes would you like to install
it would you would you would you and you
go PL right and so once you're on the
the testing track at Facebook and you're
always using the beta build you're
always using the most recent beta build
which prevents sort of old bugs being
filed by people and filing bugs is
incredibly easy because what people do
is they take their device and they shake
it now we call it a raid shake because
you normally only shake your device when
you're going it's not working oh hello I
can file a bug excellent and that's kind
of a really nice feature right so we get
good instant bug reports from people as
they're experiencing it using the latest
version of the application which allows
us to to do our releases releases never
thought I'd get that did you so um you
can pick two when you're doing a release
you can have features quality or regular
schedule Wow
it's a kind of tough choice if there are
any project managers in the audience
features quality schedule is not two
that's three so we decided that we were
going to do time-based releases which
are high quality that means that
occasionally ship without features that
we've been working on right now the
advantage of a time-based release and we
our releases are about four weeks long
so what we do is we cut a branch we do
stability work for about three weeks we
have a release candidate for about a
week where we push it out to the beta
testers and anyone in facebook who
volunteers for it and then we ship to
the Play Store so once a month there's
an update to the Facebook application
and it's really nice having that
regularity because it means if you're
working on a feature and you miss this
release you know that you're not gonna
have to wait forever before the next
release right it means that you can get
this stuff as quickly as possible and
and it means you know you've know you've
got that consistency that regularity you
also know that your feature isn't going
to be blocked as somebody else
frantically tries to finish their thing
that's nice
so time-based releases are hugely hugely
valuable to us and Dunn isn't just hey
it compiles and the test pass and you
know nobody's filed a bug with it yeah
in and on the release candidates you
know done is things like it's the design
work all finished we see changes going
into the release branch around the
design of a feature then we know that
the piece hasn't been finished and for
the feature hasn't been finished we yank
it from the release we either hide it
behind a flag and strip it out using
decks ProGuard even or you know we just
remove that particular feature and we
ask people to keep them working in
logging how do we know when we release a
feature that it isn't causing and
million crashes right we get metrics and
feedback and and information from the
versions of Facebook that you're running
on your phone if something goes wrong we
we get told about it somehow sometimes
it depends you know and we can look at
that data and we can go oh crikey
there's been a sudden spike in crashes
on this particular kind of device let's
fix that right so we get information
from the world if you haven't put
logging in we can't get them
sometimes there are server-side changes
that need to be made we still use web
views in a few places so if you're
pushing a new future feature we need to
make sure it works with the old and the
new version of the app um and obviously
Revathi and legal review are really
really important Facebook cares about
privacy like we're a social network if
people don't trust us with their data
we're dead in the water right so we need
to really really be concerned with
privacy and we are and legal review just
in case so they're just as important as
a code review and that's what done means
so that's basically how we bake quality
into the Facebook application right we
go all the way through we run tests
consistently we encourage people these
design pans for testability we have
defense in depth so they're in unit
tests integration tests the continuous
integration server we have people
dogfooding all the time we encourage
people to use devices that aren't
commonly used by people who have got
well paid jobs but I used widely in the
real world particularly in the smaller
markets the emerging markets great so
thank you very much for your time and
we've got time for some questions
thank you thank you something that was
fantastic I really like seeing the end
end we have a couple live questions so
how about we go to the left first go
ahead and state your name where you're
from
hi my name is Christian from Google
actually work on the guava team awesome
work yeah
well that's more my other teammates but
the JDK five back port yeah antastic
working on that today ship it but so I
wanted to thank you for some really
innovative work on build systems and
putting that out to the community is a
really awesome thing so I'm glad to see
it I had a question about buck
particularly because not all companies
have access to all the source code they
will ever build so how do you handle
binary dependencies of things that are
you know third-party libraries yeah
there's a real cooled pre-built jar
where you can just check in so we've
we've got third-party dependencies we
don't build guava from source for
example just check in the jars okay you
check in jar see yeah we check in the
jars we have pre-built binary rules and
you can depend on those the binary rules
allowing you to also attach sauce jars
and Javadoc jars and if you do that when
you run project it will actually hook in
the sources so that you can browse into
the source code while you're working on
the code on your project very sweet and
yeah obviously you have an eclipse
plug-in coming soon right um we accept
pull requests all right there you go
okay it looks like we have time for one
more question so we'll go over here I'm
Dave I'm from Family Search so you
mentioned that the codes in a single
tree is that like all of the Facebook or
is it just the code for Android and the
other question that kind of goes along
with it is does that mean it's all in
one git repo and how does that perform
so at the moment the Android code is in
one repo the iOS code is in another and
dup dup dup the website is in the third
repo I think you know Google I've
demonstrated you can smoosh everything
together and that works pretty well for
Google I mean we saw all the stats
earlier which were amazing right
just totally mind-blowing so we could do
it that way but at the moment we have
separate repos to the for the various
things but all the Android code lives in
one tree cool okay actually maybe we'll
just grab one more and then I have some
announcements about dinner and things
like that right after this so go ahead
last question please hey Noah Sussman
I'm an independent consultant but
formerly of Etsy where I designed the CI
system with pre-commit because it works
so awesomely for like Google and yeah
and Mozilla and so why not
why do I know pre-commit I'm fascinated
um just because we haven't had the need
for it um the other thing as well is
sort of for a relatively small company
like I know fourteen hundred engineers
sounds like an awful lot that's fourteen
engineer fourteen hundred engineer
spread over the web the iOS app the
Android app working on our internal
tooling working on stuff for our data
centers just you know everything right
Facebook does more than just the
newsfeed rate we've got messaging
infrastructure we've got groups we've
got all sorts of fun things right so
1400 engineers isn't actually that many
the team working on buck is there's
about three consistent contributors and
then there are other people who join the
team for it for a month or two and then
they roll back out again
so you know there's just isn't a huge
amount of manpower
um and it turns out that if you run all
the unit tests before you check in that
catches most of the problems so there
hasn't been a sort of pressing need to
have a pre submit thing when there is a
need then I think we do it but yangmi is
a really good mantra right if you've not
heard of yogini it comes from the agile
community you ain't gonna need it so
don't write it don't use it until you
actually have a need for it right and
then put it in so yeah that's why we
don't do it with that Thank You Simon
hopefully you'll join us for dinner and
thanks very much guys</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>