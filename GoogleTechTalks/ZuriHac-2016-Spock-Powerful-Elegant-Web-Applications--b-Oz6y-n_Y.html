<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>ZuriHac 2016: Spock - Powerful Elegant Web Applications | Coder Coacher - Coaching Coders</title><meta content="ZuriHac 2016: Spock - Powerful Elegant Web Applications - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/GoogleTechTalks/">GoogleTechTalks</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>ZuriHac 2016: Spock - Powerful Elegant Web Applications</b></h2><h5 class="post__date">2016-09-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/-b-Oz6y-n_Y" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay so hi everyone
um I'm Alex I wrote a Hasker web
framework and I would like to talk about
about it today but I also would like to
maybe structure the talk a little bit
more general so it's not only about
Spock but also about web programming in
Haskell in general because the last time
I gave a talk about Spock was very
technical and I showed off a lot of
smooth small cool features but I this
time I would like to try rather to to
show the big picture of and motivate
more people to write web applications
actually using Haskell yeah so quick
slide about me I work on four three
project and I still go to the University
and do my master's degree I work on a
medical application for the iPad and
hope it's you can see yes so basically
the idea is we have a server in the
hospital that's running Haskell it
collects all the data and then it
synchronizes the data to iPads and
Antarctic waters can look at it it does
a lot more but that's just said what it
does in one short sentence and also this
is also me not writing any programs but
walking around and measuring ground
tracks and yes we do different analyzes
and quality measurements to ensure that
the tram doesn't derail and also here
all the server-side architectures
written in Haskell and the web-based
interface that you can look at the
measurement value sliders also fully
written in Haskell okay so I started as
a PHP developer when I was I wrote a
browser game in PHP and it was really
fun and yeah I I didn't really know how
to to
to program so riding my browser game was
like I need to have my users login how
do we do that Gogu PHP user login in PHP
uh here's a code snippet copy/paste okay
it works great
yeah so we get functions like this maybe
not exactly like this but this already
has this like three or four security
problems at least um and you get a big
huge file that it's called functions dot
Inc dot PHP that has 5,000 lines and
implements all the business logic and
view in one go so it's a mess but it was
fun and yeah so moving on yeah I'd like
to talk about gauge B okay so Haskell
we're we're we're now Haskell hackathon
so why why would you pick Haskell to
build web applications well actually I
just put up three ideas what you would
expect when writing the hack has no
application so you wanted about a quick
write you want to have something quick
it's not only for web applications you
always are on the time pressure you need
to ship your product you also want to
iterate fast so when someone comes in
and says we need a new feature then you
want to say ok no problem I'm done with
it in two weeks and you want to make a
good estimate without having to worry
about stuff that's unforeseen of course
we all want high performance right we
want to scale to the infinity we want
our web application to be reliable so
when we start our web server once we
want to go to bed at night and wake up
in the morning and not have it crashed
everywhere robustus kind of the things
the same thing and we want to have it
secure so that while I users users data
doesn't leak into the world ok so yes I
came from PHP Word was really really
cool and simple to start writing web
applications and I yes I did an
internship back then and I did a Java
JavaScript application and then the
internship was for five months for five
weeks but I was done with the JavaScript
application pretty early on and then
they said
well now we don't know what you can do
but you can wire up the JavaScript
education into our Haskell application I
never touched Haskell before and never
touched anything functional before and
so that's how I started into a school
and then I also want to web programming
so I looked around what kind of web
frameworks are there in Haskell
available and there were most the web
frameworks that I found were they had
they were they were big just from
looking at them you had to use template
Haskell maybe or maybe you could do it
without you had to read a book to
understand how to run them and I found a
little framework that was called Scottie
and that basically seemed really simple
and I liked it a lot so I started using
it and that's actually also how spork
started so I was starting to miss
features in Scottie and well the goal of
Scottie was to be really really simple
and I thought well that's maybe a little
bit too simple for me and for general
purpose web programming so yes and there
were some performance problems maybe but
yeah so that's box so another motivation
from Spock was and we want to benefit as
much from the types but without much
title of a program so it's a little bit
a different approach as might be you
know servant which is a very type
focused way of expressing the
applications and I wanted to have you
program on value level and have the
types match up and then when they when
they don't match up then you know I got
something wrong but you don't have to
think about what's really going on there
so you don't have to know about concepts
like level lists if you were actually
using spark but it uses it internally so
what does it mean here's again the
motivation was to make Spock really
simple and easy to get started so this
is just a basic small program that just
has one endpoint ad you can pass into
numbers and it'll render an HTML with
the span inside that has the results so
it's really simple and already here you
can see on the get request takes two
parameters and they are both gonna be an
int so I don't have to worry about
use a pausing numbers and anything it
will just make sure that you get an int
in the compute function and if you don't
get int and the user will have an for
400 for arrow so just a quick quick more
technical view on this for those who are
interested in the core of this whole
thing is actually type level lists so if
you have what I put in comments there
and function that is it takes an int and
another int and turns it into or runs in
an action and returns nothing and that
is equal to HVAC illuminate type of
level lists of ins and then the return
type and basically you can now with some
fun type level hacker you can now turn
any any function like this into a
function that takes a list that has a
type level list and to a normal function
and the other way around so you can just
basically Corine unto a functions with
infinite size topless yes and then you
have some has rampant class that's just
for implementation details so this is
pretty cool so yeah and this is
basically then what it looks like in the
framework so you have a path you define
some static components and you define
some variable components and then you
they will be collected at the type level
for you you don't have to write this
annotation well if you put it that alone
like this then you have to write an
annotation but if you if you wire it in
the function then the type inference can
find it and then you have this get verb
for example that takes a path that takes
two arguments and then it takes a
function that takes these two arguments
and runs it in any wire adopt in the spa
component right so one big class of off
box in web frameworks right it's
basically logic boxes where programmers
just forgot to do something you forgot
to sanitize user input or you forgot to
check if the user was even logged in
before showing him a resource lots of
stuff like that and I just happen to see
I just saw and I think on Hacker News
wasn't somebody who wrote about
statistics and on hacker 1 it's a
website where you can do back bounties
for high-profile companies and I think a
30% of the box were or 27% were all
based on user inputs annotations I was
doing there was done wrong or not at all
and lots of the this box you can catch
and Haskell with the type system like
really rudimentary if you render HTML
you don't just do string concatenation
but you use a combination library and it
just basically if you pass in a text you
have to convert it into an HTML type and
that will do this capping for you so
you're really forced at least to think
about what is my input do I have to
check and escape stuff or do I not have
to snip so you can't just do the funny
concatenation thing that I did on the
PHP function that I showed earlier
another example that I picked out
because it's it's it's fits into the
into the type safe the the type and
motivation I gave him D and the
introduction is here 24 bucks were found
where application was program or open so
not and not really properly done and you
can also can prevent this with types
essentially with with with the idea that
we have in Spock you have context so
every request all doesn't just run in a
general context but you can also add a
context annotation so for example in the
in the function gets the secret data we
say we have to have we have to have a
user in our context if you don't have a
user in a context then we can't use this
function in an action right so you're
already preventing on type level before
running the application on compile time
that Emirates is that someone will use
this function somewhere where the users
not authenticated and then you can
define a hook and the hook will
essentially lift your action into the
new context so for example here we read
the old context we
session I was said now this is example
code we just get the user and this could
fail you fucking this example and if it
doesn't fail then we put the user in the
context and then the following
applications in that definition can
access it and the type checker is fine
and we made sure that this gets your
data function can only be called if
we're actually dealing with user who's
logged in so it's pretty cool and it's
pretty it's pretty simple so I mean you
look okay there's type of Lists and all
this stuff but you don't have to worry
about it when you're writing an
application it it will just most of
stuff can just be inferred okay and then
here's just another one XSS parks it's
also a big glass box and this is also
can be rented by types as I said earlier
for example with an HTML Combinator
library there are also classes of box
that can't be prevented but yes so just
the motivation has to really really
really helps to prevent this kind of box
right so now everybody wants to do
single page applications I don't know I
or maybe I know why there are reasons
against this there reasons for it
but everybody wants to do single page
applications and the problem is with
sing about applications you need to
build API soar not a problem but you
need to build API and you really want to
make sure that your your API fits
together with your single page
application right you want you have to
kind of interchange data and how do you
make sure that the data you send over
that the front-end part can understand
it and how does it all work together
and we also want to separate the logic
of the view and this is a nice way to
enforce it so if we go back to our
compute function we had earlier where we
didn't really do this well because the
business logic is addition and what
we've done here well we can't run
addition by itself in this case we have
we always get back in an action that
already render staged and we can put
turn this into an API so yes we're a
good
we refactor this so we can now write a
JSON renderer and yes and send Jason out
and now we can define our API of the
combinators and everyone's happy for a
for a while but now when you write the
front-end you want to interact with your
back-end and you want to make sure that
this communication works in the type
safe way as we're used into like calling
functions internally in our program so
how do we communicate well we can just
use ght J's now I I tried a lot of
different approaches to to to write
functional front ends I started with
just JavaScript and well it went okay I
I wrote a big application and it worked
and then I changed put in some features
and it worked and then maybe one day it
was really a pain to put in more
features and yes so looking around I
came across I tried out M which is
basically it's a simple programming
language doesn't have many features it
doesn't have type classes it doesn't
allow types that are not of kind star
and out of kind star Aerostar it's only
in types of cancer are allowed and it's
pretty easy to learn it has a nice
programming model so I tried out that
and wrote some actually code that was
actually ship it shipped into production
but they change the language pretty
quickly and so you you always have to
they do breaking changes everywhere and
they don't allow I was JavaScript and
there are some problems but the main
problem was also that you sometimes want
to share code with your Haskell code
base but you really couldn't and so I
really rated G as gjs and I figured out
yes actually it works pretty okay or
actually works awesome you just have to
do some little tricks that I'll talk
later to do
make it to make it smooth yeah so how do
we do this and now this is an example
for my from our trend cloud application
we basically have three packages we have
the DRAM clouds our package that
implements all the business logic then
we have a trend log API package that
just describes what our API looks
alright in Haskell types and in spock
group spot routes basically and then we
have the front-end code that is suit and
that is intended to be compiled by ghz
GS into running in the browser yes
so how do we define our API will we just
write Haskell types here we use Jason
for serialization and pausing it has
some problems for but just to keep it
simple here so we have a login request
it takes a username and a password we
have a login response that says login ok
log-in failed and we have an endpoint
that's supposed endpoint it's accessible
at API slash user it's our
authentication and it takes the login
request and it returns a login response
so you have it all there in simple
Haskell types mostly without any yeah
now and in the server part we now have
to define the endpoint so we just hooked
the endpoint into the application and we
write our business logic and write and
on the client side it's pretty cool
where you have this common Eider called
call endpoint we call it with with the
definition login user and we supply the
request type and we get thanks
better alright so we call we used the
call endpoint function and we've
supplied them the path we defined in the
request they get the response and it
basically from both points of view it's
fully type safe and it looks like we're
essentially just calling a local
function maybe a little bit more more
going around but it's basically that
okay so behind the curtains of course
then you have this this called endpoint
will then make an IAC's request and
serializes to J's and send it off to the
server that will pause it and do the
function that we were defined earlier
then this will back to see we serialize
back to Jason and we will go back to the
client which were posit and then we can
go on here what's also really cool is
that if you're if you were writing
JavaScript before you would have a
callback here write a callback callback
to a callback to a callback to and so on
and here it's just a monad right you
don't notice anything about callbacks
it's the runtime engine will then
probably just to spend the your current
execution flow and do something else
maybe and then when the HTTP request
actually returns then we can continue
here but it's it looks but you don't see
it as a user and you don't care about it
as user actually it's just annoying with
all the callbacks okay now I said
earlier we when we define our types
we'll just go and and oops and use Jason
here now if you use Jason like I did
here you have to be a little bit careful
because you can only add optional fields
to your data types if you do anything
else and you deploy it to your to your
customers or wherever you're going to
deploy and you have a single page
application you're going to run into a
problem because your server now sends
the new data type and of course you also
shipped your client save us javascript
file mmm but the users still have the
browser window opened or the user had it
cached or is behind a proxy that caches
for them so you don't they don't get the
new client
cold yet and if you add it if you change
this factor for Jason then everything's
gonna go wrong so you can only add
optional fields which can be maybe a
restriction another option could be is
that you use protocol buffers these will
if you follow the convention that are
composed by protocol buffers then it
basically will make sure that that
everything will just work and you can
also either you can send it over the
wire as Jason or you can also send it
over the wires binary because you're
using gjs there's no problem it can also
pass the binary but you have to we'll
have to add some tooling for debugging
of course because you can't go into your
chrome console any more and just look at
the Jason request you're gonna have a
binary blurb there and the last option
is you version your api's so you have
start to have login request version 1
login request version 2 and then well it
will work but it might significantly
increase your code size so now in the
next question comes up do I use these
types from the IP I package I defined
earlier internally or not so we have
this login request type we defined in
our API type but inside our server and
inside our clients we also have to make
a model off of this word right so do we
just use the types of the API to in in
our model or do we make a custom model
well I think that you you have to bite
into the Apple in this our apple and
define the model for your server
application in your server application
and then write marshaling conversion
functions because if you use the API
types everywhere and don't convert
between the models then every time you
change something internally in the the
model on the server side it's going to
leak out into your whole application
maybe the client didn't even care about
it but it's still gonna be there and
you're gonna have to deal with it or if
you were loading some information from
the database and you have to filter it
first and you don't even want to send
this to a client then you
also gonna haven't run to a problem so I
think a good advice is really to just
write the API functions write the API
data types and then write serialization
functions which yes and also if you use
protocol buffers for example and there's
code generation and the types that are
generated from from the current has the
protocol buffer package are knots that's
convenient to use for everyday use and
that's good to know but always if you
use these generator types and it's not
very convenient than you everyday use
there's also some implementation that
uses generics to to annotate your your
data types with broker buffer
information but the problem is you using
generics and if you require it to be
really fast then it won't be fast I did
something I did this first and I did
some benchmarks and turnout that was a
that actually was a bottleneck and large
data types so right so now we have a
project and the building is actually
really cool and simple
thanks to stack so you just put it up to
stack files one stack Toyama that's just
basically your your usual thing and then
you do one with 4 GH CJ s and basically
you have to add in the in the stack file
you have to add some annotations about
where you where it can find the compiler
because there's currently no release for
th CJ s so it has to download some some
I don't know zip file or what it is from
from somewhere and it also checks
against the hash so it's not just
anything you're running their pods yeah
but it works perfectly and then when you
run ght to s you get a big JavaScript
file a big big big JavaScript and maybe
you also want to interact with some
JavaScript package that already exists
so for example for NPM Jess
so you I have to link this I'll call it
linking this stuff in there so because
in GHz JSU can do Fi pretty pretty
easily and pretty simple and it would be
a shame not to use it because you don't
want to reinvent the view for everything
yes so an example would be you could
just call browserify on that to resolve
all the require statements and then at
the end you should run a closure
compiler from Google or the uglify J's
compiler over the the final output to
make sure that you don't send a really
large JavaScript binary to it to your
clients I think mine was like five
megabyte and now it's one megabyte and
you would say oh that's still a lot but
then I checked before using it GHz is my
JavaScript my all my JavaScript file
with all dependencies was also one point
something megabytes large so it doesn't
it from my experience it doesn't really
make it that much bigger sorry sorry
yeah so actually and also this is the
raw JavaScript and most more and web
servers also do some gzip compression on
it so then your you can you go down to
some hundred kilo boy they're like 500
kilo byte or something like that yeah so
the only kami I found with with this
setup was that when I use the closure
compiler with advanced optimizations it
didn't work I think in Internet Explorer
8 or something like that and and the
problem is that it's difficult to debug
this stuff so because then you have to
go into your virtual machine that runs
first you have to find out how to our
Internet Explorer 8 then when you manage
to install it and then you fire up the
developer console but then developer and
so it has to load up
one megabyte of JavaScript and it gets
really confused and you have to have a
strong machine to really find out what's
going on and if you look at the output
produced from JD CGS it's it's I or for
me after it's run to the grocer cavada
it's really hard to understand what the
hell is going on so yes so you're a
little bit a little bit on your own
there but I just hope that you don't
have to support it in Explorer 8 yes
small anecdote that I could tell here
was we were shipping this air map
earlier and we did some measurements on
the tram tracks during the day and then
the afternoon we went to the office to
look at the results and this guy fired
up his his workstation and the first
thing I saw was he launched in an extra
8 so I was like ok I never thought about
doing that myself but let's see what it
what it does and he locked into the side
and yeah we had a blank website so I
went home it was already late in the
afternoon so everybody was happy that we
could actually go home and I said I
promise that I will come back tomorrow
and we'll have it working and so I spent
the whole night installing some
polyfills and doing messy stuff but the
good thing was the EM compiler actually
produces JavaScript that you can kind of
understand so you can kind of see where
it goes wrong so that's one thing you
actually have to keep in mind when you
use gjs when it goes wrong I think some
people actually that are familiar with
ggh teach is that they can maybe make
some sense of what's going on but I
personally like I couldn't and and then
you think okay maybe we leave out the
closure compiler we just look at the ght
J as output but then you have to run a 5
megabytes of JavaScript in your internet
explorer I hate console of debugging
thing and yeah yeah right
well now back to spark there's more we
have lots and lots of lots of features
and but not too many and they're all
pretty simple and easy to use and they
all have the goal of providing just the
minimal set you need to build an
application without implementing
sessions without starting to pass the
cookies we have some database pooling
we'll help you we have now improved our
as cross-site scripting protection and
we have these type save contacts that
I'd demonstrate yeah yes exactly so on
the end what you get out you define all
your routes and then you can you can
compile it you can turn it into a
middleware and then if you want to have
it as a middleware you can just plug it
into it as a middleware and your whi
application or you can also compile or
turn it into an application which
basically returns a 404 error if you
middleware doesn't do anything so and
you can also do right w8a I am middle
grass using Spock so it will go to work
without problems and as I mentioned
earlier the the Scotty routing
implementation it was linear so if you
had lots and lots of fruits it's pretty
slow and in its park it's a smart I just
prefix based routing so it's also pretty
fast so at the end you you're there and
you have to choose which framework which
which library is the best for my web
application project
I like Spock it's cool but maybe my
choice is a little bit opinionated there
so I I think they're they're all pretty
cool and so I think I think I would just
encourage you to to try out what what
looks the coolest to you and see how far
you can get and then to choose what you
like best so I I would advise it you
Spock but I think that all the
frameworks they they bring this core
core message that that the Haskell
program language is really a good thing
to do web programming and because you
get lots and lots of elements and you
eliminate lots of bugs and errors and
security or that it would have put in in
other languages so I think more people
should start writing web applications
and more people should talk about
writing web applications and Haskell and
show how it worked out and
what didn't work out and I think then
we're on a good route right yeah that's
it thanks for listening and now happy to
answer questions you're not trying to
walk but I don't know I never seen
anyone has implemented so I think
there's only what you can actually run
it with or that's actually a production
quality to run it yes other questions
yes okay so the question was if we can
or if I implemented a library that does
a high level authentication where you
basically authorization yes yes
authorization so where you have roles
for your users and then you basically
define which which which resources can
be accessed in which can't and well I
haven't I haven't written a library yet
but what I did internally for for
example for this trend cloud project is
I wrote a small DSL that essentially
that does that so it's pretty actually
it's pretty easy to add it on top of
this context concept that I presented</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>