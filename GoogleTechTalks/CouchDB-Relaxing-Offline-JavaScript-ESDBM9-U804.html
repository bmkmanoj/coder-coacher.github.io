<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>CouchDB: Relaxing Offline JavaScript | Coder Coacher - Coaching Coders</title><meta content="CouchDB: Relaxing Offline JavaScript - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/GoogleTechTalks/">GoogleTechTalks</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>CouchDB: Relaxing Offline JavaScript</b></h2><h5 class="post__date">2009-09-25</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ESDBM9-U804" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hi welcome to today's tech talk my name
is Steve Souders I work here at Google
on web performance and I call this set
of Tech Talks web exponents where we
bring in people who are tech leaders out
in the web community to come in and
share what they know and today I'm
pleased to have Chris Anderson here
talking about couchdb so quick bio Chris
just relocated here from Portland down
to Berkeley so he's in the area now and
I said it would be awesome if you would
come by Google and do a tech talk so he
agreed to do that he's a committer on
Apache couchdb and he's working on in a
Riley book they'll come out soon I think
he's got I see a subsequent slide here
about it couchdb the definitive guide
and so he and I and Doug Crockford are
going to talk later about all the money
we make on the royalties from our books
because tech books is such a huge
industry and I have this one oh he's
also director of couch IL calcio you can
check that out and he has this one quote
in his bio about being obsessed with
bending the physics of the web to give
control back to the users and so you
know there's some humor and perhaps
exaggeration there but not really i
remember first talking about performance
and people said well you know there's
just the physics of the speed of light
there's not much we can do to make
websites faster and it turns out you
know with smart engineering and some you
know cool architecture you can make a
significant difference in the user
experience so I'm all about bending
physics too so without any further ado
please help me welcome Chris Anderson
thanks for having me Steve and thanks
for coming out to hear about couchdb I
really am interested in bending the
physics of the web and you know in more
than just a performance way but we'll
talk about the performance of it too so
just to say a little bit about me
although Steve did a good job I'm
jaychris on twitter if you want to get
back to me that way i'm working on the
couch DB definitive guide book I came
into this whole working on databases
world through being a web developer I
used to do PHP and then I got into ruby
on rails and then I started using
couchdb in a project that made my life
just so much easier so that that's how I
got drawn into CouchDB so before we get
started I've got some some questions for
you all so I guess you know some of
these the answers going to be obvious
how many people here have built an
application on top of a key value store
instead of a relational database all
right so a lot of times not so many
hands go up it depends on the
environment you're working in and so how
many of you have written MapReduce are
functions all right yeah not it's not a
stranger to MapReduce here and then how
many people here have worked in Erlang
alright so that's the that's the
defining characteristic I think that
makes cash to be a little different from
what you do at Google here and that's
early but before we get started we have
to look at the slogan of CouchDB which
is relaxed and ask the question asked
the question why is that the slogan and
it really goes to the core of what we do
in in CouchDB in a lot of ways I think
for me the most important meaning of
relax is that the is that couchdb should
be easy to reason about and so that
means if you should be able to look at
the API and have it makes sense to you
you should be able to diagnose failure
conditions in a simple way generally it
shouldn't be surprising but then for
users you know relax means relax your
data is safe with us we pride ourselves
on having a very reliable storage engine
and i'll talk more about that later but
reliability is is our number one concern
where we're not trying to build the
ferrari of databases that's a popular
sport these days but
we're trying to build the honda accord
of databases and i think that's a little
bit of a different sweet spot so then
the last meaning of relax and this kind
of this kind of goes to the easy to
reason about but you know when we're
when we're debating in IRC among the
developers how to implement a particular
feature what a particular parameter
should look like if you can say well
well this option is more relaxing then
you're probably gonna win the argument
so so yeah we're talking about couch to
be the guy on my shirt is kicking back
I'm going to kick back now we can all
relax so let's talk about the the see
we're swimming in Google's familiar with
the internet it just keeps growing right
there's like more internet all the time
the the curves are all up and to the
right I've got so much internet here
that I'm doing my IRC and checking my
maps at the same time and you know now
I'm checking in code well I'm drinking a
beer at the cafe and this guy has so
much internet he's got a camera strapped
to his face and that's a prosthetic
finger with CouchDB running in it true
story and these guys have so much
internet that it's it's on their heads
they're overflowing with the internet
and I guess it's just going to be more
and more like this always more internet
all the time always faster always more
and then oh no what happened he had so
much internet your router melted and or
you've got no bars because you're down
there and these situations are getting
to be you know farther and farther apart
these days because there's more
connectivity but no matter what we do no
matter how much fiber wheel a latency
still sucks and the speed of lights not
getting any faster so the you know one
way to to fix this is to move the
services closer to the users and so
that's that's what I'm gonna be talking
about answering the question what is
CouchDB so you know what is couch to be
is it a key-value store with MapReduce
yes is it an HTTP data base rate in
Erlang yes but the real answer to what
is CouchDB is it's a local web platform
and so that means that it's designed
around a you
case where the application runs on your
device or on your local network or in a
browser plugin so you've you write your
application and you just just run it on
on whatever you've got close to the user
the reason we can do this is because
we're designed from the ground up around
offline replication so it's a little
similar to the Lotus Notes philosophy
that your data should be able to move
with the users but the way we do our
replication makes it really easy to do
offline work to do ad hoc cluster kepala
geez you can do real-time remote backups
it all just becomes a simple primitive
operation that you can trigger with an
HTTP request so we'll talk more about
about replication a little bit but first
about the implications of these these
local applications as opposed to cloud
computing we like to call it ground
computing Jason Huggins is the first one
that I heard say that in in the couch
dbcontext but this is this means you
know local to the user it's a little bit
more like the desktop then it is like
gears or html5 local storage although
you know we are talking about browser
apps here couchdb is an HTTP server that
runs on the end user's machine that runs
in the cloud the applications don't care
where they're being served from and that
allows you this really nice luxury when
you're writing applications to be
offline by default so how many people
have started thinking about taking a web
app and adding offline support using
local storage or gears or whatnot so you
end up doing this thing where you've got
your back end application that's got all
kinds of whatever it does and then your
browser application and they're talking
through a protocol and that protocol
probably doesn't mirror the protocol the
browser application uses talk to your
local storage so you end up with you
know even more of you know these
impedance mismatches between your your
data store and your object model well
with with the CouchDB offline app it's
the same application it doesn't matter
whether it's being served from the
server or being served locally and it's
just a two-tier application
if you build your application so that it
can be offline then it's just going to
be some stuff in the browser and CouchDB
then you're done so there's a there's a
quote i want to read from jacob kaplan
moss and this came out in october two
thousand seven when i was first hearing
about CouchDB and really kind of sent
shivers down my spine and you know made
sure that i went back you know maybe it
took me another month before i
downloaded installed and you know tried
it out a little bit but i'll read the
quote and then i'll tell a little story
about how it got that way so let me tell
you something Django may be built for
the web but CouchDB is built of the web
I've never seen software that so
completely embraces the philosophies
behind HTTP this is what the software of
the future looks like and you know maybe
that's a lot to say about you know a
little Erlang database thing that you
know runs in your browser maybe but the
it rang true for me and you know rings
true to other people who look into you
know and start building applications on
CouchDB so when I was first talking
today me and when I first met him and
was Damien cats as the creator of cash
gb and I was talking to him about the
process he he used to get to CouchDB you
know I'd sort of had in my mind that
that it was discovered not invented and
I said that he said exactly I was I was
programming around in the wilderness you
know trying different things I knew I
wanted to build like a distributed file
system or something and you know then it
all started to fall into place and and I
realized I was at the perfect spot and
and by the perfect spot like you know
there's there's couch to beat it's got
all this nice self-similarity the
engineers really like to see when we
look at the way things are implemented
but but the perfect spot when when I'm
saying it here means it's a web server
that serves up your data and you know
makes it so that it's very natural for
that data to be replicated and to be
transformed into views and into you know
HTML renderings and and whatnot it's
just it makes everything that you have
to do is web developer more relaxing so
fully hopefully I'm not selling it too
big right now but you know you can tell
I believe in it at least so here's an
example of how we're of the web the
couch TB test suite is written in
JavaScript and runs in the browser this
means that it's really easy for new
contributors to get involved because
everybody knows enough JavaScript to
write a test case but that's not you
know that's not all that that makes this
you know in my opinion better suited for
testing couchdb then say some some unit
tests that you know run in the
development environment and one of them
is that you can validate your
installation so if you if you run couch
to be behind a proxy or behind a series
of proxies then you run the unit tests
in the local browser and you know
whether or not you're getting inch to
end acceptance and you know maybe just
one request is breaking or one features
not working and that becomes immediately
apparent but even more so you know me
with these grandiose visions up here I'd
like to see CouchDB as a protocol and in
order for that to happen there need to
be other implementations so you know if
you're out there and you want to hack up
a quick Ruby script that passes these
tests you know please do it would be you
know that satisfied and feeling of
getting to green over and over again
until you get all your all your tests
passing so that's about it for the
standard elevator pitch but I put in I
put in some elevator pitch for Google
because I know that Google has a an
interest in bringing up new developers
and making sure that people outside the
organization understand MapReduce and
understand how to build scalable web
applications and CouchDB is you know a
great it's a great first step into the
programming model that you have to use
at scale so you end up modeling your
your your reads and writes around
concurrency because we have multi
version concurrency control you want to
avoid you know people stepping on each
other's at its and everything that
CouchDB outputs has etags and it's
cacheable and so that means that it
introduces people to the idea of pure
functional transforms from their data
to a user interface and then eventually
eventually consistency you can't run
anything at scale without the idea that
you know a safe might take some time to
replicate you know to become globally
accepted by the system so document
modeling is the the the unit of a key
and CouchDB is a document which has a
multi version concurrency control and
that's every time you save a document
you need to you need to return the Rev
token that you had last time or you had
when it loaded otherwise if there's a
Mitch master on the server then you get
then you get a precondition failed error
and an update conflict and so you end up
modeling around concurrency there's a
there's a couple of patterns that I'll
talk about later that that makes sure
that users don't stop on each other's
edits and that really make sure that
developers understand the difference
between an edit a user makes and an edit
that the machine makes so if you have
people coming in who know how to write
CouchDB applications they're going to be
that much closer to to being you know
ready to get their hands dirty at Google
so let's let's get technical let's talk
about the actual CouchDB api's and and
the storage engine and whatnot but
before I get started on that does
anybody know what this is any recognize
it cool we got one it's look it's the
clock of the long now it's a it's the
Auraria which is the gear set designed
for keeping time for 10,000 years so the
idea that something could be that robust
is is really inspiring to me I don't
know if our if our data file format is
that robust but you know we want it to
be as robust as possible there's robust
key robusta kitty says you know we're
not going to we're not going to corrupt
your data so what makes the file format
robust it's an append only file so that
means that once bites are written to the
disk we never touched them again you
know it's like it's journaling all the
time it's an append only be
tree so the the big the big win we get
out of this is that if there's a crash
there there's no fix up phase there's a
it's always consistent on disk so
couchdb was inspired by some computer
science papers that Damian cats found
you know while doing his research the
you know tested a crash only designed
versus a design where there's a shutdown
command for your application so couchdb
has no shutdown command to stop a
couchdb node you just kill dash nine it
and that's as that's as good as any
other way to stop it so crash only
design really you know means that you're
not going to be sitting there waiting
for a weekend while you're my i Sam
table rebuilds or you know whatever sort
of things that that we don't really like
thinking about now one of the side
effects one of the benefits of having
this depend only file structure is that
we are we very rarely seek the diskette
and so you get some nice performance
some nice performance wins out of it
this is a benchmark that into feral at
the BBC did they were doing a shoot out
among key value stores to decide which
one to use for their new back-end
infrastructure there now they've moved
into production and they're slowly
replacing parts of the infrastructure
Witkowski be but you know sort of the
final phase it is KGB vs memcache giving
and the you can see right here to
beginning that memcache TV is way faster
the couch TV for for accepting rights
until you get outside the working set
this benchmark goes on for two days yes
it's like the clothes because the
right here transactions per second or
underpins scales but what generally
CouchDB you know starts out basically
the speed under dish and then you get
that expected order log in performance
as the b-tree gets larger but they were
really happy with this they now have it
running on on a cluster in two data
centers with automatic failover and the
thing that end I said that you know
really made me feel like this is a real
deal when Britain is burning everyone
turns to the BBC and if you're the ops
guy for the BBC you probably can't get
to work that day and so they really
needed something reliable something they
could trust and so it makes me happy
that that they went with couchdb so
that's that's the file format really you
know to be the honda accord of databases
you need to not have to go to the shop
that often and and that's why you know
we chose to design it like this so JSON
documents I assume everyone here is
familiar with JSON sorry about the
typeface it doesn't have lower case
letters so imagine some of those are
lower case letters but CouchDB just
stores every document as a as a JSON
object there are two required fees in a
CouchDB document there is the ID and the
rev the Rev already talked about is the
multi version concurrency control token
it it ensures that whoever saves first
when you never get you never save on top
of somebody else's work by surprise the
ID then is its unique within a database
which each database is a flat namespace
and it determines the URL so if the if
this database was called you know Star
Wars then the idea of this document
would be star wars / bc 4 EI blah blah
we use you you IDs by default so that we
don't have to check for existence of the
ID before you know before doing a right
we can just assume that there's not
going to be a collision thank goodness
for probability right
you know you you ideas do have a little
bit of a cost in terms of storage space
but we're more interested in reliability
and being easy to reason about then than
you know shaving every last bite off of
every request now there's a there's one
thing about this about using these JSON
documents that are schema list if
someone can just go and change dark side
to more cowbell and you know it's still
a JSON document it's still valid as far
as as far as couchdb is concerned I
should I should mention now that there
are validation functions that run in the
server written in JavaScript they can
you know require for instance that dark
side must be a boolean value so there's
a you know there's some good sides and
some bad sides that come with with a
schema free design I think the good side
is that it's flexible in that you can
evolve your data with your application
as you add a new feature you don't have
to go do a modify table to add a bunch
of stuff to the you know the old data
that's already been recorded you can
just account for it in your application
with if statements or whatever as you
would have to do anyway but I think the
bigger win for for a schema free
document model over the relational model
at least for me personally is that when
I go back in to dig into an application
that's you know been in maintenance mode
or whatever it's a lot easier for me to
bootstrap the the application model up
in my head when it's a document because
you just get the document you look at it
and make sense and if you but with the
relational model you have to you know
figure out what query do I run to pull
sense out of this database and you know
then you have this whole other thing you
have to bootstrap up in your head before
you even have the application so I think
it's a little simpler a little more
relaxing for developer productivity too
so you know one one side effect of
having the flexible schema is that you
end up having to duck type things a lot
so i put in a duck everybody likes a
duck so you'll duck type things in in
your map reduce functions or in your
application so
I want to talk a little bit about couch
jeebies MapReduce implementation it's a
little different as far as I know I
haven't had the pleasure of working on
the Google Map Reduce but as far as I
know we're the we're the only
incremental MapReduce store out there so
what this means is that you write your
map produced functions and their
computed over your database initially
and then as new edits come into the
database the index is brought up to date
to to reflect those new edits and it's a
you know it's all transparent to the
user and it's all you know optimized
there's you're not paying additional
cost to rebuild the entire index every
time so it allows you to do MapReduce
indexes that are that are online that
you know are consistent with your
initial data set the other thing that is
the you know sort of falls out of doing
MapReduce incrementally is that the
reduced queries can be run across
dynamic ranges so if you have a reduce
that say counts the number of you know
blog posts in a given date range then if
you do the reduced with no start key and
end key you'll get the count of all the
blog posts in the entire database and if
you do start key at the beginning of the
month and the end key at the end of the
month then you have the count of blog
posts that are within that month you can
also do group queries which is
essentially you know it scans through
the index and breaks it up according to
the if your key is an array the elements
of the array so essentially you could
get you could have one index that would
tell you how many blog posts there were
in all of 2008 and that same index can
tell you for each month in 2008 for each
day in each month and you know whatever
granularity you choose without you know
without having to build multiple indexes
and with an order log in query time for
for each query so our our MapReduce
functions are also written in JavaScript
this makes it really easy to get started
but also it makes it you know really fun
to to program in there's no better
language for manipulating JSON than
JavaScript so
I think I think that that's that's at
least pretty obvious I don't know some
languages come close but but I really
think that you know the native the
native language is the one to use so
this is a snapshot from from Ricky hose
blog post on the couch to be
implementation of the way that the
indexes are stored and I just want to go
up and just stick you late it that a
little bit so that people can get an
idea of what's happening under the
covers there so this is this a logical
view of the b-tree the values here are
essentially the was emitted by the map
and the cookies there are also the keys
emitted by the matter up in the up in
that second layer and then for each
vietri block for all it for all the
intermediate nodes in the b-tree the
production value is stored so if you're
reduce is a row count then you would
restore a number of rows with that block
ads below the production value is the
standard deviation of the values of the
map emitted then you would store that
standard deviation there in the
intermediate reduction value and that's
what allows us to go in and query for
dynamic reduce ranges and get the get
the correct result back if you write
function properly to and to do that
without you know the amount of cost of
actually loading up all those key value
pairs and running the reduction across a
week and use an intermediate value as
one possible and when you're concerned
about the edge of the range then you
might have to go down and grab a few key
value pairs that's on the data set to
relatively reduce this means that your
reactions have to be commutative and
associative but most of them are anyway
so this here is a picture sort of a
representation of the of the audition
format so what happens is essentially
let's say we're changing p6 here or key
sticks here so what we do is we seek
back into the file 5 p-6 you know load
the logical representation of the b-tree
up into memory and then when we go to
commit that at it we commit first we
write the key value pair then we write
the you know the intermediate node that
points to it and then we rewrite under
any intermediate nodes that may have a
point to that node all the way back up
so the last thing we write every time we
commit data is the bee tree root so you
know there's there's an additional cost
in terms of recorded data but generally
it means that you get an order log in
prosper for updates and and you're going
ahead and rewriting all that stuff
anyway for reliability so you may as
well report the new reduction values
while you're doing it the view indexes
use the same use the same file format as
the database so anything you learn about
the view indexes applies to the database
as well so that's the map produced views
does anybody have any questions on that
ok so let's talk about HTTP the couch
should be has an HTTP interface it's
restful as you know as far as we can
make it without getting too pedantic and
the you know the hallmarks of it are
that you get a document from its URL you
can post to a database to create a new
document if you don't care what id it
gets you can delete a document its URL
and then you can put to a URL to create
or update a document if you if you're
creating a document you already know
what the idea is then you put it there
if you're updating in a document then
you put it back where you found it
we did a bunch of sort of interesting
work to make sure that put is idempotent
even in a cluster and that's sort of
interesting I could talk about that
later but we really take being restful
seriously because it makes it easier to
reason about it also means that we can
leverage 15 years of tools that have
been built in you know ever since the
web started so you can put couchdb
behind squid or behind apache you can
you know monitor it using regular HTTP
monitoring tools if your ops team knows
how to scale your your web tier then now
they can scale your database to your
using the same technologies now this
also means that it's a mash-up a bowl or
remix the bowl the way that you know
normal web stuff is and one really great
example of that is a project called
CouchDB lounge which was originally
written by meebo to build a couch TV
cluster because all the stuff I've been
talking about couchdb is designed to run
on a single node but it's designed
always keeping in mind that the API that
presents shouldn't have to look any
different if it runs on a cluster and so
this was all you know in our heads and
on the developer mailing list we talked
about what would the architecture looked
like we knew eventually we wanted to you
know have a cluster capable version of
CouchDB what would the architecture look
like you know now we've got it kind of
planned now it's going to take all
summer to build it in Erlang and and the
next thing that happened was meebo came
along and built something that used the
same architecture using an engine X you
know see plugin and some twisted Python
so they're just using engine X to do the
consistent hashing and then the twisted
Python to merge the view queries so uses
a scatter gather architecture for the
for the view queries but the cool thing
about it is you run this couch TV lounge
you put it in front of you know however
many nodes I think that me boats are
running it on a 64 logical nodes sharted
on to like 12 boxes or something right
now but you get it deployed like that
and then you
run that JavaScript test suite that I
showed earlier and it just passes so you
know what's cool about that is like now
all of a sudden those node those lounges
are just couch newbies and if you get in
a pinch where you need to grow your
cluster well you can just make a lounge
of lounges and have fractal scaling I
mean it's you know it's it's not news
that that's the way you would scale
something like this but it's really cool
that you can do it all in the HTTP
domain and in the fact that we've got
etags on everything allows you to have
some of the intermediate nodes in the
tree do caching and you know keep the
latency down even if the tree gets kind
of deep so the backbone of all of this
is replication and I should talk a
little bit about replication so so
you've got a couch like no big deal you
got some data in it now you've got two
couches and you want to you want to
bring them into sync so you just post
this JSON object at one of the couches
and say replicate from remote db2 local
DB and it's done any changes that have
happened on the remote DB since ever
since the last time you replicated get
pushed over and if you do it again and
only whatever changes happen since then
get pushed over so there's actually two
modes this is triggered mode where just
does a push of the changes there's also
continuous mode where the target DB or
rather the replicator subscribes to a
comet feed of the source DB and waits
for update events to come through the
comet feed and then pushes those update
events into the target DB and so this
allows you to do a bunch of fun
topologies you could do the real
standard master-slave load balancing
thing that you can do with mysql or
whatever where you just ship all the
have all the rights go here so put a
proxy in place the sins all the gifts
over
everything else of this couch and then
just good replication happening and when
you've done that then you can put a load
balancer across it all and and you've
got you know you can scale your read
requests the nice thing about it though
is that because of the way that then we
maintain the indexes for replication it
can be bi-directional it can be ad hoc
in in all sorts of whatever ways you
want to do so you can now you've got
multi master and two masters is you know
that's that's doable in a mysql
installation three masters with a little
bit harder and then you know when you
start talking about in master then now
how you have to have you know somebody
who's who's managing the you know the
global agreement about IDs and whatnot
so for us we don't have to worry about
that because of you you IDs so we just
have all the Masters we want we're
eventually consistent if you load
balance this then if one couch falls
over your load balancer drops it out of
rotation the users are none the wiser
you can also do some useful things like
this imagine user transatlantic cables
here this is the primate for your career
East Coast users and those are your your
London users or UK users and this is
offline backup that you use for
reporting job to what you have another
one in Europe so you could set that up
pretty easily if any of those links
walls down all the individual couch TVs
are still useful and if the only comes
back up they bring themselves back up to
date so what I get interested in is this
topology where everything is a couch and
couches are everywhere and this is my
laptop and this is the computer at work
and this is my phone and they're all
replicating around my contacts database
and
maybe change a month all he goes to work
and he goes with other people in my work
groups contact list so you know you've
got to write the application to do that
couch to people just make sure the data
gets shipped around but I already talked
a little bit about how writing the
applications is simple so one thing you
know one thing to think about is that
since each couchdb database is a single
flat namespace of documents usually
named by you you IDs after everything is
replicated you know in the fullness of
time there is only one couchdb because
it all just you know comes together but
you know that's assuming that everyone
replicates with everyone so I'll have to
wait for that one so now there's there's
some conventions you have to follow if
you want to get that offline mode for
free stuff and the simplest thing is
that your application itself is packaged
up inside a couch to be document so
you've got a document and how should be
recognizes this documents special it's a
design document it contains an
application and it unfurls it into a
wonderful beautiful running application
you know with the flower icon there and
so once your applications are documents
then they just replicate like other data
and it makes you know makes sort of a
whole new way of deploying stuff
possible but but can this actually you
know be done it is just practical so
we've got to scale down we need couch to
be to be running at the edge and it's
not you know it's not super easy
Erlang's on our side with this one so I
checked I checked last night and even
running the test suite which is like
doing things like triggering replication
over and over again and causing crashes
on purpose and whatnot you know so it's
sort of abusing a CouchDB the memory
usage stays below 20 megabytes which i
think is pretty fair for a database it
used to be smaller but we're faster now
so that may be one of those one of those
classic trade-offs I
I've heard rumors of couch gb of Erlang
couch running on the arm processor this
is definitely got to be running on the
open sea and there is a couch that runs
couch TV but you know uses it to store
user profiles so so think about a couch
with user profiles it's actually it's a
robotic massage couch in it massages you
according to your last.fm listening
history so there's you can do all sorts
of things with it but maybe getting our
lang you know into a tiny footprint
isn't enough because you know certain
you know there's politics and whatever
people want to run their stuff in C or
or you know accepted environments so a
tool Varma wrote this started this
project called browser couch which
allows you to have a couch that runs in
your browser as part of the web page is
just a JavaScript library that uses
local storage or whatever is available
in a local browser and replicates with
CouchDB it's not done by any stretch of
the imagination but the important parts
are started and you know the idea is
that you can write couch apps that don't
even they don't even need a real CouchDB
but they can still be full-fledged couch
absent and replicate to the users
computer and whatnot so this gets me to
the thing that I'm really excited about
which is giving control back to users
because when the application lives on
the user's machine with the source code
and everything right there then they can
just flip it over change it make it fit
their needs better share it with their
friends I mean you know if you ever see
a kid program it doesn't make any sense
what they do you know they're right like
the craziest stuff I mean that's what I
did and and it works for them I mean
like a program that's you know sort of
like half broken and crazy but is your
program is a lot better than you know a
perfect program that's for grown-ups or
a perfect program that is for you know
inventory at an organization it's not
your organization so if you have you
know your little inventory program for
running in house or whatever it really
is yours then you know how to change it
you know how to customize it you know
how to personalize it I think you know
programming is empowering and it's
empowering for two reasons one is that
you
make something awesome and share it
without really asking permission but the
real reason the thing that got me into
is being able to personalize stuff being
able to take applications that i was
using and you know make them a little
bit more mine I really you know I I'm
not so much trying to like make a tool
for teaching kids how to program I just
want to make an environment where kids
get in trouble for programming too much
because you know that but that's how
that's when it really gets good so so
that's enough of the of my sort of
ideology of wanting to you know empower
users but I think it's really an
important point and it's what got me in
the cash to be you know in a serious way
so who's using it so I talked earlier
about the BBC and meebo there's a few
startups using it mozillas really in the
couch eb IBM employees damian cats
full-time and this is you know far from
a complete list there are also a bunch
of these little couch apps a bunch of
applications that run on a standalone
CouchDB so you know we've got a sort of
gallery of processing j/s sketches we've
got a real time shared group where
calendar we've got a Twitter client that
lets you do word clouds of you know the
popularity of words that people say
based on the archive of what they've
said you know one of the other couch to
be committers jason davies even switched
out the one of his one of his consulting
clients websites from a django app i
think into couchdb as a standalone app
with just a little bit of a rewrite
proxy in front to make the urls pretty
and it literally didn't look any
different and no one could tell the
difference except for he did that as an
experiment to make sure that you can
make anything in it there's much more
here there's you know a few instances of
this blog software that I wrote there's
a couple of online presentation things
and delicious style link aggregator as
well as personal site for for Jason's
wedding
so that's all good but what's really
exciting what makes me think that this
vision is not just like some some crazy
people out on the side saying you know
we can make the web different and and
you know do people more power is
canonical is including CouchDB as a
default system service in ubuntu karmic
which is out shortly and they're using
it to solve the data island problems so
that your contacts and your bookmarks
and you know whatever data your email on
on your machine at work and your machine
at home and you know your phone or even
on a web terminal at the library all
that stuff has access to the same data
and they're making it really
user-friendly it's packaged up in the
ubuntu one service but there's also just
a CouchDB that you can log into on your
local box and start writing applications
they're encouraging the new application
developers to start using couchdb as a
where you might otherwise have used
sequel light or a flat file format in
the past because then the data is
portable and they're doing the hard work
of even you know syncing contacts with
old-school phones you know going through
a proprietary service or whatever does
it have to do in order to make that
happen so you can write a couch TV
application to manage the contacts on
the free phone that you got in you know
2003 and and that's really exciting that
makes me think that it is actually
happening so we can do all these things
and it gives us certain amount of
freedom but but we don't have to we
don't have to go all the way with the
you know apps at the edge those most of
those couch apps that i showed live at
urls their normal server this is good
because people are used to it you give
somebody a URL they go to it they know
how that works now one of the downfalls
of the you know centralized server
architecture is that when your when your
site gets popular everybody hits it at
once and users want things to be fast
you know they care about that low
latency and
as the traffic starts to back up some
people start refreshing and just
snowballs and gets worse you know this
is what happens The Dig effect I guess
is what we call it these days and so
you've got this one server in a known
location trying to serve all this
traffic and latency is the the important
factor there but when you take that same
couch app and the user has a browser
plugin for couchdb or is running it on
ubuntu and can go into offline mode then
they're browsing against the local copy
of the data and the latency is not an
issue is just fast it's also reliable if
the internet goes down there won't
notice right away and now if you if
you're serving one of these applications
if you run the mothership it's also nice
because you get to tune for throughput
and that's simpler than tuning for
latency you don't have to make sure that
every request gets gets responded to you
right away you can just fill that pipe
as full as you can and so if people are
if if your HTTP requests or replication
requests and it takes a second or two
for that replication to get up to full
speed it's not a big deal and then you
can just you know fill the pipe until
the replication is done the users are
seeing low latency responses the whole
time one thing that's worth noting here
is this really place to the strengths of
mobile connections because a mobile
connection is fast enough to stream
video but it takes two seconds to get
started so if you're using if you're
making local requests but then doing
your data synchronization over over the
network the latency on the data
synchronization isn't as important and
it allows you to have fast powerful apps
you know run from some big data center
somewhere but where the user experience
is really slick so if we take this one
step farther and you take one of those
off levant offline apps and replicate it
back up to another cloud host or you
know stick it on a USB Drive and take it
to your friend's house now we're talking
about the period of pure web which which
is what got me all excited and I think
that the the important thing here is
that it makes the applications
independent and in sort of the large
less extents that the application
answers to the user now to the nuts of
the server is hosted on and
so you end up you know probably not only
just sort of the obvious things like oh
I can add a feature that I need that
nobody else needs the standard open
source scratching your own itch stuff
but the idea that users come to expect
that applications respect their time and
attention and they're not going to like
click them through a bunch of extra
pages that they don't want to see just
show ads or whatnot so i think that uh i
think this is sort of a lower energy
state because you're using the network
more efficiently users see things as
faster and it gives them more control so
whether or not it's CouchDB that's the
answer to the question i think that this
direction is an inevitable one and it
ends up looking a little bit you know a
little bit like the desktop but
connected back in the desktop days
everything was an island now we have
these applications that we control but
but they're connected to the web and to
all the data that's out there so what
does it feel like to be a user in one of
these applications it feels like
messaging because you drop your your
message into the replication mesh and
maybe it goes through a bunch of hops
and whatnot but you know eventually it
gets where it's going and eventually you
get the messages that are bound for you
but the you know there's a couple of
problems here one of them is in a big
replication mesh maybe you can't trust
to the intermediate servers so you can
try to do something with certificate
authorities and whatnot but you know the
sort of the closer to the to the shape
of the problem solution is key based
identity and a web of trust solution and
so even if you don't trust all the
servers between you know the place where
your message originated and the place
where you're reading it if the message
is cryptographically signed by a key
that you accept then you don't have to
worry about those intermediate servers
so you end up you know with the whole
key based identity based around that
like I side to this message you know
he's signed to that message it makes it
I think I think it's actually a simpler
metaphor for users then like I'm Jake
race on Twitter
the idea that this message came from the
originator there hasn't been really a
solution that the users were happy about
because I think the reason why is that
people who write these interfaces are
all you know crypto freaks and not
necessarily the most you know sort of
attuned to the fact that computers can
be hard to use but I think that if we
don't try and go for you know complete
and total security but rather you know
secure enough secure enough for informal
msgs not you know secure enough for you
know legally binding contracts if we if
we go for an informal you know a key
based identity I think that it shouldn't
be hard to have have a user interface
and workflow and whatnot that that makes
that intuitive to users so that's that's
the story of where I think all this
stuff could take us you know in the next
five or ten years and when I tell this
story i get i get an interesting
reaction that I don't expect sometimes
from you know from old-school web heads
and that's that this is obvious they
sort of seen the architecture you know
the back in the day the web was really
amenable to new users coming on just
just stick your HTML up you know it's
got your your physics problems in it or
whatever and that's easy but you know
over time as users expectations for
applications have gone from just a you
know a list of my favorite jokes to like
you know an interactive joke ranking
site these kinds of server based
applications have gotten to have a
higher barrier of entry and I think you
know bringing that barrier of entry back
down is sort of returning the web to its
roots and and hopefully making it you
know a more exciting place to be a lot
of the data that that it makes sense to
put into a peer style couch app is
personal data you know personal like
sort of in a sense that i'm not trying
to publish this to the world this is
just the pictures from you know last
week's party and i want to show them to
my friends and the easiest way to do
that is to you know just replicate them
too so their copy of the picture reading
app and we don't have to worry about you
know the permissions settings on
our social networking site making sure
that that they only go to the right
people you just only give them to the
right people so it makes it makes data
interchange a lot more a lot more like
real world use of data like I hand you a
folder full of stuff so I think I think
that this is all it becomes you know
sort of intuitive and and fun for for
users sort of got got some high high
falutin you know ideas but but the idea
when you come down to it actually use it
is it it's really not a big deal so I'm
ready to take questions yeah
director
so the question is if you're going to be
doing lots of lots of quick transactions
in succession is there a way to make it
more efficient with CouchDB and yeah you
really if you're if you're doing any
kind of you know batch operations then
you should be using the bulk API so it
allows you to post an array of
operations essentially at CouchDB
there's really just one kind of thing
it's an update and so some of the
updates can be delete some of the
updates can be creating a new document
some of the updates can be changing
existing documents so you just post to
this big this big batch to CouchDB and
it does the work you can benchmark it it
depends on the size of your data but you
should start out by thinking about
batches of roughly a thousand at a time
and the batches also oh no I'm saying if
you have like a hundred thousand records
to put in stick them in between like a
thousand five thousand at a time if you
and there's some there's some other
performance hints that you can give
CouchDB you can tell CouchDB it's
allowed to build its own batch on the
server which doesn't help with the HTTP
overhead but it does make the files more
compact because you end up rewriting the
the bee tree roots less often and you'll
get higher throughput and the difference
can be kind of astounding in terms of
performance if you just do the single
key value you know gets and puts and
deletes versus doing you know optimizing
the batches for your application it can
be like two or three orders of magnitude
difference in performance so it's if it
looks too slow if you hold this guy
should be too slow then you're probably
not using it like like it should be for
your application so it this is very
exciting thought provoking motivating so
people watching the video want to jump
on the bandwagon can you tell them you
know what are the three things the first
three things you have to do to get on
top of programming with CouchDB like
going to a web site downloading stuff
signing up for a couch cloud somewhere
what is it yeah
let's see I've got to slide with some
links but they aren't the first links
that come to mind so probably the
easiest way to get started if you're on
the mac is with a program called couchdb
X that's just couchdb X one word if you
if you google for that you'll find it's
a it's a one-click installer and it just
runs as an application with it keeps its
data inside the application bundle very
clean it has all the dependencies with
it so that's the easiest way to get
started with a local CouchDB on the mac
if you're on ubuntu then it's already on
your karmic if you're on Windows it's
it's not such an easy story although
CouchDB 11 and trunk is starting to have
official support we're definitely going
to have a windows version of couchdb for
the you know by the end of the year in a
release so that's how to get it you
could also go to hosting couch i oh and
hopefully other services will crop up
offering hosted CouchDB instances and if
you don't want to run it locally you can
run one in the cloud and aside from the
network latency it won't be any
different let's see the if you want to
get started reading the technical
overview at the website that's on the
screen now CouchDB apache org for the
the couch TV book the one I'm writing is
available for free online we're giving
it away under a liberal license so go in
there you know translate it to whatever
language you want read it learn about
CouchDB its books CouchDB org and
there's also a manning book and some
other books coming out so you can always
go get books with your multi-master
replication one of the the challenges of
that is is how to deal with concurrent
updates on different replicas what are
the semantics that you have for that and
is there any ways for apps to customize
that okay so the question is if we have
if we have two couches we got couch a
and couch B and the same key is updated
at the same time on both of those
couches
then they can't reject the update for
being for being out of date because they
both you know have the original version
on here so now you've got two
conflicting versions of the document you
replicate those couches together what
you know what's the answer how do we how
do we handle that and then that's a
great question so the and actually have
slides for it because it's such a great
question so what we do is let's just set
up the scenario so I make this document
I replicate it now I've got the document
of two places I edit it in one place now
I edit it in the other place so now I've
got the two conflicting versions of the
same document what happens when I
replicate well all that happens there is
that we keep both versions it's really
the simplest answer the you know we
don't want to be deciding for your
application how we resolve conflicts we
what we do is we keep all the conflict
heads we maintain in each document
maintains a tree of revisions and we
keep all the conflict heads around until
the conflict is resolved when the
conflict is resolved by an edit on on
any node that has knowledge of the
conflict then that conflict resolution
is also replicated so you know it's we
basically punt on it but we pumped on it
in a way that gives applications the
flexibility to do what they want so for
instance the BBC just has a little bot
that watches the the event stream on
their cluster and when it sees a
conflict occur it resolves it to say
whoever saves last wins because they
figure the more recent data is better
but it's up to your application you the
default which conflict shows up in views
and whatnot it's going to be a
consistent across the cluster so if you
introduce the conflict on that big
replication mesh picture I have
eventually after all the couches
replicate they'll have the same winning
conflict by default but the algorithm
for doing that is just the easiest one
we could come up with it was
deterministic so whichever conflict has
the longest edit history is the one that
wins but the the other conflicts stay
around until the conflict itself is
resolved
so Chris we're running out of time are
you going to be able to stay for lunch
so anyone who has more questions if you
want to come up after or join us for
lunch that would be great Chris that
would present you with the official
google Tech Talk bag of schwag yeah
there we go so thanks very much for
coming today telling us about CouchDB
how about a round of applause</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>