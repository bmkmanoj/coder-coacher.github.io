<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Training Haar cascade object detection - OpenCV with Python for Image and Video Analysis 20 | Coder Coacher - Coaching Coders</title><meta content="Training Haar cascade object detection - OpenCV with Python for Image and Video Analysis 20 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/sentdex/">sentdex</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Training Haar cascade object detection - OpenCV with Python for Image and Video Analysis 20</b></h2><h5 class="post__date">2016-01-11</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/eay7CgPlCyo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">what's going on everybody welcome to
another open CV with Python tutorial in
this video will hopefully be wrapping up
the creation of our own hard cascade
file for object detection of really any
object that's the whole idea here I'm
almost done uploading the data set that
we just created so now I'm back into the
terminal right now and we're going to do
a few things so first of all I just real
aughh back in so I'm going to change
directory into that workspace that we
created and we should see that the files
are coming up here what we need to have
here by the time we're done is that
negative directory the negative or the
BG txt which is that description file
and then we also need our positive image
files so for me that's that little image
of a watch if you need that image go to
the tutorial link in the description you
can grab that image but like I've been
saying this whole tutorial I think it's
really better if you use an image that
you find interesting so up into this
point you could really use any image I
mean just take a picture of anything
convert it to a 50/50 and train using
the three commands we're about to run
because these negative images are good
for anything basically besides people
okay so you can train to track really
anything you want okay so as the
transfer is done let me make sure I have
everything I need right BG Tex neg
OpenCV which we just we install a long
time ago and the watch 50 by 50 so now
we want to do is let's go ahead and make
sure we need tutors we're going to make
their data this is where our Cascade
information is going to go later on and
then we're also going to make dur info
this is where the positive images are
about to go so first we're going to
create the samples the way that we do
this is with open CV underscore create
samples so open CV underscore create
samples now this is kind of a long um
command but I'm going to type it out
because each part kind of needs to be
explained anyway so first you say what
the what the images that we're going to
create samples from so
image is watch 50/50 dot jpg if you have
a different 50 by 50 image that's you
put that in there and really you can you
can do it first with this watch then
take a picture of like your phone and
then put your phone in there and you'll
have trained for a phone and you just
keep going um and do that so USB Drive
or something so watch fifty fifty jpg
cool the next thing we need is the BG so
this is the background information this
is that background text file that's BG
txt the next thing that we want is the
info where is all the info going to go
and this first thing is actually the
info file this will be the positive file
that this create samples is actually
going to make for us so we're going to
put that in info / info LST that'll be
just like our BG txt file only it'll
have the image path how many objects in
that image and their location or so
that's that then - PNG output where are
we going to put the positive images that
it's going to generate we're just going
to put them in the info directory and
then here we can set some optional
parameters like a max X angle will just
say 0.5 max Y angle will say is 0.5 and
then max Z angle 0.5 and then finally
the number we could probably use 1950
let me um what I want to do is open up
let's see how many we actually have here
properties so we have yeah we've got
1964 total so we'll use 1950 I think
that'll be good enough and then we'll
actually end up using even less and I'll
explain why when we get there so this
will create 1950 positive images so go
ahead and hit enter it's creating
samples it's done it does it that fast
it's crazy
so let me go over to winscp here let's
update this alright and let me pull up
just our working directory and so we go
into info and it'll take a second to
load all these images but here are all
the images and then this is like our BG
text only it's made for this so as you
can see this is just the list of all the
images how many objects appear in each
image so it's just one the starting
point or basically the rectangle
location of the image so XY of the
upper-left and then the width and height
so the width and height should be the
same every single time from the starting
point that is anyway um so so that's our
info and then our images are pretty cool
so I'll bring those I'll just bring one
up just to show you what it looks like
so it's hard to see really well but you
know these are people running on a track
and my watch is actually appearing over
here kind of in the in the background
and that's how it's making a positive
image but it's pretty cool
so as you can imagine and you can see
it's it's rotated a little bit and kind
of angled back a bit so it's kind of
neat how that works but anyway it
doesn't you know that or 1150 of those
so once you've got that made that
operation should be really fast so we
now we have our positive images already
done so that's pretty cool
now we need to create our vector files
so if you already had positive images
that you hand labeled for whatever crazy
reason you didn't need to do that step
but you still need to do this step so
this step same starting command oh do we
disconnect already hope not no okay open
CV dot underscore create samples and
then you specify where's that info a
file located the one that describes all
the positive images that's located the
info - info LST then for the vector file
we're going to do num 1950 total and
then the width is 20 the height is 20
and then where do we want the Veck file
to be saved - we'll just save it in this
directory as positives
Veck so save that and we do 20 by 20
because uh the the larger you make these
images like 20 by 20 is like kind of the
average that people recommend you use
kind of but the large you make these the
much longer it's going to take to run
the training process but as you'll see
in the very end because we used a 20 by
20 the actual detection will be a 20 by
20 detection rather than if you remember
the face detection that we had it would
like encase your whole face you could
find the whole face with a nice
rectangle whereas in this case it's not
I'm not quite going to work that well
but we'll still find it and if you
wanted to use larger you could it would
just simply take a lot longer I wanted
to keep us on a small server but if you
want to you can make this larger and you
will actually detect the full size of
whatever you're looking for but you
don't have to you will still find it
with these because the way a heart
cascade works it breaks down very small
features basically if you saw it's
almost like a 0 and 1 it's very binary
types of features so the size doesn't
matter as much it just simply doesn't so
anyway that was our vector file and now
we're ready to bring it all together and
actually train the Cascade now this part
takes a long time this operation on this
server
um this we've got about 2 gigs of RAM a
good idea actually would be to clear the
cache or something like this but we'll
just let it go
so so what we're going to run here is
we're going to run OpenCV underscore
train cascade train cascade okay then we
specify where is the where's the output
going to go so - data we're going to put
it in the data directory keep in mind
you have to have these directories
already created I close out I think I
closed out of I did I closed out of the
winscp I don't know why I did that but
anyway make sure data exists as a
directory
before you run this it won't create it
so data goes to data the vector file
will be positives BEC the - background
file will be BG txt and then the - num
pause is going to be 1,800 1,800
do not use a bigger number stick with
1,800 I promised - a num neg I'll
explain why in a moment no neg will be
900 half of the positives and then the
num stages will use 10 because we're not
crazy and then the width will be 20
height 20 okay even though you say num
pause 1800 it will start at 1800 and as
you go through each stage it will
increase that number and go to higher
numbers so if you said 1964 you're not
going to get to stage 1 so keep that in
mind use you know leave a nice few
hundred leeway there num stages the more
stages you use the more accurate ish
it's going to be but the more stages you
use the much longer it will take to
Train like stage 1 or stage 0 will be
pretty quick
stage 1 will be a little slower stage 10
will be even a little more slower than
that one and as you go on getting
through stage 10 is like 10 times as
slow as getting through stage 1 it's
very slow so this process even though of
10 stages it'll probably take 2 to 4
hours so I'm going to start well no
actually if you already started control
see get out of that stop that what you
want to do actually probably was
something that's going to take 4 hours
is it's the same command end with an @
sign and go to the front of this command
and type n Oh
HUP no hub and what this is going to
allow you to do is run this command and
the output will go to an output file it
doesn't really matter and it'll start
training and you'll be able to exit so
actually we'll go ahead we'll run it
without the an sign just to make sure
the command is correct but then we'll
cancel it and redo it
so run it so it starts running we're
doing the positive and negatives
let me duplicate the session really
quick here we go into top here and you
can see right now we're pretty much
using all the memory we may actually
wind up running out of memory here we
might have to use less we're really
close we're going to we're in it we'll
probably get kicked out of the server
here in a second anyway so yeah you need
about two gigs of RAM like I said so
this is it training everything looks to
be successful one thing to note as long
as you use all of the same parameters
except for training stages you can like
you can train to like 100 let's say you
train to ten stages and you output a
cascade that was created from ten stages
and later on you want to train to 20
what you can do is you can run the same
command so long as all the other
parameters are the same you'll have the
data that leads up to stage 10 and you
can begin training at stage 10 so long
again as all the other parameters are
identical so for example this is zero
stage when it gets done training zero
stage it'll train one stage I can
actually cancel this and then when any
time I restart the command you just you
pick up right where you left off so it's
actually pretty cool because you can do
that and it'll probably be useful
because you'll probably blow your RAM
based on cash yeah we didn't I didn't
set up any swap memory so hmm we might
hit hit that limit get booted but we
should be able to get at least a few
stages out hopefully we'll get to ten
but we'll see
so anyways umm that's all for now just
let this run you can either let it run
up or like if you want to run this
overnight but you don't want to leave
your computer your terminal open you can
actually break that just ctrl C hit the
up arrow and use nohup and what nohup is
going to do is it runs the command in
the background and you and you can leave
your session and it will still continue
running normally like if this was
running and you close out of your
terminal it's going to log your user out
and the command won't run but if you use
no huff it'll run just in the background
so and that's what it's doing here and
we can come back over here and just make
sure it is indeed running which it is
okay so go ahead and let that run just
let it run for as long as it's willing
to run and then when all that is done
you should have so many stages if you
don't make it to ten you can get two
well let me let's go ahead let me pause
this real quick and let me pull back up
our server room real quick okay
brought the the winscp back up so if we
go this is currently running and we got
okay amount of free information anyway
going into data will refresh this
hopefully and oh I guess we're not we're
probably not through maybe stage one yet
but once we're through stage one we
should get like an XML file that has
some information there so once that's
done we'll get there now if you open up
another terminal one good idea that you
might have especially since we're
running so close to possibly running out
of RAM eventually what probably will
happen is your your RAM cache will build
up and you'll get kicked out especially
if you don't have swap so one thing to
do is we'll break out a top here and you
need type in like crontab e will use
Nano so hit - sorry probably went too
fast there and then just go ahead and do
star star star storm sorry so five stars
and what that's going to do is every
minute it's going to run the following
just run sudo echo one
I suppose greater than Sun slash Proc /
sis / m / drop underscore caches take
that line
copy paste paste and then change this to
two this two three yes save so control X
yes to save enter and then service cron
restart and then now hopefully every
minute
I don't have a chop installed I like H
top we'll just get that real quick
apt-get install each top um it should be
pretty quick yep bring that up and then
now we can see how our CPU is doing good
we've got memory usage we're actually
had pretty good we actually have quite a
few free we had a huge cash though
so that cash as it runs up you'll max
this out and if you have no swap left
your digitalocean server will reset and
so that's no good so um so you just
leave it like this and you should be
good let's see if we got past stage one
yet no we still have not passed a stage
I'm kind of bummed out I wish I could
see it now I kind of want to see the
output I forget where the output even
goes I think it may go to the root
directory if I recall let's refresh real
quick I can't remember where the output
said it was going to go does it say here
yeah it sends it to no hook out maybe
it's in the workspace yeah make sure we
didn't get an error
okay so training stage zero goes through
the negatives ok so it's still going
we're on currently this spot it'll go
through quite a few well probably I
think it's like you'll get to probably
like 60 or something that before stage
one is done as you can imagine this
takes a long time so I'm going to go
ahead and I'll pause it here and
hopefully when I get to the first one
maybe we can I'll explain what I was
talking actually I'm gonna let this run
and then I'll come back with the
completed version and I'll talk about
the additions so I think we'll go ahead
and break the video here and then in the
next tutorial I'll talk about you know
the completed file what you can do to
continue building on it or if you don't
want to wait any longer you can cancel
it and build up to that specific point
we'll talk about that and then we'll
actually incorporate it and test it and
see how well it worked so as long as
you're getting output that looks like
this either here or to your know hub out
file here you're totally fine
everything's running as it should and if
you use no hope you can log out and
you're totally fine just remember to set
up the cron
to clear caches because otherwise you're
going to run out most likely of memory
even though it'll be cached you'll be
it'll be all stuffed up and then the
server will shut down will restart and
then it won't restart your command
so anyways uh questions comments leave
them below otherwise as always thanks
for watching thanks for all the support
subscriptions and until next time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>