<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Orders and Leverage - Algorithmic Trading with Python and Quantopian p. 2 | Coder Coacher - Coaching Coders</title><meta content="Orders and Leverage - Algorithmic Trading with Python and Quantopian p. 2 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/sentdex/">sentdex</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Orders and Leverage - Algorithmic Trading with Python and Quantopian p. 2</b></h2><h5 class="post__date">2017-01-30</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/H5LLJDJ3jTI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">what is going on everybody and welcome
to part 14 of our Python for Finance
tutorial series as well as kind of part
2 of the quanto peon part so in the last
tutorial we kind of just built up these
initial two functions and now we're
actually going to execute trades so the
way that we're going to do that is
basically we're just going to ask if SMA
20 is above the SMA 50 we want to place
an order now if you don't know how to
place orders and go down to the API dot
price control F border here we go
ordering boom so you've got your options
here these are like types of orders that
you could make market limit stopstop
limit you'll see what I'm talking about
there momentarily looking for the list
of the actual orders though I know which
one I want let's try a order one of them
is ordered target percent or art or
target here we go
order methods cool so here you can see a
bunch of the different order methods you
can do just a simple order of a security
how many of them in the order type which
is like that market limit order and so
on market just will buy it for whatever
the market price is limit lets you say I
want to buy for this price and so on
order value you can order like a
specific amount of dollars worth of the
security as like this one was just an
amount like I want to order five shares
this is I want to order five hundred
dollars worth of shares order percent
this is yeah percent of your current
portfolio value
there's ordered target for an order
target like an amount basically or an
order target yeah order target value so
this is an order target like literally
like an amount of shares the number or
sort of value how many how many dollars
worth and then order to target percent I
like order target percent it's like the
easiest one to like keep your your
portfolio balanced
so we're gonna go with that one so we're
going to order underscore target
underscore percent and here we see CID
target percent and a sitting target
percent in style so the fit is just
context by Apple then I forget what the
other ones were I think it's just really
just want an amount style by default
it's our caller Ids market so we really
just need basically the target percent
we're going to at one point out that's
100 percent so zero point three three
would be thirty percent and so on
so we're saying we're going to order 100
percent of our portfolio or really not
going to order 100 percent of our
portfolio we're going to set the target
we're going to say we want 100 percent
of our portfolio to be Apple so it's
really convenient when you want to like
rebalance the portfolio or something
like that there or just balance a
portfolio you can say look I want 20
percent of my portfolio Apple 20 percent
Google twenty first to Amazon and I
don't know 20 percent I don't know a
Bank of America topic right
Microsoft that's better one so anyways
you can do something like that but for
now we're going to order one percent
Apple now what we're going to say is if
or help if SMA 50 is above SMA 20 we
want to do the exact same thing only we
actually want a short Apple so if we
want to just make sure we sold all of
our shares we would say the order target
percent is zero we want to make sure we
have zero percent of our portfolio and
Apple but actually what we want to do in
this case is negative one point O we
want to short Apple if you don't know
what shorting is you're basically
betting against the company so to short
a company you bought you borrow some
shares from somebody at some price right
you borrow those shares you sell it at
that price because you're expecting it
to go down so you bought let's say five
shares of Apple at $1,000 you're
expecting it to go down
so you borrow those five shares of Apple
you sell them for $1,000 each and then
you're planning to rebuy them back at
$800 each and then when you buy them
back at $800 each you've made $200 per
share right you did pretty good you made
$1000 and then you give the Apple shares
back
that's the goal so don't always work out
like that the danger of shorting is
there is infinite downside and only a
finite upside so at $1,000 you're upside
per share is without you can make $1,000
per share shorting a share but your
downside is infinite because the share
price can go up infinitely and the
inverse of that of course is investing
your upside is infinite your downside is
finite so shorting is just inherently
dangerous plus you're borrowing money
basically
so anyway cool so that's our strategy
again like I said it's magical you don't
actually have to call initialize and
handle data to run they just simply run
there are other functions you will have
to specifically say hey I want this
function to run this one not the case so
we're going to run it let's just let me
simplify this and not run it for too
long I wish there's a quicker way to do
this I'm gonna leak liquor by the way
someone's gonna be like holy yeah okay
uh-huh
I thought i misclicked and then it was
going to not do it anyway we'll fix one
full practice okay so then once this
starts up we'll start seeing some
results if it goes too slow I'll pause
and wait but basically everyone is going
to have to sit through this so but I'm
expecting to immediately see something
that will like for example here we
immediately bought 1.3 million in sold
0.3 million so that's already kind of
suspect but we'll continue trading no
problem no problem because we're doing
good so there's no reason to kind of
question what's going on as long as
we're making money is it all right it's
going kind of slow so I think I'll pause
it you don't have to pause it and wait
for yours I'm just trying to prove a
point so I'm going to pause mine and
wait for what I'm what I'm waiting for
alright and we're back we are making
Bank okay so finally what I was waiting
for happened and basically you can see
here that you know suddenly we're making
transactions like 74 million this is a
huge one 213 million
and so on and obvious in our return is
just absolutely BS so we're going to
cancel this and talk about leverage
because something's happening and
basically leverage is just something
you're going to always want to track the
reasons like this so we're going to go
back actually go to algorithm and what
we want to do is track leverage so what
we're going to do outside here flips
Girt I don't know it's not let me click
there anyway down here we're going to do
one more thing we're going to record and
what we're going to record is basically
in record you can record up to five
things if I work alright they only
record daily metrics but happening in
here basically handled data is going to
recur occur every minute so it's kind of
unfortunate same thing with our SMAS
this is rather unfortunate right now
we're going to fix it soon but for now
we're going to record right into here
but normally you would also just record
like once a day or something like you
don't need to be recording every minute
so anyway what we're going to record is
leverage and this first value that you
passed in pass into record is just by
word again it's very uncomfortable as a
Python programmer to do to just write
leverage because this is like the name
it really ought to be like leverage
equals but know you use writing like
this so leverage equals context account
dot and then here you can see like all
your options you've got a ton of options
one of them happens to be leverage so
we're going to just be tracking this so
what you can do in a record is it just
will just plot your leverage as you go
so again I'm going to go ahead and run
this full back test and again we will
see we'll see what's happening to our
leverage when that happens it again you
don't need to wait with me or something
I'm just going to hit full back test
pause and I'll restart again so we can
see what's going on with leverage all
right and we are back and we are making
Bank again okay but now we are tracking
this custom data and we can see that at
some point we went up to about 50 X
leverage so basically it means like
we're investing with 50 times more than
we actually own no one's going to give
you that kind of leverage so you just
can't you can't do that
now we settle down a little bit here
actually anyways yeah you just can't do
it
so okay so our leverage is crazy and now
you know all wait you should always
track leverage because it's just a place
that goes wrong frequently but now we
need to fix what's causing us now we
know okay yeah we're getting over
leverage but why okay so I mean
cancellous and go back to the algorithm
and what's happening is basically okay
where we have a million dollars to
invest here and quanto peon is an
environment that simulates trading so
when we decide hmm I'm going to buy a
million dollars worth of Apple shares
okay
that takes a minute you know to fill
maybe more than a minute so same thing
if you've got a million dollars with
Apple shares to sell that can take more
than a minute to occur and so but if it
doesn't occur within a minute guess what
happens
well if SMA 20 is rather than 50 it
executes the exact same order again and
then you start getting into some trouble
so and then it just starts amplifying so
at some point basically we start
shorting more Apple than we've got and
we start buying way more Apple than
we've got word in theory just borrowing
money to do it so instead what we need
to do is put a quick check into here and
the check that we're going to make is
we're going to check our open orders
first so we're gonna say open underscore
orders and that's going to be able to
get underscore open orders and just
touches all of our orders and again just
just magic here is happening we never
had to import get open orders it's just
part of the quantity environment
imagine we did like from quantity and
import asterisk like the horrible Python
programmers we are that that's basically
cut out like we just have access to this
function so and again to know these
functions exist ducks
so open orders equals get up in orders
we're recording leverage and then
basically right before we place this
order what we want to do is like I said
what's happening is we still have an
open order that's pending to fill for
Apple it's just not totally full so
let's say let's say you what in one
minute you say okay I want a million
shares of Apple stock after a minute
goes by you bottom I'm sorry million
dollars worth about the shares a minute
goes by and you've you've got $500,000
and Apple shares you haven't quite
filled it yet but a minute goes by
you've got 500,000 worth of Apple shares
but this runs again it says nope we want
a hundred percent so what do we do we
buy $500,000 more of Apple shares so now
we've got two positions that are trying
to buy $500,000 of Apple shares we've
already got $500,000 of Apple shares
when all said and done we have 1.5
million dollars of Apple shares then
same thing happens when we go to sell
and buy and it happens over and over and
over that's how that's happening so all
we need to do before we place this order
is say if context dot in this case we
just have one company normally you might
have a list of companies and for each
company you would go through this but if
contacts dot AAPL is basically not in
open underscore orders if contacts that
APL not in open orders then we'll place
the order and then we'll do the exact
same thing here they're their tab this
over great and now let's run this and
see if we're doing any any better so you
ought to keep the same the same thing so
I'll run this back test and again I'll
just pause while this is going and then
I'll unpause when we see whether were
we're winning or we're not all right and
we are back we are actually currently
beating the market there's been plenty
of times when we're not beating the
market but coming back down here and
looking again at our transactions for
such a interesting choice
I'm not going to question that
transaction right at the moment but for
the most part we can see that serious
trends actually like this is probably
ants
all that just happened even more to
compound what I'm about to describe but
you can see after that huge one
you've got some pretty large limbs here
like 2 million again 2 million again
probably about 2 million about 2 million
so what's happening here
well let's go back to our strategy again
we can see that Putin well you can't see
but just no handle data runs every
minute initialized runs once but hey I
was running every single minute so
there's going to be times where the 50
and the 20 SMA kind of are playing with
each other us a little bit one time some
points above at some points below but at
the point of the crossover as prices
going up and down and kind of changing
before it really solidifies it might
actually change like 10 times
so again whoops here we go with in this
case we probably just you know bought a
million sold a million body really
insulting it was just kind of kept doing
that the other thing that's happening
why that's a problem first of all just
the back-and-forth buy and sell and buy
and sell that's not good because you be
racking up trade fees like crazy right
now I forget I think there is a default
Commission I think it's point zero zero
one but I'm not positive percent or
rather 0.1 percent anyway I'm not
positive that it's actually built in
initially I think it might be something
you have to define and normally it's
free Commission's but at least looking
at our leverage we can see we've got
leverage under control there is some
wiggle here but if you look at the
actual axes it's it's not it's like
thousands of of a wiggle all right so so
the other question is of course why are
we seeing something like for example
besides this one which clearly as it was
going crazy like here why is it 2
million well think about it this way
like you know first of all we've made a
little bit of profit on top of our
million so it's we have more than a
million to invest with but also what's
happening is basically to consider like
a situation if you're shorting a million
shares of Apple you have to buy a
million back to equal zero and then you
buy another million to be like long 100
sent apples so that's why you're seeing
a lot of these two million tics but
anyway the six million is a great
example though of a serious problem that
we still have but we have leverage under
control so that's it for this video in
the next video we're going to talk about
how to control this transactions problem
and and then from there we'll kind of
talk a little bit more about even from
that point why research is going to be
more important so if you have questions
again up to this point if anything
appears black box Q it probably is and
I'd love to answer any questions you
might have on anything like that or I
can help explain something and if not
you can also always check out the
documentation so anyway it's questions
comments below otherwise I'll see you in
the next tutorial</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>