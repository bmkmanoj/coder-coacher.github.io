<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Portfolio Optimization API - Algorithmic Trading with Python and Quantopian p. 12 | Coder Coacher - Coaching Coders</title><meta content="Portfolio Optimization API - Algorithmic Trading with Python and Quantopian p. 12 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/sentdex/">sentdex</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Portfolio Optimization API - Algorithmic Trading with Python and Quantopian p. 12</b></h2><h5 class="post__date">2017-02-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/-M_KCH7sqmI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">what's going on everybody welcome to
part 12 of our algorithmic trading with
Python and quanto beam tutorial series
in the last video we covered our last
videos we've been covering testing
multiple alpha factors combining them
and seeing why we want to combine them
in general it just it helps and it's
been very clear through the testing here
that it's been good to us to do this so
now what we want to do is let's say you
found a great combination I mean
honestly this combination isn't that bad
I mean we saw some volatility here
ideally like what I'd like to see is
like a nice smooth just up curve that
would be great like a nice compounding
up curve as smooth as possible this
one's not as smooth as I would like it
but but it's pretty good and
everything's pretty much been improved
so anyway let's say we're happy with
this and we want to we want to move to
back test it so so yeah so what we're
going to do basically is just take this
this this pipeline and use it because
we've got shorts along so we can
actually pass this in so just assuming
we were to take this strategy we could
just actually I'll have to copy that in
a second let's just go to algorithms and
this was this is I think the one that we
left on raw ward so let's just copy this
come down here new algorithm a Q
tutorials combined alpha great the
algorithm fantastic paste and then we'll
come over here take this pipeline copy
hopefully that that went well that's
awesome
weird thing but okay make pipeline
initialize make pipeline so do this
paste now initially we have this I am
going to comment this out those soon
enough because we did want to see how we
would do but first we just kind of want
to see here so we've got the quantiles
we've got shorts and Long's we come down
here and we just perfect 50/50 weight on
the shorts and Long's and we can back
test is like now so let me fix dates
here should be we should go with oh six
Oh
our action we'll be doing we're doing Oh
101 2015 and then Oh 101 2016 so of
course we're still using the market
neutral year over a long period of time
the market is not neutral therefore we
need to still solve for that problem but
one thing at a time young padawan next
run the full back test the pressure
changes to a million but o first of all
we need to make learning imports back to
the algorithm so what was that import it
is it the same always it prepared I
think we can just do pipeline data I
think we can do the same import I don't
think that one changes so paste let's
just build it real quick and see if it
compiles and then if it does I'll
continue loading pipeline data we see
like one percent off I'll pull the
trigger this way to make sure we don't
get an error now while we wait I just
want to introduce the the optimized API
okay cool
I wanted to talk about the optimized API
while the back test is running so now
let's change this is this this should be
1 million let's make it 10 million 10
million a suggestion by the for the
quanto pian allocation so we'll do 10
million run the full backup now do note
we still don't pay full Commission's
will check what we're going to change
this a few times before we actually care
so eventually I will remove it and if I
forget someone can feel free to yell at
me but that's the plan is to actually do
default Commission's so so while that's
running let me bring up the optimized
API so first of all the optimized API is
making use of what's known as convex
optimization so you don't really need to
know a whole lot about that but
basically it's for one if you want to
learn more about it you can go to my the
machine learning tutorial series where
we actually were pretty much covered
that through when we talk about the
support vector machine but in this case
basically the idea is we can this line
here is pretty good you can specify the
desired state of your portfolio in terms
of
objective objective and constraints so
your objective what is your portfolio
want to maximize or minimize so you know
minimize volatility maximize alpha
maximize your Sharpe ratio constraint
something that your portfolio has to
adhere to leverage one
okay so leverage must equal one okay in
your universe we've already kind of been
through the universe so there's got some
examples here initially let's see it
came out initially it came out for the
just for the research but now that it's
available on the actual algorithms one
thing to note is this is highly likely
to change or at least improve over time
I there is some assurance that nothing
will be everything should still be
backwards compatible but that might that
might change okay the last time I put
our tutorials on coins opium they
quickly came out with 2.0 so just as a
note this might change over time so if
you're getting errors or whatever look
look up and see what you what you can
need to possibly change okay algorithms
still running just run check so what
we'll do is first of all you can go
through here and play with it in the
actual notebook setting if you want I
think that it makes more sense at least
in terms of when you're picking your
portfolio to really just just do it in
the algorithm itself this is kind of a
good it just makes sense there so what
I'm going to do is there's an algorithm
here I'm going to literally just clone
this algorithm and I think we'll leave
everything possibly here and trying to
look through this code basically the
thing that will change is this here and
here
the combined alpha part and then this
will stay the same the sector will stay
the same so what this will do hopefully
is balance us across sectors as well
which should be pretty cool that's just
like a new thing to basically add your
strategy so you're not over weighted
into one specific sector
so already we're doing pretty well and I
mean this is pretty pretty much matching
what we thought we were seeing in the
the alpha lens where we kind of just got
do crappy or not crappy but also not
great in the first few months and then
we kind of picked up and I'm pretty sure
we're already on a much better track
than we were initially and again this is
using the the quantiles and I don't
think default Commission will high off
check that one but I'm pretty sure we're
I guess we don't have to I can just be
good yes we're using this but we can
look here the transactions on this is
fair amount to render that's
transactional today so it might have an
impact but we'll check that in a minute
there's maybe a little bit of volatility
here I mean you wouldn't want to see it
be nice if we didn't have such
volatility right here but otherwise yeah
we're doing we're doing pretty good so
I'm going to keep working on this one so
while we're here what I'm going to do is
I'm going to we're going to continue
waiting on this I'm going to come over
here now this is the our old pipeline
basically and I'm going to go ahead and
bring these two lines in pipeline data
Centex pipeline data Morningstar copy
coming over here to the top we're going
to make sure we import those two things
he's already imported Morningstar's and
we could use it and star dot that's okay
though I'm a I'm not going to worry
about that that overlapping import from
now and coming down here let me think
here what we want to do basing universe
so he's not even using the Q 1500 in
this example I kind of want to just
because I'd like to keep it as close to
what we had before I'm just trying to
show you how you can work on that
that simple skeleton especially because
I I see it as being highly plausible
that the optimized API is changed and
this exact code won't work but hopefully
if there is a change you can go to the
source on quant opium take his example
and make very simple changes to it to
use what we're doing okay looking at
this right here anyway a huge
improvement over what we had before
already I pretty sure volatility is
relatively close but our Sharpe ratios
above two which is fantastic Sortino is
great as we probably expect we did beat
the market pretty significantly max
drawdown is not you know the same as
return so that's always good now while
we're continuing to modify that other
algorithm let's do set default
Commission so let's not modify
Commission so we're using the default
trade commission's run that back test
and while that is running I'm going to
come back over here hopefully this isn't
too confusing I'm bouncing around I'm
trying to just save as much time for
everyone as possible so so let me now
what I'm going to do is we'll try me to
change these numbers I would probably go
with because we want to war invest in
more companies than that then 1.5
percent that's a theory a very small a
number of companies the quanto peon fund
wants a larger number so let's try to
use a large number plus in theory we're
dealing with as we've already seen 522
securities so hopefully a number around
500 total security so 1.5 percent was
not going to allow that so they'll go
here you know 1.5 percent would allow
much less than even you know 100 so ok
that's good we've got these new imports
the Q 1500 I kind of just want to like
throw into 1500 in here and I could we
could almost let's do built-in with
equity pricing that might make sense to
have that there and then volume must be
greater than 0 I mean I guess I guess
that sounds good I didn't know that was
something we would need but let's go
ahead and what have I done let's see
okay so now and keep Q 1,500 us monthly
top bowling universe equals oh so this
is how he was choosing based on like
volume interesting
I see why we requested piece now we
could go off of that I really want to
get as close to what we were using it's
possible ingestion of the difference of
applying what we have so yeah I'm going
to I you can we can try that or maybe
I'll add it to the very end or something
or maybe I'll put it in the text-based
version because I want to copy this as
close as well the way that we've built
it in alpha limbs and cut away as much
extra so I'm going to do this take this
copy we've got the universe testing
factor is what we passed so let's come
back over here interesting and basically
combined alpha will equal what we've
just copied says come all the way up
here paste let's call this something
different so I don't confuse myself so
we'll call this optimize plus alpha
combos save coming down here now alpha
is no longer to combine alpha testing
factor we pass the sector sector nominal
pipe all this will leave
I hope it runs let's see if this is done
and it is okay so we are we lost a
little bit of our returns but that's
okay we expected that to be the case but
what's important is now we're paying
this is what what you would have
actually a long theory if you paid full
like personal interactive broker account
fees so it's actually really good like
we did fine um with this combination so
awesome now let's add the optimized API
to this to help us pick our strategy and
just see if we get any improvement first
though let's make sure it runs because
we really kind of monkey patch this oh
we got six debates of 0 1 2 1 2001 oh 1
2016 build hopefully not too many errors
combined alpha not defined where's that
in the screen wait where will say line
62 I know we didn't uh ah ok fine let's
do this let's say a combined alpha just
so it's even closer there ok filled out
room we made 62 though so hopefully we
can make it all of the way back test and
generate anyone I asked it to build I
thought let's try one more time come on
start so optimized is a lot lower than
the other method that we were just using
so I'll probably pause while this one
runs that way if you want to wait till
it goes all the way through great and if
you don't you can just kind of keep
watching so you don't have to run it
yourself if you don't want looks like
it's starting fantastic I'm going to
cancel it run a full back test and are
we ten I think we're ten million or yet
10 million see yep be nice if there were
some commas there okay press the fold
back this
okay so while that's running I don't
think the other ones running so it is
the only running back test and and I
think probably you know what I'm going
to recommend is you should probably go
through both of this and and I'll try to
post the links in the description for
this notebook and then also the post for
running through the API with the
algorithms I highly suggest you go
through here read it but then also just
kind of play with the code yourself to
kind of get used to it but there's not
too many constraints and objectives that
we can set right now and I cannot
remember there's any documentation yet
for the optimized API so basically it's
kind of like a little bit of trial and
error for yourself actually you know
what I think there is document because i
i've seen some documentation somewhere
let me see
let's let's check optimize I forget
where I've seen it I've seen some of the
functions for optimized I think it
exists somewhere I just can't I just
don't know where let's say portfolio
optimization
hmm well anyway there are only like very
few kind of objectives and constraints
that you can kind of deal with right now
at least from my brief kind of poking
around but anyway yeah so even now I'm
pretty sure we're doing better so far
and let me see your view code we're
checking for yeah okay yeah so there
there's no definition for any
Commission's here so therefore we're
using default commissions in the
strategy as well so we're going to
compare this basically to the other one
that we just ran I think that this one
the ex-head little Commission's correct
and is working off of just simply
quantile so as opposed to just kind of
arbitrarily slicing the quantiles and
thinking nothing more of our strategy
instead we're doing something a little
more sophisticated and see if I can have
rhythms here and in fact let me pause
well I'm going to possible that back
this is running how much see if I can't
find what I was thinking I've read
something on the optimize API that kind
of went through the methods didn't stuff
that we could use so let's see if I
can't find that as things are of course
it only took me two seconds soon as that
paused so first of all if I forget to
post these links you can go to Google
and just type like optimized API quanto
peon and you'll find both of these
threads the ones that's now available in
algorithms and also the request for
feedback but anyway the one for the
algorithms if you scroll down he's
posted an updated version of his
notebook you can either view or clone it
come into here and there still isn't any
official documentation I don't think but
this serves as pretty good documentation
and examples and if you come down here
it's kind of like an overview of how to
use the API and then here he posts the
docstrings so here this I think where I
was seeing when I was talking about a
moment ago basically all your options
and stuff like that but for now you
really you really can just use the
skeleton that he posted and it's
probably going to be better than
arbitrarily choosing things especially
because now you can at least take note
of like things like sector and stuff
like that but I highly encourage you to
just kind of play around with it I'm
mostly I'm just showing you as a simple
example as opposed to just splitting
quantiles let's see where is oh here we
are
okay so this is optimized plus and then
was it this one that had the I'm getting
everything confused let's see I yet so
this was no Commission this was with
Commission and then this one is the one
that just ran now so alpha your six and
the beta zero two same as that optimize
gave us plus C and then I try to make
sure we're going this one had better
returns and no Commission but the the
Sharpe ratio is significantly lower than
the one that was using optimized famous
routine of course volatility here is a
little lower and then same with drawdown
here much less drawdown I mean if you
can tell just looking at it that this
one has more volatility this is just
less volatility it's a smoother our
overall return is less but the way that
we got that return is much more safe and
predictable also it looks like we've
made ya much less trades and ooh let's
see which one was this let's see this
one's our 60 even this one like actually
even though we made a lot we actually
win with an ace at one point and then
this one just never went into the
negatives fascinating alright so there's
a lot of playing around with this that
you could do mostly I just wanted to
bring it to your attention that it's a
possibility now on clinto peon and i'm
going to go ahead and wager as probably
best way to go about it because it just
takes the guesswork and you're much less
likely to just pick random things and
keep trying until something works so
yeah you might want to get rid of like
certain things here that you might not
agree with necessarily like
you don't have to go based on like
dollar volume and stuff like that so you
could remove some of those things where
see or just we not even use this every
we didn't because I think we just like
copy and pasted our strategy over that
oh yeah so so probably what would be
cool is actually to combine that initial
strategy with this one but yeah I'm just
just this one's getting kind of long so
let me cut it off here anyway the last
thing that we probably should do is with
the optimize plus alpha combos where is
that it wasn't this one let's see that
test okay we can take this back test now
that's our codes to the back test we can
and what we're going to do now is we can
come back to our notebook for research
I'm kind of undecided if I want to do a
new one or what let's just I guess we
could do a new one and then it just
quickly do a quick back test check of
this so PT equals get back test paste in
that string make sure it works taking a
while okay
and then BT died okay full hair sheet
so we already kind of knew these numbers
very good next Rawdon actually went
pretty well the other thing you might
want to check and I actually I already
ran it so I'll show it to you is the
full they pull it up for you guys like
go over the entire units index timeline
let's see which one would it be
okay price here you see I'm pulling up
the full back test of this strategy
against all yeah I think it's front yet
June 5th 2013 all the way up to December
18th 2016 and while that's pulling up we
can keep going through here yes this
looks so much better than the first one
that we had very good
so anyway I'm not sure what happened
there
Gru's de treatment cool so we've made
huge improvements over just by combining
and actually those alpha factors were
all like weaker than sentiment alphabet
the sentiment was already a weak alpha
factor and then you would applied to
more weak alfe's of factors and we've
made huge progress so the next steps
here are would be to check for
correlation of these alpha factors so
two of the alpha factors that we're
using are correlated like I forget if it
was if it was revenue or if it was the
operation operating margin or whatever
one of them was like definitely appeared
to be correlated to some sentiment so
you'd want to check for that and here is
the all-time so four total returns match
to drawdown it's not looking too hot
Sharp's not great sorting is not great
in volatilities not great so it's better
and also this this was with default fees
so the interesting what would happen if
we removed if we basically didn't have
those default trading fees and this
would probably be much better but what
we're going to what you would probably
want to do at this point is fix the
whole like we still kind of have a
shorting issue we've improved it quite a
bit but our strategy obviously is not
prepared because it's so market neutral
and pretty even on long and short we're
just not doing well enough long term on
our best our best part good enough like
we definitely have alpha we're able to
trade on that alpha we're able to make a
profit trading on that alpha but it's
not good enough we definitely need to
make some improvements anyway that's
enough for now that's a ton of
information to throw at you like I said
I would check out the optimized API kind
of go through the you can clone the
sample algorithm but definitely go
through that notebook I guess I probably
got rid of it already now available now
rather than as down here I'll try to
link to it if I forget something to
remind me you know I'll link to it but
works through that and kind of get
comfortable with using it and really the
best way to learn that is it's really
trial and error
in my opinion so check those out and if
you if it's just too much for you who or
whatever that's really fine you can you
can stick with the whole quantiles thing
the quantiles were fine and we we
actually I think this is a quantile one
yeah like this one used quantiles and we
did okay
it's just that using the optimized API
you're much more likely to get even
better likes nice nicely and smoothed
out returns so anyways yeah so if you
have any questions improvements concerns
errors you need help with something let
me know below otherwise I will see you
in another video</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>