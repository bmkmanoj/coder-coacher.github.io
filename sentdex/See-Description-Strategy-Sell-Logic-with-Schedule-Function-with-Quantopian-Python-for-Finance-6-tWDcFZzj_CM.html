<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[See Description] Strategy Sell Logic with Schedule Function with Quantopian - Python for Finance 6 | Coder Coacher - Coaching Coders</title><meta content="[See Description] Strategy Sell Logic with Schedule Function with Quantopian - Python for Finance 6 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/sentdex/">sentdex</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>[See Description] Strategy Sell Logic with Schedule Function with Quantopian - Python for Finance 6</b></h2><h5 class="post__date">2015-07-01</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/tWDcFZzj_CM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">what is going on everybody welcome to
these 6th Python for Finance tutorial
with quanto peon and zipline in this
tutorial we're gonna improve this
algorithm a little bit because right now
all we're doing is making purchases but
we're not making any sales at all so we
need to have some sort of logic that
will handle for sales so the way that
we're gonna do that is we're gonna
utilize a new method and this method is
rebalance so the rebalance method is
added here because there might be logic
that you want to use from time to time
let's say that you want to schedule to
occur but you may not want to actually
in your handle data method so generally
any sort of rebalancing let's say you
want to like after so much time you want
to make sure your portfolio ends at
being 10% technology 10% manufacturing
10% whatever else right so you would use
the scheduling function to schedule
changes also let's say you're trading
minute data but you want to have
something run once a day you would use
the schedule function okay
so let's go ahead and get started with
that so right now we've got before
trading start and we run that and we
have this initialize and in initialize
this is where you have to put your what
you want to schedule basically or this
is where you define what you want to
schedule so we use a command called
schedule so scheduled function scheduled
function and then you put the function
that you actually like what's the
function you want to schedule basically
and that's gonna be rebalance and then
you're gonna have you've got basically
went like the date rule so you've got
date rule and we'll just leave that
blank for now and then time rule okay so
this is when is this running like on
what date and then time is what time is
this running so for example date rule
can equal dates underscore rules then
dot and you have all these options here
so you've got every day
at the start of the week at the end of
the week at the start of the month at
the end of the month we're gonna do
every day then time rule this is okay so
you're running it every day but at what
time so you say time rule equals time
underscore rules dot and you've got two
options market open market close we're
gonna do market open and then you can
say like basically here relative to
market open time you could say you want
it to run 1 hour after market open one
hour and one minute after market open
and so on we're just gonna run it right
at market open we're not really too
focused on anything there so what's our
schedule function now we actually need
the function that we scheduled so let's
go ahead and define that so we're gonna
define rebalance rebalance is gonna
require both context and data so we'll
need those two things and then what
we're gonna say is for stock in our
portfolio so for stock in context
portfolio dot positions okay what do we
want to do so we don't care about
anything else but the companies that we
hold when we're doing a rebalancing
so we're gonna reference all the
companies that we have and then we're
gonna be like what is their their values
and then this is why we're using the
term this 14 here because what we're
gonna say is we're kind of we're using
this so we can reference that's our
maximum right so if it's 14 or higher we
don't want to be invested anymore in
this company we're saying it's a little
too highly valued so what we'll do is
for stock in context portfolio positions
what do we want to do well we want to
say if that stock is not in context dot
fundamentals fundamentals and so if that
stock is not in kind of stuff
fundamentals and the stock is in data
what we want to go ahead and do is we're
gonna order underscore target and we can
say ordered target and say zero another
one I just want to show you is target
percent
so you can order to make a percentage of
your portfolio that company so that's
kind of cool so you can say order target
percent for example we'll say stock zero
we can also say order target equals zero
as well and that would make just as much
sense okay so now we have this rebalance
that's running now I want to come down
here and right here for this try and
accept the reason why we have this try
and accept is because with both p/e
ratio and price-to-book ratio if the p/e
ratios and the negatives and I believe
that price-to-book ratio both of those
generally if they're in the negatives
companies or people that report
fundamentals are gonna say that value is
null or not available or whatever so if
that's the case we're gonna basically
context up fundamentals here is a
panda's data frame and that's how we're
referencing we're basically referencing
the columns of that data frame and the
values of those columns and so it's
possible that at along the way these
values don't exist right so when we come
here to reference the p/e ratio and
we're asking is it less than 11 the
value might be not available and if we
do that it's going to return an
exception so we use try and accept here
but another thing you might as well do
in the more pythonic solution would be
more so context up fundamentals here and
then basically right after the query you
would say something like this like
context stop fundamentals equals context
fundamentals dot drop and again I don't
like this
autocomplete I just there we go drop na
and that should delete or remove all
rows that have a not available value in
it but still it would be requesting that
data I believe for that time and it may
not exist so I'm gonna use try and
accept here for that reason but I'm
gonna get rid of that too okay so now
we're both buying and selling companies
so we can run this back test now and
maybe do a little better than
did last time huh so anyways as this
runs a couple other things that we might
want to consider is you know we're
making these buys and sells based purely
on fundamental data but we might want to
have some other rules maybe so another
useful thing is like stop loss and stuff
like that so this time I return we get
three point nine percent there were a
few times we beat the market but nothing
very exciting here but it's decent and
low at least you have a low drawdown or
Sharpe ratio still is horrendous and
just for the record we'll talk a little
bit more about the Sharpe ratio alpha
and beta in the coming tutorials
so cuz it probably means nothing to a
lot of you right now so anyways we will
talk about that probably not in the next
one but the one right after that anyway
it might be the case right now that
we're buying companies and we're making
a mistake okay so one way that people
kind of alleviate themselves from
mistaken trades or trades that in their
head made sense but the market is just
saying nope that's not a good trade is
using what's called a stop loss so a
stop loss is where you make a buy but
Wow as long as you're holding that
basically as long as that stop-loss is
active if the price hits that stop-loss
you'll sell it so it's a way to kind of
cut your losses so speak so if you buy a
company you think it should go up but
instead it goes down maybe you made the
wrong choice maybe you made the right
choice and you need to be more patient
but maybe you made the wrong choice so
basically what a stop loss allows us to
do is say okay well we're gonna buy this
company but this is the most money I'm
willing to lose on this company if it
gets worse than this sell the company
and it's a good idea to use stop-loss
people have a hard time cutting their
losses a lot of times so if you can
write it into your program and make your
program cut your losses for you instead
of you cutting your losses it's more
likely that you'll actually cut the
losses and you'll be more successful so
let's add in a stop loss to this in the
next tutorial and we'll kind of see how
that pans out for us so anyway that's it
for this tutorial if you guys have
questions or comments up to this point
please feel free to leave them below
otherwise as always thanks for
watching things for all the supported
subscriptions and until next time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>