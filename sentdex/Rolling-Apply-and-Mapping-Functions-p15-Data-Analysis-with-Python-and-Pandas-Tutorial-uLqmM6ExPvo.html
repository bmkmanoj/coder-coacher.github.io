<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Rolling Apply and Mapping Functions - p.15 Data Analysis with Python and Pandas Tutorial | Coder Coacher - Coaching Coders</title><meta content="Rolling Apply and Mapping Functions - p.15 Data Analysis with Python and Pandas Tutorial - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/sentdex/">sentdex</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Rolling Apply and Mapping Functions - p.15 Data Analysis with Python and Pandas Tutorial</b></h2><h5 class="post__date">2015-11-03</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/uLqmM6ExPvo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">what is going on dudes and dudettes
welcome to part 15 of our data analysis
with Python and pandas tutorial series
in this part we're going to be talking
about how we can start structuring our
data set so we can feed through a
psychic learn machine learning
classifier first of all at the end of
the previous tutorial we basically took
all this data and we stuffed it into
this HP i dot pickle that means we're
all set here now if you want to I would
recommend saving the code from part 14
that way if you want to add more stuff
to your pickle
you can do that but of course you can
always load in the pickle add some new
functions that pickle and then make a
new pickle okay you can do anything you
want but for now I'm going to delete
basically all this code all the way up
to this point okay so in order to feed
through machine learning classifier we
got to do one major thing and with
machine learning generally with
supervised machine learning anyway what
we have to do is I mean obviously we
could also try filtering through
unsupervised but anyway supervised you
have features and you got your labels
okay so you've got feature sets usually
so like features would be you know the
state HPI State Unemployment at us GPE
SP 500 these are features at the moment
and then the label or the classification
is you know that current HPI value and
our goal is to at least in this scenario
we want to predict changes in the HPI so
what we end up doing is we're going to
take current HPI values compare current
to next month's HPI value or maybe the
next two months being HPI value and
either HPI went up or HPI went down
if HPI went up we call that a 1hp i went
down call that a zero and then so that's
the classification and then the feature
sets that made up that classification is
that months you know futures okay so we
feed through all those features through
our machine learning classifiers so you
say ok machine learning classifier today
we have such-and-such GDP we've got the
current HPI is x we've got unemployment
rate at
you know why and so on we go down the
list what's gonna happen next month are
we gonna go up or down and the goal is
to have relatively high accuracy ideally
something over 70% but obviously we'd
like 80s or more obviously we'd like a
hundred percent but we're not gonna get
it um we want something that's
relatively accurate at predicting the
housing price index so the first thing
we have to do is you have to generate
that label right because right now we
have the HPI and we can find out what
the next HDI value is but we don't
currently have those numbers so we need
to we need to generate that data you're
still kind of fuzzy on that don't worry
will I think it'll clear up for you as
we start writing and coding all this so
in order to do that we're going to cover
mapping functions and then when we since
we're going to map these custom
functions I'm also going to talk about
the rolling apply because those both are
very similar in my book it basically if
pandas doesn't do for you what you want
pandas to do you can write a quick
function and make that happen or you can
write a quick like apply and do the
rolling apply and that kind of stuff so
this is pandas way of letting you you
know have such an awesome module but if
they don't have the things that you need
specifically it's fully customizable so
first of all we're gonna load in our
data loading in our data is pretty
simple it's going to be housing
underscore data equals PD to read
underscore pickle I do like that one
line to read and do a pickle that is
nice HPI that pickle boom we read the
pickle in goes to housing data good to
go okay next side note I wonder if
pandas can read every pickle or if that
pickle must be a data frame because
otherwise you would never even import
pickle right we need to get rid of can't
believe that's still around I don't know
how that's still even there maybe use
that for a long time anyway I wonder if
you could always use pandas for like all
pickles or something because using only
one line to open up a pickle and read it
and so that's kind of nice anyway what
we're going to do now we've read the
pickle in so now we have the housing
data now if you recall before when we
did our little percent change thing we
wanted the percent change over time but
when we're investing we don't really
care about percent change from the first
value we care about what's the value now
and what's the percent change to the
next value so what we're going to go
ahead and do is actually apply a percent
change to the entire data frame so we do
that by going like this housing
underscore data equals housing
underscore data dot PCT underscore
change it's done let's print out housing
data head just so we can kinda see where
we are
oh it's saying no liar you were lying to
me I know I have it there what is this
sorcery
let's see did we save it as HP out maybe
I didn't save it as HP are that pickle
I'm pretty sure I did let me pull it up
here we go whoops went the wrong way
pandas tutorial apparently I don't have
it this is the code that we wrote HPI to
pickle oh I must have gotten an error
that's really strange
I don't recall getting an error in that
last video but maybe I cut it off before
I was complete making the pickle or
something odd okay or maybe the air
maybe I it was just like off the screen
I don't know anyway okay there I have
the pickle now that was odd I'm so
surprised didn't catch that in the last
video anyway carrying on loading the
pickle there we go so the first value is
not a number because obviously we can't
calculate a percent change off nothing
so okay but otherwise we've got all the
state HP is our housing price indexes or
indices and then we have although I miss
in the benchmark
unless it was truncated but I don't
think it was that's okay we'll leave
that out for now anyway
and yes so we just now at this point we
want to drop the the nada nada numbers
basically and so we can either do
actually let's go back let's see what
that was
yeah sometimes I've gotten a number
before being infinity but at least
that's weird in the past I've seen when
you do percent change it'll be okay at
least we have some infinity values so
we've got not a number and negative
infinity so we've got a handle for both
of those so first of all we give you
housing underscore data drop in a in
place equals true second what we're
going to do is we don't have to numpy
import it so it's bringing numpy import
numpy as NP coming back down what we're
gonna go ahead and do here is we're
gonna say housing under store data dot
replace and we're gonna employ we're a
students above not a number surround
replace it with not a number replace and
we're gonna replace numpy dot infinity
as well as negative numpy infinity we
replace that with NP damn and then in
place equals true you could also that's
really the only way we're gonna get away
with as far as I know okay then come
take this paste that down here let's
make sure we spread our comment let's
make sure that worked up till now here
it is looks like it did so that's good
the next thing that we're going to do
now is we want to we want to take the
see do we not have that u.s. HPI very
angry now let's go back to a fourteen
then let's bring that old code back up
and let's see H there's HPI benchmark
here so I'm gonna copy that
and apparently we never had that as a
part of the CHP I data equals read
pickle HP I bench equals HP I benchmark
but we never added that let's go ahead
and copy this and I'm gonna add the
benchmarks I guess we just didn't have
it there so go ahead and run this one
more time save that into the pit because
we do want to compare to the benchmark
right I mean the benchmarks what we want
we could have done we could do any state
though right you could you can run this
information on just the state of Texas
or any other state but anyway so let's
close this out now and hopefully let's
run this yeah okay so United States
probably should call that the United
States HPI but we'll leave that for now
anyway so that's called United States
anyway so now what we're gonna say is so
housing data dot head what we'll do so
now we have all the data that we want
I'm gonna get rid of that now we're
gonna say housing data and then we're
gonna say the column here is gonna be us
underscore u.s. honors for HP i
underscore future this is the future US
API equals housing underscore data dot
where actually we have to do this united
states united united states housing data
united states and then we do this we do
dot shift minus one now grant housing
data head and what it should do is shift
that calm down for us one point so so
it's the future value so yeah so here
right the current value is 40 nineteen
and we're seeing and in fact maybe what
we should do is just so it's so much
more clear
probably would be this and then take us
HPI future this is the current values
United States paced so the future will
be on the left the current will be on
the right so here's the current value
and it's saying the future is four nine
five seven well short now if we can look
at the futures UCS so what it did is it
copies that column but shifted it down
minus one so that's our way of you know
accessing the future number well of
course
every time we'll just drop in a this way
because the final value would be a not a
number now what we want to do is we want
to calculate the difference when I see
is that a bigger or a lesser number so
the way that we can do that is with
function mapping so we'll come up to the
very top and we're going to define a new
function we're gonna call this because
that that'll be our label basically so
they define create on this form labels
and then we've got Kurt Val Butte API
something like that
so actually will maybe make this ker a
bi HPI and then the question is if the
future if the future HPI
is greater than the current HPI well
that means we want to invest that was a
good thing so we'll say that's a 1 so we
return a 1 else return a 0 so if the
future API is drop we're gonna say that
label is a 0 so every time HPI goes up
we're going to take the current features
and the label for those that those
current features is a 1 if it falls we
take the current features and we say the
label for those features is 0 and then
we feed that into our machine learning
classifier so we have that information a
one problem that kind of can arise with
this is as you can see in the graphs
mostly HPI goes up over time so you
might have a really strong bias to
predicting up every single time so you
wanna look at that and take that into
account but even if you had that strong
bias if HPI you really is going up all
the time then your strong bias should
pay
right so anyway now that's create labels
so then how do we map this kind of
functionality to an entire column well
what you do is and in fact let's may
need to print this right now we'll come
back to printing stuff we'll say here
housing underscore data label housing
data label equals and then what we say
is you want a list
map and then in here you first you want
to put the function that you want to run
we want to run create labels and then
after this you put all the parameters we
have two parameters so we just put two
parameters if you had five parameters
you put in five parameters it doesn't
matter so create labels and we have two
parameters we want the current HPI in
the future hbi well the current HPI is
right here so the current HPI is housing
underscore data the united states whoops
and then the next is future API well we
have that too that is us future age HPI
or US HPI future whoops this this value
paste okay so that's kind of a long
thing but basically you just do the list
of the map of the function and all of
the parameters after that and that's
going to create us a new column so now
you can print housing underscore date
ahead yeah that should be fine
so you dropped in not available so then
you have your labels so here we've got a
label one that means it went up okay so
we can say I don't even see it oh here
it is so from 40 to 49 right well zero
zero four Oh versus zero zero four nine
that's up good label one then obviously
here we went from the current let's see
this would be the row three so five to
sixty but then we went down to 51
eighteen so that's a label zero right
and you can see that's true from here as
well and then again we went from five
one one eight two three five again
that's a drop so here
and so on so anyway our label is working
so that's how you can apply an entire
function to a data frame and then since
we're on the topic of these custom
functions being applied so that's a
custom function to the entire data frame
and then what about that rolling apply
we were talking about before
we can do this pretty quickly so let's
just do it
up at the top go ahead and from
statistics import mean if you're in
Python 3 and greater you should be able
to do that in Python 2 you can't so if
you're following along and - shame on
you anyway I'm getting good at making up
these rhymes anyway now we're gonna
deploy moving average now of course I
know that we can do a moving average in
pandas already but this is just me kind
of showing you the rolling apply in
action so moving average and then moving
average takes values that's all we have
to pass through and then basically we
return the name of values simple as that
and really you wouldn't even need a
function at all for this you could
actually rolling apply mean values but
we're trying to show that you can make
your own function so that's what we're
doing so then what you would do at the
very end here is you could say something
like this you could say housing
underscore data and then we'll just say
ma apply example no one save this past
this tutorial button is shown it equals
PD got rolling underscore apply and we
want to have the rolling apply be
applied to what data well we can do the
I think we have n 30 so like we can do
housing data and then capital n 30 like
that so that's what we want to apply the
data to what is the window that we want
you want a 10 window and since now
normally that's all you need right with
like a rolling mean for example you pass
the data that you want it to be applied
to and then the window but in this case
this is a rolling apply we have to
specify what function we want to disrobe
and apply to be done with so then after
that you say moving average
and that's that so now we can take this
pace actually heads not gonna work right
because it's moving out so anyways
detail and there you go you got your
rolling apply word okay so anyways long
story short that's mapping function to
the entire data frame which is I find
mapping a function is I use that way
more than I don't think I've ever
legitimately used a rolling apply other
than to show it as an example but I'm
sure that's just me I've just haven't
come across a reason for it but I'm sure
people have otherwise it probably
wouldn't exist in pandas but yeah so so
those two things mapping functions in
rolling apply basically opens the door
for you to customize pretty much
everything in pandas like to get any
sort of data manipulation or calculation
to be run on your data frame done and I
think that's really cool that shows some
serious foresight on you know the side
of pandas so anyway that's pretty not
nifty and a lot of times you know
there's probably a way to make this
happen without mapping the function okay
there probably is a way I just don't
know it and there's gonna be a lot of
like little stuff like this one's
probably pretty easy you might be able
to do a one-liner and have that be
generated but sometimes you might have
like pretty complex logic that you want
to have mapped and it's just easy you
just make a function it's just a lot
easier on you anyway that's it for this
tutorial in the next tutorial
now that we have labels we can really
quickly create features because we
already know how to reference of a list
of columns so from there we got our
features we've got our label we can feed
it through machine learning classifier
very fast in the next tutorial so stay
tuned for that questions comments
suggestions whatever leave them below
otherwise as always thanks for watching
thanks for all the support subscriptions
until next time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>