<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[See Description] Pipeline Tutorial - Python for Finance with Quantopian and Zipline 20 | Coder Coacher - Coaching Coders</title><meta content="[See Description] Pipeline Tutorial - Python for Finance with Quantopian and Zipline 20 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/sentdex/">sentdex</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>[See Description] Pipeline Tutorial - Python for Finance with Quantopian and Zipline 20</b></h2><h5 class="post__date">2016-03-04</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/cXDpuigSsjg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">what is going on everybody welcome to
part 20 of our quanto peon tutorial
series for algorithmic trading with
Python in this video we're going to be
building on the previous video which is
talking about utilizing the pipeline API
so to start we've explained a bit about
the pipeline worked into our initialize
function we did set up the before
trading start and then we left with the
handle data really doing nothing but
logging some information so in this
tutorial we're going to be pretty much
working completely under handle data but
we'll make a change to initialize so
let's get started the first thing I'm
going to do is get rid of this logging
info we don't really need to be doing
that and so the strategy is gonna work
as follows so we're looking for the
company's ordered by the MA ratio so we
want to buy the strongest ratio first
we'll call this a momentum strategy and
and then go from there so we'll buy the
strongest ratios if we have the money so
the way that it will work is you'll buy
the strongest ratio and then any time
it's not in the top 300 ratios we want
to sell that so the way that we do that
is we iterate through all companies that
are in this context up my universe down
index if those companies are not in our
context portfolios positions we want to
buy it if it is in the if it is already
in our we already have a position that
we don't want to buy it then what we'll
do after that as we iterate through all
of our positions and if we have a
position that is not in our context on
my universe on index or our a universe
we want to sell that position so that's
the plan let's do it so the first thing
we need to do is we'll define our cash
as context portfolio dot cash
controlling leverage on quanto peon
still seems to be a little bit of like
black magic or an art form unfortunately
I wish there was a way to just say like
this account can will only be granted so
much leverage that would be a huge
request on my my part because right now
your leverage can get way out of hand
and in the real world
someone just would not give you that
much leverage but regardless we're gonna
attract cash and then we'll have to do a
couple other things to make sure we're
not making mistakes with leverage but
for example if you define cash here as
you buy and sell companies you have to
update this cash variable within this
function here but then there's a couple
other weird things that happen so anyway
we'll say cash and then we're just gonna
we're gonna define an arbitrary purchase
value of M we'll do 1,500 for now and
then what we're gonna start doing is for
stock in context my universe index if
stock not in context portfolio positions
we're gonna say another if statement
we're gonna say if purchase underscore
value is less than the cash that we have
you could also use an and here and keep
adding but I don't really have the space
for that so just put on new line what do
we want to do well we're going to order
underscore target value stock purchase
underscore value close and then we have
to do cash minus equals that purchase
value that way within this loop here we
are updating how much money we have in
attempt to control our leverage also for
some reasons sometimes you get to this
point and you try to order a ticker and
an error occurs thus I am going to
encase this in a try and accept and by
the way if you highlight multiple lines
control and closing brackets will shift
over writes control open brackets will
left so
yeah and then I'm just going to accept
impasse no that's not pythonic you might
you can do whatever you want to do but
for now this is literally just to keep
the program running okay so that's our
purchase logic now we're going to work
on the sailing logic so the way that we
would sell companies is bot is doing
this for stock in context dot portfolio
dots positions what do we want to do we
want to go through the companies that
are in our universe so what we would ask
is if stock not in context stop my
universe Don index we want to order
target value stock zero then finally we
wish to record and we're going to record
with the name of leverage context dots
accounts dots okay
leverage there we go all right so we're
going to go but you're gonna see this
causes trouble immediately we'll start
with one three 2003 and we'll go all the
way to but you'll see within a few a few
moments we're actually going to have an
issue here so what's gonna happen for
some reason is leverage is going to get
way out of hand I look at this and I see
this is a logical script I believe I
mean there might be some minor issues
here but I believe this is a logical
script and up something went wrong
anyway so runtime error at line 17
output hmm I am Not sure
let's try again that's not even a that
didn't even change on this oh I put
meant to do 2003 there so I think that's
our issue is that I was trying to pull
from 2002 I wish it would tell you like
oh no data for 2002 or something
something useful wait for it okay so we
have our leverage it's already ticking
up like crazy but that's kind of to be
expected but then up shoot we're at one
point one throw my goodness it's just
going crazy it's good and just mad so
this is gonna continue going crazy so
first one I'm going to show you though
is that if I was to come here and and
we'll just I'll just we'll just delete
this okay that hole that line here and
remember all this this loop is doing is
ordering a target value of zero that's
the it's the target value so we think
there would be no mistake as far as
accidentally producing leverage of some
kind I'm not sure how it's occurring but
as I'll remove that we'll check the back
test here and you'll see that it didn't
actually it's not causing issue the
other thing you can do is order target
percent and once this loads I'll show
you target percent and how it doesn't do
anything either and and then I'm going
to show you guys how I've gone about
handling for leverage but there are
other ways I saw one person posted a
sort of a code as far as handling
leverage was concerned is actually
pretty good code it was like a class
that would control your leverage for you
so anyway this is remember this is
actually this is this back test is
running without that little loop there
okay so we're actually doing quite well
right now but anyway and leverage is
being held at a perfect one canceling
the back test and then let's say we try
to order a target percent of zero and
you'll see it goes wacky so I'm gonna go
back to target value or we could leave
it as percent but
I'm gonna put it as value what we're
going to do it to remedy this issue is
first we're gonna come up to initialize
we're gonna add a new variable and this
new variable is going to be context dot
stocks underscore sold that's just gonna
equal a list as you can see leverage is
going crazy so I'm just gonna cancel it
right now okay
so that that's gonna be stocks sold and
then what we're gonna do is every any
time what I believe is occurring and
what I'm about to prove as a current bug
would be that sometimes for some reason
this will plausibly double sell a
company or something and you'll find
yourself in a leverage situation so the
way we're just gonna go around this in a
really simple way and every time we sell
a company we're going to add it to the
stock sold list so order target value
stock to 0 what we're gonna say is down
here context dot stocks underscore sold
dot append the stock and then what we're
gonna say right above that if stock not
in context dot my universe dot index and
stock not in context dot stocks sold
then will perform that operation that
way hopefully the stock is only sold one
time finally what we have to do is if
we're doing this we need to also come up
to the handled data otherwise we would
in theory by the company and then we
might never sell it because of this
question here so when we buy a company
if stock non-ambulatory soul if it's
there we need to remove it because this
is a new position for us so we're gonna
say contacts dot stocks sold dot remove
stock great
let's build and just make sure that
things are the way they ought to be and
then if so
we'll run a fullback test and I'll
probably pause it while I run the
fullback test I don't really see much
point and sitting through it but maybe
you guys will sit through it too but I
have nothing more to say so anyway so it
looks like it's building at the moment
without an issue we don't appear to be
launching out of our we appear to have
control over leverage but I'm gonna wait
until we hopefully get to it a one maybe
okay I'm gonna go ahead and pause it and
I'm gonna run the fullback test now just
because I'm fairly confident that we're
under control of leverage so everything
looks good so this is from January 3rd
2003 2 to 24 2016 that's basically to as
far as we can go so now we're gonna go
ahead and run a fullback test and while
I run this I'll just pause or something
and then I'll continue one all right so
that actually did a lot better than I
intended or expected probably just
really got lucky with some of these
initial companies here but you'll see
leverage at the highest point was at
point 6 but really for the rest of the
strategy it was at you know 0.5 looks
like my browser's about to crash on this
data
all right great anyway this is gonna go
down and came back alive ok so let's go
back to the algorithm while we still can
and I think double or something just for
kicks let's do purchase value it let's
do 3,500 okay and then I'll run the pull
back to SL posi you can stick around if
you want otherwise you can leave these
back tests kind of take a while to run
so you can figure out what the answer is
maybe a little quicker so I'll just run
this full back test I'll pause it and
then we'll see what would happen with
that larger investment all right well
that helped a little bit but as you can
see our leverage is still pretty low
okay so you can you can increase your
buy size regardless I really don't trust
this output I mean it's it's possible
this
strategy really did this but and our
leverage did not exceed point so I don't
know maybe maybe this is a good strategy
there are plenty of people who buy into
a momentum strategy but I'm skeptical of
these earnings to say the least
especially these earnings although I
mean like here we made quite a bit of
our progress at that full 1.0 leverage
and then we've gotta made a lot here at
point six leverage and then we kind of
followed the market basically all the
way to here until we started going
closer to one leverage basically every
time we started to go up and leverage
except for like maybe right here
we were actually outperforming the
market and so maybe you could keep
adding but feel free to player play
around if you want I don't think that
this you know maybe these are the real
results but it's probably more by luck
as far as which companies we found here
I'd love to see this strategy over even
a longer period but you know to be
honest this is 13 years that's a pretty
good strategy over the course of 13
years and there are certain like we
obviously outperformed significantly
here here here here and then we start
underperforming basically here so anyway
let's really do to leverage and I
probably wondering you know you could
probably start coding in some you know
automated leverage handling which
basically would find all of the
companies in here because basically all
the companies in your universe those are
the only companies you would be
investing in therefore every each time
you go to make your investments you
could like dynamically choose what the
investment size is based on the
company's you know you're gonna buy and
that would be a way to always have like
one leverage so you can think about
something like that and maybe that would
work out I but I'm really meant to just
keep this simple but it looks like we're
off to a pretty pretty good start if
these are reliable results so anyways if
you have questions comments whatever it
feel free to leave below in the next
tutorial we're going to talk about using
the sin tax data with the pipeline so
anyway stay tuned for that otherwise
until next time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>