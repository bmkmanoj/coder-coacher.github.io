<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Testing our Machine Learning Strategy - Python for Finance 17 | Coder Coacher - Coaching Coders</title><meta content="Testing our Machine Learning Strategy - Python for Finance 17 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/sentdex/">sentdex</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Testing our Machine Learning Strategy - Python for Finance 17</b></h2><h5 class="post__date">2015-07-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/YfCh2atatSE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">in the last tutorial we showed how we
can use machine learning to feed in the
features and we're actually making the
predictions now we're ready to add this
to our algorithm so first of all what
we're gonna do is instead of if ma 1 is
greater than ma - let's go ahead and
just really just throw it all out there
and let's just say if P equals 1 we'll
do that l if P equals negative 1
we'll do this and I think we're ready to
rumble
that should be it so let's go ahead
let's go way back in time here let's
just go to the earliest time possible
and let's run a full back test and let's
just kind of see what's happening and
hopefully we can we'll watch the
leverage make sure leverage doesn't
exceed up got a problem
let's go view algorithm what's wrong man
invalid syntax on what's the syntax
error
I forgot our colon here try again all
right real moment of truth now no more
syntax errors man so back testing here
oh no input contains okay so line 82
let's see where is line 82 and doesn't
need a line 82 what have you done
pre-processing scale X so what we need
is we're gonna have to in case really
let's see for stock in context we can't
if we can't really do anything if it
contains a knotted number and that's
probably happening when we do the
percentage change possibly if there's
like a zero percent change and we try to
calculate or if there's a zero change we
calculate a percent change maybe that's
throwing the air
for now let's just be naughty coders
let's in case everything under here and
a try and accept so highlight everything
after this try all the way down to the
Elif statement cool hold control press
the closing brackets that's above your
Enter key to the right slightly good
that's our try now all the weight over
one tab except exception as e print
whoops print string e all right now the
real moment of true here we go no oh my
goodness give me this unexpected
unexpected unending that's on line 98
okay so you are truly killing me smalls
truly killing me so probably what we did
this time is the try it's for stock then
try correct
right so the try needs to be two indents
over okay okay okay okay
seriously the moment of truth everyone
here we go alright if I see another err
I'm just gonna I might cry on don't
video I don't know oh ok so at least
we're going I don't know about trade so
it'll probably take a second to trade
should take a hundred days to trade so
we're trading and actually right now
we're trading purely on the signals I
don't think we're using moving averages
so so far we're doing ok but we kind of
cheated because at this point the market
was worse off than us when we started
but that's ok I don't mind cheating
so probably what's gonna wind up
happening though is this may just
hopefully it doesn't just continue its
downward descent forever but we already
know that at least on the log output
oh-oh-oh see
are we still printing the prediction we
are still printing the prediction so
although that's so weird that we have
these predictions but then we don't have
oh okay all right so yeah so on the
first few days I guess it just it's
gonna it just takes a while because you
have to wait through a hundred days
basically because we're using 100 bars
so that's all that was happening there
otherwise we're making predictions just
fine I was like man this is crazy okay
so coming back up here come back to our
whoops now I want to see our back test
how are we doing result so a review not
very good all right so we're already at
negative 70 percent returns with a 72
percent drawdown so that's no bueno so
what we're gonna go ahead and do we
don't need to see this through so let's
cancel in fact this stop the pain and
let's go back to our algorithm that's
okay what we're gonna do now is now it's
if so like we were asking this question
basically well what we can do now is we
can say instead of that we can come in
and be like okay well first of all
there's a few things that we could do we
could change the feature window right we
could we could make that longer shorter
we could change the amount of history
that we're reviewing that might help we
could also change we could add more of
those classifiers here we could do a lot
of stuff there and in fact let's let's
just let's add more classifiers before
we go back to the moving average but
we're gonna end up reimplemented that
moving average most likely now coming
down to basically CLF here let's call
that instead of CLF we'll call that CL
f1 now we're gonna do is we'll take that
copy
let's do paste paste paste will do will
do four classifiers so two three four
and now what we're gonna do is let's
bring in
linear SVC let's bring in new SVC and
then we'll bring in logistic regression
awesome so we've got those now here at
this point so we've got the classifiers
then we trained the classifiers so see
LF one fit just copy this paste paste
paste down a line what you could do is
you could create a list or an array that
the elements of the array or that list
are these classifiers and you can say
for classifier you do the fit and then
for classifier you place a vote stuff
like that we could go really fancy if we
wanted we'll just do this copy and paste
this not too bad it's not a very long
list so we'll just keep this but just
note you could do it better and then
instead of P we're gonna say P equals
that and then let's just do paste paste
paste and then this is one two three
four and this will be one two three and
four
no problem there so now we've got our
fitments we've got our predictions and
now we need some way to like vote okay
and so to do that we're gonna use the
counter so what we're gonna say is if
counter ash this counter is capital C if
counter for the list that is P 1 P 2 P 3
and P 4 so these again if you remember
predictions come out as an umpire array
we 0th element of that numpy array is
either a negative 1 or 1 so there we go
so these are negative 1 or ones this
will be a list of negative ones and ones
so if counter is equal so we're gonna
say if the counter actually what we need
to do is dot most underscore common most
common has a bunch of elements too and
basically what we're looking for is 1
and then we're gonna say but the 0 with
and then the first if so most common
does is it's gonna it gives you like the
most common but it gives you like a list
of the common is you know the elements
so
what will happen though what can happen
is like we've got four classifiers so we
might have two negative ones and then
two positive ones and then it's just by
chance which one you get as saying it's
saying is the most common so we're gonna
require we're gonna require it to be
greater than or equal to four so later
on we could say three right we either
three or four have to come into
agreement but right now we're gonna say
all the classifiers have to be in
agreement that the prediction is X okay
so if that's the case what we're going
to do is we're gonna say P the
prediction is equal to basically this
right here counter all this and then
instead of this the one here just make
it the 0th so what most common comes out
with is just like a tuple of these
things so it'll be like a tuple it'll be
the number and then the number of
occurrences of that number so we want it
to be four basically and then so like
the zeroth element of the zeroth element
of that most common that's going to be
the actual prediction so then we say the
P is that cool otherwise we're gonna say
else P equals zero
that's totally fine and then basically
nothing will happen here okay so LS p
zero cool now what we can do is we'll
run that full back test again that's
saved run the full back test
so now just basically in order to make
any change in our movements we need all
the classifiers to be an agreement that
yeah we're ready to make that change now
again this probably is not gonna save us
we'll see what happens but I'm guessing
it's not gonna save us so in a hundred
days we'll start making our trades you
could also start the algorithm at a
hundred days that might be a good idea
and then we can reference the previous
hundred days of bars and that might
actually do us pretty well to do that so
the day the start day here is May
thirtieth so maybe in the future ones
what we'll do is we'll start at May
thirtieth err
more in there it's yeah bout me leap me
somewhere in there so initially we're
pretty much shorting everything clearly
we're invested in a few things because
we're coming down but clearly we can see
mostly what we're doing is shorting
companies now since we're also plotting
the moving averages we can see that we
would have been shorting everything up
to this point and really we can see here
that we just still we haven't gone long
really anything except for maybe right
here we're long because you can see
basically you're long if you're
following the market pretty much what
we're saying here we've still got quite
a bit of divergence and we're almost to
the point where it looks like we're
gonna pan out almost identically to what
we did before so the last thing I would
do to this before we kind of move on
would be incorporating those moving
averages as a form of protection so
we'll let that continue running in the
background if you didn't know when you
run those fullback tests you can run the
fullback test and then like leave and
work on something else all right I'm
pretty sure you can even like exit
quanto peon and come back later and
it'll be finished so if I understand
waiting on algorithms just like go do
something else
so anyway coming back here if PE equals
one cool and then we're also gonna say
and ma one greater than ma two and then
we can come down here and if P equals
negative 1 and ma one is less than M a 2
so we can do something like that and
that's saved let's go back to our back
test to see what we're doing or still
losing money left and right awesome
awesome
but our leverage is 1 so that's always
nice so things are working the way
they're supposed to at least let's go
ahead and run this other back test
though and we should see that we're a
little more successful also let's let's
let's be legit here and start on May
30th run that full back test and now
that other back test is running that's
ok we'll just let it keep running and so
you can run like multiple back tests and
again if you if you like run a bunch of
back tests and then you're like oh shoe
what was that
I set you can always go to that specific
back test you click this over here and
you can view the code that is comprising
of that back tester made that back test
so here we see results that are a little
more close to what we had and the you
know previous algorithm leading up to
here that was basically only trading
those moving averages so right now we're
we're shorting pretty much everything
because we're basically doing the
opposite of the market right now it's
pretty much a mere something actually
we'll go back here and it's like this
one is also running we're still just
constantly losing money see if we've
actually had an uptrend at all no not
really
so this one pretty much for some reason
wants to basically always short
companies it's not really confident
staying bullish on a company even though
we've got like all this trend here which
is interesting because this other one I
think will end up going bullish quite a
few times let's go back to it right so
right now we're in agreement with the
market but all it takes is like one
agreement right one full agreement with
the market and then everyone else we
can't we can't go against the market
until the moving average so once we have
at one point all the classifiers are
like yeah let's go ahead and do it
that's gonna stay the case until it's no
longer the case that basically
everyone's in agreement that yeah we
want to short it and the MA is less than
MA - so you could also you could throw
something in here - where either you get
out of a position based on like everyone
in agreement even if the these are not
crossed over right or get out of a
position even if everyone says ba ba ba
ba bi but these crossover and clearly
we're trending the other way you can get
out so that might actually doing
something like that might help the other
backtest what we're basically just
losing all of our money but right here
we're actually doing pretty good right
like starting from the same point of the
market we experienced a little bit of
drawdown that brought us into the
negatives you know where we actually
lost money but so far we've actually
done the opposite of the mark
didn't lose very much money at the same
time we're currently beating the market
but the market is edging up to us
probably what I'll end up doing is we
can't just sit through this and like
wait all the way so probably always I'll
cut the video here and then we'll I
won't continue on to the next video I'll
just cut it here and then we'll pick
back up once this back test is done and
we can talk about it so stay tuned for
that okay so the back test is done now
we got eighty six point four percent
returns so slightly better than the
other strategy and I went ahead and ran
the other strategies well for the exact
same time period so before the previous
back test we had was starting at January
first or actually January third I think
to 2002 so I went ahead and ran them
over the exact same timeframe now
they're both really similar weekly
returns are a little different this one
earned a little less money here than
this one did and that's probably just
because this strategy is a little less
wild than this strategy so you can even
see that this again this is the long
short this is the one that's not using
any machine learning at all max drawdown
here 33.1% as opposed to 32.3% so not a
huge change in drawdown but still that's
that's a change and then sharp here 25
sharp here you know
sorry not 25 point 25 and then point 26
that's pretty crummy Sharpe we want to
really that's probably the worst part of
this entire algorithm is the sharp I
mean drawdown we'd like to see that
change too sharp we that like x like 10
drawdown we could divide drawdown by
like three and be happy returns were a
little better
alpha remain the same beta is slightly
better so with you you know the
inclusion of machine learning without
actually customizing our machine
learning in any way all of these machine
learning algorithms are very specific
algorithms so again I will just
reiterate that you'd want to come
through here maybe check out a lot
there's so many things that we can
change in parameters and stuff that we
can set here that it would really be in
your best interest to go ahead
and look through these and this is just
for the random forest classifier I mean
there's for all of these classifiers I
highly recommend doing that and then and
basically you should you should see over
time that your returns as you kind of
fix this strategy your returns should
improve slightly as you kind of gear
your classifier towards towards trading
basically and towards like the specific
problem that we have and then you know
maybe you can lower drawdown by even 10
up to 10% even just by tweaking the
machine learning classifiers but then
there's a lot of other stuff that we
would want to be able to do like like
here this is our major point of drawdown
like right here and we're it's like this
point of drawdown where we hand back
basically all of the gains that we had
made I mean this is almost the highest
point in our entire algorithm and it
takes us a really long time just to get
back to this this point so it's useful
to be able to detect these kinds of
events occurring and stop them
immediately so one thing that we could
do is a form of stop-loss there's a lot
of other things that we could do as far
as stopping this event okay this event
here but you have to be careful with
stop-loss because stop-loss you have to
make a decision on like where you want
that stop-loss to actually occur at what
point but sometimes it may be if you
just waited a little longer you're you
know prediction would have come true and
you would have made a lot of money so
anyway that's it for now I just wanted
to show an inclusion of machine learning
machine learning as long as you get kind
of used to it you'll kind of see that
you basically apply it the same way
every time it leaves via scikit-learn
but again it would be really useful to
learn about this specific classifier
that you're using and try to play with
the with the parameters that you can
change once you learn about them and you
should see that this this whole
algorithm improves quite a bit so
anyways we'll go ahead and cut it off
here if you have any questions or
comments up to this point please feel
free to leave them below otherwise as
always thanks for watching things for
all the support subscriptions and until
next time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>