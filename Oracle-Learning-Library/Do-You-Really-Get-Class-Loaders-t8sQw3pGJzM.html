<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Do You Really Get Class Loaders? | Coder Coacher - Coaching Coders</title><meta content="Do You Really Get Class Loaders? - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Learning-Library/">Oracle Learning Library</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Do You Really Get Class Loaders?</b></h2><h5 class="post__date">2013-01-30</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/t8sQw3pGJzM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so my name is Evgeniy kobata the CEO and
founder of zero char owned a company you
may or may not have heard about and
today I'm going to speak about gloss
motors or how we tend to gently call
them as your journal class holders so
the talk so before so this talk is
usually very very interactive
this talk is also usually in a smaller
audience oh hey what can mic now it's on
the wire that's bad I generally like
walking but yeah I guess I'm just going
to stand in front of it so this talk is
typically very interactive which means
that actually ask questions from the
audience and expect the audience to
answer me unfortunately well this is a
bit larger audience for this so how
about the first you know three to five
rows are on the spot so so the fate the
fate has decided that you guys are going
to be are going to be and actually first
row of course you know this is I'm going
to come personal ask you let's stare at
you into the answer so say so I will
expect you guys to work along with other
words it's kind of boring they're all
behind you can also work you just have
to scream really loudly otherwise I
won't hear you but otherwise you're
totally welcome to scream you know your
ones off and also classically I let you
to interrupt me with questions again
here is going to be tough so let's say
this way you can interrupt with
questions but I can just miss them if I
feel that it's just too much so and my
background is I'm a software developer I
have a computer science degree I have a
lot of stuff I've been working on
virtual machines programming languages
all that kind of stuff for many years
have published have done all kind of
stuff so you know I
some some background which says that I'm
not a complete idiot and that actually
what I say is not complete but
you know still obviously everything have
to be verified
now just joking it's all complete truth
and if you'd like to comment something a
good place to comment is also on Twitter
so without your iPhones and androids and
windows mobile phones and comment at a
Cabana or like hash glass holder or
something so you know whip it up guys
don't don't make it boring I don't like
it work so again like our the background
of the company would mainly known for a
product called arable which is basically
prevents redeploys and restarts and
builds and developments allows you just
traded code in UID and immediately see
feedback in the browser we are pretty
good at that we have a lot of customers
happy customers and I hope some of you
will join those ranks but the talk is
all about that though you know if you do
want to try it then you can get it for
free on my gerbil comb but the joke is
actually about what we did when we were
making a gerbil and well we had to do a
lot of very very hairy very weird things
we had to cook hook into the class
holding and JVM levels and many
different idioms we had to plug into the
class holding in many different app
servers the latest test matrix that I've
seen just twenty two versions of jdms
and fifty-five versions of different
application servers so that's a lot
which means that we know more about
glass holders than anybody ever would
want to know we sold hundreds literally
hundreds if even maybe today thousands
of issues connected with class orders
and now well we got very depressed but
then we decided that you know the
depression all this effort has to get
somewhere so we made this talk and
actually interesting enough next month
we also releasing like ebook which is
basically the content of this talk and
then some
next month if you search for zoo
returned and class holders will get the
very nice very very nice materials I
think that the release is something like
19th October this is the next month next
one this is actually already this month
I'm a bit confused here
so obviously you know I stand on the
shoulders of giants and in this case two
giants or the three giants is first of
all Vijay's a shrub who wrote the paper
that Java is not type safe which was a
seminal paper we changed a lot of things
in Java which I very much recommend you
to read if you have time and wish and
also Cheng Liang and Gilad bracha the
dynamic was soaring in the Java Virtual
Machine so these guys came up with the
whole idea how to use class orders for
the dynamic class reloading there this
is a very interesting paper it jogs
autobot very interesting talks a lot
about white class or is actually as hard
as they really are so today we're going
to cover the basics pretty quickly we're
going to talk about problems and
solutions and this is the bulk of the
talk it's about I'll show you particular
problem and ask you how would you solve
it and then I would try to suck out the
solution out of thin air if you can't
really tell me so then we will talk
about why do color class orders white
classroom is so troublesome why do the
leak why it's very typical fabrications
to go without a memory errors in
production after a lot of redeployment
and then we will probably talk about
OSGi spring dmj bus and others because
there's never time and anyway they were
less interesting than the rest of the
stuff because there was so the stuff is
more practical so and then we're going
to discuss just kind of a bit of future
in a bit of conclusions all right so
just let's start with basics here's the
class holder he's a little bit shy but
he's he's you know he's actually in the
java.lang package and not a lot of
people seen him so but really first of
all you know class order it's an object
so it's it's a it's an abstract class
and then
the actual class soldiers will implement
I will extend that class there will be
actual objects in memory which will do
things the by far the main method of the
class or is load class which gets the
name of the class what's called a fully
qualified name so don't separate it you
know a bit dot B BB C dot kalasa
my class so and returns an object of
class class that's going to be a lot of
that thing coming on the whole class
class thing so this is basically the
representation of the class as loaded by
the JVM from which you can upgrade
objects from which you cannot manipulate
so it's already exists for the JVM
another important method is defined
class so this is actually internally
this is actually the method used to like
materialize the class for the JVM so the
byte array it's actually how will this
go to class bytecode so it's the actual
you know it's loaded from disk or loaded
over the network whatever but you get in
the end you get a battery which is
representation actual class and then
they define the defined class method
create loads it into the JVM loads it
into memory materializes it initializes
it blah blah blah get resource and get
resources very important methods they
they're the other part of the class
order contract and this is that this is
kind of the class path contract that a
class holder can take a name and return
every URL a return a resource actual can
also can return directly an input stream
so and one of the important part is that
that get resource if you give it a class
resource right so you know this a a / bc
/ my class dot class you know there's
actually a unwritten contract but
nevertheless upon check that it will
return it as a URL it will join it as a
resource so we so get resource and get
resources they're very very important
sometimes and you can use them to load
resources and for other more interesting
things as well and finally every class
holder has a
Varian class which means class for me
hierarchy right so remember this is an
object key not a class hierarchy so you
know my particular object has a parent
and then that one has a parent and then
at some point there's a system class
petryís on that one and and then the
bootstrap class or is actually something
weird so it's it's not real weights it
doesn't have it's a null mirror of an
eye in all some versions of jail please
okay so that's an interesting thing to
know about class udders
and which explains a lot of them
originally class videos were motivated
by applets remember in 1995 applets were
all the rage they were going to be what
Java was all about so and one of the
issues that we had in 1995 is we had
those things called modems some of you
might not actually have seen them but
they were real
we had the whopping speeds of you know
maximum 56 kilobits a second
I took 24 hours to download one album of
music from Napster and I did say that
and and so one of the motivation for
class orders was that class ode is
allowed you to load one class at a time
over the network which was supposedly
faster it still seemed like a lifetime
but it supposedly was faster so really
like largely in the at least Java 1 to 2
and 1 to 2 and class orders were largely
motivated by applets this actually
explains a lot about them and also by
the loading resources over the network
right so get resource and this gift
resource and like both class they're all
completely abstract methods that you can
actually you know you can actually load
them over the network we don't always
say that they're backed by a file system
something that so class loading so this
was the first part all you need to know
about class for this is the second part
so class loaders are actually working
the way that everything in Java is super
lazy
everything is done at the last possible
minute and typically a class will be
loaded when it's referenced somehow and
it's referenced either by constructor by
static field by static method or that's
it pretty much
so construct a static field a static
method there also some reflection
some ways to load up your reflection so
and when you actually when we when it's
referenced then what happens is that
like it's not really that particular
call but it's completely semantically
equivalent to that particular call and
so what do we do first of all we do a to
the class so that's just a way to get
the class class object of a and then we
do get class order so every object in
Java is associated with its class every
class in Java is associated with the
class order that was used to load it
right so this is our true can a context
class order which is very confusing
because there's another context class
order but basically that's the class
order that used it was loaded us and
then we use that class order to load
class B right so this is this is how it
always happens and okay that's all about
the basics any questions good so let's
get to the interesting stuff faster so
class orders have a parent class holder
but really you know why is that
important is because typically the
parent will be consulted first right so
this is this was originally motivated
basically because you didn't want to
load the same class several times but in
Java EE it's actually reversed right so
if we want to the next slides this is
like a typical typical web container or
application container more likely so
which has a class order for container
actually has a ton of class orders for
container it has a class order for each
year and it has a classic refresh more
and again this is hugely simplified
because if you just start up JBoss
you're going to get 90 class orders
without anything deployed yet right so
but in a very simplified world view
which is what we are interested in this
is outlooks and the wars are very
special because in it whereas every
other class order when it gets this load
class method call it will first ask the
parent class where can you hold it right
so for example in case that parent class
order has a shared library and you
always want to load it from there so
that you won't have duplication then the
more class order is there exactly worst
like if they
first of all try to blow the glass
themselves and then delegate to the
parent why is it why was it made like
that the reason is that at that point
there was this problem that containers
would shape with a bunch of libraries
and then the versions would be very old
and then people wanted to overwrite them
like for example classical is like look
look for J and so on so the designers of
the JV container they wanted to
guarantee that the web application
actually runs with versions of libraries
that use is shipped with and not the
ones that it loads from the container
and so that they did this search the war
first that probably caused more problems
with class orders that anything else
ever so that was kind of a shaky
decision especially considering that
later down the line every container
started if they ship some standard
library they would actually rename the
package because the conflicts was due to
do too problematic in the reality okay
so that's all that's no more basics now
we go to the problems and solutions
still no questions you know maybe I'm
just sir oh you have to scream I'm sorry
okay so the question was how does the
delegation I think the question is how
does the delegation in Java EE and so
it's from what bottom up like so bottom
class orders delegate to the top ones so
war delegate CR year our delegates to
container continue the gastric system
and bootstrap the only difference is
that war will first check itself and
then delegate where CR will first
delegate and then check itself right so
that's that's only difference right so
let's go to problems and solutions and
now we go away from slides
almost new into return now i'm
especially my giant laptop doesn't let
me speak very well so wait lip loops
okay
so what happened hello
that corrects this doesn't
I was trying to disable school
okay yeah I know what happened here but
it's fine now all right sorry about that
so this is our first program it's very
very complex so it's a servlet which go
test one and only does is out dot print
util one say hello say hello returns
hello very complex code you probably
haven't seen that complex code in one
oh sorry but when we actually go so it's
running Tomcat and all that but when we
actually go here then something bad
happens exception so now imagine this as
you know this is your production so what
do you do how do we spoke that but had
everything worked in the IDE so this is
one of the simpler problems but I still
like to solve it so what should I do now
I am at loss
sorry okay so u21 didn't know float why
I like the war well so I I don't
actually know where my worries okay so
you should find the war but how do I
find the one so here's an interesting
thing what are the containers are really
really annoying and what I mean annoying
a Seca Bloods probably should set a try
servers but reality is that what a
containers will catch a lot of things
they will unzip things in weird places
their work things with weird places and
you actually can never be sure where is
that from so if you get classmate found
typically although it's useful to check
the war file if it's actually there it
actually might be there and it's to a
problem so there's a tricks which you
can actually do for that and one of the
interesting tricks is that you can
actually in many containers not at all
but in any containers you can you can
get you can get the container or plus
order to confess where is it loading
things from and the way you do that is
that so I take the test one and get its
cluster and then I cast it to URL plus
order so that it doesn't always work
sometimes it doesn't work because not
all clusters the dissent when you have
class or but in majority you know a lot
of cases it does and I will also talk a
bit about what happens if it doesn't
work damn it
so your rail class order there we go
euro clusters actually has a mythical
interior else which returns the class
path rights but every all dangers in the
class path and if we now refresh then by
the way we'll find out that our class
that is really strange it's as I said
like modern containers a very annoying
wonder 97 worn one
so my war is actually somewhere knows
where and and what they've watched apart
is that I can now go here we're in that
your file where this glass was supposed
to be so I can go there and I can
actually I date it I can find out where
the glass is actually music so why am I
going so funny you know such a simple
thing why we do so complicate it example
I'm going to be sewing in such a
complicated way well one of the biggest
problems with clot soldiers and this is
a less feasible here but there's going
to be more and more visible with every
next example is that damn it
and I've never seen two using keynote a
lot so one of the problems with glass
owners is that glass shatters all at all
class learning happens at runtime so all
the things you build all the things you
compiled everything you did in the IDE
it's always irrelevant monitors all
happen at Franta and which means that
that sounds that we usually make their
head aesthetic and oh yeah they're
they're usually so the biggest the most
important things with classrooms is you
have to always validate your assumptions
and for example so for the particular
glass compound problem it's quite for
the simplest one you can get with glass
holding it usually has one of the two
variants he's a constant
section one class a day found error and
error exception so the first one happens
when it's expected the second happens
when basically something fails like
really if you do a newbie and B cannot
be loaded then that's the class but if
Darren happens and what you can do well
you can you know do that d-class lookup
you can do the searchers but in reality
this doesn't actually tell you where the
container looks classes from
unfortunately there's not amazingly
great ways to find that out because
basically the class wasn't loaded so
there is no information about where it
wasn't loaded from it's a negative but
it's usually worthwhile - I've been
trying to get the idea really get URLs
kya cos Omega T Rails method or if that
doesn't work then just try container
specific hoax or for example in Jameson
inside some others you can actually
connect through a Jenkins soul and for
most classes you can basically just a
particular class or you can ask what's
its class path through the through the J
like this chain links interface okay so
that was the easy one let's go a little
bit more hard the quote is way more
complex now to test to so you know it's
very very complex code now much more
complex than in the previous poll and
let's go to the actual thing right
so no such method error but it clearly
works what's happening
why is there no such method error uh-huh
the class is different okay why a huh
different version hi
I've sketched quite possible how do I
control that how do I find out okay so
it's very it's a relatively common
problem and this happens yes from the
plural plot version of witness has been
deployed for some reason instead of that
one this usually happens either to a
version with mismatch like you deploy an
application with the wrong version of
the library it happens in many
unfortunately many other cases as well
cash is a cause the things that can be a
cost and voltage method there is
actually by far the easiest I'll show
you if you're others later which are
much harder and what you have to make
sure is actually have to understand
where is in the class loaded from to
solve the problem to truly solve the
problem don't just you know start
hacking away like I'm going to just put
the class with a coin build trying to
understand what actually had where it
was cached why it's cached why their own
version and to do that you need to
understand exactly where the version was
loaded from so luckily the JVM provides
a wonderful tool for that which is
called - verb Rose called glass I think
I'll check later I would check circles
you wear every class of alt so that's
the easy one but if you don't like
restarting the JVM like I don't and if
you can just develop then another way to
find out where the glass bullet Rome is
to use remember I was talking about that
for every loaded glass you can also use
the method with your get resource to get
the array so we can just use that again
hold it so I just call it first then
I'll explain what happens so now what
we're doing getting chest to class we're
getting it across river that loaded us
we sang give me the resource and they're
saying this is a util to class good name
we replace the dots with slashes right
so it's a to B dot C not say slash b /c
and we have that glass so we get the
actual file am of the class source name
of the class and when we do that then we
find out where it's loaded from all
right so it's loaded from here and then
since we're going to eat that and it's
in this in place actually so it's useful
to lift class just get bigger again so
it's two two two two classes you gain
some totally weird place which you never
know what you look at all right so
tepees zero slash or whatever and unless
just check what happened so Java
actually shapes the very nice tool
called Java P jela P allows you to
disassemble the class adults of your
easily to dump the class structure when
you fall detection will done the
structure so if I just do this I can
indeed see that the two two does not
have the method right spoke I've
verified all my assumptions now I know
that this is where it's old from and
that really doesn't have a method so
everything is correct why would I want
to go to such lengths and less options
well for starters as I said no such
method to most acute on there is by far
their simplest of the ones you can get
so you can get an abstract method there
if the for example if the method you're
calling is an interface and the
interface is there what the class
doesn't actually implement it or the
class implements it but doesn't serve
the class in
doesn't actually have the minute for
some reason overreach the method used to
be abstract and now it's not mr. so it
like the absolute method error is rerun
going plus s exception a for example
you're calling an interface and the
glass start class actually does not
implement that interface what you'll get
is class cast exception actually you can
get even worse
so now I should think if you can also
given even by far worse things from
there but the class cast exception is
fairly reasonable or unreasonable
actually as happens I'm thinking
actually you'll get even a linkage here
from there so so this is the point is
that an illegal access error for example
the method used to be participatory feud
used to being protected of private
announced public right then you have the
older version you get an legal access
error so this wrong class found it's a
very large class of problems and usually
the very very good right so the the one
that I shown is by far the simplest so
what is important for us class if you
can do that plus where to get resource
and always verify that yes actually you
know verify assumptions by J the Java B
or like looking at the clocks with some
other bided editor because honestly the
first thing you always want to do with
classes verify your son France because
it's so easy to assume something wrong
and then just spend a lot of time that
way you know this like Tokyo to the
watch early also were they winning else
windows watching meals I do want to know
this an interesting image okay
so sir
the patient race does get closer to get
research work from classes loaded from
the boots trip it's a very good question
and I'm actually not sure outright I
would say I'm out out was it that yes
Adam not sure there was there any other
questions sir
okay so the question is asked on found
exception and class on they found error
again they were damn it and there's
there's no substantial friends except
that class not found exception is thrown
mainly by reflection methods where you
explicitly load classes or something
that a classroom tip from there is
strong from like random place in your
java code
you know were you trying to access Class
B and it's just not fair right so
there's no way to throw an exception
from there because you don't expect a
checked exception so an error is grown
and that's the class on the under so
there's no substantial difference they
report exactly the same thing adjust
their checked exception is from their
most simple reflection methods and the
error is from one actually you're not
doing anything with exceptions okay so
the next problem even more interesting
one map okay this time oh so now I have
a factory so in the future obviously in
the in the future I plan to add all kind
of XML and you know quite interesting
features but at the moment the factory
is embarrassing so I have a factor class
engine turns into instance type and then
say hello so if I actually look at util
three say hello minutes again the same
so nothing changed here but if you
looked at the factory three then it's
it's basically returns a new your tools
of rights very very simple as the
natural everything seems to be very easy
and we have to
two to three because it returns an
object but otherwise everything is okay
so let's see what happens if we do that
boo class cast exception it you three
cannot be cast you till three
who has see that in production
all right you two guys are the closest
tell me what does it mean different word
is one okay we have one different
versions different class voters anymore
make your stakes guys
whoo he knows his thing so so when you
see that you're guaranteed that there's
two different class odors in play and he
will make a very interesting historical
note why does this even happen so in
1990 519 the 1996 one Java one one that
one came out then basically every class
I was always uniquely identified by its
name unfortunately what this and got I
can I can never remember his name
what's the guy of the first vapour
identified was that
unfortunately this mean that applet and
created Yan lang string and because you
know it's only identified as a Java one
string the name getting shifted into the
sandbox and actually subvert the virtual
machine right and because Jia was all
about security put all that so what
happened that actually give Abraha and
Joshua along I think wrote their paper
and and what they said would basically
happen in jail one to two is that the
mechanism of sorting was changed and
what happened is that now glass was
uniquely identified by its name plus its
class class order that ordered it so
that mean that means now that even if
you define managed to define jail one
string which is also possible for
different reasons now but if you manage
to do that it will not be compatible
with the actual jail bug string because
it was more than a different class order
and this is what we see this is the
result of that so you till three and you
till three there you have the same class
names but they have two different class
Pater's so now the question is how do
you find out what they like what the
class R is on what is the problem so in
the first solution is actually the same
as in the previous
that if we can add - purpose : class
will actually see we're both glass would
class which is loaded both of those
classes and also see where they were
loaded from but again because I'm lazy
I'm going to use the same solution as
previously and I can validate my
assumptions so just open those two so
let's see what I'm doing here so look
first I'm taking the test three class
get closer to get resource and then I'm
taking actually three get class but I
guess resource why because I'm loading
here through util I'm loading here
basically one util three directly in
that context another one in the factory
three context right so both of them
refer to GTO three so let's see what
let's see what happens and I'm by the
way is durable during the loading so
that's why I can just zoom zoom zoom
okay so it turned out that some complete
bastard put a jar in fashion toolkit so
if I find you a cueing anyway and
actually so you would think that this is
like a very constricted constructed
problem but actually it's surprisingly
most rare sorry actually I forgot the
very first so so it's not so rare why
because the time containers shift
libraries which means that you almost
always already have the situation
whether you have same classes in
different class Pater's what you only
think you're missing is that you know
they have to somehow be met in the same
place let me see what I have
sorry yeah I have the slides later which
one was interesting but here's the
interesting thing this would never
happen if the world class owner
reverse like that right if it wouldn't
have reverse delegation because if it
wouldn't have reverse delegation then it
would actually first their actual load
the second classes in both places to
load the one in the application
container right so remember I told you
that the the fact that the web browsers
reverse the legations root of all evil
there you go live example and so if you
have like vote for jail hibernate or
something that bonded with container
you're not unlikely to get to this error
though actually let's see the next
problem and that come gets even a little
bit
so just for actually uses all the same
so we can have sir
okay so the question is like okay here
we could remove it so it very easily by
removing the charm file from the
container but you know if it's bundled
with the continuum can't really remove
it right so how do we solve it that well
either we remove it from the web
application or we just make damn sure
that they never are used in the same
context right so just like you you can
actually make sure that is just very
painful yes
well we use mailing but it's it's
irrelevant because this is happens at
random so
no sorry that like the question was can
we solve it in maven or like 90 but the
reality is that this is a runtime
problems I told it bends what has the
container cache 20 was deployed by other
people besides you in previous feels
like it's fairly complex ok well you can
ask more questions later offline so the
the next is actually this is the same
setup which do you have the two clusters
right because I'm using the same factor
three am using the same just for so we
have all the same situation the only
difference here is that instead of using
the instance of time which returns an
object I'm using an instance which we
chose eto three and let's see what
happens then and then we get this
wonderful thing which are much more
likely to encounter that the class cast
exception which is linkage error loaded
constraint violation and then like a
bunch of information so this is actually
something you're much more likely to
encounter because the class cast
exception happens when you actually
guess right so if you actually have a
guest but this is what happens if you
don't have a guest right you have two
class owners and you're trying and these
local constraints is a mechanism how to
track that using many multiple clusters
in the GBM and this is exactly what jr.
broccoli was writing in this paper about
and it's a fairly complex mechanism but
what it does is basically if you try to
use two different classifiers with the
same as in the same context right so you
basically let's see what I'm just going
to refactor the code a little bit to
make more understandable just forward is
for so if I just introduce a variable
here so we actually have two different
contexts here like one you to3 in one
class earlier is the one that this
returns and the other you till three in
this cluster is this method invocation
because this method invocation happens
in current context whereas the holding
of the class happens in the context of
factory three right so and the reality
is that it's very
understand it's really really hard to
stand from code it's much the only way
to understand it again it's to do this
way we did previously right so it's
actually exactly the same I'll just pop
it just funsies so just go is this with
just for now right and hello what
happened
did that was something about yes I need
okay so your ality and was lying to you
because there's already before two
contexts but it doesn't change anything
and the point is that we still have two
clusters and we have two contexts in the
same static statically compiled file
right and already if I even just and I
think even actually I do this then get
in there right so it's kind of weird but
it's there they always add to context on
which returns the one which you call up
and an angelic sorrow such an error so
what what do you do when they get such
an error well we know that you have to
close others you vary your some trends
you find out where they load it from and
you saw that's the same way but actually
just very quickly I was gonna show you
just five which is the last of this part
and here would you almost the same
except that the method that we're
calling is package it's a package method
right so it doesn't have public or
private in front of it but it's all the
problem because Factory three and test
five they're all in the default package
so it's the same package right
unfortunately if you actually try to
access it then we get illegal access
error who can tell you eyes that
sorry
so the hypothesis is that this pretty
check is only for the class actually on
it
fortunately it incorrect but it's good
hypothesis
okay so when one so it turned out that
when the change was made in the classes
be careful identified by their name and
their class holder to allow them the
same had to do be done two packages so
actually the full identification of a
package and this is really weird is the
package name and the class order and so
the full package intuitive moment like
the full packages classes loaded in two
different mass orders is actually not
the same package so if you're trying to
access a package for get detected
methods again across clusters you get an
illegal accessor very interesting thing
alright so the more than one class found
is one of the most common problems in
production what is one of the most
common problems which can be really hard
to solve so and now you know how to
solve them so what you do is verbose
class and absolutely get resource and
you find out where everything is verify
all the assumptions and then you fix it
by basically making sure that classes
are not used the same context or even
venture making sure that there isn't two
sets of classes to begin with so this is
actually the same the same problems
we're looking just to refresh this is
how the actual look so we have two
classes we have the web passenger and we
have the shared class order we have you
till three present in both of them and
then we have two plus three in one in
fact three the other and you know this
is this is what actually but okay are
there any more questions about this all
right tied in here so I'll pretend that
it never happened
okay I'm just going to take a look at
all right I'm holding fear too slowly I
should move faster so the next problem
is almost entirely again surely there's
one slide I mean it's almost Mitali
almost a child in code so the next
question is why do class so there's
leaks much right so you often memory
error permian to memory this permian are
of just heap memory it's a very common
thing if you just blow the typical
enterprise application he 'tried employ
a few times and then you know it's just
a question of how many times it's not a
question of you know that whether it
happens it's usually just question
whether it happens up to five times or
to two times or ten times so and now I'm
trying to it will try to design while
the first engine is ten is actually
reloading classes in Java is really
really hard the AEI the Java API the
java language says that basically once a
class has been defined its cast in stone
there's no way to undefined it there's
no way to change it in Norway loaded
with an exception of what's hope which
was it choose replace method bodies but
generally it's cast in stone right so
the generally the only way to really
update the class in memory in a java
application is to create a completely
new class better create a lot remote
there all the classes from the new class
files so they get updated and then you
somehow have to move over there and the
typical way like in Java is that you
just throw away all the old objects I
throw away the old class very great all
the objects Chris from scratch and this
is why we deployment extra takes on down
low because we waiting all the reloading
all the configuration you know
recreating all that states from complete
scratch right so there's that plasma
taste of time but let's let's go to the
code now this is this is really annoying
oh very good
that's better so let's go to the code
then let's close this so now we're going
to build an application server I have
only ten minutes so it's going to be a
little bit virtually minute but
nevertheless it's going to be enough
purposes so this is the app server
whether it supports to play only one
whether fortunately we can add support
for more nature so it has a minute
method and all it does it creates smooth
goals in the loop and actually
continuously richboys that weather right
so what it does is created from the
factory then it does some print print
lines whoever can send a message and
also it has a counter in it so we must
plus the counter and plus plus actual
returns the content of the counter so
this is the country so that the web of
the cache will have some state right of
course it's a web application and then
we just and then we just wait for 200
milliseconds so let's just for a second
look at the web app so it doesn't have
anything much messages which version is
it and the plus class just increments
the counter like so nothing metal X here
so let's try that okay so what is
happening now that remember I told you
that there's no way to move the state so
on every on every cycle the web the web
app is created from scratch so the
counter is always zero so we throw away
all of state this is that extra window
state but let's check is redeploying
actually works so yes oh the class is
actually reloaded right so wait but why
is it did okay so let's look at what the
web Factory actually does so first of
all this method is everything that is
wrong with Java I like to go with joette
explode over there okay and this is
actually what we're doing so we're
creating on every time we deploy like as
I said you know the only way
load anything in javis continue class or
or you 0 so that Monty will create a new
class loader and basically what it does
is like here this part is actually
reverse delegation again we want to
focus from the class over and run from
the parent class over here it is safe
because I know how to do that but
generally it is not safe and so it you
ain't in your class order which is
basically let me use class order to load
the class and create a new instance so
that's that's that's why the state's
being reloaded so now we go back ok but
the problem is that the class is
envelope but we don't preserve the state
so how do you preserve the state we just
do a copy right here's the interesting
part is that mostly all you have to do
like this is base house user session is
bet on the redeploy listen where you can
copy different state so just go create
it here as well and no notice that copy
just focus the culture state right speed
this is the only way how you get it will
preserve stated job you can just somehow
repeat it and copy no terribly you think
all right and we stop and we also stop
don't care because of the natural
anymore
now we respect ok so now we actually
have a count going so we have a state so
we have a fairly feature-rich
observer and I'm actually going to see
how cluster is leaked so and I'm going
to be a 10 a week so I'm going back to
the web app from gradall let's see what
it does
yes absolutely poor charity hello what's
going on
can't this is not good remember I link
is right here
you bastard stop seeing it sometimes I
hate eclipses I had a specific line
anything okay now that's actually good
to Oz ball okay so let's go back okay so
let's see what happens first of all
let's take a look at the glass League oh
sorry I just felt really costly so class
week is a super nothing class it's
basically all it does is contain another
week
right so it's very tiny little class
doesn't do anything so now if you go to
weather then weather can change the
league but again that leak has no
references to weather bachelor and web
app also contains a cash rate this is to
give the web app its weight so it is ten
it's a million of loans which is like
four mega mega bytes I think and and so
here's the interest part where we copy
the vacation we now actually introduce a
leak and what we do is that so what we
do we add another leak in the chain on
the copy like so if you see the method
leak then it just creates a new leak
wraps a new leak around
previously right and this is just cause
that method so what that means is that
every time we reach deploy we add
another week into the chain and we hold
on to the last leak right so we never
hold on to the previous web app we don't
do anything like that so let's run it a
bit and see what happens so why am i
doing that I'm actually trying to
reproduce very common thing that happens
in the application servers we're just
one class somewhere is getting stuck at
not not anything else just one class
some movies
the next version or by the applications
River something like in a logging
framework or whatever just hold on to
one as from your application right
Sonique is supposed to be that glass and
turns out that is very very dangerous so
let's see boo
so first of all one very nice thing I
can recommend is the reason why I right
now the heap down is because I put this
a nice argument into my app which is
minus xx plus heap dump and not a memory
error it's actually very much worthwhile
to have that everywhere because when you
run out of memory that you'll get to
keep them which you can actually do
something with and if you do want to do
something with the heap down and then
there's an amazing free tool for that
which is called Eclipse memory analyzer
so I just refresh this session see that
yes oh I see this ok yes yes yes where
and ok and so the Eclipse memory
analyzer has this thing which I think is
the Dominator tree yeah so and the
Dominator tree is actually great so
remember we we have put four megabytes
in our cache but somehow the the class
order is now 120 megabytes let's go in
it buh-buh-buh so we see that that's our
Rachel in Holts hundred twenty megabytes
cantilever and here we see the poor the
weather itself only has eight megabytes
but somehow the league is hundred twelve
megabytes
remember the delete was just a tiny
little glass right it didn't have any
references to weather in how refers to
anything and we introduced one malik for
every redeploy turns out that is so weak
that every week as a reference to the
class week every class remember every
class has a reference to its class order
so the cluster was this temporary class
order and every class tutor has a
reference to all of its classes
including the weather and every class
has a reference to all the static fields
so the way it actually looks is like
this that every class rotor has
juice glasses static fields and
obviously every object ever assess glass
every class has a reference to class or
and so all together except this only
they talk to should a webapp into class
above factory dollar one so we have a
change of leagues but every week drags
along with it the whole cluster and all
the classes will go to that class and
all the static fields voted in those
whether like he'll buy those classes so
this is a very live explanation why do
application containers run out of memory
because if you accidentally managed to
make one class in your application it
just dragged along whole vacation with
it right so this is this is the big
problem it's really really easy in our
two-week just in class it's really hard
to trace it I presume that you can use
Eclipse memory analyzer you can do it
but honestly it's just this is kind of
coming to the point that closet or you
late for Java applets
for java application containers so
unfortunately although in development
it's fine to do we get some production
it's really very very tricky to get it
to the point where it actually works yes
of course
so the showing an example again you mean
this one or well this is the contextual
this was the most common cold
so we do we call the method copy every
cycle and we just add another week image
and leak itself doesn't have absolutely
any references to anything but it has a
reference to the class order that's the
problem
so um okay I have little time left so
I'll try to I'm against keeping the
stage if they aren't but you know this
is this is a big problem so what are the
possible solutions well one solution
that I used to take about was Oh H
equals then these but truthfully they
have more or less the same problems just
like modern modern class owners they try
to do this one cost of your every jar
and then they try to kind of remove
these dependences and like set like
route all dependences from some
centralized repository the problem is
that exactly
you know you get exactly the same
problems slightly different flavor
because in reality you know some of the
things can be verified by tooling most
of the things cannot classroom leaking
basically almost cannot be prevented
into it's just too easy to do and it's
actually easier to the classes when you
have a lot of class huggers which all
the systems have so just switch to your
own problems easy to week well but the
question is how do we fix how to ensure
that this never happens in production
right so how to make reduce the number
of costly and honestly you know
everybody else in the world does not use
clusters or something like that for
updating code the use processes right so
process is natural abstraction of
isolation the process actually has its
own keep and nobody else can refer to
that e so memory leaks between processes
are impossible
by definition we have to copy everything
between processes it's widely used
outside channel unfortunately it doesn't
go anywhere far so far but you know what
you can do the very simple thing is just
and what almost everybody probably does
here is you never redeploy in production
you will start the server right on every
update because it's the only safe way to
make sure that you're not out of memory
and so it's okay so in this talk you
already learned how to solve the bigger
their main loss other problems you know
that you shouldn't ever redeploy in
production which are the two main
messages they're actually other ways
also run this so hopefully some day
processes will come natively to Java
meanwhile there's of workarounds one
background that I'm going to pitch you
which is our workaround is also out
patching which basically means that it's
kind of way to bypass closures where you
the cultural resources without creating
a new instance of anything's just memory
which we learned how to do and so we
have actually a product called life
level which does a safer fetching in
production which guarantees no leaks and
which also does automated volume
restarts in case where what batching
cannot be applied so if you plug it into
production we actually get very safe and
very quick updates I'm not going to
teach it extensively slay this talk is
not about products but if you do want to
learn more about it then come to my talk
tomorrow
it's called pragmatically to use
deliberate such jokes also much wider
than just about our products it talks
about how to generally set up your
production environment so that the
batches would flow nicely from
development to production but I think
you know it would be it also talks about
stuff is context and also I invite you
to visit both which is a grand ballroom
I think of kora and learn more about
both clips or ask lots of questions if
you have any so I'm finally just to
conclude so remember that if you do have
any plasma problems the most important
thing is to validate your assumptions to
leave any closer s it's enough to lick
any object processes are the only is
elation abstraction that actually works
well for updates and what patching is
like a symbiotic alternative thank you
very much
question</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>