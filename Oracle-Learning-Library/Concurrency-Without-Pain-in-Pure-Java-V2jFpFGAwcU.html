<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Concurrency Without Pain in Pure Java | Coder Coacher - Coaching Coders</title><meta content="Concurrency Without Pain in Pure Java - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Learning-Library/">Oracle Learning Library</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Concurrency Without Pain in Pure Java</b></h2><h5 class="post__date">2013-02-01</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/V2jFpFGAwcU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">welcome to the ER session on concurrency
without paid viewer job my name is Venki
Subramanyam
let me tell a bit about what we're going
to do here today and then we'll get into
the main content quickly and we'll talk
about what's the reason for excitement
on concurrency I'll talk about three
specific models here for concurrency and
we'll use quite a few code examples I'll
be inviting some examples demoing it
best time to ask a question or make a
comment is when you have it so please
don't wait to the very end just about
any time is a great time for questions
comments along the way so let's get
started why all of a sudden interest in
concurrency well let's give credit where
it's due
you have multi-threaded programming in
job from day one if you recollect when
before the time of Java those of you
have two programming language like C++
we have two big really different
libraries along the way and when you
program for the compact form you have to
learn a different library and use a
different library one thing that are
really well was to give us this one
common API we start the thread and be
happy with it but then still why are we
still excited about concurrency it's the
problem old problem isn't it well it
turned out that in about 2003 time frame
things kind of started changing
does the day when this guy went to his
boss and said it went really fast before
it melted and he was talking about the
tips of course right and we went along
the lines of multi-core processors now
with multi-core processors multiple
threads are on steroids on a single
processor multi-threading is more like
multitasking but when you have multiple
cores it's really on steroids but how
does it really matter again we've had
comprehensive memory from day one
what's a big difference well let's take
a look an example imagine for a minute
that everybody in this room is a thread
right and imagine we all you know
running in processors I'm going to use
some people
the victims for me here too as an
example what's your name sir Chuck so
Chuck is our first bride and he wants to
be the data what is he gonna do Chuck
walks up to the wall which is the main
memory gets the data cough is he down on
his notepad comes down and sits back
here and start working with it let's say
a few minutes goes bang what's your name
James James wants the same data right
and he's going to get up and Chuck looks
like a nice guy you know being a nice
guy as he is he says James let's share
the data and they have no space here
they put it on the desk here and then
they start sharing the data well you see
this mall is already broken isn't it
James and Shelby do you really plan
ahead to sit next to each other purely
coincidental right yeah we confirm that
so the point really is that there's just
quite simply sitting next to each other
they start sharing the data right now
imagine this is a one core processor
things kind of already broken that they
pretend to work correctly but let's say
a little bit later we have multiple
cores of the system and let's say
somebody over there like he's getting up
to idea to get some data as you can see
pretty nice demo and he wants the data
what is he doing right well he's
obviously going to go all the way to the
main memory to get the data he's not
going to take a peek at what these guys
are working on here right and the point
really is that on a multi-core processor
not only do we have multiple caches we
may end up having multiple levels of
caches so in other words on a single
processor we normally have a cache and
the data kind of is in the cache at
offering system kind of moves things
around but in a multi-core processor
there's multiple levels of caching
multiple locations of cache and as a
result the terms of an application being
broken is much more i got a--an up from
the guy I thought this was funny but I
don't think he thought it was funny his
email said we have an application in
production for the past five years and
it's working fine
and his email goes on to say last week
my company bought a multi-core processor
we deployed the application
and all hell broke loose his email
wasn't to say don't tell me to do the
right thing I know what it is I cannot
do it so tell me what's the quick fix
how can I make this application work on
this multi-core processor and I email
back and say it's very simple welcome to
the multi-core processor and turn off
all the other course like and the point
really is you cannot quit fix these
problems now why is this such a big
problem the reason is most Java
programmers including me have not really
taken the time to understand something
extremely important and that's called
the Java memory model the Java memory
model talks about how the data goes from
the main memory to the working memory
where the working memory is a
combination of registers and canvas this
object is going to use and without
understanding the download in the model
it's incredibly hard to get this right
if you're not sure about this right I
recommend highly a fantastic book it's a
book by Brian gets called Java
concurrency in practice they've ever
read the book that's one of the most
scariest book for programmers and when
you read that book you realise how
important our memory model is and as
you're reading the book you will realize
it's impossible to get concurrency done
correctly without understanding that but
then once you finish the book you
realize it's impossible to get
concurrency even if you understand the
John Hammond model that's all sadnesses
but some of why this is such a big
concern now let's take a look at an
example of this and see what the current
state of concurrency is so I'm going to
start with a little example here now
let's say for a minute that we have an
account class very simple example start
with right hands interlocked young class
and I have a balance in the account as
you would expect I've got a constructor
which takes the initial balance value no
surprise there and of course I have a
deposit method and what's like a
positive method I'm going to increase
the balance as you can see they are
adding to the balance not a big deal
right I have the withdraw method I want
to make sure there is enough money first
before I would draw so right there I go
ahead
rather money and you can see that I have
drawn the money based on the balance
amount and of course finally the most
obligate we get balanced me I think is
also available to us so as you can see
that is our account class just a little
POJO nothing really complex at all right
so a deposit with little bit wrong
method I get balance method that's now
let's take a look at the code that's
going to use this over here and what I
have here as you can see is a little
account I've created two accounts I've
created
and each of them have a balance of
thousand dollars in it I want to
transfer money between those two I don't
want to transfer 500 between those two
and of course once I transfer money I
want to display what the balance is of
course this is using a transfer method
within a so call account service let's
look at the account transfer method
itself oh I don't have it let's go ahead
and write it so public static void and
other safe transfer what do we transfer
from well I'm going to say final and
this is going to be an account from and
I want to transfer this to some account
so we call it final account to and of
course we got to tell you what to
transfer and that's the amount I want to
transfer so right there is the transfer
method of course we have to implement
the transfer method isn't it how do i
implement the transfer method well let's
give this a try how about saying to our
deposit and I want to give you the
deposit method that we already had and
then I'm going to say from that withdraw
and I'm going to specify the amount I
want to withdraw now I know what you're
thinking you're thinking god that this
cannot work for a bank right because we
just gave the money to this account
turned it on to the other account and
said can I have the money please and it
says what money it's too late close the
door you know bring back the guy who we
give the money to right well yeah that
kind of looks a little scary but maybe
we want you unfixed in a little bit so
let's say if the from dark withdrawal
was successful then maybe to deposit
amount maybe that's a little bit better
and safer as well alright so that's all
great but really the concern is we want
to create multiple
and access this account repeatedly so
obviously this account is not thread
safe at all so I don't think I should do
to make this account thread safe any
ideas I can hear the few whispers feel
out synchronize you said so I'm going to
put synchronized over here right
synchronized and I have to put
synchronizing the withdraw method as
well but I'm kind of thinking do I need
to synchronize the get balanced are not
anybody else thinking no a few people
did you know so we can die a democracy
we could vote for down this right and
then they can see who made your things
boring well of course there's a problem
here right because it's got to one or
the other
well if you don't put synchronize what
happens well it turns now if you ask
those Java programmers what synchronize
does they'll tell you it gets you a lock
unfortunately that's not totally true
that's only partly true
what synchronize does is it helps the
code cross the memory period of the
program crossover very very so every
time you call a synchronize method not
once but twice we cross the magnetic
area similarly when we access the
volatile dairy book when we call printer
start thread don't join we when we call
you know a wait on objects we notify the
objects there are quite a number of
methods when we cross over that area now
cause of the memory there here is
extremely important but not crossing it
when we have the cross is as bad as
crossing it when we shouldn't because
because we didn't we shouldn't we end up
exposing invariance paper incorrectly
and that could be good problem in
semantics as well so this as it turns
out to be very very difficult to solve
okay put synchronize on this what do you
think are we done not really because I
have to worry about synchronization in
here as well as it it so I'm going to
say synchronized over here and then this
is going to be on the front account and
then I'm going to say synchronized on
the to account as well and then of
course with the synchronize block I want
to perform this
operation now the code is safe and we
are done
what do you think if you see if you
laugh already what do you think if you
have the confidence you're done no of
course not
in fact I got the best answer in one of
the talks I gave a few months ago this
gave us v racing hands and of course an
artist and how is this been only five
minutes since you started cannot be done
okay that's one way to go guys right so
absolutely so what's wrong with this I
heard my gosh there's not only deadlock
there's also a rival block what happens
when you call synchronized really Chris
for Allah
well what if no lock is available what
happens you wait how long the wait
forever
what does that sound to you it's very
stupid isn't it what you do that work
you go to the faster machine to get a
coffee there's no coffee right so what
are you doing - waiting for coffee to
fill up and how it exactly that happened
right so absolutely that's kind of
ridiculous right so we don't want to
call synchromesh but how do you wait for
a timeout of synchronized that's the
right answer
there's no way to do that okay that's
one problem a light lock but there's
also a deadlock how does this a deadlock
because do threads been at the same time
and the faithful Roman they both end up
transferring money across the two
accounts in the opposite direction right
here's a way to think about deadlocks
there's a boy and a girl in the house in
the morning the boy and the girl run to
the kitchen the boy grabs milk the Virgo
got lots of sugar and they both wait on
I having breakfast because one has the
sugar the other has because what do you
have on him now I did not appear in a
nightmare right so obviously we have to
weigh the way to resolve this and how do
you resolve this you say kids from
tomorrow you have to get sugar before
you get milk in other words you can put
ordering into the picture right so one
way to remove this deadlock problem may
be to say somehow in the account we'll
put an order way and we could say
account and we could say a count equals
and we could save
example arrays dot sort and we could
sort the accounts from in the two in
this case and once we start the from in
the tube don't worry about the syntax at
the moment for me and the ones we sort
the accounts tell me what I should do
really is create the account structure
here new your camp like that now once we
create these from of the two accounts
what we could do is arrays dot sort and
then we can put the accounts to sort
then we could say over here account zero
and then this could be accounts one to
really lock them in that particular
order
well even if that removes the deadlock
we still have the LifeLock and we have
to start putting lock interface them do
a lock and try lock and release a lot
nobody more putting a try and finally
block what do you think that's going and
once you finish all of that is the code
threat safe you're not sure anymore
right and why they are struggling with
it the boss control it is how's it going
or until the boss yeah I had no clue
what's happening thanks for hiring me
right you can see how this has become
complex isn't it the other day a lot a
piece of code and I had called
synchronized on it on the way to a home
I was thinking about the code now we
cannot do that she but cool code as I go
home way I thought the way so did I see
eyes at the right level as soon as I go
home I check it look at the code and
sure enough a half synchronizing the
code but it was in the wrong place
and once I figured out what was going on
I fixed the code and now I'm sitting
there wondering where else the code is
broke and I don't even know that how do
you feel about that
pretty scary isn't it because we're
trying to solve calm currency problem
and we are not sure anymore the problem
is solved or not we're not sure if we
lock it at the same to the right place
or not so in a sense we really are at a
loss when we try to do synchronize in
fact I love this so much I have a
special name for it I call it the
synchronizing suffer model and the
reason why this to synchronize and
suffer model there's the minute we get
in to see
it is extremely hard to reason through
the comb and ensure that the code is
correct from the point of view of market
so it's analyze what we talked about
when you forget to lock or you lock at
the wrong place the Java compiler gives
you an error correct no no no okay well
let's write this again when you cannot
get the wrong place the Java compiler
view that tolerant thing is you were
warning you know I hear people laugh you
know it does it well what does it do
then you don't have a clue like it's
unpredictable
if you are lucky it fails on your
machine if you're not so lucky
it fails when you do an important demo
right so this is what I understood
programming concurrency on the JDK is
like working with a mother-in-law she's
just waiting for you to fail and we
cannot have that kind of cut you know
friendliness to develop enterprise
applications now don't get me wrong I
love JDK it's awesome it's very good
it's just that it's way too level of
abstraction to no level of abstraction
for us to be writing concurrent
applications in in a way I would like to
see the JDK concurrency library as the
assembly language of concurrent
programming in fact that's true today
cause most of the solutions that I'm
going to talk about today use the JDK
concurrency libraries like fork/join and
other things but they use it so we don't
have to so we can build on a higher
level abstraction and get focused on a
problem we're trying to solve so we're
talking about two problems we're going
to look at today two ways to solve the
problem today
one is the so called subject runs actual
memory and the other is called the actor
based concurrency model so let's talk
about what these two approaches are well
these two approaches are
mentally different in the way they
approach the problem it's kind of
interesting how they really approach
this now one what is the real problem
really the problem really is that we are
dealing with shade durability isn't
there so if you read about it is
mutability such a bad thing
well this work we've been programming in
Java for a good 15 years and unity is
the way of life in Java you're used to
it so beautifully cannot be really that
evil right
what about sharing what sharing is a
good thing remember what mom told us
right sharing is a good thing so you
know these are my sharing this great
share capability is devil's work and the
minute we bring in shared durability we
got all these problems we have to deal
with so there are two different ways to
approach it
well the functional programming guys are
telling us that everything will begin
your over will change nothing and you
sit there wonder what are you guys
smoking
how could you develop an application
where nothing changes right well the
point really is in a functional
programming style you don't change
anything in most of the application but
you have selected areas where change
happens that are very controlled the
fashion and of course they are very
clever they call it monad so nobody
would understand what they're doing but
the point really is that we kind of
control those structures really well but
when we program in Java it seems out of
weeks to even think that we can program
a function language what do we do rest
our programmers most of the time when we
write code so there are two approaches
we can think of one is this one tomato
different shift in the way we handle
shared unity is soft a transaction
memory which is driven on I'm going to
handle
for you I'm going to give details of
that a few minutes and the other
approach is where we can deal with
mobility but what I would like to call
us and isolated mutability where we are
still a mutable variable so no two
threads can ever get to it at any given
time we'll talk about that also a little
bit along the way but one of the
beautiful things about the shame you
ability so the software transactional
memory is that we have separation of
state from identity what does that mean
well if you ask me
what's the stock price of one above
today you would say that some crazy
value and one obtained what happens 1/10
what happens that value changes well
that's sure that's one way to look at it
but a different way to look at this is
our stock wise never ever changes in
fact that's really true because every
stock price at a given time is historic
never to be modified into the future so
you can go back in time and say what was
the stock price of a particular company
given time on a given day and the family
never ever changes so what you do is you
say the values of the stock are
completely immutable and they never
change once they are created and I have
an identity referring to what these
stock prices are at a given time the
current price the identity changes but
we'll get back to them in just a minute
but the stock price itself the stage
itself never changes now think about
this for a minute
James wants over access to the stock
price right now at this instance so I'm
going to given the stock price and
exactly the same moment Chuck wants
access to the stock price also and I
want to give this price to Chuck as well
but how many locks should I hold on this
object when I give it to these two
people none at all that's correct
absolutely right because this is two
totally in Irbil right it cannot change
no need to hold a lock great that's fine
for the scape what about the identity
well the identity and sort of
transactional memory Sdn is it's a
managed to mutable identity it's a
mutable identity but some
managed to mutable identity meaning it
is controlled by an environment it's a
managed object so here's the identity
and at any given time I may say here's
the current value here's the new value
flip the switch to the new value and I
can switch it to the new value at any
given time but all the other day and you
say well that's great but how do you
protect it and the way STM deals with
there is that managed immutable identity
can only be modified with the cut
transaction now you say what is a
transaction what a transaction is where
your code runs with what I'd like to
call as a cone of silence
so I know what happens in the cone of
silence nobody knows about it I'm going
to reach the end of the transaction and
either you commit and others can see the
change you made or you go back and as if
nothing happened to the government's so
the point feeling is the transactions
run in a code of silence now stov has
been around for a while by the way but
this was introduced into the JVM by
closure when Richie key created closure
he implemented that into the language
let's take a look at an example here we
are quick I'm going to say for a minute
I'm going to create a balance over here
and I want to know what the balance
value is I'm going to be fine balance
he's going to be a CEO value as you can
see the value is zero right now and you
tell me if I could give we're having
change the balance value to a hundred
thousand now I have to say I don't have
a clue how to do that and the reason is
it's a state and it's immutable
enclosure you cannot modify States you
say what do i do then well we can modify
the references on the other hand so what
I'm going to do is rather than keeping
balance as a state I'm going to change
it to a reference over here and you can
see that I'm able to change the
reference
well I'm able to access the reference
but I won't know what's within this
reference how do I do that
I'm going to say in this case give me
the balance value and notice it tells me
the balance run to zero now I want to
modify the reference
do that well I'm going to go ahead and
say a ref set balance is going to be a
hundred thousand I'm going to change it
but knows one thing that's
constitutionally absurd here I haven't
mentioned anything about transactions to
the scope
so whenever round this little program
you can see it blows up and it blows up
saying illegals take exception no
transaction money if I could get really
upset it's green slow saying he touched
me right and it's really unhappy this
happen because you did not enter into a
transaction so in other words imagine
the beauty of this states are Mirabal
identities are mutable but only in a
managed to fashion it has to run with
inner transactions for us to modify it
so what I'm going to do here is to say
all right all right let's go ahead and
create a new sink over here and do sink
is a way to enter into a transaction and
now that I've entered into a transaction
I'm going to go ahead and modify this
notice this time it's not screaming loud
and now that I want to go ahead and
print the value of the balance at the
end of this and you can see quietly it
was modified to a 10,000 at the very end
so in other words you cannot modify a
managed commutable identity unless you
have entered into a transaction now you
say okay that's cool I see that you
cannot you know accidentally modify this
this is acid Java really evolved to say
if you don't synchronize your object
with the proper place
we will scream loudly right well you see
the problem I have in the JDK
concurrency is not that we have to
synchronize that's not my problem my
problem is it doesn't tell us if we
don't synchronize it doesn't tell us you
are wrong instead of called the other JB
reports that we have a victim another
victim today right so we want
predictability in the code that's what
is missing now notice how its
predictable here it tells us oh no you
cannot do this and it fails lovely
alright that's great we can have
transactions but how does this really
help when multiple transactions are
running concurrently
if the transactions don't collide with
each other meaning they're not going to
modify the same object at the same time
they all complete and go away no problem
whatsoever and we never held an explicit
lock on the object on the other hand if
two objects two transactions are going
to modify exactly the same object what's
going to happen imagine for a minute
there I have something over here and
shocking change both are approaching
that and they won't mind quite that
exactly at the same time one of them
will get to that first make a change and
come in back to the memory energy and
the stl will go to the other transaction
and say I'm really sorry while we were
running there was another thread under
the covers that was working as well and
that took a proceedings and if automatic
retry is the transaction we don't have
to write a single line of code that
transaction is repeated automatically
now what if the another time it runs and
it turns into a problem even we tried
one more time how many times will it
wait right well the case of Estima
includes your it retries up to a maximum
of 100,000 times I had a guide very
curious the other day said immediately
what happens at 100,000 times that's
called bad karma right give up and go no
point in me trying after that the point
really is that they don't have 1/2 that
commercial contingent anyways in your
system concurrency is not a suitable
solution in that case so the beauty is
of course you can configure there also
in other systems so you say all right
that's all sounds great but we did check
the title of the start and you did say
kinda see without pay in your Java well
they're kind of willing to video a
little bit about this no pain part it
was the pure Java part alright that's
doesn't look like Java so we'll kind of
move away from that now it turns out
that you don't have to program include
your to use SDM and it turns out s given
closure was implemented take a while to
guess in which language job so it turns
out we can actually use this from Java
so that's exactly what I'm going to do
we have a Java right here and I'm going
to go to the account class right there
and let's remove all the synchronized
mess we created it because that's not
helping us after all so I'm going to
remove all the synchronized parts as
that doesn't help us also the deadlock
is looming over ahead as we speak so
rather than doing any of that what I'm
going to do instead is I'm going to
simply tell him that I want to use a
managed to mutable identity how are you
going to do that let's go back here and
say import closure dot length art star
now you say wait a minute you're
bringing in a library here for me to use
how do you feels hibernate of course I'm
here you're springing of course you only
have hundred jars in your class back
what does this is a big referred one
more in the past path right so
absolutely so all the be doing is
putting closure in our jar in the class
back you're not programming in closure
at this point is reaching into the
library at this point isn't it so
another changes to a ref object now the
ref here is the manage new double
identity and in order to use that I have
to say here that I want to say this is
going to be a new ref object and I'm
going to say this is going to be simply
an initial balance of what I'm bringing
and similarly I'm going to say get
balance over here and I'm going to get
the balance plus the amount that
one hand and I want to put this into the
balance we use a ref set on the other
hand welcome back to the Dominican
so I'm going to say balance dot set and
set the balance notice I'm working with
this object keep in mind that the ref is
the managed immutable identity and what
is it going to hold a reference to an
immutable object and we already know
that in Java the big I integer is
immutable right we cannot modify that
similarly in the withdrawal method I'm
going to get the balance right there and
if the balance is good enough I'm going
to set the balance this time and I'm
going to say in here that the balance -
the amount itself and I'm going to set
the amount and finally here does the get
balance method and in the get balance
method we'll say this is going to be
integer object and I'm going to just
cast it to the integer and return that
value to the caller as well so what I'm
missing here clearly go
that's right transaction I can create
any transaction let's see what happens
if I don't bring in the transaction back
in the account service let's take a bold
step why don't we simply say go ahead
and do the peu deposit first of all
after all we can trust everybody in this
world right so let's go ahead and say to
deposit and then of course I'm going to
say from the withdraw and then the
amount let's be very bold and see what
happens when we do these steps so I'm
going to go back here and and transfer
that money through this account assuming
I wrote all of this correctly oh it's
complaining in this case it says Inc in
convertible type in this case he's not
happy with it so let me go back and tell
him what we are dealing with not do a D
ref I got to get the value of the field
right so DF is getting the value out of
him always complaining about exceptions
of course I can regard your programming
in Java right but as experienced Java
programmers we know exactly how to solve
the problem
okay so we can go on oh it's complaining
about illegal skate exception you notice
that so we're back in the Java side and
it says how dare you modify that
reference no transaction running illegal
State exception and those are slap on it
with for touching that object right now
right because I went into the
transaction maybe send so far so we have
to into a transaction before we can
modify this how do we enter a
transaction on the closure side we all
just use this wonderful thing called
do sync we don't want to use to sync
obviously here in Java but fortunately
that method is available to us on the
Java side using a class called a locking
transaction so what are we going to do
here I go to the account class first of
all and here I want to run this within a
transaction so I say locking transaction
so locking transaction and the run in
transaction and unbar simply say here is
new colorful avoid of that and I'm going
to implement this method public void
call method and within this myth that
I'm going to do that one operation
that's the do think you saw innocently
on the floater side
blowing up here on the top side but I
got some good news for you this code is
to play sending a flow sugar to a lambda
expression CUDA to that running
transaction method when Java 8 is
available to us that look very concise
and beautiful isn't it so that there's
hope for us in that regard so what I'm
going to do here I'm going to import on
over here Java util dot concurrent a
concurrent dot store because I want to
bring the callable interface and are
running this within the transaction so
notice how I wrapped this call to run
within a transaction where is it going
to do what it's going to do is when I
come into the deposit method it starts
that friend
action and that one line of code is
running in its own transaction at this
point and then when we are done with
there in the with grommet that I need to
do something similar but I'm going to
change it a little bit I'm going to
rather than a bully and I'm going to
make it a void method and then I'm going
to round this whole thing within a
transaction so I create our transactions
right there and then within that
transaction I'm going to go grab this
code and drop it in there and I'm going
to say if there was enough money go
ahead and do the transaction if there
was not enough money by the way then I
would like to simply say throw new and
I'm going to say thrown you are what am
I saying here one-time exception and
this is going to say this exception says
not enough money right of course if
there's no enough money we cannot be
giving this money away right so we are
throwing an exception at this point I
mean we've said so far and once we do
this hey what about the transaction for
the get balance well thankfully be there
runs in its own transaction so we don't
have to base over time creating that
here but if we are running it out of the
transaction it will just run within that
no problem at all in this case great so
far so good but I got to go to that this
guy here and do the same thing here as
well so I'm going to grab the two
imports we need from up here I'm going
to put this into a transaction but
before I do that I want to report a
failure as well so if there was an
exception I want to report there was an
exception so this output here exceptions
are getting message to say something
went wrong and of course in this code I
want to ruble this within a transaction
so I have the transaction boundaries
created and with them that I'm going to
say deposit and withdraw money and we
call that method let's go ahead and see
if this is working so far we're
transferring $500 between DTF to
accounts let's make sure we handle the
exceptions properly first of all so this
guy's don't throw an exception
potentially we catch it right here in
the account class we have done the
throws exception up here for this guy
potentially this could throw exception
as
we'll put that in there and then of
course this could potentially show an
exception we'll put that in there
so that seems to be all right so far
assuming I've not messed this like
totally we can run this and see what
happens all line number 15 return
statement is missing let's go fix it
so I find by 15 over here what did I do
I have started a transaction over here
and I'm going to run this the whole
thing within a transaction but I haven't
finished this transaction that I started
up here is it good so let's go fix that
real quick here I'll just go ahead and
you know remove that and it's easier to
just get the batching Squier here so I'm
going to say amount is one call within
that transaction for me all right there
we go
so it's go ahead and run that and see
what happens so deposit must be declared
to throw exception how did I miss that
so this is again unfortunately this guy
doesn't care about it but I need that
here but let me go put that in there so
we can see how the you know what do we
call those techniques of cute is really
making this much more complex than it
should really be we don't have to find
the problem of course with you but we're
forced to find the problem here so why
does it complainant can't anybody see
where it's complaining on line number 11
in a cone service of course line number
11 is right here I need to tell him to
throw an exception as well all right so
I can see that the account was done
let's do one little thing by the way let
me go back here and do one small thing
after me to posit the amount I'm going
to talk for deposited money amount and
then I'm going to say will it stay so
I'm going to ask the bastard money will
it state it just divided at 500 will it
stay let's see why I'm doing that I'm
going to go back to this code here I'm
going to ask him to transfer not 500 but
5,000 between these two accounts I don't
maybe bit nervous and I was in there
what's going to happen well let's step
into the transfer method first of all in
the transfer at the beginning to the
transaction and it says go ahead and
transfer
give this guy $5,000 and it's like I'm
rich white is happy and is running out
of the building then we go to withdraw
it and say can have a five thousand
please it is like what are you crazy
over five thousand a thousand mayhem
that transaction is going to blow up but
remember we are animistic transaction
here so that's going to blow up the
other transaction the code of silence is
broken at least in theory what should
happen no money should really be
transferred in the hand isn't it let's
run this and see if that's true so
around this code the positive 5000 will
it stay not enough money in the withdraw
and when we are done loaded with killed
after thousand in each and the money
never got transferred so that tells us
that the transaction was running in a
cone of silence except I did something
really bad here I printed that the
message called deposit five thousand
will it stay what do you think of that
idea no in fact what you run within a
transaction must be a pure function what
is it being the pure function it should
never have any side effects why should
it not have any side effects anybody
because of all that if we reach by
several times and if you had side
effects we are in throes of this engine
so things you should never know with the
transaction
bring down to the console bad idea right
login to the log file writing into a
file is writing into a database sending
email to customers right bad idea right
so it's important to not do those things
so don't think this will example
literally install writing messages over
there you say okay are they able to see
the transaction of boundary but we still
are not sure is this really helping well
let's do one more thing to just prove
this point I'm going to create new two
threads dot start that's my first thread
and with
read I'm going to say new runnable and
to distinguish this let's go ahead and
say in here our advance for $100 between
these two accounts so I'm going to just
put a hundred as you can see right there
I'm going to start one more thread right
here and in this case I'm going transfer
to even $200 so you can see the two
different transactions running
concurrently and then of course let's
just wait for them to finish thread
Doc's leave let's just give it a little
bit time to finish it now I don't know
if this is really running so with that
method for the transaction I'm going to
say a transferring throw transferring
and I'm going to specify the amount of
them transferring so those what's going
to happen do threads are running
concurrently to transaction running
concurrently
they both are private transfer money one
transferring hundred another principally
300 we can see how this gets into a
contention mode so when I run this
notice I haven't written any extra code
to handle this but when I run this
little curve notice it transfer says
transferring 100 times 3,200 but one of
them one I don't know which one one in
this case it looks like the 100 really
finished and none of the transferring
200 was automatically we started we
didn't write any code for the be
starting off it right because it went in
there too so realize oh wait this guy is
a contention one day finish I'm here
sitting with the snail data and it
restarts itself and repeats the
transaction one of them where is the
other one repeated so what we just saw
here is the so-called source off trans
actual memory and we saw how we use it
so when do we really make use of SDM STL
is an interesting solution and it is
very useful when you have frequent leads
and frequent rise but very infrequent
right coalitions
meaning you can have concurrent weeds
and concurrent rights as long as they
don't step on each other think about
this as we have three doors in this room
I put the exit
the mind or a new exit to the left door
and we don't have to ear to each other
but if multiple people go towards the
same door like in the case of an
elevator I assimilates people what we do
we say after you please and then we make
another attempt to enter the elevator
it's the same for all here when multiple
transactions complete the change exactly
the same data it needs to one and the
other B price automatically what's the
catch the catch is this requires the
transaction to be very pure and it also
requires the state to be immutable well
there's a really good news in closure
because in the language for sure
everything is in your home except the
managed mutable identity in Java
everything is beautiful except the ones
you remember not to make mutable so we
had an amazing trouble with Java that's
one of the biggest unfortunate things is
we have to make sure that we don't mess
up and soft muted mutating things in
between so I'm going to say that almost
every language has this problem but
closure makes it a lot easier to work
with the only way in fact I'm going to
say only in close your it's really safe
to do concurrency today in every
language they give you a api's and a
loaded gun with it so we have a very
careful programming with them we still
have to scrutinize it but the beauty of
this is I place it's a little bit easier
to deal with then forgetting to
synchronize and suffering through the
consequences of that so that is the SVM
model I'm going to switch gears and show
you a different way of doing things here
this is a fundamentally different
approach this is act based concurrency
predominately evolved from earth line
and came into the STM the came to the
JVM through the model game Scala itself
and that's kind of taking a little bit
more form in this way please
so question is what is what is really
happening under the covers when you use
the ref glass so what's happening is we
create a special kind of an optical an
attitudinal identity which is the ref
out now one of the things we have the
guarantee is that the ref object always
points to an immutable state in this
example we pointed the ref object so all
balance to it I big I integer and we
don't in Java integers are immutable we
cannot change their values so imagine
our demands mutable identity and I'm
fighting to you good which is the
current state of the object but you are
in durable it cannot be changed at this
point at a later time I have a new
balance rather than changing the value
we created a new value and then we said
flip the switch appoint the new value
letting go of the old value right now
the whole value could remain for
historic reasons all should be disposed
of we don't care about it
so the point really is that this is a
very special of Technology event mutable
identity now the key things here are
that you cannot modify the object that
it points to that has to be immutable
you can change the reference to point to
a new reference and you can only change
the reference when you are within a
transaction if you try to change it
without getting into a transaction the
managed object keeps its eye open and
immediately screen saying you will enter
a transaction you have no rights to
modify this object at the moment so
protecting us from modifying this
incorrectly and when we do get into a
transaction the rest of it is managed by
their schemes binds actioning to make
sure that when there is contention it
resolves by letting one then win and
repeat the other ones so that they can
heal them some seed eventful and there
are some more logic of course under the
covers to make sure there is not whence
formation for a long-running friends
action meaning that not a long-running
basically by the older transaction so
there can be prioritize to get this
completed as well so there are a few
things to pick it up so one other
approach by the way is the so called
actor based concurrency like I said
brought through a JVM through Scala from
Pearl and now what is that release
concurrency really do I'll give you a
quick example here and be putting all
the time we have I will be able to
expand it as an example and basically
the idea here is quite the opposite well
share it over the causes problem we want
to completely get rid of that well the
extreme case is totally mutable Eli
cultural programming says of course we
cannot really afford to do that so we
are we going to do here instead we are
saying I'm going to have what's called
an isolated mutability isolated neural
to use different capsulation though
encapsulation is where I have it data I
have review methods that to access this
data you cannot touch the data directly
but you can ask my method to run
unfortunately though when you call
vertical threads on this object across
these methods I have to worry about
thread safety at this point right but
the point really in here is rather than
cancellation we are isolating the
threads so managed in this case the idea
is the isolated durability simply says
when multiple threads ask the object to
do some work the object guarantees that
only one thread will run at any given
time that's guaranteed let's think about
an example for a minute
well let me click on Chuck again as an
example here we got chocolate he's got a
phone number but he's missing in a
meeting he's not going to answer this
phone right now I'm going to call Chuck
and you're going to call Chuck exactly
at the same time who's going to be able
to leave a message because it's not
picking the phone both of us right
absolutely
multiple of us can call at the same time
and leave messages for him so this is
purely a
Karnas also has a fire-and-forget model
we can simply send my system and move on
well Chuck comes back room is meaning
looked at his phone and says boy it's
been a busy day look at all the messages
that are waiting for me he's going to
start listening to these messages how
many messages can shuckles into at any
given time Wow this - evil ah okay he
doesn't understand them
that's the suffer model again right so
if you were to understand the messages
how many was it - at any given time one
at a time even though he has two years
here was this only one message at a time
why because he tried multiple messages
and you realize that multitasking sucks
right
and our the time he realized that he can
take one message at a time either finish
it or delegate it and then move on to
the next message that's exactly the case
about actors so actors are little
objects that one in their own thread and
we can send messages to actors a rather
than calling methods we send messages
and actors themselves happily sit there
and receive these messages and forces
them over and over as the messages
arrive but only one message will be
processed at any given time not multiple
messages at the same time so let's take
a look at an example of how that could
be used within an example here I'm going
to create a simple actor here for us to
understand and then we're going to a
little bit more complexity if if time
were to permit so let's take a look at
an example of what I want to do we gotta
create an actor first of all what kind
of actor can I create well we need an
application to use actors the library or
a framework are a tool I used st of
earlier and I use closure SDM by the way
there are multiple
implementation of SDM also available on
the JVM one of them is called multiverse
for example which is an API available
Scala has a steel implementation as well
so there are multiple implementations of
SDM when it comes to actors there are
about seven to ten libraries available I
mean you know this already that's a
beauty of the Java world right we can
never have one solution that works we
can always have character we know fight
against each other and we can spend the
time figuring out
same thing with actors as well there are
multiple different actor libraries
available for us to be confused
unlearning is just one of them which is
pretty good here which is called the
akka library and anka basically is
written in scala but people use it from
Java here because just a library just
like we reach into spring or hibernate
we're going to just reach into it and
use it here let's see how we going to
use that here so what I'm going to do
first of all here is I'm going to import
a card our actor darkstar to bring in
the imported package and I'm going to
say actor system I need access to the
system itself and use the actor system
and this is going to be actor system dot
create and one of the first things I
remember to do is I simply say actor
system shutdown because we don't need it
anymore at the very end of this forgot
create an accurate using what kind of
actor can I create so actor ref I'm
going to create an actor well what are
their bitter and blue for enough right
we can create a Hollywood actor
resilience so we can simply say that
death is a favorite actor because my
children keep saying is movies all the
time so I have to say here actor system
dog and I'm going to say actor of new
props so I'm going to specify the object
I want to use here and this is going to
be the Hollywood of actress so Hollywood
actor a actor dark Lance
so notice rather than using new to
create this object we simply use the
factory we created and the reason is you
want the heck
even through the library's managed code
so we can have the thread being managed
by you automatically isn't it so now
that I've created the actor I'm going to
say that dark hello we're sending a
message to him and ask him to act the
role of Sparrow for a minute
so that's online code of course I need
to have that attribute up for me to
allow this part of the code before we go
any further let's pull up the Hollywood
actor here real quick so you can see
that the class Hollywood actor is
sitting right here and I'm going to
extend this from untyped the actor which
is a base class I'm going to provide
here a mythical on receive which is
going to take a message
so it was a final object message as a
parameter percent to me so essentially
on the client-side we call the TEL
method on the server side we are calling
an on receive method to say run the spin
up method is across that message arrives
so we don't have to deal with messaging
ourselves the library takes care of that
for us so when a message arrives the
theme and there's a message popping up
and Chuck can be actively working on it
but until then it just relax and use
iPod and then have a good time
right so the point really is that it is
sent to him and he can receive and
process that so how do I really work
with this here so I'm going to say
playing and I'm going to simply display
the message we are playing here so our
friend this message that's all I'm going
to do on this side and notice in this
side I'm just telling him what to do and
run the code you can see that it says
playing Matt Farah and it tells us it's
played that message but of course we are
curious what really happened over here
to make this a little bit more
interesting let's go ahead and say in
Maine and I'm going to specify the
thread dart
current thread so we can see where the
thread is in the main itself and of
course that should be no surprise
maybe's running in the main thread but
I'm also going to go back to this code
the actor itself and then say plus and
after the message itself I will say
in and let's go ahead and display the
threat information for us to see in the
actor itself this kind of noticed that
in this particular case I'm going to
specify that directing is running in so
let's fix this first of all so this will
be pretty dark current right now that's
what I want to fix over here so what do
they do anybody sees that all plus two
pluses thank you so right there is the
Plus message thank you so you can see
that in this case ah look at that the
main is running in the main thread or
the other again Spano is money in a
totally different thread and what time
is he wanting in he turns out he's
running in a dispatcher threat of some
kind in fact if I lower the horn we hit
a little bit you probably see the
dispatcher thread number hey that's a 1
as you can see here
did you notice we never fear the thread
in our code but automatically points in
a separate thread and the reason is
actors running their own threads what if
I have multiple actors at the same time
well let's go back and try this one more
time so this time I'm going to be yet
another actor and this actor I'm going
to call as Hanks over here and I'm going
to say Hanks to do some work here so
Hanks dark L and in this case I'm going
to say here let's say gum so we're going
to ask him to play another this actor to
play at the terminal but you can see
that they both are running concurrently
raise this up here for you you can see
good they both are running concurrently
but you can see that sparrow is running
in thread 1 and Hanks this concurrently
running in Fred - so every actor ones in
its own separate thread and at any given
time so they can be concurrent but what
would one actor what if multiple
messages are sent to one actor at the
same time so going back over here notice
right after I send this payroll method
message I'm going to say requested
Sparrow and I'm going to also say output
here requested let's say requested gum
so then I'm going to go back and do two
more messages if you will this time I'm
going
tell that to play let's say one cup and
I'm going to ask him to play Lavelle
here and of course in this case we can
see what happens so I'm sending these
four messages one message at a time but
notice that the main is not to wait for
that the main simply runs through and
it's a asynchronous request so you can
see all the requests misses are piled up
in the top and they are queued up in the
object to be processed and notice though
that Sparrow is on thread 3 and Wonka is
on thread 3 as well that tells us that
it was process sequential II one after
the other and multiple actors can be run
at the same time but any given after
only does one work at any given time and
then moves on to the next one of course
looking at this one you're saying gosh
if that is true
is it true that threads hold these
actors hold these threads hostage
fortunately no the library maintains a
pool of threads and less they pull up
red shade by the actors when an actor
doesn't have any message to process it
doesn't hold on to these threads think
of a thread to an actor as a waiter to a
restaurant table the waiter doesn't wait
on the table but the switching between
multiple tables and the need may be in a
similar way that thread from the thread
pool shuffles between the actors and
whites their needs as and when messages
are available for this process but the
guarantee here is no two threads will
enter the particular actor at any given
time in a given instance only one that
moves will be in an actor at any given
time so this gives a fairly decent
amount of scalability in the code as
well as we can see so given this how do
we really put something useful with this
let's take a look at an example of how
we can apply this so let me say that I
have a stock info class right here the
stock info is a fairly simple
pojo object all that the stalking
processes I will protect the stock
information of highs on a thicker
information that's all it does trick now
I'm going to need an actor I called a
stock collector now I want you to focus
on this part for a minute now all this
you see here in this part is I would
like to call these as not encapsulated
variables but as the isolated mutable
variables because these are part of an
actor no two threads will modify these
mutable variables at the same time they
are beautiful but they are isolated and
in the on receive method I'm simply
using the logic so as the message
arrives meeting a stock information rise
I compute the real maximum which our
stock is maximum and I'm going to reset
the stock high price no need to read the
code inside the onreceive
because that's purely logic that we are
used to writing isn't it but the point
really is that the on receive is going
to be called and I'm going to send him a
stock info object and based on what I
send him he will compare and update the
highest price value for us how do you
want to use all of this stuff so here is
an example of using all of this stuff
let's first of all go ahead and write
this sequentially and play with this
versa fault so I'm going to go to Yahoo
and get the stock price so I'm going to
say over here first of all this is a
sequential code I'm going to write I
measure the current time I ask him to
create an empty stock price here is a
traditional form loop and within the for
loop I'm simply looping through and
getting the Yahoo Finance get price you
can take a look at this code on your
website and see what this parsing code
does it's it's really not a culture to
show forcing code in public these days
so I want to know the parsing code but
you can take a look at it in the privacy
of your home or off mic and all that
it's doing is getting the twice for us
in giving us and then I'm complete
Frye's and saying alright here's the
highest price based on what we were
given so I want to go ahead and call
this do sequential function and this is
going to go to Yahoo and get the highest
stock price based on whatever we have
right now of course that requires
internet connection which I don't seem
to have at the moment let's see if I'm
able to connect to it so essentially
that's what I'm doing is simply going
out the Yahoo and getting the price now
how do I do this concurrently if I
wanted to do this concurrently let's
talk about concurrent application of
this now that shouldn't be too hard to
do so do concurrent what I'm going to do
here is simply start out by creating a
tag for system as you can see right here
and once they get the actress system I'm
going to say create me a stop collector
and once you create a stall collector
telling how many stock prices are going
to expect and then they go through a
loop as you would imagine but within the
loop I'm simply delegating this to a
thread and saying hey you thread go get
the stock price from Yahoo and when you
come back please go ahead and tell the
collector that's the price you have so
forth notice we don't have any locks
over here as well and of course I'm not
able to connect to the internet so we'll
show you here but this code is online on
the website you can try it but you will
notice that in this particular case it
would take anywhere from 20 to 30 to 40
seconds on sequential but that
concurrent would take less than a second
or about two seconds per run because it
was concurrently but essentially what
I've shown you here is something very
simple we definitely want to avoid
synchronization as much as possible
because synchronization is extremely
hard for us to reason and anything we
have to lock something we have to sit
there and scared and say use this
locking properly and my
doing the right thing it's extremely
hard to reason that code and errors
creep in so by looking at these two
models what we are decided to do here is
completely avoid synchronization and
then we said let's focus on to creating
a simple model that's easy to understand
easy to reason easy to prove that this
is doing what it's supposed to do now
that could be going to have to deal with
the logs we got several things really
removed from our shoulders right you
feel a little lighter today right why
when you don't have to log you don't
have to worry about where to lock ready
to lock which objects to lock which
level to lock did we lock at the right
time they below for the right duration
we don't have to do any of those and
that saves the search effort and time
and we can develop code focusing on the
problem you're trying to solve
rather than chasing behind
synchronization problems so these
memories are available on the JVM that's
what the beauty of that is so we can
program them in any language but of
course there are a few things we have to
be careful about and when it comes to
actor itself after this useful man you
want to have a separate task running for
a long time think about like a printer
in your department right you can send
multiple jobs to the printer you can
send jobs to multiple printers but
you'll be very upset if a printer
interleaves paper's like some people
sometimes do right so that's where the
concurrency she was taking care and
coarse grain things can be passed around
pretty easily if you are interested
further you can download this code right
from that URL and that's our post with
that right before the stock and you
should be able to get to that thank you
very much for your time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>