<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Autosharding Enterprise to Social Gaming Applications with NoSQL and Couchbase | Coder Coacher - Coaching Coders</title><meta content="Autosharding Enterprise to Social Gaming Applications with NoSQL and Couchbase - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Learning-Library/">Oracle Learning Library</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Autosharding Enterprise to Social Gaming Applications with NoSQL and Couchbase</b></h2><h5 class="post__date">2013-02-01</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/2SreEtCWAHM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">good morning everyone thanks for coming
everybody hear me in the back okay great
I know it's a little bit early you know
the partying hasn't stopped I guess but
you know I really want to thank you all
for coming i know it's little early but
you know we will talk about no sequel in
couchbase just to get an idea of how
many a few are already using couchbase
or some other no sequel technology and
they're very familiar with a maybe five
or six people okay yeah that's that's
good enough so you know that's kind of
what I get so what I'll do is we do a
very quick intro of no sequel and what
it is this is not by any means as
session on no sequel okay but a lot of
these concepts can translate across the
board to several of these technologies
as well so by introduction my name is a
dragoman shriniwas i work as a developer
advocate in couchbase if any of you used
the spy memcache d libraries you know
most of the recent bugs are introduced
by me okay side work so I'm working
towards fixing him but you know Matt
engine Tron he originally was the
creator and maintainer of spy so most of
the older bugs it was in that let him
introduce himself yeah Dustin Stallings
wrote it originally I was I just
maintained it for a while so yeah but
now we have a number of other fingers in
the in the pie as it were yeah so I go
by rags feel free to call me rags and
matt goes by Matt so it might be
difficult to get either of our last
names okay so very easy to reach us rags
at couchbase calm and Matt at couchbase
calm okay we still have passed name at
couchbase calm alright so the agenda for
today in the next you know 55 minutes or
so it's gonna do a quick intro and then
look at document access using primary
keys because 95 maybe eighty to ninety
five percent of the use cases are going
to be based on primary keys but we have
a really cool feature using vuze you
know this this came
from a from the CTO of couchbase who
originally was a contributor couchdb by
the name of Damien cats you know a
concept or what is referred to as views
and queries it's based on a incremental
MapReduce technique and we'll talk about
that you know this is a feature that's
new to couchbase server so you need the
latest couchbase server to be able to do
this and really what it enables you to
do is to do secondary indexing as long
as you persist your data in JSON and
we'll talk about that we have a bunch of
demos plan towards the end of the
session depending on how the network is
behaving you know and things like that
okay so we will we will do either all
the demos some of the demos or maybe
none of the demos now hopefully not none
of the demos but we'll do at least some
of them then towards the end we have a
few case studies will do a roadmap
conclusions Q&amp;amp;A and you know we have
some nice t-shirts to give away you know
if you ask some questions all right so
we have a bunch of them so we can we can
definitely do that anything else you
want to add Matt yeah right so really
very briefly and what is no SQL ok this
is a cartoon i saw in geek and poke i'll
let you guys kind of look through this
for a little bit ok so little bit
tongue-in-cheek but you know how things
start off right in army so it's it's
that's the way it is ok but but
essentially I think really it it stands
for not only SQL and and I think there
was a product in a more of an object
oriented database probably a few years
back which was no SQL but but somehow
the name never really caught on but
roughly about three years back there was
a meeting where you know they're trying
to come up with some kind of name which
not quite SQL and I came up with not
only a scale okay by no means SQL and
NoSQL is mutually exclusive there are a
lot of applications which can benefit
from using both but at the same time
there are a number of applications where
this
normalization rules are not really
necessary and they can be relaxed in the
Indy you know for the sake of like
simplicity and and really for the sake
of performance and so on and that's what
we're going to see today so it's really
not a single class of database it really
encompasses a lot you know I'm not going
to go into the taxonomy of no sequel
databases but but essentially you know
they don't provide a relational
interface something that you know you
have your views known and low or
whatever right they have their own way
of accessing the accessing the data and
like I said a lot of times some of the
rules of normalization are relaxed a
little bit for the sake of performance
and simplicity so that typically don't
offer a lot of the RDR dbms feature so
they're schema-less and you know
schema-less is probably a very strong
term it's really more of a scheme of
flexible you know we'll see some
examples today where you can change your
schema on the fly and your application
is still able to adapt to some of the
schema changes I mean does it mean that
there is no schema at all you know I
don't think so because you are
persisting your data is JSON and when
you purchase your data as JSON there is
some sense of meaning associated with
the data but if you don't persist as
JSON ok it's just treated as a binary
blob in couchbase okay there are
typically not too many key constraints
no long-lived transactions and really no
concept of a joint something that you
know you know joins outer joins thinks
that you're used to does that mean that
you can't do it yourself of course you
can okay and we have an example you know
basically about beers and breweries a
very simple relationship beers are
brewed in breweries breweries make beer
right and you can you can kind of play
around with the data and implement your
own inner left join of you know and it's
it's pretty trivial to do that it's
really well suited for crude for cloud
deployments only if you have seen this
before the cap theorem 2 3 4 7 10
okay so essentially there are three
properties in any distributed system one
is consistency availability and
partition tolerance okay so amongst the
three you can have a maximum of two in
any system in any distributed system so
typically you can have not typically but
but you can have only two properties and
and typically lot of the traditional
databases you know do consistency and
availability really well and and you
know they sacrifice partition tolerance
okay and and there is a reason because
you know it's really about monolithic
databases and and that's kind of how it
was working before of course you know
these lines are thinning these days but
what the point is that most of the no
sequel databases you know start off with
the assumption of partition tolerance
and they either sacrifice consistency
our availability it doesn't mean that
it's not going to be available at any
time or it doesn't mean that it's not
consistent at all okay there are degrees
of consistency and degrees of
availability okay couchbase itself is a
CP system okay it's consistent and
partition tolerant okay so why do know
SQL at all you know my foot most of us
start off with a monolithic you know
program right and then suddenly
overnight we become a huge success and
now we're scrambling to to make it
scalable so scaling the web here is
pretty straightforward right you know
you throw in a load balancer you throw
in you know more servers in the front
end and your your application scales
relatively easily it's not that easy to
do that on the dated here okay just you
know growing your your database
vertically you know there is a ceiling
you cannot go beyond a certain limit so
then what you could do is you could say
well you know I'm going to come up with
my own sharding algorithm very simple
algorithm a2l is going to go here m to Z
is going to go here right but what's
going to happen when you throw in the
new server what what's going to happen
when the server that's serving a to L
you know dice how do you deal with this
right so the application you know is
going to be tied very closely to the
sharding algorithm and that's seldom a
you know a good idea so it's very
expensive and very disruptive and
doesn't really you know you you don't
want the onus of the sharding you know
to be really on the application
developer so the idea behind many of the
no sequel databases including couchbase
is that leave the sharding you know to
the framework and you worry about you
know everything else on top of that okay
and we'll see with some of the demos and
some of the examples today that it makes
it a lot easier to scale we're that way
okay so so typically like I said when
you're scaling your database up there is
a point where you kind of hit the wall
right it you cannot keep growing and
usually when I'm when I'm in other
confidences you know I make a joke about
article but you know it's article open
word so I got to be respectful to them
but you can only go up to a certain
limit right so what you really want to
do is rather than keep growing
vertically you want to try to grow
horizontally okay so simply put that way
so the idea behind growing scaling
horizontally is that your your curves
here which are kind of going
exponentially both the system costs
which you would expect to grow up
exponentially right and also the
application response time okay you want
to try to flatten it as much as possible
okay and that's really the idea behind
no sequel database okay simply put so as
long so what what coach base does is it
does auto sharding and you know we'll
talk a little bit more about this so for
each key there is a specific server that
it goes to and you know there is a
consistent hash algorithm which kind of
works with the network topology changes
meaning when you add nodes or subtract
nodes you know it's it the the client
library maps you know is going is is
able to keep keep track of those changes
and do the right thing for you so you
don't have to from an applique
developer perspective write your own
shouting algorithm you know figure out
you know which zip codes goes where
which has to be active at what time and
all that you know leave it up to the
framework so one of the examples that we
give this you know any of you played
this game or entry pop yeah Draw
Something yes all right yeah from OMG
pop yeah essentially you know you can
you can you can draw some cool things
okay I haven't played it much myself
okay but what happened was like all of
us expect you know all of us want this
v.v wanna you know be a successful night
and that's really what happened you know
somebody Jersey sure I don't know what
Jessie sure is you know I think it's
like a cereal or something you know
anyway tweeted you know tweeted and
suddenly it became you know instantly
popular right so you can see here there
was somewhere it's like 200,000 users
and they went to like 20 million users
you know all within a matter of few
weeks okay the event from like literally
like half a dozen servers to thousands
of servers okay written you know matter
of few weeks okay and they were able to
do that because again the idea is that
you know you'll see later in the demo
adding servers throwing them in and
adapting to the changes as the
application is working you know it's
relatively straightforward using this
framework okay so with that let Matt
talk a little bit about coach base and
I'll come back and you know kind of do
some demos and so on right Mac you can
use this if you want good morning well
people are still streaming it no thank
you so I just wanted to spend a couple
minutes talking about couchbase
specifically the draw something example
OMG pop actually did build on couchbase
so when they had the need to scale that
up they did use a lot of what you're
going to see this morning so catch my
server itself I just want to give you an
idea of what it is they're very
obviously a number of different ways
that we could talk about couchbase just
to give you the the brief definition
couchbase server it's it's a it's a
document-oriented flexible schema always
on no SQL database system so it's really
designed for interact that's designed
for interactive applications so in this
world of no SQL one of the things that
I'm going to show a little bit later is
actually integration with Hadoop Hadoop
actually fits in that no SQL category of
things and you can sort of look at
couchbase if you will as modern oltp and
Hadoop is sort of modern DSS in a way
both spread wide both scale very well
and couchbase specifically is trying to
go after that that's that spot for
interactive applications so briefly
catch bass is open-source patchy to do
license you know some minor details on
how you obtain it and so forth and as
you'll see in a little bit it's all
administered by a web console through a
restful interface we're actually pretty
proud of that the in fact one thing that
we're really proud of is that there's
not a single master within the cluster
there's not like a set of systems that
manage it you can make requests of any
node in the cluster and it will take
care of whatever that request is from an
administrative point of view you can
also see a lot of different statistics
as ill as will show in just a bit
available for a number of platforms
windows linux mac c c++ is actually how
the core was developed even though some
of the clustering was developed an
erlang question here what that's
referring to is so that's what linux and
windows are sort of enterprise platforms
max people don't usually use this
servers yeah no worries it would
certainly work but we don't really run
the full Q ace we don't build like
hundred node Mac clusters that would be
sort of funny you know there was a point
in time when Apple is doing some of that
but not not so much anymore right so the
so it's a the as rags mention one sort
of interesting thing is that while catch
bass is definitely a document-oriented
database it has this history from
memcache d in a project called mem base
and it actually works very well is just
a distributed key value store so there
are a number of people who had for a
variety of reasons maybe they'd written
an application that was using memcache d
and it was back ending things to mysql
with some sort of custom partitioning
built into the application and it's easy
to just sort of as a colleague put it
you know write negative lines of code
you can go remove that portion that's
putting things in mysql and just start
to use the the key value store instead
of as a cash as a persistent store a
couple things on architecture so catch
base server has effectively two major
components to it the data manager which
is really where all the core i/o is
happening that's what's doing protocol
handling provides the query information
Querrey api and so forth one second and
then there's the cluster manager portion
the cluster manager is really all about
clustering the nodes together and
understanding what the topology of the
cluster and adjusting to topology
changes in failures good question it is
a yes question was will the presentation
be available afterward and Oracle is
posting them up absolutely so the let's
drill into that just a little bit not a
lot so they're they're effectively those
two aspects to it if you were to go one
level deeper what you see is inside the
data management side of things there are
a few things that we've written that
were needed to be really
high-performance see oriented and that
we based on memcache d we also built a
the query engine over there actually
parts of the query engine do user lang
and then we built a new persistence
layer and that's that's a that's a very
modern persistence layer to depend only
file format which is generally the way
to make something really really reliable
and and fast it's one of the space-time
trade-off things so it does trade-off
space although we do address that with
automatic compaction then there's the
cluster management side and again this
is really just about checking in on all
the nodes telling clients what's
happening if
have topology changes allowing you as a
developer or maybe an ops guy to script
up adding servers together things of
that nature as mentioned earlier it is
both a distributed key value store and a
document store so that means that from
your application perspective you
actually don't need to even really think
about where these things are going
that's that's a really freeing sort of
thing you simply have a document a name
for the document which is frequently
called the key or the ID you hand it off
to this API and say I'd like you to
store this I'm going to come back for it
later and then the cluster is
responsible for all of that you don't
have to think about the sharding or how
how the sharding actually occurs and so
the the verbs that we frequently use
because it has this memcache d legacy or
things like set and get rather than put
and so forth keep from a key value store
perspective all die items are stored and
retrieved just using standard operations
and they're evenly distributed across
the nodes of the cluster by wavy buckets
v buckets are are really just a layer of
indirection so when something that's
kind of unique to couchbase there a
couple other no SQL databases that work
this way but some of the some of the
systems in the category of no SQL will
have to do what are called metadata
lookups or quorum reads depending on the
how the system is built and because of
that they either move more towards where
they don't have consistency or they have
to do this metadata look up which
increases the amount of work in order to
access an individual piece of data and
that has an impact on a couple of things
one is it has an impact on throughput
and latency because if you're having to
do a metadata lookup or a quorum read
that's just more work and more work
takes more time the second area that has
an impact is if you're doing something
like quorum reads and I don't want to
say that quorum reads our bed it's one
of these things where I think there are
scenarios where an AP type no SQL
database makes sense but for the
majority of scenarios we believe a CP
type
system makes sense the reason is you as
an application developer if you're
writing you know code I need to I need
to reference a document and suddenly the
database system comes back and says well
I got these two I'm not really sure
which one's right that's that's sort of
you have to write your code very
defensively I would refer you to
something like the the Amazon dynamo
paper there are good use cases the the
in amazon's case they talk about the
fact that you can take the shopping cart
and if you have to request for the
shopping cart and the system says hey
I've got to shopping carts for you well
that's pretty easy for amazon they just
merge them right there are scenarios
where you can very easily come up with
the algorithm but they're the majority
of scenarios we believe that trading off
momentary availability we still have
automatic failover for purposes of
consistency really makes for easier
application development so the another
couple things we do store if you do
choose to store json documents into the
system now we can actually get some more
information so the the the database are
understands what json is and allows you
to write additional code to be able to
extract information from that JSON so we
sort of like the giveaway here right we
sort of jokingly talk about new schema
right so but realistically it's flexible
schema or implicit schema so each
document when you write that application
you have entities as entities have
certain attributes when you store those
documents to the system you sometimes
want to be able to go back and extract
data from that system and it doesn't
matter say if two records for two
individuals have slightly different
format and this is very liberating in
that you don't have to work out how am I
going to map my object level down to a
relational model I can simply store
things as an aggregate and then be able
to extract information back out of the
system later and you'll see some
examples of that just very briefly to
show you how this works from your
application perspective to the cluster
when the application starts up it's
really just going to have a set of nodes
that live out inside the cluster if a
new node happens to come online we
actually use a calm
a stream back to that client so when
when a topology change occurs when we
had a new class node to the cluster will
send a topology update to that client
this also works for failover same same
methodology here and once that new node
comes online now that that client will
immediately start using that new node
also worth mentioning is just how do you
start things up it says it's actually
quite simple it'll look relatively
restful from a client perspective you
when you create the client you're really
just creating this counter based client
object that has all those verbs set get
etc has the query API and access to the
views but really instantiating a client
is just a matter of pointing it to one
or more nodes in the cluster now you'll
notice that i may have 100 node cluster
but i really only need to point it to
two or three it will dynamically
discover the rest of the cluster after
it initially bootstraps so this is just
a restful bootstrap to understand where
to start you got to have a starting
point so frequently that will be
maintained in a properties file or
something like that yes question
No
sure so the question is what if one of
those nodes happens to be down that's
why and I sometimes get true people give
me a hard time because I forced the the
constructor to take a list and so it
will iterate through them until it finds
one that's up yeah so it'll take a
little while to determine that that
guy's not there I'll move on and
bootstrap somewhere else now the one
thing that you do need to be aware of it
this is a in our in our current client
library because we don't try to purchase
things to disk on her own or
configuration or anything like that one
thing that you do need to be aware of is
if you completely swap your cluster and
that does happen anyone use a ec2 by
chance and around december of last year
if you got one of those emails i don't
know what happened exactly but they
basically said everyone on east please
get off and the neat thing was that we
had a number of customers who were
deployed and it was really just a matter
of you know they couldnt Stan she ate
new nodes in the same region but the
ones that they were on they had to move
everything off of so they just
instantiated new nodes completely
swapped out the cluster hit the
rebalance button all the data moves no
in that situation you're gonna want to
change your bootstrap your eyes because
suddenly all of your nodes of the
cluster change yes exactly yeah so but
we have that bed scenario covered so
with that I'm going to turn it back over
to rags and I'm going to come back a
little later and do a bit more
demonstration so like what I mentioned
earlier you know 80 to 95 maybe even 99%
of the use cases are going to be based
on primary key and because of our
history from memcache d you know which
essentially takes care of persisting
your primary keys you know it takes care
of hot keys and all that you don't have
to worry about you know how to access
those keys where they are distributed
all that is done by the infrastructure
but essentially it provides you a simple
set of operations add replays set and so
on you know very easy to figure out what
they do just by looking at it okay
there's also a property called as TTL
which is time to live and this might
scare a little bit
you know some of the database
programmers away basically what happens
is after that particular time you know
that document is no longer valid ok this
is this is true of a lot of those
documents out there you know something
may not be valid after a certain amount
you know a certain time or something may
not be valid after 15 seconds in kind of
like a gaming application that you're
developing or something like that so you
can specify the TTL either as an
absolute time or a relative time um then
there are a bunch of other things like
get get in touch you know which updates
the cast and so on you can get bulk and
and so on okay so here's one thing about
couchbase which yeah let me let me hold
off on the questions if you don't mind
but essentially one of the things about
coach basis that you know pretty much
everything is asynchronous okay this got
me the first time when I was doing it
you know my name is programming in coach
base essentially what you do is you you
set a future object right with the
return value from from the operation and
then when you go and do a get is when
you're doing a block on the particular
operation to complete so what it allows
you to do is it allows you to queue
millions of operations per second and
only when you really need the result you
know that's when you go and get the you
know the result by just doing a get as
you can see here basically what I'm
doing is I'm I'm doing at set and I'm
you know going around and doing whatever
I want to do but only when I want the
result then what I do is I do go and do
is get on the set up and now I can look
at the you know what happened to the
operation and so on so essentially we
are using a future object you know just
like a you know any other job of future
object and and the strange thing is that
even a get has an asynchronous version
of it okay like there is an async get
again and it's exactly the same so what
it allows you to do is to it allows you
to queue operations as quickly as
possible how do you implement
concurrency there are two ways of
implementing concurrency one is you know
the pessimistic concurrency using gate
locks right so you grab the lock and
nobody else has access until a
particular animal on a time just thought
just to jump in for a mo
and so the issue is that once you move
to a distributed system now you need
some new concurrency primitives in order
to describe how that application and
that distributed database operate
together you can't necessarily rely on
you know with the traditional rd VMs
everything's going to one place right so
we need these new concurrency primitives
and we've added some of those yeah so
essentially one way of doing it is using
the ghetto which locks a resource and
until you unlock the resource you know
nobody has access you know that
particular piece of resource that you're
interested in this is you know you know
how how we you have done this in the
past the difference here is that there
is a default of 30 seconds okay so if
you're if you die within 30 seconds or
something you know then what happens is
you know that that lock is released
after 30 seconds you know typically
that's more than enough and then you can
implement a a graph of these different
locks you know to do long-lived
transactions and so on but a more
interesting version of this is a what is
referred to as optimistic concurrency
and the philosophy behind this is that
you know these things happen and when
they happen you would rather deal with
it when they really happen then try to
prevent them from happening okay so what
you do is you use what is referred to as
a cash value okay which is basically a
long value which is incremented every
time you do it Cass you know in effect
and then what what happens is you
provide the cash value and say set this
only if the cash value matches okay so
if it matches it's a success if it's not
you get back in class mismatch doesn't
mean it's a failure like what Matt was
alluding to you may need to merge the
shopping carts or you may need to merge
the comments on a particular record or
something like that right so you the
moment you get a cache miss match then
you you know the application can deal
with it in the most appropriate manner
you know that you know the application
really knows about it okay so it doesn't
mean so so the top one is optimistic
concurrency and the other is ya think
yes pessimistic concurrency
so so far we talked about really server1
coach base over 180 k which is really
previews and queries okay and like what
you know Matt and I talked about earlier
is now if you pass this to your data as
JSON you can pretty much slice and dice
your data in any form that you want okay
a lot of the use cases you know let's
say I'm Starbucks you know I'm really
interested in each of these different
coffee shops right so I provide an ID
and I look at you know each of those
coffee shop but as a user you know I may
be interested in all the coffee shops in
san francisco right which is typically
not a primary key kind of access okay so
what you can do in those case is if you
persist your data is JSON then you can
say you know get me all the you know all
the coffee shops which are in this range
of zip code or which are in the state of
California are in the in the county of
whatever Sonoma or whatever this is okay
so so you can do something like that so
essentially the view and query up a AP
ice allow you to do that so the
difference between couchbase server to
Otto and whatever was there earlier is
that essentially it adds JSON based
storage so the server looks at it and
says is it JSON ok if it's jess and then
it does something special with it right
if it doesn't if it's not JSON it just
treat it as a binary blob and deeper
sister okay so just one thing to watch
out here is if you you might be thinking
you're persisting in JSON and that's
happened to me a couple of times okay
and you may if you have a syntax error
then it ends up being a binary blob so
just watch out for that okay views are
materialized with indexes and basically
what this is is secondary indexes which
are stored on desks okay and we'll we'll
look at that you know really quickly so
essentially what views are like I said
there are different perspectives on the
same data you know and enable secondary
indexes and really you can create
secondary indexes and whatever it is
that you want you can create indexes on
salary you can create indexes and
department number you can create indexes
on zip code like I said before you can
create indexes a name just about
everything all right
it uses something called as MapReduce
you know don't shuttle at the tart of
MapReduce it's you know it's basically
the philosophy is just the same meaning
what you do is you take your task and
break it down into chunks that each of
these different nodes can operate on and
then you collate the results back and
present it back to the user it's the
same philosophy okay and you express
your MapReduce in what is referred to
you know in JavaScript again we will see
it's very simple it emits key value
pairs and the key is the one that's used
to you know kind of sort your data if
you will okay and the values are used to
aggregate you like for example you can
do count sum and starts and so on okay
we'll see some examples of that and
things become very clear how our view
Smitty list and their materialized using
indexes you know these secondary indexes
are stored and the different nodes and
and like I said they get brought
together and present head back to the
user okay so a map function creates a
mapping okay between the input data and
how you want to see the data that's
really what it is okay and reduce really
provides a summary there is a concept of
what is rear adduce and all that but we
don't need to worry about that right now
okay so essentially what a map does is
it outputs one or more rows of data and
associated with each row you know there
is a concept of what is referred to as a
document ID okay although you won't be
able to see it you you can you can
access that you know using any of the
language api so and we'll see that you
know in the demo essentially what they
do is they emit key and value pair okay
so key value pair okay and that key will
be used for sorting and querying and so
on and the key and the value itself is
stored in the index okay so what you
want to be you don't want to be tempted
into a situation where you want to store
the entire record as a value okay
because you always can get to the record
by using the document ID because that is
available in language api and there are
some ways in which you can optimize your
views because remember these are all
secondary
texts that are stored in that is
different nodes and you may want to
optimize it in number of different ways
and we'll look at that in a little bit
so some of the rules associated with
views are that all views there is a
concept of what is referred to as a
design document and within a design
document there are a number of views all
the views within the design document is
incremental I updated whenever any
single view is accessed so what you want
to do is you want to put related views
in s you know in the same design
document okay there are a number of
other optimization techniques as well if
the end time you know view is recreated
and you can create that you know using
the admin console are using a rest based
program you know there are number of
ways of doing that okay if the view
definition changes then the entire
secondary indexes you know kind of
thrown them in and recreate it okay
there are various in which you can get
the freshest data but it's a trade off
against performance okay they're always
access lazily by default meaning you
know they're you know if nothing happens
you know if nobody accesses the view you
know nothing really happens you know no
no big deal right another way to put
this is it's an eventually consistent
secondary index you know if any of you
have ever used say Google Docs I
remember we you know frequently be you'd
invite somebody to a document and then
they'd go pull up their document list
and it wasn't not good there you know
they'd get the email and they'd have a
direct link but they wouldn't have it in
their document list because the you know
the big Google Map Reduce engine hadn't
come along again and found he had so
it's effectively the same idea and for
many many use cases it's actually a
pretty useful thing one that we toss out
frequently is things like leaderboards
so you have an option of either being
having a consistent index at the cost of
updating the index or an inconsistent
index at the car in getting a
performance advantage yeah now that's a
good segue you know what if one of the
coffee shops in 10 physical is missing
you know I think I can deal with it
right most of us can but if you are
really you know if you want the latest
coffee shop in San Francisco you can say
stale is equal to false meaning I
wander freshest data and now what
happens is when you're updating when
you're accessing the data you know the
indexes get updated so you know that's
the trade-off you have to deal with so
you can set the scale is equal to false
and work that way so the index
information is stored on the disk and
like I said it's all stored
decentralized and this kind of picture
kinda illustrates this all the indexing
work is distributed amongst the
different nodes and then essentially
what happens is whenever you do a query
you know they're kind of brought
together and present it back to the user
you know this is in principle all right
so we have some data you know is
essentially we have if you if you
install the latest server we have beer
data okay and we have you know I also
work on presidents data so essentially
we have all the you know 44 presidents
with all that information associated so
you kind of kind of play play around
with this especially with views and
queries and this is typically how a map
function is you know is express this is
in JavaScript okay it's you know
somewhat different but but you know it's
pretty much the same okay essentially
i'm specifying the map function and
basically i'm saying if the type is
precedent okay and there is a home state
then what I do is Amit the home state
and the name you know I could emit
really just about anything that I want
okay so what it's going to do is it's
going to organize it in terms of you
know home state you know very
straightforward all right so you
conceptually this is kind of how it
looks you know Arkansas value blin Bill
Clinton California Richard Nixon and so
on and so forth all right on in addition
to the map function you can define a
reduce function as well okay there are
three inbuilt functions one is count and
the other one is some and the other is
stats okay stats gives a lot of
statistical information count is very
straightforward count and some is you
know and some all right so basically if
I'm using the count function then your
radius function kind of looks something
along these lines you know not exactly
the same but basically it spits out
Arkansas Bill Clinton California
California Richard Nixon Ronald Reagan
Georgia and then Illinois Illinois or
whatever right and then what it does is
in the reduce function it basically
takes the array of values and counts the
length of the values which is really the
you know the count that's going to be
finally emitted out ok so the conceptual
was a result of the radios will be
something along these lines what home
state and what's the value the count of
the number of presidents in that
particular home state does that make
sense okay this is a little bit more
interesting example and again this view
is prisoner is already available to you
if you just install the couch base
server with some of the you know the
sample buckets essentially what i'm
doing here is you know i'm sorting on
country state and city okay so if there
is no state than i do country instead if
there is no state than I do country
along all right so with just one map
function what i can do is i can sort by
country state City or by country state
or by country city I mean by country all
right and we'll see some examples of
this as we go along and all that all
that i'm doing is i'm counting d you
know the the number of rows in that you
know which which basically belong to the
category all right so i could say
something like get me all the are these
sum of all the breweries you know in san
francisco in Kevin in USA in California
and San Francisco you know I can do that
yeah okay yeah that's a good point and
you saw that it was not available before
but basically meta is for getting it the
metadata okay like for example I talked
about the cash value remember that and
the TTL you know some of those can be I
don't think the cast is available but
the PTL is available and there are
certain other parameters available as
well we can take a look at that okay
like the ID you know ID is part of the
meta okay
yeah basically what I'm doing is I'm a
meeting one for each because what I'm
doing ultimately as I am doing a count
right so you know essentially count yeah
count really kind of add those up yeah
if I'm doing some you know let's say I'm
doing some batting averages of baseball
players or something like that right
then i might do it a little bit
differently i might omit the batting
average and then do a stats or some or
something and then divide it so that's
gonna be a little different so here's
the interesting part right if i do a
group level is equal to one then it
groups by country if i do group level
two then I do in a country and state you
know group level three then it does
country state and city and so on okay
and we'll see some examples of that as
well so how do i use the query api you
know essentially what i do is i set a
number of properties in the query like
for example i'm saying set reduces false
set include darks is true what what that
means is i can get at the document
itself just by looking at the particular
row set steal steal dat false which
means you know i'm getting the freshest
data all right the view API very simple
it associates the view okay the design
document and the view name okay and then
what I do is once i get the view then I
iterate through each of those rows in
the view and then you know on based on
each each of those different rows I do
whatever it is that I want to do okay
essentially what i'm doing here is i'm
just getting the document and I'm done
okay but I could do anything I want you
know and we'll see in a little bit okay
so here's an example of what I'm doing
I'm getting president by state you know
remember what i did was i imitate the
home state and then i did a count right
so what it's going to do is it's going
to give me the state and how many
presidents hail from that particular
state okay so so when i do a road or get
key it's going to give me the state and
road at get value is going to give me
the count of the residents that hail
from that state that makes sense yeah so
it kind of looks something like this
okay and we will see an example of this
in a little bit so that kind of has 44
presidents I I think okay so let's let's
do the demos I will switch to one all
right that's good so here's a a cluster
you know essentially i have a two node
cluster everybody see that you know
basically it's to know it's running on
ec2 you know we use right scale and go
through that done ec2 and what i can do
is i can drill down and on pretty gory
detail and look at you know what is
happening on that particular node are
kind of look across the cluster ok so
now since i know that you are all
developers and you know you probably
don't care too much about this but but
you know the fact is that it's very
simple and even from a development
perspective you know you get a lot of
information like when I was debugging
you know a tap operation that you know
all that i did was i canna looked at the
step cues and kind of try to figure out
you know what was happening there so you
can you can kind of figure out what's
going on by just looking through this
you know jquery graphs in it it's pretty
and it's kind of neat and it's
definitely geeky ok so what I do more
more to the point is you know here's a
load that's running ok and i will show
how easy it is you know to a day add a
server ok so here's another server ok
i'm in a node 184 169 183 28 whatever
you know let's not worry about that ok
so what i can do is i can I can you know
set it up very very simple you know I
can just send it to let's difference are
you doing trying awesome yeah or i can
do a giant yeah you know I could I could
basically what I could do is I could go
back and join to the original one ok so
which is 50 dot 18 dot 137 that 221 you
don't have to remember you know it could
be well qualified names as well ok and
essentially what I'm doing at this point
is I
joining this node to the cluster okay
and you'll notice when I go back to the
server okay you will see that there is
one node which is spending a rebalance
okay and if you notice here okay your
node should also be oh ok you know it
should still be serving that load okay
and and really what the way I can do it
rebalances just hit the rebalance and
the node is going to be continued to be
a load is going to be continued to be
served while the rebalance is still
happening okay this entire you I was
actually built on that same rest
interface I talked about earlier so so
realistically this UI this index 2.html
is really just an HTML page with a bunch
of divs they can get manipulated by
jquery and it's true across all nodes of
the cluster so from an administrator or
developer perspective it's pretty useful
to know that anything that you can do
there is actually doable from
programmatically as well also made it
easier for us to implement so okay so
you know you don't really have to use
you see to write scale and all that you
know this is running on my laptop
actually and here i have a bunch of data
buckets define okay and this is my
default data bucket you know I can I can
take a look at this as well okay but
what I'm going to do is I'm going to
show you the view that I defined earlier
okay let me see if I can make this look
a little bit better okay so here's my my
map code right can everybody see that
you know basically I have dot type is
president then what I'm doing is I'm
emitting home state and I'm a meeting
the name okay so typically what I do is
I bug my MapReduce code like this ok so
here you can see that the value is 44
because what I did was I really reduced
the result so essentially told me that
there are 44 presidents you no big deal
right so let me let me go back and do
this which is I remove the reduce
function now we can see that you know
Arkansas
as Bill Clinton California as Richard
Nixon and so on and so forth all right
is everybody with me now basically what
I'll do is I'll go back and add the the
reduce function okay and we will see how
we can access this in Java you know
which is really pretty straightforward
okay so here's my you want to make a
comment to matter oh yeah so basically
what i'm doing here is i'm using the g
sound libraries okay let me make this a
little bit bigger okay you can really
use any JSON library that you want you
know the shoot suits your fancy you know
jettison jisan whatever right and all
that i'm doing here is i'm accessing the
view but is it in by state okay and then
I'm saying set reduces true I said stale
falls in a not that it matters much in
this case and I include the darks and
i'm setting the descending to be true so
it's going to start from Wisconsin
whatever right who was the first person
okay and then I do the client query and
then essentially what i do is i iterate
through each of the rows and I display
the value okay pretty pretty pretty
straightforward okay so all that I'm
going to do is I'm going to run that and
so the the thing to sort of focus on is
that if you have that data that goes
into that system you don't have to worry
about the format of the data you can
effectively just do regular programming
around whatever the entities are
whatever the objects are have some
library turn that into JSON for you and
then when you what a query it that's
really when you can start to work out
what what is the information I need to
query on and I build up the the
secondary indexes yeah so so essentially
since I had descending it started with
Virginia and so on okay so you can see
you know Virginia had five presidents in
Texas at four and so on and so forth
okay I can go on with the president
example but you know it's not as
interesting as a beer example okay so
this one is a beer level and basically
what I'm what I'm showing here is access
to another query okay and what i'm doing
here is by location and you know if you
if you guys remember what did what it
would do was
you know sort by country by state and by
city okay and how you do that is just by
setting the level okay i'm setting group
level 23 okay so if I said the group
level 21 then it's going to start by
country if I do group level to that it's
going to do country in state okay if I
do three then I'm doing country stated
city okay so very simple I'm going to
run this and we'll see what happens okay
and you'll see you know argentina
argentine aruba and so on and so forth
I've set the limit 2 30 okay if I take
out the limit then you know you'll see
everything in there so you know being
from India I'm you know curious how many
you know beards are made in India okay
so let me try this so basically what I'm
saying is get me everything in India
okay and let me go up all the way to
Japan all right so so I'm doing this and
let me run this and we'll see what
happens here is basically India you know
in bangalore which is where i come from
nope wrote that at least there's one you
know i'm sure this is not the latest
okay and then you know we have a bunch
of those as well and then of course we
have ireland you know which beat society
you know the country but but in any case
so you get the point about how you can
use you you you cannot really do random
queries okay we have in a project going
on you know where you can do random text
searches but that's not you know part of
the official product yeah it's a
different way to state it is that you
don't do ad-hoc query like you might do
with a traditional relational database
and if anyone is aware of this I'm sure
you've all done this right you do it do
an ad-hoc query on a very large system
used in production and suddenly I yeah
exactly the system gives way lets a
whole questions if we can till the end
just were almost out of time yeah so
there's no ad hoc query capability but
that's also part of how we keep the
system fast all the time so you are
doing some definition of the things that
you're acquiring yeah and and if again
you know if you're you know really
concerned about performance and don't
really care about latest fresh data you
know then you can say its tail too
true okay which case you're okay with
the later you know the old data all
right so hopefully that can I gave you
an idea of how you can persist your idea
or your data in JSON and then kind of
slice and dice it in multiple different
ways with that we have a little bit more
and let me bring Matt back again sorry
so we have about eight minutes remaining
so I'm just want to go out through a
couple situations where people use this
and then do one more demonstration so
one one example here is orbits orbits is
a java deployment and recently very
recently they shifted their hotel
queries so the data behind the hotels is
actually running on a series of
couchbase clusters it's 10 nodes
currently across two different data
centers and they're planning to expand
that a little bit to two other
environments there just to show how
things changed so what they were after
was going from their previous system to
new system they wanted to reduce the
latency the max latency in the average
latency so this is showing average
latency and you can see that it was
deployed on 96 so good good change in
average latency of course the big one is
max latency anyone ever do a search
right and you know that search there's
lots of good statistics about this where
if it goes on for half min of two
seconds or something like that you get
pages abandoned which is pretty bad so
they wanted to be able to change that
and so you can see max leniency came
down from around a second in most cases
but some outliers up there all the way
up to two seconds to what I think
something like 50 milliseconds or
something along those lines I saw your
I'll get two questions in just a moment
so another use case just so I can get to
the demonstration is ad targeting so I'm
going through this fairly quickly but
I'm happy to talk about it later
everyone from ad scale to AOL
advertising to chango the added space is
really a it's a really interesting
market it
there's a dritte are getting and so
forth so it's not just add displays as
my mind sort of understood it there's a
really complicated market with lots of
different players in that market but a
common use case because of that
consistent high throughput low latency
has been deploying catch bass to ad
targeting and that one is kind of
interesting because it also brings that
other no SQL player into the loop the
one I'd mentioned earlier to do so in
both aol's case and others they'll
develop events over the course of the
day and either through flume or through
log imports or other way in aol's case
they actually put the data into
couchbase and then move it over to the
dube later they'll gather events over
the course of the day and what they're
trying to do is build a profile the
little profile about the users so that
they can decide when they need to
display an ad what ad to display so
based on the profile real-time campaign
statistics etc they'll display that just
briefly looking at what that flow looks
like and to show you what I'm going to
demonstrate here in just a second is
that the moving parts are you have all
the users hitting the ad targeting
platform that ad targeting platform is
generating logs as well as directly
accessing the couch based cluster so
they have that little box on the page
and the SLA s4 ad targeting by the way
are very low it's the service level you
have to be in 40 milliseconds and so if
you can get your data in a millisecond
then you can spend a whole thirty nine
milliseconds on your algorithm to
determine what ad to display so that's
that's a big win so they wanted to be
able to get that information as fast as
possible and that happens through the
through the catch bass cluster and I'm
not dissing to do but I'm just kind of
pointing out the the difference anyone
have a guess as to what the latency
would be for getting something at a
Hadoop MapReduce job right it sits in
typically in seconds or minutes so and
that's for small quantities of data so
Hadoop is is designed for heavy lifting
lots of data couchbase is designed for
that interactive set of data but we can
move data back and forth between them so
we actually built a scoop connector we
did that in conjunction with Cloudera we
actually certified that connector
with them and so I want to show that is
a quick demonstration with the minute or
so we have left so what I have here is
yet another cluster this is a cluster of
two nodes I have a two node cluster and
a two node couchbase cluster on a two
node Hadoop cluster so I have a couple
task trackers out there this is the
cloud error manager and then what I'm
going to do is I'm going to kick off I'm
going to kick off the scoop job first I
have to remove my previous data just to
make sure that when I dumped the data
and so now I'm going to run that scoop
job what this is going to do is scoop
dynamically generates the code so you as
a Java developer you can certainly use
your own objects whatever it is you're
storing inside we typically are using
JSON but you can use other you can use
just serialize java objects and then the
scoop connector can actually get
whatever information is appropriate out
of that Java object it the default is
everything goes to a string and it's in
the process of dumping that data from
the couch base cluster to the Hadoop
cluster there's also an option for
backfill and what that does is it does
sampling for a period of time so
sometimes you don't need a lot of data
you just need a little bit of data the
interesting thing about this is you
there's a good presentation from my
colleague dan Templeton over at Cloudera
the way we do this is by generating a
bit of code and shoving it into the
Hadoop cluster and then that Hadoop
cluster attacks the couch base cluster
that's basically what's happening and
says give me all your data and so if you
had a 20 node Hadoop cluster and 20 node
couchbase cluster it's going to
automatically distribute that job
relative to how you might have done that
previously would say etl or something
along those lines so with that I think
are we had time I think that over time
yeah we are out of time we will
certainly be available for additional
questions or we might be able to go a
minute or so over really quickly any
questions out there we have some
t-shirts to to give out so
he's jumping up vs. comparison to
Cassandra yeah so the question is
comparison to other major no SQL players
it depends right so we're
document-oriented we think that's the
right model versus column groups and
super columns for example the other
thing is that we do have as I mentioned
earlier that that second that thing
where we don't have to do metadata
lookups and that gives us a lot of the
speed and performance advantages there
are a number of other ways to put it
together for example you saw how quickly
it is to cluster system it's that we've
put a lot of focus and making sure it's
really easy to set up and manage a
cluster and we we pounded the heck out
of this thing by working with xanga and
others so sorry I don't know where to go
next I'll pop up here yep yeah yeah so
just to repeat the question is couchdb
Apache catchy be in the past and there's
a there's something called ektorp which
is basically an odm object data Monta
you know document mapper people do
actually use act or to some degree with
other components of couchbase we don't
have anything directly for ketchup a
server 20 but it shouldn't be terribly
hard to use the to the view API is
mostly the same there a couple slight
variations but henrik the the the extra
maintainer we have a good relationship
with him mostly on the mobile side which
wasn't the focus of this morning stone
yet another question
is it possible to handle questions as
possible handle query results as a
strange dream yeah and so not exactly we
should the iterator example and really
what's happening under the covers is the
iterator is doing this is streaming the
the query results for you and so if say
you were to have billions of items you
can just use an iterator and iterate
over what comes back and that the
catcher's client will handle all that
for you you could potentially use wrist
right yeah even the REST API itself is
documented so if you did want to go
straight to it and stream the data that
there's no problem I think I'm going to
I know there are a few other questions
by all means please come on up here and
sorry for not being will answer all the
questions hope it was useful and thank
you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>