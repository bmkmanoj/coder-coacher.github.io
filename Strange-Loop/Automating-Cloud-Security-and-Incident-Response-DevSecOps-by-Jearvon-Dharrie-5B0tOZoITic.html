<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>&quot;Automating Cloud Security and Incident Response (DevSecOps)&quot; by Jearvon Dharrie | Coder Coacher - Coaching Coders</title><meta content="&quot;Automating Cloud Security and Incident Response (DevSecOps)&quot; by Jearvon Dharrie - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Strange-Loop/">Strange Loop</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>&quot;Automating Cloud Security and Incident Response (DevSecOps)&quot; by Jearvon Dharrie</b></h2><h5 class="post__date">2017-10-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/5B0tOZoITic" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thanks for coming out to this talk my
name is Jovan we're gonna be talking
about a little bit about security today
so quick survey how many people run
their stuff in a public cloud and how
many people run that in AWS well hey
Davis is making money and how many of
you consider yourselves like security
experts now cool so this talks for you
so I am NOT a security expert I'm just a
developer so I decided to name the stock
responsibilities I think it had some
other name on the schedule
I call it responsibilities because it's
our responsibility to make sure we
deliver a good customer experience to
the customer right deliver a good
product and it's not like Security's job
to do security it's not operations job
to do operations we have to do this
together
so if there's one takeaway to this talk
it's automation is requirement its kind
of feature so let's talk about the
agenda so this talk is basically a story
about my team's journey into the public
cloud and what we're doing to work with
security and make that seamless you
don't have to do the things that I'm
talking about in the talk but it should
inspire you to sort of do similar things
to take control of your infrastructure
the talk is broken up into three parts
the first part is about how to get
consistent and repeatable infrastructure
with security controls built in the
second part is getting insight into your
infrastructure and the third part is
sort of setting up guardrails because
you would inevitably shoot yourself in
the foot one day so just protecting
yourself so as I said before my name is
Joe bond I work at Comcast and I work on
a team called XP oh we do all the back
office stuff for the x1 platform so if
you have Comcast and you're watching TV
on any device your device is probably
talking to our systems so we're a
critical part of the plan
and we need to be secure and up at all
times so traditionally this is where we
run like it's a managed not that
specifically but we run in a managed
data center right so if you want to do
anything it's opening a ticket you want
a new node you want to you have to open
a ticket you need a firewall request you
have to open a JIRA ticket and these
things could take like a day half a day
or many days so we wanted to get rid of
this process and move faster and deliver
features quicker and take more control
over our systems and our infrastructure
so we decided to go to the public cloud
or AWS and this in this case just to
have on-demand resources that we could
spin up and use at any time that we can
do so with a public cloud or any public
space it's easy to create resources
right you can create a 128 node cluster
but you could also create an insecure
128 cluster open to the public Internet
so how do you prevent yourself from
doing that one way would be security
just restricting you from doing anything
in your account or you working together
with them to have you do stuff it's a
little bit of history so earlier this
year we're like yes we're going to AWS
we're super excited we get our account
and we can't do anything in it so we
can't create users or we can't create
security groups or anything we're like
what's up like how come we don't have
the rights to do this and the
conversation went like well we don't
really trust you and we don't think you
know what you're doing so we're gonna
protect you from yourself so we tried
that way even though we knew that that
wasn't the way we wanted to go but it
was still painful so the process was if
you want to create a service in AWS you
would have to think ahead of time of
what ports what I am roles that you need
to open and then go to them open a
ticket and wait a few days and most
likely you'll probably have missed a
port that you need to open and then you
need to redo that whole thing right so
we're like we don't want to do that
let's forget a way that we can work
together
so initially this is what the
organization looked like and this is
what we wanted it to look like it's sort
of there now so the first thing we're
gonna do is do infrastructures code so
what infrastructure as code does is
automatically manage and provision
resources through code so if you want an
ec2 instance or an RDS instance you're
not going through and clicking in the UI
you're basically writing some code to do
that and basically running that and
you're gonna have have your resources so
the tool that we chose for that is
terraform how many people are familiar
with terraform cool I'll get them out of
the room so we'll have to explain it so
the beauty of terraform and why we chose
it over something like cloud formation
is it interacts with more things than
just AWS so anything that has an HTTP
API you could write at our phone
provider for and interact with it so the
first thing that we get when we do
infrastructures code is visibility so
before when we were doing stuff with
when we were separate we would have to
go ask like who's in this group or what
ports are open for this firewall or you
know just like what is the IP range for
this service or this zone but now you
can just go to github and you could view
that stuff right you don't have to
fiddle around in the AWS console or just
speak console to figure out where this
stuff might live you go to github
there's a well named file and you can
see who's in the strange loop users
group right now there's Alex and there's
yovan and I know what they do
another thing is accountability so with
application code we hold each other
accountable doing code reviews and stuff
like that so why not do that with
infrastructure of code yesterday in the
sentinel talk Arman talked about
remediation before or guardrails before
you get to production and this is where
that comes in so basically ahead of time
you could catch insecurities before they
go to production so one way to do this
is code reviews so here there's a
picture of someone adding a role to one
of the code bases
and he clearly writes out like what's he
doing and why this is why this is useful
and why we need this so someone will
then come in and either plus 1 or minus
it minus one it and then I'll get
applied merged terraform will run it and
we would have this role so you can
envision doing some automatic checking
against this also like writing a pull
request bot to +1 based on certain
security group rules that you might want
to enforce or certain roles that you
want to enforce so it won't get merged
and you don't need a human to say it
over and over again so the other thing
that you get this is an audit trail so
we all use git and for our application
code so your infrastructure code should
also go and some type of version control
and for any compliance reason if you
need to know that you know who executed
this change or who did this change you
have that automatically and get so here
you can see like the git log and you can
see that someone added four subnets to
the east prod V PC or they renamed an
instance profile and then you can dig
into that change and see exactly what it
does
so the another interesting thing with an
audit trail is let's say someone
accidentally rolls out something that
exposes s3 bucket the change to revert
that would just be reverting the commit
and going back in time and just terrify
them applying that again so it's easy to
make changes or just roll back your
you're insecure it is another thing you
get is reusability so before we were
doing stuff in terraform security was
doing things by hand there creates each
PPC by hand and each user by hand and
you're like well this thing doesn't have
that or that thing doesn't have this so
now they can create a module or
basically you think of it as like a Java
class or really class like you can just
reuse over and over and share posted on
github import it and everyone has the
same the same code that they can run off
in this example we're using a terraform
remote state so let's say security has
some valid security groups that they
want you to use you can reference those
without that being a New Yorker
please you're basically stored in a
remote place and terraform could look at
it and read read in that and you don't
have to do it yourself so consistency is
another thing that you get so here I'm
creating another V PC and what I did is
I extracted all the rules that I think
that an x vo V PC should look like so it
should have cloud trail logs it should
have V PC logs you should have certain
users and basically when I want to
create a new V PC I just referenced this
module which again it's just like a Java
class and I get all those things for
free if a change happens upstream that
we want all V pcs to inherit from we
will change it in the module bump the
version and have each V PC run that
again
so basically consistency across the
board so now when you want to create a
new VP Caesar new accounts it's not days
long processes it's just a day maths or
a few few hours so now that we have
infrastructures code we can do some
automation right so one of the first
things I mentioned earlier was you know
you can't have I am access because we
want to impose these rules on you so
what's a clever way to get around that
we have some code we have some API so
exposed to us so we're gonna so this is
a policy that AWS publishes it's a force
MFA on users and there's some tricky
stuff here it just says deny everyone
that this is not true for and the magic
of IIM is if there's a deny anywhere in
the chain will just deny you
so we're denying any API access to
anyone that doesn't have him if they
turned on which was something they were
worried about so when a user wants to
get added to the account let's say we
hire Alex Miller tomorrow and he joins a
team we want to add him to the account
Alex opens a pull request on the tariff
um code that gets code review to make
sure that he's getting added to the
right group so I'm not and then someone
tariffs on plans it terraform applies it
maybe it's just CI automatically doing
that and then we have this nice little
shell script that basically sends Alex
his password and we don't have to have
any interactions basically so all that's
automatic it's no longer a ticket when
Alex logs in he doesn't have access
the console unless he turns on his MFA
so another thing is tests so we have
this infrastructure code we can start
testing it's similar to how we have we
test our application code right so some
of the benefits of this is just ensuring
that the assertions you're making are
correct so we use AWS spec for this and
if you look through the terraform module
codes you'll see examples of how people
are using it and it's basically just a
ruby gem that you're including your
project you can see here I'm just
verifying that the group strange loop
group has an MFA policy and if it
doesn't it will fail and tell me I could
constantly run that in my CI environment
whenever it changes happening so I'm not
totally sold on doing a lot of tests for
your infrastructure yet most of the
testing I'm doing is just an exploratory
so like I'm working on something I'm
gonna write a test to verify that it's
being done the way I want it to be
instead of just going to the console or
checking manually that that's being done
so that's a link for aw aspect you can
go there later so now that we have a
repeatable consistent infrastructure
we're gonna ship that to production
right and then we're going to say okay
let's spin up some VMs let's make some
accounts let's make some rules or
whatnot we probably want to see what
those things are doing so it'd be nice
to get inside into the system getting
some logs getting some metrics and some
dashboards so first up is logs so for
the WPC and for AWS we store cloud trail
logs and PPC network bugs or VPC flow
logs sometimes SSH logs and Bastion host
logs so anyone that's SS aging through
the bastion host we log that and we can
do some auditing on that so you got
another level of audit trails here you
can see who did what what events happen
what they're doing when they're doing
let's say a an instance gets terminated
by someone by mistake we can go out at
that and say okay who did this and are
there privileges
do they have too much power here can
days can we scale them back so this is
what an elastic so we pipe all the lots
the elastic search and we use Cabana
because that's the easiest option you
can use Splunk or any other logging tool
that would accept logging in JSON format
so this is just a classic search query
and then that's gonna print on our table
and say so let's say I terminate an
instance someone can go in and say hey
who terminated this instance what time
and the identity of that person another
cool thing that was pretty helpful and
this is actually a positive case is we
used so we're running in a hybrid
Network right now so we have our
traditional data centers and our public
cloud so traditional data center wants
to connect to the public cloud and
sometimes you might not know ahead of
time who to open up to so AWS has this
thing called PPC flow logs which just
monitors all the network traffic coming
into the V PC so we set up some logs and
we could say who's getting rejected
what's your source address what's the
destination they're trying to get to and
the port they're trying to get you so
then we can go evaluate that event and
whether it's some malicious or a
friendly request we can open up to them
or keep denying them or investigate it
some more
so we have all these logs we could
probably start collecting metrics on
them similar to how we collect rejects
earlier we can start graphing
all the rejects and API calls are
happening so this is a Cabana dashboard
that we have set up so in the green
we're graphing all the active API calls
that are happening in the BBC at any
time
by user or by role and in the purple
we're showing rejects by network ID so
if you do this in the in the ADF console
console it's super confusing you have to
click a bunch of things and then you
have to find the right network ID that
you're using and jump through a bunch of
Hoops both with Cubana you basically
could glue the data together very
seamlessly and then in the
here we just have a table of recent
events that are happening so you could
monitor by sort of happening if anything
is looking funny like if no Terminator
instances should be popping up an event
name you could you know alert someone
and then you see the username and the
principal see it's easily identifiable
another dashboard that we have is using
AWS config which is basically a rules
engine for AWS so this is a dashboard
that we have set up for s3 buckets and
s3 but it shows there's three buckets
that are not compliant with our rules so
for this rule is just an on whether the
bucket is public or not and this likely
happened to us so we people accidentally
opened up a few buckets and no one had
any idea until someone thought it was a
good idea to check so we set up an
automatic check that will be evaluated
every time the config on a bucket
changes so the way config works is you
set up a rule and the rule checks
certain resource and the rule could
either be something pre-baked by AWS or
a lambda function that you can set up
and every time the configuration changes
in our resource they will run and check
its compliance and then send your
notification or take some type of
remediation step so again I mentioned we
use terraform so we're not doing this
stuff by hand this is how you would set
up a config rule with terraform it's
basically super simple this is straight
from the docs
so we're saying hey the identifiers yes
three bucket and the resource type is
just the s3 bucket again so you can
imagine like if this is something you
want to run across all your accounts you
would stick that in your terraform like
base account module or base VPC module
and for every new thing that you bake or
print out you get this for free and no
one has to worry about hey is this thing
did we turn this on or something like
that so we have rules we have logs we
have metrics we could probably do some
alerting so with AWS you can use cloud
wash alert
and set up some rules and what to Alert
on if there's a bunch of unauthorized
API requests coming in you could send
that to like Prometheus or cloud watch
and alert someone on your team that's
that this is happening so so far we have
alerting I mean sorry so far we have
insight into our system and we have
infrastructure as code which gets us
repeatable and consistent infrastructure
so now we're gonna use that data that we
get from the insight to sort of set up
some guardrails for ourselves so we're
gonna talk about remediation so what
this means is basically if something
happens in your account and you get an
alert for it maybe you could
automatically fix it or automatically
change it back to the state it's in or
if there's some type of drift happening
you could fix that drift so first
example we're gonna look at cloud trail
logs because that's super important for
your account if this is turned off you
can't get insight into what's happening
into your system so if someone wants to
be malicious they could get access to
your account
turn off cloud trail logs for like a
minute do whatever they need to do turn
it back on and you never know that that
happened right so let's look at this so
we're gonna use terraforming again we're
gonna set up an event rule and this is
just cloud event rule and we're gonna
send it to a target and the target here
is a custom lambda function and this is
what the lambda function looks like it's
written so you could write lambda
function so lambda is an AWS service
allows you to write server less code and
you can use closure which is a
programming language that runs in JVM to
write your lambda code and this is what
a basic lambda handle looks like so when
you want to do remediation you probably
have to do through things or you
probably will do these three things
first you'll fix it you'll fix your
problem then you log it for later for
looking at forensics or whatever you
want to do with that data later and then
you're gonna alert someone and the
closure code is super readable right so
it's like if you're not logging if
logging is not turn
do these things so the way this works is
you set up a cloud watch rule based on
that event pattern and say you want to
monitor this resource and then when
there's a change on that resource
it sends basically a JSON payload to
your lambda which is an event and in
that event there is a is logging boolean
field and that's what we're looking at
if it's not turned on it'll be false it
was turned on it'll be true so this
stuff is basic programming right we do
this every day so we could basically do
this for our security stuff also let's
dig into the code a little bit
so this is our remediate function we're
basically just calling out to the AWS
Java SDK and calling the method start
logging if we see that logging needs to
be turned on we're gonna give it the
cloud trail erm and our logging function
for forensics is just saving stuff to
DynamoDB so way to say hey dynamo here's
this cloud trail table this is the user
that did it this is the time they did it
if we see that they were doing it more
than one time so keep trying it again we
could lock them out and disable their
account or whatever steps we want to
take for that right so this is an
example of what's happening so you can
see I have a shell script that basically
checks the status of Cloud trail and all
it does is say hey it's just true or not
so you can see at 553 and 16 seconds
it's true cloud roll has turned on in
the background I call the command to
stop cloud trail and you can see at 1753
20 it's false and then at 53 23 its true
again so basically it turns on within a
few seconds you're gonna lose some data
but it's going to be super fast to be
turned on again so you're gonna
constantly get data and this is the
notification we go we just use SNS to
send a notification saying hey someone
is tampering with this you should look
at it the next example is let's say you
have a tainted ec2 instance and tainted
it could be relative to whatever you
want it to be and the example I'm using
if the ec2 instance gets
Tainted tag so again you're going to do
three basic things you're gonna fix the
problem you're going to log it and send
it alert to someone so for this example
all we're gonna do for for fixing this
so these rules are custom to your
business logic right there relative to
however you want to handle these
security vulnerabilities so for this
case we're just gonna set a security
group that has no ingress or you guessed
rules so no one could ssh to it further
out you could also set like a
non-modifiable policy so no one can mess
with the tags or no one can delete it or
terminate it so let's say someone
changes the tag to tainted that censored
event to us we get it we've assigned a
security group and we basically
quarantined the instance and no one can
get to it we can go to it later and see
what's up and look at it another tool
we've been using is cloud custodian
which is a Capital One open-source tool
written in Python and it's similar to a
config but it has a lot more
capabilities and it's free so you
basically write these policies in llamÃ³
format and it could run in a lambda or
you can run it every so often and get
notifications or has different things
that you can do like turn off instances
or shut them down within four days or
something so this one is just a policy
that says hey we require these ec2 tags
and if they're absent and the state is
running notify someone about it so
someone on this team will get an email
and we'll go remediate that and fix it
you can also automate that and shut the
instance off stuff like that
so was this worth it I think it was even
though it was super hard so some of the
things that we can do now so we have
full control over our accounts on our V
pcs now right so we could use AWS in the
way that it was intended
- so by taking advantage of security
groups and I am policies and being able
to be super flexible and segmenting
stuff out we have a better relationship
with the security team like they can
reuse some of the tools that we're
writing or if they need something we can
build it up for them so what's next
there are some things that so this is a
work in progress this migration will
take maybe more than a year we currently
have some services in there so AWS has a
security benchmark white paper that they
publish based on what they have seen and
customers accounts and they wrote this
lambda that you could run against your
account and basically see if your
account is in compliance with like basic
security things so taking a look at that
and having some way to run that maybe
nightly or like once a week to see if
our accounts are in compliance explore
more of cloud custodians the cloud to
study and can do more than just tags or
notifying you can write some custom
rules to do some cool stuff taking a
look at security monkey aardvark and
repo kid so there are three Netflix
security tools Netflix takes this stuff
seriously and they're sort of they take
different angles on on the security game
taking a look at Sentinel so there was a
strange group talk on Sentinel yesterday
from hairy Corp and that's a policy
language a compliance policy language so
you can set up rules on on your your
infrastructure and things won't get
deployed if it fails the policy language
then do some chaos on on our
infrastructure and what this just means
is like part of dev sack ops is like
having the Red Team and stuff come in
and break your stuff and try to break in
so maybe just automating some of that so
like a script that opens up an s3 bucket
or opens up network traffic to unknown
resource and see how fast that kid get
remediated and if we suffer any
consequences from that
to some takeaways automation is the
requirement not a feature as I said
before we're all responsible for this
stuff and we should not draw lines
between our teams we should work
together how this stuff is super easy if
there's an API to something you could
probably automate it right so for
anything that has an API you can write a
terraform provider and have that stuff
in github instead of somebody manually
doing that and just things running amok
you don't need to be an AWS to do stuff
like this you can do stuff like this in
OpenStack or GCP you just have to think
about our a different way like so if
using lambdas you could probably use
whatever GCPs serverless is and whatever
cloud you're in probably has an API that
you can use and scrape logs from so all
this work to not create your tickets so
yeah it was a long few months that's
pretty much the end of the talk
say hi I'm drew on Twitter that's my
email if you want to email me about any
of this stuff we are hiring if you want
to help me stop making JIRA tickets and
get rid of to your Comcast and I'm
helping organize a conference on behalf
of the Comcast's that I could tweet the
links to later it's a free one-day
conference in Philadelphia at the Barnes
Foundation which is an art museum so if
you want some tickets let me know and I
can open up for questions now
any questions
for me it's more just verification that
it's being done so like did I attach
this correctly if I didn't do that I
would have to go and and run the CLI to
like simulate a policy or simulate
something to do it so it's just like a
verification ahead of time some things
I've thought about is like maybe trying
to create users in the test attached a
group to them and have that be like a
nightly test that gets run or something
like that oh no so the the Lamanite
stuff is just developers it's like we
were just like we will talk to them and
say hey this is something cool we're
gonna do and like they don't have to
know the implementation of it they just
know that it's being done we would just
have conversations and this is say like
this is so like one of the things we did
it's like all right here's the IT
compliance book for Comcast I read like
many pages of it and just wrote those
down in terraform so like password
policies and who gets a lot access and
stuff like that
so I'll have a good answer to that yet I
think you could think of AWS spec as
ahead of time like when you're writing
the code and then Kyle watches for when
you're running the code but either said
I'm not making a lot of use of AWS spec
it's just like yeah just like driving
the implementation and then when you go
on when you ship the terraform code you
basically get alert right away so that
could get a little painful but terraform
is very freeform and you're allowed to
layer your infrastructure however you
want to basically so we've layered like
account level stuff EP sea level stuff
and all that's stored in s3 and
basically you just set up a remote state
when you want to count level stuff and
you say hey this is where count stuff
lives this is a VP see I want to
interact with so we don't have
everything in one global State people
might say that's bad or that's good but
it really depends on how what feels good
to you at the point in time any other
questions you could also use terraform
to deploy your lambdas terror from all
the way down
all right if that's not if that's it
you find me around keep us asking
questions</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>