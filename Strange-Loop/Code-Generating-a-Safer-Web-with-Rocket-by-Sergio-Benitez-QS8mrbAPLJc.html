<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>&quot;Code Generating a Safer Web with Rocket&quot; by Sergio Benitez | Coder Coacher - Coaching Coders</title><meta content="&quot;Code Generating a Safer Web with Rocket&quot; by Sergio Benitez - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Strange-Loop/">Strange Loop</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>&quot;Code Generating a Safer Web with Rocket&quot; by Sergio Benitez</b></h2><h5 class="post__date">2017-09-30</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/QS8mrbAPLJc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">awesome it's really great to see a lot
of people here really excited so today
we're talking well I'm talking you guys
listening I suppose today I'm talking
about rocket I'll tell you all about it
in a second this is me my name is Sergio
that's my email address you'll see at
the end of the talk again so feel free
to send me an email for whatever you
whatever you'd like any question about
the talker anything really and this is
rocket again so what is rocket so rocket
is a web framework for rust that ideally
supposed to make it simple to write
quick multiplications that are fast
performant without sacrificing
flexibility while having lots and lots
of type safety and when I say type safe
they think of the kind that hassle gives
you not of the kind that you know si
gives you so real type safety and what I
mean my web framework is your Django's
your flasks your rails think that kind
of thing it's not like any of them
really it looks a lot like flask but
it's not like flask but it's you know
it's that class of libraries and it is
written in rust so I just like to get a
show of hands please raise your hand if
you know about rust of course of course
it's a strange loop I wouldn't expect
anything else but here's the trickier
question raise your hand if you've
written rust ah wow that's pretty good
excellent awesome thanks all right well
for those of you haven't written rust or
you know for the very small minority of
you who don't know about rust it's a
programming language that is memory safe
without a garbage collector
so no dangling pointers no double fries
nothing like that it's even more memory
well you see the semantics of memory
safety and rust or even stricter than
something you'd see in Java for instance
there are no null pointer exceptions in
rust the type system guarantees that
there are no data races so if you're
thinking Errol data races the runtime is
very very small even smaller than
something like C++ and it has very very
powerful macro systems and I say systems
as opposed to system because it has to
and
is sort of Macker by example or think of
C macros but you know done better and
the other one the other one is like Lisp
reader macros or procedural macros you
get a nice T it calls your function with
an AST UUM in another AST and you're
done and this last point I want to
emphasize because Rocket makes abundant
use of the procedural macro system
without Rus procedural macro system
rocket would not exist
so rocket is web framework for Rus that
makes it simple to write fast web
applications without sacrificing
flexibility or type safety and the last
thing one emphasized here is simple
there are web frameworks in type safe
languages in very type safe languages
like Haskell but they're not
particularly simple when I say simple I
mean like flask simple or like something
you'd write a Python or Ruby just it
looks kind of like what you read in a
dynamic language but it's entirely
strict in and safe and you know does
what you wanted to do not what you know
the monkey patching or mixin to do so a
bit of history about rocket so it's
rather new unlike struts which has been
around for a very long time
rocket is much newer so it's less than a
year old it's released December 23rd
last year so about 10 months coming up
on the year virgin 0.2 is released a
couple months after that and then 0.3
several months after that just a couple
months back and it seemed you know a lot
of a lot of progress it's also seeing
plenty of adoption people on github
really really liked it and one thing
that is not on this timeline yet is how
quickly someone told me that they were
using rocket in production and if you
had to guess to yourselves where would
you put a little line there I mean I was
very surprised the line goes right there
which is like a week after a rocket
launched and I got a message on IRC
saying hey thanks so much for rocket I
switched my nut application at work to
rocket and my boss loves it it's way
faster thanks so much Sergio I was like
no thank you for trying virgin 0.1 I
appreciate that so so that was fun you
know nowadays it's it's it's a much
there's a much more calm sensation that
I get when someone says they're using
rocket in production not so at 0.1 so
when rocket launched it it was at the
top of hacking you used in the top of
any programming thing and people you
know seemed to like quite a bit in fact
it was at the top of github x' rankings
that day which was which was awesome I
mean that was that was really great so
you know short short lifespan but lots
of adoption there are thousands of users
using rocket which is you know not tens
of thousands but thousands there are
dozens of companies at least a couple
dozen it's really hard to count but at
least a couple dozen companies using a
production mostly internal stuff but a
few public facing things so that's the
very short short short just about rocket
web framework for rust that idea makes
it simple to write fast mode
applications without sacrificing
flexibility should be able to do what
you want not what the web firm wants you
to do or type safety so I think the
question on everyone's mind at least on
my mind when I started thinking about
rocket was yeah exactly huh yeah I made
this stuff so you probably don't know
what it is but yah fizz yet another web
site work do we really need another web
framework probably not but maybe maybe
and so I like to put rocket into maybe
hopefully category and the reason for
yothe is is this bad stuff here there
are the web is like this really scary
thing that came about you know someone
just wrote it one day just like here's
the web and then it's just been evolving
organically ever since because we need
this we need that we need this
and it's you know just just laden with
the myriad of issues and these are some
of those that sort of impact server-side
ramifications which is what you write
with rocket and some of these are sort
of solved we have very good solution to
some of these problems so these guys in
green I'm gonna say that we have really
good solutions to these problems and if
you use your you know rails or Django or
whatever it'll take care of these for
you these aren't really problems anymore
as long as you use a library that solves
them for you and the solutions are
pretty good
however these guys over here have not as
good solutions there are solutions like
don't execute code that the user gives
you that's a really good solution but it
turns out to not be a thing that you
know frameworks do for reasons input
validation is something that no one
really tackles you just kind of do if
statements and you maybe you put them in
a function or something and that's how
you do a evaluation but it what really
tackles input validation with
application authorization bunch of
different solutions no one has really
like a nice way to do it and you can
argue about what nice is and miss
configuration if you try to configure a
rails application it is like non-trivial
and if you do something wrong maybe
you'll get a little like debug output on
your on your logs saying hey the secret
key is like not secret please fix it but
you know it'll just continue going and
leak are your secrets so rocket really
tries to tackle well not only the things
that we have solutions for because if we
have solutions then let's just use them
but also the things we don't have
solutions for which is all these things
in yellow and sort of the way to go
about this so the way rocky goes about
this is through three different sort of
philosophies three different ideas and
those are these guys here so the first
sort of core idea in rocket is that a
handler the thing actually handing
handling a web request its declaration
and the parameter types ie the input
that we're gonna get from the user they
should contain all of the information
necessary to validate and process that
request so this is this is rust this is
flight this is type two everything has a
type and the idea here is that the type
should tell you everything you need to
know to process a request including
validation including everything
to be true about the world about the
requests about the world that request
gives you for that request to be
processed and so this immediately
prohibits api's of the sort that you can
just you know take your request object
and inspect headers or you know inspect
the data or something like that you
can't do that in rocket which sounds
limiting but we'll see that hopefully
it's not the second point is that as I
said all requests hand in handling
information should be tight the web is
this string right HTTP is a text-based
protocol you just get a string from the
user and we have to convert that string
into native types in our language if
we're in Ruby there maybe we can just do
that dynamically if we're in rust or a
Haskell or any sort of more strongly
typed language then we have to convert
that string into some native type in our
language and rockets philosophy is that
everything should be tight you should
never handle strings everything should
be typed and finally and you know this
is you can sort of argue about this
Third Point but I feel that that
decision shouldn't be forced on you I
you shouldn't have to use this template
engine or that templating engine or this
way to do sessions or that way to do
sessions
none of those decisions should be forced
on you rocket can provide you know a hey
you why don't you use this but
everything should be implementable by
the user whatever rocket provides you
should be able to write yourself and it
should be just as nice as if rocket
provided for you
so these are rockets sort of core
philosophies now I'm gonna give you a
very quick overview of what a you know a
snippet of a rocket application looks
like but later on the talk we'll do that
in detail so here's a very very quick
overview so this is what a handler in
rocket looks like and your rocket
applications will be composed of
handlers of this nature and the things
to sort of look at here are this thing
at the top here this is an attribute
think of attributes in Python or sort of
like attributes in Java but it's all at
compile time this is not there's nothing
happening at runtime here and these
those attributes are used to declare the
things that your handle is going to
match against so here it's matching
against HTTP GET request to the dynamic
path
with the dynamic parameter ID and like I
said we'll talk much more about exactly
what's happening here in a second now
the second part here is much more
interesting so this function takes in
two arguments and you'll see that
handlers in rocket can actually take in
an arbitrary number of arguments and so
one of them is this ID parameter and
that's the parameter we saw in the URL
and so this ID parameter has type paste
ID which is you know it's an ID of some
you know thing that you're pasting or
something and it has some it has some
user and that's going to be a
requirement that the request must
satisfy the request must identify a
valid user for this type to exist and as
a result this handler can only be called
if the request that it defies a valid
user and like I said we'll see much much
more about this in a second and finally
the last thing I want to note here is
that the types directly describe the
functionality of this handler you can
read off the tie signature and know
immediately all the things that must be
true about the world there must be a
logged in user and the ID parameter must
validate as a paste ID and it's gonna
return maybe a file so option is like
maybe and Haskell if you're familiar
it's a thing that may or may not be
there it's gonna return maybe a file so
just by reading the Tison mature you can
see okay oh we're probably gonna you
know fetch a paste and if the paste
exists then we're gonna return the file
and we're gonna return that to the user
and oh by the way there has to be a user
logged in for this thing to run so this
is what everything in rocket looks like
a set of matching conditions declared at
the top of the file a set of types that
declare what things must be true about
the request and then some type some some
value that you return of some type that
is then sent out to the user okay so we
have all of these problems you might say
well all these things are these things
really a concern like okay if let's
assume for a second that rocket solves
these problems or it gives me a tools to
solve these problems well do I even need
those tools
well obviously and here's three reasons
why you need those tools so WordPress CV
2009
impact level 10 impact 10 is as high as
you can get it means you can do whatever
you want with the application there's a
vulnerability send it is a very very
easy to exploit vulnerability you can do
whatever you want so in 2009 WordPress
first any version before two point eight
point three allowed a remote attacker to
gain privileges via a direct request to
eight different end points and so what
this was was basically a bunch of PHP
files weren't presses in PHP so you
could just make a request to put some
data in there and then you would be an
administrator literally I mean it you
don't need a PhD in security to be able
to do this you just send a web request
and then you're an administrator it's
very very easy and so what was the fix
well here's take one of the fix there
were four patch sets by the way to fix
this problem I'm gonna show you two of
them so here's take one of the fix and
as you might imagine it's checking like
oh hey can the user actually do what
it's trying to do you know so so here
it's you know maybe it's a little small
to see maybe not here's just checking
hey can the current user have the
permissions that this file requires and
so you sprinkle a bunch of if statements
and all you know in this case they were
like thirteen different files because
there was an unrelated vulnerability but
you sprinkle these if statements on the
eight different files and then you kind
of fix it it turns out that wasn't the
full fix because these files were like
meant to be included in a bigger file in
PHP you can include files and so these
were meant to be included in your bigger
file and the fact that they weren't only
included they could be directly called
was itself a vulnerability set to go
ahead and add another sprinkle of if
statements that checked oh hey am I
being included if not just you know and
the request this thing is only meant to
be included and hopefully this fix the
issue
okay but what I want you to notice is
that we have to sprinkle all of these if
statements around if you want to
actually check anything why don't we
just declare like oh hey we need an
administrator at this point and what's
more why don't we have the type system
ensure that we can only access data if
there is in fact an administrator will
see that rocket in fact does exactly
that
so that's WordPress now Spri commerce is
an application written in rails it's a
like a shopping cart app I think the
biggest user of spree Commerce's
Chipotle so if you've I don't know what
they sell on their online store but if
you've purchased the burrito on their
online store or whatever it was using
spree commerce and there was no CV for
this not that I saw
but basically the again this is very
very simple stuff this is like a
level-10 thing again you can make
yourself an administrator bypassing the
right parameters while updating a user
that user is able to assign any existing
role role to themselves and the way you
attack this is by again just sending a
web request with a particular field in a
form and the interesting thing about
this vulnerability is that it wasn't
just free Commerce it was every single
but not every single but almost every
single rails application was vulnerable
to the exact same thing and it's called
a mass assignment vulnerability and this
was like a pandemic you know an epidemic
just people are like oh my god this is
why are we supposed to do this rails and
rails was like yeah Ruby's nice but also
stop doing what's nice please sprinkle a
bunch of checks everywhere so now if you
read the section in the rails guide it's
like hey by the way the thing we just
told you it's totally vulnerable please
don't do it like fix it you know this
was a big problem we're gonna tell you
to do it because it's really easy but
also don't do it so it's called a
massive time and vulnerability and it's
it's pretty straightforward so here
you're getting some parameters from the
work from the request as a form and and
Ruby or rails rather well to serialize
that into a hash map and so say you're
getting in this user parameter and then
what you do is you create a user let's
at user thing you create a user from the
parameters passed in from the web
request right so now your user you know
in rails your your objects are tied
directly to the database so if in your
database you have a role parameter that
identifies whether this user is an
administrator or you know a regular user
then if you create an object with that
field and then you save it that field
gets saved to the database and so what
happens is someone passes in in the form
a role parameter you don't check that
the role parameter
you just assign everything in that is a
mass assignment in that hash map to the
user and you create a user this is all
dynamic see this is this is sort of a
dynamism get to you you'll sign
everything to this user and then later
on you save it well if the user passed
in a role you've also saved that role so
the user passed in an administrative
role then you've just made that user in
administrator so what's the fix well the
the real fix is more complicated you
have to annotate your thing by saying oh
don't save these things so the user
passes these things in don't save them
and by the way those are dynamic as well
so if you happen to change the name of
role to user role later on everything
breaks but the fix thats free commerce
took was to you know add one line here
and to just delete role very effective
fix it works and it's one line so you
know you met the quota there so this is
the fix but this was a very very very
serious problem because this is the way
you do things in rails this is not like
oh let me take a shortcut this is the
way you do things in rails and first for
a framework to advocate this way and
then have it be vulnerable to very
serious attacks is a problem and this
this just isn't possible with rocket or
rust like there's no kind of dynamism
like this and rust rocket even goes
further and is very very very very
strict about what it accepts from users
obviously we're trying to solve Impa
validation so it's very strict about
that we'll see more about that in a
second and finally I wanna talk about
get lab and this one was kind of fun to
figure out what went on so this was an
impact 8.8 he said the impact 10 and
then something changed now it's a point
eight but very very serious again it
allows anyone to be an admin so they
said in their blog we discovered a
critical security flaw the impersonate
feature was not properly secured it was
possible for any authenticated user
administrator or not to login as any
other user including administrators so I
could just be you and that would be easy
and in fact here's how you here's the
entire attack here's the proof of
concept you log in as a regular user you
check your cookie
for this thing called a authenticity
token an authenticity token and then you
create a request that looks exactly like
this you send a post request to slash
admin slash user slash stop
impersonation an ID equals the person
that you want to impersonate the
username of anyone you want impersonate
and then as the data you pass in method
delete and the authenticity token is
your authenticity token because it will
check that you are logged in and that's
it then you're logged in as the user
that's literally the entire tak I mean
sometimes these attacks are like really
clever you have to go to like very
crafty things but this one this one is
not that this one is very simple so
here's the code that led to that attack
and I'm not going to make you read this
but I do want you to see sort of all the
stuff that you have to write first of
all this like skip before before action
and there's other stuff that I've
deleted but this is the way that you do
this authentication stuff in rails and
the problem in this code is sort of
these lines here so for some reason they
said don't authenticate the admin for
the destroy method it's right that's the
thing that we were attacking not totally
sure why but do authenticate the
impersonator so I guess that makes sense
like it doesn't have to be an admin but
maybe an impersonator is like a
different role so do authenticate the
impersonator okay great so what does it
mean to authenticate an impersonator
well if we look at the method there well
it's an if condition again always if
conditions it's in this condition well
you check that the session contains this
impersonator ID thing and if it does
then you check with their an admin well
what's the bug if there is no
impersonator ID in the session the check
doesn't go doesn't happen and that just
and because this is Ruby there's no type
information that just you know for some
reason becomes true and the whole thing
passes or it becomes nil I guess and
then rails would just toss it away and
say okay yeah that makes sense that
that's an authentication sure and so
what happens is that all you have to do
is be logged in to buddy calls destroy
and what is destroyed you well destroyed
just changes your user to the user that
was passed in and then it redirects you
to the root so very very very some
bull cool that's get lab all right so
these are three serious serious problems
but too much mayhem and despair and also
fanfare there is one more thing I want
to tell you about that rocket would
prevent and that's these guys here
it's a good old Equifax and all their
social security numbers so Equifax is
written in struts which is a web
framework for Java and back in March
they had this CDE which was impact 10
and the problem goes like this they have
a parser for multi-part forms and this
is very weird but basically what
happened is it had incorrect exception
handling so something went wrong and
then it would handle the exception and
then it would execute code basically and
all you had to do was send in a properly
crafted Content ID content as position
or content length header and then struts
would execute code in that header and
this is what that looks like
- that properly crafted message
obviously this is long but you just
write a script and then you can inject a
command right there and you send it off
to the server as the content type header
and it will just execute it so what do
you put in that command well one thing
you can put is hey just give me the
password file and you know I'll try to
run some attacks against it but if
you're Equifax you just keep around some
secured numbers in tap Zurich tap
separated files and then you can just
cat the tab separated file and get the
Social Security numbers for all
Americans this sounds ridiculous like
now come on Syria they did not do that
turns out they did do that and the
question that becomes ok how do you how
do you get great surgery but how do you
get this path well they have a dashboard
where the password is admin and the
username is admin and the dashboard
tells you the paths of all sensitive
files so you combine you know insecure
dashboards with this struts
vulnerability and then you can just
catch those cubed numbers great so well
not correct obviously but great great
for me I guess great for this talk now
so struts and equifax not great but okay
so this is not possible in rust or
rocket there's no dynamic code execution
there's no VM there's no interpreter so
this is just like would be totally weird
to ever mean you can write an
interpreter and rust and execute code if
you want to but why would you and rocket
doesn't let you do that that's weird
so those are some serious serious
problems and those are problems that
rocket is trying to solve and I think I
think has a good solution or at least a
good good toolset to solve these
problems all right so let's talk about
rocket let me show you the hello world
of rocket so here's rockets hello world
and this is very similar to what you saw
just second ago and there are two things
here again there's this route attribute
which again is a description of matching
conditions so this is a get path is a
this matches against HTTP get request to
the route path and this is the route
attribute and the second part is the
route handler this is a thing that
actually gets called when a request
matches the set of conditions so when a
request comes in for the route path I
get request comes in to the route path
this hello function will get called and
this will just produce a response now if
you've never written Russ or you're not
very familiar with rust there's an
ampersand tick static thing will be like
that's okay it is like what it's fine
you just it's a static string don't
worry about it
rust syntax is okay but sometimes it's
the Terek there's no return you can just
you know it's an expression the block
expression is an expression so you just
return the string so this returns a
string that's really it's as we saw
before you have this matching additions
and then you have a handle that gets
collared with this conditions match and
your thing executes and if you refer to
run this server while you would see
hello world so you go to local loco your
localhost 8080 the main function as with
any language most languages your main
function so here's your main function
here's what it looks like what you have
to do is tell rocket about the routes
that you've declared and then you have
to launch the application so so mounting
is like namespacing routes it's it's
taking a route and then prefacing it
with a path that you
namespace all of those routes behind so
here we're just name spacing it behind
the root path which means no namespace
but we can also change this for instance
to slash hello and then every route
inside of that sort of routes list that
you see down there this wraps bang thing
would have to be prefixed with slash
hello in order to be called by rocket
and finally so the first part is that
rocket ignite that creates a rocket
structure second part is that mount that
makes routes available to rocket to
handle and finally you call lunch
because Rockets needs to go rockets need
to go in the air of course and if
everything goes well rocket will print
emojis yeh that's how you know things go
well when your application prints emojis
things have gone well and that sounds
like fun but people on github seem to
think sometimes it's not fun to print
emojis I disagree I think emojis are
great rocket prints 3mo jeez
the first emoji it prints is configured
for development depending on which
environment you've configured to for
it's configurable it tells you all the
information you need to know about your
application then it tells you all the
things that you mounted and then finally
tells you that things went well and it
has launched now this is the point where
rocket tries to help you with miss
configuration one it's very very clear
how you've configured your application
there's there's no if ands or buts it
tells you exactly how the configuration
is how the application is configured to
if anything weird happens for instance
you're running your application in
production and there is no secret key
rocket will just abort it'll say no this
makes absolutely no sense you need to
fix this any miss configuration rocket
will abort application it would be nice
if we could do it I can pile time we
can't because it's dynamic information
but it will abort if it's if it sees
anything wrong so that's that's
basically what you write now this is a
very not interesting application one
thing we can do is we can change that
route path at the top that gets slash
path to something more interesting like
get slash world and they would have to
go to the slash world path to see that
we can change that to slash Sergio and
make you go to you know slash surgeon to
see that but ideally we can do more than
that and rocket would be very
interesting if we couldn't and
disorderly we can do dynamic paths so
dairy pads as we saw before are these
in brackets at the top there and what a
dynamic segment is is you match anything
inside of that past segment so anything
inside of you know the first segment is
going to match the name and anything
inside the second segment is going to
match to age and for everything that you
have in brackets you're gonna have to
have a matching name in the function
signature so here we have name and age
so we have to have a name in an age
inside of the function if we don't have
a name and age inside of the function
for instance we have the age and number
well then Rockwood would give you a an
error at compile time and the error
looks like this it says hey there's no
parameter you there's this parameter
name age and you haven't used it here's
the function where you're supposed to
use it in you know use it and this is
exactly what Adam it's so we can go
ahead and change that back to age and
you'll see that these things are typed
right this this is not like a straight
well the first one's a string the second
one's an 8-bit integer and any type that
implements this from params rate which
is a type class in Haskell or an
interface in Java or you want like a
superclass or something like that it's
just things that must be true about this
type anything that implements that
interface that type class that trait is
allowed so here we have string and you H
and rocket implements from pram for both
of those types and so that's allowed and
the cool thing is that this handler will
only be called if those parameters parse
at the types that you indicate so a
string is always a string so that parse
is just fine but an age is not always a
name that a string is not always an
8-bit integer so that age parameter will
only parts if it's an 8-bit integer a
bit unsigned integer and only when your
parses can this handler even be called
because Rocky's not gonna generate
fabricate integers so this handle only
gets called if everything validates in
this case there are two parameters and
building tonality so one nice usage of
this for instance is when getting a path
from the user so say you're trying to
write a static file server and you need
a path from the user well for those of
you familiar if you get a path in the
user you better make sure that the path
is safe otherwise they're gonna be able
to read every
that you have in your system and rocket
basically prevents directory traversal
that's called directory traversal and
rocket will prevent directory traversal
just by asking for a path so here we
change the dynamic parameter to have dot
dots and that just means not only this
segment but every segment because we
want to match the entire path and then
we've specified that the that the type
of that parameter is a path buff which
is just the heap-allocated path and then
the implementation of from per am will
ensure that path is safe to be used as a
suffix to any path so here we can just
open a file at that path prefixed with
static and and return it and if that
file exists the user will get the file
if the file doesn't exist then we'll get
a 404 and this is exactly what you'd
write these four lines are exactly what
you write if you want a static file
server and rocket and it is not
vulnerable to directory traversal and
you know again the types tell you
exactly what has to be true this has to
be a path and nothing will get called if
that path is weird wonky that the user
will get an error and say nope that
doesn't make sense please fix it
okay so request guards are my favorite
part of rocket I think this is where all
the power comes in really so rocket has
this content of guards and these
parameters you can call them parameter
guards and so there are different types
of guards so the parameter guards that
we saw before and now request guard and
so request guards are types again that
that guard your function so here your
handler so here we have a guard called
admin user and you can have as many of
these guards as you want an arbitrary
number and again like I said they these
guards will validate the incoming
requests against any arbitrary policy
and they protect the handlers from being
called Irenaeus lee if there is an admin
user logged in then that that that guard
passes and it allows that request to go
through if there is not then that guard
is not passed in fact he has two things
they can do when it doesn't want it to
pass they can add to fail you can say
hey rocket this is not a good request
feel it stop processing it but it can
also do something called forwarding and
forwarding is is it's kind of like
indicating a local failure it's saying
hey the
does not validate an administrator but
maybe something else can validate this
request for some other thing so for
instance you might have another path
another route rather that has a regular
user and we'll walk it will do is it'll
try these routes in what's called a
sending rank order so when rats collide
that is they match the same requests so
here they both match get request to
slash admin it'll try those routes in
ascending rank order and you have to
specify that with this rank equals
rankle in this case two parameter and if
you don't for instance if you did this
and again you get an error this time at
at runtime because routes are lots can
be generated dynamically and it'll tell
you right here hey these things collide
here are the names of them by the way
did you know about ranking that usually
fixes this problem and so yeah you have
to rank them and so you rank them and
raqqa don't try them in ascending rank
order so if we have these two routes the
first thing it'll do is it try that rank
that route at the top which means it has
to validate an administrator and if that
doesn't work it'll try that second route
which means you're gonna need a regular
user and you can extend this further for
instance to say well I don't even need a
user for a given route to run and and
what we've done here is in coda policy
authentication and authorization is
encoded in these eight lines right if
there is an admin you give them the
admin panel that's the first route if
there is no admin we try that second
round that means hey I need a regular
user maybe you give them an error that
says hey I'm sorry this is only for
administrators and finally if there is
no regular user if there's no user at
all then you try that third route and
this one has no requirements it has no
parameters in the function signature
which means nothing needs to be true for
this to run except matching the matching
conditions in that case maybe you
redirect them to a login because we
don't know they may be administrators so
this is encoding an arbitrary policy do
request guards in forwarding all right
the last thing I want to talk about sort
of the world of of rocket is this data
guards thing this is sort of the thing
that would've prevented the equifax
attack so say you have some structure
and it's some task here so this think of
this like C++ so you have some structure
the task has two fields a string and a
boolean and you want to parse a form
into this structure well what you do
well you use a data guard and this is
what you would write for instance and
we've introduced this data equals in
this case we're calling it to do and
what happens is rocket well look at the
type form and look at the generic
parameter tasks
well not rocket really rust and as long
as that task implements another
interface called from form things will
be okay it'll allow this to type check
and so how do we implement this
interface well you could write it
manually but also rocket could generate
the implementation for you from the
fields in the structure and the way you
do that is by adding that derive from
form thing to your structure and rocket
will look at the fields and generate the
code to parse any form as that structure
and it's very strict if there are any
other field in the form it'll fail if
there are fewer fields it'll fail if the
fields are the wrong type it'll fail so
you have to get exactly that structure
for this to pass now there are escape
hatches for instance because like API is
like to give you more fields and are
actually they're like stripe just gives
you fields that you know they've never
documented so you need some way to say
ok except more fields but nevertheless
field to never feel to the wrong type
and any type that implements this from
data interface is allowed so so in this
case for instance we have a form type
that rocket provides and it implements
from data as long as the generic type
implements from form and like I said
rust rocket will automatically to
serialize that into the form into the
structure that you'd like and you can
change that form for instance to JSON
and all you have to do is change the
type and all of a sudden your
deserializing JSON and everything else
happens for you ok so this next part I'm
going to I'm going to run through very
very very quickly because for those of
you that know rust this will be
interesting for those of you that don't
know rust this will probably be
confusing so I'm going to go through it
very quickly just so you have an idea of
what's going on here so how does rocket
do what does rocket generate
what code is rockin generate to do all
the validation for you so here is the
hello world revisited and here is a code
that rocket generates this thing up here
is generated from the attribute it just
reads off the things in the attribute
and it generates a structure that has
the name the method the path and then a
handler the function that's gonna call
and you'll see that the name of the
handler is not the name of the function
so that's another function that rocket
has generated so this is high round
thing you know what it's done it's mono
more flies your function so it's taken
any function and made it one signature
as opposed to many signatures which we
can't call and finally on this mount
thing it's expanded that routes banging
into a vector like I said I'm just gonna
go through this pretty quickly so this
is the code that it generates the fun
thing like I said is this mono more
efficient takes your handler and expands
it into another function that has a
static signature that rocking can call
at any time so what does it do about
guards and parameters this is much more
interesting first the attribute stuff
that's exactly the same it just reads
off of things inside of the attribute
and generates a structure we're just
gonna use at runtime to actually know
what route this is but this part is much
more interesting well the code that
generates it's pretty big it's this
stuff here and I mean it kind of does
exactly what you would write alright
these are these if conditions that we
saw it just writes them for you so for
instance it calls this from request
method for you automatically from that
from request rate and it calls that from
purim method automatically from that
from params rate and so really it's just
generating the code that you would write
yourself it's no magic just cogeneration
so this is the three bits of things that
it that it covers alright so one last
thing on rocket so this is type your
eyes so this is a new addition to rocket
so say you have a route like this and it
has some path such inventory slash
product flash ID and you want to
generate a URL to this path to this
route well you could just concatenate a
bunch of strings together and you know
get you this shirt yd 2417 but better
than that rocket provides this macro
called URI or you just give it the
actual type that you need so this type
safe and it'll generate the path for you
and you can also specify them as key
value pairs so you can do product equals
product ID goes ID you get
around but if you get it wrong for
instance if you call product item when
it's actually product then rocky gives
you a nice compile time error and it
says hey these are wrong this is what I
thought it was this parameter named item
I don't know about it but you are
missing this other parameter so fix it
so if you go back and fix it it
generates this URL for you okay finally
on performance rockets fast rockets
pretty quick here's how quick it is
so there's whales there's Express
there's flask and there's rocket so
rocket is several magnitudes faster than
rails or flask and it's quite a bit
faster than Express you know in this
case tens of thousands of requests
faster this is on a rather slow machine
this is so don't take this for granted
or don't take this as the truth if you
ran this on a faster machine you'd
easily get hundreds of thousands of
requests from rockets what's more
interesting is what happens with latency
so if you look at latency so all of
these other languages are garbage
collected
if you look at latency rocket is just
way way way way WAY WAY lower here lower
is better so rocket is sub a microsecond
everything else is you know many many
microseconds and this is the average
latency when we look at max latency if
we saw that tail at scale talked we
should really care about that then
rocket is just you know really really
low and this is at this point this
linear graph becomes a very very bad
graph so if you go to this logarithmic
graph and then things look even more
crazy rocket actually goes to the left
of that graph now because the only thing
sub microsecond and if we were to plot
both average latency and Max latency
then becomes very very very very clear
that rocket is in a whole different
ballpark as far as latency is concerned
compared to anything else that you might
use sort of in the same usability
category this is a summary of
performance so quite a bit faster in
throughput it's going to get much faster
and it you know it's quite a bit faster
than most things the latency is way way
lower especially in in the max case and
and yeah Rockets Rockets pretty quick so
that's all I have to say about rocket if
you want to learn more about rocket
there's a website if you go to rocket
dot RS there's a guy
there's a tutorial there is a bunch of
documentation there's news and obviously
a link to github check it out it's you
know I said there's thousands of users
dozens of companies I'd love for you
guys to use it my name is Sergio that's
my email address thanks so much for your
time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>