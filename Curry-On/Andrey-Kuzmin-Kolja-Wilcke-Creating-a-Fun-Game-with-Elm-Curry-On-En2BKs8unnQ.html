<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Andrey Kuzmin &amp; Kolja Wilcke - Creating a Fun Game with Elm - Curry On | Coder Coacher - Coaching Coders</title><meta content="Andrey Kuzmin &amp; Kolja Wilcke - Creating a Fun Game with Elm - Curry On - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Curry-On/">Curry On!</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Andrey Kuzmin &amp; Kolja Wilcke - Creating a Fun Game with Elm - Curry On</b></h2><h5 class="post__date">2016-07-21</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/En2BKs8unnQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">yeah
okay it's on hello everybody
Andre and I came here from Berlin to
tell you about the game that we created
and in fact what we want to do is
encourage you and inspire you to also
take on Elm and create a game of your
own it was a fun experience
so Elm is a functional programming
language and solando is a company we
maintain a website that allows people to
buy a fashion online so another thing
that we do at Solano is we have
something that they call a quake a quake
means for one week
everybody just drops what they usually
do as a day job and implements things
that they really feel need to be done
all by themselves mmm so last hack week
and they came up to me and said let's
create a game in elm he was pretty
explicit that it had to be Elm did we
use and I thought maybe we can do
something like something thats related
to solando so something about going to
warehouses picking up clothes and
shipping it to the customers that was my
my take on this thing so what I usually
do at sorondo is write closer and closer
script code and I like to make
illustrations as well so I was a good
fit for this and Andre has a background
in Elm so he had already written
something like a Tetris game and put it
on the or it was featured on the Elm
website and so he knew what he was doing
and I had to learn I had to learn it
from scratch but um well I was doing a
hostel class at the time so it was right
up my alley really then at the hack week
you can just run around and advertise
your game too or advertise your project
to other people and so we took on other
other of our colleagues so there was
who was also new to Elm and there was a
pet who had a background in Lisp and he
had just over he had in before he had
implemented his own scheme called Miko
Miko and so that's the team that we
ended up with in the background you can
see that we have we have this sketch
that we did to the whiteboard to get
clear all the mechanics of this game how
this should should go down so it's run
we have this slogan put yourself into
her customers shoes and for this game
now we had this this thing we had this
idea we could turn it around and make it
you know put our customers into our
shoes for a change
so I a really should we use them for
this Elm is used Elm compares to
JavaScript
so it's using web development quite a
bit and according to this survey by
Brian Hicks apparently it's also used a
lot in games and I think this is
probably due to Elm being opinionated in
the sense that it comes with something
that they call the Elm architecture and
I think it lends itself quite well to
games but Andrey will go into this into
the ins and outs and particularity of
this a little bit later so when we
started out I had to draw a lot of
things first and the other guys put in
place the the basic mechanics of how to
render sprites and stuff to the to the
to the screen so we have put the
backdrop we rendered surprised this
worked what they programming part of
this thing started out with and I just
had to draw a lot of sprites I was
helped by Vignesh who gave me like he
gave me this thing where all our
delivery people were to be seen at the
same time and you could animate them
so as you can see I had to draw 24 of
these to allow for this guy to move into
all directions also of course customers
yes I had to draw quite a lot of
customers and they also had to start
more or less naked because we didn't
sell anything to them yet
and you may also notice maybe some
familiar faces and the customers to give
this talk more relevance we felt it
would be appropriate to include some of
the participants of this conference so
if one of these guys looks like you
that's on purpose so of course also we
needed to create a lot of clothes yes
and we put those onto separate layers so
when you deliver the clothes the people
you can mix and match and yeah so there
is more variety in this thing however in
our game it's like this if you fail to
deliver the clothes to the customer
quickly enough they will become angry
and yeah also needed to make a little
bit of a change to the clothes because
they have to animate with the angry
customer yeah so while I was doing all
these drawings the others the other guys
weren't lazy they were creating code for
instance our pet head was working on on
the implementation of the a-star
algorithm and Andre had created the
sandbox for him so he could focus
entirely on creation on the creation on
the implementation of this algorithm and
he didn't have to you know think about
how to render stuff and then when the
algorithm was just half-baked we could
click around and see how it reacted and
it was fun to see in the early stages
where the delivery guy would take
detours or run through obstacles and
stuff like that and
he would go back back to the editor and
make tweaks to improve it another thing
that we didn't solve during our
implementation week because during this
time we had all our items rendered
statically into a certain place but as
an afterthought we wanted to make this
thing responsive we wanted to make the
game responsive to allow for rendering
or on different devices and so we needed
a way to randomly display these these
items yeah so and Ray came up with a
solution you render the first item and
it gets placed randomly somewhere on the
screen and then the remaining areas get
split into four and other subsequent
items are placed you know in the
remaining space somewhere and so on
until all the space is filled up or
until you know your rules are satisfied
satisfied of which elements exactly you
want to have rendered so it would be a
stretch to tell you that we actually
created this thing within a week we work
night shifts and to make this happen was
fun but yeah you know one week okay
that's tough and in fact when we were
presenting this one of us was would be
presenting it to the rest of the company
and people would play it well the other
guys were still hacking away and
implementing last-minute features and so
it came out that when you would you know
refresh the screen or refresh the
browser then the Reeb like new features
would have cropped up when they were
implemented last minute so probably
you'll you want to see it yeah so we
have it here let's give it a demo run so
and we need to go to the warehouse those
are the square buildings but first we
need to check like what the company what
did the customers really need
so there's a high demand for green
shirts here so Andre please go to the
today yesterday where's above there and
then you pick out maybe two shirts so we
can make this customer happy please just
go back and okay give the person two
shirts very nice also you may have seen
for a bit there the guy had like a
strikethrough symbol that means he
doesn't want whatever he bought anymore
he wants to return it this is something
that occurs at solando as well
from time to time so and I can you okay
and because I see there's a lady she she
wants this the shoe the spring shoe
please pick it up because it's already
blinking blinking means she's getting
nervous and she'll eventually be unhappy
if if she if you don't get it so please
give and deliver it as you can see this
lady already looks a little bit pissed
that she didn't get her green trousers
if if you don't do anything for a while
people will get really really unhappy
they'll start shouting and then
eventually they just disappear from the
whole thing and then you see those green
customers up in the in the top they're
like all green now but they will become
red and then when you lose three
customers that's it game over also
another thing that I should mention is
you cannot you know have as many items
in your cart as you as you wish so you
have to be careful and and make careful
planning like with the Traveling
Salesman you know you have to do this
okay so I guess you get it maybe we can
just move on to the next slide so you
see an illustration of the Elm
architecture and I'll hand over to Andre
who's gonna give you more of a technical
thank you quite so have you ever tried
Elm before yeah so plenty of people
actually well others please bear with me
there will be some elm code in the
following slides so yeah this is the
architecture let's make this a little
bit more technical so architecture is a
very simple concept you have a model you
have a view that is the projection of
that model a view in Elm is the dome and
dome has also Dom events and this events
then they send messages and update is a
pure function that takes your message
it takes your old model and then returns
you a new model and this is how the
model is reduced over the update
function and this is how the whole thing
is running so it's like slightly more
complex than that
you also have subscriptions that is also
a pure function that takes the model and
it returns a list of subscriptions so
you can hook into some global events
like window dimensions animation frames
time intervals and mouse keyboard and so
on and update function can also return
command so commands is a side effect
kind of thing but it's a side effect is
a data so it's like just an instruction
that you can use to ask Elm please do
something and once it's done please come
back and send message back to me so both
subscriptions and commands they also
produce messages just like the one that
you get from the view and all these
messages are then sending to your
central update function
so in elm it it is important to mention
that Elm is not just the language it's
also a framework and what you can get
from the HTML app program is function
that that you can run and you just pass
in your hooks and then it will just work
so what you have to implement is the
initial model and initial command you
have to implement update function that
takes your custom message and the model
and returns model and command you have
to implement subscriptions and you have
to implement view and then what what you
could use is just this HTML app program
and it takes the record where you just
fill in the attributes and then it will
just work and and in the following slide
so we'll go deeper into model update and
view and we'll talk a little bit how we
use them in our game so a little bit
about the model so model it's it's very
important to get the data structures
correctly in the functional mutable
world because the the way you structure
your data has a lot of effect of how you
write your functions so you have to
really optimize the data in order for it
to in order to not write a lot of code
when you deal with that data so we have
this example and in the traditional
object-oriented approach how would we
have structured articles so would look
like this we would have a house
warehouse and delivery person is just
objects that would have a list of
articles so house will have lists of
articles that are delivered to that
house and the list of articles that are
awaiting to be returned so list of
articles for the warehouse and for the
delivery
and the functionality that we would need
to implement is speaking up an article
and spawning a new request so picking up
an article would require us to mutate a
lot of things so we would have to update
the list of articles inside the
warehouse and this will produce create a
new warehouse object there is in all the
objects of the game and the same with
the delivery person when you have to add
this article into the inventory of the
delivery person you would have to mutate
the delivery person also spawning new
requests like the new order from the
customer will well we customers cannot
order articles that are not they are in
the game so you would have to traverse
all the data and you will have to find
what are the articles in the game and
this will also require some code to
write and what we went with
was having one simple list of articles
and we used we tagged them with location
and for this we used Union type state so
an article can be in stock at warehouse
waiting returned from house delivered to
house or picked so it actually it allows
us to to write less code in order to
explain this functionality so picking up
an article would be as easy as just
changing the state from in stock at
warehouse to picked and spawning a new
request is just like to get the list of
available articles we will just have to
filter through the list of articles and
find the ones that are not awaiting
return not ID not delivered to house but
sometimes it's not it's not easy to get
the data right so
sometimes you just have to implement
something quickly and Elm has a lot of
benefits regarding this so compiler can
help you in further refactoring of the
code because the language is strongly
typed and the compiler will guide you
through your shotgun surgery that you
applied to the code so here is a small
example small refactoring example so
before we had separate lists of map
objects in the model so we stored them
in separate lists and all the objects
warehouse house and obstacles they were
of different types so different record
types but what they had in common is was
position and size and we needed to them
to be in one list because we wanted to
use them in the path finding algorithm
and we wanted to use them in the random
random algorithm so if so before we had
to convert them into a single type and
then convert them back to put them into
the slots in the model but what we did
we we also we unified the type the map
object type and we used union type in
order to explain what are the different
attributes of of this object so we have
created house category that takes
capacity of the house same with
warehouse and the fountain category
stored the animation state of the
fountain and and the tree category tree
yes just the tree and this change alone
including the random generation
algorithm actually cost in removing more
lines of code and agent code so this is
the case in hell whenever you want to
introduce some new abstractions whenever
you want to pull some
data structures together you end up
agent features by removing code and this
is I think it's very nice about it also
another feature like the compiler guides
you through so you spend less time
playing the game you spend more time
programming it so the next thing is the
update functionality the actual reducer
of the of the model and and for this I
would like to talk a little bit how we
did animations in the game so there is
this nice module called animation frame
and this gives you a subscription to to
the animation request animation frame
API in the browser so with just simple
code like this you could subscribe to
animation frame deals so here we create
our custom message type that is tip of
time so time is in the payload of the
message and animation frame that gives
gives you a subscription to time
differences between frames and you tag
them with the tick constructor so this
will give you the subscription to this
your to your message type and then in
the update function we use the pattern
matching case operator to extract the
elapsed time LX elapse time from the
payload and then we call our animation
loop function we pass at the time since
the last frame and the previous model
and this will return you the model after
this animation step and and here is the
simple implementation of the animation
loop here we store the frame the current
frame and the time out so we we
increment the time out we had elapsed
time to the time out and whenever it
reaches one second
we increment the frame and we reset the
timeout otherwise we just store the
accumulated value so let's let's run it
so so here you see that the time out
once it's reaches one second the frame
is incremented oh and by the way haven't
I told you that the presentation itself
is the Elm code so this is actual Elm
program right another important thing is
you have a lot of different objects in
the game and all of them they have to be
animated so how do we compose animations
this is a very simple example example
excerpt from our game so here we have
two separate modules one for delivery
person another one for a customer and in
order to animate them we take this
attribute from the record and we apply
this animate function to that attribute
so it gives you the the animated value
so for customers it's a little bit
different because customers is the list
of customers so what we are doing there
we partially apply an amide function
with the elapsed time and this will give
us a function that takes old customer
and returns the new animated customer
and then we map this over the list of
customers from the model and this will
produce a list of animated customers so
and the last part is the view so
initially we rendered our game using our
HTML module that that has a similar
implementation to react as if you have
heard of it
so it uses a virtual Dom concept you
describe your view declaratively
then the runtime will create a diff
between the previous previous
description and in the new one and will
only apply a patch to the actual Dom in
the browser so this is very efficient
and it causes the last amount of reflows
in the browser but we noticed that the
performance was not good for us
especially on mobile devices so we tried
to explore what the what were the other
options and one of them was the canvas
implemented in the graphics module
however that one didn't have a way to
work with texture offset so we needed a
way to store animation frames in on one
single sprite so this was not possible
so we used a WebGL instead and on WebGL
is also very nice and straightforward
approach so it's much easier than using
WebGL from the JavaScript because then
you would have to compile the program
link all the stuff together and in WebGL
you just declare declaratively describe
all the renderer balls and and then it
will work so of course you would have to
learn shaders but a lump has also some
nice features so it does automatically
generates type signature for your shader
so so a little bit about the transition
so when we used HTML what we did we
rendered in the view function we render
each object into the list of our own
custom boxes that had some information
about what is the sprite that has to be
used what is the position and dimensions
of the object what's its layer and so on
and some of the boxes they had also on
click events so and then this boxes they
were rendered as
a bunch of gifs in the browser and we
used z-index to that index CSS property
to to implement layers and and we used
the browser feature we just had unclick
events on those divs so however as I
said earlier this caused a lot of like
performance penalties in on mobile
devices because the we had like a lot of
moving elements a lot of moving divs
inside one container and this was
closing like slow deep and slow updates
of the real Dom this thing could have
been solved with the key attribute where
you could say that please don't touch
this element or like you could actually
have this exact one-to-one mapping of
elements however this didn't fit well
into our code and so we had we'd have to
rewrite a lot anyway so we chose to go
with WebGL solution and the difficulty
that was there is big we couldn't use on
click events we had to manually
implement our own detection of what
object and the game was clicked and for
this we created a special Union Union
type the the box was a union type it
could be either a textured box or a
clickable box and then we did some pre
rendering in the update function that
would create us two lists of boxes one
textured boxes and another list for
clickable boxes so on the onclick event
we would have manually calculate which
box was clicked and then dispatched the
message from that box and then in the
view function we simply used the
textured boxes and we sent them to WebGL
for rendering
so yeah this is the time line from from
chrome debugger we probably saw it in
the keynote I spent a lot of time
looking into this so here what you can
see that the game runs pretty fast so
all the frames that you see there are
milliseconds it's almost 60 FPS but
what's wrong is there is this red line
on top this means that there is layer
thrashin happening in the browser so it
doesn't necessarily recalculations of
the layout and also the heap size is
pretty large so it's almost 20 megabytes
and I try to improve that and in the end
we have everything is green there on top
and heap size has decreased and also we
reduced the scripting time so before we
were doing like a lot of recalculations
a lot of high computations in the
animate function that was running very
frequent and what we did we extracted
them into a time interval subscription
so we ran those high time consuming
computations less frequently than the
requestanimationframe happened so we are
still working on the game just recently
qualia I drew the boxes the of the
delivery person so you could see like
those jumping boxes depending on how
many are there in the inventory our
plans were to go live on the actual 404
page of the Londo website and we would
like to add sound effects improve the
performance and the gameplay we are of
course looking for contributors so it's
there on github please check it out and
the last thing that I would like to
mention so whenever somebody asks me
about Elm and I explain all the nice
features of the language how welcoming
it is and how good is the experience
work
with compiler but there is one question
that people ask me like but but do you
use it in production and and this is a
tricky question that I couldn't answer
before but today we are going to change
this so today we are going to put it
life so we will have Elm in production
and I hope that my colleagues enabled
the feature so so now I think you can
access it on the actual 404 page of the
lambda thank you
of course yes I would like to use em for
the new project there are some ways of
actually introducing Elm into your
codebase and even has just recently open
sourced the module that allows to
integrate into your reactors application
as reactive component and the JavaScript
Interop is pretty simple so you could
use port parts so it's like a pops up
way to communicate so yeah I think go
for it so but yeah first you can try it
on some small project maybe some
internal tool
I think we are going to push it on to
github and we will send the link with
the I hope that the conference will
retweet the link so it's powered by the
slideshow that is the presentation
engine that I implemented you know when
I was like writing the introduction to
them when I was creating an introduction
to a presentation I thought it would
make sense to use em for that because
like I'm a front-end developer so I
would use something html5 presentation
engine but using javascript to present
Elm like felt unnatural to me so I
created my own presentation engine so so
integrated with the server side there is
the HTTP Elm HTTP package that allows
you to consume api's so you get the JSON
and the payload and then you use
decoders to decode them into your typed
object into your typed structures
so so speaking like the the performance
was slow because I think that the
virtual Dom is actually it works better
when you have like trees of objects so
we could it could easily go and see
what's changed but what we had just a
bunch of divs in one single container
and whenever like one gif is removed all
the rest of them are refloat and
recalculated that's right of course
yes so as I said we also reduced the
script in time inside the animation
frame and the way we did it so the
requestanimationframe is executed
frequently and and there were some
computations that like some cleanups
like removing some debt of objects that
are not linked this thing is has been
moved to less frequent interval
subscription so it occurred every second
or so so we didn't have to run it every
time but also because with WebGL you can
just send stuff to it without taking
care about the divs so it doesn't need
to give anything so you just render
every time
so personally I just use Adam and Adam
has Elm make integration so whenever you
change something it will automatically
highlight what's wrong like what that
the type signature doesn't match and so
on so under the hood it just runs on
make command and that and gets the nice
error message and shows it like at the
exact line of code that you changed and
for the teamwork we just used github yes
oh yes so our colleague lineage
implemented CI solution so we used
Travis to try to compile the master
branch and publish it to github pages so
whenever something is merged into master
if own compile succeeds its they're
pushed automatically to github pages so
we didn't have to take care of that so
we always had the most recent version
that compiles working
so my high school knowledge is very
small what I know basically some stories
from some high school developers who
come in to Elm and they want some new
features that Haskell has but Elm
doesn't like type classes for example I
think this is the most thing that people
request from Elm and and Elm is driven
by very pragmatical things so they don't
introduce new features into the language
just because it's a feature that someone
used so is more toward solving actual
problems of the UI development so and
and a lot of people who are using em
were people who were doing their own
front-end development in using
javascript and then they converted into
elm so adding some new abstract like a
new complicated features from Haskell
would make the language not as friendly
to the newcomers from this side so I
guess that's why it's not there but like
if you want type classes then I think
you could go with pure script for
example that has down
you know I haven't seen this and my in
in the timeline there was no problems
with this so far I think that JavaScript
engines nowadays are pretty powerful to
deal with this because a lot of other
libraries like reactors immutable J's
library by Facebook that and there are
some other immutable libraries that are
quite popular nowadays in the JavaScript
world and people have no problems with
this so I heard from one one friend told
me that it was a problem back in the
days when we had low low memory devices
like some phones that had not a lot of
memories and this may just crush the
browser there but but nowadays I don't
think that's that's an important concern
thank you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>