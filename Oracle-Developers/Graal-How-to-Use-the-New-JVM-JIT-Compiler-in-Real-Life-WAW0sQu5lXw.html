<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Graal: How to Use the New JVM JIT Compiler in Real Life | Coder Coacher - Coaching Coders</title><meta content="Graal: How to Use the New JVM JIT Compiler in Real Life - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Developers/">Oracle Developers</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Graal: How to Use the New JVM JIT Compiler in Real Life</b></h2><h5 class="post__date">2018-02-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/WAW0sQu5lXw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hi welcome I don't know why they put me
in this room and usually that the talks
I gift they're basically all my talks
about our about compiler technology and
I know that not a lot of people show up
because it doesn't have machine learning
in it or container or cloud or so but
I'll be using or the cloud today so if
you if you came for the cloud you will
get some my name is Chris ballinger I
work for Twitter I'm a I'm a JVM
compiler engineer and I live in Hawaii
so I was hoping you know it's warm here
but it's not what the hell I don't know
what's going on so Twitter has its own
VM team we have four engineers we have
three chassis engineers they take care
of you know that you see related
problems our services happen then
there's me and I'm mostly you know
playing around almost with Gras and try
to make stuff run better so that's
that's what we do if you if you're going
to tweet about this talk and I would be
happy if you would does everybody have a
Twitter account I show up so use that
hashtag and then you know my team
members will know as well so why am I
doing this these talks
so this talk specifically no let me let
me talk about in general why I do my
talks it's how many of you know what a
chick compiler is let's start there okay
not everyone okay good so the chip
compiler in the JVM just very quickly I
don't have a lot of time I prepared many
many demos I don't I don't think I can
do it in 45 minutes I cannot but I'll
show you as much as I can so a JIT
compiler basically takes Java bytecode
and composite down into native code what
this what the CPU then can execute and
growl how many of you know what growl is
okay even less oh yeah I know you do
growl is is a new cheat compiler for
hotspot you know what hotspot is the JVM
in openjdk yes okay
so hotspot has today c1 and c2 client
and server compiler and there's there's
something called growl and so weird we
will be talking about growl and I'll
show you what it is and how to use it
and so but the main purpose of my talk
is what my talks is to get people to try
it you know we're twitter we use it but
I want people to try it as well to see
if it works for them to save money to
fix bugs to improve growl and so on and
so on so these this is the reason why
why I'm doing all my talks and and after
my talks
some people come up to me and and they
ask me questions I go this is actually
safe to use it right because it's not in
the product it's more an experimental
feature still and how do I use it and
where do I get it and so this talk today
will answer these questions and
sometimes yeah they simply emails later
and say oh I tried it and then they are
most complaining about it and to say oh
this benchmark didn't run faster and so
on and so on and they usually say that
brawl sucks
okay that's because they don't
understand that it's different than C -
for example it's just the way it's
written is different and the way it
behaves it's different and this talk
will tell you about this
so I said saving money and that's
basically why I still have a job at
Twitter so we are using growl at Twitter
and because of that we're saving a lot
of money my other talk
Twitter's quest for a Holy Grail runtime
funny pun you can there's lots of
details in my other talk with lots of
graphs explaining what's going on and
why we are saving money and CPU
utilization and you can you can search
that talk on YouTube and watch it but
it's pretty much it looks like this so
this is me giving the talk it kind of
looks like that and so what is Grogg as
we said there's a java virtual machine
just-in-time compiler I briefly explain
to you what that is and it's actively
developed by Oracle apps these are the
links there's a
k-project then they use github as their
main repository because it's just easy
for them to use it and then it uses
something called che vm CI which is in
in the jdk since Java 9 and very
important growl is written in Java so
the compiler itself is written in Java
and this will be the most important
thing you have to remember throughout
this whole talk that it's written in
Java because that brings a lot of
different things to the table if you
have a compiler of written or the VM
basically all of the VM is written in
C++ if suddenly something else comes in
that's written in Java it has different
behavior right
it needs to be compiled it uses Java
heap memory for allocations and so on
and so on you have to remember that so
this the this is the main takeaway if
you can remember one thing after this
talk remember that so where do I get it
as always the answer is it depends and
the problem here is in inches oh okay
there is chap 295 which is ahead of time
compilation and ahead of time
compilation if we go to this chap and so
we can see ok ahead of time compilation
is in 9:00 and it's it's closed of
course because JDK 9 was was already
delivered and if we scroll down here all
the way to the bottom it says the
dependencies of this project depends on
chapter 243 which is the JVM CI the
compiler interface I talked I mentioned
earlier and it uses growl as the coche
narrating back end so the alt feature in
Java 9 uses cross compile code and which
in turn depends on JVM see right the
project will merge growl core which is
the cross source code into the JDK and
deliver it in Linux x64 builds that's
the that's the it depends part so if
you're running on Linux like 66 which I
think almost everybody does at least in
reduction then you can just get JDK 9
and you you will have a growl version in
it that you can just turn on okay okay
let me go back here so or if you're not
on linux there is this bug it's it's
basically it's not a bug it's a ticket
and it adds platform support for Windows
and Mac OS 10 and then you can also use
alt for these platforms and then in
these builds you would also have crawl
in it okay if that makes any sense so if
you have a JDK with JVM CI which you
have since nine and a ot you have draw
okay and that means for linux x64
created equal then jdk nine or from mac
and windows credit equal than tam so you
can download a JDK nine here from jdk
java.net or if you need it for Mac or
Windows you can use it at ten early
access panel 10 is when it's 10 out like
in four weeks or something so it's not
that far away
okay so how do I get this and yes
this talk as I said is a lot of demos
and I hope all of them work we'll see
maybe I'll forget some stuff could
happen so the the way I decided to do
this talk and this is this is kind of
the the part where it could get you know
a little awkward and boring at times but
when people give presentations and and
they do live demos the most of the time
they do it on their laptops and I always
wonder how many hours did they spend to
make this demo work when they do the
presentation up on the stage so I
decided to do it completely differently
what we are going to do is we are going
to fire up an Oracle cloud instance
right now completely from scratch
there's nothing in it and then we do
everything from there we download the
JDK I'll show you how to use it so
everything I'm doing today is if you
would do it on your completely newly
installed Linux server
okay okay so I have my account here
login and then there are these awkward
pauses where I'm waiting for stuff to
load so bear with me a little bit so
we're creating an instance we want to
compute instance and luckily I'm wired
up with Ethernet Ethernet so I don't
rely on Wi-Fi here so we want to compute
instance but I still have one running so
I want a new one and we call that what
do we call it le I hope that works and
then we do oh no sorry see I want it to
be in the u.s. that's what I want it to
be and compute instance right now I
still have one running no no let me
quickly terminate that one so we
launched a new instance we call it le we
put it in I can't remember what the
other one was to put it in this domain
and then we want to Oracle Linux 7.4 we
use this tens i/o one because it has the
most CPU cores and I have to select
these network things I don't have to do
this I need to paste the necessary so we
have to do that
and okay here we go launch instance so
that should do it it's not provisioning
it and I don't know you guys probably if
used the cloud way more than I did so
this will take a while and in the
meantime so the provisioning is actually
pretty fast and now we already have the
public IP address that's exactly what we
want so we want that IP address but we
can't log in yet because it's not
running yet so we have to wait a little
bit for this and in the meantime we go
back to my slides and I tell you a
little bit about me so I work on JVM for
over 13 years I was pretty much always a
compiler engineer and and then at some
point I started to work for some
Microsystems
you know through basically through open
JDK I came to some Microsystems and then
or at the quiet sense who I was working
in the hospital compiler team at Oracle
for a while I was heavily involved in
chase r2 92 which added invokedynamic
and all this dynamic language stuff to
the to the to the JVM and the JDK I
basically brought chip 243 into into the
JDK which I talked about earlier so the
compiling interface which Graul uses to
talk to the VM and vice versa and then I
worked my last project that Oracle was -
95 which was ahead of time compilation
so we want to get that out to the people
that people could use it output also so
that we could alt compile crawl itself
for example which I won't have time to
go in today but that would be very
interesting to to show as well and now
I'm a Twitter so I work for Twitter
that's my that's my Twitter photo up
there and all the stuff I do I'm an
Oracle developer champion that's how
that's why I can use the Oracle cloud
for free love it it's great so let's see
what the demo does
it's running ok that's good let's see if
we can login it's a foot if it's already
up no not yet I was talking too fast but
it should be up soon
come on did I used to write I hope so
come on oh yeah here we go
so the provisioning is usually pretty
fast but then you know you lean ups
needs to start up and all the services
need to come up but but eventually they
are here ok good so we got that what we
won now is we want jdk java.net we want
chocolate Java 9 right because we're
running on Linux so we can use 9 as as I
told you earlier so we are going to
download this one we go in here and we
download it and since we're in the US
it's pretty fast we don't have to wait
too long it's only a couple seconds ok
here we go
so we unzip that guy come let's with my
typing today it's not that's called open
JDK here we go alright so that's it we
have JDK 9 now and now we say we we said
Java home because it will be useful
later so we accept Java home we also put
it on the path because we will be using
it all the time we do the same thing
over here I'm having two windows because
later we want to hopefully we have time
to good to do this we want to compare
see to withdraw you know especially in
benchmarks ends and start up situations
ok so let's see - with Java there you go
and let me go into this window so there
is something let me quickly go back if
I'm not mixing things up yeah right
so Java has something called you know it
has modules now and it has you had as an
option that's called list modules
it has about I
like 75 modules or something like this
right and so we talked about the äôt
module or the EIT feature earlier and so
it is this module called JDK IOT and
then there is an option it's called
describe module okay
Maggio jdk dot äôt and then it will show
us okay that's the JDK T module for this
Java version and it requires a bunch of
things and it requires for example jdk
internal dot b m dot c i that's JVM CI
so this module contains the code of JVM
CI and then it also requires jdk
internal dot VM compiler and that's the
Java module that contains the grass
source code so if we have all this then
we're good then we know ok this this jdk
we have the support gras and and we can
turn it on so get a jdk with JVM CI and
ELT which has verified that yes we have
it so we can use it and then you just
turn it on that's really all you have to
do so that's the user demo and I'll show
you how to turn it on so if we go to the
chaps oops I was the wrong link chips
here chap chap index on open JDK and the
chap was 243 for the compelling
interface and if you scroll all the way
down it tells you how to turn it on here
okay so all you need is this forget
about the compiler name because there's
only one so you don't have to select
which one it will pick them one
automatically so we are going to stick
that into something called Java tool
options and we're doing this because
it's being picked up automatically all
the time so I don't have to type it and
I'm doing two more things we're using
parallel GC by default because looking
at G 1 output is a little confusing and
we're going to look at some GCU output
later and we are going to set the
maximum heap size to 512 megabytes and
also the
start size to 512 megabytes and I do
this because Corral is written in Java
yes you guessed right and so it's using
Java heap memory and if we're looking at
for example at benchmarks this is very
important because if the if Corral
itself does some allocations and
produces garbage it will chit you know
when you when you compare to see to
you're not comparing apples and apples
so you kind of have to give it a fair
level playing fields so that's what
we're doing here okay so we sell all
this stuff
if we run Java version now we see oh yes
all this is picked up and so we're
turning it on we're turning on
experimental VM options because in
experimental vm feature we tell it oh
please turn on
GBMC i itself which not directly turns
on the compiler it just enables the
interface okay and then i don't know if
you guys heard about truffle but then
you could schedule compilation
compilations through the interface but
it's not the same thing as using it as a
chick compiler that's why you have to
tell it use it as a JV m CI compiler
that then really replaces c2 with gras
okay so that's the output nothing
happened right so what exactly did go
wrong if something went wrong nothing
went wrong but we if we look at at the
compilations that that are happening
when we're doing wet
yes bring competition sorry let me do it
again these are the compilations that
are happening by default hotspot uses
something called tier compilation so
there are a bunch of different tier
levels which is the third column here
this one
that's the tier level okay so tier one
two and three all C one and tier four
would be the top tier compilation level
and that would be either c2 or Gras
so since - version doesn't run a lot of
Java code we are not hitting a tier 4
compilation here so JVM CI and Gras are
lazily initialized because it takes some
time to initialize it so we are doing
lazily
and so we never headed here for
compilation so it's never being
initialized that's why we're not seeing
any difference so we have to run
something else to actually see something
and we're using because we're using it
later as well we will be using that a
couple benchmark if it's loading I hope
it does otherwise I haven't have a
problem Oh in the meantime in the
meantime I have to do something here I
have to install git because it's a
completely new cloud instance doesn't
have anything what are you doing yeah
that's not what I want
we can grab that one that's not exactly
what I want yeah I think we can use that
I'm not sure if again if I get to the to
the scholars of couple benchmarks as
well but wait where is it oh yeah get
down here I always forget and we want
the one yeah I think it's this one okay
let me quick download this guy should
have done this before I explained it oh
it's quick good don't install get here
great
so I forget now perfect so if we if we
run
it's called Scala at a couple benchmark
and let's say add a shell yes wait
before I do this I have to show you
something else so there's something
called print flags final which which
will print all the g vm flags that it
has with their final values and so I'm
just grabbing for JVM CI so you can see
they're a bunch of kb mci options here
and one is very interesting for us now
it's the TVM CI print properties one and
if we do that
okay here we go it's a very long list of
stuff right there are a few JVM CI
properties up here their properties
because JVM CI is implemented in Java so
if you we decided that the flags you
pass in are just Java properties -
capital B right and then the property
and so on and so there there are few JVM
CI properties and the whole load of draw
properties okay we're not going into
this but what we want is this init
timer1
so if we do that so as a capital the
main the tires in search our property we
have to say true and then we say okay we
run this Scout benchmark suite thingy
and we can see oh something's going on
so that output here is triggered by this
flag okay so we see okay there's
something being initialized but it looks
like it doesn't really finish and the
reason is that running this - L exits
too quickly like the initialization of
Corral isn't done yet didn't have time
to compile anything and the appropriate
program already exited and there it
cannot finish the initialization so we
have to do a little bit more if we do
the same thing and we say or we run us
we do a small run of Aurora and then you
can see oh yes it's doing stuff right
it's initializing all of JVM CI it's
this part and then it says okay I'm done
and then there's this compiler
configuration Factory and basically it
selects the compiler and it
automatically selects the one it has and
that's raw and then it initializes growl
and from there on we are using growl and
it finishes the benchmark run okay
that's how it that's how it works so let
me go back here and continue here so
bootstrapping is very important to
understand when you when you're using
Gras it's since go is just another
charlie</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>