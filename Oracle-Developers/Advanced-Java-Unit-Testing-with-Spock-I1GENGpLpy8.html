<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Advanced Java Unit Testing with Spock | Coder Coacher - Coaching Coders</title><meta content="Advanced Java Unit Testing with Spock - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Developers/">Oracle Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Advanced Java Unit Testing with Spock</b></h2><h5 class="post__date">2015-06-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/I1GENGpLpy8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">um who in here is familiar with groovy
oh okay good I just like to know that
and this is the groovy track I guess
right everybody's you know holding the
faith
how about Spock okay less hands okay
good all right what gives me a good feel
we're going to talk about Spock and unit
testing you'll find that my version or
flavor of using Spock is more unit test
wearing it and we'll look at it we'll
talk about it you could be one of those
BVD obdd bigots yeah it's okay you're
gonna be I'll be out in the hall you can
beat me up later I'll be fine
the focus I'm for the Midwest the United
States and they're it's very
conservative and people are afraid to
put new bits of code into production
it's a scary thing but what I have found
is that they let you use the new bits
for things other than production and
this is one of my favorites places to
use groovy I'm going to talk about Spock
from the perspective of unit testing
Java code right I'm writing Java code
will have a code base that we're gonna
be leveraging here who's in favor of
looking at more code and less slides
alright that's a that's good all right
that will have change how I do things
so I have a lot of slides and I'm afraid
I won't get through them all but there
will be good reference for you I think
and you can have access to them alright
but I won't miss anything I hope either
so why don't we get going my name is Ken
site I do this for a living I write code
my current job is actually working for
Mesa sphere here in Bay Area where we're
trying to push meso sand I'm a solution
architect for the cloud outside of that
who cares there's how to get a hold of
me our focus is right here we're going
to be talking about testing in general
getting to Spock and my hope and goal is
to get to advanced stuff the area of
advanced things within Spock there is
one area that I haven't added in that
you might work you ping me I just don't
have code samples for it at this point
is around concurrency testing but there
are
things within the framework for doing
that also I had a good show of hands of
people who are groovy but there's at
least half of you there or not I'm gonna
try to be as specific as possible to the
Java I as to whether it's groovy or not
all right
in fact the probably a popular question
is if I'm gonna do this do I have to use
or no groovy in order to start testing
my java code and it's a good idea it's a
really good idea all right I'm not
saying you have to what I find as most
people can read groovy code if they have
never seen groovy before pretty much
read it the challenge is you're gonna
need to be able to write it the code
base said I know it's cut off sorry
about that
if you go out to Ken's site you'll see
Spock - and they'll say Java 1 2014
there'll be another slide that has that
information on it as well alright so
let's get started a quick intro and to
Spock first let's talk about what it's
solving it's bringing together some of
the best practices if you will in the
testing arena so our spec added some
cool things BDD groovy add some cool
things it brings them all together in
one package one framework and best thing
is it still works within your CD your CI
environment or your within your editor
environment so the whole goal is to
reduce the lines of code to focus on
testing and to provide mocking and I'll
say this I cannot think of a reason why
somebody wouldn't you Spock as their
testing framework it just makes no sense
to me at all other than one reason and
that reason is if you have the need to
test statics there's not a great way to
test static code that is Java static
code from Spock but I beg to ask you a
question
did we not talk about not having global
variables so talk dude I don't write
static code and we're good so so there
is a challenge with that but other than
that you'll see that this the mocking in
here is just phenomenal I don't want to
spend too much time on J unit cuz it'll
distract us but I thought I'd it'd be
worth bringing up some pain points this
is probably what we're used to seeing in
a J unit world see some tricks that we
have some boilerplate code that we have
for testing out exceptions
what's the problem with a unit by itself
well first of all a unit by itself
doesn't come with mocking he end up
having to go somewhere else and the cool
kids in the purely Java world are
probably using J market Makita power
mocks those be the three that probably
stand out so what are the pain points
besides the fact that doesn't come with
mocking you have to go somewhere else to
get that one thing point is it's pretty
verbose in fact here's the challenge
that you have you do a ton of setup
within your test and then you invoke
some kind of assertion and then you're
left with the question I want to know if
if another state change is possible as
well so I want to assert one more thing
and the question I'm left with is do I
assert a second or third thing within
that test or do I copy and paste that
code into another test and then assert
their right I'm often left with that
that challenge and it's it's frustrating
in fact that's one area where Kent Beck
mentions that do not repeat yourself as
a is probably an anti-pattern
where you probably do want to repeat
yourself then testing and so we get
these wordy type things it's very
verbose it's very repetitious constant
repeating of code and then it leads to
this
it's refactoring nightmare all of a
sudden you spend your entire world
refactoring unit tests instead of
actually doing more code more
functionality and so we're left with
some challenges right so we're hoping to
solve these challenges let's start
talking about groovy
what does groovy bring to the table the
first it comes with the GDK it comes
with groovy test case within it and I'd
say there is one thing about groovy that
is super amazing that it brings to the
table and that's this the groovy power
assert what is the first thing that an
individual will do a developer would do
when a failure occurs they will probably
set it up in there editor and they will
probably rerun it and they'll probably
stop right where the problem occurred
and the whole point is to gain context I
need to understand what are the inputs
that cause this challenge the beautiful
part of
groovy is it has this power suit which
has been there for a very long time now
and anything that's an object has a
two-string called on it and if you had
an intelligent to string on this it
would have been something intelligently
typed out so this is an object to
calculate we have a function that
returns 20 point 0 which obviously
doesn't equal 25 point 0 and we have the
inputs going in and oftentimes when I'm
using Spock or groovy testing my Java
code I don't even need to bring it up in
an editor I'm that productive because
the context of things is already evident
it's self-evident so this is a beautiful
thing that we get for free because Spock
is a groovy tool so we get some clarity
we promote the whole idea of groovy is
to increase productivity yada yada yada
let's talk Spock Spock is a tool that
builds in a it allows us to write code
in a certain way and run it in a
different way which I'm it totally
sounds foreign especially if you're a
Java developer and you're used to
looking at code and it executes in
exactly the same function as you wrote
it the same way the same order and we're
gonna talk about the advantage of that
and it may seem foreign but we're gonna
demystify that because this talks on the
advanced side it will run in your IDE or
your CI and it is using the J unit
Runner so the J unit Runner built within
Spock is called Sputnik I know it should
be the enterprise but it's called
Sputnik and that's the J unit runner
that's running it so anywhere you use J
unit you can use this you just add it in
there is one challenge that if you are
one of those lucky folks you're lucky
teams that it's decided to use test for
J that's it test ng thank you that's the
one I was looking for if you're looking
if you use test ng there's a problem
this is a J unit thing and the challenge
you have has nothing to do with Spock it
has to do with the fact that Jay J unit
and test and G do not work well together
you know there's ways of setting that up
and if you want details to it send me an
email or a tweet and I can help you with
it ever in an article on how to do that
it's not a big deal but they will be two
separate runs of tests because that's an
issue with J unit and test in G alright
so let's look at the taxonomy of a spec
the first
is is that we are going to write
something that extends a specification I
will start using this word in fact we're
using a spec it's very much like a test
case in the j-unit world and we're going
to talk about these different features
or functions that can go within that
body of code so we have a class that is
a specification the things that can go
within that if you create a field level
variable you can imagine that that gets
reinitialized every time a test runs so
it looks foreign to you because it's an
object that was created at the class
time but it be reinitialized for every
run of the test so you want to think set
up at that point and in fact it's
usually throws people off enough that I
avoid it but that's that's the life
cycle that it runs within it is possible
to share if you have a very expensive
object it is possible to share that and
there's an annotation built within Spock
for doing that it's called shared so
that's very simple and you can think
setup spec so the lifecycle that you
should become familiar with is set up
clean up set up spec and clean up spec
and it works in this order if we had two
tests I'm gonna eventually call those
features we were going to set up spec
set up run a test clean up set up tests
to clean up clean up spec so that's the
order of things and it shouldn't be too
far into those in here I hope now the
first thing that becomes really foreign
to the java i as we're writing groovy
and our method name is a string now what
if you're writing this purely in a java
world and you're running a BDD - what
would you do well you'd probably use
something like J behave and then J
behave world you'd have a function
following all the normal rules that Java
has which means it's not a string and
then you'd have an annotation on that
and then some string inside of there
that describes what that's doing and we
get rid of all of that boiler plated
stuff and we just say the string is the
function name that's what we commonly do
and then there's some there's some
additional features here on the advanced
side we'll talk about a little bit later
but that is the feature test and it's
just like a test would be within a test
case of a J unit so let's go into the
blacks of the blocks of code that go
right here within
this function and they look like this
these are your your options these are
the words that you can use and it's more
of a DSL type thing so the common words
that go together is given when then so
given something
when this occurs then this the other
word that might be useful is expect the
way to demystify that as there's two
options here is when is a stimulus on
something and then it's my expected
result when the stimulus and the
expected result come roughly at the same
time then you would use expect so expect
does not have two other words that go
with it when and then go together expect
is by itself we'll talk about the where
in just a second the end the end is just
eye candy it's nothing more than eye
candy there's multiple places you could
use it one place you could use it to say
given x equals two and y equals three
that's one place you could use and the
other place you could use and is given
when then set some expectation and some
other expectation is just eye candy it's
it's just useful to you as a human to be
able to read it that's it
setup is the same thing as an alias for
given and both of those are optional
let's look at code so starting out with
a block of code we can use these are two
of the same example on the same slide we
could use setup or we could say given
we're going to create an instance of a
stack and we're going to create a string
variable so given this or setup that by
the way I'll often call these blocks
because the internal code to Spock calls
these blocks there are blocks of code
this is the setup block if we were to
complete the previous slide they feature
tests it might include something like
this when I push a string into a stack
then I expect something now this
expectation we we have to take one more
step back for my job of friends in the
groovy world we have something called
the Ruby truth right
in the java world you might find
yourself writing this line of code a lot
if a collection is not equal to null and
the size of the collection is greater
than zero then that line of code in the
groovy world is if collection it's an
abbreviation so it's considered to be
the groovy truth if you're in the
JavaScript world we have the same thing
we understand the groovy truth I'm sorry
we have a truth with truth e we have
truth and truth e so it's very much the
same as we have within the JavaScript
world it's the truth eNOS so in this
case I could have said hey it's not
empty or the size equals one these are
three assertions what what is the thing
you do not see what's missing from this
slide if we were to consider this slide
and this slide as being a full-featured
test the thing that's missing is we
don't even assert anything because
everything it's in the then body is
expected to be asserted so we've just
abbreviate code you could write the word
assert if you'd like but it's done for
you it's automatic so we can start to
reduce the amount of code that we see
taking a look at some other options here
I could do a pop and I have a couple of
different ways I can handle exceptions
the first is I have a function within a
specification called thrown it will
provide back to you something that was
thrown in which case you can inspect its
internal state which is a useful thing
you could also say that this was thrown
so those are two different ways of
handling an exception within a test if
that's what you're after there's
actually a third or fourth way in fact
within Spock but these are the most
common way to handle the exception now I
don't know why this is true but the fact
remains that in a hash map within Java
it's possible to have a null as a key so
you may want to check for the absence of
an exception being thrown now I don't
know how many things you want to check
the absence of because I could get
somewhat verbose but it's pretty cool if
within your API you want to assert that
something did not happen and in this
case that an exception was not thrown it
is possible within Spock we're going to
get to mocking in much more detail later
but the first slide on
looks like this if I'm gonna create a
mock first of all it's built within
Spock it's automatically there it just
exists so we have a subscriber one which
is a mock of subscriber we create two
subscribers I create a publisher I add
the Box to the publisher I do a fire and
then we'll talk about this but I have a
way of describing things and I'll talk
more detail on mocks in just a second
just wanted to give you an idea of
what's possible the last part is that we
can do a cleanup and there's actually
some annotations in here to do Auto
cleanups which I'll show you later as
well but there is a the the cleanup is
expected to be the last block of code
within that feature and then we have a
we're body of code once again I'm going
to show more detail on this but this is
a data-driven test whenever you use the
word where it indicates that you are
gonna create more than one test on the
beauty of this is that can write code
one way I can write it as if I'm writing
it for one test I can assert multiple
times but each assertion is in its own
test
it's very separate in other words if I
have a failure in element 0 I still will
test element 1 ok each one is in a
separate test and that's an important
fact we'll talk a lot more about
data-driven
as we get into some code features and
then we're left with another challenge
which is what if I need to assert
something multiple times I have a number
of tests that I'm gonna be running it is
possible to create a helper function if
you create the helper function where I'm
gonna use this multiple times in a
feature test I can do one of two things
one is I can return the groovy truth
which is what you see in this particular
code base or you can assert each element
the challenge here if I if I just pass
back the groovy truth I may get less
information and I may have to hunt that
down because it won't show up in the
power cert if I if I do this then I'll
know exactly what the failure was
because the power assert will tell me so
those are two different things that can
be added I don't commonly use this
helper but you know you know code base
where you have a lot of tests going on
and you have some repetition and your
assertions that might be useful so let's
break into code
so first of all I have this as I
mentioned in the Spock Java 1 2014 out
on github the other is it's completely
grade alized my groovy friends right so
all you need to do is say Gradle W idea
and it will create your IntelliJ
environment or eclipse it'll create your
Eclipse environment or build and it will
build everything it'll pull all
artifacts that it needs down and build
everything and then test everything so
that's the magic of well if I did a
clean it would look more impressive
right so there's a full rebuild of
everything and all the tests running
that again it's not that interesting
other though it does get you up and
running very quickly let's jump to some
code real quick first of all as I
mentioned the code that we have here is
a simple Java class and if I were to
jump into this simple interest
calculator you'll see that again it's
it's simple it doesn't do a whole lot
notice a couple of things there's no
constructor to find that's a useful
thing to know for the examples that
we're going to talk about and there's
just some really simple logic okay so
let's jump out and start testing this
thing the first thing is is that we're
going to be given something and I'm
showing you an annotation that comes
right out of Spock which is this is the
subject of tests so often things get so
verbose within your testing world that
it's hard to figure out what is it that
you are actually interested in now it's
nothing more than I can D and it might
help a developer find the thing that
you're most interested in
however one of the things that is
lacking within the Spock toolkit or our
framework is Peter really really is
interested in better reports than we
have for j-unit so there will be
reporting which will report this subject
in a special way within that report so
just be aware of that as we move forward
so I create an instance of the simple
interest calculator I make an assignment
of the rate and then I have an
expectation so I said given expect you
even expect means that add expect a
stimulus was applied and R is
was expected so I'm actually doing a
cert on that if I were to change this
value to something that would be off and
say run we would have our PowerSearch
filler it's always dangerous demo gods
it's always dangerous all right so we
have a failure over here we can see that
well you do have a power cert and
clearly 100 point zero does not equal
1000 point zero so our power cert tells
us exactly what a failure is let me undo
that and look at some other options okay
now in this particular case I've added a
wear body as I mentioned the wear is is
a data-driven thing but in this
particular case I just made it the
assignment now to my java friends don't
be scared all right but if you don't
define the variable something really
interesting happens right IntelliJ knows
I'm using I'm using a dynamic language
in a dynamic language things could just
like materialize at runtime you just
don't know so if this were Java there
would be a little red squiggly and the
Clippy would come out and say hey idiot
this is not gonna work for you it's not
gonna compile but it doesn't know so
it's kind of like saying well I don't
see it but maybe that's that's what the
underline means it's like maybe so the
question now remaining is how is it that
my variables are being defined after
things and the thing to know about
groovy is that it uses in fact it's my
understanding is that it's the best
example of AST transformations within
the groovy space so we actually take an
abstract tree and we reorder things at
compile-time and run-time and that
allows us to do some interesting tricks
so in this particular case I see an
assignment where I have interest equals
some value and though the same value is
I used before so there's nothing
terribly impressive here outside of this
I could say show off some VARs right
show off maybe the
yeah come on yeah I'll show it in the
unroll in the second we go to the next
step we have the wear body in this
particular case I'm no longer saying it
equals something I'm actually have this
overloaded operator in groovy we can
have overloaded operators so the
question this is why do I not make the
assignment I'm not wanting to assign to
the array of things I want the value out
of each element to be inserted into that
variable in this particular case I'm
creating two things I'm creating two
tests to be run if I were to run this
test notice a couple of things first of
all I've used this special annotation
called unroll the unroll within Spock
says to unroll this test if I were not
to unroll it the whole test would be
reported as one like no matter how many
are listed there so in this case I have
to it would be reported as one but I can
unroll it now what does the unroll
really do it's just it's just a thing
for reporting that's it it does work
with the editor and it does work with J
unit reports so let's go ahead and run
this and see what the results are again
you can see a couple of things first of
all when I'm using the unroll here
I said unroll and then I used the
variables that were defying down here
and in the unroll I can see that I did
in a knit here I'm sorry I have an
integer here an integer here an amount
here at a year here so I can have a
report of the variables that are being
used within the test what if I didn't
have that well then it would look more
like this and it would say showing off
VARs list in calc zero and one would
look like what you have down here now so
I can give meaningful values out as part
of the report if I like but once again
if I were to just kill it and run I
would just see one thing if I had a
failure showing off this is the one
right here if I had a failure in here
and ran I would still see one test but I
would see one power assert the power
cert would give away where the failure
is now the beautiful part is if I had
two failures I would have to power certs
but I would see one read does everybody
get the unroll it's not that significant
but that's what its value is it's pretty
cool all right
now if we're going to go to all the
trouble of creating where it might make
more sense to create a table it's in
this particular case I can create a
table or the header of the table or the
variables that I want to find and the
rows of the table of the number of times
I want to test created all right it's
pretty cool not only that I can have and
sell within the table be a calculator
itself so that's what I see right here
is I have some value that's being
calculated ten times ten is a hundred
and gets replaced within the amount for
the second test that's being run there
as I mentioned there's another way of
handling exceptions and so I have an
exception you could just say it fails
with this and that's a simple way of
doing it
notice I have no where body here or I'm
sorry given body there's no given I just
expect this now there's an extended
feature it's not built completely within
spock the features to use it are there
you need to include some more libraries
which is the hamcrest libraries so
sometimes when I am interviewing Java
folks I will ask them this question tell
me what 2.0 - 1.1 is because I like to
have a conversation with Java developers
I don't actually care that you know the
answer well I want to have a
conversation about precision and the
answer actually is point eight nine nine
nine nine nine nine so sometimes you get
a calculation like that based on the I
Triple E standard and you still want to
test but I don't really know so what I
can do with hamcrest is I can say you
know what I want you to subtract 2.0
from one point well I'm sorry one point
one from two point zero and it should be
close to 0.9 within point zero one of it
and that's what hamcrest does so and
this is how you would do that within
spock is that I set up a simple interest
calculator and I say that's the
calculation subtracts this value and
it's close to that so I find that people
seem to be interested in that and I show
it off one other thing I failed to
mention is here I have a simple interest
calculator I have a rate defined here
and it looks like a constructor but
within
I'm sorry within groovy we have the
ability to be short-handed a number of
times in this particular case under the
covers it creates a new instance an
instance of the simple interest
calculator and then it sets the rate so
there's no magic happening but we can do
a lot of shorthand with in groovy so be
aware of that that's the thing that
might catch you a little bit if you're
new to it you see if I did it okay
impressed okay cool so we got through
talking about calculations and some of
the basics let's talk a little bit
deeper and I'll get into another demo
something that's a little bit more
foreign so the first is is we have
you've already seen thrown and not
thrown but we also have old and with and
those can be super fun and they become
more you become more aware of what they
do when you actually see them in action
so I'll show you some code in a second
we do have the ability to document
things in a BDD style so you could say
title narrative issues you have
annotations that are built within Spock
to help you manage those details
I see people either like or dislike
doing that it's up to you
of all of these I think issue becomes
the one people might like like the most
if they if they ignore the rest Oh some
of my favorites
now there's a challenge Spock currently
is point one snapshot that is not in the
maven central repo so you have to go to
a separate repo by the way clearly it's
in my build scripts that you will have
so you'll be able to see where that's at
but the point is is that this is not in
what people tend to use in production is
maven central but these require requires
is super cool I'm going to show you an
example in a second but it's essentially
a stating that this tests in order to
run it you require something like what
if it requires that you are on Windows
what if it requires that you're on Java
8 what if it require that you can go
through the list right now the beautiful
part with this is a very common we're at
a really interesting point in time again
right the last time I remember this was
Java 5 where he had huge language
changes in the JDK and what happened was
this people would create Java for stuff
and below and then they had
but Java 5 repository that usually
LinkedIn in some way but they separated
their tests out because it's problematic
because I need a Java 5 in order to run
these things but we have a dynamic
language and one of the things that we
can do is we can use the requires and if
it's not running on Java 8 you just
won't run that test which means it
doesn't need to compile that part
because it's dynamically run all right
how cool is that so I'll show you an
example it's super great all right we do
have unroll we've seen that there is
something called auto cleanup auto
cleanup will automatically call closed
on whatever it's annotated so if you've
annotated some object you're using
within your test it will close it if
it's if closed is not the right function
then you could tell it what function to
use and you can tell it to be quiet
right you'd be quiet
which means if there is a failure on
close you don't care that's essentially
what you're saying and we have some
timeouts of some other things with
concurrency but sometimes that's useful
let's look at old and with all right so
let's jump into code again now old is
interesting right first of all to my for
my Java friends this is the short-handed
way and groovy to create an ArrayList I
realize you don't see it but none of the
covers an ArrayList is created so I'm
creating an instance of an ArrayList and
I'm adding a four so there's three
elements there I'm adding a fourth and
I'm saying then if I've added a fourth
element to an array list in the size
obviously is four but I can also say
that the old size of that was three yeah
so sometimes you don't really care you
just want to know state changed and you
want to say hey I've got a hashmap and
I've set the value of the example which
is the key in a map to this value I
establish a new value to that key and
all i care is that the current example
key within this map is not equal to the
old one i just want to know the key
changed that's it yeah how does it do it
that's magic I can talk about it later
on probably but it's it's just the fact
that Spock has taken ownership over the
whole execution of of this path so we
can establish the state of things prior
to and that that function tells it to
establish that state
and it's actually relatively simple when
you get into it I know it seems mystical
now whoops
obviously this changes slides not that
code alright this is just an example of
with sometimes you may do multiple
things on a given object all I'm saying
here is after creating an instance of an
account I want to say with this account
this values that and this value is that
now this could be used as you see here
as an assertion by the way you see with
but each line within here is its
separate assertion so there's a power
assert for each one of those which is
super cool the second thing to note is
sometimes when we get when we get into
mocking sometimes you want to establish
some behavior with a with a mock like
multiple functions that should be called
and it is also possible to use with with
that and that's where I see it most
often used in fact all right so there's
an example of the width operator all
right and as I mentioned one of the
earliest books that I that I've known
that I knew at the time on Java 8 was my
friend Venkat and so when when I was
reading this book and doing a tech
review I took one of his examples and I
wrote it in this test now what's awesome
about this the reason I even wrote this
is that kind I got in an argument with
my scholar friends and they were telling
me how much better Scala tests are then
groovy tests and I said oh yeah and this
is an example of why a dynamic language
is really cool right is that this
actually doesn't cause any compilation
or problems when I am running on a Java
7 platform it just doesn't run the test
if I'm running on a Java 8 platform then
it runs these two things are just
opposites of each other it either
requires the JVM Java 8 or it ignores it
if it's not Java 8 but I can do that
with OS Windows OS Linux now all of a
sudden I could have one code base with
one set of tests they all have different
platforms specific things in it and when
I have it my CI environment go out to
multiple platforms different tests will
actually run if that's what you're doing
right super-powerful good stuff all
right
see where I'm at that's 4 5 ok and then
the last one on this particular subject
working it into mocking what
here is an example of a specification
where I've used annotations which I call
fast and slow in this particular case
the annotations are literally they're
created by me
they're your own annotations so these
are not within Spock these are just
things that you created in this case I
created it it is at runtime but I can
discover them at runtime so I've created
a fast and I have a fast and I have a
slow and if I go in now and they say
yeah I want to run the fast and slow
spec you'll see as the example here that
we'll have an air of course demo gods
all right all right we'll hunt that down
later and maybe we'll see if we can get
it to work but let's just talk through
it it is possible it's just not finding
it my environment I don't know why yet
but it is possible to have something
called a Spock config in the Spock
config I can configure the runner and in
this particular case I could say exclude
the annotation slow I can also use reg X
and say you know I don't even have to
use an annotation I can just say here's
the things I want you to exclude and you
can multiple lines of that so I can
create two different CI environments in
fact in which case one is my smoke tests
where I'm running on my fast tests and
assuming that passes then I'll go to my
long-running test so if I wanted to
change
I do nothing more than I say yeah now I
want you to run all my fast tests and if
this were working then then when you see
a whole different set of tests that
would actually run versus not run
there's a there's additional detail here
but usually showing off this Spock
config is pretty cool just with the
exclusion factor all right let me see if
I could just why is it bugging me so
much why can't I let it go I don't know
what's it
oh man
pear coding does work that's a good hi
all right so here we have two tests that
ran if you see down here I have a list
of these this this test in this test we
have two if I back out and go to my
config I can switch out to slow if I
spell it right and run again it's a
whole different set of tests that run in
this case I ran three okay so I can
control what's running with with the
same code base I can just change what's
running based on a config it's good
stuff all right
oh okay so I have this comment down here
if you can handle it
how many groovy friends do I have in
here that's enough all right okay Java
guys just gals just turn your heads
don't ignore okay but this is the
Advanced section so I might as well
right first of all I have to find it but
I do have something called a table of
closure now since you already know the
where body what I have here is the
ability to actually establish a closure
within the cell of a table I'm not
suggesting that you do it I'm just
suggesting it's possible so here what
you see is I have a whene then and aware
where the where has an example let's
step through it real quick maybe we can
make sense of at least one run of this
remember this is the variable is the
example so somewhere up here is this
example right here this was test so we
replaced the e with an A so we should
have a TAS T which is the value I then
check dot call well the check is here so
this is the field level variable of this
table is this where I invoke a function
out of the table and I just to make sure
that that that it which is the string
contains an A which is the value of what
was replaced right we can get more hairy
than that obviously that's not a goal
right
so what is possible here is is some
pretty amazing stuff you have total
flexibility in the groovy world
I'm not saying again to off you skate
your tests though so you want to be
careful with this right just saying just
want to reveal what's possible and then
let let you guys run around with knives
sharp alright alright let's talk about
the need to fake it well what are we
talking about why do we fake it well
there's a couple of things the biggest
thing here is that now first of all I'll
state this there's a bunch of j-unit
testers or test enthusiasts that do not
believe in mocking in fact the creation
of a group we call MacOS the MCUs
actually believe that you should use as
much of the production code as possible
whenever you're testing that is kind of
their belief system the behavior list
came out of that group which is a weird
thing to say it's like a religion right
the behaviorist group actually thinks
it's actually there's some value in
isolating tests and that's what we're
going to talk about is the ability to
isolate a test down to one thing that
we're interested in we can also increase
testing performance because because why
because the biggest pain point of a CI
environment is tests and the biggest
point pain point almost always is the
serialization of data the
reestablishment of data and and I've
seen tests that actually take 5 hours to
run that's terrible right but I've seen
it so those are the things that we're
trying to combat there is a great
article that I'm not going to go into
much detail here but mocks are not stubs
Martin Fowler is known for this and
we're gonna delineate three different
styles of mocking we actually have mocks
stubs and spies the terminology that
I'll use will come out of this book so
it's worth reading it's a fantastic book
it's probably getting dated by now but
it's still what we use today all right
let's see how long you can stare at that
let's talk about doubles the first thing
is that we have these dummies there's a
need to create dummies how often have
you used a
test within the web world where you
needed an httpservletrequest object and
why did you need it because the
framework required you to have it you
didn't need it for any other reason
you just had to satisfy an API and in
this case we're just gonna call him
dummy so there's a time where we just
need some dummy we're gonna toss it in
there the next thing that we have is
something called fakes the fakes that we
tend to have typically are in memory
databases it's not production it's close
to production it gives us more value
that I'm using a database but there's a
difference between using a new memory
database and Oracle and sometimes which
I have run across this you will discover
that outside of your test environment
right because that's where you will be
when you finally hit now notice a couple
of things whenever I'm testing one of
the things that you should be discussing
or what are the things I'm not testing
so in my CI environment I usually am not
testing my production database some
places they do but almost nobody tests
their topology so there's always
something you're not testing that you
will discover in the next environment
where it's required the other two things
that we want to talk about beyond fakes
is stubs which is I just want canned
answers if I pass in a servlet request
object it may be asked a question like
does it contain this parameter and I
just wanted to respond with something
just don't be null right that's
essentially what we're saying with the
stub and the biggest difference between
in the Spock world between a stub and a
mock is that you typically want to
assert that a mock did something
specific whereas in a stub it's just
needed to satisfy some requirement you
don't care about its interaction so much
and in fact the model of mocking tends
to look like this no matter what tools
that you're using you tend to establish
a recipe this is the order of execution
that I expect I then have a point of
demarcation where I say okay I'm done
recording stuff you're about to get
invoked by the real object and then I
invoke the real object and then I test
and verify whether that recipe was
followed that's the standard approach
for handling mocks so let's look at that
in
in spock when we're using dummies
usually the developer is creating it or
built within spock is a thing called up
genesis shouldn't say it's built within
and it's used within it so up Genesis is
a project which is leveraged by Spock
which creates dummy objects for you it
is also used within the stubs fakes we
don't actually solve that problem within
Spock so that's another area where
there's there's no value within Spock
other than mocking things out so we've
talked about some of the classics and
the mocks so let's talk about mocking it
within Spock itself the first is that we
have a Spock mock we can go into the
details but you'll see that there are
three parameters we tend to use what the
three objects we're talking about mocks
stubs and spies so we have true true and
zero an old response so we don't expect
you to give back an object if you're
mocking unless I tell you to if an oval
occurs it's because I did not program it
correctly the true is a verification and
the second true is to use of Genesis
when we're using a stub we do not want
verification so the biggest difference
between a mock and a stub literally
within Spock is that we do not use a
verification on a stub where we do on a
mock we do use of Genesis and we do
expect you to create a dummy response
where none is provided from a mock
unless provided by the developer and the
last is a spy and in this particular
case I have mixed feelings about whether
I like spies or not well I started
teaching Spock I don't know a few years
ago and the common question that I would
get all the time is can I do partial
mocks well this is what this this
enables partial mocks what do we mean it
means that I have an object for which I
actually want the behavior of that
object except for this piece and what I
would say is maybe you should be looking
at your design all right but that said I
have an example that we're gonna look at
so maybe it'll make sense so let's talk
J mock easy mock and Spock so I had a
separate code base by the way this is
this isn't a separate code base it is
also up on github what you see here is J
mock J mock oh my goodness
I want to I want to a mocked warehouse
and I expect once I have some string
that equals a function I have to if I
refactor the function I have to refactor
the string the bad stuff right it's it's
verbose as I mentioned before here's the
expectation so here's the recipe here's
when I say get me a proxy that's the
point of demarcation now I'm verifying
that I actually invoke the thing the
right way I
code base by the way exactly at a Martin
Fowler's example so you'll this is I
just wanted to show his example and what
it would look like in Spock so this is
what it would look like with J mock this
is what it would look like with easy
mark now ease mock takes us so step
further which is cool right I don't have
those strings that mean functions I
actually can great create an interface
I'm using the warehouse class and so now
when I say has inventory I can invoke
that on an interface and when every fact
or something the code refactor is is
super cool that's awesome we can see
that on my point of demarcation I have
an expectation set up I have the
exercise okay and then I have the
verification so the order of things is
still roughly the same ezybox certainly
is a better and easier mock but you have
to get into this creative control and
give me a proxy I have this kind of
thing right where I have expect this and
return something I have an order of
things I have an API to figure out I
have a separate API to figure out so
let's look at the same example within
Spock we have with Spock is that I'm
going to create an order of course the
Talisker we could go with McCowan if you
like so I have an order in the warehouse
I say fill and I have a then body and I
say one time the warehouse will be
called with has inventory of Talisker 50
and return true on that so we have
overloaded operators the shift right
operator because we're always shifting a
bit to the right in Java for some reason
that operator is to use here to say I
have a return so I don't have a new API
to know there's a couple of new
operators to figure out but there's no
API that's in my way at all now the cool
part is is wait a minute don't I have to
set a recipe and then don't I have to
assert that we just do all that magic
for you since you have to describe it
anyway we - we'll just say we're going
to assert the thing we're describing and
so in the their body I'm sorry the then
body we've established that one time
this warehouse will be called it will
our has inventory will be called and
we'll return true and one time we'll
remove something and then we have this
and again right then and so for me
personally I tend to use the and this
way I like to separate my behavioral
things for my stateful things so you'll
see in my code that I commonly do that I
have some behavior that I'm expecting
and here's a state change that was also
expected some things to note about how
this is written because I want to dive
in much deeper on mocks the first thing
is I am not guaranteeing order at all in
the previous examples with jae bok and
with easy mock the order does matter
it's recording things and the order that
you wrote it is the order of expectation
there are times when that's useful
unnecessary but there are times when
that gets in the way it's just extra
overhead you don't care the philosophy
and the Spock world is that we don't
care unless you do and if you do care
then you have to annotate that and we're
gonna see that in a second all right so
we've got a few more minutes what's oh
let me go a woman step further what if
you decide you don't care about
something so in this case I am going to
fill an order and I say that the
warehouse has inventory will be called
once with 51 because that's passed but I
don't care if it's Talisker McCowan Obon
I don't care so I can actually use the
underscore the underscore the underbar
within Spock main it's a wild card it's
just anything anything's good and in
fact any objects good so you want to be
careful about using that it still
returns false and what we're saying here
is 0 times the remove should be called
so if we cannot fulfill the order
because it doesn't have the inventory
then this should never be called I can't
actually assert that a function was not
called with any values at all and I can
also check that an order is not filled
using
the groovy truth at this point alright
let's take it up a notch mus which code
again oops
you'd think I'd learn it's a nice seven
there we go oh I forgot one thing we're
gonna dive into it now and then I'll
switch to box alright remember the
simple interest calculator you would
there are things here you would never do
in production right the thing you would
never do in production is you would
never create a table on the fly like I'm
doing here no it's useful because this
test will run on your platform right so
I'm creating a table with data but here
I'm using sequel this is a JDBC
connection in groovy by the way where I
get the Rose and I select the year
interest and amount from calculus
calculator which is setup up here and I
can actually grab the tuple back and the
tuple will become the variables and the
point is is that the number of rows in
the database become the number of tests
that will run oh yeah now I've got a
next group in here some people are in
here who have already been bitten by a
database having corrupt data and having
to fight that they're going that's
stupid and there's another group in here
going haha that's cool
so just respect each other right we're
all friends now it is possible to create
your own custom data provider and it's
super simple the only thing you need to
do you need to create something that
implements the iterator that's it so I
have an example of that let me jump to
this code base and if we look here
you'll see that I have something super
simple it is something that implements
an iterator so it just returns back the
next collection of data the next array
list in this particular case I haven't
even implemented a whole lot here it's
just a list now here's the beautiful
part what if this was reading a CSV file
or an XML file could easily do that
return back the use an iterator and
return back the values that you want and
then it would look something like this
this is using that simple interest cop
data provider where I've pulled out the
year the interest and the amount and
this runs just the same way as the
database did right super cool stuff
all right let's get into some mocks yep
all right
let's go to our publisher now a couple
of things here the first is I have
options right we've got to have those
that way we can all write different
style code I can either death a
subscriber one and say that I want to
mock an interface or I could say
subscriber subscriber two equals a mock
at runtime those are the same thing at
runtime Spock will discover that I'm
trying to mock something it will look at
the left hand side and create an
instance of that thing and in the other
example it just it's passed in it knows
what tamaak so both of those are valid
code code solutions it is expecting an
interface though if you were to put in a
concrete class because that's what you
want to mock it would fail and it would
fail and I give you this this this
exception and it would basically say hey
if you want to do this you need to add
in oh boy
I can't think all right well there's
that there's there's a oh I apologize
there's that there's a certain thing to
add into the class path in order to make
that work and in fact it's gonna eat me
up so let's go find it let's go to the
build.gradle you need CG lib all right
so it will basically tell you that it'll
say CG lib needs to be here if you want
to do this so one you should do
interfaces and probably that's the right
way to go but if you find yourself in a
jam and you need to implement a mock on
a concrete class it is possible if you
add CG lib to the library to the class
path that's it magic happens all right
then you can have mocking all right
let's jump back to our code base in this
particular case I'm creating a publisher
I'm saying fire I say then this then
that hmm now here's where order starts
the matter if I work to say this order
doesn't matter and as long as one was
fired and the other was fired we're good
in this particular case because I said
then then the first one has to occur
first and then the second master
so this is a case where you would see
then then and it guarantees quarter
sometimes it's very useful to guarantee
order and I'll show you an example as we
get later on in this code base now for
my group Java friends in the back
somewhere this is how you can add things
to a a collection in groovy so this is
just nothing more than asserting
inserting something into a collection I
can fire an event here's where things
get really cool I can actually say that
this will be called and it will be
called with something that's not null as
long as it's not in all I don't care I'm
good here I can say I can pass in a
closure
oh my Java friends I'm sorry you have it
now in Java eight though in that cool
we're saying that we have some value
that's passed in and this is a function
that will be invoked on the object
that's passed in and we will make sure
that the object has a function called
contains and it will return true that it
contains Eve in this case we know it's a
string by the way in this cool like one
of the biggest pain points that people
have with a dynamic language is that
people go crazy with it it's a shiny new
thing so developers start to use it
everywhere and the code starts to get a
little bit squirrely here like what is
this thing you have to have a you have
to read a book right what is it what's
the possibility of this thing what's
great about a test is that it's so
concise I know exactly what it is it's
so easy it's all right here right so
that's huge value so we have two
subscribers in this case I don't care
about order but I'm passing in a closure
to the function of receive now what I
didn't tell you is that it's possible to
on a mock the function actually is a reg
X expression I know right so what we're
saying here is that on subscriber one a
dot R EC function with any other
characters after that is fine it'll be
called once and it won't be known in
this particularly this other function it
will have anything passed to it as long
as it's a string so I don't care what it
is but it has to be a string and there's
some guarantees on that right super cool
look at this then then what am I saying
this is what I expect this test to
invoke and then I never want
anything called on the mock again I can
say any mock with any function zero
times any mock any function in fact it's
completely legitimate spot code to say
that any number of times
any mock could have a function with any
parameter pass that's completely
legitimate spot code and if you ever
write that will shoot you probably it's
not a goal it's not a goal but it is
legitimate code it syntactically correct
alright let's go a little bit further
because we can whoops I actually ran
something that's not exactly what I
wanted since I can use the underbar as a
wild-card on mocks what I'm saying here
is I don't care I just know two of these
things get a receive function so two
mocks will have a receive function
called
in this case actually don't know that so
here's what gets a little bit
challenging what I do know is that a
mock or one or two mocks were called
twice or once each right one of them
could have been called zero times and
this would still pass does everybody
give it that you follow the logic all
right so be careful all right
now we could do this I can go into
subscriber one and say you know what you
when you have an event received method
invoked I want you to throw back an
exception so I will create an exception
that will be thrown but I want to
guarantee that the then here is invoked
I'm making sure that a bad citizen
doesn't kill my collection in this
particular case I actually coded it to
fail I believe so if we were to dive in
and run you will see that this fails
because I'm guaranteeing order so we
have a failure take a look at see what
that failure looks like look at that I
have too few invocations this should
have been called once and I had zero
implications on that I guaranteed that
it should happen at least once and I got
0 how do we fix that well we can't go
into the fire and see that I have a
try-catch block that is surrounding my
iterator so instead I could put the
try-catch block inside the inner
and then all of a sudden we have
something that pass so it's a good way
to verify that you actually wrote good
code alright that was the point that
code might be too small to read and so I
apologize for that all right let's see
you know what I want to add in one
advanced thing really advanced so I'm
gonna move to that now because I only
have a couple minutes all right so the
question is is I want to be able to
extend Spock now there are existing
extensions like having a spring
extension where I can have spring
objects injected in while I'm running so
that exists are gonna you wouldn't need
to create that so we're going to go
ahead and create one ourselves which is
in the code base as I mentioned let's go
to the extensions the first step in
creating this is to create an annotation
you create your own in this particular
case I created something called say on
fail I stole this from zan and I got his
blessings in doing so so I'm giving him
recognition for that I thought it was
super cool all right so we have
something that has a voice we have
something that has a value and we
haven't except an extension now notice
this there is an extension annotation
that extension annotation is a Spock
thing so within my annotation I have
this Spock thing that says hey I'm
extending Spock so pay attention so if
we were to jump into the say on
extension notice that it has an
extension of the abstract annotation
driven extension if I could say all the
words and it is of type say on fail so
whenever we see the annotation say on
fail what will happen is it will be
visited by this extension and if you can
read groovy code it's not too difficult
all we're doing is going through an
iterator and we're going through each if
if it's annotated on the specification
we'll go through each feature of the
specification if it's indicated on a
feature then we'll just do this so we
have two functions in this particular
case this calls this for each function
that's in that particular specification
on that class and all we're doing is we
say we want an interceptor so we
an instance of an interceptor and then
we add the Interceptor to this feature
method so we added an interceptor it's
it so we have an annotation Spock will
see that I have an extension point which
will be looking for that annotation when
it sees the annotation it will then
create an interceptor and it will attach
it to the feature method the only thing
we haven't seen yet is this interceptor
so we'll look at that in just a second
in detail what we need now is a test
that actually runs that so this
particular case we have an exception I'm
sorry we have an annotation say on fail
and let's run it if it should pass and
everything's good let's change it whoops
that's not what I wanted okay what did
you know yeah I got happy all right
so and then let's run it again
nope happen here
oh no not my all right let's do this I
typed one the demo gods are really mad
no option and now we have tests that
talk so that is how simple it is to
extend Spock if you want to create your
own expansions clearly you have
something that very very much feels like
aspect or any programming or I can get
before or after a test runs and do
whatever I want with it if you want to
see the details of that technically it's
in the Interceptor itself so the core of
that is written right here well this
invocation proceed occurred and a
failure causes they say invocation on a
Mac that functions obviously that's not
going to Mac work on your Windows
environment so with that I am one minute
past time there's lots of examples in
here on on leveraging Spock from mocks
standpoint it does use J unit rules I
didn't look at spies but the codes in
there for looking at spies what I have
is a web resource from spring where I
have something that needs to know where
the web inspector II is and then I just
mock that out using a J unit rule for
temporary folders and I add that in and
I've testing the actual resource but
telling it it lives in a different
environment so you might want to take a
look at that and with that hopefully you
enjoyed it I'll answer questions in the
hall thanks</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>