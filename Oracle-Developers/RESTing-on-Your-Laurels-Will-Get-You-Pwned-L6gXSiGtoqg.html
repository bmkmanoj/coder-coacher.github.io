<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>RESTing on Your Laurels Will Get You Pwned | Coder Coacher - Coaching Coders</title><meta content="RESTing on Your Laurels Will Get You Pwned - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Developers/">Oracle Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>RESTing on Your Laurels Will Get You Pwned</b></h2><h5 class="post__date">2015-06-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/L6gXSiGtoqg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thank you very much that's part of the
interactiveness yes we've already
started um so I'm gonna be showing you
stuff and I may expect you guys to
respond when I have questions so they're
gonna be certain hints in the slides
like things will be in bold red and
that'll be a hint oh that might come up
in a question I'm asking in the future
and also it's important for you to know
when you look at your code and look at
your systems to say what do I need to
focus on so it's about time to get
started so are we recording okay thank
you
so I just want to give a little credit
well not a little a lot of credit to my
two other co-presenters who couldn't be
here because one lives in a Spain and
another lives in London and they were so
busy in the costs and everything they
couldn't make it out here but they were
instrumental and helping out with this
talk so Dennis and I we were working
through the XML Dakota exploits and we
figured it out together and then he took
it up to the next level with these
awesome demos which are gonna see then
Alvaro figured out the Xtreme exploits
and he took the demos even further and
he weaponized them and I'll explain that
as we go through the demos but I really
have to give them a lot of credit and
these guys are the best guys that I've
worked with I was very fortunate to work
with both Alvaro Munez and Dennis Cruz
great developers great security
researchers so with that I'm gonna go
ahead and get started so the main point
of today is whenever you're developing
your flexible dynamic awesome whatever
it is component service whatever think
about how it can be abused okay and what
I'm going to show you today is some of
the techniques that attackers the bad
guys are going to use to try to attack
your systems okay so try to keep this in
mind all right so this is kind of a road
map we're not gonna read this slide out
it's basically identifying the causes of
restful abilities we're going to go into
these one by one I'm not going to read
this slide to you but this is so that if
you download the slides later on you
kind of have a road
of what are the common causes of rest
vulnerabilities in your rest
applications all right so this is a
common thing that I've seen when I
reviewed rest applications how many by
the way in the crowd are working on rest
applications can you just Wow awesome
perfect now I'm curious how many have
this architecture so you have a rest
application that sits on the front which
serves as your main interface but then
you also have rest based applications
internally in your network that provides
services does anybody have those oh ok
ok good all right yeah don't worry I'm
not gonna attack you guys I'm just
trying to figure out what it is that you
guys have all right so when an attacker
is looking at attacking your system ok
there are certain things that he's gonna
do first of all he's gonna look at that
open interface and try to vulnerability
in that exposed REST API and what he's
gonna try to do is he's going to either
try to find some type of way of using
that outer point as a launching pad to
your internal back-end rest systems
because everything now is a URL right I
mean all your systems now are accessible
via URL before when you had si PE and
you had all these other back-end systems
they needed all these complex clients
and even complex protocols to talk to
each other right whether it's CORBA or
Oracle you know you need its sequel net
or whatever but now with wrist all you
need is HTTP and a URL and if you find a
way to trick the system the front system
into allowing you to connect into any
other internal network system now you've
got because you only need a URL a way to
attack all those systems systematically
and without much fuss because you just
need HTTP and a URL all right and when
you think about what's running on the
backend systems right you got couch you
got maybe it will Oracle REST API maybe
you've got OData which is Microsoft
sequel servers REST API
for J Mongo alright so let's talk about
the first type of attack which is called
server side request forgery okay and
what it is is attackers will take
advantage of certain vulnerabilities
that allow them to connect to arbitrary
points in your internal network okay one
of them believe it or not is processing
XML does anyone process XML maybe yeah
okay I was gonna say you don't have to
tell me but if you do they can use
something called xx e2 now jump to any
system internally in your internal
network and do it over HTTP or they can
use x XE to iterate through files on the
servers local file system and try to
find things like password configuration
files try to find other sensitive
configuration files that will give them
the credentials they need to access the
backend systems or find out what back in
systems or they can network port scan
the internal network so the main thing
is xx e then you have if you're using
PHP PHP includes you have other rest
specific redirect errs that are
server-side so this isn't something
where I send you a 3-2 302 redirect to
the client and the client redirects this
is all server based where you send a
response to the server the server then
makes a request on your behalf and pulls
that data back and gives it to you ok
and that's where the problem lies all
right so what do you look for when
you're looking at your code to find this
alright so if you're looking for a
situation where the attacker can attack
any system in the backend meaning it can
start just going and port scanning in
finding out which hosts are available
then you're primarily concerned with
redirect errs like the one that example
I gave you at the top here where they
take the URL from the cookie and then
they do a redirect based upon that now
does anyone know why taking values from
the cookie as a URL to redirect to is
bad who can control the cookie a proxy
server that's true
an attacker also can modify the cookies
before they're sent and change that URL
and start iterating your back-end
Network right the cookie is something
that the client has control of the
attacker has control of right okay so if
you parse XML and you do not enable the
secure processing and if your app takes
arbitrary XML and parses it well then
they can do this they can start
attacking your back-end systems and
iterating now one of the things about
back-end systems that I've known with by
working in these large fortune 500
companies is that they have lessened
security requirements because their
quote in the internal data center
sometimes they call it blue net or
something called a green net or whatever
so people think oh because it's behind
the fight second firewall it's safe but
if you're doing that if you're
processing exit XML even and you're not
sitting at a secure processing flag then
attacker can pass an XML with a location
they want to attack and attack you from
the outside all right also does anyone
do NE WS addressing or WS protocols it's
pretty popular in enterprise yes so
again that's another area where if
you're taking XML that's using those
standards they can put arbitrary URLs in
there and start attacking your back-end
systems they can put HTTP 192 168
whatever whatever and start attacking
all the internal hosts from your
internal server or the public server
that's running all the rest requests ok
anybody you have any questions so far
all right so then the next set of
attacks is attacking the back-end server
itself so for example if you're using
nodejs or MongoDB or CouchDB you're
going to have to build up a URL to
connect to it right
and thing is if you concatenate
user-provided data they can change the
URL does anyone know how they can change
the URL what can they what what kind of
meta characters can they pass in to the
URL that's built to actually go up the
URL dot dot slash right then they go up
then you can go slash and do something
else put admin go back down the URL now
now you're hitting MongoDB is admin
interface right ok so that's the other
thing you're gonna look for on your
server code you're gonna look for these
things where they're concatenating into
URLs that are connecting into your
MongoDB into your CouchDB into your
whatever ok alright so what's the second
type of attack in rest-based
vulnerabilities well Lucas at Sir Tony
and Stefano DePalo in 2009 came up with
something called parameter pollution and
I apologize for the people way in the
back I know it might be difficult for
you to see this but there's a URL there
and in the URL there are two request
parameters both named input one says net
input equals over okay ampersand input
equals and that's a sequel injection
string now if there's two of them there
and you have a web application firewall
and then you have your app what these
guys found was that sometimes there'd be
a mismatch so the Web Application
Firewall would look at the first one and
say oh you're not attacking me
everything's okay and put safe but then
your app depending on if it was a tomcat
or if it was WebLogic or whatever will
look at the second one pull that value
and then concatenate it into your sequel
string now the attackers got sequel
injection okay
but with rest this problem becomes
totally expanded okay because now you're
looking at other things
that can be attacked because of rest
okay so and this is where it's gonna be
important where I was talking to before
about listening because we're gonna have
a test your knowledge question next
so in extended eight what I call is
extended HPP because it's not just
parameter pollution but it's also path
pollution so you're not just messing
with parameters like in the previous
case the input but you're messing with
the path itself the URL going up and
down the path okay and to do this you
can use a number of characters like hash
is very similar to - - and sequel
injection this does anyone know a - -
does in sequel injection right it
comments the ending part of the
attackers that the legitimate sequel it
gets rid of that so the attacker can
embed in the front part of the sequel
whatever he wants then he can put a - -
and get rid of all the garbage sequel
that's supposed to be run and execute
any arbitrary sequel that he wants okay
now if you're going to do this in rest
use a hash mark get that gets rid of all
the rest of the the URL stuff that was
at the end and allows you to build your
own URL essentially alright okay so we
talked about dot dot slash that's
another key thing it allows you to
navigate up the URL and then you can add
stuff to come back down we got semicolon
this is kind of a unique one okay so
this is related to matrix parameters so
this might be more advanced stuff in the
rest world but and it's probably not
used a lot but it allows you to again
kind of separate out the URL and get rid
of stuff on the right side then we have
special request parameters so in rest
there is a underscore method request
parameters does anyone know what that
does yes it overrides what yes the verb
so if I was originally making a get rich
Qwest I would put underscore method
equals what to change it to a post post
right yeah see this is this is I'm
trying to get you guys in here all right
all right so remember that okay remember
these things in red all right and then
also for JSON JSON is one of the major
input formats that's submitted to the
server and a lot of times is built using
concatenation so anytime you see
concatenation that's typically a sign of
problems okay so let's go through and
let's look at an example all right now
I'm gonna read this for the people on
back we have the bad guy the hacker and
he is trying to attack this credit info
REST API so if you go to credit info and
you make a get it will return the users
credit info how would an attacker change
that to be able to update it let's say
that the the back ends no so remember
we're dealing with an architecture where
the the hacker can change the URL but
the server is the thing that actually
receives a request and then forwards on
the request to the back-end system right
and let's say that the attacker can
control that URL by adding a parameter
to this credit info back-end call so
what what am I going to use here to
change this from a get to a post
underscore method right remember it was
in the previous line all right all right
so once he does that now he's changed
the request to update his credit info
not just get it alright so let's take a
look so that's that's basically the
answer right so we just all right so
let's let's let's try another example
okay all right so what we're doing up
here is we have a variable dafair
defined called entity and it's getting
from a request parameter entity a
request parameter called
entity and there's an ID variable which
is getting a request parameter ID and
then it's concatenating it into a URL
that is being caught that that the
server that the public rest server is
making a call now into the back-end
server with okay does everybody got that
all right so I'm concatenated entity
into the path and then also taking the
ID and I'm concatenated it as the ID
parameter okay so what what I do to
change the URL so that it's going to the
slash admin instead of slash client I
want it to go to slash admin dot dot
what dot dot slash admin very good and
then now I want to change it to a post
from a get because if you see that URL
it's it's originally I get but I want to
change it into a post to actually do an
admin operation that changes variables
or the state of the rest application the
running rest application so how do I do
that
yes you got it underscore method all
right underscore method equals post and
that's exactly what I do so right here
what I'm passing in for entity is dot
dot slash admin which goes up erases the
client and it comes down to admin and
then I pend underscore method equals
post all right okay yes
so that is true
so so the admin was just basically for
show but it's showing you that okay so
the question was the admin URL is
usually protective and that is true but
but what this is trying to show is that
you can navigate up and down the URL and
you can get to resources that wouldn't
have been expected okay that's a good
question
all right so what's the next problem
with rust well it's very self describing
the wonderful thing about rest is that
it's it's self describing and it's
readable the bad guys can use this to
their advantage
alright so let me ask a question if you
were gonna or if the bad guy was gonna
attack a system and he didn't know what
the system was but he just knew as a
rest system what do you think would be
the first URL he would attack to try to
find out what the heck it is you know am
i attacking couchdb x' rest api am i
touching attacking notes equals api am I
taking solar what URL do you think he
would ask I mean what what URL do you
think he tried first okay you're you're
actually you're probably right in some
cases but it's even easier won't say for
for what what you could you could just
go to the just the host import right
exactly so so here like if you look at
that you just go to host import on the
REST API it's gonna tell you hey I'm
node sequel i'm CouchDB this version go
find some exploits for me oh you know so
you know compare this to you know how
you'd find out in sequel would they
database you're running or you know
trying to find out if you're running
sequel or Oracle or Postgres you know
it's a lot more complicated
alright and no sequel rest APRs are
especially problematic so if you're
running couch if you're running Mongo if
you're running any of these Cassandra
really you know consider this because
look
right now for example with HBase if you
want if you just go to the the host
import of the URL for HBase it gives you
all the tables that are in that database
so in this database for example there's
two tables content and URLs and if you
want to find out the version what do you
think you go to slash version whoa
that's really good if I'm a bad guy I
can find out what version is I can go do
it you know quick CVE search on you know
HBase what vulnerabilities for this
version and then I know what to do to
own the machine all right same thing
about there's so much information all
right you can find out what the table
looks like but just going to slash
schema and the table name alright so the
next problem with rest applications is
that I call it an inbred architecture
but what that means is that remember
that architecture I showed you in the
beginning where you have the public rest
api and then it contacts the internal
rest api s-- that front your systems
like HBase and whatever well let me ask
you something if they're using wrestle
it on the public rest api what do you
think they're using for the rest
framework
on the internal REST API yes wrestle it
and if they're using spring MVC on the
outside what do you think they're using
on this side spring MVC why exactly it's
easier right we don't have time to learn
two different rest api's and frameworks
we want to get our stuff done right so
the problem is once I know what you're
running on the outside then I know
exactly how to attack you on the inside
all right so this is another one where I
want to see if you guys are awake you
see these three roles and for the guys
in back I apologize here it says dub dub
dub svr calm slash view profile question
mark ID equals 1 2 3 4 5 what is wrong
with that yes
okay that's right okay what else I mean
what about some stuff that's been
recently in the news yes
right that's what one guy did right for
18 t he started just iterating through
all the IDs and got a hundred thousand
people's profile information right okay
so what about the next one that one says
dub dub dub server comm slash credit
report question mark user ID equals one
two three - four five - six seven eight
nine what does that look like social
security number whoa not a good idea
right okay how about that a little last
one this is actually blit based on a lot
of real world stuff so you have URL
there is something called find friends
question mark phone underscore numbers
equals what you know four one zero - you
know whatever three three other digits
asks for other digits come on another
phone number what what's wrong with that
yeah well you could you can find certain
people's phone numbers right you just
start iterating through let's say you
know the Washington DC area code you
could find the phone numbers for almost
every single senator and maybe even
Obama in there right okay so think about
these things when you're looking at your
applications so another thing that rest
provides which is very different from
the web world is something called
dynamic URLs so does anyone know what
dynamic URLs are so let's think about it
in that no sequel case when you have a
no sequel database and you have a REST
API for it that means everything about
that database can be controlled through
a URL so normally if you were going to
create a table you would use create
table table name you know I forgot
columns by blah blah blah right but with
a REST API how would you create a table
you have to do it through a URL so what
would you do you'd say HDTV colon slash
slash host com slash what well not
create table just table name new table
name and then what would use this verb
to create post boom you got your new
table okay
now how do you secure something like
that with the way that we've been
securing it we've been using ACLs but
what's wrong with ACLs there once you
put them in there they just kind of stay
there right there's static so let's
let's think about a situation that I'm
talking about so you've got let's say
you've got a Mongo C MongoDB REST API
and you have two databases real-time and
predictive okay and you think you
protected it because you put a ACL in
there and says real-time has only access
to public or whatever and predictive is
you know another level
okay but what is the problem with that
when you're dealing with the REST API
you you've protected these two databases
that's true
but what can you do with that REST API
when you're interfacing with a database
we just talked about it you can create
all these kind of things exactly you can
create new databases you can dot that
slash to go up and down and then create
so how do you do that let's take a look
at this so right now real time and
protective on that database are
protected at real time and predictive
are tech protected then you use dot dot
slash to go up and you go back down
using tests
and you do a post so what does that do
it creates another table called test
right and then you could take advantage
of the functions that are associated
with that table and through expose
through the REST API on test and test is
not protected right if you look at your
ACL the only things that are protected
or real-time and predictive but tests
test is open because you just created it
right so there's there's that problem so
here we're just showing you how to run
arbitrary command on the server side
after you created a table and you've got
this ability to go up and down the path
ok to execute some commands and then get
into JSON alright so let's talk about
rest input interfaces what are the major
inputs to a rest-based API any one JSON
anything else
XML ok so we're gonna focus on XML today
JSON does have some problems and we're
working on that for the next talk but
today we're gonna focus on XML so we
have xml and json and when you think of
xml vulnerabilities is anyone familiar
with xml vulnerabilities what what is
yes any expansion or also called XX e
xml external entity injection all right
and then there's also another one XML
serialization does anyone know what XML
serial is
is so-so serialization so you receive
this XML from somebody and you've got to
now use it in your application which is
maybe Java so it's got to somehow be
converted to Java objects right so
that's what XML serialization is it's
basically converting from XML there's
some object format that your application
can utilize so if your PHP it's got to
be converted to PHP objects your Python
Python objects or Java Java objects
right all right so let's talk a little
bit about xx E is it so I think I hope
everybody can see this but what's
happening is you have an XML with a
special tag at the top under the XML
prologue which is called doctype and it
allows you declare a XML variable okay
and that variable here we defined is y
and we're pointing it to what and anyone
see that what are we pointing this is
the web that XML configuration file
right now what does that do it takes the
what it takes the contents of web down
XML and it what puts it into Y right now
now we have another thing up here we
have the ampersand Y semicolon in the
XML now what does that do it takes the
bout that the the content that was in
the Y variable and it what it expands it
into your XML and that's on the server
side right so now the problem is if that
name attribute is returned back to the
attacker because it says thank you name
your transaction has been processed
right well now what does the attacker
have the contents of the web.xml
exactly all right everybody got that
that's xxxx EE in a nutshell all right
but problem is that developers they are
really great they're they want to make
things so flexible they want to help you
do a lot of
the problem is that this particular
thing allows you to execute arbitrary
system commands in your entities so here
now a report it requires PHP PHP has you
know a history of a lot of problems but
oh I have to give it to the PHP
developers that it's very flexible
but here they're using a expect module
and they're running a system command and
then they're taking the output of the
system command and putting it in the XML
so again if that name comes back you've
got a remote code execution right and
you've got the output yeah hey yeah I
guess yeah you could format the drive
that but most of the bad guys you know
they're gonna want to steal stuff well
they're gonna want to insert a
Metasploit backdoor which is what I'm
going to show today how to use
Metasploit but but the realistic thing
about xxe today is that it's been
patched ok but your individual
applications that you write if they
process xml and they don't set that
secure processing flag they will be open
to this type of attack ok so you guys
need to to really and that secure see
that that set feature secure feature
secure processing true that's what you
want to see in your code all right ok
all right let's talk a little about XML
serialization vulnerabilities because
this is where the fun happens this is
where you can start getting you know
doing some real real damage most rest
api's have to have a way to convert from
xml to objects ok because that's just
how your program runs alright so we
found three problems well actually not
three three ways of serialization one is
where the app in instantiates an object
that's of a specific type then picks the
values from the XML and goes okay I want
to shove them in there okay that's the
safest way then we found other ways
where the app allows you to tell it what
type of object to instantiate populate
the values and then try to cast
- whatever it expects you get a cast
cast exception right but the third is
the one that's the most dangerous which
you tell it what type you want to
instantiate on the server you tell it
what methods you want to execute on that
type you tell it even what values to
pass to those methods alright let's
let's go through something let's talk a
little bit so wait we looked at two
primary libraries extreme and XML
decoder
extreme is one of the most popular XML
serialization libraries out there okay
it's used in everything XML decoder
comes with the JDK itself and it's used
primarily to serialize UI state and your
client-side applications but because
it's there in JDK it's a tempting target
to use when you're developing apps all
right and these two are problematic or
have been problematic so xtreme has been
patched since 1 4 7 and X ml decoder I
heard was patched I haven't verified
that but XML decoder is worse and you
will see why this is kind of hard to see
but maybe maybe when we get to the demo
I will go into the code and show more
details and explain all right you'll see
the code better so one of the things
that we found in wrestle it was if
you're using something called object
representation then inherently you're
using XML decoder so when you look at
your apps and you're using wrestle it
make sure you are not using object
representation because under the covers
it is using XML decoder to serialize and
deserialize
all your XML that's being received from
the requests ok so let's go and let's
let's do a demo here and what we're
gonna do is let me go through and first
oops show you the sample code here
alright so for wrestle it oops
can everybody see this kind of this is
your typical simple app alright so this
is a contact that we want to expose
through the public REST API it's very
simple just has a name last name that's
it
and we have a resource which is
basically our way of getting at this
object and providing an API okay so
forget requests we're going to call this
method get contact and for put requests
on the rest let API we're going to call
update contact alright and if you look
here this should look familiar what
we're doing is we're setting up the rest
lit server to be supporting the HTTP
protocol on 8180 and then we're exposing
the contacts resource that we had up
here the class through slash contacts
okay now when you look at this resource
it receives a contact entity and then
you see this object representation that
is going to inherently use XML decoder
so let's look at the XML here so if I
pass this to the server it's going to
instantiate this item using the know our
default constructor then it's gonna I'm
sorry it's kind of not the know our
default constructor it's going to use
the constructor that requires two
parameters which are a name and a
description to just instantiate your
item object and it does it automatically
as a part of the serialization process
you can't control it
you can't stop it it does it and then
after it creates this object it tries to
cast it to whatever you're trying to
support in your application so this is
another thing you can you can declare
references so it's almost like a
programming language now so here I
declare an item with the knower
constructor
and I set a variable reference called
item and then later on I can reference
that variable reference and I can set
properties on it just like this sample
code here can everybody see that no so
so what I have is I have an object ID
item in the class that that calls the
nor default constructor and then I have
another object where an ID ref the
previous item and I set properties okay
now I can also call methods I just
passed this XML to the server it's gonna
do all this stuff for me and I can call
static methods and chain them together
with instance methods and then pass in
values to those instance methods all
through XML if you look here this is
almost like a programming language in
XML just doesn't have ifs and some of
the other significant stuff but if I
could do this does anyone know how how I
can get code execution from this right
here how can i does anyone know how do
you call a system command in Java what
do you do runtime so you say java.lang
runtime dot what get runtime so here I'm
gonna have java.lang runtime and then
the method I'm gonna have here is get
runtime right that's the static method
then I need to also call another method
to actually execute a system command
which is what exec and I need to pass in
what the command I want to execute on
that server I got everything in here to
do wrong code execution on a rest lip
based rest API right there and if you
look at it actually this is what it did
I mean this is what me and Dennis did so
this just pops a calculator on the
server but you can do a lot more
obviously all right all right so let's
let's take a look a bit more you can you
can make this very you know more
complicated so you can use process
builder to execute arbitrary command you
can write files on the server right
right here yeah that's a little more
complicated because you got to write
every single byte but you can write an
arbitrary
file you can write a class file on the
server and on wrestle it you can
actually change the response dennis put
these then demos together he's awesome
you can change the response so that you
can query the server and access any of
the objects on the server and add them
to the response so for example if i
wanted to dump all of the system
properties that are on the server
that's what i do right for wrestling i
can dump every single system property i
can even create excellent XSS where
there was no XSS with that right alright
so let's take a look at some of this XML
that we're gonna be exploiting today in
the demo so this is what a normal
contact looks like okay right benign but
then for xxe we're gonna pass in that
and for remote code execution we're
gonna run the clock and then we have the
final which is the weaponized version of
this which I'm going to show now which
allows the attacker to put a persistent
backdoor on your server and then start
using the server
whichever way once and connect anytime
all right so let's let's go ahead and
start this up and so what I have is oops
all this stuff got a little messed up
when
so this right here on the left hand side
is the victim machine it is running
wrestling that sample sample application
I showed you what I'm gonna do is I'm
gonna first just run the normal kit use
case okay so let me rearrange this
because it's got all messed up so what
I'm doing is I'm running a curl command
right which is this basically making an
HDTV call and I'm passing that XML file
to this server okay so if I run this you
notice on the left hand side it received
the request and basically inserted that
contact into the database okay now let's
try the remote code execution example
alright and watch the left side
carefully when I execute this what
happened now okay some people say oh
come on you ran a clock on my server who
the hell cares what wait it's it's it's
a little more than clock I just don't
want to I don't want to attack my own
server so I executed an arbitrary
command now now let's talk about
weaponization so alvaro weaponized this
exploit so what I have here is I have
another oops
another vm which is a acting a little
weird here and I apologize for the font
size what I have here on the top this is
an attacker machine I have Metasploit
running and on the bottom I have a HTTP
server running ok so what's gonna happen
is I'm gonna run the command in what
that the way Metasploit works is that
you've got to get the server to execute
a command to connect back to your
Metasploit able jar and pull it down to
their server so that you can run some
commands or some executable code on the
server so you need to get executable
code on the server so the first part of
the exploit is the command to connect
from the server to
my machine that has the jar that's going
to be the the code that I'm going to run
to take over the server so it's going to
pull that down to the server that you're
going to take over then I'm going to
execute another command to run the jar
and when I run the jar it's gonna create
a verse TCP connection back to my
listener the top thing Metasploit and
now give me reverse shell into that
machine okay so up here what I'm doing
on the mess blip machine is I'm setting
up the reverse listener okay and so what
I'm doing is whoops interesting okay so
I set the reverse TCP port and the host
and then I'm gonna do exploit alright so
what's happening now is I have a
listener listening all right now I'm
gonna run the Metasploit or the
interpreter attack and if you watch what
you'll see and let me maybe try to it's
going to be kind of interesting you're
going to want to watch the right-hand
side so when when this attack works it's
going to connect back here in the
right-hand side at the top you're going
to see it respond and also you're going
to see that before that you're going to
see the attack pull the jar file from
the lower bottom so this is my HTTP
server which holds the Met jar that's
the meterpreter executable code that I
want running on the victim server it's
going to pull it from there and then
it's going to create a connection here
so
contact that
okay
this is interesting okay
I was just testing this okay the demo
gods are not working for me today here
let's see okay so the IP address is 126
54 all right and this is connecting here
contact up and that contact out that 106
190 met char 8,000
this is interesting okay I'm sorry
the port it should you should see this
okay what I'm gonna do is I'm gonna kill
this server I'm going to try it again so
I'm going to start the server and this
should be alright so let me kill this
and restart it
XML decoder okay empty reply from server
eighty one eighty okay that's right
contact op met when I to 168 126 54
that's this eighty one eighty and just
that's a good question so so what this
is doing is calling this here so the
first part of the exploit basically
creates a URL class loader pointing to
one six eight so if I look here if I do
I have this should be 192 168 1.9 which
is what it is and then it invokes once
it downloads the jar or loads the jar in
the class loader it calls the class and
executes the code to get reverse shell
but there's some reason it is not
working okay I don't have to move on I
we have another met jar a demo with
Xtreme so hopefully that works all right
so let's talk about extreme alright
Xtreme has something called a dynamic
proxy and it's allows XML to be
serialized to something that allow you
to put code and arbitrarily inject the
code into a
the invocation okay so let's let's go
I'm getting some looks of confusion so
what let's talk about what a dynamic
proxies you have a class okay you have
also an interface what a dynamic proxy
does is allows you to inject some custom
code either before or after the call of
the actual class you want to invoke the
method on the class ok all right so if
an attacker is looking to attack this
this several step he's doing he's
basically fine trying to find out what
kind of XML that he needs 'dearest the
serialized to then he needs to create a
proxy for that class intercept any hooks
replace the original call and then send
the serialized version of the proxy all
right so this is kind of a graphic of
what a dynamic proxy is so that man is
the dynamic proxy and he's trying to be
in the shape of what the server is
expecting but he's got a special
surprise in his pockets when he gets
behind that wall okay all right so this
is what the extreme XML looks like right
that's the normal thing that's the safe
thing but what we send it is this which
execute process builder and calls calc
ok so ok
this demo better work all right let's go
back here let's let's go back to here
and now what I'm going to do is I'm
going to kill this and start up the
extreme server and what I'm gonna do now
is let's just do the let's do the
regular case okay whoops so we're
listening on 8080 this time what the oh
sorry the server still starting up here
okay come on it's still starting up okay
so what that did was basically insert a
contact into the database all right now
let's run a remote code execution on it
now if you look right I'm sorry
we're getting a little ahead of
ourselves here I want to show you the
code so in spring extreme the way that
they work is you define an interface for
the entity that you're going to store
okay then you have an Impala sociated
with that interface which can have JPA
annotations those Jaypee annotations
just tell it how to store the entity and
then you have something called a
controller which like before you have to
tell it what URL it's going to respond
to and then how to get the values out
and also when is it going to respond to
a get versus a post that's all in here
right so here we're responding to a get
we're still pulling a contact out and
here we're saving all right all right so
the the regional contact was here the
exploit is this and there's two types of
exploits so one this is what this is
what Alvaro had figured out is if you
know the interface of the server-side
object you're attacking then you can use
this method but if you have no idea what
the object is you can use a generalized
attack and basically pass an assorted
set and it will automatically
deserialize this and vote invoke all the
things that you need in the dynamic
proxy to execute code on the server so
let's run that now oh let me show you
the window here all right so BAM
calculator right this time was a little
different you know clock was boring we
thought that calculator view Oh
calculator is scary no okay
so that all right so we got the
calculator now let's let's try to get
meterpreter running again all right I'm
gonna cross my fingers on this one
alright so there are two stages so with
rest tlit and XML decoder it was a
programming language essentially right
you could put a
a whole bunch of commands but with
extreme you can only execute one thing
at a time so the first stage is we're
gonna actually go to command tell it to
go to my server pull the jar and put it
on the machine and I execute another
command to run that jar that causes the
jar to connect back to my meterpreter
and in stand create a reverse shell okay
so the first step across my finger let's
and let's see if we get some action on
the port oh thank you thank you goodness
goodness thank you very much these might
be excess that you should have seen down
here at pulling a okay let me let me try
to restart my VM I apologize I'm going
to shut it down let's let's just maybe
try to do this and restart it hopefully
it'll I won't have to set everything
back up all right so if I go back here
and I start up my Kali come on buddy
all right let's see here let's try this
again
come on okay let's take a look at this
code real quick so stage one thing
okay have this I'm gonna ping it ping
one 92168 1.9 oh that's why what the
heck happened here okay there's gonna be
kind of I see if this fixes it okay I
apologize
let's try that again ping no route to
host wonderful this worked before okay
I think unfortunately something is not
cooperating and we need to get through
the final pieces of the I'm sorry
virtual box yes that's right virtual box
is very flaky breed your own Oh with
this yeah this is bridge mode okay do
you know how to fix it real quick okay
alright well I apology this does work
and it's impressive because once you get
reverse shell you can take a snapshot on
the machine you goand you of the screen
you can turn on the camera you can turn
on the microphone and start recording
you can do any shell commit you can
install a permanent backdoor all that's
possible okay so I apologize for the
meterpreter not working
Alvar will work really hard on that and
I wasn't able to show it so alright json
serialization so this is an area that's
new and there's research still ongoing
we haven't got anything finalized but
the next talk we give will go more into
details on that alright so one of the
things about breast frameworks in
general is that they put this cool
functionality into the rest api and one
of them was
the ability to copy your database from
one location to another okay now
unfortunately remember with all those
techniques I showed you going up and
down the URL and adding stuff to the
JSON string and concatenated in the URL
ID parameters well you know what do you
think let's see let's see if you guys
how much you learned all right this is
the final test for today all right we
want to make that which is basically
something as simple as going to the
customers back-end database for couchdb
do that
which is call underscore replicate and
then in the JSON we want to specify the
source and the target for where we want
to exfiltrate to okay now we get an ID
parameter and we also bind in to the
JSON so how would we do this what do we
need to do what what value does the
attacker need to provide for ID to get
it to go to slap underscore replicate
remember so that's the URL dot dot slash
what underscore replicate right now what
about in the JSON JSON looks pretty
harmless right they're just appending a
name to the JSON using concatenation how
do I add in a source and a target to
that yeah just put them in right just
exactly just sum it would be what is it
well okay it's easier to describe in the
next slide but yes it is that easy and
it will ignore the other parts that you
know the full name attribute and now
you've allowed someone to exfiltrate
data from your database to their
location anywhere in the world okay yeah
it's real all right
okay so when you so the conclusion is
you know you know this is a developer
conference and so you know when you're
looking at your rest state AP is and
your applications remember to think
about these things and now that you've
understood the different ways that your
reciprocation can be attacked and then
what typical vulnerabilities you know
start thinking about that okay
is there any questions all right yes
jax-rs is a very generic framework these
kind of things like this thing right
here this is something that the you know
how the rest api czar for these
databases well you have to be able to do
everything with the database through URL
so they're just trying to help you out
and so it's different than the generic
risk just the generic Jack's API won't
have something like like this because
this is very specific to CouchDB but
they're the other ones do exist in many
of the applications built on top of
those like I think the underscore method
parameter I think is there or it's a
HDPE header or something like that but
yes some of these things are in the core
framework but a lot of these things
developers add in because they're trying
to make the functionality through a URL
right they want to provide everything so
the thing is now that you everything's
through a URL it's so much easier to
attack you know you don't have to use it
you don't have to use these proprietary
protocols you don't have to know the
binary you don't have to know what you
know goes where or what are the
padding's you know all that it's just a
URL right any other questions
so that's a good question testing tools
you know I'll be honest with you I don't
know of a lot of testing tools because
my job is basically trying to find these
things I you know it's it's difficult to
test also because you know in a typical
web application you have the links that
people can spider to figure out your
application but in a rest app you just
have a single URL in the response you
know and it's difficult to figure out
where do I go to now with apps that
support hyper what is it called hate OAS
yeah how do you say that
hey yeah hideous Hades okay well in
those all the URLs for your requests and
the subsequent requests are in the
response so you can use that to spider
but for the most part I honestly don't
know of any testing tools I'm sorry
Oh OS app that's that is a proxy you can
use that to proxy the requests there are
generic proxies but I didn't know of any
rest specific testing tools any other
questions yes
yes so the question was yeah with with
sequel you can use a pair of
preparedstatement
and you can protect yourself through
these kind of injection based
vulnerabilities but with URLs you don't
really have something like that and
you're absolutely correct there is
something close called I think URL
builder I can't remember if it's in
spring MVC framework but there is
something similar but you know
unfortunately we need something like a
prepared URL where we specify where it
goes in and it can't go out of that and
you know you can't add certain
characters to add matrix parameters or
hash tags for - yes unfortunately it
ultimately the question was you know
does it come down to then input
validation and that is essentially where
you're at with most of these things you
have to look at your input and strictly
define and enforce what characters you
allow to be added to the URLs yes
oh sure sure all right any other
questions okay thank you very much for
sending us off</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>