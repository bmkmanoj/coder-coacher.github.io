<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Anatomy of a Java Zero-Day Exploit | Coder Coacher - Coaching Coders</title><meta content="Anatomy of a Java Zero-Day Exploit - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Developers/">Oracle Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Anatomy of a Java Zero-Day Exploit</b></h2><h5 class="post__date">2015-06-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/B1_3DH7B6ZQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">welcome to my presentation anatomy of a
Java zero-day exploit my name is diva
Svoboda and I work for the software
engineering Institute at Carnegie Mellon
officially I work for cert we still keep
that name around it seems to be pretty
popular so today what I'm going to be
showing you is just one particular
exploit that hit the internet back
last August August of 2012 there had
been of course a rain a set of exploits
affecting Java over the last year and
these exploits have all the ones I know
of at least have targeted the security
manager in Javas security sandbox so
they have affected the security of Java
applets Java Web Start apps rich
Internet applications they have not
affected Java on the desktop so so for
this presentation I'm going to show you
one single exploit before I show the
exploit I'm going to give you a quick
demo of how Java applets are supposed to
run under normal circumstances and how
the security manager acts as a chaperone
and make sure they only do sanctioned
activities then we get to actually watch
the exploit unfold and I'll take you
into the code that made the exploit
possible and then we'll go over how the
exploit was patched up ok so our story
begins actually with a Polish polish
researcher named Adam Gaudi ak he
founded the company called security
explorations he founded it in particular
to look for vulnerabilities in Java and
he did this as you can see not because
of Java he considered Java to be
terribly insecure and easy to exploit
but because it was difficult to exploit
he considered it to you know have a
strong eye toward security and exploit
a serious challenge
for anyone who doesn't think enough
security mindset anytime someone tells
you you know did this this platform is
impenetrable it's totally secure think
of that as a challenge because the bad
guys are definitely thinking of it that
way
one other interesting bit of information
as before he founded security
explorations Goudy AK was actually part
of a Polish group called the last stage
of delirium LSD rather cool name they
achieved notoriety in spring 2003 by
revealing or by discovering the windows
vulnerability that was subsequently
exploited by the blaster worm so he has
a pretty good CV associated with him so
the material that I'm showing you is all
publicly available the exploit itself is
freely downloadable over the internet
and all I've really done with it is
reformat the code and made it a bit more
easy to demo so that you know there
there's nothing secret or sensitive here
at least not anymore so the material I'm
pulling things from is from our two cert
books the cert and Oracle secure coding
standard for Java which was released two
years ago right before Java 1 2011 and
our latest release Java coding
guidelines which I just got my my
promotional copy you saw last week it's
available at the bookstore and by the
way if you're interested in picking up
either book then follow up you're free
to follow me after this lecture will be
going on down to the book store and
giving away or selling autographed
copies so pick a book pick up a book and
we'll sign it for you there's a couple
of other sources I'm using one is the
Oracle secure coding standard which our
books are modeled after and there's
there's a good overlap in information
between Oracle's books Oracle's material
and our material and finally there was a
blog post that I posted to the cert
Coordination Center blog back in January
or I analyzed the August exploit and a
similar exploit that happened in January
originally this lecture was going to
have two exploits but when I
I'd rehearse it it the lecture took
about two hours sorry there wasn't time
okay so how does a regular well-behaved
applet work it operates in the context
of a security manager sort of accident
chaperone the manager makes sure that
the app that only does things it's
permitted to do such as it's permitted
to access or if it's in a network
connection back to the host machine that
the app that itself comes from it's
allowed to phone home it's not allowed
to access your local file system it's
certainly not allowed to run programs on
your local file system and there's a
handful of other things one trivial
thing is it's not allowed to modify the
current security matter if it could
modify it it could just tell to go away
you know trust me I'll be good so that's
that's definitely not allowed it's a
security manager detects that the applet
is trying to do something unworthy then
it will throw a security exception in
crash the applet so the first thing I
get to do is show you simply how a
normal applet behaves so I'm going to
take you to my virtual machine this is a
standard virtual machine running Debian
Linux Linux Linux whatever as you can
see I've got several versions of Java 6
in Java 7 these are all fairly recent
yeah at one point 7.0 update 6 is the
was the latest version in August that
was exploited and the newer one well the
the exploits was were patched in update
7 but i've got update 10 here so we can
use that to demonstrate that the exploit
was since fixed so i'm gonna start up
Emacs here I'm an old Emacs hacker
actually yes I'm gonna start Emacs and
then open up a first file which is
basically my instructions so the first
thing I want to do here I'm also going
to open up Firefox and just simply run
the applet for you the standard applet
which is here so the
first applet I'm going to show you is a
signed applet and synaptic
in that they are allowed if they so
choose to request additional permissions
a sign applicant asked to run outside of
the security sandbox and run with the
same full privileges as your web browser
one runs with so the sign that appeared
if I run this signed app but then we're
first of all going to get some scary
dialog saying no are you sure you want
on this applet yes I'm sure
and what is the applet done it's running
a small little program here this is
called X clock it's a standard clock
program that's provided on all Linux
systems so all I demonstrated here is
the ability to run an applet outside of
the security sandbox now I'm going to
restart the browser and do a similar
applet but this time I'm going to run
and unsigned this uses the exact same
code it's going to try to run the clock
but the app that does not have a signed
certificate and you'll see this time we
have no clock all we have is text saying
loading and nothing else so the applet
is running but it is running inside the
security manager and the security
manager has silently suppressed the app
its ability to run an external program
so I'm going to show you just a little
bit of how this applet is put together
it's fairly straightforward so it's an
example ok so we first of all have an
HTML file all this HTML file does is it
asks for the applet gives it a window to
run in and the sign HTML file is asking
first sign jar the unsigned is asking
for an unsigned jar in particular they
are both asking to run Java applet dot
Java that's the class that we Coop's the
class we're using and I'm going to show
you that of that if this is difficult to
read then don't worry I have slides
containing all the code and we will use
that when actually analyzing the
material so here's the Java code I'm
running fairly simple
all we have is and in it routine and a
paint routine the paint was responsible
for putting that loading text that you
saw and the init is responsible for
actually running the clock let me go
back to the slides now because the
slides have all that same material on
them eventually why me
all right so this didn't happen when I
practice the demo okay so in the
well-behaved applet as I said you have a
paint routine Ian you have a init
routine so in the when the applet was
signed the init routine successfully ran
the X clock and that
overrode the paint routine in the
unsigned applet the init routine tried
to run the clock an exception was thrown
and the system then promptly tried to
print the stack trace but since there's
no standard error the stack trace
basically was invisible and then and
then again I have the HTML file which
simply runs simply absolute to sign
applet now I'm gonna I'm gonna regret
this but I'm gonna be I'm gonna be
switching a lot between the virtual
machine and the end PowerPoint here but
the next thing I want to do was to show
you that if you're testing your applets
then running a web browser is good when
the app that works fun but if the app
that dies with a with a crash how do you
how do you tell what happened and in
that case the answer is that there's a
program part of Java called applet
viewer so I'm gonna start up applet
viewer and run it on this example applet
so you can see just exactly what's
supposed to happen
so applet viewer
oh I mean Java applet that's what's
wrong so unsigned HTML and so again we
get the loading picture because you
always get a window from applet viewer
and there's our exception I'm going to
show the exception in the slides if
PowerPoint will let me yay it worked
okay so here's the stack stack trace
we're looking at and what's going on
here the security manager did its duty
it gave us an access denied because we
were trying to access the X clock file
and we have no permission to access all
files and if you look through the stack
trace and you go to the bottom here you
can see it says job a pajama
I'm sorry Java in 24 and that basically
refers to the code that actually tried
to exact cute the X clock so this shows
well-behaved Java security managers and
now that we see how how security
managers are supposed to work I'm gonna
show you how security manager fails in
its duty so what I'm gonna show you the
August exploit and here's the common
vulnerability number about it all this X
play did was it broke out of the sandbox
it ran code outside the sandbox which
simply set the security manager to null
and that something means you know
disabled security manager don't throw
any security exceptions let everything
else proceed as normal it effectively
breaks out of jail in when this appeared
in the wild it was used to install
malware it installed malware both on
Windows machines and Mac machines giving
all Apple users a major headaches in our
case we're simply going to use the
applet to run again our favorite X clock
program so we're gonna go over to our
web browser and we are
and run the HTML file and zap where was
the warnings
where was the loading thing this applet
is not signed in fact the HTML asked
directly loaded the class file instead
of going through a jar
there's no signatures there's no Jane
LPS none of that stuff but clearly this
applet had full privileges without ever
asking for it or jumping through all the
hoops that Oracle requires you to jump
through in order to run them so what
actually happened here let me take you
over to that directory so first of all
again the HTML is very simple again
we're just load directly loading the
class file I didn't even know you can
load a class file I thought you had a
little bit jar but that's not important
there we are so here's the Java applet
that perform the exploit this is what
we're gonna be looking at and figure out
why was a lot to work it's a fairly
small exploit it has at the bomb your
and init routine right here and then
down here that's the paint routine sorry
down here is the init routine which
again does much the same thing it did
before it runs X clock but it also has
this disable security and then the
applicant cysts of several more
functions
don't worry again I'm skipping through
this I will show you PowerPoint slides
of this now let's have a PowerPoint
that's me yeah one crash and you could
be I'm very shy but and timid okay so
let's go in a PowerPoint thank you so
here's the init routine and again this
init routine looks pretty much like the
well-behaved applets init routine where
we're executing the X clock and you know
throwing exception if it fails but as
you can see it succeeded the one major
difference was this disable security
line here what did that do
that was clearly critical and to
demonstrate that to prove to you that
that part is critical I'm gonna actually
comment it out so my comment on disable
security recompile the applet and then
run it what's gonna happen
so I recompile it okay okay we're having
technical difficulties all right I'll
tell you what mouse we become
unresponsive I'm gonna restart the
virtual machine and going for slides so
that's no this happens during rehearsal
well hardly ever so suffice to say that
the disable security line there is
critical to the applet running without
that line the applet would run
completely in the security sandbox and
there would be no exploit possible so
here's the code for disable security and
what are we doing in this code so I've
had you know 15 years of programming in
Java more or less and I haven't gotten
to work with Java beans I also haven't
gotten to work with security manager and
I haven't done to work with class
loading and the applet involves all
three so in order to understand Java
security you have to learn some rather
obscure parts of the Java library code
so let me walk you through what's
actually going on here we first of all
have a Java beans statement this is
simply an object that represents a Java
statement you can execute it and the
statement we're building here simply
says set the security manager to know
disabled security of course if I tried
directly just calling that function here
the security manager would say no
request denied so so instead we build a
statement and then we set it up to run
with outside the sandbox but of course
how do we do it down the bomb here you
can see we're actually calling execute
on the statement and right before we
call execute on statement we have this
line above it set field and thus view
we're sitting is stay
action they want to know what statement
DAC is so if you look in the Java API
documentation for statement doc you have
lots of documentation for Java Bean
statement you have nothing about Java
Bean statement action because it's a
private field you're not supposed to
know about it in other words only the
bad guys know about about this private
field it's also a fairly new field it
was introduced in one layer updates of
Java six so it exists today and
therefore since it's private
you know first of all you're not likely
to know about it second of all since
it's private you're not supposed to be
able to modify it you surely can't
modify it directly and modifying it
indirectly say using reflection would be
stopped by the security manager so
instead of asking or instead of using
Java reflection to set the field we have
our own set field function to bypass the
security manager why did that work so
there's actually two questions here
first of all what is statement act and
secondly why did we set it and why were
we allowed to set it so this code I'm
showing you now is from Java Bean
statement and this actually reveals both
the code as it is today and the code as
it was back before the act field was set
it is initialized at the top here to to
the current control context that it
means it indicates what privileges the
statement runs with and in the execute
function we delegate to invoke invoke we
usually just simply delegate to another
function called invoke internal but the
invoke function now reads the act field
and execute the invoke internal with the
same privileges specified by AK in other
words in other words the purpose of the
Act field now is so that privilege code
could build a Java Bean statement and
the statement would inherit the
privileges of the code that built it and
then it could be passed
to unprivileged code and the
unprivileged code could execute the
statement and it would execute with the
privileges of its Creed whore makes
sense to everyone it's sort of like a
genie who has much more privileges than
his master but until he's actually
called out he lives in his lamp in the
lamp can be passed from person to person
all right all right so I'm gonna come to
the set field thing in a moment let's
see if our virtual machine is healthy
all right so I'm gonna try the same
thing I was gonna do before we're gonna
go back into Emacs all right and we're
gonna go into the August exploit code
now there's the innit but here is
disable security and here is set the get
field function again if you want to get
a field and you don't want to bypass the
security manager the way to do it is
right here it's in the two lines I've
calmed it out so I'm gonna uncommon
those fields I'm gonna comment out the
rest of
and we're gonna try our web browser
again and fly our exploit and what
happens now we get the loading sign as
you can see this exploit is a simple
proof of concept it's easy to tell if
you're running inside the sandbox which
we are now or if you're running with
full privileges in which case we get the
clock so clearly using the normal
reflection get field method failed to
escape the sandbox so in other words all
I have simply proved to you is that get
field is that our get field routine here
the magic code that I've commented out
here is critical to the inner workings
of this exploit so I'm gonna undo this
and recompile and rerun the x-point just
to make sure I didn't break anything
I've already broken enough stuff today
we run the exploit and and it still
doesn't work
ah we tried to disable the security
before and failed didn't Li yeah we just
saved a lot more than the security okay
there we go
so that goes away and everything else
looks good
so we recompile thank you and I didn't
have to do this by myself
oops go away and we run our applet again
and there we are our exploits repaired
yay so let's just clean it clean up here
okay so getting back to PowerPoint and
powerpoints being faithful again so
whatever this code does is magical and
it's critical to the exploit working in
particular we are setting a field the
statement dot act field to a particular
value which causes the the basically
causes the are the code we built the
statement to run with full privileges
so what is this set feel doing again
we're relying on on javabeans this time
we're building an expression we're an
expression simply calls a get filled
routine once you have a filled object
you can that belongs to a particular a
particular object you can set the you
can change the value by calling your
field that your get value and then
change it here the set down down here
sorry I'm used to walking all the word
and pointing down the slides in like I
can't do that I have a leash so the big
question here is is how do we get this
private field and well why was it
allowed the reason we get this private
field is we're not calling the
reflection method we're instead calling
this method son a dbt son toolkit get
field and apparently that works now this
brings up two questions and that is
first of all first of all how do I start
this going on there we go first of all
how do we get access to two son AWT son
toolkit since it's in the son package it
is internal and private and athletes are
definitely not supposed to have access
to the son classes so just simply being
able to access that was a violation of
the sandbox and the way we did it was we
used this get class routine which is
also part of our exploit there excuse me
there is a standard way of getting
classes given just a string but this is
definitely not the standard way of doing
it so let me first focus on some a unity
dot son toolkit obviously this is part
of the abstract windowing toolkit which
came out in what Java 1.1 I think so as
I say here it's private to son and the
security manager automatically
guarantees that classes in the son
package are inaccessible to
and because they're inaccessible to
applets the the Sun toolkit it's get
field function has no other security
it doesn't check to make sure that it's
being called by benign code because it
can never be called by malicious code
right so in other words because just
because it's this you know he's like
this fellow just because it's acting in
a secure context it assumes that anyone
who's all able to get in the offices in
Harrow secure like this fellow here so
here's the actual code to to get filled
and as you can see get filled does
something that which no code that ever
interacts with malicious code should
ever do it's calling a do privileged
block and actually using the get
declared the field get declared field as
part of the Java reflection package so
in other words it's using Java
reflection but it's using it with full
privileges if with full privileges it
might have been able to to
access any field in any class if it's
called by untrusted code so um what I'm
trying to say here is if you ever use
you don't do privilege then you have to
it is up to you to make sure that you
are called loaded by trusted code and
clearly not Oracle the probably son made
sure this was only called by trusting by
trusted code by putting it in a private
package and they thought that was
sufficient and well unfortunately it was
not sufficient so we actually have to
secure coding guidelines this is this is
from our first book the certain Oracle
secure coding standard for Java where we
simply point out that first of all you
shouldn't use reflection to increase the
accessibility of a code and obviously we
obviously this exploit manages to do
just that but don't ever do that in your
good code and secondly do not allow
privilege blocks such as the one in Sun
toolkit do not allow privilege blocks
too
send the information across a trust
boundary in this case a trust boundary
is that invisible line that exists
between the applet code and the core
Java libraries what happened to the
developer who wrote what son AWT toolkit
initially that's a good question I don't
know I would guess that he got a
promotion for writing good code and
getting it done on time yeah if you find
out let me know please okay so let me go
to the getclass code now and the get
class is the other part of this riddle
and it's not here it's right below here
the normal way of calling of getting a
class is simply the class for name
method which I've commented out right
here now do our routine again of
uncoming out and using that as a way to
run the exploit and if I do that if I
use the sanctioned way of getting
classes we compile the code we're gonna
run the code hopefully nothing will
crash on us you're asking why does Java
the Java beans expression allow you to
do what reflection is not that's
just--that's I'm going to spend about 10
minutes explaining that but as you can
see if we use class dot for name by
itself then the exploit fails we're
still trapped inside the sandbox so we
close things out and we undo the change
here and clearly this code that I
commented out is somehow magical in
making the exploit of work I'll rerun
the exploit just to make sure I haven't
broken anything I like living
dangerously
and our exploit works again yay ok so
back to our slides somehow that makes me
feel safer okay so here's the get class
method again it's doing it is managing
to get a private class that simply
in class that forename forbade you is
that a word forbade you from doing so
again we're using javabeans expression
this time the expression simply calls
class stop for name we construct this
expression we execute it and then we and
then we get the return value from the
expect expression bruises and so and and
that's how get class works in other
words that's your exact question we are
using a javabeans expression to call
class stop for name instead of calling
it directly itself if we call directly
than the security manager stops us and
if we use javabean expression the
security manager happened that's a go
why so this is one of the most
complicated bits of java of at least
Oracle's guidelines and the actual
details for this I don't think those
made into our first book they're
definitely in our second book which just
got released so you should have to go
out and buy the second book always be
incomplete so that people come by for
the update okay so what is this where we
calling here we're calling class not for
name so in order to explain this I need
to go into the confused deputy problem
in fact when I first encountered this I
I could see what's going wrong but I
didn't know a name for this and my
coworker Dean Sutherland he's sitting in
here hi Dean he gave this gave me this
name and the computer deputy problem is
up is it's a major problem that affects
most every system that has different
privileges it's a major source of
vulnerabilities in in UNIX and if you
come to my tutorial this afternoon about
the job security architecture I'll go a
bit more into confused deputy but in the
meantime I have you know what 20 minutes
left 30 minutes okay good so the problem
itself is you haven't secure you have a
secure trusted code say object B here
and it's being requested by object a to
access you know sensitive information
here on the on the left so we already
know a priori that B can access this
information but we don't know
if a can so if they can access it then
you know haven't you just haven't you
sacrificed your complete security I
explained this to my boss's boss and
actually his when I tried to explain to
him he finally got it he said so it's
sort of like if you're underage if
you're you know 17 you can't buy alcohol
here but you can send your older brother
to go in and buy some alcohol for you
and thereby circumvent the the drinking
laws
so the confused deputy can cause lots of
headaches because you know B has to make
sure it's not invoked by malicious code
and that's difficult because most
languages don't provide you with any
reasonable access to the stack trace
however Java had a very clever solution
to this problem and that is that the
security manager checks every calling
method in the stack trace so it checks B
says fine B your access your authorized
it then goes up and says hey you call B
wait you're not authorized request
denied and that is the fundamental
that's what fundamentally makes Java the
Java security manager secure well almost
security it withstood it it existed for
at least fifteen years before we started
getting all these exploits so let's give
it something let's give the Sun in
Oracle some credit here so the way that
confuse deputy is normally handled is
that all the security checks that the
manager does apply to the entire stack
the our applet can call lots of it can
call anything in the core libraries that
it wants and the core libraries are
trusted code but when trusted code tries
to do something sensitive like execute
the X clock program the security manager
looks through the stack trace discovers
that the untrusted applet is in the
stack trace and therefore says request
denied here's have a security exception
so that normally that is the linchpin of
the applet security and it's worked well
for 15 years so here's a standard
security check again this
a manager looks through this entire
stack trace and this looks pretty much
like what you get from an exception
because most exceptions will print the
stack trace and as you can see at the
very bottom here you have our untrusted
class which allows the security manager
to say nope request denied
now I talk to you the way that that
things normally work I'm going to show
you the exception and the exception is
class dot for name and a handful of
other functions particularly associated
with class loaders so class stop for
name is one of a handful of functions
that doesn't do the standard security
check
it doesn't check everyone in the stack
it only checks the immediate calling
function so when we called it when we
tried calling it directly class not for
names so we looked at the immediate
caller which was our exploit code it
said sorry you're not trusted requests
tonight
but when we use a javabeans expression
as you can see this is what the stack
trace looked like and classed up for
name looked and and saw that the calling
class and method was class finder fine
class which is part of the java core
libraries and said oh your trusted
welcome in here's your class so a
typical case of confused deputy so as
you can see fooling class up for name
was actually pretty easy and was
probably pretty easy for fifteen years
before I actually tried to do it you
can't call class up for name from an
untrusted applet but you can call it
indirectly through Java beans expression
and we have several secure coding rules
one from our old book and one from our
new book and one from the Oracle coding
rules you know everyone pretty much
covered the bases here do not expose
methods that use reduced security checks
to untrusted code I have to admit I I
first read you know guideline 9-9
because towards the end of the Oracle
coding standards it's freely available
on the web by the way and um well I
didn't understand it there's about three
or four Oracle guidelines and they're
all
they're all written from the design of
from the standpoint of the developers
developers they build it this way I
don't know why they do it that way but
they said you know this might be a
problem we better documented and they
documented it but they didn't exactly
write it from the perspective of someone
who's gonna use this stuff so so I fail
to understand then I am I feel to
understand it back in August when the
exploits happened and I fail to
understand at a job of one last year I
only figured it out when I had to write
the blog post basically the only way I
understood the rule was by seeing and
violated catastrophic ly isn't the way
most children learn learn things
certainly what's the way I learned
things
okay so Hulk I try to explain this more
more concisely in section 18 in the new
book do not expose methods that use
reduce security checks
hopefully I succeeded please go up by
the book and let me know okay we also
have a more general rule in the older
book protect sensitive operations with
security manager checks so you know this
was a major security fail for for the
javabeans expression class so to
summarize this exploit works because
they had to exploit two different
vulnerabilities if you read if you read
the security explorations quote the
beginning gaddy act note that there was
simply no individual vulnerability that
that you know let let you run any
arbitrary code you had to exploit at
least two vaults yeah it's working at
certain security we call them Falls and
all the time so two vulnerabilities so
our two vulnerabilities are first of all
that javabeans expression can be used to
access a forbidden class it could access
any forbidden class that you know the
string of and in this case it was used
to access some toolkit and secondly the
Sun toolkit had a get field method which
could be used to access any field even
if the field is private or in a private
class and in this case we use it to
access the statement act field once we
use that we were able to build
statement that ran outside the security
manager and the statement itself
disables the security manager leading us
to step five so oops
big oops so well fortunately Oracle was
attentive they were on the ball and they
worked at patching this exploit so they
did so since there were two
vulnerabilities that were exploited here
they you know they did provide to
mitigations one was her protection on
the get field method
I believe that protection simply said if
there's no security or if there is a
security manager but this is running
with an access control context of zero
of null if it's totally privileged code
then deny it but the more interesting
part was fixing class stop for name
sorry they actually didn't change class
stop for name they instead changed the
class that called it which was a class
finder in which case they did their own
security check
so that again here's the stack trace of
class up for name and what they fixed
was fine class and in fine class here's
the here's the code it calls a check
access method now and the check access
method does the standard security
manager check so it checks every method
in the call stack you know in order to
prevent confused deputy so let me
finally at least I hope I've scared you
enough during this this talk so to help
us ways your feelings I'm going to
upgrade to Java one point 7.0 Update 10
that has these fixes in it just to
convince you that this is no longer a
problem so here we are
I want this code so this is just simply
changing a bit of symbolic links so that
the Firefox uses update 10 instead of
update 6 so once again we run Firefox
run our exploits and this time okay
we're now getting it this is a different
warning that Oracle's piled on a whole
bunch of different warring this
they they've tweaked the warnings we get
but this is just simply saying you might
want to update Java no I'll do it later
thank you and and yeah we're getting two
dialogues here now again I want to run
this but when we run it we get just a
loading we don't get our clock and the
exploit fails so in fact I can do one
better I can run the applet viewer so
let me just do that quickly HTML and
this time our exploit fails oops
we are back in we my focus went back out
of Emacs so here's our error message
again I'll show this error measures in a
slide but we're getting the same access
to non error that we have here in
particular it is not this time it's
actually not allowed to access the Sun
toolkit class or get class method fails
because they patched essentially the
code that's used by the Java means
expression so they basically mitigated
both exploits here 1 2 and therefore
prevented the exploit from succeeding
and here's the stack traits that we were
looking at again this is mostly trusted
code but the untrusted part here is
under is inside our get class before
grey methods there which specifically
refer to this constructing this local
expression because we tried to call
class out for name and that failed even
inside the javabeans expression okay so
to summarize this comparison actually
compares the August exploit
which I just showed you with another
exploit that hit the internet in January
and which there unfortunately there's a
there's 15 minutes left I don't have
time to explain that one so here's some
tempting morsels about what we have here
both exploits did a lot of similar
things they first they first break out
the sandbox it reminds me a lot of
Houdini just working loose their bonds
connealy achieving higher and higher
stages until the bomb lake they achieve
full privileges the first step is they
they access they obtain the ability to
act as any class using you know and the
August exploit used be javabeans
expression once they act as any class
they go to a forbidden class like Sun
toolkit and use that to access fields or
constructors they're basically bypassing
both the Security Manager and jobless
normal access restrictions public
packaged private once they have the
ability to invoke arbitrary methods they
construct some code that turns off the
security manager and they give it full
privileges they then promptly run the
code and they cheat they obtain full
privileges or profit profit means
different things to different people
so I think you just said that yeah that
since the Java code is is open is freely
available it's easy to peruse through it
looking for vulnerabilities I'm not sure
that's a question but I will definitely
agree with that of course that also
means that presumably the good guys can
warn Oracle about these problems in fact
Adam Gaudi akka of security explorations
did just that
he pulled he published about twenty of
them and gave them to Oracle in April of
2012 and he only published them made
them public in November it's a you know
that's what we had sir called
responsible disclosure you know it's it
gave Oracle six months to patch things
up
of course it that doesn't take in the
fact that that doesn't take into account
the fact that other people can discover
these vulnerabilities and be less
responsible should Oracle be reviewing
all the code most definitely they should
be they're probably not the only ones
are being in all the code people like
cert are also working on and I'm sure
there are black hats also reviewing the
code so but but that's a good reason why
they should be reviewing the code I'm
right with you so yeah here's a summary
of the vulnerabilities the ones in gray
or the January exploit that I couldn't
talk about but the ones in black are the
August exploit which we've been over
carefully and also here all the secure
coding guidelines again for both the
August and the January exploit with the
most with probably the biggest and
hardest one being number eighteen from
our new book exposing methods that use
reduce security checks and a handful of
ones all from the security section of
our old book and all and several of the
most complicated Oracle secure coding
guidelines all in Chapter nine Gustin
we'll see a version of the January
exploit tomorrow in your talk yes I
haven't gotten to plug your talk yet
dean sutherland here who works in the
office next to me and robert Secord who
is my boss hail hail to the boss they
are giving a lecture tomorrow at 8:30
called don't be pwned a very short
course on secure coding in java and jean
dean has just told me that they're gonna
quickly go over the january exploit so i
don't have time to explain to you they
do be sure and tune in then okay one
last thing quick thing we have here is
simply a set of vulnerability vectors
published by Microsoft so since this is
my Microsoft you can take it with as
much salt as as you want but I'll point
out that over here the right where the
blue orange red lines cross the blue
lines of course HTML based
vulnerabilities and the red line is Java
and Java happened to exceed HTML
vulnerable is right around August right
up when this X point happened that's
probably a coincidence I hope so
so I think we're just now repeating what
we already covered earlier which is
simply that Java is a huge codebase it
is largely open-source it's all publicly
available at least in John yeah the Java
part is all publicly available and the
open JDK is open source completely so
lots of people are looking through this
code oh there's one thing I did want to
mention it is tempting when you do
vulnerability analysis to you know rake
the developers the software developers
across the coals it's easy to say Oh
Oracle's really not paying attention
they need more on the ball come on guys
get with the program I get with the
exploit programs so I'm I'm trying hard
not to do this the code that the exploit
code that I've shown you yeah the
exploit code of course came out in
August but the the core library code
that was exploited here
easily predates Oracle its javabeans its
javabeans insa and the class loaders and
the class dot Forney so this code oracle
bc inherited this huge codebase now
should they go over this codebase and
look for four more vulnerabilities
definitely they should unfortunately i
mean it's a thankless job they could say
to you hey guess what we're coming out
with oracle with java 8 which has all
these new features or they could say i'm
sorry we're not putting on job 8 yet
until we can fix these security
vulnerabilities which is which is easier
to do which is better for business well
in the long run fixing these
vulnerabilities is better for business
but it's certainly not what a lot of
clients necessarily want to hear and
besides this how many lectures that
you're gonna hear at JavaOne are about
new features coming out in Java and how
many of them are about well we are in
the code we found these vulnerabilities
is anyone else talking about Java
vulnerabilities well besides Dean Thank
You Dean it's a lonesome fight so but
lastly I'm going to say in this slide is
simply that instead of finding the
vulnerabilities after the fact by
sitting through you know thousands of
lines of inherited code is cheaper to
build the code that doesn't have the
vulnerabilities in the first place and
our books should be instrumental in
helping you avoid these vulnerabilities
so please follow the coding guidelines
there are documented in our books and
also you can follow Oracle's unsecured
coding to islands we we work heavily
with closely with them to make sure
their guidelines are good and our
guidelines are well even better so so
that's the lecture I'm interested in
I'll be willing to take questions I'm
also happy to point out that after this
lecture the three of us Robert Dean and
I were all co-authors on both these
books and we're moving down to the
bookstore we'll be happy to sign sign
your copy of the book if you want so are
there questions we have a few minutes
left so I can answer I can answer some
questions yes
so so okay so the question is does the
fact that I had to sign the applet is
that relevant to the exploit and
actually it's not historically applets
had to be signed if let me make let me
just make sure I get this right they had
to be signed if you wanted extra
privileges and if you did not want extra
privileges you could leave the applet
unsigned now Oracle's changing their
their tune their where they want you to
sign all your applets and that is a
that's an hour-long topic in and of
itself and I and while I had to show
both a sign unsigned applet just to show
you how applets behave again I didn't
want I try to avoid going into that
morass right right we can talk about
that a bit during my tutorial this
afternoon at 4:30 I've got two hours for
the tutorial there so we can talk about
sign versus online applets then again
this you know well I had to show you
sign on versus on synaptic here I this
is not about the the changes that Oracle
has has imposed on us regarding applet
signing other questions yes yes you had
a question
you're asking if I know of any tools
that do an hour analysis based on secure
coding standard the answer is yes so
there are several tools free and
commercial findbugs is a excellent free
tool every so the problem is every tool
that does analysis have their own set of
things they hunt for and they tend to
hunt for the things they're easiest to
define it's easy to tell if you have say
a syntax error or if you're doing
something that looks like it was a typo
if you say have a semicolon before or
after your if clause which will change
the way your program your program will
still compile and run that will probably
not behave the way you expect
so some tools
I think Colbert does Coverity have
support for cert standards I think they
do
I have it I can mention that we actually
have a project at cert called scale
which takes lots of tools including
Coverity and findbugs and maps the
output of these tools to cert standards
so you give us a code base and we can
tell you where the code base violates
our standards of course fine bugs and
your other tools do have the problem of
false positives they tend to often
report lots of things that aren't really
true upon further examination so it's
easy to tell what Diagnostics they have
and which ones map to secure coding
rules and which ones have nothing to do
with security telling which ones are
false positives or true positives that's
it's what we call a major area of
research ok other questions I didn't
talk about that did I so it was called a
zero day exploit because the exploit
appeared in the wild in August without
there being a patch available back in
the old days the exploits would come out
well the vulnerabilities would be
reported publicly to the general public
giving giving companies like Microsoft
where Adobe you know so many so many
days in which to fix the exploit which
have patched the vulnerability before an
exploit comes out so so you know a
seven-day exploit means that an exploit
that a vulnerability was published one
week later a volley was published but
there was no exploit available yet so
yeah it's the time between when the
patch comes out and when the exploit
becomes available so but a seven-day
exploit means that the X point came out
seven days after the patch you had one
week to apply the patch before you might
get pwned a zero day exploit something
means the exploit came out before there
was a patch available and for a few days
in August you know you could be pwned
without any recourse without any
particular help from Oracle all they
could say is you know disable Java for
now
working as far as we can I'm sorry
who found the exploit so I can tell you
that security explorations found the
vulnerability they did not as far as you
know published the exploit we don't know
who published the exploit I think if we
do know there would be there would be
trials there will be court cases okay I
think we're about out of time so who's
up for cake</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>