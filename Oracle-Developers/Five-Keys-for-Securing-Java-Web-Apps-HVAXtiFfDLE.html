<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Five Keys for Securing Java Web Apps | Coder Coacher - Coaching Coders</title><meta content="Five Keys for Securing Java Web Apps - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Developers/">Oracle Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Five Keys for Securing Java Web Apps</b></h2><h5 class="post__date">2015-06-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/HVAXtiFfDLE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">welcome to five keys for securing your
java web apps let's go ahead and dive
right in just by way of introduction my
name is Frank Kim I'm here with the SANS
Institute maybe some of you guys have
heard about them there are an IT
security training company that's offer
all kinds of security training and I do
a couple of things for them in terms of
their application security curriculum
now let me ask you guys a question how
many of you are avid readers of the data
breach investigations report published
by Verizon every single year quick show
of hands one hand two hands in the
entire audience you guys are definitely
not security people folks in the
security industry read this thing
religiously Verizon publishes it every
single year over the course of the last
decade they've collected data for over a
hundred thousand security incidents that
they and other organizations have
actually responded to and in analyzing
all of this data they have discovered
that there are nine different types of
attacks attack patterns that they have
confound that encompasses all of these
hundred thousand different attacks and
you see eight of them on screen here
today this is actually the cover from
the most recent Verizon deburr dbi our
report the what I cut and pasted it the
point-of-sale attack was down at the
bottom and it wouldn't fit in the screen
but the reason that we're here today is
as Verizon points out web app attacks
are quote-unquote still the proverbial
punching bag of the Internet 35% of the
breaches that they investigate have a
web application vulnerable owner ability
web application component associated
with them so it's really bad which is
why we want to focus on how we can
develop create our web applications more
securely make sense all right so with
that there are five things five keys
that I want to share with you today that
are listed up here on the slide and
we're gonna be talking about five these
five things because well I think that
they're really important in terms of the
security of the applications that you
all probably create every single day the
first one is cross-site scripting
now quick show of hands who here has
heard of cross-site scripting excellence
virtually a hundred percent of the
people I asked the same thing when I
first started talking at JavaOne 40
years ago and it was maybe 40% of the
people had raised their hand now how
many of you quick show of hands have
actually fixed a cross-site scripting
vulnerability in your applications well
it goes down from a hundred to maybe
sixty percent or so okay now I'm not
really here I don't really want to talk
about cross-site scripting today what I
really want to do is talk about tennis
for just a moment
are there any tennis fans out there no
no more people then have read the deburr
so that's good just a handful of folks
that are tennis fans any Maria Sharapova
fans very popular tennis player right
millions of followers on Twitter I had a
few more a few more hands okay well it
turns out you know Maria Sharapova is a
well known tennis player right a lot of
people are our fans of hers actually and
some years back she was actually having
a career crisis she was not sure if he
wanted to continue being a professional
tennis player so she actually announced
on her website that she was going to be
leaving the world of tennis to become a
CCIE
a Cisco Certified internetworking expert
isn't that awesome
right that's pretty sick in my opinion
and it was true it had to be true
because Maria Sharapova it was published
on her website and at the exact same
time it was jointly published on Cisco's
website Cisco comm now of course you
know this was all a ruse this was
jointly published on both sites on April
Fool's Day April 1st turns out some
Russian hackers had found cross-site
scripting vulnerabilities in both Maria
Sharapova calm Cisco calm saved them up
until April Fool's April 1st and then
published these links on the internet
with a bunch of extra data in these URL
parameters that when you as the victim
clicked on that link to cisco comm came
down to your browser and all of that
extra data got rendered in your web
browser and actually executed rewriting
the contents of your page by accessing
the Dom to make it look like there was a
fake press release a press release was
actually issued by both of these sites
announcing Maria Sharapova's career
change and that is your classic case of
reflected cross-site scripting XSS is
basically just some evil data gets sent
up to your web server and it gets echoed
back down and rendered in your browser
so an evil data usually in the form of
JavaScript
sit now you guys probably know one of
the best ways to fix well things that
you could do to defend against
cross-site scripting and other
application attacks is to do the
appropriate input validation but to
really fix cross-site scripting you want
to do the appropriate output encoding
right do various HTML URL JavaScript
encoding when you send the Brout data
back down to the browser and this is
nicely summarized nicely written up in a
great little paper on the OS website
called the a wasp XSS prevention cheat
sheet who's read this before XSS
prevention cheat sheet all right a
couple dozen people or so excellent now
but the problem with that is doing all
that outputting coding doing that input
validation it takes a lot of work and I
don't know about you guys but I'm a
pretty lazy developer I would like all
of that stuff to just be handled for me
instead of going and finding every
single parameter in my application that
might be sending data back down to the
browser and doing the appropriate
encoding fortunately they we do have a
solution that could potentially make
your life a little bit easier it is
called content security policy CSP for
short anybody used this before all right
we have one gentleman up in the front
content security policy instead of you
having to make actual changes to your
code itself when the data is being sent
to the to the output stream of your JSP
or servlet what content security policy
allows you to do is create a whitelist
of trusted sources trusted domains of
your JavaScript code that makes sense so
if you know that this JavaScript is
coming from your own trusted content
delivery network let's say well you're
gonna allow it to execute and you're not
gonna allow any other JavaScript to
execute thereby mitigating the exposure
that your application has to cross-site
scripting attacks and you do this simply
by not necessarily changing your
application line by line but by
including as shown in the second bullet
here an HTTP response header and you set
this header back down to the browser the
browser sees this and says oh well I'm
not gonna execute any JavaScript from
any untrusted locations
only gonna execute the JavaScript that's
defined in the value for this header
itself some of the directives that you
can include in that header are listed
down here at the bottom now it's
important to note that there's a couple
caveats to this right in your
applications maybe especially older
applications you might have a bunch of
HTML and there might be some inline
script tags right in there maybe it
might say script do something or there
might be some inline Styles cascading
style sheets a prereq for using CSP is
that you cannot have any of those inline
script tags or inline Styles if that
makes sense right so if you have a
legacy application that's something that
you want to factor it in terms of your
plan for how you might start to use
content security policy but with that
let's go ahead and take a look at two
examples the first example here in
number one content security policy
header default source is self meaning
that my trusted code my trusted
JavaScript can only come from the same
origin port protocol and domain and
you're only really allowing stuff to be
executed from your own site thereby
prevent protecting preventing cross-site
scripting but the second example here
the student number two is actually from
my quest org my quest is a developer on
the Google Chrome team based in Germany
and on his personal site he actually
uses this content security policy so you
can see here by default and may be a
little hard to read all the way in the
back default source is none so by
default allowing nothing but styles can
come from his CDN net content delivery
network only allowing framing the frame
source right here from YouTube and
SlideShare only allowing scripts again
from his content delivery network and
SlideShare on down to images and fonts
all the way down at the bottom so you
can see this is just an example real
example of how he might how you might go
ahead and define the trusted locations
of the sources of different data that
your application might use now I don't
know about you guys but to me this is
pretty awesome being able to stop
mitigate cross-site scripting without
necessarily any manual very specific
point in time changes to your code
itself using content secure
ten security policy now I didn't
mentioned there's a couple prereqs how
many of you guys have legacy
applications with scripts directly in
the HTML inline scripts no not not that
many maybe about a quarter of you guys
if you have that situation you might not
you might be worried about breaking your
application right by turning on content
security policy what you could do
instead here on this next slide is
instead of using the content security
policy header you could use the report
only header and this is an actual real
example from Facebook where they
actually basically say hey we're not
we're only gonna allow scripts from
these particular locations and if
there's a error if something violates
this directive we're not going to block
it because we're afraid of breaking our
site in the short term while we're doing
this texting down at the very bottom
what's going to happen instead is that
there's this report URI and if the
browser is going to go ahead and
generate a JSON formatted message send
it up to this report URI location and
then you as the owner of the site could
go ahead and parse that and see okay
before I turn it on fully in production
and block things let me go ahead and see
what errors I might need to clean up in
my application itself all right that is
content security policy any questions
all right so with that let's do a very
quick very quick demo I'm gonna switch
over here to a VM that I have running
and the VM itself has this beautiful web
page on it that's just basically the
little links that I'm gonna be using
throughout the course of this specific
talk and if I go ahead and click the
first link for XSS make this a lot
bigger for you guys and in the URL bar
I'm going to zoom in a little bit and
you can see I've got this page called
XSS JSP because it's vulnerable to XSS
takes a couple parameters a message and
a name and all I have to do here is
change this to something like hello Java
1 hit enter it changes the message right
date evil data coming back up to the
application server echoed back down to
the browser and render so if I go ahead
and change this to something like script
alert script our standard way of looking
for cross-site scripting vulnerabilities
and go ahead and hit enter right the
evil JavaScript goes up to the server
comes back down and is actually executed
in the browser itself your standard very
basic simple way to show that cross-site
scripting is actually this site this
page is actually vulnerable to XSS so
let's see let's see content security
policy in action if I go to this second
link here and again we've got the exact
same parameters up in the URL bar Java
Wan right changes the message now if I
change it to whoops script alert script
and hit enter this is the moment of
truth nothing happens the alert box
right calling the alert function doesn't
pop up let's take a quick look at why
that is right here I've got another
application running it is the a very
simple proxy we have application proxy
if anyone uses one of those before this
is the perros proxy one of the most
simple straightforward ones that you can
actually find if you haven't used one of
these before
over here on the left hand side is a
hierarchy of all of the sites that I
visited while perros has been turned on
all of the requests that have been sent
down here at the bottom if I go ahead
and highlight the last one where I tried
to execute that alert functionality and
go to the response tab here and zoom in
a little bit you can see that the only
thing that I did in this page - that was
different from the first one that did
pop up the alert box was to set the
content security policy header here and
simply by doing that the browser was
able to interpret this and block the XSS
attack from occurring all right yes yes
that's a very good question this is this
header supported by all browsers the
generic answer is yes this header is
supported by all modern browsers now I'm
not very good my wife will tell you at
remembering a lot of things and so I
don't remember what specific versions of
certain browsers but yes for many
versions now all the modern browsers
have supported content security policy
header yes I saw another hand
yes that's a good comment in this
particular case the script origin when I
put the script alert script in the URL
bar was the same origin but the other
thing to note is that content security
policy prevents inline scripts from
executing and because of this URL
parameter the way it's echoed back in
the browser it's places it in an inline
location that prevents that from
occurring yes good question all right so
with that let's move on to the second
topic here which is encryption now this
is not a surprise everybody realizes
that we should be encrypting data
there's lots of revelations that support
this in terms of folks maybe spying and
looking at our data invading our privacy
and so on you know I believe that all
communication on the Internet should be
default encrypted in your java web
applications the easy way to configure
this is in your web.xml file as we show
a little snippet here simply by setting
the transport guaranteed to confidential
now similar to how we saw the content
security policy header it would be nice
if there were some additional
protections that were that we could
utilize in our SSL communication that
brings us to the next slide here with
this secure flag now the secure flag if
you mark your cookie as a secure you
know in your code you can say new cookie
and say a response dot set cookie but
when you say new cookie you can also say
dot set secure and it'll set the secure
flag on your cookie itself and that
tells the browser to only ever send that
cookie value over an encrypted channel
to prevent the risk of that session ID
your sensitive cookie information being
sniffed off the network and an attacker
conducting a session hijacking attack
right yes question
I think the question was on the
developer side how do you work how do
you do this oh yeah not all developers
will have a certificate an ssl
certificate for their site yes that is a
prerequisite is you have to have a valid
ssl certificate for your production
application that will be trusted by the
end browser itself so there's various
certificate authorities that you could
go to get those for for as little as you
know dollars if you go to the big ones
like the arrow sign or thought it's
gonna cost a little bit more but yes
once you have one of those though the
way to configure it in web.xml is like
this setting the secure elements to true
and as we talked about programmatically
you can do it using the set secure
method down here at the bottom now
there's a little bit of a snag though
with this if you turn on SSL on your
website what happens if somebody types
in HTTP and goes to the non SSL version
right usually what'll happen is it'll
redirect you to the SSL version right
well when that happens there's a very
brief small window of opportunity for
the attacker to intercept that
communication and basically send you
some evil data there's a great tool
called SSL strip written by Moxie
Marlinspike that kind of takes advantage
of this little time window that the
attacker has to conduct this to conduct
this attack so what you could do in
addition to the secure flag and turning
on SSL is using HTTP strict Transport
Security the STS header in your response
now when you do this it helps mitigate
that issue that we just mentioned about
having this window of opportunity for
the attacker to sniff and manipulate the
non SSL connection during the redirect
so if you send down as you see at the
bottom the strict Transport Security
response header it's basically going to
tell the browser the first time you get
the SSL certificate from the server go
ahead and cash it for the number of
minutes or seconds specified in the max
age parameter in the lower right hand
corner and the browser's gonna keep it
for that amount of time and then
subsequently every time you man you
we go to the website in question via the
browser even if you type HTTP the non
SSL version under the covers the
communication is still going to be
encrypted makes sense
helping to reduce the window opportunity
that the attacker has to steal and sniff
your sensitive traffic so strict
Transport Security another incredible
header awesome header that you could use
to protect your applications all right
with that let's move on to the third
topic here which is access control now
access control might sound like a little
bit of a boring topic anybody use
standard out-of-the-box Java EE
authentication to protect their web
applications right though as defined in
the specification know only oh yeah only
a few people really everyone is using a
single sign-on framework or rolling your
own or using spring security or
something like that okay all right well
if you are using standard out-of-the-box
Java EE authentication well you have to
configure your app server to get the
users and roles from the underlying data
store and you make some configurations
in web.xml to support that right that's
per the specification
well the specification specifically says
that you can define what you want to
protect in your site with a little XML
snippet like this so in this particular
example we're saying that the URL
pattern we want to protect this site
slash star right just an example and
here we're calling out to specific HTTP
methods get and post now you would think
that this should mean that the get and
post methods are protected and nothing
else should be allowed right but if you
read the specification it actually means
the exact opposite if you configure your
site like this it means that only these
methods are protected and everything
else is allowed all right how ridiculous
is that and so what that means from an
attackers perspective is this if I have
a protected page like hello JSP let's
just pretend that that's protected in
the upper left-hand corner here is a
snapshot of the peril
tool that I just showed you briefly now
the perros tool from your testing
perspective can be used to trap
intercept traffic modify anything in the
HTTP request and then send it back up to
the server in this particular case again
it might be a little hard to see in the
back is that I've changed the request to
my hello servlet over here to some
method that doesn't exist in the
specification in this example the sands
request right that doesn't Idzik exist
in the HTTP spec if I try to access a
servlet site slash hello this the hello
servlet here on the right hand side I'm
gonna get this error and the error says
hey that method doesn't exist in the
spec and I don't support it so that's
good but if you try to access hello JSP
which normally will kick you to sign on
but you change the method here right you
can see down at the bottom it's actually
going to give you access to that page
without you being signed on pretty
horrible right alright so you guys don't
have to take my word for it let's go
ahead and do a quick demo to show that
this is actually the case so if I switch
back to the VM here and go back to the
browser go back to my little home page
of bookmarks if I go ahead and click
this access control link you can see
that this is just a little page in this
particular case the URL is going to
hello dot JSP
alright if I go ahead and hit enter on
this again in the URL bar it kicks me
back here to the same sign on screen
alright because this page is currently
protected by Java EE authentication now
instead if what I do is if I go to Paros
and I'm going to go to the trap tab over
here on the right hand side and I'm
gonna click this little trap request
checkbox and that's basically gonna say
anything you send up to the server Paris
is gonna trap it first so now when I go
back to the browser go back to the URL
bar hit enter right and you can see in
the lower left hand corner you can see
in the browser that the browser is
hanging it's not receiving a response
back from the server
that's because perros if I switch to it
here has trapped the request
here as you can see it's populated and
what I'm gonna do is I'm gonna go ahead
and change to my normal get my normal
HTTP GET request to some fake requests
like sans
that doesn't exist in the specification
now I'm going to uncheck trap requests
I'm gonna click continue and then back
in the browser you can see that I can
now see the contents of the page that
really normally should allow require me
to be signed on to view the contents so
I've just conducted an access control
bypass attack right by using a
misconfigured leveraging a misconfigured
web.xml file whose going to go back home
tonight and check their web XML files
for these configurations all right yes
question in the back
in this purse so I think the question is
who's servicing the perhaps the access
check for this application yes who is
servicing this request so excellent
question why is the application
servicing this fake fans request and
treating it like a get so in the servlet
example we saw from the screenshot that
it gave an error that said hey I don't
support sands but as you guys know
servlets when you write them and you
deploy them they're compiled into jsps
excuse me cuz servlets are compiled I
said that backwards jsps are compiled
into servlets servlets have a service
method and and protocols pasar a
specific handler methods like do get do
post and so on so the service method
will delegate the call to do get to post
and so on but it can't delegate it to
the do sans method because it doesn't
exist but jsps when they get get piled
into servlets they get compiled with
only one generic service method there's
no corresponding do get or do post which
is why the service method handles
everything and therefore as to your
question execute the functionality
itself that's right yeah good question
all right so that's access control
bypass fortunately the way to fix this
last slide of this section is very
simple all you have to do is remove the
HTTP method elements and you won't be
able to conduct the attack that we just
showed you that very simple change
though is very very quick easy change to
do in your web XML files if you do have
them configured like this any other
questions on this section before we move
on all right so that brings us then to
sequel injection now sequel injection
I think as you probably all know is
allows an attacker to extend the meaning
of your underlying sequel query thereby
allowing the attacker to execute
arbitrary sequel commands via your
application now this is all this happens
when your sequel is coded in your in
your app using dynamic queries right
essentially using string concatenation
the way that you prevent this from
occurring is to use the appropriate
rised queries appropriately now this
seems very simple right you'd parameter
Ava's implementation of parameterised
query is a prepared statement use a
prepared statement correctly and you'll
be immune from sequel injection now
seems very straightforward unfortunately
sequel injection vulnerabilities still
occur all the time
all right anybody familiar with the mass
sequel injection attacks alright a
Google for mass sequel injection they
started some years ago and continued
even to this day in varying forms but
what happened in the original
incarnation was that some attackers
decided that they wanted to target a
bunch of applications that had Microsoft
sequel server database backends so they
would start sending all of these this
obfuscated sequel to every parameter
that they could find on any web
application that appeared to be running
sequel server in the back end well why
were they doing this it turns out they
did when researchers got this obfuscated
sequel they decoded it what the sequel
was actually doing was enumerated every
single varchar' field in the database
right then it was appending to every
single varchar' field a bunch of
JavaScript wide were why were they doing
that that thought was that hey if you
got some varchars in the database at
some point they're just strings and they
will likely be displayed back to the
user in the browser and if the string
has a bunch of javascript at the end
well now you've got a bunch of
JavaScript code that's gonna execute in
the user's browser itself because it
came from your site and that javascript
was actually pointing to write malicious
websites malicious code that would
download exploits for unpatched software
like Office Acrobat flash even Java on
your machines that would compromise your
your endpoint and add it to the
attackers bot army so I was a pretty
ingenious use in my opinion of sequel
injection using it to inject some
JavaScript kind of
like cross-site scripting and then
leveraging that to actually take control
of the end users machine itself all
right so fortunately sequel injection is
really easy to fix but unfortunately
right here on the next slide we still
make some mistakes I remember doing a
code review many years ago and I said oh
you guys are just using statement class
and doing string concatenation make sure
you use preparedstatement to fix this so
they came back and said okay well we
fixed everything we replaced all the
statements with prepared statement but
no it's still vulnerable here right
because you're still creating the query
the sequel itself using string
concatenation and so you want to make
sure that you use not only prepared
statement class but the appropriate bind
variables right the question marks and
the appropriate set string and set its
methods and so on so let's do a very
quick demo so if I switch back again to
the VM if you are the attacker now this
has happened to me before and I've got a
different application here and this is
an old version of the daffodil CRM
customer relationship management tool
and in the past what has happened is hey
Frank we want you to do a pen test of
this application said okay great well so
what are the the test IDs what
functionality do you want me to test and
so on no no no we don't want it to work
like that we're gonna give you a URL
right and we want you to go to the URL
and then find out what you can find see
if you can hack the application and when
I go to the URL there's nothing there
other than a sign on screen all right so
if you are the security tester you're
the ethical hacker you're the pen tester
all right what would you perhaps start
to do with this particular application
how would you start to test it from yeah
yeah you play with it you play with the
username and password so from an attack
perspective well I want to see if it's
correctly doing the right right sequel
right input validation and so on so as
from an attackers perspective I might
simply and it's perhaps a little hard to
see in the back here I'm just gonna
enter the single quote in the user name
field then I'm gonna enter any junk
password now when I click logon oh we
get this awesome stack trace and this
ya know in this video in the stack trace
right if I scroll all the way to the
right it reveals that right this junk
password I put in there's some error in
my sequel syntax and this key here is at
the very end there's two single quotes
because one of them is the single quote
that I just injected into the first the
username field now I as the attacker
love this because this just confirms to
me that this site is vulnerable to
sequel injection so I could use this for
a number of different things but I'm
just gonna go ahead and use this to show
you an authentication bypass attack
where now I have to make some educated
guesses in my mind of how I think the
dev developers of this this application
coded the select star from users query
so I'm just going to say single quote or
one equals one space and I'm just gonna
say because or one equals one always
evaluates to true right so imagine we've
got select let's just say it's star from
users where user ID equals something so
now I've got selects star from users
where user ID equals empty string or
true so it's gonna give me everything in
the users table all right now I still
have a syntax error because there's some
trailing sequel at the end in the code
itself so I'm gonna go ahead and comment
it out using - - right
sequel comment command we're using my
sequel under the cover so I actually
have to do - - space then I'm gonna
enter any junk password here and now
when I click login we extend the meaning
of the underlying sequel command and use
it to log in to the daffodil application
using the record of the user in the
first row in the table and you can see
that we're successfully logged in
because in the upper left hand corner we
are successfully signed on as the single
quote or one equals one user right
pretty awesome right now fortunately
from a development perspective I'm not
going to show that the fix all we have
to do is go to the place where the
sequel is actually created and switch it
from using string concatenation to user
prepared
statement with the corresponding vine
variables alright anybody gonna go back
home and check for sequel injection
tonight no alright so then that brings
us to our very last topic here very last
topic which is cross-site request
forgery cross-site request forgery also
known as somebody some people have
called it the sleeping giant because
almost every application is vulnerable
to it unless you have a specific
mitigation in place also called session
writing 4 as you will see in a moment
now CSRF see Cerf allows you as the
attacker to force the victim to execute
some site function under the covers
without their knowledge I know that's a
little wordy
usually when you force them to send a
forged request it has some nice side
effect some benefit to the attacker
itself now instead of talking in
generalities like that let's walk
through a specific example let's say in
the upper right hand corner in step
number 1 you are logged into the
daffodil application that we were just
looking at right it's a CRM tool so
you're capturing some new business leads
entering their contact information
whatever it may be you're logged into
that tool while you're using it you
decide that you want to go someplace
else on the internet so you don't sign
off of daffodil because a lot of times
we stay signed on to the sites that we
use so you decide in step number two on
the left that you want to go to attacker
com that's not really called attacker
com I just put that there to make it
explicit it's probably called Maria
Sharapova com or something like that but
unbeknownst to you right attacker com is
controlled by an evil hacker me and I
put some evil CSRF code in it as shown
in step number three in the lower
left-hand corner now this is very hard
to see you won't be able to see this in
the back but it's just some simple HTML
it's an image source tag that points to
admin handling JSP and it's got a bunch
of parameters at the end one of the
parameters is basically saying hey for
this user here that's defined in one of
the parameters make them an admin by
turning this check admin check
- true so now what happens is that when
you visit this site in your browser in
the middle here this HTML comes back
down to your browser the browser says oh
this HTML is telling me to go get an
image from this daffodil site let me go
ahead and send the request up to step
number four the server is gonna get that
and the server says oh well you're still
signed on let me go ahead and process
this admin handling dot JSP request and
under the covers without your knowledge
you be signed on daffodil admin changed
my regular account to an admin account
does that make sense and that is how
CSRF works alright so to illustrate that
let's do a quick demo last demo for the
day
switching over back to the VM here I'm
gonna go ahead and sign out and I'm
gonna go ahead and log in as a different
user we've got a very weak user ID and
password admin admin I'm gonna check
this login as admin box to make sure I'm
logged in as an admin and here now we've
got this admin tab because we're logged
in as an admin so if I go ahead and
click that there's a bunch of
administrative functionality here but
the stuff that I want to focus on is
this users quadrant in the lower left
hand corner and you can see that the
only user that we've got defined in the
system itself is the admin user just
because I've minimally set this thing up
but what I as the attacker can do I'm
gonna go ahead and simulate the fact
that you're going to attacker com that
your simulate that you're going to maria
sharapova calm with that has some evil
CSRF code so to do that oops did I lose
I gotta open up another browser here all
right so to do that I'm gonna go ahead
and open up another browser window put
it on the right-hand side and I'm gonna
go ahead and click this CSRF attack link
and the CSRF attack link has the exact
same code that I showed you on the slide
and that was in the lower
that you couldn't read because it's so
small so when I go ahead and click this
right it shows you a nice little picture
of my my vacation in Paris and you're
like oh that's really nice picture maybe
I can go to Paris someday under the
covers right there was this little HTML
that sent this image source request and
now if I go back over here to my page
where only I had admin before I'm gonna
refresh this page by clicking the admin
tab here again scrolling all the way
down oh and it didn't work
there should be an admin that comes in
here let me go ahead and log out the
comment is that is because I use two
browser tabs but know this this works
before because it keeps it in the same
browser session so let's see here and
this is always the risk of doing live
demos I yeah this there's always there's
always a risk of this so if I go ahead
it was cached let me go ahead and log in
again and make sure it didn't take going
back to where we were no all right let
me try this again go to the attack page
here and if I view the source to this
page you should be able to see yeah
right here let me make this a lot bigger
for you guys is the same image source
tag on line number seven scrolling to
the right that is pointing to admin
handling JSP right with all of the
parameters that i mentioned here
now if I go back let's hope that it
actually worked
no I could have sworn this would work
now what you're supposed to be seeing
you're gonna have to take my word for
this is another attacker account coming
up here we're having some technical
difficulties so you'll have to you'll
have to excuse that but trust me it
works when I'm home alone it's like when
you sing in the shower you see you're
the best singer in the world but ah
thank you very much thank you this is a
great debugging here so let me go ahead
some live debugging here so I'm gonna go
over to eclipse lesson 107 oh I didn't
switch it I see okay all right
thank you very much so what I'm gonna do
is I'm gonna go to here CSRF lesson 107
I was still using the old sequel
injection one which was a different web
project thank you very much now when I
log in go again go to the admin tab
again you can see that there is only one
user here but then if I go back open
another browser window try this again
and yes it's gonna work thank you so
much for that noticing that if I click
the CSRF attack link now when I go back
to the background browser click the
admin tab scroll down you can see that
yes unbeknownst to you the attacker
account was created using CSRF thank you
so much thanks alright so that is how an
attacker can force you the victim to
execute some sensitive functionality
like creating a new account right in
your application using Caesar so how do
you actually prevent this from occurring
well there's a handy little tool called
from a wasp called CSRF guard written by
Eric Sheridan now before we talk about
the details of this tool I want to ask
you guys a question when you log into a
web site and you go to the change
password feature of the site what do
they always ask you for they ask you for
the old password yes
exactly and there's a couple of reasons
that they ask you for the old password
number one is you asking for the old
password prevents a passerby attack if I
log into my online banking here leave
the room one of you nice people will
probably come up and try to chain take
control of my online banking account if
unless they ask for that change password
your old password when you change your
password so it prevents a passerby
attack but it also has the nice side
effect of preventing cross-site request
forgery because your current password is
something that in this scenario the
attacker doesn't know because if the
attacker knew your current password well
it would be game over anyways he would
just log directly into your account and
do whatever he wanted right so one way
conceptually to prevent mitigate CSRF is
to include something in the request the
attacker doesn't know now you don't
always want to include you know prompt
users to enter their current password
because it's not very user friendly it's
a hassle users won't like using your
site so what we're gonna do instead is
we're gonna inject an anti CSRF token
into each request itself and that's
exactly what the wasp CSRF guard tool
does there's a couple methods by which
you can utilize CSRF guard to do that
number one is some automatic JavaScript
Dom manipulation and number two is
manual manually using their JSP tag
library to modify your forms so that in
your HTML form in every single form when
you click Submit it's going to send up a
hidden form field up to the server the
server is going to compare that hidden
form field with the value that it
originally created if they don't match
then it's gonna stop the request from
being processed because there might be a
CSRF attack going on that makes sense
all right so the JSP tags themselves are
used like this on this next slide the
token name and the token value tags you
can see the example up at the top
we've also got some convenience tags
down here at the bottom one for
injecting the token itself directly into
a URI as well as the convenience form
and anchor tags down here at the very
bottom
now the other cool feature of CSRF guard
is the automatic Dom manipulation and
token injection that we see here to
utilize this you don't have to manually
go and inject those tags that we saw in
the previous slide into every single JSP
what you could do is simply in the first
bullet include your JavaScript servlet
this JavaScript bunch of JavaScript that
gets generated and this JavaScript
actually does a couple of cool things
here in the second bullet it actually
hooks the open and the send methods of
the xmlhttprequest object and it hooks
those to include some extra
functionality in the first one it copies
the URL into a local variable and then
here on the next slide for the send
method it calls this on send function
and specifically adds a couple of
request headers one saying that this
request is coming from CSRF guard with
the CSRF token itself and when this gets
sent back up to the server server your
servlet filter that's processing this on
the back end takes that token value and
if it doesn't match the one that it had
previously generated it's gonna go ahead
and stop block the CSRF attack from
coming through all right any questions
all right
that is CSRF gar and CSRF defense yes
excellent question how frequently do you
change these CSRF tokens oh wasps CSRF
guard has a properties file that allows
you to add a pretty fine grain level of
detail configure the way that the tokens
are generated in terms of the values
themselves the content that's in them
and whether there's a single token for
the entire session or a single token per
page for every single request you know
as you can imagine there's some slight
performance and some perhaps usability
constraints that you might want to
factor in if you generate a new token
every time there's a new request sent if
you've got multiple tabs open and a user
goes back to the first tab right that
tab may not work all right so depending
on the workflow of your application
those are some things you might want to
consider most of the apps that I see
implementing CSRF
fense generically generally do it one
token per session yes
good question what if you have to app
servers I think you're saying in a
cluster and if the if the requests
originally goes to one server but then
it goes to the another server at a
different time will it still work the
short answer is yes no it won't work
a lot of times I see organizations do
sticky sessions so it'll go to the same
one in that case yes it'll still work or
if you decide to not store the tokens in
the session but you store them in like a
memcache layer or something like that
that all the app servers can access this
then it will still work but yes to your
point there are some complexities yes
and you're right it would work with
session replication yep another hand in
the back
I think I heard the question as if you
have a mobile application that's using
on iOS something like UI webview - as a
little container for these yes this will
this still work yes if you are if the
user is required to be signed in then
yes this will still work
maybe this might be a better
conversation often I think you're saying
that because of the way that you I've EV
used work your Android code or your IRS
code could get access to the stuff in
the webview itself and you want to
prevent that from occurring because you
might have some sensitive data in there
that's being embedded by a third-party
application yeah no this would be this
is only for CSR if it's not gonna not
necessarily gonna stop that yeah good
good question anybody else all right so
just in summary right five things five
key things that we wanted to cover today
xs/s encryption access control sequel
injection and CSRF real quick sidebar I
mentioned at the very beginning that I'm
here with the SANS Institute this is
just for your reference there's some
information free stuff on our website
over here on the left if you want a very
cool free poster right that we can have
someone from sans send to you with some
detailed information on STL C tips and
things to incorporate into your
development process feel free to contact
me and I'll send your request over to
the right folks at sans thanks everybody
so much for coming</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>