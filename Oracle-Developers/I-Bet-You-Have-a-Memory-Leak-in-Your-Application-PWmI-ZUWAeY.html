<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>I Bet You Have a Memory Leak in Your Application | Coder Coacher - Coaching Coders</title><meta content="I Bet You Have a Memory Leak in Your Application - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Developers/">Oracle Developers</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>I Bet You Have a Memory Leak in Your Application</b></h2><h5 class="post__date">2015-06-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/PWmI-ZUWAeY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">I'm Nikita from company named plumber
and I will talk today about memory leaks
in job applications so if you have just
realized that you are in the wrong room
you have time to leave thank you
if you are here for happy-end then
please leave it will be sad and
depressing story I want you first of all
I would like to tell that if you have
any questions during my presentation or
if you don't understand my Estonian
English then please interrupt me raise
your hand ask your question I will try
to answer it right away first of all are
a couple of words about my company its
Estonian startup we try to solve
performance problems we have started
with memory leaks and I am bold enough
to claim that we have solved that
problem so if you have memory leaks in
your application
plumber dot EU website is right place to
go and right now we are looking into
what tell what more problems we can
solve for you so if you have them then
drop drop us an email or tweet us and we
will be glad to hear about that
ok back to topic never illegal how many
of you does know what memory leak is
raise your hands please okay I said it
will do beside story how many of you
have struggled or had to fight or had to
solve memory leaks whew
it even said that I have anticipated ok
so I will just say small definition
memory leak is a situation where some
objects are not used by your application
anymore but garbage collector fails to
recognize them as unused sometimes
people ask me Java has garbage collector
Java has automatic memory management how
how can we have memory leaks
sometimes GC is not mind-reading device
unfortunately it's simple okay it's
complicated algorithm but it's very
simple if Knoblauch is not used anymore
it get it and it can prove it it'll
throw them away sometimes it cannot
prove prove it but today I will be
specifically talk about one class of
class loader leaks it's one class of
memory leaks is class loader leak sorry
in our experience class loader leaks are
the most common type of memory leaks in
web applications it's so common
that as we have stated in our title in
the title of this talk that I can bet
that your application have memory leak
when I when I talk when I make that talk
back in Estonia when we usually make web
applications
I was really bold enough to bet a beer
for that but here are too many good
developers so I'm afraid I will note
that both here but if your application
has no memory leak then please come to
me after the talk talk to me and I will
try to prove you wrong well I hope that
everybody knows what class loader is
class loader is the class which which
solar responsibility is to Lord other
classes if you have web web application
usually whole application the whole war
file or or ear file is loaded by one or
more class loaders which are specific
and devoted to that web application and
when your application is undeployed from
the web container tomcat jetty WebLogic
GlassFish then in theory all those
classes that belong to your web
application there they will not be used
anymore because application isn't
deployed all classes that belongs to
your application they will not be used
anymore so in theory all those classes
and all the resources that this class is
consumed they should be thrown away
reclaimed treat etc etc the problem is
is even one class or should I say one
object from your application of one
class from your web application is
really behind application has gone it
son deployed but one object left behind
for some reason Andy and I will show
those reasons today then we have that
unfortunate chain that every object in
Java Virtual Machine holds the reference
to its class every class in Java Virtual
Machine holds the reference to the class
loader that has lured in that class and
by by some mysterious reason I don't
fully understand so far every class
loader in JDK holds a list a vector
technically of all classes that it has
loaded so we have one object which
points to it to a class which points to
a class loader which points to all
classes of that web application so one
object holds all classes behind and if
you make a couple of redeploys during
your GV development or maybe in
production then sooner late your
permanent generation will be full and
your application will crash kaboom okay
some people tell me that
well why Drake here jerem gain Wilbur
man in generation we will be gone soon
no permanent generational problem
unfortunately not and I am not the only
guy who doesn't understand why meta
space in Joe 8 is better than permanent
generation because all you still have
that constraint resource ok you have
much more meta space that you had
permanent generation which helps to
postpone the problem not to solve them
so if you have Joey
we still have memory leak you still have
two o'clock well orderly but well maybe
your application will crash not tomorrow
but in couple of weeks
the second problem the second point that
no redeploy no problem
we don't redeploy we just restart so no
redeploy no claw slaughter league that
is valid point in fact that is by a
valid point
if you develop your application then you
can get away without redeploy at all you
can restart your server you can use a
rebel you can get away with it yes and
the new product production or test
environment you can get away without
redeploys as well you just make roll
increased are so just well we have
downtime for 5mins no problem
yes that's valid points but I really
like these leave this world a better
place that you have found it I think
that this is our responsibility as
sensible Java developer sensible
developers are sensible specialists we
should be proud of WoW of our work
should be proud of what we do so we
really should make this world world
better so one of the reasons of why do
this talk is to raise awareness of all
you Java developers of all you frame
your developers of all you library
developers there are many books about
what good API is there are many books
about if you write if you write reusable
library then you should adhere to these
rules but for some reason I don't see
many books that tell that talk about
your library developer please check if
you lie every leaks memory or not and
some libraries do
and in fact that is the that is the
problem is that most class load leaks
and in fact many memory leaks in general
in your application are not really your
fault one of the examples that I will
show you later on is you take a very
common library that everybody uses
everybody
you take that library to your
application well you you don't want to
reinvent all wheels on the some of them
so you do reuse of the libraries and you
have memory leak just like that
you take commonly used library of the
shell and you have memory leak in your
application and that is depressing for
me
you can't really avoid that unless you
know about that
you know what that library is really
doing under under the hood and how you
should use it and then you can use it in
the right way
you can stick that memory leak or fix it
it's not the right word to to say in
fact you can raise a issue with library
developers you can file a bug report and
pick that so and the main part of my
presentation is demo its live demo so I
have very high chance to fail miserably
because live demo do fail please excuse
me
but this demo application is in fact
that front-end application that you face
when you go to Palmer II to the side
well even when you use Plummer you will
use that application and the whole story
the whole talk begins
began when I one day I was developing
that fronted application it's really
quite small web application on that time
it was about three pages tiny web
applications three three web pages there
was it's common crude application GPA
with hibernate spring JSP WebSockets
small very small application I develop I
develop my JT's my JJ to redeploy
application and then we crash with out
of memory and that was somewhat a
personal insult because we fight memory
leaks an application that I am
developing on my machine crashes we've
out of memory error that of personal
insult I spent a couple of hours digging
into application what's going on with
the help and in that three page
application I have found five memory
leaks I am good developer sorry I am
good developer with a lot of experience
and I know what I'm doing I know about
leaks I know about class loaders about
classes etc etcetera by but in my
application with three pages
I had five memory leaks all of them from
libraries some of them because I was
stupid and I have used those those
libraries in the wrong way but
nevertheless okay let me switch to demo
so it's a this application looks
something like that
Oh
you don't see it let me try to figure
out okay good it's a small list of
machines and reports so I have already
prepared report so if my life demo fails
miserably then I have some prearranged
materials to show you otherwise it will
be too boring to just listen to me and I
have somewhat maybe strange arrangement
that I will have two copies of that
application running from my machine it's
in a way how plumber works so I will I
will start I will start the application
we start okay it's starting I have that
small application running of the war
file in the jetty it runs with plumber
and we are fighting close water leaks
here I demonstrating to you class loader
leaks and I didn't like face not ok it's
working and so I have application up
withdraw up and running
let me see yes all all is good it's not
demo from before I just keep all those
details I talk about leaks not plumber
so and now I just redeploy the
application I redeploy the application
and I let I will wait about one minute -
amber will analyze what what's going on
in that application after after
application redeploy and we have found
our first report and so we have do you
see you texture to the make it bigger
railroads began that's good that's
better so we have first report but in in
our application after we after we have
made redeployed redeploy is essentially
undeploy and deploy again ok so we have
some thread running in the application
the the name of the thread is abandoned
connection cleanup thread and that
thread is was left behind so when my
application runs somebody in that
application start a thread and when
application under ploys that thread was
left behind was left running and thread
holds the reference to class also
reference to class loader which holds
reference to all classes so what's going
on and it turns out that MySQL my MySQL
driver which I used in this application
to talk to my database the driver starts
a new thread
whenever you use it and it's the the
threat is never killed so which means
that as soon as you take my squirrel
Java connector in your application you
have memory because that MySQL joke can
alter start a thread and never kills it
how do we solve that first of all we
have to upgrade our version of my
dryer - at least five point one point 23
version because that was a bark in JDBC
driver in fact and it was soft in
version 23 so where is the where is
everything
so I have to update my driver version
and and other than that there's not
enough whenever some library new
application starts a thread or consume
some some other resources then sometimes
you have to clean up those resources you
have to shut down that thread for
example and that's that's really that's
really a common pattern you use
something in your application for
you have to clean up after application
dies when of like when application on
deploys it is your responsibility as
application developer to clean up some
resources in this case you have to tell
that abandoned connection clean up
threat of MySQL driver that eat that now
is right time to shut down because
library doesn't know well what is very
life cycle it doesn't know where or how
you use that driver you can use that in
standalone batch application so so it's
your responsibility to shut that down so
you use a server context listener for
example and when when that application
undeployed toy so in and let me I have
forgotten to increase font size here and
even if somebody not where should are
here it is
do you see anything good cool
so let me stop the application let me
hide these let me hide these and so when
you're when your application shuts down
and fortunately web application have
those shut down who if you have several
servlet context listen you're registered
in your web dot XML file or if you use
server 3 specification use annotation
and there is method method context
destroyed and in that method you can you
should make magic you should say abandon
connection cleanup thread shut down how
do we supposed to know that
honestly you take that mask well Java
connected to your application you read
maybe ma know how to use that which says
in a nutshell take that jar file put it
in your web rain philippe folder and go
and configure your connection pools and
such in such a way that's it how do you
suppose I know how do is supposed to
know that you you have to evoke that
magic trick you don't you google you
read you read backtracking
and then maybe you will find that out
ok let me fix that application let me
remove I promise you all other fixes or
a little bit quicker and artifacts
webbing
we good so okay
that was one problem so let me remind
you we have one problem that my SQL
driver starts a thread and keeps it
running you have to shut it down you do
it in this way but if you look here then
we have one more report that there are
one more thread left behind in our
application thread named Chrome Google
common base internal finalizer
and I you I take my world world I don't
use Chrome Google common base and Terra
finalizar in my application I don't I
have no way I had no idea what is this
so I dip deep I get really deep really
really deep and it turns out the
connection pool that I use bond CP the
connection pool uses it that come Google
base whatever
finalizer for some strange way of
tracking if some database connections
were not properly closed so it starts a
thread and thread monitors are your
connections closed are they returned to
data source after youth well I am good
developer remember that yes so I use
database connections in sensible way I
used a spring JDBC template I don't use
raw JDBC so i can assume and the
substance assumptions are cause of all
evils in this world but i can assume
that all my connections are good and so
i say data source disabled connection
tracking
I trust myself trust me
all will be good and that solves the
problem
one more illegal gun and you in if you
really need that functionality if you
need data source to monitor you to go to
go to then you're out of luck I haven't
found a way to shut that threat down
really in official public API so you can
do threads give me all threads ah
thread your name is come based Google
whatever shut down I will kill you why
why we as developers do that why we are
the library developers start a thread
silently on the background and we don't
give you developers consumers clients of
that library any public way to shut that
fourth down
or configure it not to use it not to
start up why
essentially it reads this means that you
are the library developer whoever you
have written that kongu base whatever
finalizer
you just give me a time bomb perfectly
knowing that it will sometimes explode
why do you hate me so much
we haven't even met yet you you know I I
really like that that saying that you
should write your code in such a way
that you that the next developer can be
a violent maniac who knows where you
live be sensible
be cautious okay next one that's not all
leaking classloader is being held by a
thread another thread one more third
already named bond CP key flaw keep
alive schedule and bouncy people watch
Fred okay that's easy
 B I know I know born 51 CPS
data source III used my application so
why bone CP start a thread starts fresh
and Aetna
and never shut them down well in this
case because I am stupid I am as a
developer and good developer about time
stupid developer and this particular
case well if you use data source you use
connection to be shut it down
okay that was my mistake
yes but really that was my mistake
yes but how many of you knows by heart
if a youth connection pool within my
application I should remember to shut it
down okay some hands
so this is this is in fact the second
problem somehow good books or good
teachers don't teach us that ok maybe
some do but not all not mighty teachers
at least that's the rule of thumb it
should be rule of thumb best practice
you start something you have to know at
least at this time when you start
something when and where you should
close it you should you you will shut it
down if you start something think at
once when will all close that when we
lie close that so ok
and for this report that's all so in in
one sweep in one redeploy we have found
three memory leaks in this application
an application really small one redeploy
three leaks ok we have hopefully fixed
sorry fix them that should be right ok
let us start application again if you
have questions you can raise your hands
and ask me no questions so far
yes
but the sorry I don't hear you what
live on
the last one was started by a connection
pool bonesy pika connection pool and
solution was to just solution Argos
solution one that is a MySQL driver
class they have introduced that that the
separate class as a solution in that
version 23 so we had see they have fixed
the board they have published now you
you you have that shutdown hook because
because before that they was now okay we
have started it application is good and
running we make redeploy again
so yes that's a that the reason I'm
talking about that you if you foil bark
report then some developers are sensible
enough to figure you out it down yes I
have question if you use you the the
question was so in essence we read yes
we rely on the third party on the
library developer to provide us an
official way to clean up those resources
yes that is official way you just have
to remember to call it to use it okay we
have one more report if I am not
mistaken oh that's good
the leaking classloader
is being held in the field named context
class law order of the class son avid
AWT app context AWT web application
I don't have that picture but what that
mystery fortunately if you ask me how
that calm that web application starts a
threat son abt up context he is really
yet another all its no no threat per se
but well some inner inner inner class in
that JDK then I really don't know I
really do not understand till this day
how were application why it touches this
class what it does in almost every
application
fortunately solution is easy just
upgrade to Java 7
so far I have used the Java six to run
those examples and this is a bark in
Java 6 and before that in Java 5 which
was fixed in Java 7 if I'm not mistaken
very very early update charge also so
you just update to Java 7 you just
update to Java
well as easy as that
and your nixels that's one of the
reasons why please update your Java
versions do not use Java 6 or god forbid
Java 5 upgrade gel 7 is good I hope it
will be more even better but at least
Java 7 please because I have double
reason here because we are developers of
a library of a product and unfortunately
we have to support when it whatever Java
version you do use in your development
environments and some of you I will not
point a finger use Java 5 till today
please upgrade come great please
ok that was easy that was only one or if
you really stucked
if you really stuck with Java 6 then
there is more convoluted way way to
solve that leak I will not dive into it
right now but you can see that is some
magic so just a break it's easier ok we
have updated let us start our
application once more with Java 7 with
Java 7 I hope this time
yep-yep Java 7 let us wait a little bit
questions so far no questions
music yes the question was all those are
my relief related only to threads left
behind no and I hope I will show you
shortly that no okay application is up
and running
redeploy because if is that if only
threads are problem that it will be easy
for us we just kill all threads but
unfortunately not so plumb board please
be good and give me report where is my
report oh here's this good that's good
leaking class loader has been held in
comb MySQL JDBC driver which has been
held in field named driver in Java SQL
driver in for which is held in the field
name array of the class blah blah blah
which is held in field name registered
drivers in Java SQL driver manager
that's brilliant
you know what do you remember I have
told you about that
good Google developer who gave me a time
Bob okay these is a good I don't know
son Oracle or JDK developer and the
Oracle QA leave the room he is ashamed
whenever you JDBC may beat MySQL be
Postgres Oracle database done Fanta
whenever you JDBC JDBC specification
which is the law specification states
that every JDBC driver every driver
which conform to JDBC specification on
class loading time should register
itself with Java SQL driver manager
which essentially means that Java al
driver manager holds a reference to that
class the JDBC driver class to class
implementation JDBC driver the good part
is the JDBC specification doesn't say a
word about the registration so you
change essentially every JDBC driver
developer obliged to create a memory
leak in your in your application by
justification it's not even what it's
yes
the question was isn't a easier way to
solve all those JDBC database driver
related issues by just loading drivers
in system class Lord or not application
clock logic yes that's that's right
that's why it's it's common solution to
put all those dryers into server class
lower class path then similarly a server
we load them not your application that's
right that good way to go yes but if you
don't that if you put JDBC driver in
your application in your war file then
you should know how to deal with that
but yes yes so sometimes we have to put
that driver into your application into
web application so we need to fix that
and how we do that is well I think it is
this in this particular case it's easy
bond CP connection pool is clever enough
to have that jarred deregistered dryer
on close so whenever you close that
connection pool it will handle that
automatically itself and it will Derek
after that driver from driver manager
because driver manager does have a
method they register yes but it tastes
nothing about when and how to use it or
call it or whatever you had a question
and these this is this method is called
during configuration of your connection
pool so you
and I didn't understand okay
yes the question was if you have some
for example rest service with a bunch of
concurrent users how to solve that
memory leak and that's not related you
start your application and you configure
that connection pool that you use that's
own application star and this particular
key is you just have to configure your
connection pool that if this connection
pool is closed sometimes in the future
then please throw that driver away
because that driver is application
specific so whenever application is
being shutdown undeployed then we just
throw that driver away in some other
other cases I had to ride that strange
code myself something like that
I just see the drivers you drive manager
knows aha that's my dryer throw it away
strange way but for me that that does
mystery but if you have memory leaks by
specification that's that's wrong planet
I don't want to live here oh really
really
ok hopefully we fix that start our
application again I have a couple more
report
I hope they will work and I have time to
show them to you but if not then you can
come to me later and I will show them to
you if you're interesting okay so so far
we had so applications up and running
let make redeploy so so
for we had three reports with five
memory leaks five classloader leaks one
by specification one by using library
one by talking to database so I bet you
have memory
well what at least I think for the first
time today we have a you lumber class
here so that's my application class at
last at last application is wrong not
library not JDK and so on one hand that
is classical example of memory leak when
you use Java util logging Java EE
logging and when you use custom log
levels that classical example of class
well the leak when you read some bloke
article about class loader leaks chances
are high that example will be about
custom log levels because if you use
custom log level in your application
then that djibouti logging level class
cache all those custom logs it holds
references to all custom log levels in
that is bug which is known to to Java
community it is filed in Oracle bhaktraj
tracking for if I am NOT mistake some
years already I even can
look it up
created when war created six years ago
so that bug is known for six years and
not yet solved and again one of the way
to solve it is whenever your application
shop shuts down and that context destroy
method on our cloud service listen here
you can just using reflection because
there are no public API look into that
djibouti login level class and throw
away your classes in my case I am lazy I
just will not use that custom log layer
that's it no custom no level no program
unfortunately if you if you think that I
don't do custom look level that don't
matter to be J both you use custom log
levels if you JBoss server you have a
chance that you have similar main memory
J both does use custom log levels I told
you it was a sad story
so you use MySQL you have memory leak
you use database you have memory leak
you use J both you have memory D okay
I'm a little bit too hard from tables
right now but all gay one more time
redeploy how many men relief so far we
have found six seven too many
that's all in very small web application
not simple but small a couple of pages
some WebSocket machinery some JDBC calls
one one list that's it okay why do I get
exception oh it's working
okay next report here it is bone CP
again what ah ha Joon GI Joon GI it
turns out that for some reason we in
this application really use J and J we
publish some resources to change a
directory and again if you start
something you have to shut it down if
you publish something to change a
directory then you have clean it up when
your application shuts down you have to
remove all those resources from James i3
if you publish something and your
application is going to be shut down
then please remove that and then and we
will do that again in our
several contacts listen her on
application undeploy short application
though and start to start it again and I
do hope this is the last one that I that
I want to show you let me check my old
report
I have prepared okay that we have seen
that we have seen that we have seen that
we have seen good life Deming is working
on the by the plan
imagine that okay one more
okay I do not restart application just
to show you this it turns out that our
application used thread locals and
thread locals in web application is very
complicated see because web application
usually use thread pools provided by web
server and whenever you use thread
locals which are bound to thread which
are out of your control because those
threads are managed by web server so
when your application shuts down thread
managed by web server by design and that
is good thing they left behind they
still running but you have those values
and thread-local variables well you have
not really so again when you start
something on when you put something into
scope into thread local you should know
when and where you will remove that so
in this particular case well I just
really have written my classes we don't
use thread locals anymore because that
was easier
to manage school of thread-local
variables so thread locals if you use
thread locals again know exactly I put
something into thread local here and I
will remove that from thread local there
variable here and I will always reach
that point the red local variables a
century our custom scope it's your scope
that you you create that's not local
scope as any other method body it's not
global scope as with some class static
field
it's your custom scope and you have to
mind manage that okay I please give me a
patience for some more minutes and I
will soon stop so I think that I think
that's it and mostly I have one report I
have I would like to show you once more
JDK bug if you use HTTP connections when
in some cases that some dotnet www.h TTP
keep life cash is being created is
created on the background by JDK which
starts a new thread which has your class
loader at the context class loader and
so you have memory leak already and
again solution is he is is simple
upgrade to Java
upgrade to JDK that is known bucket it
was fixed and so I think that is it that
was all report I wanted to show you and
thank you for your attention if you have
questions then ask come here and ask or
ask right away if you want
here is my digit code you can contact us
Sheru without your memory related
problems thank you and Quentin</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>