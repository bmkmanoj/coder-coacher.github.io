<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>The Diabolical Developer’s Guide to Performance Tuning | Coder Coacher - Coaching Coders</title><meta content="The Diabolical Developer’s Guide to Performance Tuning - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Oracle-Developers/">Oracle Developers</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>The Diabolical Developer’s Guide to Performance Tuning</b></h2><h5 class="post__date">2016-09-22</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/-XI9kJGCHtM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so how was the first day it's great so
far yeah what's been the favorite talk
so far show one out the which one
really I can miss that one on the
schedule that's that's kind of cool
littering unicorns what was that about
okay right agile development and the
unicorns they tried to deliver awesome I
like that that's fantastic who gave that
talk actually Oh cassia oh yeah she's
she's she's a she's dynamite italia we
went skiing with her in sweden northern
sweden last februari and she was on the
national polish national team so she can
really rock it i'll tell you yeah it's
fun too yeah so so so was good well I'm
glad you enjoyed that but that's really
good tastic so I got 5 30 right now and
we're ready to go okay so this is the
diabolical developer unfortunately the
diabolical developers in London right
now and and that's Martin my My partner
and crime and I talked to him this
morning very early this morning and I
said dude I'm not the diabolical
developer you're the diabolical
developer I may be devious conniving and
of all kinds of other undesirable traits
but I'm not diabolical so um so we
started I didn't actually I so I wanted
to deliver the same messages but in a
slightly different way so I actually
said let's try this one here which is
like my tuning with cheap drink and pour
tools talk so I think we'll get the same
messages it won't be as fun as Martin
delivers but hopefully just as useful
everything so so about me we have this
obligatory slide that basically says a
whole bunch of stuff that you can find
with Google's so we'll just pass over
that that Jay clarity is actually the
going interest between Martin and myself
were actually a tooling company so we
build intelligent performance diagnostic
tooling so we use machine learning to
help people understand what's going on
in
application and we also do a lot of
garbage collection stuff so then i did a
g1 talk this morning if anyone happen to
be around for that and i do performance
tuning training and some people here
might recognize her this is calif us and
so that was the recent one we had i
haven't picked the date for next year
yet so disclaimer and the resemblance of
any opinions recommendations or comments
made during this presentation to
performance tuning advices merely
coincidental okay so um you know why do
we put this up is because performance
tuning is a reaction to events that you
see in a highly localized environment
and every localized environment is
different from any every other or
localized environment which means that
don't you know the things that work in
one environment may or may not work on
another environment so you're you're
Miley to me may vary that said you know
the purpose of this talk is to actually
well you say find out why is my
application running so slowly right and
generally women did to get this question
is like you get all kinds of fun things
happen it's like who's been in the into
the battle like it's the database guys
fault they're slow and it's the
application guys well write the database
guys you've been into the any of these
wars who's been into that type of war
right and and the question is what
happens if you're both right or both
wrong right you're both wrong it's not
his fault but it's not your fault I
there's just something weird you know
going on right so you know we're always
asking these questions like why is my
application slow you know and quite
often the answer so we're waiting for
something so you know what are we
waiting for and and then people do all
kinds of weird things like they start at
execution profiling their application
which is telling them what their
application is doing but generally not
telling you what your application isn't
doing and the bigger performance
problems are generally a result of what
your application isn't doing as opposed
to what it actually is doing right or
what it should be doing so um so what we
you know so over the years or eons or
decades what you're going to call what I
finally did was they took all the
thoughts that I had on the subject and
said you know where people have problems
they don't know where to start generally
and we get into all of these wars
because we don't actually have the right
measurements and stuff like that so you
know so where do we start how do we get
measurements and you know these are all
the questions that we that we ask so
that we can sort of start working
together to try to solve these problems
right so the one thing I did is I took
this thing and I said okay let's build a
conceptual model you know it's a let's
bring structure to performance tuning
let's make it so that i can do fixed
cost bids on performance tuning
engagements which i do all the time
right so if you do fixed cost bidding
you know that you it's risk huge amounts
of risk and performance tuning is one of
those things like who can schedule how
long that's going to take right so that
seems like the biggest risk and it seems
like you can you can mitigate mitigate
all of that risk which is by coming up
with some structure around the whole
processor performance gentle and so it
really that's what this talk is about so
and really i don't want to talk too much
i just want to get through all this crap
so that you can do it right we'll do the
demo and actually you'll do the demo and
and you can just see how it all works
right so that so the model i came up
with a singer called Java performance
diagnostic model
just because yeah everything has to have
a name right so I figured out too late
in life is that if you don't have a name
for things and people don't pay
attention to you all that much so it's
much better to come up with a name so
that's it and it really serves the
purpose of any other system model like
an engineering and experimental sciences
and things like that the first thing you
want to do is you want to come up with a
model of the thing that you're trying to
study and that's all I really want to
offer here is a model and from the model
we should what should fall out of that
as a methodology tooling how to do the
measurements all of these types of
things right so that's that's really all
it is so here's our conceptual model
just everything you see you should know
what it is right there shouldn't be
anything surprise in here but those are
all the things you have to deal with
when you're you know when you're tuning
a system well almost something is
missing right and and what's missing is
actors right so now this really
completes the conceptual model of the
thing that I'm trying to tune and you
can think about how all this works right
so we have some more hardware we have a
JVM we have an application right those
are all very fairly static things they
behave very predictably or you know but
actually they don't do anything they
just sort of sit there until you get
users involved and they start the users
start doing things and also you get the
dynamics in the system and you get the
downward pressure down onto the hardware
right and then you do the hardware is
really what we consider to be our
consumable right so finite it's a finite
resource it's a consumable resource it's
a non shareable resource more
importantly when you get down into the
hardware we we have no notion of threads
we have no notions of process these
things are very very weakly supported
down there right so this is a consumable
resource that's that's consumed by every
all the activities that are happening on
the machine right so the hardware's just
seeing streams of data and instructions
thrown at it and it doesn't really know
or care where
these things are coming from right so um
and that sounds like oh god you know
it's like sounds like more chaos but
actually that's a good thing because
really what we can do is we can set up
monitoring of consumption of the
hardware we know the throughputs we know
the band wits we know the volumes of
these things and so we can understand
what the utilization of all the
components are on the hardware and we
can use that to make inferences to
what's going on upwards in the stack as
a matter of fact what we can do is we
can actually use machine learning on
this data to make the inferences for us
so this can happen in seconds okay but
we can do this manually to write so
things that we need right and we need
some monitoring here to understand
what's going on so we want to see what's
happening inside a layer we want to see
what's happening between the layers
right so there's some bass part base
mark benchmarking basics that we have to
adhere to first off we have to be aware
of this performance testing anti-pattern
called data light and data light really
says I don't have the volume or the
veracity of the data that i need to prot
to apply proper pressure on the system
as you can imagine with this methodology
since we're going to look for patterns
in the hardware consumption if we're not
able to apply the right pressure from
the top down on the bottom up then we're
going to get the wrong signals from the
hardware and if you get the wrong
signals from the hardware we're going to
make the wrong inference as to what's
going on okay this is why testing or
having making test environments is so
incredibly hard as a matter of fact it's
so incredibly hard that the smart people
have finally decided okay we're not
doing that anymore we're just going to
test in production which makes
microservice environments even more
interesting because that's that's an
enabler of this type of experimentation
okay so you know the big you know the
you know caching double-edged sword
really helpful in production
environments short-circuits calls to the
slower
underlying technology right and if we
don't look after cache hit miss ratios
in our test environment we're just going
to be measuring cache hit performance as
opposed to full stack performance right
so that's why we need to look after you
know having the right volumes of data
and it's not only date of feeding the
application I could have a production
database that I rep over to test its the
data that we're actually using to drive
the test harness as driving the load on
the system right I could have a terabyte
of data but if I'm if I'm only ever
looking up Mickey Mouse or Donald Duck
it's going to be cached and cash very
quickly and i'll send we're only cash
performance we need to look after it at
both ends of the task to make sure that
everything is working as it should
observe abels time budgeting you know
just like grandma said right need to
watch your time that's what we need to
do here just take very coarse
measurements of time and then and then
once we see the end-to-end time then
what we can do is figure out where is
our time budget being spent and you and
we know that Andals law tells us that
the you know the the places where the
vast majority of our time budget is
being spent is the time we should focus
our that's where we should focus our
efforts as we're going to get the
biggest gains quickly and we always want
to get big gains quickly with as little
effort as possible so I'm going to
collect timing measures with that
garbage collection it's another key
performance indicator for me so with the
garbage collection I can actually tease
the application in the JVM apart so that
helps me categorize the type of problem
that I'm actually dealing with and the
interesting thing is I can do this stuff
over the phone with the client I can
just tell them that stuff ask few
questions get them to send me the GC log
and I get a high level diagnosis of the
problem right within a few minutes over
the phone which really makes it nice to
do the pricing afterwards
independent consulting pricing very
important right so okay you know and you
know so we get the hardware consumption
metrics you can get that very quickly
the time budging they won't have no
worries look at the garbage collection
do analysis and that takes about two
minutes and bang we're pretty much done
there's other place where we can get
juicy information I'll just put it in
here for completeness you can download
the slides and read about it but it's
some there's a lot of performance
counters in the serviceability agent and
you can get them through some MX beans
jmx beans so we have the benchmarking
process here whoops sorry about that so
we got a benchmark we're gonna figure it
make sure our environments all set up
and then you're just going to run it and
we're going to ask the question use the
user happy with the performance if not
we're going to go into loop which
basically asks while the user is not
happy and the user has money right we're
going to profile the application to
identify or get the metrics to identify
the dominating consumer and then we're
going to fix the application using that
information that we get from the
profiling and of course QA it and then
we're going to rebase line it and then
just ask the question again right is the
user happy does the use or have money
and we just keep cycling till one of
those conditions becomes false right and
which is the right way to do it actually
because if the user doesn't have enough
money to make the system to go fast they
probably are going to have to they
should have yeah anyways yeah
so here's some questions if my
application is slow and cpu is one
hundred percent the question is what's
consuming the cpu this is a simple
question we don't have to ask very
complex questions there as a matter of
fact most of the people I talked to or
send surveys that we ask these type of
questions do are not technical at all
they're like bank tellers and and end
users and things like that right so they
don't need to know anything about the
system they can give you all kinds of
clues as to what's going on so that you
know exactly what the what the problems
are if my application is slow and the CP
is not a hundred percent utilized what's
keeping my threads out of the CPU why am
I able to get the work done cpu is the
fastest thing I got if I can't utilize
that then I'm not going to be able to go
any faster right two very simple
questions that's all you have to do is
answer simple questions that's it right
and you think you're not yeah it doesn't
work okay well we'll see now what I'm
going to do is I can put the load on to
try to answer these questions so i'm
going to i'm going to ask this question
who's the dominating consumer the cpu
and what I mean by dominating consumer
the CPU is that what is the activity
that's occurring within the system
that's preventing right on the cpu from
being utilized or what's the activity
that's fully utilizing the cpu so what's
going on here okay what's tues
dominating the performance profile of
this particular machine box now i'm
speaking about hardware level I don't
care about the application or anything
else okay and I have four choices the
application could be dominating the JVM
could be dominating the colonel could be
dominating or I could have no dominance
those are my four choices okay and each
of them points to a different problem
and each of them points to different
recipes and things that we can follow in
order to further diagnose the problem
and here's our decision tree and there's
a few magic
in here that i will give you okay and
these are by experience and backed up by
machine learning afterwards ok so I'm
going to ask is the system time the
colonel time greater than ten percent of
the user time so i give this off of some
monitoring tools most monitoring tools
will just give you total cpu completely
useless you need to start getting a
breakdown of some of the counters that
make up cpu time right because if you
just look at CPU time yeah some is
Colonel some of its system and there's
this nebulous thing called idle and idol
isn't really Idol idol is just things
that they didn't count for other things
that are happening right so you really
so you can get a better breakdown of
performance counters from the cpu that
you can understand what's going on right
so if we're in this condition the super
system dominant then I have a bad
application system interaction the
applications are putting too much
pressure on the system and what I want
to do is I want to try to figure out
what that is you know so the common
things that we look for very simple you
know what is an application do with the
system shout it out sorry
file reading so I o Network interactions
right lock acquisition no no really
right so you know there's an anything
some stuff to do with context switching
better I'd say context switching is a
symptom of a problem it's not a problem
in on its own okay fantastic and there's
a whole list tools over there you can
use to figure out what's going on in the
interaction between the application in
the system now the next questioning and
ask you know do have a lot of idle if I
have a lot of idol then I know that I
have a liveliness issue within my
application something is preventing the
threads to get to the CPU to be a lock
it could be that simply I don't have
enough threads and we've run into that
problem quite often you know just up the
thread pool size for something right
allow yourself to get better saturation
on the hardware right so in this case I
can look for thread liveliness thread
cardinality and just thread inventory
and that's an easy thing to do what
would I use to do that remember this is
poor tools cheap drink thread dumps
really simple right nothing complicated
here so if I'm in the if I mean if that
condition is fine i'm able to derive the
cpu to reasonable levels of saturation
or one hundred percent saturation then i
can ask the question do I have a memory
efficiency problem that's we're going to
use the GC log okay so generally what
I'm looking for rates of allocation
around 300 megabytes per second or less
I'll tolerate up to a gig where I might
not bother about it as you can see some
of these numbers are not imperative
they're kind of fluffy even the ten
percent numbers a bit fluffy okay so
it's not precise which is why we have to
use machine learning for it but yeah so
you know somewhere in around so it seems
like star getting above the gig a second
constant allocation rate I have a memory
efficiency problem
okay if I have a pause time issue I can
pick that out right but there's two
directions to go here one is improve the
memory efficiency of the application or
enter some GC tuning ok so I'm going to
go in either direction if the JVM seems
to be the problem so that's where all
the memory problems are bucketed and
then by the time we get to the
application what we're looking at our
execution problems so that's when we
start doing the execution profiling and
then we're going to do strength
reduction on the algorithms in this case
right so you can see all of the major
counter / forum scat aghori performs
problems are going to be categorized
here and from there we can actually go
on to the next step to figure out what's
going on so it all makes sense it's
really simple right good now we're going
to do it how's that yes you can have a
small question
that's the so okay so when you get into
large clusters and things like that when
we do like very large applications will
start with time budgeting so that's like
outside in and then then we'll look at
the hardware counters and then go back
up the stack to figure out what's going
on right but when so this is still a
top-down approach a bottom-up approach
is actually looking at hardware counters
and directly and then coming up from the
hardware counters right so it's a
different type of tuning that we do
mostly in low latency environments okay
so let me get I'll sorry I gotta get
these are glowing strange glasses that
can look that way and have to look down
sir and probably better if I near this
thing right now see what's going on and
okay so i have a small application here
which of course i call cheap drink so
let's open up a little window here i'll
make it bigger so you can see what's
going on don't need that and okay
fantastic so what do we need to do well
i mean i should check my runtime
conditions here so i'll go and check my
runtime conditions oops what's that i
was running it before because i was
testing some tools they had some bugs
and the tools so i just installed a new
JVM just before here and it core dumped
yes i love cordones okay so let's look
at our runtime conditions so you know
basically the one thing I want to hear
is I just wanted to make sure that
somebody hasn't done anything stupid
with the parameters which means that
they actually haven't said any okay
because if people start setting
parameters you can always have some like
what is your motivation for setting that
they're going to like well I read it on
stack overflow and I'm going to say well
unless Peter Lorre wrote this to a
specific problem you're trying to solve
that I wouldn't trust it I wouldn't even
trust me on stack
Flo saying office that's it so you know
really so I just want to make sure I
don't even know how much memory I need
so I'm not gonna set that everything's
everything's going to fault all i know
is i need GC logging right and that's
how we're going to start if i'm going to
start playing with JVM configurations I
need to have a measurement that says
that this is actually something I should
be doing right so everything looks
perfectly keen that way is fantastic
okay oh and I need something to monitor
CPU because remember we have to identify
dominate consumes the cpu which means we
need some breakdown so I'm you're just
going to use this really bad tool I did
say perform seeing with portals in check
so now we actually have a benchmarking
thing going on here so I'm going to turn
my Wi-Fi off and we got all kinds of
other processes here I mean you know you
don't want any spurious noise coming
into it so there's all kinds of things
I'd drop box he needs that I certainly
don't want you know one of my clients
given me a foul on running this
benchmark that would be rather confusing
because your performance counters are
going to you know and you go off the
scope so you know quiet you know
basically make sure that you have
controlling the environment you can
slick at the slip a chart here and it's
like yeah yeah close enough you know
good enough for the demonstration but
you know it should be ok ok so we can
just now run it right why not oh one
thing we're missing we don't have a
performance requirement do we how fast
we need to get this thing to run before
we say we're done when's the use are
going to be happy well it is a little
batch processing so i'm going to say the
batch process should run in under under
three seconds we'll make it easy ok ok
fantastic so we're going to run this
thing it's got some whoops I know how to
type
it's got some compiling here and I hope
this is under the new version so we
don't core dump and we're processing and
we're doing stuff and life is good and
we're processing things I think we've
passed the three second threshold heaven
ok so somebody I have forgot to keep
track of that so sorry ok excellent so
it's running what's wrong what's the
problem here you tell me first question
we can answer right who is the
dominating consumer the CPU now you're
going to remember that flow chart system
excellent it's system ok so now we can
do some system profiling to figure out
you know why is this application putting
so much pressure on the system Kirsten
might be a little hint in the output
there but let's just ignore that for now
and it's going Wow ok any idea as to
what this might be sorry
might be is it might be writing two
discs so we could probably do something
like I know I owe stat5 see what's going
on here probably shouldn't do this in
the middle of the base lining but it
doesn't really matter well I don't know
doesn't look like a lot of disk activity
I've turned the network off so you can
pretty much eliminate that so ever you
know we're not getting down to too many
other things that you can actually mess
up here memory that falls under a
different dominating consumer thing did
that shows up differently yeah it you'll
see ya
well I'm am I using for i'm not even
using for as a matter of fact and
whenever you see this pattern on this
type of process so you can say that i'm
using one core right it's just the round
robin effect of the scheduler that
distribute us across the four cores and
we shut off the hyper threat hyper
course right so that's that's a very
common pattern one year single-threaded
yeah yeah that's really fun right yeah
it's really cool Oh some definition of
idle like I said this is idle doesn't
mean idol okay but okay but we know that
we have a problem and it's not I Oh
related so it's got to be I don't know
anybody want to venture a guess over
there sorry context switching is a
symptom it's not a problem it's a
symptom of a problem yeah it's like high
temperature locking yeah locking why not
because look you know as I said clue in
it over 116 seconds okay we're gonna go
drop below three this could be fun right
locking okay so how we going to find
that well okay then now we need some
tooling right let's run it again and
let's get some tooling and play here so
let's shut this off i'm going to use
visual vm because that's my favorite
weapon of choice for some of these
things and then say okay well let's
figure out what we can do so what i'm
going to do is I'm going to make this
small so I can make a big you'll see
what I mean in a second just trick here
just let me get it hooked up yet okay so
now we're attached to the process I get
a profile here actually no I just want
thread pull puffing look at the thread
profile here turn off that and I'm going
to release the application bang bang and
here let me make a big so you can see
what's going on
oops made it a bit too big house that
you guys see in the back with the slice
I need it bigger yeah so it's a bit sort
of the screens are low and the room is
flat but you know okay so what do we see
here yeah it's locking Jay what a
surprise this is one of these journeys
as it's helpful to know what you're
looking for before you go looking for it
because the it's easier to find right so
we so we did the analysis and everything
I always suspected locking and you know
what do you know locking okay so let's
get a thread don't maybe we'll get lucky
and yeah isn't that nice okay who likes
reading thread dumps not me I've read
hundreds of thousands of these suckers
but you know that's why I rely on
tooling yeah I don't like reading them
either so i use this a nice plug in here
called TDA and hopefully i got the right
one installed because the jvm team and
their total disregard for tooling
decided to change the format of the
thread dumps which breaks the tooling
but you know I look like at the right
one plugged in 48 and we'll be okay okay
so we're looking at monitors let's do
that oh and look at that I did it again
you're not they're not going to like me
run audio and here we go look at that
there's one with the red box around it
right you see that one I say I think we
can we can declare victory here right
yes victory take a look and see what it
says and bring it up and oh darn no
there we go here we go every see got
that wow look at that that's not nice I
have a vector into my code anybody who
know want to know what to do next
okay so how do we determine the locking
was issue well we knew it was in a
network issue because i had the network
turned off so yeah okay it's a little
artificial but you know it's it's a demo
and and we knew that it wasn't disc
because we used iostat right I could use
netstat or some other tools to figure
out that it was a network right so I do
we just did it at the quick and dirty
way here oh I see good yeah okay so
we're still open in visual vm and we can
go back and you can look
and I need to go here yeah so oh all the
threads are dead yeah exactly i need to
scroll back thank you there you see the
red red bad okay anytime you see right
in a profile you got to go like whoo bad
red means that it's blocked on a monitor
right park is actually a brownish
reddish funky color I don't know what
that is all i knows my daughter likes
doing color charting would probably be
offended by it but that's it yo yeah
okay I can do that thank you for
suggesting that I do that how's that
does that help help you now you can see
what all the colors are right there okay
the green bit is user the red bit is
Colonel sorry I didn't explain that very
well thanks for asking those questions
um yeah so that's like really bad
because the threshold is ten percent not
fifty percent alright so actually it's
worse than that it's like a hundred
percent because it's it's a hundred you
know they're equal so it's 5050 so this
kernel time is a hundred percent of user
time so yeah it's like yeah it's got a
bad case of bad okay excellent so so we
so basically going back over to our
thread dump analysis tooling thingy here
you can see when we zoom in that
basically everybody see the piece of
code we want to look at yeah okay
awesome so keeping in the theme of poor
tools organ do is we're going to go VI
calm /
and we're going to go to line 24 and I
just I'll just make this a little easier
to read with wrapping and crap like that
yes yes I know it's a small piece of
code but this is really what i call a
microcosm of things that we commonly see
in macro environment so it so you can
see things in here probably very easily
but you know they get off he skated in
larger code bases so just stay with the
program and let's look at line 24
there's the problem what are we going to
do synchronize block yeah we have a
synchronized block and don't you guys
laughing at that's my ear you're
laughing at my code I can tell so what
are we gonna do yeah we have a
synchronized map with a singers block
right so what do you want to do yeah we
see this don't worry it just doesn't
look this obvious sorry
lock on different objects that sounds
rather frightening yeah don't do that
yeah ah someone suggested something I
like finally here we go let's go in here
put and just correct me if I'm
if I make a mistake just let me know
really quickly okay so i can just go
over here bom bom-bom damn see we don't
need no stinking IDs okay everybody
happy now cool and what other one why
why would I change that I don't have any
data that says it's a problem Touche
excellent yes as we say we're
performance tuning we r you know I yeah
okay I would probably do the other one
in real life but when i'm tuning the
more code i touch the more ownership i
take on of the bugs right you touch one
line of code you're guaranteed to create
at least a dozen bugs okay so I mean
you've heard the joke right every
program can be reduced by one
instruction every program contains at
least one bugs by induction every
program can be reduced to a single
instruction that doesn't do what you
want it to do never mind bad joke again
okay whoops what did I do um so now
let's get ready and we can run again
yeah so let's go here get it up and if
we're lucky we'll be good Oh press enter
30 baselining and
see what happens down whoa cool Wow
imagine what happened there right okay
well we still have a problem right it's
not not three seconds so we still have a
problem now the question is who's the
dominating consumers the cpu this time
well it seems like it might be we don't
know this is the its move to user space
but we don't know if it's the JVM or the
application we need something else we
need an extra piece of information yes
sir
well it was just causing our application
to be single threaded Oh what was wrong
with the synchronization and I said in
this case is causing our application to
be single threaded okay so we just so we
had a liveliness ish liveliness issue so
what if we just cured the liveliness
issue by using a more concurrent data
structure yeah good choice obviously
okay so now what are we gonna do we need
to look at the GC log so I'm going to
use my favorite weapon which is
unfortunately not a poor tool well
unfortunate for you guys not for me but
so and i'm actually going to analyze
this GC log mmm oops actually you can
see I was analyzing more GC logs earlier
where was this Oh desktop and I'll get
there the glasses are weird um cheap
drink it's under the sea's I guess
there's a GC log let's load her up and
okay so now I'm going to make this again
smaller so we can make it bigger what's
going on how's that okay so yeah so we
have you know so this is our
unfortunately commercial tooling but you
know you can get open source versions if
you're not willing to do this but let's
let's take a look at what's going on
here so yeah so oh wow we have two
system GCS in there we have 206 young
generational collections but all in all
the pause time picture looks like 91
milliseconds so if i take seven point
whatever seconds and subtract 91
milliseconds doesn't seem like that adds
up to three okay so it doesn't look like
garbage collection is an issue they look
at heap it's stable this in my heap
utilization after the collection oh by
the way here's my system GCS you can't
see the guide there but you see these
little sub tank my sins
Wow ok so the benchmark starts here so
the picture is even worse than first
imagined because you know once I take
off the system GC time it's like not
even 91 milliseconds anymore it's less
so that doesn't look like it's going to
be an issue there's all kinds of other
things we can look at here is a
resonance set size but let's look at
allocation rates ok so it's the
allocation right here
yeah it was like seven gigabytes per
second whoa baby it's nice eh okay so
based on this information the dominating
consumer the CPU is going to be the JVM
the reason we have a memory efficiency
issue hi allocation rates okay to make
sense okay it's all just you know very
rigid all our boxes are working out very
nicely
with the GC log analysis using visual
team no there's no GC log analysis tool
written into visual vm so it's very
difficult to do this type of an out like
an allocation profile you can do it with
the MX beans but the numbers are not
accurate these are reasonably accurate
numbers okay okay there
um it's much harder i will say that Oh a
standard do we stand a chance without
this tool my answer is no you don't I
know to be quite honest I mean the
reason why I wrote this tool is I was
just getting frustrated with not being
able to get this type of information in
a way that I wanted it and so I didn't
actually write it to become a tool for
whatever I just wrote it because as you
know our CEO is quite annoyed at me
because customers don't say but what if
it did blah and I said why would you
ever want to do that useless a don't
care about it don't keep pepper me with
requests from customers I wrote this for
me not for anyone else so yeah and then
he gets a mad and then you know they
would come to a compromise but yeah but
Angus you know the point is is that I
just wrote it because you know you have
to do this type of analysis and the
other tooling that we're dealing with
just in my estimation was not up to
scratch although we've put pressure on
some of them so they've gotten better
recently I'm is Mission Control helpful
um gosh you know Marcus heard is a
really really good friend of mine so I
have to say yes yeah yeah we're gonna
have a talk about that later yeah no I
think Mission Control has its uses of
purpose but again you can't do this type
of analysis so we're still okay with it
okay so let's okay so what are we going
to do now well obviously we're going to
do some memory profiling all right are
we doing for time Oh 15 minutes okay
we're going to be good let's run
visualvm again
and I'm going to attach just as before
now I'm going to go to the profiler and
i'm going to say let's get the
allocations and of course i want to
record the allocations fact races it's
going to give me my allocation hotspots
and you see this is really cool people
think i'm clever but you know this is
like really see how easy it is ok uh
right let's put some load on this puppy
Oh Martin would not like that ok and
yeah so should I make a big so you can
see now there's two ways you can look at
this you can look at this as a volume
problem or you can look at as a
frequency problem I tend to like to look
at it look at it as a frequency problem
first then a volume problem later ok so
which means that you know if I'm going
to sort this anyway I'm going to sort it
on objects allocated now in this case it
still gives me the same answer but you
know tsilivi right we have runaway car
care car thing so let's take a snapshot
figure out what's going on ok so now we
got the car race i'm just going to go
over I mean this is mechanical stuff now
I can talk around it if you want but I'm
sure you're all clever enough to figure
out that these three guys are the
allocation hotspot hot pass open it up
take a look and my word what shows up in
the list again what a surprise ok
we see that fine person by name abstract
stringbuilder thingy in there don't know
what that's about don't really care
figure that out later it's open up this
one that's a stringbuilder of
constructor oh there's fine person by
name again Wow another big surprise okay
to string string builder fine person by
name again you know I think we're done
yeah do do do we need to see VI again
yeah okay that's let's go look at VI
again this is really fun oh it's still
processing but I don't really care about
that let's kill that tooling nine
percent one there don't do that at home
so and yeah I think we're down in this
range again so okay so what's going on
down here what's happening anybody see
the problem we're missing an abstraction
aren't we you see the + syntactic sugar
for a stringbuilder appends right and
really what you know what are we doing
we're doing a look up in a table and
we're using two fields to do a lookup on
a table what's that called those are the
database guys got this right a long time
ago what do they call it it's like a
composite key yeah so let's introduce a
new abstraction here
new
so I'm going to pass in the two keys now
people sometimes will say well let's
have the collection of collections and I
say coats mail missing abstraction okay
so I need to do a little bit more work
here to make this all compile so do make
sure that I don't make any mistakes and
I press the insert when I shouldn't have
there and then I need to do
ok I think we're good
where where oh right thank you see there
is a use for an ID okay right there yeah
oh no before yeah I've done this before
thank you you can tell i'm not being cat
okay okay so we can run this now so
let's get rid of all of the XX stuff
that new kill done bang run it release
it here we go boom boom yes baby victory
right we got her okay you guys did a
good job right you did the whole thing
excellent so as you can see the process
here is just very repetitive one small
step at a time just go through the whole
process like you know from top to bottom
just one step at a time identify the
dominating consumer use that information
to go to the next step you're generally
never going to go from from A to Z
without going through b c d e f and
whatever the rest first yeah i know a
lot of people like to say but i have
this problem here and tell me what's
wrong and it's like no now we have this
very repetitive process very boring you
don't have to think actually if you turn
your brain off and do this it actually
works better and and eventually you'll
get down to the where you need to be yes
sir you had a question but a huge ass
down she'll get to second yeah
okay you're absolutely right i mean this
is like a very boring part of the tool
it's very useful but very boring but we
also have other analytics there so we
can tell you things about your GC log
that you're very unlikely to see for
instance that I can tell you if you have
noisy neighbors and if you're running in
a cloud environment I can tell you if
you have configuration issues in your
Linux system I can tell you if your
collections are triggered by other
conditions inside the JVM that you might
not be aware of so we have a whole bunch
of different analytics in there that we
are very useful to us and MTU bingo
right and we do we do this streaming
from live systems also but I don't want
to really get to commercial here that's
not the point okay and now it's your
turn again you haven't used it you good
no you're ok you're good ok because you
still haven't used up your question
quota so is there any any questions for
anybody else in this whole thing yeah
okay he can go yes sir yes absolutely so
the way we log in the JVM today is
all of the logging frameworks for use
are very very very badly thought through
very badly constructed and unfortunately
it's coming to the JVM also yes that
means log4j that means log back that
means slf4j that means everything if you
want to talk to someone who really knows
how to log properly go find Peter Lowry
is running around here he actually has
some talks he's written a journaling
framework that can log at amazing rates
and amazing volumes and under those
conditions you don't have to filter
anything you just take all the log
messages you won't have any problems but
I mean I've you know the last engagement
is that I was actually workshop and they
said hey we have this problem with the
front-end transactional engine it goes
half a slow as it should yeah and I
sucked at it and very quickly we said
allocation
we looked at the logging the way they
have it set up because that's where the
profiling lead and said just turn all
this off right they blew through their
performance requirements once they got
rid of the logging problems yeah so and
I could go on for at least another hour
on this subject but I won't just say you
know and reevaluate how you're logging
right make sure your logging is not only
human readable actually forget human
readable just make it machine readable
go to binary logging screw this are
readable stuff it's like you know it's
not really good for anything it just
makes your logs neither machine readable
nor human readable is there something
yeah continue yeah you look at Chronicle
but like I said seriously seek out Peter
Lorre he's giving some talk seeking
hammer him at the end of it and and see
what he's done aaron has also been built
by the hft crowd in London and one of
our subcontractors used to work with us
on the stuff built it and it rocks as a
messaging system there's really not
another messaging system that goes
faster and it's like high frequency
trading environment safe so you know
yeah anyways then they have to meet as
the SEC requirements with that yeah okay
yeah it's called Chronicle you can get
it on github just go poking about yeah
you'll see arion is also in github it's
a hft so it's like Martin Thompson PA
that God sorry jet lag is kicking in and
Warburton Richard Warburton also known
first some of those other things yeah
Warburton a I use something or other AE
ero and I think do you know how to spell
that Melissa yeah exactly okay that'd
run all I know is it's really super fast
it goes really nicely
Lori la wi ER you'll see them on the
schedule here actually yeah I'll see him
in a few minutes ok any other questions
yes in the back
no leaks okay so yeah we had a session
this morning I was just sort of like
burying my you know it's like facepalm
because the guy was saying oh we can
detect memory leaks is like no you can't
no one can detect a memory leak with an
analytic all you can tell is that you
don't have enough heap right now it
might be that you do have a memory leak
but it also might be that your heap is
just simply too small for your the
amount of data that you're keeping in
memory should I remind everybody to vote
I spent all Wednesday packing the voting
machines and all the demo stuff so I'd
like you to use it on the way out okay
sorry you were saying memory leak know
there was that that was perfectly flat
utilization so I can tell if you're
stable I can tell if you're unstable but
I can't say that it's definitively a
memory leak because you know that you
know it might be just like you try to
put four gigs a date and a two gig heat
I mean you're going to get in out of
memory air you know it might be that you
need for gigs of data you know that's
not a memory leak okay that means you
have a lot of memory pressure but
certainly not a leak okay anything else
no so it's like a half past beer time I
think yeah thank you for coming enjoy
the rest of week</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>