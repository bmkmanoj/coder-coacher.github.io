<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Google Cloud IoT Core Technical Deep Dive (GDD India '17) | Coder Coacher - Coaching Coders</title><meta content="Google Cloud IoT Core Technical Deep Dive (GDD India '17) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Google-Developers-India/">Google Developers India</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Google Cloud IoT Core Technical Deep Dive (GDD India '17)</b></h2><h5 class="post__date">2017-12-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/PSZU-3afKPk" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">it's been great meeting everybody here
and it's a rare privilege for me to get
to come and speak to you all this talk
is about the fundamentals of Google
cloud IOT core and how I'm going to talk
about I'll introduce a concept of cloud
IOT I'll tell you how our product works
and then we'll go over the basic
building blocks of the platform my name
is Gus class I'm a developer programs
engineer on Google cloud platform
earlier this year I was spending by 20%
time on cloud outi and recently I've
started to dedicating all my attention
to it in the past I contributed to
Android things cloud machine learning
api's and Google sign-in I also do arts
and crafts with electronics and circuits
hit me up on Twitter or find me in
office hours after the talk
if you have any questions or just want
to chat so things are increasingly
becoming connected to the Internet in
fact it's becoming implicit that devices
with any kind of computing capabilities
are pretty much internet connected this
means different things to different to
the developers who are working with
these devices in the industrial and
commercial domain developers are now
using newfound internet superpowers to
do things like measure and control
factories or run car and bike share
businesses and homebrew and enthusiasts
developers are internet connecting their
projects for quantitative self remote
control and home automation consumer
products are frequently monitored smart
and they can be controlled via the
internet and are connected to other
devices in the home so they can
interoperate with each other but I think
that there is more than just the
internet connectivity that is relevant
to this transit so here you can see my
robot friend mr. scruffles there are
sensors on the front of the little fella
and his legs are connected to motors at
some point mr. scruffles was connected
to the internet for remote control but
to the home Rouen enthusiast taking a
robot like mr. scruffles and delegating
control to a giant cloud computer to
make
smarter it's what cloud IOT means so
look at that here's my hero the Android
things weather station I like the
weather station because it straddles all
the domains that I'm talking about today
all the way from homebrew to consumer
devices and also in the commercial space
for the consumer devices developer
Android things weather station can have
its software updated through the
Internet should you want to make changes
after you ship your device if you're a
developer in the consumer and devices
domain you'll probably want to address
capabilities to your devices by by
providing software updates after you've
shipped that device you're probably also
thinking about adding predictive
capabilities to your devices and
enabling coreography across devices
where you control one device or many
devices in synchronized in a
synchronized fashion so you want to
control which devices get which changes
and be able to rollback should you not
not should there be issues with it
change that you ship so this is cloud
IOT for consumer devices so here's a
picture that I took of gasworks Park
this is a decommissioned factory that in
its heyday had meters and valves
connected to tanks and boilers I imagine
it at some point a mechanic would need
to manually twist a valve to adapt to
the conditions that she read from a
meter connected to a tank in a modern
factory such mechanisms are controlled
with sensors and actuators but in cloud
connected smart factories the cloud
controls the valves and it does this it
does this control based on predictions
that are made from sensors that are it
that are distributed throughout
throughout the factory so you warehouse
that sensor data and you analyze it to
make predictions and then these
predictions enable you to better control
and proactively maintain your factory
making your factory safer and more
efficient this is cloud IOT for
commercial solutions so Google
infrastructure naturally lends itself to
a number of the problems that you
encounter in IOT this lets you move from
just a few devices when you're getting
started to thousands or millions of
devices so the first domain that that
Google the Google cloud really addresses
the needs of IOT is automatic scaling
so increasing capacity is as easy as
turning a dial or checking a box we are
also a leader in analytics and data
warehousing this goes hand-in-hand with
Google scale so being able to process a
large ingress of data from lots of
devices or being able to transmit data
to control a large number of devices is
Google's bread and butter so Google's
also a an industry leader in machine
learning and artificial intelligence for
example our inception model is the
baseline for feature detection and
images which is why I chose this
photographic image and finally security
if you're not careful with IOT your
Internet of Things can quickly turn into
a botnet of things Google understands
security and design systems so that they
can't be abused this is why you would
choose Google when building your IOT
solutions but maybe in deployment years
and years from now into the future so
let's go over the platform cloud IOT
core connects your devices to Google
cloud to allow you to get all the
features on Google cloud down on your
devices this is exciting because you
don't need to worry about scaling and if
your demands change over time Act you'll
have access to all those capabilities as
we add them to Google cloud you don't
need to build out devices with excessive
power or computation requirements
because Google cloud operates as the
brains backing your devices so here you
can see the product within Google cloud
that are relevant for IOT so Google
Cloud IOT core on the left of this
diagram connects is operates as the
identity provider and the communication
which is bridged to your devices so
pub/sub is connected one-to-one with
Google Cloud IOT core and is the
critical entry point into the rest of
our cloud so pub/sub is globally
distributed and high throughput which
makes it a natural fit for IOT with
dataflow our ETL solution you can
migrate your data to warehouses such as
bigquery big table or spanner
if those meet its to meet your data
warehousing needs you can also drill
down into your data using data lab or a
data studio and finally you can use
cloud machine learning and machine
learning api's to make predictions given
device data or to classify unstructured
data this is how we deliver on the
promise of cloud IOT so now that i've
hyped what cloud out what cloud means
for IOT you're probably wondering how it
works in practice
so it's helpful before describing what
we write what it's helpful before
describing what we're providing to
clarify what we're not so you can see
this picture here cloud IOT core is not
candy bananas it's also not a device we
rely on hardware partners to offer to
offer these devices built with our
solutions and it's not an operating
system however we work very nicely with
a lot of existing operating system
solutions for devices it's also not a
new protocol um it could be bridged to
new protocols but it's not protocol
specific it's also not a new radio so
this is not like this is not tied to a
specific hardware radio like some sort
of Laura based solution but we would we
potentially can work with Laura and
other radios so here's how it works on
the Google cloud side you have device
provisioning which is controlling which
devices have access to your cloud
resources and you also have choreography
and choreography I like to think of as
controlling individual devices or
multiple devices in concert and to
facilitate this on the device side we've
taken a standards-based approach which
is kind of a googol way to do things
right and so we support HTTP as one of
our bridged protocols and we chose this
because it's supported on many devices
and developers are really familiar with
this for example like if you've got some
sort of software solution we provide the
curl library like curl libraries are
pretty predominant and available so that
you can do HTTP really easily and next
is message queue telemetry transport or
mqtt now this is an industry standard
that is very efficient on over the wire
communication it's got a small memory
footprint and it's a ratified IOT
standard so if you've got a device that
you're working with already there's a
very good chance that you've got an imp
utt library for it so using these
standards based protocols you can now
connect your devices to our cloud and so
let's see which services are in are in
Google Cloud IOT core to provide this
functionality
the first is the device manager so the
device manager lives on the cloud side
and controls which devices have access
to clouds resources and it's the
choreographer for communication and
synchronization across those devices and
then on the device side we have the
protocol bridge we call it the protocol
bridge because it's not an actual server
but it's a server like it's like a
server like service that allows you to
communicate using these available
protocols with our cloud platform all
right now that you've seen the product
from a high level perspective let's
drill down and look at the pieces in
practice starting with the device
management so the device manager
organizes devices using a hierarchical
resource model projects contain
registries that in turn have devices and
then these devices have associated with
them a credential and configuration
multiple credentials can be associated
with each device so that certificates
can be rotated or revoked without
transmitting credentials to devices and
still maintaining that connectivity
so again registries encapsulate devices
and map devices from the protocol bridge
to Google cloud platform these are
always mapped one-to-one with a pub
subtopic so basically you write to this
you write to this topic in the Google
Cloud IOT and then those messages will
appear in a pub sub-q Sojin registries
are regional as indicated by their path
you can see that I've highlighted the
Asia East one region that is used inside
of this address for that specific device
and generally you want to aggregate all
your data from a single like from a
single given project to a single pub
subtopic so we don't anticipate many
scenarios where you should be creating
multiple registries within the same
project I know what you're thinking now
create lots of registries I know that my
demo project does but you really are
going to probably want to have your data
in one place so map your registries one
to one with your projects and the device
manager is the first next thing I'm
gonna talk about this lets you
programmatically manage your devices as
you probably expect there's a crud model
for devices letting you create delete
lists describe or update them and
there's also an iam permissions model
that allows you to delegate the
control of these devices to other people
in this way you could have a
manufacturer who's registering your
devices so that when the met when the
device comes from that manufacturer to
you it just you just turn it on the
internet and then it's able to connect
to Google cloud so with each device you
have this metadata associated with it I
have the JSON representation up here on
the right and you can tell things like
the last time that advice connected you
can tell whether whether or not was able
to send messages to Google cloud and so
forth this is really useful when you're
debugging but it also allows you to know
like what your fleet of devices is doing
and it allows you to get all sorts of
analytics that you would not that you
may not be able to get another platforms
so we authenticate devices using a JSON
web token or jot which is an encrypted
payload that is verified server-side so
basically the client needs its private
key in order to produce an authorization
credential that is verified on the
server using the public key that you
register with the server so multiple
credentials can be associated with a
device so that you can revoke
certificates or expire them without
losing device connectivity so we
currently do not provide a mechanism for
distributing new credentials to devices
in the wild because if a device is fully
compromised the best way to recover the
device is through mechanisms such as a
secure radio or an over-the-air update
using the operating system you have
installed on your device and this is
just going to be implementation specific
for now okay so device configuration a
device configuration is the means of
communicating changes to a device from
the cloud configuration configuration
change messages can vary from simply
modifying a device parameter such as
like fan speed to Perkins to
reconfiguring a devices context with a
new one
such as uploading a new tensorflow model
configuration changes may are
acknowledged by the devices when they
come down and as soon as like as soon as
the device actually connects and reads
the configuration change we consider it
acknowledged so in HTTP you get these
configuration changes by making a get
request to a to a URI and then an MQTT
you subscribe to an MQTT topic and then
you'll receive those configuration
changes as they come and in this way I
think that mqtt has a slight advantage
over HTTP
and that you don't have to kind of pull
to get those configuration changes all
right enough slides let's see what it's
like to provision a device sorry my
computer locks this will just take one
second all right so let's switch over to
that yeah here we go
okay so here you can see the Google
cloud platform console you're probably
familiar with this and this is the new
IOT core section and if you navigate in
the Left menu here you can just find it
there and so this is what this is what I
OC core looks like when you load it and
we're going to create a new device
registry and so when you create these
remembering back to what I was
describing in those slides if you have
to get the device registry an ID and
I'll call my device registry hello GDD
India and then you have an again
registries or regional so I'm going to
set the region to the region that's
closest to where we are Asia East one
and then again associated with each
registry is going to be a pub subtopic
so I'll choose one that I've already
created but you can now create these
topics on the fly from the console here
and so then I create the registry oh
it's hot up here alright so now that
I've created the registry I'm going to
add a device and so before you can add a
device you need to create those
asymmetric public/private key pair and
so I'm just using the sample code this
is a if you look at the actual script
itself it's just open SSL and so I'm
also creating a pkcs eight key which is
used with Java and so then I get the
public key and you can also do this
programmatically using the API or using
the console with g-cloud but for today
I'm going to show you I'm going to show
you how to do this using oops I'm going
to show you how to do this using the
console which is relatively new
alright and I'm gonna call my device GDD
India
and that should be the key and if I did
everything right now the device has been
added okay so this returned to the
slides now that we've added a vise it's
time to start thinking about connecting
to that connecting that device and then
communicating from it so I'm going to go
over the next part which is the device
protocol bridge and this allows you to
send device telemetry state and
configuration updates so there are three
classes of messages that are sent over
Google Cloud IOT core I have a heartbeat
to represent the telemetry message these
are frequent updates from your device
that are sent to be stored in the pub
sub topic associated with your registry
the configuration messages the next one
are updates that are sent down to
devices so if you want to do
cloud-to-device communication this is
done using configuration messages and
then the state messages the third type
are persistent and are shared between
the device manager and the device so
these are used for things like
confirming and acknowledging
configuration changes that's why I chose
this cute little receipt here okay so
let's start with publishing messages
using the HTTP bridge authentication is
performed using an is performed on the
HTTP bridge using a bearer token so you
just pass inside of a header an
authorization and then this contains
things this contains the jot which we
talked about earlier which is the which
is the authorization credential and so
the token has to has an expiration of an
hour and the and that expiration needs
to be in sync with Google's time servers
so specific to HTTP you should be using
lowercase headers and set cache control
to know cache so that you don't miss any
changes when pulling down configurations
and to send to send messages to cloud
your going to post to a global endpoint
passing in the identifier for your
specific device so for requesting
configuration from the cloud in HTTP
you're gonna have to authorize again
using a jot token and you receive the
configuration by making a get to the URL
that I'm gonna show on the screen or
that I'm show you that I'm showing here
on the screen and this this URL is going
to correspond to an individual device
and in this way you can send a specific
configuration down to an exact device
and so when you send the configuration
you also request a specific version as I
said before Google Google cloud stores
multiple versions of configuration for
your device so that you can roll back
and you can request that specific
version or you can rip or you can send
zero to request the latest configuration
that was set on your device all right so
one more demo let's connect the device
send some messages and see how that
looks in the console so remember I
created this I created this private key
and the public key from the from from
the Python sample I'm going to use that
private key to create an authorization
credential and then connect to cloud IOT
core and then and then I'm gonna sense
I'm gonna transmit some messages that
will appear in the console and so if you
look here like I'm just calling this
this this is the same sample code that
we shipped it's available with
documentation and you'll see that I have
the registry ID which we created earlier
the device ID and the region and then
the the project ID which is used in the
path of each individual device so when I
so what's happening is so you here you
can see that I encoded the jaw and then
I'm using it to connect and then I'm
publishing these messages and I'm
getting a 206 s back meeting that it's
working and so now if we return to the
console here we can also we can refresh
this we can refresh the device and then
see those changes live inside of the
console this is really useful for
debugging and so here you can see the
payload that I'm calculating and
transmitting to Google Cloud IOT core
all right well that's that's it for this
demo we switch back to slides ok great
all right well I would be remiss also
not to cover MQTT as a reminder
mqtt is a published subscribed standard
that scales down nicely to IOT class
devices so when you connect to MQTT the
user name is ignored as with HTTP we're
using a jot as the password and this has
an expiration of an hour and we also
pass in the MQTT ID and sorry and the
mqtt ID we actually pass in the
Device Identifier so this is just a path
to your device and then after you
connect you can publish telemetry data
using the device's device ID events
topic and you can publish state data
using the device's device ID state topic
so you want to use the telemetry pub you
want to use the telemetry topic which is
events in order to publish frequent data
and you want to use the state topic to
publish data that is shared between
devices and the device manager and so
again if you have something that you're
publishing frequently like you're like a
heartbeat data like or sensor data that
you're reading from say it like say a
temperature thing very frequently you're
gonna want to use events and send those
state messages less frequently so next
thing we're going to talk about is the
MQTT bridge for subscribing to topics
this is how you get configuration
changes down to your devices so a device
can only subscribe to the MQTT topic
devices / device ID / config when you
connect the first time using MQTT you'll
receive the latest configuration you can
also request a specific configuration if
you if you if you request it using the
bypassing a sub a sub topic to the
configuration so configuration these
acknowledged when the MQTT message is
compared confirmed on the device and
this is QoS one which is at least once
delivery so you can anticipate that
sometimes the configuration may come
down to your device more than once all
right so one more demo and this one I've
got some hardware and if we can dim the
lights a little bit so you can see this
better so here is my little device it's
got a donut on top of it and I've got an
antenna loosely connected to it so
hopefully this works I was feeling
really brave so I made this demo on the
plane and so here's this is just an
Android things project and I have
instead of the Android things I'm using
string resources to configure the topic
and the device ID and then I'm going to
have to configure it with the with the
credential that we just created
and so I just said this again I just
copied the private key into a resources
into a raw resource on on the Android
app and now what I'm going to do is I'm
going to start the Android app and this
will this will hopefully connect
successfully I'm carefully reading the
little adb logcat here that looks good
so far and so now I'm going to use the
developer console to send a
configuration down to the device and so
the configuration message here if we can
switch over to my laptop screen for just
one second so I this is just an RGB
value that is colon delimited so this
should set this so when I click send to
device this should transmit that message
down and then the device will subscribe
that's subscribing to that MQTT topic
will read that off parse it and then set
the LEDs on here to read if it's working
correctly all right can everyone see it
we can you do the lights up here again
guys and there we go
so we see yes it's okay you can clap
yeah let's just sit let's update it a
couple more times I'll turn it back off
oh there it goes again
and then one more so you can see just
how fast this is happening I'm
considering this is conference Wi-Fi and
like this is you know this is a demo
that I just threw together in a few
minutes like this is actually really
performant and here's another demo and
so you can see here's like a nice little
animation with some LEDs alright and
that's it for my demos thank you then
now I gotta find my clicker all right
great
all right well now that I've shown you
the basic building blocks that's it
that's all the rest of the platform it's
kind of you know it's it's kind of
boring what you really want it to be
because the the really the most useful
things are really simple but now that
I've shown you the basic building block
to the cloud IOT core platform let's
revisit how Google Cloud offerings come
together to light up developer scenarios
so this I call an introduction to IOT
patterns so in this basic example device
is connected to a cloud IOT 2
Google Cloud IOT core and then they they
convened all of those messages that come
in go into that pub/sub topic which is
connected one to one to Google Cloud IOT
core and then we're using dataflow to
then migrate that data to bigquery and
BigTable so from there you can do tool
you can do analytics on that data and
you can do those analytics in our
powerful data in a powerful data
analytics tools a data lab and data
studio so let's look at the next let's
look at this next example so here we
have device-to-device communication and
I imagine this is like things like
you've got a doorbell on your front door
and then inside of your house you've got
a chime think it's actually waited when
you press that doorbell so a device
sends a telemetry message to Google
Cloud IOT core which is connected one to
one with pub/sub and then you anything
any time that a message comes into that
pub sub-q we have a cloud function that
executes on the data that comes in and
then when that cloud function executes
what it actually does is it makes a
configuration change using the Google
cloud I Oh T core products back into
another device which would then bring
the door l and so the next one that I
want to talk about let's talk about some
machine learning scenarios here so
imagine that you have a device with a
camera and it's connected to Google
Cloud IOT core so that whenever that a
picture is taken a telemetry message is
then sent over MQTT and then that
telemetry message would then appear
inside of Google cloud pub/sub which is
connected one-to-one with Google Cloud
IOT core and then whenever those
messages come in there a cloud function
is called and then this cloud function
makes a call to the Google cloud vision
API which then classifies that data and
then send you back labels about that
particular data and then that label
comes back to that structured data or a
control message is sent back to a device
so as an example imagine that you've got
a door to your garage and you've got a
cat and raccoons keep coming through
that garage door or the little kitty
door and they're breaking in and eating
all your cat food so you could filter
out the raccoons by taking a picture
before unlocking the door and then
detecting cat so you would see like
you'd run you'd run through and then
when the cloud function returns the
vision API would be populated with
labels such as cats or raccoon and only
when there's the cat tag
present and the raccoon the raccoon tag
is absent would you unlock the door and
allow the cat in and so we have one more
example with with machine learning and
so you have a device imagine like you
have all of these industrial this
industrial equipment that's out in the
that's out distributed across you know
your country and device sends this
telemetry at this telemetry message up
to Google Cloud IOT core this could have
things like the oil viscosity in an oil
station or the temperature and then all
that data goes into Google Cloud IOT
core which then triggers a cloud
function that takes that data that's so
this is like this the sensor data over
time and then that's passed into a cloud
machine running engine model that then
makes a prediction and so then from that
prediction we then send that we then
control those devices again either from
cloud IT core or we or we use or we
actually use another notification system
to send messages down to the users as
relevant so as an example imagine that
you've got a carbon monoxide detector in
a factory rather than going off when the
levels just reach some dangerous
threshold you could warn people when the
levels are rising and so these are the
kind of things that you can do with the
cloud IOT core without having to without
having to worry about having that
functionality down your device and so
what or one more example because I want
to talk about Android things and
firebase you have a device powered by
Android things that is listening for
changes to a real-time database
it's connected to a light and
potentially other smart consumer
products and you want to do things like
like a window shades in a sound system
so that when you when you set up but
when you press a button in your house
you want for you want for it to be ready
to play move to play your movie so it
dim the lights and it sets your surround
sound up correctly so device one
transmits its telemetry message to
Google Cloud IOT core and so you press a
button or you turn on your blu-ray
player and then that message comes into
Google Cloud I would Couture which is
connected one to one with pub/sub and
then we use and then we use data flow to
deduplicate and to order it in to make
sure that the messages are coming in
order and then that that will then pump
a state into a firebase real time
database that's Lisp it's being listened
to by Android things
then that Android things device can
respond to those messages and then can
set all of those all of those widgets
inside of your house up to the modes
that you've configured for it and so
we're using firebase here because we
want to share that state across all
those devices so that so that all of
those all those changes can happen at
once so our beta has been public for
around a month it's a great time to take
a look at our platform I'm all the
documentation is available here and I
recommend you start from the docks and
try out the sample apps that's all I
have for now feel free to ask me
questions on Twitter I've left my little
Twitter up here it's at GG you you SS or
post questions to Stack Overflow using
the Google - cloud - IOT tag also be an
office hours after the talk in
conference hall 3 and that's it thank
you all for listening</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>