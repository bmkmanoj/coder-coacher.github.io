<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Integrating AMP into PWA (GDD India '17) | Coder Coacher - Coaching Coders</title><meta content="Integrating AMP into PWA (GDD India '17) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Google-Developers-India/">Google Developers India</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Integrating AMP into PWA (GDD India '17)</b></h2><h5 class="post__date">2018-01-24</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/TooT5LiMNew" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">my name is Sara Clark I'm the program
manager for web developer training and
certification at Google and a lot of you
have probably seen me on YouTube
teaching the developing progressive web
applications course here in Bangalore
last February we put that up on the
Google developers India YouTube channel
as well as the full course on
developers.google.com so what we're
going to do today is something that
we're actually about to add to the class
which is you've heard things about
accelerated mobile pages and I'll do a
quick review for people who are not
quite up to date but we're also talking
a lot about progressive web apps can you
make them work together and the answer
is yes there's a one really easy way and
then there's a more difficult way that
has very high performance so we're going
to do them both so first things first
this session you should have you should
have no js' installed we need no jf6 or
later if you don't have it installed on
your table there's a bowl with little
boxes in it that's full of thumb drives
and that thumb drive has on it the
installation images for node for most
systems we have actually we have mac and
windows if you're on linux you will have
to go download it for which I apologize
and then what we're going to do is talk
for a little bit
write some code do it again until we're
done and then have some time for
questions at the end so we'll do that
there will be instructions available if
you want to try to download everything
from the net but the instructions by
default or how to do it from the
thumbdrive but let's do a quick intro
alright so we're going to do two
different things here the first is we're
going to take a standard EMP page a
standard amp page and we're going to
turn it into a progressive web app how
many people know what a serviceworker is
pretty much everybody in the room we've
really done our job here so you're going
to write a very simple serviceworker
actually we're going to use a tool
called work box to write it for you
so we'll build a serviceworker with work
box which
super quick and then you'll simply plug
it into your amp by adding a single tag
single line of code really fast I know
everyone's going to get it done and then
optionally let's say you have more than
one page you have a whole family of
pages you have an entire app you can
actually do what's called the amp and
PWA strategy which is you build a simple
app shell and then use amp as the
content pages that you pull in and you
inject them using shadow Dom so we'll go
through how all of that works if any of
this part doesn't make any sense don't
worry I will be explaining it this is
just a quick preview I'm sorry okay so
amp accelerated mobile pages okay how
many of you are really really good at
writing really fast pages Bueller no
hands right it's hard I've been working
in the lab doing site reviews and it
keeps coming down to the same things you
know it's like okay can you move some of
this traffic script later can you lazy
load the CSS can you lazy load these
images oh look that you know that vendor
is dead slow can you move these on to a
CDN it's a lot of work and it's often
the same advice over and over so what
happened was other engineers but maybe I
can build a library that does all the
right smart things and give people some
advice and help them build really fast
pages and that's what a MP is amp is
basically some HTML markup and we use
most of HTML there's a few tags we don't
use because we replaced them with faster
versions so for example you don't load
just a straight image tag you load an
amp image tag that thing's smart enough
to know for example is image not
displayed yet great I don't have to load
it the first time so there's a lot of
performance built into those custom tags
amp J s is the single library that you
need to load to make amp work and it has
all the best practices and all the
loadings stuff in it so it's basically
an expert engineer wrote you the pieces
that you need to build a really fast
Paige and then the amp J cache I
mentioned to some people I've said oh
yeah put your stuff in a Content area
yeah CDN content delivery network
somebody said yesterday well what if I'm
using Amazon said yeah s3 works just
move your stuff over somebody else is on
Google Cloud I said well you know we do
have a CDN but here you don't even need
to pay for or provision anything to see
the end we take care of it automatically
now that does make some people a little
unhappy because if the URL at the top
says Google instead of your brand it's
kind of a lost branding wise but all of
the browser's are now compensating when
they see an amp page by continuing to
show your brand in the URL as opposed to
Google's URL so that one's been fixed
and there's a there's talk of a
long-term permanent solution to this
going on now that's started to go
through the standards process let's talk
about amp HTML for a moment looks pretty
much like regular HTML the only
differences are in the very beginning
first off it's an html5 document bang
doctype HTML and then HTML and you have
to add a special attribute to turn on
amp there's two ways you can do it you
can either say HTML space AMV and just
put in an attribute the amp attribute
doesn't need a value it's a boolean
attribute if it's there it's true and if
it's missing it's false or we got silly
and unicode it said yeah or you can use
a lightning bolt which is also amp
symbol so this is that lightning bolt or
the or the letters a MP will mark this
as an amp page in the head you need
what's called the canonical link so you
will often render a page in two versions
the amp version and the non amp version
the non amp version might have more
functionality or not depends what you
want to do but the canonical link points
to what's the non amp version of this
page what's the master version you need
to install any CSS that you need custom
inside the amp book there's style
amp boilerplate
block you don't load it from another
file part of the secret to amp being so
fast is to minimize the number of file
loads so you have to inline that custom
CSS that you need you then load the amp
script and it's loaded asynchronously
which means once it's loaded it's not
going to block rendering all its parsing
it'll get parsed on a background thread
it basically says I promise not to
modify the page until after Dom content
radius has been fired so it can price
asynchronously in the background and it
loads from the CDN and that's all you
put in the head it's very simple a
little too simple it feels but it's
actually correct and then the body so
you use regular tags unless we give you
a replacement and here's one of the
replacements here's an image and you
have to give it the height than the
width and I'll explain why in just a
moment but you don't get to use a
regular image tag a regular audio or
video or any of those you'll use the amp
replacement but you can still have menus
sidebars a lot of things that you're
used to it's just we've built optimized
versions of those for you and you can
still skin them you can still get them
to look like you're branding by adding
the inline styling now amp jeaious is
the script that implements all the
loading and a couple of other
interesting features so one of the
things it does is because you have said
here's the size of all of my images and
it could calculate the size of the rest
of your content it knows how much is
currently visible on the screen how much
is above the fold and so it only loads
that much from the network remember
that's one of the best practices right
as only load you're above the fold
content and then lazy load everything
else you need in the background amp does
this automatically so what's happening
is that amp puts that up there very very
quickly often less than a quarter of a
second sometimes often under 100
milliseconds which means it feels
instantaneous when you click the mouse
and then it starts loading the rest of
the content in the background so when
you scroll up it's there
and then the J cache is optional but on
by default it's basically our content
distribution network it's based on
Google servers so if your web server is
somewhere in the States on the East
Coast we then as its accessed from
different places around the world
actually I think we do a push up as its
accessed we copy things out to those
edge servers in fact what it's not
showing here is it's not showing an edge
server super close to you but we just
opened up a data center in Mumbai about
a month ago so some of the caching will
be happening there two things will be
showing up very very quickly and this is
on by default but you could turn it off
so amp is really there implementing all
of the stuff that a really really
skilled developer would do for you and
it's all tested and debugged and it's
just going to save you a lot of time so
the pre-rendering makes it feel instant
it just shows up right away so
limitations no custom JavaScript because
that is a huge slowdown for your page
yesterday I was looking at somebody had
loaded an ad tracker and the ad tracker
added that what their load times their
page was two-and-a-half seconds
a full two seconds of that was loading
and setting up the ad tracker so a lot
of custom JavaScript is not written in a
fully optimized fashion now before you
run screaming out of the room and you're
all too polite to do that a lot of the
custom JavaScript is for things like ad
tracking and analytics and all of that
amp actually has that built in on the
server-side so it's done for you
you don't have to add it to your page
now if you want to do a lot of
animations and other like high
interactivity things if you want this
page to go into a react application
that's when that PWA
app shell approach works as you build an
app shell load the amp pages in its
content and you can have as much custom
JavaScript as you want at that point but
the initial amp pages are more for
static content low interactivity new
sites I've seen several are called
brochure sites are kind of
an advertisement for your product so you
might have your static content in amp
and then a link that takes somebody into
the full application which you could
have loaded in the background I'll show
you how to do it you one more thing
no offline no Add to Home screen no push
notifications because it's not a PWA but
we'll fix that in this class so three
different ways of doing this way number
one is doing amp as a progressive web
app taking an app page adding a
serviceworker to it there's in fact a
tag for this it's called amp install
serviceworker you tell it where the
serviceworker file is it does all the
necessary work to set it up now we don't
give you a serviceworker you have to
write one but that's where work box
comes in another way to do it is amp as
a progressive so amp as a progressive
web app it will actually your page will
come up you'll actually get add to
homescreen what will happen is the
person will get the first page up off of
your server and it won't show up as a
PWA because it never does on first load
until the reload but when they click a
link the next thing they pick up from
your server as long as it's also set up
this way that will activate the
serviceworker and now it's a full PWA
available off set offline so any page
they visit will be available to them
offline or you can even preload the
pages so we're going to add a
serviceworker and we're gonna add the
manifest file that lets us get add to
homescreen
here's the code we're using work box so
inside your serviceworker dot JS file
you import the work box toolkit you
create a new work box serviceworker and
you say precache you give it an empty
list now it's not going to read your
mind what happens is this is a template
work box is going to take a list of the
files that it that need to be cached
it'll look for them on your disk it'll
make a copy of this file and fill in
this with the required content so work
box is part of your build step it's a
code generator that works for you you
have to add a configuration file so
we're basically going to say pick up all
of my images
here's my incoming Service Worker
there's my outgoing Service Worker
don't bother cashing this configuration
file this is not for run time it's only
a build step very simple config file and
so what happens is you run workbox
and it generates the service that
generates the file for you the service
worker so it filled in the template area
with the URL to save in this case an SVG
and a provision which is a hash of the
file so that when you get a new version
of the file and the service worker sees
it it knows automatically to pull that
and update your cache so it's really
efficient again this is all work that
you would do if you were really super
expert at it and we've built it for you
work boxes open source it's actually
used by Google for our own progressive
Web Apps but it's Apache 2 license
completely free to use no no royalties
or anything let's install the Service
Worker first thing you need to do is to
get the install serviceworker tag we
don't give it to you by default it's not
one of the core tags so you have to load
that bit of custom code and you do that
by loading a custom element by the way I
said before no custom JavaScript and amp
I'm lying very slightly we now let you
write your own custom tags as well but
they have to fit some fairly carefully
written rules so anyway we're going to
load the amp install serviceworker tag
it's loaded async so it's parsed in the
background and then we'll call amp
install serviceworker tell it where the
serviceworker lives in this case layout
you could say for example take up the
whole screen or not in this case we're
going to say just look like a normal
page that's what no display means and
then you need to actually give it an
iframe on the page with a little bit of
HTML that installs the serviceworker and
that's it that's your whole index dot
HTML plus any cut plus any custom
content you need the installer page
looks like this it's kind of standard
boilerplate you're just going to copy
and paste this and it just has the code
at the top that says if I have a
serviceworker available register it and
in this case they'll console.log a
little bit of information about it now
pre-caching the whole idea of a PWA
and serviceworker is that you can go out
and cache the files that you need at the
start so they're available offline that
means not just the body of the page but
all of the images and everything else or
in this case as your page visits new
pages you want to go ahead and cache
them as long as it's visiting inside
your site so I'm going to register a
route of slash star so everything inside
my URL and I'm going to see if we're not
navigating between a page so we're
rendering a page right now grab
everything cached first we're going to
say assume everything's in the cache but
if we're navigating to another page go
network first which means go out to the
network go ahead and let that thing come
in and add to the cache this it will
guarantee it will always grab the latest
version of your pages but if you're not
online network first falls back to the
cache so this is a perfect all this is a
perfect strategy it basically makes sure
that your content is always fresh but
your static assets always come from the
local cache and this goes in your
serviceworker file and that is it so
here's what's going to happen I'm
hopefully if people needed to install
node you've already done it from the
thumbdrive copy that lab code from the
USB Drive and I'll walk through how to
do that in a moment
open the lab instructions you will need
to be on the network for that but it's a
pretty small file
skip section 2 in the lab instructions
they tell you to download everything but
because we didn't want to turn this into
a rolling denial of service attack we
gave you all the things on thumb drive
instead and then stop before you get to
step seven now it might sound scary 6
steps yeah but they're tiny so you're
going to open up your USB Drive the node
images are in there if you need them
you're going to open then you're going
to go into the codelab source folder get
Anthropy wpa work bugs if and copy that
to your machine and then unzip it
locally on your machine
please don't uh non the drive that'll
just confuse the next person copy it to
your machine unzip it if so if the
person next to you needs it pass them
the thumb drive if somebody can't really
make this work check with your neighbors
maybe you can pair up with them and then
open up the lab instructions and I'll
leave that on the screen and go ahead
and let's see actually let me go forward
there we go
open the lab instructions up there and
do the work stop before step seven okay
so I'm going to give you about 20
minutes for this first part for install
and everything else that's about how
long it takes if you'll notice there's
folks in the back of the room they're
all in red shirts this is all my team
they all work for me today they work for
you at least for the next hour so if you
have any questions any one of them is
free to help you out I'll also be
walking back and forth on the floor
alright so go ahead and get started
we'll come back at about 11:45
so some people are close to done with
step six some people are still working
on step five this is all good you're
going to get more time I want to go
ahead and talk about the next part a
little bit and then give you more time
to work nobody leaves here with an
unfinished app it's not a problem okay
so let's look at add to homescreen now
you've done the add to homescreen
serviceworker part but we want that
pop-up that says you know or you've done
the amp service worker part but now we
want to be able to add an icon to the
homescreen
and to do that you need to build a
manifest.json file and it has the the
long game of your app this is what shows
up in the in the task switcher the short
name is what shows up on the screen if
you want to match the color of all of
the outside of the browser or like the
top bar in the bottom bar to your app
you set a theme color you also set the
background color so when the splash
screen comes up it uses this in this
case we're using all one color display
now this is display standalone this
means it's going to take over the entire
screen the person can still get to the
URL bar by dragging down but by default
this is going to look just like a native
app it's going to take over start URL
every manifest says when the user type
taps on this icon where does it start so
it'll always start index.html and then
there's a list of icons which there's
not enough room on this slide to show
you so here's I had to homescreen coming
up automatically it says hey yep fpw a
codelab do you want to add this to your
homescreen and you hit yes and off it
goes so step 7
just you know keep working forward and
for this step we are at 42 this step I'm
actually going to get people about 10
minutes get caught up and then we're
going to half an hour to finish the
session alright keep working if you need
help teams here and let's just keep
going
I've had several questions about what if
you're doing something like an
e-commerce site and you have dynamic
content how does this work so amped by
itself uses support static content
things that don't change so it's really
great for for example a landing page
where you know people are going to land
in a hurry landing page Terms of Service
anything that doesn't change much now if
it does change much what can you do
we'll go into details here let me show
you how to make it work where if you
need to have amp speed but ecommerce
kind of dynamic content how do you bring
them together and you do that with an
app shell okay so there's a couple of
things you can do here you can have your
server put your content up in two forms
you can pre render your pages as amp
statically render them so that a user
working on amp is getting the amp
experience but it doesn't have all of
the dynamic content in it so let's say
an e-commerce site wanted to be super
fast let's say there was let's say you
wanted to be all faster even the flip
card you might have your drum your
landing page done his amp you might even
have all of your product pages done his
amp and on the product page there's a
button amp allows some interactivity on
the product page there's an order button
or a see details button and what that
would do is open a different non amp
page that could then do all the dynamic
content although amp actually does have
tags in it for doing dynamic content
including things like prices and lists
of objects so you should take a look at
that Ben Morris is doing a talk right
now on amp that if you look at the
recording later he'll tell you how to
inject dynamic content into amp pages so
that's what you need you can also do
that you can also have your server so
pre render pages is amp HTML for the amp
the high speed experience but then serve
up data is JSON so the parts of your
site that are PWA that are a single page
app and go get data from the server can
get it from the server but there's an
even better way to do this and that is
to use the amp content itself
as the content for your page so right
now when you build a single page app
what do you do you use Ajax or fetch to
go out to the server pull some data in
take a page template render it I'm
seeing lots of people going yeah that's
yeah this is what we do
well amp is a cotton pre-rendered chunk
of content so you could pull it in and
merge it into your dom you could pull it
in and put it in an iframe or if you've
looked at what we've done around custom
components there's a thing called the
shadow Dom for every custom tag there's
actually an entire dumb self-contained
that you can inject the content into and
then hang it behind a single tag and so
what we suggest doing is actually
getting the amp via fetch and all of its
pieces and sticking it the shadow Dom in
fact you put the fit they amp in the
shadow Dom and it'll fetch the rest of
what it needs like a regular page and
you can still cache it you could still
use serviceworker so you can really have
the best of both worlds
so in that case instead of needing to
serve two kinds of data you only serve
one so it's amp HTML used as standalone
amp or as this pre-registered pre-built
display data that goes into your single
page app makes your single page app code
a lot simpler too now iframes are slow
so you can do it without shadow dom you
can have one window but for each time
you load a document you have a separate
copy of the amp library and this eats up
a lot of memory with the shadow dom you
have one window you have one copy of the
amp library but you can have multiple
instances of that embedded amp content
in your page each and a separate shadow
Dom the other trick is this by the way
once you've loaded an amp page and
you're displaying it like in the shadow
Dom you can get around the JavaScript
restriction because at that point you
can in you've got the reference to it
you can actually inject a custom
JavaScript into the page you can build
what some people call dirty amp it
doesn't pass the validator because it's
got a lot more capability
but it gives you all the speed event
plus all the flexibility of writing your
own code so the second part of the lab
for those who have time we're going to
about 25 minutes here is to build a
little app shell we'll give that to you
intercept any navigation so somebody
tries to navigate page to page the shell
intercepts it those out fetches the amp
and parks it in a shadow Dom entry so if
you're doing an e-commerce kind of thing
and you want this kind of approach this
is where you want to go they don't think
is that shell could have a lot of your
custom logic in it it could have your
cart management and everything else and
that reduces the amp pages down to
mostly static with a little dynamic
content and as I said amp actually has
tags that will go out to the server and
pull dynamic values and merge them into
the page so you could do things like
have amp serve up mostly static content
go to the server pick up say the
availability in the price and the other
things and have the app wrapped around
it handling all the things like the
order and payment logic so we're going
to do an amp of PW a demo example here
very simple page and there's a div here
labeled amp route so right now the shell
of this app is pretty empty and there's
a place that we're going to stick an amp
page we're going to register the route
we're gonna register for everything if
we're inside rendering the page we're
not navigating pull everything from the
cache just like before if that's if
you're not navigating then everything
gets handed back to the shell cache so
return caches that match shell ignore
any other parameters like search
parameters so every single navigation
request gets redirected to the shell and
then the shell needs some custom code in
it now to do shadow DOM and amp you load
the shadow tag the shadow amp tag now
what you have to do is you actually have
to wait until amp is ready before you
can start modifying the shadow Dom this
is like waiting for an onload event but
in amp and so what you do is you get the
amp object
and you push a the result function on
you here this promise and then what'll
happen is this app ready promise will
get resolved when amp is ready to go and
then that has an empty function you can
do whatever you need after amp is ready
to start so we'll find that amp root div
using document dot query selector will
get the URL of the amp page out of the
location well wait we'll take that amp
ready promise wait for amp to be ready
and then fetch that custom URL and when
it arrives attach it to the shadow
attach it to the shadow Dom so what this
does is this picks up an amp page and
inject it into your container and by the
way since you've set the route to
basically you can then also cache
everything if you wish so to install the
serviceworker
we then say ok do the installs before if
there's no fallback if there's no
serviceworker let that fall through and
basically the fallback shell URL says
always use this for the app shell page
so you don't even get a 404 you just get
the shell every time now the links in
your page will not be links inside of
your current app so there's some code
here to go through and actually re link
everything in your everything in your
screen to be a link inside of the shell
so it calls the shell and then adds an
href parameter on the end so that the
shell Interceptor can do its job so
we're going to do the we're going to
leave you time for the last optional
steps 8 and 9 the lab instructions are
there we have about 20 minutes so at
about 3 minutes before we're done I'll
go ahead and come back and say a couple
more things but you've got now about 15
minutes to work
I'm going to very quickly look at the
last couple of slides here actually this
last ones all it really you need and
then we'll send you out of here in a
couple of minutes so amp project org is
all the amp documentation amp by example
is an entire site built using amp using
static content but it'll teach you amp
all the all including all the custom
tags if you search for react amp we have
a complete amp example using react for
people who use react to need that
interactivity and if you look at the
shadow reader example on github that is
a complete amp that runs in a PWA shell
and does dynamic data it basically goes
out and reads news feeds so if you're
building any kind of e-commerce or
they're dynamic content that's the place
to look to see exactly how it works
we don't use any frameworks we show you
how to do it straight up JavaScript and
then you can adapt it to any framework
you like thank you I will be around look
for my team in the red shirt</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>