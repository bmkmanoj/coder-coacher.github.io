<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>M04-Part1: Getting presign-url for S3 with EX-AWS | Coder Coacher - Coaching Coders</title><meta content="M04-Part1: Getting presign-url for S3 with EX-AWS - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/EQuimper/">EQuimper</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>M04-Part1: Getting presign-url for S3 with EX-AWS</b></h2><h5 class="post__date">2018-02-10</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/3DFrutp7WJw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">well coming around to this part number
one for this four milestone so what
we're gonna do today as you know it's to
create a present URL using Amazon s3 and
to make to be able to find any to upload
an image to s3 with a present URL and
we're gonna use the hex AWS library and
yeah so this is what we're going to need
to do for today
so we're gonna also create a user with
Amazon and stuff like that so we don't
gonna really do a lot of code but at
least at the end of the day we're gonna
be able to upload at the end of this
video we're gonna be able to upload a
photo to the s3 bucket we're gonna
create so first thing I'm gonna put the
link in the description for all the link
but we're gonna need to use the a lexer
AWS library and this one asked us to
install this for library I don't think
we need the acne because of Phoenix but
I'm gonna just follow what they say so
we're gonna need this one so this is
everything who gave us the AWS s3 and
stuff like that
after that Alexa UUID it's a way for us
to create a unique ID we're gonna use it
to create a file name after that go
inside your terminal we're gonna do mix
dep get to get all the library we just
install mix compile to just get though
to complete inside Visual Studio code
okay because it's gonna compile our
project so resources you're gonna see
after that what we're going to need to
do it's now we're gonna need to first
thing you need to add an AWS account and
after that we're gonna need to create an
IM user so we're gonna go here inside
the first page are you gonna go to I am
and now right now we're gonna create a
needed individual I am user we're gonna
click on managers on we're gonna click
add user we're gonna call this one
Instagram Instagram clone admin or
whatever you want we're gonna click here
on programmatic access so they're gonna
give us an access key ID and a secret
access key I'm going to click on next
permission we're gonna click on attach
existing policies directly we're going
to ear search for s3 we're going to take
for Amazon s3 full access we're going to
click on next review just make sure this
is whatever you want we're gonna click
on create user now here I add some of my
secret and stuff like that but yours
just take yours finally and the way I
want you to do it's going inside your
project click on new file click on the
env and right there what we're gonna do
it's a we're gonna finally add on the
we're gonna add some kind of with not
some kind but we're gonna add some
enjoyment here the way that's gonna work
is we're gonna use the AWS access key ID
and now just put equal and just paste
whatever you have inside you access key
ID and paste it right there and we're
gonna do the same for doing the secrets
of AWS see secret access key like that
and now here your space whatever the
secret key they gonna give you and save
the file go inside get ignore and put
that env inside you'll get it no and
don't touch it anymore so the way we can
end all that because we and we're gonna
see that we're gonna go inside the
config file and this config file what
we're gonna do it's now we're gonna
create a new config you're gonna get
this key so we're gonna say here for AWS
I'm gonna sit config exe AWS like that
I'm gonna say access key ID we're gonna
get that from the system that get and
rerun man variable and we're gonna say
AWS access key ID put a comma secret
access key so that's gonna be this the
secret one get env AWS secret access key
and here now what are we gonna do is I'm
gonna just create some kind of a scheme
and stuff like that just follow me area
just I want my image to be HTTPS because
of iOS my oh so I'm gonna just put my
oath here and I'm gonna say Instagram
clone be the street that I'm a zone AWS
calm it just finally the posting all my
image gonna start like that HTTP
Instagram lalala and here I'm gonna just
see my region it's gonna be us s East
one so all that ear this house and
region would be yours and I don't think
because I'm gonna use this one for mine
I don't think you can use it for you I'm
not quite sure but I think this need to
be unique or ting enough okay so now we
have the confi so now we can start the
server first thing we're gonna say
source env2 export every key we just
have put inside a env file and after
that we're gonna run the project with a
mix Phoenix okay and now we get a syntax
error before access key so we forget to
put here at como don't know if you run
again perfect Iran so another way we're
gonna end the lab it's now we're gonna
jump on the Lib folder we're gonna go
inside the Instagram post and post yeah
so this one I didn't delete the dog for
this one so I'm gonna just delete some
command just to make the file a bit
smaller that okay and now what are we
gonna do here it's that's going to be
the place where we can finally create a
present URL so what are we gonna do is
we're gonna say the f
pre-sign we get sorry get pre-sign URL
and this one need no argument at all and
we're gonna have another function ear
called get image URL and this one you're
gonna need to think so this is the two
function we're gonna need and this one's
can be private and now here what we're
gonna do
it's we're gonna create first thing a
UID to create a unique name for the
photo we're gonna so I'm gonna set you
UID that you you the UUID for version 4
we're gonna say the buck yep so give it
the name you want whatever you want you
can call that up loan or for me I'm
gonna call that photo for now after that
I'm gonna put a config who's gonna be
cool to an app where I'm gonna say
region and us is one I don't think I
should have need to do this in my config
but that was the way I did that for now
so yeah I'm gonna secure parents and now
here we're gonna have an list of about a
list of ear with the content type oops
not like that content type so now we're
gonna say which type of thing we're
gonna send to this prison URL and for
now I know it's not good to do with this
you should use like a mem library who
get whatever is that type of the photo
you want to send but for us we know
that's gonna always be jpg photo and I'm
gonna just enter that for now with image
GPE G like that and we're gonna just say
finally ear SEL and we're gonna say we
want it to be a public read okay
after I'm gonna see pre-sign options
we're we're gonna have a virtual Oaks to
be found and we pass the creep around
whatever we have create after that here
we're gonna have a to paly we're gonna
return from the AWS that config the
new so we create a fan either a confit
or we say s3 and we pass it the config
so the config we have right there
so this that's why I don't think we
should have need to add this but make it
work and now here I'm gonna go right
there
we're gonna do a pipe to another AWS
that estrine the pre-sign URL here we
see that's going to be a put request we
put the bucket we need and now you know
that we need to put the object and the
file name sorry so we're gonna say here
in the string interpolation UID
so the UID we have green line 90 at to
d8 that GPA and then we're gonna pass a
pre sign option okay like that and
finally we're gonna return a map where
we're gonna say upload URL gonna be
equal to the URL we gave it back from
this top one and now this def get image
URL it's because this thing you're gonna
give us the prison URL the one I've
shown you in the last in the
introduction where it's like make no
sense at all like it's not really a URL
well we need to create the URL it's
going to be pretty simple what do we
need to do it's just passing the bucket
and the UUID and our we're just gonna
return at HTTP
Astri that Amazon AWS calm and now here
you pass the name of the bucket we
create which bucket not the bucket we
create but yeah the bucket finally and
which folder so here that would be
fooled or not broken but you see my
point here we're gonna pass the bucket
we passed here and here we just passed
that name and that's gonna be UID that
GPA so here's gonna be the URL we're
gonna save in the database so that's
gonna be the URL
user can access to get the image so now
here this is a madness like that and now
here we say URL it's gonna be equal to
get image URL and we pass it the bucket
and the UUID like that so now we're
gonna
on the resolve our of the post and now
this resolve art is going to be almost
really really simple so the result was
gonna just be finally I okay cow so
we're gonna say def pre-sign URL where
we have three argument we don't need so
we pass back nod back to underscore you
need to end this one okay and this one
we finally just do okay Instagram the
post and get three sign URL like that no
need to call it when you have no
argument it's called by default okay so
now what we're going to need to do is
we're going to need after that to create
the object type of this person URL so
open here inside your schema folder go
inside the post type and what we gonna
do it's at the bottom we're gonna create
a new object call that pre-sign URL
inside that we're gonna have to feel the
one we have just good so we're gonna add
a type URL who's gonna be a type of
string and it's not new so it's
impossible to that admin and we're gonna
also upload URL who's gonna be not new
string also well now we have create the
object we need for that so now inside
the schema we can call this one so what
we're gonna do we're going to create a
new description so here get a three sign
URL for uploading photo feel we're gonna
call that pre-sign URL we return a
prison URL object and now here what
we're gonna do is we're gonna make sure
you are authorized for doing this and
also we're going to resolve that to be
the result web post and pre sign your
stash tree like that because we need to
pass these two argument okay so now is
that time to test it so we're gonna open
graphic UL sorry
okay looks like nothing crash so no yeah
I'm gonna say get free sign URL okay so
this one's going to be a query so we can
open the curly bracket like that present
URL and now here we have the URL and the
uploaded URL so if I run it now this is
what we got okay okay so now with this
stuff we can upload this image and for
testing that because we didn't put the
front end yet we're gonna use postman so
what I want you first thing it's good to
go to google search for any major one
here I have one I'm gonna save my image
on my desktop like that and I can maybe
save this one also so you can just say
whatever image you want yeah and now
what you can do it's going postman open
postman okay we're gonna change the get
to be a put request and now we're gonna
run again this one yeah but before that
we're gonna go in the others we're gonna
see see a content type to be image JPEG
and now here what we want to do is going
inside the body and I'm gonna go here
inside the binary and I'm gonna choose a
file so that's going to be the image or
whatever I want to send so I can maybe
send this one and now here I'm gonna run
my graph cool
I'm gonna take this URL I'm gonna paste
it there and I'm gonna send now I get
the specific the specified bucket does
not exist yes because now I need to
create it so go inside you'll AWS click
on service click click on s3 now here
we're gonna create a bucket so we call
this one Instagram clone put the name
whatever you want
yeah so bucket naming already exists so
I think yeah I'm gonna say zero
so we're gonna need to change some of
the stuff we're just in so this is
something I didn't know
okay and now here what we're gonna need
to do its we're gonna just see next and
create bucket for everyone
okay like that and now in Instagram
clone right there what we're gonna need
to do is we can change here the the
permission not the permission yeah to
get the list object so now that means
now we get some like public permission
and now we can create a new folder but
you don't need because we're gonna get
it already with the graph QL so now we
just need to change the name that's
gonna be Instagram clone too so now
we're gonna go back and post ear and now
we change this yeah that's why I create
in sorry I'm clone to like that and I
think I need to change that in my config
because I have put that this one here
okay like that so long as I send this
one now because we change their confi so
we need to restart okay no I have you
know I go on post man I paste my url and
now I send and all that get create so
now if i refresh my screen here now I'm
gonna get a photo bucket and inside this
one I have this image and now if I copy
paste this image now you see the image
here we have is the same as what we have
right there is the same one so now if we
go to this image what's gonna happen now
is we're gonna get this access denied so
now what we're going to need to do is
going ear inside follow and inside um
come to me and we're gonna go air inside
permission I'm gonna say on bucket
policy sorry and ear we're gonna just
follow what they say here grinning read
on the permission to an enemies user so
we're gonna just copy paste that so
finally the thing I've done before
wasn't
good with the other song we're gonna
remove it but now here you see you need
to change the bucket name here so I'm
gonna change that to be this Instagram
clone 0-2 now I'm gonna say okay and now
I think the problem was here when I
click everyone I'm gonna remove it okay
so now my image if i refresh in this one
now my image is right there because now
everyone can have access to it so now if
you want to see if I upload another
image so what I'm gonna do is I'm going
to choose a new image I'm gonna take
this one so it's really not the same and
I'm gonna do another graph QL Chris and
URL right there I'm gonna take my URL
I'm going to paste this one then again
this one take the URL we just have
created right there and now we can place
this one right there and now we can see
the other image we have created so you
see now and now if you look at your
bucket and you were refreshing your
screen you're gonna see now we have two
image right there so that's it I mean
now if you follow what I'm trying to
show you it's now the front end before
we upload an image the front end do a
curry call to the backend get the prison
URL object where I get the URL the real
URL end upload URL send the image to
upload River and you have saved in is
like any state URL when this one gets
succeed with a 200 call as you can see -
Andrea now we gonna create pushed to the
mission where we create inside the
server and we're gonna give it this URL
so when we're gonna send the object
that's gonna be the URL we're gonna save
and this is the one we're gonna save in
Postgres so I hope you enjoy so in the
next part the only thing left to do
before the server is going to be to
create a mutation where we create a
photo so it's gonna be pretty simple so
I hope you enjoy this video
and I hope you learned a bit and we're
gonna talk together bye</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>