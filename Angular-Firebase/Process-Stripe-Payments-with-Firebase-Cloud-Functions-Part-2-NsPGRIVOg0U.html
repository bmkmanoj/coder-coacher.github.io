<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Process Stripe Payments with Firebase Cloud Functions - Part 2 | Coder Coacher - Coaching Coders</title><meta content="Process Stripe Payments with Firebase Cloud Functions - Part 2 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Angular-Firebase/">Angular Firebase</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Process Stripe Payments with Firebase Cloud Functions - Part 2</b></h2><h5 class="post__date">2017-07-11</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/NsPGRIVOg0U" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">welcome to part two of stripe payments
with angular 4 and firebase in part 1 we
collected the payment token from stripe
and in this episode we're going to build
a fire based cloud function that will
actually charge the card hole stripe
transactions need to occur on a real
back-end server and that's exactly what
we're going to use cloud functions for
the first step is to initialize cloud
functions if they're not already set up
in your project run firebase in it and
then CD into that functions directory
then run NPM install stripe with the
save flag to save it to the local
project your package dot JSON file
should look something like this and from
here we need to set an environment
variable with our stripe API key run
firebase functions config set stripe
test key followed by your own stripe API
key check out the link in the
description to just copy and paste this
command now we can start building the
function in the index.jsp file first
step is to import the firebase functions
library as well as the admin database
and for stripe we'll initialize it with
our API key using that environment
variable we just set the name of the
function will be striped charge and
we'll use the on right database callback
to trigger this function in other words
whenever a new payment is written to the
database this function will be invoked
it has an event object that has the data
from that node in the database which is
the payment along with the token so we
can get that by calling event data eval
and we'll also set variables for the
user ID as well as the payment ID just
to make our code a little more concise
and then we want the function to return
null if there is no payment or if the
payment already has a charge from there
we'll chain together a bunch of promises
the first one being the user in the
database this isn't completely necessary
but it's a good idea if you have
recurring charges or if you want to save
customer data in the database we call
once just to get a single snapshot of
this data then we just return the
snapshot value from there we can tell
stripe to charge this customers credit
card with the payment token
we can set a few variables just to keep
the code organized and we'll also set an
item potency key using that firebase
push ID for this payment this is
important because it prevents duplicate
charges it guarantees that multiple post
requests to this ID can only have a
single side-effect so if we ever had a
network issue
it wouldn't duplicate the charge on the
customers card from there we set the
source to that token ID and the currency
to u.s. dollars and we can just easily
build the charge objects from these
variables now the stripe API finally
comes into play we call stripe charges
create and pass at that charge then pass
the item potency key as the second
argument in its own object then we wait
for stripe to return the actual charge
object which will tell us whether or not
the charge succeeded in this case we'll
go ahead and save the entire object to
the database and when we look at it
you'll see there's all kinds of useful
information in there now let's go ahead
and deploy the function so we can start
testing it run firebase deploy flagging
only functions then go back into your
app and test that with another test
charge we should see a turn green than
orange very quickly that's the new token
being created then the charge being
updated from that cloud function you can
see the object from stripe contains all
kinds of information such as paid
refunded risk level and things like that
I went through that very quickly so
let's go back and revisit the entire
stripe payment process from start to
finish
the user will enter their credit card
details through the angular app with
stripe check out then stripe will
respond with the payment token which we
then want to save in the firebase
database this will automatically trigger
a cloud function which sends the token
back to stripe stripe will charge the
card and then respond with the charge
details so at this point we're at the
end of the process we received the
funding and now we just need to update
the users balance or assign the charge
to a specific product and that'll be the
topic of the third installment in the
series we're going to create a payment
history component and then
give the user the ability to apply
digital products with their account
balance that's it for part two if you
want to learn more about stripe Ament
consider joining our slack team or
becoming a pro subscriber at angular
firebase comm where you'll get exclusive
content about building apps with angular
firebase and stripe payments thanks for
watching and I'll see you for part 3</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>