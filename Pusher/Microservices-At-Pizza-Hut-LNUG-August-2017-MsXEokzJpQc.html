<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Microservices At Pizza Hut - LNUG - August 2017 | Coder Coacher - Coaching Coders</title><meta content="Microservices At Pizza Hut - LNUG - August 2017 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Pusher/">Pusher</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Microservices At Pizza Hut - LNUG - August 2017</b></h2><h5 class="post__date">2018-03-29</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/MsXEokzJpQc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hi everyone i'm ana i work as a software
engineer at Pizza Hut at the moment this
is my twitter handler feel free to tweet
at me follow me and all the way back all
the kind of stuff I'm here today to talk
a little bit about what we have done at
Pizza Hut it's it's one of those talks
where I will show you what we have done
with node rather than go into details of
any specific technology but I will also
go into some of the challenges of micro
service and note infrastructure and
architecture and hopefully make some
sort of conclusions that are applicable
to everyone who is using note say
some year ago Pizza Hut heard this very
out-of-date ugly website which is a
little bit weird because they were
actually the first e-commerce website
ever created sometime in the 90s so you
would think that they are you know like
up ahead with digital but a year ago it
wasn't so and that's why Pete had
created Pizza Hut Digital ventures where
I work
to create a new flashy awesome website
to begin with for the UK and later on to
go global and they invited McKinsey
agency to help them out with the with
the kickstart and they came in and said
that they can start taking first orders
in six weeks which is a little bit crazy
but they did do it they did do it in six
weeks and the way they did it is they
created a super simple lean targeting
infrastructure for micro services to
begin with there weren't that many over
time it was growing now we have around
20 micro services and we cover two
regions in the UK so we have fully
covered to the UK market at the moment
and we are moving to France and global
over the next three years
obviously this system doesn't only have
to be lean and and easy to develop it
also has to be super resilient and
scalable and to do that we created micro
service and infrastructure which is
really suitable for this kind of task
and we decided to use node fully 100%
for several reasons and over the mouth
super pragmatical that's a lot
necessarily because notice the best
language in the universe
but it is because there is a huge
community around it it's easy to get
good libraries it's easy to get tested
well-documented code that you can just
pick up and use it's easy to do front
and back-end in the same language we all
of us at Pizza Hut do full stuck because
there is no needs to switch contacts we
all work in the same language and last
but not least it's easy to hire it's
it's easier than hiring for example
foreclosure or something like that so we
stayed very much on target say there
will be two parts to this talk the first
one will be shorter and it will be about
the general infrastructure and how we
organized the system and the next one
will be about the challenges which we
have faced while developing the the
original product and the current one say
Pizza Hut as I mentioned we do have
Microsoft's infrastructure it pretty
much looks like this we've got the UI on
the front then a set of public facing
micro services which you can directly
talk by requests and then there is the
VPC of the private sector for micro
services that are talking to our
internal network taking payments all the
sort of secure stuff that you should not
be able to curate directly and that all
sits behind queues so it's it's a fairly
standard micro service infrastructure
there is nothing weird about it and you
can kind of imagine it as like a normal
infrastructure where the UI is separate
and the backend is it's all one chunk it
just happens to be slightly separated
out it might live in different
containers but at the end of the day
it's most of it is kind of the same
we are fully on AWS and that was a
conscious decision to stick to one
vendor which might be weird because a
lot of people when we talk about
infrastructure we talk about you know
vendor lock-in is that a bad thing how
do we make sure that we can move from I
don't know AWS tea to Google platform
easily or to Azure and that kind of
makes sense I guess in certain ways but
if you want to be lean and you wants to
really make use of everything a certain
platform can give you then you really
need to come
to it and so far that proves to be the
right decision for us everything is
written in terraform there's actually
the link at the bottom also shadow
slides later on is a terraform
repository open source written by our
solutions architect who created the
whole system and you can literally just
take that and and run your own micro
source infrastructure if you want to
give it a go so theoretically we could
deploy it to Asha because we used
terraform but obviously we are linked
into dynamodb and s3 and all these
similar things say you can never really
take any kind of architecture and lift
it off and put it somewhere else even if
you code in something like note because
you always have the external dependency
even if they are minor say that's about
the main infrastructure and yeah it
really allowed us to move fast to
iterate really quickly we do continuous
delivery in the sense that we do not
even have a staging environment because
if you want to replicate 20 micro
service in exactly the same state in
another environment that is really
tricky but actually we don't need
another one another staging environment
I can see really puzzled faces now and
and when I first came to Pizza Hut I was
like well we don't know staging and
runner I was really afraid to push life
because I felt like I'll break
everything immediately but actually
having separate micro services and
separate repositories really do risks
everything because if you screw up you
screw up on like one small part and
quite often we use feature flags and all
kind of kinds of systems around it that
allow us to swap back and forth really
quickly so even if we manage to screw up
something in production a it usually
doesn't have a big impact and be it's
really easy to roll back to roll forward
to change things around so it takes a
little bit of inner discipline to make
sure that you know you have tested
everything well we have a hundred
percent test coverage and we make sure
that our tests cover the right things as
well so that we have relative certainty
in moving forwards and iterating really
quickly and that's how we got to a stage
where within half a year we
completely new website because it
allowed us to move very very fast cool
now for the challenge is it all sounds
really good because you can you know
create something resilient and secure
and scalable very fast towards the catch
and I believe that the catch is mainly
in changing the way you think about
developing your code and the way you I
guess do operations I got do the real
life stuff so there are three main
challenges that I have personally found
at Pizza Hut one is optimization how do
I make sure that things are fast
another one is splitting code how do I
make sure that I draw the line right you
know like well how do I split the
micro-services into the right bits and
the lice last one was monitoring because
obviously when we don't have staging
environment we need to know very very
fast if something has gone wrong in
production so the first one is
optimization so as I said we want to
ship fast right like most of the time I
maybe I don't know ship to production
five times a day I want that to be very
fast if I want to rollback it that needs
to be also very fast so we wanted to be
able to do all these things quickly but
also we wants to make them safe we don't
want to break production because we have
I don't know thousand sales every ten
minutes in peak hours we have a lot of
sales going through and if we screw up
we lose a lot of money basically so we
want to stay safe and fast so how do you
draw the balance and in our main micro
service which serves products we have
about twenty thousand tests which is
insane that's like incredible amount and
most people when they see it even like
the you know it like new starters at
Pizza Hut are really puzzled by they're
like why would you do that well we have
around 700 huts and each heart has about
hundred products and we need to make
sure that every single heart has the
right products and just the amount of
combinations that can go wrong in such a
system is that they're up there a lot so
we need to test it really really well
but how long are we willing to wait for
something to build right now our built
for just to run these tests take so
about five minutes which is quite a long
time in the continuous delivery world
say when I'm talking about optimization
here I'm actually not talking about
about optimizing the micro service
that's super fast that's that's Surfside
to know under 100 milliseconds it's it's
that's fine
the problem is the built and the tooling
around it so when we had the 20000 test
I started wondering how to make it
faster and I went sorry
into new it profiling and that's really
cool with node you can really easily
determine what is your code spending
time on as an example we can say that
hundreds of times will read a JSON file
and pass the jason that's all we will do
with it
and I originally saw that the read will
take a lot of time and then the passing
may be a little bit much but not that
much
now JSON files in the test is a little
bit big there are mock files of of stuff
of pizzas that each pizza is like
throughout 30 different toppings and
five different cheeses and and you know
that's a lot of data for every single
thing so it said that the farside quite
chunky chunky say there is an example of
what you run when you want to do the
profiling you Justi just probe whenever
you run the script that will create a
really weird super long log file that is
not very readable then you need to run
the profiling process on it which is
also part of notes and package and then
you get some kind of a file which looks
something like this
that's not much more readable I guess
that's about one tenth of the file by
the way it's not that's not even
everything but if you sort of focus on
the main bit in the middle I'm not sure
if it's super readable but I'll walk you
through it so you see that there are
takes on CPU you see how much CPU each
process in your node application takes
and on the third line we can see JSON
parser which for me was quite a surprise
I thought that the reading of the files
would take much more energy for the for
the computer than than it would to parse
the JSON but since the Jason's are
relatively big we actually spent a lot
of time
passing them now you can see that's only
four percent of the actual CPU usage and
you could say that's not very much but
if you have twenty thousand tests then
four percent is actually quite a lot so
for us shaving or four percent was
really crucial so the lessons learned
from from optimization is how to do
profiling and note it's super easy it's
inbuilt
data parsing is expensive surprisingly
you need well
we memorize until we run out of memory
and I think notice by default 1.7
gigabyte memory - its use we actually
overpass it especially now when we are
running different campaigns and we have
like three different versions of
everything for different dates that that
kind of like happens but we also figured
out that we need to shave off a lot of
data that we actually use in our tests
do specifically target tests - the data
we actually need and not really waste
time with mocks that are super long and
contain maybe 70% of data that are not
very useful for us cool so that was
those optimization the next one is put
in code be lean as a spoiler and I think
this one is a little bit more than just
for micro services it applies to note as
well quite a bit because node by default
is quite modular and I think every
single note developer faces the the
question in daily life where do I split
it like how do i split my files how do i
split my modules does it make sense she
maybe extract one thing into a
completely separate module so that I can
reuse it in two different places so I
feel like this is something that we need
to deal with all the time not only in
micro services but in note as well as an
example I've got for micro services that
we use at Pizza Hut well really we have
only three of those but I'll get to that
so there is the products micro service
which is our core micro service it
contains all the data about which
products we have which HUD has which
products including availability in terms
of times some products are only
available during lunch time some are
only available
during Sundays so there's a lot of
different logic around that then we have
as a separate micro service content
which serves images and descriptions and
titles etc and another one is pause
which is point of sale which is the the
system that sits in the actual hut where
we send the orders to now the reason why
we split it this way is because well
product is the main one that's that's
kind of you know like the core that
sells everything together and then there
is the content which makes sense to have
separate because it does not have any
business logic it doesn't really know
anything it's quite dumb it just gives
you descriptions for products so that's
that there kind of makes sense to begin
with to have separately and then the
post micro service is separate because
it talks to the outer world and now we
know that the post system can be changed
we already have a new system coming up
we know that when we go global we'll
have like three new post systems in
France etc so we know that this is like
quite a moving target that doesn't
really necessarily have to do anything
with the user with the user experience
or with what with our business logic
that only tells us how to map our
product to their SK use or their IDs
I also have pricing micro service there
because that's our hope that's the one
that we are splitting off at the moment
because products kind of started doing
way too much we figured out that there's
pricing in there as well for all the
products and that actually doesn't
necessarily need to live in the same
place because when we are working on it
we usually work on it separately it's it
has separate business logic and having
it together in one place just doesn't
make sense and makes things things
harder for us so generally speaking the
approach is to be to be lean not to over
split to begin with we didn't come and
say oh we'll have 25 micro services and
each one will do exactly this we created
a bit like sort of step by step some of
the things were there to begin with
because they made logical sense but most
of them are created over time and the
other hint on splitting is you don't
want to really make two monoliths
because that's not what Microsoft
about and that's not what note modules
are about you don't really want to have
everything living in just one ginormous
things that dust dust and different
things you wanted to separate constants
as much as possible
that takes us onto a controversial topic
of too dry or not too dry or code reuse
because it n it is modular and quite
often we get to a point where maybe
something could be extracted into its
own module and could be reused by three
other other files or modules and it's
the same with microservices sometimes it
would be easier to just oh seemingly
easier to take something off and put it
into its own micro service because then
we would not need to change one thing in
three different places but as we figured
it out over time it's actually much
easier to copy/paste and even a few
times in a year go and change it in
three different places then figure out a
whole system that we would need to
maintain around for use so most of the
time we have well we really have like a
micro service template that has all
these like reusable utils and things
that we generally speaking do everywhere
and based on that we create new micro
services but most of the time we just
don't don't want to make things dry we
are happy to to iterate over the same
thing over and over if that makes things
easier in the long run and yeah as I
already said the lessons learned are
don't over splitter don't understood it
and just just do it as you go I feel
like a lot of people have the approach
that you want to sort of engineer
everything to begin with and then just
go with it but that never works in real
life is special in agile when you know
that every single week somebody will
come and say can we change that can we
change this so yeah be lean and be out
Charl last but not least there is the
there is monitoring which is maybe a
little bit more into operations and
infrastructure but I maybe because at
Pizza add we all of us do everything it
feels like a like natural part of note
micro services for me and the question
is if we are shipping all the time how
do we make
show that everything is okay and how do
we make sure that if something if
something is not okay that we can make
it okay again very fast and for that we
have like quite a complex system of
monitoring and stuff we're hosting on
AWS as I mentioned but using cloud watch
itself the monitoring system that AWS
provides would not be enough because
code which can be down it happens like a
month ago where cloud would suddenly
went down and we had no we were blind in
that respect so for that reason we have
new relic which is also monitoring our
systems and checking it they're up when
we would expect them to be up that there
are no error alert etc and we also have
an extensive system of logging
throughout all our micro services and UI
and we collate those logs and lovely and
then we can easily sort through them and
see if something is going wrong but
obviously doing all of this manually
would be a lot of hassle and so we have
for all of these things integration to
slack it's it's quite quite a badass
robot we call it hot pot it's basically
like a slug board that sits in its own
micro service it's also written a note
and it just monitors everything
it shows us alerts if there is an alert
and cloud watch it shows us alerts
whenever we raise an error in low Glee
say it immediately gives us feedback of
what is happening but also because it's
a it's a micro service and it's quite a
clever thing you can teach it to do
stuff so we implemented autotrace triage
she liked it when an alert comes through
and we have already seen a hundred times
and we know that it's a minor bug that
we don't really want to address the auto
triage does that for us and just says oh
yeah we've already seen that one you can
ignore it which really helps us to get
to the actually important fails that we
have not seen before but it does much
more it's not only about reporting
things it's also about changing things
it allows us to close and open hearts
whenever we are told to do so by the
area manager and it allows us to create
reports for the estimated time of
for pizzas and stuff like that say it
just a lot and we are still building it
to be able to do more and more and and
the hope is kind of that in the end we
don't actually have to go to AWS to
check things we just ask hotpot hey is
everything ok can you give me a report
for something can you maybe I don't know
check if this instance is up etc so
that's that's kind of where it's going
and the lessons learned here are don't
rely on one service for monitoring and
logging well I feel this may be like a
one-on-one of infrastructure and DevOps
you never really wants to realize that
AWS will always tell you when it's down
integrations with slack is awesome it
saves us so much time and it makes it
just much more enjoyable to roll out
things and roll back things and you know
not roll back but you know roll out and
make sure that everything is fine
another one is log log a lot and a lot
of log often we are figuring out that
although we have log on every other
function in our code base it's still not
enough there are still things that are
sort of like escaping us and the more
logs the better there is nothing like
logging too much I don't think and last
but not least designate Alice overseer
we figured out to begin with that if
there is an alert on slacked and
different people jump on it
immediately even if it's 10:00 p.m. on
Friday night so we decided to always
have like an alerts rotor and always one
person it was responsible for checking
that the system is up so that not
everyone constantly needs to check all
the microservices senate other words my
note micro services are awesome they are
not a silver bullet obviously nothing is
but the challenges that have arose
during our working with them have all
been definitely manageable and there are
good approaches out there that help you
manage a relatively complex system like
that and not only micro-services but
node give us a great flexibility to
scale and to make sure that we deliver
the best user experience thank you very
much
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>