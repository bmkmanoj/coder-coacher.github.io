<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Cultivating a Microservice Culture with Node.js - LNUG - February 2018 | Coder Coacher - Coaching Coders</title><meta content="Cultivating a Microservice Culture with Node.js - LNUG - February 2018 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Pusher/">Pusher</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Cultivating a Microservice Culture with Node.js - LNUG - February 2018</b></h2><h5 class="post__date">2018-03-29</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/nNpKiqzQ5Us" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so if my name is Oliver everyone I work
for come Liquidators I am in the tech
foundations team and the remit of our
team is to improve the productivity of
the rest of the team so I'm the software
engineer in the team and I'm accompanied
by two infrastructure guys who've been
building all kinds of wonderful things
for communities and all the things the
metrics and logging and everything that
you kind of wrap around that so I'm
gonna talk through kind of how we go
about building worker services what this
looks like from an engineer's
perspective and all the kind of tooling
and stuff that we've got around this to
make this process really easy and how
we've got containers into production um
before I crack on I'm got to get a train
home today and it was pretty chaotic out
there so I'm gonna have to vacate pretty
quickly after this talk so I apologize
because the best part like coming here
is talking to all of you so is like the
best next thing I can do it took my
discord thing at the top there so if
anyone like has some burning discussions
that don't want to have like something
on here and you don't wanna there's that
time at the end you're welcome to hit me
up apologies on that one okay so on the
left here we've got engineers they
create repos they then write code
builder on produce containers containers
gets production and I'm going to talk
through all of these parts how we fitted
node everywhere everything is no
spoilers
right so no warning engineers create
repos so whenever a new person starts
working on our micro service stack and
we point them to this repository it's a
repo in github that I've made it's
called micro services it's just full of
readme so we've got three big documents
that we're like everyone to read there's
one about like the culture and why we do
things and the reasoning behind it all
there's one which is like this is a like
the walking tour of typing these
commands and these things happen and
there's one of our kind of fun stock
what do I do inside this engineering
guide they're kind of like the first
steps that you do are basically going to
go and npm install this module once
you've done that the steps to correct
any project basically say go to console
still a module run this tool called
create and I'm gonna cover how that
works briefly in a second so I want to
create a new service it asked me what I
want to call it I'm gonna
when our a for it no but I'm gonna give
it a go it's then gonna ask me more
questions it's going to say am I on the
internal network on that check because
we have a lot of network isn't it's easy
to forget that you yep
it's then gonna say which looks like you
mean I'm folder with some codes in it so
I'm gonna guess this is like your gift
folder we're gonna go for doing can I
pick this stuff here and we say yes it's
then gonna say who's gonna own the
service so we have this idea of
ownership
so whenever a team builds a service they
are responsible for it so if it goes
down the other ones to have to come and
bring it back up that works very well um
you can try and type garbage in at this
point and we kind of it'll say no you
can't do that we validate this again
it's kind of the idea of slack slack
groups we can find a cleaner way of
doing that but it as a ease of access it
works surprisingly well so I'm gonna go
ahead and type in on the chat pod name
and it's going to say what kind of
project would you like so we support no
GS we support Python kind of and we
support micro you guys okay - no Jess
it's going to say which are like Redis
yes or no yes please
thing to say which like a sequel
database I want to say yes I'm saying in
a clarify if I'm happy with this I want
to go absolutely then I'm gonna go make
a cup of tea
there's got a chant for wine it's um and
when I get back after those five minutes
it's gonna have done a whole lot of
stuff for me oh it's gonna make have
created the github repo it's gonna have
given me like a base template for the
project I picked it's gonna have build
all of the infrastructure it's gonna
have deployed to all of the various
places it's going to have provision
sequel servers and backups and failures
and staging versions and it's going to
have created all these things and it's
gonna create Redis all those CI
pipeline's can be made all the secrets
are gonna be in all the right places and
it's just magical right so just now the
start we started off with this kind of
funky npm install and then we're kind of
jumping as this come on how does that
work when you write your package JSON
you can put like a bin section in there
and you can specify clones and you can
link them to JavaScript files as long as
those files the e reference are marked
as executable as long as they start with
the hash bang
node when you npm install that module
you'll simply gain those come online
binaries
so one key point to make here is that we
use NPM is a distribution tool and it
works really well by all of our internal
engine earing tooling is installed as
you solve via this all of our build
tooling for all of our CI stuff is all
built through this area everything is
like NPM install would actually here's
our project and like the beautiful thing
about that is it works on RS 10 and for
the next it's a really clean way of
distributing our code so we've got our
project we need to write some code what
happens next what if I neglected you to
get hub file find all of the base
template that has given me which I've
got on my file system I've got all these
docx files and everything it's all kind
of set up with node 1 and everything if
you poke into the dependencies for into
the package stations the dependencies
this is one funky dependency there's a
dependency on this project called the
node toolbox and if you dig into the
readme of that we've got some kind of
reasoning and why we built this module
so I only go ahead and show you what's
in it and then you kind of appreciate
why we've built it so here's an example
we've got going to require the node tool
box I'm gonna use the routing up to say
I would like Express that please I'm
just going to attach this to it and so
don't in here use Express keep your hand
up if you think you can name more than
ones that you need to run Express there
we go
job done when you have 150 micro
services and everyone's building
services you don't want people to waste
their time working out what are the ten
modules that you need these pipelines
give you access logging they give you
metrics they give you error caching they
get the works like five lines boom job
done next up this one's slightly taller
but is for caching you take an object
which is your cache key you take the
object that you want to store you say
storm object in the cache if you asked
for the reddish cast when you Redis
cache when you built the dockyard crate
in the beginning it would just go to
Redis if you didn't it goes it's like an
in-memory cache it's like caching job
done everyone gets caching it tastes
like five lines again you get metrics
and logging and everything and all that
good stuff that goes with it we've built
an RPC module so you can expose
functionality so you can expose an odd
function which has this input schema in
our pit schema and you can
find what it does you can then write
code to consume it so this is like a
really clean way of enabling teams to
share function calls without having to
work out how to mess around with the
passing arguments across their express
servers and all this jars it also opens
up nice opportunities to use different
transport layers so we're playing with
like persistent tcp between services and
all that kind of funky stuff the video
with your arms publish and subscribe
pops up whereby you publish at the top
events on to topics and events come back
down there's a nice wrapper around all
of that so we can kind of hide some of
their complexities and those
technologies and again you get metrics
and logging and all this other cool
stuff we do databases this was a really
good one I got late to this database
party I'm I came to implement this I
found three people three teams had
already implemented database databases
in each of those three teams had spent
like two weeks
implementing databases in different ways
all right when you have you know
hundreds of people in the web team that
simply doesn't scale and so we built the
database ins here notice that you'd have
to pause the access credentials in like
if you asked for a database at the
beginning it just kind of connects and
goes to the right place um so it's like
it's a beautiful thing so the kind of
the key takeaway here is that we've
built one module that wraps all of these
other modules and it seems our engineers
time and working out how all these NPM
modules work that's just there's kind of
too much choice Olympian you can easily
spend weeks working out which modules
you want to use how you build your log
leaf logging module you pick connecting
your logging what joins you Express
module and I think you pub/sub it's
chaos
so yeah we have this one module line it
kind of wraps everything cool so when
writing features
we're using the toolbox it's really easy
we're shipping code really quickly when
we push commits to github we use staging
master branches you push a commit to one
or the other and you'll get a staging or
production build this is what our Travis
logs looked like for awhile you'll
notice that we have that called code
folding thing going on there Travis
there's only hinge Travis couple of
people cool so by default like you build
logs are just like it's massive
sprawling text it's really hard to kind
of read like we had a lot of Engineers
talking to us like how do I read this
log what am I looking at
stand so he went about trying to ease
how we view the logs so you can see
they're kind of like that collapsed on
the left little arrow it tells you how
long each one took if I expand one of
these you can see it kind of you get
that like nice little gutter effect on
the left so you can see the indentation
if I expand that another one you can see
that I think this one has double
indentation yeah so in line three 894
you can see this double code folded so
this module here we call this the Travis
helper it kind of looks like this and
this is one of the finest modules that
we built without really realizing what
we were building so this is just an
async await module while you give it a
bunch of bash commands and it will run
them one after the other and it will
give you whatever output you got any
output that was produced by those
commands gets nicely indented with that
gutter effect and we output the relevant
lines to go forward and this was really
powerful when we started down this micro
service journey all of our deploy
scripts will bash and I don't know if
you guys have seen big deploying scripts
in bash but it kind of gets a bit
unwieldy fairly quickly
certainly if you want to start timeing
how long things take and kind of
wrapping all these things it gets a
little bit murky so we managed to move
well this was like an easy stepping
stone for the infrastructure team to
basically get on board with using nodejs
and I they were keen to use load in the
beginning but they're like hopping into
the directly into like the cool back and
streaming world is quite a challenge
whether the writing code like this way
they just can't wait to try this helper
here's my - get some output Jana
Internet's command off we go it was a
really easy way for them to kind of take
that first step into node we actually
have an amazing thing happen the other
week in the office so so one of our
engineers like a middleweight engineer
put in a pull request and he put it in
my snapchat on is like guys got this
pull request can someone review it at
one of the infrastructure guys Johnson
he has one look at it he's like this
can't possibly work like there's no way
this is going to work
I know you had the engineer he writes
jobs gets all day every day I was like
oh any fun would and he's like I do you
know what this for he doesn't work and
he's like do I make tea like what's the
forfeit
so it was amazing to see those
infrastructure guys growing in towards
node as we kind of provided them that
kind of stepping stone so one thing to
take away from this like that
async/await kind of syntax is a really
good way of kind of
getting people to take that first little
step I don't really need to understand
too much about it but like you can run
commands like sequentially it's like
it's worked really well for us I'm kind
of going back to this you might be
thinking man this isn't really dull
library yeah its purpose but we actually
stopped using them supposed to the CIO
after a while when you have like 150
services paying people to run your
builds is not cost-effective especially
when you're kind of updating
dependencies you get through hundreds
and hundreds of builds a day these
libraries are an amazing place to latch
in and just build your own CI because
you know when can ones are starting you
know what can one output looks like and
you can web put those off to wherever
you want to put them which is that what
we did and so I built a CI service which
has its own communities cluster it looks
listens to the github web perks when its
uses a push on a branch it will go and
trigger builds on the cluster
pull down the code from our deploy
scripts I'll deploy scripts web hook it
back to the CI service and get like a
nice telling output like Travis job done
so that was the yeah we can run builds
really quickly just by doing them in
houses food for thought okay so bills
running we've MPM installed our build
scripts they're already node things are
moving nicely we're now gonna go and
build some containers does anyone know
what these modules have in common
cool all these modules have a like a
native component to them so they all
require you to have GCC and come to
compile a bunch of things in order to
get it working I can see a few people
nodding that is a problem especially
when a lot of us work on these things
web wise you can power something on OS
10 you can't simply copy it into a Linux
container expect it to work this is also
a problem if you use hosted CI like why
you're probably running some kind of a
bunch of container if you're trying to
push your code into a null point limits
container it's not going to play ball so
moving these modules into containers
there's a lot of faff and you'll find
that these modules are fairly you're
going to want some of these modules
basically via profiler gives you the CPU
profiling production which is invaluable
and that gr PC modules like Google's
like if you touch any of Google's
modules for any of Google cloud services
you will get that and you can't
so there's a problem we've got a pretty
good solution to it this I haven't put
that in here this docker image is
actually in public domain so you can
actually have a look at that you can
dock a history that docker file and see
what we're doing but the general
approaches we pre comply all those five
modules into the container and then when
you come to London the container locally
we copy everything in and it was copy
the five default ones over the top and I
saved you having to wait for the NPM
install or the NPM rebuild which takes
ages like minutes and I see you can
convert like your thing that would take
one or two minutes down to about five
seconds which is a wonderful thing when
you're trying to speed up builds these
are some graphs of our memory usage in
production for three different services
that is all that is the complete
container running a nodejs service it
took us quite a while to get the note
and the memory usage of node under
control so these are the these are the
four flags that we ended up hunting for
they basically say don't be lazy and
trying to keep be sensible about what
it's doing
your mileage may vary with these flags
but if you're trying to buy a few small
curriculums than this for example you're
gonna need something like this anything
when you're trying to squeeze as much as
many containers as possible into one
host that yeah
it's worth looking up so those are two
other problems that we found with
getting node into containers there is
there are a few others it is a bit of
hassle but it's definitely worth it
having like a container you can just
push to wherever you like is incredibly
valuable
you can run our production stack on our
laptops using a tool called local and
you can just spawn all of your
containers locally and to see how they
will interact it's really valuable for
debugging and being able to meet you
containers from cloud to cloud and
everything is it's it's definitely
working okay so the containers greater
production once the containers are in
production we needed a way to kind of
help our engineers understand exactly
what's happening surrounded up building
a bunch of services using all the
previous tooling which basically
consumed the kubernetes api so all of
our services are running in kubernetes
now in Google's cloud they do like a
host of Kuban at ease it's surprisingly
good
and they have like the school API and
you can ping it so we have the service
which basically pulls the API every 10
seconds or whatever and it produces like
this nice read-only web page where you
can see every container host that we
have all the services running on them
how much resource allocation they've got
if there is kinda hard to read on the
projectable you can see if they're
healthy or they're unhealthy or they're
crashing or whatever how many times they
crash when they are deployed and like
you can click on a service and you can
see all of the seven container hosts
that that one can tell that service is
running on it's like a really nice Pekin
to how old people eighties works without
exposing our entire engineering team so
hey guys this is how kubernetes works
you know some people aren't going to
enjoy that that leaves me to engineers
get feedback so we've got a service in
production what do we like how do I know
what's going on we have adopted a lot of
chat ops in this area so we have a lot
of BOTS kicking around in our slack
channels so the first one at the top is
the alert bot so whenever you make a new
service with that it's all that I showed
you at the beginning it's important to
advertise to your team that hey guys
they've just built this service and
you've got to own it congratulations so
everyone gets like this little message
saying someone's built this thing here's
the repo here's the alerting dashboard
you know have fun with that will never
build trigger we build them ourselves
our own service we have the CI bot which
informs people on slack what's happening
so you can see when a build has been
huge when the build started when the
builds finished or failed white failed
you get like a nice little slap thread
telling you what the hell is going on we
did a lot of this this stuff because
some people simply didn't fully
understand what was happening with their
services like we're reducing the
barriers to entry so much that people
get confused as to how simple it is so
people were pushing commits the mass
stream we're like how do I deploy this
arise nowadays you looking slacking
you're a slack Channel will light up
saying you know you're deploying this
thing and here's the build steps as it
goes we have an alert bot so we use
Crafar to do our lighting it's in I've
got a nice UI where you can drag sliders
and things that posters think there's a
lighting service which has it yeah a
slack bot while we post the graph so you
can see why things broken
what are we
about this you can have chats about it
and slack in line debater fix it you get
them what's that called there's a bunch
of services which will pull your
websites every periodically and tell you
when they go down there's a whole bunch
of them status cake is one of them
it's a whole bunch we do that in-house
because we can pull it to slack and tell
people so it's really obvious when your
service is broken because your slack
channel lights off and you get the
graphs and you get the messages saying
it's broken as soon as it's back ups
like edits the message and you get the
green message again when we throw errors
in production the node toolbox catches
all these errors and we throw them to
slack so you can be like oh it's
crashing it's crashed four times in
production we need to do something about
this and the nice thing about some of
this like I can get my phone out right
now and see all of the stuff and we can
put buttons on these things so like the
previous ones down here is a redeploy
button when you run a build you can play
you got a cancel button like you can do
other stuff on the train without getting
on the corporate VPN you just pluck out
your phone you can see the alerts like
oh no what do I do
scroll up hit redeploy on a previous
build so it's a really clean way of
getting people to interact for your
stuff without getting after power which
is wonderful
I like that goes on we have an access
spot which is we're using too much
access I guess to various things so
we're locking down data and everything
based on what team you're in and you can
now ask this access but you know I want
to join the solid team temporarily can I
get access then someone in that other
team has to click approve with slack
buttons by the way you can tell if you
click the bottom so you can't be like
you can't click that button you're not
gonna help yeah and this basically talks
to Active Directory and github and
everything kind of adjusts your
permissions on the fly which is a kind
of nitrous
we've got a whole bunch of others ones
like we found as we built all this
really cool stuff micro services all of
the engineering team really excited by
it so the pointer which they are all
like trying things in the evening and
the weekends and when things that work
they just jump on slack and message
people and they're not feeling like the
little casual message in that to say by
the way we do try to sleep in the
evenings you can wait try again later
this one in the middle right is a really
cool one I mean guys use JIRA
my name is you're a couple of people
some JIRA asked if things
maybe if you slack like when you've used
slack going back to a ticketing based
system where you gotta take your
messages on the tickets it's really
painful so we've coated up so that when
you drag a ticket across the back the
open channel you get a message like this
if you click create channel you'll get a
slight channel that you can type in
anything any conversations that happen
in that snap channel get archived once
in the JIRA any messages on the giro get
archived back into suck so you don't
really have to leave slack you can just
like have a really good chat like this
what's all the code tag since like
backticks and it tags them if you up
people it fixes the names and beautiful
they got a few people DM me on github
like a slack message and it's a bit
nicer than the flurry of emails that you
go if anyone here works any of the
companies that could benefit from this
though this is what good chat pods look
like that's really valuable so a kind of
a key takeaway there like chat opps is
an incredible thing you've got to get it
right like in the very early days we've
got it slightly wrong that was kind of
too many messages in the wrong places
that kind of got annoying we've worked
our I'll kind of slack layout these days
so every point has three channels one is
like our private channel for gifts and
talked about going to Nando's and you
know silly silly shenanigans and
whatever ones not safe for wanting one
of them is for like other people other
teams that approaching your team for my
only this thing how I do this how do I
use your API committee to change
features you know these cool
contributions and stuff and then there's
like a knowledge mint channel whereby
all this chat bots are basically you
know putting their stuff in there so
that kind of forms a nice segregation of
you can kind of you have to talk around
the bots which kind of gets annoying
okay so I've kind of gone from the left
engineers we curate repos so engineers
creepers using in silence all in which
we distribute via NPM
we write courage with the node toolbox
which is a nice wrap around all the
crazy modules and stuff that you get in
in NPM builder on with an in-house
service written in nodejs using in no no
js' build scripts again and still apply
NPM
those builds produce containers which
has nodes in it
they go off to production and we get all
the feedback through all the bots and
all of everything else
almost yes again says it snowed
everywhere everything is known so can I
get to some place what I've been doing
like we've automated everything how much
JavaScript did everything the only
things that we're struggling to
JavaScript are things like the deep data
world like the machine learning stuff
like because you can't overload
operators in JavaScript like pison has
that advantage of array plus array
equals array in JavaScript you just
can't do that so I think I will always
struggle in that area but generally
speaking it is definitely possible to
get you infrastructure guys writing
JavaScript and once they're on that
train like they realize the power of
consuming API isn't talking to get help
and everything and fly are you very
quickly hit economies of scale this is a
quick summary of like what all things
look like before and after
micro-services so you can see building
any service used to take again two weeks
of faff with various cloud providers and
getting installs and getting your are
set up and getting working I have to
keep you know process up and hard to
cycle an auto scale and build CI
pipelines and how how does team City
work I don't know but how it takes five
minutes it takes five minutes in the
four of those minutes I'm getting a cup
of tea it's beautiful and shipping a
Minimum Viable products nothing's in the
order of hours because we've taken that
away the complexity of picking all your
modules and working out how to clean
them all together
deployments now take four minutes on our
in-house CIO rise used to take twelve in
Travis that is how quickly you can do it
by the way like it's amazing how quickly
you can run builds when you do it
yourself
and that's mainly because you can baking
your dependencies in nowadays we don't
people that need support to build a new
service like IE
I have no idea when people brought new
services they'll just build them and
they consumed them and they're all very
happy and there will shipping your
services they don't have to approach
anyone on our team to be like I wanna
build the service can you can you know
can you do these things for me so
they're kind of very much lots of
freedom so that they can build new
services and genuinely half a day and
that's an incredibly powerful thing to
the point in which my innovation is now
cheap for us right we can try something
we can get it in production in half a
day and we can see if it works and if it
doesn't work or just delete it and move
on and we don't have to like pour
through your legacy stuff from your mom
or less and try and code to making new
stuff work and you can I don't want it
delete it because you put so much time
into it and then it kind of lingers for
a while and go stale and gets all
horrible
so yeah yeah cool that's most my points
thank you for listening</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>