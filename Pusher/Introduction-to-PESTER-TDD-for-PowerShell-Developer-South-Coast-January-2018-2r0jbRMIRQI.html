<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Introduction to PESTER - TDD for PowerShell - Developer South Coast - January 2018 | Coder Coacher - Coaching Coders</title><meta content="Introduction to PESTER - TDD for PowerShell - Developer South Coast - January 2018 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Pusher/">Pusher</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Introduction to PESTER - TDD for PowerShell - Developer South Coast - January 2018</b></h2><h5 class="post__date">2018-03-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/2r0jbRMIRQI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello nice to meet you this is my third
different user group that I presented to
you in this building of them the sequel
user group and I've done the pyro use
group and now I get to meet you guys as
well so my name is Rob
I am a production sequel DBA by trade
originally once upon a long ago now I do
stuff I pretty much go in and do the
things people don't realize they need to
be done so DevOps automation I do
training all the boring under the hood
stuff and nobody really sees and I love
para shell I've been doing PowerShell
for many years now and I'm lucky enough
that I'm involved in organizing the
paschal conference in Europe
I've spoken the PowerShell conference in
Asia I did the PSD in London as an
organizer and a speaker and I'm involved
in the sequel community as well so any
user groups sequel bits sequel really
all of those sort of things and I've
developed a DBA reports as an open
source partial module for collecting
information from sequel server states
I'm one of the founders of DBA tools
which is probably know is definitely the
best PowerShell module for working with
sequel even better than the sequel
server one from Microsoft and yeah I
know that's recorded and we are
currently developing something called DB
HX which is going to use DBA tools and
Pesta to develop nice easy to use
validation for your environment so I'm
going to do two sessions today first one
is going to be introduction to TDD with
Pesta which probably going to be more
your guys sort of thing as developers
and second one is going to be green is
good red is bad turning your checklist
into pesto tests which might seem like
in the air what's the point but actually
hopefully you'll see pest has got
another side that's really really useful
as well oh yeah I'm an MVP Microsoft
decided that spent so much time speaking
about my
that they'd honor me with that award I
still play cricket even though the beard
is gray and I fly a drone I crashed a
drone and now I've bought a new track so
pester pester provides a framework for
running unit tests to execute and
validate Parashar commands from within
para shop it's the first open source
thing that Microsoft releases with one
of their products so it's embedded
inside Windows 10 in the para shell you
get in Windows 10 you'll have pester
them best there was an open-source tool
it's an open source module you can see
the code on github you can go in
contributes and it enables you to do
unit tests and validate your partial
commands why do we need to test we need
to test to make sure that our code is
working correctly
even people who use PowerShell nowadays
if I'm working on PowerShell and I'm
developing something that's going to
recreate an entire environment in Azure
I want to make sure that it's doing what
it should be doing this is something
that was really hard as a an ops guy as
a production DBA to get my head around
what was what was this how is this
important why do we need to do this we
need to prevent regressions so we need
to make sure that when we make a change
it still works how it should do if we
upgrade something it's still going to
work with the old stuff with me big new
documentation because we all love to do
documentation pesto
testing in general could actually help
you to document how you when he wrote it
expected the code to work so my command
should have an integer as a parameter
because we're never expecting a string
to be passing you write a test to make
sure that's happening and then explain
in the title of the test why people will
understand always think about the future
you all the thing what you call it a
meme I guess about always code like the
person who's going to follow you is a
maniac axe wielding psychopath who knows
your address come on you really like to
laugh you could have something laughter
it could provide design guidance my
security team say that I must only have
windows groups has logins to my service
so I can write to you detest whenever
I'm adding a log in to attack to a
server to say that if it's not a group
don't get out it enables us to refactor
so when we go back and somebody says oh
can you do this we've upgraded to this
version can it make sure you do this
well that's really amazing what that
does with those sequel servers can you
get it to do the same with our
application service if you have good
unit tests and enables you to make sure
that all of that happens
so as I said already if you've got
Windows 10 PowerShell version 5 and
above you've already got Pesta
unfortunately because it's being
released with Windows 10 embedded in the
operating system it's not the version
that can be updated by the parish or
gallery power gallery is a new gate type
repository of PowerShell commands and
modules and it means you have to do this
force and this skipped publisher tip
check to update it you might have to do
an install module pester to get it to
install from the gallery so that then
you can update it the new powershell
version 6 does not have pester embedded
into it for this very reason use partial
version 6 special call call because it
runs on dotnet core because it's
available cross-platform but also core
as in only the core things that you need
are embedded in partial version 6
everything else that you want to go and
get you go to the powershell gallery new
installer modules you build yourself up
your packages of modules and commands
that you need to do your work
if you're not able to run your commands
as administrator you need to use a dash
scope current user to enable you to
install any modules modules pester this
runs for any single module tool and
something else I was going to say then
if not is if you work in an environment
where you're not allowed to connect your
machine to the Internet and download
strange things because obviously parish
or galleries hosted by Microsoft has
some pretty good malware scanning on it
but you should never trust anything from
the internet anyway so you should do
your own checking on those things so
don't automatically install it what you
can do for the patrick gallery is save -
module save the module down to path and
then import it from that path we want is
passed all the relevant checks that are
required to get on your environment
what's it look like looks like this so
I'm going to describe so PowerShell
normally goes verb noun but here we have
a different command command is one word
it's described and we have this is the
group of tests we just put a name of
some description in it a string and then
we have a curly brace on the same line
very important that you have the curly
brace on the team line otherwise you get
my favorite para shell error error that
kind of walks up to you guys
you put the curly brace on the next line
as opposed to the random sea of blood
that you sometimes get out of PowerShell
when stuff goes wrong so we have a
context there's a set of tests a scope
and this is very important you to
understand that within this block
everything is within the same scope just
allows you to group your tests together
in a certain way it it is the test it's
how we decide this is a test we give it
a title but I clearly brace on the same
name on the same line and then we say
what I found pipe sign should be what I
expected or should not be what I
accepted or should be less than what I
expected
whichever way round it needs to be
that's pester and the results look like
that Green is good red is bad if we do
an environmental validation we're doing
TDD Green is good red right that's also
good because it proves we've written a
good test we've made sure it fails
before we've written our code to pass it
and this gift doesn't stop looping like
I thought he did but you can see that
you get some results you get a skip test
and it will tell you where things fail
environmental validation absolutely
brilliant we will talk about that after
the pizza free editor allows you to work
in all sorts of languages so you can
work in any of these and alter
formatting intellisense all the rest of
it you can add extensions you can do all
sorts of funky stuff and the play with
docker is your containers you want to do
some of the get lends blame stuff all
available to you within Visual Studio
code it is the editor that you should be
using for doing any powershell and
creation one because it's nice and easy
to use and you can create as many tabs
as you need to you just keep building
new stuff it's got brilliant debugging
process and because there is no more
development for the ISE to the old
believe where the bottom and white at
the top that you would expect that will
no longer be developed it will still be
available but it's not gonna be in any
development whereas this gets updated
every one
so if we did a list available and have a
look at all of the available variations
of pressure that we've got three point
4.0 that'll be the one that you've
probably got in your machine I'll be the
one that was delivered with you all
Windows operating system and as you see
I've updated mine at several times at
the moment 4.1.1 is the latest available
release and we'll also have a look at
some of the pre-release what week to
version as well so when we're just
working on a single command we're going
to start by just running the command new
fixture and what new fixture does with
the name that matches the command name
that we're going to make is creates as
two files the crater's file with our
command in it and a file with our tests
in it and what we'll do now is so what I
was doing when you came in was setting
up my API and unfortunately I managed to
run out of credit on my usual
subscription so I tried to set up a
different one which didn't quite work as
I expected
otherwise this would all be ready so
spit thank you
on the left we have our function this is
what's been created for us by new
fixture
it says function gets bigger beard and
curly braces that's it's done on the
right we have this funky start for
getting the current value of the path
we're in and the current file that we're
in and splitting it out and taking away
the tests so that we've got a name just
leave it there and it gives us a nice
quick describe so I described now we can
run a test
if we run invoke pester in any folder
it's going to go through and look for
any file that ends dot test ps1 with a
capital T only it's going to seem that
this pester in there and it's going to
run the pester and gives you the output
and as you can see what we've got
does something useful false true should
be false we get the read we get a
failure tells us how long it took to run
our tests and that we failed this
perfect we failed a test because we
haven't written any code yet so let's
start off by writing some code as if by
magic over here we've just written some
code say does my command exist its
command name exists we're just a get
command error action silently continue
this is a PowerShell
and way of suppressing our errors so we
don't get our test results completely
overrun by a sea of red from a failing
PowerShell command just keep that hidden
away now then we've got should not be
null or empty should be something there
so now if we run off test we've done it
there we go
congratulations so you've now learned
how to do TDD we passed that great a
test it fails to rent some co2 passes
pretty much that's it but let's go on a
little bit in general what I do is
create myself a set of contexts like
that so I've got a test for my input I
got a test for the execution the path my
tone that they're taking I've got some
if else's or some switches test where
they're going to go and test for the
output probably it's where you gonna put
mostly tests I'm gay testing get speak a
bit absolutely yes so this is the
function that we're testing on the on
the left and this is our test on the
right so very well but what is Speaker
beard going to do so let's get Speaker
beard is gonna do yeah we've got we've
got no internet so great we're going to
use the cognitive services API from
Microsoft for no other reason than
because it's fun and also free and we're
gonna use the faces API to analyze this
page I'm gonna take each picture from
this page you're going to analyze it and
see how good the beer is how much beard
there is on this page of speakers at an
event in Portugal last year and I'm sure
you will agree that there's there's one
particularly fabulous beard in there
that I'm particularly proud it's the
first thing we need to do
if you wanna run a command that says
when there is no speaker in the array we
should get a useful message so we really
defined that we're going to put an input
in there and when we put the input in if
we haven't got something we expect we
want to get back this particular phrase
this is what has been decided by the
focus group so this is the message
should be given to our users for when we
have not got a speaker available in our
comment when we look at our command
it's literally saying one argot speaker
beard with a value that I know is not
available and it should be no speaker
with a name like that you enter Chris
who you met that's exactly what we were
expecting to get nope
when I run that test fails we write some
code to fix that test you have a look at
that very simply gives us as a parameter
of faces and we've set our face is equal
to get speaker face
fortunately the get speaker face
function isn't going to work for me so
what I'm going to have to do is actually
just move on so what I would normally do
is run this test and the test will call
get speaker face get speaker face will
go off to the internet it'll go to the
web page of T right e get the speaker
faces down analyze each of them show
that display what
analyze all of them put all the results
into a JSON objective and then get
Speaker beard is going to make use of
that JSON objects to decide about
whether speakers you've got a beard a
lot now I can't run that right now
because my a guy is not working my
Internet's not working everything's
great
I normally I'd run the test and then
turn my wife way off and say we'll look
I passed the test and then it failed
because we should only be testing the
code that we're writing we shall waste
write our unit test in such a way that
nothing external affects them at all
right now
lack of internet and lack of API means
that this test is going to fail when
actually I might have written the code
that would mean it would pass so we need
to do a thing called mocking luckily
I've got some Jason already so I happen
to have some Jason already this is what
you get from get speaker face as you can
see it'll give you the name of the
person Yap brusse because one of my
friends he's a dutch powershell MVP
helped me to write some of this as if
you see with the particular picture
these goodies that he's not that you
can't tell you can't see with a picture
that he's wearing and he's not wearing
any makeup so this is this is good we're
pleased about that
they did used to come back and resolve
that he was wearing makeup so a
different plain-looking and it also
gives us the URL of the image so we can
actually grab what what image we've got
this is exactly that this has been
picked up from this JSON file here and
the JSON file is just some Duff data
that I've created actually straight off
of there to enable me to mock my command
and I mock my command with that piece of
parasol there so I took the value from
the actual website I converted it to
Jason we had a depth of five and then we
just didn't act file to face it so Jason
and that means that I can lock my code
like this so now we've added another new
command to our peso test it's called
before all I don't need to tell you what
it does
runs everything inside the curly braces
before all of the tests surprisingly
enough there's one called before each
domain which will work run all of the
code within the curly braces before each
of the tests there's also an after all
hand and after each to enable you to
create and destroy whatever things you
need for your tests all within the scope
of this context block if we put the
before all up here the describe level
then we run for every single context bot
that we've got sorry every single eight
block that we got within that described
block what we say is set me the variable
Mach face to the content of the faces
JSON file with a little bit of that to
make PowerShell understand that this is
a JSON object and then we say look get
speaker speaker face with whatever is
inside the curly brace basically when
you're running this test every time you
see get speaker face don't go and load
the function go off to the internet grab
the page bring it down analyze it with
cognitive faces API and then give me a
JSON object just give me this and you
can fill that with whatever you like
only that means that I can run this
command
it's going to go to get Speaker beard
it's going to fill in the speaker from
the parameters that we set and it's
going to set faces to get Speaker face
and then go hang on a minute I don't
need to do all that rubbish I'll just
use this mock staring run test test
passes
everybody knows wall as well you cannot
have a context without a context
no not it you could you can have as many
contexts as you like with another
describe have as many describes as you
like within a file but each of those are
going to be their own steps so that's
right another test and this test is now
going to be in the end it should return
the beard value for the speaker so we
know that Yap brasses bid value is not
point to because we created it in Jason
and when we run when we run our pester
fails because we haven't got any values
we've got no code there to fix that so
as usual we're going to write the code
to fix our test say if we have got
something just do the phases where grab
me that property out of the Jason please
and we just keep adding ourselves
further and further things within this
as we go forward so we can make sure
that we've got a speaker name and a
beard value and a URL if we provide the
detailed parameter so if we add that
switch we definitely should have all of
these three things now this is wrong you
should only test one thing and one thing
only each time okay you can write three
of those tests and test the name and the
beard and the image URL but actually my
argument would be this is right because
if I've got a detail I want all of those
things actually it doesn't matter as
long as you make sure you do what is
right for you it's fine
pesto can do more than one test within a
net block whether it should or should
not is a religious argument that other
people would have yes
Hey so the thing about this is within
this it block everything should be the
right value so he takes one of these to
fail and if one of them fails he'll come
back and say I was expecting naught
point too but I got a hundred right so
you'll know where you are if two of them
fail you'd get I was expecting 0.2 but
it should have been 100 you won't know
which one of the other two it is that's
fail and we carry on we write some code
to pass our test run our code test
passes so now our code has if we've got
a detail then do this otherwise just do
that a bit of an expression just to make
sure we've got everything that we
expected if we want to open our URL we
could just have a show image switch and
that's just going to start a start
process and this is pretty much just to
say that you can mock powershell
embedded commands as well as your own
functions that you've written for
yourself so doesn't matter what it is if
you mock it pester will return the mop
just don't try walking invoke pesto
because then it really gets us sorry in
a twizzle so we'll write ourselves a
test to make sure that we've got
everything Rulon taught me what we're
doing oh yes we're doing we're making
sure that our code follows a certain
path and if we have chosen to get our
image URL we want to make sure that
we're going to use our showing me switch
so this time we're going to we know what
the value is going to be Valley is going
to be nought point two that's what's
going to be returned from our function
we're not going to test that we get an
actual image we're testing the return in
the console from our function so even
though we've put the show image switch
in what will be displayed on the screen
will only be the output from the command
that's what we test that we're gonna
check that if we use the detailed switch
as well as the show image switch that
we're gonna get those three values again
and now we're going to come up with
something else it's all very well
mocking your commands but you need to
make sure that they have actually been
locked or if by mocking the command
you're actually taking away some of the
functionality and you're no longer
giving an output that you expect you
need to make sure that you're testing
that you're calling that comment and
that's where we use assert mock calls
this is called splatting your parameters
it's just a power shell way of
displaying all your parameters up ahead
of time so you don't end up with -
command name - x that's exactly -
precise because that makes it really
difficult for people to change things so
we're just gonna say I want you to check
the mock forget speaker face it's only
checking the mock it's not if you
haven't mocked the command it's not
gonna work in fact it's going to come
back and say no I don't have a mock for
that command how many times well I know
that because I've run two commands
within this particular scope I'm gonna
have called get speaker face twice
exactly twice if you don't put the
exactly in it we'll just go I need to
have two I could have 202 but as long as
I got two we passed we're gonna have run
against Speaker beard once there and
we're gonna have run against speak
appeared once there and I could put
those down here doesn't matter this is
going to check the scope of that context
unless I add it there if I put it equals
true then it's only going to check
within the context of this particular it
block make sense
and if we run our tests we expected it
to be called twice but it was called
zero times excellent you notice that the
other ones are actually lying to us
because this test and this test was
checking the output of the command and
the output of the command we worried to
written the code for so we've already
written the code to give us a speaker
beard and the name and the URL of the
image that's all coming out with these
ones the start process to give us the
image URL is where we failed if we want
to write we win some code and fix the
test that's a look okay all right and
here's the code we've written
basically we've got a show image start
as a process grab as that image or our
lights of our JSON object and away we go
all of this was already written so
that's why those first three tests will
still passing there's something to keep
your head around always know what is
going to make your test fail as well as
what's going to make it pass if we want
it to rank our bits if we wanted to make
sure that the top beards and the bottom
beards were ranked in a certain way we
can grab the top one or the top five
expected to get a one we didn't get
anything we write some code we'll pass
that test where do we do this time this
time we just did account and I can't is
of the number of objects that we come
back we've named mocking we're now
calling get speaker faces mock 1 2 3 4 5
6 times now so we need to check that
we're grabbing those mocks every single
time everything screaming so now we've
written all of our tests to gather all
the information about these beards on
this page well we've written the tests
and the code to pass exactly what it is
that the focus group says that we should
do the requirements for our project a
business analyst has spent many many
hours and days building as an excel
sheet to make sure that we have all of
this information so that we can write
this particular piece of code so now
we're done now you just throw it away
hand it over great excellent
everything's groovy
you could fully test pass I'd argue
shipment because you haven't done some
other things first of those things is
you haven't made sure that your code is
following good practice do to practice
good practice defined by the PS Script
analyzer module which comes down and
Microsoft it is the way of making sure
that everything is as we should do so PS
use single announced it has been decided
by them the parish shell should only
have singular nouns which means that
when I connect to a sequel server and I
do get - sequel database I can get back
360 databases which annoys me but them's
the rules
everybody should follow those rules we
have a test visuals there's a lot of
other good rules in there as you can see
there's 50 rules there at the moment
there's going to be a lot more coming
through with with new partial core as
well and also as you can see I haven't
actually um passed for these since this
passes the PS Script analyzer rule
number one PS avoid using command
addresses do not use aliases encode that
you share with other people
remember this beard and imagine how
frustrated he was seven years ago
searching google for % parish l % parish
l % in double quotes parish l % of
single quotes parish l % parish l what
the % me % is it alias for where object
nope percent is an alias for for each
object question mark is an alias for
where object that one I might have got
but I drove myself absolutely 100% batty
trying to work out how to use my Google
foo to find what this meant please don't
use aliases in code that you share with
other people all the time use aliases on
the command line to save yourself from
typing things absolutely every single
time but remember write your code like
there's an axe-wielding psychopathic
maniac who knows where you live he's
going to be the guy in the job next
after you nobody's gone
hang on a minute where's the problem
here we don't really know we could just
see we're expected to get zero but we
got two not really telling is a great
lot we failed the test script analyzer
said of typing it on a high amenity
script analyzer you just do an invoke
script analyzer you pass it the path of
the script that you're analyzing and
it'll helpfully tell you much more
information about this you'll say avoid
using commander aliases so they were two
of them both the same a severity of
warnings it's not bad enough to really
break stuff but you should take notice
it's in this script
get Speaker beard doc ps1 so you can run
this against the whole folder if you
want to hi and it's on line 27 and line
36 and it says select is an alias of
select object don't use aliases because
the beard gets really cross bonnet well
that's where should so now if you're
using BS code you would already notice
that you've got a little green scaly
line under your select and your little
light bulb
and the light bulb comes along and says
yeah I do to replace you select the
select object fix everything
so hopefully use EVs code means you
don't you won't fall into that
particular trap but not every single one
of the BS code of the script analyzer
rules is going to be picked up by PS
code you don't even have to think about
testing writing your tests for analyzing
your partial scripts because somebody's
already done it for us
wasn't me somebody else did this and
I've just stolen it I've made use of it
and there it is one piece of context
code that you can just pick in and push
through to anything and I make use of
this I use a module called plaster so
whenever I create a new module when I'm
working I just invoke plaster it creates
me all the framework that I need
including all the tests the fake team
the ordinary tests all the commands I'm
gonna run one of those is the script
analyzer works if I can quickly run
those through without even thinking
about it don't even have to write any
you pretty much all right things for
other people yeah so you've written a
thing for another person or another
group of people and after a while
somebody comes back and says Sam the the
thing you wrote it's not working doesn't
do this got an arrow you get that yeah
so when they phoned me up and they say
Rob that module II wrote this function
gets speaker beard I'm getting this
error I say have you one get help get
speak a bit they say no I say okay maybe
I go well run get help get speak a bit
and then put it up the point is don't
create yourself as the support for your
own code especially with your PowerShell
code PowerShell has this brilliant
ability to grab the help for your code
and display it to the user and all they
have to do is type get -
I'm the name of the command so actually
make sure we've passed that test there's
a pest test that has been written for
this if we want to have a look at it
here it is genius to work for Microsoft
in the paschal team
if you've opened partial version 3 you
have read some of the words that she's
written because she was one of the
people that wrote the help for Parrish
show version three and four then she
went to work for sapien now she's
working for AWS and she is amazing
awesome lady and she's written this peso
test for us so now we don't even have to
think about whether we have created our
help in the right way we can just run
this test and make sure that
everything's there
I wrote eight modules for the place
where I'm currently working at the
moment
each one's got a couple of dozen
commands in I'm running this for every
single command I'm starting to get a lot
of green and some red and what happens
is you see this flash past Green Green
Green Green Green Green Green Green
Green Green Green gets the bottom it
says summary six thousand seven hundred
eighty two tests pass three failed
alright okay great
Oh scroll up scroll up scroll up all my
fingers gates or page up page up page up
page up bar exception now to memory
error ah so I know I failed to test site
of six thousand seven hundred and
whatever it was but I can't see any
information about me invoke pester has
got a parameter called
show which is not even being shown
got parameter called show and show is
merely the output of the tests results
to screen it's not the tests themselves
it is just the results that come to the
screen so we can run a test with a show
summary is running well we get is 92
passed in one file for most uses it but
it shows us what we can do if we do we
do failed up okay hey old it's pretty
good
get this example help them get to be
kabir to expected the value to not be
empty now if I've got eight modules and
I've got a hundred commands and maybe in
seven of those I've got something like
server names should be always in little
letters and it fails on one of them how
do I know which one it is
so I say don't you failed you failed
because what fails does is it gives you
the describe and the context and if
there is a failure it puts it in the
right place makes it much easier for you
to find out that everything is in the
right place this right I'll help files
we've passed our test oops
you've shown off our get lens you'll run
all of those tests expected value not to
be acting right okay it's obviously
because I didn't write the right bit of
code test ran everything passes the
other advantage to the show we said that
ran into point seven six seconds whereas
when we displayed all of the output
ekran' about twenty seconds so when you
are now doing more and more with this
and you're writing more and more tests
actually we don't care about what comes
out and screen we just want the results
the object we load on module that's
sorry load off function now we can make
sure that our users can help themselves
there we go get Speaker beard ranking
from the T variety website helpfully
tells us that hopefully tells us that if
we do a dash detailed we can get some
more information including all of the
examples always write as many examples
as you can with as many parameters and
many switches just to make sure that it
really gives you give your user all the
information so because we don't need to
show all of our information at the
results of our tests onto the screen but
we might want to make use of them we've
got an output file and an output format
so now we can take the results of our
test even though we're only going to
show the summary in the header and we
can put them into
file what about them
oh yeah salsa that's a really stupid yes
I hear I hear that I hear the PISA call
I am aware of the pizza call
it's just XML results of all of our
tests just XML you can see the name see
how long it took to run see the
successful result was a success we can
save them into a variable two more
things and then it's time for Pisa test
drive we might want to work with files
so we can make use of a test drive
variable which goes to an actual file
system somewhere in the attempt
directory which is created and destroyed
at the beginning of each scope so
describe context this test drive will be
created and destroyed enabling these
create files as and when you need to if
you need to with any type you know tests
without affecting anything outside and
in module scope
you can use in module scope within your
peso tests to put your mocks into that
module rather than into a completely
different your scope of your entire
script so you say only if I call this
mock from within this module that I'm
writing then call the mock if I call
this command from outside of this module
don't call it going you know get child
biting or whatever it is that we need to
do if you want to learn a lot about
pesto
get the agile delivered pesto book by
Adam Bertram and there's some details
Windows PowerShell a shell - please
don't use to throw it away
disable it three four five 5.1 those are
the ones that you're used to looking at
in the blue screen with the white
writing or in an ASE what we've been
seen pretty much all the way through
that's be partial 5.1 powershell six
partial core as you can see in vs code I
can just flip select safe like that
select my language mode will select
which language I want choose to have
parish or call six now you can get a
pre-release version of any modules on
the parish or gallery if you have the
latest parish old get package so in an
admin session you need to install module
partial get go to the partial gallery
gets new patch will get and that list
all it for you and then you can install
any module but pester particularly say
allow pre-release and once you do that
you can see that you've got partial
version 4.2 see we've got all of the
same functions that we had before still
got a context to describe an eight and a
shirt but one of the beautiful things
that we've got is
I expected the strings to be the same
because beards are awesome but they were
different so the expected the results of
the tests then the because whatever you
put in and then the result of the test
that you get so it means you can do
things like this one of these may not
work because my SMB protocol module
didn't load I expect his strings to be
the same but because we have failed to
bother to update the app and it only
works on XP they were different should
be running as robux PS Rob yeah great
and this actually worked
should have SMB 1 enabled expected true
because we don't care about the risk but
we got false obviously jokey made up
because us but hopefully you can see
that you can now begin to pick up why
these tests are failed
and give even more information document
your code even better as to why this
particularly has has failed in this way
Microsoft cognitive services does not
recognize that as a face so even though
I wrote my gets leak appeared it will
analyze all of these pictures to grab
the faces out and give me a beard score
for my picture gave me a beard score of
0 just wish quite fun greenies good
where is bad
before the break Green was good and red
was also good because it was about
writing our tests and making sure that
everything was as we expected this time
we're going to talk about validation of
your environment still the same person
still doing the same things still
available on Twitter at sequel DBA with
beard still have a website of sequel DBA
with up beard there's a reason for that
and that is that when I changed my
Twitter handle
I suddenly became sequel DBA with a bear
because Twitter's only got a 15
character minutes
so I stole that moniker and I make use
of it in fun and interesting ways but I
am sequel DBA with beard on Twitter and
all the other things still saying I'm
still an MVP still work with our assess
software and projects and all of this
community stuff that I love doing but I
hope I no longer have a drone no Joan no
no that drone that when I wrote this
crashed they just flew into a tree
it was probably absolutely fine until it
fell 40 meters down and then smashed on
the floor but it was okay but I do have
a new drone so today's list get up drink
coffee anime me the rest of the world
can happen yes I know this says drink
appropriately credits because somebody
complained that they don't drink coffee
so I embarrassed them by changing the
slide at the time and I will keep it
there won't I Karen and what I want you
to think about for the rest of this
session is how many checklists do you
have in your job in your work in your
team and think about ways that you can
use your checklists and turn them into
pesto tests okay so don't take what Rob
says here is all this is absolutely way
to do it take what Rob says here as here
are some things that I can use in my
environment as I can make working this
way so I bet we've all seen checklists
like this Incident Response checklists
things we should do when stuff goes
wrong at 3 o'clock in the morning which
normally a stuck on the share somewhere
that we can't find because we've
forgotten on login details to get to
that place with ago what am I supposed
to do release checklists making sure
everything is in place before we move
forward to release our next upgrade of
the amazing widget that we've built
all of the chains release
it'll management type checklists by the
first thing in the morning checklists
what about all of the things that you do
when you get into work to make sure
everything is as you expect it maybe you
want to make sure our build server is up
and running make sure there are no
failures in our unit test last night
when everything round through it one of
those things that we would like to do
water magically it's a good checklist
what about standing in front of about 30
people in Southampton wanting to make
sure everything works had absolutely as
you saw before the break my API II was
in a subscription that were run out of
credit but I knew about that because I
had run a pester test for my environment
so I knew that that was a problem and it
enabled me to try and fix it which I
then failed to do but then it breaks at
least I know that it's there by styling
in front of a client did a presentation
about in the new widget that we've just
built it's going to be amazing this is
the wrong version of the widget Oh nuts
I wish I check that before I stood in
front of them incident response morning
checks first lines of Paul everything
else that you're thinking of they're all
good stuff we know because we talked
about it earlier pester provides a
framework for running unit tests to
execute and validate parish shell
commands from within PowerShell great
that's brilliant
how is that helping us test stuff about
our environment validate parish shell
commands from within parish shop
whatever parish shell command I give to
pester I can test the output off
therefore they're a whole bundle of
things that I can test
we're going to bother talking about how
we look what pester looks like because
we've seen that listen this morning this
morning felt like this morning before
lunch before Peter I must apologize as
you may have noticed from before Peter
and since I am NOT somebody who likes to
give you powerpoint slides full of text
however sometimes you just have to give
people parish shell PowerShell slides
PowerPoint slides full of text these are
our stood up raters I am NOT going to
read through all of these I'm going to
let you read them you can see what they
are you understand what they mean these
are the should assertions that are
available to us within Pesta when this
was written a couple more come through
now oh yes the one you I will draw your
attention to is contained
what contain does not do is see if there
is a member of an array so you can't say
does this list of servers contain this
particular server with your content
contained check super file contains a
specific specified text that may catch
you out it still occasionally catches me
out so be aware of that but this is the
properties of a sequel server object a
sequel server agent object and a login
object that's all
so in PowerShell sre in sequel server
itself I can probably find another three
or four hundred properties that I can
check that's just in sequel server when
you think about Active Directory file
systems has you VMware hyper-v you start
adding all of those up and then you put
W my calls in there's pretty much
nothing in a computer type thing that
you can't
Pastorius we've seen works on pi over 6
that means you can check things on Mac
if you check things on UNIX all sorts of
stuff however there's one thing it can't
check if you're going to Stuttgart and
you're gonna do a parish else after day
and you take your nook and my nook have
got domain controller in about 13 sequel
server images on there and they can run
all of them at once means like a
show-off
look at these scripts run against all of
these different versions of sequel
server and clusters and availability
groups and all these wonderful things
however here is a peso test which shows
us how we can do a contain so we'll
describe our backpacking will have a
context scope of hardware a knit bag
should include beard nook so our bag
contents contains big nook that's just
parish up
that is going to resolve to true or
false so we NSA should be true we don't
need to say should be true yeah there's
an assumption around that we're gonna
get a shift we just put a ship we
wouldn't get a failure of our test but
will we put should be true because we
want everybody to understand what
happens so I failed that pest to test
because I couldn't actually run it and
when I got to my hotel room at about
11:00 p.m. and I got everything out to
Roma pest test to make sure everything
was working I didn't have my look at the
power supply had the switch had all the
network cables didn't have the look so I
rapidly had to rewrite my entire
presentation to make use of the fact oh
and you could only run about for
instance as a sequel on my box so some
of the things we can do is we can see if
things exist so we can check for example
our servers we say this server returns a
ping we're going to test connection for
a server name count of one with a quiet
area action silently continue we put
higher action silently continue in so
that our results of our tests are not
confused with a sea of blood red of
failed PowerShell maybe you want to
check our operating system it's just a
WI call so we know that our version
should be ten point zero point one six
point two nine nine it's easy for us
check one thing I cannot test that
little moon there apparently if you
change your registry key you can switch
that quiet hours on or off which means
it's just PowerShell I can connect to
the registry it just appears like a
drive to me but the registry key hack
that they gave doesn't work so that
literally is the only thing that I found
that I have not been able to test with
pesto apart from whether I took might
not be justified maybe we want to make
sure about a particular text well is in
place
maybe our folder with some things it
should have only a certain number of
files maybe the XE should be of a
certain version I'm gonna make sure when
we go in front of our clients show
brand-new widget that we're showing off
brand-new widget and not brand new
midget version - one maybe should say
that our file has been created on this
date we know that we did the
configuration file on the 18th of
November therefore that's when that
should have been created and it should
not be modified since that date I was
sat in an organization where a business
analyst had done some work and then he
came to the manager and the manager was
very cross and he came out the
technician he was extremely upset
because this process happened
hey client phoned up the service desk
and said the thing is broken okay
what's what's broken my saying blah blah
blah blah blah service desk man went or
woman went well I don't understand what
that means
um okay try a few things write it in the
call pass it to second might support
second life support when I'm really busy
I'll get to that in a while and it's sat
in the key for a week
for two weeks and then cycle I picked up
and they went find the client house try
this try that change the rich treat this
icon I'm not happening okay we'll try
that no I don't know what it is though
second loan went I've got 150 other
calls here I'll check it up just third
line third line were very busy they're
perusing the internet we were reading
read it and they were making sure the
nerf gun was in fact working so they
picked up this call right out of this
and they looked at the call and they
went oh for goodness sake they've
changed the company for what they should
have done he's given the call back to
the first line to pour the first line
support should have find the client and
set the client I'm sorry you will not
under support because you have altered
the configuration file as specified in
our contract of agreement with you
because third line support Mike try that
with first line support first line
support would find out the client client
will be really angry you've had this for
four weeks and you still haven't been
there now you're coming back saying that
this is ridiculous all right so what
third line support did is give the new
conflict I'll put it in the clients
place oh did I fixed quick clients happy
everybody's happy except for the manager
manager was completely happy because
there were no clients shouting at him
until the business analyst said I don't
know minute you're wasting all of this
time and resource for something that is
actually not under a license agreement
and you shouldn't be supporting in the
first place this is ridiculous oh how
could we do this that's how we did it
that wasn't even working on that project
and I went well you could just wipe s
test now what what what pest test file
should not be modified since this date
so we had a whole load of other stuff
than we needed to make sure was right we
gave that first month support first-line
support when they got a call would say
okay who'd you just download this run
this pester test tell me what it says I
come back so I was Green Green so next
he should be of this version is green
saying the file should have been created
in the state it's red it says the file
should not have been modified since this
date I'm very sorry sir
appears that somebody is altered the
configuration of your client if you
could reset it back to the original
configuration we can support you but as
it is in its current state I'm afraid
we're not able to support you suddenly
everybody's happy apart from maybe the
first-line support guys you have to have
that conversation with the client but
that's okay they'll grow they'll get
used to it
everybody's happy here is just one
example of a way that you can make use
of pesto to resolve an issue for your
customers for your clients for your
managers but now imagine that your
consultant and you walk into different
clients different times of the week
different weeks and you're pretty much
checking the same thing you know you're
checking where the sequel server is set
up as it should be
you're checking whether your as your
subscription is set up in the right way
Active Directory is created in the right
way whatever it is that you're
consulting about you're going in
checking the same sort of things with
different clients have different
environments so how do you path in
different things to these clients so
what you can do is make sure you're in
the white over yes good load ourselves a
function and if we look at this
particular not that particular
function if we look at this particular
function
you see got some good help some good
descriptions because I do not want to be
the person who looks at and mike koval
it'll be the support just want to be the
guy that writes it some examples be some
examples to make sure people know how to
use the thing that we've written for
them and what this code is going to do
you see there's a lot of it got some
parameters loads of parameters we're
gonna press in parameters are plenty
into this piece of code for each server
in servers skip equals trip remember
that I'll be useful in it what we're
gonna do is going to do a test
connection make sure the server is
online we're going to do a test WS man
make sure we've got some PS remoting
capabilities and then we're going to
create ourselves a script block which is
going to make you solve the line thank
you a return object a PS custom object
just defined like that this is a custom
object with nothing in it I mean in that
object for save a backup directory we're
gonna put in the results of the backup
directory querying our sequel server
we're gonna go through we're going to
make sure things are enabled and the
frequency in the start times are all as
they well what what they are place them
into this object just with some Parishad
because it's PowerShell we can create
anything we like I'll at the bottom
we're gonna invoke ourselves a script
lock go to our remote server run this
script return me the object now that
we've got our objects we can go through
and say pick that one the full system
database backup should be scheduled so
our return object all s this full
schedule should be true the full system
database backup should be scheduled with
this frequency which is a variable that
we've passed into our function so this
value should be the same as the value
we've passed in so anything that we
might change but we can still gather in
the same thing maybe how often we take
our backups maybe it's who are the
members of the administrators on the
local machine but all sorts of different
things that you can imagine you might
want to parameterize because you're
going to different places to save us
having to put all of these parameters in
one long line try and change them we
splat them out into a nice column we can
change anything we want to if our system
full frequency job runs weekly we can
just change that to weekly and then run
the rest of the command
good work and what you're seeing there
is not greenies good already's bad we're
seeing yellow is skipped because pesto
is just PowerShell so if we have some
logic that we want to define we can skip
our tests that's we need to because as
we've already discussed I don't have a
look with me I didn't actually bring it
I deliberately didn't do it okay but I
have no remote machines to run commands
on so I've just skipped them all so you
can see what would happen but you can
imagine that I can quickly run all of
those tests if I wanted to go to a
different environment and run them I
could just change the parameters run the
same piece of code I don't have to worry
about it it's already been done what
about the other way round of thinking
about it what about if all of you wanted
to write some para shells and pesto
tests and you all wanted to do different
things or maybe your values for
production are different from the values
from UAT the difference of Farley's to
dev difference of values of QA or SAT or
sut or all the other acronyms that we
give to test environments that we want
to create another one just because we
think there's something else we want to
test before we test up by five my word
invoke pesto will run all of the files
that end up test stock ps1 that are in a
folder by adding a tag of backup we have
only run the backup commands if we look
in our folder we can see we've got one
file with top tests got ps1 inside that
file we've got a describe block which
has a tag now got a tag of backup so
even though he's like pesto ran all of
this code it only ran the tests with a
tag of
so you can write first line second line
third line prod UAT Active Directory DNS
whatever tests with a tag put them in
the same place source control them
anybody can run them with the tag it's
just one way of using it I'd show you
some more but I don't have much time
maybe you want to make use of some
configuration I just used some Jason I
pick a tag Teddy B I picked some values
that I could change and a skip as and
when I need to and I can skip various
tests if I need to do so enables me to
write different Jason for different
environments and we could just call them
with a command but I want to show you
this because this is cool so I needed to
check that every server in the estate
there are about 250 had all of those
particular jobs and each job had been
enabled and scheduled and had run and
had succeeded and that each of those
jobs had created a backup share for each
server and inside that folder there
should be a folder for each database
inside the folder for each database this
should be a full Adair for the log
folder inside the full folder there
should be a doctor within less than
seven days old
within the diff folder should be a
doctor in file less than one day old
inside the log folder there should be a
doctor in file less than thirty minutes
old apart from all of the databases that
were in simple mode and the ones that
were in log shipping and the
availability groups would be in a
different folder so you can imagine that
was going to take me a fair amount of
time to do for 200 instances and however
many thousand databases it was check all
of those files existed so it's parish up
I just need to work out that logic it
took me an hour or so a right to pass
the test
and that meant that what I can do is run
tests on instance which is the function
that I wrote against these three
particular instances the moment with a
value of the share of the backer then I
can grab all of this come back ok there
we go we're now checking that who has
files in the full folder and that the
lock folder for world while the
importance has files in it but it was
written to within the last 30 minutes it
expected 30 minutes ago
to be greater than the file that was in
there and because this is just
powershell and we get our results as an
object we could turn them just into a
JSON object and because it's Jason we
can create ourselves something beautiful
and if you go to my blog you'll find a
power bi desktop file that will take any
pester results if you format them in the
right way some of them might not display
quite as you want them to but in general
they're going to look as cool as this
so we can see 507 tests 43 seconds arrow
test for good run we can click into our
tests because we're not online we're not
going to get all the values in there or
maybe any managers in the room okay and
if you just close your ears the next
five minutes sir please we all know what
management like pretty pictures chilli
pretty pictures that are interactive and
stuff changes as they click on them yes
and you can give them all of this and
they will click on it and they might
actually forget the fact or forget to
ask why are 8% of these rate because
they're so impressed with this because
you've created this amazing thing and it
is beautiful and it is useful and
enables you to maneuver this data around
however you want that is one of the
beauties of PowerShell that it enables
you to go within a whole environment
whether it's Windows Mac Linux sequel -
your VMware hyper-v test all of the
things that you need to test turn them
into an object which you could use in
your CI CD build process you can put
those XML results in to VST yes for
example to give it the test results or
you can create some beautiful power bi
that means that you manager doesn't
actually hassle you for why things are
wrong okay monitor you come back of
course this is all really useful as we
explained for all of our managers
you've all got checklists don't do
things manually if you can avoid it
bestories unit testing framework but you
can use it to validate anything you can
gather with Perisher describe context it
don't forget to put the curly braces on
the same line I bet you put them on a
different line just to see the error
message
should test your assertions you can
output to any XML for CI CD you can
output to an object because the parish
all you can do anything you like with it
but I think the best way is try to put
it to Jason and turn it into phobia
might be robbed you've been amazing
thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>