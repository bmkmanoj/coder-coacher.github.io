<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>End to End Testing Single Page Apps &amp; APIs with Cucumber.js and Puppeteer - LNUG - April 2018 | Coder Coacher - Coaching Coders</title><meta content="End to End Testing Single Page Apps &amp; APIs with Cucumber.js and Puppeteer - LNUG - April 2018 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Pusher/">Pusher</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>End to End Testing Single Page Apps &amp; APIs with Cucumber.js and Puppeteer - LNUG - April 2018</b></h2><h5 class="post__date">2018-05-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Wapb_LIS45E" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so in sync page reps are a really
popular approach in terms of building
applications you have one API it can
serve a web app it can serve a mobile
app it can serve a third party API it's
kind of the dream but the route see is
that tesam is not really simple because
there's all these different components
that you've got to get to test for an
internet and test strategy you need the
single page app needs the API that
serves the single page app you need the
databases that serve the API and you
need the data in the databases for
testing so an entering testing strategy
needs to handle loading all of those
components at the same time it needs to
coordinate the setup and the teardown of
the application state across the
components for the tests and it needs to
be flexible enough to accommodate for
changes are going to happen to
components over time this is one of the
JavaScript fatigue images that I plucked
off the internet and as as anyone does
anyone recognize this one what's this
one backbone it's ancient
we've all done backbone in a previous
life and required us to and they're all
dead well they're still alive somewhere
but anyway the point is I want to talk
about a testing strategy and there are
many different testing strategies it's
like you know there's many ways to make
an egg well unless you're a vegan but
there's many different ways to approach
this so strategy I had was two key
technologies cucum jeaious and google
chrome's puppeteer so i'm going to talk
about cucumber here-here's use cucumber
cool so has quite a few of you that have
used it so I'm gonna give a quick
run-through not cover every single thing
just a kind of what it does so it's a
behavior driven development tool that
allows you to describe and applications
features in an English language and then
get that to power automated tests the
description of the applications features
run the tests and it becomes a safety
net to catch bugs and prevent
regressions and it also provides living
documentation on how the app works to
people that aren't developers who can
read it and understand it and that's a
key important feature of cucumber
developers they come and they go from
projects and companies
and you really want something that
someone can read it and go I'm not I can
read the code but I'd rather just try
and get sense of what it's doing
elsewhere and that's what this
documentation provides so cucumber is
some steps step one installing it you
can install it just like that past the
capitalize D is a development dependency
step 2
create a folder in your app called
features and we will put cucumber
related features files and folders in
there here and then step 3 meet with
your product owner and talk about
feature you want to implement and then
you know talk about that perspective of
the user using the feature what would
they do how would they interact with the
application and write down some notes or
put it on a whiteboard whatever process
works for you and then once you've got
those notes you want to turn it into a
feature file so say we've got a feature
called delete user dot feature what you
have here is you give the name the
feature you describe a big business
frame that's going to accommodate who
you are that's doing this and what you
want to do as an action and then in the
scenario you then list out all the
different steps in a given when then
format which is for gherkin syntax
pausing so here's a good example that's
quite pertinent gdpr
is exactly one month from now so imagine
you've got a scenario where you've got
to implement deleting a user's data for
a data compliance officer you might
describe it as this and you sort of try
and describe it in as much English
language as possible you really don't
want to computerize it too much you want
to make sure that this is something that
they engage with they understand and it
makes sense and then step 5 once we have
a feature file like that and we've saved
it in the features folder you can just
run npx cucumber jeaious run and save
running no modules being cucumber da da
da you can just do that and what it will
do is it will scan for files and
features folder that have a dot feature
extension it will execute them and then
it will print out results what it will
do is it will go step by step by step
through your scenarios trying to find
out what the English language is it will
then scan your step definition files to
see if it matches
with this particular one given I'm an
admin if it doesn't what it will do is
will say I couldn't find it here's some
code stick it in a particular file in
the features folder and I'll be able to
pick that up I don't know if you're
testing a web app or even an API free
cucumber all I know is that you've
written this line saying I am an admin
and you might want to you know set up
some data in the database for example
and then what you can do is you can also
put quotes in the text and it will
actually parse them out and turn them
into variables and also deal with
numbers too so here's an example the
user should no longer have any data in
the system the user quite sam is then
this string here and the idea with that
is that we can then put references in
our cucumber feature files that we can
then pluck out and pass down into the
JavaScript here step 6
Kress step definitions folder inside the
features folder you then create a common
steps yes as an example I put in step
definitions and then that JavaScript
that you saw earlier just slot it in
there and cucumber automatically pick it
up and then you can start to write code
for your step definitions that does
things like you know clicking a button
in a web app checking that the user is
logged in querying the database making
sure that there's a user in the system
for example and then you go through red
green for refactoring so at first
everything's going to fail because you
don't bring the application code and
then you write the application code and
then it passes and then you've got your
safety net and now you can change it you
can do refactoring you have that as an
option now I'm gonna talk about
puppeteer top tier is a know Jeff's
library that provides a high level API
for controlling Google Chrome or in the
case of Linux chromium by the dev tools
protocol it can run the web browser in
either full mode with application
browser windows popping up in front of
your face or in headless mode if you're
running it on a server so there's no
browser windows rendered and you won't
need to pass any of the funny Linux sort
of xcf don't run a graphical user
environment to render windows at all
it's it just works seamlessly
you can use this to do all sorts of
things you can use it to take
screenshots of web sites
you can create PDF files from webpages
is much better than wk HTML to PDF for
doing that you can crawl a single page
app and generate pre-rendered content
maybe you're trying to build a ticket
search engine and you notice that
Ticketmaster and Vargo go also put all
their listings about JavaScript rather
than in the actual HTML because they're
stopping people like yourselves that's
one strategy you can have to work around
that you can power web spiders that fill
in forms automatically and you can get a
timeline trace of a website loading you
know when you're looking dev tools and
chrome and your sort analyzing your site
you can pull that data through puppeteer
and automate the process which is really
really cool so anyway you can install it
just like this NPM ID puppeteer
what it will do is it will download
google chrome or chromium and it will
download a version that works with the
library and works on your operating
system as well it's clever enough to
know those details so then it's a much
simpler experience and if you try and
set up selenium where you've got to have
the right version of Java you're gonna
have the jar file you've got to tell the
library that's connecting selenium to
your browser where everything lives this
is just much simpler so here's a quick
sample
you've got pops here required puppeteer
you say in async/await mode you go away
puppeteer dot launch which boots it up
page weight browser dot new page loads
up a new page and then you can say go to
this URL and then take a screenshot and
save it example dot PNG and then close
I'm done and that's a nice simple
example that's literally gone to a
website taking a screenshot and then
shut itself down but you can use it as
part of your testing strategy and it can
be used inside integration services like
circle CI I haven't tried Travis yet so
I can't guarantee whether it works or
not might do but you can even use it in
name AWS lambda functions anywhere so
lambda functions have like a 50 mega m't
it turns out you can build an image with
docker
with properties of dependencies that it
needs and then you can serve that to
lambda which is really really cool
so making cucumber juice and puppeteer
work together the way I see it it's
quite ironic that puppet is called
puppeteer because in this case the way I
used it was more like
this cucumber is actually going to
control puppeteer it's going to handle
telling it what to do so properties that
have been puppet masters anyway so
puppeteer is loaded into cucumbers well
Jess file which is a file which contains
a global context that's passed to all
the step definition files and then that
lives inside the features folder and it
gets all loaded automatically when you
run a cucumber so here's an example here
of the world yes file that I'm useful an
app so the bit of interest here
puppeteer is required here I basically
just put it here and then that driver is
accessible in my step definition files
so I don't have to try and require it in
my common steps in different places it's
just there and I have a few other things
going on there which I will talk about a
bit later and then here is where
cucumber does some other stuff to make
sure that the world gets injected into
step definitions so how do we do the
setup and teardown we're both the single
page wrap in the API which is an
interesting question because you've got
to combine them so the case example here
is the dashboard app I built many years
ago and I'm now reinventing from scratch
called - key first version was built
back in 2012 as a real-time web app with
a framework called socket stream which I
no longer maintain the new version is
being built as a single page app and an
API react on the front-end
Express Mongo Redis on the backend and
this time I wanted to use develop it
with behavior driven development from
scratch so you got the backhand repo
this is API the front-end repos
- cute web so then I decided what I'm
gonna do is I'm gonna put the tests in a
separate repo called - queue integration
and then what I was going to do was have
the database API data here front-end web
app here you come tested puppeteer here
at the top all nicely contained in sort
of their own domain and what I then
realized is well if I'm going to do this
I've got to find a way to get this to
happen where the API on the web can be
accessed by the - go integration
repository and to do that there's a
number of options
you can consider you could go down the
river get sub-modules you could go down
the route of docker compose with docker
images but the strategy that I found
that worked was NPM so it turns out NPM
is not just a package manager you can
use it to stitch together a couple of
dependencies in order to achieve a large
goal you can coordinator setup and
teardown between those components and
I'm going to show you the package.json
for the - to integration repo so there's
a lot here to digest but I'm just going
to bring your attention to this bit here
there's like four dependencies in the
entire integration test suite cucumber
pop tier and then the API and the web
which are private repos and the beauty
of this is I'm requirements known
modules and because I'm doing that it
means that I can actually point local
copies of the webinar repos to my local
machine with NPM link and that means
that I don't have to have a scenario
where I can't test a certain component I
can have all those components loaded in
one place so now when I create a new
product feature I can write the tests in
cucumber I can then implement the
feature in the single page app and then
implement it in the API when I need to
drop down to that level and then when I
need to run the tests I call I can
coordinate the setup of all of those
things in one place and just to show you
what I mean by that so here in that same
package JSON file there's a script
section so when I want to run the cucum
tests before I do that I have this step
called pretest and pretest we'll use NPM
Explorer command to go down into my web
repo and say can you run NPM run build
but also run it with the node em set to
test so you load the test configuration
and then it goes and does that so my
local copies got it built pointing to
the test API and what that endpoint is
test then run and then after I do that
post test I just pretty much run the
same command as pretest I just don't
have no data because test I say no
development I just want to get back to
how it was so I could just continue
coding and that's really nice I've just
orchestrated a couple of things running
together there and then so how does
cucumber start up the webinar repos
while I use indexed Oh Jess in both of
the repos and they contain all the
loading up code so here's an example for
the front end it's really simple as just
Express which is wrapped by HTTP
shutdown which allows me to then close
it programmatically after I finished
it's just literally serving up a static
folder and then it's setting a host
which I need to reference in the
cucumber steps to be able to work out
what your are need to load in pop tier
and then exporting the server again the
API repo a little bit more but similar
approach Express HTTP shutdown wrapping
it and then again an endpoint to point
to for cucumber to pickup and then I
load these in the world Jess file from
earlier so if you look up here if you
look up here at the very top constant
API constant web those are actually
loading them programmatically I don't
need to do anything more that's it they
just handle themselves and then when I
don't need to do anything with them to
access anymore I can scope them here and
later and we'll see an example of me
shutting down later it's a management
data in the databases - who uses MongoDB
and Mongoose but I am considering
PostgreSQL with a ORM called objection -
which is node async/await compliant and
has a fantastic graph QL plug-in you can
literally add a whole graph Q FBI in
about three or four lines of code it's
really really good but remember as I
said before whatever you doing in terms
of n to n tests you need to be able to
handle changes to those components over
time so I might be crazy enough to think
of rewriting the database part but
hopefully the test suites there to catch
me and tell me how I'm not so him but
anyway so I was looking at this and
going ok so - the integration needs to
talk to the API needs to put data into
the database in some way how do I do it
and the way I figured it out was well
I'm already doing it with the node
modules in the hoaxers file which gets
automatically loaded by cucumber there's
a bit of code here and a very top so
here I'm actually able to just go
require API for slash models
all the mungus models are there I'm not
having to have Mongoose knowledge living
somewhere else that reference the config
or anything that it's all just in one
place it's all there in the API so just
load it up Natalie nice when I need to
do some cleanup before any tests run so
that everything's in a nice clean State
I just caught async/await
user remove now I might be able to run
those in parallel that's one
optimization I can make and then
afterwards I did actually notice that
I've got a bit of space up there before
Mongoose but I will correct that
afterwards anyway so nitpicking so and
then also AB interest just on a side
note afterwards scoped up browser was
puppeteer in puppeteer I'm like setting
a current page context if there's any
cookies I'm gonna wipe them because I
want it to be like fresh page I'm not
closing the browser down I'm just
literally saying we're gonna wipe your
browser's memory so it's still up and
launched I don't have to shut it down
and launch it again I can just open up a
new browser window and it'll be like hey
I'm new and that's how it works and then
here is where hey should be shut down
allows me to go scope the API or shut
down so this is gonna shut down web shut
down shut down disconnect Mongoose and
Redis so that there's no more process
listeners and that way cucumber exits
nicely and is like yeah everything's
turned off I'm good to shutdown
so that's Jeff's file in terms of
seeding data the way that happens is
part of the cucumber feature scenarios
so here's an example where a given a bad
user pub Jason already exists it matches
this step definition and then what I
actually do is I put my step definition
code into little functions the reason I
do that is because then it's really nice
and clean to just write a couple of
lines code here which later on I can
repurpose in other ways and to give an
example just to show you this is my step
definitions file and it's all just
little functions that are automatically
readable right next to the actual step
lines from cucumbers sort of saying how
you need this and I just have it here
and it's really nice and simple to read
and that's really nice the other benefit
is that you can use nodes async/await to
combine step definitions for a single
step so the reason for doing this is say
you've got
a cucumber scenarios login with an email
address there's about there's eight
steps there but there's seven that I'm
interested in from the second line down
and if you are doing any sort of testing
you wanted to test from the very start
each of those steps has its own
dedicated step function if I wanted to
repurpose that in every scenario you've
got to repeat those seven lines every
single snare and that just gets really
really verbose I would say that and make
those feature files cumbersome I've got
a panda at work for this very reason I
just have a bad habit but anyway instead
what we can do is we can dry up our
cucumber scenarios so what we can do is
we can use async/await
to basically combine them so here you've
got these seven particular steps to log
in as a user what I can do is I can just
go and I log in and I just leave it at
that it's kind of a assumes that I'm
logging in as person and then what I do
is and I log in looks at this particular
step definition here and here is a
combination about seven different
actions that are all cute together
through they sink away and they will run
and they do the whole login process and
I've just been able to express that in
one line in the queue can fall if you
actually notice the pattern here a visit
homepage coconut and go to page it
marries with what's actually happening
there in the top three or four lines of
the cucumber future scenario it's
literally just a mirror copy but because
of that I can just express it as one
line and that makes the cucumber feature
files less verbose that's the best way
to keep everyone engaging with them as
they start to write them and test the
app and then people have to read them
and say okay this still makes sense so
anyway in terms of selecting elements
and page to click fill in and check that
there you can use CSS selectors and
puppeteer to do that I have a nice large
list of CSS selectors I'll show you in a
bit
which is just nesting an object tree in
terms of XPath support puppeteer doesn't
have it just yet but they're actually
introducing it in the next release which
is just three weeks away which is great
because it means you get to do some more
powerful
elections where you can actually look at
an element so I want to select based on
fact there's got some inline text saying
a particular phrase which is much better
than I have to remember what CSS
selector it was and here's an example
here so the selectors is a big object
versus selectors links dot signup or
close your account and I basically have
all these letters that brittle but will
correct later that's going to be my
programming in five words tweet later on
after this or just realize but basically
this is how I'm currently getting the
CSS selectors to marry with the cucumber
features for the step definitions here's
an example so I pick out the current
page scope context current page click
selectors links link link is passed
through and that's where I kind of get
it all to glue together so just to give
you a quick demo I'm going to quickly
get out of this and I'm going to just
show you this running live in action so
it's going to take a few seconds to do
build I should have probably got it just
to skip anyone had that pre run but it
will take a few seconds whilst we can
all contemplate the meaning of life and
everything else and then once it gets up
there
in fact I'll just make it a bit in fact
what I can do is I can move this here
and there we go boom and there it is and
if you can see there there's chrome just
firing away testing all these scenarios
and it's actually telling me it's you
can see that little notification the top
chrome is being controlled by automated
test software those tests are running
here on this side and this is all just
automatic this is the front-end app it's
hitting an API it's all in one place I
don't have to hit anything else and it
can all just run and it will run for the
next couple of minutes I'm just going to
leave it running and we'll see at the
end but yeah so go to quick demo there
is a circle see our recipe for any of
you who were wanting to use puppeteer in
your test environment and happen to be
using circle CI I have published it it's
online here if you search for an FNX
puppeteer soap recipe circle CI recipe
even it's there and that will work it's
not completely optimal I'd like to get
it into a little docker image but
it's there and it's available for you to
use from today it's public Kyle tweet
about it later in terms of testing
browsers other than Google Chrome if you
are wanting to do that so you're using a
public site and you need to support
multiple browsers
my recommendation is continue using
selenium or you look at webdriver - IO
and place at puppeteer because puppeteer
is purely for Google Chrome and if
you're using cucumber to test things
other than single page apps and API is
like maybe desktop apps you can do that
it's really really versatile so give me
an example you can test electron apps
github have a library called spectrum
which is electron testing framework it
will actually boot up your electron app
so you can write tests and run them and
do that and if you want to learn more
about it
there is a chapter on it in my book
that's my little plug in there we and
the book is actually also a Mandarin
Chinese thanks to a guy called Gaudi
Zhao who's a spend a couple of months
translating it into Mandarin my name is
Paul Jensen you can find me as public
Jensen on Twitter or on github it's the
same spelling and that's it thank you
very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>