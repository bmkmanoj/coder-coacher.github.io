<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>My Node.js Process is on Fire - LNUG - March 2018 | Coder Coacher - Coaching Coders</title><meta content="My Node.js Process is on Fire - LNUG - March 2018 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Pusher/">Pusher</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>My Node.js Process is on Fire - LNUG - March 2018</b></h2><h5 class="post__date">2018-04-09</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ZWnMnwudPGU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">everyone so I mean in London I'm not I
don't live here
passed by for the week I just said to my
colleague Anna hey it may be a maid come
to do a talk I've been coming on and off
London but I've never been here on the
last on on the last week on the last
Wednesday
on the first Wednesday of a month never
like it never happened
it was it has been crazy so this time it
happened so I had to submit a talk and
SP so this is my Twitter at matok Alina
tweet something make questions Italy or
not or whatever so I'm going to talk
about some some interesting stuff right
now typically wear a hoodie by the way
like this is whatever I'm going every
with a client so I typically wear a
hoodie and the t-shirts be okay so some
of you working out some of you are
couriers but it happens to everybody
that you got cold at some point Sunday
morning at 7:00 a.m. okay because
something went bad on some servers
somebody's laughing okay and and we
didn't have a really nice time about it
like I don't know it's happened to me
several times everybody okay it's
everybody has been on call or the team
was small enough that there was nobody
really on call and everybody was on call
I don't know what typically happens if
if you are in this situation and you
receive an alarm it's because you did
something wrong okay and that's very
normal that's very that's very typical
and you get this alarm and typically
goes around with the second alarm like
you get the maximum number of servers
like this this application is slowing
down you have 10 or 20 servers running
on AWS your elastic load balancers our
reach your limits and the board is
burning and your managers calls you
shouting at you on your phone get that
thing on line please okay
so typically what every
does at this point is they do they what
they call the poor man fix what does the
poor man does
it's also called a windows person it
basically you know it reboot the server
throw more hardware at it and it's done
there's been a very nice joke it's not
crashing anymore by the way like didn't
happen for a long time I also have a
Windows machine so I need to test some
stuff from time to time of Windows and
now everything he's come again and you
can go on back and relax
fun story it it happened a similar
situation to me some years ago when a
lightning struck the Dublin data center
of AWS and I had to rebuild some server
on the 15 or Foe boost and they was on
vacation it was not a good experience
overall anyway this is a calm situation
everything is fine
as far again so back on Monday what you
do while you're looking at what the
problem was because you know you don't
want to be really notified in the
morning okay of of a Sunday or whatever
you don't we don't really like to work
in a panic situation in a stressful
situation we like our things to run
smoothly and not be bothered like we are
lazy developers right so we need to look
at what happened
this is a typical very hard problem
because some of the production problems
are really hard to replicate okay are
really hard my player runs fine on my
machine right so why doesn't run on my
servers that's a typical you know if it
runs my machine if you compile it I
don't so and after we understand what
happened we need to look at how to fix
this problem so first of all we need to
gather some diagnostics and evidence so
wait a second the problem happened the
day before so how can we gather data and
evidence now typically a lot of prefer a
lot of production deployment should
include what is called application
performance monitoring solution which is
dubbed APM by
everybody and which basically what it
does is basically collect some metrics
and that's on tracing and mines or some
errors and it can tell you more or less
what went wrong typically you can see
that database over there at this nice
query that you forgot to optimize
somebody on the team said nah nobody I'm
not going to optimize that stuff it's
just you know nobody's going to eat at
that end point and then that end point
brought everybody down
very typical another very typical
situation so once we have gathered the
data and evidence and we know that that
endpoint is what brought us down we
start reproducing we need to reproduce
the problem in a non-production live
environment what does it mean you need
to have a separate environment deployed
on AWS as your Google Cloud your
raspberry pi on your basement I don't
know some data center somewhere in the
world which need by biometric the retina
scans to enter you decide okay you need
to have another way to reproduce the
problem in an environment is likely a
similar s production that you usually
use and after you've done that you can
gather some more some more data and
evidence and you can pinpoint the
problem and to reproduce it in a very
synthetic way so something that you can
run on your machine because coding on
servers and trying to fix life problems
on servers is very very hard don't try
to do it okay please raise your hand how
many did they symbol in the past perfect
okay I'm super culprit of all of this
okay like super super anyway the right
approach is reproduce the problem in a
synthetic way so something you can work
on on your machine if you can reproduce
it on your machine you would be super
slow in fixing the actual problem so if
you fix the ectoderm if it takes food
and if it takes like a week to fix the
problem it's probably too late and then
we try a fix we finally got to coding he
took a long way and then if not fixed go
back again because you know
nobody gets it at the first try so so
this is a nice diagram okay
I took me two hours to do this please
appreciate my art please okay so you
have a deal we have our performance
issue and then we diagnosis we do some
we get some Diagnostics from the
production environment which is
typically coarse-grained and also
polluted so what I mean by polluted is
it means that a lot of data from a lot
of other end points and sources and it's
not it's noisy so it's very hard to
understand exactly what's going on maybe
I got a hunch but it's not perfect
so from there I need to try all the
different roads and I can reproduce it
on a no live environment these are very
hard step as well then I get some more
clean diagnostics and then I will
finally able to write it on my machine
and then more data and then walk the dog
that's what the typical solution for no
J yes I am a dog I walk the dog to fix
performance problems somebody else can
like staring at the screen for a long
time before having the dog I used to do
that long time it's very hard because
not Jes is exploded and all the tooling
for gathering data and interpreting the
data is not really easy to use big
disclaimer I have been the guy staring
at the screen and walking the dog for
some companies around the world trying
to fix their problems okay so I know a
thing or two about this step so fixing
performance issues it's games about a
very simple process that question mark
okay first of all you to establish what
I call a measurable goal okay so given a
situation you want to know exactly what
what is your target and then you measure
and if there should be a gap between the
two so if we want to improve if you
don't wave inish maybe not I had a
problem so so you have a measurable goal
you measure you find what is called the
bottleneck which is what is
preventing your application to reach
your goal and you optimize and fix the
problem you measure again whoop sorry I
didn't mean to do that
the establishing a measurable a
measurable goal is the most important
step most people forget about it okay
because improving the performance of
some code is a never-ending process it's
a complete rabbit hole you can go down
deep in trying to optimize node and be
there three years later keep doing the
same thing because there is no hand to
it okay if you don't establish a
measurable goal and you loop into the
process you'll never exit so you need to
always establish a goal to what you want
to reach so how do you establish a
measurable goal I don't know you can
throw something like this randomly taken
from the web you know you want to apply
it under 200 milliseconds for 100
concurrent requests 99% of the cases
something like that okay it can be even
two seconds for your application it's
not me 200 okay it can be 20 by the way
okay no Jess can go as fast as you want
depending on your business logic you
need to remember one important thing
when developing new NGS application the
latency and throughput are always
connected to each other mainly because
no GS at one single track so if it's
processing something is not touching
something else
and it's true that you runs multiple i/o
access in parallel but when one of those
queries gets delayed so if one query
gets super delayed for whatever reason
because it loves an index okay so the
database gets in trouble and then some
queries get delayed or takes like I
don't know half a second or a second to
reply
we typically that means to increase
concurrency so we have more queries
running in parallel which means that we
have more memory usage because we have
more in-flight data so the number of
requests that are flying in parallel in
my code are
there is just more data because instead
of having like a hundred now I have 200
or 300 running things running in
parallel I have a hundred concurrent
requests coming in okay which increase
memory usage which increasing memory
usage will gather which will have an
increase in garbage collection activity
so because you have more memory you are
allocating more memory so your garbage
collection is going to be have more work
to do and more work to do
means more CPU that I'm going to run
with more CPU I would have work I need
more small city power to run my code so
all of these variables are all connected
to each other so if if you just from
time to time a problem related to slow
IO can show up as memory leakage
situation where your application goes by
balloon to two gigabytes of memory but
in fact it's just i io issue from your
database so it's very hard to understand
exactly what's going on because all of
these things are connected between each
other
so going back to the two what I call
being benchmarking driven development
establish measure a Google measure find
the bottleneck optimize fix measure and
thin now it's not really a very good way
of a very good acronym but here is my
try yeah so measure so how do we measure
a couple of years ago I brought this
little thing called called autocannon
after cannon it is an HTTP 1.1 load
pester written in JavaScript so in node
you can use it to load do load testing
into - against your web applications
it's nice because it is written in
JavaScript so it can be fully scripted
in JavaScript so you can configure which
type of request you want to send you can
send multiple requests at the same time
and so on and so forth
it's really simple to use it's also
really fast which uses its own HTTP
parser actually team casual but whatever
it was a very
fast HTTP parser this is nothing one in
core and it has a non complete version
HTTP implementation which is very fast
because we about to do a lot of things
because just we need we just need to eat
hand points a lot so we can we can cheat
a couple of couple of code we could cut
a couple of corners that nodejs cannot
do you can check it out it's very easy
to use no or it also have some windows
which is you know it's as I said it's I
started saying windows so I keep saying
windows and it's always hard to start
those type of things on windows so you
can also run it on Windows it runs very
well npm install of the channel or even
NP x autocannon and it just run so very
nice how do you use it while you start
your server then you eat autocannon
there's a nice progress bar and then it
please some latency and whatever it uses
a very fast data structure to collect
this data called HDR instagram it's
really handy to use that if you want a
if you need to compute statistics data
and so on it has a one inserting time
insertion time on the on the structure
which is very useful and is fairly new
and not really most people know about it
so i'm worth talking about it play
asking look at autocannon dependency you
will find it so well we have established
our goal we have been measuring and then
we need to find the bottleneck
it's time' for it's good time for
diagnostics diagnostics is one of the
hot topic for node.js for 2018 we have
been with others on the TSC and the
diagnostic working group at a nice
summit in ottawa in February was super
cold okay discussing on how to improve
the situation
okay as you probably if you have run not
just in production you probably know
that you might be lacking some of the
instruments that you have been using
some of the tools that you have been
using in previous increase platforms so
this is what we have been developing at
Mir firms called node clinics it's open
source you can try it it's Apache - so
whatever - whatever
with it so let's let me BMO let me do
this
oh yeah so not Clinic you stole it npm
install node clinic - gee it is it has
it says several comments one is the
optional another one is flame and there
are more tools to come so we keep
working and extending this product to
add more stuff to it so first of all
clinic doctor so you doc doctor enables
you to die to self diagnose your
application and know what to do next you
run like this
so clinic doctor - - node server you
need to pass the node executable so you
can test it with node master if you want
to okay or you can test with different
versions of node and whatever you want
so wait I wasn't going to run demon ow
so here we go I have some some demos
here so clinic examples okay and I've
run this a lot so what we can do is
clinic doctor - - on port this is a new
flag that we have added so that you down
so that we can run out of ten on
automatically for you so on port
autocannon does see 100 hundred
concurrent connection the five four five
seconds to lock a lost at port so we get
a nice environment variable so nodes low
Evan look index this is an example with
the slow event loop application okay now
I am on battery on a MacBook 12-inch
attached to a projector so whatever I'm
doing demo girls might not be with me
this is very obligation after you have
run it analyzes the data and it prints
it out here we go so this is the this is
doctor we have a bunch of things very
interesting stuff we might have the CPU
usage the memory usage the event loop
delays you see ghost balloon and the
number of active angles the number of
active endles is very useful to
understand the number of concurrent
connection you are having the number of
fan dots so what is unhandled in in node
terms a handle is average low-level
resource so imagine a file descriptor
get a file whatever you want that's on
handle okay so these are the number of
active and those that you can that we
track and we also have an event loop
delay we use a very nice very art one
not nice very hard to understand
I couldn't statistical model to even
talking with the data science under
smart and set brought it is did a
fantastic job to detect the the
waveforms for these for all these
patterns and combining these together to
detect values issues one of these is the
event loop delay issue so you can see
event loop delay it can't detect more
than one and it offers some
recommendation around here let me try to
zoom in okay it offers some
recommendations so there may be one or
more long operation blocking the tread
and it says mitigate implement 503 event
loop protection how many of you know
what a 503 error mean in HTTP service
unavailable yay so what it does it tells
your load balancer to try somebody else
okay
more or less you are saying if your
event loop is going to be is going
balloon you might want to tell hey load
balancer don't send anything this way
because I won't be able to reply anytime
soon or pull me out and kill me I don't
know depends on how you want to end all
the stuff okay
but whatever how do the N knows well you
want to just find out what
cpu intents what is blocking the event
loop there is also long discussion and
explanation and bla bla bla that one of
my colleague David mal Clemens wrote is
fantastic
you might ask what I did about this zero
one thing I did basically I work with
the statistician for for a couple of
months to actually coded the waveforms
so they came from my brain I'm joking
anyway so this is doctor you run this
way this image so now Clinic Flint er
okay clean claim is based on this tool
called earwax you might have already
seen it
it's a flame laughs - how many of you
have used the flame graft in the past
some people hey good guys so 0 axis
makes running this very easy so we can
run it in this way with clinic flame and
run nodes low event loop index and it's
going to clinically is going to ask me
for my root password because I need to
do because it needs to use the trace the
trace runs only on runs on Mac on Linux
it use a thing called perf which is more
or less it's similar
it does stack sampling so it collects
all the stacks of your applications and
then it enables us to to print the
status now this projector completely
destroyed the visualization the code is
not seen this is a function called sleep
okay this is a theme button let me try
the theme button did they change
anything it's even worse right maybe not
maybe you can see the scope sleep okay
this is a sleep function so now let's
see the code that's a code
okay that's the slip function okay so
this was a very very simple example okay
how to block that and loop you put a
function that wait for some millisecond
to pass very good code to implement
sleep by the way there is a new version
of D Rho X coming out that's already
came out what we haven't integrated with
clinic yet
it's before with v4 we can use the same
on port flags that we use with dr. so
you can use 0 X - OH - automatically
open and we can do the same thing now is
it is slightly different for example it
has a nicer it has a nicer emoji okay it
has a better terminal handling but more
importantly it it doesn't have any
dependency it can run without the trace
or perf by default it uses the internal
some of the internal profilers from v8
to actually perform this work so and in
fact here we can see more stuff it's
also have some more options it can show
you which function are inlinable which
function are not inlinable it can show
you optimize and optimize and other
things what it doesn't do it doesn't
sample the C++ stuff stuck stuff that
the kernel tracing can do it also - poor
candle tracing so you can use it as a
Swiss Army knife or flame graphs okay so
how much time do I have left five
minutes perfect so it's the super contra
seeing the window okay
whether I have a Mac I started joking
about Windows it works on Windows so one
of the most requested features of zero
actor was working on Windows by the way
remember that most code doesn't need to
go
ludicrous speed okay it's not it's not
needed okay it's perfectly fine to write
slow code okay depends on your
applications however if you need to
write fast web application that's my web
framework okay there is a nice talk that
I did that last year called take your
HTTP server to the cruise speed check it
out talks about this framework was
falsified it has a very CPI similar to a
lot of others I this Model S is out it
compares this is Latium outdated numbers
so take it with a grain of salt is a
little bit lower because of speculum
meltdown so these high numbers of not
reachable anymore thank you Spector and
man down and thank you Intel I also want
to talk about logging this is a nice
another talk that I did three years ago
the cost of login Pino is the fastest
logger for node yes you should check it
out it's very very very fast very easy
to use the same API of Bunyon so you can
create it blah blah blah I've been
working a lot of making code fast ok
this is the performance difference on
taking last year on on Pino whatever
take take your your decides this make
your choices acknowledgments I would
like to thank Annie affirmed because I
wouldn't be here if it wasn't for Nathan
in a very true sense and me from send me
to a client and I just decided that I
was going to speak here
[Laughter]
also thanks in from from my time on
North core I am on the nodes ASDs see I
am paid to to work on open source so I'm
thank you for for using node and for
using all the stuff that makes this
community great so that is that if you
have any questions about node
any curiosity and it dubs any problems
any complaints
whatever come to me I want to hear about
all of them okay especially if you have
noticed not streams if you have problems
with node streams
I am the guy for not streams okay I am
maintaining that stuff if you fi if I
ever you have a problem with readable -
stream which is the thing that you old
all the time you download with any
node.js project that you are running
please come to me I did but I published
that so it's probably my fault I want to
thank everybody on this picture very
quickly Andreas which is was the data
science scientists they did the magical
thing with dr. joy they did the design
corner are my boss and Martius mathias
mathias booth you probably know hit this
guy McIntosh on github you were quite a
bit you know who is working on these
tools on the next tool that is coming
out and allanon caminar working there as
well and David Mark lemons that brought
the racks and this containing it and
this presentation not design the
previous version of it I will deploy
this one sooner than later is available
here and this is me a whatever a lot of
open source and thank you if you need up
with nodejs
we are in business so that's what it is
so bye</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>