<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>After update trigger   Part 44 | Coder Coacher - Coaching Coders</title><meta content="After update trigger   Part 44 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/kudvenkat/">kudvenkat</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>After update trigger   Part 44</b></h2><h5 class="post__date">2012-09-18</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/P_BREQy6bOo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Oh welcome to prison technologies I am
venket this is part 44 of sequel server
in this session we'll learn about after
triggers after update triggers
specifically in part 42 of this video
series we are speaking about after
insert and after delete triggers again
in part 42 we have spoken about you know
the three types of triggers that are
available in sequel server DML DDL and
logon triggers DML triggers have fired
automatically in response to DM elements
and examples of DM elements include
insert update and delete statements DML
triggers can again be classified into
two types
after triggers and instead of triggers
after triggers and are also called as
four triggers and in part 42 we have
spoken about after insert and after
delete triggers and we know that after
triggers fires after the triggering
action the insert update and delete
statements causes and after trigger to
fire after the respective statements
complete execution on the other hand
instead of triggers as the name says
fires instead of the triggering action
instead of the insert update and delete
statements the instead of trigger gets
fired okay and we have seen in part 42
of this video series you know there are
two special tables that triggers make
use of inserted and deleted tables
inserted tables we'll hold the new data
that you have inserted into that table
and delete the table will hold the data
that you have actually deleted now let
us see what actually happens when we
update a row and if there is an update
trigger you know what does these
inserted and deleted tables contain so
let's first quickly create an update
trigger on TBL employee table so we have
caught the stabile employee table which
has got ID name salary gender and
department ID columns now let's go ahead
and create an update trigger on this
table and then update a row and see what
these inserted and deleted tables look
like so let's get into sequel server
management studio and we have this
tables you know TBL employee and let's
write an update trigger for this and
again
in the syntax for the update trigger is
pretty much simple I mean similar to
insert and delete trigger except that
instead of for insert or delete you use
for update so create trigger trigger
name and then give a meaningful name to
the trigger usually triggers have will
have 8 TR prefix or TR underscore the
table on which we are creating this
trigger in this case TBL employee and
for what action and we are creating this
for an update action so for update on
TBL employee for update as begin and end
ok so here let's simply say select star
from you know the two special tables
that triggers make use of deleted and
the other one is inserted so select star
from inserted table and let's get what
actually happens so create this trigger
command completed successfully if we
refresh the triggers folder we should
see the trigger that we have just
created alright now let's go ahead and
update the employee table so if you look
at the employee table we have got an
employee with ID 8 who is Jane here at
the moment Jane his salary is 1800 and
Jane is a female but what we are doing
here in the update statement is
basically we are changing his name from
Jane to James and his salary from 1,800
to 2,000 and a gender from female to
male ok so let's execute this and see
what actually happens and keep in mind
we have created you know an after update
trigger so obviously immediately after
the execution of this update statement
on this TBL employees table this trigger
gets fired automatically ok and we know
that triggers are actually special kinds
of stored procedures that execute
automatically in response to the DML
events because these are DML triggers so
let's execute this update statement see
what happens so plus a five look at this
did this is the you know select star
from deleted so deleted tables can
deleted table contains this data and
inserted table contains this data so
so if you look at it ID we haven't
changed the ID because that's the
primary key so it stays as it is and
then we have changed the name from Jane
to James
and similarly salary from 1,800 to 2,000
female to male and Department ID we
haven't changed so it's the same so from
this you should have got an idea that
deleted table will contain the data that
the table has before the update action
and inserted table will contain the data
I mean actually the new data after the
update okay
so delete I mean after update trigger
actually makes use of both inserted and
deleted tables and inserted tables
contain the new data deleted table
contains the old data before the update
action alright now with this in mind
let's let you know quickly write a
trigger that can audit you know employee
information when we update a specific
employee data okay now if you look at
what we are trying to achieve let's say
for example yesterday when we have
spoken about you know after incident
after delete triggers we have audited
these things you know for example when
we add a new employee we said new
employee with ID is equal to mine is
added at so-and-so date and time
similarly if an employee is deleted then
we have audited that as well similarly
when we update an employee's details we
want to capture what information is
updated okay for example if you look at
this employee with ID is equal to to
change the name from Mike to Mikey and
salary from three thousand four hundred
to three thousand five hundred so these
two fields are changed okay if there is
only one field change then we only want
to capture that one feel okay so how
many ever are the fields changed we want
to capture all those fields and then log
that in this another table called TBL
employee audit table okay so let us see
how to do that and obviously you know we
can make use of after update trigger for
that okay so we have this TBL employee
and TBL employee audit table
so we want to insert you know audit
information into this TBL employee audit
table and if you look at the TBL
employee or the table it has got one
column of type I mean two columns
basically one is the primary key and the
other one is and we're cap ordered data
okay so obviously we will have to build
the string and then insert it into this
table okay
so if you look at the way inserted and
deleted tables are storing the old and
new data it should be pretty
straightforward to achieve you know what
we will basically do is retrieve the
data from inserted table
compare that with the data in the
deleted table and if there are changes
build that string and then insert that
string into TBL employee audit table
it's as simple as that so obviously if
you look at the employee table it has
got named salary gender and department
ID columns so we need variables to hold
the old and new value so first of all we
need to create the trigger so let's
create the trigger I have this written
already so that we don't waste time
typing it so create trigger trigger name
since we already have a trigger with
this name we will call I mean we'll say
alter instead of create okay on TBL
employee for update as Piggin so this is
all the regular staff and look at this
we are creating some variables basically
here and the reason why we are creating
these variables are to hold the old data
and the new data for example ID will not
change that's a primary key so I just
have one variable to hold that ID of
type integer
but then name salary gender and
department ID can change so I am having
variables of that data type old name new
name old salary new salary old gender
new gender old department ID new
department ID and then obviously you
know we need to build a string like this
employee with ID is equal to to change
name from whatever so we need to build a
string like this and to do that we need
a variable of type and we're care so I
am creating another variable called
audit string of length thousand
okay and then I am using Kira a
temporary table and the reason for that
is let's say for example I will actually
practically explain that reason in a bed
okay
so all we are doing here is so this is a
trigger and we know that a trigger can
access inserted and delete a table so
what we are doing here
after after declaring all the variables
that we need we are saying okay select
all the rows from the inserted table so
when we little get into an inserted
table whenever somebody updates a
specific row the new data will be in the
inserted table so what we are telling
here is whatever row that is there an
inserted table take it in take that into
the temp table okay select star into
hash temp table from inserted okay so
put that row into the temporary table
and then I'm using a loop here and the
reason why I'm doing this is because
somebody can issue an update statement
like this update TBL employee set name
is equal to whatever salary is equal to
whatever and then wear ID in maybe 1
comma 2 comma 3 comma 4 they can give
any number of IDs they want so if you
are if they are updating so many records
in a single shot then we want to loop
through each record because we want to
update each employee so that's why I'm
putting this in this temporary table and
then looping each row within that
temporary table okay so here we are
checking ok select ID from hash
temporary table so we are getting the ID
I mean if there is an ID column I mean
if there are rows select the ID column
if there are no rows obviously this will
not return anything and this exists
function will return false if it returns
false
obviously we'll get out of the loop so
this is basically a boolean condition to
check if there are rows in the temporary
table and then what we are doing here we
are initially you know setting the audit
string to an empty string and then from
the temporary table if there are rows
you know this condition will tell if
there are rows in the temporary table so
if there are rows
could be one it could be many okay so if
there are many rows we still only want
the first row that's why we are using
top one so select the top one you know
what we are saying is select the ID into
ID variable since this is an inserted
table we are copying into hash time
table so hash temp table contains the
new data so I'm copying the name new
name to name I mean name to new name
gender to new gender variable similarly
salary and department ID from the temp
table and then what we are doing we are
taking this ID and then going to the
deleted table because deleted table
contains the old data so we are using
the old variables old name old salary
old gender populating them okay so it's
pretty simple I mean these are these two
lines are you know they look big but
they are pretty simple to understand all
you're doing is selecting the first row
from insert a table taking that ID and
then comparing that with the ID in the
deleted table because if there are
multiple rows we want to pick up the
right Heidi so and then we are
populating those old variables next step
as you might have guessed what we will
do we will compare the old and new names
old and new gender okay but before that
we are setting the audits train okay so
how do we want the output we want to say
employee with ID is equal to two changed
so we want to faster build a string and
to do that we are using we are setting
the audit string to employee with ID is
equal to whatever is the ID that we have
here and ID data type is integer so we
need to cast that so ID is integer we
need to cast that to n where care so we
are casting that and then concatenating
with this string and then obviously to
that we are concatenated this changed
word and then now starts the comparison
so from here this is again a very simple
code you know it looks big but then it's
just a copy-paste of the code so here we
are saying okay if old name is not equal
to new name it means it has changed so
we are concatenate the
deterring so to this audit strain ad
obviously the old name is not equal to
new name so employee with ID is equal to
1 or 2 whatever changed name from the
old name can get nade that to 2 and the
new name because those variables contain
old and new name respectively and along
the same lines we are comparing genders
salary old Department to new department
and then we are building these strings
dynamically there if there is no change
then it wouldn't get into this if block
and then concatenate that so I mean this
procedure looks pretty big but then it's
pretty simple it's it's mostly it's a
copy paste these lines you are declaring
if you look at this these lines you are
declaring variables here you are copying
the rows from insert a table into hash
stem table and the reason why we are
doing that is because if we have
multiple rails then we want to audit
each employees record and then we are
using a while loop to check there are
rows in temporary table or not and then
here you are taking the first row
because you are using top one keyword if
there are multiple rows you get the
first row from the inserted table and
then along the same lines you are also
getting other columns into those
variables and then using that ID
retrieving the row from deleted table
and then populating the old variables
and then you are building the audit
string here and finally what you need to
do you need to insert that audit string
into TBL employee audit table and if you
remember TBL employee audit table has
got only two columns ID and audit data
columns ID is an identity column who see
this one increment is one so obviously
when you insert a new row ID value will
be automatically calculated you only
have to supply the value for audit data
column so that's the reason why we are
only supplying audits string into this
TBL employee audit table and then what
you need to do this is very important
delete from from the temporary table
delete the record that you have just
audited otherwise
this loop will become an infinite loop
okay that's all
so let's alter this trigger and see if
it works as expected press f5 command
completed successfully so the trigger is
created now let's kind of try to update
but before that let's select the data so
let's say we want to change maybe Todd
to toward name to Tebow Diaz and look at
the store's record as this one ID is
equal to four and salary from 4,800 to
let's give him two thousand and gender
from male 2 let's say female we can also
change department ID if we want to I am
NOT going to change that and we can save
Air ID is equal to four so when we
update this + fi alright it says one row
affected now let's select data from TBL
employee table actually employee audit
and employee table and if you look at
the audit data you should see employee
with ID is equal to four change name
from Todd to Todd's
gender from male to female sell it from
4800 to 2000 alright so it's a simple
example I mean it looks big but then
it's most of it as a copy/paste so the
after trigger for update even makes use
of both inserted and deleted tables and
obviously the insert a table contains
the updated data and the deleted table
contains the old data on this slide you
can find resources phrase be dotnet
c-sharp and sequel server interview
questions that's it for today thank you
for listening
have a great day</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>