<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>ASP.Net Core: 06 - Email Verification | Coder Coacher - Coaching Coders</title><meta content="ASP.Net Core: 06 - Email Verification - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/AngelSix/">AngelSix</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>ASP.Net Core: 06 - Email Verification</b></h2><h5 class="post__date">2018-04-26</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/iYFP26_zI98" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so in the last video we finished off the
register of an account on the photo wood
server and the only but we didn't do was
really sending the user an email
verification link to click to verify
their email so I did a spin-off onto the
web development series to show you how
to make an email HTML template that is
now on the github YouTube repo and email
template and effectively the output is
this if I turn off my dark theme for
some reason is still showing doc L has
because the it's a local file I can turn
off the dark theme on the local file for
some reason maybe I can just disable the
whole thing for a minute there so this
is the email template we made basically
so we've got that you can if you don't
want to make that and you just want to
take you know the free compiled output
then it's in this YouTube repo and we
can use that output as we go forward but
that's now the email we want to send so
that's what we're gonna do in this video
is to actually send it when required
here and to do that we are gonna do
initially we're gonna make use of a
service to send the email for us
and then we will do an additional one
where we can send it directly just using
SMTP so I'll do initially a decent one
you know a a service dedicated to
handling mass emails which really I want
to use in the facetted word application
but then I'll also show you an alternate
way of doing it with just SMTP in case
you want to keep the cost down for
yourselves so what we're gonna use is
something called SendGrid so you can use
any you want but if we just go to
SendGrid comm so I just type in Sandro
comm will take us to this website
now it says free and if you're gonna do
low volume emails like you know 100
months it's it's free so all you need to
do is try for free sign up for a free
account just enter your email name and
address and then you get initially you
get for 40 thousand emails you could
send but obviously we wouldn't send that
many and then it'll revert to a free
hundred emails a month account so go
ahead and sign up for this and then
you'll get to the login screen and then
this is the screen you presented with
one troops signed up for an account if
not just go to the drop down here and
click setup guide and you'll get this
option so this will send emails and I
will be half so you can see we're gonna
drop down here and we can integrate
using popular apps that we're not using
we're making their own building some
marketing companies are not interested
right now we basically want this one
integrate using our web api so we'll
click start on this one and then it's
recommending the web api as opposed
directly sending an smtp so we're gonna
go ahead and use the web api and then
we're gonna choose c shop and basically
follow the set up guide so our library
requires dotnet 4 5 2 which is fine make
an api key
so this will be for our entire
application so I'll just call this
versatile word and create key and also
there's delete this key and recreate it
on there you know after this video so
it's not you know you don't see this so
we need to make use of this key create
an environment variable of the developer
blah blah blah install package and then
send first email their websites messed
up and we just fix that a minute
i frames got a high um for some reason
there we go so they want us to bad looks
on install sanguine as a package and
then take this code so let's just take
the code this is what they want us to
use in essence so just copy that bit and
we'll open up the peseta word server and
then in here I guess now we need to we
don't want to just send it directly here
so we obviously want to a to make use of
dependency injection and to do this
properly so we'll have an interface that
will send emails and then we'll
implement that interface and to be
honest we could implement it directly in
the core as simply a one of the
implementations as a built-in one to our
application and then we're free to swap
that out if somebody else wanted to so
we'll make a folder called email we'll
make a new class we'll call it send
bread email sender and it's just in call
public class will inherit an interface
we'll make an interface shortly I mean
just make a function to gumbaz code in a
minute so this will be sends emails
using the SendGrid service now the only
thing about putting it directly in
chorus were then gonna have a dependency
on SendGrid and call as a package so we
could pull it out to make another mini
solution but to be honest it's that
small can dump it in here we can dump it
in here so let's just flip this around
and let's just dump it in the server
instead so it's not directly in core
think about it so we've moved it over to
the server here like say we can always
pull this out and use it elsewhere
change the name space to a Fassett Oh
word web server
there's that so suddenly males using the
same word serious and I want to do
things all this doing healing is getting
the environment pulling off the key we
won't use that we'll make use of our IOC
container that we have so we already
have an IOC container with configuration
and then this can be pulled in from our
app settings JSON files let's just chalk
it a key in here
so I'll have call it send the grid key
and then we'll copy and paste that key
here so also it is changing where while
loading it from will put that in there
save that so now each one sangra key in
here so seventh-grade key so I'll get
the API key the client to send with
client so you can see we need this now
so if we right-click on dependencies and
manage NuGet packages browse and type
SendGrid I'm presuming the gonna and
nougat get hops and good yell at the
official one so install that accept that
and then control dot and you should find
it using SendGrid
control dot again there send good
helpers and finally this is just waiting
for and await so that code will compile
now we could test that but I'm happy
that'll work so we were all the testing
that for now one thing I did notice
though if we right-click on the solution
because you haven't done this in a while
manage new that package for a solution
and go to updates and see we got six
updates just keep everything up to date
as best you can so select all update
just get the whole you know all these
packages up to date including my DNA
framework and then do a build to make
sure everything builds after this so I
presume it's still updating
just taking a while then we go
come on so they're all updated so that
solutions up-to-date this just complain
about the name it's my convention so we
haven't broken anything in theory yet so
let's just try and compile
I think DNA framework might break
actually cuz I mean named they use
keywords to add to match with dotnet
core apparently not
why not I'm sure did we name things I'm
not using DNA framework in this yet oh
no so I haven't integrated DNA framework
into this yes we will be doing them so
that's all we got in core but we're not
making use of it outside of there yet
that's all the packet is upgraded we now
have this so let's start really thinking
about this so in terms of a generic send
even let's just call us and email let's
start turning this into a function we
will want a Singh because we need to
wait their code summons will return a
task will also have the response to send
an email that was maker own class up
source go to send email response say and
that can lie in core so I just go ahead
and create an folder in here in core and
we'll create a class called send email
response and that will be a class a
response from a send email call in for
any and then C and we'll made the
interface us will be I email sender
implementation
and we'll want to obviously have certain
details about what we're sending so for
that I guess we'll have successful
whether it's successful or not true if
the email is sent successfully and I
guess the only other thing for now is an
error message we can handle and we'll
handle in future error codes and unit
testing and things and little evolve
further but for now that isn't in our
application so we'll just do an error
message error message if the sending
failed and the realness the successful
could be an indication of the error
message not being or if the message is
not from it's anything except null then
it's gonna be a failure so we only have
to set the error message if we want it
to be false so let's say that's good
enough for a response we'll use that as
a response that is in core so gonna
include the core namespace there because
this is a task should we send email
async and we can make the interface to
be ourselves or the interface needs so
that can be I send I email sender and
then we'll make this interface so just
go to email sender will be in theories
in I of C can be injected so make a new
class in there call thy email sender or
a new interface rather so probably
interpreting maths under handles sending
emails to be honest I don't think this
much more to say about that so a class
or a service that's handle sending
emails on behalf of the poor not much
else to say
this call will then be in here without
the async all the public and this will
be sends an email message but the given
information that also leads us down to
needing to pass some information in so
I'll say send the email details the
details about the email to send we also
know need to make this and email details
which is going to contain you know who
it's going to who it's coming from what
the message is whether it's HTML or not
you know the whole details so I'll be
send email details in poor again that'll
be public class we can copy that
description and now we have send email
details for this will have a from name
get yet that's an I think the name of
the sender well out from email the email
of the sender same again for the two so
to email the email of the receiver and
to name the name of the receiver could
be receiver or recipient but doesn't
really matter we'll have a subject email
subject well so we got we've got the
content itself the email body content
and then finally a flag indicating HTML
indicates if the contents is a HTML
female I think that's all we need for
send email details so now we can pass in
the details here and now we have finally
a function ready to do things nope a
sweetener response that's fine all right
so now we have a nice structure we have
an email sender we have the response
that we can make well the details we can
give and we have the code that will do
for now let's just return a new response
little build don't care about it and
we'll do this last will now make the the
infrastructure for all this to kind of
fit in and work if you will so what we
want to do we want to inject this into
IOC so we have the email sender so we
want to go to the start up and we want
to want to do similar to this these
extension methods so how the ad identity
you just do services to add identity
it's just an extension method like this
so we want to make an extension method
so in here anywhere we really want to do
it I guess we want to do up here say add
some grid email sender I want to be able
to do services dot add send grid so to
do that we'll need an extension method
so we've implemented it in here so let's
just do another class in the server
application called sand grid extensions
and remove that there'll be a public
static class extension methods for any
send grid classes or any Sun grid don't
know script report classes so in the
extension method also need to do is
return a well first is going to be a
static method inside
static glass that's how you do an
extension method we need to return a
nice service collection and we need to
then give it the name so I'll say add
SendGrid email sender and then we do
this to turn into an extension method
and we also accept a service collection
so you simply pass in the service
collection and meeting it back out and
making use of it inside and that's all
that's you know how asp.net core does
its little don't add this dot add that
and you can you know like at the end of
here now we've done add identity and
then you notice no semicolon we've done
that dot add some metal studs metals and
chain them all together and that's what
they do and all you do here is return
collection or chaining and that is the
service so now we would just go back to
here we could do services add SendGrid
email something you can see now it's
already an extension method so now we
configure it like this so it stays the
same as all the other you know adding
options and then here now we need to
inject the same grid email sender so to
do that
because this is going to be a class and
I'll talk a tiny bit about this so
dependency injection I've mentioned a
few times and then multiple ways the
it's a good way to separate your
concerns and to be able to construct
your application here and inject
specific implementations of certain
interfaces or certain classes so that
you can simply invoke them you can say I
want the provider dot get me this
service and I want an email sender
service and then anywhere in your whole
application can access that service
without knowing anything about it
without knowing the implementation when
you add a service to the dependency
injection you've got a few options you
can add a transient service which means
every single time you request it it's a
new copy you can add a scoped service
which is if you start a scope that then
handles the creation of elements like in
an asp.net controller
that's a scoped instance it basically
it's almost like transient or if the
call or the thing that's creating the
the class that you're then asking for
other services inside of its the scope
that handles returning those instances
then you've got Singleton's which are
single instances so for this because all
the email senders really doing is every
time it's spinning up a new class anyway
creating a new class adding the stop
sending it and then being done we'll
just have this created every time so
we'll just make it a transient so every
single time you request it you get a new
copy the benefit of that is once you're
done won't you sell email and it's gone
it's no longer in memory you're not
keeping it in memory all the time like a
singleton will be so you're not using
RAM on your machine you're only using it
on demand and to do that transient we
want to implement an eye email sender
and the implementation of that will be
the SendGrid email sender and that's all
we need to do so that will now add our
service and now we can get that service
back now when we need it so that's the
extension method on so injects the
SendGrid email sender into the services
to handle the eye email sender service
and that's really it
so that's the extension math done we've
a degrees in start up so now we're at a
point where we can actually make use of
it and you know send something so
without us having to first get all the
way to here and register an account to
do some testing we can just chuck it in
the startup and we can just go once
we've done the configuring and we then
do configure here we've got the provider
and we use let's just chuck it to the
pop-up here so the app spun off this
could be anywhere in the application and
it will ultimately be here when we're
done we'll first just get the the
service provider
so to do that as if we are in a you know
a different part of the application we
use the ioc container and provider which
if we shift and f12 you'll see get set
here in the configure which is where we
are now it's at the top and this is just
a static reference right now in our web
server that will clean all this often
and bake DNA framework into it so this
is accessible everywhere in every
project so this had been cool but for
now it's the same principle simply this
is accessible right now everywhere in
our application for now so it's good
enough to to make use of so I have C
container dot provider get as
effectively this service provider that
we just added everything to let's use
your dependency injection provider and I
can just ask for a service soon as they
get service I email sender and that will
get us now the email sender and now we
can do dot send email and then make a
new email details and so now this is
effectively sending an email so just to
test this whole thing works and then you
know dependency injection works put a
breakpoint on that we'll put a
breakpoint inside here we could also to
show the transient work you know guess
it's just create a constructor for now
and for a breakpoint here so you'll see
every time we hit it we get a new
version
we'll also then copy this twice so we
can see it happening and that each time
it's a different one and then finally
we'll we've got a breakpoint in here to
see something happening comment and I we
don't want to actually running right now
so we build and run this we'll see
hopefully the the set that we've done
working
so the site spinning up then we should
get to there we go so now it's kind of
ask the provider for an email sender or
press f11 no because it's creating a new
instance and then it's now going into
the send email call which is what we
want and then it's for now it's just
going to return a function we hit the
next one f11 n because it's made another
one so each one because it's transient
is creating a new you know copy of that
class if you up just a new instance and
then it'll call into our function so
that's what we want that's now set up in
the right way to handle being able to
send emails so we'll leave the sending
it for the minute for sending the email
on startup and we'll fill us with some
type of content so let's do a certain
basic content first s our first HTML
email and then we'll do be with some
bold text and that will do well to be
honest all we need just to show it's
there from email so it's coming from
will say secret art website comm just
make up one then we have from name
equals some guy as HTML as true we
should probably put that next to the
content and then we'll have to email I
want to go into myself so I can see this
and to name which don't really matter
because it's kind of whoever those go
into it's going to this is more for your
reference who you think it is if we've
got their name we add it so we can see
who we think is and then subject this is
from the circular word and I think
that's it
yeah that's all work property so there's
all the info we want to send so now
let's actually make use of that so we
know that's going to boil down to coming
into here so we can now get that we can
delete the constructor now we don't need
it so now let's just get their example
code and chop them what we need so we
have a client or more common Ness so get
the send red key great a new SendGrid
client set the ROM details and then
we'll just go to hear this from email
from names that'll be details doc from
email details from name subject will do
from - makes more sense same again
details - email details doc - name
subject is now our details that subject
plain text content using HTML content
well to be honest content of content now
and then we decide that afterwards so
that will be details content create
email class ready to send so we've got
the from - the subject plain text and
HTML content so looks like you can send
one or the other
bought the I guess it's which one you if
you put both in it can't possibly work
because as far as I know maybe I'm wrong
on this but I'm sure you can't send her
HTML email and a plain text email you
either send the email content is what it
is you can't tell the receiver what it's
got so I'm pretty sure this will work on
have you send HTML content that will be
sent if you send plain text only the
office sends but let's make that
presumption and say that then
if details dot html' then it's gonna be
null in this case otherwise it's gonna
be the details content and then for HTML
it's the opposite so details dot is HTML
it's gonna be the contents otherwise
it's gonna be not so I'll create the
message ready to send we can also break
this down so it's easier to see and we
can also comment plain text HTML or
content and then the rest are obvious
from to subject and then finally send
the email and we get a response now
there documentation
I saw overlooked something doesn't
mention anything about the response
doesn't do anything with it so we can
look into the documentation but to be
honest I'll just send the email see if
it works and see all the responses and
then return result based on response and
that we'll have to figure out after so
we shall get into here get all the info
get to this end and then finally get to
here so let's spin up the application
and take a look so we've gotten to here
now to send we should have the details
for the email just here all I get set
off the API keys pulled in successfully
two prompts object content the message
now the message is created has got
contents and its text HTML so maybe it
can send a multi an email with multiple
parts of content in fact saying that out
loud I think you can for now were quite
happy sending HTML emails it's you know
not many people can only receive plain
text I'm not really bothered about that
so from is correct personalizations
subject twos and then it's too so all
the details look like them in there and
now finally we'll send the email so f10
over that and we await so up as you now
the site's kicking in which is fine
because that's at the end we've returned
here well the reason it's carried on us
because we haven't bothered awaiting
this call so it's in a way to Bob what
we didn't bother waiting that's why the
website kicked in
now we're gonna respond so we hover over
we've got a body which we I'm read to
Wed read from so we should read that
headers we've got and then states code
except it's something that's a HTML
status code so by the Luke sorry that
should have worked I guess so let's just
stop letting out check me emails out so
I drag the emails off you can see we've
got the email so there's a subject which
is right this is where it's apparently
coming from some guy at our secrets at
website calm and that's the content and
it's come to me so looks like it's
actually worked fine it's that's a good
start so now I guess we will move on to
adding our actual content their HTML
content supposed to go back to the site
now we've done that so I've integrated
the code below next to verify whereas
tester integration send an email to your
application using the code you
integrated click verify and it worked so
few email activity now it doesn't look
like it's coming through yet on here but
we're not bothered is come through we
know this dashboard update with email
sent I'm pretty sure so we want to
really make use and the reason I've
picked SendGrid is that we can make use
of templates and that will allow us to
put in our HTML template and put
variables inside of it so our email if
we pull it back up we want to replace
like the we can make a generic one with
a title
or content and a button which to be
honest isn't a bad idea which will
probably do so then this would be the
variable this would be the header this
would be the content this would be the
button text and that I've bought nil as
well doesn't be a generic email template
for us so in order to do that we'll go
to templates transactional and then go
to marketing campaigns try again
template transactional there we go and
create your first template click their
name I guess we'll just call this
general yep general template in that's a
search so yeah we'll call this one
general we'll save I guess then we'll
add a version and code editor because
we've got the code to put in continue
here's the code so if we take our code
from our email copy all that and paste
it in fact we just replace everything
yep there we go so that's definitely our
code in there and now we need to know
this got kind of oh yeah just got like a
comparison here so we want to replace
this verify email with a variable so
this can be any literally any piece of
text you want so let's just do say - -
title - - and then we'll replace these
bits of string in the whole thing so you
just want this to be something unique
that won't be anywhere else in your HTML
template so I'll do a title there then
the content now the only thing with the
content as we've got a real it's content
one content two because you've kind of
separate them with td's so this can be
content one and this can be content -
and there we can see how it looks and
then the verify email
I don't want clicking that to actually
open the link so here we go this will be
- -
cotton text and then the Earl it goes to
this hate draft here will be - - or than
ill so we have now that's all we've
really done we've modified those few
bits with babbles we just have to
remember these variables title content
one two button text button ill if we
save that template now unknown errors
are cured thank you very much
so select all copy refresh and then see
if it's magically lost Excel paste it
anyway that's their save ok that's
worked fine now so we go back we now
have a template with a really bizarre
name can we change that name yep general
save so we've got a general something
with a very I've got the version name in
there at the title the same that's fine
so now all I need to do to send an email
based on that template is to get this ID
here so copy this ID and close that bit
now and go back to our email we don't
let that bits run them about direct
email send code which is here after we
created the message which doesn't really
contain anything you know that's purely
message details now the content itself
is there the interesting part here
really I'm not sure what's gonna happen
with the content to be honest because
the contents I think that's where it's
gonna be body in the email
well it had that special body tag and
that's where contents gonna be we don't
really use contents here so it's also
gonna bag a different question oh it's a
certain template that we've got you know
special variables to we're gonna have to
have a list of we're either gonna have
to make a specific detailed per email or
handle that in a special case that we
know we want to use a certain we're
sending a very specific email of UL or
sending a verify email
and we've got a construct that detail
and also to handle the templates are
sort of a it's very specific to SendGrid
so making use of really the same good
template system in this fashion is is
not gonna really be universal because
this is an email sender that just wants
to send data so what we want to do is
bubble up above this level and
construction on the else that's more
specific that then ultimately this will
just send details will also have to I
guess handle this sending of an email
because what we're going to do is is add
a template ID and add the variables into
this but we need to pass that in as well
so I guess we need to think of if you
want to send an email some email some
email details been sent could be I guess
very specific to the email sender that's
been implemented so we could have just
an object in this class that's you know
custom details that are specific to the
the sender that's being used but then it
kind of again you boil it down to being
not generic he wants to stay generic so
I'm almost tempted than one I'm thinking
this through to keep this as a standard
email sender in the sense that it needs
content from an email to be sent and we
we handle the substitution ourselves
because that's all its really doing is
taking our code and replacing almost a
string replace value with those and then
we've got keep track as we had ID as
well so just to quickly show you how
that would work anyway and then we won't
do it that way there's what you have
here is you do message dot template ID
you pause then you paste in the ID and
then just do message to add substitution
so the add substitution and this would
be their title and then the value would
be verify
email and you do that for each one so
you have you know content one content to
put in text and vote nil and then that's
it you'd fill it with the right
information and send and the content
would be tweaked to you know suit that
that's all you'd change so if you run
this now you'd get a template so we can
run a quick one and say like hi guy then
this is the the second line and this is
just below verify email as a button text
I'm gonna go to my website say and every
where to send this now you should see
the email will get will be including the
the template but then what we'll do is
just delete that so there's the details
we send presume it's worked we get
accepted again that's fine and now we'll
check the email so you can see there and
now we've got verify email hi guy for a
second line verify and the link so
that's working fine and that's making
use of the template but as I mentioned
this isn't really if we now want to
change this out to not use Sanger it
we're relying on send good for something
we're adding a dependency that's a bit
more than the like we don't need to make
use of that template thing so we'll
delete that save that go back to send
grid let's just delete that confirm
delete this done so now we'll do it our
way we're doing exactly the same thing
what we'll do without the requirement of
using sangwich templating system so all
we need to do is pass in the the final
content as HTML so this is really done
this SendGrid email sender is donuts job
is done it sends an email the only thing
we've got to do is handle if it
succeeded or not and where the error
messages are so we will get first the
body result equals the respond
body dot read a string that will simply
get as the body totally gut and we will
have the response is status code rather
as HTTP status code so yeah that is
there and we've got accepted which is a
202 so it looks like 202 is the if it's
succeeded
let's 42 fail to see what happens let's
just say an email that doesn't exist and
let's see what happens to the response
at that point says opens or tries to
send a presume oops I didn't break point
so totally floating through and missed
everything so let's try that again so it
opens up get to here so the response
this time is bad request the body result
is a has a tan will await the async
strike once more he'll wait the results
that's a task so we know bad requests
happens when it's failed so basically
anything other than 202 we can presume
as a failure
you could also read the documentation
I'm just being a bit lazy here figuring
out myself
so now the body request is Jason
obviously here so it's a class that
contains an array called eros and in the
array it's got a message and a field and
a help link so we can construct and we
will construct I should copy that error
open up notepad and paste that in a
minute
so we will create in here a new class
called
SendGrid response I guess and this is a
response to a response to a send threads
and message call so we know it contains
a list of errors which is also another
class so let's just make another class
which will be send read response error
and that will be an error response for a
send read response and then here then so
for each item we'll start with this is
now can be probably kept a list of
SendGrid
response error it's gotta be called
errors any errors from a response you
can do an array I just like using lists
so we've got errors that's the only
thing in there has a bunch of errors
that class is done inside the errors we
have a message which is a string of
field which is a string and help which
is an ill there's a string so razer got
three strings called message field and
help so we do public string message the
error message public string field the
field inside the email message details
that the error is related to and we've
got help which looks like an L and I'm
presuming that's always gonna be the
case so useful in formation for
resolving
the error so this looks like this would
be more developer help because you know
you're not going to tell that to the
end-user
that would make any sense to them that's
to us you know help for us this at the
same time is also practically useless to
the end-user but this message kind of
helps a little bit so all they'll do is
output that message detail so what we
should be able to do is say firstly if
we succeeded so a response dot status
code is accepted then return new
response a retailer successful because
that's all you do return one there's no
other content otherwise it's failed so
this would be otherwise it failed so we
get the result from the body deserialize
the response we should also at this
point try and catch here I guess and if
we fail then that we failed or if
something unexpected happen return
failure stop it return you email
response with an error message are
unknown and to do localization which
don't need to do a debugger dot as
attached
debug break and all that I'll do is if
we are debugging it'll break into here
so we can see this and we can get rid of
that warning which that is not a victory
want to ignore that warning which is
well for now let's just drop it inside a
local variable so doesn't complain and
it's gonna complain about that anyway I
believe no that's fine
so we break of R in debug mode so break
we are debugging just helps us for
quicker caching if there's an error have
we forgot to turn on throw on all
exceptions deserialize is a valid word
for us at least I'm bothered about let's
just add that to the ignored words
serialize if there's none expected
overton we should never get to hear well
yeah we should never get to there so
that shouldn't throw now so we get DC
lies the response for SendGrid response
equals Jason convert got deserialize
object of by singing grid response and
it's the body response so I should get
from that now it's a nice bunch of error
messages that we can provide so to be
honest what I think should actually do
as well is there should be a list of
errors because the map will be important
you know it's not necessarily one error
so this ministry errors and that is also
I guess errors crash mark dot count we
want this to not be known but also not
be empty so it's successful if the
as I'm just trying to think the logic
back to front here I'm not sure if we do
and knowable because if it's nor is
gonna return here so we want an inverted
logic basically to be assure of this
logic so if that count have not the
errors so that's if that's false so
that's null return false which will then
return troopers we invert it otherwise
at the count is greater than zero
and it's true we invert it what I want
to do to be honest we can test this out
so doing that way if we did Evers count
is less than into zero we concern here
is the knowable whether there's no lab
all of its null is gonna return
successful as false because if it's null
it's gonna return false let's just
double check that logic by making a new
class first let's just start up here are
any course true bout me logic new same
grid a dart errors it was new so start
at this point and go after and we'll
check when it's not
this is gonna complain there's another
minute just return a new one there after
the minute still get a complain they
complain about now as it calls from new
list of errors new array with one error
and to be honest we could do that simple
if you want to that's fine for now that
is not really going to just complain
that it's actually gonna throw I thought
I'd only got that on a warning now I'm
gonna stop on an error to do that hmm
it's going to throw me off okay we just
got to comment that out for now and
check once then check again after so
where the new response come on getting a
bit annoying
we're the new send email response with
null successful should be true so see
there's the issue successful is false
because the knowable so we can't use
that simple logic so because if it's no
so we're gonna have to invert it and say
if it's greater than zero then that way
if that's false then the logic should
now flip back to front whether it's no
or not so this time now successful
should be true which is and then we
should also be able to create a new list
of errors and it should still be
successful because it's an empty list of
errors and then finally we can add say
see still successful and finally if we
now add to a bunch of errors or rather
huge one I'll do and it can be an empty
string as well this should now say false
so the logic set up correctly at that
point so that's one thing you have to be
careful of negative successful false new
stuff be careful of with nullable
statements that look fairly
straightforward like you know to glance
checking if you know the count equals
zero that you've got to realize what
happens here this this gets replaced and
says if air is is null then you return
false at this point which means
successful false based on it being no
but then of it returns the less empty we
turn true so you have to just really
understand you know what the logic is so
the way around that is to invert the
knowable so that it always matches so
we're saying this is checking if there
is an error so that when this is true
there is an error so if it's null it was
returning false which means there isn't
an error and if the counts 0 or less or
which can't blast both the count 0 it's
also false which means it's in ternary
then you invert the final result so
hopefully that makes sense it's a simple
thing I'm just probably not explaining
it very well so just a simple
for successful so we get there we fail
we deserialize the response and now we
can add any errors to the response so
that would be VAR ma response organ just
returned well in fact what we want to do
is say this did fail
we know it's failed because it's not
successful there but there's no errors
then we'd want to make sure there is an
error otherwise we'll say it's
successful with no errors so we'll say
for every response it was new send email
response and we'll say the errors equals
SendGrid response question mark dot
errors dot select and we just want the
message from them to a list so that
we'll get the errors make sure we have
at least one error so we then say our
response have a response the errors
question mark count or response dot
errors count equals zero then add an
unknown error so we'll then just add
every sponsor errors equals new just in
case it's no and then yeah we'll do
unknown from same credits again that
might not be the message you want to
send to the end user but for now that's
five for us or in fact unknown error
from email sending service
please contact dr. support and that will
be enough
and then localization is needed here
again so that will make sure that if
it's not a States could have accepted we
know it's failed we dis you realize the
response in a big crash is doing that we
return that there's an unknown error
occurred otherwise we do get the
response we extract the errors from it
and we dump them into the errors we then
dole check we have some errors and
finally now we return the object which
we know for a fact will contain errors
if it's failed so we should fail so
let's step this whole logic through to
here where it fails and run this again
and now we should end up with a response
from our call that actually does say
whether it's successful or not and it
contains the response back from send
grid with the correct info so the
response should be that bad request
which is said that fails is jack so then
we get the body result we deserialize
which has worked we've got an errors
count in there with all the details so
this will now form a response in our
format that says it's failed with the
message does not contain a valid address
so it's it's a it's a good enough error
message because we're gonna directly
from send grid we could handle them all
specifically ourselves but for now
that's a good enough response that we
handle whether it failed or not so this
call really
I feel handles the SendGrid API you know
well enough that we can send an email
and a bit succeeds we return its
successful otherwise we return the
errors so the thing we want to bake on
top of that now is another service that
we inject that specific for sending you
know very specific emails things that
are custom to our Fassett a word
obligation one of them's like you know
send a general email and that's very
specific to our application that the
general email will include a header two
pieces of content to button you know so
there's there's multiple types of emails
and we want to wrap that poly tin from a
template in
location and go from there
so for that will make another interface
and we'll call it the email template
sender and that's in core and this is a
public interface sends emails using the
email sender and creating the HTML email
from specific templates and because
these templates are all going to be like
I say very specific to our application
the calls inside here will be very
specific so this would be say send
general email and this will have the
send email details and we'd also then
have to have the custom specific info so
the one thing in here that would be
slightly different is we wouldn't expect
them to pass content because we're going
to replace the content so it's kind of a
you know a piece of information they
need to be aware of other than that
level that will have the title content
one content two button text and porton
ill and this would say sends a sends an
email with the given details using the
general template and then we could have
a template provider that then we inject
and add you know set templates that we
can then read from a file system or
wherever else we want but for now I'll
probably just skip over that and we'll
add a file system afterwards so the
email message details and and then we
should also mention note the detail of
the content property is ignored and
replaced with the
wait so the title of the email off the
title because it's not the email it's
for content the first line contents the
second line contents the button text and
finally the button tail so now we can
implement this service and inject the
series the same so jump back to start up
we have same grid extensions so we're
gonna have this time we should make a
subfolder in here called SendGrid
chop them in and we'll now make and
templates and this is where we've gone
this templates under this will just be
the way templates actually add a class
let's call this email templates and
they're just our generic standard one
which can just live here for now this
will implement the I email templates
under handles sending template these
emails template did I feel as a word
that we should now add to our language
so there we go it's now in and finally
the send email so for this and again to
break this video up into sectional or
rather to break the series of these
videos up slightly what we'll do after
is add a local flat data content
provider so basically something that can
provide files off the local system so
kind of a datastore reach for the server
but in terms of you know directly
directly on the file system not in a
database and then that's where we can
store the templates so instead of doing
that will directly just read from
read from a folder for now you know I
conclude it here and then copy over and
read for now just to keep it simple so
that's what we'll do we can add it to
the WW root folder so it's a file but
you know we'll sort that out in a minute
we'll just read straight from a file for
the minute
so this should also be called a sink
because it's asynchronous and that's not
renamed when I've done that some reason
that would be a Singh what's it
complaining about now method must have
return type oh yeah of course we should
actually then a wise saying we need one
and this isn't saying when you want but
we do actually need one good to send
email response and oops there we go so
now it's a response now it will say not
all copass but you know value correct so
this will be also need to do is read
read the general template from file and
then that'll be it to do replace with
IOC black data provider so what we're
gonna do I think if we just add two here
for now I'm add existing item and we
don't have that file in there just yet
let's chop up violin so if I just go
into email templates paste it in it's
already gonna be included actually so
we'll call this general template cancel
that just open up general template this
is just the compiled one that we saw
tackle we'll just remove actually notice
that in there then style we no longer
need them now that's gonna be added for
no reason I have because they're all in
line then we need to now replace the
verify email header again here so with a
- - title and then this would be doctor
content 1 this will be doctor content 2
and then we've got doctor button ill and
finally here after one text so we've got
that we have this here not sure what
we'll do with the build action here so I
could read an embedded resource or we
could do content so let's just make this
embedded for now like this is definitely
a temporary solution so we've got
embedded journal template but how do we
read this again I'm les in a while so we
need to read the stream so 100 reader as
a new stream reader and and the resource
stream that is assembly dot get entry
assembly that'll be you know disassembly
there the server's assembly that's fine
um then I think's getting money comes on
that's not one well get money first
resource stream the name is the name of
the project so it's this dot and then
the folder we're in email and then so
folded up templates
dot general template dot HTM so that
looks nice and nasty it's a good job
it's temporary
utf-8 is the encoding coding utf-8 I'm
gonna be happy with that okay so that
nasty mess should read us from the entry
assembly which is in this one the thing
that started hopefully and then get the
money first resource stream and that
just means look for an embedded resource
which we just set that to and you do the
project name first which is this and
then each folder separated by a dot
which it does and then the name of the
file
so hopefully this would read us the
contents so far template or rather what
we should have here is our template text
equals default string and then set it
here template text equals we do not read
to end and it should be all strings we
make use of the async one read file
contents let's just return for now a new
response just to test it works this far
and then we'll go from there once we got
the contents so it's just now add email
templates sender we want to extend your
methods for as well so we want email
template sender extensions and we can do
very much a copy of this extension
extensions for any send email templates
under classes and then we'll just copy
this in to here injects the email
templates under
into the services to handle the I email
templates under and that would need that
I gas using for Sutter doc work or to
show that there we go we also need the
dependency injection and now this will
be add email template sender and the
reason we're doing all this work is to
as I mentioned keep the the
responsibilities of each little module
each little interface very specific so
we are now an email sender that we can
be placed to send by a send grid or send
by a different mechanism and we can also
send templated emails without we line on
the underlying email sender so now this
can be replaced that the place we read
emails from construct them into a piece
of info to send and pass it down so
there's a you know a good reason for all
this that class needs to do static it's
that now has the email template sender
so now if we go finally to the start up
go up to the or into the configure
absent grid sender add general email
template sender services dot add email
templates under so now that's a service
available just like the other one and
instead of calling now like this and we
cut this or copy this and then here we
change this to I email templates under
and now do send general email in fact I
shoulda left that in there should have
just pasted that delete that now the
first pet we do is send the same info
and now we can add the specific so the
title now is going to be verify email
this will be high and then once public
for now to match the original one that
content is going to be
we'll find out we'll just match the
thing so we know the templates working
basically so this will be this in here
and that would be a HTML break at that
point then we'd have the verify email
content one content - and obviously this
would be pulled in from wherever we want
and put in the right place right by
email and then finally the Earl which
will generate afterwards so this should
now say send it via a template we should
have all the info passed in just the
same so now the templates and doors it's
got to do is read the template to mental
maps or finish the call at that point so
we read the templated text replace
special values with those inside the
template so this would be template text
equals templates techstop replace and
we'd have title title you can see where
I'm going with this in fact you could
chain them so it'll be doctor place
content one content one whoops one
percent content to button text button
ill
we can see all you've done there is
there's done the job of what Sanford was
doing for us so now we end up with the
same template with all the injected info
and finally we just have to send the
message and I will return the awaited
IOC containing a dot and again you
wouldn't do provide her dark get service
as we're doing now instead what we'll do
is we'd add it to here so we have as
I've got here scoped instance the
transient instance of the email sender
and that is using force after dot word
call and this would be email sender I
email sender and we get the service
email sender oops pop transient wrong oh
yeah
no no CNN and then copy and paste that
and call it email templates under and
there we go so now we have shortcuts to
it to say IOC dot e mail sender dot send
email async and we just pass in the
details up one lustre set the details
content to this template content so now
the details got content gets over in the
templated text send email and then
finally we can now go back to here and
this can be replaced with io c dot email
templates under dot send general email
so finally all this should boil down to
being injected and callin to here and
then we should read that temporary HTML
that we store that somewhere else get
the template replace it with the content
and send off an email hopefully
how that actually worked I didn't expect
that to work so ago templated text we've
read from the embedded resource now
which is put in there we have our
special tags which are like there they
should get replaced so if we then go
over replace them
check out the content once more we
should now have in the header we've now
got the content then we've got high Luke
and then the detail so this should now
be ready to send that should all send
and hopefully work
oh we've forgot that right now we've got
the wrong email and that doesn't exist
thought it happened quick just try that
once more
and that I forgot a breakpoint I've
removed the breakpoint well it's gone
anyway forget the very point I removed
it let's check the emails so that looks
like the email and something messed up
because that's not quite the same
which is interesting the in fact yes
something's definitely
I wonder it's because I've removed the
styles and the styles were actually
helping out so even though we've
embedded the styles that we did tweak
the we did tweak the email content let's
just tweak that back and re include the
styles but the important part is we've
got the verify email the name the info
the link it's all actually worked so
let's just delete those offspring out
confused and close that down open that
back up just go back to email template
and copy this style back in cuz that's
the only thing I removed a morning
whether that's impacted the email said
that technically tweaked the email so
now it's back to what it was exactly the
same if that doesn't work then
potentially the format's not utf-8 which
saved them run that once more
opens up so that should be done so let's
check the emails again and there's now
the email so yes that in leaving the
style and that did actually seem to to
help out so we'll we'll leave that email
as was but now what we have is a full
template email that we can change and
put content in so let's delete that one
and the last step now to this whole
setup and this has been set up correctly
now so we've done it in a very modular
way and using dependency injection so
that all these little things are
individual and can be replaced so like
now that the templating system can then
rely on here reading from our flat data
provider which is where the templates
can get stored afterwards and also the
sender is called directly and that can
get replaced so we can replace
individual blocks of our you know
program code and that's kind of one of
the benefits of dependency injection and
we've put all that to do is where we
need to replace things so now let's all
get as a template or get sent we've got
all the dependency injection done got
the error handling done so the last part
is to really cut this out here and go to
the API controller finally here where we
want to send the verification code so
email the user the verification code so
here we can we probably just want to
make a helper function that sends the
verification code to the bin of the user
as opposed a general email so we've got
the same thread we've got the templates
then we're following on one specific to
you know this web server so this is now
going to say you know send verification
email and passenger to user details so
we'll call this the peseta
email sender and this isn't going to be
injected because this is literally
specific to this web server itself it
doesn't go outside of this web server so
handles sending email specific to the
receptor word server and now all's us a
lot to do is public you can get a
response I guess just in case you want
to use it whether it's in your TAS
but to be honest it'll be self-contained
really it's just that you know the job
of this is to send the email it's kind
of a true or false and if it fails it
should also be responsible for setting
some properties in the database to let
the user know through when it asks for
information it knows something's gone
wrong but that's again further down the
line so for now we'll just reply with
the email I can't think what it's called
using word core oops and email send
email response that's it
this will then say send user email
verification or send user verification
email I don't really know what to call
it's really a email verification email
but that's doesn't look like to send use
it verification email so I think that's
what we'll do the details we'll need
about the user we can either just pass
in directly as strings or we can pass in
an identity but to be honest we can keep
it as simple as because I don't know
where the data is gonna come from
we'll say user name or rather first name
of the user or display name of the user
so if you know hi somebody and if it's
not we can substitute that then we'll
have the just paste this in before my
thingy gets over and wait that what do
we need any display name content that is
no longer needed there is HTML is true
from would be our email which again can
come from settings somewhere so for now
we have no real settings like general
set and we'll check it in the
figuration here this will be I don't
know for Seto setting to say and in here
we can have email from send email from
email and that will be let's call it no
reply of Prosecco calm and the send
email from name here's a settle word
then we can get that from email using
the IOC dot part IOC container dot
configuration is just set directly so
we'll get the configuration there and it
will be the if I remember rightly I
think your shoes have : - just jump
inside nice and quickly without having
to do anything more complicated so I
think that's it I've got the from
details and then the two would be the
users email so that's one thing we need
so that will be string email so that can
be replaced display name display name
subject we don't need to pass in cuz
that's under our control so I can come
from settings again just somewhere to
store it for now until we you know
decide on the best place to put these so
send email this will be send email
application send e-mail verification
subject or to be honest this is kind of
this is sending the verification so we
can just put that straight in here for
now because this is this single call as
the one that's going to send the
verification email just can put for seto
word verify your email or do the other
way around so it shows the start
and then the the top bit is verify email
there then it's hi and then display name
from one high displaying thanks
repeating account those two please
verify email about by email and then
finally this needs to come in from here
which will be string verification ill
application error and that will come
from me you know the specific request to
send a verification and that we can just
return for now and that it's gonna
complain that wants to end in the word
async still going to complain not to
call an instant remember a static class
that's going
static itself there we go the seto is
apparently not in the woods
really oh yeah who would never even a
deeper sat over the detriment right so
now we have sends a verification email
to the user to the specified user so the
users display typically first name and
then also what we'll do for the display
name is if the display name is nope
so we don't know it then we'll say
instead stranger so I'll say hey
stranger
as opposed just hey and then blank so
we'll always have something there
because we don't have that first name
right now we're gonna ask them on signup
to enter the first name they use us
email to be verified the Earl to send
the verification email or rather the
Earl the user needs to click to
by email so now we can just call a
static class to send this and that'll
wrap all this in a little helper we've
set up the settings here to tweak their
pieces of info specific to the email
sender so that's customizable we could
also remove that from the content being
passed in to send email and have that
baked inside but to be honest it gives
us that flexibility to change that
anywhere we could also default it if you
don't provide it it defaults to these so
we don't have to specify but again as it
grows we'll figure that out so now if we
then step back to our work all you have
to do here say for certain email send
the docs send user verification email we
don't want to await it because we don't
want to hold the usual while sending an
email so we'll ignore this but in order
to ignore a task correctly really you
want to await the result to catch any
errors you know that throat otherwise
you don't know what to do with the
errors but we'll sort that in a minute
display name of the user we don't have
so that was Ben all right now the users
email we have user identity dot and in
fact you could change this from page
strange to hear you and then the
username actually but we'll try it with
null first to check that works and I'll
swap it with the user's username so
we'll do an email and then the
verification Earl is the e-mail
verification code so don't want to
generate confirmation token I wanted
generate email well I want to generate
the ill not just the token generation
email confirmation token so now we want
the actual it oh and of course we've got
to do that part of it so once we've got
that we also need to handle the oil
coming back in to validate the the email
that's another call we need to make so
that's just I won't take long just make
a public async task
well the balance is going to be a review
action result and we'll make this view
in another video you don't need to make
the view for this one task of fight we
don't need to be a task action results
vary by email and that will be for now
route because we need to put these on
their own little Maps API verify email
and I can do ID and then string ID so
that will get passed in verify if the ID
matches yeah I need to pass in the user
ID as well first actually sucks user ID
and then email token I guess this would
be user ID email token so first you get
the user so wait in fact this doesn't
need to be a Singh that will not be both
by email async I've got the user manager
dot find by ID user ID so VAR user
equals if the user isn't known then we
need to return and this is a visual when
they click the tail this is a visual
would want to tell them to you know in a
page that we haven't designed yet so for
now we're just going to be termed box
standard plain text we haven't done the
UI front-end and we don't really care
about now for that so it fails what
lipid return content and we'll just say
user not found and then after we face
that with proper UI so to do a nice UI
if we have the user
now we want to verify the email token
not same thing again verify user tokens
it the no it's not good if I use a token
confirm I'll as I confirm email so
confirm email async/await and it wants
the user which we now have and the token
which is email token and what's it
return returns don't know it's returning
an identity result which is to proceed
you are so if succeeded
so if result that succeeded return
contents email verified and then
otherwise invalid token and a sub base
and then the same again some nice UI on
the returns so that should be that's as
simple as it is to verify this should
now verify an email so we need to point
them to this this API root for now and
again we wouldn't copy and paste this
once we put these into an API routes
class that contains all the routes we
can make use of that exact route but for
now we'll just use that so we have the
confirmation token confirmation or
equals and then this would be the Earl
to the whole website for now to do with
place with API routes that well contain
the host contained the static routes to
use that's got to be it to do until then
we need to include the host that we're
running on for such API process email
forward slash user identity ID forward
slash that email verification token and
that would be the ill and to get that we
can use like cousin to get the ill what
currently running on it will be request
dot and that will probably best break
pointing and and taking a look at that
so we know if let's just put a
breakpoint its comment that out in fact
yeah comment that but out that's fine
come back to that bit and let's hit up
just say the homepage minute to find out
what we need so go control us home the
index and bar a equals request and let's
just inspect the request because what we
want to do is get the localhost colon
and and poor name which will effectively
change whenever the pages change but you
know we want the actual thing there
send really could not pass the JSON file
have messed up the JSON file and ii
forgot a semicolon
it's got a call on there let's try that
again
so we hit there we get home page and our
request
it's just do a quick watch on this so
the request dot host dot value looks
like what we need so request that host
our value is what we'll use for the earl
and again that will boil down to being
inside of it specific well to be honest
that's actually fine all the time for
where we are so in here we can now do
request host dot value
and then the foil start with the
confirmation air that can be passed in
and that can now be the fault ill and
this I mentioned we're not awaiting so
we don't have a result so what you want
to do is do a cast run and wait it
inside here and it's going to complain
about that as well because we're not
awaiting I'm not sure how we get around
this warning as such we can we'll make a
helper function to run and log the error
which I don't think we've got already so
cast off Ron it's going to be a hell of
a lot
I'm just running weather I already made
a helper task manager so in fact this
already runs and logs bought do we have
kind of a run and forget no and we're
not even making use of this class
managers don't run either which
automatically logs any errors and throws
them back up bought ok for now let's do
it's a rare case where you want to run
them and not await them and to be honest
you might as well wait for how long it
takes to screw it let's just await it
for now saves any other hassle and re
catching errors and things so let's just
a wait there the verification email
being sent so I'd like so I can't see
taking that long I was finally break
point here run and we will register for
an account so I think we've already gone
a camp let's just make a new one up how
did we go jester now I can't remember
have you made any UI or will be hit up
or did we run it through we ran it
through for SATA word didn't we sawed
off to spin up for set a word so we run
for set a word now and where did we have
where do we even put the calls
so we go to the view models application
register and we just might happen in for
now so we can use we run this while
we're running the server which is
running at the minute we should get into
a register call here so let's go back to
for such a word
this is got errors now that I upgrade
the modules so same as before right
click on solution manage NuGet packages
for solution
select all update keep everything up to
date and this is the one that will
probably fail on DNA framework just got
the one file rename for the change in
names we go to a sam'l dot CS i believe
and use i believes change to add now and
then we should control ro and we named
our to add just keeping more in line
with the way the asp.net core does the
same thing so now it's building it runs
will probably up to logout which doesn't
logout right now and we want to register
free account so username test email
contact dangerous six calm and just a
temporary password and register this
hits here it's gonna go through the
normal steps I think we might finally
already have a user with that name so
it's probably gonna fail yep false so
then it's gonna complain that we already
have a user so let me just wipe the
database a minute so it's good databases
for Seto word client that's how it
settings and that was why both so it's
white for Sato word and while I press at
a word client
and then we'll have no data whatsoever
then we better restore both things so
restart the server which will now have
no user database so we should be fine
creating a new user and restart this and
I think we should end up back at the
login page because we've never logged in
because I've just wiped the database
that contained the login or not always
that's just temporary but to restore
that why did we store the locking
credentials once we logged in it's been
a while we logged in handle successful
login client datastore save login
credentials so yeah how is that even
how's it even taking us to a login page
when we have no database anyway
let's ignore that for the minute it's
not important go back to here create an
angel 6 contact angle 6 calm and login
now we hit here we should create the
user fine because it doesn't exist so
that should now say successful there we
go we get the user identity which is
that we get the e-mail verification code
generated which we haven't awaited
typically I'll start that again and I
should delete the database again because
now we've gotten a user in there
and I think the start that back up and I
think the peseta word application must
have we must just go to that page by
default I remember rightly because the
application view model which stores
their current page now should begin to
login that's actually interesting that
we are oh sorry no ignore me we're not
using that we using a local DB that's
stored in the updater that's why I let
me just delete so let's just delete the
first other word DB and run that again
and then now we should get to the login
screen and we should got a fresh
database with a server so we finally
create an account sign in or rather
create it first send that off the server
should pick it up we get to here we now
have a verification code which massive
generator nail which is going to be huge
but who cares
so our verification L so it's got the
server for such API for a very 5-4 slice
email which is a simple the Yola hits
first then the next there is the users
ID and the next there is the token that
should now get sent so after we hit this
line everything else is normal that
should pass over a presume it succeeded
we didn't both again the result I should
get an email in a minute
that's the account registered then when
I logged in we've got settings which are
all here we should sir in the settings
whether the email is verified it should
be like I guess green or red or
something saying that it's verified or
not just a tick but that should be sent
off now so let's just check the emails
so you can see we've not actually got
the email so we've got verified email
hi stranger which is what we said we
wanted to use it first and we'll change
that to the user's name please verify
and finally this is a natural link that
we can click now so if we were to go to
the server we know that
works and we should also add the ability
for resending of that oil but for now
that now actually works and sentence we
now want to get to the verify email ill
here which we should hit when we click
this lets link now in the email we go to
the email get some spam and click verify
email it will open up a web page so of
course I need to open it in a store
really I need to open a local ill oh
we've missed hasty TP off so delete that
do once more feelings pause delete them
and resend that email with the HTTP
appended so I'll just add two here
because it doesn't include the protocol
HTTP run that up again I'll delete the
database and do it or gap and now we
have the email again this time with the
HTTP we click that opens up the ale and
I'm hoping we've hit the breakpoint now
we haven't user ID email token so we
should have hit this ill instead what
are we getting just a 404
yeah 404 so API verify email as it just
expecting a post all the time as opposed
a guess we've got to explicitly tell it
it's a get well that's now close that do
HTTP GET run that up again we don't need
to resend the email now it's you know
we've got it
so we know that the button link works
and we know where it's trying to go to
so now we're just resolving that so we
click that still getting 404 it's
something to do with not encoding the
ale a be yes or something do with the
ill and coding so what do we have we
need to safely encode the ah that's why
because the details also contains a
forward slash so the user ID basically
to elenco
in the nail decode this piece of
information to make that work so we will
need to and this is now we'll have to
resend the email Bracken I can generate
that and pause and redo so what we'll
need to do here here's I think it's on
HTTP utility dot ill yeah L encode so
with patties in oh there we go string so
you're talking a string and we will
encode it and this basically means that
anything in the oil is safe to go into
an actual web address so anything like a
forward slash will get replaced I think
it's just a base64 encoding and then
we'll do the sync the e-mail
verification code just to encode both
parts so now that should definitely get
through so I'll just pause on resend and
delete the database and get a new email
spinning up and now we have another
email and this time the ill will be
slightly different doesn't actually look
any different but let's just click it
and see there we go so it is different
so now we've actually hit here so we
went backwards yeah you can see that see
the details has totally changed and
they're like the plus there is change to
a percent to B so that's correctly now
encoded it's never got the user ID which
is come back and we haven't little
decoded it yet so we have the details
that's been ailing in fact us ill
decoded by default I believe we'll soon
find out so now do we get the user yep
we do so it's already ill decoded for us
on this side ready to touch anything so
we've got the user and we've got the
token so let's see if we got a
successful verification and it failed in
valid token so why is the token invalid
maybe it is the ill decode on this so it
doesn't actually like ill decoding on
that so we should see the
it's different each time what we should
do is Earl encode and decode a minute to
see the difference this is fun we can
also just do quickly just to see equals
HTTP utility dot fill decode and passing
the token and let's see if that works
just out of curiosity to see oh it's
just not decoded but I feel like it has
decoded so we just click the email again
just to get that back up and we
originally have CF plus sent to so
that's now changed with the space
instead of a plus so I've got a feelin
that's also screwed up the token
yes that's failed so let's just pause
this a minute and resend the oil token
I've got up in the old decodes met in
fact let me just go to the home page
first let's figure this one out and on
the index let's just say get my user can
we do a first no fine by name so here
I'm going to do angle six async task and
index async for now then we await and
just do user dot M user dot generate
email confirmation token the user or
token equals and I'll just mess with the
token bar-coded
equals HTTP utility it's a little
utility dot L and code and pass on a
token and do decoded equals LD code and
this will be the encoded but I'll put
equal then we'll just combine the two
just to visually see what's going on and
like a nice easy output this would be
system dot environment a new line and
put decoded and I could do a comparison
I want to see if they are matching in
the first place what's going on so we
know to spin up this and see we'll see
the original token the encoded in the
decoded and in fact that was the wrong
way around anyway I just realized I
output the token and that's also not
working because of the index index there
and screw this because that's
complaining for now and do tasks are on
top it's inside of a task and it should
be token and decody don't see the
difference it's in fact let's do token
and code each token decoded and then
just truck the encoded at the end for
the swell know that there needs at the
end so what's this moaning about now
index
there we go so set this off hit the home
page and let's take a look at we missed
the break point which is already gonna
run by now other thoughts there yeah so
the output now is we can get it on one
big line to me that looks the same so we
don't word wrap that is now successfully
encoded and decoded so we know what
we're looking for so this time if we
pause keep a log of what's been sent and
then confirm and find out what's what's
messing up basically so I will now get
the register what we'll do is take the
register call and it definitely does the
register and instead of keep deleting
the database let's just chop in this a
little bit here so we can just keep
rerunning there so we get there then
user then we generate the token generate
the dl and we then send the email so we
can pause here keep a log of the actual
email that was sent see what email we
get and see what we get back in and see
what parts break in here what's what's
sending the wrong info because something
is so the e-mail verification token that
we want it's this and now let's see what
we get so that one I've send away and
we'll get an email click the new email
and let's see what we get firstly let's
get this bit which should be the
encoding part over the bar that's still
all encoded and I've got a feeling it's
removing the Pilates altogether which I
think actually I've come across this
issue before
which is quite annoying actually I do
think this is a fairly common issue and
then we go to now the email bit here I'm
pretty sure when it comes in let's see
what we get this is the not met with one
and in fact that looks valid now so it
has it ill decoded so you can see now
it's all decoded bought you can see it's
actually partly not done it right so
there's actually % 2f there which should
be forward slash which is a Anil decode
things will be replace the forward slash
I'm wondering whether he's just forward
slashes are messing up which is
interesting because I guess he thinks
it's part of a nil it's it's the way
it's coming in so yeah it's the forward
slash is in the token that are getting
messed up which kind of makes sense in a
way so I think one fix might be to if we
put a star I think is the key at the end
of this that simply means I think it's a
star there I mark your star there I
forget to try a star there first and
that just means nothing else can come
after that point I'm wondering then
whether the oil decode will work
correctly then so that's not a valid
feel so it must be the star outside
because I don't want to have to hack
ecially fix an email ill token from
having forward slashes so I'm hoping
this way makes it work now we're gonna
have to click the email link again and
hopefully fingers crossed
actually nothing's coming this time so
it's that's now stopped working so this
is still not got the right ale so did a
quick google and turns out this is a
common issue that I thought I'd seen
that's ongoing and still open so here's
the issue that I'm gonna link to code
this is all talking about that exact
issue
they're basically ill encoding and
decoding is leaving the forward slash so
unfortunately it looks like it's a known
issue so what we'll do to fix that
it's already decoded we don't need a bit
corporate note issue at the minute with
Earl decoding that contains forward
slashes does not replace them paste that
in and then before now manually fix that
so the email token and this is a that's
rare you ever have to fix anything with
dotnet it's usually very very bug free
well this isn't outstanding issue with a
minute so what we'll do instead is just
replace percentage to F with forward
slash and also just in case okay so
anything change using the tweak anything
between now and then the uppercase to F
as well and replace that way of forward
slash so now that should fix the token
and we should end up with the same token
we don't need the star anymore and we
should now get hopefully a valid e-mail
verification after all that so now we
hit this exact same link up that was
emailed to us we get hit into here the
token now should have been replaced and
you can now see the forward slash way it
should be
so just to double-check this the old one
the original is at the top which what's
going on here well anyway ignore that
now but so lost that note file so we get
the user we tried to verify based on the
token and finally succeeded so
unfortunately was a little bit slow
thanks to a lot of bug in the dotnet
core side of things but now that will
spin up and verify an email so now the
last step to I gets confirmed that is if
we were to open the database and look at
the user we should now have
a verified email so we go to database
for Sato tables yes peanut users do a
new query select all and from AFP and
that users you can see now email
confirmed here
so we've now finally confirmed the email
so that seemed a bit long-winded near
the end but we got there so what we have
now is when the and let's just remove
from here the template code to make sure
I don't accidentally commit that we have
a system whereby we can provide a new
route where you can verify the email
which is simply an ill that gets the
user ID and the email token passed as an
email so that the user can just click a
link we verify that and just simply say
confirm that it's opens bat lead and if
so that's it job done it's all done and
then inside of the register function we
just made all the helpers around sending
an email and using the token at the
template we made and made it all modular
in the correct way so that we can have
you know a static send verification
email which makes use of an email
template sender which makes use of an
email sender so it's all nice and easy
to expand upon so now when we come to
make new emails that'd be much much much
quicker we've now got a simple way in a
simple mechanism to send and receive
emails I will replace the SendGrid one
with a direct SMTP for those that want
to simply use their own email address to
send emails and just enter their
username and password so it's kind of a
free way without having to you know pay
for anything at all
you can still use the send grid one for
free for up to one hundred a month so
it's kind of in there and then obviously
I'll just pop in here
so I don't forget again replace with
your SendGrid
key and then we just won't commit that
in to the database
so hopefully this refutable again anyone
wanted to support what I do can support
me at patreon.com forward slash angel
six any questions or comments on the
video let me know
and I'll get back to you know all
comments but hopefully this was a useful
video and walk carry on in the next one</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>