<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Jean-Yves Perrier: Today: Making a browser fast, the story of Firefox Quantum | JSConf Iceland 2018 | Coder Coacher - Coaching Coders</title><meta content="Jean-Yves Perrier: Today: Making a browser fast, the story of Firefox Quantum | JSConf Iceland 2018 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Jean-Yves Perrier: Today: Making a browser fast, the story of Firefox Quantum | JSConf Iceland 2018</b></h2><h5 class="post__date">2018-04-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Frwe3x8HfwE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so hello everybody I'm really exciting
to be here and to talk about how browser
makers are making brother fast and I
will use Firefox quantum as an example
of how browser vendors are modifying the
browser to cope with the 21st century
most of the things that I'm about to say
is also valid for a lot of other
browsers but I'm taking the example of
Firefox content so I'm George Bailey I'm
part of developer outreach at Mozilla
and I have a Twitter account so the
story starts a little bit with how a
computer works so at the core of the
computer there is a processor and
processors have evolved over the years
very quickly initially in the 70s 80s
90s of last century there was something
called the more low that was basically
saying that every two years or every
three years your computer becomes twice
as fast as previous which was very
convenient for people making programs
and browser in particular because you do
nothing and two or three years later
your browser is twice as fast it's kind
of free lunch lately at the beginning
was second decade of this 21st century
people are seeing that processor or not
I'm not really doubling the speed
anymore each 2 or 3 years it's still a
little bit true for the high end
processors but in fact it doesn't really
matter for somewhere because we are no
more in a point where we want the web to
run only on the high end processor most
of the time you want it to run on such
device and it's not the latest the most
powerful processor in it because as the
battery will just last 5 minutes so
processor has found a different way to
increase the calculation power and it's
by having more calls
so more processing power in parallel and
the difference here is there is no free
lunch program has to adapt themselves
and to make use of this multiple course
of this concurrency that is now
available at the same time on two
browsers what we want browsers to do has
changed over the years so at the
beginning it was just displaying a
document and even in 2005 if you were
able to put a few images and making
rounded corner or on the box
you were top-notch developer it's not
the case anymore today and what we want
today is to have HD videos running with
transparency effect with rotations and
you want all these to run at 60 frames
per second you want all these to run on
your virtual reality headset which means
that in fact you need more than 60
frames per second because if you want
with a virtual reality headset not to be
to have motion sickness you need at
least 80 if not 100 100 frames per
second in order to achieve this in order
to cope with this browser had to adapt
they were designed in the 80s and the
80s and mostly at the beginning of the
90s even if they have evolved of the
years it's not the same architecture
that is able to run so modern web so
this story today is about telling you
what browser vendors are doing in order
to make your website view web
application faster even without you
having to do anything the browser is a
user agent and in 2008 we used this
robot for the launch and 543 it's a
friendly robot but of course over the
next decade it looks a little bit clunky
is it still
user agent that we want to have on the
web so the question is what a modern
browser is doing in 2018 sorry first
part is how does a web browser work and
especially the rendering engine so this
is quite important to understand a
little bit so that you understand what
changes are happening so the first thing
is your browser is downloading pages its
request handle on the web and it gets
HTML the JavaScript the CSS files and
just pass all these into an HTML parser
as a JavaScript engine the CSS parser
and what it does is to generate the Dom
of nodes so each time you modify the Dom
of nodes the whole process starts again
not downloading but what follow up so
with the CSS the first things to go in a
rendering engine is the stein engine the
styl engine take the CSS and applied and
define what rules are applied to each of
the boxes it doesn't apply them the yet
but you just defined what has a set of
rules that match each element of the Dom
when you have this you add all the media
so the images videos and you can know
the size of the images the size of the
videos and when you have this you have a
face that is a layout which is in fact
defining where on the page will be
displayed each of the boxes you have
several layers because they can be on
top of each others but you don't know
yet what is inside the layers and which
layer is winning the next step is a
paint so this is to apply texture on
each of the layers that will define okay
this texture is the video this texture
is the image this texture is just a
background or some text from this then
you have to define which pixels are
visible this is the next step and the
last step that is a compositor and then
you go to your page on the screen
and each time you modify the Dom you
have to go through this process again
for years and years browser have already
optimized this part by only redesigning
or redrawing the part of the page that
are actually modified when you change
the Dom and not the whole page but this
is really the big the big an important
element atmosphere in order to improve
this we wanted to test new algorithm and
we wanted especially to work on
parallelization so what we have done
first we have created a new language
called rust rust is replacing little by
little the different part of Firefox
written in C++ by by this language and
this language has been designed to make
the writing of of codes that can be
executed on multiple core on multiple
thread much much easier with less errors
than C++ and so that's really important
because a lot of people are contributing
to the code and if even if most people
are really good programmers they do Aero
but you can also get patches for
programmers that less experienced and
they will not do the basics common
errors we created then an experimental
engine and experimental browser called
servo it's written in rust
it has algorithm that take paradism and
that allows us to check if this
algorithm are very working very well and
also it has no significant UI it's not a
real browser it's something to test if
the idea we have are good or not and
finally and this is the most important
part servo can break the web so where is
a very complex piece and there is a lot
of special cases with special CSS
properties and so on and in fact to test
the algorithm you don't want to have to
write the engine in all the detail first
you won't first validate that in the
good case in the easy case you get the
speed improvements that you were you
to have so we did this several and we
developed a lot of things on it at the
same time we wanted to solve several
other problems so a firefox had a
stability problem we noticed over the
last few years that he was has a lot of
crashes and we were wondering why it has
an old theme so like the robots that
were loop is just looking old by just
having an old theme when the UI in OSS
has been improved
it feels slow and also there was a lot
of cases where in fact the user
interface was freezing
it's called UI young and finally we
wanted to increase to have the new
algorithm so we launched we launched a
project called quantum la the beginning
of last year and we decided we want to
make a quantum leap in performance and
in the way the website are rendered
there are several things that has been
done but the first thing and I want
first to thank my colleague 9 o'clock
who has drawn this amazing drawing I'm
absolutely unable unable to to make any
drawings that looks readable by anybody
so she's doing a lot of these drawings
she's writing blog post explaining how a
browser is working
there will be a link later that allow
you to have more information so the
first things that we have decided to do
is to change our Stan engine so the
style engine as I said take the
different CSS properties look at the
selectors at the specification and in
fact for each of the boxes define ok
these properties with this value apply
to this one for example the background
color of the text color as a font and so
on this is something that has to be done
to each and every boxes so this is at
first sight something that can be
use very easily to with a parallel with
paralyzation and so we tried it in rust
on style so basically we had several
processes several threads that takes
part of the tree and makes the
calculation and of course it's not that
easy because first you don't have one
thread one process per element on the
page because are sometimes several
thousand of them so you have to give
chunk of the page to each of the
processes so that means that some of
this process are just idle at some point
because there is nothing happening is I
finished their work while other may be
extremely busy so there is a very big
complex algorithm here that allows the
different threads or different processes
to still work from the other when they
are idle so with this we created and we
validated that's a new way of doing
styling in the browser is in fact much
much more efficient but that was only
the first step because this is in
several in the experimental browser we
needed to sort out all the detail and to
integrate this into the real browser and
integrating a new styling gene in a
browser it's a little bit like doing
heart surgery but with a person that is
still conscious
you you want to browser to continue to
work you don't want suddenly have no new
release for one year two years while you
put all the wire together so we took the
stylus or quantum CSS with a parallelism
we integrate it with a rule tree from
Firefox and also we took the staggering
cache from Chrome and Safari so the
start sharing cache just memorize things
you have already calculated because
sometimes on the page a lot of nodes
have the same ancestors and the same
values so it works pretty well in fact
it wasn't working that well anymore
because lately with all
you do classes and so on it became more
complex and there are less of these
elements that are there that were cashed
so we modified so start sharing cash in
orders for it to work again and then we
just transplanted stylo into the browser
and this happened last November in
Firefox 57 and we got for this spot a
very very large improvement in speed so
style is the first technology transfer
from several it's not the first part of
rust inside the browser and it is
solving a problem that is called
embarrassingly parallel problem by
definition style engine are doing
something that can be massively
paralyzed and of course when the page is
simple you see little improvement when
the page is very complex you see a lot
of improvement browser has another
challenge each time you click somewhere
on the browser there is an even handler
going on and firing and executing some
code and you want to be sure if you want
to have 60 frames per second or 120
frames per second that all that's
happening on the main thread and
especially these handlers happening is
no more than 16 millisecond or 8
millisecond for 120 frame per second so
that means that you have to go out of
the main straight as soon as possible
because while you're on the main thread
you cannot handle the next even so
Lex even when you are calling a page or
when you are clicking and so on
initially browser had everything on the
main thread and little by little over
the years I start to take things out so
first of of them is a video decoding
that is happening now most of the time
on the graphic cloud itself there was a
plugins also a display canvas worker and
several others but what is quite
interesting is
we have another piece of computer power
on a browser that is a GPU the GPU is
designed for games is designed for the
operating system where you have a lot of
calculation to do on a lot of data the
same operation on a very large amount of
data and it's very very efficient for
this kind of things it's very efficient
for gaming on the browser we have this
kind of operation one of them is a
compositing so the last bit of the
calculation where you have all the
layers and you have to define which one
are visible or not it's the same
operation most of the time on a lot of
data so we decided in 2016 to offload
the composition to the GPU and we did it
and improve a lot at the same time a
little bit later in fact we notice that
the crash is just increased we had a lot
of crashes and in fact it wasn't the
browser itself that was buggy it was the
drivers that were Birdie
so the crash the crashes were mostly
happening on Windows and for example Mac
has very few few grush crashes because
of farlis type of divert for less types
of graphic cards and less bugs so we
decided last year to solve the crashes
by having the GPU in the graphic drivers
load in a different process so the
process crash the browser detected crash
it's restarted and then it works without
using the GPU for this part so you don't
have all the speed improvement of the
GPU but you don't have the crashes
either so that's a way we had to
mitigate the bugs in graphic drivers so
the compositor is the first part that
went to the GPU at the beginning of last
year another part is a painting so the
painting is to take a texture and to
apply it to the surface it's cool or
rasterization and we want to do the same
off-roading li2 GPU
and this is a project called WebRunner
it's not yet finished it's in progress
this is ultimate goal I don't know when
it will be finished because if you asks
management they say very soon and if you
ask the developers I say oh in several
years
so it's some somewhere in between
meanwhile we decided that okay even if
we don't send it to the GPU
we can remove it from the main thread so
we have what we call off main straight
painting just what's right for the
painting and this has been done in
Firefox 58 which went out in January so
basically we create a set of instruction
the display list that is applied to
assign to the layers and then we send it
to another process that rasterize which
is actual painting operation and then
sent to the compositor that is in its
own process or on the GPU and that way
as soon as the rasterization is no more
on the main thread so that means that
you can trace the next displaylist and
so on so we remove the bottleneck it's
not as perfect as having everything on
the GPU we still sometimes lose frames
when it's gone a lot of changes but much
less of it's no more the rasterization
the problem so this landed in Firefox 58
and there is an improvement coming the
next version into it where in fact we
discover that this Palast we don't need
to recalculate it each time for simple
but it's not the most efficient so now
we have you ristic in place so that we
don't recalculate so this play list was
a who loved the display list each time
so until now we have mostly seen
replacement of pieces of the browser and
in fact if you want to have a browser
that is efficient that feel quick
responsive you need to consider it as a
system as a whole because yes you can
have a very efficient style engine but
maybe the bottleneck is somewhere ads so
we changed a way to do development
and to prioritize the development masya
by having the moto measure all the
things then we triage we prioritize and
weary measure and we applied this and we
still apply this to fight young so
freeze in the UI and there is a
collection of 30 blog post by Asian act
Garin that explain all the changes that
happen all over the place it's it's
going on a lot of details and she calls
her name death by a million cuts we
found bugs where we had to fix ten bugs
and suddenly we get back a lot of time
each of the bug individually in the
individual fix were just shaving one
millisecond here there but no
significant difference but the ten
together we're leaving a lot of
differences so one of the things that we
change is a way we were doing is
crawling it's it's not specific to
Firefox at all and it has been pioneered
by Apple and it's called checkerboarding
you when you scroll on your screen with
a mouse with the finger you never want
to scroll to stop but sometimes it goes
too quick and you don't have the time to
calculate what to present to the screen
so you present a default value and
people instead of being confused scroll
less quickly the data appear the images
appear and initially it was a chick
abort
that's why it's called Chicka bowling so
the the X overall speed is not better
but the feeling is completely different
and those are big things that we have
changes what we call IPC inter-process
communication so it's known for a long
time that when you communicate for
example with a disc it takes a lot of
time and you don't want to do this on
the hub on the main thread it's the same
when you communicate with another
process especially if it's synchronous
communication you don't want to do this
on the main thread so we fight
synchronous communication and you want
it to have as many as synchronous
communication at all and this is where
we did a lot of merger and so on
there was for example two people working
for six months on the cookies because
cookies were needed a lot of synchronous
communication they rewrote completely
the cookie mechanism in Firefox and in
fact it was 25% of our block blocking on
inter process communication and on big
website when it was fixed like Facebook
is making several written write several
times per second to the cookie store in
this website like Twitter or Facebook we
were able to win in the order of the
second in the time we need to display
the page so as other offenders like
plugins but plugins are gone today
other traditional extension on Firefox
on Zul extension also we're on offender
so we had to define to decide to stop
having that there are plenty of other
things that we have done for example we
have changed some algorithm just till
efficient but they were already
efficient but in fact sometimes they
were not making usage good use of the
cache so we keep an algorithm with the
same complexity but that works better
with a cache for example and suddenly
you have an improvement of your
performance on complex pages that with
the same complexity of the algorithm
also the garbage collection so the part
that take back the memory has been
changed instead of having to do a
complete sweep or we can now do an
incremental sweep so we take a bit of
the memory we stop because we have only
a few milliseconds and then we continue
later so that means that the memory grow
a little bit but when the browser is
idle it go back to normal at the same
time we notice that memory that is used
on towards the end very quickly and so
on is the ones that usually is released
very quickly and what you have are done
I don't know two hours before usually
you will keep it until you
the browser so we also have as changes
these kind of things in the last thing
is we try to remove old timers in the
interface timers are really really bad
at first time first look it looks very
nice because you delays execution later
but in fact you don't control when the
execution will happen and when the timer
will fire not only it will find the main
thread but maybe it's a moment that is
important for something else you have no
control so in fact the web platform in
this can be used also on website we have
now request either callbacks let's say
fire this or do this when the main
stride is free we also did things like
throttling background tabs so if it is
in the back it's less important but of
course if there are music playing in the
back you don't want your musics to stop
so we are very very defensive here and
we process with experimentation and
finally we redesign our user interface
so the feeling of the user interface is
something really important so the look
has to look modern and it doesn't change
the speed it change the perception of
the speed one thing we change is every
animation now is happening on the GPU is
happening through CSS we had in the
previous interface still animation down
in JavaScript and they were causing a
good deal of the yup so that's that's
really important that animation not in
JavaScript on the main thread we change
a bit the structure of the user
interface so it's quicker for the user
to find elements it's not quicker and
speed proper but it's quicker for the
user so with all these things together
we have now a new engine and it looks
still a user agent still a nice robot
but it looks much more modern and it's
not finished in fact quantum was
released in November but already is a 2
next version of the browser had more
improvements or web render is coming
soon at some point we have other ideas
to improve things and in general
browsers are still evolving it's it's
not the end it's it's a new beginning
because it's the first time we have now
this power of having a massive
parallelism on a browser so I want to
thank you too
here also you can help by installing
firefox nightly by reporting problem
especially when your application or your
website is much slower and firefox and
in lhasa browser this interests us
because it's difficult to have real-life
data each time we do a commit there are
two thousand hours of tests going on on
a term of computers but it's test it's
not real life things so if you file
about say you can give help by
reproducing it engineer will be very
happy spread the word we want as many
people to use as many browser as
possible firefox if possible to because
competition is good that's a way we
improve speed and firefox nightly
twitter account is where to stay info
thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>