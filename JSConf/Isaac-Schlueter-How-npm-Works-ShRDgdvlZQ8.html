<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Isaac Schlueter: How npm Works | Coder Coacher - Coaching Coders</title><meta content="Isaac Schlueter: How npm Works - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Isaac Schlueter: How npm Works</b></h2><h5 class="post__date">2013-01-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ShRDgdvlZQ8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Isak I'm here to talk to you about NPM
so just a little quick disclaimer here
I'm not I'm gonna talk about how NPM
works and NPM sort of by definition
works the way that I think a package
manager should work because otherwise I
would have done it differently there's a
lot of trade-offs though right and
there's a lot of different paths you can
go down we can still be friends if you
know if you're from the Debian world or
from Kiwi or whatever
rubygems aficionados in here so basic
hands up if you have not used NPM great
I'm just gonna skip this slide the long
and the short of it is 1.0 just landed
and there's a bunch of big changes I'm
gonna tell you about some of those the
basically the vision behind NPM and when
we when I started out with this was we
really wanted to just increase speed of
node development and in the node
community and I think really either you
can if you want to increase speed you
can either push harder or you can reduce
the friction and whatever everybody else
is doing you should really do the other
one in 2009 there was a lot of people
really pushing hard on node they were
doing a lot of interesting things
writing all these really interesting
programs and modules and stuff and I
kind of figured you know well I'm not
gonna really add much to that so I'm
gonna try and make it a little bit
easier to install all these things that
I want to play with that people are
building and I figured since we're
starting with a clean slate we may as
well get it right so the main sources of
friction that I saw were you know these
these four things I'd come from from
Yahoo I was actually still at Yahoo at
the time and using Lion switch is a
brilliant brilliant package manager you
should go get a job at Yahoo just to use
why inst but that you know you still
kind of have these these four sort of
sources of friction here so the first
one conflicting dependencies this is my
least favorite you know you try to
install something it requires something
else that require something else that
requires something else you end up in a
conflict and then you make this face and
you say this word and you you have to
carefully go through and be like okay
maybe toot one-two isn't gonna work but
2-1-1 still use the oh gosh shoot me now
completely intolerable unacceptable
the other one is inconsistent services
that was the biggest problem when node
was starting out right somebody would
email the mailing list and they'd say oh
hey I wrote this really cool thing it's
a binding to this library and what you
do is you run make and then you copy the
file I mean you do whatever Jace and you
have a version of no unacceptable this
is better you install it then you
require it and it just works another
thing is that I kind of found in a lot
of other package managers is just a lot
of excessive metadata that you have to
kind of fill out now sometimes you want
that right I mean metadata is good it's
it's searchable it's kind of nice but
you can't get too carried away with it
so in NPM I decided we were gonna go
with this just this one JSON file is
originally called NPM JSON but you know
tried to be standard ish or whatever
there's only two required fields name
and version everything else is optional
there's a lot of stuff in there run NPM
help JSON and then the last one is a
publication cabal you see this a lot in
operating system package managers where
it kind of makes sense you know for
Debian people trust Debian packages they
trust that they're gonna be stable that
they're all gonna work together that you
know they're not gonna have malware in
them so it kind of makes sense that you
need permission but I don't want to do
that work everybody's too busy building
things to be reviewing all the other
things other people are building so we
went with just an anarchic dictatorship
so it's a pretty popular mantra to kind
of mention convention versus
configuration right and say oh well we
you know we prefer convention over
configuration
I think convention is an awful lot like
like kids you know it needs to grow up
at its own speed and if you have it
before you're ready it's really a bad
idea so just to put things in
perspective here right Perl is 24 years
old it's got a master's degree Python is
20 years old it's you know going to
college doing its thing ruby is you know
still kind of a punk it's but it's
almost done with high
school got his driver's license now note
is two years old it like just learned
how to walk we don't have a lot of
conventions yet you know so yeah we're
standing on top of v8 and github and
these other things that weren't around
when those other platforms were built
its totally impressive it's very
important it we're spamming hacker news
every day but I mean really like we as a
community are still kind of finding our
voice for what is a module and what
makes sense has one package or how
should I structure things so a better a
better idea for this was to go with I
think to try and be a pain killer rather
than a vitamin when I started out I said
you know here's a pull request with a
package.json would you please put this
in your program so that I can install it
and play with it and you know if I said
well you know can you take all this this
folder that you're calling modules can
you call it Lib instead and you know
could you name your things based on the
name of the class that you're defining
in them and could you be like no would
not would not fly now maybe we could
kind of find those patterns that make
sense but at that time it just copying
what Ruby or Python did didn't really
make sense so I think a better model is
convention in configuration in search of
convention so just enable everything
right make it very configurable make it
very flexible and then as patterns kind
of arise let's bless the the popular
ones right this is a process it's
organic it's happening and I think with
node zero four we kind of took some of
the things that we saw as as good kind
of patterns to to go with and we kind of
blessed a few of them so that's why
you're seeing some simplification and
it's it's a growing and shrinking kind
of process it's not always comfortable
but it's how it works so today there are
almost 1,900 packages from close to 800
different active paths package authors
even if you're maroc Squires you can't
list them all in a single lunchtime
event there's the this is the wild thing
there's about 300 new packages every
month that's crazy
and something like 2000 updates every
month you know that the next node conf
I'm going to show you that last slide
and you're gonna be like 1900
I was tiny that's like a thousand
thousands now you know really I can't I
can't stress this point enough NPM is
really valuable because of what all of
you guys are doing with it everything
that you guys are building and adding to
it I mean there's this huge long tail of
bindings and modules and stuff that are
all much more you know they add a lot of
value to that package manager so really
without everything getting put into it
it wouldn't be that great
you should give yourselves a round of
applause that's awesome okay so that's
kind of a little bit of background
here's the 50-cent tour of how it works
internally the the registry where things
go when you publish them is a couch app
it's running on Irish couch if you want
to take a look at the the JSON API
that's at registry on NPM JSTOR that's
where the NPM client actually talks to
the HTML thing that most people know is
search to NPM j/s org which is a handy
way to search for modules and of course
you can view the couch app code or
replicate out the data if you want to
tar balls are are added as attachments
to the registry documents there's one
document per package and then underneath
that there's a different version for
each one you use the add user thing to
auth and then the owner command to
manage who owns what who can publish
CouchDB is really awesome for this I got
to say it's it's I started out using
couchdb just because Michael Rogers said
I'll make a registry for you if you let
me do it and couch was like I will let
you do it in whatever you want and no
it's been really great the replication
model is really is really nice and you
know the whole document and attachment
model is actually really really good for
this kind of an applications vary with
the grain of what couchdb does a lot of
people are using NPM inside of their own
organizations I believe I've heard
rumors I don't know if it's actually
happening at Yahoo or not do you guys
know it is all right it is yeah Yahoo's
doing this I know Rackspace is doing
this we have some stuff like this going
on at joint and it's basically you've
got a couple of different things that
you can put in your package JSON to
prevent accidentally publishing
something public one of them is private
true
which will prevent any publishing the
other one is published config so you can
say anytime I publish this let's set the
registry to this other place just so I
don't accidentally send it to the wrong
wrong one so a little bit about that
anarchic dictatorship if you publish
something it's yours and you own it this
is a land grab for names it's still kind
of a land grab there's a lot of good
names that haven't yet been taken and
you know I really think a land grab is
important because it incentivizes early
adopters and without early adopters you
don't have any adopters so yeah authors
all admin their own stuff it's a really
simple permission scheme either you can
write to something or you can't and if
you can write to it you have full
permissions to it the dictatorship part
you know sometimes packages get
abandoned authors go AWOL they decide to
go on vacation for six months and their
stuffs broken and you can't get them to
fix it or you know you send them a pull
request and they accept it but then they
never publish it back to the registry
occasionally programs can be malicious
or misleading or just beyond bad like in
tolerably Badham it's got to be really
bad to be a pain but basically that's my
email address I'm gonna admit on the
server email me if something is really a
problem don't be creepy the cache folder
in npm 1.0 in tilde dot npm there's a
registry items are all cached and then
it does etag caching that's another
reason why CouchDB is so great because
you know it's got this really really
good use of etags it uses them really
the way that the HTTP spec sort of
intends you to use e tags so new in 1.0
we've got a vastly simplified folder
structure much smarter GUID ignore an
NPM ignore handling it it actually kind
of works the way you probably always
thought it did and then we've got this
global versus local installation on it
tell you a little bit about that people
tend to either love or hate that raise
your hand if you hate it anybody yeah
all right good somebody's gonna heckle
me later that's awesome if you haven't
if you haven't kind of gotten on this
bandwagon yet basically with any command
you add - G or - - global
run that command globally if you don't
do that then it runs inside your own
package folder so anytime you install
something it's installing it just within
your project global oh okay thanks
global goes and use a local local goes
in your project global is for putting
files in the path and local is for doing
require the global route is not in nodes
require path this is on purpose and if
you don't like it I think you should
just try it and kind of try to submit
yourself to this and accept it and
you'll grow to like it is this it's like
get versus SVN right I mean it's you
know you hated get when you first used
it you could admit it
so yeah packages are installed into the
node modules folder I think I think I've
been shown slides too long you guys want
some stuff am I still on all right good
what's that
oh yeah okay anybody follow me on
Twitter come on
I've been bitching about this all week
oh hey so what was that
you got a request oh fail hold on a
second I can I can do this
command option what
command option control 8 oh yes thank
you that's brilliant okay so what was I
talking about
oh yeah node modules folders so if I
look here this is actually in the npm
source code let me go someplace a little
bit more interesting
all right great so now I've got a
package.json in this folder and I depend
on a bunch of things and as you can see
none of them are installed so they do
type NPM install what it's actually
doing right now if you remember from NPM
0x it would be spewing all kinds of crap
but what it is actually doing was going
to the registry figuring out you know
calculating which install twitch thing
it needs to install and then finding the
right version and dropping it into the
folder and now you can see it's actually
showing me the thing it installed and
then the place that installed it so you
can see in this node modules folder I
basically have a folder for each one of
those packages and I mean that's about
all there is to it those packages are
just there it's just using nodes built
in module loader which is why that node
modules folder works like that oh I'm
still in background mode oops
command shift weight command option
control 8 there we go
I was like why is it black on weight
again great
okay so cycles are handled smartly
actually so right now it won't install
anything it doesn't need to like if it's
already found in a parent node modules
folder it won't bother to install it a
second time which is really important so
there's a few things you can put in your
package JSON the that a lot of you
probably know about and just kind of
maybe some of you maybe don't the first
is the scripts they it's a hash of like
an event name and then a command that
you run NPM will run these scripts as
nobody if you're currently root which is
important an important security point
you can set the unsafe perm flag and
then that will just run at us whoever
you are all the time
you can do pre and post events on each
lifecycle moment and the environment has
like just all kinds of data you know NPM
underscore config under store every
config option if you read from process
10 then you're in your script you'll see
all kinds of stuff
the important scripts to know about
install happens when your project gets
installed start is how you start your
server there's I'm not sure if the other
node has systems are using NPM start but
we're rolling that out
soonish and I know de the test command
is run by the NPM tests command and then
pre publish runs before your stuff gets
published so if you have a you know if
you want to generate all your JavaScript
from coffee scripts at publish time so
that people don't need CoffeeScript to
run your program that's how you would do
it definitely include a test script I'm
going to show you something a little bit
later which is awesome you were really
gonna love and tests make you look like
a grown-up that make you look like you
know what you're doing and like you care
so all of the all of the commands in the
NPM you know all the different commands
you can run are all in an PM sources lib
slash whatever excuse me
whatever dot J s and they hang on that
NPM object as NPM commands dot whatever
this has actually been a really
interesting study in building a kind of
a sprawling large program in node right
so you know and in particular how do you
how do you organize things like adding
completion or help Docs or you know
stuff like that or a breath support so
one thing you can actually do in NPM
which i think is kind of kind of RAD is
this npm completion now it's it's hard
to see at this monitor I'm actually
gonna I'm gonna bump oh wait you need me
you need me to uh yeah there we go
so what NPM completion actually does it
you can run this on your on your laptops
right now it actually spits out a
completion script so you can pipe that
to your bash RC or to your z shrc or
whatever I didn't you know there's so
many different ways to assign a script
to be run as a completion script so I
don't want to
sort of hard-code that but it spews out
stuff that works for Z shell or bash
keynote there we go
if you only know a single NPM command
this is definitely the one to know so if
you if you run it without any arguments
it sets up your local build directory it
installs all your dependencies it runs
your build script it's pretty much the
one thing that you probably need to do
the most link is really handy if you
want to make changes and then see the
changes automatically without having to
you know rerun your your install every
time yeah basically just read the help
file it if you were using link in 0x it
changed a lot so this REO architecture
really hit that one more than most other
commands LS is important you can do LS
dash G to see all your global packages
LS dash P to list it in parsable format
or LS dash L to list it in long format
and you can combine those flags together
but it's still MIT licensed and there's
a we've been working on splitting out
myself and actually a couple of other
people have contributed to this
splitting out some of the reusable
pieces of NPM out into their own their
own projects so this is pretty handy I
mean if you're writing a large command
line app like NPM nopt is a really nice
option parser and validator cember is
the thing that NPM uses to parse
versions so if you're basically if
you're parsing versions in node I would
highly recommend using that same cember
lab library because then you're gonna
you know you're gonna know that you
always are using what NPM is using and
AB Rev is like the Ruby AB rev module
it's so you can actually type NPM
instead of NPM install and it'll know
you know what you meant
so this is the part where I make
promises and get myself into trouble
everything that comes after now is
suspect one thing that we're that we're
looking into with npm 1.0 is to do
binary distributions it it turns out
this is really really important for
Windows because Windows users just the
don't have a compiler and it's also kind
of important when you have you know
little VMs where you want to run a
little node process or if you're talking
about stuff for you know the palm
devices or whatever there's a lot of
places we want node to go where there's
no compiler and there's no tool chain
and even if there is a compiler and a
tool chain there's hardly any memory so
it's gonna take three days to compile
anything so we've got this experiment
I've got this experimental feature
landed in 1.0 where it'll actually when
you publish it'll pre-compile a binary
add-on and also publish the precompiled
copy and then it install time it'll see
if there's a pre compiled copy for your
architecture and your platform in the
version of node and everything and if
there's a matching copy then it'll
install that one instead it's probably
pretty broken but it's working
surprisingly well so far I'm sure that
there are issues we're gonna sort of
suss out over the coming months end pad
this is that thing with the testing I've
probably talked your ear off at some
point a lot of people in this room I
know I've got I get really excited about
this one but basically so pearl has like
the best distributed testing service
just ever I mean in any language
platform it is hands-down the best when
I I wasn't really I'm not really a perl
user primarily but when I kind of took a
closer look into the sea pants stuff I
mean that's incredible it is so so good
and we just we need the best of
everything in note if there's something
out there that's better than what Note
has for that thing we need to make a
better one of those and so this is
definitely no exception I want to the
idea here is if you do NPM set and Pat
true then every time you install a
package it will also install the dev
dependencies and also run all of the
tests so if there's a problem you'll see
it right away if you you know want to go
ahead and install it anyway you can
always just override that flag at at
install time so the future part of this
that that much is implemented now the
future part of this is that eventually
those results are going to be uploaded
up to a database along with platform
information and the version of node and
what other dependencies were installed
so you could you as a module
or can say hey where are my tests
failing you know if you see a big red
marks under the freebsd column you'll
know hey maybe I should check that out
you know and Pat will tell you when it
works and when it doesn't so if you have
that those n Pat reports and you have
binary distributions that can be built
right and then we get a bunch of VMs and
a bunch of different operating systems
and architectures we can have the
ultimate package test integration mega
engine like that's what I'm calling it
or uptime for short that is in all caps
that is always in all caps NPM is in
lower case because NPM cares about you
it's very gentle uptime is not gentle
uptime sends you an email it says dude
you screwed up on this operating system
go fix it yeah I think that node needs
one of these you know there's there's
these kind of clever interesting CI
things being developed but really we as
a node community for the open source
community need to have the best one of
those that there is yeah so then I mean
at that point then we've got the couch
changes feed we could just build
everything as it's published
publish the binary distributions back
into the registry run the tests upload
the results this is gonna be awesome so
how can you help there's basically just
keep building awesome stuff with node I
mean that like I said that last slide
with the numbers we need to make that
number keep going up open source your
reusable libraries as you build them I
mean there's a lot of people doing
interesting creative things with node
now if even if you're doing a closed
source product you know you can probably
still open source some binding or some
library that you're that you're using
and you know publish that back up to the
NPM registry and just try to help out
with some of that future stuff if you
think that there's some some benefit in
it for you and in general I mean hang
out in the IRC room and and tell people
how to do stuff so that's it my slides
are on this URL anybody got any
questions the question is I was
wondering how that test stuff works is
it just the exit status
of the process primarily yeah so I do
eventually want to do some stuff with
parsing the output and I wrote a little
library called node tap which is kind of
like it's it's more a toolkit than a
library you can kind of pick and choose
bits of it
so that you can output tap results from
your test frameworks I'm trying to get
TJ and Alexis to use it in expresso and
vows respectively Kalin McMahon as well
in in node unit and they all seem fairly
receptive they're just all busy
obviously at some point though we're
gonna make this end pad server actually
parse the output and if it is tap then
it will you know give you much much more
granular results good question thanks so
the I'm gonna abbreviate your question a
little bit so the question was there's a
bunch of stuff in the NPM registry that
people use just because NPM is so
awesome right yeah okay and is there any
thought given to delineating which
things are node modules versus which
things are common j/s modules or CouchDB
models or whatever and I mean currently
you can do this right in your your
package JSON file you can you can
specify an engines hash which specify
which is actually really important
because the node API is still you know
is obviously still changing but you can
also say engines I think there are
actually a few things that are you know
engines Narwhal or engines dojo and
there is actually a way for the dojo
Foundation has some overlap between
their registry which is using the same
kind of API and the couch app where they
they publish a reference to their
registry and then I think it's I forget
the promise di oh all that stuff is
actually hosted on the dojo registry not
on mine and yeah I mean you can do that
today and there's there's really no
reason not to I mean it's a I really
believe firmly that you you loosely
couple as many parts of the thing that
you're doing is possible and whether
that's you know that works in software
as well as in communities right there's
no reason why we can't have some over
between the dojo Foundation in the note
group or you know couchdb modules and
node modules some things are gonna work
in both places some things aren't okay
so everything that I mentioned in that
futures future not futures that's a
different thing that's fibers everything
I mentioned in the future section is
basically geared towards that question
like how do I oh sorry
the question was how do I pick which
module I want to use and you know you
pick the one that has the tests that run
and that work on your system and that
has more dependencies on it and we're
working on kind of building those those
heuristics out to both help module users
as well as module authors yeah so the
big difference the questions the why not
use optimist why use not the the big
difference between the two is that
optimist I believe generates a help
banner for you
and nopt doesn't also nopt does option
validation so it will actually yell at
you if you try to make a number thing
not a number and I didn't need anything
to generate help banners because I
already have that you know this
extensive kind of help structure
throughout NPM so I just needed
something to validate the options where
we're valid and I think I'm getting
booted thank you guys</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>