<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Andrew Paprocki: Bloomberg: home-grown server-side scripting | Coder Coacher - Coaching Coders</title><meta content="Andrew Paprocki: Bloomberg: home-grown server-side scripting - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Andrew Paprocki: Bloomberg: home-grown server-side scripting</b></h2><h5 class="post__date">2013-01-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ODgs0eWAIKc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thanks for coming down here everybody
we're from Bloomberg we got four guys
here we're going to be presenting what
we do with JavaScript we haven't really
talked about anything we we do publicly
before and we figured it would be a good
idea just to kind of show the JavaScript
community what we do every day at work
which involves a lot of JavaScript so
thank you so as you see homegrown
server-side scripting so what we do you
know as this implies we do a lot of
server-side script so first off about me
if you looked at the schedule I am not
arming I am ng prep rocky Armand is
right there so I'm a programmer nardi
been there for eight years I work on
core infrastructure and making rd
productive which is one of the key
points here because that's where
javascript has helped us a lot so how
many people here have heard of Bloomberg
before okay so is that how many people
fur to Bloomberg because of the TV
station or the radio station okay that's
good so first employee is Mike Bloomberg
he's now the mayor of New York City they
wrote the first line of code in 1981
that was way before Windows even existed
the TV station didn't start until
nineteen ninety-four I say this because
a lot of people just they view our
company as a media company and not as a
software company so we want to get
across that you know we have a lot of
code you know that when the TV station
started we've been writing code for 13
years already and as of right now we
have 30 years of code in our code base
that's a lot of code and to let
everybody know we have thousands of
programmers you know it's a lot of
people don't know that if you don't know
anything about the financial world but
in our offices in New York London and
even Tokyo we have a lot of people and
making those people productive saves you
know e equals real dollars to the
company
so let's talk about code for a second
coat accumulates over time the more
programmers you have the faster it
accumulates and this is especially true
of compiled code you wind up with tons
of code and what we found is that makes
your company very very slow when I first
started there about eight years ago the
the development cycle like it almost
felt like a sweatshop because the work
that people did there like compiling all
this code going through this like
laborious cycle of testing things and
rolling things out it really made people
not like their jobs and it also took up
a large amount at a time so the other
part of this is that not everybody can
write clean compiled code I mean you
guys see just even in the JavaScript
world like what the difference is
between good JavaScript and bad
JavaScript now you extend extend that to
c c++ even Fortran whatever anything
compiled and you have all kinds of
issues that you wouldn't even have in
JavaScript like memory corruption memory
leaks things like that and and when you
have 30 years of code accumulated that
stuff can be fatal to your company here
so we discovered that JavaScript makes
people productive so about five years
ago we decided to use JavaScript to
write all of our app UI glue we the
infrastructure team we build complex
bindings that hook into like all of the
all the legacy Bloomberg infrastructure
and for the most part app development
teams are focused on writing product and
they write JavaScript that's like a
thousand two thousand plus people
writing Java server side JavaScript
every day in order to make this
realistic you need a complete end-to-end
solution you can't depend on piecemeal
things that kind of work together or
having a complex workflow that you have
to teach to every new person come in
coming in you have to make every person
productive from almost the moment they
start so what we wound up developing
is you know you can kind of think of it
as like a grandfather to nodejs back in
2005 we made this switch and we have
everything that goes along with this to
make people too productive we built our
own desktop ide we have an entire
deployment system with permission
handling roll out back outs exception
handling routing errors to the right
people debuggers memory debuggers code
profilers all of this stuff is built
into our environment and it all works
around jas so like I said in 2005 we
started with spider monkey we decided to
go with spider monkey because at the
time in 2005 that was really the only
the only good option and at the time it
was about spider monkey 1.6 which if you
guys use spider monkey at all if anybody
here works on server side stuff it's
pretty old now we decided to go with an
object-based UI toolkit to a lot of
people this will be familiar because it
actually started out as GDK it started
out as like the general concept of GDK
of course it was completely carved out
the the guts were taken out of it and
replaced with all of the code that we
needed in order to make it work in our
client server environment but the idea
remains the same it's a GUI tool kit
built around G object I doubt anybody I
mean some maybe some people in here I've
heard of gob I'll you'll see an example
of it later gob was a small project that
somebody made on the internet it isn't
really used anymore but it it was
something that we actually wanted it was
a way to write effective G object code
without all the croft and all the it's
really tedious like lots and lots of
lines of c in order just to write a
simple object gob kind of hides that all
the way and it's a preprocessor that
just generates the G object code and
what you're left with is like a
basically a c-sharp like syntax you
declare classes your properties signals
things like this and when you use the
preprocessor it actual
looks pretty nice we had to implement
our own equivalent G object
introspection layer so when we took G
object G object was just G object the
gnome community didn't have any work in
there related to introspecting these
things or hooking it up to scripting
languages they were just starting to
mess around with serious Python
integration stuff like that G object
introspection was actually started the
same year that we did this but we
essentially forked at that time you know
even though we're built on top of G
object it's everything it's been all
hacked now to to work the way we wanted
to so we're no longer really derived
from that you know we we can't take any
of their code anymore because it just
doesn't apply to our code base we had to
implement our own equivalent of ggas
which is a fairly recent project which
came about at the same time that all of
this server-side scripting stuff started
to pick off pick up that project started
in 08 and again we have this completed
in 05 so give you an example of what
some of this stuff looks like this is
gob syntax if you've anybody here
programs in c-sharp you know you'll see
that this looks pretty similar the as
far as the outer class definition goes
inside the curly braces to still see
your C++ but we really we liked the idea
of gob and so we took gob and kind of
made it our own we used the open-source
one that exists for a little while but
it had a lot of things that were missing
so we decided to reimplement our own so
we had a guy that wrote our own in oak
camo and now it's a lot more complex we
have support for C sharp type attributes
and lots of other nice language features
that again just all preprocess into C
code that's built around G object so
this this is what my group does we write
a lot of these objects we we have a team
core team that builds all these things
and the app developers use all this so
here's an example of this previous
object
you wrap it and because of the generic
bindings which are equivalent to jjs it
shows up in JavaScript like this and you
can see that you know the bindings are
can be pretty smart whatever logic you
want to bake in there you can we we want
to catch errors before they occur so you
know when if you if an object if a
native code object takes an integer and
it gets something that's that can't fit
inside of an integer it's going to throw
rather than trying to coerce it or clamp
it or something like that that's a
general theme throughout all the
bindings you want it to throw as early
as possible so app developers can fix
whatever the problem is so one of the
problems is so you create a server-side
scripting environment that's great now
people can write JavaScript code but
javascript by itself on the server side
obviously isn't that useful you need to
be able to do things with it you need to
be able to get data you need to be able
to affect whatever environment you're
running in so we at Bloomberg have over
the 30 years that they've been in
business they they've had a legacy data
catalog that allows programmers to
access almost every point of data that's
available for every security in the
known world so you can take any unique
security identifier you know the example
like a stock ticker AAPL for Apple and
you can request one of like thousands of
different data points if you need that
in your app you can say I want the last
price i want the bid i want to ask you
could ask about options stuff about
credit default swaps about whatever all
of these things have unique codes and
you can request that data point it's a
couple lines of code and you know it's
not hard for people off the street to to
learn this we built a our own homegrown
generic seema schemas service
architecture app developers that the
asterisk I had and I when I said app
developers write JavaScript they write
that JavaScript for their for their GUI
code for their apps but they're also
responsible for any of these services
that their app might talk to to do more
complex tasks because while javascript
is great and server-side javascript is
great if you're doing heavy duty
computation number crunching things like
that you
don't want to do it in JavaScript you
want to farm it off to some native code
that can do the right thing maybe talk
to different databases different
machines and to the JavaScript it just
gets a response back with the data that
needs we have our own in-house database
that we've written because other
database products you know obviously we
have those too we have oracle and sequel
server are basically db2 every database
in on the man but there was holes that
needed to be filled for the really
really high performing applications you
know apps with really really high read
rates where you of course you can build
the same thing in any of these other
databases but the amount of hardware and
the amount of money investment you would
need in order to achieve the same read
rate made you know this little niche for
an in-house database so for super high
read rate fixed record access we have
our own database which is bound directly
into the engine that people can access
so like i said here's here's an example
of you know if I just sit down I want to
write an application and I want the last
price of apple because I want to stick
it on my screen this is an example of
talking to our data catalog it's very
easy for people you can give it any
security that's available in our system
these this PR 0 0 5 this that's the
unique identifier I was mentioning about
the the security the different data
points that just happens to be the data
point for last price you make a request
and you get back both in string form and
as a number if the data point is a
number because sometimes there's
formatting and things like that that are
built in that would be in the string but
not in the raw number so everybody's
probably seen x SD before so assuming
that you have somebody writes out an x
SD generates one of these services on
our back-end builds it deploys it it's
out there you know have a simple request
response pair this is bound also
generically into our JavaScript we have
a generic catalog that's available from
the engine so I
say I want to talk to this service
version 1 point 0 and immediately the
objects I'm working with in JavaScript
represent the x SD schema and as you can
see the x SD schema like the bindings
take care of translating JSON into
whatever the x SD scheme is so it's very
very simple for app devs to start using
this stuff and and get data into their
application catalog is externally
maintained everything is schema
diversion to met to manage roll out ever
since it levels the playing field now
every developer in the company can look
at the schema for anything and see what
it is you don't have to go hunting
around for somebody's native code in
like a different group that you never
talked to before the services because
it's this generic framework you
externally configure them to run either
in process or out of process and also
the transport is configurable we
obviously depend a lot on speed so the
majority of stuff in our system works
via shared memory that we try to use as
little sockets and TCP as necessary
because everything passing around
locally on the same machine was shared
memory is a lot faster but for
compatibility we you know it also
supports things like soap so we have
apps that are written in our homegrown
server-side JavaScript that talk to
services in external banks that are just
windows soap web services to get data
directly into our server side JavaScript
so it's very very convenient it all
works do the same infrastructure there's
there's no difference to the app
developer there's always a blood
marshaling data to JavaScript sucks
anybody that writes a server-side engine
or deals with sticking data into
JavaScript you really really don't want
to work with large amounts of data in
JavaScript because everything you have
obviously if you're pulling it from
somewhere it's already in the most
efficient implementation and possible if
you've done that work you know we want
to have constraints we we enforce we
like push on to our app developers a
limited heap size so
you're running in this reusable
container your JavaScript app gets
invoked for all intents and purposes you
you have a fixed heap if you go if you
cross that heat boundary your app is
going to throw an exception you're going
to get an out of memory exception and
and the way we enforce this is
interesting but it's separate from this
talk and speed is the the final thing
the majority of our fastest applications
run end and from from the time the user
types it in so where the stuff is on the
screen in like 18 milliseconds 20
milliseconds 30 milliseconds we try to
handle any event in under 100
milliseconds so to us speed is one of
the greatest concerns because of data
center usage hardware usage power
consumption things like this that you
have to deal with when you have a large
data center so we have had to do a lot
of optimizations that a lot of people
don't have haven't had to do like our
environment has lots of caching built in
compiling things to byte code executing
cash byte code and anywhere we can gain
a couple milliseconds back like we've
tried to take it the JavaScript we
ideally wanted it to just be rich glue
people can write complex apps with
handlers signals from GUI widgets and
access to data sources without having to
stick all of the data into JavaScript so
here's a dumb simple example of
something this is a real test screen
just showing like some data in our GUI
environment being shoved up onto the
screen it's all the members of the the
Dow Jones index in a list this is the
actual JavaScript code for that entire
screen this is a very simplistic example
because there's no interaction with this
UI it's just grabbing a bunch of data
and throwing it up onto the screen but
the key thing to take away from this is
we we've discovered through running all
of our stuff that when you get data
responses back you want to try to deal
with them with tools that prevent them
from marshaling into JavaScript so when
we get back this data set of all the
members in the index we use this thing
that we call a mapper to
and pop populated into the grid and the
mapper just is predefined to say which
which fields in the series in the
response get mapped to which columns in
this grid just using generic expats now
you know from here design time and what
does it mean to write JavaScript design
time and it's just not editing
JavaScript we built full IDE this is all
homegrown we have support for debugging
profiling all this stuff in here and
this runs live in our environment so at
this point I'm going to show you guys an
example of how this stuff works
of course we have to resume it
this was set up before but ok no
okay so I threw this together before
this is just some simple example people
like pictures rather than words this is
just an image widget thrown on the
screen as well as a flag which is just a
specialized version of an image where a
programmer could set a country code on
it instead of having to remember some
image resource so just to kind of show
you the interaction in here so say I
drag a button in here this works exactly
like an ID that any other ID you would
expect except as you can see the code is
JavaScript everything that's powering
this screen is JavaScript there's
autocomplete in here there's error
checking it tells you when you have
syntax errors in your code all this
stuff and this is hooked into our
service layer and our database layer so
when you when you say application
services create and you give it a
servant service name the it populates
the intellisense data with the stuff
from the schema for that service so it's
very developer friendly for for getting
access to your data and the other thing
is that it's very environment tries to
protect against our so here I'll show
that you see that down in here the image
that I had dragged into that app is
named image and so I'm going to set the
picture on that that image to a string
now
you'll see here that from the IDE you're
running you're running this app live
within our actual software that's
sitting on client desktops so there's no
trickery here you know it's it's running
live so everything you see is exactly
what you're going to get when you
publish publish this up and you'll see
when I click this because I'm a
developer I get this nice little pop-up
telling me that oh you did something
evil and I go and look in here and it
tells me integrated into the GUI that
you know I got this JavaScript exception
because I tried to assign a string you
know that doesn't course to a number to
something that expects a number and you
can see something that works in here you
know i'm going to set so instead i want
this handler to change the flag to a
different country now you can see this
this is the workflow that we switched
everybody to instead of compiling code
linking code debugging native binary the
dbx gdb whatever everybody programs like
this now and this increased productivity
probably like an order of five orders of
magnitude I mean it's like ridiculous
how much more product comes out of the
entire rd of thousands of people because
of this environment and I'll show you
what we do now so say I want to take
this app and I want to publish this app
so that a client can run it I'm on the
phone with a guy in a bank right now and
I want to demo something to him so I
like my app right now I'm going to
publish it
the other thing to note about this ID is
that there's no local files this entire
thing is inside of the cloud n.e.r.d
developer anywhere in the world can log
in to our terminal access the
development environment and all of their
work that they're editing and publishing
testing it all goes into our backend
there's no local storage here it makes
it very convenient for people just to
pick up work wherever they are and also
work on laptops so I published this
thing now I had a version in here before
but I published it this is our
deployment system so right now this
thing is released to me on development
so I'm going to come shove this right to
prod I have superuser access to do this
so nobody you know doesn't normally work
this way and I'm going to assign a
mnemonic to it so that I could actually
run this in our real software and i'm
going to call it JSC f so this thing is
now deployed this if if i added a client
to that list if they come in here and
just run JSDF they get this application
that i just wrote which to show this to
people like to talk to them about a
workflow that they want and then to
prototype it during a lunch break and go
back and show them exactly what they
were just talking about an hour before
is really powerful and it's actually
helped us win a lot of business but i'll
show you some of the tools that we built
around this because just building
something isn't good enough you need to
be able to test it and debug it so say i
go back in here and i change it back to
what i have before this is going to
throw an exception i can set a
breakpoint here i could come in here and
debug so it was very interesting to
actually get this working debugging live
inside of server-side javascript it
actually involves two processes that the
one the debug e is actually opening up a
blocking socket connection to the
debugger so that's how we implement the
stopping you know that if that socket
read blocks then that's how the debug
use waiting so now when I click on the
button you'll see that my my break point
fired over here and just like any other
idea you know I can go in I see the
JavaScript variable image its type I see
all of the the members on that
JavaScript variable and what their
values are I can come in here and run
code I can in run code in the context of
the jas context that's currently
executing right now if I want to change
something you know so this is pretty
powerful and of course if I continue
when it's going to blow up this system
in production if I run if Iran that app
and it did that in production and it
crashed it kicks into the whole
notification system we have so that the
programmers that publish this
automatically get notification walk
backs JavaScript and in native code of
where the application failed it
automatically puts tickets into our bug
tracking system things like that so it's
a very self healing system now once this
is available we have other tools you
know how do you look at the performance
of your app so here this this is very
in-depth information about our back-end
for running this JavaScript application
it took 14 point 46 milliseconds of CPU
time to run this a bunch of different
data databases and things that were
accessed you know we have built-in
timers and checks in here to figure out
where the time is being spent if we were
talking to any services things like that
we we can look at the actual scheme adre
quest going out to the services and not
just see the requests and how long they
took dive into them and actually see the
payloads of the requests which is pretty
interesting for people in addition to
that memory debugging so people need to
know how many how their JavaScript usage
like how many objects they're creating
because these apps can be long-lived
apps so they need to know
am i keeping objects alive is everything
being deceived is there a bug in the
native code of one of these objects
that's causing the reference to stay
around for it to leak so this is running
live right now so if I go over here and
kill this this should update it doesn't
update a nap but anyway the point is you
can come in inspect everything you can
see okay wrap it up you could see code
this is saying this indicates that it's
from native code I'm not running in
something that's supported right now but
we actually get native code walk backs
JavaScript walk backs of where this
stuff broke so that's it we run out of
time I mean this is like a lot of stuff
to try to cram into 20 minutes but we
kind of wanted to show everybody you
know we've been doing this for years we
have a lot of time and effort invested
into this tool chain and making
everybody productive in it so we hope
that some of these ideas can carry over
into the nodejs world and I look forward
to seeing nodejs got a competitor spider
monkey because we use spider monkey we
can't use v8 for a bunch of reasons but
spider monkey hasn't been really
entering into the server side arena it's
going to be soon there they're fitting
it with a v8 harness to get it into a
spider node so we'll see what that
brings up thanks everybody</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>