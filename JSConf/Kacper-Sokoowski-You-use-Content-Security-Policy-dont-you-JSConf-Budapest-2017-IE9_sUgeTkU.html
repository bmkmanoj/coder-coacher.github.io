<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Kacper Sokołowski: You use Content Security Policy, don't you? | JSConf Budapest 2017 | Coder Coacher - Coaching Coders</title><meta content="Kacper Sokołowski: You use Content Security Policy, don't you? | JSConf Budapest 2017 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Kacper Sokołowski: You use Content Security Policy, don't you? | JSConf Budapest 2017</b></h2><h5 class="post__date">2017-12-01</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/IE9_sUgeTkU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">yeah hello everyone my name is Kasper I
come from Poland so not that far away
I've been loved in this city for it for
a quite long time and it's always a
pleasure to come back to Budapest I love
the city really and I'm here today to
talk about a little bit about security
and to talk about security in the
context of JavaScript applications so
every once in a while the big news break
out that some of the some of the leading
companies got hacked right millions of
credit card details personal data got
leaked people get anxious before being
angry the the reputation of the
company's got undermined and if you look
closely it it seems that there are some
technology giants that get those kind of
problems and for me it can only mean one
thing
that security is really really hard and
I don't know if you've heard about this
product
they got hacked like in 2011 and they
probably they lost some credit card
details so the hackers could use them to
you know to use your credit card to buy
different different things and it's
estimated that Sony lost 171 million
dollars in as a consequence right
because they had to they had to first
fix the issue the PlayStation Network
was down for some time and then they
have to you know pay the insurances like
make refunds and stuff like that so it's
really really important to know that you
can load your company can lose a lot of
money not to mention reputation right
but but but you can lose a lot of money
if you get security wrong but the the
things I'm talking about are mostly
fuckin related we probably most of us
here are front-end developers there are
probably some back-end developers but
I'm gonna focus on front right now and
we usually don't deal with with
databases with with user data because we
do front ends right and we are safe so
we shouldn't be talking about security
and
it turns out that nope we are in safe we
are insecure and does anyone of you know
this guy no so so cool because it's a
very very cool story his name is Sammy
come car and he wrote a fastest
spreading virus ever using javascript
yeah really
that's the VPD uh page of this and he a
huge huge javascript to write a virus
that spread on myspace myspace was a
like Facebook back then sorry for the
images I couldn't find any better but
the virus wasn't really that harmful it
just sent the friend invitation to many
different people so it just sent coming
a semi invitation from many different
people and just posted some random posts
like Sammy's or some person like this
and he ended up having this many pages
of friend requests so so that was that
was pretty you know that the virus went
went crazy went really viral and as a
consequence he went to jail he they they
made him they made him pay some some
money as a compensation and they also he
also had some had to do some public
service so yeah that was really that was
really that was treated really seriously
and by the way if you don't know Sammy
you should definitely check out his
github page because he's done security
research I don't approve the thing he
done with he has done with with MySpace
but still he is now a security
researcher and he does a really cool
stuff and one might ask how how was
Sammy able to to get this virus running
and he used a technique called
cross-site scripting and probably most
of you are familiar with cross-site
scripting but I will quickly recap so
cross-site scripting is a vulnerability
that lets the attacker execute any kind
of code any kind of any kind of code in
the context of our our webpage right and
what does it really mean it does mean
that attacker is able to still cook
still local storage data basically the
attackers are able to do anything we
would do as a programmers in a context
of our webpage and if you want to learn
more about cross-site scripting there is
this great resource called Ava's because
there are some kind of there are many
kinds of cross-site scripting attacks
there are many techniques to to defend
ourselves against the cross description
attacks so we should go to or spend and
learn about them and I've prepared a
demo so I will show you how to how to do
a cross-site scripting attack
all right so
so imagine we are an attacker we are a
hacker and you want to hack into this
blog right this is a blog like you know
we have a blog post here you can go and
read it and what would I do as a hacker
to try to hack this i crack this blog I
would probably go and see like this in
WordPress right try to hack it as it was
WordPress it turns out it's not in
WordPress and then I would look for more
interesting parts and I would go to some
like this admin oh well there's an admin
login for example and probably admin has
some yes there is probably an admin
panel that would be interesting from an
attacker standpoint and our goal right
now is to hack into this panel it
happens that I know the login password I
will just show you what's in panel yeah
sound like this and our intention would
be to hack into this panel without
knowing any kind of password or login
any kind of credentials so what could I
do
it's not occur I would go to the to my
to the to the website I would like to
hack and I would look for possible input
points like for example let's go to the
post because posts usually have a
comment section and it turns out that
there is this comment section and you
can what we can do is we can try to put
some HTML here
whoa something broke sorry on handle
there yeah yeah demo that's right
yeah let's just start it again sorry we
would just have to
it just worked it worked like five
minutes ago so demo gods right yeah
let's do this one more time
first yeah yeah the restart is always a
good thing
yeah and it works and as you can see
I've typed it Iife there a bold tag
right and as you can see the browser
read it as HTML and executed so what I
can do is I can try to put a script
doctor and see what happens right
and as you can see the script got
executed that's right so that's my
that's my that's my security
vulnerability like I can abuse and right
now I would assume that the session is
stored in cookies I would use this hall
to steal the cookies and my code for
stealing cookies would look something
like this here's my code
it's called hack yeah yeah is it
readable from from the back yeah so
basically what I'm what I want to do is
I want to get my cookies and send them
to my server so then I can you know
somehow get them and login into the into
the admin panel assuring that the admin
of the webpage would eventually go to
the poll go to the post and try to read
it right so that's my script and I'm I
would just add an image tag to my web
page and add like special guide
parameters the image wouldn't load but I
still get a request in the and in this
cookie parameter I would get encoded
cookies right and that's great so if we
post it
my server is down but no worries
Yeah right so right now as you can see
it says only great article thanks but it
tries to send some cookie to my server
which it didn't because the server
wasn't running but when i refresh it
probably will yeah and it did because
I'm already logged in as an admin you
see I got the request here and this
encoded thing is my cookie so now when I
copy this an open new separate window as
you can see I'm not logged in but when I
try to set my cookie here I prepare a
little snippet here and if I add my
cookies yeah it just set the cookies in
my in my current current browser window
and if I go to admin panel I've logged
in right and I didn't know any passwords
because it's like completely separate
page so the attack went like this I just
found the security cross-site scripting
hole then I planted the script that
stole every cookie from the website and
then I used those cookies to get into
the admin panel so that's pretty scary
and let's go back to the slides
so yeah and I know that this demo was a
little bit exaggerated because normally
you would use something which is called
HTTP only cookies that I wouldn't be
able to read them if you want to keep
the session in cookies you should you
should use HTTP only cookies but I I
disable this feature for a purpose
because I wanted to show that it's
really easy to steal some malicious data
from the user some personal data from
the user and then abuse it somehow and
how do we say so one might say that I
should always filter the input from my
users and use sanitizer so just and
strip every HTML tag that is posted to
the comment section and that's true but
it turns out that those parsers could
have bugs and there are really really
sophisticated bugs but still that there
are bugs and on the other hand there is
a better way of protecting ourselves
against those kinds of attacks and this
method is called content security policy
and content security policy is nothing
more than a whitelist which let us
define from which lets us define the
URLs from which our browser is allowed
to download some resources so for
example I can take tell hey browser you
are allowed to download download stuff
from bootstrap from Facebook but you're
forbidden to download anything from from
different resources right and not only
content security policy lets us define
what we can download it also it also
lets us define how do we want to how do
we want our scripts to be executed so
for example we can say that we can
execute the script using like we can we
can we can allow the browser to run the
scripts addit using source attribute
like this and we can say we don't like
inline scripts so we want to disband
them and browser what would wouldn't
wouldn't even wouldn't even execute this
code and contrast security policy is
turned on using HTTP headers we just
specify on
our server we specify we specify the
content security policy header which
looked like this it's here we have
header coverage policy then we have
something called directive in this case
it's script if it defines from which
resources we can you can download
download script and there is a URL list
which says we can execute scripts from
and download scripts from self which is
our domain and from Google as simple as
that so having this knowledge that we
can try to fix our demo so the attack I
presented you wouldn't be wouldn't be
even possible alright so here's my
server code and it's like basically
really basic really basic really basic
Express app which uses this this really
neat package called content security
policy and here are my content security
policy rules there are a couple of them
I'm specifying the the resources that my
page uses so I can use only scripts from
source self and there is a couple of
things I've added here because my web
page requires bootstrap and some google
fonts right so when I use this
middleware
and restart my server
and go back to my webpage I would have
to oh and as you can see my browser
refused to apply in line in line of its
inline script actually yeah so it's here
all right so as you can see my script
didn't get executed because it refused
my content security policy which says
that I can only download scripts which
are from my from my own domain and not
only did it block my inline script which
is not explicitly defined in my content
security policy rows it also it also
gave me this this nice report here that
says that somebody tried to try to hack
into my web page and we can specify the
content security policy rule to send
this report to to our to our back-end
and then we can filter those reports and
see that somebody tried to hack us and
that's really neat and as far as I know
the sensoring the tool for getting blogs
is also supporting content security
policy right now so you can definitely
check it out and see whether somebody
tries to hack your site hack your
webpage so right now my attack would be
completely my attack will be completely
impossible because the script we we
planted before it's not exactly and
that's great
I'm sorry all right
so as I said before content security
policy lets you define many different
rules for for resources and we can
control almost everything like we can
control the WebSockets we can specify to
which servers web sockets are allowed to
connect we can specify the image
resources as you can see the Astra photo
didn't load because I didn't explicitly
tell the browser to allow it load it
right and security policy content
security policy is really really great
but it also has its downsides just look
at this it's the content security policy
header from Gmail right and there is
there is a lot of stuff here and it's
really really hard to make to maintain
those tools because imagine you are
using third-party scripts like analytic
scripts or Google tag manager or
something that that we have we have a
tag manager that downloads many
different resources from many different
domains and we didn't even we don't even
know from which domains we have from
which domains we load content to our web
page and to make them work we have to
explicitly define them in those rules
right because otherwise they won't be
working and as you can see this gets
pretty large and it hits both
performance because we had to load this
header and it's you know if we have that
many rules probably we are not safe
anyway because if some of the different
you know different different services
that we listed here get hacked we would
be affected as well so that's really
hard and if you try to use content
security policy right away your webpage
would probably break because it's really
really it's it's really really hard to
know the exact resources that your
webpage uses and there will be if you
turn on the content security policy
today you will be surprised how many of
things your webpage downloads right but
so there is one rule if you start a
project start using content security
policy as soon as possible because it
will give you the full control over your
resources another downside is that you
know I am building single page
applications
and we use webpack for building our own
for building the application itself and
we end up with a package that is
completely serverless we don't need any
servers we just want to deploy we just
want to deploy those three files and we
decided to use Amazon s3 right because
it's like come on come on use case we
just put those files from this tree
turned on static web site hosting
and we are done basically and it turns
out that Amazon s3 lets us define our
own headers so that's great because we
can use it to you know control cache and
we thought that it would be it would be
nice that we would be able to add
content security policy here so we would
actually we would get an architecture
that is completely that has no moving
parts we wouldn't have to maintain any
servers anything and it turned out when
we turned the CDN before ahead of the
head of the stream it turned out that s3
doesn't support content security policy
headers for some reason we don't know
why so we had to add an engineer's
before our Amazon s3 just to add those
headers and that's the another downside
of the content security policy is that
only a few hosting providers and city
and support those fellers I don't know
really why if you ask them nicely they
would probably turn them on for you
but it's not by default and it's you
know it's really really hard and you
know to sum up what have we learned
today
yeah we recap to what continent what
cross-site scripting was we learned what
content security policy is and the most
important thing that I would like to I
would like to you to learn from my talk
is that security is really really hard
and we should always pay attention to it
because it's it's really important and
it can cost us a lot a lot of money and
a lot of and it can cause a lot of
trouble if we don't have security done
right and here are a couple of links you
can read afterwards and my name is
kasper zhukovsky for girl follow me on
twitter and thank you very much
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>