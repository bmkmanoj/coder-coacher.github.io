<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Tim Messerschmidt: Supercharging Node with Kraken | JSConf EU 2014 | Coder Coacher - Coaching Coders</title><meta content="Tim Messerschmidt: Supercharging Node with Kraken | JSConf EU 2014 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Tim Messerschmidt: Supercharging Node with Kraken | JSConf EU 2014</b></h2><h5 class="post__date">2014-10-29</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/gKebfQH8aXU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thanks for attending my talk it's
sometimes thankful to have we talk after
the lunch break sometimes not I hope you
guys are not going to fall asleep and
this is going to be as generally said a
story about how paper slowly transforms
into this new and better company that
started to adopt a technology stacks
like nodes and lots of other cool things
like go and I hope that you guys are
getting something out of it I try to
leave some time for Q&amp;amp;A so let's see and
most good stories usually start with a
little bit of background right that's
like one of those movies where you go
back in time and if you go back in time
it shows where all the characters come
from and why the current situation
actually exists so PayPal had founded in
1998 as a company called Co Finity and
back then in Silicon Valley everybody
had one of those PDA pages anyone ever
owned a palm okay so those things used
to communicate via infrared and a few
guys including Peter teal who's nowadays
this enormous investor thought it would
be enormous ly awesome if you could send
money around using infrared and it
didn't really work out so they started a
new product and another new product and
in 1999 one year after they founded the
company they came up with a product
called PayPal because they realized
sending our own money in the web is not
really easy so 2000 a company called
XCOM ran by Illamasqua the awesome guy
who runs Tesla nowadays acquired them
and stand in 2002 they got acquired by
eBay so a lot of different history and
as long as
they exist basically being one of those
kind of oldest companies in Silicon
Valley nowadays they had a bunch of
different engineers coming and going
starting stuff nearly finishing it
sometimes they did sometimes not so you
can imagine the technology stack it's
kind of a mess and sometimes if I think
about these scenes I imagine this all
growing out sad trombone so if you think
about Jake archability with his sounds I
should have totally done that and
the traditional application stacks that
PayPal hats were basically - and that's
what we had fill up in a few years so
the first deck was a traditional C++
stack because obviously a lot of stuff
that we do is very processing heavy and
then there is Java which used to do a
lot of the web apps hosting based on
Java with spring JE traditional and it
was kind of effective for our and our
teams basically knew how to scale those
applications but you cannot scale any
application to infinity and obviously
nowadays nobody really likes to touch
these things anymore and if I look into
this room and usually I get this talk in
front of a JavaScript audience everybody
looks kind of like that people are
disgusted C++ Java well obviously not
what we all want to go for I have to be
honest I used to be a Java engineer so
please bear with me now this is PayPal
in 2002 and we used to have this big
problem where we had deployments every
six weeks and now if you imagine issues
like there's this number saying we have
a hundred million users and this number
changes we have to wait six weeks until
we can deploy these things and you can
imagine how painful that is and it was
not just the web site that got deployed
every six weeks
it was also applying to our API so if
something went wrong in our API you had
to wait six weeks until you could
actually fix it and obviously
going forward into our modern kind of
engineering culture where we do
continuous deployment and continuous
integration and so on this was really
really awkward for our engineers because
we had those engineers working on
different stacks and they realized that
it is incredibly painful to work on our
product because on the one hand we used
to have our production stack as I said
six weeks of deployment cycles and so on
and then on the other hand we do have a
prototyping stack and that's where our
developers usually went along and had
modern scripting languages lots of stuff
happening in JavaScript sometimes Ruby
and those guys were able to basically
come up with new functionality
incredibly fast and they used modern
kind of toolkits like bootstrap and
Bower
and so on and then then they had to roll
it out into our regular stack I had to
do a port so instead of just taking the
JavaScript templates that you just wrote
and all the CSS awesomeness they had to
come up with ways to bring that through
our stack and I'm going into his stack
in a second
so we had user testing we had a B test
we knew what people liked and then we
had to wait six weeks again at least to
roll these features out and we don't
really interact with full stack
engineers under the production stack so
you have the traditional Java back-end
guy and the traditional HTML kind of web
developer and those guys didn't really
talk to each other so a lot of those
reasons basically leads to huge problems
obviously so the situation we were in at
that moment was actually kind of
frustrating we had B C++ stack with
style sheets for XML we had Java
back-end with JSP as I said mostly was
based on spring and then we had this
cool prototyping stack that I usually
just define as nodes with different
JavaScript templates and we tried out a
lot of those different templating
languages and at one moment actually the
big decision came that we should go for
dust which is heavily driven by LinkedIn
and people at paper just started to
adopt it and kind of like that I'm going
into a few reasons for dusts in a few
minutes but to be honest it's not really
about the templating language as it's in
general it's more about JavaScript
templating so we had this big issue with
our Java stack right where I'm saying we
were running JSP but before we had JSP
we were even writing our HTML CSS and
JavaScript in Java so it wasn't even JSP
pages that were rendered but also now a
big problem with JSP is that you usually
end up with a lot of different
programming languages and scripting
languages and markup languages in one
file because you can have HTML in a JSP
file CSS JavaScript and Java so
obviously it was a big mess and we had
to get rid of that so a few people came
up with UI toolkit a paper that they
called Spartan and Spartan was a
proprietary solution based on spring
nowadays we would do that whole thing
difference now a big issue with
proprietary software is usually that you
have a bigger ramp at time if you bring
in new engineers because those engineers
have to learn about the frameworks have
to apply those frameworks we had those
really bad deployment cycles so people
were not happy now that was likely a big
big push into open source a lot of great
new engineers came into our companies
they used to work for startups before
other bigger companies and they said
that open source might be actually
something variable to pursue so three
reasons why you might want to go for
open source in a company as a set less
ramped up time for your engineers they
can usually work with the tools that
they know anyway so they are more
efficient in just doing work on the tool
sets that they know already then there's
this big issue where engineers often
have to focus on setting up environments
and setting up the project and all that
stuff instead of actually building the
app
you want that your engineers can beat
what you want to achieve and not have to
do all the setup work because that's
less efficient obviously and you waste a
lot of time and then obviously the last
reason is proprietary solutions are
seldom better than the open-source ones
there are great open source projects out
there with thousands and hundred
thousands of committers so why don't you
just go for that and try to bring some
benefit into this so we came up with
rapid deployment and development cycles
and everything was great right on a
production stack we still had to go with
the old stuff so we ended up with a push
into going into a new production stack
and this all was still before we
introduced nodejs so we had bootstrap in
the front ends we had JavaScript
templating as I said and then if you
want to go for our regular stacks I said
that we have C++ and Java so what we did
is we injected the C++ v8 engine into
our c plus plastic that was fairly easy
we call that the project DeLorean so if
you remember DeLorean from the Back to
the Future it's that awesome car that
does V time jumping stuff so we thought
it was kind of fit and then there is
Mozilla Rhino which is a full JavaScript
implementation in Java so that's what we
used on our Java stack to run the
different templates and looking at that
basically we had now a few different
kind of environments again prototyping
we went with tasks and it was great now
since we settled on using dust or
somehow a Java stack we leveraged Rhino
and we were able to run the same
templates that we wrote for our
prototyping stack on production as well
and that was obviously great for us
because it helped us to not leave the
old stacks behind because if you want to
push for new apps it's obviously an easy
choice to say we want to go for nodes
and we want to go for awesome JavaScript
templates and we leave the old stuff
behind but since we have so many
different applications that was not
really something that we could do
so we wanted to try out notes in
production and this one thought this one
wish came from a simple project PayPal
checkout page that you might know if you
go and buy something online and it
redirects you to PayPal generates more
than 3.5 billion dollars every year and
we thought why not start at the core of
paper at the one thing that drives most
of our revenue so a project got named
after the god Hermes God's born and
Hermes is we got of agility and mobility
so what we did is we started with a very
simple stack that we just introduced at
the beginning of that week so we had no
js' running we use bootstrap to do some
very lean UI and we use some other
open-source as I mentioned we used Bower
and the first prototype of a new
checkout platform was born in three days
and people were incredibly excited
because we didn't have to fiddle around
with our own frameworks it was much
easier for new engineers to get involved
so that was great and then we thought we
should definitely try this with another
project and that's we account page the
paper wallet app so if you go to PayPal
and log in over there and you see your
balance and your funding sources and all
that stuff that is actually the first
project that we did and it's actually
kind of risk to go for a new platform in
production if you're not sure that it's
really running so what we did is we had
first this initial project if you check
out page and people were convinced we
should try it right so we had two teams
starting with two projects the first
team was a traditional Java team that
was used to our stack and was well
trained in actually building apps on the
stack the second team was only two
JavaScript engineers compared to five
Java engineers and they were supposed to
just give it a try and made the same
kind of experience so we started in
January in 2013 and we a Java team
obviously used the existing components
and
debating the app in March just two
months after the environment for no it
was completely set up so we had key
stores we had logging services where you
we knew how to connect your databases
and so on so that's what we two
engineers paid on javascript now in June
the two teams met I met Crossroads so in
terms of functionality both applications
were in power one team five Java
engineers started with all the existing
services the other team was just two
nodes in genius so we ran a few
functionality tests and all of them
passed and we were actually really
convinced that this is a good sign
and run a few benchmarks so I don't want
to bore you too much with numbers but
just to quickly go into it we have a
bunch of different requests with number
of users and this is the Java stack and
you see the Java stack actually averages
at some point at about eleven pages per
seconds starting with one user per
request and let me go higher up to 15
users that request at the same time now
this is five-course for actually
production hardware that we are using
and then we had the note stack and the
node stack actually serves nearly double
requests and the same stuff happens just
on one core at that moment so it was a
very young new stack it was barely
optimized and was more efficient
straightaway obviously you cannot really
compare apples to peaches so it's not
completely fair to compare those two
because one is using our proprietary
Java kind of stack the other not but at
least for us it was a good sign that we
could go ahead with this a few more
numbers that we had were pretty much big
coats was actually very lean we had to
write less code to achieve the same and
we needed less engineers to do the same
work so we were kind of convinced to go
ahead now our Java engineers clearly
were not so negative about it started to
contribute to parallel work streams and
got taught too
get some more note note skills and
JavaScript skills now be new stack at
paper changed over and what we have
right now is C++ we have Java serving
some older apps and all the new tannu
apps running nodes and I think the
biggest step into this direction for us
was actually decoupling our UI first
because obviously if your application
layer and the UI layer are really
tightly integrated it's very very hard
for you to iterate and go ahead and
start a new stack so now that we were
able to run dust on all those three
different stacks we can basically bring
all new features to all stacks which is
amazing for us now since we do
JavaScript templating it comes with a
big benefit that we can run the render
both on the client side and the server
side and we actually use that quite a
lot so what you will see if you go to
paypal.com the initial start page is
always rendered on server side and then
for dynamic content we can decide on
Leafly if we want to render that ahead
or just when the client really loads it
up so one of the benefits of node is
obviously the node package manager and
be used heavily to actually distribute
our internal services so if we want to
use our monitoring services security
anything that actually interacts with
our C++ stack we can just go ahead and
install San NPM modules and we're using
an internal NPM proxy for that which I
will show in a few seconds as well now
we had this situation we were finally
able to start and actually go ahead and
use nodes and we had dust and everything
was great right so for us this was the
moment to release McCracken and the
animation you just saw took me about
half an hour
so he's telling me I'm addicted about
her so with cracking we actually had
this one situation where a lot of
different teams have been working on
notes they leveraged Express we used
happy lots of different kind of ways to
abate our service and a few best
practices actually started together so
Kraken is a suit on top of express um
it's not a whole framework I wouldn't
call it framework and it comes with a
lot of kind of sensible defaults a lot
of pre-configured stuff that makes sense
so as I said we used dust for templating
but it doesn't necessarily have to be
dust so if you like Jade or if you like
eg a s or anything else you can just go
ahead and use that and originally it was
made to make middle scale to corporate
skates companies adopt note faster but
we actually noticed that lots of
startups started using lust and started
using cotton because they didn't have to
care about security and a lot of other
stuff and it's heavily taps into
middleware which obviously comes both
with Express and cracking and at moments
now the reason is as I said lots of
different teams at paper are working on
the same kind of stacks and they did
different apps now if you have a lot of
teams building apps in the same
frameworks or different frameworks you
will realize everybody configures
frameworks differently if you have now
engineers moving from one project into
another they kind of lost because
configuration is made difference
some of them might use some JSON files
for configuration some of them use some
methods to initialize things so it was a
big mess and we try to resolve that by
bringing some best practices into that
and now I already said it before they
have actually more time to be eight
projects instead of setting up the
environments which is really good for us
the project structure is actually kind
of opinion so we try to push for a clear
Model View controller
way and we used that initially by having
kind of different frameworks so we use
backbone and a lot of other frameworks
but it was a bit too heavy for us so we
just went ahead and did our own folder
structure and that works incredibly well
for us so we have those templates as I
said can be rendered both server and
client sites
it comes with unit testing straight
ahead and what is interesting about
cracking is that we moved the logic away
from our initial in the x-ray ass or fjs
file into the different controllers so
controllers handle routing and a lot of
other stuff and this is something that
you can actually see it's now also
present in Xpress 4 so Express free
initially didn't have that and they
actually moved it over into Express 4 as
well because they realized it helps to
have much cleaner fights and way more
structure and I think the best for
modules and there is a whole lot of
different modules that come with it a
mcaren lisca Adaro and CAPA Makara is
used to do internationalization
localization or specialization in your
apps
lioska is coming with a lot of sensible
security defaults Adaro is used to bring
the Strayer support and CAPA is our NPM
proxy now if you want to do localization
it's actually quite easy we use key
value files for that it's not Jason it's
our own kind of format with property
files and you just load up lots of
different content bundles and you can do
that on the fly or you can obviously use
gratin to do that for you but you don't
have to use Kraken to use all of these
modules so what we do is we have a
provider that just loads for various
locates and it basically provides those
different values for you which is kind
of good and the property files are not
really complex as I said it's not JSON
syntax but it allows for some structures
where you can bring arrays in there you
can define multiple values it's actually
kind of useful for us you don't have to
use this format
but I think it's actually pretty good
since it also supports some more
structure like subkeys now if you want
to use this it actually heavily taps
into dust so one of the good things
about it is if you switch be located it
automatically changes changes we locate
for you and be templates as well by
leveraging the folder structure so
different keys in different languages
get visible for you which is very handy
and you can see that down below with the
head attack so it basically just loads
up the index start quitting and index is
my controller so my localization is
bound to my controller and it just
basically loads in a file for me which
is really handy for us and if I want to
use Adaro
I basically just defined dust as my view
engine for express obviously I can still
as I said before use any other view
engine it's just dust for us because a
lot of new engines try to have a lot of
logic in their files and they try to do
a lot of processing for you and
calculations and that stuff and we tend
to move that rather into our controller
logic so you basically have a layout and
you provide your palettes into it and
what happens is it fades up the content
so nothing new nothing magic in there
dust comes with some cool stuff like
sections and you can provide your view
context into that so different models
can be just rendered directly and it
also comes with conditionals so not too
much logic because it's just saying if a
certain content is there show it or
don't show it so it doesn't really try
to be dead smart now security is
something that I think is kind of
interesting
lots of frameworks come with security
measurements and lots of kind of ways to
make your app secure and harden it but
lots of those frameworks also don't come
with sensible defaults so they just
assume you do the configuration and
quite often developers tend to not do
that so one of the biggest features we
support is
prevention of cross cross-site request
forgery see Cerf and it basically says
if you want to manipulate my data with
post requests put or delete you have to
provide a token to make sure that it's
really the app and not somebody else
click tracking which basically means I'm
framing your website in another website
can be prevented by setting up the
same-origin header it comes with output
escaping against cross-site scripting
and content security policy supports and
if you've attended last year's J's comp
you might have seen my quest talking
about content security policy it's
really awesome stuff configuration
happens via JSON so you basically just
say I want that feature I don't want to
have that feature this is my setting or
you can just go through the method calls
one by one so you don't have to use all
those kind of things
now I already mentioned you have to
provide a token and it's basically just
a hidden input fields that you provide
over to the app and then it plays a key
validation or at manipulating me data
the NPM proxy Kappa is very easy to
install you can go for that globally or
locally and that's basically what we use
to distribute our different services
like the key store database access
logging monitoring and it's based on
another module currently to NPM delegate
and if you look at the configuration
it's really just a folder so I got
called config and in that folder you
have a bunch of different files and you
can set up various environments so you
can say this is my staging config this
is my development this is my test
environment and it's pretty much easy to
set up in this case you see the view
engines and you can obviously do that
for all the kind of different settings
for cotton now if you want to set up
cracking with let's say passports you
could go and really just configure it by
providing some options to it and this is
just the index.js file that you would
use for that and now we
nice thing is about that you don't need
to miss mess around if you lifecycle you
don't need to figure out when is my
module being loaded and why you just tap
into different events like in this case
middleware so after my session is low
that I make sure that my I can use my
passport local strategy I just make sure
that the user is nicely serialized
deserialized and that's it so it
provides a very very clean way to make
sure that my projects are nicely and
visible so I think it helps a lot and
since we wanted to make sure that people
don't have to set up this stuff manually
and it comes with a yeoman generator so
you do NPM install generator Kraken call
yo cracker in your shell and that's it
it's really easy to set up and I think
it's pretty cool because it does a lot
of scaffolding for you so it comes with
the templates it comes to few
localization v3 tests automatically
which is really useful for all of us I
guess so cracking nowadays is already in
version 1 that X which also came with
the Express for push and I think one of
the features that we will focus on
heavily is going to be specialization
which is not going to be purely used for
a be testing but also for mobile device
versus desktop and so on so it allows us
to do a lot of this kind of logic and
well I can summarize for us it has been
actually a really good ride to introduce
note and especially cracking to the
company we have those really small teams
with lots of JavaScript full stack
engineers that are able to move much
faster we can write our applications
more efficiently we have now dust as one
UI up layer so we don't have to mess
around of different templates and it was
our very first big portal pushed into
open source so for us it really helped
to make sure that we are not just
building profits or a primitive sorry
proprietary software for paper and
release that you to device we actually
try to figure out what will be useful
for everybody
and our teams are now so convinced that
all the new apps are going to be written
on note purely big thanks for attending
my talk and I'm hoping for some
questions
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>