<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Maurice De Beijer: Event-Sourcing your React-Flux applications - JSConf Budapest 2016 | Coder Coacher - Coaching Coders</title><meta content="Maurice De Beijer: Event-Sourcing your React-Flux applications - JSConf Budapest 2016 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Maurice De Beijer: Event-Sourcing your React-Flux applications - JSConf Budapest 2016</b></h2><h5 class="post__date">2016-06-10</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/LrkXWj9zxsU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Thank You Jacob good afternoon everyone
I'd like to talk this session about ven
sourcing Redux and react applications
now decision is more about architecture
I use redux and reacts as examples but
this would basically apply to any Java
scripts application or for that matter
even any smart client server site
application desktop application the
architecture is universally applicable
so who my name is waste buyer i'm from
the netherlands I'm freelance instructor
developer and I consoled to lots of
companies doing stuff so if you want to
learn more about react I've recently
started the Kickstarter campaign and
with any luck if it gets fun that I'm
going to create a whole course about
reacts where you can do learn much more
so if you want to go there that's the
link so why am i interested in event
sourcing and these kind of our sticker
things well I want to make better
applications and that's a goal I've had
for a long time and there is a lot
involved with making better applications
the front end has to be better and react
helps me a lot there day that
manipulation in the front end has to be
better that's where Redux comes in helps
me a lot put on the server side we have
to do things a lot better as well and
one of the reasons things need to be
better is because of fire like this one
of my main customers creates safety
software for the oil and gas industry
and we kind of try to prevent these
accidents from happening now we don't
control people we can't actually
forcibly stop someone from doing
something wrong but we do create so far
where all the work is planned and we
kind of evaluate well if someone is
going to open up a gas main lying and
someone else is going to do some welding
then torches sparks free gas that's
probably not a good combination you
probably will
to separate those in time so they don't
happen at the same time or you will get
accidents like this happen so
traditionally people be storing data in
all sorts of ways you might have been
using relational data or an object
database like MongoDB and typically in
the traditional application architecture
used to be quite simple with there's
something like this at the very high
level so the left we've got our database
and in the middle we've got our server
for application and that server
application grabs data from the database
whenever a client connects client is on
the left hand side sorry the right hand
side it's the browser running a react
application in this case and it kind of
passes that data to the clients and then
whenever the client has made some kind
of changes it passes the data back to do
server the server probably does some
sort of validation and stores it in the
database this is the kind of system you
might end up if you just use restful
styles of working with data and that's
fine if you've got a relatively simple
application if you've got to do
application you're not going to have lot
of multi-user contention most people
manage their own to-do list no one else
is going to touch that maybe in the case
of a manager he'll have a secretory
managing his to-do list but in that case
it's probably the secretary doing all
the work and even if you create to the
to do list to rule them all is the whole
world is going to use it you'll have
lots of small lists but there won't be
much interaction and a relatively simple
architecture is going to be just fine
but if you want to create reacts
component to render something like that
in this case it's not for to do
applications it's actually for work
permits you might end up with a react
component like this really simple it
just takes in a list it's good no clue
where it actually came from it knows
there is something that it can do it can
draft the permit which basically means
we're building up a whole permit
requests specifying what we want
to do where we want to do it when what
kind of tools we want to use etc but
react component doesn't really know
where it came from how its treated
they're really simple and that's how
your reactor components should typically
be so if you've got a little more
complex application which our
application is you want to be a bit more
explicit about updating things and
that's where the CQ rest pattern or
command the query responsibility
segregation comes in and insecure s
commands are very important commands are
used from the client to update things so
we're not taking a resource like in a
restful system downloaded changing its
ending that home resource back though
we're very explicit about I've got a
resource I want to make some changes to
it this is why I want to do it if you
take all your command names and you give
those to some kind of say business
analyst or end user he should be able to
understand that so what commands like
update fields is a lousy command it
doesn't convey business value draft
permits pay check check credits records
those are valid commands and something
which makes sense and if you use see
caress the architecture will become
somewhat more complex like this on the
right and still site we still got our
browser application using react if it
wants to get some data from the surface
it goes to the query surface at the top
and the query surface is probably a
restful service but all it does is get
data it never responds to with boots or
a post or a delete it only retrieves
data purely redone so what if you want
to change something well the client
sends very explicit commands to the
server so the commands go down to the
bottom to the command surface it does
all the validation it could potentially
reject the command like you want to
deposit or you want to withdraw some
money from your bank account but you
don't actually have
enough money well in that case your
request is rejected your command is not
valid and the plan could get a 400 style
error back but assuming the command is
valid the database gets updated and the
client or in the other connected clients
could actually retrieve thread through
the query surface so what does a command
like that look like in JavaScript well
it's really simple commands are really
simple objects we try to keep them as
flat as possible it's just back of data
a couple of interesting things though
first of all every command has an ID in
some cases in more complex applications
especially if you've not got the perfect
connection like we do when we have to
work with offshore platforms you might
get commands which get sent twice after
all if you've got a timeout from from
HTTP requests you don't really know what
happens did my command reach the server
and what's the response timed out or did
it never actually receive the server so
every command has a unique ID if its
recent for some reason then the server
can check based on that command tidy am
I duplicating the same month and if so
get rejected because it's already done
it the other important thing is the
command name what are we actually
intending to do there and based on the
command name there will be a whole bunch
of other data or maybe very little in
case of delete apartment then all you
would need to know the permit ID to
delete and that's all but in this case
with draft permits to raise a whole
bunch of data about the permits there
after a command like this has been
successful we kind of need to update the
reader store on the clients so we Redux
you typically have actions to signify
that something happens and an action is
very strongly related to a command a
command is ok I want to do something
well the action is ok that's been done
it was successful now go and update the
data on the client
so you see this action notice different
the command was draft permit so
commanding tense the action is permit
drafted we know the draft command has
been successful so it's past tense and
the data in there is going to be pretty
much the same thing so that's nice that
gives us a much better our stature but
it still leaves us with one big problem
if we looked at the database it only has
the current state in there and it's like
how did we get there if you look at this
rock formation which is in the west of
France it's kind of like a beautiful
rock formation but how did it get to be
the way it is did we have a solid rock
there once upon a time and it waves
break a big hole into it or maybe was it
deposited on top and did deposit grow up
to form that arch you really can tell
all we've got is the current state and
if you think about databases you quite
often experience problems like well
something in the database is wrong like
there is something which should not be
the way it is it's invalid we know that
but how did it get to be in that a valid
state we don't know all we can say is
well okay it's invalid now somehow that
happens maybe we've got some logic error
but we really don't know how it got to
be that way but will write some kind of
sequel script to patch it and we're good
to go again and maybe a month later the
same problem occurs again still no clue
why it happens so we really want to know
a bit more about how stuff got to be the
way it is so that's where event sourcing
comes in a fence or thing is really
something which is theoretically quite
old it's based on accounting and
bookkeeping which is be used for ages
and a guy called Greg young basically
implemented that in data storage so he
said well instead of destroying the
current state we're going to store
are everything that leads up to the
current state all of those events and if
you think about that draft permits
command I showed a few minutes ago well
if that was successful we would change
some states well in an event source
system we would store an event permit
drafted and like the commands could be
validated and rejected if it was invalid
the event is store if it is successful
so we know it's happened its history
which also means it's never going to
change we're only going to add more to
or to the table of events so if someone
makes it change through that permit does
another draft the command it's not going
to override the first permit drafted
events no it's going to create a second
one and they don't stack on top of each
other and the current States is a result
of applying all those commands or all
those events i should say in functional
terms the current state is a left fault
of all stored events now turns out that
something which is relatively new in
computer terms but in real life is be
used for ages and ages even back in the
days of the Pharaohs bookkeeping always
had to rule like we don't distort a
current state we store transactions and
even back then the far-out might have
had ten cows and one will be born then
they won't cross out to ten given that
they use clay tablets and papyrus back
then crossing that would probably be
quite hard but they would add another
line cow born on whatever date and
number one and when they got to the
bottom of the tie tablet they would kind
of sum them up and start a new tablet
they say at the top current status is
the Pharaoh has 11 calves and then they
would report sales their purchases etc
and kind of keep tally that way now
bookkeeping has been doing that for
thousands and thousands of years even
the model double entry bookkeeping is
hundreds of years old it was
invented around fifteen hundreds by an
Italian monk and he created to double
book entry bookkeeping system which
basically prevents lots of mistakes and
makes it really easy to detect errors if
they've been made so in that respect
it's really nothing new and one of the
great things it's a perfect or that look
we know exactly what happens when it
happens how it happens usually by who it
happens depending on what you store in
the event but usually you store all
those things so if you run into the
database you detect some kind of anomaly
dare you say well that state isn't what
it should be it really should be
something different instead of saying
well don't know how it good to be there
but it is there now we can actually go
through all the events being store up
for that item and track well okay these
changes were made these changes were
made and you can determine what changed
actually caused the error maybe there is
something wrong with c'mon validation
maybe there is something wrong with
updating the current state at least
you've got a complete track of what
happens so you can lock that so if we
look at the high level architecture or
for an event-driven system will see
something like this so on the right hand
side who still got our browser
application using reactor redux and it
still connects up to that same two
services the commanding service and the
query surface so as far as the client
concerns there is really no difference
all the difference here is at the back
ends the command surface basically takes
each command turns into an event it gets
stored in its own database whatever you
want to use there are different
libraries implementations you can use
there is a projector surface which
basically picks up the whole stream of
events coming in and it says well if
this event happened and I want to show
it in some way and it updates a
projection database for it now I've said
projection database but it could be
plural you could actually project into
different databases you might say well
I've got a relational database for
normal projections but I use elastic
search for file searching
and I might use MongoDB for documents
database for yet other services and the
query site actually queries that
projection database so why do we need
two different databases or projections
and the event store well the event store
is just a list of everything leading up
to the current state which makes it very
hard to query for lots of queries now
they're actually some queries which are
really efficient to do that like you
could ask from well whoever drafted the
permit and then deleted it within five
minutes after that something you found
really easily query in normal database
but if you want to know about all
permits for a given drilling platform or
all customers that are overdraft that's
a lot harder to do in an event database
and that's very easy in a projection
database because you can basically
choose whatever you want and whatever is
most suitable for your need but we can
actually expand a bit on this
architecture because if we've got a
projector surface which receives every
event we can also create another surface
which says well I'll also receive all
events and i'm going to use push
notifications to all connected clients
use something like web sockets or socket
build io or whatever technology you want
long polling could work but basically
every client that's connected scan
indicates whatever data it's interested
in and it's gets notifications of
whatever changed it will receive all
those events now you can have as many
clients connected as you want someone
makes a change and everyone else sees
that change and even if they're editing
something as long as the two edits are
not an actual conflict like the current
bank account balance for a client might
be updated through an event and another
user is changing their address well
we're both related to a customer but
it's not really a conflict because it's
different item would be affected by
different events different commands
so that would still be perfectly fine to
update so what does that look on the
client side well we've got our views
which is basically what the user sees
they're typically done with react at
least in our application that's done
with react but that could be angular it
could be some simple view library J
mustache or something like that we've
got Redux which is by far the most
popular flux implementation and it has
its store which is basically the current
states of whatever data you are working
with that gets updated by actions and
those actions are updated in part by
user actions in view and imparts by
server actions from as a result of other
users being pushed back to web socket
API so because a really nice
architecture would really clean
redefines data flows which makes
everything very predictable very
performance and very easy to understand
now I mentioned projections and a lot of
time when people start working with
events or systems projection caused some
issues what is a projection how shoot it
look how should you shape your
projection where should you project well
it really depends on your needs like
I've got a map here it's a map of the
world it's a Mercator projection and I
at least I assume it's an accurate map I
haven't actually checked that they've
got another map of the world here
basically exactly the same data this is
a more white projection so they're very
different projections based on the same
day that because there are different
needs if you flip back to the Mercator
projection if you take a look at
Greenland the big white blob at the top
it looks about the same size as Africa
turns out that's not the case the more
white projection is specifically made so
you can compare areas
so you can see that Greenland is not
smaller than Africa and reality it's
about the size of the Arabian Peninsula
so what's the point of this map then
well it turns out for navigation if
you're moving the ship across the ocean
ricotta projection is really nice
because if you draw a straight line on a
Mercator projection map you get a
straight compass heading and if you
follow that compass heading assuming
there is no drift down wind than
anything which you'll end up exactly
where you want it to go and with the
mall wide projection that's not the case
so different projections based on the
same data for different needs so it's
actually fine if you want to start
projecting out data and you're going to
project it out in many many different
shapes depending on your needs and the
good thing with events or system the
source of truth is not the projections
the projections are just read only view
of whatever the current state the source
of truth is the stored events so if you
come up with a new projection you need
some time later well you can just create
it based on all the store at events you
just reread them again and create a new
projection so you can throw away your
projections and basically rebuild all of
that whenever you want to so what does
the Redux coat look like on the clients
I've got there a simple example and you
basically see redux producer which takes
all the incoming actions like the one I
see previously and it checks the type
and it decides how it should handle the
type by default it kind of says well the
default action at the bottom I don't
know anything to do about this action so
I'm just going to return the state s is
but in this case for the permit edit or
permit drafted commands it actually
knows how to handle those and does
something and now this only handles the
case of permits the collection of
permits it doesn't worry about how to
handle individual permits
individual permits are done by a
different producer so it knows if a
single permits is drafted how the state
inside of that permit actually changes
now redux basically combines all those
different producers into one complex
tree and every time an action is fired
that tree gets a chance to handle that
and it decides how the current state
should be so even though the terminology
is very different than used in the vents
or existence in reality it's really the
same thing an action in redux is an
event in the events or system it's
something that happens we projected in
the events or system well we reduce it
in Redux end result is we've got some
state to work with so how do we wire
things up well inside of our react
application we have a start-up so at the
bottom you can see that react don't
render which actually should be react do
not render this code is slightly old
sorry about that and you see that our
application the app elements is wrapped
inside the provider that provider is
provided by reacts redux which basically
connects Redux to react like I mentioned
before Redux could be used anywhere
without react but that connects it to up
and that makes all the day they're
stored inside our redux store available
for all react components next thing is
ok now we need that components to have
data so one of the first components I
showed that list of permits needs to
have the list of permits to display and
you do let using another thing react
Redux provides the Kinect function which
Bailey says will connect up some data
from the store what well there's a map
states to props so it map state from the
store to properties in we have
and in this case it just says well met
all the permits from that store into the
properties of the components so it has
its list of permits the other thing the
original component had was that draft
permit commands so it needs to know how
to handle that and the second function
here on the slide is actually intended
for that so map dates patch to props
dispatching means dispatch in action so
some thing in the back end producers
api's etc get to handle that so with
this we've basically completed the
circle we've got reacts components which
are completely unaware of how the day
that works they are purely focused on
rendering we've got Redux which is all
about the client-side state which is fed
on the one hand by user actions on the
other hand by push notifications from
the server you've got the server which
stores all the events resulting in the
commands being sent in a database and
projects those out into a rig model or
whatever shape we need and we've got a
very scalable and very nice architektur
so with that I'm slightly out of time
but at the end of my presentation all my
slides will be a SlideShare later this
afternoon so on the right hand bottom
you can see my Twitter accounts if you
just check my Twitter accounts somewhere
at the end of the afternoon you'll find
a tweak there pointing to the slides and
slide share and with that I would like
to thank you for inviting me and
presenting to you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>