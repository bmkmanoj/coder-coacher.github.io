<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Zachary Johnson &amp; Andrew Reitano:NESpectre: The Massively Multi-Haunted NES | JSConf EU 2017 | Coder Coacher - Coaching Coders</title><meta content="Zachary Johnson &amp; Andrew Reitano:NESpectre: The Massively Multi-Haunted NES | JSConf EU 2017 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Zachary Johnson &amp; Andrew Reitano:NESpectre: The Massively Multi-Haunted NES | JSConf EU 2017</b></h2><h5 class="post__date">2017-06-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/KSVYCV66sQQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">I can everyone hear me hey there you are
hello there hello you beautiful people
um thank you for joining us here on the
side track for the first day of Jays
count yes one we were there from
somebody thank you very excited more
wounds come on come on whoa there we go
there we go fantastic thank you we've
got somebody who has flown in here from
Minnesota which I believe is in the
United States of America I don't really
know about these things it's got
something very very excited lined up I
think was meant to be a tag team special
originally but we've lost 50% of the duo
due to a bitter throat illness so please
be very very kind to the remaining car
for the gang
Zachary Johnson
hi thanks everybody I'm really really
excited to be speaking to this audience
thanks so much to the committee and
volunteers for inviting us and for
putting on this event so I'm Zach
Johnson or Zachary Johnson Andy right ah
no is supposed to be up here he's back
at her flat sick he got in and like got
a like lost his voice and got a horrible
cough and a fever and so he's totally
knocked out and I told him you know I
got this sleep until 7:30 we got another
thing at 7:30 tonight on the other stage
with more interactive demos because a
big component of this is more the how
talk and we'll have more play tonight at
7:30 so I'm hoping that he can sleep and
join us I was going to tell you that he
got you know eaten by a shark or
something I was more exciting but
whatever
so Andy is an electrical engineer by
trade so you know he worked on like
submarine navigation systems and I was
like sure electrical engineering stuff
and he got into chiptunes an electronic
music scene instead of doing
visualizations with Nintendo's and Sega
to tell you a little bit about him
and because he's not here I just want to
say that Andy always wanted to be a game
genie when he grew up and this project
gets him a little close okay
me I've you know Zach Johnson pretty
common name except for maybe Zach part
so I go by Zach's turn out on you can
find a bunch of my projects at Zach's
calm that little pixel art astronauts
kind of my character so some of the
things I worked on I if you're familiar
with Adventure Time on Cartoon Network
did the programming for the BMO app or
you can have your own morphic BMO and
that entire app it was number one in the
App Store was probably four or five
years ago already the whole app was done
PhoneGap the entire thing was HTML CSS
and JavaScript and was number one it did
really well for Cartoon Network a couple
of things I've done if you remember in
the United States there was a
legislation called SOPA there was a big
internet blackout I did an open source
template for that that had like
animated spotlight effect that many
websites used and I'm also a game
developer and then in the bottom corner
there is a game called jaggernots that
you can ask me about kind of big thing
I'm working on right now my backgrounds
web but I've really been getting into
games and interactive stuff so going to
do what is an aspect or tell you the
story of how it came to be and then get
into kind of the nitty-gritty of how it
works but you know got 25 minutes to do
all this so find me in the community
area if you want to talk shop get into
the nitty-gritty of this and then if you
want to play with more demos because we
have a bunch of different things you can
do with this tool tonight at 7:30 on the
main stage during dinner okay so this is
going to go audience interactive so I
shall lift it up for just a hair longer
so you can see it in the back so get out
your smartphones and if you do have data
if you have LTE you have a better time
with that actually than what Phi I think
so pull up your smartphone you're going
to be able to control in any apps from
your smartphone go to net Specter comm
it should forward you to the address you
want to be at and crank up your volume
on your phone if you if you would for
more fun so let's leave this up for a
hair longer NASA specs or comm if
anybody has gotten that to work just
want thumbs up of be awesome okay
alright so what we're going to do here
is a little live demo what this thing is
going to open a couple browser windows
this is actually tonight hopefully if an
use well we're going to have the
physical Nintendo and I'll explain that
my talk this is an EM script and
compiled emulator running in such
JavaScript and pull up Mario Brothers
here and I will have to play it didn't
go here be a real nice to me
okay okay looking behind the curtain
here okay Mario mode all right that's a
good sound okay so on your smartphone's
you should start to see there we go
you've already there you go so I'll just
play this completely normal game of
Mario this is an unmodified rom this is
the original game and i'll explain
what's actually going on because it's
compelling my okay because it's
completely the original robbed evolving
quickly we'll keep doing the light like
it resin and slowly make me freeze so we
usually like to do this with inviting
somebody from the audience up the stage
they have no idea what's done to happen
to them to play a normal game of Mario
but I don't haven't gained that I kind
of doing the keyboard here
I'm not you guys haven't managed to kill
me yet a little scared
butterfly Mouser hey I survived
okay let's pause all of this to not
completely kill my server sigh wait
wrong wrong domain okay pause cool okay
thank you very much
so doesn't mean a bunch more different
games and different play modes tonight
so let's get in a little bit into how
all of this happens okay there's an
event in Austin Texas it's an
interactive art and video game festival
called fantastic arcade and I think it
was two years ago I go to this event and
I'd never met Andy before and he was
showing a brand-new NES game like it's
on a physical plastic cart he made a new
game that you play on the NES and it's
called super Russian roulette and it is
pretty much what it sounds like you play
with the zapper against this cowboy in
this game despite being in a real legit
8-bit an NES game has like full screen
graphics and animations in this
beautiful country western soundtrack and
stuff and it just pushes the limits of
what's possible and I was amazed so go
up and talk to them having never met
them before and we start hitting it off
about the NES because I'd kind of done a
study of how the NES sprite system works
and I wrote a WebGL shader and
JavaScript and GLSL that kind of
emulates this is the shade of running
that emulates like the dying sprite
system because like if you remember
playing NES sometimes like you'd have to
boil in the cart and the graphics get
scrambled and so this is kind of
emulating that and we we hit it off and
I told him about some of the the
massively multiplayer game stuff I was
doing so I did this game called eight
stir knots for node knock out years ago
and another one called Narwhal nights
which is like massively multiplayer
dowsed but you're on a narwhal instead
of an ostrich and use the tusks to joust
and so he was like wait a minute
why don't we take your massively
multiplayer JavaScript stuff and my NES
stuff and mash these two things together
this is the first time I met him first
day I met him at this festival and I
said absolutely let's do that and so I
went back to my flat at the conference
and started coding this thing and the
next morning I came to Andy's booth
where he's showing his game and I and
this is the original version of the UI
and I said hey you know like let's I
coded it last night let's try it and you
know this is like answer this is Andy
you guys this is another photo of him
and despite like both of us playing
video games and partying the entire
festival we managed to put this thing
together and this is like now like less
than 48 hours from the idea we see this
happen in contra if you remember contra
that's the level one boss and we just
jumped up and over in the end boss and
contra into just uncharted territory in
the game and this was kind of the moment
where I was like this is a thing like
this is this especial and so this is
then you know the that same day and he
had a talk invited me onto the talk to
show the thing we just collaborated on
he's like coding like before he speaks
like on stage like last minute stuff and
I'm right next to him like on the far
left there there's me and a duck hunt
t-shirt and so yeah so that that was how
it came to be which is really cool it's
like the magic of festivals like this he
needs someone and you want to
collaborate so a little bit about the
NES and this is the part that Andy would
tell you about he's the hardware guy and
I'll do my best without him so the crazy
thing one one very crazy thing about the
NES is the entire RAM of the NES was 2
kilobytes like 2048 bytes so that's like
15 tweets entire all of program RAM and
so what Andy did when we do this off the
physical Hardware what Andy did was he
used what's called dual port RAM which
is RAM that two different CPUs can
read/write at the same time so he
actually dee soldered the RAM off the
NES motherboard and put on his own
custom
auto board to talk to the dual port Ram
/ serial and so he mounted the box to
have a serial plug that looks like a
headphone jack that just goes into the
back of the NES and otherwise you can't
tell it's not a normal NES and this is
this is a diagram of the game genie
because it's important again to make the
distinguished distinguish this so the
game genie modified ROM it sat between
the Kart and NES and change the values
that are being read off the the
read-only memory on the plastic cart but
our modification is directly into the
RAM the working memory of the Nintendo
which lets us do things you could never
do with the game genie so here's some
examples of what you can do with this so
Andy made a giant hockey buzzer four
blades of steel and of a scoreboard and
it's reading Ram off to the console and
then you know you get a goal in it and
it fires off this thing he did a mod for
contra with a strobe so every time you
fire the gun you're going to strobe and
then this is something that I can show
you more of later but like you can hack
set it and do crazy things like there
he's hex editing the whip in Castlevania
and like he was no it was like whipping
different sprites like that are no
longer that like the whip okay so what's
going on in the stack so there's the
physical NES console or in this case you
saw an emulator and there's a script the
talk serial to the yes there was a note
server that all you connected to and
with real-time communication with socket
IO and and definitely there's some
actual ghosts in the mix here the back
end is actually really simple we first
made this like two years ago and I
wanted to show my package Jason because
it's like kind of silly how little is in
here and how old some of these version
which I thought you know I mean in the
in the age of you know tons and tons of
libraries and stuff like that I kind of
appreciate the the old school and so
back to the diagram a little bit so I'm
just using express to basically serve up
the the client to you the the all of the
UI is in that first HTML
and then it's JavaScript after that that
all speak socket IO to the server
you got a peek at our little back-end
admin gateway to switch the game modes
and the socket IO server that sits
between you and the NES is basically
maintaining the the state of whatever
like metagame you are all playing and
it's mapping your button presses to
physical RAM addresses and that 28 48
bytes of memory and and creating a
basically a delta change file that's
saying the audience has changed these
bytes to these values and that's what
gets sent off to a script to write those
values to serial to the nes front end is
also you know pretty standard stuff I'm
not even using like a I mean the UI is
not super complicated so it's just like
to query replacing stuff it's not even
react or anything like that
sock IO for the real-time communication
and I grabbed a little library called
fast click just for backwards
compatibility with devices so there's
not that 300 millisecond lag when you're
pushing buttons some of you might know
about for mobile you didn't see this but
you'll see it tonight so when you're
playing a game like you're playing Mario
in real time like I can instantly change
to another game you don't have to like
reload or anything it just switches so
you all of a sudden all your phones with
the intent rasol your phones being
contra mode and and that's pretty simple
like the client is basically just
waiting for the server to say hey we're
now playing Tetris and then all of your
UI to slip over and there's just like a
simple JavaScript controller for each
different game that then takes over
listening for UI events and sending data
over the socket IO stream this is kind
of like random but you know in case you
know any of you weren't familiar with
this there's like the long time
restriction of only being able to play
audio on the web if you in a click event
like you have to you have to like touch
something and then you can load and play
an audio file and I when we wanted it so
we had that creepy like all those bells
were ringing when you guys when that
when it's activated that wasn't on click
and so this is like a hack where you
basically the first time someone touches
the screen you set the volume really low
on the sound and and put an odd time
update listener and as soon as it starts
playing you pause it and then you can
use it later anytime you want
procedurally you don't have to use
another UI event to play the audio and
I'm assuming lots of you probably can't
read that code the back that's right the
client socket code is like way less than
64 lines to do all of that back and
forth it's really pretty simple
javascript is kind of amazing for for
prototyping and for rapidly doing stuff
as I'm sure a lot of you know like to be
able to build something like this in a
day really speak studying to the power
of JavaScript so the emulator that you
saw to tell you a little bit more about
that there's there's a C++ emulator
called fceux which is a great NES
emulator and then in Emscripten is a
tool that compiles from C++ to a SMGs
and so my finish is not great but it's
Val Valtteri hi Kela I think there's a
URL bitbucket org slash ps1 they were
the ones to originally do the EM script
and compile of fceux and did amazing
work optimizing the WebGL and Web Audio
API ever being used and so not only does
it run at 50 frames a second but it has
far in a way the best audio and music
reproduction of any of the JavaScript
NES emulators because there are a few so
it's kind of incredible that you can
just straight-up transpile c++ to
JavaScript and get such an awesome
result and so what I did was I took that
code grabbed the original C++ code and
just put in some new hooks to access the
RAM and expose those to JavaScript and
then recompiled and then that lets me
use an emulator like you saw today and
that was really important because I'm
from Minneapolis
and E is out in Brooklyn in New York
City and so we're in two completely
different parts of the United States and
basically we need to be able to do
research with each other like find these
RAM values that are interesting
what's the RAM value that makes Mario
swim what's the RAM value that makes
Mario shrink or change the colors on the
screen and so the way that we actually
did that was peer-to-peer hex editing of
the 2048 bytes of RAM and so and I can
actually show that see so let's go to
another demo let's maybe do let's do
well why not concert I guess so now I
can find my hex editor so this is a live
hex editor of the RAM this is one page
of RAM so 256 bytes
I think kind of page through memory and
see everything that's going on in this
like you essentially do like both
archeology on what's going on in these
games and also find out where you can do
these hacks and some of the stuff is
really interesting like here like this
looks like something right and it turns
out like this matches some values with
the color cycling that's going onto the
palette you can also tend to find music
in the engine too you can see where like
the the music is playing this one
doesn't have a lot of input and so I can
actually go through here and Andy in New
York to be able to do this to we'd have
two little cursors that we go around and
we start to find with values and so I
can do that I can start changing RAM
values here and it's amazing how
resilient these old games were
see like I'm corrupting a bunch of
random bytes and it's actually not
crashing it so let me go into play mode
here okay and then the first 256 bytes
of RAM are by far the most kind of
interesting to have there see that
killed me right away but it's mostly
this kind of first page that really is
that whoa it's still toast okay that's
normal that sounds normal
I'll see if I can find real quick okay
okay so let's see what this might does
maybe this one Oh see that yeah so I
know there's a byte in here somewhere
that you will instantly win the game and
I would really love to see if I can
happen upon that one that would be great
let's see yes
well this is that one the level not the
game there's another one we're literally
like the helicopter comes in in the
credits roll like wherever you are it's
great so yeah so the way I can I can go
back to the media sorry everybody okay
so the way that that works is I use PJs
which is a really slick and easy to use
web RTC rapper and WebRTC is a little
bit different than what socket IO and
WebSockets had been because WebRTC is
first of all peer-to-peer which allowed
Andy and my computer to connect directly
which is nice when you're 60 frames a
second sharing 256 bytes so you have
peer to peer and it's binary data and I
and I think WebSockets have gone on to
support binary but they used to always
be strings and so there's a tremendous
overhead of having to send two
characters for a single value or more
and so MRT sees binary data over the
pipe and peer-to-peer which is really
slick I was really happy with that it
wasn't it was pretty easy really to put
together this hex editor so this is a an
example of like archaeology in an NES
game so this is Dragon Warrior 2 which
is an RPG for NES and I decided to
enumerate every vet possible value for
inventory and I originally did this in
the English English language version of
the game and I just went like 1 to 255
what is every possible thing you can
have in inventory all the swords or the
armor all the potions and I found this
thing that showed up as perilous which
is like an English word that means
danger and you could equip it and you
could use it but nothing would happen
and I'm like what is this thing this
does not appear anywhere in the game and
I'm googling it I don't find anything so
then I hop over to the Japanese version
of Dragon Warrior 2 and I do the same
thing I enumerate all of the values that
you can have and now I have to compare
them one to one with English because I'm
like well what if they're ordered
completely different in the Japanese
version and so I'm like from the
I don't know any Japanese and from these
bitmaps I'm trying to figure out the
characters and then the and then use the
Unicode and paste it into Google
Translate and I'm like sure enough this
is an herb this is the great sword this
is the so-and-so's armor and
everything's lining up and it turns out
that perilous in the Japanese version is
music box of death and and I originally
died because I don't speak any Japanese
I originally translated it as a music
box of teeth and it wasn't wasn't until
the first time presenting to a crowd
like this but somebody who knows
Japanese was like uh you know like let's
that doesn't say that and so then I did
some more searching like music box of
death that didn't really turn anything
up then I you know copied and pasted the
the Unicode Japanese characters into the
search for that and I stopped like one
single forum post like old forum post
that was like a dragon I was a Dragon
Quest like Khan or something somebody
had asked about this to one of the
creators and they said that it was a
debugging item that they used to kill
the entire party at will they needed a
test death and they just disabled it for
the for the production release and this
kind of thing is actually really common
like Andy found a two-player mode in the
the ship's Tetris the retail version of
Tetris that shipped well one of the two
for the NES has a hidden two-player mode
that's like half-baked and so they just
turned it off but you can play it you
can find the byte in memory and you just
flick it and now you're playing
two-player Tetris and so there's stuff
like this in these old games and it's
really fascinating ok let's see well
actually so rather than do questions do
we want to do another demo yeah okay and
I have like five minutes right yeah okay
let's do a demo
okay let's do let's a Tetris because it
has great music
okay one second here
nice clown emoji whoever's name was
clown emoji so again the URL if you
don't still have in your history was
nest factor calm like the name of the
talk no specter calm or you can go to
that one
Tetris mode resume okay here we go so
you are corrupting Tetris while also
voting on what my next piece is going to
be and there are a lot of you in here
holy cow so if you all were nice and all
push the same button then I would get
that piece or you can continue to just
be really mean so it's going on is your
you're voting on what the next piece is
going to be but some of the pieces like
here look are actually out of range so
like you're basically picking a piece
that doesn't exist and then the game is
trying to compensate and you can hear
what you're doing to the music engine
when you press the music button I'm
doing alright and then you're also
corrupting that stats panel basically
every time you vote it gets more
distorted because all of this the whole
stats panel those pieces and the numbers
like are all represented in RAM that's
like value the what sprites should show
and so we're just corrupting them so I
can show you now how let's do this I can
go over here and I can send you all back
to conjuring
back then Mario let's say and now I can
come over here and I can put you all
into Marimo against love it now we also
have this light extra dangerous mode
where you're literally corrupting a
completely random fight that could
horribly crash the game or do nothing oh
my god
that's fine all right is that a vine
what does even what I'm sure that's fine
how I can't even know just I'm stalking
I'm just dog okay okay follow so what
I'd like to end with here
back to my slides I'd like to end with
is a little teaser we're going to have
more games
such as 200 player track-and-field and
kind of thing lots of crazy things you
can do
you just beat beat a level by crashing
and here let's let's quick show you how
man glass Joe and get started now there
we go
wait for it that's funny if you know
punch a little okay so come see us
tonight 7:30 play more games thank you
so much I appreciate it</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>