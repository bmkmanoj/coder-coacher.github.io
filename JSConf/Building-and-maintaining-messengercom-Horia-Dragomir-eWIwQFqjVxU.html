<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>&quot;Building and maintaining messenger.com&quot; - Horia Dragomir | Coder Coacher - Coaching Coders</title><meta content="&quot;Building and maintaining messenger.com&quot; - Horia Dragomir - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>&quot;Building and maintaining messenger.com&quot; - Horia Dragomir</b></h2><h5 class="post__date">2016-12-05</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/eWIwQFqjVxU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hola amigos welcome back from lunch i
hope you enjoyed it I did it was great I
am well you know who I am my name's on
the thing and everything but it's my
first time in Argentina my first time in
Latin America I could not have been more
welcome than I am right now it was also
my birthday four days ago so can i get
affiliate companies
buzzer buzzer that's great so let's talk
about how we build messenger calm if you
don't know messenger calm is a full page
react application on which you can send
and receive facebook messenger messages
or we had a lot of fun building it but
why would we even build such a thing
when there's already a perfectly
functioning chat interface on facebook
com well the initial personally stated
many reasons oh it's a full page
application reno meant for chat it's
distraction-free it's great but there's
also something that happened after we
launched that we didn't think about you
see a lot of big companies block access
to facebook com on their corporate
networks because they want people to be
productive i suppose but they don't
block access to messenger com so people
are free to chat even at work but before
we get into messenger com we should talk
about how we front end at facebook and i
really believe we should start using
front end as a verb it's hard to talk
about things otherwise but we fronted a
facebook like any other company
basically we use modules it's a very
simple paradigm it's a proven paradigm
it works well if you're not using
modules I really urge you to think about
maybe incorporating modules in your
workflow and modules are supposed to be
simple and simple to use simple to
implement to create a modulated Facebook
it's very very simple you open up a file
you give it a nice name messenger food
at CSS and you add this doc block this
doc book as it obviously says provides
the module messenger foo it's not a very
useful module right now because it does
nothing so let's add one rule to it the
quick of you my already notice that
there's something weird over there
there's a slash but that's that's our
syntax for rules we use the module name
and then use what the rule name actually
is ah that makes sense because you can't
change rules from other modules right
this is encapsulation that we provide
why would you ever want to do this I
will sometimes you do because
composition is a thing so we do provide
public classes and you use public
classes to style other rules that are
explicitly stated as this can
be changed by a thing that encapsulates
me but this is also bad why would you
always want to change a rule from
another module this will fail you can't
commit this you can't register
production you have to combine it with
your own classes very simple rules very
simple encapsulation this is how we do
CSS modules at Facebook and we find that
it works pretty well but this is all you
need just one rule is all you need to
have an actual module that you are free
to use inside say react this is a simple
example react component as you can say
whether provides module degradation we
also have a flow decoration over there
in the dark block I strongly suggest you
to strongly type your javascript files
it may seem like a lot of effort to do
up front but it really pays off in the
long term it catches bugs before they
even run in your browser but yes that's
how you use the class name you just you
know put the class name in the class
name and you're done or you can do more
fancy things like give it a hash a map
where the value is whether to use the
key to which it belongs right ah and
some of you might have noticed that
little thing the CX that's always there
and indeed CX is always there CX is our
class transform function it takes in
classes and gives in strings right and
it's always there we always use this to
add a class name to an element and
because it's always there we can do some
fancy things at our build step our
scripts will run over all our code and
look for CX instances and look at the
class names and by looking at the class
names from those modules we know which
files we need all right so static
analysis we know which files will be
required by this JavaScript module so we
load them up and ship them automatically
I've been at Facebook for about two
years now and I have not once manually
written a link tag or a style import tag
everything is done automatically and
this saves you of headache because you
never forget to include your styles so
we optimize a lot for the two most this
is one example where we automatically
bundle your
ESS for you and what I mean with the two
modes of software is not that you read
code more than you write code I mean the
human mode and the the Machine mode and
they're pretty different right as a
human being I want you only have to
write transform and I want something to
magically do all this for me I'm sure
everybody feels the same way all right
so obviously we have tools like this in
place we also do we also go one step
further and we optimized for machines as
well because if you're using Firefox you
don't care about the WebKit and
Microsoft transformed you only care
about the mass transformed so we do
create different versions of style
sheets and we ship the appropriate one
to your browser so we only ship the
bytes that we need the ship now this
saves bytes that we need to send down
the wire obviously and bites directly
translate into energy and we save a lot
of energy so much energy can say from
this every day that we can raise the
temperature of the entire board Osiris
City to California levels in its winter
for like a whole year but this is not
the only thing we do the next thing I'm
going to talk about is a pet peeve of
mine I really hate this but I have to
talk about it so it doesn't matter if
something is zero pixels or zero percent
or zero elephants from the right it's
still on the right the unit is
superfluous there we shouldn't add it
ever so we remove it automatically you
might want to add it because that's how
you want to write code but that's not
what we ship to the client we ship what
we need to ship that also saves bites
and remember bites save energy energy is
important the easiest way to save bites
and energy and file size in general is
to change the class names right to munge
your names human and machine work in
different modes as a human I need this
this tells me a story just tells me as
the title rule from the messenger foo
module a machine doesn't care a machine
needs a unique string that's all it
needs so we do this as well at our bill
stepp if we transform everything from
something this is humanly readable to
something that's not really human
readable so back to our initial
JavaScript example where we use this at
runtime CX says yes use both classes but
these classes ever
been transformed at bill step into
something very very short and it is a
lot simpler than what we had we would
have had to ship down originally and
this is where most people stop with
their optimizations we go a bit forward
so there's one more thing you can do and
we use packager for it packager does
what it sounds like it does it looks at
how we use code how we load our modules
right we oh we always load these two
files together apparently when we
require the javascript file we
apparently also always load these two
CSS files packager will analyze how
these are loaded and will transform
these two files into just one file
that's saving one network request never
request you know saves bytes saves
energy all that stuff it's very good and
of course you know this is an example of
package name the randomly generated by
machines so sometimes machines randomly
generate bad things some of you ready
see the problem this was an actual
package name that was generated some
time ago and ad blockers went crazy that
day they thought this was an ad when in
fact this was a very crucial JavaScript
for chat to work it was a fun day and
and even here I got asked a lot or
whether we prefer SAS or less or stylus
or what do we use and what we use
neither of course we believe that anyone
should be able to use Facebook but we
also believe that if you have the skills
that are required to build a basic web
app HTML and CSS in some JavaScript
that's all you need to be able to work
at Facebook so we don't use last or less
or SAS so that we don't you know stop
people from flying to Facebook or
joining face began being productive on
their first day nonetheless we do
realize their value because they are
extremely helpful and powerful all the
preprocessors so we do kind of have our
own things on the side one of them would
be our CSS constants which is our
implementation of the you know CSS
variables obviously you use CSS constant
with the VAR keyword but that's a
discussion for another time
so I hope that now you maybe have an
idea of how things happen at Facebook
and how they get in you know from my
hands into your browser so let's talk
about my future before we talk about
messenger we need to talk about how chat
got rewritten in 2011-2012 the whole of
child was rewritten from the ground up
and the people who did this back then
had this wonderful idea to create these
style agnostic components they would not
know how to present information but they
would know how to get information and
pass it along to another component the
other component will be a renderer and
we call these components containers and
that's how a lot of our infrastructure
is built container render a container
renderer you know something wraps a
presenter and that's wrap again in
another container that is wrapped in the
other presenter and so on it's like a
big big rap we call this shawarma driven
development it works a simple example
say we have a theoretical module that
lists recent conversations that you've
had it would call into the style
agnostic components hey I want
conversations this is your presenter the
component that knows how to render them
an optional class name for some styling
hooks and inside that component it just
says yeah sure I got the threads and it
passes them down to the component it
doesn't know what the what the renderer
is why they will do with them and
doesn't care and again the shawarma wrap
goes deeper and deeper container
renderer container renderer so because
we were able to reuse most of the
infrastructure from facebook com we
could focus on you know CSS a lot more
which is great and the first thing we
decided was we don't want to pull the
old browsers facebook com different
story right we believe everyone should
be able to use facebook regardless of
their device and there is capabilities
but messenger calm was a new product and
by definition there was a niche product
so we didn't need this all-encompassing
support dropping support for all the
browsers meant we could use new CSS
stuff like transforms but mostly flexbox
initially you know we wanted something
that has a simple clean three-column
layout and we implemented using
Xbox and mmm it didn't really work too
well the first time because you know
flexbox has had about three different
types of implementation and they've all
had different stages of evolution and we
wrote our static transform rules the
things you know analyze our code and
ship you know change it to be production
ready at various stages of that
evolution so sometimes we had
conflicting rules we would export very
bad things to Safari or very bad things
to Microsoft but after we fixed them and
revamp the whole way we've powers
flexbox rules we finally had a nice
looking thing we think it's nice-looking
I hope you agree so we had we had layout
out of the way we got right pretty early
but we weren't out of the woods because
bad things just happen to people you
know can you tell what's wrong with this
let me let me make it bigger so
obviously the comma is jumping and it
shouldn't why with a comma jump and in
right-to-left languages as you're typing
and you want to add a common type comma
space as you do sometimes the comma will
flip it space is placed with the space
and we had no idea why turns out it was
because we were using one fun definition
messenger calm is a web app like many
web apps we have one font family itself
on stack and we use it everywhere right
everything inherited we were happy we
were using helvetica neue which
apparently has this problem if you're
using a right-to-left locale and you're
typing sometimes it will decide to
magically switch the comma in the space
it is a very poor experience for people
who have to type in right to left so we
don't have just one fun definition for
people who are typing in right-to-left
we use aerial which is the fallback
phone for facebook on as well and I hear
the gasps and people are going re oh yes
re oh the boring old re oh but the
battle-tested Ariel has been around for
ages it's had its kinks wire and ironed
out down any problems like that I with
REO it might be boring but it also works
well another thing we were doing wrong
is we wanted using pixels facebook.com
uses pixels because it has many
components right messenger com is
a full page application we shouldn't use
pixels it would be hard to use because
we need to use percentage based
everything mostly about most of the
components that were for layout or were
for positioning some things required
pixels so we need to re-implement them
not only that but we need to be able to
accurately represent when you send one
photo of shawarma or two or three or so
on in short we need to be responsive in
a lot of ways and you can be responsive
in a lot of ways not only by changing
you know from pixels to percentage based
but from providing a better canvas to
your viewers on the data we launched we
got featured on good products as you do
and one person spent I don't know how
long doing exactly that just resizing
the browser back and forth taking notes
and when we hide or show the right hand
column and you made this an amazing
review about how much thought and effort
we put into this and this may be cool
but it's also very in-your-face it's a
very big change when you don't have
enough room we'll take that away so that
you have enough room to view the
conversation properly that's very
obvious but you can be responsive on a
much smaller scale to messenger calm is
a messenger app therefore it looks like
your messenger app on your phone so
titles are centered I but if the title
is long and the space gets short it's
really hard to truncate you know Center
aligned text if you have an icon on one
side of it it is not fun and CSS alone
couldn't really help us here maybe
element query if we ever get it so
instead of using a CSS only solution
which wouldn't have really worked we
measure the sizes in JavaScript and if
we detect that there is going to be an
overflow we flush the text to the left
and we apply to occasion been and it
looks okay so it's not a CSS only
solution and it doesn't matter having a
CSS only solution does nothing except be
of CSS only solution no one cares the
people who use your application won't
care if its CSS only or you use some
JavaScript the developers will have to
maintain this after you won't care
either it's only a bragging Dart
isn't that important but I mentioned
that messenger calm is a messenger app
and well as a messenger app it follows
some style guides we have one style
guide on Facebook right the design looks
cohesive everything looks like it's
connected that gets in its right place
because on facebook com everything
follows do you know what this is say its
name yes they follow the fig and we have
a similar style guide from messenger can
you guess what we call it we call it the
MiG the messenger interface guide
obviously fig stands for facebook
interface guide we built that the
interface guide around the time we were
building messenger calm and it wasn't
just designers who are working on it it
was everybody involved in the project
and we found that was a much better
experience than waiting for designers to
finalize something this way we have back
and forth and productive discussions
about what made sense of what didn't
make sense so compared it to my facebook
button messenger button our button looks
a lot like a link trust me it's a button
but even though they may look
differently they still apply that same
design agnostic component kind of
concept to them they both wrap an
abstract button that really knows how to
be a button oh that's all it does it
knows how to be a button really really
well it knows how to beat a bobble it
knows how to present the right labels
and also be you know screen reader
accessible and we just add some starting
to it and because we were able to reuse
all of those components on facebook com
we saved a lot of time but we also got
accessibility for free I want to take a
moment to emphasize that it doesn't
matter how beautiful your product is if
you can't see it so we got accessibility
for free and we improve the point where
we could while maintaining our style
guide which is great and our struggle
has constantly evolved because initially
we always had yes messenger blue and
everything was messengered blue but as
I'm sure you know you can now change
colors and you can have different colors
and well the day that they started doing
this on Iowa
an Android we caught wind of it before
it was public we saw it and we thought
yeah that's a cool idea let's let's do
this to one went yeah let's just do it
so we wanted to get an internal test
ready um changing the bubbles was
actually very simple but the one thing
that kept is busy the whole day was that
little thing that little thing used to
be an image it was just a raster image
of a thick and we thought okay we can
change the images to be you know 12
images as many calls as we have and then
though that doesn't know I don't want to
manage 12 images for one icon and then
have 25 icon no I know how you CSS
filters great right you have the hero
Tate when I talked about them you can do
amazing things with them and this was at
6pm when I started calling out on
Twitter for help because CSS filters
won't really really work you can't
predictably change one color to another
if you know both the car you for me
where you want to get em where you want
to start from because they use different
color space is the way you analyze and
reason about colors and JavaScript will
be very different than how CSS filters
will apply that those transforms and if
you want to make sure that you're using
the same space then the math becomes
obnoxious and all of that to change one
icon is not worth it also the typos that
everyone made that day where sometimes
awful so in the end in the end we we
scrape the whole CSS filter thing and
weary implemented the image using a
simple live with a border inside of it
and we're using custom current color to
change the colors it's a lot easier and
this leads into my next point d I just
don't like the image tag I mean it's
okay for an image but I don't like
displaying images with the image tag
because it's just so obtuse I don't like
it at all remember we need to do this
and we want this to look nice you want
this to look nice as well it's it's
better if shawarma looks nice but to do
this with images you can already start
to see in your mind what the problems
would be you have to stretch them they
look
horrible you need to crop them how do
you copy couple on the server what if
you resize the browser the problems are
endless so obviously we don't use images
because if we would then we couldn't do
this if you send a link and we attack
the link has an image and we'll take the
images big enough will display it in
this wide format firstly if you send a
link and we detect it has an image but
the image is pretty small will fall back
to the compact layout this is the exact
same component using mostly the same CSS
rules except for the one that positions
de image which is not an image because
you can't do that with an image you can
do it reliably and it doesn't work and
cropping well you don't get cropping but
you do get cropping with background
position and background size and all you
need to do is set the URL to what you
would set the image and then CSS will
pick up everywhere else doing this
enabled us do some funny things like add
maps to our components because they were
so apparently well separated people were
able to implement other types of
attachments not just links but hey yes
your thing is on the way it will arrive
there you can Pan the map and all the
things arm or you know go one step
further stickers I'm sure you use
stickers on messenger they're all
implemented the same way on web and
payment receipts I don't know if you
have messenger payments in Argentina do
you know I'm sorry it's a very cool
product that we have in America it's
really really easy to semi to your
friends but but that was the cool thing
that they are we like the most yes we
were the first complex web application
to live on a domain that's not facebook
com but use facebook com infrastructure
Oh what we mostly like with other people
who then came to build upon our platform
they said it was a pleasure because our
components were small rather silly but
flexible and you could use them in a way
that always respected the style guide
and was powerful enough to be able to
you know compose them into something
better and by the way even if we don't
use image tags to display images you
should still use image tags in the dom
because a screen reader can reason about
an image tag it knows what it is it
knows how to read it out
you can also right-click and save it so
over most of the images you see here
there's actually an invisible image
element that has the same URL just so
you can right click and save as and all
these lessons that we've learned and all
these problems that we've had to fix
have you know accumulated in our minds
and we had a lot of fun building
messenger calm in a nice clean interface
everything is a lot flatter it follows
the messenger style guide and then we
took a look at from where we started you
know the big chat rewrite of 2011 2012
and that was a while ago so applying the
knowledge that we've gained and the
designs that the saga that we've matured
we've also redesigned chat on facebook
com quite recently so in closing I would
like you to use messenger com if you're
not already it makes it very easy to
talk to your team to talk to your
friends to talk to anyone it's a
distraction free environment and let me
know what you think I am here all day
and i'm looking forward to talk to you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>