<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[JSConfUS 2013] Janessa Det: BPM Detection with JavaScript | Coder Coacher - Coaching Coders</title><meta content="[JSConfUS 2013] Janessa Det: BPM Detection with JavaScript - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>[JSConfUS 2013] Janessa Det: BPM Detection with JavaScript</b></h2><h5 class="post__date">2013-08-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/XAqSLcNI9Ac" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">let's get started so BPM and Jas the
thing is most of us already know have an
idea of what BPM is it's beats per
minute and you know we know it's a
generalized tempo measurement for songs
see how fast or slow it is but if you
really look around historically it's
been a very manual process you have
people labeling the actual beats and
uploading profiles to databases to make
this data available to applications and
you know that's just not ideal in a
world where things are changing so
quickly and we want this data available
readily so I wanted to look into number
one how to make this an automatic
detection process and second of all you
know just trying to bring it into the
JavaScript world so that we can all use
it first things just a little bit about
myself right now i'm working at twitter
in the new york office as a software
engineer on the web team my name is
janessa debt if you didn't catch that
from the first slide and the program and
previously from that I come from the
background of computer graphics and
vision and then before that a lot of bio
engineering where I mostly hated the bio
and mostly like to the engineering so so
what are we really talking about here in
terms of what's behind automatic
detection of BPM well in research they
call it on set detection so if you look
at the signal that I have here what we
have is we're looking for this thing
we're looking for when the beat happens
there's a really sharp signal change and
we want to see where that is to know
where beats are happening so what this
is fundamental to is like a million
different fields and that includes sonar
speech EKGs movement detection and you
know some things maybe like Iron Man I
think I secretly wanted to put him in
slide the student something but
seriously sort of so discover ran an
interesting article about becoming iron
man how close is research to really
making these suits that you can control
you know with your nerves if you're into
the comic books that he installs stuff
into his body to interface and you know
that involves things like EEG or
electroencephalogram EEG on sets for the
nerve signals and you do a lot of
analysis after
but you get the point this is a very
fundamental sort of applicable thing not
just to music but a lot of things but
since I'm a music nerd personally I like
to think of it this is a much more
interesting application that I want to
look at which is a automatic
transcription of music the first step is
you know detecting your beats of course
but there's also things like instrument
identification instrument isolation
pitch dejection dynamics all things that
I plan to hopefully in the future look
into as well and by reading lots of
research papers and stuff so so why did
I want to bring into the browser like
you know there's see implementations in
research being passed around of this
stuff well the biggest thing is I find
research papers in this whole academic
research area to be so niche and closed
and you know entwined in the politics
and people never really look at research
papers I wanted to bring that sort of
engineering and make it accessible and
shareable and cross-platform and make it
easy for all of us here to just use and
play with and the other thing that
enables this is that you know the
browser's javascript is seriously fast
now like it's no joke like this article
that ran earlier and that's really just
it's just helping us to do things that
are really computationally heavy without
having to worry about delays and lag
time as much and with things like you
know we just saw so much going on with
WebGL and web audio and digital signals
processing is really enabled in the
browser now it's pushing that forward we
can do a lot of these computational
things which you know makes the
browser's really powerful you can do so
much awesome stuff so the caveat of
course is you know all these things are
great but they only work in the latest
and greatest canary beta you know new
shiny builds of I'm sorry about that I'm
in chrome firefox safari and opera and
that was a little bit mean because i ii
really is coming along with that but
also why in the browser well you know
when i was thinking about doing this
honestly this was the biggest reason I
think javascript is fun I think this
stuff is fun and it would be cool to
play with and I think that's the best
reason to start working on something and
another thing to know is that the
browser is really diverse now you know
it's not the 90s anymore for document
display
most interesting thing I could find was
you know unlimited gifs of Sailor Moon
or gifts or whatever and more
importantly the community is really
diverse like we've seen such a great
subset here of the JavaScript community
everyone comes from such different
backgrounds and art background music
backgrounds you know all sorts of
engineering and because of that we're
really pushing the use cases of the
browser and what we can do with it and
what it's becoming enabled for you know
we're influencing it by making people
who are on the standards community think
about the different things that we want
to do it that besides you know
displaying all the animated gifs you
could possibly find on the Internet my
personal mission in terms of this little
diversity thing is I come up from an
engineering background from my undergrad
I'm a huge music nerd and you know now
I'm doing full-fledged computer science
web development so I like to put this my
bio finding ways to breed engineering
research music and art with a trusty
steed of JavaScript that's JavaScript
not horse GS to make the magical
unicorns of my imagination reality so I
found an image that sort of like
captured my mental image I wanted to
share with you so just in case you
didn't know this this is magical unicorn
I'm going for breathing fire like epics
eyes and that's me that's the cat riding
the epic magical unicorn and there's a
little nyan cat in the back from the set
I thought that was like really awesome
but you know this is like living the
dream like I you know I'm going to take
engineering it's smash it with art and
music and JavaScript and it's going to
like look awesome but so far because
things are coming along a lot of my
projects end up looking like that you
know what is he saying there I must eat
more rainbows like it's it's there a
little bit lumpy and awkward right now
but we're getting there you know and
it's still a lot of fun you still have a
unicorn it's just you know in kind of
you know awkward and derping but anyways
let's jump in let's breathe some
unicron's so this is a big question
right how do we do onset detection like
what is this first I want to take a
quick step back and think about you know
BPM we think about it because DJ's are
like all popular now and you know BPM
it's like that you know some pump that
you hear on the bottom but
it can mean a lot of things it's really
tied to human psychology and it's can be
anything from percussive beats which is
what we think of it could also be
pitching notes you know you have like a
flute piece from the classical music era
and it's like you don't have a drum in
the back like you know and seeing you
know like in a club so on sets this is
just a little bit of research
terminology they like to categorize it
into a lot of different names because it
is more complex than just detecting
where the drums are so there's you know
pitched or not pitch percussive and more
commonly now it's complex mix which is
basically like everything else because
we can't label everything some quick
sort of just scoping a lot of times V
pm's are associated with genres these
days for an example you know drum and
bass they like to say it's like 160 to
180 and etc etc and you know if we're
talking about classical music if you
have a background did it I did piano for
14 years so this adagio for an example
66 276 BPM it's not just this new DJ
thing like matching bpms in the quote
you know so detection method so how do
we do this and how did I learn how to do
this well I read a lot of research
papers and I'm not going to read this up
to you right now but I think this part
was actually a lot of fun and
interesting understanding some esoteric
language so I'll break it down into
something sort of bite-sized for this
talk so first what we're doing there's
some general steps we're doing an SD ft
short-time fourier transform which
basically the purpose of it is to prep
the signal for detection functions then
we do the detection function what these
are our functions that are meant to
selectively maximize for on sort
properties that we're looking for and
turn them into strong signals we can
peak pick out in peak picking which
after you have those highlighted on set
times you can pick out those times from
the signal that you've now got all I
processed and from there it's the you
know home free you calculate the BPM so
I'm not going to go too much into the
mathematical detail of things but
I do want to show you a high level view
of what this looks like just so you have
an idea of what I've tried to stuff into
javascript st ft does a number of steps
it's not just a fourier transform it
does window slicing slicing the signal
into overlapping windows often for this
application as small as 50 milliseconds
80 milliseconds and then you apply
Hamming window to trim off the edges of
bad stuff basically discontinuities and
normalization normalizing the magnitude
and zero padding because it needs to be
a power of two to do an F of T on it and
it clarifies the signal and get into
that if you want on your own and then
finally you do your FFT and get a bunch
of complex numbers in a matrix so
detection functions what these look like
I'm going to go over the ones that were
frequency based because they were more
robust out of some of the ones I looked
at and also these seem to be the ones
that are more prevalent more robust
Scott recognition high frequency content
and spectral difference I stuck the math
in there if their math and engineering
nerds and want to like dig into the
exclamations but these to maximize on
energy which you know tends to be those
percussive beats phase deviation is more
sensitive to things like pitch and
euclidean distance tries to smash these
two things together into something a
little bit more balanced so you know
we're looking for that onset they're
trying to highlight it peak picking
there's a few it's not as simple as you
would think be just because these
signals are noisy and you're doing
processing on them they're still going
to be noisy so you're building an
adaptive threshold which you'll kind of
see the visualizations later that I have
for this and by applying that threshold
we try to cut out the noise and actually
pick out where the on sets are so
initial peak finding you threshold them
out and refractory period is another way
of filtering where you say oh there's no
way that there can be a beat between
this time at this time cuz it's too
short and it's probably noise because
they're right next to each other so this
helps to cut out some of those noisy
signals if you pick some of your windows
wrong
um and not to bore you too much with the
nitty gritty details of this but peak
times this is a trivial example but say
I have a bunch of peak times so it's
really simple from here it's about 0.5
across the way I average it and there's
a beat every half second and that's
about 120 BPM you missed the happy
unicorn I press next well I think the
unicorn I had high hopes for my unicorn
how do you do it in JavaScript I'm going
to go over some of the fun things I ran
into their kind of fun oh but before
that I tried to think of some
interesting things I could do with this
you know initial implementation and i
found one song that i particularly like
if you don't listen to discovery they're
fantastic you should look them up but so
insane by discovery they do an
interesting thing where and two in two
spots in the song they kind of dip it
down into a lower BPM and like slow it
down make it like all you know groovy
and I wanted to see if I can maybe pick
that up by slicing it into 10 second
signals or 10 second windows of signals
and pushing it through and seeing if I
could see a modulation I signed some
colors to it where darker means a slower
BPM and lighter means a lighter a higher
BPM and I found that these two patches
you know there tends to second signal so
it's still pretty granular but it
actually picked up pretty closely to the
timestamps on the bottom where these
were happening so I was really excited
about that one to show you so tools that
I use that were really helpful just
being like how do i bring this research
paper and put it into javascript and DSP
jas was really helpful I didn't have to
run my own fft algorithm it's been done
it's been out there and people have been
using it I used it also for my windowing
function so that was super helpful
there's a note actually you know there
wasn't an NPM version I've had to do
some interesting wrapping of the stuff
only that I needed and taking it out but
Web Audio does great things like how i
used it in its most rudimentary form is
you take a signal you throw the file at
Web Audio and it will spit out a sample
and a float 32 array for me to work with
which is great complex arithmetic you do
have to do complex math with this so i
found a handy npm module so that I
didn't have to write that too because
that would just be silly to reinvent the
wheel and a lot of the other stuff I
just had to kind of write a lot of math
and stick it in a lot of loops so for
that browserify was a huge help for me
just being able to keep my code
organized and sane so I could see what
was going on see how things were
connecting clear a thing about how it
actually connected together BPM that was
my like main driver module web audio as
I said feeds a signal and information in
and these were the three things i went
over before so I separated them out
according to what I saw and a lot of the
math was happening there so connecting
up all of those things there and
detection I had the for detection
function so this is much easier to you
know browser fighters I just really like
it and source maps are awesome so so
interesting challenges that Iran to this
is a little anecdotal I suppose I've
never really had to work with float32
arrays before this so that was
interesting because I realized you know
you can't just add zeros on to the end
you have to like slice it and like copy
be a ray buffer and stick it in a thing
that's bigger and so that was
interesting to learn about and I mean
that's the best thing if you're learning
when you're building new projects so it
was fun but compatibility you know Web
Audio is enabled right now in chrome and
now also in beta versions of everything
else which is great but that's something
that you kind of have to be realistic
about and then complex arithmetic in
matrices like you know coming from
engineering where like MATLAB does
everything for you they have like a
function do the most complex things and
matrices and just spits out answers like
Java scripts not built for that so I had
a lot of like verbose like pushing stuff
around like beating it into like
JavaScript form to make it really like
pop out the complex stuff that I needed
and the biggest thing was just figuring
out how not to break chrome I have an
optimization slide later where I know I
haven't addressed a lot of optimizations
things that I wanted to do but didn't
quite get to so I'm aware but
was really interesting so there was a
lot of this where I actually put t bug
statement in a place that I probably
shouldn't have put a debug statement but
it was late at night these are those
complex objects from that library and it
was like for windows in it was like put
and you know I tweeted it out of
frustration of course my snarky
coworkers are like well we could just
doing something complex well there's
your problem like saying sits like four
in the morning not encouraging but like
literally it would get to the point
where you know chrome started showing me
like measurement rulers randomly and
they would get like stuck it be like by
the way your window is blah blah and
like I've never seen this before I have
what did I do to it like you know my
poor chrome is like crying at me and
like after a while like yeah I would hit
localhost 3000 and literally it would
just meet a crash be like no I know what
you do at this dress like you can't do
this anymore to either stop but that was
interesting and you know looking at
these arrays there's a lot of dots
behind this tweet where it's like
thousands of you know indices that I was
kind of scraping through it and you know
you make mistakes doing like math.pow
late at night doing math pow number two
instead of two number and etc so I was
getting a lot of these like no no no no
no no no and when you're you know seeing
a lot of these late at night my head I
was like nananananana batman i was like
god i'm going crazy like someone save me
from the nand's so these were some
interesting nights me and you know
chrome happy together in Batman um
anyways enough of that you get the point
all right so here's where I'm going to
kind of I stuck a lot of little plotter
things in there to help debug and I
think it really illustrates what's going
on in the signal and to see you know all
the math stuff that I did before in
action so I thought that would be
helpful to kind of show my code working
and crunching these numbers and shaping
them so this is what the original signal
something like this would look like it's
just plotting the signal Hamming window
trimming off the edges as I said then
the normalization the numbers are like
tiny but there's like one at the top of
that and zero padding as much as you
want and then FF
tease it you know you saw in the
previous screen shots just complex
Cumberland complex their complex numbers
this might be a little bit small but
they're actually not that many lines of
code it was just a little bit of
wrangling working with float32 arrays as
I said you know padding the signal it's
not just like push punches ears at the
end it's like no there's like an array
buffer and then a view on top so things
like that FFT this would have been so
much longer if I didn't have DSP so you
know god bless Diaz pjs same here for
the detection functions I'm just going
to bring them all out here so these are
the four that I covered before kept the
math there they're actually not that bad
you know once you learn how to read
mathematical and you know discrete
notation like you could do so much with
it so maybe I'm echoing other people but
like don't be afraid of this stuff it's
it's just a couple lines coat you know
not bad unicorns still looking pretty
good I thought peak picking so this is
what it looks like after I've applauded
detection function I've done that
Euclidean distance one here so you see
that you have some like strong peaks
going up here and that's detecting where
those on sets are happening and it's
really like spiking the signal up there
so that you can pick this out afterwards
here is the median filter step which is
part of the threshold assuming over the
signal according to a window size that
you can kind of filter out a lot of that
noise that's going on that's just
interrupting like seeing clear Peaks
like that so after its filtered it's a
lot clearer it's flat it's flat like
that and you basically choose out the
peaks and etc etc and you have an array
of times and like I showed before you
take those and what I do is I take the
gaps average them and do a little bit of
math and you have a BPM for your sample
so here's my optimization and
performance slide how not to break
Chrome I know there are ways and I just
have it quite delved into it yet but I'm
excited too soon because I want to fix a
couple things but web workers I think
are just ripe for this sort of thing
especially for the short-time fourier
transforms
step where and have like a gazillion 50
millisecond windows and doing the exact
same thing to every single one of them
so you know pass them into a web worker
I'm as far as i know i know there's like
an exception for typed arrays as well
where you don't have to serialize and
deserialize it which just slows
everything down and i'm using typed
arrays so if i can just pass that
through process all the crap and pass it
back like that'll be a huge performance
gain for me most music songs don't
change in tempo or BPM so if I slice
well-selected windows I don't have to
process like a 10 minute song all at
once like you know take it one from the
beginning middle and end like I think I
could basically figure it out and that
would save just a ton of computation oh
I have a third point that didn't show up
but it's basically about you know as I'm
jas you know and L ljs it's perfect for
this and I've just started learning
about it so I might go back and like
rewrite the whole thing and LLL and see
what happens so we'll see but I thought
this was interesting so I tried out a
matlab implementation and MATLAB is like
you know the engineering dream it does
all the things with matrices all at once
for me you know median filter like I
wrote a median filter that one it's like
median one signal window size it's like
one line I'm like wow wish I could do
that in JavaScript I guess love to make
it so people can do it dresser but it
was cool because you know I was testing
the signals on both of them and they
actually take about the same time it's
not like MATLAB is like exponentially
faster like I thought it would be I
think a 10 second signal I tried it was
like an uncompressed wave or something
it took a couple seconds in the browser
just not bad matlab was about the same
you know it's like busy busy busy and it
spit out some stuff so i was really
encouraged by that you know like go Jess
love it and you know the dream here is
if I can make it fast enough like all of
this processing stuff with like the
heavy computation has always been like
something I post back and it generates
and generates like it's been a couple
hours can I accept it yet like there's a
queue can't fetch it yet but if we could
do this like all the client side and
just like process almost real time I
think that would be super powerful just
for
you know anything you think of to do
this with oh there it is as inscripted
ljs if you're a here for Brendan's chalk
which was epic you know about all that
alright so there are some weaknesses
that I need to be realistic about and
these come straight from the research on
onset detection you might have heard me
mentioning things like the median filter
window time you know the window slicing
could be 50 milliseconds or 80
milliseconds and the thing is if you use
those wrong like you just make really
giant windows or you filter out that
thing so it's so smooth like you
eliminate all the on sets like you are
going to break this like it will give
you crazy numbers that make you know
zero sense so that's just something to
be aware of and something that you know
I still need to test different
parameters for different detection
functions to see kind of where I can
apply them and where I can't and so also
previous feeds into that prior knowledge
is often helpful to selecting the right
detection functions like I said some of
them are pitch based so if you have like
a flute piece like the pricasso one is
probably not going to do that well on
that but you know phase deviation might
and there's still a lot going on
research so there's lots of reading to
do and just more things to look into so
future work just on the more general
side besides wanting to make it faster
is this is really only scratching the
surface of research like I read a couple
of papers found some good summary papers
that summarize a lot of things going on
in the fields but there's so many more
detection functions that people are
developing every day like this is their
full time job they're phd's like
underfed underpaid and this is what they
do all day in the lab and you know I
almost went into research and I'm glad I
did because I don't have the personality
for that but god bless lot of people who
do like this is crazy awesome stuff and
as I mentioned previously for different
applications you know onset detection
exists it's just for signals so really
the only differences is yanking out the
detection functions I'm using for music
and sticking other ones in and maybe
other things I just haven't read up on
you know on such detection for nerve
signals and stuff like that
so grating time so how did I do was my
JavaScript music engineering you know
stuck together and taped with scotch
tape unicorn beautiful well it's a
little bit forced like I have to admit
like it's I felt like I was like
sticking you know like cuz engineering
is a cute pug and into like a JavaScript
horse suit and it grew a horn and some
like fudz like it was it was okay like
there's a lot of things I can do better
hopefully that I clean it up you know
put more skin on it and it's like it'll
be good like we're really getting an air
with the browser the web is changing
aggressively and you know just as a
quick example i was just searching
around mpm for stuff to use and just to
see what i could find when you know very
like basic engineering certain keywords
DSP digital signal processing FFT which
is the fast Fourier transform filters a
little less there but there's a lot of
stuff out there for free that people are
using every day downloading maintaining
you know like this is really awesome
stuff like it's available for us to play
with and use and improve upon and
contribute to in god bless em p.m.
because I just did a search and I found
everything I needed so and things like
you know web audio and you know the w3c
really pushing forward on a lot of these
really powerful tools and you know des
pjs who's like written forever ago but
glad I didn't have to go to someone else
did so and it's a lot about you know
rethinking web engineering it's like I
thought that when I left biomedical
engineering so I hated bio it's like oh
god I like learned all of this
electrical engineering stuff for nothing
like what am I gonna do but you know
today you know yesterday I built a robot
with like a breadboard like the old days
and like you know now I get to use this
stuff in the web like you know I didn't
have to leave all that behind so what
does it mean to be a web engineer these
days how about more engineering like you
can bring all these things that you've
learned or if you want to learn like
there's stuff out there to learn and you
know we're all smart people that's why
we're here so how about more engineering
this kind of stuff with vendor prefixes
is not the final frontier anymore i know
a lot of people you know friends in New
York who have come over from finance
like completely different
Fields having no idea and they're like
oh my god okay look I found like CSS
transitions and I'm like that's really
nice now let me show you something on
NPM that it's really fun to play with
that you should play with like that
whole connect talk earlier like they
would have so much fun with that like
you know these are cool and they're
important but like it's not the final
frontier like there is things beyond the
vendor prefix cacti and it's thorny in
the vendor prefix cacti but that's
another topic I think it's just really
important and I mean now at tort you
know towards the end of this conference
I feel like this is not even necessary
to say anymore but you know there have
been so many diverse talks just you know
today and all the other days and it's
really important for us I think to
embrace diversity like I think that this
field is young enough like you know web
engineering and JavaScript that a lot of
the people that I've met here are really
diverse they come from engineering
backgrounds art history background music
you know like fine arts anything you can
think of they've done it and I think
because we're such an open community
like that's what we're known for we
really need to embrace that and bring it
together and collaborate on all of our
different talents you know knowledge
really builds upon itself and combining
these fields generates a lot of powerful
tools like you know you don't have to
figure out everything yourself like your
peers have done this like you know like
Raquel she worked on robots for years
and years like she can answer all of
your questions just ask you know and you
know just thinking outside of the box
like i said before like you know i do
web engineering at work all the time
every day but in my free time you know i
want to do something different but it's
still things that i know the web and
other things but it's really exciting
and a lot more fun i think for my free
time to just think outside the box so
you know breed on unicorn and that's all
I've got and I just wanted to say again
like I really look forward to seeing all
the diversity you can bring to web
engineering and you know show me what
you want to do and what you can do and I
think we'll all be better for it so yeah
that's it thank
Oh</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>