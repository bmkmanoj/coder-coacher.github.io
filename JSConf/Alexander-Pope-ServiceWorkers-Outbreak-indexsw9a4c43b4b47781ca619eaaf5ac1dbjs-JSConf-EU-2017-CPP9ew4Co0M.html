<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Alexander Pope: ServiceWorkers Outbreak: index-sw-9a4c43b4b47781ca619eaaf5ac1db.js | JSConf EU 2017 | Coder Coacher - Coaching Coders</title><meta content="Alexander Pope: ServiceWorkers Outbreak: index-sw-9a4c43b4b47781ca619eaaf5ac1db.js | JSConf EU 2017 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Alexander Pope: ServiceWorkers Outbreak: index-sw-9a4c43b4b47781ca619eaaf5ac1db.js | JSConf EU 2017</b></h2><h5 class="post__date">2017-05-16</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/CPP9ew4Co0M" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">music hello welcome to the last
sidetrack event my name is Alexander
Pope and I'm really excited to be here
today to share this story with all of
you it's a scary story so I hope nobody
has a weak stomach and like the scariest
scary stories it's all true most I'm
going to try something here we can try
and actually say the title of the talk
this is outbreak index
- SW - 9 a 4 C 4 3 B 4 B 4 7 7 8 e 7 D 1
C a 6 1
II a a net 581d B Jaya
if this wasn't attached to my head I
would just go up and like and go but I
have a story to tell here we go
in the corner of a functional Lowell
Thomas OpenOffice Alexander sits at his
desk staring intently at the screen a
phone ringing in the background
momentarily disrupting the early morning
students hey wow you can input analytics
table can I use and it looks like we
already have over 50% service or support
Alexander it's still considered
experimental the specification has not
yet stabilized now that's all they were
talking about at Google IO serviceworker
is the best thing in a check and already
huge in India be not the first time did
me or tried nor yet the last to lay the
old aside the following morning in a
cramped meeting room
Alexander enthusiastically sketches on a
wall-mounted whiteboard this is great
basically a server in your browser you
just call navigator serviceworker
register with a path to your script it
returns a promise that's cool Alexander
I hope you are aware that the
serviceworker lifecycle is non-trivial
there are many opportunities for error
nonno nonno this is the web something is
broken you fix it and ship it continuous
delivery for the win at Google i/o they
recommend it you just change something
the service or Pharaoh will be
invalidated and reinstalled eventually
anyway within 24 hours at least
fools rush in where angels fear to tread
days later Alexander hurries the cleanup
committee while rebasing a get merged in
time for release the desk is littered
with disposable coffee cups bed unique
Anthony add features like youth cash
Christmas at cache expiry logical cash
all API JP nadda add app shell add
online offline Status Messages
remotely log errors Alexander
haven't you forgotten something what
about testing testing serviceworker is
hard so many Global's and an
installation life cite things are
working fine locally anyway it's
progressive enhancement the most
positive men are the most credulous
several weeks pass in a quiet of a
darkened Theory Alexander anxiously
stands there
notification alert type error undefined
is not a function another function how
could I service with local scope Oh
not be a function the hell is going
online I don't get it
things have been running smoothly for
weeks they only change here some
refactoring how could cache at all be
undefined it works fine on my machine
versions ago prior to 46 did not ship
with cash back at all among other
differences the specification is still
unstable as you are well aware shut up
you are not healthy to focus and revert
these changes one week later back at the
office
Alexander puzzles over the latest error
loss that's weird
and almost a week since I've heard of
those changes there's still lots of
tears it shouldn't take that long to
upgrade it's just not possible
the logs say otherwise there have been
more than 2,000 errors reported in the
last 24 hours alone more weeks pass
visibly tired and distraught Alexander
slumps over his computer at the dinner
table a baby cries
this is starting to freak me out don't
understand how that can still be so many
errors and it looks like it looks like
they're coming from inside the home
Alexander
don't be ridiculous the errors are
clearly not coming from inside the house
it at me at the inside me my effective
with these errors no Alexander you are
not infected it would appear that for a
small number of clients index - yes W -
984 c43 be forty four seven seven eighty
seventy one CA 6 198 AF 5 AC 1 DB j s
has been permanently installed what
permanently it can never be upgraded
like some kind of dead zombies that is
correct
you flops up you up big time
poof that gives me chills every time I
think about it permanently installed
that is a horror story you know there's
something strangely compelling about a
disaster story
sometimes it's the disaster is an act of
God other times it's man-made but the
best of them have this in common the
central characters are faced with
difficult sometimes impossible moral
dilemmas as viewers we ask ourselves how
we would behave in similar circumstances
could we handle the pressure would we
make the same choices would we do the
right thing some of my favorite disaster
stories are about epidemics or disease
outbreaks that threaten humanity I think
a Night of the Living Dead 28 days later
12 monkeys
children of men and many others many of
these stories and the entire zombie
genre in fact were inspired by the book
I am Legend by Richard Matheson the book
has been adapted three times for the big
screen and my favorite version is the
Omega Man from 1971 with starring
Charlton Heston I love it because it is
just so 70s and Charlton Heston just
can't stop delivering cheesy one-liners
no matter what happens to him he is part
of the day she has no place here is the
stink of oil the electrical circuitry
about him is obsolete you are discarded
you are the refuse of the past you're
full of crap
the antagonist in this version are more
human than the vampires and the zombies
of the other adaptations and I like this
I like that is cult of our by no mutants
spends all of its time raging against
the science and technology that they
blame for their faith in most Dombey
stories of course they don't plan on
turning people into zombies it just sort
of happens by accident and it's usually
because technology goes a little bit out
of control
now as I struggled against my own mob of
zombie service workers I realized that
there is a real risk of triggering
technological backlash now as web
developers were constantly tempted to
throw more and more technology at the
problem but if we aren't careful we
might end up pissing off our users you
know making things that are slow
annoying inefficient insecure or even
just full of bugs
it really risks alienating the people
we're trying to make happy now
for the next 11 and a half minutes
things are going to get a little serious
not like oh my god this is serious kind
of serious but more like the grown-up
kind of serious there will be a lot of
information that may or may not be
relevant to you now but don't worry if
one day you realize you need it you can
always find it on github but before we
first go to deep just in case some of
you are wondering what the hell the
serviceworker actually is here are the
basics a serviceworker is a script
installed via a web page that runs in
the background it gives you the power to
control asset caching to handle requests
from pages and workers went offline and
to respond to incoming push
notifications serviceworker is a type of
worker so it doesn't have access to the
Dom Ajax or local storage but it does
have post message for communicating with
clients with the betch for accessing the
network and indexeddb for storage
serviceworker has a lifecycle which
starts with registration when the file
is downloaded and executed it then
enters the installation phase when the
install event is triggered and if
there's already an older version
installed and it's actively controlling
clients the service worker enters what's
called the waiting phase until all
clients have disconnected when it's safe
to begin controlling new clients the
activate event is triggered and the
service worker enters the activation
phase finally when the activation phase
is over the service worker is known as
running and able to respond to client
network requests via the fetch event
handler now service worker also has new
toys including a cache API for storing
network requests and responses a
client's API from managing connected
clients which are pages and workers and
a push API from managing push
notifications from remote servers so
with that out of the way we can get down
to business how do we avoid the next
zombie apocalypse or here are some
things I wished I'd known before I
started with serviceworker
rule number one in no particular order
understand how promises work but don't
use them use async/await if you can
instead the service work api takes
promise used to new extremes so using
async await can really help make things
much more legible although very few
browsers support it natively it's just
syntactic sugar over generators with
promises and every browser that supports
serviceworker will also support async
code converted to use generators using
babel with the async 2 generator plug-in
that'll do the transformation for you
but be aware that this code cannot be
minified with up ijs which only supports
cs5 so use Babli which is another plugin
for babel that you can use community
instead rule number two don't register
the serviceworker while the page is
loading a bandwidth and CPU are limited
obviously it must be shared when the
cache is being filled during the service
workers installation phase so wait for
the window onload event or some other
signal before registering rule number
three know your dependencies during the
installation phase passing a promise to
event to wait until will delay
serviceworker activation until it's
resolved however if it's rejected the
serviceworker will be thrown away and
marked redundant now since the
installation phase is when you want to
pre cache all your assets any asset that
fails to load will cause a rejection in
this sense you can think of pre cached
assets as hard dependencies so you
should beware rule number four cache
smarter when upgrading a serviceworker
it's common practice to precache assets
in a new uniquely named cache before
deleting any old caches during the
activation phase now in most cases this
is really good approach but if you
release very often you can avoid wasting
storage and bandwidth by only fetching
new assets and then recycling the old
ones
now you can first create more than one
cache to separate versions assets from
those that won't change and copy
versioned assets from the old cache if
they already exist obviously this is not
as neat as cache at all but it is much
more efficient rule number five avoid
forcing activation for major changes
forcing activation after an update can
break already connected clients if the
new serviceworker is very different from
the old version so you can avoid calling
self skip waiting after a major change
and consider actually prompting the user
to trigger a manual refresh in that way
there won't be any breakage rule number
six use a library for messaging sending
messages between a service worker and
its clients is actually kind of weird
the API is a bit hard to work with but
using a library like swivel makes it a
lot easier
number seven never rename the Service
Worker file once the service worker has
been installed and activated it will
need to be updated to the course but
often we also qui cache the HTML file
that triggers the registration so it
would be difficult to install a new
Service Worker if it had a new name from
that HTML file so you can avoid this
chicken-and-egg problem by making sure
the service worker script file name is
never unique always the same and along
with that rule number eight you have to
set correct cache headers because of
course if the Service Worker script file
names are static and the browser fetches
the script through the browser cache
before going to the network you will
need to correctly set cache control
headers to prevent the browser from
caching outdated versions now the
precaution for to avoid accidentally
installing a Service Worker for days
weeks or months caches will be bypassed
if their script is older than 24 hours
regardless of what you set now cache
invalidation is always tricky as we know
so in the future browsers will be using
cache busting always by default to
ensure that the serviceworker script
files are always up to date rule number
nine invalidate your serviceworker when
updated the serviceworker will be
updated if it is byte different from
previous versions now a simple pattern
you can use to treat the serviceworker
as a boot loader by using import script
and version dependencies and that's all
you have to have in your serviceworker
file rule number ten add a feature flag
or kill switch this one's important in
the event of disaster having an easy way
to disable existing service workers is a
lifesaver really add a feature flag to
control and registration keep a no op
service worker handy just in case you
have to have a quick deploy or even
better have a service worker phone home
to check its version then force an
update if it's updated rule number 11
don't cache bad responses should always
check the ok property of the response
object returned from a spectacle before
you add it to your cache because HTTP
response codes they don't cause the
promise to reject so you have to
manually check rule 12 don't store
global state historian global state in a
serviceworker is really bad bad idea
because code outside of the event
handlers like install activate and fetch
they run each time the serviceworker is
started but the service worker is
stopped and started many times over its
lifetime as the device manages battery
and other resources so it's really
important not to store global states
because it'll be destroyed at unexpected
times rule number 13 guard against
missing ap is a number of API if methods
were added in later browser versions so
it's wise to test whether they exist
before calling them the following
methods were editing later versions of
Chrome for example after serviceworker
was launched rule number 14 this is
important one to test your serviceworker
now because of the installation
lifecycle and as a unique environment
that they run in service workers are
really difficult to test as always
running tests and real browsers with
real code is going to give you the most
realistic results but unfortunately
there aren't yet any good tools to help
with browser tests but the methodology
is well laid out in this article by Matt
gaunt of Google highly recommended
now automating browser tests comes with
own set of challenges as some of you may
know so it's often better to test as
much as possible with unit tests now
fortunately there are some tools
available to easily mock a test
serviceworker as part of their service
workers tool chain Pinterest has
developed helper methods and a mock you
can use to make the node.js global look
more like a serviceworker
I've also released a project called SW
test end and if there's a little more
thorough mock of the serviceworker
environment and allows you to run
scripts in an isolated sort of sandbox
context with it you can inspect the
properties of the serviceworker scope
manually trigger events post message
between clients and service worker
instances use import scripts such real
or mocks data use index DB storage and
require require modules from inside your
serviceworker
file without a build script now here's
an example from one of the unit tests I
wrote for my slides because I write
tests for my slides first we load the
serviceworker file then we create and
populate an old version of the cache
then we trigger the install phase and
finally we read from the cache to verify
that the old version has at in fact been
recycled now I think it could be a
really useful tool so if you get the
chance take a look and let me know what
you think
finally rule number 15 use the
serviceworker generator tool if you
don't want to get your hands dirty with
all these details you can use one of
several serviceworker generator tools
there are lots of good ones out there
but you should still write tests so now
that we're educated you might be
wondering what happened what was the
recipe for this disaster simply it was
one part ignorant one part stupidity and
one part mystery now we know that
versions of chrome the 446 didn't
support cache at all so any client
missing that API should have caused the
promise returned to the install event to
reject with a syntax error undefined is
not a function
unfortunately a catch was also added to
the promise chain in order to report
install errors but the error was never
thrown further up the chain and the
serviceworker was installed instead of
thrown away and that explains how some
clients became infected with a broken
serviceworker and based on the number of
errors reported it's clear that most of
the infected were soon cured but it's
still a mystery to me as to why or how a
small number became permanently cursed
now even after trying to install an
empty serviceworker
then eventually a kill switch to
unregister it completely that broken
file still haunts me and probably will
until every one of those devices is
retired now even if the details are lost
on you I hope I've made my case that
serviceworker is a complex beast
it is awesome but it's kind of awesome
like the way a chainsaw is awesome it's
really powerful and really easy to lose
a hand a foot maybe some toes but don't
be afraid because a lot of people use
chainsaws everyday without spilling
blood they take precautions they dress
for the job and they read the
instructions now now that I know more
now that I have some tools for testing
I'm ready to get back into the lab and I
hope that everyone here is also ready
because serviceworker really is the best
thing since Ajax and I know everyone
remembers how that turned out
so thank you and remember to kill your
bugs and zombies but not your dreams
good boy Alexandre get off the stage
thank you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>