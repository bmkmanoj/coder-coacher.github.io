<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>John Schulz: Canvas in NodeJS | Coder Coacher - Coaching Coders</title><meta content="John Schulz: Canvas in NodeJS - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>John Schulz: Canvas in NodeJS</b></h2><h5 class="post__date">2013-01-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/3Kms9YASgAw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">this is candice in New Jas my name is
John Schultz I'm not going to be able to
show you this like this Wow
it's going to go okay so I'm currently
working at include which is a web
consulting company in DC before that was
that honesty I also upped its own
company and we did work at Sur conus
which is a really nice monitoring
service where i did a lot of the work
with the charts and am on twitter at jf
s III so why would you want to use
canvas on node and the idea is to
replace script you know source path to
your live and then creating it with the
script or an iframe width image source
equals and just get your canvas image
back everything is croakin okay
so we made some canvas bass charts for
somebody and they really liked them they
wanted to get they liked them so much
they wanted those charts to be in their
wiki the problem is that canvas bass
charts need a browser or document
iframes a good way to do that but wiki's
don't allow high frames so I really
wanted to forget a way to do this
because it seemed like you know it's a
really valid use case it was just not
possible so I did a little research and
there is something called rhino canvas
which is kind of what it sounds like the
main problem with that is 2006 as the
last time any work was done on it and I
just wanted to stay a node and work on
v8 so I asked Twitter for help and I got
a bunch of what are you talking about
back people it's I understand it's a
visual thing and I'm talking about do it
on the server what if you think about it
there's really nothing inherently
browser specific about canvas or about
this geometry that we're dealing with it
just keeping track of go to this
position then make a move and then once
you've I don't know make a circle and
fill it that's all just math I don't
need to worry about where the mouse is
or what the window view port is so it
definitely seemed possible one of my
former co-workers mentioned that I could
look at Cairo which does PDF generation
SVG a bunch of other stuff I'm only
problem with that is it's in C and I
would have to go through and mimic or
make a mirror of the shell of the canvas
API and see which is problem for me but
then TJ hollow wall Chuck and learn
boost released note canvas and what note
canvas is is it gives you so it is
canvas in know Jas and it gives you a
standard canvas element so in a TI so
you get moved to begin path stroke all
the things you expect and that gives you
some non-standard methods like create
PNG stream to buffer which is actually
used to create binary information to get
an image back and to data URL
so here's an example from that page and
if you notice i put a comment in there
but the first two lines are the only
thing that's any different from a
regular canvas program we do a require
to get the package and then instead of
saying canvas equals document create
element canvas canvas not hide equal
something canvas top width equals
something you just create it with new
canvas pass it the height and width so
then if you were to paste that in you
know or run that is that will give me a
data URI kick back an image that's got
this data string in it
and that's it so that's text so that got
me pretty far so that means that i can
now run canvas on the server my problem
with that was that i already had a
client-side library that i was using it
was flat and flat uses jQuery and jQuery
uses the DOM and there is no Dom on the
server so technically I could do it I
had the tools but I didn't get a lot of
the benefits that I was looking for and
I didn't want to recreate flot on the
server side I just wanted to move it
over and have these charts that looked
all the same the same there like I said
the customer liked him I wanted to keep
him that way so i had to find a way to
get jquery to work on node and that is
done by the incredible jazz dom they
find a way to do a common jas
implementation of the dom in node they
give you donna level one and dom level
two just came in February I think the
latest version 02 and you get get like
last name get on with my ID a lot of the
bomb stuff you need so I now had a fake
DOM and that means i can now run jquery
so here's an example actually from the
jsm site the new version at movement
this thing called n where you pick this
case they're going to scrape a page so
you would say end destination URL that
array is a list of scripts you want to
include so I made a point to notice that
that's a production jquery file that's
not patched or hacked in any way then
you get a call back when you've got that
window and then this case it runs when
did that dollar so it's taking jquery
and running it against that URL now that
screens great thing it's not quite what
i was looking to do but you get the idea
I mean he's immediately able to use
jQuery on some remote code so I did a
little bit of patching and flop it's
really minimal because can denote canvas
gives you an API compatible but is API
compatible with canvas I really just had
to go into node and find or flot and
find where they did the creation so they
used to create element I now just do a
test and say if you've got this new
incredible constructor use that
otherwise use the regular one
that's really it I changed some
detection at the bottom where their
detection used to be if get contacts is
available or if it's not available then
do X canvas well because node canvas
again is API compatible that is now
going to be there so I just changed that
too if you have the bx canvas hack if
you have the X campus hack use it all
right yeah I do have the full patch
available as a guest if anybody's
looking to patch flop so putting it all
together here is an example that uses in
Jas node and this is using the new
version of jas Dom so you do require
give it an end where I pass in again
production jQuery code the two scripts
that are there one of them that flot
that svn is my patch version of flop
flop text is just a plug-in for flock by
default flot renders labels in absolute
position gives so not part of the canvas
so when I go to export it you'd have
lines and areas but you wouldn't have
values associated with them so you need
to have a plug-in for flot to do that
and that's just what this is done is to
call back this is just data generation
I'd have to do this for any example same
in the client side the things that are
of note at all width and height that is
something that's different about this
version flot by default takes an element
and then it determines its dimensions
which I don't have those dimensions when
I'm running on the server even if i did
in line styles i couldn't get jquery to
detect a height and width so i had to
say here's a specific height and width
now people have been asking for that in
flot for the the reason that you might
have a div that's off-screen and you
want to pre-render it and just show it
so if it's off-screen it would get a
zero and not show up anyway so
technically I needed to add it for this
project but it's something that isn't
going to be in the next version of flock
x-axis and y-axis and normal arguments
canvas text is something we use for the
plug-in and then clickable false and
hover bull falls are again flot
arguments I just set them to false
because it's a static image there's no
need to apply that then the rest of this
is me just doing some aliasing I didn't
want to say window dollar window jquery
so i just set those up
and then did equals div on this
signature right here is exactly what you
would see out of the plot docs plot div
or placeholder data in an options array
then I get a canvas back again this is a
get canvas is a flot method normally it
would give you a dom instance back in
this case I'm getting the node canvas
instance back so I can do something with
it I set up where I want to save this
image and then so I create a right
stream create a stream on data right to
that so I think I've got that open well
if I nude jst MJS wow that's right now
so log some stuff out in there ji sent a
flaunt just on pain sweet update if you
were to that may show you I mean that
really is just an image but that is if
anybody's work with fly mean that's lot
that is a styled flot image or canvas
alright so I actually was real stoked to
score j SN o de so my initials rjs and
this is where i play with node and after
all the JavaScript Jess note / flat will
always give back a random but very
narrow set of items but you should
always be able to do image source equals
jas note / flat and you'll get the
canvas image just a way for me to test
it and put multiples up and make a you
know a list or whatever I also did a
little bit of work so that it'll accept
parameters via the query string so you
can get it a JSON object or just the
data or options example that being that
and
alright Bob misspelled so and that is
updated right there and again I mean
that is just an image so we're able to
use flat on the server side and get a
nicely styled canvas chart back one
point I should one thing I do want to
point out in the previous example here
whatever guest I had while i was showing
Jas Tom and I was creating a dom every
time what I actually do on Jas node is
at start I preload flat so it's real
basic stuff I just do a basic you know
script injection but I pull those in so
it does at one time that I just share
that document instance I don't feel like
I shouldn't be creating a new j/s Dom
window or document every time I serve an
image let's want to point that out all
right wrapping up some advantages I see
I think the biggest thing is image works
everywhere whether it's me we're talking
on mobile said iframes aren't available
you know on a wiki an image it's been
around for a long long time it's got
incredible support it's about as who's
going to get code reuse you take the
library you've already have on the user
level client-side can move to the server
side you will have to do some patching
but again the work the tj's done that
canvas API is there it's exactly the
same so all you have to do most likely
is change the way that that instance is
created and then hand it off and it
should be good from their performance
images much less burdensome on on any
device or again older browser mobile I'm
not giving it information having it
create it render it spit it out it's
just an image so you might not have that
horsepower on an older browser or mobile
privacy was another one we had a case
about that monitoring service where
person wanted to show a graph and they
wanted to show relative changes but they
didn't want to show the absolute numbers
whether it was membership CPU burden
whatever so if you do have regular the
regular way you deal with it you give
JSON back and while I could do a graph
that didn't have labels on it that data
still got transferred across the water
you look at the net request you'll see
it and maybe it's off you skated or
something but
it's still coming across the wire with
this you control what you want to return
and just kick that image back and it's
completely opaque so there's no way that
anybody would be able to know what those
values actually were also by having that
URL you now get a nice normal HTTP asset
and you can cash it as you see fit so
you have some like sales figures are
something that are static or i would say
aren't going to change you could do
something like if I'm given a start and
an end and they're both in the past set
a far futures expires header on it they
cash it for a year 10 years whatever
your site does so that way the client
doesn't have to do another request they
don't have to redraw they just pull from
cash and you on the server aren't
redrawing that or reserving it text I
was going to say that canvas text isn't
the canvas text methods aren't supported
in all browsers but it's a kind of an
arrow key thing I think one of the
bigger ones is that you get the benefit
of having a single platform that you're
supporting here and you can use a font
if it's available on your server you
know what's available because you're
controlling that environment
disadvantages I think probably the
biggest one is you're bringing load from
the client back to the server now I
talked about ways you can hedge that
with caching and and so on and there's
other reasons my you why you might want
to what you are pulling from the spokes
back into the hub image means there's no
interaction that's probably that's the
other key one you can't do onmouseover
can't do tooltips that's what if it is a
static image but in the cases where
that's where you're you know there's a
lot of times where that's perfectly
suitable and it's another piece of
technology and your infrastructure
although you likely have something
that's serving images anyway and you can
it's not as though you need to have your
entire stack or anything running a node
you just go to a certain port or certain
URL which you mod rewrite or otherwise
direct to your node instance which kicks
that image back but it is something
you'd have to add in if you're not
already running node president don't
think i've got anything else that's it
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>