<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Matteo Collina: My Node.JS Process Is On Fire - JSConf.Asia 2018 | Coder Coacher - Coaching Coders</title><meta content="Matteo Collina: My Node.JS Process Is On Fire - JSConf.Asia 2018 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Matteo Collina: My Node.JS Process Is On Fire - JSConf.Asia 2018</b></h2><h5 class="post__date">2018-02-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/G9Vkpe55Gu8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so my not process don't fire yes this
talk is about what to do when your note
application is it's not behaving okay
I'm not talking about literally burning
IOT devices no I've done that doing that
I'm not doing that anymore stay so I
don't know how many of you I mean how
much I don't know how many times
happened to all of you to be woken up by
an alarm on Sunday morning because your
application you spend so much time
developing was not behaving correctly
and user were disappointed so while it
happened to me several times in fact so
what you do well typically you login
into your cloud servers cloud provider
accounts whatever look at what's going
on and you know you have a bunch number
maximum number of servers in your auto
scaling group which you should use all
the time and applications still not
behaving so you log in ESS H in the Box
I don't know you tweak some stuff and
after a while everything gets back to
normal and you need a hotfix as as we
call it now this type of performance
problem are are very important to solve
and to prevent so whenever you have you
have a performance issue or a production
issue you should really do run a
post-mortem so after the morning on
Monday morning you come back to work and
you you check oh well what happened okay
and this is the question you ask what
happen but more importantly you should
check you should ask yourself how to fix
this so this is the road to fix things
in production is first of all gather
Diagnostics data and evidence so again
if you have set up some some logging
infrastructure some monitoring cloud
watch one of those whatever you want to
use a lot of services in there at the
APM area
and with this diagnostic you need to be
able to reproduce the problem in a
non-production live environment so you
can really produce the problem yes and
after you can reproduce it as it is
still on a cloud environment and after
you are able to do that then you can try
and reproduce in the problem on you on
your box now where pollution is the
problem on your box is important because
it means it's very easy then to work on
this stuff on there and gather some more
diagnostic and evidence the type of
diagnostics and evidence you can gather
from your box are way more detailed than
what you can get on the cloud because
you are not limited by the hover head of
fire off of the tools you want to use so
then you try to fix the problem several
times several times several times and
you if it's not fixed and you go back
and you try again and more Diagnostics
fix it whatever so how do we fix things
the most important bit it's establishing
a measurable goal and I will get back to
this later on and then you measure so
how you get good measurements and then
we find what we call the bottleneck
which is what is lowing down your
application and then we fix the
bottleneck we remove that bottleneck and
ideally that will show another
bottleneck and and so on and we measure
again and if it's not fixed we go back
and find a new bottleneck optimize
measure all over again up until our
measurable goal is solved now how do we
establish a measurable goal well
typically you can talk to your boss and
get something like this from him
whatever this means what's something
that's valuable for your application
okay how many concurrent user per
servers you want to achieve you want to
reach what's the maximum latency you
need to have those are very important
numbers whatever it is this is very
generic things that you can pick take
and use it okay but every application
has its own business requirements when
developing nodejs application you need
to remember that latency and throughput
are connected to each other and because
node is single threaded however
and this means that multiple ru action
running parallel but one single
JavaScript function it can execute and
when multiple are you are in parallel
like for example multiple database
connections you know you have an
increased concurrency and if the latency
of those u action gets higher because
you might have a database problem for
example you having typically the
concurrency increases but that when that
happened memory usage spikes and when
memory uses spikes this increased the
garbage collection activity so when all
of these are connected it means that the
garbage collection activity impact your
CPU cycles and the execution of your
JavaScript functions so all of these
things are all interconnected 2000 imita
resources that your CPU has your your
processes so in order to establish a
good measure we can use this to call out
to cannon is an HTTP load tester runs on
Mac Windows Linux very trivial
installation you don't have to compile
anything it just comes out it you have
it will compile something but we are
getting rid of that Italy sooner rather
than later how do you use it you start
your node server then you start out ok
now specifying the number of connections
the duration some other parameters and
it gets you some statistics including
the latency so how do we find the
bottleneck well you need to gather some
more Diagnostics
now we have a Mac we have measure we
know our standard goal we can compute a
gap between the two and we need to
gather some more some more Diagnostics
we can use this new tool that we have
just released called node clinic
you can NPM install clinic if you want
to and what you need this tool has two
comments inside one is called dr. and
one is called flame and then we show
them in a moment
the first one is doctor it's nice logo I
don't know if you like it but I hope so
a friendly doctor and you can literally
type
clinic doctor note server these stalls a
bunch of things probes ensure your not
server into your server and it can
generate some some useful statistics out
of it let's do that so here it is
OOP this went up can use OPI hopefully
you can see this okay
so what you do you do clinic doctor - -
no demons is my demo code so as you see
is spinning up the it's using its using
trace events to gather together some
most advanced statistics this is still
an experimental feature in no date so we
run the stuff and after turn with
control C on the server
and you generate this type of diagram so
in this diagram it can tell you some
some very nice things for example you
can tell you that we have detected the
potential event loop issue and how we
can do that well you can see here that
you can that this process the event loop
delay it keeps growing okay up to almost
three seconds
well it's buggy okay it's a demo of some
code you should never write and we can
also track a memory usage but the very
nice thing about this tool it's it has a
recommendation panel which it tells you
what to do when you have this type of
issues so in this thing you can press
ample implement HTTP 503 event loop
protection it's a very important thing
you should have in your application but
you can also recommend you to use a tool
called clinic flame to discover the CPU
intensive functions and there's a lot of
explanation of all of this so stuff to
follow we also have brought other
undetected issues so you can also read
the guide for example on how to solve
your problems or garbage collection
problems which are not memory leaks are
more problems where the garbage
collection is interacting with your
application in and not so nice way so
this is it this was my fault back then
the other tool is called clinic flame
and this is based on another thing
called zero acts it's using it
internally that we've developed before
and how to use it again similar pattern
clinic flame - - note server so what we
do is we run it this way clinic flame -
- no demo and this requires your root
password because it needs to use some
low level
Institute to use some low level
diagnostic tools called D traced on mac
and prof on linux okay now we have run
this then we eat ctrl C and all of these
crunching stuff of course takes
time all of these arguments are very
complicated now let me zoom in because
of course what you can see it generates
this type of diagram where this a very
odd function called sleep now I hope all
of you guess what the type of code that
I have written for this demo which is
very simple which is this thing it has a
slip function that just actively wait
for something to happen very trivial
okay you should never write this type of
simple function in your code base okay
but you can detect some very complicated
code in there as well for example so I
want to go through I want to just say
that tomorrow and then I am I'm doing a
performance worship with my colleague
Josh and in which we will get lost in
the rabbit hole of performance so in
this in this workshop we will go through
how to diagnose a performance problem
using clinic but also using other things
for example how to use the node
inspector and other stuff like that we
will also use frame graphs to know where
is the problem okay as I showed there
that was very simple and trivial but the
probe what we will see what we'll see
tomorrow
it's way more complicated and way more
deep and then we will dig deep into v8
flags to understand what is happening if
you'd go into we have been talked with
fluckey before that there is a thing
called inlining okay and we will dig
deep into the wall optimization cycle
and the optimization and the
optimization cycle art of v8 and
turbofan and and we what we use to do
this is as low is this low rest API so
as low what we mean is I provide you a
nice application and you can do that you
should so this wall talk was about
performance optimization but I want to
spend 30 seconds saying that you don't
need to over optimize your code so the
important part about optimizing ojs
applications is only about
doing this when it's needed okay and and
to meet your business goals so over
optimizing the code is most most of the
time not a good idea
please remember this and do not do not
fall in the trap okay I want to thank
near front while building this tool it's
open source so you can download it now
this is a couple of block big blog post
coming out in about this I would also
want to thank the team that helped
building this tool and Reyes joy corner
matheus Allen and Camille this
presentation is available a couple of
places these and this it's you can take
a picture if you want that's the best
way to get this content and I am on time
so even a little bit early but that's
fine so this is me hi I am a police Jeep
allocated at near four and I'm also a
member of the technical steering
committee of the of nodejs so I help
maintain the nodes AES runtime so if you
have any questions about not a yes come
and ask me okay I also write a lot of
code as you can see and thank you folks</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>