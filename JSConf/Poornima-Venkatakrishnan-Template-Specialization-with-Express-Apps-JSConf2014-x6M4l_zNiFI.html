<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Poornima Venkatakrishnan: Template Specialization with Express Apps [JSConf2014] | Coder Coacher - Coaching Coders</title><meta content="Poornima Venkatakrishnan: Template Specialization with Express Apps [JSConf2014] - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Poornima Venkatakrishnan: Template Specialization with Express Apps [JSConf2014]</b></h2><h5 class="post__date">2014-07-16</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/x6M4l_zNiFI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">my name is and I'm from PayPal yeah so
if you would like to follow along with a
slice in your own browser just point to
the URL out there yeah
so before I start off giving you a
textbook definition of what we mean by
template specialization I'd like to talk
about what is the problem that we wanted
to solve with this solution in big EEMA
ecommerce sites if you there are like
millions of users lots of products and
different flavors of these products that
we want to provide and these products
may vary with respect to the users
profile itself and so we needed a
mechanism in the framework itself
somehow to do it instead of actually
handling it within the templates and
putting the logic the business logic
inside the templates typical cases we've
had is like in case you want to a be
test inexperienced you have two
different great designs but you don't
know which gets you more signup and
which gets you better adaptation so
that's one case that you would want to
use this another common case is like you
want to adapt your website to different
form factors because your user may be a
person who uses your website on
different form factors and then this we
have a lot in PayPal that I'm not sure
if it's applicable to many other
countries like many other companies but
when you have an e-commerce site that
sells products to different countries
the countries may have some regulations
or they may have some slightly different
expectations of the product so you would
probably want to provide different
flavors of the same site for different
countries a little differently so what
are the solutions that are offered out
in the industry like one very popular
one is responsive adaptive design
responsive being using media queries and
CSS techniques to somehow fit the
website into the viewport based on the
viewport size and adaptive being
providing a very specific design for a
very specific device yeah and other
techniques are like not long ago many
companies used to have like their mobile
site completely hosted on a different
domain or even if you want to have two
different experiences you would probably
host them on two different routes and
redirect and based on the users what
experiment or what segmentation is
turned on on to that user and more
recently there's a really popular
technique called rest and what what it
is is basically responsive server-side
components and what this does is like it
takes the advantage of using something
like worthless value find out what
device it is and for certain devices you
kind of like turn on a completely
different design but use it as a hybrid
model with responsive on the front end
to also adjust according to the viewport
sizes for example you could have a
different experience on the website like
on the desktop but from a tablet on you
probably want to have a completely
different layout but you still want to
adjust it as the viewport size decreases
from tablet on so this brings us to the
question of what is template
specialization then tech I would give
the definition as like dynamically
switching partials in your view based on
the context at render time like at that
point you know what the users
information for that request is and you
know for that you sets a set a bunch of
rules to figure out for that rules
what is the template you want to render
and then based on that you decide so
this could be at some levels thought of
as a rest technique because it is using
some information on the server side to
decide what is the base view you want
render
and then from there on you could just
render in response let me make it
responsive on the front end so how does
it work one the first thing as you would
probably have a bunch of rules that you
specified to figure out how you want to
resolve the templates on based on what
rules so there'll be like a bunch of
rules that you specify upfront and then
at render time you use these rules and
you use the context information and then
resolve for every partial what is if if
and what partial you need to map them to
so the genesis of this idea are like we
in PayPal let me take a step back and
give you a history in the past 1 and 1/2
years we moved to doing our entire app
stack in nodejs in JavaScript
so we built a thin bootstrapping
framework on top of Express apps to
provide some structure and convention
and some interesting ideas that came out
of like the design for Kraken is what
actually is an inspiration for how the
template specialization has been built
so I would like to take a quick bit over
to crack and this is not the stock was
not supposed to focus on Kraken itself
if you have if you are interested in
knowing more please hit that link
so what kraken provides is like a nice
thin boost bootstrapping
abstraction on top of express you would
throw it like configs at the conflict
it's a very conflict even approach where
you could have like the set up for your
express apps specified in the form of a
config or you could have like
environment are there configurations to
do different things on different modes
for example in dev board you may want to
do something else and prod mode you want
to do something else and also to set up
your middle that chain not only just to
set up the middle version also to figure
out what order you want to insert these
little bar in the middle that chain so
it's a very nice conflict driven
approach to setting up your app and
hence was born the specialization logic
ended up writing a very simple rule
parser Kolkata and
this is basically you would specify a
simple JSON config of what are the rules
and what you want the rules to result to
when the context information matches
these rules so given a set of rules and
facts if an manage results you will get
the correct templates picked up and
these rules are really in a very simple
JSON format which is what you see here
so you would see that the gun is very
simple you have in this and a rent class
what it means is like for maps to bar
when the bunch of rules in there match
with the context so how would you use
this to generate the map actually if you
look at it it really isn't specific to a
template specialization it's just a rule
parser but we use this rule Casa and
conjunction to do that specialization
itself so how you would do is like
require the module require the conflict
that you just specified and then you
create a rule parser the specialization
of specialized an object that you see
that and the specialized object right
exposes two different methods that's
resolved and resolved ah so you could
either resolve one template at a time or
you could just resolve the whole set of
rules that against the context a set of
rules that you just specified so let's
see how we use it alongside Express apps
for template specialization
I'm just going to show a touch late on
key parts in the Express app that you
would want to like watch out for like to
implement this so this if you look at it
is like a simple JSON config what it's
saying is not a partial called body to
something body ex-porn when like say an
experiment is turned on and not the
partial extra to something else when the
country is either UK or D or France and
then you have another partial right
panel which maps to something else when
the rule is though the rules are
satisfied like experimenters x1 as well
as extra has something called coupons
it's as simple as that and then you
would have I wanted to show so if you
look at the template itself is a dust
template there are three partials here
in body which has header body and footer
we just saw that body is actually
specialized for certain certain context
information so certain rules but you
keep your template really clean by
actually you doing kind of
specialization because you don't put the
business logic in the template itself
and it's actually handled for you by at
render time it'll just get picked up
from the config and then it'll get
inserted and switched in underneath in
the rendering workflow
similarly sorry about that
if you look at body for example body
also has right panels which are
specialized but you don't put any
business logic in your templates at
render time it'll take the context
information and figure out if it needs
to be switched out or not so let's take
a quick look at the app itself I'm not
planning on going over every line of the
ad but I wanted to show a tossed light
on what I'm doing to actually specialize
so this it's a very simple app you can
see that all it does is create an
Express app include the specialization
rules that I just showed you in a
different config and since I'm using
dust I'm actually including dust chairs
LinkedIn module and then creating a rule
parser instance which I'll use later on
to generate the math when I have the
context information and this is just
simple stuff I'm just setting up session
I'm just setting up serving static
telling it what is the parts to the
templates and what a new engine I'm
going to use so this is the part that I
would like to talk more about so where
you would actually intercept and
specialize there's venue where you feed
the app engine function into this
Express app so generally what happens is
you just get the view engine function
from consolidate or whatever module you
are using whatever templating engine
you're using and then you would just
that would automatically look up the
templates and do the processing
compilation of the templates and render
it so this is a plug this is a point you
want to actually intercept and do
whatever you want to do to actually
specialize your templates so what I have
like a three-step recipe that I tell
myself is a right way to do this the
first thing is what you want to do is
wrap your engine function so that you
can intercept before the actual
rendering and compilation of the
templates actually happen the second
step is when the render happens you get
called into your rot function and there
you already have the context information
super so now you have the two pieces of
information that you need to actually
specialize which is a context
and the rules that you already specified
so you have a specialized er which is
the rule parser which already has been
set up with the config rules config that
you just wrote in your app and now you
have the context information all you
need to do is generate that map saying
here in solve all and give me the JSON
object of all the template mappings that
need to happen and now once you have
that you can stash it back into the
context itself great so now you have the
map generated the next step is you want
to somehow get notified right before
every partial gets rendered that you
want to check if that's a mapping that
needs to happen like a switch that needs
to happen or not so for that dust gives
a nice hook to do that which is called
dust or onload so if you implement dust
or onload you will get called into that
function if the template is not found in
the cache so in my case I actually
deliberately enabled cache to false when
I set up the engine function so I will
get called on every every partial that
will get rendered so you may ask hey if
if the cache is disabled isn't that a
bad thing so what we do is we in paper
the kind of internet our own custom
cache if we want to do this sort of
massaging before we actually render the
templates yeah so now we have dust
calling in to me like in to my app
before any partial in my view gets
rendered at this point I had the context
the context already has the
specialization map for that specific
context so great so I have all the
information that I need to check if
before the partial gets rendered if I
need to map it to something else or not
so you would see that what all I'm doing
is getting figuring out if that needs a
mapping to a different template I have
the name of the template the context and
the context has the specialization not
itself generated so at this point what I
do is like I figure out if needs
switching sneekly switch it underneath
and then read the file and then pass
back the data and from there on the
rendering workflow is the exact same as
what you would have before so
that's the three things that you would
have to do if you want to do something
like this rest of the app is pretty
simple
like generally if you want to set the
context information it would let's say
you were trying to trying an experiment
on two different experiences you would
probably have that information come from
some experimentation platform or some
sort of that'll be a segmentation of
users who get some set of experiences
against other in this case I'm just
going to demo something close to real so
I'm just going going to set the context
from the using this route so demo time
so you'd see that what I have here is
like a really simple demo the view has a
header or footer signup form and then
some content in the center and then some
sort of feed newsfeed on the right side
so the menu you'd see is like a tabbed
menu let's say I want this view to be I
want to experiment the exact same
information in a different sort of
layout I all I would have to do is like
set an experiment on it you earlier saw
that in my specialization config
whenever experiment has turned onto x1
it has a different fashion mapping for
like a body fashion so you see that
automatically it gets rearranged to a
different sort of experience tab menu
now becomes a stacked menu and then
there's a content and the login form
actually gets rearranged differently so
let's assume that this is a different
experience that you want to test out to
see which gets better sign up on your
site let's say that once you have
segmented your users between like
experiment 1 and non experiment 1
experiences you want to further segment
it for some other rows let's say you
want to have coupons show up in case of
experiment 1 is enabled in that case you
see that it just setting us extra config
in extra information in the context
automatically showed the coupon on the
right side so it can you can easily set
values in your context and enable
different sorts of layout without having
to touch any of your actual without
having to have enough extra business
logic in the templates themselves let's
say like I want to have my signup forms
differs for some countries as opposed to
another so I'm going to set the country
to UK and you'd see that let's say UK
needs extra information if you want to
sign up you want to probably give a
recovery number like you want to enter a
CAPTCHA you can easily like map that
specific partial to something else to
give show something else
different countries and you can now I've
demoed like there are different three
different vectors of information that
are used to decide what is shown in the
view right like they're all they're all
kind of independent of each other let's
say I want to have UK users also to have
both segmented with both experience one
and non experience one you can easily do
that as well
by setting experiment to not expand so
you have the specialization for the
country still but you get the benefit of
segmenting users for two different kinds
of experiences so this is what I wanted
to this is like a sum total of what
template specialization this so going
back so the rule pasta itself until now
I've just shown like really simple rules
that can be config actually the rule
parser has more capabilities I'm just
going to quickly go over what other
possibilities you can do with that rule
parser caca you can see that you can
specify multiple options like for
example in can either not to yang or BOM
depending on what sort of what are the
set of rules it satisfies this is kind
of like a switch case mentality so which
whichever one wins first gets to be the
one that gets mapped to so if the state
of mind becomes peaceful that gets
satisfied that that wins first the next
is you can specify multiple rules like
en gets mapped in yang if three
different rules are satisfied so that's
one option then you can have multiple
values for a rule where mood can be
either happy or related or ecstatic or
the state of body could be like should
have active and walking or energetic law
so you have different ways of
communicating your rules or let's say
you have a rule where it's not just
about comparison of values but you
actually want to do some math on the
context information or you want to do
some date/time manipulation or let's say
you want to do some regular expression
comparison you could all you can do is
like you don't even have to specify the
rules you can implement the evaluation
function yourself and it will what it
will do is it will give you the context
and the rules config you can do the
process of evaluating whether it matches
or not so summing up what's the recipe
there's just three steps to doing
template specialization take the engine
function wrap it so that you can insert
whatever you want to do at the time of
friendo second step at the time of
render you have the context and the
rules you can just resolve them into
attempted map use your favorite rule
path so it doesn't have to be what I
just showed you caca third once you have
start generated the map and stashed it
back in the context figure out if you're
templating engine of your choice has the
hook for you to like figure out if it
actually has a way to tell you all the
templates that need to be rendered or
the partials that need to be rendered in
your view now map it against I mean
compare it against the map that you just
generated figure out which ones need to
be mapped or something else and yes you
have there you have it there all you
need to do is like once you switch it
pass it back into the rendering workflow
you will have it switched on runtime so
on that's about all I wanted to say
thank you for listening on a parallel
note not completely related but I just
mentioned that PayPal is hiring big time
because we are moving to note completely
JavaScript on our app stack so please
come and talk to us we have a bunch of
enthusiastic faces here we want to talk
to you about what we're doing in PayPal
and want to listen to all the exciting
things they are doing in JavaScript
thank you for the opportunity</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>