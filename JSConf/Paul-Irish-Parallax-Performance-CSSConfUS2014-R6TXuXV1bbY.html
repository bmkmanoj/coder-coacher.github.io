<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Paul Irish: Parallax Performance [CSSConfUS2014] | Coder Coacher - Coaching Coders</title><meta content="Paul Irish: Parallax Performance [CSSConfUS2014] - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Paul Irish: Parallax Performance [CSSConfUS2014]</b></h2><h5 class="post__date">2014-07-16</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/R6TXuXV1bbY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">yeah fairlight performance I've always
been really into parallax I mean it's
really it's really hit these days to hit
on it and there's times when they that's
done really poorly but I like the effect
and like personally I i like i like long
single pages and i hate it when I'm like
working on a project and someone's like
well let's break it up into multiple
pages and I'm like because I was that
baccardo Jason he he's in Massachusetts
he said something like a click is the
decision but scrolling is a continuation
and I feel the same way like usability
wise i just feel like scrolling is like
extremely low barrier to entry right
it's just like i'm continuing and then
when you augment that's rollin
experience with parallax i think it's
cool but anyways there's many ways to
fall into a pit of badness with parallax
and so i'm going to show some examples
where that's happened and try and talk
about techniques to avoid that sort of
situation but like i said i've been into
it for a while in 2001 i just pointed to
this site because i thought was pretty
rad so like it's like this one and it's
italian site and I think it's just
selling shoes but like they kind of got
this thing floating in front you know
its parallax is what we're going to talk
about but first I think there's a little
bit of terminology we could discuss I
recently asked kind of like how we could
break up some of these things because
parallax generally gets use the word
gets used for anything for any site that
has an effect on scroll and I think we
could make it up a little bit more so
let's try it out this way parallax
moving elements in different Z layers
along with the natural scroll pace so
come on come on yeah this a classic
example and really the first example was
the nike better world site so this was
designed by ian cole
whole a Kian coil out of the UK and he
is generally the designer credited with
creating the parallax technique and at
least popularizing it on this site so
that's generally parallax peeler is
another site another kind of technique
that we've seen more recently a good
example is here and this is actually I
think where the name is kind of coming
from this is a concept video from the
Canadian agency tehan and lacs but as
you kind of scroll down the the article
kind of peels out of the way so you peel
through content in fact this technique
also I believe might have debuted on
edits quarterly com which was as well
designed by Ian coil so the man really
likes augmenting the scroll experience
with some good stuff alright lastly
scroll jacking scroll jacking we've seen
a little bit more recently this is kind
of taking over in the natural scroll of
the user to display an alternative page
velocity a classic example of this is
the Milwaukee Police newscom which takes
a while but it's so worth it come on I
really yeah let's try it so all right
it's going to scroll a little bit uh-huh
that's good actually oh it's working
pretty nice bring it up on your own
sometime in in many cases it scrolls to
like halfway through the content so
showing like two pieces all at once
that's a good example so they add some
work to do but honestly i think that the
design is done well but it's a little
tricky to pull it off when you want to
completely yeah overtake the scroll like
that alright so that's a little bit of
terminology but we're talking about
performance and so we're really talking
about jank jank is like you are
scrolling everything's supposed to be
smooth you're supposed to be able to
scroll at 60fps if you know a basic site
can do that but the more you throw out
the page and the more you kind of inter
with JavaScript the more you're going to
introduce jank so typically when there
is jank during a scroll it's caused by a
thing that we usually like to call paint
storms paint storms the term has kind of
been around for a while and it generally
means there is just excess painting like
more painting that should be happening
to the page and show so I'm going to
kind of try and visualize this actually
looks like when I come back to this
example over here and I just open up the
devtools what I have you hit escape and
you kind of bring up this drawer down
here which usually has a console but has
a few other things inside the rendering
tab there's show paint rectangles show
composited layer borders and show FPS
counter and I'm going to make good use
of the show paint rectangles now and
basically we're seeing these green
overlays happening on the screen all the
time if I take let's see this is just a
static page and I'm just going to open
it up the same thing we have green over
on me on the scroll bar because the
scrollbars is having to be redrawn but
the content itself is not being redrawn
right so similarly I'll take a inception
explained looks like it's over here cool
site kind of parallax II kind of effect
on a lot of this and if I take a look at
what's happening so they have orange
borders around all of the composited
layers and green for what's being
painted and so as I scroll you can just
see kind of blinking green everywhere so
this is a pretty visual example of paint
storms yeah but in order to understand
kind of like paint and what that means I
want to kind of quickly review all the
different operations that happen in the
browser kind of the rendering pipeline
inside the browser this is a view
from inside of the chrome devtools
timeline but at this point all browsers
have generally these same steps so first
up is the recalculate style operation at
this point we get all the style rules of
the page so they are in external style
sheets inline styles even the user agent
style sheet that you know says what a
button is supposed to look like then we
evaluate all the selectors of all that
stuff match it against the current job
this is exactly where selector matching
happens of total recalculate style costs
usually selector matching is about ten
percent but probably even less so it's
not it's not too big of a concern then
we calculate the computed style for
every a single element just kind of like
when you call get computed style in
JavaScript the browser does that for
everything that's on the page based on
what's in the style then we lay it out
and this is literally just what is the
geometry of the page laying out all the
boxes and all the dibs then we paint it
painting is figuring out what the pixels
should look like so any sort of visual
effects that are up need to be applied
to figure that out painting oftentimes
is what hurts when we were scrolling a
second ago and all that green that's all
paint so paint oftentimes is capturing a
lot of time inside the browser
especially in highly interactive
scrolling environments on low-end
devices paint is the thing that makes
the experience feel slow it is the thing
that drops the frame rate many times not
JavaScript and then show a little bit
about how to debug with the show paint
rex which we saw and also continuous
paint mode which is a way to find out
oval things being painted what is the
most expensive so of all of those
operations that are happening inside the
browser how do you kind of map those
into the CSS that we write so here I
kind of have just a snippet of CSS and
here's a brief look so the selector
the cost that we have of the selector is
really manifested in recalculation of
style just figuring out what elements
that style applies that select replies
do then we have a height the height
effects the layout of the page the way
of a div and then all the divs following
it usually and then a tech shadow
doesn't affect any sort of geometry of
how things are laid out it's just a
visual effect right so effects only
paint and so you can kind of look at all
of the CSS properties and figure out
what they account for so if we kind of
take all the operations that happen
transfer moment opacity can actually
they do not affect the layout they do
not affect paint and really can actually
be handled completely at the compositor
level things visual effects happen like
a box shadow bore radius background
outline even outline actually is just a
visual effect and does not affect
geometry so those only require being
painted and then composited and then
these guys these are all kind of the
things that cost the most changing the
width changing the margin the border
left and top and we're talking about
parallax these are usually the ones that
we're talking about anytime that you
change left on top you're going to have
to the browser is going to have to lay
it out then paint it because it has a
new size everything beneath it has
changed and then do any sort of
compositing so the more work that you're
doing the slower of a frame rate and the
worse the user experience gets so I took
a look at all of the CSS properties that
are animated there's actually
instrumentation inside of chrome to
figure out what CSS properties are
getting animated through transitions and
keyframe animation and so this is a dab
dump kind of the left two columns width
and height gets animated the most and
the next one I put kind of what they
require so pretty much you know
everything requires layout and then
paint and then compositing whereas color
and bordeaux-style just paint
pacity just compositing so basically
when we think about the things that we
can do change in elements that the
browser can transition extremely fast
there's about four things we can change
the size the position the rotation and
the opacity these just map to us
changing that the scale of a transform
translation the rotation and just the
straight-up opacity across browsers I've
spoken with the Firefox engineers this
is consistent on Chrome on on safari on
Opera and I use a little I ease pretty
good at hardware accelerated everything
so they're better than this really but
these are the four things that are on
the super super fast path so whenever
you're doing any sort of visual effects
that are animated any transitions any
animations try and use only these things
and transforms and opacity transitioning
anything else is going to require layout
and paint on every single frame and it's
going to slow things down so kind of at
your own risk I should point out at this
point layer promoting with translate Z
or 3d might be required depends on a lot
of things the compositor architecture
inside of browsers is really freaking
complicated generally it's like it's
required these days in browsers on
desktop browsers on low DPI devices not
required on mobile not required on
retina devices on retina desktop devices
but that's kind of how that is and at
this point I should also point out that
we've kind of known these as hacks for a
while a while and now there's a new CSS
property called will change that is the
kind of standardized version of this
that gives the browser a lot more
semantics to optimize the experience
there and show that in a little bit I
should point out of this at this point I
should bring up background position and
background attachment these two get used
a lot
in kind of a parallax experience you
have like a like you have a div and as
you scroll you kind of want to move the
background up as you're scrolling down
or background attachment here you've set
it to fixed the solution here which kind
of sucks in some cases is taking it out
of a background and throwing it into its
own image element promoting that into a
layer and then changing that around with
transforms I don't like that this is
like a recommendation it feels like a
terrible hack that you have to do to
overcome the brows that the browser
should be smart enough to do this in
most cases on mobile so Chrome Safari
and Firefox on mobile handle this
optimization for you on desktop they're
less smart again so watch out for that
it's something that you can test for
with the profiler and experiment with so
next when we're talking about parallax
you kind of have to you know know when
the browser when the user has scrolled
and so we need to handle that input so
as a few ways and usually it comes down
to a touch start handler mouse wheel or
Scroll basically touch start and mouse
wheel are the semantics of those
elements inside the browser are such
that if you call event.preventdefault at
any time inside that handler the browser
has to say nope I'm not scrolling the
page at all so basically the browser has
to just wait for you to do your entire
handler before it updates anything
scroll it has a little bit more
flexibility with so basically let's say
you have your phone you touch it you're
like doing a fling to scroll the page
right you touch it it's received by the
compositor gosselin is like hey is there
any JavaScript attached to a the place
where I am touching if there's not great
it's going to update the screen it's
going to scroll the page let's say that
there is a touch start handler and the
sonic handler is bound to the body
uh it's like oh okay I need to go
execute that before I do anything else
before I update the screen I'm just
going to execute all that JavaScript
that's attached the handler this is a
cross in a separate thread and that so
it's hopping across threads and when
it's finally done with that can finally
go back and update the screen this can
take hundreds of milliseconds and
hundreds of milliseconds in some cases
like doesn't sound so bad in a page load
thing you might like hundreds of
milliseconds and sound so bad but when
we're talking about input handling it's
much worse this is a benchmark that some
folks at Google made and it basically
helps visualize what latency and jank
kind of look like so I'm just going to
drag this box around and basically
there's no added latency here it feels
pretty snappy as I'm dragging it around
this one has ten frames of latency right
does not feel as good it feels worse for
me and then it feels for you i go to say
similarly down here jank this is fine
this one see periodically it just kind
of like hangs it's sticking with me as
far as as far as its latency but every
once awhile just jenks pretty hard all
right so the the the latency that we
were experiencing in the top right
corner was 160 milliseconds doesn't
sound like held a lot but you feel it
like crazy especially with your finger
on a touchscreen device all right so
some things you can do to minimize that
bind your event listeners low in the Dom
this basically means don't use event
delegation for touchstart don't use
event delegation yeah for touch sign
browsers aren't smart enough to know oh
yeah he's using an event delegation to
really just watch this one selector
that's bound down here it's going to
like have 2x
the entire handler because you set the
hit region of that handler on everything
so it's going to it's going to execute
that before it gets to anything else
bind late so like don't have handlers
set up for non visible objects browser
is not always that smart figuring out
that that element is not visible so I
might have to start executing it anyways
if the visible if you know that the
element is gone outside of the viewport
kill the handler and speed up in the
handlers you've got you want to minimize
that input latency to be really really
tiny so kind of in summary for this is
just avoid JavaScript handlers for
scroll and touch as much as you can
because they just affect the user
experience incredibly if you can't
profile them and make them tiny as
possible you know those annoying
JavaScript micro optimizations that are
annoying this is actually a time when it
might make sense to start applying them
because it's really citizens between a
user touching something with their
finger and then seeing that something
update all right so then the question is
is it possible to avoid JavaScript
completely for parallax because we've
never really had that before and luckily
there is now this is a technique that I
became familiar with through actually
the chromium bug tracker but Scott
kellam is a great guys and he's in
Brooklyn does a lot of great work with
SAS he came up with us a while ago and
he's actually building on some research
from Keith Keith Clark Keith Clark over
in the UK someone let me open this up so
here's basically a bunch of kiddies and
well it's just parallax right but let me
kind of compare this with what we were
seeing over in Inception explained this
loads up
alright so in Inception explained as I
scroll like this is the paint store mean
I'm getting and if I look in a timeline
as I scroll we're getting frame times
that are about 150 milliseconds per
frame there's a lot of work going on now
I know that this demo is a bit more
simplistic but the fantastic thing is
that there's zero paint storming we have
movement completely here straight up
parallax movement and no pain storm at
all we are just you know updating the
scroll bar and that's about it so this
is really cool because never has before
this kind of technique has been evolved
there's never been a pure CSS wave of
doing this the technique here is it's
pretty cool so we'll call this the
kellam Keith technique we're basically
taking all of the elements of the page
and we're putting them into Z layers
it's using 3d transforms which have
constructed a technique you know 3d
transforms comes with a way just as we
heart of establishing depth and def is
exactly what we need for parallax so a
really nice way of seeing this I come
over here and this is kind of the
fullscreen example I'm going to open up
the dev tools and there's a new
experimental panel over here called
layers and so we can see my layers
moving around on the right-hand side but
cooler than that I can also kind of tilt
it and we can see the depth of them as
they kind of move around so we are
literally actually moving these in 3d
space and we're locking the viewport of
the browser to a particular perspective
and moving this around which
semantically you know feels great
because it is like exactly the 3d
experience that we are trying to
give to the user and now we've actually
constructed it in 3d space inside the
browser so it's pretty cool I want to
show a few more things just taking a few
sites that have done these sorts of
techniques and see if we can make them a
little bit better the first is this
great kind of interactive experience
that the New York Times put together a
little bit ago so it's tomato can blues
and as I scroll down this page we have
these kind of guys that that's scroll by
but as I kind of scroll this by like
like up here it's smooth right like this
feels fine and then I come down as I did
you did you did you do and it's like
like I'm just going my fingers but it
just like juggs as these are moving out
so let's look and see what's happening
all right I come in I'll inspect element
and as I scroll we're looking over in
the elements and we see some things
updating and it looks like we have a top
and a and a transform scale that's
actually changing so what someone's
guess at something that is wrong here
yeah just do the transform we kind of if
we avoid the top completely the browser
is probably going to be able to make
this a little bit better so what I did
is this is using the scroller library
which is pretty good and what I did is I
went in and I just made my own copy of
this page and in it this is kind of a
mess I basically temporarily said let's
just take out the top let's transform
only lets manipulate only the transforms
here is my yeah forget it this too hard
to read we said let's do only the
transforms I'll take that away and come
back over here and so this is my updated
version I just told scroller instead of
manipulating top and transform at the
same time just transform it's about it
and as I scroll down
yeah before after yeah so I was a quick
one the next they have here is carousel
carousels and app recently released by
Dropbox has this nice kind of experience
right here pretty good but let's open it
up and take a look I think that I'm the
thing that I didn't show in these two
experiences really is I mean I guess we
can all see it and feel it but I like to
show it to if as I scroll the page what
we want to see oops we're going to see
on the timeline is yeah so I just
captured a quick timeline recording
we're looking at the frame times here
huge frames going way above our 30 FPS
threshold compared to the after where it
is saying really small all the work that
we're doing is happening far underneath
60fps so looking over here on carousel
you can see the entire page is green
right looks like we're just changing a
few things on the page but the entire
page is getting updated for some reason
if i run a timeline and i scroll you can
see it's doing a lot of work so like any
device that is a little bit weaker than
mine is going to be running this much
lower I'm running it at 20 to 30 fps and
any other machine would be a slower
machine we've been running it much lower
so let's see if we can fix this I'm
going to open up elements and I want to
basically get an understanding of why
how these are being changed so i'll just
select it and so it looks like we have
just the transform is being updated okay
that's cool so here we don't have that
problem of top being manipulated it's
all just transforms let's figure out
where it's being manipulated I'm going
to break on attribute modifications
sizes are shaking but when we say bagon
that rebuke modifications a great bonus
here is that it will break in the
JavaScript where the inline style is
being changed so let's drop that in and
I'll scroll again and cool so now we're
broken inside of the minified jquery but
our call stack is telling us a little
bit more coming down we have jQuery
jQuery jQuery and then this looks like
actual application code animates step we
look in here and it looks like this is
where it constructs the transform
adjustment and so what I'm going to try
out is let's just add a translate Z into
this what this is going to do is say hey
we are animating all these things with
transforms I want to operate them as
individual layers on the page I'm just
going to change that JavaScript I hit
command s and my console tells me
recompilation update succeeded so I just
updated that JavaScript I'm going to
come out of the breakpoint just is just
going to continuous and now as I scroll
I'm going to hit my break point again
good and there we go cool so here if I
take I'll open up the unmodified example
right next to this here is the before
think yep before and timeline the after
so yeah it's not so bad a lot less
working them the next thing that I could
do actually is because translate Z is
kind of on its way out as a hack a
better thing to heed we could do is just
straight up views will change so i'll do
that now
something like this thing will change
and then we basically say what we're
going to change we are going to change
the transform of this element will hit
command us update that and well it's
basically the same but that's that's the
kind of effect that we want so we're
looking good here as far as a few
library recommendations scroller and
stellar scroller is probably the most
popular and the author has put a lot of
good work into it stellar is from a
developer outside of Melbourne they're
both great they're not very well suited
for mobile work but they do a good job
being as perform as possible on on
desktop for mobile for mobile only
things i would recommend the Kalam Keith
technique that we looked at earlier
which does a great job the other
question is like dude should you provide
a parallax experience on mobile I would
probably recommend that you likely don't
need to hit it enhances the desktop
experience and you could probably just
kill it from mobile so to sum up
browsers can hit a bath bath and
optimizing these animations if they are
just set up declare declaratively and
CSS the fastest thing you can be
animated it's transform and opacity you
might need to layer promote so watch out
for that try it see if it changes if it
doesn't change don't leave it you can if
you just promote everything it consumes
a lot of GPU memory and that will either
crash a browser or just make everything
really really slow so a good guideline
for that is don't have more than 30 to
40 layers on mobile and try not to use
JavaScript but if you do make it as lean
and mean as possible a few techniques
for keeping your JavaScript fast is
using requestanimationframe minimizing
only the elements manipulated
this not doing what this site did this
is like kind of the classic one this
blow up a few years ago and they did a
really nice job come on come on what the
site decided to do was as you scroll
down there kind of moving elements
around and they literally update the top
and left property for every element in
the Dom as you scroll so basically the
viewport the user viewport stays fixed
and they are just moving the entire
document with left and top as you as you
move your mouse all right and minimize
your hand lacoste and that's it for me
I'm going to wrap up and let's get on to
Jen so I'm excited thank you guys very
much
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>