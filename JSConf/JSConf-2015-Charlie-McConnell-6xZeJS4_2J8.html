<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>JSConf 2015   Charlie McConnell | Coder Coacher - Coaching Coders</title><meta content="JSConf 2015   Charlie McConnell - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>JSConf 2015   Charlie McConnell</b></h2><h5 class="post__date">2015-09-30</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/6xZeJS4_2J8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hi everybody I just like to say as we
start you haven't really given a talk at
a tech conference until you've had a
kernel panic setting up your displays
well yeah anyway we're from pebble we're
here today to talk about the pebble
timeline I'm Charlie McConnell and I'm
lands Vic and we're a retired magician
retired actor and we've been playing
with linux stuff for a long time and now
we do that professionally we are the
resident linux weirdos on the pebble dev
ops team yep so pebble first of all by a
show of hands how many of you are
already familiar with double suite how
many of you actually have a pebble also
sweet all right so for anyone not
already familiar what is pebble we make
watches the core mission of pebble is to
just make a damn good watch I'm directly
quoting the CEO when I say that so since
it's 2015 these watches are pretty smart
I'm told some people have gone as far as
to call them smart watches all right so
the original pebble in 2012 was a
started out as a Kickstarter project it
got a whole lot more interest than
anyone actually expected and at the time
it was a record-breaking more than 10
million dollar Kickstarter this this is
a picture of the Kickstarter from the
first pebble as you can see it's it's a
very simple watch it's black and white
screen all plastic just a really simple
device but a ton of interest at the 10.2
million dollars in kickstarter backing
for a long time we were the record
holders then i think it was 2013
somebody made a really cool looking
cooler and this this beat the original
pebble now i'm not really i don't really
know much about this cooler but it looks
kind of awesome oh that guy i hope lots
of people are having fun with their
margaritas and their coolers but uh you
know fast forward a couple of years and
then this year a few months ago we
released pebble released their newer
announced their new watch the pebble
time on kickstarter this is a revamp
design we've got a color display we've
also got added a microphone for voice
capabilities and this you know we did a
little bit better this time I hear we
gave Kickstarter a couple of bad days
sorry about that
but yeah so why would I want to pebble
for starters the thing that I like about
it best actually being kind of a
curmudgeon about technology is that it
is always accurate the time is synced
via its connection to your mobile device
so it's literally the most accurate
watch I've ever owned it's also got an
always-on screen which is what they
would call an e-paper display the idea
with this is that it reflects light
instead of emitting light so it's big
power savings and it's often times
easier to see in sunlight because of
this and other things you'll get up to a
week of battery life now that this is
dependent on how many active like button
pressing games you're playing on your
watch obviously but you'll get up to a
week of battery life and there are tons
of cool apps cool watch faces
integrations with companies all sorts of
stuff like this so what it isn't is you
know the pebble is a relatively simple
device it's not a heart or health
monitor it is not a payment system it is
not a smartphone on your wrist it is not
a new pile of virtual distractions or in
other words and overpriced trophy watch
was not on our to-do list so yeah along
with the pebble time we've come out with
a new idea for an operating system for
the watch this is the pebble timeline
the whole idea when you think about an
operating system what you want is to
have something where the information
that you really want the information
that you're really after is very readily
accessible for you and in the case of a
watch what you care about is time so
what this gives you is the the basic
like the the most basic service
interface for this operating system is
just the timeline you can hit one button
to get to your recent past and another
button to get to your recent future
upcoming events so yeah an interface for
upcoming and past life events it's
designed to be really simple and to save
you time as opposed to being another
thing that you're taking out of your
pocket to press buttons with and stuff
like that each event is called a pin it
can be easily created by our API is all
of these things are just JSON objects
and for starters without you having to
do anything your phone's calendar app is
automatically synced with your timeline
so what can I use it for we're sitting
here at a conference there's talks going
on all day left right and sideways let's
put the talk schedule
Lance yeah so let's let's try to do that
um so to get started with the timeline
API you have a couple things get a
script which is actually using a pebble
API to post pains this is just a nodejs
module you can grab off NPM and a small
watch app to handle the sinking of those
pins that's that's really it so let's
take a look at an example here is the no
Jess library peple API node and you can
create pins send a pin to a user pretty
straightforward so let's go look at an
example we get this J Escom 2015
schedule there's no read me because I
did this like 3am last night or
something but we got a year so you've
got to populate dodge yes this is the
bit that actually matters and it is very
quick to put together and hurry you've
got all sorts of stuff here at the top
which I'll show you this is to get the
schedule it's just parses the GS comp
schedule web page and pulls out all of
the data and whatnot kind of rage roots
and regex here but it does the job lance
has that habit sometimes it's true but
so if you need to make a quick j/s comp
app you can come steal this function and
it does the right thing at least as long
as this change format doesn't change
around but any of it so we skipped down
to the part that it's actually really
relevant here to get scheduled magic it
all to worry about alright we've got a
schedule we come down here for each and
we just have pins you create a pin you
have a topic you have a generic pan
layout to notification it's got a title
that's all you need then you send the
shared pin to the j s compu doesn't 15
schedule topic and you can log it if you
want that's it that's all it takes to
make a basic out the nice thing about
this is that there's no server involved
here you just run this once Oh or run it
periodically if you want to update so
that's your data source up doing the
pins those pans are then posted to our
server and the watches then pull those
pins from our servers and keep in sync
for you so let's jump back
there's actually what that looks like
got a couple things in the timeline
there to show what the next things are
to do so what I looked at to realize oh
hey we have a talk that we're supposed
to be at so we did make it here yeah
thnkx Bibble yeah so very basic we
provide an API we have the no Jess
library you make content and then you
make apps that you know make the watch
gets notified when that content has
changed so pretty straightforward here
you can actually create update delete
pins pins are attached to either topics
or users so you can either attach a pen
directly to a user and that goes to only
their timeline or to a topic which goes
to many users apps subscribe to the
topics the watch passively updates that
and you can notify the user if it's
something that matters right now you
give them a notification else with
something they can just passively check
all right so let's let's go over some of
the tools we've used here it's all
pretty standard stuff we use MongoDB is
our primary data store it's all built-in
nodejs &amp;amp; Co ajs as far as our
application runtimes concerned we've got
red is in place as a cache and to handle
rate limiting for the timeline api's and
the actual notifications are handled by
a pool of workers which are pulling
messages off of amazon SQS no real
rocket science here just good solid
stuff so let's talk about our web
infrastructure let's talk about how
we've actually built and deployed this
whole thing so the the philosophy that
we have is best summed up as version
control the immutable deployments now
what this means is the idea that if
you're making a change to your
infrastructure that is actually even
more something that you should be
tracking in version control compared to
your coat the idea is that if you're
making a change it's getting tracked an
immutable deployment is the idea that
you are deploying and artifacts that is
the result of something is the output of
a program and if you are then going in
there and making manual changes to it
afterwards you're doing it wrong and you
should actually be fixing the program so
that you always have correct state as
the output of something this is the
whole idea of this so version control
deployment let's start there you're
going to deploy you're going to make a
good commit if you're going to alter the
infrastructure
alter the size of a cluster or the size
of an auto scaling group you're going to
make a git commit into the files the
track that information if you have
configuration data environment variables
configuration files however you're
tracking that and you're going to make a
change to it it's really important to
keep it in version control because that
way when someone fat finger is a value
and things are broken all of a sudden
you can be like oh I see what happened
now that thing was mistakenly edited
okay and then it's it's extremely wise
to back this up somewhere we've we
personally use an encrypted s3 storage
for this and the base of our deployment
system is actually available at on
github at pebble / get to play so to
achieve the immutable deployment side of
this we use containers the advantages of
containers is that you get a clean
system slate on every service run you
you know it's it's a like a subdivision
of an operating system so you don't have
things cluttering each other's spaces
they can't see anything else running on
the system you use namespaces to make
sure that everything like the first app
running in a container usually thinks it
speed one and it can't see anything else
if you're doing it right it can't see
anything else on the on the system you
can also use also on Linux these are
built out of namespaces and control
groups which are kernel level features
for keeping things separate from each
other one of the big advantages to this
is if you've ever worked with Python and
used virtual land of you will never have
to do that again so yeah specifically we
are using docker for this as of today
it's the most mature containerisation
solution it allows you to very very
easily create containers from a
blueprint namely a docker file and the
docker file is just think package.json
for servers it's it's a very simple
concept relatively straightforward
configuration file now there's a lot of
really good things about docker as a
really really big really active
ecosystem if you are you know if you
want to experiment with something you
haven't deployed before the odds that
someone else has a ready-made docker
container for it are really high now you
may not want to deploy that straight to
production but if you just need a quick
setup for something it's really great
for that it's also really easy to get
started building your own
containers docker is you know the
dockerfile syntax mostly not rocket
science not too many surprises it's an
easy thing to work with and docker also
gives you really easy interfaces to
things like by default docker containers
use this virtual networking bridge so
that they all have their own virtual IP
addresses and stuff like that setting
that up manually not so much fun dealing
with C group resource limits manually
not really all that much fun with docker
it's just command line options and
everything's pretty easy now as you
might imagine it's not without its it's
not without its hardships and faults the
dockerfile syntax can be kind of quirky
and surprising if you're copying a
directory you can't forget the trailing
slash or you'll have an unreadable file
containing all of the contents of your
directory it's also really really easy
to make really really big docker images
if you're starting your files with from
ubuntu if anyone who is part of your
base image is starting with from ubuntu
you're starting out with a quarter of a
gig on disk and then it's real easy for
apps to get way bigger than that we have
a couple of things that are over a gig
and it's really kind of surprising
logging also unless you are handling
things yourself out of the box docker
only knows how to pull standard IO out
of these processes and it tends to hang
it around in memory all of a sudden if
you've had a busy process you'll notice
that the host is slow because the doctor
daemon is using like forty percent of
your RAM and not really behaving very
well doctor also it doesn't tend to
clean up after itself when you pull
changes so if you don't pay attention to
it you'll have your disks filling up for
lots of dangling image layers in
addition probably the most important
thing to remember about docker is that
if you are root inside of a container
you are root on the host they do not
have a separate UID space for these
containers so it's super super important
that you drop privileges always there's
lots of advice in the community that you
don't need to worry about this you're in
a container it doesn't work like that
it's not really true it's kind of
dangerous in the sense you absolutely
have to drop privileges and if you're in
a position where the only thing you need
you only need one specific thing that
you might otherwise use sudo for like
binding to port 80 they have these
things called Linux capabilities the one
in particular cap net bind will let you
bind
port 80 there are lots of these further
further investigation here is left as an
exercise to the viewer so yeah after a
pair of slides full of full of hardship
there are there alternatives to docker
well there's a couple the first one the
one that interests me the most is system
DN spawn now systemd made this over the
last over the course of the last few
years they made it pretty quietly
because it was not really intended to be
a like a publicly advertised product
they built it as their test harness
because if you're if you're an init
system you always need to be paid one
make a container all of a sudden they
started to realize this had actually
become pretty solid and as of the last
version they quietly edit the ability to
pull and run docker containers so that's
brand new and it only works on btrfs but
I'm really interested in watching that
there's also a product being made by
core OS called rocket they are trying to
gather lots of people together to create
an application container spec and I'm
very excited about the direction this is
going but they're not as mature as
docker these are in progress things
rocket i think is version 2.5 or
something like that you watch them in
the long run as my personal opinion all
right so you're going to deploy with
docker it's it's it's easy and
convenient because the only thing you
really need on the server is the dr.
Damon the containers themselves will
contain all of the kinds of dependencies
you might need so all you need is
something to run your containers there's
several modern distros that already ship
with sucker Red Hat in particular will
ship with docker however not all of them
actually ship with a recent docker and
so you'll need to pay attention to how
old is if there's any outstanding
security issues things like that I would
say the bottom line though with all of
this you should choose a distribution
that you're already comfortable with
because it's just not going to matter
all that much in the long run if you
spent your whole career using app to get
on a bun to in debian you're going to
have a bad time with red hat because
it's really different in ways that
aren't going to make sense to you so
yeah for us the distro that we've chosen
to use is core OS it is a minimalistic
distro it is designed for containers it
ships with Dochart with the dr. Damon it
is designed as a clustered container
deployment target car OS is also
curated rolling release we get the
latest versions of everything after
they've hit some testing and for us that
means we're on the 403 Colonel I think
we're on dr. 1.62 it's very recent stuff
and so core OS is based on Chrome OS
which is itself based on gentoo so what
we're basically dealing with here is a
source distribution that was curated
than locked gown by Google and then that
was taken and curated and locked down by
the core OS guys and now you have a
server operating system there's a lot of
things that are really good about this
as I said it is ready-made for deploying
with docker you're you're the distance
from 0 to 60 doing this with core OS is
it's just really easy you don't have to
install anything it's also a system d
distribution I have a big fan of system
date systemd adds consistency where none
existed before and the dependency
management that you are able to have
between services and mount points and
parts of the operating system is not
something that you get otherwise unless
you feel like writing a couple thousand
lines of bass yourself which a lot of
people who don't like it appeared to do
core OS also it ships with that CD at CD
if any of you are familiar it is a
strongly consistent key value store it
is it's a lot like Redis except its
emphasis is on consistency as opposed to
high availability in performance it is
it's designed for keeping things safe as
opposed to being a fast cash core OS
also comes with a neat tool called fleet
it is designed as a distributed wrapper
around the the systemd instances that
are running on all the notes in your
cluster there's a lot of really cool
things about fleet as nodes come and go
from the cluster fleet will just say oh
ok I'm this type of note that means I
need these services let me pull those
services from etsy t let me start those
things pull the docker containers from
where they come from and then when
you're you know when your cluster
autoscale in the middle of the night
everything started like it was supposed
to because you've got to distribute it
in its system now there's also core OS
also has a really cool automated rolling
updates feature they actually have this
thing where you've got two separate root
partitions and they'll update one while
the other ones running it's yeah it's
good stuff but
thing about this is that if you leave it
with the default configuration it will
reboot to apply those updates which is
cool and really fast because of that
thing with the two root partitions but I
promise you you don't want this
happening in the middle of the night you
might think you do you don't want this
happening in the middle of the night
luckily it's easy to turn off and the
updates still download you can do it
yourself with one command in addition to
this the current default version of Etsy
d at sea do point for is problematic
they've got a new version it ships with
core OS but it's the binary is named at
CD too because they don't want to be
pulling the rug out from under people at
sea do for is problematic and is
definitely something that you should be
careful about using new deployments
should not go anywhere near it another
another issue is that fleet sounds like
it's really awesome but it's super super
simple and not really a not a complete
deployment system and additionally a
number of the quick easy fixes to these
problems involve subscription services
from core OS which is what it is anyway
back to pebble our deployment pipeline
starts out we have our own we have a
private doctor registry we use that to
build images based on get pushes and to
host the images for us to pull to our
infrastructure we've got a in our
staging in development environments
we've got a web book server docker
registry will give us a web hook for
this when the builds are complete and
then in staging we automatically restart
services in production we're a little
more careful in that and we run
everything off of a custom git repo as
we were talking about before with this
the pebble get deploy and we base
everything on just post receive hooks
and all that so yeah at pebble we are
firm believers in using the right tool
for the job because most of this stuff
is get hooks we are about 90% bash where
the deploy pipeline is concerned we've
also used little bits of go here and
there because with go you can make a
really tiny binary fairly
straightforward language you can make
really really tiny binaries like a five
megabyte docker container and stuff like
that it's pretty cool for us these
docker images are the immutable
deployment artifacts that I talked about
every server every state of it
you stayin of every service should be
the output of the program if it's miss
if it's misconfigured to fix the program
finally a quote from an old friend of
mine redundancy resiliency scale this is
how you this is how you survive
unexpected things you've always make
sure you have backups you make sure that
things can be deployed automatically and
you make sure that if servers suddenly
start exploding there's something that
you can do about it without a ton of
fretting and head-scratching alright so
yeah we're here to solve real world
problems with watches and a lot of these
real problems uh you know what's was
their food around me I'm hungry you know
and I want to be able to see that
quickly at a glance where's my train you
know rather than pulling my phone out
and checking constantly is it here yet
is it going to be here what's going on
or where's my you know driver or
whatever when's my next talk has imaged
with a Jas comp demo you could totally
add those events to your timeline and
actually know in your next talk is it is
the restroom free yet all right I need
to on a show of hands here how many have
really need to use the restroom at your
office and you found out that
everything's full anybody if you honest
people okay all right yeah it's actually
really inconvenient it's a time sink um
in fact I would a that's uh yeah it's
it's very convenient it's probably our
biggest problem as a company so you
think about right so fast growth 180
employees catered lunches right for
toilets um so you know haven't got the
we have to rethink the office situation
obviously but yeah so at the moment it's
it's a problem so you know we have to
solve this problem so a solution for
that a lock state sensor arduino a
nodejs server we emerged javascript
conference right na pebbles so we can
take a look at what that looks like here
so I've got the toilet time repo here so
and actually let's just go through and
see actually read me shows you some of
the things that are going on here you
can play around with let's actually dive
into the code so
three parts to this we've got a locket
clients this is actually some Arduino
code this just shows you that there's a
lock pin there's an LED pen there is
ether nets in this case it's you know
listening on a lock penn state whether
it changes to on or off and it sends a
manual post to a server and you should
actually give you a look look at what
that looks like there yeah something
like that so um I don't know about you
guys I'm pretty sure this is production
ready you know or we're getting a bit
yeah exactly okay we got the the lock
sensor there it goes down to Arduino
update server you know we're good to go
so we go through the posting of JSON
let's go look at the JavaScript so for
the JavaScript we've got got khoa joy
router which is actually an in-house
project to make a nice validated router
for for khoa here we've got a route v1
update it's a post route going a little
more catch the body if there's not
anything and we checked the state's
coming in and the state coming in is
either going to be locked or unlocked we
say if it's either occupied or vacant
based on a 01 that we're receiving and
here's the bit that is again very simple
we're creating a pin and this is just a
generic pin bathroom is either vacant or
occupied and we post it to the timeline
that's really it that's that's that's
all it takes and these three parts work
together and you could actually refactor
this to be something a little different
perhaps you want to know on your
timeline you know what the temperature
is of your very tightly controlled
aquarium at home or anything to get data
from a source at get it to a server and
then project it to as many watches as
people care about that piece of
information so let's just jump back here
and show you that looks like here I've
got a bathroom vacants and it's actually
working right now and I can actually
find out the status
of the Palo Alto bathroom and whether or
not it's free because that's what's
really relevant at the moment I have
never been more disappointed to be a
remote employee yes so yeah that's a fun
demo and hopefully gets you thinking
about the things you can build with
pebble and go grab the node library and
try it out thanks thanks in closing
pebble is hiring like crazy so if you do
any of these things you might have to
squid that right now by all means come
talk to us nabble.com jobs</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>