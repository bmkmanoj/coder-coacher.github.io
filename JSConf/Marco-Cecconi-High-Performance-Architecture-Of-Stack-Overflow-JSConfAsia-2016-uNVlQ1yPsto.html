<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Marco Cecconi: High Performance Architecture Of Stack Overflow - JSConf.Asia 2016 | Coder Coacher - Coaching Coders</title><meta content="Marco Cecconi: High Performance Architecture Of Stack Overflow - JSConf.Asia 2016 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Marco Cecconi: High Performance Architecture Of Stack Overflow - JSConf.Asia 2016</b></h2><h5 class="post__date">2016-12-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/uNVlQ1yPsto" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">how are you are you well rested after
the break so my my name is Marco I'm
amazed that my surname got pronounced
right
anyways I work for sack overflow I'm
going to talk a bit about the
architecture so how do we build stuff
and first thing so there is this
fantastic QR code if you scan it you'll
be able to follow along the slides okay
is I don't know if it works but you can
try anyways so we are by the way we are
a c-sharp company so we use C sharp
we are not no js' and before anybody of
you ask me the question that asks me
every time why don't use nodejs or
whatever okay if you do that I'm gonna
make fun of you because of left ok so be
careful anyway so architecture so I
looked up the definition of architecture
and it says the art of science of
building specifically your practice of
designing and building structures
especially habitable ones of course in
our case you know a software
architecture is not about building
houses is about building software where
is the same concept and architecture is
actually something that existed for a
long time it was studied since we have
texts talking about architecture there
are more than 2,000 years years old and
one thing that was notable even at the
time is three characteristics that make
the concept of architecture so three
things that architected things must have
so the first thing is durability right
so you building a house you're building
a temple you don't want the temple to
meltdown when it's raining for example
the
thing is utility right you you created
your fantastic temple you forgot to put
in the doors and you know you can't go
into it so it doesn't really work so so
you need to have something that doesn't
fall down and something that you can
actually use but it's more interesting
the third characteristic that a good
architecture must have and is beauty and
you can see how for example for a church
or for a temple or for even for a house
or a villa it may be something obvious
right you want it to be beautiful but
how does it work with code right and
this is open to interpretation and but
in our case we certainly have
interpreted this as to mean performance
so for us it's important that the code
that we that we build is very efficient
and efficiency is the ability to do
something without without waste so there
is one good way that we a method that we
know all about that is very very
efficient and allows us to get to
solutions which perform that maximize
the performance very easily and that
method is the scientific method so if
you think about it
when when people when you have
scientists doing science what they do is
they have some observations and they
think of a theory or some model that
will explain the observed observations
and use that model to make predictions
and then they make experiments and then
they verify whether these experiments
are actually are actually confirming or
disproving their policies so the most
important meeting here are these three
the small 3-step cycle here you know
where you gather we gather data you
refine and alter expand so you analyze
your day
and you build new theories all the time
and we basically did something very
similar so when we when we do code we
build build code we build the product we
measure performance and then we analyze
the measurements and this allows us to
define how to build the rest the rest of
the product so the first thing that
anybody is going to ask you if you are a
customer and you want someone to design
a church for you they're going to ask
you okay so you want like something
small what's your budget you know or
something big so knowing the
characteristics of what you're building
is very important and therefore this
this whole talk would be meaningless
unless I told you a little bit about
Stack Overflow and the kind of scale
that we have so you can sort of relate
or or see why we go to such lengths to
do to do these things so first of all
this is the top sites according to
contest which is one of the two top
measurement agencies that tell you how
many unique visitors you have every
month that were Flo would be between 17
or 18 it's not there for a couple of
reasons and but the most important one
is that we have our traffic is actually
split around all our network of sites so
Stack Overflow is part of a larger
network of 160 different sites with
different topics that go from cooking to
English to Japanese to philosophy or
physics so Quantcast doesn't really work
very well for this kind of setup and
therefore it is split all the traffic in
different blocks but putting them
together we would be somewhere between
Wikipedia and people which is pretty big
by the way I was telling you is not very
you know podcast is not very reliable I
can tell you why so does anybody
remember this coming out maybe in
September
so basically North Korea screwed up
there there both the router
configuration and turns out they have 28
websites in the whole country so you can
imagine them you know or like there and
according to Qantas what are they
looking at Stack Overflow
so apparently we are very popular in
North Korea so now you can trust this
numbers clearly but okay it's just funny
so I think in some version of this talk
since 2013 when I when I started giving
this talk we had somewhere around 100
websites in our network that was talking
about nowadays we have 160 and we are
still growing of course and these are
pageviews
so again Quantcast so believe it you
know take it or leave it
but we were around 400 million pageviews
per month when I joined and we're
talking about this and nowadays we are
actually over 1 1 billion 1.2 billion
per month and this is not really up to
date on the other hand the number of web
servers was one in 2008 when the when
the site started then he grew a bit to
five in two thousand nine thousand ten
and then 2011 we went to nine web
servers and ever since then I started
talking and we grew like we doubled up
our traffic tripled our traffic and we
still online web servers so to give you
an idea I was looking today at some
stats for some other sites which are
there in the in that list so Pinterest
which is two steps of on top of us
in 2012 the what
150 servers Wikipedia which is I think
below us or just above us I have more or
less 10 times the amount of hardware
that we have so how do we do this we do
this with this small poor man's
scientific method build measure analyze
so I'm going to give you a few examples
very quickly because time runs out so
first of all with the hardware so this
is an actual picture of our own server
farm server farm three racks and as you
can see there is not much there and
they're mostly databases all the stuff
that you see up here all these numerous
things here they're all these drives
because we have a lot of content right
so our main concern is actually running
out of space is not running out of power
so what do we do we serve the site and
then we have this fantastic dashboard
which is an open source project called
observer which allows you to measure the
performance of all the servers in it and
as you can see in this screenshot can
you read it yes so up here there are the
database servers and you can see we got
four and the way they are set up they
are two for the network and two just for
Stack Overflow of each pair one is
read-only and the other one also accepts
writes so basically there is only one
server doing the actual hard work and
this one's got a lot of RAM
even though nowadays you know there is
common to see terabytes of RAM so these
are the web servers so this one runs
like promotions and not the sides the
sides are actually on this nine here as
you can see this is a typical day and
their CPU is like five percent
10% so we have not only we only run on
nine but these nine web servers are
really really under capacity so we could
lose a few of them and still be up and
nobody wouldn't notice in fact sometimes
when there is something dangerous we
just take one out of the out of the load
balancer and try to deploy stuff in
there
so if it goes crazy if he goes crazy we
can just shut it up shut it down and
nobody cares because the traffic is
gonna just go on in fact we have
calculated that we could probably use
just one less web server and serve all
the traffic if we were crazy enough
after we get all this data what we do is
do one big spreadsheet and we try to
understand how much space are going to
need next year and then based on that we
buy new discs or buy new servers and so
on and so on
so again it's literally physically built
measure and analyze the data and this is
the architecture overall I just wanted
to give a quick overview a word based so
on top here this is where you are right
so the requests come in here go through
Reuters all the borderline stuff they go
through low load balancer which is like
one machine active and one machine is
just stand by and they go into the
famous nine web servers and in the back
hand there is really very little there
there is Redis which runs on two boxes
there is elasticsearch that runs on
three and we use that for searching the
service tier is more interesting what
this does is it's a specialized index of
questions and questions and tags are you
familiar with the waste our flow works
you know I have a questions as a tag so
you know this question you see sure of
this question is no js' or whatever and
when you navigate the site especially if
you're logged in which
to guess which questions are going to be
interesting to you and we do that based
on tags so there is a lot of querying
going boolean query going on with with
the tags and that actually can't be
performed by sequel server that would be
absolutely crazy so we moved on to
something having something completely in
memory but that also was too much and
then so we move it to a separate server
which only does that and then finally we
have a single server so again build
measure analyze that particular build
measure analyze just shown was actually
quite slow right you can do maybe yearly
hardware refresh cycle if you're using
the cloud you can increase the number of
servers if you need to but in any Indian
case you don't do that like
second-by-second it's something that you
do with time and whereas it's important
to have these cycles optimized for speed
so if you can do this cycle very quickly
it's important because what this cycle
does is takes a solution your product it
just changes it slightly in the way it's
implemented so it fits better your
condition and the faster you can iterate
the quicker it converges to an optimal
solution so an example of this is actual
code right so this is an example of code
and I'll show it again later one thing
that you can see in here and we
optimized for is that this code
basically what it does it takes all the
table out of the DB this table contains
content in particular it contains our
health center and the store sitting in
cash and installing a static object and
it's there for use and and all the stuff
is done in 10 lines of
and the reason is you know the less code
you write the faster you are in this
step the faster your cycle is so it's
important how do we measure that
so once you have your page is being
rendered normal users just see the site
right so they just see that the page as
developers see up here a small rectangle
with the time so this page actually took
100 no so yeah 150 119 one millisecond
to to render this was really really slow
for some reason in any case you can see
what's wrong if you're a developer you
can go up there click click on it and
you get actually a complete breakdown on
how the page was rendered where time was
spent was it spent in this column here
which is sequel was it spent on Redis
calls was spent on elastic if there is
some elastic calls in there you would
also have a column and this tells you
pretty much what you need to optimize
and what the problems are not only that
but profiling everything at every at
every call allows us to actually store a
subset of this data and put it in a
sequel in a sequel database so not only
I can see this particular page what
happened in this particular rendering
instance but I can also run averages
over the last day for example and see
okay how is the site how is this
particular page performing today and
then allows you allows me to actually
get to graphs like this one so this is
just something I did on a random day to
tweet about it but as you can see this
is a question page so when when you go
on Google and say okay how do i parse
HTML with the regex you land on our page
and this is that page so these are the
measurements for that page and
can see rendering that page takes
between maybe twenty ten and twenty
milliseconds for most part and you can
see also in here that about two three
milliseconds of spent on average in in
sequel and read this is like crazy it's
like sub milliseconds we can't even
measure it from most most part and it's
also interesting to see that there are
some spikes here those spikes are things
that went wrong garbage collections and
so on and so pages which are not
performing as well as they could for
example the one I was showing before had
some problem it would definitely be in
this small spike there so of course you
know understanding which pages perform
worse allows you to focus your effort in
making them faster and this is how you
get pages that rendering ten
milliseconds I'm pretty sure your
applications not as fast as this if you
do web so I mean all these optimizations
would be not very useful unless this
cycling would would was fast in fact I
think our cycle is pretty it's pretty
fast so I actually went on and measured
how many deployments we do on those nine
web servers every day so when I joined I
was told it was five they lied to me it
was so I joined somewhere around here
and actually was five like the first
month though and they went down and then
growing back up again so we are around
five four four five deployments a day
which is actually pretty good at least
according to my former career where a
deployment took six months by the way
does anybody know why there is the spy
here of like a gazillion developments
just for that month anybody can guess
sorry rejects no so this is because we
release documentation and which is like
a major expansion of the site is like a
completely new part in which there are
many examples documentation for
languages and features and of course
that came out with a large number of
bikes and large number of consequent
deployments so I was telling you before
about the Help Center
so the Help Center is just a random part
of the site it's not a major part or
site but even that is optimized and as I
was showing you before so this is the
code that actually is a complete storage
of all the all the Help Center articles
they're just you know blatantly stored
in memory they're stored in a global
variable which is something that if you
went to any computer science course they
would have told you never to do and we
do it it's all everything is cache the
global cache is a nice object at what it
does it looks in memory do I have it in
memory yes okay here it goes
if I don't have it memory I'll look on
readies for everything readies no ok
then otherwise I'll just execute this
lambda over here you got lambdas now in
node.js right and and this is our ORM
layer two lines of code basically this
opens up a connection and this part runs
and maps this people so as you can see
the code is very is very tight and it's
actually using a lot of this particular
way of doing things where we use a lot
of global stuff a lot of static stuff
which in in language like the C sharp is
really really not something you should
be doing and we do it because it's fast
it's really really damn fast there are
also examples of caching which are
really strange
for example this is the actually the
answer to should I help connect parse
HTML with the regex you can't anyways
this is just a question it's a very
popular popular answer sorry and as all
answers there is up there there is three
small tabs they allow you to change the
order of the answers whether you want to
see the latest active one the oldest one
or the most water one on top so that's a
completely static content you know
there's nothing in it that you need to
do you know there is no calculations
there is nothing the only thing that we
need to do in order to display that in
the backend is actually create objects
for the three tabs and then we just
render them right except that code is on
a page which is rendered 1.2 billion
times a month so that's a lot a hell of
a lot of objects that are created here
so in order to further optimize the code
it actually makes sense to cache in
memory those three objects so we just
create them once instead of creating
them every time the reason for this is
garbage collection and if you do not yes
you should be worrying about garbage
collection even though you may not have
been thinking about it so far what
garbage collection is is the magic thing
that allows you to create new objects
and then you never have to delete them
you know in old times when people
actually use see you couldn't just
create something out of nowhere the way
to do to do it of course is you know to
ask the runtime okay give me a chunk of
memory then you use it and then you give
it back and say okay I don't need it
anymore if you forget to give it back
then you keep on using more and more
memory and then at the end you run out
of memory but in a managed language like
like JavaScript or C sharp you don't
actually need to give that memory
because the system is so smart that he
figures out okay you don't need this
stuff anymore so I'll just reclaim the
memory for you and this is done by a
thread
and bacon thread called the garbage
collector and what it does it takes all
your objects all your functions all your
contexts and goes through and see which
one depends on which and which one is
still alive which one is otoscope and
then it clears up all the space this is
great because it allows your code to be
very simple but it sucks
because in order to do this the garbage
collector needs to actually freeze all
all your code from prevent your home
from running at some point and just
clear up everything so if you got if you
create a lot of instances or if you get
create very complicated instances then
this becomes this becomes complicated
and it takes a long time so you don't
want to do that one example is
dependency injection so it is something
that you do a lot with with testing
right so instead of creating objects
instead of getting them from the DB what
do you do you create a container and
that container is a magic object and
knows how to build stuff and it knows
whether you're testing or not testing
and if you're testing use your test
object and if you're not testing it's
going to give you the real object so you
can like the couple stuff you can do
stuff without going to the database and
so on all right you can do fantastic
stuff like this right so you go to the
repository say I want to get this thing
and then and you don't know what it does
right it could be if we go into a mock
object but in this case it particularly
is doing a lot of things like it's the
invalidation security login and so on
and you can't do this again because in
reality what you're doing behind the
scenes in the in the in the repositories
you're creating a bunch of objects with
all this stuff and we can't do that in
fact we can't do that and therefore
testing gets really really hard and
therefore there you go we have very very
few tests in the code basically we don't
unit us at all so
build measure analyze more stuff right
so I was telling you about about unit
tests right yeah that's the most
interesting man in the world so that's
pretty much a testing strategy so what
happens when you when you do this right
so what happens is okay if you do it in
your likes or during a financial
institution it's really bad if you're a
site like Stack Overflow with your main
customers are developers you get bug
reports right so we have automated
testers actually a lot of them do
JavaScript and what happens is we
actually get the solution so there you
go see this is how you approximate stuff
so you know you do the best of your
condition anyway so
anyways if you think you have pressure
we do our pressure okay so we go down
and we go we go on TechCrunch okay this
is not it's not a fake
okay build measure analyze and it's
another cycle that we have okay it's not
exactly that in practice is you know you
hire great programmers or programmers
that really have a lot of passion for
what they do
hackers and then you give them the right
tools for the job
right so you empower them you give them
you know the harder the one the softer
they want the trust they want and what
they do is create great code or
performant code and having a great code
base I mean if successful product is
what gets you again there are kind of
people that you want to have in your
company so isn't there a kind of cycle
that we have but we are very conscious
about it and it's very much
part of what we do on a day to day basis
and so I was just going to talk about
hackers and this what came out like a
90s movie so no real hackers look like
this okay not really in the seventies
though can anybody guess what company
disease yeah so yes so we have a policy
where you can get all all the all the
tools that you want and if having three
monitors is absolutely normal and you
know having your favorite like clicky
keyboard or you know visual studio if
you need it or whatever so it's
important to have all this thing coding
wise we do stuff that okay people are
actually I've been discouraged from
doing in all the other jobs I had like
for example they compiling your
intermediate code that gets rendered is
something maybe you don't do we no js'
but we do it all the time to in order to
to improve performance or if you look at
it
with queries look at the query plans of
the my security plans and look at all
the little bits and tweaks you can put
into to make it's just likely faster all
right so it's a cycle again you know
hackers tools and and results are code
so in conclusion I have 15 seconds
okay so performance is a feature and not
a luxury at least for us as I was
telling you you know you want this site
it doesn't fall down and you want a site
that is usable and but it's you want to
have the code base which is beautiful in
our case performance is the beauty of
our core base in order to optimize
performance you need to have cycles and
I'm pretty sure that no matter what your
priorities are in your in your company
you have your seen cycles you maybe you
do a Giles and you have weekly cycles
but you need to be very conscious about
these cycles and optimize for them you
know I'm pretty sure that most companies
don't measure as much as we do so all
the cycle schedules hewed up the results
that you get are become very very
specific to your case as I was saying
you know automated testers this is
specific to us it won't work anywhere
else but it's also extremely high value
if you think about all that I've talked
about and how we can do code which is
not testable but then we can test it
another way it's all a chain of things
that work together and this only works
for us and you need to build the same
thing in your own case you need to build
the perfect architecture for your own
case if someone comes to you and tells
you just do whatever architecture acts
several less we had the new one is
everything's going to be better maybe
it's true maybe it's not true you know
it really depends whether it fits you
garbage collection is a pain at scale
and you know I know js2 sorry
so you need to hire hackers and hire
people with a passion for coding that go
beyond you know just merely doing the
job for eight hours and then going home
and I need to insert a plug about Stack
Overflow jobs and this is how we
monetize so if you want the job we job
for you and buy three monitors because
come on they are cheap now so anyway so
quick announcement you know we have
badges to encourage good behavior we are
giving away today in tomorrow this badge
it's a silver badge cannot robot in
order to get it you have to come and
talk to me and I give you a code to
unlock one for yourself and this just
encourage people to come and talk to us
that's all the reason that is there so
that's thing and that's it so that's my
Twitter and that's a game so thank you
very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>