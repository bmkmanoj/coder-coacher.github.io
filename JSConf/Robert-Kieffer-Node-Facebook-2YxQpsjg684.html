<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Robert Kieffer: Node @ Facebook | Coder Coacher - Coaching Coders</title><meta content="Robert Kieffer: Node @ Facebook - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Robert Kieffer: Node @ Facebook</b></h2><h5 class="post__date">2013-01-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/2YxQpsjg684" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">you
I'm Robert Kieffer I'm a facebook
engineer on the chat team and if you
need to contact me at any point I'm rufa
pretty much everywhere skype IRC Twitter
etc and I just want to thank you guys
for coming here I know we've got got
Isaac next door doing the NPM talk and I
actually really like mtm a lot and kind
of wish i was there as well to check
that out so I appreciate your time here
so let me start by giving a little
background on who I am since I don't
know how many of you I actually heard of
me I've been developing web apps for
actually quite a while I started writing
rich like MVC JavaScript applications in
the client back in 1998 1999 and I've
been doing that for pretty much the my
whole career since then I've at
companies like AOL Google most recently
Facebook and with a couple of startups
in between so I like to think I've got a
pretty good perspective on this whole
hold javascript thing um as far as my my
street cred with node goes I've got my
fingers on a couple of little things I
would say like modules that are more
micro libraries than anything else
things like node mine which i guess is
used and expressed and and connect these
days if you want to do RFC compliant
uuid generation my node uuid library is
the way to go jayus litmus is a ad hoc
benchmarking library I did that was the
basis of jas perf calm and then
a little library for doing n64
manipulation in a node thrift which
way'd winsome as has been putting
together and then within Facebook I seem
to have fallen into the role of internal
node evangelist so Adam wolf and I run
the the node group that's internal to
Facebook and I'll talk a little talk a
little bit more about what exactly that
means to evangelize within a company so
let me set the background for this a
little bit just to give you guys some
context and maybe to give those of you
who are here thinking I'm going to be
talking about us deploying thousands of
servers in production and all the hard
data and stuff that we learned from that
opportunity to go head over to Isaac's
talk because the reality is Facebook
isn't doing enough with node right now
we're actually just getting started but
I think what we are doing is pretty
interesting and more importantly what I
really want to talk about today is it's
sort of the note in the context of a
large company like Facebook where you
have to you have to deal with things at
a scale that really aren't being done at
very many other places around the well
around the country around the world so
what I'm going to talk about today is
like I said isn't really going to be
nuts and bolts details on how you deploy
thousands of nodes servers it's going to
be more about why I think facebook needs
node why we're not embracing it yet why
we're not that far along the curve and
what I and some of the other folks
within the company are doing to change
that and to what extent we're failing or
succeeding in that so why does why does
it company like Facebook need node I
mean one of the things that that we run
into or that I run into when I talk to
people within our company who aren't
note enthusiasts by nature is sort of
this well they're not impressed reaction
and a large part of that is I think that
the things that get JavaScript people
excited coming from sort of the client
JavaScript Amy
and having access to server side
JavaScript and you know in the form of
you know the single threaded event loop
just don't really turn them on there's
all these it there's all these
alternatives out there like lie bv live
event tornado event machine those
technical problems have been solved in
other languages you can solve them in
other languages and especially at
facebook where we already have you know
hundreds of millions of users and that
are being supported on servers by by
thousands of servers when you talk to
the people who put that there to put
that system in place it's really hard to
argue with success so there is a there
is a significant amount of I think well
justified resistance there so it does
beg this question of like well where is
the value to a really large company that
has established itself with technologies
that they're working and I guess the
answer to that I've actually been
thinking about this fair bit lately and
the answer that I guess I'll have to
sort of give you an anecdote from the
dark days of the internet when when I
first started doing JavaScript and this
was a small start-up I did back in
1999-2000 that was started by I and
three of my friends and of course one of
those was his CEO who's off doing CEO
things and the three of us were that
left three of us to do the end to be
through the engineering side of the
company and what we were doing was
building a well the goal the company was
to build microsoft office for the web so
Google Docs but done with JavaScript d
HTML and our first product was going to
be a productivity application
application so when we sat down the
three of us sort of looked at each other
and like well we know we're going to be
using javascript and HTML on the client
apache and java java servlets on the
middle layer and my suit my sequel in
SQL and a back-end and we had this
discussion of like okay well who's gonna
who's going to do what what are the
roles were going to assign and i ended
up drawing the short straw
found myself doing JavaScript so you
know that's what I ended up doing for
the next 12 years and sort of the irony
at the time was I never thought I was
going to put that on my resume because I
was sure this whole javascript thing was
just a passing fad so it fortunately
hasn't turned out that way the point of
this is that in that on that project and
pretty much every project I've been on
every web based application effort I've
under I've undergone has had this very
early conversation where engineers have
been cubby hold into one of those slots
are you a front-end engineer middle you
know middle where are you a back-end
database guy and um well that can be a
good thing I mean after all it does lead
to these conversations between people
that about well okay you've got you've
got Fred on the front end who needs
Maria doing who's doing the middleware
stuff to implement some point
functionality for and that enables this
conversation about well how should with
that what should that API look like to
what extent do do we need logic in that
middle layer versus on the client and it
creates these very well-thought-out
api's these very nice and modular and
structured interfaces at the end of the
day it really slows you down you have to
have this conversation and more
importantly it doesn't it doesn't allow
you to really distribute your resources
and one of the things that from that you
know from that company that really stuck
with me at the time was was a period
when we were actually in talks with AOL
to get acquired and they became to us on
a Monday and said hey you know we really
like this technology developed and this
team and you know you're selling us on
this whole stack of JavaScript d you
know really interactive applications but
we'd like you to prove that and what
we'd like you to do is build us a web
calendar a prototype because they had a
traditional static calendar application
and it was really for the slow and laggy
all these page turns
and so um they said yeah you know come
back a week from now and show us what
you've done with this you know give us a
prototype and of course our CEO being a
CEO immediately turned to us and said
hey I don't want to give them a
prototype I want to give them a
full-blown application and they're in
soo this conversation where we sort of
all turn to rob davis who was on our
back end and said hey what do we need to
do this and he said well give me a half
an hour and i'll implement the schema
you need for calendar events in our
database and so you know half an hour
later he came back and then we turn and
then we turn to Keith in the middle
layer and was like well what do we need
to transport this data back and forth
between the server in the front end and
keith is like well i really need to do
is whitelist the data types that were
sending and then they all looked at me
and like okay we need a calendar app and
you've got a week and i ended up
spending something like 120 hours over
the next week writing all this
javascript for a full-blown calendar
application it was incredibly rewarding
i mean it was an intense period of time
and it worked out really well AOL loved
it and my you know my wife went to take
me to dinner afterwards on the you know
after we'd given the presentation is
sort of a little celebratory thing and
about halfway through dinner i literally
just started shaking chills and you know
just completely exhausted and I was like
you know honey we gotta go home and the
reason I the reason why I'm going down
this path is that had we been using node
had we had JavaScript throughout our
whole technology stack instead of
everybody turning to me as the front end
guy and saying hey you've got to
implement this you're the only one
that's got this experience we could have
turned to the whole team and said hey
you know I know you guys have been doing
JavaScript in the middle layer and back
in but it's the same line which is the
same basic patterns and you can bring
all of that to the front you know to the
front-end development and really make
that work for us and instead of me doing
120 hours it would have been you know
three of us putting in a normal work
week um which would work that would have
worked out a lot better and probably
produced a better product in the end so
the point being for me the real value in
is not in not so much the technology
side of things but it's the
organizational and the cultural
differences in options that it enables
and I think that's often overlooked and
a small start-up you tend to get a lot
of cross discipline expertise anyways
but when you get into larger companies
like Facebook that's definitely less the
case and I think pretty much any project
that's got more than three people on it
has this degree of specialization to
some extent um so if there's this
benefit like why why isn't Facebook
going down this garden path you know why
aren't we why aren't we jumping all over
node and you know I think there's a lot
of reasons for that but the one that
really came to mind for me was basically
you know that that's saying about a
million monkeys at a million typewriters
eventually producing the collected works
of Shakespeare at Facebook we've got 600
million and not to say our users are
monkeys so please don't tweet that
because my boss is in the audience and
I'll get a call from HR but what we do
what we do have is just millions of
users that do all sorts of inexplicable
things and if you put a new technology
in production without thoroughly vetting
it they will discover every bug every
design flaw every performance weakness
that that technology has and the the
results of that are these guys they go
from being you know 600 million users to
these guys 600 million monkeys angry
monkeys and I have these all lined up
for a reason because they're organized
and you get things like the whole beacon
fiasco and you know all this this hubbub
over privacy issues not to dismiss that
because that's very important but it's
just no fun and so
that's where a lot of the the resistance
to note comes from in large
organizations but that's also very hand
wavy so let me go into a little bit more
detail on what that means at Facebook
performance is a top to your priority in
ways that are really surprising to me
I've actually only been at the company
since July which by the way it makes me
more senior than like forty four percent
of the company it's bizarre uh-huh so
one of the things that you find when you
join facebook is there is a an intense
focus on performance and cpu usage in
particular if if you can come in and you
can reduce average cpu usage on our web
to your machines by 1% you will be a
frickin rock star at the next
engineering All Hands our vp of
engineering will literally point you out
in the audience ask you to stand up put
your put your picture up on the screen
and say this person is saving us
millions of dollars it's that noteworthy
1% we've also developed our own
proprietary mama / re thats actually
open source web server called hip-hop
which is compiles PHP into native code
because of this issue similarly
reliability you know you need a system
that's gonna going to be bomb-proof day
in and day out or at least have well
understood failure characteristics and
both of these things i think the reality
with node is right now is that for a
company like Facebook or Google or Yahoo
there's really nobody up for us to look
around at and say oh those guys have
done it these issues are understood and
that's really scary and so the you know
this issue is it's certainly foremost in
the conversations I have with people and
then there's some other secondary issues
not related directly to the production
performance things like code inertia
Facebook has eight million lines of PHP
and that ruin that represents an
incredible investment of intellectual
capital and just as an aside we have
about three hundred thousand lines of
JavaScript
and the chat team has about twelve
thousand lines of airline that the chat
system runs so for people who care about
that sort of things that sort of thing
there's also things like deployment
processes and tools at a company like
Facebook where you have you know
thousands of web servers and production
rolling these things out is a
non-trivial task and you need a lot of
tools to help you do that and a lot of
people put a lot of effort into that and
of course any new technology makes that
sort of rocks the boat in that regard
and so your ops team your weekly push
team that's responsible for these things
they're going to look at you with a
really wary eye and then finally in we
have devtools so actually Facebook just
open source the product called
fabricator which is the internal tool be
used for browsing our source repository
and doing code reviews you may may want
to check that out it's actually pretty
cool I'm pretty impressed by how well
that works so I think that's sort of the
the litany of issues at the at the
cultural level that we run into when
talking about node with with people
inside the company so how do we get
across this chasm how do we actually get
people inside the company to embrace
this new technology that's got a lot of
sort of unknown performance
characteristics at Facebook scale so
what would I and the other folks are
within the company who are familiar with
node and enthusiastic about it are doing
is we started out with an internal
internal group which you know is
basically a mailing list there's nothing
to revolutionary about that and that
gives you some obvious benefits like it
allows you to coordinate the people who
are passionate about note all ready for
whatever reason we have about 60 people
in the group we share links to new
updates new modules various information
that that is pertinent to the sort of
things we're doing it also lets you
educate people who haven't heard about
note or just curious about it they have
a record of the discussion that's gone
on before they found out about it gives
them a way to discover events so we
actually bring
people to talk about it we've had Ryan
and Matt Raney talk and that's been
really well received and I think it's
done a lot to really raise the awareness
and then the really surprising benefit
for me came in to lunch conversation
that I was having with some folks that
were in the node group and we were
talking about node and sort of how we
could get things you know moving inside
Facebook and a guy named Ben Mauer who's
the one of the founders of recaptcha the
captcha technology that you see around
the web alot kept pushing back and in
ways that i found kind of negative and
it was very disconcerting and i
eventually called him out on it i was
like dude why you know if you're this
down on node like why are you down on it
in the first place and further why are
you even in this group and his response
was essentially well I want to make sure
you guys don't do anything stupid and I
really don't think it's a good idea for
facebook to embree be embracing more
technologies and fat as a matter of fact
we should be using less and so he came
from the camp of simplicity being a
really important priority and a really
good way of minimizing the the overhead
involved in running all the systems that
Facebook runs and it took me a while to
come around to this point of view I
actually agree with him you know in
general you do want to have as few
technologies as possible at a company I
just happen to think node should be one
of those so um after thinking about this
for a while I realized that he's
actually doing an incredibly valuable
service for us and that he is keeping an
eye on us and making sure we don't screw
up pretty much early and really alien
alienate ourselves by doing something
that's going to permanently get people
resistant to the idea of node so you
know embrace your critics they're your
best friends and then in actual
practical terms in terms of what we're
doing with node we're trying to use it
everywhere we can that doesn't doesn't
put us in critical spots right now so
and ideally we're doing that in places
that allow us to touch the critical
systems so let me talk a little bit
about what that means in practical terms
this is sort of the menu of what we're
doing right now
and one of the advantages of having that
that node group is it lets us get a
pretty good idea of who's doing a lot
with a note inside Facebook and and so
here's the menu to start off with I
don't know how many people have heard of
j s game bench actually if you could
raise your hands like it knows what Jays
game inches okay so James game bench is
a JavaScript benchmarking suite for
html5 technologies related to game
development it's put together by a guy
named cauri and rekha and Bruce Adam do
you remember Bruce's a Bruce Rogers and
it's actually pretty cool because what
they're doing is bringing in much the
way like son by sunspider tests of
brought attention to javascript
performance they're bringing attention
to WebGL performance CSS animations and
various other technologies that game
developers are likely to use that's open
source and it comes with a node server
that you can use to run the tests and
the benchmarks we have a mobile
JavaScript framework under development
that will be announcing I don't actually
know one will be announcing it but the
intent is to open source that that uses
node for both a test server and also as
a build tool so in those cases I would
say there there's nothing too
extraordinary about those they are
fairly small projects the bulk of our
node work is actually being done on the
chat team and I think that's something
that it was really and it's something
that we sort of brought to the table as
mostly just because it gave us an
opportunity to explore the performance
characteristics of node so what we're
using it for is doing traffic analysis
of our production chat system so we
actually set up port replication and
we'll pull TCP traffic pull out a TCP
dump that over the course of an hour or
so and run that data through through
node and use the node pcap library to
analyze and get a get a performance or
rather a traffic profile of the HTTP and
thrift traffic and then we actually use
that and feed that information into our
load testing system that we use to
to actually test these production
systems and the cool thing about this is
that because we're using node alongside
this production data it actually gives
us a pretty good data point for how the
how node will perform in production and
unfortunately I don't really have hard
numbers i can give you folks because
we've been pretty heads down i'm just
trying to get this stuff working and i
don't know that we have a good enough
feel for what these performance
characteristics really are yet to go
public with those but that certainly
would be would be our intent I can I can
hand wave around things like for example
that that hours worth of traffic data we
run that through note in about ten
minutes a single node process so for
example we do know that if we put note
in production as a monitoring and
analysis system it we shouldn't have any
problem there performance wise it should
be able to handle handle the traffic we
throw at it as far as bandwidth and cpu
required there and then the last thing
that we're doing on that chat team and
this is more just my own efforts is
we're using it for what I call
production hacking so I've actually
found it to be really useful to set up a
node proxy server that alters the
behavior of our production system in a
way that I can still use the test with
the front end client so for example I
wanted to I'm in the process of adding
support for xhr and cores which require
various origin related headers in the
HTT HTT P packet and rather than going
in and mucking around in the airline
system and setting up my own tier of
back-end chat servers and then figure
out figure out how to reconfigure
everything so that my account the points
to that I instead just set up a you know
tell Firefox that point in my little
node proxy which I which I've set up to
actually modify those headers on the fly
in both directions and I can actually
add xhr core support to our production
system on my local box it's pretty cool
trick I highly recommend it I've done it
I've done stuff like that in a couple
cases and then the last thing we've done
is just enhance our internal tool chain
for deploying systems to actually
support node and NPM so um that's pretty
much the presentation there's a saying
at face book that we're one percent done
and you see little stickers all over the
place you know this chair is one percent
done this food is one percent done this
toilets one perfect one percent flushed
it's very cheesy but I actually think
it's what it gets a ton yet what are you
with that underlying with what that gets
at in the underlying statement is really
that it's a journey and in this case
we're not doing as much with notice i
think we'd like to be doing you know
we're one percent of the way but I'm
hopeful that in a year's time when we
come back that I'll have I'll have hard
data on what our performance is that
I'll be able to tell you guys yet
Facebook is running a thousand node
servers in production and it's saved us
this much CPU and you know and our
bandwidth our costs are down by X number
of dollars but I'll also still finish
with this slide that says we're one
percent done because I'm sure at that
time look the capabilities of node and
the landscape of the node community will
be that much larger so that's it if you
have any questions the question is what
are the airline guys think of node I
actually love it that's actually good
question because the short answer is
they actually like the airline system
they think it's it's perfectly capable
of handling the traffic of what we have
today and I'm inclined you know and it
seems to be working the flip side of
that is the airline guys that originally
wrote note I wrote the chat system are
pretty burned down on it and have gone
on to other projects and have left us in
some way you know I won't say this to
you know with too much resentment but
we've been kind of left holding the bag
and trying to find good airline
developers is a real challenge and I
think it gets back to it that point I
made about having us having a single
technology throughout your up and up and
down your staff actually gives you a lot
more options so um but yeah I mean
there's it's really interesting
conversation to get into the details of
how airline and no to compare anything
else all right thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>