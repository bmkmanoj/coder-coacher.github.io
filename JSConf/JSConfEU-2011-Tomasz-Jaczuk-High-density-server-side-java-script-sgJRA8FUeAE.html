<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[JSConfEU 2011] Tomasz Jańczuk: High density server side java script | Coder Coacher - Coaching Coders</title><meta content="[JSConfEU 2011] Tomasz Jańczuk: High density server side java script - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>[JSConfEU 2011] Tomasz Jańczuk: High density server side java script</b></h2><h5 class="post__date">2013-06-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/sgJRA8FUeAE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right my name is thomas yang shook
i'm working for microsoft i'm currently
focusing on making sure that windows is
a great hosting platform for know Jas so
I'm working on a couple of projects
related to know Jas and windows if you
are interested about that topic i will
be available after this talk to to talk
about it so feel free to get me and we
can go there please talk about is about
something entirely different this is
about high density several side
JavaScript which is pretty much about
how to do more with less so let's get
started so let's say you have just
developed a web application something
that most likely has happened to most of
us oh and let's have a look at that
application actually
so this is a application written in
server side JavaScript and it's a simple
web chat up
so nothing unusual basically you can hit
an HTTP endpoint that endpoint will
serve you an HTML page with a bunch of
client-side JavaScript the does HTTP
long polling against rest endpoints
exposed by the same backend posted in
that server side JavaScript application
the one interesting thing about that app
is that it falls into a category of what
I call a lightweight web application and
what I mean by that there is a class of
applications that are using very few
resources both in terms of CPU memory
networking and possibly disk usage so
the next question you are facing after
we have developed such an application is
what I hosted and there is a number of
choices today on the marketplace varying
in the level of functionality and price
but bottom line what what it boils down
to and don't hold me to that number but
you know 5 euro will probably buy you a
reasonably decent shirt hosting plan
today my claim is that five euro is way
too much to ask in terms of hosting a
lightweight web application hosting such
apps such should be much less expensive
so the question is is there anything we
can do about it to make them less
expensive to run and I during this talk
I'd like to have a look at ways we can
help hosting companies lower their costs
of running such apps and therefore
potentially provide them with an
incentive to reduce the pricing of the
shirt hosting plans
so after you deploy your application to
the any of the onion of the shirt
hosting providers will probably end up
running a place like this so there is a
data center with a large number of
machines your app is running on one of
them probably alongside a number of
other applications possibly applications
written by our competitors and this is
pretty much what you are paying the five
euro for the breakdown of the cost of
operating a data center it falls into
three categories there is this cost of
buying the hardware there is a cost of
electricity and maintenance and there is
the cost of electricity is most actually
cooling the data center and there is a
cost of maintenance and these categories
are roughly thirty three percent each so
the key takeaway from this is if we can
reduce the number of machines that are
necessary to run a certain number of web
applications we can pretty much
proportionally reduce the overall cost
of running a datacenter and therefore
provide an incentive to hosting
companies to reduce the pricing of the
short hosting plan so the typical
breakdown of the plans that the short
hosting companies offer falls into three
categories you can go and get yourself a
dedicated piece of hardware that will
cost you most let's say 200 your mouth
then you can go and get a virtual
machine running on a piece of hardware
that virtual machine running alongside
virtual machines owned by others who
purchased computing power from that
hosting company virtual machine provides
a good level of isolation between these
execution environments typically these
hosting plans are manifest themselves as
the so-called root access to the system
because effectively you're an
administrator of the virtual machine but
it is still not a physical box is just a
slice of the physical box in the last
class of
short hosting plans offer today revolves
around process level isolation so
typically you'll basically have a
username created on a system and you'll
be able to host your application as part
of that username so operate most
operating system modern operating system
offer a kind of user level isolation
within the operating system where you
can control access to resources meter
access to resources at the level of
process that there is running within the
credentials of a particular user
registered with that system and this is
perhaps the densest you can get in terms
of application density in case of the
most moisture hosting plans today so
this is what you're paying the five euro
for a monthly basis there are two things
you really care about when you choose
your show hosting provider one is
isolation of your application you really
want to make sure that your app when it
is deployed to the data center is not
affected by what other applications are
doing you don't want other applications
running on the same physical machine as
yours for example take away all cpu
capacity from your application or affect
how much networking you can do the
second aspect also isolation is one the
second aspect is resource consumption
you really want to make sure that what
you're paying for really guarantee see a
certain level of access to memory CPU
networking and days can you really want
to make sure that you're paying your
fair share of the resources it kind of
in proportion to what the applications
from all the applications are consuming
on that box so in case of the class of
applications i'm talking about here the
lightweight web applications as i said
before cpu usage networking and disk is
probably not the
factor that bounds the number of
applications that can be running in one
box I think in this in case of these
apps today it will be the memory simply
because of the process level isolation a
single process has a certain weight
behind it and you can only run a certain
number of processes on a single physical
machine and regardless of the operating
system you are using so let's have a
look at what exactly does it mean to run
I the process scope let's come back to
our shut up I'll just stop an instance
again let's just make sure it is running
yep so now as you let's have a look at
the resource consumption of the process
so first of all you're not is that cpu
usage is pretty much negligible all cpu
usage is actually coming from other
processes running on the machine the my
light weight of obligations are sitting
there no doing nothing waiting for a
message from the client so this is to be
expected let's have a look at the memory
consumption so this is my process there
are many ways you can measure memory
consumption of a process there are many
different metrics that the one that is
most relevant in the context of this
discussion I think is what on Windows is
called private working set so this is
the number of bytes that that is
dedicated to the exclusive use of that
process so it is not shirt between
processes that for example doesn't
belong to any shirt library that is
ridiculous processes and a subset of
those buys that actually resides in
physical memory at the time so this is
not something that is paged out to or
swapped out today's it is something that
has to reside in physical memory for in
order for that application to function
correctly so that number would represent
what chunk of the physical memory
resource is that particular process
using and therefore how many of these
processes could you run at maximum on
the honor system with a given amount of
physical memory so in case of the
process we are running here this is 2.6
megabytes right now so i'll just take
note of that number and you'll use it in
a moment so process level isolation
memory
and what you're paying for that level of
isolation is 5 euro so naturally the
question is can we do better and given
that I'm only ten minutes into this
presentation you can expect that the
answer is I hope so so how about trying
to use threads in order to isolate
applications most modern operating
system provides primitives that helped
write applications that are isolated at
the process scope you can for example
put limits on the number of handles the
process can create you can put limits on
the amount of memory process can consume
at the thread level the number of
resources you can constrain or control
at the level of the operating system
from the outside of the process is very
limited for example threads are free to
access memory within that process there
is no makin no native mechanism within
any of the operating system that would
prevent one thread from accessing memory
that another thread has allocated within
the same process and this is what the
difference between native applications
and managed applications becomes
important so whenever you are writing an
application that you really don't know
anything about it could be written in C
C++ and use the full functionality
offered by an operating system there is
really no way to reason about resource
consumption at the SAP process level
there is no way to constrain resources
on a per thread level when the threads
running within that app well managed
execution environments like server-side
JavaScript provide us is a layer that
separates the operating system from the
application called a hosting layer in
case of nodejs it is actually the node
code which consists of the v8 JavaScript
engine plus the node specific
functionality the event loop and all the
native modules so it is up to that layer
to expose certain primitives to the
application to use if the layer chooses
to allow the application to spawn new
processes it's a certain decision that
is made at the hosting layer know the
operating system layer so that layer
could effectively provide a constraint
set of primitives to the application
such that it is easy and actually
possible to control resource consumption
and limit resource consumption a
finer-grained in the process so in
theory you could run multiple
applications within a single process and
use the hosting layer to provide both
isolation and resource metering between
these applications so a solution that
uses hosting layer around a javascript
v8 engine could look like like this we
will have one process there is running
multiple threads each thread will be
running a different application a
JavaScript application these
applications theoretically can compete
for access to operating system resources
and it is up to the hosting layer to
ensure fair access to resources as well
as isolation between these context so
JavaScript the v8 engine provides a few
key concepts that help realize that
possibility so first of all there is a
concept of a v8 isolate an isolette
allows you to create a standalone
instance of a JavaScript engine within a
process and you can have multiple of
those what standalone means in this case
is that each instance is completely
isolated from each other in terms of the
resources then the memory resources it
uses because its own he passes on
garbage collector if you dispose of a
sea of one v8 isolate within the process
it doesn't affect the other isolates so
as far as I understand v8 isolates have
been meant to support concurrent
execution of multiple JavaScript
programs within a single process and
different threads a second concert that
is not shown here and I'll go into that
later is a Viet context VidCon text
provides the in that kind of data
environment within which JavaScript
application execute specifically in case
of JavaScript it controls the global
object that is available to the
application code when it runs so you can
have multiple
v8 context and multiple isolates when
you run JavaScript code you have to
choose one isolate and one v8 context
the data application will be running in
in this case the reason I didn't show a
context is because there is kind of one
to one relationship between isolate any
context so for each isolate I create I
get only one context and execute the the
JavaScript application within that
context so let's have a look at how that
looks like
so the tensile prototype which is that
little hosting lane that I've created
for the purpose of this demo allows you
to actually start multiple apps inside
of a single process so i can three start
three web chat applications in this case
and each of these apps is again running
on its own thread and using its own v8
isolate so the data of these apps is
completely isolated in key in terms of
access to the cpu it is actually the
operating system that ensures fair
access to the severe because thread
scheduling happens in the operating
system level so let's not just test the
hypothesis that these apps are actually
isolated I'll pick the first one
so this is strut one and I'll take the
second one
and this is the chapter so you can you
can do chatting in this window it
doesn't affect the chat in the other
window so the level of the day doubt
that these chat rooms exchange they are
isolated now in terms of resource
consumption one thing that the hosting
layer that I've implemented here does is
also provide metering of resource
consumption on a per program basis so
what it does it basically shows you cpu
usage network usage and memory usage on
a per program basis so you notice that
you know this particular web chat
instance has used that many cpu cycles
so far the exchange a certain number of
bytes and that number will increase as
you type something number of HTTP
requests and also memory usage so memory
usage refers to the name of our
locations within the heap maintained by
the v8 isolated applications running in
one thing to notice is that these
numbers and are different from the
second web shot that I have running here
so this is let's say thirty four
kilobytes exchange this is 3 80
kilobytes exchange so you've got
metering and resource control the
program level and these programs are
running within the same process on
different threats so this is greatest
demonstrates that at that level we can
actually measure resources and isolate
applications of the subprocess level now
let's see how heavy weight it is to run
many of those applications
so right 50 of them in a single process
now let's have a look at the memory
footprint of this 70 megabytes so go
back to excel thread 70 megabytes by 50
in programs so it is 1.4 megabyte per
program now if you if you assume that
the short hosting plan will will be
proportional to the memory consumption
of that application that shirt hosting
plan would cost less than 3 Europe
so basically what i have shown right now
is that from the perspective of the data
center the the hosting provider can now
run the same number of applications on
less hardware so this is a great out
section of the hardware at the end of
the rackspace they're giving there are
fewer machines used to run the same
number of apps theoretically the cost of
the shell toasting goes down and it can
be reflected in the price of the
hosting plan which is now around 3 euro
can you do better than that is there any
way we can reduce the price even further
so let's see there is a way we can
actually share a single thread among
several applications running on the
system in a way that still provides the
guarantees that we can isolate data
between the applications and control
resource consumption for each
application and this is what the v8
context comes in in this solution I'm
going to use a single thread in the
process a single d8 isolate which means
that all the applications running within
that process will use the same keep the
same gap in the same garbage collector
however I will use a different v8
context for each of these apps this is
actually the model that no Jas is using
today however to my knowledge node has
not been started off with intent to
actually provide the level of isolation
that allows you to run competing
applications within the same process you
can spawn multiple contexts inside of
node using the vm module but
the code executing in this context is
kind of by default as soon to execute
within the same kind of trust boundary
you can belong to the same tenant of in
the in the context of short hosting so
why is that there are actually two
challenges with this model one is the
the most evil program you can write as
this basically while true this this
program will take the CPU and prevent
other programs that attempts to run on
the same thread from executing at the
operating system level that the
operating system will when at season
infinite loop like that it'll actually
at some point preempted up thread and
give the cpu to another thread that is
open on that system but remember that in
this particular case we are running
multiple JavaScript applications that
potentially compete with each other on a
single thread so if one of those
applications has called like that it
will basically hold up to the CPU
infinitely from the perspective of
sharing it with other JavaScript
applications so this is not to say it is
not impossible to prevent this from
happening remember the name on your arm
code like this in JavaScript what
happens at the JavaScript engine layer
that code gets compile into some form of
assembly code and it is not
theoretically not impossible to inject
checks into the generated code that will
prevent runaway programs from executing
however such mechanism that does not
exist today in any of the JavaScript
engines that I know of another problem
with the context based approach is
limiting memory consumption so running
several applications using different
contexts on the same v8 as I slit
implies that all these apps are
allocating memory from the same heap
managed by a single instance of the
JavaScript engine so a program like that
will effectively result in every
increasing memory allocation and there
is no mechanism in the VA JavaScript
engine today that kind of native
mechanism that allows you to control
memory consumption repair context level
such functionally can be built in on top
of the primitives provided by the v8 but
this is not something that my hosting
layer currently has so again these are
two challenges with this approach none
of which is kind of a smoking gun reason
not to do it I think there are ways to
to address that problem however it is
not immediately available in either the
hosting layer that I've done all the v8
engine so nevertheless let's have a look
at what's the density that running
JavaScript applications or the sub
thread level using v8 context gives us
so I'm now going to run dancer using
context as the isolation boundary
between applications and this time I'm
going to rise the ball and around 1,000
of them
you
here
alright so you have 1000 web chat
applications running within a single OS
process using a single thread and
different v8 context for that provide
isolation of data between these
applications so there's a large number
so let's just make sure that it is still
running indeed
you go um so let's have a look at the
resource consumption again cpu is pretty
much still dormant remember these are
lightweight with obligations that are
not using cpu they're just sitting there
and maintaining a state of readiness to
accept user messages so from that
perspective you are fine if you look at
the process memory consumption 150
megabytes
one thousand roses no thousand
applications oops so that's 150
kilobytes per application so this is
actually pretty good let's see how a
short hosting plan like that would cost
if it was to be priced and in proportion
to memory consumption 30 cents so that's
better than five Bureau so with that I'm
actually going to start a little social
experiment
so if you have any questions about
fighting city server-side JavaScript why
don't you look up Twitter go to this URL
and ask it and let's see what
unmonitored web chat results with
so again if you look at the data center
we started off with we allow the hosting
company to share a bunch of extra
machines by going subprocess level the
end result is if you turn these cost
savings into the reduction of the shot
hosting plan price with around 3 euro
cents which is a reasonable price to pay
anything for my little web chat
application so basically we started off
with the notion that five euros too much
to pay for for hosting very simple web
applications like that we have shown and
demonstrate mechanisms that can be used
to lower the price quite dramatically
over 10 x and if you are interested in
looking at the source code of the denser
cost which is really a very thin wrapper
around the javascript v8 engine it is
available on github on the same account
there is also a project called is know
that i'm working on kind of during the
day at microsoft that that is used to
help hosting no J's applications in IAS
if you have any questions there is most
little pieces my contact and with that
let's go back to the questions
hi great presentation so I have a
question about the overhead so how does
the the overhead plays into to this how
much does the context switching of v8
coast in terms of CPU and memory usage
in this because we saw all dormant
processes and DD applications were
enthused intensively so did you just put
this into under stress into to verify
how it relate how it compares with a
traditional approach with process
isolation yeah so effectively what this
approach is showing that there are
certain constant cost of creating a
process on an operating system as well
as certain constant cost of creating a
thread in an operating system that if
you take that cost and you actually
average it out across a large number of
applications that becomes manageable
small so in case of of a process it is
basically all the static like libraries
that you have to load up in order for a
process to function once you spin
multiple threads within the process that
actually show the static libraries not
cost averages out nicely at a threat
level once you create an additional
thread you have to allocate a stack size
for each thread which again you can
average out the cost of that memory
allocation when when you're running
multiple apps on a single thread on top
of that there is the cost of running a
single JavaScript engine which basically
allocates its own heap memory to manage
memory locations of the JavaScript
program so whenever you can show the key
across many apps you can also reduce the
average
memory consumption will be dubs
by the way is Andrea here
get yourself a mic up there hi em
question how is Mary using your online
news is the same like we saw on your
winners or because I would imagine a lot
of hosting platforms would use lonex I'm
sorry can you repeat I yo this is tested
on Windows I guess have you measured how
many usages and liners is the same I've
done similar experiments on Linux using
node with a second approach the the one
in which you run multiple JavaScript
applications using context level
isolation and there is also very very
comparable you know the difference is
you could point out between Windows and
Linux in this case would really probably
revolve around possibly around memory
allocations of the process and Fred
scope whenever you are running
applications in that quantity and you
average out the memory allocations they
really become irrelevant these
differences become really leery minor so
there is also a third model in which you
will have a application well thread per
application but to make the threads
share the same v8 instance so it has
something called the preemption which
allows you to basically say 28 please
switch between these threats every two
milliseconds or something and this will
first give you a lower memory usage like
in your second model and
in the same time you will be protected
from the wild true loops because we it
will just trimmed between the thread
skewing each thread a fair amount of via
rock yes I agree there are many many
models I haven't experimented with that
are perfectly legitimate these are just
to kind of reference points in the
entire space of possible solutions so
definitely as you're right
no more questions thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>