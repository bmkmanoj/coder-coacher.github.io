<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Neil Green: Writing Custom DSLs [JSConf2014 ] | Coder Coacher - Coaching Coders</title><meta content="Neil Green: Writing Custom DSLs [JSConf2014 ] - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Neil Green: Writing Custom DSLs [JSConf2014 ]</b></h2><h5 class="post__date">2014-06-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/lm4jEcnWeKI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right I'd like to say that kudos to
the Microsoft guys because if I was at a
Jay s comp I would never want to open
with where the guys who made a E but the
I'm sure the latest ID is awesome though
how many people here ever develop for
ie6 ends up
I wasn't those guys all right so I
worked for ice we end up I'm a technical
lead there I end up working on a lot of
very complex business problems and at
work I wrote a couple of dsls part of my
job is to coach other engineers on how
to do their job and one of the things
that I've wanted to speak on but I just
hadn't had the time to pull the talk
together I was writing custom dsls
so when there was a call for speakers of
jazz calm face admitted it got accepted
and somehow it got to be the first for
this track thank you very much Jay Escom
for accepting me and I'm honored to be
to kick off this conference all right so
we're gonna break up the talked into
four sections the evolutionary history
of dsls to give us all some context to
how we got there what a do cell is
defining your DSL is grammar and
implementing your DSL all right
evolutionary history of DSL so for the
history of programming we've always been
trying to create a machine language that
reads like a human language when we
first started out we said let's use
punch cards fun fact
turns out punch cards have been used
since the 17th century
for programming moons I didn't know that
and they were used all the way up until
the 80s until they invented monitors and
keyboards low level languages like
assembly that basically read like gibble
D Guk higher level languages where we
started to see human words like if and
else and end and do then we got even
higher level languages that allowed you
to express things that were again more
human and more natural and that led us
up to object-oriented languages now
object-oriented languages or the purpose
of them is that you can use them to
represent you know real world stuff but
encode by creating computer models and
domain modeling is the you know the the
methodology if you will of taking
something that you see in the real world
and making a computer model of it now
the fact is that doesn't happen well my
opinion nearly often enough but
generally speaking we tend to just use
you know models when it comes to models
we think of them as just data transfer
objects if you look at just about any
framework out there they're all saying
you know here's how you use our models
and this is our models and models and
models and all there most times all
they're really saying is this is how you
trance data back back and forth but when
you actually do a domain model when you
actually model your domain you end up
with something that is much you know
conceptually bigger and more important
and the persistence layer the database
the presentation layer the user
interface tend to be much simpler in
comparison if you think of something
like Bank of America and you you know or
sorry any that's my bank if you look at
any banking interface you know the the
stuff you see on the screen and the
stuff that's going Oracle or whatnot
pales in comparison to all of the
business logic that's responsible for
transfers and international monies and
all the rest of that the clearing goes
with it when we talk about the MVC
pattern the M in MVC is you know they
use the word model for a reason they
sort of want your m2
be your domain model so that it you know
you that is where all of your business
logic lives and then you've got these
other ancillary things to make a domain
model and by the way that's that's one
of the many things like cochon is just
how to get an engineer to start thinking
about how to make your own domain model
I think it's relatively straightforward
and simple but it's it's something that
requires a lot of practice until it
becomes second nature understand your
domain model your domain implement your
domain understanding your domain is this
process it starts off with speaking with
your customer and developing a mutual
language that is crazy important and
will be a theme for the rest of this
talk the model begins with this idea of
what is your domain so that I can
understand it so that I can build it
good model your domain in UML just need
a UML sketch you don't need anything
very complicated when you come to
implementing your domain you got a
series of choices and I'm going to take
you through one is you can sort of
listen remember what you say go back to
your desk and just start typing and hope
to god that you remembered everything
properly a better way to do it is to
write your test first then write your
code to pass your test but when you do
that when you invert the order with
which you you code meaning testing
testing first you've got two choices
that you can make there for I just got
freaked out because there's a little
green bar in my screen and then there's
a little counter thing and they don't
line up and I want them to so I'm gonna
hold on all right I'm gonna keep going
there we go
so you have a choice of writing tests by
yourself or you have a choice of writing
tests with the customer when you write
your tests by yourself
it's called test-driven development when
you write them with the customer
it's called behavior driven development
there's an example of what a behavior
driven development set of spec tests
look like if you're working with your
customer to develop these tests as you
should if you're modeling their domain
you're going to end up with a synergy
between what they how they're describing
their expectations Oh
the domain is and the mutual language
you two came up with and when you do
this enough it's it begins to occur to
you that why are you the program are
even involved because they're nirvana
would be just let the customer in
express their expectations directly in
the code and that's what DSR holes are
for now here's what a DSL is there's
three aspects of a DSL the grammar those
are the syntax and the words that make
it up the implementation which is the
code that obviously implements it and
then the rules that are that use the
grammar to express something useful
we're very used to DSL zwy sequel
regular expressions in UNIX shell
scripts they're all dsls and the
JavaScript community we've got a really
good culture of wrapping complex
technical domains and dsls jQuery
obviously in some of my favorites I love
d3.js and I use mocha chai a lot and
gulp is something that will go up is
something that we're probably going to
switch to before too long at work so DSL
generally old ESL's they make complex
problems simple that's their goal sequel
for example makes dealing with
relational data very simple in the
business world there are lots of
incredibly complex domains that come
from multiple industries and when you
think about the domain problems in the
business world
they're not just domain problems their
domain problems within domain problems
within domain problems if you stop for a
second and think about well what how
would I model health insurance you know
you can go as high up to you know the
definition of a policy and as low down
to you know where what is the inventory
of this pill versus the generic pill and
when should I use the generic pill when
it's not in inventory and things like
that the key difference between business
DSL and and technical dsls is that the
business dsls come from the customer
meaning the grammar of the DSL it comes
from the customer when you're developing
technical DSL you as the programmer
pretty much know everything you need to
know but for a business DSL you need to
get it from hopefully the subject matter
expert so to illustrate that I'm going
to take you through defining a DSL
grammar so the easiest way I thought to
explain this is with a semi real-world
example where we're going to take our
lovable security guard Paul with our
customer Chuck and we're going to use an
alarm system as the domain model so the
idea for this exercise is to say that
Chuck is going to work with Paul to
configure the alarm system so in this
way this is what these business DSL czar
trying to do think of an alarm system
like the domain model or the state
machine where it's behavior changes
based upon how you configure it so the
idea is that Chuck is going to tell Bob
to configure a alarm domain model now
I'm saying the same thing repeatedly
because I want to drive this point home
the alarm has lots of different
intricate pieces that are within it and
everything from smoke alarms to motion
detectors and things like that the key
there is Chuck really doesn't care about
any of that and the way in which he asks
for the alarm to be configured is as
follows having a conversation with Paul
hey Paul how's it going
yesterday our office admin came in early
to set up for the company's weekly
status meeting but he couldn't remember
the codes turn off the alarm the cops
had to come out and he tried to explain
that he was an employee because he had a
key but then believed him and ended up
calling me we have the same meeting
every Monday morning so can we just not
have the alarm set so he doesn't need
doesn't need the alarm code to get in so
Paul goes ahead and let's try to
remember that long conversation goes
back to his you know a little management
console and and does his best to
configure the alarm system as he
remembered Paul saying it sorry as you
remember Chuck saying it and of course
Chuck comes back and says hey Bal what's
up I know I asked you not to have the
alarm set for our weekly status meetings
but during Memorial Day
I was worried that we had the alarm off
when we should have had it on and a
friend of mine whose business got robbed
in July force because I I guess they
figured no one would be there so this
back and forth is pretty much what it
means to be a programmer unfortunately
and I I would say it's probably my least
favorite part of writing software is
this is this this back and forth that
happens maybe some people like it I
personally don't like it and that's why
I got good at writing TS else is I
wanted to not do this anymore
and Paul reaches the same conclusion he
says you know what if I could just let
chuck configure his own alarm system
then I'd be I'd be out of this game and
much happier so the way we do this is to
build a grammar based upon what Chuck
has said is we'll just review the
conversation that we had with them and
we'll drop out all the words that really
don't mean anything they're just you
know they're just transitionary words
they don't carry useful information and
then we'll split up the nouns and the
verbs now I'm using verb and now a
little bit loosely here I'm not I was
never an English major run with it I
think you guys know what I'm trying to
say there so we what nouns you know
physical things verbs stuff you do to
stuff we're gonna go ahead and clean up
that grammar we'll just flip back to
that for a second so we have nouns like
our office admin code alarm yesterday
early weekly yeah this is this is the
raw material from which you're going to
pull your grammar out of so now that we
have this we're going to start to dig in
and apply some common sense to it right
so it seems that we have things and then
we have time so I'm gonna you know make
some edits here and say rather Paul
who's going to make some edits here our
really means company you know office
admin really means employee and role etc
etc set is really when he said set the
alarm it's a synonym for you know on and
then we have early I'd make some
assumptions about what early is weekly
means every and week every Monday
morning actually you can combine
different things we already have like
every a day and and a time range from
Memorial Day in July fourth we have an
opportunity to use an idiom idioms are
the most powerful technique you have
when writing a DSL for simplification an
idiom is a word or a phrase with some
implied useful meaning for for us when
he sent Memorial Day when he said
Independence Day
he probably just meant federal holiday
it was just being too specific so I'm
gonna make the decision Paul's gonna
make the decision to replace the
specifics of Memorial Day and
Independence Day well with just federal
holiday so I go back update the grammar
sheet again it's looking pretty clean
looking you know pretty obvious now what
I have to do is go back Paul I'm sorry
I believe it or not there is no Paul
actually I made this presentation the
we're gonna reconstruct the no one
laughed at that and that's okay that's
one everybody know that that's cool
the I'm gonna reconstruct what Chuck
wanted with my new grammar and it turns
out that it's just alarm on weekdays at
8 a.m. to 6 p.m.
alarm off Mondays etc alarm on federal
holidays and actually introduced another
idiom of weekdays which I take to mean
every Monday or Friday that's probably
what Chuck means so now I put back in
some transitionary human words and we
get the alarm system should be on every
weekday between 8 a.m. and 6 p.m. but
the alarm should be off Mondays from 6
a.m. to 8 a.m.
also the alarm should be on for federal
holidays wonderful this seems good now
all we gotta do is go back to Chuck and
your review it with him and Chuck says
yeah that's pretty good
only thing is we don't close for a
Columbus Day because Columbus was a bit
of a tool and i'm from bahamas by the
way so that's where Columbus actually
landed yes born and bred till I went to
college and we celebrated Columbus Day
all the time and he wasn't that cool a
person so I add into the the grammar but
not for Columbus Day then I go back to
the grammar sheet again and I get rid of
stuff that I just didn't need to express
what Chuck wanted
for example no need for company employee
role all I need is the only thing that
matters is the alarm
I don't need should I need not on and
off
I don't need day every and week because
the the idiom of weekdays covers
everything with a specific parameter of
Monday's federal holiday specific
parameter of Columbus Day and there's
some time ranges so now we have our
tightened up grammar sheet and we're
sort of ready to go right we have
everything we need ray start
implementing and it turns out that Paul
is taking night courses in programming
and he just so happens to be learning
JavaScript so Paul's decided that he's
gonna take it on he's gonna implement
his own DSL so he gets on Google and
gets immediately freaked out because
what you know compilers lectures you
know parsers what does this all mean
doesn't make much sense to him and this
is actually one of the hurdles that I
tend to help engineers get over as much
as I can which is just relax you know
over time you're gonna want to use more
advanced techniques to implement dsls
but Paul's gonna make the decision that
I encourage all of you who've never done
this before to make which is I'm going
to choose method chaining the method
chaining when it's used to implement DSL
like jQuery for example most JavaScript
DSL is pen to use method chaining it's
called a fluent interface that's its
proper the proper name for it so we'll
start off with the simplified you know
Paul doesn't want to go after the you
know the full human readable text I'll
make another and the later slide I'll
show you how to deal with that but he
starts off with this basic DSL sheet and
then he adds in oh sorry basic grammar
sheet and then he adds in the the syntax
he needs to make it into executable code
then he kicks it off with a builder
object now if you guys are familiar with
the Builder pattern
it's basically an object that you
configure them and produces an object
which is great because that's actually
what we want we want to get a configured
domain model based upon that chuck's
configurations effectively and that's at
the very end we're going
say you know call the build method in
this case build a configure domain model
for JavaScript in particular you've got
and I you know any multi-paradigm
language like JavaScript is going to
give you this ability you've got two
different ways that are very
complimentary that you can use to
capture state you know what that clock
is counting down it's not clowning up
I've got a lot more time oh wait I don't
have as much time I don't know but it's
okay we're doing well either way I got
the green bar I got the clock freaking
me out all right well thank you all and
all right so you can inject data into
object construction just like you would
and you know this is a fairly typical
way to do it but you can also use
function composition as methods and this
is something I have use a lot especially
for performance tuning oftentimes if you
just use state you'll end up having to
go through this very complex
you know if Elstree to get to what you
really need you know once you understand
what you need just take whatever method
you were going to result with and just
pin it on to the front of of the call
chain and that's you know that's my
primary way of performance tuning DSL is
that run all the time all right
and with that pulse written a custom DSL
and that's uh that's that's terrific and
we're all very proud of Paul now quick
review of the steps he followed he
reviewed meaning that you know in our
particular case he must have recorded
Chuck and then got it transcribed for 80
bucks online but you reviewed the
conversation with the customer
he removed meaningless words he
separated the nouns and verbs he
identified idioms he reviewed the
grammar with the customer and then he
implemented the grammar now to make sure
that every every one of you can leave
and begin writing your own DSL x' we're
gonna start fresh and this is sort of
your final exam we're gonna implement
your DSL and we're gonna choose shipping
now shipping is one of these domains
that seem simple if there's one package
that's going to you but shipping is
fairly complex and complicated domain
especially when you get into things like
domestic shipping international shipping
you your order has to be shipped from
multiple warehouses to get for you get
to you it might go from carrier to
carrier there's there's a ton of little
subtleties that go into thinking about
the domain of what goes into what goes
into shipping now for this talk I dug
this domain model and this is and this
is something else I wanna mention I did
this with visual paradigm it doesn't
matter just use any modeling tool but
this whole thing took me maybe about ten
minutes to put together so over time the
more models you make the faster you're
going to get at it I you know you can do
this on a white board it really doesn't
matter but the bottom line here is that
I've got relationships that that mirror
the yeah cuz I'm looking at this clock
this clock is a terrible idea for
anybody who's speaking you've just got
this red thing that's blinking at you
the whole time but I'll do mine but
maybe if I sketch down and I can't see
it no all right so it's got interesting
relationships like they're like a I'm
sure it's impossible to read but either
way take my word for it extinct
relationships so this is the actual
shipping DSL grammar right this is the
grammar that you know someone went
through that hard process of pulling the
grammar out of some business owner who's
in charge of it and it turns out for all
the complexities of that domain model it
just don't care about it the bottom line
of calculating shipping cost which is
which is what this business owners asked
us to do comes down to these pretty
simple rules
let's jumping domestically if the
delivery date is flexible ship is
cheaply as possible if delivery date is
specified just past the shipping cost on
the customer when shipping
internationally then ship as cheaply as
possible fairly simple so the steps
we're going to go through to actually
implement this are we're gonna dump the
junk words we're gonna throw in the
syntactical constructs we need to do
method chaining and then we're gonna
preface it with a builder and end it
with a build function
so here's it here we go so I'm going to
start out with just a text area just you
know something that lets say that our
owner would actually be inputting it
themselves whatever it doesn't matter
just you need hold grab hold of that
text here I'm just grabbing it and then
trimming it here I'm grabbing it and
trimming it then we're just used regular
expressions to rip out all the words
that we just don't care about and when I
say don't care about it's that they
don't matter for the for the
configuration of the domain they matter
to the human being but they just don't
matter for the configuration of the
domain then we replace the white space
with our parens dot and what we're gonna
do is because to construct the final
executable string I need an API for the
Builder so I'm just gonna use a stub
builder here and you'll notice that even
though it's a stub and stuff meaning it
doesn't do anything it just conforms to
that API that this is an important point
all it's doing is just returning this
every time right that's how method
chaining works so now what I do is to
create the DSL code that's going to get
executed and going to configure our
domain model I'm going to preface it
with a or rather and with and
concatenate DSL builder dot with the
parens in the middle with the parens on
the end and then I'm just going to eval
it and when of course I have valid I end
up with my builder object so now let's
look at the builder object now my my
wife my beautiful wife was my main
reviewer for this and she learned last
idea cells in this talk she's got a PhD
so she's smarter than me but after she
got to this point into talk she said you
need to show an implementation and I
said how do you even know what an
implementation is but nonetheless this
is brought to you by my wife who said
you need to actually code something so
people can can see it I said all right
so let's see how clear that is can
anyone make out that text at all I bet
you can't in the back but I'll skim
through it really quick I'm not going to
dwell on this for too long
interestingly on the screen it's
down so I can barely read it so let me
lean in all right it's cool so we've got
rules which is an internal array a
convenience method of get current rule
which just says what M the current what
rule am I currently working on I have a
whene method there that that kicks off
the rules who remember it says when
internationally when domestically that
starts off the rule so all I do is I
just add an empty object there for
domestically and for internationally I
grab the current rule and I just tack on
a property that's a boolean flag of is
domestic and toggle it appropriately
true or false and this kicks off any
rule so you can add as many rules as you
want then I get into the if you know I
promised myself in this talk I wouldn't
use then and then if because it'd be
confusing but I just did I'm apologized
so then doing it again you can't use if
because it's a it's a reserved word so
you just use square brackets to use it
you grab the current rule if the
conditions are already there then then
you use them otherwise you assign them
to empty array you push that on to the
conditions etc etc I'm sorry I'm reading
code but it's very fascinating to me I
suppose then is just synonym for if so I
just assign it back to each other
and then with get current condition
another convenience method that just
grabs the nth condition just like we
grab the nth rule and then for the rest
of the DSL it's just a simple matter of
grabbing the current condition adding
the appropriate properties and then
returning this as I as we were before so
we can keep the method chain going and
then finally we just call build and in
this particular case our shipping cost
calculator constructs its own domain and
all we have to do is just give it the
the rules array that looks like this
when you see realize it so it's a very
consumable thing by something that's
configuring and constructing a domain
now one of the the most important thing
in my opinion the most useful and
important aspect of all dsls is that as
time goes on your your actual domain the
domain model behind the scenes will get
more
and more and more complex just happens
over time but the DSL because it came
from you know human thinking about the
problem tends to remain more or less
consistent if you will because there's a
limit to how complex humans can think of
things but there's no limit to how
complex things can actually be for
example one day hopefully we're gonna
have packages that can be delivered with
drones so when that day comes we will
have a rich very complicated domain
model behind the scenes that deal with
all types of things like weather and
battery charge and route and you know
was it FAA
you know regulations and stuff like that
but the bottom line is this when you're
shipping with drones that the weather is
favorable and as cheaply as possible
otherwise just ship it domestically all
right that is the main part of my talk
if you'd like to learn more these are
the books I recommend to the engineers
that I work with design patterns so you
can get your object-oriented concepts
grounded test-driven development so that
you actually know properly how to do it
Kent Beck's first half is every every
time I hear stuff what success
development sucks ago have you read a
book on the material and have you
actually read the book on the material
any answers no and universally when they
come back and they say oh I get it I
didn't get it until I actually saw
someone step me through it
domain-driven design it's a huge very
important book probably if you only read
one book I'd read that one patterns of
enterprise architecture speaks about
model-view-controller and then get keeps
going on and on and on and on about
different ways to structure application
and then of course domain-specific
languages which came out relatively
recently which gives you patterns for
talking about dsl and that is it thank
you so much for your time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>