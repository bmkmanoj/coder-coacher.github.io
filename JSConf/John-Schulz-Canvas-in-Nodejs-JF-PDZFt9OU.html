<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>John Schulz: Canvas in Node.js | Coder Coacher - Coaching Coders</title><meta content="John Schulz: Canvas in Node.js - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>John Schulz: Canvas in Node.js</b></h2><h5 class="post__date">2013-01-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/JF-PDZFt9OU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">my name is John Schultz and as I said
I'm here to speak about canvas in nodejs
real briefly about me currently at
include in DC web consultant company
design firm that do mostly web
consulting before that I was at Omni TI
which was also another web consulting
company while it on the API we released
a monitoring service called Sur CONUS
and I did a lot of work with charting
there that's part of where some of this
stuff came from and you can find on
Twitter at JFS III so why are we doing
canvas um no it's to replace either this
script tag which is loading to library
and then instantiating it or an iframe
with image source equals and that
stilled only get you to but why are you
doing canvas a node and the best ways
give you a use case so we had made some
Kansas based charts for customer and
they really liked them and they wanted
to put the charts in their wiki canvas
based charts need a browser or a
document and iframes a good way to do
that and just you would link to whatever
normal content is and put you know
chrome equals false or something along
those lines unfriend problem is wiki's
don't allow my friends or most don't so
I really really want to make this work I
mean it seemed like a completely valid
use case to take these charts we had
worked on and get him to work at their
company then it was a compliment they
liked our stuff enough that they wanted
to share these items within the company
so it did a little looking and I did
find a project called Rhino canvas but
it is it looks dead in the water I
haven't seen any activity since I was 6
so I made a request on Twitter just some
of the people I could think about
basically you get what are you talking
about its image why are you doing an
image on the server or a specific item
canvas which is clearly a browser item
on the server I did talk to some other
people and Kiro was mentioned akairo
does SVG p and june PDF generation does
a lot of stuff it's got hooks for PHP
Perl a whole lot of other languages so I
thought that if I had to wherewithal
I could just reimplemented see but that
wasn't the most exciting thing to me the
good news is I'm serious three days
after I figured out that I would use
canvas I mean uh Cairo TJ has some post
about how he's almost done with no
candles so thankfully a couple weeks
after that learn Bruce and TJ released
note canvas and does exactly what I was
trying to do and it's canvas API
compatible so you get all the stuff you
expect you get move to line to stroke
Phil Phil rectangle everything you
expect out of a canvas instance and it
gives you a couple other items which to
which are really poor one of which is
really important to me create PNG stream
and to buffer so I'm going through a
couple examples this example is a little
bit trimmed down from the one that's on
the new canvas site and notice here I
mean I made a note in the comments the
only difference between a typical canvas
script is that one after acquire canvas
and then really char instantiation that
instead of saying canvas equals document
create new canvas canvas dot height
equals canvas now with equals you just
passed the height and width and the
constructor from there on you right
create canvas like you normally would
here I'm doing to data URL which is
standard method and that gives you you
know big data your I which we produce
woot here's gradients and again the only
two items that are the change here
require canvas and new canvas everything
else is the same this is the image that
it generates
oh yeah I was doing some editing yeah
it's not that magical I was changing the
plane around sighs sorry about that yeah
it's definitely type of a graph or
whatever a sparkline similar item this
is all what you would do in canvas that
you were doing on a client side so that
gets me close it means it's possible for
me to write canvas and node the real
issue is though for me I can't I still
can't use flot over on the server side I
don't want to spend my time writing a
charting library there's already one out
there there works in particular the
customer liked our graphs we had made
some new data visualizations we've done
you know customizing of the colors
whatever I didn't feel like doing that
work again so flot uses jQuery jQuery
uses the Dom so you have to find a way
to get the Dom onto the server and that
thanks to Elijah
can be in J's dome as possible Jase Tom
which are fuselages talked this morning
but it's a way to get the Dom it's a
common jazz implementation of the Dom so
why like that would be the Dom or so the
way jQuery I'm sorry go ahead
so the way within a we run the plot on
the server side and we basically go to
strapped a couple jQuery functions and
then the only problem is that where some
reason flawed uses Dom for the labels
mm-hmm but there's a project that
implements labels in camera correct I'd
love to get that actually was talking to
TJ about it I was trying to know the
project called drawback so what it does
is basically be able to share the same
code and apply an observer as far as
sports actually
of my chart and then for the server-side
ads hooks so for example if you want to
get up great view of the chart it's
gonna execute the same code and also
load additional plugins server like for
example rather than text in the canvas
gotcha
so we can go into that afterwards but
where camera was saying was that they
have done some work to make to where you
don't even need a s Dom to have jQuery
wrong I did like I said I was talking to
that TGA about it and I couldn't get a
hold of that so I found you'll see in a
minute here way that while it does
require to loading some additional stuff
it was also the minimum amount of work
that was required for me so jess tom is
incredible and it currently gives you
Dom level 1 &amp;amp; 2 browser support and with
that Dom I can now get jQuery to run on
the server here's an example - the same
same thing that a lodger had this
morning just get jazz Dom in this
particular case you're loading nodejs
title work and then going to inject
jQuery made a note that that is
production jQuery when it's ready their
runs jQuery against that content and
counts the number of anchors the number
of links that are there so you can do
screen scraping in this example GS Dom
so patching plot was really simple
because that canvas API is API
compatible all I really had to do in
flock was just go to the place where
that canvas was created and make a
change to it just did a branch and there
was one other thing which is that flot
in particular wants a width and a height
which it grabs from the Dom element so
since there wasn't a width and height or
jQuery wasn't able to determine those I
made it give it the config option of
giving it a width and a height so
technically I had a couple more lines
however that can that's a complaint
that's common in fly is that I want to
tell you how the dimensions of this
image perhaps you've got a div or
something that is off screen at the
moment so if it's hidden Ischl e slot
would see that as 0 0 and wouldn't
render it anyway so you can't pre-render
so that's something that's coming in a
newer version of flawed it's I needed it
in particular for this but eventually I
mean it's one less item you'd have to
patch I do have the patch this is from
oh six I've got that
was a guest I haven't made those
commissioned I did post the the patches
of there are available when I worked
with them when we did the github Fork
so I've been having discussions with me
it's not committed yet and that's
actually one of the things I'm trying to
thought get committed in there so
definitely that would be the ideals to
not have to patch anything just get a
committed because it really it's
completely compatible I can run a
client-side or server-side it's fine so
here's an example so I've got a domain
JSP no de which is where I play with
node stuff and so this example let's see
if I've got it all right so this is
basically just taking ajs Dom example
and converting it or whatever adding a
couple things in so in this example
required just aam give it a base Dom to
work with again production jQuery code
my patched flan and then here's one of
the there's two plugins that as Gamera
was saying the only real remaining
challenge with flawed is that it renders
labels in absolutely position divs so
they're not a part of the canvas and
when you go to do actions like - de -
URL or whatever you now don't have them
so all you would have is a canvas with
lines and fills but nothing to say the
current value is 50 or this is
pertaining to CPU usage or whatever so
there's existing canvas plugins I mean
um flop plugins to get text and this is
a totally unpatched flat plug-in
actually my guess I'll get to it later
but that will be going away at the need
for that is going away soon and then
when it's ready this is just generating
data I would have to do this if I were
showing you how to use flock just make
some random data the only things that
are of any real change are the height
and width that I mentioned earlier and
for that particular plugin it takes a
canvas text argument to grid give it
some information that out with what the
font is to be and then I set clickable
and hoverball to false those are getting
normal flawed options there's no need to
apply any sort of listeners since I'm
going to be returning a static image and
after that um a couple aliases here just
so
I don't have to write window dot jQuery
or window dot dollar in my code create a
sham div this signature right here plot
equals plot div data a completely
standard flock Hall get canvas there's a
normal flop method here I'm getting the
node canvas back which has those
additional methods I haven't defined
where I want to do this output and then
you the create a right stream more
importantly create a PNG stream and then
as it gets data right to that that
created jst ang which is back here I
think I can do that's what was actually
being written out so going a little bit
deeper I got GS node Jason OD / slot
which is just a way again for me to
experiment with stuff I wanted to do in
source equals something and get data
back so you can on this particular
whatever instance I have I can actually
pass parameters in via the query string
probably not what you want to do in
production but it's possible so in this
case I can give it a JSON object or just
options or just data so if you give it a
list of actions that will give those
right have an issue with that
occasionally weather I don't get there
but that is live data so I do use one
Dom in that earlier example I was always
doing require setting up an empty Dom
writing to it there's really no need to
do that so that's a JSON OD slush slots
and Express app so what I do is when I
create when the server is created I do
this real basic script injection where
script injection where same things you
saw earlier I just load up the patched
flock and the text plug-in that I need
just to have this there and that does it
one time I then assign window doc canvas
to that canvas that a new canvas item
and same thing I was doing before global
that jQuery equals window dollar so I
can use those later on in the script so
the idea there is that I have one Dom
that I think I'd go to next that when
I'm actually writing the image ACK all I
ever do is create a jQuery item and it's
always dealing with that one document so
I'm not making multiple documents we're
making a new one each time because it
just seemed wasteful and it also happens
to work here so this is render flawed
image which is what is used to render
that um jsn Odede slash plot I happen to
get some data create data like you saw
it before I'm just getting rid of that
placeholder equals jQuery I don't even
actually in this example I don't even
throw it a div this seems to be enough
to allow it to work again the standard
plot or flat call signature no canvas
just to remind me that I've got a
enhanced API and now I make a two buffer
which is what gives you this that binary
image and then I just in my response I
give that image back and I'm really I
haven't done enough testing to determine
what effect placeholder has but I
actually decided just to delete
placeholder because it couldn't hurt I
don't know it's working it might clean
memory up for me
I haven't been able to put this thing
under enough load to determine if that
has any effect or not
so wrapping up advantages big thing
image works everywhere explaining we had
people that wanted a wiki I couldn't do
an iframe on that you've got older
browsers or even current browsers that
don't support canvas Mobile is another
one so or if it's an either a older or
just lower powered I guess through age
or form factor they might not have
support for canvas everything's got
support for image most things you care
about code reuse and this was key with
me we had already done work into getting
these charts to look the way that I
wanted and I wanted to quickly get
something up that allowed us to use this
for this client so that was key for nice
performance images less burdens again I
mentioned lower power devices instead of
me giving a data structure to the device
having the device constructed and render
it I'm just giving binary image data
back
so there's definitely performance gained
on that for some items privacy is huge
in the monitoring service or was
mentioning with some people that just
wanted they want to share their charts
but they wanted to show the relative
change or relative effect they didn't
want to show actual membership database
queries whatever it was and if I was
just giving a JSON data structure back
you can see that in the net request is
possible to off you skate it but you're
one way another you're gonna get it it's
a JavaScript that's coming across here I
can make all the changes I want on the
server determine what I want the person
to see and return a completely opaque
image or as a because I want it to be
image back to the client caching now
that you've got a standard HTTP request
you can cache it like you would anything
else let's say you've got something like
sales and you know that if I'm given a
start and an end date and they're both
in the past new sales aren't gonna have
occurred put a far futures header on it
man you can cache it as aggressively as
you would anything else or as you live
that type of data elsewhere I'm side
note I mean if you've tried to ever
cache xhr if you've ever dealt with a
304
or of an xhr it's really problematic so
three or four says that data hasn't
changed ask the server can you give me
the data the service says use what you
have the xhr object gives you back empty
there's no way to get the data that you
did have before so when you try to do
the right thing using xhr if you give a
three or four back it's it's
debilitating or it's a really depressing
that you can't use that so this allows
me to get around that as well text one
of the benefits I guess for having a
single platform you know what you have
installed on your server so you can use
a certain file this advantages I think
the first one being I'm now bringing
load from a client back you know that
nodes are going from a node back to the
hub so you are taking on some burden but
I think you can offset that by some of
the things I mentioned caching and etc
it's an image a lot of fun stuff done
canvas mouse over tooltips expand zoom I
can't do any of that with an image so
clearly that's gone and it's another
piece of technology in your
infrastructure you might not be using
node already again that's not too
terrible I mean you can make a request
that goes through a certain port or a
certain URL and just send that through
so it's only being run not only that
little bits being run by node you
probably have your own image server
anyway that's doing something similar or
if you're doing server-side and
generation you already have that memory
as I said I haven't dealt with enough to
know I'm not seeing it but I know
there's been there was some question
from Elijah if I was running into it
when I showed him what I did he said I
should be fine but this is not
thoroughly vetted so I'm not exactly
sure what people would run into with it
don't know of any other said this hasn't
been I didn't get a chance to implement
this at the monitoring company it's our
code so I'm not quite sure basic
questions can you do this with Gd or
imagemagick
you can but I wanted the same charts
that I already had
I like the client-side charting
libraries a lot better I think there's a
lot more development actually going on
in that so it's a lot more there's a lot
more for me to choose from and what I
like is if I find something I like I can
just do basically a patch like I showed
you before go fine work creates canvas
a little bit out and theoretically
that's it or do a little bit more
digging but it's really not that much
work to get a client-side library to
work on the server side
I'm sorry performance I've mentioned not
really sure some flat specific items
actually didn't realize till yesterday
that flat was 7 is out came out about a
month ago so I actually did a patch the
internet issues today I couldn't make my
changes over but it's a similar patch
it's really simple just the line numbers
changed enough that I couldn't apply the
same one flat oh wait so there's the
verse Mets an SDN right now is doing all
the rendering or at least doing the
label rendering in text so you don't
even need that plug-in I don't there the
tick label rendering in text I don't
think they have labels down yet but
that's definitely where they're moving
so you would just specify font size fill
etc options and that would be completely
standard which means the new that plugin
is gone um
Elijah mentioned note flock I'm pretty
sure he's talking about me there isn't a
node flop project I don't know if there
really should be ideally I'd just commit
the stuff back it's a patch file I'm not
trying to fork maintaining this stuff so
hopefully I will submit these if for
whatever reason I can't get them worked
in and I'll make a project which is just
gonna be a patch file right now just got
him up as guests and that's it
does it make any questions I had it no I
haven't sorry the question was have I
ever on Raphael j/s I have not Rafa
exactly so Raphael's SVG which means
that now I did here turn Crocs wrapping
theirs but I did here Raphael shut him
out so I believe it exists somebody we
should be able to do the same thing
because Cairo like I said also has SVG
support so if somebody was similarly
motivated or if no Raphael doesn't do we
think it does you should be able to do
that
near portions what's up I don't have her
this the question was is there a service
on WebGL there's a couples the answer
from camera I'm sorry
so these are there was a couple that's
right ahead soon the one okay thank you
for your time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>