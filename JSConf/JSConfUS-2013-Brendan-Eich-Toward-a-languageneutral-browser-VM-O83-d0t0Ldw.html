<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[JSConfUS 2013] Brendan Eich: Toward a language-neutral browser VM | Coder Coacher - Coaching Coders</title><meta content="[JSConfUS 2013] Brendan Eich: Toward a language-neutral browser VM - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>[JSConfUS 2013] Brendan Eich: Toward a language-neutral browser VM</b></h2><h5 class="post__date">2013-08-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/O83-d0t0Ldw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay um I just flew in from being like
SVP engineering or something at Mozilla
I'm kind of busy lately and I was also
at this thing called fluent I thought
I'm doing a talk that's going to have
more nerdcore stuff in it because I know
and love my Jas conf audience thanks for
being here so the first I'm going to
talk about is the web is the native code
platform which seems crazy it wasn't
really working well until recently and i
want to show what you guys all from came
here for which is c epic games I'm
religion 3 like I'm electrified I'm not
going to move except I'm gonna have to
play game and i'll talk about the tools
you may be failure with for doing this
why triple AAA games what does Triple A
game mean I'm told it means like halo
and top end you know xbox playstation
games these really do want to be seen
C++ games and to run at full speed they
have to be compiled that way you know
John Carmack said this at quakecon last
year he's quite right but they're a good
torture test the exercise all the
hardware they stress memory and load
time you can dodge a wrench you can
dodge a ball and so yeah I switched from
Wesley at patches actually I have both
so we're very interested in pushing the
boundaries of the web and even though if
you really want to go full speed there's
nothing like C or C++ if you want to
reach everybody with a safe non-scary on
the web just click and it runs
experience you need the web stack web
staff is pretty lame for a while we had
the reboot browser competition with
firefox and then it really got better
and then it got even better some of this
stuff you know indexdb okay
it's getting there it's a work in
progress the web is a work in progress
but there's really awesome stuff coming
between like Mozilla and Google people
we've got pointer lock gamepad full
screen working pretty well WebSockets
and then stuff we're doing again
collaborating with Google like web RTC
gets you even farther you have any way
low latency data as well as audio and
video communications in web audio which
who has originated great for multi shot
effects something you really can't do
with html5 audio positional affects the
whole works so this is a pretty good
platform now it's you know it's a little
lumpy it grew gradually but you can do a
lot and yet it's cut off from native
code unless you use some script in which
I think everyone here has probably heard
of even then scripting was generating
code Alonso coyote super genius it was a
little research figured out how to
generate JavaScript that ran pretty fast
but until we formalized something called
asman j/s it wasn't clear how fast it
could be we wanted to push too
predictable performance and i'll talk
more about that in a minute so now we've
got a native code platform it has a
bunch of stuff and it works in some ways
it's just another compiler target maybe
it's the last compiler target because
once you're done you know game guys do
this all the time they poured they look
at the audience size they see the ps4
the port to that the web is really huge
there are maybe eight million of 10
million developers I don't know if I
mary meeker had this in her latest
slides it's going to be 20 million i
talked to marc andreessen last year and
he's betting on github big because he
sees the developer community around open
source show your work really heavy
javascript emphasis he sees that growing
to be bigger than any any native
platform the population of native stack
developers is in the hundreds of
thousands by comparison so time for
demos and we are still working on code
loading so you will you will have to
bear with this initial experience it's
getting better we can do parallel
loading workers
we can make it better and turns out a
lot of the code loading is not
JavaScript compile time so we've we've
got something else to blame let's make
sure this is going to be loud am I on
audio here I'm plugged in I don't care
my volume oh thank you good let's hope
that isn't too much so this is this is
the fly through this is the sanctuary
level of Unreal Tournament truck it's
unreal engine 3 this is all JavaScript
there's no plugin it's all WebGL of
course you want to get on the GPU that's
a good thing and i'm going to show you
my mad skills
you're over here there they are
Oh No uh I'm gonna get out of here for
our children good thing I'm invincible
alright
they're Thank You technical issues um
that wasn't possible year ago we had no
guarantee we could get to the speed we
got until we did some work i'll talk
about now so when you think about
reaching people you have to think about
javascript you guys know this i'm at JS
conf and javascript PM's are fast but
they they they don't necessarily give
you the predictable performance you want
so when you run a compiler like a C++
compiler built on the llvm framework its
kind of missin a and it's not a vm it's
a compiler framework which is what I'm
scripting uses awesome framework it's
what client uses you you can tool to jas
but can you get the speed so it turns
out you can compile code can be faster
it can be deterministic in types and
memory use it can take the static types
of your C++ program apart from unsafe
casts and map those to JavaScript and
you can preserve that happening if you
don't do it you have code like this we
all know this code it runs pretty fast
in jits but you're having to guess in
the JIT that that I as an integer you
don't know what X might be you having to
guess that the sum s won't overflow into
a double and if it does you might have
to recompile one of the insights that
alone had was to take typed arrays from
WebGL and use them as the heap use them
as the the memory for data not the
control stack and that can really give
you speed up because then you're
modeling memory is a bunch of 32-bit
integers or by its or both you can you
can model it multiple ways you can have
multiple views on to the same underlying
buffer and that gave a good speed up
with them scripted but what we need to
do is go further we need to get out of
the unpredictable miss speculation
regime of jets the garbage collection
pauses are also an issue and if you load
code you end up with large amounts of
code and you end up with inevitable miss
speculations rii compilations hard to
analyze data flow let's say if you're
doing type inference it you hit scaling
limits so as some JSE's our answer to
this
this is a subset of JavaScript currently
and our intention is to extend
JavaScript so it always remains a subset
that's not really cheating we're always
extending JavaScript anyway if there's a
gap in the language we try to fill it if
it's got legitimate use cases so this is
just another one of those drivers of use
case extension use case based extension
and that helps us run in other browsers
which is also important if you if you
tell someone they need a new plug-in or
they need to get a new browser you're
going to lose a lot of users see if you
tell them it runs a little slower it
might actually be tolerable it might
also put competitive pressure on other
browsers to level up and that happens
all the time we've been doing it forever
you know in 2008 when v8 launched there
was a performance war that hasn't ever
stopped really and it's still going on
and I'm going to use the latest v8
numbers when I show results here so what
does asthma just look like it looks like
this version of Java Script where you
use coercion that are written as bitwise
operators like that single bar 0 where
pointer is stored back as an integer
because it's been bored with 0 it
doesn't change its value assuming it
wasn't in it you're just just make sure
that it is knitted your and since that
assignment dominates the rest of the use
of the pointer you can be sure it's an
integer and if pointers recomputed it
gets gets really reordered with 0 and
you can do similar things for unsigned
with triple right shift it's a good
thing I added those operators to
javascript in 1995 it was something I
wanted to do as a low-level see hacker
it was in Java it didn't make sense to
leave them out even though their
precedence is kind of wrong there's a
nice history of that from dennis ritchie
about why that happened but turns out
they're pretty important for Asmodeus
and other sorts of things people then
hand coding bitwise operators for
various special purposes in JavaScript
and now it's critically important and
this is something you also see in
mandrel another script and I compiler
what we do with asthma just as we make
sure we know that there's always a sound
type at every join point in the control
flow graph we know what the types of
things are and if we if we have to take
a coercion step we will put it in the
generated code and we can analyze not
only four types we can also make sure
all the memory and the
eep is understood so that we don't have
any garbage collection pauses that would
really hurt your gameplay so let me talk
a little bit more since this is jae's
comp about oh yeah this is I want to
talk about this other stuff I'll get to
it s MJS has a very simple structure and
it has this hint use Azamat currently
doesn't mean anything if you if you
ignore it you still can run pretty fast
in for instance v8 and they did some
work to make it even faster just before
Google i/o but if you actually do take
that hint you can do what we call ahead
of time compilation it's not like you're
running the compiler before you even go
load your code it's happening though all
at once and you can analyze everything
you can see the entire module which is
what's going on here you can see a type
system this is where dave herman
invented some funny names like double
ish and in tisch I don't know if elvish
makes sense dwarven oarfish dwarvish
that's right Toki and said dwarvish with
a V troll ish we should have trolls and
and what this is doing is it's saying
with JavaScript bitwise operators we can
have in types we can have in types that
might have to be coerced back to enter
they cross a boundary so we're modeling
that formalizing this and one more thing
I want to show here this is the MJS spec
it's on sm j org um is how this works
for operators when you when you look at
how JavaScript works it has all the math
operators but currently they operate as
if things were double-precision
floating-point which isn't the best
number type for going fast you want to
stay in your CPU and your ALU you want
to integer operations so these these
types help us do that in some cases it's
hard to make sure you stay there when
you for instance do a multiply 32-bit x
32 bit might give you 64 bits they might
have to go to a double we actually have
something in es6 it's already in called
math I'm all which is an integer
multiply so that helps that's an example
of extending language really easy
extension to to make smgs still be a
subset make things go faster and we also
have the math library of course and we
have these nice WebGL typed arrays so
get back to my prezzo that's how I some
Jeff's works how fast is
well this is pretty these are fresh
results I think blue is Firefox red is
chrome canary with the latest v8 and it
has pretty good performance for the
micro benchmarks the first nine in fact
if you look at this chart one along the
bottom means same speed is native the
life I think it's Conway's life
benchmark supposedly runs faster than
native and be eight in Firefox that's
actually a clang bug GCC beats them both
as you expect you we're not going to
really beat native speed unless there's
something wrong with a native code
compiler but these micro benchmarks are
somewhat trivial if you look at the
bottom six those are macro benchmarks
those are real significant programs they
have those scaling problems I mentioned
one run in a non as MJ s optimized
engine and you see this with with chrome
now the v8 guys want to keep pushing and
see how fast they can get without having
to do the kind of asthma guess
verification that we do and I hope they
succeed I am NOT concerned about which
way wins everybody wins if we get to the
same speed but right now because we do
this ahead of time verified all at once
compile step we actually are unboxed 2d
one point three three times slower than
native code which is it's going to get
only faster as we keep going we have
more optimizations ahead of us so we're
getting to the point where you don't
care about the slow down from native
code on modern hardware and even on the
average hardware on the web the reach of
the web the lack of a plug-in or a scary
install dialogue or a need to switch
browsers makes this a winning
proposition for game developers like
epic games we worked with them just in
four days we brought up Unreal Engine 3
that was amazing to them because because
of the power of him script in because we
had asthma j/s Odin monkey optimizing
backend and spider monkey at the end of
a week in Raleigh North Carolina we had
unreal working and they were blown away
so that's where we are right now and
we're pushing that down toward one point
pocket change X slower than native and
that's I think going to change the world
it isn't really for hand coding people
are doing it there's a guy on github
who's doing an awesome job but generally
you don't want to do it the tooling
isn't there you
verification areas if you make the
slightest mistake if the types don't
agree at all the joint points if there's
an inscription bug you might get that
we're still early so we had some friends
at Intel working with it and they said
hey it's only 12 times you know sort of
the native it's not too or 1.3 times
slower what's going on I won't I said
look in your console and sure enough
they're having verification errors and
alone I fixed the inscription bug right
away so we're bringing it up and you
don't want to hand code it too much
Never Say Never people talk about
writing assembly windows in JavaScript
the problem is right now the boundary
crossing is a little expensive because
we're doing this this verification
because we have to make sure the types
going in satisfy the constraints inside
the atom blob where they can't change so
there's some overhead that makes it not
yet desirable to write as in Windows but
it could happen so this is part of my
top where I see an evolutionary process
that is running native code on the web
at new native speed but safely with no
extra plugins no memory safety your loss
or any other concern like that that's
big but people say what about my needs
what about blub and you know it's a good
question javascript isn't for everyone I
think I was retweeted saying is by far
not the best language for every task
let's say I know it's gotten better and
people like it and that's good and I'm
working on it because it's not going to
go away so i think it's it's or
obligated to work on it but there are
other languages that people are more
productive in why shouldn't they use
them so you know trans compilers if
you're at the same semantic level not a
big deal source maps tirar here i think
in firefox and chrome thanks for getting
to the point where you may be able to
just use languages like Python Ruby Lua
now if there's a real semantics Gavin
this I think this happened with dart but
I'm afraid they took out big number
Terry position integer we could have
added that the JavaScript it's still on
the agenda it might happen in es7 but
because it wasn't efficient in dart to
jas or wasn't even implemented I think
it was just double which isn't
semantically the same not the same as
dart VM
get out I feel that that's that's a
mistake i think if you need something
like big numbs if there's a good reason
for it in your language in your audience
then maybe we should add at the
javascript big numbers are something i
wish i'd added 95 it would have settled
a lot of arguments early but there
wasn't time so you know how good can we
get with just trans compilers not clear
but as we fill these gaps we can do a
lot with languages that are near the
level of JavaScript now some languages
want GC and if they're running a GC in
this big typed array heap and we can
actually connect that heap to the Dom or
JavaScript objects which is on the road
map now we have a problem of two garbage
collectors fighting so you don't want
multiple GCS you want to have one GC
rule them all like in net like the
modern JVM which supports multiple
languages but has one GC so you want the
JavaScript GC to have hooks safe hooks
that the Assam Jas generated code can
use in the guest heap which is that
typed array and that's on the road map I
wanted to just acknowledge this as an
open issue you're working on alones akai
has got Lou a vm this is not luigia to
this is not the super awesome you know
assembly coded lua but this is
still pretty fast micro benchmarks legit
two beats it but on Unreal Lua
benchmarks which they're surprisingly a
few in the web this is this is not a bad
BM it's faster than Python and Ruby C
Python this is M script ined and it
works pretty well and it I'm going to
run it here and see how it works it it's
just a big c vm nice efficiently written
portable interpreter vm and it has a
garbage collector that garbage collector
is not yet married to the javascript
garbage collector so there there is a
with leaks right the way this is running
right now it's just going to allocate
memory and not collect having it run its
own collector as possible and then it
can scavenge space again if you ever
connect things between the the guests
and the host heaps you'd have problems
until we we do this lifting of the host
you see into the guest heap which is
possible
is going to finish soon so if it is not
going to go play some more games and
another open issue is jits so I
mentioned blueridge it too if you want
to take a say a C code base that has
some some assembly code generations
machine code generation into right a
bullet skewed old memory and script and
is not going to solve that for you and
it's formally unsafe so we'd have to do
something like what the novel guys have
been working on I'm not sure that is I
saw activity the other year about it but
doesn't seem like it's it's a big thing
I think it's happening in the mono world
to you can do it you have to be able to
generate verified Adam code you have to
be able to invalidate it when the JIT
miss speculates so whether this pays off
or not in the long run is an open issue
but if it's important we can do it it's
just more work it's on the road map and
then thread this is actually significant
if you talk about native code C C++
people say where's pthreads I have to be
able to write you know multi-core code
there right javascript has always had a
race free memory safe model of execution
which doesn't allow you to observe
shared mutable state you can see it only
at event loop turns so there is this you
know coarse-grained shared mutation and
that that's enough that causes people
enough headaches if you actually had
fine grain you know races to update
memory if you had people doing busy
waiting on memory in JavaScript you'd
have problems that we don't really want
in the language you'd have to make your
VMs multi-threaded nobody's done that
Java VM in the 90 started out that way
and was incredibly expensive they had
research David bacon did at IBM research
to optimize using atomic instructions
and then so they realized well we can't
really afford this overhead anyway so
they ended up adding like
single-threaded versions of all the data
structures but if you look at v8 spider
monkey just report all these engines are
single threaded in their implementations
and that's important so we must not
pollute the JavaScript semantics either
at the language level from pan coders or
in the VMS with data races on the other
hand smgs is a target language for see
if it's all as encode see semantics are
good enough
right there are games that are going to
do busy waiting their games they're
going to do shared you know mutexes and
condition variables and atomic
instructions so if we can verify and
this might require that use azum
directed to mean something we can verify
that these workers that are racing over
data shared memory running on different
cores giving you that great parallel
speed up are all as them all the time
then i think we can do it so that's
that's what we're trying to do we're
trying to keep data races in the bottle
of the Asmodeus only workers and i think
that's a fair extension to do and i
think it's going to happen it is not
something we have get persuaded others
in the standards bodies to believe in
but it seems like a shorter evolutionary
step than anything else you can think of
like adding general threads to
javascript is just not going to happen I
guarantee it and then we'll make sure we
don't let these data races leak out so
this leads me to what informed the
abstract my talk which is I had this
sort of depressing feeling when i wrote
that abstract that we were going to have
a race like the one between John Henry
and the steam-powered hammer that
JavaScript hand coders heroic people who
really helped co-evolved the language in
the libraries who've made all this great
progress possible as much or more than
the vm implementers in my opinion would
be like John Henry they'd be like
hammering away and this this this
compiler this set of VMs or automations
for compiling programming languages
would be hammering away and John Henry
the human coder would would win but then
his heart would give out and that would
be it and then we be in this this modern
postmodern or maybe matrix e dystopia of
compilers I still worry about this you
hear about things like opencl as a sort
of bastard language derived from c99
being pushed this web CL and it's
supposed to let you program you know GPU
sounds good it's got all this crazy
storage class qualifiers you put on data
to say whether it's in you know nearby
or far away it's a global memory it's
really slow programming the GPU is not
easy and if we all wrote open Taylor
Webb CL I think the world would be a
worse place you know view source
wouldn't mean as much there'd be
co-chairing there be sort of more like a
world of applets or Swift's or you know
binaries from the Windows desktop era I
don't think we can stop this but I
actually got less depressed as I thought
about more I think it's still an open
race John Henry's heart hasn't given out
you guys have to help John live I think
it can be done and it isn't just that
JavaScript has this incumbent advantage
I that that's part of it and that's you
know fair or unfair that's just the way
it is Java scripts there in all browsers
even if there are compilers generating
azum code it'll always be good to load
some javascript fast and go through the
dynamic jits javascript and the web
browser the whole client side of the web
even though jess on the server it's not
the same as native code you don't need
to write everything as you did in the
old days you don't need you know
millions and millions of lines of code
to do cool applications you have a
network you have clouds you have GPU
clouds as I talked about on my blog
recently even if you're offline you're
not going to take your whole server no
sequel database into your local memory
you might do something like that with
navigation controller alex russell and
others working on but it's going to be a
subset it's going to run in javascript
so there's still this sort of novelty
and asymmetry with the web and with
javascript that i think makes it
something that will continue to endure
even when there is compiled code for
games though you have million line code
bases they have to be written in c++
because that's the language to go
fastest metal on you know ps4 or xbox
makes sense so I think we will have both
compiled and JavaScript hand coded code
for a long time to come and that makes
me say you knew it was coming i'm going
to say almost bet on something but you
know people object we're in this
evolutionary regime it wasn't all
planned i didn't plan this right i had
put in bitwise operators because i'm a
see hacker i thought they might be
useful i couldn't justify taking them
out of the grammar and it just I knew
the grammar by heart so I just
implemented the whole thing and it
turned out to be useful and so you know
this Pelican don't make fun of it for
looking like a urinal it it's a happy
beautiful creature you know that this is
this actually isn't isn't isn't the
animal it just looks like a monkey but
it's a sponge and I don't think this
actually really fits the WTF evolution
site the tumblr sites meme but it's
funny but I'm going to close as I
usually do always bet on Jas thanks
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>