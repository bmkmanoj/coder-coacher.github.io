<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Adrian Perez de Castro: JavaScript in JavaScript: Inception | JSConf EU 2014 | Coder Coacher - Coaching Coders</title><meta content="Adrian Perez de Castro: JavaScript in JavaScript: Inception | JSConf EU 2014 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Adrian Perez de Castro: JavaScript in JavaScript: Inception | JSConf EU 2014</b></h2><h5 class="post__date">2014-12-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/F2cL4EOAztk" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thank you thank you welcome everybody
it's always great to be in Berlin and
even more if it standing discomfit I
like it how powerful and bright vibrant
the communities this is my second year
and it's not just a pleasure but it's a
great honor to be in this side of the
room as a speaker and well it's amazing
first of all let me tell you that I have
not watched inception and you may be
thinking which kind of person has has
not watched that movie and why is it
using the title then well any possible
reference to the movie is just a plain
coincidence coincidence it is just that
for this particular talk I like how Jes
inceptions handled because this talk
it's about implementing scenes of
JavaScript engines in JavaScript and I
wanted to use this very nice logo that
I've been thinking to use for a while
which is all CSS and that I having like
licking a bit after success comes the
other day so well this is all HTML and
solid speed but let me do this myself as
you know I'm Adrian I'm from Spain but i
live in helsinki so it's funny I
actually do enjoy the winter it's cold
yes but it's very nice also but that's
all the things I enjoy a lot one of them
is free software another one is getting
into trouble the first one free software
that's what got me into galaxies years
ago a and I'm working they're still in
the compilers team and I hope for you to
come the second part is what got me into
little machines and compilers it's not
the most useful thing for people to like
and it's also maybe a bit of low level
for this conf but no worries we're not
going to touch almost any super stressed
call today and yeah I said trouble
because those risks
those beasts can be quite complex and
lately the last year and something we
have in collaborating with Bloomberg
they have been supporting us to bring
es6 features into JavaScript engines not
only the ADA does so some spider monkey
and also modern layout to CSS and if you
have not watched it in CSS conf I would
recommend you to check out the grid
layout talk that from friday was very
nice and it was amazing to see all the
positive responses in twitter while the
talk was going on and it seems that is
something people are going to like
that's very nice so in for today i'm
going to spring a bit what is this
interesting thing about how do we get
the JavaScript into arranging must act
in v8 and when we have time from the
from the talk will keep trying to come
up with a small implementation for a
feature of es6 try to add it in v8 and
refine it a bit as long as the as much
as the time allows so there's going to
be live coding I hope that nothing blows
because this is the kind of thing that
can go wrong well to make things even
clearer this things are not going to
touch in this talk at all this is not
about trans piling this is not about
changing JavaScript trans piling it from
es6 two years five to current engines or
anything like that it is not about your
spelling other language languages to
javascript it is not it is not about
implementing a Java screech engine in
JavaScript itself that can be done it's
surely a lot of fun and it's the kind of
thing you do when you have a lot of time
but we're more interested in to getting
our things into actual process getting
them in OGS get them in places where
people would use them in established and
browsers so this is more about other
features into yahoo screech engine
trying to touch the less of C++ as
possible because the thing is once they
lack the basic build tool machine
ranging is the basics are implemented
there's not much that would prevent to
use the language itself
to implement things this is the same
that happens with C or C++ you have the
c compiler the c compiler you can use it
to build the c library or to build the
c++ library and then use that in all the
program so why wouldn't we use the other
Street to implement parts of JavaScript
or parts of the standard library or at
least as much as we can and then use
that in a round engine well actually we
can and that's a good number of reasons
to do that I think we can all agree
being in these cones that we prefer to
use the other Street and C++ it's easier
to beat faster to develop we don't have
to go with all this code compile will
test check the bag see cycle so that
gets faster it makes us more productive
and very often the algorithms and more
easily understandable and more
maintainable if we just write the
nominee JavaScript and anyway that's
another reason which is why not doing it
I can do it well as just do it just
because and that's one or two not so
obvious reasons and one of them is that
the modern just-in-time compilers are
really really really good to generate
the machine code they're so good that
they can make faster code that our
handmade C++ code and how's it possible
it's amazing well the thing is that if
we implement parts of the runtime in C++
they're still going to be a moment in
which the JavaScript code has to call
into the c++ runtime and there there's
two words does the javascript world does
the C++ world and whatever you use in
the JavaScript world you have to convert
it you have to compare the values to C++
values arrange the stacks arrange other
things make sure you call into c plus
plus plus plus with proper calling
conventions these takes time this layer
this layer of butter in the middle of
JavaScript world and C++ world takes
time if the functions I'm doing are
likely to be well implemented by the
JavaScript engine with with rather
implement them in JavaScript because we
have all this jumping from JavaScript to
C++
and that's what makes it faster also
compact engine of others make very good
guesses about types of things so that
you can just most of the time not as
well this integrals just generate
perfect code for integrals so yeah they
may very good cold so there's no there's
no reasoning that we say yeah let's make
it a plus a C++ because it's faster it
doesn't need to be and it may be slow in
C++ and well anyway again just because
and because it's fun to give you an idea
of how much javascript is using engines
this is from yesterday I have made the
numbers yesterday having checking the
with toll to count lines of code thus
that's the most of the JavaScript code
is using b8 next the spider monkey
following very far javascriptcore only
one kilobyte maybe they're trying to
make one of those one kilobyte
javascript contests or something but
well the fact is there's one reason for
that and is the javascriptcore can
revert to an interpreter so it doesn't
always in general machine code so in
that case of course it's faster to use
c++ runtime that you have to call into
so that it's my guess about why why
javascript core is not using more
JavaScript of course these numbers are
not counting test suites or tools etc so
it's the runtime or the parts of it that
are implemented in JavaScript so the VA
it looks like the perfect match for this
kind of task and that's one of the
reasons but why I have choosing b84 the
this demo today so I was saying we're
gonna implement an e6 feature so I've
been checking until last week which
features features from ethics are not
yet in v8 that also they can be
implemented in JavaScript that also
nobody else is really trying to
implement them to try to come up with
something new that it's not don't buy
any one and this one thing that it's not
done and it's a lot of methods from type
of the rays which are well
similar to the ones in normal arrays but
they just work with type of the race
this kind of into a tray in 32 array
that have contiguous memory baking and
for example those are used by a smgs etc
so for today let's implement in
something array for each and while the
code is very easy it's what we could do
in a polyfill if we were patching the
prototype ourselves this one is light a
small thing that is not a handle by this
function so let's see a more respect
compliant version and is this a second
argument so for each then we can change
the binding of these for the callback
that is called for each of the elements
so this is actually the a version that
we can go and implement now so let's do
that some music for this ok
okay let's mess up this so you can see
against our scenes inside the eight
there's a number of JavaScript files and
this one that is called typed array that
looks very good let's go there type in
array in sm street Oh surprise great has
a well several feels that look a bit not
so much like JavaScript let's just go to
the end and patch in our prototype so
for each the state function we're
implementing over this argument oops
function keyboard that's important well
if this is undefined then not this but
this the argument passed is undefined
then the spec says that these arguments
should be implicitly is the usual one
for this function so goes that way let's
make a loop this is like all most of the
loops that go over arrays
this is this length there so we call the
callback use this call function to
change the binding of this and we pass
datum in the position not the song can
it really be this easy let's check it
let's build it it's of course only
generating some staff building only the
building including the JavaScript into
v8 i'm going to talk in a moment about
how this works oops extensional internal
compilation error hmm that doesn't look
very good maybe the devil's creating
here is not as JavaScript e as expected
or advertised but let's good let's look
at it around does this setup data hbu
for example there let small things you
let's see what it does Oh is a bit funny
okay there's more things only stole
Gator hmm maybe it turns out we can
adduce get resided to interstate while
we are implementing since in the run
time hmm maybe maybe let's see the Sun
any other setup function setup type of
the race maybe we should move our code
here well let's assess all functions
mmmm the booze good but look at these it
actually access this prototype here and
it uses global hmm probably the some
kind of module system thing working on
here let's try adding this global in the
front and maybe it works again the build
phases fast let's see if it complains
this time
blah blah blah this time it works that's
great so amazing we have just became v8
hackers 10 minutes who wants a full CS
degree and compilers masters it's a
little let's just go fetch v8 now a Stan
 house could just get in there
and well make the engine do whatever you
want it to do all the linking is what
takes Marcus time I should be building
release versions but anyway doesn't
matter but I actually want to show that
it works
is it sounds a bit too strange that
during the compilation phase it actually
spits the letters and says well I
compiling this acid well it actually is
because it makes sure that the it's not
going to generate errors later a runtime
and kind of compiled version is included
in the v8 library and there it is now
let's make an array three elements for
example so do we have for each whoa we
have fridge but hey we have to see if it
works maybe it doesn't work example we
can change one of the elements that's
useful semantics so let's see for each
function engineering do for its print
hey it works wow so we have now a fridge
that words we implemented it in
JavaScript it was previewed into machine
code when building what else we can ask
for well the couple of things we could
improve here
let me stop you use it there so that's a
couple of things that we would be
tempted to do now because there is not
only into a traders in 16 ray in 32 ray
blah blah blah all all of those who
raised the teletype of the race so we
would be tempted to do this this will
actually work we could patch all the
prototypes what is it a bit of work we
have to duplicate those lines in the end
but of course we can do it but these
does not it's not necessarily a good
idea remember that the compiler doesn't
is not specialize in one version of the
code for each function so it it may
failing it gasps its guests for the
types so what we want to do is rather
have a copy of each of the function that
is something called inside but it's a
each one of the race gets its own
version so when the compiler makes an
optimized version after doing guessing
the types it can do the perfect version
that matches each one of the types and
now this is really starting to get a bit
tedious and a bit boring to write all
those so fortunately i was saying
there's some strange things there in the
JavaScript code at the eight uses they
have a kind of macro expansion thingy
that we can use to well to make on
implementing that generates one copy for
each of the four each of the functions
for each of the right array types and
this is going to be good because the
code generated for each one of the
versions once they get hot and they have
any news for a while and types having
guests the code it will generate this
well the best it can so let's see how we
can use that and I'm going to board your
gang with the same music
okay so let's go back there still intact
of the Ray there was a setup type all
right up there let's catch this let's go
set up tight terrain that is hmm macro
type of array array ID name element size
that looks like it is generating copies
of things and this name seen here that
we are replaced for what well for name
is rupees into a tray name can be in 16
arraylist then moved our version here so
based let's be nice and intended so
instead of in tight array we write name
hmm is that enough it seems so well now
each version of type of the race
supported by v8 automatically gets a
forage function in its prototype and
each one gets its unique version so this
should make it that in each one of the
type of the Ray classes their prototype
has a fridge at super that sees as any
syntax errors or things
oh that's an error again this was not
planned the other one was so what's the
problem here I don't think if the make
it stop it's a bit picky because the
macros tension is not very smart so
sometimes the arrows appear where in
places one doesn't respect
so let's see
aha now it seems to work yeah so be sure
to always put colons and semicolons and
all the deli miters you need because you
never know how the material processor is
working I have not checked the call it
just works sometimes makes things we
have the deli miters things were again
nah just a lot of time if it sounds like
elevator music it's because it's almost
elevator music
I had to make sure I was picking
something with free of Rights scale of
things
while the 80s are revealed maybe I can
just run yet I mental harmony also Oh
missing a knife producer micro secretary
that's a bit of a bummer if you want to
hacking compilers get a fast machine
with lots of memory for drinking okay
there we go I'm gonna add harmony this
time that we are let's see in 16 array
prototype for each oh yes sir that's him
will it work this time let's wagon with
int 3 array yeah it works just to work
let's make another one next this time
you in 32 array two elements for example
be for each let's let's let's try that
this argument handling works the second
parameter to make it even nicer let's
make let's make the scenario functional
so let's bring these plus X
and let's pass a string for example
right hey it works Wow amazing an arrow
functions are starting the word that's a
support they don't don't rely on the
scoping of arguments and this so far as
it works and we got automatically from a
simple implementation from strong just
one implementation a copy of the of the
function it is one of the prototypes of
all the type of the Ray classes that's
super we could make it a bit nicer we
could use those install functions staff
Louise over there and then we once it's
nice enough we could send it for review
and get a TB eight and we are just one
step a one-step a far from being from
being a person that has a comb it in a
jet engine so I hope after this talk you
all go hacking your laptops to start
implementing all those missing a type of
the rave methods it will be get a bit
tough with the review process but it's
it's gonna be nice and you will be also
compilers hackers there was those funny
things in the v8 cold this is not the
type of the ray I can actually show this
one this is from normal array normal
array so we have the code for of for
each here and it has these things that
is check audit coerce evil this is tahj
it too I u int32 but what was what is
this what's a yellow speed without types
is a spec function Wow % get default
receiver well those things are there for
a reason and so there's certain things
we should know about the v8 runtime and
similarly happens to spider monkey is
just that it's different that's a
different approach to certain things
because it's not as fast to do
everything in JavaScript or it's not
possible to do all of everything in
discreet because this thing I was saying
the initialization of the renton library
is down early
during any hesitation of the object of
the CC tanjung so there are certain
features that may not be available and
also to implement certain parts of the
JavaScript specification we need more
information we may need to know if a
function is a neural function or a
normal function and we can know that the
neural function is an arrow because when
we try to make new function it will
throw and the normal one doesn't but
throwing an exception is very slow or is
lower than just checking a flag so
actually the runtime is poses these
so-called not native functions which
allow to introspect the runtime and the
JavaScript code can manipulate and no
more about internals of the runtime so
of course this is all in implementation
dependent that's why it's different in
v8 and is different in spider monkey and
the parts are actually knows about this
does a low native cinders flag we can
try those things in the d8 interpreter
and that's a lot of functions that some
helper functions don't devastate the
sturdiest wants to check so this helper
functions are these ones that don't have
the passing time and the functions
correspond roughly to operations as the
specific specified in the language
specification so for example days in the
specification the definition of what 20
idiot is suspected to do and the
algorithms in the specification are
written down using as reference those
basic operations that are also
implemented as helpers here so the
algorithms that exist in v8 most of them
try to mimic the algorithm the way it's
written in the in the atmosphere
specification so that's good because
it's easier to find how it corresponds
to the spec but it makes it a bit harder
on us implementing JavaScript engines so
I would recommend to just to check this
to check this natives yes runtime yes
macros VI
and there's also the simplest pass
functions like this get the phone
receiver this gets what would be the DS
default argument for a certain function
so it checks change and other things
that we have that we have known
implicitly when we were doing the first
implementation of forage and you can
check those in runtime CC and there's
some fun soon it should be run time
function there it's random function is
declared with this macro so for example
that I get scope count it counts how
many scope there are well you actually
need to know bit of the engine to go
with those but with three tough time and
checking code examples from the rest of
v8 is not that difficult to get to use
the same constructs as the as the engine
area does so just check the code in all
the all the other GS files and try to
follow the same style and check the
specification the specification of Java
street is quite big it's something that
may get into your way and it may look
like a wall that is difficult to go over
because it's not greeting in a very
accessible language so looking for
examples in the rest of the JavaScript
code is better and of course at some
point you will need to check the spec to
make sure things work as expected about
b8 and how it's built it took a bit
actually it picks all the GS called puts
it into a C++ file as bytes that is
linked in to alleviate no snapshot that
is used by make a snapshot which is it's
a small utility that comes with VA that
is built with Libby a base that doesn't
include the runtime and what it does is
it generates the call for it by loading
those javascripts and running them and
dumps makes a dump of the java still hip
where the code is and the variables and
so and in a weinery format that goes to
a snapshot CC file and that is built in
dang in v8 or the Great Library so it's
much faster to load so if you have a
stand-alone application that uses b8 you
can modify the bootstrapper dot CC file
and include other files of JavaScript
that you have to you want to have
pre-loaded and pre-compiled that are
always available as soon as the
application starts so that's something
that is quite nice to have so well we're
running out of time but i still have
couple of remarks a as results of being
here today with me what I want you to be
aware is that it's not only c++ in
javascript engines it's it's ready to
start hacking in engines picking those
slightly sir tasks in a language that we
may know better we may prefer like
JavaScript and you can pick your
favorite engine hack on it all of them
is shown as good don't be don't be
scared of the spec ask go to the year es
discuss mailing list ask for
clarification sometimes the spec is not
clear especially yes six parts that are
still changing a bit and sometimes you
ask for a clarification and some someone
comes and oh this is not very well
specified let's give it another try so
well i hope i hope you are now all
encouraged to go how can the engines we
need more people like dude to implement
all of that must read six so thank you
for coming here and thank you for
becoming Tucker
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>