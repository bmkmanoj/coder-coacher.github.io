<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Prasanna Kanagasabei: JS Security - A Pentesters Perspective - JSConf.Asia 2015 | Coder Coacher - Coaching Coders</title><meta content="Prasanna Kanagasabei: JS Security - A Pentesters Perspective - JSConf.Asia 2015 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Prasanna Kanagasabei: JS Security - A Pentesters Perspective - JSConf.Asia 2015</b></h2><h5 class="post__date">2016-01-03</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/LVamMYljS4Q" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">good morning everyone I think it's still
morning my name is prasanna kanagasabai
I work for a company called thought
works I have been a pen tester for a
long time pretty much my I've been
speaking at a few conferences in India
started I just moved to singapore so I
just started giving some conferences
here we also run a group called the null
which specializes in hacking and
security on the offensive side on the
defensive side and I am one of the
moderators on that one I'm available at
on twitter at the rate prasanna in that
my mandatory interaction let's move to
that shall talk what I'm going to be
talking about is a today a gentleman
spoke I forgot his name sorry about
different classifications of security I
want to concentrate on one specific one
which is available because it's a
JavaScript session I wanted to
concentrate on JavaScript and one of the
most craziest bugs that we see today as
pen testers is Dom exercise things are
changing a lot in the environments how
we build stuff applications are moving
more from very heavy server-side to more
client side also so it effectively
brings that we might have an attack
vector inside the client side also so
today we have code that comes in picks
up information changes at the client
side itself which could effectively
create a dom xss one of the important
concepts on da mixes is source and sinks
we're going to discuss that also what
because it's a what I had called this
call sorry a presentation the a pen
testers perspective I would be
discussing some of the issues that I
have found some of the issues that
others are found and some things which
are very interesting some of that one
and JavaScript being so huge and
somewhere of data we want to create some
automation in there and I wanted to work
on a specific tool created by a friend
of mine and I would demo that too
this was one of the recent payloads that
I had created this is actually a payload
that gave me administrative access on
one of the applications that we were
working on it's actually a file it's a
file name this is what I'm going to be
deciphering the whole thing and what is
it what happened and stuff like that
before we get into it a little bit about
what is Dom excesses itself most of the
people understand what is cross site
scripting cross-site scripting to go too
much into it it's effectively we're in a
malicious user could send some input
send to the server process back and
comes back asses and played back on the
Dom it is effectively doing the Dom
manipulation but when a doll mixes is
the data doesn't go to the observer at
all so there is a component that is
there in the client-side itself which is
picking up this data and making changes
to the Dom itself which is why it was
called the dharmic success the reason I
like it is one of the reasons I love
this thing is there is no way servers
can detect it most of the security
mechanisms that people implement are at
the server side there is nothing at the
client side at all so you could have an
exploit gone into production and there
is no way that a security administrator
in the system can even find out about
this because the payload is never
reaching him ever just to give you a
little bit of how a simple darkness
looks like this is like a hollow world
of dharmic stresses itself it's a very
simple thing if you really look at it
it's taking the location hash which
basically is anything that you put after
the hash slicing it basically so we want
you don't want the hash you want to take
that content out of that after that and
you basically write a document dot write
which basically would make a dom
manipulation could anyone know what
would be the exploit that if you want to
do this what what would you send a
simple JavaScript actually you could
write an image tag with any crop your
traditional exercise would totally work
in this scenario I was thought I I
forgot your name sorry for that
some of the most important concepts when
it comes to dom exercise we have two
very very critical things that you
really think of source and sings that's
the simplest thing what is the source a
source is a point of entry for a ten
third input via malicious user what it
effectively means is these are places
which a malicious user can send input
into the application itself as simple as
that and what is a sink a sink is when
you take this and manipulate the Dom
it's as simple as that so one of the
fundamentals things that when I was
learning security probably a 10 years
back a very good gentlemen taught me a
simple principle security issues can be
divided into two sets when data becomes
code you have a major problem and when
code becomes data it's as simple as that
all security issues can go into these
two lines effectively if you really
think about it here most of the
important component is there are ways
there are Dom API is which allow that a
user input which a string can be
converted into a dorm component itself
that's what the fundamental problem
comes in and this where Dom exercis is
all about a very good location of what
are the source and sink says I have just
put up a very small laundry list not the
biggest one I would actually suggest
that you could go to the dharmic census
Vicky it has a more exhaustive
information on what are the different
sources what are the different things
that are available but if you really
think about it I want to spend two
minutes here to talk about some of the
evac pretty much dead nobody uses evil
these days while in my demos I have used
evil because it's easier but if you
really look out a set timeout and the
function constructor can also execute
code these also can be used as Tom sinks
that's something that keeps missing all
and the eternal most important is the
inner HTML and outer HTML these could be
effectively be used to change your Dom
which is why it's a sink there
okay now let's get into the actual fun
of things recently I was been testing
one of an application wherein we found
Adamek sucess but there were two
scenarios that were noticed here it was
basically said that the application or
this bug is detected only inside an
authenticated session we take care of a
lot of security controls in there the
application cannot be put inside I frame
so that you cannot do and self only
exercise and stuff like that so
effectively saying that hey this is a
very low priority bug here yes we agreed
sir bug but it's not a bug and the other
thing that they told me was we
understand this is the file upload which
is what I showed you a few minutes back
and they said it's a file name what will
you do maximum with this all the special
characters that you need to put inside a
file name or blocked by the operating
system how would you even create an
exploit around this so this were the two
challenges that season the problem is
that the developers did not tell me it's
a nota but they don't know yes we will
fix this issue but it's a very low
priority issue the problem with the low
priority issues it gets pushed off and
it gets slower to come in and the
application needs to go life and I was
worried that it could compromise so I
had to create an exploit before we go to
win let me show you a demo of the actual
exploitation itself so I basically
created a test application because I
can't show you the actual application
itself a lot of legalities and stuff
like that I can't show you the actual
application so let me show you a simple
thing pretty much similar like this
we're in a user would take a a file name
and the file name was being reflected so
what the developer did was he just took
the file name he trusted it and he just
placed it on the DOM and effectively it
created a cross-site scripting which is
the Dom exercise but the problem now is
the one that we discussed how do you
weaponize this exploit this is where it
came in let me show you something
how many of you know of a amazing tool
called beef okay this is beef beef
allows you to control browsers it's an
amazing tool when so a lot of cross-site
scripting and I know people think that
it's just alert boxes it's not really
alert boxes it gives me capability run
execute JavaScript that's the real
problem to prove a point I wanted to
show that hey I'm going to control your
browser so let's do this so I'm going to
take the actual exploit all right either
everything about your information of
your browser if it seemed obvious
localhost here but it could be anywhere
across the globe if if it had gone to
production thankfully we fixed it after
this demo that was done let me show you
something let me show off a little bit
do you see the CSR of token there this
was a rails application so rails by
default user CSR of protection so just
by a cross-site scripting I could
basically capture that what really was
more crazy for them was the prompt
it would actually send messages you can
craft HTML you can create whatever you
want beef allows you to do anything that
you really think about that's the power
of this one coming back to the exploit I
may go back to the presentation okay so
if you look at this how did I solve the
problem the two problems that were there
the application being internal it also
had one of the features that the
administrators of this application could
accept USB disks from people and they
could have image files and they had to
upload these images and they had to do
some work with it that was the
functionality so I had a way that I
could take my exploit to the
administrator itself second problem how
do you deal with special characters not
being allowed by the operating system
itself because I have to write a file
and put it on the USB disk and give it
to the administrator how do you solve
that problem again JavaScript if you
really look at it all I did was I made I
exploit converted it into base64 and
used to the a to b to do the job so then
i sent it to eval to execute it's an as
simple as activity as that but in this i
found some very interesting things that
came out of it evil generally supposed
to run arbitrary string which can be
evaluated as javascript i did not work
it wasted an hour of working with it i
realized that when you use eval in a
file attribute it does not work so what
I had to do was if you look at the first
one I changed evil 2 is equal to eval
and then executed it with evil 2 and it
simply works so some controls that the
browser started putting in could be just
bypassed using a simple fix like that
that was what the first exploit was
moving on JavaScript templating engines
so these days we have to work with a lot
of templating engines some of it are not
necessarily the top end of it sometimes
we even come and scenarios where people
have created their own templating
engines what are these templating
engines these are
very simple there is a piece of data
that is coming in it could be through a
jason and the developer has basically
said that there are patterns within that
he has written some patterns the data is
going to be that is received from the
user or could be whatever method is
going to be filtered and then these
placeholders are going to be changed and
basically this was a beautiful exploit
by a friend of mine called nafisa Hamid
we initially found out by a gentleman
called Mario the links are provided
there so what this basically does is
then some filtering wherein the data is
coming back and there is some filtering
that is there but how do you bypass this
filtering that is what this demo is all
about
cancel this so I have not written this
piece of application into my blog or
test application yet it's still in my
jsfiddle but let's do this one so if you
look at this piece of code it's a very
simple thing it's going to take my users
input there is a placeholder here which
is could be like your templating engine
which will change the placeholder please
notice that there is a filtering that is
done the filtering function here is a
standard filtering function which
basically will mean sure that the data
output you put in so basically this is
going to take a value and make it a
image' SRC the data if you notice the
placeholder is between two single puts
so to break out of this context you have
to break out of a single quote and then
you can pass your standard on error or
something like that which will execute
your JavaScript but please notice that
there is a filtering condition here
which basically says that if there is a
single pole double quote or any of the
angle of brackets that are there which
are what are the ones that you need to
break out of this one text are being
removed now how do you break out of this
one let's just do a small demo of it see
this one if you see this it's basically
saying image' SRC into whatever value
I've crossed it and gone now let's say
we try break out of this one the
standard one that any car side scripting
I would start with something like this
please notice it is still within the
single quotes it's not gone out how do
you break out of this context if you do
not break out of this context the filter
is actually working that means that the
country the control that the developer
has placed is actually good and it works
but there is a problem here and which is
what Mario had pointed out that browsers
behave a little different there is
something called a mutation XSS which
basically means that how let me show
this one and let me then explain about
it
please notice the difference now see
what has happened there is actually a
difference in the way the output has
come back last time the data used to
come within the single quotes itself but
this time there is a small difference
there and let's click it yeah alert nine
which effectively says I execute
javascript in your context now what is
the why was this happen it happened
because how JavaScript string replace
function works in the ACMA script the
most of the string replaced functions
take two parameters it takes one input
the output change whatever it is there
but across prepped and JavaScript our
little different they behave a little
differently what in this case what it
has done is when you put a dollar or
backtick what happens is it can't it
Matt it returns back the string that it
matched in this case the image SRC
single quote and it gives it back and
when we added the other components we
are effectively closing the whole single
time the whole image tag and because
it's a whole image SRC equal to a single
quote and then I error thing the browser
will basically render the image it will
try reading that file that is they're
effectively it's not going to get the
file so it's going to go into that on
error and execute this itself that was
the whole point see the reason being
with templating instance is what we
notice is most of the time filters like
this which thinks that the context is
within a single quote or a singer with a
double code which cannot be escaped it
is very secure but that's not the case
you need to know about how acma script
works understanding how the string
replaced on most of the templating is
actually using a string replace
functions how do you basically
understand how the system works there so
that was what it is I have given in some
more information of where it is and you
could pick it up from there and
information on that moving on this is
another very interesting exploit that
came up recently with hacker 1 and
hacker one basically said hey we were
affected by this we gave out a bug
bounty and i forgot the gentleman's name
who found it out
and there was a good amount of payment
for this one I found this very
interesting because some when you see
this you really see the power of how
browsers really work let's get back to
this one so let me create a new blog
please notice I've just created a simple
one test test just one and there is a
link to something here and that's what
the idea is and you submit it if you see
that it's a simple blog with probably
some references that are given or
something like that you click the link
did you see any change
look at the parent the parent can be
controlled the parent was effectively
127 001 8,000 port right i want to made
it go to beef I just has an idea showing
your beef project effectively I could
have created a HTML page and exploited
this guy with that beef again but I
didn't want to show that i wanted to
show something different which is why i
chose to use put the beef project itself
just to give you an idea what can be
achieved here imagine this a fake
banking application all you know it is
you went to a blog you click the link
and you see your banking and with
technology our attack sequences like tab
nabbing which is you have so many tabs
open i have multiple tabs when I work
with and he just put a fav icon there it
will look like you are into your gmail
or you are on internet browsing site
something like that an effect you could
be just giving away your credentials to
someone else how simple is that how that
was the other very interesting exploit
that I worked with the one that also
that I wanted to show on my last one
that I wanted to show about was
something called a window dot name what
is window dot name is one of the very
unique properties how many of you know
it's actually a cross-domain accessible
property okay do you see a risk because
of this yahoo had a huge DOM exercise a
long time back using this PM pacific one
it's fixed at this moment it doesn't
have it anymore but just using a window
dot name let me show you a demo it's a
very simple one by the way before i go
into this one i forgot that i didn't
show you what i did when the previous
one the previous one it's as simple as
this it was again using a window dot
opener dot location property what i did
was i just have so once it landed on the
attackers page it said that change the
opener the opener in this case being the
parent itself
so effectively you can use this a child
could basically change how the parent
would behave that is what the previous
one was sorry I didn't show you the last
time the new one that I wanted to show
you about is a very simple one something
like this where in here what we're going
to do is we are going to open a window
itself or use JavaScript's window dot
open to open another child case in this
case so the last time we were at the
blog page and we opened another
application this time we are going to be
at the attacker page and we are going to
use the blog as my victim so I'm just
going to close this go back here
please notice here the page at 127 8,000
is saying that hello to 90 80 it was 90
80 which opened up this insecure blog
right so effectively information that
the 90 80 domain set was read by the
insecure blog which is running on port
8000 the rideau it is different same 127
00 but i am sure most of you understand
about same origin policy is and it is
different domains it's effectively
considered a different domain so data
communication between the two are
controlled and restricted and
effectively what we did was we use this
component here to basically say that I
as a user I'm going to give you some
data now you as a user is basically
going to take this data and convert this
I or read this data and sorry I lost of
your thoughts there I was just looking
at the time so what it basically is let
me just go into this and show you how it
actually happened
as simple as that if you look at it even
the Yahoo exploit had a similar one two
functions if you if you think of it what
I did was in the global space it took an
even the data was picked up and being
stored inside a variable called tag but
a function called add also exists it
could be a very simple thing in the real
thing in yahoo what it happened was it
was using their ad based JavaScript
which was availing some components
before sanitization and it also did at a
different function the same object was
being filled up with the value that is
being filled in the top dot name
doctored name is nothing but the same as
window dot name it's just like an alias
there so effectively whatever is there
you could basically exploit it with it
how do you exploit this very simple one
if you notice this this is awaited you
do a window dot open you basically set
which URL you want to open and you sit
the alert function or any JavaScript
that is there and it will magically get
popped up there this could be something
that you could use to even do something
called a Dom covering attacks I probably
don't pronounce it properly what
effectively it means is that when you
can open an iframe as a child the child
iframe can set variables or global
variables inside your parent so imagine
you have an application which loads or
iframe the child I frame could set
saying that hey my flag is equal to true
what would happen is the parent has some
control or structures which basically
sees if the flag is true do some
operations the child which is an
untrusted component can do the similar
attack and change values in the parent
itself that was the power of it but you
could see with controls like extreme
options being in there you may want to
say that hey that risk is getting
reduced now
now that we spoke about all this how do
you how do you automate these things
what is the thing that we are the point
that I have so Java scripts are getting
huge today we have applications let's
say angular or a meat-eor which is so
huge the amount of time that you can you
do this manually can you go and check
every component it's simply not possible
the amount of interesting time we have
is very less but we do need to guarantee
code coverage we need to say that we are
able to at least that is to some extent
give some information saying that we are
able to fix some of these issues how do
we do it the solution is earlier there
was a beautiful tool called Dom it a
tool by stefano de pelo but it's just
that you have to pay money for it I
prefer to use folkish written by another
friend called nafisa Hamid the reason I
choose this is it's easier to use free
what more can it be better so it works
by all you need to do is it's basically
a Chrome extension you go ahead and you
put the application that you want let's
say localhost let me just use 127 this
time
and just keep browsing
if you keep noticing it will start
seeing all your sources and sinks and
keep displaying it to you see if it like
look at it it basically says that hey I
see a document dot cookie that is being
said here which could be picked up I
have a window dot name which is what
effectively that application was doing
it picks up every piece of information
it basically how this works is he's
hooked into every function that is there
and it's please note this is not being
statically done this is being
dynamically done it is at real time
analyzing what information it is there
and it hooks into the actual function
itself so let's say if evil is there it
hooks into it and it sees that what is
coming inside evil it also as the
sources it marks the sources and and it
marks even the sinks if it sees that a
source that was entered is being
detected at sync it will say that hey I
have a source and a sink detected
together and once you see it it brings
it out here and when it detects that
there is a Dom accesses the color
changes and that is one of the a very
easy way of doing some of these things
so as a developer it could be as simple
as that you know you run this
application you finish all your
application just keep running this tool
and run Europe just browse through your
application it will start telling you
what are all your sources that are there
it will also start telling you what are
all your sinks it also will
automatically start evaluating to tell
you where are all the positive things
that have actually happened where are
the actual issues that have happened in
this itself the other one that we are as
a pen tester I like a lot is I can
choose to put let's say window dot name
and say window dot eval and I can say
where are all the functions it's still
not evaluated it here basically it will
it will allow you to say huh so once
again the output actually comes to your
console so when you say identify you are
effectively what it will show you is it
will show you where all it sees that
some source that has been picked up and
it does it see a sink of the same input
somewhere else
and it helps as a mentor stuff to say
that hey what are all the combinations
of data that are there you have a chat
with the developers you basically say
hey what are the functions that you are
using I can basically put those
functions in here and weekly see so that
i can guarantee some of these controls
it doesn't take away your manual pen
testing efforts but it it helps you to
at least do some bits of it some of the
other functions too I spoke about dom
cobra wherein you can change the global
variables right you can use this to find
out what are all the different global
variables that your system or this page
on the 127 is basically using you can
see that who is using them if any
changes that are happening you can find
them out from here
but there are some known issues that are
there like I'll show you something
the same thing that I was working with
doesn't seem to work when i use okish
how do you figure that out is if you go
to your thing here it tells you what are
all the things that are hooked on you
can even control some of these these are
the parameters that you need to work
with to like in this case I might have
to tune some of these things basic
reason is my application has not been
written properly if you look at it every
time I go to the new blog I have to
refresh the page there because it's not
properly written down yet I need to make
those changes and doing some of these
things okay should be able to help you
there work with it so the insecure blog
that I have is something that I and Alex
are continues to work on it we are
trying to put in as much Darmok senses
that we find we try putting into them we
start dumping or so the idea being is we
want to learn ourselves so we try
writing our own insecurities and try
exploiting them like I'll the last one
that I showed you about how templating
engine works the idea that we have is we
could create something like an avatar
and which would update and real-time
than avatar there which would have a
simple filtering there and you could
bypass that's the whole idea and it's
available again at my github link there
that's all pretty much I have to talk
about and if any questions p % now thank
you what's the solution for that
underscore blank issue ah very good one
sorry I didn't talk about it the fix is
basically before you do a redirect
basically set the window dot opener to
null you set to the window dot opener to
null effectively this problem will be
solved that's the fix that hacker one is
it right now</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>