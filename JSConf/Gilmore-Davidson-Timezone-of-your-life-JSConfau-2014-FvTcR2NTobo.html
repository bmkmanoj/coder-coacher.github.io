<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Gilmore Davidson : Timezone of your life  | JSConf.au 2014 | Coder Coacher - Coaching Coders</title><meta content="Gilmore Davidson : Timezone of your life  | JSConf.au 2014 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Gilmore Davidson : Timezone of your life  | JSConf.au 2014</b></h2><h5 class="post__date">2015-01-14</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/FvTcR2NTobo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">Oh
titled my talk is detecting time zones
in the browser are you a freaking
masochist because time zones are hard
and time zones have had a lot of
problems with developers this joke that
goes around Twitter every now and then
you can tell the developer by just
mentioning the word time zones and
watching them cringe I will start with a
quick introduction though you'll find on
the internet generally looking like one
of the top two pictures so I'm Gil more
or less in various different systems I
am NOT your broom on Twitter and I very
occasionally right things at a site that
doesn't have a logo so I'll start with a
common problem on the web which is the
server has a concept of now and outputs
a date or a time because all right there
you go that's that's what time this
thing happened but depending on where
your users are that now isn't actually
now for them it could be in the future
it could be in the past but there's no
indication given and this is actually a
very common problem in Australia where a
lot of servers are in the San Francisco
and times that are of 17 hours behind us
on particularly useful it's even worse
when you're presented with you I that
makes you write the time for scheduling
system there's some examples there from
Bob your software if there's no
indication of what time the server
thinks that is how you meant to know
when something's going to happen so
there's actually a very very simple
solution to this which is to just not
ever show date or time it's perfect
we're done thanks for listening except
that's not actually particularly
practical so we'll try a different
solution basically you can make the
conscious choice the output only server
time and at least indicate what time
zone that's in and say alright deal with
it you work it out but here's what we've
got
but really that's not actually a
solution either it's just the problem
again so to have a look at why this is a
problem let's actually look at how time
zones work this is this is clearly a
draft edition alright so time hundreds
of years ago there was just the concept
of local time and it was based on the
Sun when the sun's at the highest point
in the sky it's noon but depending on
where you were that everyone had
different versions of local time and
this wasn't a problem that the village
down the road was eight minutes off
until you got to Telegraph's and
railways and people started traveling
long distances and suddenly it actually
became a bit of a problem so obviously
they need some work out some sort of
standardized system and back in eighteen
seventy nine I think it was some kind of
came up with the idea of well there's 24
hours in a day he divided the world up
into 24 bands works out to 15 degree
longer dude bands you just work out
where you are in the world and assign a
time based on that so it was a nice
perfect solution it was mathematical it
was precise it was easy to calculate
especially for software later on and
like all perfect solutions it remained
perfect right up until the time it met
reality and became completely
impractical because this is what it
actually looks like the nice neat bands
aren't quite so neat anymore because I
hit country boundaries and state
boundaries and politics and this doesn't
even include daylight saving time
differences so obviously there are
discrepancies when you're starting to
walk boundaries like this and this is
actually some great work by a guy called
Stefano mo kio low volumes and can
assume I'm pronouncing that right
basically be the green on this map is
where the times only is ahead of means
all the time and the red is where it's
behind so you can see Russia and China
are particularly behind
due to using the China touches I think
something like eight different time
zones across its borders because it
comportas 15 countries but it's all on
one time zone so the parts in the Far
West of China are actually three hours
behind means all the time so obviously
if you're trying to write a system based
on this it's a real headache and you
need some sort of common reference
reference point now everyone will divert
of greenwich mean time but this is a
tech conference so we use the technical
definition which is UTC so what is UTC
actually stand for well the answer is
nothing the International
Telecommunication Union and the
international astronomical union when
they were defining the standard they
wanted to have the same acronym for
every language in the world and the
English in the French of course didn't
actually agree on what that acronym
should be so in the end the compromise
was made and everyone is equally wrong
so how does UTC actually relate to gmt
well if we use javascript notation and
equality checks they're pretty much the
same it's just that you TC is more
scientifically precise if you want to
think of it in software terms gmt is
deprecated ok so we're gone looked at
the history of time zones a little bit
so now you think all right I know a
solution I can get the user to pick
their own time zone and I'll just
convert all the dates into that which
now presents other problems so my talk
is actually briefly it's mostly about
the browser but I'll give a quick toke
invention to know to make sure my
presentation is web-scale you'd set
process damage opti z equals x 0 name
and all your fake calculations after
that we'll be in the appropriate time
zone so you can the user an option to
select from a nice simple
list this is how to pick Sydney time
zone for various pieces of popular
software so as I mentioned in the slide
before there are four hundred and twenty
three times no definitions at the moment
that's there's still more being added
all the time so every time zone picker
that you give your user is a trade-off
between the ease of use and the actual
comprehensiveness of the list so at this
point you need to ask yourself do you
even really need to store the use of
preference because what what are you
really trying to achieve you're just
trying to take a date and a time and
display it in a way that's relative for
your users so what you do is you only
ever reference UTC your server stores
UTC you'll see the output to TC and as a
side note you should only ever store UDC
anyway because otherwise your day
calculations for adding and subtracting
data is going to get really hard so the
server just output to UTC and then you
convert it to local time in the browser
without actually knowing what the time
zone is this is by far the best solution
and it's used by a few popular sites
like I'm sure the github people can tell
you that's what they use in the web UI
and the really really basic
implementation looks like this you have
a html5 time element which has the
date-time attribute this is using the
iso standard date time format the Z at
the end of the string stands for Zulu
which is just another word for UTC this
of course it is
zillow actually come from a nautical
term where they had defined letters of
the alphabet for each zone that they
went through and Zed was their reference
so you grab the elements you quickly
look through them you get the date-time
attribute pass that straight into a new
date object which recognizes the iso
format but that is then converted that
UTC absolute time stamp into your local
time and you can just out put it in some
way that probably is more friendly than
to string you could use a library like
moment to get friendlier dates so do you
really need to store user preference
unfortunately sometimes you do because
you could be working with software that
needs to reference it in the back end
for some reason it could be scheduling
automated alerts so now we come to the
part what you really need to ask
yourself what you're doing because okay
you just put some times and information
in the browser surely we can just detect
it for them yeah good luck so the idea
is simple you grab a new date you use
the one method that we have available
that has anything to do with time zones
just get time zone offset and this
returns your local time minus UTC as a
value in minutes so for where we are
right now that returns minus six hundred
if it was a couple of weeks ago before
we moved out of daylight savings that
would be 660 so the idea is then you
just map the offset to a list of time
zones and do a quick look up and we're
done not at all so to understand why
this is a problem we'll take another
little detour about four years ago guy
called Patrick McKenzie read blog post
falsehoods programmers believe about
names and this was a very very widely
spread article i highly recommend right
there highly recommend you go find it if
you haven't read it this was based on
his experience working in translation
software and he's named he went by any
one of six different names and he
generally broke software whenever he
tries to use it because it made certain
assumptions about the way names will
formatted now this was referenced a
couple of years later by Noah Sussman
who wrote falsehoods programmers believe
about time and this was mostly to do
with hours minutes seconds timestamps
and include a fun example that
particular vm software if it suspended
the vm it suspended the clock and when
it resumed perhaps an hour later that
one second could have lasted an hour
this got spread around reddit and
metafilter and hacker news and he got
overwhelmed with the responses and three
days later he wrote his follow-up post
which contained 79 different falsehoods
all gleamed from user comments all of
which were mistakes that people had seen
in software dealing with time now I'm
not going to there's a full list on the
right but I won't read out all of them I
will just pick out a few of my favorite
ones like the local time will not change
during office hours which is wrong
reading the clients clock and comparing
to UTC is a good way to determine their
time zone ya know and i can easily
maintain the time zone with myself
so problem number one with time zones
stay alight saving time first of all
some countries use daylight saving some
countries time for those countries that
do not all the states and territories
use daylight saving Australia is a great
example of this when they do use it they
don't all change at the same time of
year and if they do change on the same
day they change at different hours of
the day some countries don't change only
twice a year Morocco for example bases
its dates on Ramadan so they go into
daylight savings and when Ramadan starts
they come out of daylight savings one
month so that it's easier to fast during
daylight hours and then they go back
into daylight savings for about a month
and a half and then come out again and
not every change into daylight savings
is by one hour most of them are but Lord
Howe Island changes by half an hour so
that for six months of the year in
winter it's half an hour ahead of Sydney
and for the other half of the year it's
on the same time as Sydney when City
jumps forward an hour why they do this I
have no idea but it's something software
has to account for now when i was
looking at time zones actually gave
myself an excuse to play with d3 and did
a visualization of different time zones
and their daylight savings
implementation now the details aren't
really important but what it shows is
there a hell of a lot of variation and
now we come into the second major
problem which is changing the rules
because that is make up the rules all
the time countries and regions are
constantly changing what their base
offset from UTC is russia is the prime
case of this where they are arguing
every year about whether they are in
permanent wintertime or permanent
summertime and they've changed their
minds about three times over the last
five years they're still trying to
change it again
regions can decide to start or stop
using daylight saving time even while
they were in daylight saving time Jordan
for example in March 2012 just before
daylight saving time ended always Judah
and they decided you know what we're
just staying in summer time all the time
permanently they actually thought that
it would save them electricity costs
throughout the year and they wanted to
see if it worked a year and a half later
after massive protests from amongst
others the Jordanian Teachers
Association who were worried about
students walking to school in the dark
in the morning they ended up switching
back the start and end dates of daylight
saving time they're constantly changing
and sometimes you get advance notice and
sometimes you don't and then my favorite
example is that for Samoa the date of
December 30 2011 doesn't exist so they
went straight from December 29 across
the international date line at midnight
and went straight into December 31 the
reason they did this actually made
senses they wanted to increase the
number of days they could trade with
Australia New Zealand but their nearest
neighbor American Samoa wanted to stay
trading with America and so the two
neighboring islands are now separated by
48 kilometres and 24 hours
which brings me to the big point which
is politics because this actually just
causes most of the other problems we've
seen if you want a great example of
politics Spain is currently in debate as
to whether they should change their UTC
offset the currently new TC plus one
hour but that only happened because
Franco wanted to align with his Nazi
allies and so switched at the same time
as then a lot of Spaniards don't like
this and they want to move back still in
debate there are non official rules
there's a town called you club near the
border of Western Australia and South
Australia which actually has decided to
pick for itself at I'm halfway between
Adelaide and Perth so it's they use UTC
plus eight hours and 45 minutes
the best thing about this is that the
australian government doesn't recognize
that time zone so australia actually has
eight different time zone rules but the
government only recognizes said not them
but software still has to account for
because this is what the people in that
town say they use there are one-off
changes sydney decided to extend
daylight savings earlier during the
2011-12 is one day because they had
local elections and then there's the
ones that are just made up on a whim so
the decision for jordan that i mentioned
before ah we're just going to stay in
summertime they announced that only two
days before daylight savings went to end
which actually caused havoc with
pre-printed flight tickets and they just
had to tell everyone to turn up to the
airport an hour earlier than their
ticket thankfully the airlines use UTC
and they weren't affected morocco
extended daylight saving time by a month
only one day before it was meant to end
and as i mentioned their dates are based
on ramadan which is a lunar cycle so the
dates in the future are currently does
the best guess so how do you keep up
with all of this well there is the
official iono timezone database which
was started by arthur David Olson back
in the 80s and has been kept up by
steady list of dedicated maintained errs
and it moved to iono after there were
some legal complications which did get
resolved but now it's it's got a better
controlling master and this is actually
used in most software that we use today
so linux and mac operating systems they
have this as their standard reference
windows of course doesn't they use their
own shed but the key thing is that you
need to keep your definitions up to date
because as we've seen countries a change
a dime by my count there are five
different places in your website where
these definitions could get out of date
so you've got the service operating
system the software which could just be
the programming language the libraries
that are built for that which could
bundle their own definitions the users
operating system and then if you're
adding in client-side libraries all of
these can have different definitions of
what a time zone is and what its rules
are so the question I'm asking is do you
really need to add in a client-side
library the deals with time zones having
said that there are there are actually
some people who have put an impressive
amount of work into trying to get this
to work in JavaScript moment time zone
for example pulls in the iono database
as a get sub module and then compiles it
using grunt you can select which zones
you want the the Jason definition for
but the problem is that if you want all
the time zones that JSON file is going
to be over a hundred kilobytes and if
you're loading that into a mobile
browser you can imagine especially
there's more definition comes through
that's not actually a great thing so I'm
trying to avoid the problem completely
because this is not just a historical
problem this is a list of all the IR
database changes in time zone rules
since the start of 2012 which doesn't
look like a particularly long list until
you actually scroll through it
there we go but that doesn't actually
include the latest change because as I
was writing this presentation a change
came through which summed up the whole
lot of my points really neatly it was a
hard to predict in advance and it was
really politically motivated
so two weeks ago Crimea jump for two
hours to align themselves with Moscow
but should you actually care well
unfortunately the users of your software
really might care I can tell you from
bitter personal experience so to finish
up at lessons issue tracker JIRA it's
widely used around the world and just
after I started lycian it gained the
ability to set a user timezone
preference now I felt that this feature
wasn't getting enough use of looking at
the stats on our biggest public issue
instance of JIRA and almost no one was
using the timezone feature that is so I
am in twenty percent time I wrote a
little plug in to try and detect the
timezone in the browser before I knew
all of this background and just make it
a one-click operation so I used one of
those libraries I mentioned before Jay's
timezone detect which worked really well
for what I wanted and showed a little
banner saying we think your browsers in
a different time zone from what your
preference specifies just click here and
it's set the lib the library is one
hundred percent accurate because it just
picks one major city / collection of
time zones so most of Western Europe is
just detected as Berlin which works fine
for what I wanted because the rules are
all the same it actually goes through
and has some disambiguation code for
rules the zones that are similar but
have different daylight saving start
dates and so can now work on that was
certain start and end dates about a year
later I wrote a blog post amount
developer blog showing statistical
analysis of how it had been used the
timezone feature usage and increased
16-fold in the year that had been
implemented during the time I've been
aware that the feature Whitney main
q his own updates and I've committed
back to the library by pull requests
when somewhere across the date line but
I didn't realize how bad things could
actually get so the problem started last
year when Israel change the starting
date of daylight savings time which
wasn't a particularly big deal on its
own but when it was combined with the
hard-coded date disambiguation code in
the library it caused quite a problem
but this didn't happen so Israel changed
the rules then I had to go into the eye
on our database and that had to be
compiled into software updates and then
it finally came down to the users and
when they uploaded their operating
system JIRA started telling them they
were in Gaza so down the bottom is the
the public bug that we raised about in
one of the comments where they actually
say this is both incorrect and very
offensive
now I don't know about you but when I
started in the tech industry I didn't
really have career goals of us that I'd
play it by ear but I'm pretty sure that
if I did have career goals that on that
list would not be increased political
tension in the long-standing conflict in
the Middle East so obviously couldn't
just let this go ahead fix it and the
quickest way would just be submit a
fixed the JS x undertake library try and
work it out two problems with this in
the year and a bit since i first wrote
the feature the library had had a
refactor and had removed an API that I
relied on so I couldn't just quickly
patch it and the other one was that I
realized this could probably happen
again in the future with a different set
of countries so it was actually time to
just completely rethink the approach so
some basic architecture is this how it
was working I would check the user
preference at the head stored in zero
call out to the detection library if
they differed give the user an option to
set the new zone and the way JS x
undertake actually worked basically is
that it will create a date in January
and create a date in june to compare the
gene to us or the UTC offset and if they
differed well that country had daylight
savings and they could be further
calculations from there so what I wanted
to do is actually get rid of that bit
and we already had times and definitions
on the server so I started detecting the
offsets myself asked JIRA back end to
find all the zones that it had defined
that matched that offset pair and then
show the user list so that I could
select which one was relevant to them so
this is the newer version not zoom in on
that so that's for where we are right
now and for anyone wondering curry is a
zone for an island in the best rate but
all these for zone definitions he have
the exact same time switching but they
have their
own names for historical reasons so
obviously we're this working one hundred
percent correctly still relies on the
backend having the right definitions but
we already had that problem anyway and
now if things are going to be out of
date the front end of the back end or at
least add update in a consistent way and
there are extra hassles I found while
doing this so automated testing you can
never be sure what time zone you're
build server is running in so I tried to
mock the date object and given how many
different arguments its constructor can
take that not a good idea so in the end
i actually just created an abstract
method i can called something like get
off set for month and then I just mopped
that to return hard coded by using my
tests manual testing when you change
your computer's timezone so you can test
that the features working properly
firefox gets the update just fine it
changes its own in you date calculation
to find chrome just ignores it
completely but that's actually better
than what it used to do which was reset
to UTC the worst part though is when you
have changed your machine time then you
forget to change it back and wonder why
all your instant messenger conversations
are logged at two o'clock in the morning
windows as I say it doesn't use the eye
on a database this wasn't specifically a
problem for me with the giro
implementation but other software
providers do actually have to worry
about this there's a standardized
mapping between windows time zones and
iono tongue time zones and then mostly
similar but there are some discrepancies
and I had some people ask me that I why
don't you just try and detect their
location yet so if you think timezone
disputes are bad don't even start
looking into border disputes
basically windows used to have a map for
selecting a time zone in software they
removed that because the number of
people who complained from India and
Pakistan about where the border should
be on the map just four senators go nuts
screw it we're just taking it out and if
you worry about a hundred K of just time
zone definitions I can't imagine what
the polygon data for timezone shapes
would be so I'll just finish quickly
with some big takeaways and as an aside
if you do a google image search for
world record food it's really disturbing
so the first one is do you really need a
time zone or do you just need to output
the time in a way that's relative for
the user most of the time or you're
going to need is just relative time but
if you are going to do a time zone make
sure you do it properly which brings me
to the next point which is don't ignore
history despite what some people in the
JavaScript community might think
problems existed before JavaScript and
problems were solved before JavaScript
we are not special time zones are really
freaking hard and a lot of people have
spent decades trying to make them easier
for everyone and we should learn from
their work thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>