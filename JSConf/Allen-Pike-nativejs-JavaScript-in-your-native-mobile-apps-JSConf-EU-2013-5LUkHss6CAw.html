<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Allen Pike: native.js: JavaScript in your native mobile apps -- JSConf EU 2013 | Coder Coacher - Coaching Coders</title><meta content="Allen Pike: native.js: JavaScript in your native mobile apps -- JSConf EU 2013 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Allen Pike: native.js: JavaScript in your native mobile apps -- JSConf EU 2013</b></h2><h5 class="post__date">2013-10-10</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/5LUkHss6CAw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">you
so i am indeed alan pyke i work at steam
clock software all the way in vancouver
canada and what we get excited about is
building delightful apps that's what we
do that's that's what we're passionate
about that's what gets us up in the
morning and although we often do that
using native technology on iOS Android
and generally mobile platforms we also
really love JavaScript we use it on the
server we want to use it as much as we
can in our apps and so that's why today
we're going to embed a JavaScript
runtime it's going to be a lot of fun
and we're going to do that so that we
can embrace our platforms an ableton
kering render native OpenGL mixed
JavaScript and native code and share
javascript in between native apps so
that sounds fun right let's do it so the
motivation behind this all of why are we
even looking at native technology is to
build delightful apps so what do I mean
when I say that I mean not just apps
that work that do what they need to do
but apps that are really cool apps that
are delightful that have a fascinating
you I that performs extremely well
beautiful touch interactions they're fun
they're quirky and that get people
excited and say how'd they even do that
or how do they even think of that you I
it's just so so great to use and so
that's what gets us really exciting is
is blowing people's minds and often that
means that we need to reach into our
native UI toolkit sore OpenGL or some of
these other technologies to do that but
we still want to use JavaScript as much
as possible so we're going to embed a
JavaScript runtime it's going to be a
lot of fun and it's really easy all you
need to do is get clone v8 so that's
pretty easy and then you just check out
the build steps go through that few
hours later you have v8 bill on your
machine it's really awesome and then
you're going to consult the VA and
betters guide which has a lot of really
handy information for example note the
handle stack is not part of the C++ call
stack but the handle scopes are embedded
in the c++ stack handle scopes can only
be stack allocated not allocated with
new
you know what on second thought let's
not do that I'm going to tell you a
story instead so some time ago remember
for five months ago steam club we were
browsing through the WebKit repo as you
do and we were looking at what would be
involved to embed javascriptcore into
our apps and Nigel Brooke he came across
something really interesting a series of
commits and these commits started on New
Year's Eve everyone else is out partying
drinking get getting crazy and some
Apple engineers were getting crazy as
well but they were getting crazy adding
something very interesting to
javascriptcore an object to see API so
Nigel finds this and he soars like hey
cool look at this I'm like oh my god we
have to write about this we have to
build stuff on this we gotta like you
know we got to pull this out and so we
did we wrote about it and we shared sort
of a hello world project on github and a
lot of you thought that was really cool
and gave us some great feedback on it
and we're really excited this finding
this thing in the woodcut repo though
didn't answer the questions though that
we had the really big question which is
why are they doing this what is this for
is this something that's going to ship
in one of the operating systems and if
it is which one well thankfully just a
few weeks later maybe about a month
later came WWDC and with WWDC came a
giant NDA it was great of course it was
this is the iOS 6 India the Iowa 7 NB a
looks like that so it's a little bit
different
the effect is the same though which is
the apple doesn't want as publicizing
stuff about beta api's which might
change or might go away entirely which I
totally understand thankfully for all of
you Jas conf EU comes at the exact right
time because on Tuesday apple announced
Iowa 7 they released it its GM it's done
and all the api's are final um so i can
actually now confide in you that on iowa
7 as well as mac OS 10.9 there's a new
API it's a public api called JavaScript
core framework and that's built right
into the operating system its public is
maintained by Apple and it's an
objective-c to JavaScript bridge hey
cool a free JavaScript bridge so what
does that was exactly mean like what
does it JavaScript bridge look like well
ideally a JavaScript bridge let's
javascript be JavaScript right on your
Java scripts will still you know if
they've done their job right your
JavaScript will still look like in the
JavaScript you would normally right
except that you can interface with
native code um so let's take a look at
some examples what does that what does
that look like so we've got a JavaScript
function here JavaScript's really great
at math so we want to help objective-c
code do math with JavaScript because
just so great at it so we define a
multiply function and it looks just like
a multiply function it's what you would
expect it's cool so so that's cool and
now that we've defined that an
objective-c we can go evaluate that
script so weeds this thing called JS
context I've instantiated one here I
evaluate the script and then I can reach
in to that JavaScript context and pull
out the multiply function once you have
a handle on an injective see you can
call it i'm using this so-called with
arguments thing if you're not familiar
with Objective C syntax is crazy like
basket of at signs and square brackets
in the bottom right corner is passing
arguments into into this JavaScript
function so what I'm defining here is
native objective-c number types they get
passed over JavaScript and Java Script
can work with them as number as just as
they would expect and then when returns
back to objective-c we can get that
value out of JavaScript and we can cast
it to
integer or whatever so are statically
typed and our JavaScript world they work
well together so that's great our
JavaScript looks like javascript what
happens if we go the other direction so
let's take a look at that same multiply
function and objective-c it's beautiful
so I don't know maybe that's why we're
writing JavaScript instead of a check to
see if we can this is actually the the
block syntax injective see for defining
the exact same thing that we did in
JavaScript and you get used to that and
it makes sense it's just takes two
integers multiplies them returns it it's
great so we define our multiply function
in objective-c and then in exactly like
we did in the last example we can reach
into the JavaScript context and then we
can actually we can just guess a ok hey
I have to find this thing called
multiply you have it and now you can
work with it so in JavaScript it looks
like as simple as it could possibly be
we just have multiplied and and when we
call that multiply we passed into one
and two they get cast to inside the
director seaside we got a multiplication
back and I'm in JavaScript so that's
pretty cool right like you know we got
we got JavaScript right to see going
back and and for a one-line or multiply
obviously that's not going to like you
know shake the world or change anything
fundamentally but it sort of gives you
an idea of what this API can do so how
do we do it what's what is the API well
there's three main classes that you care
about if you care about this API and the
big one is jas context so basically
loads of JavaScript p.m. and you can
throw a JavaScript files into it and
it's what we're using to reach in and
take objects out of the JavaScript
runtime at the JavaScript context into
the objective-c world and put them back
so this is kind of your workhorse class
on but then there's two helper classes
that allow us to go in each direction
there's something called jsx port which
is a protocol a protocol is objective c
ism that basically is an annotation so
you can say hey this this particular
this particular objective c class I want
it to be bridged over the JavaScript
side so it's really easy to do that for
your own classes it's basically trivial
there's a little bit of oil play if you
want to jas export an existing objective
c class that you don't have
you don't have the source for but you
can write a script that will automate
that and that's something that we're
planning to do ourselves so so Jay s
export and then going in the other
direction we have Jace value and so Jace
value is a object for encapsulating a
JavaScript value in the objective-c
world because of course like you can't
have these like crazy type listings in
an objective c we need to make sure that
we know exactly what's going on with
them so JS value lets us hold on to
javascript types and cast them to
various things so so that's all very
cool what is that what does that bring
us you know so we've got all these
things put together what is the equation
here we got javascriptcore right and
we've had JavaScript Cora mobile for a
long time it's part of mobile safari but
now we can instantiate it without a
webview I'm using public api's we don't
have to actually go through that build
your own a package your own so that's
cool we don't have the the memory
overhead or or the start up overhead of
starting webview and we also get this
nice bridging functionality which is
cool so that's that's what we get that
we like there's something that we get
that we don't really wouldn't have
really missed we didn't have it and then
society of reference cycles so
objective-c is not garbage collected
it's a a reference counting language and
the compiler automatically counts
references for you and it cleans up
memory when nothing is pointing to it
but the the key is that it only cleans
up memory when nothing is pointing to it
so you could have like a two objects
that point to each other and if the rest
of the object graph doesn't point to it
then the the runtime is not going to
know that that's a reference cycle and
it needs to be garbage collected um so
that's something we don't normally have
to deal with in JavaScript and so if
you're not familiar with working with
Jeff to see and you're sort of
experimenting with this I recommend you
check out the wwc video from this this
past June on how to avoid it's generally
on this javascript stuff but I the kind
of gold in there is avoiding reference
cycles so that's kind of annoying but
what do we get in return we get this
more flexibility right and we get all
these new new things that are easier and
and we can do stuff like instantiate
multiple JavaScript context and having
them having them run on different
threads really easily
and we actually suspect that it may be
possible to instantiate a JavaScript
context have the JavaScript get parsed
and then write that out to disk and then
restore it later for faster startup
times so something we want to experiment
with and this is the kind of stuff that
like you try to do that with a webview
like oh god helped you so I mean maybe
it's possible I don't know but all this
stuff comes together to make for some
delightful possibilities there's stuff
that that we're not exactly sure I mean
this thing like iOS 7 coming out
basically now right so we don't exactly
know all the things that are going to
shake out of this but there's definitely
some really cool possibilities so what
kind of possibilities one this dear to
my heart is embracing our platforms and
when I say that I mean you know the
different mobile platforms that our
users are using and the ones are you
they're using for particular reasons
right and as web developers especially
when we're building like in a webview we
tend not to we sort of pave over the
differences in between each platform
right partly just because it's a pain in
the butt to to make your your web app
feel like the the local operating system
and so for example like maybe we did all
this work to make our iOS 6 app look
it's like a web app but it looks like
iOS 6 and then Iowa 7 comes out and
kicks us in the nuts and it's like okay
everything's completely different right
like and and sometimes it's not even
that that hard to do right like iOS 7 we
got these white backgrounds type heavy
layouts focus on images flat rectangles
blue text you can click it's really high
tech stuff right you know or it's the
web from 1997 right it's it's not like
we can't make these things happen in
webview there are things that are hard
though right like it has these
physics-based gestures and it's
beautiful 3d effects we got this 60
frames a second scrolling on all these
various places while doing a real-time
blur operation on mobile on like an
iPhone like 4 4 s class hardware and
highly responsive touch you know all
these cool things and so it's it's kind
of you know controversial like oh yeah
you can't make yeah you can do some of
these things on mobile as possible are
you going to get great performance are
you going to build adlai flap probably
not maybe not at least not yet
so so so what is that what does that
mean that's our iOS 7 so that means that
if we build with a native UI or at least
as much as makes sense for any given tap
then we can have these native looking
and feeling things that will conform to
what the users want and what they expect
on any given platform but still
potentially write a lot of our code in
JavaScript titanium obviously has been
barking up this tree for a long time
appcelerator guys and I think a lot of
us have played with titanium I've played
with it before and i find it can be
pretty heavy I've been quoted as calling
titanium a 500-pound monolith of eclipse
and licensing which is kind of mean
because technically it is not 500 pounds
it's 211 megabytes but these guys are
really smart and they understand this
problem and when they saw the the new
stuff that Apple was doing at WWDC their
minds were blown and they promptly
actually embarked on a complete rewrite
of titanium to take advantage of this
approach I'm they're actually going to
javascriptcore on every platform porting
it to Android and 40 javascriptcore to
windows as well and they're also
building something called Hyperloop
which is a compiler from JavaScript into
native code on each platform I'm so
they're going totally crazy with this
like JavaScript bridge stuff and then
you know you're writing something is
because titanium like how long is it
gonna take I don't know however how many
months or years but it's definitely
worth keeping an eye on what they're up
to if you're interested in this stuff
because there's a lot of cool there's a
lot of cool thinking and prototyping
going on there at the EPS elevator so we
general want to enable tinkering right
and native apps historically not that
easy for people who are not coders or
not really up on necessarily you have
senior level people to like tinker
around and just play with your objective
c or c or your your your native app and
this is something that you know other
industries have been doing for a long
time right like if any of you familiar
with the games industry you know about
lua right louis this little embeddable
language that most games nowadays have
some sort of scripting facility for a
I or four levels or various things that
they are not necessarily performance
critical to the app but they are there r
it so the written in lua so they're
easier to toy with and you know level
designers can edit the lua without
having to build this giant C++ project
well we can do exactly the same thing
but with JavaScript right because Java
scripts incredibly performant dynamic
language and it we get this bridge for
free and we can also embed the
JavaScript runtime in games and anything
else that we want to so that's a really
interesting way to enable tinkering um
but when I think about enabling
tinkering the story that always comes to
mind is the story of this this is the
mac calculator from the original
macintosh it was up there it looked
exactly like this all the way until Mac
OS 9 so like for 15 years and the way
this calculator came about it didn't
originally look like this there's an
engineer at apple whose employee number
eight at the time but he was still like
he's like a high when he was 14 or
something like that and in the
development of the Macintosh in 1982 um
he wanted to do this calculator to show
off the new drawing code that the
Macintosh was going to ship with so we
hacked something together didn't look
like this and he showed it to Steve Jobs
it seems like this is like these
fonts are wrong this pattern is wrong
that the buttons are too big like I
change everything so Chris goes and he
changes everything I an exit he shows it
to Steve and Steve's like oh this is
 this is wrong the fonts wrong blah
blah blah you know potentially even
contradicting things that he told them
to yesterday so after a couple
iterations of this Chris gets wise and
realizes that he's not he shouldn't be
building what Steve a sims to build he
should instead be building the Steve
Jobs calculator construction
construction tool kit so that's what he
built um so this is this beautiful
application his purpose was to let Steve
tinker with all these various values and
the shadows and fonts and outlines and
stuff like that and and he did in 10
minutes later they had the calculator
that we just saw that shipped for like
15 years um so I thought what better
demo for something for technology that
makes it easier to tinker with
applications then a calculator so i'm
going to show you the calculator
so this is the iOS simulator this is
nothing because I'm not mirroring pardon
command f1 cool i'm totally going to
press that it does nothing unless i suck
at pressing command f1 but my
understanding of oh it's command
brightness down not kind of fun ok cool
so this is that the iOS simulator and
I'm going to make it a little bitter for
you guys and it's the yay so this is the
iOS simulator and this is iOS 7 um and
ok cool a calculator right guys have
never seen a calculator before so i'm
going to show you kind of how it works
58 that's really cool and so we can do
all the sort of things we can like
guests or thinks in memory and clear
them and restore them it's a cool little
demo app that you guys can check out on
github and see how we've built this but
this front end is entirely native UI
right if we take a look this is built an
interface builder there's no JavaScript
code that's assembling the UI it's
entirely done in insert our native tools
in Xcode so all when you know Iowa's new
versions come out we get all this sort
of new functionality and stuff that we
get in the developer tools but we still
have this thing running here in in
JavaScript that all of the logic is
written in JavaScript I'm so you may be
skeptical that the logic is running a
java script so I should probably prove
it to you um javascript is pretty good
at math so let's let's take a look so
let's see what this equals yeah yeah
that's that's right and a JavaScript
interprets numbers starting with a 0 as
octal because that's pretty cool so
let's see what this equals yeah cool
okay yeah so it's JavaScript I'm so
we've married the power of objective-c
with the math power of JavaScript and
created something pretty amazing I think
you're all gonna want to check it out um
okay so that's fun let's undo my full
screen meeting cool a calculator awesome
so you can check this out on github we
push it live now steam clock / Jas calc
and i'll post the slides obviously after
the talk and that's really cool really
impressive you can do a calculator you
know it's more impressive though is
rendering native OpenGL so it's kind of
opposite ends of the holy crap spectrum
and when people hear OpenGL they tend to
sink games but there's actually a lot of
really great uses for OpenGL for
rendering non-game applications this is
something we built recently steam cloth
called the map the internet it's 3d you
can you can interact with it you can
zoom through time and see the history of
the internet you can do an interactive
trace route it was actually Angelina
that that wrote the the traceroute that
goes through the internet in 3d and so
it's this crazy 3d application and we've
built it with c++ and opengl on each
platform but there's no reason to the
logic that is non performance intensive
needed to be written in c++ and we
realized that now and if we were to do
it today we would probably try this
JavaScript bridge stuff um we're not the
first people to think of embedding
javascript in an OpenGL app though
there's this thing called ejecta that
you guys may have seen and it's related
to the impact project so dynamic
dominicks jablonski who wrote bio lab
disasters like with the first html5
html5 games that was actually like
really worth playing he's built this
thing that's actually a native
implementation of canvas audio and WebGL
that you can deploy
to to iOS and run all of your existing
like sort of WebGL game that runs in the
browser you can run it run it on iOS and
you know this is possible in like a
webview well not WebGL but the
performance implications of this are
that it runs way faster and with
substantially even more dramatically
with a lot less memory overhead and so
you're still using the same open
technologies is it using the same is
easing the same API is WebGL and all
that kind of stuff but with a native
backend and you know obviously don't
have WebGL in a webview on iOS yet
anyway so it's a nice sort of polyfill
um so so in general there's all sorts of
cool ways we can mix javascript in
native right so for example you know
with steam clock we tend to build apps
this way right we have note on the
server which is great obviously we want
to have script there and then we'll end
up building a native sort of logic layer
and a UI layer and then a native logical
error and UI layer in H platform okay
well that works fine but it's we're
writing Java and then you're writing
Java right so let's not do that let's
write the logic later in JavaScript
right so we got the the models and
controllers in JavaScript and the UI
layer for the views in native code and
that's great if your your UI is the
intensive part of your application but
what if your UI is really simple at some
enterprise app but you're doing some
intensive number crunching or video or
something like that maybe we do it the
other way around right we use web views
we use HTML on the front end and then we
have a native layer for our models and
controllers right or maybe we build
something like a Cordova webview or we
use corto de Cordova webview so most of
you are familiar with phonegap Apache
Cordova and well they have a component
where you can drop Cordova into your
application so it's sort of side by side
you can have your native UI code your
native models and controllers and then
you can also have your your web
technology or your web view model some
trolls in JavaScript and so my point is
that however you mix these technologies
if they're the right solution for your
app then they're the right solution
right like even if this is the right
solution for your app right that's
probably not the right solution for your
app I would not recommend
that particular architecture but the
point is that there's lots of
opportunities for sharing JavaScript we
want to share javascript in our in our
native apps so of course we built this
demo I'm showing showing the the
calculator on iOS but we will be totally
remiss if we didn't get running on
Android right thankfully there's
something on there's a JavaScript
runtime called rhino which mostly
probably been heard of it's been around
for a while but it's written in Java so
it's extremely easy to embed on Android
so I'm just going to quickly show that
to prove to you guys that I need to do
my little dance again so i'm going to
show you guys this thing running an
android um cool yeah an Android okay so
this is his accent calculators uses the
exact same JavaScript but is again built
with a native UI and so just in case you
guys are still skeptical of my claims
let's type 16 9 s 1 2 3 4 5 6 7 8 9 10
11 12 13 14 15 16 and see what that's
equal to write 10 twin quadrillion yeah
okay slow clap okay great so um this
this is still on github and you can try
that out on both platforms what's the
point of all of this what's what's the
takeaway I've shown all these different
offices you know demos and ways that we
can use JavaScript we can mix transcript
I just want to encourage you to try
embedding a JavaScript runtime whether
you go through the VA instructions
whether you use the iOS 7 api's you
embed rhino you read javascriptcore try
it out so with that I encourage you to
go out and go build the life laps
you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>