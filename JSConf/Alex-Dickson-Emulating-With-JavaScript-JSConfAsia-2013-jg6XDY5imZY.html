<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Alex Dickson: Emulating With JavaScript - JSConf.Asia 2013 | Coder Coacher - Coaching Coders</title><meta content="Alex Dickson: Emulating With JavaScript - JSConf.Asia 2013 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Alex Dickson: Emulating With JavaScript - JSConf.Asia 2013</b></h2><h5 class="post__date">2013-12-12</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/jg6XDY5imZY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">good afternoon are we talking about
emulating gaming consoles of JavaScript
so Who am I on this guy named Alexander
Dixon I've got a Twitter like some
people do I'm not an emulation expert so
there's that one here written an
emulator for yep should probably come up
here and finish this for me so I'm a
developer atlassian which you may know
that make bitbucket 0 you might use them
so so let's do our JavaScript today it's
pretty fast which is always good when
you want to write something like an
emulator it's got really awesome browser
api's the inputs and outputs you can get
are pretty awesome so let's talk about
them we have the canvas element Web
Audio API gamepad API type to raise
quite performant things for animation
like requestanimationframe but things we
don't have our sane implementations to
some of these for example that yeah what
I'm what Miguel mentioned earlier is the
Firefox gamepad API users events but the
WebKit one you have to pull which
doesn't isn't always so great so what
can we build with all this gear we could
build some awesome practical stuff like
we've seen earlier you could do
something almost complete useless and
write an emulator so why would you what
would you want to do this when there's
problems you could be solving practical
problems well because we can of course
so you might be wondering what an
emulator is so wikipedia tells us so
when you won't refer to emulate like
this we talk about taking a existing
system and implementing in software so
the original program so that hardware
just work normally and what kind of
system can be emulated but the church
cheering thesis says that on anything
that can be okay anything can be
programmed such as a hardware Kimmy can
be redone with another language or
system basically it says any
can be emulated given enough time and
memory so there's three major types of
highway emulators there's interpreter
which runs the system as as the system
runs via software there's dynamic
recompilation which will take a list of
instruction and translate them directly
to the top the target machine code and
there's static recompilation which is
pretty much impossible due to things
like self-modifying code and fertile bit
emulators they're kind of a bit dodgy
from a legal perspective because
Nintendo don't really want you to go and
make emulators so you can always do at
your own risk and use free programs be
careful like a mega man so how would you
start this journey well you'd have to
pick a system of course so you might
pick the a Game Boy you have to discover
what components that uses such as what
chips it uses how its display was driven
what inputs it had so then you go find
technical information and all those
sorts of things and this this is
required for formulating it so there's a
really basic system called chip 8 and
this was a actually a vm and those two
back programs most which are games and
the great thing that you paid is it's
super easy to emulate so it's a great
starting point so the cpu limits of
instructions the graphics are either on
or off there's only one audio sample and
it's undefined so you can you can make
it up and we'll give you a look at that
so this is a chip a system let's load in
a program tank looks good
I'll attempt to play uses 16 different
inputs so it's kind of hard to figure
out something bloomies meant to be an
enemy but it's not doing much mmm let's
try that again yeah we remember Tetris
so this is this is all powered by
JavaScript and it's just implementing
the original operation codes that these
are programs contained
so a more complicated and more exciting
system is a nintendo entertainment
system which you pull your recognized or
you may have seen it looking like this
which is the famicom so whose play this
before oh good to see so here's an
investment for it you haven't played it
yet we can plan on my Nintendo
Entertainment System it's the legend of
zelda and its really rad those creatures
from gas are pretty bad akhter Oxitec
tags leavers too with your help I hear
upholstery yeah Michael like yeah it's
okay wiki wait awesome thanks a Nintendo
Entertainment System your parents help
you hook it up The Legend of Zelda sold
separate so so as you can see it's
pretty awesome you'll just bust out
rapping as you're playing so let's talk
about the system it's got a custom CPU
based off the 6502 it's got two
kilobytes on board room to kilobytes
video ram 256 bytes of object attribute
memory ram and twenty eight bytes of
pallet ram and that will make sense as
you listen on it's got a custom-made ppu
which is responsible for rendering the
graphics from memory and as we have five
sound channels and the best part
possibly the awesome rectangular
controllers before ergonomics come in
and play obviously so the how this all
fits together is the von Neumann
architecture where we have a common bus
that lets us communicate between the CPU
memory and peripherals so what we want
to do is emulate each of these little
yellow things and just have some way for
the code to communicate with them which
will act as a bus so let's go more in
depth with the CPU so CPU when you're
Emily it's basically a loop it just sits
it just runs grabbing instructions
decoding them and X unum so are these
instruct the instructions we call op
codes so the inexact codes perform tasks
to update the system state and there's
many that that do many different things
so this is the
the nessus if you it's the recoil
there's two different flavors depending
on the location and it's like it's a
custom 6502 because it has audio support
but no binary coded decimal support I'm
it's a bit processor with a 16-bit
address bus and runs at 12 megahertz
clock speed so something like the
fastest by today's standards there's
plenty formation about it because a lot
of hackers have emulated this so it is a
great thing about doing this one is it's
plain information so finally the system
JavaScript here's how you may implement
the CPU and JavaScript so we have a
constructor function here and we've just
listed out all the registers initialize
them as null and then we call a method
called reset which which will basically
just go and set these to the initial
values so that that's kind of how simple
it is to start off an emulator start
start emulating a system so CPU needs
memory so let's talk about that so it's
basically can't in contiguous block of
data that can be addressed and written
to depending on the type the nest memory
had two kilobytes on board and these are
divided into things such as zero page
the stack and just more general purpose
memory and there's also memory that can
be accessed on the carts so to address
about the 10,000 and the program Rome
that you plug in one of these guys holds
the program instructions sound and
graphics title so when you're dealing
with big blocks of memory with
JavaScript they can be if you you're
represented this as an array it can be
quite slow and where the emulator
performances is pretty critical so you
can use typed arrays which are
relatively new thing so you represent
the memory as one big typed array you'll
get perform performance increases
because it makes it makes it easier to
reach any offset
there's information on them at this URL
so i recommend having a look so here's
an example of a typed array working it
as our memory so if allocated enough
memory for the cpu here and then we take
a view onto that memory which is a um
unsigned integer which is what the the
nurse works in so with an NES there's
the memories mapped every where for
example to communicate with the PPU you
write you read from a rail I wrote to a
specific memory dress and a highway
would take that over to the picture
processing unit so instead of writing
just modifying the array directly you
need to write some helper functions
which would go through and do all the
magic for you and it's especially
important when you have a complicated
game cards which which extend the memory
via bank switching so now go memory
other way let's talk about decoding the
instructions in the CPU so the first
thing we need to do is check for
interrupts and these are little things
that get set which which makes the
processor go and handle them immediately
so for example with NES before a screen
is drawn there's an interrupt that you
can you can that's defy it and you can
listen to that and go ahead and paint
your screen so when this happens you are
you read the memory of the program
counter you go stall that somewhere yeah
so so is more general fetch decode loop
so you read the memory at the program
counter which is a little pointer to
where you are currently in the
instructions you decode the addressing
mode which is how how the the argument
is is encoded and then you process that
opcode so to go further into interrupts
as I said earlier there a little special
signal that that interrupts the normal
execution flow so when this happens you
you put the original PC in the processor
status on the stack and you go and
attend to this interrupt so the way you
can handle this again it's it's pretty
simple you just list them out before you
emulate a cycle you just simply go ahead
and check
if any interrupts been set if it has you
can just call out to a new method that
handles them and you might think this
code is not that JavaScript II you can
make it right it better so I thought
maybe I'll try to write this with some
more new jersey of stuff but
unfortunately it's far too slow and
that's how you basically have to write
your JavaScript like your writing C or
something because then is new stuff it's
just unfortunately too slow so when you
got these op codes so you you read the
location of the program counter from
memory you then look up the up code in a
big table that you've implemented to
find out what the instruction does now
you find the addressing mode which
describes how its arguments encoded and
then you process that of code and then
you mostly then increment the program
counter to the next one so again all
these parts are pretty simple there's
just a lot to write down so we have this
method courgette opcode where we put the
piece of memory at a program counter
pass it to that then we find the
addressing mode and we just basically
list them out and describe how that work
so then emulate writing emulate is
basically just reading the technical
specification of the system and
implementing it in code so these
avocados I've been mentioning see you've
got to become pretty familiar with them
so i recommend reading the paper a bunch
of times taking it with you really in
the shell and when things aren't working
debugging is can be quite hard so you
really want to get quite familiar with
it so you know making simple mistakes
and of course when you're not going to
write just keep trying persistence is
key so implementers opcodes is again
it's pretty simple where you just look
at what the type is in this case it's a
jump and all the jump is it set see the
program counter to a new address that's
a really simple one the problem is
there's about 150 instructions or with
potentially about six or seven dressing
modes so you need to
implement quite a bit of stuff there so
now you've got your cpu running smoothly
you want to move on to the next part
which is the PPU which is a picture
processing unit and so this generates
video signals from memory on the handle
sprite scrolling and the colors
basically anything you want to rent to
screen it uses it has two different
chips depending on the area for
different refresh rates this is it down
the bottom it's quite a nice looking
chip so it's got two kilobytes of RAM to
it can support eight by eight or 8 by 16
tiles though in practice stay by 16
almost never used and you can render
resolution of 256 x 240 which can be
clipped depending on the the screen res
on the target screen resolution so I'm
communicating with this ppu is performed
by memory maps from the CPUs addressable
memory so when you write or read to
these that the hard way actually goes
out and and affects the pp user
registers and that the pixel tiles which
you use to compose a picture of their
store on the character Ramallah cart so
with a palette of colors yeah 52 colors
which is two pallets of background and
and sprite 16 bytes each but do some
limitations you can only use about 25
colors on screen at once so when you're
rendering a picture it's composed of
tiles each one opposes 16 bytes do the
way it's encoded in memory a bit turned
on in the tile represents a a color in
the palette index so in the way
determine this is you get the first 8
bits and then 8 bytes later there's a
second 8 bits that you merge and then a
lot further down there's there's the
higher parlor number so if you look at
this number here and you imagine the
letter what the number one sorry is a
strange yellow color and it's a bit
simplified you could render this which
is a na bhaye at all
so these tiles are great we need to
compose them into a pig you know a
picture in order to get getting on
screen so you have bites which index
this these tiles I'm you have a 32
horizontal and 30 vertical which matches
the resolution discussed earlier and the
difference between after is nice if your
tiles is some extra color information
which thing is combined with the
previous tile information to generate
new color so nothing is really is really
wasted here so this would become clear
when I show you an example so if you
look here at the zero offset we have a
bite eight bytes later we have another
bite and the first part of the object
rebuke memory holds a a second number
and these are you grab this one put it
here grab this one put it here and you
can probably guess you throw them over
there and that gives you a final color
index into the palette and of course
doing bit stuff in JavaScript relative
straightforward you just end it with
with this number in order to get the
part you want shift it where you want
and then just or it with the other bits
and that gives you the final number of
course the pp use pretty complicated so
this is a pretty high level overview so
if you want to know more of course the
Internet's there it's got plenty
formation and when this all comes
together you end up with an
action-packed picture like this so let's
say you how you put it together a arm
put together an emulator but I want to
talk a bit more about the browser API as
a show up you this so playing playing an
emulator in a little window is not
always so great so you often want it if
you can use a full screen API you can
you can get a much better experience so
the the full screen API of course has
the prefixes everywhere so you want to
make a polyfill which goes and tries all
the different prefix versions here's a
simple example and I'll show example of
chip 8 so let's load up invaders go full
screen
there's a button here that does
something
yeah the 16 different input so it can be
quite hard to figure out which ones do
what so I pongs can't board on your own
so once you've got your your graphics
done you put one look at sound and san
information is a lot harder to come
across online I love emulator authors or
ones that are that aren't too interested
in producing a Polish won't just leave
stand out altogether so Sanders does the
vibration of their riches
representatives waves with a frequency
and amplitude and the frequency is
simply a number of phase changes per
second and the amplitude is the volume
of the wave measure in decibel so the
nes has sound onboard the the cpu it's
got five sound channels to pulse wave 16
volume levels and I supports pitch
bending so can anyone recognize this
song
well you couldn't hear it by yours
battletoads which is an awesome game
once you finish the emulators first
Roman should play of course look don't
let trade West know and so the audio
processing unit again like the PPS got
registers maps in the addressable space
it's got a couple of different channels
for for bass sounds treble sounds random
noise and a digital channel so you can
actually encode samples with the Nets
but I was really done Judah the rumor
took in the the low encoding had used so
here's how a pulse wave worked here's
your volume here's a low order bits
here's a high or bisque and and here's
some math you do to get something so
let's have a listen
so I didn't have time to compose an
actual song so I'll just run through a
sine wave but here are those parts put
together you can hear the noise channel
being used for symbols there and the
kind in here there's a square wave there
for the drums for the kick drum slow and
this is all possible based on the Web
Audio API which is based on audio routes
in connecting these different nodes
together it's pretty awesome for
emulator sound so the way you use the
Web Audio API is you have a context
here's a gain node an oscillator
connected together specify type
frequency and we turn note on and then
after a duration we can turn it note off
and that gets us a little noise as
boring as this let's basically you build
up from there in order to put more
things together I actually showed you
those demos back to front so no demo
there it sounds like a start again we're
only scratching the surface to your time
it's a lot harder to find this
affirmation online wait it's there
here's a link so does they don't
remember these controllers yea though
they're pretty awesome so that these are
how these controllers work there's two
locations in memory that you can that
the nazcans strobe and it will go
through and store the store its status
as a low water bite in sequentially over
eight bytes so you can read the status
of the d-pad select start and the BNA
buns and this is what this is awesome
because we can hook up to the gamepad
API so the set of Firefox has it has a
pretty good system WebKit requires
polling so you're not writing some
potentially awful code like this where
we use request animation
to continually pull and get the gamepad
status so let's have a look at that so
this is a emulator written by bent
fisherman and I've just added gamepad
support to it but i'll just put the game
in
let's get work here
so I'm also not very good at games but
as you can see using gamepads a bit more
authentic experience
yeah my remembers this level in fact I
haven't died yet it's a bit of a oh
there you go
um so with all these pieces of hardware
in the console obviously then they're
not synchronous oh alright they're
running independently but your
javascript isn't so what you need to do
is need to count the cycles Vietnam that
passed once every piece is you then you
need to use this count in order sync
them together so i wrote try using web
workers here but i tried and that didn't
work out well for me so don't try using
web workers so now you know a bit you
probably want to write your very first
emulator so i can't stress how much you
need to spend a lot of time researching
before you jump in you're a good idea is
to start programming your own programs
that way you can become quite familiar
with the instruction set as well as
other media can sing granese about the
year about the hardware here's a good
link in order it's kind of like an
interactive tutorial for learning 6502
there's books available so let's get
started so chip a is your friend that's
the first one you should use because
it's pretty simple and I'm if I can do
it then I'm pretty confident on Ken
here's some tips so you're probably
you're probably looking at this problem
thinking ohhh that's kind of like a
MapReduce into a some underscore
function and pop that there but it's
just far too slow you have to kind of
you kind of write like the sea subset of
JavaScript so you switch cases are your
friends for loops just just basically
all the simple stuff because it if you
can get to work with other stuff that's
great but um when it comes to nest
simular a lot of stuffs just far too
slow some other things I've seen is
optimizing around passing of data so I'm
still passing around object which holds
different values you pack them all into
one bite and then extract them on
destination it's also good to know about
v8 optimizations know how it what are
optimized for what things can break
optimization so it's quite great if
you're wondering why emulators run
pretty slow and again write your own pro
games for the cyst
in it because you become quite familiar
with it so a lot more possibilities and
what I've discussed here I was going to
implement but ran out of time a
WebSocket phone controller I thought
that'd be pretty cool there's you could
also implement multiplayer for to play
game have a second player come in via
web sockets you could use a vibration
API for force feedback life in 10 or 64
had you could use a file API application
cache and then you have a portable
emulator which users can download and
carry around with them a lot of games
had batt battery back safe state so you
could use local storage to serialize
that and for example the the fam econ
javits controller here it had a
microphone input in the controller and
whilst not many programs use this I
thought about using getusermedia with a
microphone in order to emulate that so
i'm pretty sure that hasn't been done in
javascript yet here thank you you've
reached princess was there any questions
if anyone has any questions as usual
just please raise your hands and we'll
be right over at your seat anyone
anybody
alright so oh hey
to do the full screen stuff have you
looked at like scaling it up I mean
using one of those pixels pixel art
scaling algorithms I mean yeah with the
chip aid emulator when it when it the
graphics are rounded there's a set size
for the pixel and when I use the full
screen API I actually up that so i
render it big as opposed to letting the
browser just scale it I'm not sure
that's the best option but that's just
one thing I tried okay any more
questions
well alright if there are no more
questions can find Alex around the venue
and possibly later at the after party be
sure to go there after the event and of
course you could ask him there and that
has been Alex running pong thank</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>