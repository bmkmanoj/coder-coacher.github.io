<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Charlie Crane: Building Fast Scalable Game Server in Node.JS (updated) - JSConf.Asia 2013 | Coder Coacher - Coaching Coders</title><meta content="Charlie Crane: Building Fast Scalable Game Server in Node.JS (updated) - JSConf.Asia 2013 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Charlie Crane: Building Fast Scalable Game Server in Node.JS (updated) - JSConf.Asia 2013</b></h2><h5 class="post__date">2013-12-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/h3GEagIG47U" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">you
thank you today I'm gonna talk about a
building fast scalable game server you
know that ah yes this is a fast just
cause I've ever attended this year and
but this one by far has the best
conference room not only this great of
you but also look best Wi-Fi signal now
what I find so good that I have it to
keep a working all day and as I speak
hurt for you guys headed in time and I'm
Charlie curry I'm from China I work in a
company called Nabeel it is the nasdaq
listed company it is very big company in
China actually and I've been working in
that in for about eight years I have
developed varying web game weather and
the game products but mostly I have mob
where background actually and so many
people ask me where do you come from
which stated will come from actually and
I replied I come I come from Hunter
ho-oh
never heard of it we offered of eighteen
and show hand and never heard of Hunter
but today I will let you guys all
remember this city hunter so anybody
knows this guys some step I think most
turn north or just guy should have know
this guy because she's very cool and he
actually maintained about hundred of
projects on github only him alone very
cool guy and a month ago he have
statistics about cities for NPM
modules and here it is okay not Fri the
number one San Francisco number two okay
this is where our subjects lives and
number three in London number four New
York number five medicine and which is
number six how to China
okay
okay I'm Joe hello - biggest Internet
company in China Alibaba and a Nettie's
and it's also a very good at Traverse
City so if you guys are interested are
you travel in China
don't miss handle so let's jump into the
topic this is today's agenda I'm gonna
talk about our games of a framework
first the state and some scalability
issue and performance issues and because
I'm from there most from web background
I'm will talk a little bit about real
application real-time application
development okay so let's get started
formula is a fast scalable distributed
game server framework for no--don't yes
it was open sourced about a year ago it
is quite popular now actually in China
but not only in China after I spoke her
ingest configure two months ago the NPM
download account held in double and the
many guide is from America and Europe
here and what Tommy no can do formula is
a game server framework it can develop
mobile game web games social game and
even I'm a marketer and only one premise
it I need a real time now to you the
interruption it means that only
multiplayer game neither this rumor if
you are developing a single-player game
you do not need our free look at all and
it is also a real-time applications of a
framework actually it can develop
real-time application holding millions
online users we have an actually you
don't you look it for that formula is
not a single project if you take a look
at I will get half it holds about more
than 40 projects there so what is all
this project about well let's include
many demos and also there are many
client libraries including say iOS
Android and
quit even unity3d all these crimes and
many tours like Adam in control and well
commander line thought and also some
many many plugins and libraries like the
I was funny and beneath it in the
framework and this is our github address
and this is our main project between the
writing quite quickly actually there are
already many success Christian in China
now and this is one of it it is a car
game called as a moon and they have many
online users and this is another way it
is correlation so basically it is a
little like crash escape but they say
they have many online you doesn't know
and as I said it formula is also
suitable for real-time application and
the some guy developed this game this is
project it is a real-time chat mobile
chat application it can chattering voice
and there are also many successes like
there I will not eat a richer one my way
actually there are many card games and a
many real-time application and they are
also many job-hunting out of time out
there so this is evolved it look at
obscure number one no jest number two
ready number four my cycle which is
number four hello
okay many of their has out they are like
their yeah
and today I'm gonna focus on scalability
because I have given many briefs talked
about this three month before today I'm
gonna focus on scalability and to make
you guys know what the game like I will
show you a little demo about this game
let's start the game demo because I run
in the local I actually have five online
users it can actually hold about a
thousand Caroline
and the art material you the press you
can just take them good night because
today I'm talking about a game server
the crime side material just a crap okay
and let's see you know what does the
game like you see there now I'm not much
oxygen it can it's my mouth
okay the players can working around
fighting each other
oh it it can attack Earl the other
player and also can attack the master
and the master we are so quorum attached
me it is driven by official intelligence
and also I can run and this way this
Elena Missy and I can run to another
math area actually oh here I am I am me
another area and they see the water the
game like basically okay so you guys get
any idea what a game like and we can go
on scalability web service are usually
help and let me do the scalability but
game server usually is not a scalable at
that for example you have a word
encourage there that it can have a tone
about 7000 online users but it city then
I know Marty to did it cannot hold that
come line users actually 7000 is the
most okay why why game server is not a
scalable as well so let's start from the
illest long connection game server need
a lot connection for two reasons the
first reason is immediate response time
game needed to response in very very
short time like less than a hundred
milliseconds so we must use long
connection the other reason is by
direction message flow we not only need
to request to make a request to the web
server we
you know to push a message back to the
crime so we need a pint direction
connect connect so we need this
Gong crashes so actually but this
problem is very little so because we are
using no tutorials this is why we are
using no touch yes because it will
design the for event-driven i/o and it
is very good at holding connection
between very good at real-time
application and network incentive
application in our case if we you are
you'll in sock-doc tayo we can hold
about 25,000 dying one process but if
you are using QT t it can hold about a
hundred and twenty thousand connections
so this problem can be solved we just
eat many many mem memories we can add a
machine and make the online users okay
but the second problem is not that easy
to solve it is called state for so where
the application usually is not stateful
it is stateless it we can partition the
randomly and the each request can be
routed to any server but game is
designed in different way game server
you in this case you partition the pie
area so what is that mean so you can see
the demo before when I'm watching a role
in the map I am in one process when I am
escape into another where I'm actually
get into another process so why
designing in this way because most of
the player interruption happen in one
day so we can do it in one process and
all this interaction can be done in
memory they feel the nature of game so
but because of this partition strategy
we have a problem of State for each
requester come from the cry site must be
routed to this server not that's the way
and that's the one
so how to solve this problem actually
this cannot be solved in technical level
it can be depending on game design we
cannot make one hair we are too crowded
we need a parents
area for example this is a case of a too
crowded area too much players in one
death and this process cannot hold too
much some line user and it will crash
and this is a much better design I can
it's not that proud and the process can
hold this online users and it come to
the third problem it is quite difficult
it's called broadcast because indeed
when I'm watching wrong or fighting
I needed the other players see me right
so I need a push message to all the
other players if they are you the only
one player in the area so I only need a
to push the message to me or no message
at ha so one message II one message out
if there are two players in the area
how many message are needed to notify
myself and notify to another player so
two messaging for message up that hill
okay
and if they are about four players how
many messages sixteen that is also okay
note about us can handle this no problem
if there are about a hundred online
users how many messages ten thousand
that we've a lot of messages heavy if
they're about thousand players in one
area how many messages
Emilia holy no process can hold
this online users so how can we handle
this okay the first strategy is quite
easy actually
it's you call the Aoi it is an algorithm
the idea is that when I broadcast to all
the other players I do not need to
broadcast all the players in the map I
only needed to broadcast to the players
who can see me so this is what this
module is builder we use an algorithm
called a power
and in the center is tower and in the
screen who can see me only in the center
this nine rectangles can see me and all
the other the outsider cannot see me so
I need not to notify all they are the
players I only need to notify all nine
rectangles in this area okay this can
save a lot of broadcast and the second
problem
yep the second solution you separate the
process I remember the guy before have
you talked about it a year if we have
all the logics in one process for
example game logic and broadcast erotic
all this process can eat a steep hill
right so fight each other and the 5000
will go down yeah so what can we do we
can split in the process into front end
and back end the front end the server we
are do all the connection starts it will
broadcast to the crime side but we do
not do the business logic the business
logic is done in the backend server and
it have another benefit although the
game server is paid for
yes the back instead for but the front
end it's actually it can be up to many
many processes and I have no problem so
and so the solution is also about game
design because even we have the air
groom is muscle you I if I are all the
players in in this single place so I
also needed to broadcast all the players
right well we need a tool dispense the
bone place and make the character not
her not crowded in one place so usually
we can dispense this one place in too
many places and each of place is not
that crowded and the first strategy is
called a push schedule and it is much
more about the real-time application or
something like that
for example
neither to broadcast an advice advertise
to five million online users do I'm here
to broadcasting 15 milliseconds no I can
broadcast my minutes are comments that
feel okay so in this way I can define
our strategy and this is how it's
defined in formula for example I can't
broadcast about 10,000 messages and I
have a rest and check out the city you
saw I can rest a while and when does if
you use free I can broadcaster the next
message and it is depend on your
business logic and i/o scheduler
strategy okay
come to the fourth problem tip it is
also called game look we not only have
game Luffy in the crime side we also
have game loose on the suicide it is
something like that average a hundred
milliseconds I needed to update many
things for example I am bad so I should
remove you from anti-terrorist make sure
you disappear and I move if I move I
will in the next tip I will put you to
another place and for example you have
some revival and also the it were
trailer trial date artificial
intelligence because monster and I might
be father master we are attacked me
please driven by the I and the dead
logic is also driven in the stick if a
tick in a hundred milliseconds all these
after logics
should be far less than a hundred
milliseconds for example 40 milliseconds
is at most we need to throw some space
so how do we solve it the entity number
should be limited because we needed to
iterate all the end at the end and do
some update stuff we should a limit
early entry number another second is the
attention to the algorithm because we
have a I'm algorithm in each dick if
there are algorithm pick too much time
oh that's a very crash and the third
problem is about to see because Fuji say
is horrible right
especially in Java usually take about a
few seconds and if you configure not
right maybe a minute no that seem crazy
for game but I find that weirdly very
good at garbage corruption actually I
have talked a few guys from Google in
their team and the dart team and
actually if you can control the memory
under fifty thousand fifty five hundred
megabytes it have a very very good to
say performance actually even for GC can
only take about 30 milliseconds that is
very good so v8 is very good at it but
we should pay attention to make the
memory be limited we should have tried
to divide the process as possible the
more is possible we should have divide
the process into single task so in this
way this is embark of the runtime
architecture this is it okay it's quite
complicated in the front hand either a
bunch of connect service it's just how
the connections we are not to the
business logic and the backend is where
this the business logic is done and we
can see we divided many processes we can
so we not come we err your server even
actually Chris they are usually about
twenty process is something like that
and each one do its own job like a
server service tests or something like
that and when the business logic is done
to a push message back from the
connector and the connector will push
back to the client so it's a quite
complicated distributed architecture
right so how do we solve this
the solution is framework so
let's jump to the third part framework
and the essence of Hamelin is a
distributive scalable real-time
application for a work actually if you
take a look at the core of our framework
it has nothing to do it again it is just
a real-time framework but it is not
similar to media or Derby or something
like that it is not an MVC framework the
car Camilla is to make distributor
programming as easily as possible so
let's take a brief look at the design
goal the first goal is about abstract of
service we have we can see there are
many many process we need a simple way
to scale up or down all these service
and easy as possible and the second girl
is about abstract offer request response
and broadcast this is the basic API of
cream server request the response is
similar to web server web server also
have it but we need another directions
message we need a broadcast of the
message back to the client and the third
problem so the design go in about RPC
framework actually we use a very very
hot is very very simple RPC mechanism
because in this case we can make it a
very very easy but and I have talked to
all about these issues in other
conference before many times so today I
am gone I'm not gonna dig a deep play in
this area I'm gonna talk to some
framework features about scalability and
he I used three features the first thing
service scalability the second is
network 30 plugins so let's start with
service scalability we designed the
server as duck time so almost a no
configuration file you can stock up but
the are you I'm gonna go what
configuration fire neither and it is in
the JSON file and in the oxide we have
one connection
and one church service so this is the
runtime architecture right like this so
how can I stop we just changed this JSON
file three connector through your chest
over no code I needed a draft change
this configuration file oops get up very
very easy we also support another kind
of stuff we can dynamically add a server
in runtime it is a command line to start
our server in runtime so with this
mechanism I can scale up in runtime like
cloud computing we can write a very good
sheer sheer script if I find we found
that the resource is not enough I just
give up in this shell script very very
easy so this is the first problem the
second problem is network when we
released our framework a year ago we
only support such that I applied socket
IO
is very good at browser client right it
is very good at browser compatibility
but it turned out most of our customers
users are from mobile background they
said who are using Jessie that is twist
for very very much bandwidth so we need
another protocol like binary and small
pendants as possible so we developed
another connector which called hybrid
connector and also we form of our
developer and qtd connector by ourselves
and so I'm gonna dig deep about a hybrid
connector and this feel how the package
is encoded and decoded I actually have
three levels the first time we are
including improved pasture contains some
message encoded I will not a big detail
about this today I'm gonna focus Oh
broke it off so
this is what we usually prefer fleas
that we write some prefer buff
definition right and we compile it we
run some command line compiled and we
deploy copy this code to the sauce to
our project and when the entity streams
up I'm here to rewrite our protocol and
compile it again and copied who needed
that
yeah oh we need a better strategy and
this is our strategy we just write our
protocol definition we do not need a to
compile we do not need to do anything
just this definition changes well we can
encode in this definition and no
comparison and in Okabe so how do we do
it and this field a configuration case
so you say we this is our configuration
file it is a little similar to Express
and if you take a look at we use the
hybrid connector and the way you wrote
about and with this configuration and
what else would we do we just need ax
and proto talk about definition and you
can see we defined in the right style
its
amo it tis a proto buffer finishing of
the message and with that we have
nothing needs to be done just that with
push message with a loaf and boot all
these entities we are transferred from
jason to protobuf and a pushback
prescribed it's that simple if there is
no definition in the right side it will
transfer interesting format and it is
also a key that we open sourced upon me
antonio probe us as a single project any
of you guys can use this product person
in a single project it's quite easy and
this is the API I will not pick TV in
this so with protobuf compression 4400
online users
originally it need about 3,600 flow
bytes and with pretty bad about 25% well
set receive a lot of network flow so
this is about network and the last part
in cloudy cloudy is a mechanism to
extend our framework so it to use
component and events and it is quite
easy actually
but what is the relationship of between
planning and a scalability actually it
related a lot because we find that many
many services need except for a service
for example online status we need a
greatest we do Redis to store all this
online status right but if we write all
this code in our main project between a
problem because our main project will
rely on reddit and if some guy said oh I
do not get like radish I like MongoDB so
we need to import MongoDB our main code
base but with Robbie I can do things
like that we just if you don't use this
plug-in and both this this framework
have the ability of skill up in being
Redis and if I need a MongoDB I just
write another plugin and use it and I
have the ability of use MongoDB and
online status ok here is another example
master we use a master process to manage
all the other processes the other
process is maybe 50 or maybe 20 many
processes so what is this master process
is crashed crashed or crashed so how can
we guarantee our master process is not
crashed we can use the keeper and we
have this in the strategy we have to
slave processes of master yet we are
only in normal cases only this must
process do the job but when I am crushed
does it maintain a heartbeat - zookeeper
zookeeper we all know that
oh so many proves the main master you
crashed it we are a mere 10 what I'm
watching event and the two slaves were
select oh I want to be master and the
trust level we are competing to each
other and the one we are the selection
area the master and after the slaves
become master so zookeeper we are
notified all this message to all the
other processes and the other process
note oh the master changer I needed to
reconnect so how the other process will
reconnect to all them to the puller
place to the master process and so the
we do it turning our main product then
we need to rely on zookeeper in our main
project who needed that most of a guy
don't you know that but we can write it
in a froggy and we use it and we have
the ability of hive available he musters
that's either okay so let's jump to the
first part performance actually the
performers various differently in
different applications even games
because there are so much different
games real-time game and not on your
time game it's very very different and
this in this case we will focus on the
previous previous case MMORPG I know of
a b2b cannot hold that online you that
actually there is a plus yeah
nephew he said that he can hold about
20,000 concurrent for prayers of our
area who believe that it's impossible
actually in our case in one area it is
not holding about 800 online users in
one process it's at most seven thousand
at most actually in real case
so 50 now standard and we actually test
time our OpenStack virtual machine and
the machine is not very very good and
this is a use case the first years Chris
only fight we only tested in one area
one process stress from one area step by
step and it will log in every two
seconds and fight each other or fight to
the master in two to five seconds and
this really actually in our actual
picture for fighting each other in this
case how much are you this 486 we
guarantee in this case the server is in
very stable status it is not as good as
our online data but it is a fairly good
editor and we are not bluffing we just
we are very honest
it sees our line data and it take about
less than than 80% of the CPU so the
second the use case will not fight each
other we just move around and walk
around and the other use case here
around hand they see the map how much
online users about 800 online users this
is almost as good as our online meter
and the third case in house fight in how
smooth it is the usual case seeing real
in reality in real game and in this case
we can hold about five hundred and fifty
eight or nine units so this is the
performance data and the response time
is also very quick okay so we still have
time so I'm gonna jump jump into real
time application will come allocation is
very different from game actually and we
have already have many success stories
about real-time application like our
message was pushed platform it can hold
about 10 millions online users and also
some track application in this case it
is not
is not that frequent messages at gate
but it usually have much much more
online users and some in some cases you
do not need to push message that real
time you can push messaging one year or
some seconds it is horrifying
so usually real-time application is much
scalable than game and today I'm gonna
take a look at this message push
platform it is reused in our company
it actually can hold about 10 million
online users now because there are many
products are using our platform and it
is all beautiful so this is the
architecture of real-time application
and this is a typical Palmetto
architecture many many processes and the
front end is connector in this case
we'll use the obvious to connect and the
flock flow is very simple we have a
group of service yet we're still message
from RabbitMQ and push message to a
penis or connector here to depend on the
logic and it seemed quite easy but it
actually have many many problem because
there are many challenges out there and
we do it quite well
so what's challenge first of course it
is highly loaded 10 million online users
the second we need a broadcaster yes
this is need of food product we need a
broadcaster to 5 million users in
whamming it and they see you quite a
difficult and we have handled it quite
well and the third problem in
reliability we needed to push message in
any conditions even the crime-filled
crash something crashed we need to do
high availability and if the crying
crash we needed to store the message in
our in our Redis and yet we have pushed
message when the user is online it takes
quite difficult actually and
the first problem is about power and a
network we need to save our network
bandwidth and there are many strategy
about it and we support all this crime
including iOS
I always actually support a TLS and I'm
qtd because if unity is not very real
time in our country actually so we need
another protocol to DT that we are
pushing message directly and in Android
where you learn qtd and in browser sorry
doc I owe you the best choice and even
we even support a Windows desktop
application now it also you don't get it
so how do we do it because we have
communal framework I'm gonna forum ok
very good at support all these clients
in one project very very easy so I think
that's all I think are they are you some
time for questions and does anyone have
any questions right charlie raise your
hands and we'll go right through
anyone okay well if there were no
questions for Charlie well that has been
our presentation on Pamela</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>