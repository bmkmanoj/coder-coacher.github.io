<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Chris Anderson and Jan Lehnardt: CouchDB to the Edge | Coder Coacher - Coaching Coders</title><meta content="Chris Anderson and Jan Lehnardt: CouchDB to the Edge - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Chris Anderson and Jan Lehnardt: CouchDB to the Edge</b></h2><h5 class="post__date">2013-01-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/vu7wST7m_1Y" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">those the first question we have for
everybody is who here has heard of
couchdb there's not very long ago those
hands wouldn't be going up so what you
guys Rock just for that yeah and so
who's used it a little bit who likes it
it's good more hands cool we came to the
right place so I'm Chris Anderson I'm
one of the couch TV committers I'm kind
of interested in the HTTP like restful
side of it and we're really nice guys so
we can't get to everything in the stock
would come find us later and we'll talk
all about CouchDB yeah my name is young
Nina I work also and catch TBN I'm more
into the I used to do mysql was a big
pain now I've got this other cool thing
working so that's my background and
we'll talk about cool things you can do
with card should be so so rather than
you know because we could give an
introductory talk and talk all about you
know like the basics of couchdb but you
already know that so we're going to talk
a little bit about what happens once
you're already using couchdb wow you
have to think differently writing
applications or how your how you can
think differently if you want so yeah
we're going to focus on programming
applications that live at the edge
there's two features a couch TV that
make this possible one of them is that
applications can be documents and the
other one is that replication is awesome
and when you combine those two you can
get applications that live at the edge
of the network okay we'll talk all about
that good oh yeah go ahead but before we
do that a little bit of CouchDB and
yalls an expert's so this is this is our
bullet points this the agenda that like
the things we talked about on KGB so
catchy beats a document based database
which is not a relational database so
you don't have any tables any schemer
but you have this thing called documents
which you know cases json documents so
you all know Jason off of course and
what you can do instead of figuring out
how to like take your data probe that
you get data objects that you use in
your language might be JavaScript might
be something else you don't figure out
how to split that up in tables and rose
but instead you just saw that object to
get back a key if you want that object
back a gift
actually be the key and get back your
object it's a very simple very simple
concept we've got sort of revision
control which is not not not what
subversion is that's not real version
control but we use it as a means to
expose multi version concurrency control
to the user so that whoever saves first
wins you're never going to save over
somebody else's work when you're using
couch TV right the the trade-off we're
making is that we don't want any locking
and catch TB so we said want to support
high levels of concurrency in a locking
system will at some point be busy trying
to figure out who's allowed to do what
and in catch me we just don't have any
locks but you need to be the first one
to safe and if you come late you can't
save and need to reroute and so on Wow
the next thing Oh HTTP right so you
already know that the API to catch TV is
HTTP but there's some cool things about
that one of them is it all the HTTP like
middleware and caches and you know load
balancers all that just works so if
you've deployed things you know into a
cluster of HTTP app servers you can you
can also deploy a large-scale CouchDB
installation okay if you've got
operations people running your
applications they'll be really happy
because they already know how to scale
Apache and they know cannot take all the
infrastructure they have to scale your
web front and put it in front of the
database they don't need any like
special hardware software to do that and
and we'll talk to that one of these
bullet points is replication but we'll
go into detail on that so right so at
this point we've got a oh sorry yeah we
can go on and on and this is all
technical and whatever but hopefully you
know the big point is that couchdb is
simple you know like that there's just
documents or not relations there's not
like you know updating parts of
documents and hoping that you know it
worked out it's just it's simple so yeah
this capable thing is like scalings like
the buzzword of 2008 and I hated one
started and still hate it so what what
kind should be enforces here's the
application developer is to make your
application in a way that cash we will
be able to run it or not just a single
instance but on multiple instances so
you can scale up the the computing usage
of your application whatever that is
like maybe disk might be memory might be
might be a CPU but we can just put in
more couch just to make your application
faster and better the downside is you
cannot do everything and catch to me so
we put you in a sort of a straitjacket
that you cannot do things
don't scale which is still most of the
things because we've got big sites
that's do scale and other systems and
they do use the same straightjacket so
and we just use these like in core
couchdb and make okay give you a nice
like a comfortable place to do scalable
applicant on relational database for
more reasons than just because we're
honoring like really think there's good
reasons to leave that stuff out of your
you know your one share tier and your in
your application so distributed that's
the fun part that's what we're really
going to get into so couchdb you know it
uses like 10 megs of ram when it's under
heavy load it's not it's not a big thing
to install so you can run it on your
smartphone or what I mean you know
that's our that's our hope and it'll run
on the client side like you know next to
the browser so you can have applications
that come all the way down to the client
it actually does ronald g one yeah see
have we got it running or someone who
what they these crazy guys crazy guys
got it on as you want all right so if
you don't believe us some people you
know have already stepped up to the
plate we will name any names but there
are people using couchdb and production
even though it's still alpha software so
they're putting real money behind you I
know it like I know if a handful of
startups that are based around the
contact and some project that has
casually be in its core so there's real
money going into guys should be already
even though like we're kind of not there
yet but it's because yeah the you know
engineers the top these organizations
recognize that our design is simple and
I'm not to complicate it but that's not
what we're here to talk to you about
we're here to talk to you about pure
JavaScript applications because we all
love JavaScript yeah and there's you
know we're going to will go through this
in sort of a you know crazy order just
because I want to get the big picture
costs before we get too technical but
what matters about you know you could
write a JavaScript application and host
it you know inside of a titanium or on
your server or you know any number of
ways but the cool thing about couch TV
being sort of you know it's agnostic as
to where it's running is that you get
these applications and add the data as
well that you can ship around too
yeah it's a I've got a lot to say about
this but i kinda want spread out through
the course of the talk the important
thing being that the source code travels
with the with the data with the
application so that means that you know
think if I'd in a way that like
functional programming makes code being
data to make like code more expressive
catch to be max applications being data
to make applications more shareable more
independent and more more fun so yeah so
we hope that you know we end up making
it easier for people to hack on the
programs they use on a daily basis but
in order to understand how to build
applications in couch TV will dive a
little bit into document modeling so
yeah I think I mean a basic document is
just like a you know it's a JavaScript
object so JSON uh you know with curly
braces and that lets you put pretty much
anything you want into it the we catch
be reserved reserves the underscore
namespace everything every attribute to
start with an underscore is special to
catch TV and everything else you want to
put in there can be whatever like you
should be familiar with putting whatever
into something but that's kind if you
come from the relation later okay I'm
not a native speaker might say stupid
things so I had one talk I said like
Coach like culture replication goes both
ways and I'm like what did I say no
nobody was snickering I'm like I didn't
get it anyway so in relational databases
yeah you have that fixed schema thing
that's totally annoying if you want to
just add one field you run alter table
statement on like 16 gigabytes of code
and you're waiting a week until it's
done but in cash to me you use just your
not you need to start storing that you
know the Darth Vader has a sombrero so
you just add the sombrero field to his
document it's a and and then you know
you've got to do you've got to do some
duck typing in your application so that
your view will check for that but you
know you're already writing if if
statements hopefully when your display
and things anyway so that's okay leave
the dock yeah we've got like jason has
no type and if you want to program your
object of some sort of type and you
you want to like be able to like find
out what object is doing what or what
documents doing what so you're quite
flexible Minh and applying just tags to
documents and then read just these tags
and that's all very flexible you don't
have like again not a fixed schema thing
I keep raving about that because I
really hated not having a schema makes
it easy to evolve your application over
tell you what yeah we should we should
say that like having no schema doesn't
make migrations go away so if your data
changes that you need to deal with it
but you don't have to deal with it up
front but you can be a little bit lazy
or agile with it so switching gears a
little bit about you know from from
another point of view about the
technical aspect of CouchDB because of
the Erlang implementation language it's
it's designed for super high concurrency
so show fans who he knows la that's so
Jake you're not paying attention that's
good so Owen was was built for for telco
industries and that was designed 20
years ago and they had a couple of
interesting problems they had these big
service that could never be offline they
had these like thousands of calls going
on at the same time and if there were a
problem with one of these calls none of
the other could be reflected it's not
like you can drop calls if there's the
ZEC fold and one of the calls for
whatever reason and a couple of other
things and they solve that with our line
and turns out like today in the web we
have similar problems we don't have we
have customers all over the world
there's no like downtime window at night
where we can do maintenance there is no
there's so many things going on at the
same time so the same it's basically the
same problem in all things just the
perfect solution for these kinds of
problems so it's a good fit for CouchDB
so what we get is specifically in our
own time with it is we get the ability
to handle like huge numbers of client
socket requests HTTP requests at the
same time and you know as the load goes
up you know the latency will go up a
little bit but the server doesn't just
fall over you know your networks akal
fall over before CouchDB does and there
was this this benchmark in a patchy to
against y'all's which is an all on clone
of Apache too and they like they
couldn't get a patchy to accept more
than two or three thousand concurrent
connections before it fell over and they
just stopped the benchmark at 85,000 for
yours it's not that it's there some
magic so that it will take longer that's
not
it's a finite computing power but if you
have a like huge spike on request the
handle will have airline will handle
that gracefully where's other system
very hard getting that right so that's
all stuff you don't have to worry about
if you're using CouchDB but it stuff
that makes it fun for us to make a kind
of CB right and another thing that you
don't have to worry about when you're
using couchdb is how it does this but
its replication is really resilient you
have data set on this machine a data set
on that machine you can make you can
bring them in sync with a single HTTP
request so say you have an address book
on your phone on your home computer on
your laptop on New York work computer
and you like make changes to one one
instance and you want this change to pop
up everywhere else and a couple of
products to do that mobileme is one that
works pretty well and other ones that
are sort of that that come up in that
space but they always required to
require you to go through some kind of
vendors through the cloud and we think
it's kind of cool if you could just like
my phone's just in the same way for that
my laptop I can I just not talk about
without talking to Apple that would be
kind of nice and contributed let's
allows you to do just that doing like
multi-node synchronization that works
solo flawlessly without going through
any cloud vendor yeah so Oh ops people
really like this because it simplifies a
lot of deployment scenarios like one you
know so you just have one couch that
you've deployed and you know the local
starts to get kind of high so okay if
you if you like actually be because code
should be itself is pretty cool you like
in make an application that runs on cash
to be and runs on one machine and you
know that there will be problems like
things break it's just a fact so in that
case you just want to have a second
couch that it's just there in case that
can take over from the other couch so
this is just a heart failed over let's
just a whole file over or master slave
thingy that you can set up with MySQL
for example pretty easily and if you're
the traditional web thing you have a lot
more right reads than rides that's where
the next slide comes in you just make
your this read cluster that just
everybody reads from in this single
master thing either replicates with the
other ones and that's official be
familiar with that so you just throw
your engine text or whatever in front of
that to load balance there if this one
falls out of the cluster no big deal
because the web browser will block the
requests and but but that's let's no
different than mysql replica
that's exactly the use case my school
that replication was designed for it's
important to note that these arrows are
triggered replication so what that means
is the replicates once and gets
everything up to date for each trigger
but you could put the trigger on a cron
job the idea is we're giving you really
simple primitives for moving you know
for keeping the data in sync right it's
not that you just set up like a magic
synchronization thing they also
unidirectional so you move one from for
one couch to the other and not backwards
and if you want to do that you just swap
the arguments to the replication call
from the source and the target database
of this is where this comes in coach to
be replication unlike the mysql master
slave replication is designed to be an
master a multi-master replication so any
node that runs the couch TV is a master
database as far as contribute
replication is concerned and even kind
of three masters like you can talk to
the MySQL guys and their game yeah just
do two to master setups like yeah I've
got too much of a right load I like to
do like three masters and I can know
that I don't go there and like in catch
to be you can like it the way it's
designed the way you design your
application around replication will make
sure it will it will work that way yeah
I mean there's you know we'll get to
some of the things you have to think
about especially in terms of like
identity and having you know the same
same document on all three nodes you
gotta avoid update collisions and
whatnot but that's application level at
the couch to be level it just you know
handles that for you so you can have the
same data on all three nodes you know
pretty easily and you can get even
crazier like there's no reason not to
just have everybody replicating with
everybody all the time this is the world
that I'm talking about building
JavaScript applications for and that's
so you know this is your computer and
that's my computer and you send me a
message you know you put something in an
envelope for me and maybe bounces around
a little bit and maybe it gets to me I
mean it's not the way you want to write
everything but it's kind of fun that you
can do that without a centralized you
know control point so to the user to
somebody who is actually you know using
your application it just sort of looks
like they drop their message you know
into the pond and the ripples are going
out yeah I think we didn't mention
peer-to-peer but that is that like a
true pit to pay set up that you can set
up with catch to be just send stuff
along and it eventually arrives where it
belongs just as long as the two nodes
can
touch via HTTP so yeah maybe maybe one
day I'll be like a scientist and figure
out how to get HTTP to go through all
the firewalls I would just we just by
skype and they so we mentioned document
modeling but it comes up again because
applications are documents so if all the
things that apply to documents apply to
applique should we should mention one
more feature of documents so JS
documents are just Jason blobs or Jason
documents of objects and but they also
can have attachments just like email can
have attachment so you can just assign
well attach arbitrary binary stuff to a
document as much as you want and so you
can just put piles and then files could
be for example HTTP for HTML files CSS
file JavaScript files and they all get
there on your eye so you can point a
browser to catch to be inserted HTML
file from couch to be into your browser
and your browser will render it because
coach people know the correct content
type to send yeah you can even take like
a Holden set of nested directories like
if you're building static web pages and
just shove it up into a couch TV
document and the you know everything
will work out the HTML file then will
reference like the JavaScript and CSS
resources that then get pulled from
couch to be again so you get full full
JavaScript enabled application serving
right out of catch keeping without any
sort of middleware layer so yeah so when
you're doing when you're doing document
based applications you want documents to
stand alone you want them to sort of
contain their own context where it's
like in a relational system what you
have is you know one table that pulls
out from a million other tables to get
the to get the data that you need in
order to answer your queries but with
cow should be like you want that to be
one request you know maybe a couple
other requests but the context is in the
document and so that feeds into having
applications be documents because then
you've got the duck you've got this
document that is just the whole
application right there and that means
that if you if you replicate it the
application replicates just like a
document would so practical use case for
that that's kind of fun chris has a blog
that's the couch app running on Jake
trace aid on that that you can just hit
right now if Wi-Fi still working I can
just replicate from Christmas blog to my
couch to be instance and I have chris's
blog software running running on my
computer and I really like Christmas
blog but I don't like the green color of
the header bar so I change that to blue
on my couch to be instance and then I
have my own
put my own content and it put publish it
to my like cash to be public server and
everybody can read my blog that's I
actually Chris blog but my content and
my colors and I got a blog for free
which is kind of nice and then Chris
sees okay my colors are better or did
better topography or whatever and you
can pull out changes back to his couch
and go all crazy and if you all like to
get model off of open source development
that's a lot like it yeah i mean i would
actually do my development sharing and
get still but for data sharing like
especially public data sets the ability
to replicate it around and then you know
so you have an application that can you
know graph the number of traffic tickets
by you know square mile radius from your
house or whatever and at someone else
says well like you know that's kind of
cool that square mile radius thing but i
want to see you know like some other
crime statistic or you know where are
they putting in new parks so you can
take the applications on the data and
remix them really freely because
everybody's got all the you know
everything it takes to budge the data as
well as to handle the you know display
in it so this is my metal icon for an
application so your document goes into
CouchDB and then it gets unfurled into a
beautiful flower of functionality so
look out for that if you see it again
it's an application but how what like
it's a database so how does it run this
application and and that's what we're
going to get into for the next little
section here so there's a special kind
of document all the only thing special
about it is it lives in this namespace
and couch to be looks in there for the
application alright so the design
document we call these design documents
is just like a regular document the only
special thing is let's start the idea of
that or the key of the document stars
with underscore ID / design / and the
other thing is that catch will look for
fields in that document so if it has a
field views and other than what we got
there so views validations and like my
thing one off so so a couch TV it has
MapReduce that's like a nice buzz word
that we have but it actually turns out
to be great for Trent you know for
transforming inquiry and json documents
the definitions for the MapReduce
queries live in the design documents
that was the first
got stored in there and then as we've
been adding features there's document
validations which are run against
updates as user saved them to make you
know make sure they're valid so no
schema is pretty cool but at some point
you really want to make sure like if
you're storing a blog post it should
have an office feel a title and and some
text body and the validation functions
can like they inspect every right
document that comes in on the right and
then can say okay I like I like a
document and I Sebadoh like you don't
know you forget to like put in the title
or something oh I forgot to mention I
mean we should just say this although
maybe it's obvious this is all
JavaScript code right here the mapreduce
is written in JavaScript the validations
are written in JavaScript most of the
functions that you end up seeing people
write are less than like five or ten
lines long it's really simple you know
you're just checking for a property on a
JSON object so the API is so simple you
know we can we can show you api examples
maybe tomorrow at a track be or
something and then rendering HTML is one
of the new features because just having
Jace on showing up from an API isn't
restful like that's not enough for a web
spider to crawl your site or anything so
we're adding the ability to render HTML
and we'll get into details of like some
of the philosophy behind how we do it ok
for the first two are the first and the
third thing the render in the MapReduce
like if if you have a design document
and you put in these functions and their
character will recognize new your eyes
so everything in casually B is a
resource and this render things and the
map and reduce our resources and catch
to be and if you define a MapReduce view
cut you will recognize that there's a
new you or I that's like / design your
document ID your view name and then you
can query that view or have that stuff
rendered through HTML through HTTP again
so that's all the same interface there's
you know there's some other stuff that
doesn't quite go into the design
document but it's still pretty handy
like installed with every copy of
CouchDB is jquery and then a jquery cash
to be plug-in which makes it really easy
to load documents and save documents and
run queries and whatnot like thanks John
for jQuery yeah it turns out to be
pretty handy so then we you know of
course is HTTP API so even just with a
static HTML file and a jquery plugin you
can do you know
you can write a full kyuubi application
the example is futon which is our you
know our built-in admin client which is
all just HTML and Ajax right we
shouldn't mention the age thing so just
pushing our JavaScript and HTML and
JavaScript it's not like that fancy so
we're just pushing static content but so
this is like why reinvent the wheel but
in this case you have your data stores
actually a database so you can use Ajax
to talk to coach to be into all the
document modeling things and query the
views and do the validations on all that
from your static HTML Javascript
applications it's pretty neat I think so
the kind of applications that like like
I wrote a little Twitter client which
uses their JSON PAP I I love Jason P so
you know get the data into the browser
and then you sort in the couch TV and
then you can do like if you can do a
little tag cloud and see what words your
friends use too much and stuff based on
queries against couch TV so yeah so
application like can live in a document
and then we end up with a new kind of
replication which is the same old
replication but it replicates these
magic applications instead of just data
so yeah that's what I mean that's what
I'm passionate about with CouchDB
because I don't know here's another
survey question who here in this room
got started by hitting view source on an
HTML window and then you know like oh
yeah it's not that hard so this is a
view source for applications I mean you
know it comes down your computer you can
if you can use it you can get to the
source you can change it make it better
deploy it to your own couchdb which
isn't any different from the place where
you got it and you know generally let
the application develop according to
what the users want not to get too
philosophical but this is like the the
Wikipedia idea put on steroids instead
of just editing content that's available
for everybody on the central place you
can edit the application that's showing
that content in every place you want it
to be so you not only like be able to
update like you're not only in control
of history because you come into the
Wikipedia but you can also like change
the display of how that history is being
shown to you or others yeah so so the
next thing we've got to talk about is
just a little bit of the mechanics of
how you would write one of these
applications because you know we've been
kind of high level so far
there's a there's a little script and
stuff that I involved in its called
couch app and all it does is take some
junk off your file system is sticking
into couchdb in a design document so
what we all we mentioned is that you
write JavaScript put it into the JSON
document and catch we can figure out how
to do views and all this validation crap
you can use futon to look at your
documents and you get a text area that
that shows the JSON or the JavaScript
that is in defines your view turns out
editing javascript in text area feels
another thing we want to do especially
because it's like triple escape to json
but a few screen you really don't want
to do that and yet you want to like it's
code you want to put code in version
control so what we did is we made a way
to push filesystem hierarchy into a
design document so you have native
JavaScript files let you deal with your
you can use your editor roi de get
syntax highlighting context your help
and whatever other tools you set up in
textmate or whatever you use and then
just take all that and push that into a
format that cash to me then understands
put in it took in to catch up so so yeah
so the way this is you know usage
example it's a couch app clone and then
a URL and the URL is the URL of the
running application that you may be
playing with and you could just kind of
tell by looking at the URL or maybe you
know otherwise that's running on couch
so you're on couch up clone against that
application and it pulls it down to your
local file system and you can play with
it you can change it you can just look
and see how they did it and you know
well that's that's use case I talked
about like I see chris's blog and i
canna just like pull it'll climb the
entire block to my file system and see
how it works that's like the view source
off yeah so catch up on phone poles the
just it just pulls the the code it
doesn't pull the data like my other
documents so it's a good way to share
applications around and then once you
have that file structure and you've
edited it a little bit it's pretty
simple to push you just run a couch a
push and type in the name of your local
database that you want to see that
application running in and you'll get
the application right there after couch
app gets the files uploaded to the
design document it'll print the URL for
you to visit so you can go see what you
know see if it's running or not and you
know this is just a file system mapping
we're hoping to maybe get hooked up to
the fuse adapter and like otherwise find
a really you know simple ways to make it
seamless that you're using this file
system mapping so that's the mechanics
now we want to talk a little bit about
what what it means now that now you can
run these applications and they're
bouncing around the edge and hopefully
if you're lucky they're running on lots
of little smartphones and laptops and
who knows what but that's the that's the
end goal there's a lot of intermediate
steps to get there so there's a few
different there's a few different
deployment models and how distributed
they are so the first one is a normal
server like you didn't know like it's a
server and has URL and you go to it and
the application is there you can put it
on your you know your bumper sticker
this is most like what all of you are
doing yeah so this is this is the thing
that we you know I got the familiar with
through PHP and rails and there's lots
of other ways to do it but couch up will
serve that I mean a couch TV design
document can be served at a particular
location you can even put some proxy
stuff in there so that if you didn't
want people to clone down the source
code it's you know not that hard to
change then and you can also do URL
right rewriting and whatnot in that
deployment but the downside that we've
all probably experienced if our site has
had any kind of heavy traffic with being
a like a normal server is that you are
at the middle of it all else on your
popular and everyone's coming to you and
they want their data and they want it
now and so latency gets really important
and when you have lots of people trying
to pull from you the latency just goes
up and up and up and eventually your
site falls over if it's really bad and
that's it's not good to be unavailable
and it's not good to be slow when
especially at the moments when you're
getting most popular so if we take so
that's centralized model we can get a
little bit distributed with offline mode
so I mean you're probably familiar a
little bit with offline mode but maybe
you I think if you run oh if you create
a couch to be application you get the
offline mode for free there's no like
things you need to install no gears
programming no SQL in HTML
that some people seem to be happy about
sir so what do you like what you can do
you just run your run a local copy of
your couch if you say it like the block
example again so you're riding home from
jas console you want you want to say
that the catch to me talk was the most
awesome stalk you've ever seen and you
cannot wait so you fire up your blog on
your on your laptop on in-flight and you
just type that blog post post it to your
blog on your local your local times to
be when you get home you just replicate
that blog post to your life blog and
it's published so you could like life
interact with your blogging software but
on your local machine and then whenever
you you are available again you can can
make it available for everybody else
well so the other another example like
like Gmail right it's a great service to
makes it so not to worry about setting
up smtp stuff but everybody's hitting it
all at once then Google's load is going
to spike whereas if they were using
CouchDB to provide an offline mode you
know email client then they don't need
to worry about latency because if you
when you go to hit your replication
requests to bring yourself up to the
remote or to push to the remote it's not
a big deal if it takes five seconds for
that replication flow to start and so
when you're optimizing for throughput
and not latency on operations side you
can get a lot more throughput so offline
mode can give your users a really snappy
experience but with more predictable
lower load on your servers so yeah
hopefully we'll see this happening a lot
I mean we already are but in the in the
future people will understand that
there's more benefits than just remote
availability for offline mode the
biggest thing about cloud computing is
that it it kind of pretends that the
network is always available and like
Wi-Fi here it's pretty good like big
props to the Ops guys but when you're
really really really really an internet
connection it won't be there I won't be
too expensive that you like like worry
about like paying 50 bucks for ten
minutes of internet or like I don't know
3g or GSM just goes away and like you
have some other sort of issues so to
have stuff locally that you can work
with and sing like the replication is
pretty resilient again like against like
networking problems so if it if it
breaks you can just restart it when
networks
back we've definitely replicated like
from Portland Maryland via his iphone
how that was like my Wi-Fi in my office
went down so I attended my like 2g
iphone through my VPN and then I
replicated catch at Damian's catch to be
blog to my machine through that 2g
iphone and across the world that was
pretty pretty amazing so then yeah
offline mode is like replication is good
for this but what we're really here for
is the peer-to-peer web we want we want
the applications to live there soon as
the kids could hack them because like
you know I want kids to get in trouble
for programming too much because they
took apart their I implant and put it
back together and the way they like it
and so you know it's the same thing the
only challenge here is is trying to find
you know a way to tunnel the HTTP
between them but you can right tools to
get around that or at the worst case you
know have an ad hoc you know public
server that you both replicate via then
that can change over time so yeah in
this case when you're the application
developer like it's like developing for
the desktop you're not running anything
except for maybe you know a github
repository people can pull down from
there or from your you know your starter
CouchDB they can replicate in and then
the application from there is out of
your hands and it will bounce around you
could drop new changes into the pool and
you know maybe they'll get picked up or
maybe they won't depending on what your
user base is like but I think that the
idea of building web applications in
JavaScript and HTML and having them be
able to go anywhere and you know be
hacked on by anyone this is this is what
excites me is what got me a new couch to
be in the second place I got into it the
first place for some other stuff but
then I got really fired up when I
realized that you could do this so yeah
that's that's a little bit about
programming at the edge there's still
still some other topics we want to cover
but first I want to just quote from the
a GPL which is not a license that I
necessarily think we need it sucks but I
do think that it describes it describes
what happens when you write applications
in this manner it's a public use of a
modified version on a publicly
accessible server gives the public a
success
the source code what I say is we don't
need a license to make that happen
because that's just what happens when
your code runs in this in this kind of
couch app public manner so yeah that's a
just you know make the future so now
back to the application the document
programming model context is expensive
that's what happens you know when these
big applications fall down it's because
they're trying to load up like 50
documents in compare mall in one request
response cycle and that's just not where
that belongs there's you gotta decide
what goes in the request response cycle
and what doesn't and how we should be
very conservative about what it lets you
put into that cycle because we're a
database and we're not going to let you
put something into that cycle that's so
that you could you know do s yourself so
yeah the context stuff has to come
outside but there's a lot you can do
without too much context how you go in
all right well so rendering documents is
HTML is accomplished by a JavaScript
function that gets the JSON document as
an argument as well as some of the
headers information so you can switch on
the accept header to return HTML or XML
or whatever the test suite returns a PNG
file from one of these functions just to
make sure that it works and it's it's
really simple you doubt put whatever
string you want and that's what goes to
the browser so the nice thing is that go
back one slide you right this one's for
for your application that when a browser
hits it you serve with HTML if I can API
consumer client hits it with the
application JSON accept header it will
get JSON if feed reader hits that you
get the XML all from the same source so
you get all that for free from just
using the standard HTTP API so there's
no nothing else you will need to provide
a feed for full foil blog for anything
else I don't let the I also it's fun
because you can make applications like
we've been talking about but it's also
really useful for a couch tb's core
mission as a database because you can
make it so that you know you have some
legacy API that you need to
but you don't really care about and you
don't have to maintain a whole other
infrastructure for translating your
couchdb install into this legacy API so
if you implement it in JavaScript then
you can put it up on the couch and it'll
just live there forever and you never
have to deal with it again like for
example back in the day coach to be used
used to use XML because of JSON and I we
switch to Jason everybody will say yay
because only some people said like well
we like XML we got to still go to use
XML and that's where we will give them
this they can like transform the JSON
transparently into XML they can still
use that with whatever technology they
happen to use yeah our spider monkey
interpreter includes the e 4x bindings
so you can you can do native XML
processing as well whereas I said like
our core mission of being a database we
do this a part of the straitjacket we
put you in is that you show one document
you don't like you don't load up a
document load up three other documents
because of it and then change one of
them and you know do something different
because of you know like who the user is
what you do is you yeah you just render
the the HTML or whatever from the
document and that means that there's no
side effects so you can't go you know
like having a get request so that screws
up your database over time I that that
that in turn and hidden from the
application Mike's like three other get
requests and five posts and whatnot that
will totally not be able to like sustain
a lot bigger load and because there's no
side effects it's cacheable so that
means that you throw like a varnish or
whatever in front of couch db's you know
an HTTP cache there and now things are
it automatically sets up the e tags for
you so when things are the second
request it just comes out of the cash
rather than out of cash to be so yeah
showing a doc simple related what you
can list views so a view and CouchDB you
know gives you a sorted list of you know
documents or parts of documents based on
whatever key you choose so it's great
for making like a list of all the blog
post by date but that's in JSON so if
you need that to be an HTML you can't
very well load that whole list up into a
JavaScript function and process it
because it could be millions of items
long so what we
have is one by you know one row at a
time processing so you run once to set
up the head of your document and then
after that your javascript function gets
called once for each row and garbage
collected afterwards so you're never
gonna all that run some constant space
you can kind of blob memory for just
pretty producing an atom feed out of
your blog posts yeah you can make an
atom feed you know hundreds of gigabytes
in size and couchdb would never hit more
than one row at a time so yeah then
you're up your clients parts did I guess
so yeah that's that's the point of that
you know it's another straightjacket you
list one row at a time but at in return
couch TV says well you do well just do
this all you want you're never going to
take down your couch note from it so
sort of the same story with the
validations they're just an update so
it's not update is you know the new
version of a document the old version of
the document if it exists and the user
who's making the update and when you
have that information you know your
JavaScript function either throws an
error it doesn't and if but it doesn't
go loading up a bunch of other stuff it
doesn't it doesn't pull in context to
make those decisions right you're doing
the slides so oh alright yeah so what do
you do what do you do when you need to
when you need to make those when you
need to make those updates you know when
you need business logic when you need
stuff that actually needs to look at
lots of documents you've got to do it in
you know sort of outside of the request
response cycle couchdb has lots of ways
that make it easy to subscribe to
updates to the database you can write a
an OS process just like a ruby scripter
what everything gets pinged every time
someone does something you can react to
that we're adding comet hooks so if you
know that eventually at some point
someone today is going to is going to
post a document of this URL you can just
hang there on a get request and you know
only when that change comes through then
the response comes back to your browser
so you can do instant notifications and
you know you could also use that from
background scripts if you want to start
an asynchronous process based on it so
if you think back I'll do what will
Chris said the the taking everything
that would hurt your application front
and is getting taken out of the request
response cycle if you get to like the
big ones yahoo facebook flickr
they tried that a lot that they just
have to serve static content and
everything is preprocessed or this
process as synchronously that's the way
to run big sides and that's like again
we only put things in that you can run
big sites but we own also make it that's
totally easy to do that it makes sense
to run it on a single like small side so
the sort of the last point and this is
more something to think about is how do
you manage user identity in a system
like this in the in the peer-to-peer
system because you can't ask the server
to validate that you know that they are
who they say they are because you don't
know what was the server when that
validation was made so you've got to
thought about this for a while and then
I thought I was crazy because the only
answer I could come up with was by using
you know sort of the gpg yeah the web of
trust gpg style signed documents and and
we know hold that oh well that works
yeah well then the users I mean it just
hasn't caught on and that's not that's
not like an indictment of the technology
but it's really hard to make the
metaphor easy for people so i'm working
on that end but while I was sitting
around thinking I was crazy i talked to
some people who know lotus notes really
well and that's what Lotus does so I
guess it's not that crazy sort of
similar the deployment and it might not
be like trip to gap cryptographically
like super secure so if you like if you
run your corporation get a bunch of
messages that is signed with the key and
you know okay that guy's jack and jack
like send me send me these messages and
I know they all these other measures
messages that I'm now getting our sign
with the same key I'm pretty sure the
same person centered that send the
earlier messages and if I know the
earlier messages we're coming from Jack
I know the new messages that are also
from jag so this is like there's the web
of trust thing is something we take out
of there that's not implicit in the
technology which makes it a lot simpler
so if you like really need to be like
cryptographically sure that that there's
no identity behind a message you might
need to like introduce a little more
more headache for the user but for the
general user it might look like Jack
that's Jack it's all right yeah so I've
been kind of like diving in researching
like loading up all the old crypto
libraries and JavaScript and like
nothing really was quite done there's
some good implementations of the
algorithms but
like of the of a ski armored versions of
the key pairs and whatnot so if anybody
here knows JavaScript crypto better than
I do which is probably not I don't know
it that well but I did some research
like let's talk because I want to make
this happen and I spent like two weeks
researching it I think that I mean it's
just right there it's low-hanging fruit
and once we have that then that
peer-to-peer apps thing is going to be
totally ready to go so yeah we didn't
get to do much in the way of actual
putting color on the screen and because
we wanted to like give you the feel for
a CouchDB and what it can do but I think
we're going to do a track be thing
tomorrow hopefully so if you want to
come c code will you know put that up on
the screen and mess up our code examples
a lot probably but yeah that's oh and
one last thing we're giving out free
hosting for CouchDB we have were you
know maybe I don't know if we've got
this this this project where we try to
like sell couchdb for people who are
interested in it and we sort of just set
it up so we're not charging for it and
we like need people to break it so
please like sign up and break it yeah so
yeah so hosting couch i oh and invite
code for today is stone dash horse so
you know just think of the statue and
find us on Twitter and find us in the
hallways and yeah thanks for listening
thanks oh well it's a good question is
kind of two parts so the question is how
do you get you know with MapReduce you
can build up context but um or how can
you build up contacts the other one is
can use that context and validation
function so you can't use the context in
a validation function it's just one
document just one update the old version
of the new version so you're basically
validating for well-formed pneus with a
little bit of the user context there to
make sure that they're not lying about
being the author if you decide to do
that in your function but you can do
join like queries in MapReduce by
collating rose that you want to have
next to each other you can just give
them similar keys to little collate
contiguously so you can you can pull out
for instance up
blog post in all of its comments and a
single query by setting up your indexes
correctly
oh well it just wouldn't that's like an
application concerned as far as couchdb
looks at it so yeah you can have you are
eyes as parts of year so this is quote
from Jacob kaplan miles from the django
team and he said like django made a SP
look out of date because django was made
for the web and like asp was pretending
the web didn't exist and he also said
like HP makes makes Jango looks outdated
because cash to me is not made for the
web it's made off the web and the web
doesn't have like there's no integra
france there's just links so catch me
has jostling sketch is made of what all
the web gives us
yeah if you have secret data you know if
you file your doubt is public then you
can just use your validation function
put cow should be right there on port 80
and say only let you know only let
admins update or whatever but if you
have secret data then you need to use a
proxy
what I grade he did that there's a
patient zero that we
neither chance to look at yet but like
he did it in a weekend afternoon or
something that was really really quick
that he width of his own authentication
scheme soaked actually be the code base
it's a very very modular you can like if
you happen like you all like the
JavaScript but if you happened to not
like the JavaScript you could all that
although that in Python or Ruby or PHP
or whatever yeah I wouldn't see why but
you can very easily swap things out you
can write your own URL extensions you
can write external a nexus we've got a
project that integrates with leucine so
you get full-text search all that is
very very simple to understand we should
mention too that the code base the couch
TV airline code base is a great way to
learn erling because CouchDB has a
well-defined HTTP API as soon as you're
comfortable with that API you look at
the code base and you'll start seeing
things that you are understanding
recognize
there's multiple ways to do backup one
is just having a second node to
replicate to to do real like a host
setup or host backup you can from a live
cow should be instance you can just run
our shrink or CP on the database file on
disk to your e to your backup target
location and then reload that into a
running so over again so couch tb's file
structure or the file is append only so
your art if you are sync it you'll never
theirs will never get an inconsistent
file we don't ever we don't ever touch
anything we've already written as
there's no complex tools we need to
write you can just use the file system
tools such a backup so yeah and then
once you are synced over then you'd use
replication to bring up to it bring it
up to date with any updates that came in
while the rsync was running
it takes about six months like the first
few months I was like Damian cats as the
guy behind couch TV was talking like
what kind should be sucks it can't even
do this and he's like I think about what
you what are you trying to do here like
okay I'm trying to do this and this is
how it works and i will start doing
nested sets and mysql and it can't work
I can't walk it out how to do it in a
MapReduce view and I get pic take a step
back do it like this and then use the
view like that like yeah that's solely
up is a super works and that's not
nearly as complex that's what I've been
trying to do with the mysql database so
you need to unlearn a lot of things that
you're familiar with from a relational
database it turns out the document me
tougher comes from the real world so
everything that we have like on paper
receipts dog all these are documents and
they have the same properties that car
should be documents have they are
self-contained like my business card is
a document that has that it doesn't say
if x equals model I just don't have a
fax machine I don't make that explicit
so specifically how I was able to start
playing with it is i had a rails app and
what I did is I had my main model you
know like my user model and I just load
them all and loop through one at a time
and you know I was already kind of
halfway converting them to JSON for
other reasons of my API so then I just
started dumping that JSON and CouchDB
and that gave me enough of a grip to
where I could start playing with it
because that user models going to pull
up stuff from other tables if it needs
to to make your JSON so yeah so just
denormalize in your old code and push
the push the documents or rather normal
i yeah pull it all together and then
push the documents in the CouchDB
oh yeah each database is one file so
there's a couple of things you can do so
if you have like a user application
where you don't need cross-reference
user data such as an email each user get
to sell its own database so you've got a
bunch of files and like a tree was
tested with over a million data
databases in a single server so that's
not a problem and even very big
databases we've got there's one project
what Chris was doing 19 million
documents like we got a thousand
documents a second and then we add zup
for day and the insert rate after after
a day of inserting a total of like 86
million documents then degrade so well
integrated but like was not hardly at
all I mean you know it's order log in
for inserts so so yeah and we've got
installation that I have like around 200
gigabytes of data and single database
and they work just snappy the only it's
a bit of a pain to like copy all that
data back and forth and you might not be
comfortable with that but it works and
there's compaction so the file is depend
only but occasionally you know when it
starts to fill up your disk you need to
start compaction which which copy is
only the live data out of the old file
into a new file sort of like vacuum and
in postgres or see polite or
generational garbage collection right
so the catch to be API is so simple that
some guy the guy said meebo.com like the
web IM client folks they took courage to
be until we need sharting like we really
need it and they just build it in an
engine X module and a twisted Python
client to merge views and I'm like well
we've got the shouting thing and we're
like that's pretty cool can we see some
source and I got we got to talk to our
lawyers about that I can't do and a week
later or two week later they came back
okay we pull it up a google code on the
apache to license so everybody cutting
now use that like in production stuff
and it was really really simple to do
just because of our like HTTP API
you
so you have people people will teach you
not to put
falls into your database because it's
bad idea and the way you'll be using
relational database is like going
through a middleware layer like swapping
from Colonel n to use the land for three
times before it hits the HTTP socket
against sent to the client that's a
really bad idea unless you like a very
lightweight binary stuff that can like
that you need the management for button
couchdb it gets streamed from this
directly to the user so it's not a bad
idea to put binary stuff in to catch to
be and when I did the de binary
attachment API that stand alone I
stopped benchmark testing it with the
eight gigabyte movie father just put in
and out there were no problems i went
through i'm at grambler hunting lately
and i was able to make the files a
little you know it does some bookkeeping
in the file and i was able to pull some
of the sparseness out so he had the the
programming is about trade-offs and the
trade-off that catch me makes is it
trades reliability speed and whatever
else is in care should be for disk space
because disk is cheap so you need like
if you're in a very like tight disc
environment casual you might not be the
best choice well yeah that's our gambit
because this cuz disc is getting free so
you
no that's not
the concern of cash to be but the fun
line file system yeah but it's also it's
pretty resilient in terms of you know as
long as you don't get hit by a cosmic
array right in a b-tree index and you
don't try you know a lot of the lot of
the data in the file if there's
specially if there's a high update rate
and not just new documents well that
data is you know redundant at a certain
point
you
the one thing that you need to keep in
mind with college
that's true for all other applications
they are not optimized for single
maximum speed but for concurrency so
we'll be able to hurt like you get the
same throughput but you can host a lot
more concurrent users so the problem
with lady is that's it's single core so
you need to run a lot of ladies on the
multi-core line is pretty good on the
multi-core what we did what I did
benchmarking for a client is put in a
varnish in front of couchdb and because
varnish is a lot faster htp handling and
also does a little bit of caching I got
like twenty percent more read read and
write out of just guide should be would
launch on the same node so their
advantages of complaint combining these
if you just want to use engine X to
serve static content and you don't have
a database in the back end so so if you
lead the data management part of that
which is pretty neat then you just use
casually but you can also use a
combination to make it like lightning
fast or the replication so you have done
it set of data
that we've got you tags on all our
attachments also the yeah I mean there's
no there's no real reason not to I mean
we are the little cost should be
architecture is set up to be
stream-based so we don't reckon a buffer
your 40 goodbye detachment in RAM and
then and then send it out to the client
so yeah we may not be as lightning quick
as some of those other ones because
we're not optimizing for a single
request latency but we should be able to
you know not slow the disk down too much
well it's it's still fast enough for
like the average user so instead of like
10 millisecond would take a whole 100
milliseconds but it's still faster than
you I can see it because it's you know
trying to get a lot of 10 milliseconds
in a row because you can have 50 100
millisecond ones at the same time you're
like you need to take these numbers with
a grain of salt or couch be might be
like this is just pulled out of the air
so catchy we might be 10 100 times
slower but that just like it makes no
difference for the user and you have
kinda have a lot more users and you have
the same data throughput so yeah I'm
come out tomorrow will be across the
hall I hope and will show you will show
you JavaScript and will be around all
today just grab us great thanks
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>