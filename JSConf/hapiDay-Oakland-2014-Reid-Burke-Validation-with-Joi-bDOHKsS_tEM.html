<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>hapiDay Oakland 2014 | Reid Burke: Validation with Joi | Coder Coacher - Coaching Coders</title><meta content="hapiDay Oakland 2014 | Reid Burke: Validation with Joi - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>hapiDay Oakland 2014 | Reid Burke: Validation with Joi</b></h2><h5 class="post__date">2015-01-26</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/bDOHKsS_tEM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">a lot better awesome my name is Reed
Burke I'm here to talk to you guys about
happy and how we use a module called joy
and I'm going to spend about half the
talk talking about where he's happy a
little bit about give you some context
and explain really just my favorite
feature about joy and encourage you
hopefully to go and check out joy for
yourself so I work at yahoo joy is
hopefully at the end of the talk you'll
see that joy is useful in happy of
course because all you folks have used
it I'm sure if you are at this
conference and if not you really should
be and we also use it in things outside
and i'm going to share about that for a
little bit so if you are interested in
the slides or want to know more find me
after the talk or you can get find me
online on twitter and github a dream so
I work for the mash team at Yahoo and
what we do on this on this team that's
the name of our team we actually we work
on build system for the whole company so
everything at Yahoo is actually built in
like one where the team that is
essentially responsible for if you want
to deploy code or deploy whether it's an
app or website whatever it is it used to
be that you would have to do this you'd
have to have someone dedicated in your
group doing this and instead now the
entire company is being built on the
same system which we done this over a
period of believe it or not three months
we moved everyone from many different
version control systems to get just
that's all and it's it's crazy but also
great because now you know we used to
have folks we're trying to encourage
folks to come you know use the
centralized system now you they just
have to but it's also really great
because not just because they have to
because it actually provides a lot of
benefit and that's something that I
think instead of having hundreds of
people literally hundreds of people
trying to solve this problem themselves
they we get to work with those folks so
that they can freeze them up to do what
they're best at doing and we get to work
on the centralized thing so give you an
idea of what we do we have the system
that i work on which is one of five
systems and all them are being
consolidate
it into ours ours is responsible for
6,000 builds per day for five to six
thousand builds a day and the whole the
whole companies like it or in the tens
of thousands everything's built from get
like I said everything is built with
Jenkins and we're definitely the largest
installation of Jenkins anywhere you
either are building your own thing or
you're crazy like us and so the things
that we hear all the time from people
and this is like people would be
spending so much time maintaining their
own CI system whatever it was typically
Jenkins that they weren't able to
they're just kind of tread water and
keep their their head above water and so
the the biggest questions that we get
now that they don't have to do that
anymore and they're really want more out
of you know they look at we look at
what's available outside of you know
like what what other folks are doing
with CI and and we we think we can even
improve on that but the biggest thing is
as you're deploying things continuously
where what's the status of this commit
not the status of a build number right
now when you have when you get out of
having just a small system and get to a
large system we have mini builds it's
difficult to understand where a change
set moves or where artifacts move across
an entire large system and so so build
numbers are pretty terrible what and
also when a build fails or there's it's
there's a block getting your thing out
to production why did it fail and so I
work on a system that uses happy that's
called cinch and so it's one part of our
team and it's commit centric view of
deployment that's that's basically what
it is it answers why things failed and
it's like an API that's used by other
teams to create like dashboards and also
just like build status pages and other
things and so architecture this to real
real quick is it's a happy server and v8
we move to it it took it did take me
about three or four hours to to migrate
from sissi v62 v8 and it's not it's not
that bad all the changes I think are
wonderful so so I I'm really by the way
I just want to say I'm really happy that
a happy decides to make breaking changes
that make sense and are really well
thought out and they have really great
release notes so anyway that's even
though they're breaking changes I'm
really happy to see them
so we have everything as plugins it
seemed to be a common theme I'm really
happy to hear that everyone's doing this
we have all of our web services in the
plug-in we have something that
subscribes to all information about
builds every log line is is something
that's an item in our queue and then
something that provides metrics so we
have a plugin that adapts happies events
to metrics then we have so so we use
Redis as a as a queue and I suppose a
shared like cash among all of our note
instances so out of all like this this
this slide here we probably have 60 of
these instances that are all processing
data from like five Jenkins masters that
are all feeding data into it and that's
happening throughout Jenkins plugin so
we have a plug-in that's all it's doing
is pushing information to read us and
then what what we get out of on the node
side is just handling that throwing it
into a database and then having everyone
hit it to get their reason why their
bill failed and where their commit is so
it kind of takes you know what's coming
off of this you know build and inverting
it so that you can query everything by
your code chicken so an example of what
you know folks you know would do if we
didn't have happy and what we see a lot
and in other other places that we have
some value and then you're doing this
all the time and it's never this simple
but you this winds up being horrible for
a lot of reasons when we have joy as an
alternative so instead with joy we get
to do this and hopefully this isn't new
to anyone but what's great about this is
that this when you have this everywhere
you could just take the object inside of
here and then just put it in a shared
place and then wind up if you ever need
expect the same result you can instead
of copying pasting or having a function
you wind up having a an object that's
very descriptive and so when you when
you have changes to this is great so
instead of writing changes like say if
foo will become something else because
we're say we have Baz now right as a
thing that's we renamed something one
example that's more real that doesn't
fit on the slide though is we changed
something for commit sha to commit sha-1
because some things were using commit
sha some older versions and some were
using commit underscore shot one
so I wanted to support both and so
something that we wind up like a
prevalent idea at Yahoo that that's
changing really quickly is the fact that
you can't is like you think of you know
when we have breaking changes we're just
going to deploy all these things and I
want to go we're going to take down the
old system and restore with the new
system and do that by rotating you know
these giant subsystems out of out of a
rotation and it's had the old system
running for a while and kill them off
and then we have the new system which is
all deployed together by Khan and that
doesn't work like we don't want to do
this instead everything needs to be more
loosely coupled instead of very tightly
coupled together so we want to support
different things different sometimes
different schemas at the same time so if
this is the case we wind up being able
to use joy to do again this very simple
example but why is it being very
powerful in a large system where you
could just support both and still have
like our new configuration and and we
just wind up changing a lot of these
together as necessary and then killing
this off again by having continuous
deployment we don't have to have this
rename in there forever we could just
get rid of it after a short period of
time so yeah we use this everywhere not
just in not just in our happy
application but also there's other
things that also are handling data from
Jenkins and so it's able to verify that
the you know we we have many instances
of Jenkins that all run different
plug-in versions that pass different
data to Redis and so this verifies the
data is correct in the format that we
expect we found tons of issues with in
various parts of our systems by using
joy and it's amazing it's also very easy
to read I think it's a very readable API
and I really take i really think that
the folks who are maintaining joy are
doing a really great job with making
sure that the API stays a very high bar
code coverage is also a benefit and you
get if you're using a lab with and
trying to get a hundred percent code
coverage as I am like using this as a
much prefer to something like this where
if you have a lot of these it could be
difficult to hit everything that you're
checking and you might be thinking well
you want to
be able to check all these things and
that's true but you might want to but I
I also think that a you should only
really be checking our writing test for
things that you're more likely to break
and instead of having to write this over
and over again I would encourage you to
be using joy where instead you were only
checking to see if a error ever happened
and not if every single possible
validation error ever happened leave
that to Joy's own tests which that you
know it's very well tested so then you
don't have to check for common mistakes
to get a high level of coverage and then
also like this is an example just lifted
straight out of if you guys aren't
familiar with with joy this has just
lifted straight out of that joy read me
that shows that this isn't just for
strings you can it's very expressive and
it's I find that once you start using it
it becomes very easy to read and not
just for me but also for machines and so
we've seen people talking about loud
today if you guys haven't used loud it
can read this information in your happy
route configs and show you formatted
documentation we also seen swagger today
which also reads this which is great and
so yeah it's it provides benefits for
people and for creating your api's so in
happy particularly um you know so you
use this you use joy for your request
schemas I'd also encourage you I haven't
seen a lot of examples of this and your
response schemas and so what this is
allowed us to do is prevent sharing too
much we might get more information as we
proxy something from another system or
we're getting information out of a
database we might be getting more than
we expect and so with by using a
response schema with strip puck known we
can remove things that we don't expect
or don't want to share with our people
who consume our API and we can also you
know kind of massage values into the
right place by using rename so if there
is something that's legacy coming from
an upstream system we can just take that
into the correct format and hand that
off we also use something like the last
talked actually just have different API
versions which is also useful so this we
could serve something old to the old
version and then rename it for the new
version using response schemas others so
let's see also
loud is great I want to put it in big
text here so you don't miss it and I
really hope that this gets even better
i'm looking forward to like i've tried
to use swagger before and it just seems
like it's a it's a lot and loud isn't a
whole bunch it's just it's very small it
doesn't depend on other like front-end
framework things that allow you to give
you the nice try it out button so I'm
hoping that I know like swagger has a
lot of work that's happening with it
last time I checked like few months ago
I'm just like this is great i'm like
really trying to sell my team on and and
with great success on how great having a
consistent API is where you don't have
to have api comments to go out of date
instead you can use loud and it's very
things stay up to date so for the things
that I want to use not the future of
half of joy but the things that I want
to do with it is having schemas that are
shared and so the big thing here is
right now sometimes we have duplication
and our schemas sometimes like you know
one of our plugins and one in our API
don't share the same schema all the time
there's nothing in common between there
I suppose that like a like we don't have
a schema node module and so I really
like therefore there would be a way to
share that because we've gotten new bugs
where schemas deviate and so one system
won't accept the others output and vice
versa and that's a really big pain and
so it's possible and this is a lot
better it's a lot easier to find bugs
now that everything's in an object
instead of everything being in a whole
bunch of conditionals so so this is the
logical next step and also all of our
how everyone I don't have enough time to
get into like how awesome this is
basically but if you everyone views
Travis wrecker Circle C I you're used to
defining all everything you want to
happen in your build with a
configuration file and indeed the k
thats true even though we use jenkins we
actually use note to script creating
jenkins jobs and deleting them and
everything it's awesome and it's it's
actually limited right so instead of
being able to do whatever you want we
have archaea type say if you're trying
to build a node app then we will
automatically run all the default things
that makes sense bring in
give install NPM test when you're ready
to publish it publishes the thing using
the standard way that everything at
yahoo's published so so you just have a
single file but we have a validator for
this and I'm hoping that we could
leverage joy moore and these things that
are where it would be really complicated
and possibly would require some
contributions two things either that
built on top of joy that we hope to open
source for like say taking something
that's in y amal and having like that
nice like explanation of what's going to
happen with your build configuration and
have using joy for that so we haven't
started on this but I'm really looking
forward to that I think it's a logical
next step so recap the biggest thing
here is rename I think if that's that's
my favorite thing so if you learn
nothing else like take advantage of that
and joy is useful outside of happy and
you should consider it for even if
you're not able to use happy for any app
that you're writing whether it's a web
app or just the simple library great so
this is my team they're pretty awesome
and we wish here a part of them because
we have lots of ice cream and it's
fantastic this is me and come talk to me
if you have questions thanks so much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>