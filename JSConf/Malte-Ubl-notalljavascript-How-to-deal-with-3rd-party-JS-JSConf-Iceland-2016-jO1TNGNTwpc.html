<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Malte Ubl: #notalljavascript (How to deal with 3rd party JS) - JSConf Iceland 2016 | Coder Coacher - Coaching Coders</title><meta content="Malte Ubl: #notalljavascript (How to deal with 3rd party JS) - JSConf Iceland 2016 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Malte Ubl: #notalljavascript (How to deal with 3rd party JS) - JSConf Iceland 2016</b></h2><h5 class="post__date">2016-09-22</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/jO1TNGNTwpc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">one my name is Malta thanks for choosing
the front end talk I'm one of like 15
engineers at Google not working on
machine learning so differently
appreciate the other people interested
in this yeah ok Google I specifically
work on a thing called amp project if
you've not heard about that it's kind of
a thing to make reliably fast web sites
and like while doing this project and
learned a lot about something that's the
topic of this talk so and the talk is
going to be a little dark so I wanted to
start out on a lighter note which is
that JavaScript really is my favorite
programming language and for so many
reasons for example you can use it to
build applications to make presentations
and just a few examples from from Jay's
comms what we what we did over the years
we made like robots and we made note
copters and we made freaking boats and
remain note rockets of course and you
really can't like summarize it any other
way than the javascript is freaking
awesome by the way when I came to this
conference I was talking to this person
telling like yeah I went to 15 j/s cops
already where she was saying like yeah
you're really old so there's that by
that so JavaScript really awesome but it
does have a really dark side and it's
getting darker when you talk about
third-party JavaScript or as I liked it
to call it other people JavaScript so
it's something we definitely didn't
write ourselves and it's also not stuff
on NPM which is typically something you
actually want because you like actively
included third-party JavaScript works
really differently and some examples are
for example comments and polls stuff
like reviews ads of course I'm going to
talk about ads about social plugins I
could put a tweet on your side right you
just load some javascript file from
Twitter and you trust them to do
something that's nice in it and it might
not be right um I always give this
example
when you like if you were building a
native app and the first thing you do
you say like hey I'm going to make it in
secure HTTP request and load some more
native code from this other third party
that I barely know and in the cat's case
they like redirect somewhere else and
then you load their native code before
anything else happens and run it and
that like seems really not such a good
idea but that's that's how this works
and I my talk is about like some
examples of what can happen and then
later on what we can do to handle it so
it's looking at my my site that had ads
the other day and I was searching in
chrome dev tools for the object tag you
know which is most I mean yesterday I
guess we learned that you can do useful
things with it mostly used alert to load
flash and so yeah so this page had 65
flash objects on them and so wondering
why and obviously it's because of ads
which doesn't really explain it um so so
but here is the the deep inside flash
movies reduce the frame rate when
they're off screen right and that is a
very good idea right that's even though
Steve Jobs was totally against flash if
you reduce the frame rate and you can't
see it that's great right you don't use
as much battery you don't use as much
CPU and so because of this you can use
flash to mathur measure whether
something's on the screen and that leads
us to space or dove Swift right so you
can totally put a 1 x 1 pixel flash
movie on on the screen and by observing
its frame rate you know whether that
pixel is visible and so you have things
ads and so yeah and so obviously it's
very important for the ad to actually
measure whether wishlists not rendered
somewhere deep down the screen where the
user actually scroll there so you put a
flash movie on it and I mean that's
already like a big step forward but
only tells you something like about the
top 00 position so you you you add three
flesh movies and there's actually I
think a standard that says like
twenty-five percent of the ad has to be
visible for n seconds to be considered a
view because you need to have these
twenty-five percent you add a few more
so it turns out there were seven flash
movies on this ad and now there's also
this issue that there's like the
advertiser the publisher the ad network
they don't trust each other so you you
can get to 21 flash movies on a single
ad totally not not not unheard of and
now you might like correctly question me
like yeah my phone doesn't actually a
flash them I'm good and of course it can
get even worse because the nice thing
about this flash solution is at least I
mean it's in a way incredibly
inefficient because certainly have
probably like a vm and each of these
flash things like so I mean you can't
even think about it but at least it will
like pushed you the information whether
it's visible on the screen right and um
so today on an iPhone this is basically
the best general solution you can you
can do all right well you just pull for
where it is right you can never know
that nothing else move to your round so
you can't like listen only for scroll
events because something like a thing
might be somewhere else right so you
have to like literally go and make like
get bounding client direct and call that
like however many times per second you
want and and that is really like the
worst possible thing you could do the
performance right you know you do this
all the time you don't in not even on
screen you're busy pulling like you're
probably calling something I'll get
Bonnie klein direct which is like
basically Tecna browse like you have to
really really really render everything
on this page you can't cheat like the
waveform collapses in this case like 25
times per second and so fortunately we
can do better nowadays it's it's in
chrome and I think it's coming in
Firefox and for Safari we can hope for
the 2007
version so there's an API called
intersection observer where you can just
say like I would like to know what this
is and where this is in relation to the
screen and it sends you events as things
change and it doesn't send you events
when they don't change and it also
doesn't change send you them
synchronously it tells you after the
fact at this time it was there so you
don't have to like do this busy waiting
so that's that's good so at least there
is a way to do this right um doesn't
mean everyone's using it already but I
think it's a great great change and you
can use this for other many many other
useful things alright so that was Hawaii
we have so much flesh next thing I want
to talk about how browsers parse web
pages it's it's really simple you take a
nation panel talk and look at its tokens
this is basically diagram there's a bit
more complexity there somewhere but
that's essentially how it works until
you see something like this probably all
heard about document right and the magic
of document ID right is completely
synchronous it changes how the current
document is being parsed so even if
there's like an openstack you can like
write into that because it's really
really weird and it gets worse because
you can actually write scripts
synchronous codes and those can do more
document or rights and that wonderful
simple state machine becomes something
like this so we like after parson we saw
we have a script tag we have to execute
it it document writes something we have
to parse the output oh there's another
script tag and then we download that and
then we basically we enter in our state
machine and things become really slow
right so the basically what you get in
like in JavaScript language is you have
the synchronous xhr that gets to modify
the currently parsing document and you
and that that is recursive right and
it's
in strong violation to what I call the
the first law of javascript is that they
all will eventually be asynchronous if
there's like you start our synchronous
because there's you only have to do like
one plus one eventually it will be
asynchronous but this entire the
semantics of document are right do not
allow anything to ever be asynchronous
so even though um every player in the
game might be completely fine with
making their stuff asynchronous if
anything relies on the synchronous
semantics you can't change it and so we
get to the opposite is if anything
relies on being synchronous obviously
every child has to be synchronous there
can't be anything asynchronous and and
and the thing is that synchronicity
really really doesn't scale so for
example um you're like on the website
and was like I would like to have a net
that's all these synchronous and then
but you don't really know how to make
add see you this is like another
javascript file leg do you know how to
make ads that's the synchronous request
and right cause like add source like
many players you like can you help us
find out which ad to draw another
synchronous request and then because you
found out that you make more money
that's Wade like let's ask these other
folks over there if they have better at
another synchronous request and then
they say no no weary soul this to some
other party and then they make another
synchronous request and then they
finally say okay now we try to figure
out how to make ads and it can be a bit
early deep which leads to these absurd
situations way where web page load times
get so slow that you can literally bake
cookies during them there's the chrome
team currently has this experiment where
they kill document right if you're on 2g
that's already launched and soon they
will always do it when you're on a 2g
like connection because you get you get
like document dot write like kiss gates
are 50 element deep if each request
takes 10 seconds you had 500 second web
page load time and you see absolutely
nothing at all during this entire time
which can't be good for anyone right
cool ah so we have how to measure
something on-screen how to load
something synchronously next is the what
I personally found like that was my own
impression was the the most awesome ack
hack in JavaScript ever was actually
done by Mozilla they may think called
Broadway jas and what they built was
this native JavaScript h.264 decoder
that was decently fast and so that that
seems like really cool like you can use
JavaScript to decode h.264 I think it's
pretty impressive now we need some more
context so Chrome Safari both agreed
that autoplay as a feature of the video
tag wasn't a good thing a noble right
and you can totally understand why they
would think this right autoplay means
definitely you have to download the
movie file so you incur data costs
definitely autoplay with sound can be
really awkward like you're on the bus
and you thing like place sound that you
don't want that so they they make this
decision on behalf of the user should
say like um you cannot like all the play
video users always have to tap to play
video combining this with Broadway jas
gets us to this right so some people
were like oh well you can't do autoplay
but we have a JavaScript side h.264
decoder so we can do autoplay because
that is not subject to any limitations
whatsoever and the consequences were
dire you still use the bandwidth
obviously because you download the video
now using like xhr you devastate the
battery because decoding and JavaScript
happens on the cpu this is typically on
devices that have you know a decoder in
hardware that could do this essentially
without using very little battery so
it's running totally on the UI thread
the page shanks because it runs on the
UI thread and and the worst part of this
is that now the legit players on this
Web like us basically we want to do
autoplay we can we
we wouldn't do this but the bad guys can
and so this is I think a good example
for how you have to be careful with
doing these interventions because the
workarounds which typically do exist
once you have a Turing complete
programming language can be much worse
all right this is the very dark part of
this talk um I wanted to continue and
talk about how we as developers can
handle it better my friend may know
typically says like let's put on the web
wetsuit and jump into the like how
can we how come we embrace the bad thing
and at least handle it and as this comes
back for when we like basically we're
working on amp and we're thinking like
how can we you know we this stuff is on
the web we have to deal with it like
it's there what can we do and so we
decided to basically put all the like 3p
code behind this barbed wire fence and
on the web that always means essentially
an iframe and and the first thing we did
was pretty simple I think it makes a lot
of sense which that it once you haven't
like something i frame you can decide
not to load it load content first then
you look everything else let's pray say
forward next part is that what i call a
generally containment right so if if you
need to load someone else's code having
it in an iframe sandbox can be very
useful it gives you you know better
security for example in amp when you
load an ad it will be on a randomly
generated domain right so they can
totally go and set some like local
storage but they will never again at
least in the time of the current
universe that same domain right so that
local storage is just gone um and then
there's not the middle also means
there's nothing on it that you could
hack right you have control of our
resizing because like in typically the
third party code you load it into your
page they own everything they can do
whatever
they want once it's an iframe they have
to ask you like I would like to be
bigger and then you can say no or like
yeah it's cool but it's up to you and I
think one of the also not obvious things
is once you have it an iframe you can
just kill the iframe so one thing well
if everything's on the same frame you
load the JavaScript like it's very it's
like you could kill the Dom they render
it but all this would still be
there they might hold onto references
the Dom so it couldn't really be garbage
collected so having an eye from is very
clean that you can say ah go away and it
really has gone that the memory comes
back and the best feature which isn't
completely obvious is that iframes also
made a gate documented right so um and
this is completely not obvious I think
on so if you have a documented right in
iframe that doesn't actually have the
same blocking behavior on the other page
yeah last thing that we do and which we
so far haven't really talked about
because it's a kind of a get in mouse
game is that we intervene on behalf of
the user so we it's not a thing if you
have something I frame you can like
globally change everything in it but
it's our iframe and so we can throttle
timers and probably shouldn't use these
words because they sound really
dangerous but basically what there is so
there's code in that I frame that says
oh you made another child iframe i'm
going to go there and do the same thing
and what I'm doing is I am throttling
timers so I like I'm going to show code
for that so basically if something's not
on screen like why should you be able to
like call set interval with like 16
milliseconds right it doesn't really
make sense um but they do it all the
time so we have code like this and its
really like this is really dirty so one
like basically there's just one example
there's like five similar monkey
patching functions that go through all
the various ways how you could create an
iframe
and one of them is that you create an
iframe but a new document right into the
iframe there's actually a legit use of
document right but in this case you have
to call document close and so we monkey
patch it we eventually call the original
but we basically be just before calling
that close we documented write another
script tag into the iframe and basically
recursively call us to run that same
kind of we call it manage it's like a
nice word for like 40 link timers so we
go into a recursive time I frame and and
run the same code again and again and
the actual code looks like this so again
we monkey patch set timeout in this case
and there's like similar code for like
set interval requestanimationframe and
in various cases in there and so x is
one of the simplest one so we basically
just forward the set time a call to the
system set timeout but before doing so
we we overwrite the time at least
potentially the second function is the
function we actually have so what we
saying is if you're in viewport you get
whatever time you want it but if you're
not in viewport we'll just add a second
to whatever you ask it makes sense to
always add a second because that means
the order that they expect is still the
same right you go from like 10
milliseconds to 1010 or went from like
even if they ask for 10 which will be
legit they get 11 so that's kind of like
doesn't really matter we wouldn't have
cared but at least the orders now as
expected and so so all of these things
together really make a difference so we
I particularly saw this ad that was
using this like Bravo ajs style h.264
decoding and it was um even if the ad
was invisible the page was basically
unusable and with this code the page is
only in visit unusable when you see the
ad which is actually a big step forward
because you can start reading everything
else and you can like scroll away
because it's like almost as big as the
screen and then everything works again
right and and so
we the questions like whether we
actually went to the AP website and
licensed this picture which you can I
learned yes are we done I you know I
think that like this type of mitigation
where you handle someone else's code is
very very important because third-party
javascript is everywhere and like you
totally want to show some tweet
somewhere right and that's fine um so
it's not something that's going to go
away and that's why I think it's
important to talk about how you can
handle it but in the I think in the
particular ads case we can actually do
better so I again like I'm obviously
working at Google we do render some of
the ads in the internet so I think like
my team is both the privilege and the in
some words responsibility to actually
fix it so I'm not actually going to dive
into what exactly we're going to do but
I I did write a long blog post about
this a bit ly flash and for as the
number of ads for our details for the
long term plan so basically while there
still will be JavaScript around
everywhere we're super super hopeful
that we can at least have a more like
like a healthier at advertising
ecosystem were like you don't have to
mitigate them like everyone's kind of a
legit player yeah that's all I have
again I'm melta crime force on on
Twitter github etcetera thank you very
much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>