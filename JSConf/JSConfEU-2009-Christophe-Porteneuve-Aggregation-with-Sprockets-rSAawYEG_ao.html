<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[JSConfEU 2009] Christophe Porteneuve: Aggregation with Sprockets | Coder Coacher - Coaching Coders</title><meta content="[JSConfEU 2009] Christophe Porteneuve: Aggregation with Sprockets - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>[JSConfEU 2009] Christophe Porteneuve: Aggregation with Sprockets</b></h2><h5 class="post__date">2013-06-22</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/rSAawYEG_ao" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">it's a for instance okay I have an slc
directory and and in there is an
application GS which most likely
requires plenty of other stuff and
please practice that and put that in a
dist JavaScript application GS and
whatever assets you encounter along the
way put those recursively in the dist
directory that's what the dash a deist
says if I hadn't specified an asset
rooted wouldn't copy the assets met for
the provider actives you can use that
from within Ruby code so because it's
Ruby API anyway so that's a quite simple
there's that the main entry point is
gone sprocket secretary and you provide
basically the same thing except you can
use google being you can use especially
double star globbing which is not
necessarily available in your shell and
and then grab the concatenation save
that anywhere and you have a special
instant assets as well to install that
has it all the assets in the SS root
directory so sometimes well you don't
over be or you can choose your OB and
then for instance you're in a PHP world
like so me and therefore you need
something else so what you can do is use
a CGI script that does all this for you
say you have that tree so we have
something that kind of look alikes rails
application we have a sparkle gml file
somewhere up there in the config
directory we have our base javascript in
javascript out there and we have so that
all of those of defaults assumed by the
CGI script which is why I am going with
the convention here but you could
customize this crypt and then we
have a vendor directory with brackets
and in there one directory post bracket
and slc sub sub directories and now you
can have assets sub directories as well
and stuff like that and you can actually
configure all this through the spark
HTML file so this package see how much
fun would tell you won't say what the
load path is so here the lib beth is the
javascript directory plus vendors
brackets anything slc and the source
file the sources that i'm going to want
to to pass here or my site jazz first
and foremost and then any other j/s
after that if if any and i want that to
be output you to public sprockets Jess
so that's what I would want and you
write this and then you have well some
configuration to do that so for instance
this is Apache configuration and you
would just say obviously I want to exec
execute cgi's and add the handlers and
stuff and say okay if I if I request
sprockets that jazz either it exists and
then everything's fine or it doesn't
exist and then i'm going to rewrite that
internally through patched through to my
CGI script and i'm going to there's a
smaller environment variable that you
can put in there which tails the script
to actually save its output to the
sprockets yes so it's cached after the
first request and and all you have to do
in your source is basically just called
stash Park hds which will pass through
to a CGI script and do the concatenation
on the fly and obviously that NPH
sprockets cgi it's provided by the
script so I wanted to show you a couple
of things here's down sprockets
directory so
way to say it was my mouse here so
that's the sprockets stuff and I
actually have such projects and I wanted
to show you so you have all installation
details in that script and that script
is basically provided by within brackets
so you in the X sub directories you you
can use that and does all the work for
you it's just the Ruby script basically
and it does all that work for you and
that's that it's provided by sprockets
and that's pretty neat union of itself
obviously if you're in the rails world
as Sam staff and son isn't us many of us
are likely to be you have an extra level
of candy which is the sprockets rail jam
right which is provided as well by Sam
and what sprockets Ramsdale is it's a
plug-in you just install it or use the
same module if you want to and all you
have to do really is in your route
configuration and that's a simple call
that will do all the mapping for you and
then instead of using your regular
JavaScript include tags you just use a
sprocket single tag and that's it and it
will do the entire concatenation for
this it uses a config sprocket CML file
in your config directory in Wales which
does pretty much the same stuff as we
sell with the pinion with the CGI script
and accept that you don't have to do all
the Apache configuration and stuff
because well stuff the route into the
routing you just r out like this and it
will handle all the caching disputing it
provides rake tasks to install the
assets into to precompile that script
and put it in your source repository for
you if you want to you could do that for
instance if you deploy with caps Tran
you could do that on a cab deploy hook
to every time you deployed free
composite everything update to the SS
put that
you're sore on your server and your
deployment server and then you don't
have to worry about a thing so that's
also recently I was fortunate enough to
do some planting for tennis on freckle
and on Thomas came back to me and say
you know what would be awesome it to
bind that with really good JavaScript
compression so that we can squeeze even
more size out of it and not stop at
regular concatenation so yeah indeed
just because it's one big file doesn't
mean it's one small file which is really
weird sentence i'm really happy with it
and we have something called yui
compressor and why our compressor is
arguably the best to shrink are out
there currently it's one hundred percent
safe and despite that it has a lot of
optimizations and the documentation we
use on sprockets rails and and the yui
compressor wrappers and stuff just
mention a couple options like the munch
options for instance we just shortens
local variable names but there are
plenty of optimizations that you can use
it's currently seems to be better in
yield better results than stuff like
jasmine your shrink safe which is JoJo's
compressor or pack your stuff like that
and one of the good things about it is
unless you really really insist on it it
doesn't obfuscate and you should not
obfuscate your go ever because it makes
debugging hell among other things and
it's not necessary i mean the
compression you're going to get Fisk
Asian anyway is you can beat the crap
out of that by in GC pinpoints neato
doesn't make sense it's distributed as a
draw file so one of the small conference
you have is that you're going to have
some form of GRE installed which is
pretty straightforward on in platform
better so there's a gem wrapper which
again was provided by Sam this is why I
can pressure page you've got plenty of
information on it it it's birthday Yahoo
developing it
ok now Sam has a small Ruby wrapper you
actually put that together acting this
summer right it has a smaller bead
wrapper that wraps the right I
compressor and lets us access that
really easily through Ruby which is
awesome and you just install that and
you can access the volumes kinds of
compression and what's a specific
interest to us right now is to
JavaScript compressor and here's an
example option actually among many which
is managed which just tells it to
shorten local variable names which has
no impact whatsoever and you can tell
that it does that it does a few things
like replacing a square bracket member
access when it's static by a period
notation stuff like that so it actually
compresses very well and you can also
specify the code in the middle goes with
the default but you can specify stuff
like which Java interpreter you went
around and well the job final is located
by default it assumes a number of things
like the draw file is in the same
directory as the jam stuff like that but
you can and also notice that a Yui
compressor does a lot of things not only
JavaScript it does CSS and stuff so we
could actually use that as well to
compress like CSS assets or stuff like
that yeah it is it's distributed along
the gem because well it's licensed in a
way that lets us do that so you don't
have to install and while you are on one
side and wave I compressor on one side
and the gem on the other side let's put
yourself concern so incidentally this
thing is currently in production on
freckle Quinton's and here's a sample
configuration it's a it's very very
similar to what we saw earlier except
there is this new compress option and
compress can basically be just true or
it can be your hash of options that are
passed directly to the yui compressor
gem which usually passes them directly
to the yui compressor library i think
I have mentioned freaking freakish the
offical rules I complete mostly
freelancers deal with their time in an
unobtrusive efficient way and it has
this run so you can see it sparking to
us out there it's my you I come crash
them stuff so it's great and once you've
done that you've got all your javascript
is neatly structured you can use
Constanza it's easily maintainable you
have far less margin issues especially
as if you were unfortunate enough not to
use git and your for instance of
subversion and mergers are usually more
often than not fail force to be reasoned
and so it's you have this comfort of
using properties throughout your tree to
whatever degree of depth you want I
think we have yeah close to 60
JavaScript files on freckle and um three
or four levels of depth and uh and it's
compressed it's me to find well it's not
compressed it's it's yeah it's minified
in in the best possible way it's
constantly they do that one thing the
phone is outputted and stuff is great so
what's left for us to optimize well for
instance you could tweak your assets
HTTP server you could gzip for instance
which you release the crab it up any
kind of wire compression you're going to
be able to do and you could cash you
could configure your server and now
whatever reverse proxies or whatever you
have to catch the hang of it and heck
out a bit on the client side and if
necessary if you decide it's worth it
you could actually upload Main Street
believes that you use to the Google Ajax
API system which we'll see in a moment
that again is not necessarily what you
systematically want to use because these
guys have some form of latency
themselves here's an example I've
actually configurations actually taken
straight out of Thomas book JavaScript
performance parts
and here we mostly say like very basics
like any kind of text resource basically
should be compressed and expiry should
be active and it should be really far
away and to change that we're just going
to change names when we use rails
application rails automatically adds a
time stamp which is M time based at the
end of any asset anyway so we're we
would add we would have time stamps at
the end of all of our assets and if the
change we're going to just bypass cash
because the the result doesn't feel like
it's the same at all even name wise
which lets us put really long expiry
times here so you see that well cache
controllers public by default cache
control is most often private I think
its rails default on that point which is
good for stuff like banking or stuff
when you really want to ensure it's not
going to be character especially by
reverse proxies but here we're going
like okay let's uh let's let reverse
proxies mostly catch the hell out of
this which is great for with increasing
throughput while reducing the stress on
your application server and we are
killing any so V tanks the reason for
this is that e tanks or really dependent
on the kind of HTTP server you're using
and some of them are going to use weird
local stuff like the local IP and stuff
to use e-tags and so when you start
distributing your assets among a CDN or
whatever every single node will have
different attacks when it's the same
resource so we prefer just work with the
the fan named and whatever em time we're
going to have on the files and rely on
the good old if not matter if my fight
scenes not modified logic so here are a
few numbers that's putting onto a
produce better for instance
just the example I pulled with just
prototype the FX part of script oculus
and a very tiny application swept it it
originates out close to 300 k and when
its consolidated in one file Yui
compressed and GZ at it goes to almost
just ten percent of that so that's quite
significant as far as HTTP requests go
well either we play like the old way we
have those those massive files and
that's going to be in my example just
three files which is where under what
actual applications use let's say we
have a very significant application or
not necessarily significant but we use
like the structured split sauce approach
that can go quickly in many tens of
files at the end with this optimization
applied there's only one fine there's
only one JavaScript with everything
that's re dated in it obviously that
means that you code your javascript in a
way that every single pod detects
whether it's applicable to the current
page or not and are otherwise obviously
yeah yeah yeah because the dictionaries
better the dictionaries better basically
so obviously the compressions and works
better and here's a lot of time that
with unprimed cash so on that thing
considering the I went with a massive
amount of files and we have a huge
accumulated latency basically just
latency and that was on a page that
didn't do anything outside loading the
scripts no images know CSS so I wasn't
even putting stress with like concurrent
HTTP connections all the HTTP
connections that the browser could open
were for JavaScript even so I had close
to two seconds latency on localhost
right so I'll let you you do the math
with like actual online and after that I
had close to a half a second of actually
sending the data with all optimizations
gone I only have one single latency the
platen see is actually higher the first
time around because I'm hitting the GZ
ping online often you know like on the
flying cheesy thing so I'm actually
assuming here that the my javascript
wasn't gzipped yet and wasn't cashed on
server side that I'm like the first
client ever so even in that worst case
you know you client-side I'm still
having barely one fourth or something of
of the time on the other side and with
the cash Prime well that's awesome
because even with cash prime if you have
a lot of files you still have to request
to the server stuff like oh by the way
if not modified scenes blah blah blah
and so you can still have a lot of
latency because of that and then I'm
sure you have very small data transfer
because it's mostly headers saying oh
not modified and whatever but you do
have a lot of Latin see what you do with
all the optimizations including expiry
and stuff is that latency is close to
nail for the simple reason that you said
Oh long expiry you might file name
didn't change so it's going to stay on
server on the client and the plan is
just going to load it for local and
bossy interpret
and that's gonna be ridiculously fast
obviously your mileage may vary that
totally depends on your application but
the savings out there and the factor
vary but the savings are very
significant in any case so I mentioned
Google Ajax libraries API that is a
great idea i'm basically google just i
think i have something in there that's
the javascript performance website yeah
those are the Google Ajax libraries API
basically Google maintains a number of
recent versions online for most of the
Dominion library so obviously jQuery
jQuery UI prototype script oculus since
52 when we make it official mootools
dojo sweet objects Yui the entire thing
xed core and recently the chrome frame
system so all of this is available
through the system you can either use a
javascript call to build the script call
or just do a regular script call and
avoid an extra JavaScript interpretation
the great thing about this is that the
Duke top not serving so they have really
good cash configuration and expiry to do
massive jet zipping and they have a CDN
so from that point of view why slow
would say yay on many aspects and you
get an a but the thing is this is Google
CDN this is the same Google City and
that sometimes let's just have like a
five-second latency on Google Analytics
trackers right some what
right it's not the same but I mean in
the end you get the same kind of
potential long latency so the is sander
architecture and don't make any
guarantee of like really you before
serving and they don't have to I mean
they're just providing that as a
convenient force which is great enough
the good thing about this what's really
interesting about this though is that
you're gonna pay that let into the first
time the first time you query that thing
and then you have a really lonely expiry
and so what's interesting with that is
that if enough people use that on their
websites odds are that your user
probably went already recently to
website that use that same library
YouTube through the google Ajax API and
so we already has that URL in n cached
and so you're not going to have to load
it at all you're going to benefit from
that shared cache system and it's going
to be good fast um I'd like to say thank
you to Sam because this is all this is a
good bacon in system july this is all
thanks to him it's been working on that
on whatever spare time he has if any so
this is all open source and this is own
get have you're more than invited to
forking it and play with it there are a
few things that are on my folks
currently like the sprockets rails yui
compressor binding is not yet in the
optional sprockets warehouse is just in
my in my fork and some has to do some
review with it and with that and this
very tiny audience it's really weird
i'll just say thank you and um if you
have any questions probably not you
probably not anyone actually the odds
are and uh yeah
alright
not in the current version now you will
Plus that would be kind of weird but uh
yeah I she needed that you just have to
patch the city iphone yeah I can see
what you mean well the CDI is just for
visuals so you can definitely tweak it
to whatever needs you have and look at
the htp power amps and and tweaking that
probably filter on the remote IP and
stuff like that and I HTTP basic
authentication maybe in that case and uh
and I have it tweaked however you want
yeah or you could just like upload a new
sprocket CML and then go but on that's
what it is
at all yeah yeah it's done by Sam but it
has no relation whatsoever to put a type
or anything it's not really basic
JavaScript yeah
anyone know it's I think internally it
works with the EOB to just change that
but aside from that I don't think
there's any specific template featuring
but since it's a hobby though you're
well technically you could you can put
on now actually because it's it's going
to I would have to check in that yeah
it's I either attr be and technically it
is Ruby code so you could do whatever or
is just passing for that small snippet
that's more than you know a less than
person equal snippet and replacing from
a hash but i think it's yah be actually
and so that you could do loops or
interpolation or anything i'm actually
i'm just check that out very quickly
there's no require a visa that sounds
like constant oh well yeah but that's
just brackets so i would have to i'm
just up in a quick sprocket source
that's actually not going to be on that
session I'm going to have multiple users
on that thing I tell you that right away
yeah
so sprockets
so the way it interpolates as a
preprocessor
now it doesn't use your be so it's it's
most likely just yeah it's just a G sub
call so currently it uh it wouldn't let
you do any significant yeah there's a
small interpolate constants call and it
does a G sub so and pools for my hash so
currently it doesn't do anything like
that but indeed especially as its Ruby
based you could just pull off your be
and do an ARB eval of your stuff and you
gain the whole interspersing the whole
ability to intersperse Ruby code in your
template and get some form of templating
because of that do you have any specific
like you
right
mm-hmm
right yeah so stuff that you could yeah
that you can do with like load or
regular load codes and stuff like that
oh yeah
either that or one primitive form of
that would be to just use that to switch
between several configuration files but
the gist final concatenation plan
selection and to get finer grained yes
we need stuff like if therefore on
whatever an hour and specific well and
then we just have our includes or
regular include codes
huh
alright well thank you for having been
the elite group in this session and
one short one long then
right but then you would depend on Ruby
and rubygems basically yeah yeah which
are however today mostly instant by
default on just about any distribution
but uh I think I see where you're going
it does have I don't know how they well
you do have a build process today
because you're already cutting your
source down and slicing and dicing and
then building building it back up again
and now it reminds me of the early days
of mootools where their main selling
point was like oh you can just grab
whatever and we're going to concatenate
for you and now and now we're yeah there
I think any anytime you go into
real-world application that actually
depend heavily on JavaScript what you're
gonna need that currently like where you
know 37signals mostly does regular full
concatenation they have this big old
digesting provided by rails and then the
cash the just cash it and having a fine
jus sittin by apache but they don't have
required they don't have anything they
have to basically explicitly grab
everything by alphabetical order and put
that in there and there's no there's no
actual require system does not provide</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>