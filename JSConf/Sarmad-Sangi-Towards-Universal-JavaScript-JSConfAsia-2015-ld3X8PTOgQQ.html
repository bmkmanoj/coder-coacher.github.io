<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Sarmad Sangi: Towards Universal JavaScript - JSConf.Asia 2015 | Coder Coacher - Coaching Coders</title><meta content="Sarmad Sangi: Towards Universal JavaScript - JSConf.Asia 2015 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Sarmad Sangi: Towards Universal JavaScript - JSConf.Asia 2015</b></h2><h5 class="post__date">2015-12-21</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ld3X8PTOgQQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">alright so there are two sections to
this talk one is what and why Universal
JavaScript where I will be talking about
livid of about benefits that it brings
along and then another one is a little
bit on how we can build a simple
isomorphic sorry universal JavaScript
application and also what are the pain
points that you might face if you are
building such application alright so
that's me yeah so I'm mostly doing
front-end a trademark in my spare time
I'm doing some work on like just looking
around react native I build a couple of
apps on node stuff like but that's
pretty much it previously I was doing
some PHP and Java hated it and even did
some native Android so now mostly
front-end web front-end a red mark is
one of the leading online grocery stores
in Singapore we are technology and a
logistic company and that's rad mark so
just take a good look we do deliver
groceries why drones in case if you guys
want to order that yeah alright so
moving on
okay so what is a universal JavaScript
some people refer to it as isomorphic
JavaScript some as universal they pretty
much mean the same thing and so
Universal basically means that Universal
JavaScript basically means that
JavaScript code that can run in an
environment agnostic Bay and in short Oh
what it means is that it can run on a
server and client but also on you know
like phones mobile phones iOS android
etc isomorphic pretty much means the
same thing as well just that I
personally feel that Universal gives it
a good tag to a JavaScript the intention
the intent message that goes around is
like JavaScript that can be used
everywhere and i think that's that's
going to help javascript itself there is
some discussion going around like a lot
of people who are saying that isomorphic
is a more technical name and and it's a
good even though it's it might not be
accurate but so there are some people
who prefer isomorphic there are a lot of
people are preferring universal as well
and then I've those two links which you
guys can later go and check out and read
more about it okay so why Universal
JavaScript why do we need to go to the
trouble and you know like share code
between client and server or what are
the benefits that it brings us so
basically when building a web
application it house with some of these
so I'll go more in detail within each
one of it I see your performance and
maintainability
alright so SEO if any one of you I mean
a lot of you guys might have build
single page applications that only run
on a browser and so what happens is that
when different BOTS they come to our
website these BOTS like Facebook Google
board I think google bot now can now can
read single page application
applications properly and index them but
I think a lot of other BOTS still don't
do that so initially when somebody comes
to your like a bot that comes to your
website it will see something like this
and if you notice at the rube classroom
that's where your application is
supposed to be mounted but the bot will
not wait for that it will just index
this page which will have no information
about your website so to please these
BOTS we have to do various hacks one of
the hacks that we are doing at red mud
right now is something like this so what
we do is we on engine next level we
check if the user agent is one of these
BOTS and then we will try to reverse
proxy to our internal service that is
running a headless browser like phantom
jas which will wait for the whole
javascript thing to load CSS everything
patch it together and then give it back
to Googlebot and we also keep keep it in
man cash so that we can quickly get back
to Googlebot so there's some work
involved there we are running like to
medium instances and sometimes they
break due to various reasons we have to
maintain it and then one of the worst
thing about this approach is there might
be better ways but one of the worst
things about this approach is like you
have to put boards there and then every
day there's a new board so recently like
a slack also has a bot which so when we
face our website on slack it just shows
nothing because slack cannot read our
website
so Universal JavaScript approach
actually fixes this issue Oh what it
does is like your same application code
that you're building currently in single
page application that only runs on a
browser can render the same thing on the
server and push it down for BOTS to just
directly get that information before I
move forward I'll just quickly show you
guys how this website looks like so this
is red mark right now it's like right
working fine and then now I'll serve it
with so I'll fetch it as a google bot
and you guys will see that like it'll be
a bit broken but at least like you know
you'll see the things that are being
done to it when we are using phantom
juice or something let me just first
that again and yep so now you can see
all the information I mean all the
content the content is in here compared
to the one that we fetch as default like
jazz a browser user agent yep so you'll
see something like there's there's some
code somewhere here that that where the
mounting happens but yeah gehen there's
no full content and performance so the
one that all that is on the that is
saying client side rendering you can see
that how the browser actually renders
this is like it will download HTML it
will wait for JavaScript that is inside
that HTML to be downloaded then I will
try to evaluate it and after that I will
maybe in our case you try to make some
Ajax calls and only after that user will
see some content it works fine in some
cases like especially
dekstop like it'sit's not that of a big
deal where you have good connection
especially in countries like Singapore
but when you are mobile and then there
is a high high latency and low bandwidth
then you start to see a lot of
performance issues on on this side you
can see that server side rendering of
actually what happens here is that as
soon as you download the document it has
everything and user just sees it and you
can still download the JavaScript app
and do all the other stuff like
rehydrating it and maybe making some
additional Ajax calls if you want to or
you can just render everything on server
side so there's some clear big
performance gains when you do
server-side rendering maybe maybe this
will this performance issue will get
better with HTTP too but for now like I
mean I I think still it might not get
that better but I I think this helps and
yeah maintainability is is not a big
issue when it comes to single page
application like what we build a
trademark because it's a backbone
application all the code is in there we
don't we don't have any server
application that is rendering it we we
just have restful api so it might not be
a big deal but I i think for
applications like which have some
partial stop being done on a server and
then loading up sing some single page
application of to a browser and you're
sharing some stuff like formatting etc
or doing some data mutation I think you
can share that logic universal
JavaScript helps with that as well all
right so how do how how to build a
universal JavaScript app there are many
ways and I like frameworks like mature
and they actually come up with a lot of
packages that or I think by default also
material has this is server etc
all that stuff can help you build
Universal JavaScript app but let's say
if we are using react or something else
how do we build it I'm we're just going
to dig a big dive into some coding here
and see how to build a basic universal
application using react and nodejs so
let's build something like this this is
the component hierarchy so we have input
we have some progress j/s and then we
have search results so you type
something and then we'll just try to
fake that search result for now because
we we are not using any API or anything
it will take some time to build the
whole flux or some other layer here and
yeah we have a rapper AB GS so let's get
to it all right so I have this basic
template here which I'm going to use to
build a universal JavaScript application
so i'll just quickly run through what we
have so i've already have some node
modules that i've installed so that i
don't have to do n PM install again and
then I have some web pack config for
bundling the application etc so this is
my backpack where you basic stuff so
it's it's going to look for client
client rjs which is not there yet and it
will it will output a bundle DOJ's in a
dist folder which is not here yet and it
will yeah we are going to use es6 and
stuff so it's we i have babel loader
here and and yeah that's pretty much it
and for web pack and then i have index
dot GS so it's it's doing pretty much
the same thing for the server side so it
will set up a like it initiated it will
register babel here and then it will
look for server Dodgers and execute it
so let's let's build a
single page application that just runs
on a browser first and then we can do
the server side so I'm just going to go
here and yeah by the way I have some
code or ID with me so I'm just going to
paste it there or like even write some
and probably talk about it what it is
that actually typing each and every line
alright so let's do this let's create
client Jess and let me just look at all
right so this is what i have here so
what it's doing is it's actually yeah
it's look um it's just mounting the app
container a difference between can like
now and i'll go in detail later so app
is just a react component that is
actually composing a couple of other
components in there the one that we saw
in the diagram the slides so it's going
to mount to the root I have index or
HTML here which has this basic HTML
template so we are going to route here
and then we have this bundle dot J's
just okay yep so yeah so our client
application will be bundled and will be
captain static / bundled ojs right now
that's not done so i have this let's go
ahead and create our a BS
so a nap dodge is what we have is like
we are we are importing some components
like input search results so if you go
back here we have an input progress bar
search result so I'm pretty much loading
that stuff I have some additional stuff
that's not in the slide as like result
card so each of the result as a card
that see they're like this one this box
here and we have some data in data
folder so let's just quickly bootstrap
components
dark
yes
so this is a stateless component react
recently released this so you can
actually write a component in this way
which is like pretty cool and yeah what
it does is just take some props and just
renders a component at one more here
this one just renders a children's prop
that's it it's like a rapper nothing
else and okay all right so let's let's
have a look at here so what I'm doing is
I'm just initializing some state I have
some product data let me just create a
data ducks is it products Rogers its
product Oh Cheers
alright so I'm just going to copy this
data so this data is just like a title
and an image of that product and a URL
that's it all right so let's just close
others and just open our appt don't
cheers and yeah okay sorry what's
happening here is I'm just initializing
some state for this application for it
for this component I have some products
i'm just putting all the products in
here and then what I'm rendering is just
all the products initially and then off
then on input I have a handle on submit
where where as soon as user enters
something he will be shown it will
quickly change the state to progress the
loading and then we will we will
simulate some sort of like a synchronous
operation so I will go somewhere and try
to fetch it but actually is this trying
to like get to two of the products
randomly from that product set that been
included up here yep so let's run this
and right yeah so before I run it let me
just show you how my package or Jason
looks so I i I'm just running these two
commands and like there is better way to
do it like you have to like people run
watch and stuff but right now for this
one I just try to cap it keep it very
simple so I'm just going to run backpack
and which will create a bundle and then
I will just run a node indexed rjs which
will just execute the server that's a so
run all right
I'm starved
it
art
okay my bad it's yeah we don't have a
server so let's just open this directory
and yeah this is a very bad way to do it
but we'll just you know yeah so this
other application looks like and I have
some CSS or that I prepared earlier in
here some ugly CSS no preprocessors just
simple CSS and yeah so if you see now
what it does is like it loads the
application and then and then after
javascript is loaded it will actually
populate the it will mount the component
and you can see that react component is
mounted and so functionality is just
this I'm just going to try bread and
it's like freaking dumb and it will just
like randomly give me something banana
or something and that's it and let's
let's render this on server and so I'm
just going to create a new file server
touches and all right so I'm just going
to import Express from express
I have server prepared already let's
just put here alright so what I have
here is a very simple bare minimal
Express server it's a it's what it's
doing is it's taking that same app
container a component and it's it's
using this HTML wrapper which I have to
create yet or what HTML wrapper is is
that pretty much the same thing which
I'm just going to put it in here as a
node module
ok
alright so
so yeah it's it's is just a wrapper it's
uh oh is this wrapper function i'm
passing app to it and then is this a
binding up here that's it nothing much
so on server yeah this should this
should just do the magic and and yeah
about about about this section what we
are doing here is i'm just running a
static middleware so that it can
actually take bundle and style on the
server as a static files and this
middleware here is just sending the
response back after putting everything
together we are using render to string
this is provided by react itself what it
does is actually it converts everything
to string and that's it passes back to
the client and then online when you when
you try to mount it again what it does
is it won't replace the whole thing if
it matches the dom if the door miss em
same from the server and the client it
will not try to replace it so let's do
this now
alright so I yeah it's running I don't
have any message in there so alright
let's open our local host 3000 just move
this little bit here so that I know
what's going on all right let's have a
look so earlier when we saw it was the
the document was empty there was no I
mean it wasn't empty but there was no
suicide rendered content in there but
let's see now so yeah now you can see
that there is some react stuff here that
directly came from server and then
you'll notice something here in your in
here that there is something called data
react a checksum so what what it does is
that on a service ID will generate
something like this a number or I don't
like some time its hash I don't know I
don't know exactly what it is but like
it will generate a unique key that is
compared on the client side when we are
doing something like this so when I'm
mounting this application on the client
side it will try to compare this and
then it was just like it will just
continue from where it left off now
let's say if the DOM is different on the
server then the client so so let's say I
do something like super quick one and
just do something like this
so I'm just going to define a jewel I
hope this works and I haven't dusted it
so on here sorry on the back
here I will just do something like just
Falls and yeah that's sorry I can just
do something like this I'm gonna get out
so let's let's get this a try and so
what i will do is probably let's go to
one of the components and or we can just
do it in the app is
so if i have something like this so it's
a great driving I will do this and so on
a server side I'll just return something
like this with class name some gibberish
and then I'll just do normal progress
bar here let's see if this works I
haven't tested this out
ok
oh okay okay my bad
alright so now you can see that this is
throwing some reactive throwing some
morning here that says that attempt to
reuse markup in container but Jackson
was invalid this generally means blah
blah blah that you know your server side
render is kind of useless so you have to
make sure that your DOM is same what's
on your markup is same that you throw
from server and then you mount it on the
client all right so that was just a
basic you know basic isomorphic app
universal app sorry let's skip this
since we build this already and yep done
but was it was it so simple like I mean
is that it not really actually this is
this is very basic stuff and building a
universal JavaScript application using
react node and tools like flux redux is
a bit more complicated because of
several things so let's let's talk a
little bit more about that so tricky
parts let's look at a more complex
application so I'll just close this one
and we will just have a look at this one
so this is something that I build over
the weekend and like what it uses is the
users Redux as a as a state Redux is a
predictable state library what it does
is like it you can create reducers and
then it will create a store object for
you which you can use in your
application and maintain a state across
the application so similar to flux not
not really same as flux but I wouldn't
go more in detail there so what what are
we doing here is now I have this here
sorry this is
yeah sorry this is the application all
right so what I do is if I search for
bread should get a bread yeah internet
is slow here think so so yeah I made a
real API call to red mud API and then it
give me bread and now if like more
complex example would be disliked right
so people might directly go to this
bread page instead of going to a home
page and you know so if I just directly
go to bread what I see is yeah
everything is in here rendered on the
server side there is no ajax call that
was made and also you will see something
here so this is the state that was
passed from server to the client side
and what happened here is that I
something was done on the server side
like there was like we felt that data we
package it together and then we
dehydrated this stuff into this initial
state and then on the app on the client
side we hydrated it and started like app
will continue to work exactly the way
it's supposed to work so let's say if I
fetch milk now I will get a JAX call
that will get me a milk and yet caught
me some milk yep and yeah I mean yeah so
all right okay so so that is more close
to some real application and so what are
the tricky parts here so what one of the
thing is that when you have a complex
application that is making several which
has several components that are making a
JAX calls and they have their state
maintained in the application you want
to somehow get that stuff and push it to
client so that you can continue from
there so that's where actually things
started to get messy so in this case
I'm just showing a very quick example of
redox you guys can have a look at it
later in more in detail I'll share the
code as well so what's happening here is
that I'm just creating a store on the
server side using all my reducers so
things like my I mean in this case it's
just a search reducer that actually gets
the data and then you know like
generates that reducer object and then
i'll just create a store or using that
and then i will dehydrate for the client
by just getting the state from that
store and then i will just you realize
stringify it and then you know somewhere
in my HTML and then pass it down to the
client and on the client side what i
will do is i will just pretty much
follow the same code that i have in the
server side for initializing a store and
i will just pass an initial state to it
so i will continue from where it left
off yeah so like it'sit's bit more
complex than that but in a nutshell this
is what actually happens another another
tricky part building these kind of
isomorphic app is that like now you have
to deal with things like this you know
like you used to use edge x and make a
edge x request and but now you can't use
that anymore on the server side and you
so so yeah I mean like there are ways to
do it like you can do what I did earlier
like assigned a global you can use that
global for certain specific things but
for such cases it's it's a mess like
just don't use it don't do something
like this the HTTP request is a is a
node module and then it's HTTP is node
module that is making a request and then
if it's not a server on a client said
what i'm doing is i'm making edge x
request so this is a bad way to share
code I like in some cases you have to do
it but better approaches look for I so
like universal or isomorphic modules
that are already there in this case
using isomorphic fetch and it I can use
the same thing I can use this patch I
pie that will be in the browser's soon I
think it's already in some of the
process but I can use that on browser
and the server with the same code I
don't have to change anything
alright so so this this is this is a
hard hard problem and then there are
some frameworks out there actually who
solves it like I think ljs and a couple
of others they they have they have stuff
that actually does this data fetch
fetching part but in our case let's say
in this application it's very let's let
me just open that application and just
show you guys all right can just roll
yeah I can just show it for me so what's
happening is I'm in my server i'm doing
i'm running this fetch search term
result when i go to hello it is passed
to this and then i will try to make a
HTTP call on server etc it will build a
new state for the application then it
will pass it down to the client so this
is this is very simple like because in
this case I just have I'm just doing one
thing like I'm just building a Search
application that's it there's nothing
more to it but let's say if you are
looking at something like this our red
mod mobile website so if I want to load
everything there's like at least four to
five API calls that are made then I have
to think of a different approach so in
this case what happens is that they are
very there several ways to do it one of
the ways is that in each of your handler
components like the main components like
app app is a rapper but like beneath a
pew might have landing pages search
pages etc you have to have something
like this static function then what you
can do is actually you can get the list
of all the components on the server side
loop through all of them look for these
functions which are retaining promises
and then you resolve all the promises
build that store using Redux and pass it
back to your application yeah but you
have to write a lot of code for that
unfortunately another another tricky
part is indira data fetching is that you
want to prefetch some of the stuff like
that navigation and that categories at
the top but data for that but like maybe
this product list you don't
want to prefetch you want to fetch it
online you you want to show a spinner
for whatever reason for now you can
immediately do it I think using
component DeadMau mount and it shouldn't
cause much of a problem there but I like
there yeah I mean then then what happens
is that you will have to define to
dispatch functions one in component in
mount which will fetch something like
this which is okay shouldn't be a
problem but it's not a really really
good way there are some libraries that
help you do that like react Thatcher is
one library and then with help of some
promise middle where you can actually
pass things up and do something like
that yeah but some this is something I'm
still researching I've like we've done
something like this but I haven't done
that like probably this new stuff yeah
so that's yeah that's pretty much it and
the application that you guys just saw
this one it's using Redux and couple of
other stuff and it's it's hosted on our
github so feel free to feel free to look
at it and give feedback it'sit's not a
really beautiful code but like yeah I'm
just in case if you guys want to have a
look so yeah it's out here there's no
read me yeah alright just alright so
that's pretty much it and these this is
the resources this is what I've been
through and I think if you guys have a
look at it there's tons of universal
application related content out there
here yep hi thank you so much hi um so
question red mark doesn't use react
right now or just type of universal app
it does actually so our our main website
of the one that you see on red marcom
actually uses react all the way but we
are stuck with backbone and it's like a
really complex application we are trying
to move away from it so what I did is
like I talked to pm's and got like one
month of time and we build a mobile
website using redux
all that stuff so that we can show it to
them how it looks like and you know it's
more easy to build stuff so yeah yep so
we are going to move to this whatever I
showed for the main website as well yep
you can access red mark from mobile
phone and it will give you the mobile
website okay thank you we have done with
the same methodology i mislike you how
you deal with the the cookies coyote
cookies tub because a cookie or disable
site and calcite or totally different
yeah that's a good question actually I
run into that issue we share a user your
your session token for a logged-in user
between both the applications and
apparently for this case I had to do
that thing you know if server do this if
client then do that I I think I like I'm
looking for a module that can help me do
that effectively on client side we are
using Jas cookie module but that doesn't
work well on server side and actually
doesn't work at all i think i don't know
i haven't dig more into that so we are
just using Express cookie on server side
for now yep
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>