<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[JSConfUS 2013] Adam Solove: Constraint programming in the browser | Coder Coacher - Coaching Coders</title><meta content="[JSConfUS 2013] Adam Solove: Constraint programming in the browser - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>[JSConfUS 2013] Adam Solove: Constraint programming in the browser</b></h2><h5 class="post__date">2013-10-15</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/72sWgwaAoyk" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">is about building more powerful user
interfaces in the browser it started
just a few months ago when I was
reflecting on about a year's worth of
work that I had just finished up and I
realized that we had adopted this great
new architecture with all the things you
hear about here at jay's cough no
require an AMD backbone html5 css3 new
browser api's and then I looked at what
we'd built at the end of the year and I
said you know I think I could have built
this 15 years ago when i started writing
JavaScript the code would have been
uglier the you I wouldn't have been a
shiny we would have had to refresh the
whole page instead of use Ajax but you
know all the logic all the actual power
this gives the user we could have built
15 years ago it was kind of exemplified
by to do MVC right like we could easily
write to do CGI 15 years ago I'd be no
sweat you know we haven't given their
users anything new so I SAT i sat down i
said you know i want to set out and
learn about more powerful models that I
could put at the heart of my user
interfaces in order to provide actually
more power actually more leverage
instead of just more shininess and so
let me show you something just the very
first thing I built but I think at an
example of something that is almost so
obvious that we missed the fact that
most people don't do this in web
applications today so this is a little
visualization of the u.s. 2013 federal
budget so the kind of thing that you
might show your readers if you were a
newspaper with an interactive division
and we can do very simple things like
you know if we're really worried about
the deficit we could say you know what
would happen if I raise taxes by a
couple percent and you'll see the
deficit going down in proportion not not
very exciting and I can I can you know
maybe I really hate old people so I'll
just cut spending on social security and
that helps the deficit to and and so
there's a lot of fanciness here right i
mean i'm using like backbone and i'm
using fancy browser api's it works with
touch events on an ipad that's great but
if you think about it what it's actually
doing what i've shown so far is really
the same as a form right
in a bunch of input fields for what I
want the tax rates to be and how much I
want to spend on different government
programs and it's going to go and add
some numbers up and subtract some
numbers and tell me what the deficit is
as kind of typical of web applications
today right there's a bunch of inputs
you you wait for something change in the
inputs and then you give the user some
output and that means that you have to
decide in advance which things you think
are input what the user gets to change
in which things you think are output
that the user just has to wait for its
you know robot overlord to calculate and
so I said you know what if we could
actually take this and change this and
not have a distinction between input and
output so now instead of just changing
things and and having it affect the
deficit what I'd like to do is actually
lock the deficit in place and now what
I'd like to ask is the question as I
change Social Security how much how much
in taxes can I cut as I do that well
it's kind of interesting you get a feel
for the relationship between the
variables that you don't get by just
trying to work for words and so in a
sense although this is a very simple
program it exemplifies a kind of
solution to this problem of our two
simple interfaces which is that instead
of having a distinction between input
and output we make all of our variables
both input and output we describe the
relationships between them and we let
our users monkey with all of them so
this talk I'm going to describe how you
would go about building something like
this or honestly something way cooler
than this but with the same principle
we'll talk about what constraint
programming is I'm hopeful provide a
metaphor that helps that make sense
we'll talk about using cassowary which
is a great JavaScript library that you
could be using today to do constraint
programming in JavaScript and and then
I'll make some suggestions for other
kinds of constraint solvers that you
can't use in JavaScript today but that
would be really useful for powering you
I applications and if you're really good
there's there's a bonus material at the
end so constraint programming is about
writing our programs in terms of
relations instead of procedures normally
write our programs is a function that
takes input and returns output let me
let me explain what this means in first
grade you learned about addition is a
procedure
it's a very specific set of rules so
that given two numbers you you know you
start on the right and you carry the one
and you get to an answer and this kind
of addition is a procedure helps you add
two numbers but then we think happens
when you get to algebra and all of a
sudden addition is in a procedure
anymore it's a relationship between
three numbers so if we have the
relationship a plus B equals C this
doesn't just mean that given a and B we
can calculate see it means some other
cool things too like given a and C we
can find B or given only a value for one
of the variables we can describe a
relationship between the other two we
can plot that on a chart we can
enumerate all the values that meet that
relationship if we have values for all
three of the variables it becomes a
truth test so we can ask given this
value of a B and C is the relation a
plus B equals C true so think of this as
a metaphor for how we write programs we
currently write programs the way a first
grader does addition you tell this
computer very specifically how to go
from input to output but it's possible
and actually not that hard to describe
many programs as relationships between
variables that work forwards backwards
and every direction so cassowary is a
fantastic library for doing constraint
programming in JavaScript the API was
designed specifically for user interface
applications it is really fast it's fast
it problems much harder than you would
possibly need on a webpage in JavaScript
and there's a really great version of
this available Alex Russell's castle ajs
you can install via NPM you can include
in the browser and it's it's fantastic
the one limitation with Casa why is it
so fast and so powerful precisely
because it has a very limited scope it
only works on linear equations so our
variables have to be numbers the
relationship has to be just adding and
multiplying if you know the name
cassowary you've probably heard of it
from iOS autolayout a/c version of the
Castaway algorithm now powers laying out
applications in iOS so you can say keep
the left border of this 20 pixels from
the left side of the screen and keep
this part when
pixels from the thing next to it and
it'll go and solve this whole layout
problem and tell you what where
everything should go there's actually so
many examples of using cassowary for
layout I'm not going to talk about that
at all let's look at something more
interesting we can do with it so the API
is really simple we can create variables
and specify their initial value we can
create expressions adding subtracting
multiplying two existing variables we
can create equation saying in this case
that total spending always has to equal
the sum of defense and non-defense
spending which is like a pretty
reasonable thing to ask and all of our
constraints can have a strength so we
can tell cassowary when you solve this
system of equations this one absolutely
must be solved or I just kind of like
that this one be solved or you know I
don't really care but but see if you can
make it work and this is great because
if you have problems that are over
constrained where there's no complete
solution cassirer will find you the best
solution that you can find so let's set
up the very beginning of our of our
budget relationships will create a new
cassowary solver which is just a context
for holding all our relationships will
create three variables spending revenue
deficit and we'll create this equation
that says that you know the deficit
always has to be equal to however much
we spent that we didn't take in in
revenue and now that rule is absolutely
required it makes no sense to solve the
system without that rule holding and
we'll add that constraint into the
system so now this solver will
automatically for us make sure that this
relationship between the three variables
always holds and we can edit any one of
them and it will update the others to
match so so when we want to add
interaction into this is it just a
couple more methods we can tell the
solver let's say when the user mouse
downs to select that they're about to
move something we can tell it that we're
about to make an edit to a certain
variable what this does is internally
castaway has a representation of all
your constraints as a linear algebra
problem was a bunch of matrices and when
we tell it that we're about to edit this
variable it'll go and transform
everything that it knows about the
problem and solve essentially for that
variable so that when we suggest new
values for this variable it's really
easy really fast to solve for all the
other ones this is what makes it so fast
for interactive applications now when
the user actually makes some change
actually says I want to change this
variable will call suggests value and
give cast away the variable we want to
edit and the new value that we want to
suggest the reason this is called
suggest and not set like you might
expect from an MVC framework is that
this value might not lead to an actual
solution right this value might not be a
possible value and so we're suggesting
it and we're asking cassowary given this
suggestion do the best you can to solve
the the remaining constraints when we're
done editing you know sending edits to a
variable we can call and edit and
finally we can add a state constraint so
for example when I locked one of the
variables earlier it was essentially
adding a stay constraint saying the
cassowary you know leave this variable
alone when we change the other variables
don't edit this one find a solution that
leaves it the same so based on this
we've created the very most simple part
of this program we basically have three
numbers and we're saying that this one
plus this one has to equal this one and
you know obviously this works and is not
very impressive I can lock one of them
in place and now this forces the other
one to change not particularly
impressive but you can see how with many
more constraints having this work
automatically for us would be very easy
oh no yes so let's build some more
interesting relationships you noticed in
the first slide it's kind of wordy
creating variables and expressions in
cassowary so Alex Russell the maintainer
of casero Jas has provided a really nice
string API where you just give it the
string of the equation it'll parse it
for you and deal with everything so in
this set of relationships what we're
saying is this we have you know we have
seven tax rates and these are
percentages and and for each of those
tax brackets there's a certain number of
dollars actually you know the total
number of dollars people make that are
taxed at that tax bracket these numbers
obviously aren't right the numbers are
big and ugly so I changed them but let's
make some constraints that describe a
solution to the problem of how to set
taxes for the US tax system
first we'll say that the very bottom tax
rate has to be greater than or equal to
zero can't have negative taxes of course
you can have negative Texas but makes
the problem nicer to not the very top
tax rate we'll say has to be less than a
hundred percent again you could have
taxed more than hundred percent but not
clear exactly what that means so now now
what we'll do is for each of the tax
rates we're going to describe the value
that each tax rate can have and I've
adopted here some syntax that isn't real
JavaScript syntax is like CoffeeScript
and Ruby syntax I'm sorry but it looks a
lot nicer so for each of the tax rates
will say you know the third tax rate
starts out being equal to this rate here
which is you know the initial value that
it's been given so we'll and that's a
medium strength constraint so we're
saying you know I'd like it to start out
at twenty-five percent then we'll say
that for example the third tax rate has
to be less than or equal to the fourth
tax rate you know we in general have a
progressive tax system so we're going to
we're going to hold that relationship
true finally we'll set up a variable
that's the number of dollars that we
earn for taxes at this rate and so the
tax revenue on the third tax rate is
equal to the third tax rate is a
percentage times the number of dollars
that are taxed in the third tax rate
that's pretty simple finally the we'll
get the sum total so the sum total that
we make in income taxes in a year is
basically the tax revenue variable for
each of these rates added together so
now in these few lines of code we've set
up a bunch of relationships that would
be a real pain to code by hand or a
whole set of validation rules that you
have to write by hand and out of these
constraints come some really interesting
emergent properties let's look at what
we get with just what we've done so far
so let's say that I'm really in so
obviously we can work forward as we've
already seen you know i can increase
taxes and that affects the deficit but i
can do something else let's say that i'm
not willing to cut any spending but i'm
really interested in cutting the deficit
and by the way none of these are my
political opinions is just let's say
that so I've locked spending
in place so we can't change that
variable and now as I cut the deficit
it's going to force tax rates to go up
kind of drastically and that's kind of
not fair i mean cassowary applied all
the tax increases to the very top tax
bracket maybe that's not what I want so
now I'll lock the deficit in place so
now when I make changes to taxes the
only thing castaway can do to solve my
problem is change the other tax rates so
as I decrease the tax rates on the top
group there it's going to force all
these others oh no good no good so I
guess that's not the solution to our
budget problems now what I want you to
see is that several very natural things
fell out of writing the relationships
that would have been a real pain to code
by hand you notice that as I drag the
tax the very top tax bracket lower all
the other ones kind of bunched up and
then refused to move and so I can
actually give a limit on oh well go set
this up again and so as I drag this
one's going to force all the other ones
over and I can actually ask the
interesting question like you know what
if we had the least progressive tax
system possible but we wanted everything
else to be revenue neutral well this is
where that is it also lets us see very
clearly some relationships that aren't
clear in the normal debate like you know
normally people talk about when they
talk in the budget debate we talk we
hear about billions or trillions of
dollars as one unit we heard about
percentages of tax rates as one unit we
hear about ages as qualification for
Social Security as one unit do you know
what the trade-off is if we put Social
Security age up by one year how many
billion dollars is that most people
don't know it's hard to make how can you
evaluate that trade-off if nobody even
knows so this interface by using
constraints lets us monkey with all the
parts of the problem instead of making
an advanced a decision about which
things the user get to change and which
things they have to just live with and I
think that this is the way forward if we
want to build more powerful applications
we've got to give our users more
leverage and that means not knowing in
advance exactly what they're going to do
with them and that means writing our
programs in terms of constraints as
opposed to procedures but there are very
definitely some limits to what cassowary
do you know cassowary can only solve
problems where the variables or numbers
and it can only solve problems where the
relationships between the numbers are
linear expressions so I want to suggest
some other types of constraint solvers
that we could use to build more powerful
software so the first thing that would
be great is just to have non linear
constraints right if you want to have a
2d geometry problem where we keep a
point on a circle the constraint would
look something like this x and y
coordinates squared you have to equal
the radius squared guess where I can't
do this because it can't deal with
squares there's actually really good
algorithms known for this to do
numerical approximations and somebody
just has to do this in JavaScript you
know be sit down with a textbook could
be a couple couple days of work it'd be
great if we had this the other really
interesting thing going on in the world
of constraint programming is Minnie
Conrad and core dot logic so it how many
people here have heard of these before
anybody yes a few so this is a really
interesting thing going on with our
friends in the lisp world mini conran is
a system that provides relational
programming just like we've been doing
with cassowary but over non non
numerical problem domain so you can
describe the structure of a tree things
in a list colors you know anything you
can think of adding constraints to the
people who are work is very new the
people who are working on it are worth
following on Twitter Google+ wherever
they are and the most interesting ideas
from many conran which was first
implemented in scheme are now in court
out logic which is enclosure and closure
compiles to JavaScript through closure
script and you can actually run these
logic programs written in a kind of
lispy language in the browser and they
are super fast if you're at all
interested in relational and constraint
programming I highly recommend reading
this book the reason schemer it'll walk
you through some kind of abstract
problems to make your brain work in the
very strange way thinking of constraints
as opposed to procedures let me show you
a little bit about what this looks like
so here is in enclosure in court logic
that we could run enclosure script how
we'd solve su doku for those of you who
don't read closure what this really says
is
there are 81 things in a pseudo coup
problem if there's anyone spaces the
rows are a set of nine rows where each
one has the nine variables in it and the
columns are a set of nine columns where
each row has each column has nine items
in it and the squares are nine sets of
nine items so we're just kind of setting
up the problem now we're going to run
our logic program and we're going to say
very simply for every one of the 81
variables it has to be a number between
one and nine and for the ones that were
already filled in in the problem you
know if it said that the first square is
a 2 then make sure that the first square
is a two and now comes the actual way we
solve the problem we're going to say
every space in every row has to be
distinct and every space in each column
has to be distinct from one another and
every space in each square has to be
distinct from all the others and it will
run it will give us the solution now
what's really interesting about this is
does this look like a solution to the
problem of su doku this looks like a
statement of the problem of su doku and
yet this will run really really fast and
give us the answers now you say Adam how
fast is it going to run it's going to
run so Peter Norvig who's the head of AI
research at Google wrote a Python
version in which he solves the problem
directly and it's about three to three
hundred lines of Python and it runs
reasonably fast presumably it's the
fastest implementation of su doku solver
you could write in pythons the guy's
genius this version which is not
handwritten just happens to use a
constraint solver works on average about
a hundred times faster than Peter Norvig
Python code in javascript in the browser
so this gives you a feel for what's
coming for what's coming which is that
we're going to have more powerful models
for writing the software and we're not
going to be smart enough necessarily to
write the engines that run those models
at least not very fast but if we can
express the problem we have in terms of
a problem domain that somebody has
already written an engine for we're
going to get all the performance
benefits
of all the genius that went into
building that engine for free so this is
really something to look into if you're
at all interested in closure script
please look into core logic follow Dave
nola it's it's really interesting
corelogic is really cool it's not yet
quite perfect for you I applications one
of the problems is if a problem has lots
of solutions core logic will happily
give you a completely different solution
than the one you asked you got last time
so this can lead to a case where if you
slightly change one of the variables
instead of just slightly updating one of
the other variables it'll give you
something completely in left field so
you can't use this directly for you eyes
but you can add a layer on top that will
work the final thing I want to make a
plug for is Alan Kay everyone knows Alan
Kay right only the inventor of
object-oriented programming the laptop
the modern UI so he has a research
institute called viewpoints and they're
currently working on a research project
called cooperating solvers which is a
way to take different kinds of solver
engines constraint solvers dataflow
solve all these different kinds of
engines and ask how could they work
together you know what happens if you
have a problem where part of it is
constraints and part of it is data flow
and part of it is something else how do
they cooperate there's some really
interesting PDFs and example code
showing how to do that definitely worth
looking so that's been constraint
programming in the browser I think that
we can build much more powerful user
interfaces in this in this vein I look
forward to seeing what you all do if
you're interested in contributing to
open source projects Cassar ajs is a
fantastic one it's really easy to get
started Alex Russell's very responsive
so let's go out and build some more
powerful user interfaces thank
I have time oh I'm just gonna I'm gonna
steal one more minute for the bonus
alright how many people have seen Brett
Victor's scrubbing calculator yes yes
you know what this is so the idea here
is is you know most people normal people
can't do algebra the way that we can in
our heads and they often run into
problems that can be solved by algebra
but that are hard to express yourself if
you're not super proficient with algebra
so he had this problem where he was
trying to lay out a slide deck and he
knew that the top margin was going to be
about a hundred and he knew that the
bottom margin was going to be about two
hundred and he knew that he had to lay
out about 20 bars in a bar charts and he
guessed maybe there were 40 pixels high
and then there needs to be some space
between them so we have about seven sets
of padding that are each 20 pixels and
this gets us to 760 maybe the slide is
really 800 pixels so we'll choose to
maybe bump up the bar height a little
bit and we'll just make the Marge a
little smaller now that's that's okay
that's not very hard but now let's say
that we're happy you know this is now
one solution to the problem of making
everything work at 800 pixels but you
know what if I want to solve for the bar
height I could have if I may be cut down
that margin a little bit and it'll
interactively solve this equation for us
and show us dynamically how to update
one of the variables in response to
changes to the other while keeping the
equation as a whole in balance now this
is something that when I first saw I
didn't know how I would build and now
that I've built it it's about a hundred
lines using cassowary now it's not as
full-featured is the one that he demoed
it doesn't handle squares and things
that castle where I can't handle but you
can write this you can understand how it
works this is an example of the kind of
program that you can't write it would be
hard to write by hand unless you really
want to write your own computer algebra
system that you can write in the course
of maybe four or five hours using
cassowary or similar constraint solver
if we had a more powerful constraint
solver that worked with squaring other
mathematical functions or if we had a
real computer algebra
in JavaScript wouldn't that be great
then we could do so i'm making a plug
for constraints and for other powerful
models you know things that come out of
cs and math research as the underlying
feature of more powerful user interfaces
for our users and if anybody has any
questions I would be really happy to
take them so the question is in the su
doku example is it powerful enough to do
backtracking and give us multiple
answers and yes it absolutely is in the
code here that run one is saying give me
the first solution you can find the way
this is implemented it very naturally
does the backtracking itself you can ask
for all the solutions although in that
case it may not converge it may just run
forever you can ask for any number of
solutions you want yes so the question
is have I used closure script in in
production apps and kind of what is the
scope of problems that can solve I have
not used it in anything that I've
shipped to another human being I would
say it takes a lot of effort to find out
to get in the habit of actually
consciously modeling your problem in
terms of a known problem domain use
JavaScript programmers we're used to
solving things kind of by brute force
and this the question of does the
problem i have actually meet up with a
known computer science problem domain is
just a skill you have to develop my
senses credit logic right now is very
well suited for what i would call well
constrained problems problems where you
know that there is a solution and that
there's probably only a few solutions
and you don't care which one you get in
the case of cassowary it has a lot of
really great logic around having a
problem that's over constrained where
you can't meet all the constraints but
you can say which ones you care about
more and it'll it'll try and find the
best solution or a problem that's under
constrained a problem where there's
thousands of possible solutions
cassowaries great about if you make a
small change to an existing solution
it'll give you back this a new state
that is as little different as possible
whereas Cortot logic may just give you
you know a completely different one but
i think that there's a lot that we could
do you know as we start thinking about
how to use constraint programming in you
I programs to just layer on top of that
and handle some of that ourselves yeah
so I mean I think the general point is
we're just now kind of understanding I
mean you know there's a lot of history
with prologue in terms of what we can
write in logic programs how what Kyle
powerful programs can be and still run
backwards as opposed to just forwards
there's a lot of cool things and and
really the mini Conrad people are the
people to follow the most interesting
thing I've seen is they wrote a
relational interpreter for a language
that you know normal interpreter takes
you know some so a grammar of a language
or semantics of a language and some
input and return some you know some
interpreted version of it the results
and it only works for words and they
wrote one that works backwards so you
can say here's the thing what is the
program that would generate this and
then they use that to write a program
that would find coins programs whose
output is the same as the text of the
program itself and you know there's no
hinting they're not calculating them
they're just setting the problem to the
constraint solver and the constraint
solver is solving it for them a lot of
interesting stuff going on any other
questions awesome well thank you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>