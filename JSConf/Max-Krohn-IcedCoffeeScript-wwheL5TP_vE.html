<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Max Krohn: IcedCoffeeScript | Coder Coacher - Coaching Coders</title><meta content="Max Krohn: IcedCoffeeScript - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Max Krohn: IcedCoffeeScript</b></h2><h5 class="post__date">2012-11-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/wwheL5TP_vE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so today I'm going to be talking only
about iced coffee script tame j/s though
the same thing really it's just a
different flavor of these ideas ok so I
have three major goals today first is I
want to convince everyone that that
there is a problem to be solved because
there's a little bit of debate on that
point and then once we've agreed that
there's a problem I want to talk about
the types of solutions or the specs of
the solution and also show you a little
bit about iced coffee script and how it
meets the spec of the respect to solve
the problem ok so I'm going to jump a
little bit between like browser code in
nodejs code but it's everything works in
both cases so is everyone someone
familiar with coffee script can you guys
read this ok I'm trying not to get too
deep into like the really need agree
features this is just a function
definition an iced coffee script and
it's doing this it's trying to take a
term if you're choosing and to do a
query in de quitter sorry to query
Twitter's JSON API to get there were
like some search like Jay us coffee you
or whatever and then it's going to use
the jQuery JSON p library and when it
has a result it's going to just call a
call back with you the results or maybe
know if it failed so you might be
looking at this and say well I know this
is a regular type of coffee script or
JavaScript flow where the codes starting
on the upper left and going to the lower
right it's not that big a deal right
this is you know this is your code
pyramid and it's I don't know it's
everything's flipped in this in terms of
the black and white so that's supposed
to be the Pyramid in Egypt with the
Sphinx in front of it so that's like the
code of debt the pyramid of death so
this problem is manageable you can deal
with it the question though is what
happens when you start building real
more interesting programs with that type
of call in the middle of it and so
here's an example of something I wrote
to show a table of items so you can
imagine I have an array of 20 items
let's say and I wrote a little loop and
that this is fine this code works okay
for each item in the list it's going to
go through and write the item out to
your browser and if
the if there's enough room on the line
like if it's like a small word then
there's room to show an ad so we could
show an ad there and then go to the next
row so this works fine but let's say we
decide to make a change to our code
instead of just showing the ad we want
to make the application more better for
our users and we want to actually show
the result of a Twitter search where
that ad used to be displayed so now if
you recall in the first slide I showed
you a search function and the second
parameter of that search function was
the callback that search was supposed to
call when it's done with its computation
right and so I just wanted to swap that
in from my showing the ad but I've no
idea what to put in place of the
question marks and really what I put
there is this horrible realization that
I have to rewrite my code so I'm not
going to rewrite this function but if
you were to rewrite it and do it the
right way you would totally change your
while loop into something that look
nothing like a lot of it whatsoever so
we'd have a crazy callback pyramid of
death and at the bottom of it you'd call
your callback so just imagine I went
ahead and did that but now we go one
layer up right and so what's happening
to this the code that actually call this
show table function well just imagine
it's a function that writes a whole page
so the first thing it will do is it will
show a header and maybe has a left bar
and on the left bar it'll show this
awesome table it'll show a main page and
maybe it has a right bar and on the
right part I'll show this awesome table
and then we'll show a footer okay well
that was show table the first time I
wrote it what happens if we change it so
again show table has now been changed so
after it's done its computation it's
going to call its call back back so I
actually rewrote this and just to show
you what this very simple five line
program looks like it changed into this
and I don't think there are any bugs in
there but i don't really know and i
could have easily left out one of the
branches so i'm sure everyone's familiar
with this type of thing right and then
it's all well sorry that's three turtles
on top of each other so it's Turtles all
the way down so you keep doing this all
the way up your stack and you have to
rewrite your whole program just because
you want to change one inner function
and if this sort of thing is interesting
to you there
our other great activities you can
consider like hand factoring large
numbers hanoverian large matrices in
hand assembling x86 code so there is a
problem here and that in a very simple
JavaScript case that shows up all the
time on the browser or nodejs we're
asking humans to do the job that
compilers ought to be doing so I think
we all can agree that that's not a great
state of affairs okay so I want to talk
about how to solve this problem so the
first thing we need to do is what I just
described we need to find a way to do an
automatic continuously continuation
passing style conversion and that's what
I just was describing the problem as and
you and we'll talk about what that means
but there's really three other
requirements do that we need since we're
going to be changing the language or
adding a features to the language we
want to employ an economy of mechanism
I'll go over that in the next couple
slides we want to be backwards
compatible obviously so we could use it
in as many places as possible and
finally we don't want to sacrifice the
power that Jas is giving us so I'll go
over all three of these in more detail
so what do I mean by economy of
mechanism so if you look at javascript
or you if you look at iced coffee script
you already have these great tools you
have like if else and for while and you
don't want to get rid of those you don't
want to like replace those with this new
library that's trying to do what these
things already do for you so you want to
keep those great mechanisms and if
possible add a few new keywords as
possible so in this case I say only a
two at most you don't want to make the
language fat with all those features
that sometimes you don't even need like
compatibility with all ap is and
libraries you can javascript has
obviously been around for a while in
lots of different contexts and there's
very little agreement among people who
write libraries or JavaScript engines as
to you know what a callback is supposed
to look like this is supposed to be the
first or the second parameter and what
are the parameters to that callback and
so here are three examples that all seem
to be at odds with each other just a set
timeout function that everyone uses and
there's the jQuery get json call and if
you look at that the callback is the
third parameter but the data comes first
and then the status and then finally the
third
example is the request package the node
package written and that's the most
popular node package and NPM and you
could see there the error comes first
and then the response and the callback
so obviously whatever we do to to
address this some CPS conversion we
can't take for granted that callbacks
happened in in a particular place and
that the error is a particular place
within the callback and also i mean we
want some solution work with all
runtimes so v8 spider monkey and we also
wanted to work on the browser and so the
only way to do that is with source of
source translation and I mean coffee
script is such a natural case for a
sorry I language for this because
already doing translation as it is the
question is can we just add a couple
more translations to to get the features
we want and the last point is a little
bit it's subtle but you could do a lot
of really cool things now with
hand-rolled javascript right you could
very easily fire multiple parallel calls
and get answers back whenever you want
to you can do things like you could have
both on the browser and a note you could
do things like even more complicated
like pipeline flows what I call and so
that means let's see have a list of 100
requests to make and you only want by
with them to be outstanding at once you
could do that in with JavaScript and
it's a little bit it's a little bit
complicated but it's definitely possible
and finally you can do interesting
things like short circuiting slow
operations and you can have functions
that do background work like a call or
call back first and then they do some
other stuff so these are all great
features of JavaScript that we do not
want to delete we want to eat we want to
preserve them and a javascript in
CoffeeScript so we want to preserve
these in our new language okay so just
to give you a preview of what i'm going
to show you about iced coffee script
here's my example where remember we flip
the whole function I'm sorry we flip the
whole function upside down we didn't
know what to put there to preserve the
the structure of the code we had and
with iced coffee script really we can
preserve everything
and just make a small change and keep
going on our merry way so I'm going to
tell you exactly how this works okay so
I starts with regular coffee script and
just adds two new keywords the first is
defer it's a lot like a regular function
but it has some special features so it
has to be a keyword and the second is
this the weight keyword which alters
control of your program so it's a lot
like four or if where it's actually
going to change the way your program
runs okay so first I'll talk about defer
alderfer really does is it makes a
callback for you so you call defer
return so you'll call back and as usual
once you have that callback you can do
it ever you want with it so in this case
you can pass it to a collie function the
Kali will do whatever it has to do and
when it's done it'll call its call back
it'll tell the caller that you can now
proceed so defer is a function that
returns a callback and defer works very
well with this other keyword called oh
wait and here's what a wait does it's a
block of code so on a given example here
and control enter z wait block and it
executes every last line of code as
normal but it waits at the very end of
the block before proceeding and what's
it going to wait for well in this case
our weight block has an unknown number
of defers depending on whatever code is
it we know whatever the value of x is
and whenever the value of y is but let's
say you enter that if statement and you
go through the while loop three times so
you'll have made for defers so control
will block at the end of the await
function sorry at the end of the weight
block until all four of those callbacks
generated by defer have triggered so
it's a way to stop your program until
you you have an answer two things you
need to proceed so once all that's done
then you can go to bam and go on with
your program so here's the most basic
ice example I can come up with it's
something that when you just wait a
second and then print so I'm using the
standard set timeout function and set
timeout us you know it takes a call back
as its first parameter and that
the callback that it calls after a
second of waiting so in this case this
isn't a weight block that's just been
moved to one line but it's a weight
block that is one statement which is
called set timeout when set timeout
fires it's called back after a second
control can proceed past the end of the
away block into the console dot log
hello so this waits a second and then
prints hello and just to show you a
little bit more complicated example how
colleagues and callers interact I
prepared this other one which is really
just going to print one two three four
five but it's with two different
functions now F and G so let's say you
start without the first thing that will
happen in f is you do a console dot log
to print the number one okay now we go
into the weight block and F and what
that's going to do first is call this
other function G with a callback
generated by defer so within G now we're
in G the first thing we do is print a
two and then we're going to as in the
first example that I showed you we're
going to wait ten milliseconds for a
timeout so at this point control cannot
proceed any further in G so it jumps
actually back out to F because app can
still keep doing other things it hasn't
it hasn't reached the end of its await
block yet so it's going to then print
three and then control will jump to some
other part of the program after that
ten-second 10 millisecond timeout
expires we can now proceed in function G
because all it defers within its weight
block I finished and then G can call its
call back now what happens when G calls
us call back well that allows F to
proceed past it's a weight block because
they only had one two fern its weight
and now that's triggered and so now we
can finish up and just to briefly
describe to you how this can fit any API
you can dream of I haven't shown this to
you yet but defer actually takes
arguments and the arguments of defer the
arguments to be filled in by the call
back when is actually called so that's
why defers an Ashley a real function
it's actually implementing something a
little bit like pass by reference and
C++ so after control leaves this a
weight block the request library will
have filled in the air and the body and
they'll be available as those two those
two functions
so in this way you can use ice coffee
script in any API okay so I've told you
about automatic cps conversion in nice
coffee script I told you about the
economy of mechanism hopefully it goes
only to new keywords I tell you about
how to make it compatible with all
existing libraries and api's and the
only thing I'd left to show you is how
this makes for really cool programs that
have interesting control flow okay so
let's talk about the one we we looked at
in the first series of examples which is
just a set of cereal calls when one
finishes the next can can start and this
is what it looks like a nice coffee
script so let's say we have a series of
20 terms we need to search for we're
from Twitter what this loop will do is
it'll search it'll loop through each of
those 20 terms one at a time and on each
one calling this search function that
makes a Twitter call and then it
populates the result into that slot in
the result array so this is just for
each item wait wait for that thing to
finish then do the next I'd done the
really cool thing is how do we change
this into a set of 20 parallel calls
well it's a minimal change we just
switch the order of the weight and the
for loops and snow so now if you look at
this within the awake block we're gonna
be doing a whole bunch of things we're
going to fire off 20 different requests
at once and once all of them have
completed then we're ready to continue
so this is how you would implement
parallel control flow with with ice
coffee script and this gets slightly
more complicated but it's a little bit
more code but it's the same ideas I play
I wrote this little Klaus called a
pipeline or library and that's using
just regular iced coffee script that
I've described you so far it's not on
the slide but it's it's in github if you
want to check it out and what does this
pipeline or do well it tries to enforce
network flows with only a certain number
of requests outstanding so in this case
they're only five requests outstanding
even though we might have a thousand
different terms where we're going to to
query and so here's the way it works
with a pipeliner you wait before you
launch your call so if you go into this
the first thing that will happen in the
loop is that you'll ask the pipe liner
is there room in my window to fire a
call if yes you'll go right past out of
a Plock if not you'll be queued up until
the next guy comes back so in this case
when that fifth outstanding query comes
back I now have room in the pipeline or
so I can keep going it'll it'll
basically say I can go pass a weight
block in the in the loop and now when I
need to generate a call back I actually
need to ask the pipe liner for their
call back because as I told you there's
a little bit of accounting going on here
and this pipeliner class needs to know
when is it that I can launch the next
guy so the pipeline actually has a defer
function which I've implemented with
this regular iced coffee script and it's
doing both the accounting and also
populating the results as we saw in the
previous slides at the end of this loop
i have to flush to make sure that all
five outstanding guys are back and then
i'm done so this is a pretty complicated
control flow that's just very succinctly
captured with this library and I told
you something about doing background
work so when you're in this asynchronous
idiom your past a call back your
functions past a call back and you you
call a call back to tell your call
you're done with your work but it
doesn't mean you get to stop executing
and in particular let's say I want to
take this search function I've been
talking about tell whoever is doing the
search that okay I got your results go
print the page but then I could do other
things like save to disk or I don't know
dude do something else in the background
and this is also possible with iced
coffee script in this case after I've
done a search like call back my callback
with the result here with your result
then I can save the file to disk and
then report an error or something so
just because you call your callback
doesn't mean you're done you could do a
lot of interesting things and this is a
very powerful feature of a language it
just allows you to basically in threads
you'd have to do something call fork but
in ice coffee script it's just a natural
extension of the way things are laid out
and this last example is a little bit of
a of a trip it's it's allowing you to
take any function you could think of in
this case our search and apply to it a
timeout so if Twitter is slow i don't
know why that would happen
you could say either give me a result of
the search or wait or if second expires
and I haven't gotten it then keep going
and this time out function is something
I wrote with iced coffee script too it's
pretty interesting it sets up two
different racing computations it sets up
a timer that's going to go off the
amount of time you asked for and assess
the Twitter search and whichever one of
those comes back first will then allow
you to exit this await block and keep
going so what that really implements us
a timeout either I wait a second or I
get a result but not both so again this
is a little bit of magic that's hidden
in a library that I wrote but the
library was all with iced coffee script
so again as part of this composable
language with just this very bitten with
this natural set of features that allow
you to do very interesting things so how
is this all pulled together as i
promised i didn't want to change the
interpreter i didn't want to do things
like require fibers because that's not
portable across all different
implementations it's really what I want
to do is take a coffee script and in do
more or less a source of source
translation so the way this works is you
parse CoffeeScript as usual you got the
abstract syntax tree and then you do a
rotation on that syntax tree to actually
implement the continuation passing style
translation and then alter output code
and then output code mainly as normal
but with some differences for for the
things that you rotate it and so I'll
explain to you what a rotation means so
here's a very basic example function f 2
i'm waiting on sorry function f 1 is
called i'm awaiting on f 2 and then
after that's done I can call f3 so
here's the regular syntax tree for that
as would happen with a vanilla coffee
script compiler there's just a block
that contains f1 a sub-block that's that
has a weight and with sub sub block of
f2 and then f3 but in a rotation you
have to change what's the child of one
because this effort you can only be
called out of weights at the weight
nodes discretion so what that means is
we're going to take take that second
sorry that third arm of the tree and
basically make it to be a child of the
weight block and this is more or less
pation so as you can imagine this has to
be done recursively up the tree so
everything that within an away block
needs that type of rotation parents of
those nodes needs rotations and also
inside a loops things get a little bit
interesting if you have break or
continue inside of a loop that also has
a weight blocks and you have to do
rotations inside those loops but a key
thing that I've discovered is you want
to use this sparingly you don't want to
do this for every possible node in your
object abstract syntax tree because
things will really explode on you so
with a little bit of care you can decide
only which nodes need to be rotated and
just apply those rotations to those
nodes and this helps keep the code as
clean as possible so finally I want to
tell you a little bit about how this was
implemented I didn't rip up all of
coffee script coffee scripts about like
a 5,000 line program and it turned out I
added about you know let's say about
1500 lines of code in particular the
grammar and the lexer file in
CoffeeScript barely changed at all so
these were very simple changes to the
grammar mechs are kind of all the all
the goods are really within this nodes
coffee file in which on the output code
it is emitted and finally so I think
I've covered all interesting parts of
iced and I've tried to tell you why Isis
meeting the spec for how to make
interesting asynchronous and simple
programs with javascript in CoffeeScript
one last thing I want to say is that
this isn't just a toy project we've
actually built a real site with it it's
in the wild and this little asterisk
next to it because the site is in is in
private beta right now but it's this
site called comma Soros which we're
trying to develop a matching system
based on people's interests and it's
about 30 thousand lines of iced coffee
script with about 10,000 lines of go
code but just to give you a sense of how
that breaks down with our new keywords
it turns out about two percent of those
lines use these weight blocks and about
nine percent of those weight blocks are
using more exotic and currency than just
line a than B then C so we're actually
getting a lot of use out of the power
within the library and even this
pipeliner Klaus shows up 20 times ok so
there are my turtles again they're flip-
but the next time you have one of those
oh god no moments where you have to
rotate your whole program just remember
use CoffeeScript use ice coffee script
it'll save you all the hassle and really
what I want to do is try to get a
grassroots movement into to get this
code mainlined into coffee script so far
it's in there's not really enough
support but I encourage you guys to
download it and enchanting these uh
these new language features if they
actually solve your problems and with
that hopefully there's a couple minutes
for questions and thank you for
listening yes so how do you realize the
await block waiting it does actually
yield back to the browser and get called
back or are you blocking somehow a
JavaScript cell no I could maybe try to
show you the rotation really quickly I
don't know if I can pull it up and we
can you see that no no anyway um the
answer is you take the code that's
supposed to come after the way block and
you packages up as a function and now
that function can be called whenever
you're ready to do it so there's a
little bit of code in a weight that says
the roughly the answer is let me just
that back ok you have the rest of the
program as a function and you basically
pass that as a call back to set timeout
in this case and it just fires for us so
no changes to the browser what's your
experience with debugging this stuff
what does it do ah ok um rationalize
what's happening so this is a great
example as to why in some cases were
better off and basically we can annotate
this code so you people already have
this problem anyway with hand-rolled
callbacks because you know you'll get a
return from from Twitter and the whole
top of the stock will be lopped off and
you'll just be left with a couple frames
above the Twitter so trick
and so actually because we've made this
a lot more structured you can now
annotate the code and kind of recreate
the chain of callbacks it got you to
where you were and we're able to say you
know this actually happened at you know
this is this is on the github page I'm
not gonna be able to explain it but I'll
tell you the real set of calls to
actually went up there and we could also
do something like use real line number
translation as opposed to coffeescript
you know the CoffeeScript to JavaScript
translation so anyway I think the answer
is it's better at debugging because it's
a more structured way of putting your
programs together yes back there um so
what like what was your process at
arriving it at this solution to the to
look to the problem you talked about at
the beginning like I liked was this
organic like how how did you get there
we got there we had done this the same
thing in C++ in about two thousand seven
um we started with the same problem
though we had a whole website build with
C++ and roll call backs and that turned
out to be I mean people were really
quitting her company because he just
could not deal with it so we decided we
had to come up with a better solution
and the solution we came up with was one
that had all those four requirements
that i spoke about and it had to be
backwards compatible because we couldn't
rewrite the whole thing from scratch so
these primitives kind of fell out of
that and it turned out there exactly the
same thing that works in my opinion
really well for coffee script and an
iced coffee script so I guess experience
is really how we came up with okay I
think that's it for now so if you have
any more questions max's will be
available all right um thank you ever so
thanks very much max
I'm</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>