<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Forrest L Norvell &amp; Brian Ford: MONKEYPATCH THE PLANET! | NodeConf ONE-SHOT | JSFest Oakland 2014 | Coder Coacher - Coaching Coders</title><meta content="Forrest L Norvell &amp; Brian Ford: MONKEYPATCH THE PLANET! | NodeConf ONE-SHOT | JSFest Oakland 2014 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Forrest L Norvell &amp; Brian Ford: MONKEYPATCH THE PLANET! | NodeConf ONE-SHOT | JSFest Oakland 2014</b></h2><h5 class="post__date">2014-12-22</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/fSbVefTUgwc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right wait I think you get muted
wait yeah okay cool we can talk now yeah
and there's both of us and this is
totally not going to feedback or be
weird at all no yeah I'm gonna yeah I'm
gonna pretend I don't like you very much
okay stand over here yeah I'll just move
over here okay all right hi everybody
hey so our talk is called monkey patch
the planet but before we get to that we
wanted to talk about us a little bit so
this is an actual picture of forest ania
my name is actually Brian fjord it's
often misunderstood is Brian forward but
and I'm Forrest Norville okay that's the
best joke we have so let's talk about
what monkey patching is really briefly
will be coming back to this throughout
the talk so this is just kind of a
high-level overview it's really easy to
say that monkey patching is like
replacing a function on an existing
object or something but really that's
not what monkey patching is actually
about what Mike has a lifestyle yeah
it's a lifestyle it's a philosophy it's
a religion we get into that more later
on it's to alter the baseline behavior
of your system at runtime in a way that
is invisible to the code that is running
within it so it's a way of augmenting or
replacing or enhancing existing behavior
transparently very good okay so why why
would you use it oh this is cool so
we're like slightly cut off here plus
right we can just talk about this stuff
yeah so let's say you have an appt an
asset you hand it off to one of your
interns to write not that anybody here
did that and it's got a whole bunch of
windows alert calls in that you have to
like keep space barring through write
CSS is hard oh yeah I think that's what
the talks were about yesterday yeah yeah
so rather than do a modal you can just
do this yeah so you want to you want to
get rid of that so you can try to do is
or what you want to do is make it so
that it sends that to the console output
instead all right
so you want it to be like I said you
want to use wah console that woke him up
that work yeah it's close enough
whatever but you're gonna for the
coolest life later you're gonna me to go
full screening yeah all right I'll do
that oh and we should hide this thing or
like make it a little small computers
are hired okay keep talking keeps all
right well it's your turn to talk now
okay we're on to the next slide is that
how this works yeah okay all right so
one of your options for removing window
dot alert is to use this thing said so
you can just replace all of the things
in here right problem solved right first
well not so much hi cuz you know you
might end up replacing a bunch of stuff
that you didn't want to replace because
you might end up just like you know when
you do a global search and replace you
do a global search and replace maybe you
actually wanted that to still say that
it was still window alert even though
you're using console dot log so how
would you deal with that Brian well we
can use this cool module called falafel
that builds up in AST and like parses
the javascript so we know that this is
not a string window alert this is like
legit windowed on alert and you'll note
you have to you have to take care when
you're doing this and these are all
highly endorsed will never get you in
trouble methods for making sure that
you're running the right thing to make
sure that you only call your monkey
patch method when it's appropriate right
so it's still not that great though
because let's say you wrote code like
this because you're smart and you want
to access alert in the smart better way
dynamic languages are very dynamic yeah
so you can call things in all sorts of
ways so that won't work but what if we
were like super smart and used a JSP are
sir even more so we wrote a code
transform that took input like that and
maybe did output like this so like on
every function call we make sure that
the thing that we're not calling is
window dot alert right so this is
actually basically the same code it's
super simple alright just drop that in
your app and no more window alerts no
big deal I sweet there's one small
problem with that though you've actually
managed to
completely complicate your build process
because you have to do this source to
source transform you like if you want to
be able to debug this in the browser
because you can't do this at all no
really you're going to need to generate
source maps which is yet another
complication for your build process and
we have literally duplicated the number
of function calls that you're doing so
we've taken something that was probably
reasonably perform it and we've made it
while performance isn't really an issue
in node ever so that's not right you
like by Morgan Peter's right its web
scale yeah it's not horizontally no
problem two desktops you're set oh yeah
there's also this other problem which is
that you know you might end up breaking
everybody else's code and so either you
have to like maintain your own Fork of
the stuff that has your like preciously
built arc is newly created like
transformed version but or you might
want to lose through some sort of
dynamic process where it goes and it
monkey patches your code at runtime
Bryce wouldn't know anything about that
and like there's nothing that can go
wrong with that and there are no like
performance implications that always on
the forest you didn't it okay what will
I said you're selling them on it this is
yeah yeah this is great okay everyone
looks convinced okay so like a better
solution maybe would be just to do this
like window dot alert equals console dot
log fine call this is monkey patching
classic here right so done deal like no
more alerts in your app and kind of as
an added bonus monkey patching is really
funny and just like imagine the look on
the next person who has to maintain this
code space when they see what you did
yeah that's the thing about monkey
patching right it makes people kind of
mad and that's kind of awesome so like
that's a good reason to use it right
there all right cool so that's great but
what if we add some cool jQuery widget
onto our page that for some reason needs
window dot alert for god knows why he
used it to block maybe I don't know it's
a control flow techniques right so we we
want to maybe just monkey patch a
specific part of our app so some
specific context so what you might do is
grab a reference to endure that alert
replace it with console that log do your
thing and
and on replace it right yeah so that's
cool and maybe you want to write a cool
helper like this because we're
functional programmers and take the
function returns a function yeah so this
is another kind of classic monkey
patching thing that you might do like
function not apply and functional
collaery best friends and you can just
kind of sneak additional behavior in
there yeah that's great there's nothing
wrong about oh god async behavior so you
run this code here and it's going to
totally run without your monkey patching
because you did something asynchronous
right if only there was some way to fix
this behavior oh but wait there is you
just among needs a monkey patch that
timeout problem solved see you got the
same we basically do the same thing we
did before only we apply this to
window.settimeout now so now you've got
your patch run your original function
and then unpatch it sweet right also no
only done note the use of the comma
operator in this code sample that's
because I wrote this slide okay but what
about set interval like our app doesn't
do just that one async thing sure monkey
patch that interval keep going all right
cool but like there are other AP eyes to
what about those monkey patch everything
just monkey patch the entire universe
really is that okay yeah that's totally
okay ok cool so actually this is what
for us and I have each independently
done in different contexts I wrote this
thing called zone jas which gives you an
API that looks like this that says
monkey patch everything all the time and
unlucky patch it outside of this context
so you could accomplish the same as we
were showing in the previous slides with
a little code snippet that looks like
this and you didn't even have to monkey
patch literally every single a sync API
in the browser so that's a little bit
less work than it would have been
otherwise so I've spent a lot of time
talking about continuation local storage
for the last year or so and I've also
spent a decent amount of time talking
about a sink listener which is what
happens under the hood the cool thing
about this is i talked about how great
these things are and
nobody ever really digs deeply enough to
see and how incredibly grotesque it all
is under the hood yep this is this is a
good test part yes all that stuff's
already happened by the time you get
here and you could have set that session
anywhere and it scoped this particular
continuation change so for each
individual requests that you have coming
in we'd added this behavior the
interesting thing about this is that the
consequences are not nearly as dire as
you might think they are like depending
on what's going on you may see about 0.5
percent to about well okay like in
pathological conditions it's like
ninety-five percent overhead and like
the memory overhead is like 18 times as
much and that's all gross but that
actually doesn't happen because that's
not in code that people actually right
that's purely micro benchmark code so
that's your pathological case so you get
all this interesting async behavior that
is done by basically overriding
literally every acing function in note
right and you only have to buy 18 more
computers to do it yeah and to the best
of my knowledge this I'll just work
in I ojs as well so that's great that's
cool okay so you know yeah so this is
the key this is the Cardinal law this
stuff is super fun everybody should do
it in all of your libraries from out on
its aaron here wait he's around here
somewhere yeah you should totally get
more of this into happy going for it you
can totally solve all your domains
problems just by monkey patching the
 out everything but don't break
things for other people and the thing
about this is that i have done this
there are literally thousands of
production sites running an entirely
monkey patched environment because
that's how the New Relic monitoring
agent works but you and almost nothing
has gone wrong but when it has gone
wrong it has been bad because somebody
else has monkey patched something that I
need the monkey patch in an incompatible
way and everything blows up and you
can't use those things together and
everybody is sad and it's just you know
do I great for a sad is the short
version no don't that's that's that's
bad okay so here's kind of a rundown
yeah a little bit of this earlier but
you should probably call the original
function that's important because if
some other monkey patch person
in there and must render the internals
of your environment you want to be able
to apply their behavior as well
otherwise you might not clean things up
correctly you should keep the original
context so the value of this you want it
to be the same as if someone called the
original function you should pass in all
the arguments not just you know whatever
the function signature looks like very
important bunch of signatures change
yeah you can't rely on anything
JavaScript that's a feature and
especially because certain platforms
like issuing new major versions about
once every I don't knows how many how
long that's responsible like seven to
ten hours day is that do we know anyone
that works there and maybe I don't know
okay so yeah and then you should return
something that looks like the original
return value you should prefer modifying
the return value to like making a
totally new object because again some
crazy person might have gone in there
and magic properties but the kind of
like brain about all this stuff is
that when you are monkey patching things
you should be assuming that everybody
else's monkey patching things at the
same time it's like it's the whole the
Hippocratic oath first do no harm we all
said something in there about like
Smokey Bear and oh the doubts earlier
about yeah better than yeah that was any
whatever was anyone a Cub Scout like
isn't there a thing where like you know
you're supposed to clean up afterwards
and they have a nice concise saying yeah
all i can remembers will be loyal scouts
yeah and then don't start forest fires
yeah i thought that was thought good to
you I like always be prepared but I
think that's the communist youth
tomorrow so whatever okay and the last
thing is you should test your code
because like that's a good way to deal
with hater so when people look at your
crazy thing and they're like there's no
way this will work you'd be like boy
have I got a surprise for you and you
show them your test cases and they're
all green and they're like well you know
you wrote crappy code but it works and
you should try and run your tests or
your your patch your monkey patch code
against lots of other people's code and
so I actually built something called the
intermediately sized Hadron Collider
that automatically does this for you so
the Large Hadron Collider is a particle
accelerator I'm not smart enough to make
that so I took the lesson dishes route
which is right a testing tool
but with what this does is like you give
it some patch and it'll run it against
like really commonly use libraries and
make sure that their test cases pass
even in a monkey patch environment so
you can have some level of confidence
that this works so it's kind of like a
like poor man's integration test from
reading monkey patch code so you can
check it out it's on github so kind of
in summary like right terrible code
prove that it works like laughs in the
face of your haters it's pretty good oh
and then yeah we have a slide on this
right for us this is your forte yeah you
know yeah welcome I'm not gonna dance
for you guys I'm really sorry it's not
really my thing but there's actually
actually I think we need to move on to
the next slide okay well i can say some
abstract philosophical things okay right
so like usually when you want to make
new behavior the way that you do it is
you like extend some existing class or
like write a new API but the cool thing
about this is that you don't have to
touch any of the existing code like you
can just introduce new behavior all over
the place and that's kind of powerful
like you see for instance polyfills or
even prolly fills how many people here
know what a prolly filler is okay all
right okay yeah so ask your neighbor or
just listen to me because I'm gonna
explain right now the idea is like when
when you're trying to come up with a new
feature for JavaScript or for the
browser like you try and implement it in
JavaScript inside of the current
environment and then you can use this as
a way to try and you know figure out if
the API is good or not so there are lots
of examples of this and actually can
kind of think of zones or continuation
local storage is probably fills yeah the
kind of go back to what I was saying at
the beginning of the talk the cool thing
is you can extend the properties of your
platform for all the people using it
without actually forcing them to write
any additional code that's the real
power of monkey patching is that you can
add new capabilities remove existing
capabilities alter all kinds of crazy
stuff for a particular runtime
environment without requiring people to
actually opt into your API sore
even necessarily to learn anything like
the you know an example is that with the
new relic agent you just require this
thing you don't even need to assign that
to a variable and all of a sudden you've
got performance metrics coming out of
your appt you know in with in the case
of zones it's used by angular to handle
a lot of their their kind of magical
scoping and data binding behavior
someday someday it'll do that right now
it just sits up on github sweet someday
yeah wait there's one other cool thing I
was going to say what was it okay we're
going on the next time we rehearse this
a lot yeah well I mean we did yeah this
is kind of like that time one of my
favorite people in computers said time
monkey patches all things yes really I
don't know what that means yeah but
really we're all changing like we're all
interacting with each other as time
passes and we're all changing aspects of
each other as time passes in this this
very mysterious and hard to observe way
so really over time we're all being
monkey patched by each other right that
was really good thanks I want to point
out by absolute favorite thing about no
continuation local storage is its name
because its name is super concise and
easy to type every time I need to
install it yeah that's so the name of
this module is actually the inspiration
for the length of the name of the thing
that I talked about earlier then
immediately sized Hadron Collider see I
it's descriptive it doesn't necessarily
tell you what it does but it's long
right okay so
there's also some cool things on github
that show how you can use monkey
patching to crazyville things or crazy
good things yep and yeah good luck have
fun thanks everybody</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>