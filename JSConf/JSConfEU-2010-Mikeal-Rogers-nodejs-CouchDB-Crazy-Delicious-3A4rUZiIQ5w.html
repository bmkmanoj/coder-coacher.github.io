<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>[JSConfEU 2010] Mikeal Rogers: node.js + CouchDB == Crazy Delicious | Coder Coacher - Coaching Coders</title><meta content="[JSConfEU 2010] Mikeal Rogers: node.js + CouchDB == Crazy Delicious - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>[JSConfEU 2010] Mikeal Rogers: node.js + CouchDB == Crazy Delicious</b></h2><h5 class="post__date">2013-06-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/3A4rUZiIQ5w" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so no it has really great HTTP support I
don't know if you guys really appreciate
this but I mean compared to Ruby or
Python it's pretty phenomenal like I've
dealt a lot with the lower level Ruby
and Python HTTP stack and there's so
many bugs and oversights and it's just
generally not usually very performant at
all and to put this in perspective for
node node Z should be support is
probably a little bit better than curls
right now like there are bugs that we've
fixed at this point that we know are
open curl bugs that aren't planning on
being fixed ever and we have fix those
in the know to implementation and count
only supports HTTP there is no other
format I didn't invent its own binary
protocol we want you to be able to talk
to it from the browser and all that so
that's a really good fit I spent like a
lot of the problems we've had with
client libraries in Python and Ruby is
just that trying to make them really
fast and perform it we always hit this
bottleneck of HTTP and that's just never
an issue with no oh really okay up I can
I can probably speak up a bit if we
don't even yeah cuz I don't even know
where the button is to turn it up so all
right let's speak a little bit louder
okay and concurrency so yeah I noticed
phenomenal at concurrency it has all
this beautiful async I own it and that's
another problem that we've always run
into is the cash to be is optimized for
being incredibly concurrent because we
actually want you to connect to it from
the browser so we've got to handle tens
to hundreds of thousands of concurrent
connections all the time that's how
we've always optimized from the
beginning but then people plug in their
traditional Python or Ruby stack and
usually when they talk to a database
they try to limit the number of
connections that they do and they're not
very good at concurrency themselves and
that's just never an issue in note it's
always very very fast and very beautiful
and a lot of other databases aren't
optimized for concurrent access either
and nodes the whole system is optimized
for concurrent access so that's really
good sometimes when you take two things
that are both
really really awesome and you put them
together you get something even more
awesome and you didn't even realize how
great it could be kinda like you took
curry and like wieners and like you know
delicious sausages and put them together
you'd have something you didn't even
know could blow your mind like this all
right so there's a lot of libraries one
of the things that notes support for a
CV being so good and the HP API and
couch being pretty simple is that
anybody can write their own library all
the time so of course we have a bunch I
think we're probably averaging about one
a month right now so I'd love to be able
to tell you that like well this library
is really great at this thing and this
one is really great for this other use
case and they all have their own little
features in their niches and they're
definitely very opinionated but the
biggest difference between them is just
who wrote them so so basically if you
like one of these programmers where you
want to talk to them about their library
because like half of them are here I
would just do that because there's there
really isn't like a feature graphic you
can put up there they're all pretty
comparable and that put their pictures
up there so you can find them I don't
know if cloud heads here but he didn't
have a picture so I just grabbed a cloud
from final fantasy and put them up there
and I also that's not a super close end
picture of felix so I found a bigger one
so yeah just look for him and you'll
know where you got ok so good the other
thing about oh god that lines in the
wrong place I saw my slides basically
keynote crashed and i lost all my slides
and so i had to redo them and so some of
them are kind of up and I'm sorry
so this here is using my high-level
request library it's just a little bit
simpler than nodes regular HTTP stuff
and this hopefully actually is going to
go into core I sent out the email today
so hopefully we'll get something like
this in the node core and it'll be a
little bit easier to do get in post
requests with just one or two limes but
anyway this is how you would talk to
CouchDB without a library the CouchDB
API itself is very well defined it's
very simple it's all HTTP this is how
mean a lot of other people access couch
and
don't try to go through an infection or
a library just because sometimes those
abstractions leak or we need to get new
features into them or you know whatever
we know that the HTTP support and node
has everything that we're ever going to
need and we know the couch API well
enough and if you just want to learn the
couch API and go through the wiki and
just look at the raw HTTP API it's
really not very hard at all it's not
like you were trying to write a driver
for my sequel or something so yeah this
will use that pretend that line down
there isn't it further slide like in the
future okay so couch ABS just do people
here kind of know the idea behind couch
apps at all so like for okay oh there's
more there's more okay all right cool so
the idea of couch apps is that rather
than having like this middle layer
between the browser and the database you
can embed especially for simpler
applications you can embed pretty much
all of the application logic in the
CouchDB into the database and then you
don't have a lot of extra round trips
catch 2 b's very good at concurrency
bubble blog also these applications now
it can replicate around so if you have a
mobile phone and you want to talk to
your application offline and then come
back up you can replicate with some
cloud server and then the application
and the data gets synced around so yeah
that's the idea behind couch apps but
here's the problem with couch apps the
only tool right now well there's a
couple tools but the main tool is this
Python tool called captain Benoit wrote
you did a great job not knocking it but
because the tool isn't Python because I
don't think no really existed would
Benoit started this you had to kind of
map the little j's functions and little
attributes that end up going into this
design document it's all just one big
JSON document at some point it gets run
in like a JavaScript view server so all
these little JavaScript files or
everywhere in the file system because
with the tool being in Python it's not
like you could just write some literals
or you know scope out an object and then
just kind of dynamically be like I want
this piece here or that piece there so
what you end up with is a directory
structure kind of like this and you can
see a lot of things that make this hard
to use like I mean for one there's just
a ton of
different directories everywhere like I
mean if you didn't think that Java had
enough directories and little files in
it then like you're gonna love this it's
awesome and and the best part is that
like you'll have a directory of eight
files for like your views and they'll
all have a map jf so once they're open
in little tabs there's no way to tell
them apart unless you click back on them
in the directory tree she would be
editing one of your map so then you're
like oh wait that's the wrong map
and there wasn't really a lot to tell me
about that so yeah that's some of the
pains you go through working with that
so to try and make that try and decrease
that pain a little bit I wrote an ode
thing it's a new API and a new sink
script that doesn't use this directory
structure but gives you an alternate way
to define couch apps because couch apps
are just design documents with a bunch
of application code in them they're
basically just a big Jason thing with
some you know functions in them so this
is kind of the simplest case right here
this is this is actually a sandy
application that i wrote to do graphing
for performance analysis of CouchDB it's
a pretty cool app and we do really
pretty graphs with it but it doesn't
require anything fancy on the couch and
because all it really is is a sammie
script I just want to like do some
rewrites to map it to slash and map the
database to the API and then map
everything else all of the attachments
like CSS and all my different JavaScript
files that are attachments I just want
to scope them to the design document
itself so I have these couple of rewrite
rules in there and that I have a thing
that just loads the attachments from a
directory and then all of those
attachments now will go into the design
document and then if we go back a few
slides so pretend that that line right
there is at the autumn of the other
slide this is the script to use to sync
that application to catch DB and the
nice thing is that after it stinks it
will actually stay open and use nodes
file Walters to take any changes that
happen on that and push it up to the
database so one of the things that we've
been trying to do for a really long time
is make couch app development as easy as
developing a local application like if
you were just going to pull up a
directory of CSS and JavaScript and hack
on that like it's so fast and so nice to
do like I pull up textmate and I have it
actually save on application switch so
just command tab back to the browser and
refresh and it's really easy to
development and trying to do that with
couchdb there's like all these layers in
between and keeping that fast is kind of
hard when I was developing this app I
left to that node sync script running
for three days and completely forgot
that it was there and that I was
developing against remote server I would
just like command tab back and forth
from my editor to to the browser and it
would always be updated with the change
code and I also i mean i left him
running for three days between laptop
open and closes and I didn't even notice
the process running it didn't leak any
memory anything like if that was a
Python process it would have just
decided to eat a whole core for no
reason like that's kind of a testament
to how awesome a lot of the node file
watcher stuff is right now and we're
still improving it so that's also good
um yeah so that stuff is just awesome
for more complicated applications you
can do a lot more stuff with this script
so you can load up common J's modules
and then you can also load them as files
as attachments that's really cool
because a lot of these comedies modules
we can share between the server and the
client and like the inside of CouchDB
and underscore utils there's a jQuery
couch API and that includes a require in
it so you can just tell it what design
document to go after and you can load
all the common J's modules do you use in
the view server yeah so I can just start
adding arbitrary attributes to the
design document which is really nice
instead of showing this functions and
stuff here you see the the reread all
over again go to the next page so here's
how you would do add your map reduces
you can like this is so much easier that
used to be two directories and a single
small javascript file with three lines
in it and now it's just in line the only
thing here is that it's it's kind of
fake it's kind of a trick like you can't
reference a closure from the from the
base of this module inside of this
function because it's going to happen is
it's going to get too strained and then
loaded in a totally different context in
the view server so it's really just a
convenience for definition it's it's not
like this whole thing gets loaded in and
interpreted like this at any other time
other than when we imported it into node
and convert it into a design document um
once we got we got an update function no
no sorry that's a show function shell
functions are really nice so one of the
problems that you have like if you if
all of your app code is a sandy app then
it can't really be indexed by Google
because that's just one page like you
know totally different content
variations at the end so the show
function is just a catchy function that
inside of the Earl will take a single
document ID and then it will pass that
document to this function and you can do
stuff like grab some mustache templates
and return HTML you can also you if you
wanted to return in RSS feed you could
do that for also speeds actually you
should probably use a list function so a
list function is it's similar to a show
function but what you do is you tell it
what view you want to hit and what query
you want to do against that view and
then row by row you can iteratively go
over that entire query and return an
HTML page for that so that would be
really good for like an RSS feed so you
just do a rewriter that defaulted to you
know limit 10 and you get the last 10
articles for you know some time stamp
and then you would just pass that into
this list function and then you would
return some XML you can change all the
headers and all that kind of stuff it's
pretty simple there are a couple
performance problems with this right now
but we're working on it ok one of the
nice cool thing I'm realizing how short
this is going to be at this point
because this is like the last thing that
I was talking about so usually when
people go like i will use noting CouchDB
this is what they want to do they
initially want to you know slot node
into where they used to have Python or
Ruby or something like if they're really
unlucky Java and then you know they want
to put couch behind it like they used to
with their old database and one of the
reasons the people always did that with
their all databases they're all
databases didn't talk HTTP you know that
was their only option was to put it
behind something they could take HTTP
requests and then talk to the database
so this is where we've been using a
little bit lately because there's some
stuff that you just can't do instead of
the catch to be view server like inside
of those shown this functions you can't
just go and like send an email or go and
like request some remote content from a
site like you're in a sandbox one of the
reasons you're in a sandbox is because
we want you to be able to replicate
applications from different people
that are essentially untrusted like
they're going to be walked into that
database and only have access to that
database they're not going to be able to
get at your personal information and uh
because of the way that we host and
rewriter stuff works they're totally
locked into all their session
information only being able to access
that and then the view server we also
lock it down so you can really just
install applications into your caps DB
and not worry about them like you don't
worry about visiting websites so yeah
but because there are some deficiencies
we started working on this and there's a
couple of different permutations of this
paradigm right here like Chris has one
and I've been working on this and I
think somebody else won't run as well
I'm going to talk about mine a little
bit because the idea is a little bit
further along so couchdb has this
awesome awesome feature called
underscore changes so you do an HTTP
request to underscore changes and you
get the sequence index for the database
which is essentially every document in
the database right now has like a
sequence where it was last updated or
deleted or whatever inside of the
database so you can literally
reconstruct the entire database by
hitting this changes feed but you can
also use long pole against it with the
last sequence ID that you had you can
also do a continuous feed so in node and
if you really hack up the Firefox is our
object you can do this as well you can
get a real-time feed of this entire API
and we'll have WebSocket support as soon
as we get it in a Moche web so basically
you can get push notifications to the
browser or to whatever code that you're
writing in real time from the database
it's very very nice and of course node
can talk to this as well and it's even
better at parsing it so this thing we've
been working on is node 1 node process
sits on the changes feed for every
database and it's also checking all the
time to see if there's been any new
database is created when it gets a
design document added who is it changes
attribute it actually takes that this
whatever code is in the string here and
it evals it in a new nodejs process the
reason that we fought that into its own
process
is so that when you update it again we
can just leave that one around for a
little bit let it clear out and start a
new process and start having that handle
the new changes that come in so we'll
get into why this is useful the reason
that we want you to update an attribute
in the design document in order to flush
that is because now updating this
external process handler is the same
process that you go through for updating
your application normally so like the
distribution like there there are no
like push tools like you know get pushed
to something and then you restart your
couch app it's all this replication so
you just put this document in for all of
your other application code why wouldn't
you want to do that for your nodejs
external process okay so this is what it
would look like to send an email rather
than talking to some HTTP service and
then like basically blocking until that
says oh I sent this email and then if
for some reason the socket crashes or
like anything bad happens during that
time you don't know if you already sent
it so now you've got to try to figure
out if you sent it or just send it again
and then you have duplicate emails we
just share we just have a state machine
that shared between everybody involved
in this transaction so what happens is
the browser application will just go hey
I want to send a new email and it will
set it with a draft status and when the
note process will go okay that change
happened to this database I have an
external process handler for that
database it'll send it that change with
the ID with the whole document in it so
it'll get like the sequence ID and the
new Rev and much of other information
and then what nodejs will do is it'll
update that document and CouchDB and say
okay I'm going to go try to send that
now and maybe it'll also put the
timestamp in there so that we can clean
them up if for some reason it crashes
and then it'll go off and still an email
because node can go and send emails you
can talk to whatever it's not inside of
the same sandbox that all of the cash to
be stuff is in and then it comes back
and it goes all that was sent and then
it updates the couchdb database with
that information so the browser could
just be sitting on the changes feed as
well for the database or just for this
document and in real time update the
status
that of what's going on behind the
scenes here so the real big one do you
get with this is that this whole system
this whole application now works offline
so when I've got like a cash to be on my
android phone and a catch me on my
desktop and I get on a plane or I'm in
San Francisco so I clearly don't have
any service I can go home to my email
client and just be like I want to send
some emails I've set them in the draft
because you're not online yet and
replication isn't like some kind of
special protocol with cash TB
replication uses the normal couchdb API
so another has to be replicating a
document to to the cloud couch creates
the same document in the same sequence
index and all that stuff as a normal put
would do so by the time the battle makes
it back to the couch DB the node.js
process to go oh I'm about to emails to
send so when it's online that
replication is all happening in real
time it's all continuous you wouldn't
even notice that there's like this extra
link in that chain but then when it goes
offline none of your app code has to
deal with being offline that's all going
to be handled by CouchDB all you're
going to do is go sinless email and it's
going to go well that's still in graph
status and nobody's trying to send it
businesses lock up like Gmail does right
now for me for some reason know when you
add in all these they're crazy cash db's
like you know you're probably not going
to have this your cell but in a lot of
work groups you're going to have a bunch
of CouchDB use and different like mobile
phones and may be in different data
centers and you're going to be trying to
like you know sync everybody's data
across like korea to here and below blah
and they're all going to have these like
super weird replication paradigms where
one of them is going to be doing Willie
replication one's going to be doing two
way and did it if you've only got one
guy responsible for handling the email
then you're not going to have a bunch of
duplicate emails sent and because the
document is just a state machine if one
of them updates it and says I'm sending
it dealer was not going to go and try to
send it as well like that's that's going
to get replicated around it's going to
go oh no no I didn't I don't try to send
that yet so yeah now you can have these
like federated distributed applications
and they can also go up and talk to the
Internet and they're not necessarily in
a sandbox except for the
one trusted cloud couchdb or maybe i run
another one that i want or whatever you
can do whatever you want but it doesn't
require any new app code I didn't have
to write a bunch of JavaScript to try
and handle all these weird edge cases
with replication that all just works
couch is very good at replication so
yeah I had another side that had links
to everything and i forgot to rewrite
that one so i'm very sorry about that
but these are all in github one is
github the node couch app stuff is
github / michael my name spelled
up / node couch fjf and the other one is
just in node couches and in there you'll
see that there's a we call it a generic
changes consumer it's very inside
baseball should probably come up with a
new name for that yeah so any questions
no I find it very hard to believe that
everybody actually understands what I
just talked about all right amen
hmm
so how do you work with them how do you
work at the mobile couch okay yeah so we
have a winner beta up right now with for
the Android SDK other ones are coming I
don't know if I can talk about them I
know it's public that we're working on
the iOS one I just can't tell you how
far along it is but um anyway so yeah
when you're when you're talking to
Android couch Android catches everyone
is pretty cool so with Android what you
can do is if you're willing to write
like a phonegap application right and
you wanted to distribute the entire
CouchDB around with your application and
bind it to it you can build it that way
but what you can also do is you can
build CouchDB as a service so then it's
installed once for the device and when
other applications are installed what
they ask for is access to that service
and you'll see like a little couch icon
when you install it and stuff and then
and then they would just get access to
the local system CouchDB so we're trying
to figure out which one of those is
going to work the best in terms of like
just accessing couchdb I mean it's still
just the HTTP API you still just write
html5 applications against caps TV that
doesn't change on mobile at all I mean
we're definitely going to do some really
good like PhoneGap integrations that we
can get it some of the native stuff even
inside of that html5 application but now
when you develop it against cash to be a
new store the data and cache to be the
offline stuff works then it can
replicate back up and it can replicate
with your desktop computer while you're
offline on a plane or whatever as well
that stuff all works quite well yeah
yeah you can go to the couch one website
so it's catch one calm and then you'll
see a big thing about mobile and you can
download that download the Android SDK
and there's some good preliminary
documentation for that I don't know if
he did it this week or if he's doing it
next week but Aaron Miller the guy who
wrote the android port is doing some
kind of free webcast for O'Reilly about
how to do development with it yeah also
I know that Brian LaRue has been messing
with it and Joe McCann's been messing
with it so you can bug them about it
anything else where it that way yes
no no it's not completely open like Nana
there this security in cash TV we
weren't just like no we don't need that
yeah so Josh to be has a user's database
and every database one ends up happening
is after that us happens then we just
have the user document from the users
database and we pass that around as the
context for that user so there's like a
nice abstraction between those layers
whenever a document update happens like
we take that user context and we take
the old document and the new document
and even when documents are deleted it's
just now a deleted attribute we passed
those as three variables to a JavaScript
function and what you can do is you can
throw you can just say like I'm not know
that users not allowed to do that and
that throw message gets turned into like
a proper HTTP four hundred to the client
the really cool thing about that is
there because replication is just a
normal client like on my android catch
TBH i'm like root like I knew ever
I want and then when I go off and I
replicate with the cloud cash to be like
I'm not root I'm actually like a user on
that couch and I'm talking to the
regular HTTP API and I acenta Kate and
if I'm not allowed to write the
documents that i wrote on my local couch
like those will all be like no no that's
not happening and I won't like pollute
everybody else's data yeah i mean i
could probably do an entire talk just
about all the authentication things that
you can do with cash to be we're all so
we're working on some new documentation
that'll show certain how you would
implement certain fin occation patterns
and couch but yeah one of the nice
things about it and a couple of people
in our case studies have actually shown
that this is how they use caps and how
they use how they push data around and
give data to customers is that they just
they every customer gets their own
database and if any information is ever
like exchange between customers like day
control those access controls of what's
going in and out
and so everybody at the end of the day
gets a database they can do with
whatever they want and they can
replicate that with somebody else or
they can keep pulling replicating and
things like that it's kind of hard to
explain without slides I'm sorry
anything else yes
oh yeah so the but by the time the sdk
is not in beta it will actually come
with a demo application and to make sure
that we can get through the store and
Android in the store and iPhone will
actually be taking that application
which although you'll see the mule sale
de code for and submitting it through
the app store to make sure that like
there's no problems so yeah so yeah
there there will be a demo application
soon basically there's lots of demo
couch apps for desktop and basically the
idea is that anybody can write an
application and stick it into this and
it's kind of like the open app store for
couch apps and when you look at any
application you can see like a little
demo and then you can actually replicate
it to your couchdb and then you've got
all the code and all the example stuff
and it's pretty cool what can you sell
it no no we have not hooked that up yet
I mean maybe someday but not yet I mean
you could smell a couch up through the
android store yep
dump it to the computer when like like
dumped out like I mean yeah I mean
they're all in one like a couch at this
literally one design document that says
everything about that application so I
mean you can pull that whole thing
around that's what implication does
replication just pulls the whole
document around yeah yeah you get
nothing else i'm pretty sure that now
i'm actually pushing out a time so let's
get Felix up here</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>