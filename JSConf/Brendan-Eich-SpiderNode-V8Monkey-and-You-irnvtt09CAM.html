<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Brendan Eich: SpiderNode, V8Monkey, and You | Coder Coacher - Coaching Coders</title><meta content="Brendan Eich: SpiderNode, V8Monkey, and You - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/JSConf/">JSConf</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Brendan Eich: SpiderNode, V8Monkey, and You</b></h2><h5 class="post__date">2013-01-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/irnvtt09CAM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">we're terrible at secrets at Mozilla so
I think it's known what we're talking
about it like it's been in github for a
while and there are links here and we
have an IRC channel mailing list so I'm
talking about spider node v8 monkey and
you what the POW is polish Anna sees
here I'll be helping with a QA he and
rob Arnold and Chong Wilshire decided to
do this crazy I'd thing of how you can
read that put the v8 API around spider
monkey and put it in node soviet monkey
is the v8 api for spider monkey and
spider node is a clone of node that uses
v8 monkey instead of v8 and it works but
why would you want to do this well we we
love v8 it's awesome it's really good
work and it keeps getting better and we
also like the other open source engine
of note webkinz javascriptcore the
clothes or sentence we don't know about
them spider monkey is very own it's
something that i wrote as a second
engine at Netscape when I was supposed
to be helping out with standardized yes
one actually took time to do this and
got in trouble with my bosses but the
first engine i did was such a rush that
it needed rewritten so spider monkeys
very old and as one of the Heather said
my after life is so boring because we've
really been through a lot and we've
written it incrementally it's even now
getting a new GC a new intermediate
representation SS a super optimizing
profiling just in time infrastructure
called ion monkey and type inference
which is going to be awesome um Brian
Hackett's doing that one already it
might ship soon we we love v8 C++ API
spider monkey so will it will see so the
API is sea spider mark is used in the
Bloomberg terminal there's 16 million
lines of JavaScript there it's not going
away it has its own API but the VA API
is nice and clean c++ with
just the good parts all you need for
safety like templates and stories class
auto constructors and destructors stuff
like that garbage collection all the way
tube to nuts the jobs of language is
evolving how many people were at j s
conf okay you're going to see some
slides but i'll go fast for those of you
who weren't the slides that i'll show
thats will be of interest harmony is
coming to es next and it's it's means
that there's going to be supporting v8
at some point and we're not doing v8
monkey to try to sell you something we
are doing it to get the vapi up and do
some experiments and if you want to use
it great we we welcome people we're not
trying to fork the no community we're
not trying to compete with v8 I mean
they have an awesome garbage collector
we're not ready to do that yet so you
notice a great test bet it's outside the
browser you can you can rev it quickly
you can use new features without
worrying about ie6 this is why we're
doing this here's the es next stuff that
I showed at James Caan gonna go really
fast you've seen all this it's awesome
some of it is supported with this tracer
compiler that google announced and there
are other such things out there
transpiler 'he's having it supported in
your engine is even better because it's
fast and you have to run a compiler or
transpiler some of the stuff here makes
arguments go away like the rest and
spread proxies and weak maps are great
for doing runtimes and bridges and
mirrors and Dom's node lists modules are
very much aligned I would say with
common jas but built into the language
so that the compiler knows what to
prefetch iterators and generators syntax
being discussed still pretty pythonic
comprehensions got to have them also
generate expressions and then binary
data this might be of interest because
we're trying to embrace and extend the
WebGL typed arrays which are similar
quite close to the node buffer built in
and we think that this will be a really
bright future because you can finally
have sort of see like structs written in
a
almost declarative way generative types
that you can then use to look at binary
data you can have array of structs
trucks containing array members you can
nest them either way all the way down so
that's that's pretty awesome it's doing
great with WebGL you need a way to get
string encoded strings in and out of
this binary world and we're going to
make sure that's part of the new
standard for binary data this is comin
nes next here's something that's not I
show this is jazz comp I just want to
share my thoughts I would like to get
better function syntax in I know Alex
Russell mothers would too it's hard to
decide what that better syntax is and
exactly how it works it's hard for
committee degree on this it's hard for a
bunch of users to agree on it I'm
getting old i'm getting tired i think if
coffeescript has awesome syntax let's
just do that as much as we can now it's
a different language you have to be
careful with grammar but I think we can
do it and this is what I propose and I'm
going to propose us at the tc39 meeting
in three weeks including fat arrows so
you know what this you get and binding
forms that get hoisted to the block and
then you know maybe we'll get classes
that are prototypal in maybe not doing
your own prototypal inheritance is error
prone and tedious why not I don't know
there's it's hard to agree people want
classes to mean something else that's
part of the problem for entry syntax
another thing I'm championing we want to
lighten the C bracket load it's a
relaxation of the rules except for four
in where it reforms it bunch of
operators you'll recognize some of these
from coffee or C sharp default operator
Crockfords championed assignment form of
that integer div Maud Dib mod and coffee
like a gal operators to see if something
is exactly the same as something else is
distinguishable for something else so
you know negative zero isn't zero so
here's here's a demo of V a monkey and
spider no this shows a library Dave
Herman real called task j s which is
based on generators which are in yes
next in harmony this allows you to avoid
function nests and the setup is kind of
some boilerplate and then a little
constructor pattern node read file and
you have to look closely at these
keyword names the reserved word name
methods throw in return that's legal in
es5 it supported our
ready in Firefox and other browsers
working v8 what is this white object
well it's it's the this that was
constructed by new but it has a
prototype where we inherit those methods
from and that prototype is set on the
first line here and that is new task
wait and that's part of Dave Herman's
task library and a white object is kind
of a synchronizing device that you use
with yield in generator functions and
their you use TAF spawn you pass a
function it yields read file and on the
very next line no need for a call back
you can use that data you can get the
results out of it and put it on the
console you have to remember to yield if
you don't doesn't work but the price of
that yield is low compared to the price
of all those function s you would have
to write otherwise and so let me see if
I can demo this so here is Jen chieh s
and if I just feed it to note it's going
to spew itself back as you can see it
reads gender jas works and back to the
presentation another demo this is
another great demo that Rob Arnold just
threw together this is even shorter so
this shows how you can use this test
library and yield to write a loop that
you can run as a server and there it is
I'm going to demo it have to start it
it's going to be a hello world demo it's
running at that port go back there it is
reload reload reload reload reload
reload reload and no function nests the
yield seems to give back results which
you can use right away the magic here is
all in the task GS library far from
writing writing yield so I think this is
a win people complain about function
nests javascript function allah
functions are awesome but sometimes you
don't want to keep indenting and
wrapping and bracing so we're going to
have another demo i think and some QA I
wanted to thank the guys who actually
did the work Rob Arnold forever in
Mozilla just lost a CMU email at
Facebook
he works at Facebook Sean wilshire and
polish annecy work at Mozilla Johnny's
fort helped us with the build stuff
andreas calls my partner in crime and a
lot of stuff and he's helped too we have
an IRC channel pound spider know we have
spider note at mozilla org mail and
subscribe protocol and more demos and
questions there should be a node chat
instance running on SSID spider node
there's the IP address you guys should
try to melt it I think it's on Paul's
left no time he doesn't work restart
restart so uh so anyway we're happy to
entertain questions that's pretty much
the pitch we'd love to have people come
help us oh oh you know you want that so
right now we haven't d configured e4x so
it's there oh my god spider monkey has a
bunch of extensions right it has the
stuff that's going into harmony it has
efore x equity 357 is iso standard for
doing xml in javascript and partly
that's kind of cool because you can
write xml literals and it's nine big it
wasn't partly it's this crazy land sort
of Java like thing so yeah it's there we
can turn it off we don't advise you use
it again this is totally experimental
you opt-in we're not trying to do
anything crazy like Mickey for X a
standard and node
and
so that's a good question we don't know
yet because we haven't got it up enough
and we're still in you know debugging it
I hope the chat demo will work the
question is where will spider node v8
monkey beat v8 in node and I don't know
and we're not really trying to beat v8 I
think competition is good we can if you
look at certain benchmarks today like
certain Kraken benchmarks I think even
with crankshaft if you look at our
latest you know type inference jager
monkey whatever it is I on monkey stuff
were competitive with v8 and we have a
non generational GC which sucks for when
you're allocating a lot of objects live
a short time so we're moving at
generational but ironically for certain
other workloads r GC actually is better
than than v8's it all depends on the
workload that's the great story about
javascript is there's so many workloads
and the browser vendors have been tuning
for SunSpider for way too long and you
know tuning for the v8 benchmark isn't a
whole lot better we don't even say you
should tune for Kraken which is mozillas
collection of advanced sort of numerical
or combinatorially intensive graphics
kernels we're just trying to get
different workloads and see how we do
and there's tons more on the web there's
Emscripten which is Alonso Kai's lvm C++
to JavaScript compiler there's just a
lot of stuff out there to measure and
optimize for you think we should all be
able to optimize for like a
representative gmail workload I don't
know of that benchmark I don't know how
that's done so be it's awesome and we're
we're interested in being as fast or
faster the other thing we have already
the viet hasn't got yet are these equi
extensions these extensions that are
proposed for harmony some of them are
not harmonious e4x is a sort of a dead
limb in the evolution of the ACMA
JavaScript standards but others like
generators are already there in spider
monkey now therefore they're in v8
monkey and i just showed them that works
no trans pilot required no compiler no
continuation passing style conversion
required that's a reason to use to use
v8 monkey now if you want to try it but
again we're not selling you anything
we're just doing some experiments to try
to improve our API see how life is a
node and see if this stuff we're
proposing for harmony actually makes
sense and how
reduce function nests and improve
usability they will never be threading
in JavaScript with shared readable state
yeah so the question is debugging we
have a bunch of Awesome debugging work
that's coming along you can see some of
it in Firefox is nightly builds Jim
Blandy who's based in Portland is doing
this awesome new debug interface which
is in the JavaScript language a debug
object you can use you can write your
debuggers in javascript in HTML and
we're doing that dave camp also based
here is working on the UI for that it's
a remote debugger should work in node we
have all sorts of features in mind
memory profiling is hot we're working on
that too it's a hard problem some extent
chrome has an advantage that they can
have up to 20 or so rendering processes
they can exit them if they start leaking
and WebKit is not you know immune to
leaks but until we get our process story
done which is going to take a few more
of our fast release cycles we really do
need to dig into memory profiling and
we're doing it we're trying to say where
all your memories going and who's to
blame we're trying to identify add-ons
and web pages even though we don't have
process isolation we don't just want to
blame we want to fix so yeah debugging
tools are a big investment for us right
now and it should translate directly to
note how important do you think is a
binary object passing for workers
especially on the server because
javascript is non-threaded so you have
to have these other solutions like Jason
stringify but it feels really really
sort of bad when you do that especially
when the data gets larger and the
server's who are going to deal with that
so what are your thoughts in relation to
spider note well so this is kind of two
questions one is what node wants to do
for clusters of processes that are
single threaded node servers that
communicate share nothing no mutable
state got a serialized somehow the other
thing is structured clone is coming
along in the browsers and it currently
works through serialization and
deserialization as well but with the new
es5 ability to freeze objects and other
ways of deeply freezing object graphs in
theory if you have
kind of shared address space for
multiple isolated threads you can still
pass efficiently these frozen objects
back and forth you don't need to
serialize them just pass the pointer
it's safe there's no way that they can
form a path to mutable state that's
coming in in on the client side i would
say in firefox at least something we're
looking at but i have to say the
serialization overhead is not the
bottleneck it's not on the critical path
at least not in our experience with
workers so when you when you created the
v8 api on tied on top of spider monkey
were there any you know in the
translation to the other ABI is anything
lost if you don't have to make any
learning design considerations those are
closer Mormons or otherwise translating
like wrapping job of the spider monkey
API into the v8 APA did you guys get
that you repeat the beginning of that
like what did you up did you have to
compromise on anything because of your
trying to shoehorn into vatapi it api
mismatch any impedance mismatches yes
but alright so one of the API impedance
mismatches we have is a v8 has an API
called set index properties to external
array that you can call on any object
that's kind of a strange API it's closer
oh sorry even closer okay soviet has
this api on object called set index
properties to external array which
sounds kind of strange and scary that
you can take any object and instantly
change all its properties and we can't
implement that in jsapi there's just no
mechanism to do that so we actually had
to rewrite all the call sites so this we
had to rewrite node buffer entirely in
order to make it work with typed arrays
because we couldn't manage this one
aspect of the API that's only a drill
down on so we have WebGL typed arrays
built in the spider monkey buffer is
close but not quite and so we had to
kind of change things a little bit but
we'd like to talk we don't know what the
right answer is it could be our fault
but maybe there's a better buffer in the
future so we're looking to collaborate
with Ryan and everybody on that okay my
question is what's the memory footprint
an empty spider notes over when it
starts oh we oh we leak in memory stone
yeah we're still leaking memory we
hadn't started looking at this until
like last night um and we finally got
the logging who set up so we can track
this stuff so we serve some leaks but
we're just hurting like that now so it's
not great but it's getting better every
day how much he member you do you
allocate when you thought up in so so no
chat when it starts is running it with
about 11 or 12 Meg's so I don't know
what that runs on v8 offhand but similar
amazing yeah we believe in releasing
early and often so we're not we're not
bragging about any benchmarks remember
we profile results but we're going to
keep you posted can you do anything with
the serializing large strings out to a
socket so an issue in v8 is the strings
are starting it's really clever and
memory representation and you want to
convert them into to put them out to a
system call or write them out to a
socket but you don't have a contiguous
like flattened buffer labeled system
call tanks so this is kind of
problematic in the v8 world because of
the the clever garbage collection so is
there is the spider monkey API
offer an easier way to get those out
because that could actually be a pretty
big win the question was about strings
and do we have a better way to get flat
strings out the system calls without too
much overhead again I'm not going to
brag I think we do all the engines have
tuned their maximum stirring life to
about the same to the 28 I think limit
which is you know a lot 256 megs but all
of them because of SunSpider are doing
these stupid you know you have nation
trees or dependent string tricks to make
a stupid loop that goes plus equal on a
string and grows it by powers of two
really fast that doesn't really happen a
lot in real code but when you get these
big dependent string trees or ropes as
we call them and I think v8 and all the
others have similar things then it can
be expensive to go flatten that out and
depending on your garbage collector
there can be stricter limits on how big
I don't know what the issue you're
talking about is with v8 so I can't
really compare but we we make flat
strings pretty eagerly and we can make
him up to 22 to 28 David I didn't quite
catch when you were jumping through all
the yield stuff is there some more
information about that can you'll be
used from anywhere or only from inside
of iterated type functions or it's
exactly like Python except for the
syntax it's and there's no generator
exit object you yield from a function
and there may be some extra syntax ahead
of the function that makes it a
generator which is a factory for
iterators that can be done next it or
not sent values so there's a separate
proposal from Peter helm of Google to do
in a weight that works at any level I
think it's certainly a top level that's
a different animal kind of complementary
okay great thanks same underlying
infrastructure needed for both I guess I
have one question which it gets you and
Bill to hear you mentioned that
SunSpider and other things aren't really
good for server workloads are you
working on something that is
you tell us you guys are doing the node
you know server app development we need
to build better benchmark suites and
measure all the time it's really
important that's why we're investing in
debugging tools not just memory
profilers but you know cycle profilers
for both javascript and your native code
you know I think shark or whatever
instruments is the new hotness from
Apple but we need to get into the
JavaScript more and we need to see where
the costs are so we optimize our silly
JavaScript engines for the real
workloads not for these synthetic
benchmarks from 1998 so help us out
start a new benchmark collection what
what the build process look like for
spider node is it is it as simple one of
the nice things about notice is just
basically make make install on on unix
platforms is that um direction you're
heading with spider node spider no it's
just a clone we're working in if we can
collaboratively get whatever changes we
need up into node will do it if we can
push the change burden down onto v8
monkey will do that first we don't want
to change note if we don't have to we
don't we're not making of work I mean
github is about forking right the fork
button it's all good don't worry it's
not like Jamie forking emacs on stall
minutes it's not a big war but but we
really do aspire to be an alternative
under the VN API in though i guess the
intent of my question was is spider
monkey becoming easier to build as far
as i know i've had trouble just getting
it to even build outside of the firefox
on OS 10 and stuff is that is that
improving a spider monkey improves I see
I didn't hear a question right and I
still haven't quite heard but you guys
handle this use like are you asking
about the other week uh make make
install in spider note well yeah like
how bout is it's actually compile it on
my own machine so our fork right now is
just configure and make and that's it
but we have made small changes like the
default
we built in flags for choosing your
JavaScript engine v8 or spider monkey
and we've changed the default for now
because it makes it easier for us okay
not not a whole bunch of configure flags
every time we're building but it's it's
easy I guess hey I guess maybe this
might be sort of what was being asked
and got getting out with these questions
is like is it configuring and building a
spider monkey in tree as well and like
static linking like like v8 at all or is
it like I have to have installed
developer spider motive in yeah it's
it's you know autocom two and three
configure make cool oh well well on Mac
I do thank you very much that's the end
of the Q&amp;amp;A session</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>