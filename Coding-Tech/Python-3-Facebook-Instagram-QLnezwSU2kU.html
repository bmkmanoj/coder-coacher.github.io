<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Python 3 @ Facebook &amp; Instagram | Coder Coacher - Coaching Coders</title><meta content="Python 3 @ Facebook &amp; Instagram - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Coding-Tech/">Coding Tech</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Python 3 @ Facebook &amp; Instagram</b></h2><h5 class="post__date">2018-02-10</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/QLnezwSU2kU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">my name is Jason freed I'm production
engineer here at Facebook I've been here
since October 2011 on Halloween even I
told myself Python because it was the
more socially acceptable language at
Facebook then Perl
it took about a year until I was really
confident of as a new Python programmer
to start taking an active role in the
community of Facebook so I got started
by by helping people out in the internal
Python group being kind of first to
answer questions cuz I guess didn't have
a lot of time as a new hire or I had a
lot of times new hire accountant came
internally famous in Python circles and
when I saw an issue that we were just
doing something wrong I just stepped in
and I fixed it
it didn't it's not like I owned I just
did it so over time people started to
accept my expertise this is mostly how
Facebook works it's not top-down
there's no decrees it's it's kind of a
meritocracy of ideas you have to sway
public opinion by you know the merit of
your ideas or you kind of try to cash in
some of your social capital from helping
people to convince them that your ideas
have merit so here's a little timeline
of our change for getting to Python 3
so changing something this big at a
company as large as Facebook takes time
so let me tell you a story about during
our free time and with no authority
whatsoever
we made Python 3 the default version for
Python at Facebook in 2013 at the same
time we were getting access to Python
2.7 we got access to Python 3 3 which is
a lot different than what python 3 is
today but it was part of a task to add
Python 3 to our build system well that
task had been stalled since late 2012 it
was blocking on adding Python 3 to our
internal libraries which can be added
unless we can build them it's kind of a
weird circular problem so this didn't
really get us much it was like you would
just install Python 3 on your laptop it
doesn't mean I can run it across the
servers at Facebook so sure we had it it
was there but nobody nothing supported
it yet you couldn't use it was very
theoretical so it also didn't help that
the popular opinion of Python 3 at
Facebook during 2013 was
really negative most people the company
were either planning on like staying and
Python to forever kind of mentality
always be in Python g7 forever and some
people were just we're talking about
jumping to another language altogether
and I even you know I said something
along these lines internally once in my
defense it looked pretty helpless in
2013 that we would ever be able to run
Python 3 in production well you know at
the time only one person this was 2013
only one person called me out of my
statement said why don't you do
something about it because I was just
complaining you know so it wasn't all
bad you know we had some rays of hope we
had this thing so somebody decided you
know they foresaw that that that Python
3 was coming down the road and they were
like how can I make my Python to 7 code
live longer like I gotta make it like
last longer so they decided we would set
up this like Python this linter that
would require that you use the four
infamous imports it was an attempted yet
basic stand there the code of our life
the future imports are now pretty much
used everywhere at Facebook and unless
your Python 3 only code but that's more
modern and we it means that we really
had to solve a lot of our Unicode issues
like in the first talk we we solved them
in 2013 because we've forced people to
use these things and they had to solve
them and we sure we introduced new ones
because people are writing Python 2 code
that accepts strings or unicode and they
sometimes use bass string and I
sometimes use business as testing to
figure out what kind of weird behavior
have and we had to fix those again in
Python 3 but they were easier because we
made the jump sooner so yeah these
imports would make it easier to convert
most of those modules of Python 3 which
also leads to one of our other big
problems was thrift so thrift thrift is
a RPC framework and serialization across
system it's used extensively at Facebook
and it allows services to talk to each
other we use it everywhere
it's that core dependency that if we
didn't have it
it would never we would never be able to
do Python 3 and so in October 2013 the
thrift team put up this poll internally
we're like hey we're looking for things
to work on as
team what should we do and it was an
open poll so him Becca dad someone added
Python three support I don't know who
you can't really tell these things but
it was strangely was very popular I
voted for it because I thought hey if we
could have to add Python three support
that means we get to clean out all the
old crop it would be a great thing for
threat because I was hated it and but I
still wasn't on board yet for Python
three until I went to a talk that Guido
was giving and it was at October 16th
2013 this was at Yelp in San Francisco
and he was talking about a thing called
tulip well tulip would later become a
sink i/o and I was already a big fan of
a sink in Python too but I was really
dejected about the the different types
of frameworks and they weren't
compatible so but async i/o and my head
opened up this magical future where we
would have a single unified framework
where I is a library owner wouldn't have
to make a religious decision about what
facing framework are you use personally
I just wrote the library and you use it
so before this talk was over I was
already messaging you know Facebook
we're already messaging the thrift team
be like hey there's this thing called
tulip and we need to support it in
thrift for Python 3 it wasn't even you
know into it like barely even out yet
it's not even in pipey I at that point
so I was like we should do that instead
of waiting for G event or twist it to
support Python 3 because if we had
waited we would have to implement last
year so and they as a thrift team I kind
of convinced them is like if you support
this this is the only framework you have
to support it reduces their because they
were supporting both twisted ng event
and tornado and some other things and
after Guido's talk I was really pumped
about the future of Python 3 and a
couple days layers on the 19th the
thrift team put up a road map and when
it included in their road map for the
next year Python 3 support and Tulip
support so that was my big win and I was
sold when python 3 at that point so back
to our timeline change in 2013 we really
had a we didn't know have any rough
plans it was we only had rough plans it
was like Python 3 wasn't gonna happen
most people didn't think it was gonna
happen and by happenstance we've kind of
set ourselves up for a win
so if I wanted to l'p to be a thing at
Facebook and by extension Python 3 I
would have to be sure that Python 3 was
easy to use or at least possible to use
so I kind of ate at the thrift team with
their code reviews and help import some
stuff and by February 3rd of the the new
hire that was working with his team he
was able to ship their support for
Python 3 and then later he landed
rudimentary Tulip support it was so new
we kind of just did our best
so but for six months the support just
kind of sat there we had build up this
infrastructure but nobody was using it
was kind of like these cities in China
where they they explode of urbanization
and growth and economics that but they
were left to ban it because they don't
have the people to fill them yet or they
don't want to move there so I don't
think we had a plan yet but we were
hoping someday somebody might use it and
that was all about to change
in August of 2014 I had started a
project to rewrite a service that I had
unfortunately become the owner of and I
was going to rewrite it completely from
the ground up using modern
infrastructure and modern best practices
see I wanted the service to last room
and he used to come and I wanted to be
free of all the crushing technical debt
that had that had strangled its
predecessor and I was going to write it
in Python 2 7 and G event weight so I
was already a bully I was actually
technically a believer in this future
Python 3 maybe deep down somewhere but I
hadn't maybe actual eyes yes it was like
if I don't even if I wanted if I was
gonna write my service in Python 2 7 it
was gonna be obsolete from day one that
one day somebody would have to do the
work to undo that technical debt to move
to Python 3 so you know it's the thing
is that change won't happen on its own
somebody has to be the first person and
that person should be you so for face
book in Python 3 that person was gonna
be me and in the words of Gandhi be the
change you want to see so if I wanted
Python 3 to be a thing at face book I
would have to be that change
so I started writing my project in
Python 3 oh and everything was broken as
you can imagine no wonder nobody is
using Python 3 at Facebook it was like I
wrote a bill config for an entry point
and it wouldn't even build like the
build system was treating Python 3 like
it was Python to aid and disguise it
dependency trees refused to resolve
because all the wheel dependencies were
built for Python 2 so it and you know in
that thrift support that we landed six
months before over the last six months
people had made fixes that were Python 2
only and we basically broken we had a
ton of regressions that broke all that
support and swig and boost wrappers that
people had written in the past and are
still and were fundamentally broken in
Python 3 in regards to handling binary
data when I resolved enough of these
issues to get my project to finally
compile then its stack traced
immediately when I ran it it turned out
it wasn't even my code it was the
machinery that we used to make our entry
points work and be sane so well I wrote
my project I was really having to fix
the world around me or at least the much
of the world I needed to work for Python
3
I had to rebuild a ton of third-party
wheels so in our build system and every
time I needed an internal library
somebody in the company had used I had
to convert it to be 2/3 myself and I had
this problem every day somebody would
check in when I wasn't looking they
would check in a change to their library
which you know why would they do such
thing and it would break Python 3
because they didn't know and or they
would upgrade one of these third-party
wheels we have and it would blow away my
Python 3 version it would just put a
Python 2 in its place so that's because
the build system defaulted to only
building for Python 2 I found that most
disease most of these regressions were
actually while they were valid Python 2
code they were syntax errors or name
errors in Python 3 that could be easily
caught by things like linters so I had
to I had to kind of force some
compliance now I said before that
Facebook is not the organization that
you can from top down
all over technology and so you after do
it this way but change is synced
sometimes come from the bottom up and
our hats come with a bow so well us
engineers sometimes we can force
compliance by being a little sneaky
so I quickly learned that if you if you
act with authority people will assume
you have it and I think I used up a good
portion of my social capital in 2014 and
relied on my kind of perceived status as
a suite for software or the subject
matter expert for Python to to just kind
of let people look the other way in late
August of 2014 I instituted automatic PI
flakes linter that would run on all new
code when it was submitted for review pi
flakes was good at the time because it
was it had a lot of it didn't have that
many false positives and I could sell it
as a way to improve our code quality
since we were already running app f8
linter and the for imports linter I made
sure that the the PI flakes linter ran
once under Python 2 and then once under
Python 3 so that people not writing
Python 3 code were required by the
linter to not commit new obvious errors
so in effect I was forcing them to write
Python 3 compliant code or sort of but
this allowed me to distribute the job of
maintaining Python 3 supports so I could
focus on finishing my project so linting
is not a perfect science you really need
unit tests so for those libraries I was
using that I had to do all the work to
get 4 pi 2 &amp;amp; 3 I just went and changed
their unit test to run in Python 3 and
in run Python 2 kind of like I did with
the linters and so maintainer x' would
know immediately if they were changing
their libraries that they breaking
compatibility somebody was a school
assuming I found that unit test was a
way easier way to force compliance than
then issuing a task after the fact say
hey you broke me there could you fix it
there's more like if I put a linter in
there they would just not break me -
again with and it was more easy to keep
people to be compliant or it wasn't
always easy to make them to be compliant
so I had to be responsive to people's
cries for help
at first I spent a lot of
I'm the diff view comment sections of a
lot of diff pointing out the Python 3
lint errors and telling people
explaining why the name error unicode is
not a defined why that's not a false
positive and you know it legitimate
litera so and i had to kind of explain
why they should care like us for the
future you know this code might run in
Python three one day and it was always
one day so but look the thing basically
is if we had to also I had to try to
make it easier because if supporting
Python three seemed hard to the
developers they would give up they throw
their hands in the air and I would say
just we can be on Python 2 forever it's
just too hard too hard too hard so I end
up making a I end up making the taking
the third-party module six and future
which'll I to write really easy Python
three in to polyglot code and I I did a
trick of the build system to make them
automatically just populate on
everybody's dependency trees so that
they would just be there so when I when
I came into a comment section on their
diff I could say hey do it this way and
they're like aw little had their module
like yes you do
and and they would they would they would
import six it would be there they'd have
changed their buildconfig at all and it
was just there so it made it easier for
them to be compliant I also went and
fixed that that third-party wheel
building systems so that the buildconfig
templates were not just defaulting to
Python to only that they would actually
do two and three that remover very
time-consuming process having to go back
in time and basically rebuild those
things that people had built to be
Python to Python three support so with a
lot of those things in place we were no
longer losing ground in Python three but
we weren't really gaining any ground I
joined a teaching rotation in 2014 for a
new higher class called Python at
Facebook it was started by Mojang it
informed new engineers of the realities
of Python and Facebook and prepared them
for the gotchas that might stand in
their way
because of the linters of the class
already instructed engineers that they
were expected to write two three
compatible code because the one day in
the distant future we might switch
unlikely as it was at the time but we
told them this
well writing two three code and only
ever testing it and running it
Python 2 is not enough to advance Python
3 at Facebook we wanted to get to a
future where people wrote Python 3 for
new code and only wrote to three code
was supporting legacy system so in 2015
I took the matter into my own hands and
I made it change the class sides it
informed one of the one of the other
teacher I think was just one person at
the time the class the the class now
said that all new code at Facebook
should be written in Python 3 and that
you should never write Python 2 code
unless it is a legacy project and even
then it should be 2/3 code because that
either that project dies or one day it
will we have to convert it to Python 3
and we taught them this so that we
taught them to expect things to just
work depends users should just be there
and if that if not file a task complain
about it loudly or fix it themselves and
that's what happened so I had this thing
educate for the future you want not the
present you have I started using this
statement to justify the new higher
class to become this like propaganda to
drive change he'll most of the core
dependencies are already worked it
wasn't that much of a lie and they were
mostly converted in 2014 so everything
should have worked all I really needed
was the people to use Python 3 to keep
its support from regressing and January
2015 I ship I finally shipped my project
it was the first Python 3 project of
Facebook I spent most of the year in
2015 selling that as the new blessed
better alternative the original service
it worked out it won its it's currently
running in service it's very successful
but and by this point a lot of allies
had had kind of come out of the woodwork
and been known as being supported by the
three including our very own Mukesh
longa who's a core developer for Python
or C Python and he joined the company in
2013 and I didn't even know he was here
until 2015 and so together with a few
others we we're really able to push the
bar in 2015 and a strange thing really
like was it was about to happen
Lukasz had somehow convinced instagram
to move to Python 3 and so in 2016 he
and I formed a brain
new team dedicated to shepherding Python
at Facebook before we didn't have a team
it was just individuals you know and we
didn't that's where we did most of the
work was just individuals 3 time now
there was there was only two of us but
because we had the name I had a little a
lot of validity to our efforts our
primary mission was supporting Instagram
and there moved to Python 3 and we saw a
slow but steady growth of Python 3 usage
at Facebook internal discussions were
commonly about Python 3 and every day
we'd hear about some new project how
they had chosen Python 3 for the new
code it was obviously the tide of public
opinion had shifted and Python it was
reuse was growing even though it wasn't
the default version of the build system
for projects you you had to go a kind of
out of your way to configure Python 3
and most people just didn't remember to
do so we even used to say that Python 2
will probably always be the default
version well not anymore
in 2016 I may 2nd or 2016 I made a post
expressing my intention
you never say I'm doing this you say I'm
thinking of doing this and if nobody
complains you do it so I'm making Python
3 the default version of the build
system one of the arguments was that
using a legacy version of Python I'd
like to say these things like this for
new projects was a waste of company
money since any project starting with
Python 2 will at some point be upgraded
to Python 3 so why not save the
technical debt and use modern Python to
begin with the post received unanimous
support there were no complaints
nobody said no we should do this by May
5th so three days later I hadn't modded
all the existing Python to build configs
and indicated they needed to be using a
legacy legacy version of Python when
they built and made Python through the
default at Facebook with the millions of
lines of Python code and the thousands
of PARs
I didn't really break anything nobody
seemed to really notice it just was the
next logical thing to do sure there were
a couple people that didn't rebase you
know just right and they had a weird
thing when they finally got the latest
but other than that it wasn't there was
no like oh my god this is horrible in
2016 we've also formed what called the
shadowy Council of for Python domination
this chat group was kind of made of all
the allies throughout the company that
had that were right directly active in
Python and we used this group to kind of
keep ahead of of any compatibility
issues too
Russians and directions of the language
of Facebook and keep abreast of 82
centers to our plan see you can't do
this thing like this alone you you
really need allies in the fight now they
were there were only about 10 people
total that really made all this happen
and they came in win at various times we
really only had three people at any one
time collaborating on driving Python
three adoption now the future of Python
at Facebook is bright as ever in 2017 we
are finally in that glorious future
where we can have nice things again and
in q1 of this year Instagram finished
their migration to Python 3 and now they
are free to start making use of new
technologies they can use they sync i/o
and we can it's now and now we can focus
on things like you pet for it for typing
and migrating more services to make use
of async i/o and make Python this year
it was we started a project to to
replace the thrift stack that complained
about earlier with a new one that wraps
C++ asynchronously and it's immutable
for data structures it's it's really
awesome now we were able to upgrade
Python 3 versions without a lot of
fanfare and it's like it's no longer
this dark day oh god they're updating
Python 3 I'm not gonna go in that day
it's it's now it's like a Christmas it's
like oh look at these goodies we have we
updated to Python 3 6 3 this is awesome
what do we have now oh we've got these
special types and we have all these
special things with a sick guy oh it's a
wonderful world so Python at Facebook is
fun again and yeah it's so the problem
that we have now actually is that
services and library owners are
internally are asking the question can
we drop python to support and we are
seeing a lot of Python 3 only
regressions in Python 2 code so the
problems I had before it's kind of like
happening against those folks we're like
well you need to make your test run in
Python 2 if you want to maintain that
support but so here's kind of a graft of
how we're growing in our
support we started out in q3 of 2014 we
had for Python entry points one was the
pi3 flake glint er that I wrote and the
other three were from my project so this
for that was me ah this didn't change
enough for almost a year into q2 and
2015 when a fifth entry came along that
was Lukasz had written Python three
service and sadly we I didn't maintain
statistics after for about a year and
then two days after I switched the
default Python which I have a little a
little marker there where I switched it
Cooper Lee's put out or host put out a
an automatic stats gather so we can
actually every day several times day
we'd run and we'd actually go out to the
codebase and say how many entry points
are there and what versions of Python
and they configured for so we actually
have some really some really nice data
it was surprised to find out that there
was like three days later when we ran it
we had 4% of Python entry points were
already Python 3 so we have a lot of
entry points so just listening to that
and we they were not the default but we
already had 4% and today we're we're at
40% of all entry points and the green
line here that's where I didn't have any
data so I just kind of extrapolated
because I wasn't gonna spend the time to
actually like step through the mercurial
repository day by day and do the math so
she's made it a green line so you know
that was that's why you should have
afforded to have stats so I'm really
plain that this is a success that it's
now Facebook it's kind of an
embarrassment if you say that your
project is Python 2 only and you have no
plans to move to Python 3 most you were
like oh no we have plants it's on the
roadmap it's on the roadmap because they
feel guilty you know it was like Oh a
lot of them they want the shiny new toys
that we have they want to use that in
their old projects they want to have
they want to play with them too and they
want to get to Python 3 they're just you
know they're putting it off for some
whatever reasons and they're in the
minority now so this review if you build
it they will come
don't just say that we should move to
Python 3 make it a possibility I'll
change his to start with somebody it
should be you pick Python 3 first for
your project don't do alone you're going
to need help
linters and unit tests can kind of force
people to help you but find your allies
and recruit them
you're cause if you're not currently
educating your new hires start and train
them for what you want then had to be
well currently is it's what you want to
get to and collect statistics definitely
that that's a game-changer because when
we started putting up we put up a
dashboard where you could see the
percentage of Python 3 per like team in
Facebook it kind of added a gamification
and people are like I want to get our
our percentage is like 80 and you're
like they would come over like we have a
hundred percent in our directory and our
in the code is is our percent Python 3
and it you know I guess you know showing
around like it was a golf score or
something but and finally write some
awesome stuff in Python 3 because the
awesome stuff that attracts even more
people to want to convert like oh they
have all the cool toys in Python 3 can
we convert they're like I know we looked
at a couple years ago it seemed hopeless
maybe we can do it now questions</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>