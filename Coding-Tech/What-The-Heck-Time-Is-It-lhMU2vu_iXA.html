<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>What The Heck Time Is It?!? | Coder Coacher - Coaching Coders</title><meta content="What The Heck Time Is It?!? - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Coding-Tech/">Coding Tech</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>What The Heck Time Is It?!?</b></h2><h5 class="post__date">2018-03-11</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/lhMU2vu_iXA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello everyone my name is Joel Potter
shman I'll be talking about what the
heck time is it how NTP does the
impossible and why I care very briefly
about me
Joel Potter shman there's my email
Twitter github Facebook it's all the
same I design and build systems and
api's if it shows up in a browser I
probably didn't do it I'm not a systems
engineer I just like NTP and I submitted
to talk and things got out of hand who
has two thumbs and is available for work
this guy so talk to me afterwards and I
like to thank bang make on thank
meerabhai for doing the stenography you
should come talk to her afterwards it's
really really cool technology and she's
really cool and interesting so what is
NTP NTP stands for network time protocol
it was created by David Mills back in
1981 and simply it sets a clock to match
another clock my computer would like to
know what time it is there's a clock up
on the internet that's connected to an
atomic clock it's the way that clock
tells my clock what time it is and
gracefully adjust me to match it that's
all it is and it's been around since
1981 is version zero I'm calling it but
basically there was a formal spec in
1988 1989 they added some authentication
because you didn't want people
impersonating @dp servers and doing bad
things
1992 is really modern NTP which adds
formal correctness principles revised
algorithms more modes at mainly higher
precision on faster networks and if you
think about you know 1992 of the
advances they'd had in network speed
since 1981 still a long time ago but
what's amazing to me about NTP is that
it's worked the same way fundamentally
since 1981 1994 is version 4 it's dotted
because it's still a proposed standard
it's not we're not there just yet I
don't think you want to rush into these
things 23 years is good but let's let's
let's just think it through you might be
saying that sounds kind of boring which
would be a mean thing to say but but if
so sorry I'll be done soon but I would
respectfully disagree I think it's
really important if you think about
about NTP or you think about a clock if
I'm sitting at home in my computer and
I'm writing a document in Microsoft Word
and I print it and hand it to someone no
one cares if my clock is
by two years but as soon as you get
online as soon as we're talking to each
other as soon as you have distributed
systems it becomes really important to
have some common reality about what time
it is
and it can't be done perfectly let's say
I connect to an atomic clock that is
exactly right to a billionth of a second
it takes some amount of time for that
response to get back to me so I can't
ever really know what time it is I can
only know what time it was and I'm sort
of fascinating to me that you can't do
the thing that this does and it has to
be done carefully it has been carefully
because if you run your clock in Reverse
as I'll show some bad things can happen
so for all those reasons it's super
important you can't actually do it right
and you can cause terrible problems if
you do it wrong it's pretty interesting
thing to me so why is it important let's
dive into that the classic example is
going to be like a bank transfer I
deposit some money into my account at 12
o'clock and then some naive Network time
synching protocol that's not as smart as
NTP says that gesture clock backed by a
tenth of a second which it does and then
I would throw $100 in on those on that
slide things happen in the correct order
linearly but if you look at the
timestamp oh I would drew before I
deposited and depending on the
implementation of the banking software
if it processes it in time stamp order
I'm gonna be overdrawn so that's bad
another reason why it's important is
leap seconds I don't want to alarm
anyone but the earth is slowing down and
it doesn't take 24 hours to rotate it
takes very slightly less night so every
now and then they have to add a leap
second to keep us in sync with our
motion in space and NTP is how that is
done with NTP it tells everybody you've
got you've got to add a second today SSL
Certificates if it's revoked at a
particular date and you can have an NTP
server force everyone to believe its
prior to that revocation date you can
have a whole class of attacks their iOS
had a bug in a previous version where if
you set your clock to 1970 you could
brick your phone so imagine if an NTP
server was able to convince a hundred
million iPhones was 1970 how much
destruction you could wreak and lastly
sometimes it's really important to agree
on the order in which things happen
so I'm gonna speed up a little because
I'm behind on time but NTP and 64
seconds not that isn't a joke that's
just me so how does NTP work ask someone
with a good watch what time it is what
is a good watch a good watch is going to
be an atomic clock that's considered a
stratum zero NTP server but you can't
talk to a stratum zero server you're not
allowed to you could talk to a stratum
one server which synchronizes to that or
a stratum to which synchronizes a
stratum 1 and so on up to Scott and 15
so try to get in touch with the best
clock you can typically you're gonna be
talking to an NTP one ivi stratum 1 or 2
server find out how long it took them to
answer they tell you this is the time
figure out that latency and then you
have to calculate how much to offset by
that then decide if you believe them if
they told you it was 1776 or 1 million
BC you probably don't want to set your
clock to match that but if you do
believe them you want to adjust your
clock safely and what is safely mean
safely means don't run in Reverse
sometimes you have to but you try to
avoid that and then you repeat that
every 64 seconds that's the default time
on a Mac and probably on Windows its
powers of two every 64 seconds forever
you synchronize to check to see how much
time check to see if you are drifting
and you can do very gentle Corrections
that way so let's go into a little more
depth here's an NTP client my computer
and NTP server up on the Internet so at
9:15 I don't know if you could see that
but at 9:15 on the dot I make a request
to the NTP server and the NTP server
says I've received that at 9:15 and for
one hundredth of a second and remember
my clock may be wrong these may not be
the same time I may be off by three
years but it says 9:15 and for one
hundred to the second it sends a
response
assuming a response back to one
hundredths of a second later and then I
mark the response there so what do we
know what we know is that destination
timestamp according to my clock - the
origination timestamp might on my clock
is the round-trip latency and it doesn't
even matter what the NTP server latency
really is so by by by doing that we have
to round trip latency cut that in half
and we estimate the one-way latency and
the asterisk represents we can't really
deal with asymmetry in latency late NTP
doesn't deal with that no one really
deals that you just hope that you hope
for the best and if you have a low
latency connection the max
errors not that big anyway so from this
if I take the NTP authoritative
timestamp of nine fifteen and six one
hundreds of a second plus 5/100 of a
second latency tells me right now it's
915 and eleven one hundredths of a
second but look I said it's ten one
hundredth of a second I'm behind by 0.01
second so now we have to correct that
how do we fix it you fix it by slowing
your clock which is varying your clock
speed but staying positive if you're on
the highway and you're separated from
your friends in the other car you might
step on the gas a little harder you
might lay off of it you would not go in
Reverse it is not recommended so this
exists graph shows you that so blue line
represents a perfectly accurate clock
that is exactly in time with reality the
purple line represents my clock is
running a little bit fast so what
slewing is gonna do is say let's just
slow the clock down a little bit until
the blue line catches up and then we're
good the green line similarly my clock
is too slow speed my clock up a little
bit until we catch up now we're back in
back in sync with reality but there are
limits of slowing and the limits are
because NTP is really designed for clock
maintenance not the initial setting if I
buy a brand new computer and I plug it
in it has no idea what time it is and if
it was off by by a lot it's gonna take
decades to catch up because the limit of
slewing is 500 parts per million the
design is to have really small changes
from reality so you don't have weird
crazy transactions happening so if it's
off by more than 120 milliseconds it
just jumps to the correct time even if
it has to go in Reverse
the thinking is this is an initial step
it's better to do that than have your
clock be off for 40 minutes or two weeks
or three years and if you're off by more
than a thousand seconds NTP just says no
you can override that manually that
would be for that initial when I just
plug in my computer last step is don't
eat garbage this is a good rule of thumb
in general but NTP remember it was from
1981 the premise that in 1981 you'd have
reliable Hardware reliable network and
reliable everything would be insane they
knew this was going to happen so NTB
says hit multiple servers multiple times
favor of the responses with the lowest
latency z' and discard statistical
outliers so if one of the servers or one
of the responses says it's a million ad
you probably don't want to go with that
one on average takes about five minutes
to trust a server you could say a single
Russ
bomb squad the whole server could be bad
and TV expects those failures and
there's all kinds of reasons they could
have that could be malice it could be
that it's hot in the server room that
will affect the time and then NTP and
there's no way to do this in ten minutes
but it performs statistical analysis to
filter what's called the true timers
which are the NTP responses and servers
that it trusts from the false tickers
and I don't know why they didn't go with
true tickers and false checkers but
whatever that's they can take that up
with David Mills so my made-up graph
here shows you know in my impression of
what's happening there where you
basically have you perform your
statistical analysis as a clock filter
algorithm I had the vector scatter gram
wedge scatter gram which it couldn't fit
in there but basically you say these
results I trust these the ones I'm going
to use and these are going to discard so
in conclusion you can account for
latency well enough but not not
perfectly but well enough and that's
that is sufficient math protects you
from bad responses if you are on guard
against terrible things being told to
you on the internet also a good rule in
general you can protect yourself from
that don't drive in Reverse unless you
really have to and you can see NTP on
your own computer and I have Julia Evans
to thank for this bullet because of her
team showing all the cool tools I'm like
wait I wonder if I could look at TCP and
you can do this so pseudo TCP dump - V V
port one two three and you can watch
your computer every 64 seconds make
these tiny little adjustments and
remember who's available to help you
ship products this guy
thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>