<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Building a JavaScript Powered, Smart AQUARIUM | Coder Coacher - Coaching Coders</title><meta content="Building a JavaScript Powered, Smart AQUARIUM - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Coding-Tech/">Coding Tech</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Building a JavaScript Powered, Smart AQUARIUM</b></h2><h5 class="post__date">2018-01-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/5iWi8r7o7NE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so yeah my name is Bryan Hughes I go by
an every us on Twitter github and
basically everywhere else and I am a
developer evangelist here Microsoft so
welcome to my office
everyone so this one I'm going to talk
about building a JavaScript powered
aquarium so I have this aquarium at home
I've had it for quite a while before
this aquarium I had another one that was
very very similar and it's a great
aquarium you can see my fish in there
they're super happy
so in this aquarium it has a day and
nighttime lighting system it has
basically like really bright white LEDs
for daytime and like dim blue LEDs for
night time which is awesome you know the
fish love it and things like that but
there is one problem with it it's that
to control it we have these capacitive
buttons right here and so like it works
of course it works totally fine but the
problem is in order to change line I
have to get up and physically press a
button this sucks because well first of
all I'm not a morning person I don't
want to get up in the morning and turn
lights on but also you know I evangelist
I travel pretty frequently I'm not
always there to do this this is
something we want to automate
historically like in the days of
fluorescent LEDs it was just on-off
intellectual outlet so you put like an
electrical timer on it works fine can't
do that with this so because how do you
switch between the lights so I was like
I gotta automate this I got to fix this
in some ways and so I did exactly that
what the rest were hi this is actually a
pretty old project I first started
working on this project as you can see
from my first commit way back in 2013
this is one of my oldest open-source
projects I've ever worked on and like
this actually opened up a lot of doors
for me in fact like I started working on
this before I even knew that node bots
was a thing but I wrote this in
JavaScript and that actually led me to
becoming a contributor on the
johnny-five project which is a robotics
framework for nodejs if you're not
familiar with it like I maintain the
Raspberry Pi support for that project
and so like this one along well was
doing pretty well up but then like said
I wrote Raspberry Pi support for Johnny
5 so about two years later I rewrote a
good chunk of the project to use that
and it's gone along a string pretty well
but it starts like falling behind
there's
parts have stopped working after a while
it was running like no 0.10 in 2017
which is not a good thing so I was like
alright I gotta just rewrite this entire
thing and also I work at Microsoft so I
had like free access to admin we got a
bunch of IOT stuff so I was like I want
to play with the all these toys that I
have now in my disposal and so I did
just that and rewrote the entire thing
to make it connected to the cloud and so
the new system has this basic system
architecture to it there are more or
less three separate components there is
the controller which is the Raspberry Pi
itself then there's the server which is
a collection of various pieces doing
things in the cloud and then there's the
clients a web browser I wanted to set
this up so that I could actually control
and configure my aquarium from anywhere
using the web and so it's like divided
into these three sections and it's
actually running in production and so
first I'm going to show you kind of what
this looks like in the end here we can
see the aquarium once again I have a
tablet sitting in front of it actually
this tablet right here and it's set up
so that it controls the lighting based
on a schedule but then you can also put
in to override mode and change what the
lights are doing which I'm gonna do
exactly here so I go and I put it in
override mode I go from the daytime
lights to the nighttime light so you can
see the blue and then I turn the
nighttime lights off entirely and I have
it go back into program mode so that's
pretty cool and then another thing it
also does is it monsters temperature and
their like stores temperature data it
does analysis and the alerts and stuff
like that all right so the way I
implemented this we'll start by talking
about the controller this right here is
a photo of the actual Raspberry Pi
hardware setup along with a couple of
other things at the bottom left that big
green board that's a raster a PI 3 model
B that is the newest most powerful
version of the Raspberry Pi and
connected to that are two separate
peripherals the other big green blocks
with the white squares that is what's
called a relay module so what a relay
does is it takes a really low power
signal and it will turn on basically a
switch you can think of it like a light
switch except just using our fingers to
turn it on
it'll actually use an electrical one or
zero to turn it off so you can control
it from programming and this is really
great because those LEDs are actually
really high power they're a high voltage
high current you can't connect it
straight to a Raspberry Pi because it'll
actually fry the Raspberry Pi so you put
this device in the middle and that
allows this low power device to control
this really high powered light and then
the other thing is it's kind of hard to
see but there's a red white and black
cable it turns into like a red and
yellow cable in the upper left corner
mm-hmm that's the cable for the
temperature probe and that kind of goes
off into the tank and I also have a fan
to keep it cool just because it's a
Raspberry Pi and in a closed structure
and they need some cooling you don't
want to have no airflow so that's the
hardware and then the software so inside
the rest rate PI the Raspberry Pi is
basically an on-board computer it's a
computer in the size of a credit card so
it runs Linux and on top of that I'm
running nodejs and so on inside of
nodejs I use two key libraries to do
everything with one is raspy Jas which
is the library I wrote that johnny-five
uses to get Raspberry Pi support and the
other is one called IOT hub which I use
for communicating between the Raspberry
Pi and the cloud which I'll talk about
that more in just a minute and then so
on the rest three pi it starts up every
single morning at like you know zero
o'clock you know midnight it will
basically load up the configuration and
then program out the schedule for the
day you'll figure out what is the
sunrise time for today
what is the sunset time for today
because you know we as we know that
changes throughout the year like we
don't have much sunlight right now and
it just schedules that out it sets like
some timeouts and stuff so they'll
actually change the lights and then
everything's written in typescript
because I just really like typescript a
lot all right so next up on the server
the server is broken down into four
separate pieces I'm using Azure SQL
which is just it's a Microsoft SQL
instance but it's in Azure provided you
know the way databases are provided in
the cloud it's all manners for me stuff
like that and then I also have a node.js
app there that does a variety of things
I'll talk about in a minute and then
there's two other services I use in
Azure one is IOT hub which I just
mentioned another one called stream
analytics so IOT hub is
a pretty cool kind of suite that we have
it provides a whole bunch of stuff
geared specifically towards IOT so
simply it handles device management and
provisioning whenever you have an IOT
device usually the first thing and you
want to connect to the cloud you have to
provision it see if you think about an
IOT device you don't have a user
interface you can't put in a username
and password so you still but you still
have to handle authentication you want
to know the device that you're talking
you want to know which device it is and
what it's authorized to access and so we
do that using a mechanism called
provisioning industry general sense and
so this azor IOT hub handles a lot of
that stuff for us and also handles
authentication with messaging and things
like that you know just making sure you
know throughout every single step of
communication that Ashley knows exactly
which device is talking to and that is
indeed authorized to talk to that device
and then finally like I said it provides
messaging itself and that messaging can
be built on top of a couple of different
protocols depending on what you want
what kind of communicating you want to
do I can use mqtt amp q mq or HTTP each
of them has pros and cons and kind of
rate the docs figure out what you want
and pick one and then for all of this we
have Microsoft provides some nodejs
libraries that makes it really easy to
consume and use if you want to see the
code I can definitely show you that
later so that's IOT hub and I also
mentioned stream analytics so I the
device talks to IOT hub directly in an
IOT hub talks to stream analytics so
stream analytics is a runtime event
processing pipeline there's a whole
bunch of variants out there this happens
to be ours it's pretty cool so it's you
know a way of doing event processing so
like very high volume event processing
you know tons and tons of data is
streaming into your server and you want
to like rat it around and maybe do some
analysis stuff like that on it and this
is a run timeless processing pipeline so
there's you don't spin up VMs or
anything like that and it uses a simple
SQL like language so the idea is that
this is you don't even really have to
write very much code at all and with
this we can glue together pretty much
any other azor service so that little
code there that like select stuff into
you from that
all of the code that I wrote to take
data from IOT hub which was just a
message call on the Raspberry Pi and
pump it straight into Azure SQL so I
didn't have to write any no js' or net
Python anything like that to get data
from a Raspberry Pi into a database and
I think that's really cool
yes yeah this is completely real-time so
like the latency from whenever the
raspberry pi and post that message to
the time it's in the database is like
milliseconds and in fact one of the
things we see there's a graph right
there that actually shows the number of
events coming in I only have one device
so there's really not much activity on
up you can see every five minutes it was
pinging when I took the screen shot I
was actually doing some maintenance on
it and like restarting the app above so
that's kind of what that weird stuff is
in there
yeah it's a really cool system that
makes it super easy to do this stuff
like I had this whole pipeline of going
from the REST API to SQL like up and
running in like five minutes kind of
thing but then there's I do still have a
nodejs app running in the server and it
does like a lot of other stuff you know
that sort of thing we saw up in the
corner so this runs inside of an azure
web app service which is the name that
we have for our platform as a service
setup so basically were saying like I
want to run a node app I don't really
care about managing a VM myself or
having to deal with like updates or
updating node and all that kind of good
stuff
and so with web app services it just
does that all for you of course AWS has
you know the same equivalents in there
and so this server does a variety of
different things
the main thing it does is it provides
support for the web app for the browser
app itself that we use to control it so
it serves up those static files as well
as doing a little bit of templating and
then also has a couple of endpoints to
find for this app to kind of go and
fetch data all kinds of data which will
see what the client looks like here in a
minute and it does a couple other things
too it does some meta analysis on this
temperature data so we have this data
that's coming in it's like every five
minutes it's basically saying here's my
alighting state here's my temperature
but that's a lot of data and
it becomes very stale very quickly we
don't really need it so like one stuff
gets to be about a day old this server
will then go in and just sort of like
crunch it all down and get like a high
and low for the day and then once the
data is a month old it kicks it out
entirely and then also it since the
lighting configuration back to Azure IOT
hub there's some ways that you can
actually that IOT hub makes it so you
can configure a device really easily
they have this concept of what they call
device twins I could talk about a lot
more later but it's basically a
configuration for your device that's
super easy to pass around without having
to write a lot of manual code to do it
and so this node server app is one who
actually sits a configuration back to
the device and that configuration those
things like you know running override
mode or you know set the lights to this
you know to find the schedule stuff like
that so I use Express and a pug for my
templating on this and once again it's
written in typescript because I just
really really liked typescript a lot and
so finally we have the client which is a
web app and runs in the browser
obviously and so what this does a couple
of different things so it displays with
the current state of this system is well
the last reported state so you might be
up to about five minutes old or so but
it displays you know what's the current
temperature in the tank what's the
current lighting it'll show like the
next state that's gonna change soon and
stuff like that and also I can like
adjust the schedule if I want and
various things like that so to handle
authentication because you know I don't
want just anyone to log in and start
messing with my aquarium that would not
be fun my fish would hate me I use
Facebook to handle authentication and
then every single which by the way I'm
actually not using JSON web tokens at
all it's just regular session data and
cookies yeah and so once again
Facebook's great it's off the shelf I
can get access to anyone I need to
because they say everyone has a Facebook
account and then this was written using
all the kind of typical stuff I wrote it
using react Redux I used to charge a s
to show some graphs and then typescript
because I love typescript once again and
I use webpack to build everything all
together alright so I'll show you what
that software looks like which alright I
switched
so I'm gonna have to load this up
hopefully I'm still logged into Facebook
cuz that takes a little go perfect it's
right you may reload that okay all right
so this is what the web app looks like
so the upper left corner that's just the
name of the currently logged in person
which is me right now on the right
that's actually the name of the device
itself that is connected to so
hypothetically this could support
controlling multiple aquariums and
multiple users I haven't tested that
because I only have one aquarium but you
know that support should be there we can
see the current state we can see my
apparent is currently in program mode
program mode means is you know look
running on that schedule that was
predefined at the beginning of the day
it's currently in nighttime mode which
you know looking outside that makes
sense that's good I've been worried if
it said something else also it tells me
what time the raspberry pi thinks it is
it's gonna be useful I suppose just in
case the clock gets really off it also
tells me about the next transition so it
says the next time that this is going to
transition is going to be at midnight at
12:00 a.m. PST and sky go from nighttime
mode which is those blue LEDs to
completely off mode which is exactly
what I would expect and then finally it
says the current temperature is twenty
five point two five degrees Celsius
which is pretty typical we can see the
temperature for the day over the entire
day there was this little dip right here
I was taking some photos as we saw
earlier I actually accidentally yanked
the thermometer how did the tank without
realizing it so it sat there for about
half an hour so that's actually the the
air temperature of the room boundary
that's that little dip there what
actually captured it which is cool and
we can see the monthly temperature so we
can see the the temperature on the tank
is actually fluctuated a little bit um
it has a heater in it with a regular so
you would expect to be perfectly smooth
but this shows that it's not a perfect
heater and things like that
you can see that really cold snap around
Christmas actually which is kind of cool
and then finally we go down here and we
can see the schedule so the first thing
that's going to do that first entry
there is that sunrise it's going to set
the lights today
mo
dynamic the type dynamic our manual that
means do we want to base this on a solar
event sunrise sunset or do you want to
just have it occur at an exact time and
so for this one we're saying dynamic
sunrise second one is sunset same thing
we'll set the lights to night mode
dynamic sunset and then last one this is
the one where you know it says it's kind
of turn off at midnight you can see I
actually have a daylight savings time
bug in it it said the next transition is
going to happen midnight but I entered
it as 11 oh well that happens time zones
are a difficult thing but anyway so this
is it and then if you wanted to we can
go through and we can like move things
around we can add new entries we can
delete them and notice I'm not having
the apply button because I don't want to
change the lights on my fish right now
they would not be happy with that and we
can also go into override mode and set
anything you want so this is actually
really useful in a creative sometimes
late at night maybe something's going on
and I need to check it out and turn the
lights on and so yeah that's kind of
what this web app looks like and with
that I can do all kinds of stuff and you
notice that this is going through a
website aquarium controlled at adjure
websites net that's the default domain
that azure gives you I could do custom
domain stuff like that but it means I
can access this anywhere in the world
and I can kind of see what's going on
with my aquarium and some other things
like I have a bunch of new features I
want to implement that I haven't done
yet one thing stream analytics gives you
the ability to do is to define alerts so
like if a certain value goes outside of
a certain range you can send out you
know an email text message stuff like
that that's all baked into streaming
analytics and so they'll make sense for
this so if the temperature gets too high
or too low I could have a text Muse
saying like hey something's going on you
should probably go check this out
because like this could hurt your fish I
don't have a chance to do that yet but
like it shouldn't take too long to do
and I think it's really cool that I can
do all this kind of stuff for a simple
aquarium and so going back here we can
see you can go check out all the source
code here it's all GPL licensed open
source stuff like that and it's not
particularly big I would say I did the
bulk of the work and about
two or three weeks and then just like
little bits here and there - Paul shut
it up after that so like using a lot of
pre-built off-the-shelf stuff I made
this a pretty quick project even though
it's doing a lot of really custom stuff
and so yeah with that I want to thank
you all for listening and questions ah
so the question how do I feed fish who
I'm away from home that's not in this
system yet I use a standalone but that's
actually another thing I really do want
to get integrated into this because like
so I have it's already electronic it has
like a motor that basically spins once a
day and I'm like it tips this tumbler
over and so I just gotta dig that up and
crack it open a little bit figure out
basically where the wires are to control
the motor and once I can find out where
that is just cut the rest of the pieces
out and I can wire that up to the
Raspberry Pi and have it control it
instead and so same kind of thing just
like controlling the lighting I could
actually pray even reuse a lot of that
same code since its setting up a
schedule and having a thing you know
mechanical thing happened on the
schedule
ah so what am i using to determine
sunrise and sunset there was a time I
queried a service on the internet many
many years ago but I stopped doing that
because it actually it turns out you can
calculate the sunrise and sunset time
just using a series of formulas you give
it a latitude and longitude and you can
go from there so I am using an NPM
package it's called Sun calc su NC ALC
and it does all that for you but it's
actually an offline module doesn't have
to call your service that's a good
question so the story on where I got my
other they're actually solid-state
relays not optimal they might have an
opto isolator I'm actually I'm curious
now anyways so the solid-state relays
that I used where did I get those from
you can find those on the internet a lot
I actually bought those sort of
RadioShack as is going out of business
so you probably can't buy it anymore
but there are equivalents out there
does it so the question then is with the
stream analytics query which alright
right here
when does that fired is it doesn't like
batch up a bunch of data going in and
then run it on that batch no it actually
runs it on a per event basis coming at
and also I do want to clarify it's an
SQL like language but it's not actually
SQL so like a couple of things we can
look at this a little more in depth when
it says select those are actually fields
out of the Jade yeah the keys out of a
JSON payload as saying like take out
these things from this payload from that
front thing is saying what as your
service so we're gonna pair into it so
that's obviously not SQL that's specific
to Azure and then into you is where
we're gonna put it so I'm saying take
this from IOT hub and put it into Azure
SQL but it could come from others is uh
I forget exactly how many but there's
maybe a dozen different event sources
and maybe another dozen different
outputs so we could pass into a
different database system like we have
one called cosmos DB that's a wrapper
around basically your database of choice
so if you use MongoDB or something you
could do that you could also pass into
file storage you could pass it to other
event systems you can add multiple
stream you know lakes that are like
piped together in kind of whatever else
you want
I have I thought about adding a camera
yes I I this is another one of my
stretch goals I just haven't gotten
around to it so a story a couple years
ago I went to Berlin to speak at a
conference and my partner went with me
we're gonna be gone for two weeks so I
actually did set up a webcam to do it so
like the hardware is not all that hard
to do I just got a like ty the greatest
bits together to get it like right into
the same system I'm sorry that was all
the time we had Brian I'll be hanging
around though so he gets more more
questions so thank you Brian thank you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>