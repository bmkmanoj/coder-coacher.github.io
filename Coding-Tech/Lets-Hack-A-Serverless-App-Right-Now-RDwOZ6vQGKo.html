<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Let's Hack A Serverless App (Right Now) | Coder Coacher - Coaching Coders</title><meta content="Let's Hack A Serverless App (Right Now) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Coding-Tech/">Coding Tech</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Let's Hack A Serverless App (Right Now)</b></h2><h5 class="post__date">2017-12-15</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/RDwOZ6vQGKo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so what we're going to do is we're going
to show a verbal serverless application
we're going to show a little bit how it
works and we will hack it we'll get into
it and we'll demonstrate a bunch of
security flaws and talk about how you
can avoid them or fix them in the
process so with that let's get out of
keynote and into the terminal okay so to
do to demonstrate this I have this small
serverless application actually I'll
switch over here to Adam and I will show
you a little bit about this service
application so it's a very simple app I
don't know how much you're familiar
house how people how many people here
have deployed a service application just
sort of a handful of you so server lists
and I'm not gonna make this an entire
server list one on one set up one on one
set up but I'm using the server list
framework which has this little Yambol
file that describes the different
functions that you are deploying these
or functions as a service and I'm
demonstrating this on lambda on this
application so I have a set of this have
a to-do application that has a set of
services creates list you know get
update and delete just some basic crud
actions to be able to get or add to-do
items to my list and then I added a
little visual thing here called render
which just renders those items that I
have so let's let's see this a little
bit in action and I'm just cheating a
little bit with a with some pre pre-made
items here so we can go off the hosts
that I have deployed this on is isn't
just sort of a funky little name so
instead of I'm gonna spare us a little
bit this typing I'm just gonna use some
short hands here and I can do this
little curl to get my to-do items and I
have no to-do items so let's populate
this a little bit right just gonna run a
few of them we will go off here and post
to serve lists the some data so say this
is to-do item so I'm going to say hold
mom just run this and that would add to
this to-do item let's populate a couple
more will say you know learn server
lists you know useful maybe should have
done this before this talk
and you know maybe sort of one last one
so we have three because three is a good
number and this sort of demonstrate
another capability we have here which is
learn serve lists in three days which is
another little you know this is a really
really good to do listing applications
and one of its capabilities is a
reminder to say learn server list in
three days and that would remind you in
three days to go and learn service so
now we have these components we can go
in we can get get our applications and
and see that we have those maybe let's
make this a little bit more pretty we're
gonna use Jake you just see the items
that we had so this is this is the the
core functions a lot of times in service
you would see these functions like very
API driven very simplistic here but I do
want to have some web interface here so
I added a capability to render these
components using dust j/s which is a
templating library and I could I could
curl sorry I could curl this HTML but
that doesn't that's not very useful for
HTML so instead let's open this up in a
browser and we'll see this which is our
you know very well designed to do list
application this is this is sort of the
state of the art CSS over here and if
you haven't noticed this is a mobile
first application you can add device
equals desktop and you would get an
entirely different experience
yeah it's known it's known that you need
larger fonts on mobile so so this is our
to-do application just a bit of an intro
so this is this is a simple application
doesn't have a lot of lines in it but as
part of that it's a node.js application
and it uses a bunch of dependencies in
it
I mentioned dust yes I use a handful of
others they use MS to translate the time
delimiters they're the in three days to
be able to understand how many
milliseconds that represents so that I
can track that and do helpers so I have
just a small number of dependencies in
my functions so the first wouldn't know
kind of getting into the security aspect
of this I've deployed this application
it's running it's all good when we talk
about security and server lists many of
the security concerns that you would
typically have when we talk about
securing and applications are are sort
of taken away naturally in sir
notably there are no servers or rather
there's no servers that you manage so
many of the security concerns around the
servers making sure they're patched and
making sure you know the ports are
closed or a lot of those components many
of those are already addressed so you
don't need to worry about them
however the app what I've just deployed
that's still an app so all the
application security concerns are in
there and specifically because I've
deployed a very small amount of code but
it has a bunch of these dependencies
some of these libraries may be
vulnerable just like the PAP the
unpatched servers might have been
vulnerable so the first step we're going
to talk about in context of service
security is understanding whether within
this bundle of the app that we've
deployed here using these dependencies
are there these bits of infrastructure
these NPM libraries that might hide some
vulnerabilities so we're gonna use sneak
to find those and then we'll show off it
and to do that I will show two things
we're going to add project here and this
is if you're unfamiliar you can try out
sneak it's just one mechanism to try and
find these vulnerabilities I'll connect
to my lambda interface that I've already
provided the credentials it would go off
and show me all the different service
functions that I have and I can choose
which ones do I want to test for
vulnerable libraries and I'm gonna
choose all of them because I'm lazy and
just go off here and say add those
functions to snake in case you're
wondering this vulnerable application is
not on the snake Network it's on my
wife's Amazon account it don't tell her
they know that no snake networks are
harmed in the process of making this
talk so I went through this process and
now snake has downloaded these zip files
from lambda and inspected them for
vulnerable dependencies that might be in
there so let's take a look at some of
those so we're going to start because I
have different functions here I'm gonna
start by inspecting the create function
so I'll go in here dig in and I will see
that the create function indeed uses a
bunch of dependencies that have certain
vulnerabilities in it now vulnerable
libraries are basically the same as
vulnerable servers of sort of vulnerable
application dependencies are effectively
the same as vulnerable server
dependencies they are downloaded
millions and millions of times there are
sometimes vulnerable vulnerabilities are
just bugs and then you know if you don't
treat them if you don't track what
you're using and you don't update the
update to them over time then they will
grow stale and they will grow vulnerable
so this type of scenario is fairly
common and specifically none of these
server lists or platforms or service
function or platforms or service
environments give you any form of
visibility to know that you've sort of
packaged up again this slice of
infrastructure and then came packaged
into your system so this is one aspect
of serverless security but let's dig in
here there's a bunch of vulnerabilities
here let's do some exploiting for one of
them so I'll start with one with MS so
MS has regular expression denial of
service one er ability in it as I
mentioned we use MS to do this sort of
in three days component and as a part of
that let me again cheat a little bit let
me let's sort of see that in action so
for instance if we were to to mention
learn serverless in two days and like we
did just before ms would kick in parse
that string that says two days and
figure out how many milliseconds those
are in order to parse those strings ms
will be using a regular expression
that's very very common the the issue
with regular expressions is that they
are in fact algorithms and within them
there are these state machines and the
state machines
depending on how you each rate and
travel through the state machines
it may take a nonlinear amount of time
to traverse the state machine as
compared to the length of the string
when that length grows long or so when
that duration goes very very long then
the the event loop in node would get
caught up processing this algorithm
processing the the regular expression
and would not process something else and
this is known as reduce regular
expressions in our service but
serverless has an interesting twist to
it so let's see this a little bit first
instead of running two days we're gonna
take this little example here and we're
gonna say learn serverless
in and we're going to print sixty
characters of five so many many many
minutes all right like five five five
five five six two time minutes
and if we run this it returns fairly
quickly
you know nothing really happens but the
catch about regular expressions or
redose like the state machines and
regular expressions is that they take
the longest to process when they don't
actually match so we're going to do a
bit of a trick here and we're gonna
change that s into an A and what that
means is that the regular expression
would go almost all the way to the end
get to the to the last characters to
match and then figure out it's not
matching and that would make it
backtrack and try again and when it does
that a lot of time that's referred to as
catastrophic knack tracking and the name
kind of says it all so if we do this
it's still not a big deal but if we go
in here and we add another zero that
completes fairly quickly
we had another zero okay I took a little
bit longer and then if we add another
zero that's kind of the magic marker
where this takes a while so last year I
even demonstrated this one herb ility in
one of my talks here and when this
happened the denial-of-service kicked in
but in the case of server lists the
amount of service is actually fairly
well defended against as you can see I
got this internal server error from a
timeout in addition if I was to make
additional requests in the meantime the
surplice platform lamb that would just
spin up more and more of these functions
and would just process those components
services effectively immune to denial of
service runner abilities because you
don't need to deal with scale it just
processes the requests and spins up
infrastructure you know since spins up
capacity to meet your demand however
let's take a look at something
interesting here if we are was to go and
look at the logs a little bit of this
create function this is the lambda logs
I'll just sort of go into this top one
and we'll look at these durations here
at the end you will see that the first
one that I ran or so that the third from
the end took 44 milliseconds to run the
second one took 345 milliseconds to run
and this last one timed out after six
seconds and over here hidden is the
build duration so while server lists
wouldn't allow for denial of service of
your systems it could deny your access
to your bank accounts you know depending
on sort of how often you do this so and
it's just sort of getting warmed up a
little bit I can see I need to speed up
on the on the timing this was one
vulnerability let's to take a look at
another one and then we'll expand from
it so back to my results here we'll look
at another one here and again there's
more to show on many of these but let's
look at the render functions that I have
here so the render function uses dust j
s LinkedIn and dust j s is a great
templating library but at certain
versions it had a remote command
execution in it that remote command
executes it has to do with the
processing of that little device string
that we added over here the sort of
device equals desktop and you can read
more about it you know now clearly I
have more serverless
or more to do items in my list and it
has to do with the processing of it and
eventually you know as you circumvent
components it gets into an eval command
and eval is an evil type of action to
run in the library so I'm not going to
spend too much time explaining the
evaluation of it but let's take a look
at the effects of it so I'm gonna again
cheat a little bit with some pre-made
exploits and and run a bit of an exploit
over here so the first is we're just
gonna start off by understanding where
was the vulnerability so the
vulnerability is a remote command
execution in the processing of the
device parameter this is the desktop
parameter and we can start fussing or
sort of fuzzing this component and
provide all sorts of inputs we can
provide a single quotes and that would
trigger some empty response so that
tells us okay there was some problem
here I didn't get the response back
because some exception was thrown some
components typically that would be more
experimenting here but in my case I know
how to do the execution and I can go off
and do something like this which is
percent 27 and know that because this
string and again instead of giving you a
little bit behind-the-scenes information
to expedite is behind the scenes a lot
of this content gets into an eval that
evaluates the condition of the device so
I'm going to add some JavaScript to it
and I will say - console dot log node
some it was here if I do this I do get a
response back and if I go back to my
logs over here
and they find my render function or my
log phones render function and I look at
the latest log
I will see that indeed indeed notes that
one was here and I can see it over here
in the in the logs so if an attacker has
access to your AWS console logs you've
got bigger problems it's not the the
typical attack vector what an attacker
is more likely to do is something a
little bit different instead of logging
to your console the attacker would run a
slightly more elaborate attack that
would try to spawn some local process
and send information from the local
system onwards so let's do this
now this command gets a little bit
finicky here hope I copied a little bit
too much if you kind of read through the
if you read through a little bit the the
URL encoding here you will see that
instead of just logging to the console I
am doing a require of child's process
and then I'm doing a dot exec to execute
a command which curls and sends over the
slash et Cie passwd to my server so to
do that I need a server so let's send up
a little server that's a sage and run
this command and a viola I got my EDC
passwd from my server list server for my
laminate service so this is fun you know
there's some interesting things we can
start digging into how lambda operates
it has all these like SBX users over it
you know very very interesting stuff and
you can start experimenting from it so
there are two examples of many of
vulnerable libraries that kick in but
now we have remote command execution on
this system so let's dig into some other
service security implications first you
know I'm in here and I have a command
shell so I can explore a little bit the
filesystem around let's see what I can
find here so going back to my examples
here instead of just
you know sending me to suppress WD I can
explore do an LS on the folder that I'm
in so let's do that scroll down see what
data I got and I can see a bunch of
files here
oh and one of the folders that I had is
this admin folder now the admin was a
part of the application that I deployed
and it has maybe some interesting
functions so let's sort of go on and
cats this is again my kind of next
command here sorry for the scrolling the
many many scrolling is you know I want
to know what's in that admin folder so
I'm going to run a command that just
cats all the dot slash admin star files
so let's run this and f Walla I have a
whole bunch of admin files over here I
scroll down and I will show you a couple
of things that might be interesting for
instance this admin secret so there are
a couple of interesting things here to
talk about into context of service first
of all I just executed the function that
does rendering there's no need really
for that render function to have
included these admin components but
because it was easy I deployed my
function as this complete unit I
actually deployed about six different
functions in one table all in one zip
that got uploaded this is the norm and
that meant that now that I've
compromised one function I now have
access to the source code of the
different system so that mistake number
one very common in the service world
mistake number two that happens here is
indeed these secrets in code all the
service frameworks lambda Google Cloud
functions open whisk all these systems
have really good key management systems
and without fail development teams do
not use them now this is an example of
maybe the most like blatant way for you
to include a credential literally in the
code committed into like github in this
component but other examples might be
saving it in the environment loading it
into memory at the beginning all of
those fail if I have this command I can
run the end of command and see all of
those environments
I can see ten files that are on this
system if you are using secrets as a
part of your service function what you
really want to do is you want to store
them in the key management system in the
service that allows you to do secret
management in the service environments
and take advantage of those
I'm rushing a little bit because each of
these is a topic on its own but okay so
we've seen three serverless mistakes so
far right one is the vulnerable
dependencies second is the add minute
that got rolled into the render function
and the third is these secrets let's
let's go further to the top so the one
of the the next kind of vulnerability
that I'll show talks about a myth around
serverless
and that is that it's serverless and
that there are no servers and that you
just run your code and the run zone you
know unicorn power or whatever it is
that sort of running on the on the
ethers now in reality of course you know
server list is just the name and it's
server management lists and the servers
are indeed there but people still tend
to think that these servers are
immutable or rather that there's a
server that gets spun up every time for
every instance and this is oftentimes
not the case
for performance reasons lambda and many
other platforms keep instances warm so
they would run the same service again
and again on a container that runs live
for a while - to demonstrate this my
service makes an entirely needless call
to create a /tmp file as part of its
creation and what we can do is we will
run this little command that what it
does is LS dash L on the /tmp
folder so I'll run this command and what
you'll see over here at the bottom is
that every one of these files was
created from a different execution as we
were playing here and ran a lot of these
commands pretty much all of those ran on
a single instance in lambda that ran ran
this instance and every time I created a
file now this is again a very common
mistake it's often sort of you know
common and and kind of good practice in
many ways to store temporary information
in /jp and if you're using server lists
you might think that's not a concern
because you know that information is
going to disappear at the end of this
execution and that is not correct if
this was sensitive information as soon
as an attacker managed to compromise or
get some file content from /tmp from the
system
I can now repeatedly get that data and
other users would come in store
sensitive information in that /tmp
folder
and I will read it over similarly if I
compromise this machine and I modify the
binary on this on this machine now that
or modified the application itself that
application would be the next one that
would run when a new function call is
made so don't don't be fooled don't
think that service is truly immutable a
compromised service system can still be
modified and it would still serve the
next system so you have to be aware of
that okay
so again kind of rushing through this a
little bit we've seen a few things the
last bit that I'm going to talk about is
parameters so going a little bit back
into my code let's look at that admin
function that I have so in my server
list further down I have three functions
here one is the Nemean api and the
second is backup and restore to admin
functions now i already talked about the
fact that I'm lazy to have thrown them
into the same file here the same system
the other mistake that I've done here is
these two functions they don't have an
API gateway associated to them so you
might not know service fully but this
section over here the HTTP implies how
do you access the function and you can
create functions that are purely
internal that have knowing API
associated to them for those functions
for instance over here they can be
invoked as a part of the internal
network so in this case what I have here
is I have my little API it invokes it
comes in takes that sort of hard-coded
secret sees if I got the request to that
secret and you know it was and that min
came in with the right secret and tries
to invoke a restore or a backup action
and if the secret is incorrect the
function would not be invoked if the
secret is correct that I will invoke the
backup or the restore function ignore
the fact that this is terrible coding
just sort of as that as a verification
and in the simple case this is this is
correct this would indeed protect me
from from access because these functions
are not public but now I have remote
command execution into the network so
what I can do is take that same piece of
code over here and I guess you know I I
can spare you the time to validate this
but I can go in here and run this
elaborate piece of code that says lambda
dot invoke
the data of my internal restore function
now I've done some assumptions here as
an attacker I would have fuzzed and
tried to assess a little bit which
functions exist but still this
permission would work and if I was to go
to the logs now this action would be
there so this is another may be a core
element of servlet security which is to
just be aware of the fact that every
function is really its own perimeter and
what you don't want to do is create a
situation where you're as weak as your
as your weakest link
right or as strong as your weakest link
and that a single function that it had
compromised now topple to the entire
system and can access your entire
network so I'm already over time let me
sort it still just one more minute being
class talk anyway there of the set up
and the last thing I want to talk to you
about is if I clear this is this
function and the reason I want to talk
to you about this function is that I
have no idea what it is it's a function
that got deployed because it's easy
because serverless makes deploying
functions cheap or literally free it
really costs you the minimal amount of
storing the zip on that s3 and unless it
gets invoked it doesn't cost you
anything but this function also has four
vulnerabilities or whatever it is that
may compromise it may access my system
and may be used to like Bitcoin mining
or they could be used to exploit
whatever it is that this system has
access to and so this is sort of my last
risk to talk about in the context of
serverless server list makes deploying
functions operationally free but it
doesn't mean that the total cost of
ownership and the risk that is
associated with deploying a function is
zero if each one of these functions is
an attack surface and it's a potential
cost to you as an organization even if
there's no cost to actually having it
deployed so you have to be careful and
remember to control the amount of
functions to deploy and to segregate
them correctly so I'm well over time
here let me just sort of say very
quickly you know summarizing it one we
were vulnerable libraries that was kind
of our starting point just give the
example here a little bit to read us
you're not gonna take you down but they
might take down your bank account
beware of it 3.avoid secrets for don't
rely on immutability use granular
policies don't roll the whole thing
together into one function and deploy
granular functions so you're not
exposing more than you needed to
and then lastly think about all the
functions thinks about them as a unit of
attack surface there is that broader
talk that I mentioned go ahead and look
at that to see sort of the meta of what
is better neutral or worse about
security and server lists and server
list is being defined now so think about
security and let's sort of build
security into into the basics and the
best practice of how we build it thank
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>