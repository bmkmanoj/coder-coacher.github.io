<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>My Personal Fight Against The Modern Laptop | Coder Coacher - Coaching Coders</title><meta content="My Personal Fight Against The Modern Laptop - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Coding-Tech/">Coding Tech</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>My Personal Fight Against The Modern Laptop</b></h2><h5 class="post__date">2018-03-03</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/_kFJo5QRCiA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">I try to sit down and work out what my
ideal laptop was while preparing for
this talk because you know otherwise why
am I doing this what have I got is a
target and I came up with a number of
options for what I needed and it's
really an ideal laptop there are a whole
lot of things here that can't be
achieved there's a whole lot of things
that can be achieved though easily
portable is my definition on a laptop
for instance I look at laptops with a
pink pad with a keypad on the side and I
go that's big I don't want big I want
small so I've already narrowed down what
kind of laptop I want I can plug in a
keyboard if I actually need a keypad the
laptop that has no blobs would be ideal
but not anybody can do that at the
moment with a modern laptop even there's
a company out there purism that actually
had that as their intent and they still
can't get rid of all the blobs in their
laptop although there's been some
movement on that since I wrote this
slide I don't know that they are
actually shipping anything that has no
management engine blob just as an
example and I wanted to actually be a
laptop I was really excited when the
novena laptop was as an option except
that it's not actually a laptop it's a
portable computer so again I've narrowed
it down to things that I think would be
useful for me to have which means that
the scope of what I'm actually trying to
change can be narrowed down as well
first address something on my list of
things that I like what can I change
from that list and I can't build a whole
laptop I've only got a certain amount of
skills so I'm left with the two things
are important to me is the ergonomics of
using a laptop all day there's a screen
there's a lot of people out there with
projects to replace screens on their
laptops there's a lot of aftermarket
options that's not actually a problem
that needs solving anything and the
keyboard of the newer ThinkPad range
didn't meet with my idea of what I
wanted in a laptop so what could I do
about the keyboard
can I change it I don't know if
everybody is seen a ThinkPad keypad but
I've had them for a long time I own
every keyboard you see here I own the
laptops behind them as well but they've
had pretty much the same keyboard for 20
years up until 2011 and then they
changed they changed fairly
significantly there were changes in the
laptops before this point and there are
changes in the laptops after this point
as well you can see some of the changes
with the weird laptop up here where they
did rather surprising things like decide
that some keys needed to replace the
caps lock key but they also did things
that other members of the industry too
thought they'd do recently with the
Apple removing the function keys they
left the Escape key but you know it's a
keyboard with a number of strange design
decisions and I looking at things like
this and I said well this is the way
it's going I really do need to work on
what I can do because I had some ideas
about what I wanted in my keyboard I
actually liked the the old keyboard in
there keycaps
the way they weren't island keys but
more importantly they had a very nice
feel they had a lot of travel they had
the ability for me to type on him all
day and 20 years of muscle memory of
knowing where the keys are so when you
change it this is the very next model on
the right here when you change it they
changed it quite significantly which
wasn't what I wanted so what could I
replace turns out that the keyboard
connector from those two models is
identical I can actually physically just
plug the keyboard in it there's a couple
of issues one I didn't notice until much
later
is that the keyboards on the newer
laptop actually have a backlit keyboard
it's an option but it's an option that's
always on the motherboard and the mother
always sends hike
voltage through the keyboard connector
this needed to be pointed out to me took
a while for me to actually see it I
didn't believe it until I could see it
and apparently I was lucky that when the
high current went through the my
keyboard I burnt a little tiny hole in
it in the right spot other people have
had things like their mouse keys stopped
working when they happened so I did this
to several keyboards and they all had
the same failure mode and I crossed my
fingers and hope that the rest of world
had the same answer but there's somebody
out there who pointed this out to me and
said here's how to fix it
you need to insulate these pins so it
doesn't actually affect it after I've
solved that problem by blowing up some
tracks on my keyboard I still had some
problems the difference between the
number of rows on the keyboard meant
that they had rearranged the keyboard
matrix which meant there were some dead
keys there were some keys that had the
wrong thing happened when you pressed
them a lot of the Finke combos didn't
wipe quite do what they said on the box
anymore and there were some keys that
didn't work at all like the the new
keyboard doesn't have a caps lock key
the old keyboard kept light the old
keyboard did some people had their own
answers for this which I looked at and
said that's rather laborious attacking
it with a razor blade and pulling it
apart and rewiring the actual matrix on
the keyboard wasn't error-free I thought
there's got to be another way of doing
this I found some schematics and they
showed me that in fact all the keys were
still connected it's a different
embedded controller on the new laptop
than the old one but all the keys are
still physically connected it's all just
software that's causing the problem so
if this was open source I would just
patch it and it would just work and that
would be the end of it it wouldn't be a
big story this is not open source I
looked at what I could do the Internet
has a dump of a ThinkPad firmware from
10 years ago
it's about
it has most of the same information in
there so I was able to use that to try
and look for the keyboard table in the
somebody else's disassembly they've
reverse engineered it so it's not
actually perfect and say okay that's
what the key would look like ten years
ago in the firmware what does the
keyboard table look like in modern
firmware so I got my current laptop and
I got my new laptop with the right and
the wrong keyboard and I found the
keyboard table I said good it's all
fantastic I can patch this those of you
who saw the previous talk know that you
can't just patch the firmware it has
signatures so I can't can't act on this
I've got a patch but no way to install
it now I've sitting I'm working on the
invented firmware here that I'm dear
looking at you might not all know what
the embedded firmware is the embedded
firmware runs on the embedded controller
the better controller is another
computer inside your computer very small
one and it's plugged into the keyboard
and the battery and the mouse and the
fans and many other things that I don't
know about so I pulled out the internet
and eventually somebody else had
actually worked out how to fix the
signature so thanks Matt you should have
seen his dog I won't explain it all for
you go and have a look at the video but
if you mid miss it what he did is he
worked on how to take that firmware
reverse-engineer the encryption and the
signatures and allow us to then repack
it up we the patch applied great now I
can install the patch well not really
because it didn't actually work some of
the keys moved around some of the keys
didn't some of the keys just didn't come
live with the patch that should have
fixed it all according to the keyboard
table so that's when I actually started
saying okay I'm gonna have to reverse
engineer this only at all to do this
at all that supports the firmware the
hardware that the firmware is running
which is this our compact system right
there a tool that is used for reverse
engineering has support for that I
opened it up and I say awesome I can
look at this I looked straight at this
and I said um that looks like a mess and
if it looks like a mess to me sorry if
it looks like a mess to you because you
don't know what you're looking at it
looks more like a mess to me because
these errors should point somewhere and
they should do something turns out that
red err didn't actually support this CPU
very well so I have to improve it in
order to actually successfully
reverse-engineer the firmware I ended up
going off and yak shaving I had to
rewrite the analysis tool for red air
and most of the analysis engine that
they used for this CPU tool was written
for a different architecture was written
for an older version would only
minimally support for the one I was
working on and while they implemented a
fair bit I only took the low-hanging
fruit I only took just enough to make
sure that I could actually see what I
was doing because when I'd finished
doing my reverse engineering the hairs
look better a lot of it looks better as
well but that's a very visible thing to
me I can look at that and I can say okay
they're pointing at things that make
sense the things they're pointing out
over here are actually places that you'd
have arrows coming from and to jump
targets jump sources so I can go back to
actually looking for my keyboard tables
much of the code in Isis I was doing was
looking for the caps lock light and how
did the actual BIOS program the firmware
which wasn't the keyboard tables so I
needed to go and look further for their
keyboard tables rather than distracting
myself with code which is where I
actually because I spent a lot of time
rewriting the red hair CPU module
I end up having to learn how radio works
not completely it's a very big tool it's
written in they say the kind of flavor
of a UNIX tool where it's a lots of
little toys you can combine together but
every tool is cryptic and you have to
learn all of them so I'm gonna walk you
through some of the things I did to
actually get radar working well use red
air working we're ready so this is the
the table I found with my matching with
the 10 year old firmware so this is
actually the hex dump of the keyboard
table which I'm fairly confident it's
the keyboard table so I've given it a
name down here I've told red here it's
this size at this offset and give it a
name and once I've got that named I can
say where else refers to this table
there must be something in the code that
jumps to this table and looks into the
code table I found one hit oh hey this
is simple we can move on from here so I
had the same look the same hex dump of
around that area where I can see there's
my hip I'm looking through this and you
stare at that for a while and you work
out and what is it saying me oh okay
I'll look at this that looks like it
could be something this could be
something here maybe if I should look at
it a different way the red air can show
it to me in a different way if I show it
as the CPU is a 32-bit CPU so I'll show
it as a series of 32-bit words and oh
look that's the number of bytes in the
keyboard table that's a pointer to the
keyboard table what's this it's a
pointer to something nearby so again I
name this table that I found point
comments into some of it and make it
sure that radar knows that there are all
four byte long quantities 32 bits and
then go and have a look at the thing I
first just found it's just I can see the
thing I've just named it's highlighted
it for me and I can see before it okay
I'm not really sure what that is but it
looks like it is
a hundred and ten hex bits long so it's
the same size as the keyboard table all
right I'm fairly sure I found something
why don't I call it
it's a bitmap and I can keep giving some
of your name and if you keep doing that
repeatedly eventually you can print out
what you've got and that starts to make
more sense this is exactly the same list
that I showed before printed a different
way and you can see there's my comment
about all that must be the size there's
a point of the first table I found
there's a point of the second table of a
found and there's some more work that I
have to do
I haven't found what that is at this
point and that's not the only tool you
end up using for this hex dump I hope
most people have heard of its really
good hex dump has an alias called HD
which I didn't actually know about until
along the year ago which shows the hex
dump in the format that I call hex dump
rather than the format that UNIX calls
hex dump so I use HD all the time
then there's the bin def which if you're
downloading multiple different firmware
versions and you're trying to work out
what the differences are it's really
handy for dipping binary files it's also
seems to be something that is not really
well catered for in the tools that I've
used so when I found this I said god
I'll use this for that kind of thing as
well and then another tool which is my
go-to for the first thing that I need to
look at all the time is HTE which is a
hex editor as well as a hex viewer as
well as a disassembler as well as a bit
of an assembler it's got advanced search
tools so this is the tool I used for
searching for my keyboard table it
doesn't actually stand for anything
magical it says it's HT editor I tried
to work out I knew somebody would say
what's HT Eastern for HT is what it
stands for high-tech why not bean walk
is the final tool that I actually have
on my top 4 it's what I use to try and
pull apart the firmware and the fact
that it didn't show me anything for this
keyboard firmware it was
because it's still lit all I used first
what's in this blob that are downloaded
from Lenovo and it shows you it pulls
apart all the contents of it looks for
the magic numbers and shows you all the
details in there so it's like file but
on steroids and it has an option for you
to say fill this directory of all the
things you found and you end up with all
the component parts which is really
handy because some firmwares it's
Turtles all the way down one of those
component parts you'll need to pull
apart again
and pull that up in walk and do it again
so once I've got all my tools set up I
can continue looking for the structures
that I need to actually fix the
remaining keys on the keyboard what I
showed you before when walking through
the red air command line ends up looking
like this if you actually graph it out
and you keep going you'll look for more
tables you keep following all those
pointers and you look for more pointers
and you end up with more tables there's
a lot of them in the firmware at this
roundabout this point that I'm searching
for various parts of the firmware that I
hooked up with a guy called nitro caster
he found me through the internet
basically because I posted on Zed Matt's
blog post he then searched me out and
contacted me and said hey let's work on
this he'd found the live key bitmap
which is what I'd found as the bitmap
before and I've abbreviated enough that
I can actually pointed anything here
sorry that bitmap was the Bing returned
on the dead keys and after he did that
working together we were able to find
the other two tables that are needed so
this structure that you can see here
contains the four tables that are
actually needed to patch the firmware to
make the old keyboard work once you've
got those patches you can actually get
most of the functionality going I've
written most of this down in the docs
for the repo that I put together for it
so hopefully other people can find the
same things and patch them differently
if they wanted to
there are a lot more tables in the
firmware this is the abbreviated version
this is just the stuff that comes from
the keyboard table that I found right at
the top there I think the full graph is
about three times this size it's not
many bytes but there's a lot of stuff
there so and it's very well-organized
you can actually automatically this is
automatically generated so if people
wanted to go looking for what else is in
there the combination of that and the oh
of the ten-year-old firmware that
somebody else's disassembled might give
you some more on pointers so success I
did that I patched my firmware I
installed the physical keyboard and most
of the keys work as I said there is no
caps lock on the X 230 keyboard I
couldn't find where the caps lock was
configured in the firmware it might not
even be there they might have compiled
it out so I don't know if it caps lock
like anymore
there's a couple of other bits and
pieces like the the screen lock key
doesn't work properly it might work but
I don't use it so I don't look at that
the hibernate key doesn't work properly
for a different reason I was a bit
afraid to try and touch it in case I
break my firmware and I don't use
hibernate so I didn't touch that but
basically all the keys are working which
is where I said okay the two of us have
worked together to produce this patch
we've succeeded in producing it
let's get other people to help us or
let's help them we'll publish it
nitro caster starts up a flare and
ThinkPad for moments publishers the work
that we've been able to do we put
forward to them all the hex offsets of
the bytes they need to patch in their
firmware they didn't really follow along
a lot of the people there would want to
do a little bit more information and
they want to know how they could do it
themselves with that information so we
had to polish the project a bit
I collected together all the patches
that we had put it together a github
repo published it with a readme file and
said here you go
which is when I discovered that I didn't
actually know who my audience was that
when I published hex offsets and the
bytes you need to patch and they'd said
oh that's a little bit difficult they
weren't saying I don't want to type in
hex patches they were saying I don't
know what hex patches are so I had to
rewrite all my Doc's try and simplify
the process which was a little bit
problematic because the level of szimpla
Kayson that you need for an audience
that is just end-users basically who are
not interested in breaking their
firmware is a level of streamlining that
is hard to achieve when you're
distributing patches to somebody else's
firmware I didn't want to redistribute
Lenovo's binary objects I don't know how
I'd even go about asking information to
that but I'm fairly sure the answer
would be no so what I've published is a
toolkit for editing those and will
automatically download for them which is
still a problem because a lot of them
are on Windows as it turns out a lot of
them who are interested in actually
being able to do this were able to fire
up a VM and install my tools inside the
VM and combine all that information to
get a binary patch that they could then
flash under their system so that's when
the other requests started coming in
everybody had a different type of laptop
to me I had an ex 2:30
this guy had an ex had a T 4:30 and then
there's about seven different models in
this range where they're all like can I
support this - additionally I was a bit
confused why would I be out of this sort
these I don't even have the hardware but
I got - I got the firmware and I had a
look inside it and it turns out there
the entire range the X X 30 range of
ThinkPad laptops all had the same
firmware layout not the same offsets not
exactly the same hardware but close
enough that I could find the same
keyboard tables
create a new patch for each version
which made my repository a little bit
more difficult to follow because I'd
structured it assuming that I need one
laptop hardware and now I've got I think
there's eight in there maybe nine not
all of them have full patches but it's
probably needs a bit of a restructure
now that I've seen what I ended up using
the the the repository for and one of
the ways I thought about simplifying it
for people is instead of actually
getting them to have to run a system to
create a bootable disk and then take
that bootable disk and reboot onto it
what if I could patch the firmware from
the command line they're already running
a UNIX command line because the tool
sets UNIX maybe if I can work out how
the tool that Lenovo provides actually
talked to the firmware how did it flash
to the firmware so this is where I went
further than what I needed and this is
where I said okay I'm gonna scratch my
edge by trying to fix their problem I
was intrigued about how it worked
I thought there was some interesting
questions about whether or not how the
magic happened and whether or not it it
was something that I could replace and
then just give them one project that
they could boot up on bare metal it
would connect to the network download
the firmware patch the firmware and then
run the tool on Linux to upload the new
firmware to the hardware which required
me to actually reverse the tool that
Lenovo provided and it's not something
you can easily trace to find out what
it's doing because it's a 32-bit
application written to run under dos
which means that they aren't that many
tools that I could find to do it and
most of them didn't work very well for
stuff that one of the talk to the
hardware I can unpack it all turns out
it was compiled by an open source
product from the the 90s it was compiled
by a program that was used to for
to compile the original doom so it's all
software that is on print sauce but I
was able to download find out the format
of the EXCI and use that to unpack the
32-bit program that was inside it which
allowed me to host the DOS EMU inside my
host the dos flash tool inside my own
emulator and using an lwn article which
was invaluable to do it I was able to
actually write my own KVM based
hypervisor that hosted this dos flash
tool and gave me trace output which
meant that I could see one side
implemented all the framework required
to actually run a this program the basic
framework I could run it and get a trace
of what it was talking to I got all the
interrupts are called all the places
that it opened files and their file
names and that's when I started to find
that it was talking to the hardware
which I assumed was going to be
happening it wasn't a surprise but now I
knew which hardware is talking to it
loaded various ACPI tables out of the
firmware in the BIOS firmware which gave
me a place to start implementing I had
to actually implement the ACPI firmware
and then I found the SMM calls now this
is the part where it actually talks to
the hardware well the hardware because I
could document the protocol that it was
using to talk to the SMM but the SMM is
not actually Hardware the SMM is a more
privileged mode of the CPU I can't
easily get into that so I can't easily
reverse engineer that but I can reverse
the age of the protocol if you don't
know what SMM is you use a code is
normally run by a kernel your kernel is
running inside a virtual machine
hypervisor even more privileged than a
hypervisor is this system management
mode and it's a little bit of code that
sits inside your CPU that you can't talk
to
that you can't run that you can't edit
so it's in the BIOS firmware somewhere I
probably could find that I didn't go
that far because that's pretty much
where my problems started I couldn't
give it the right answer that it was
looking for the dos flash tool center
come out a protocol out to the SMM and
got an answer that didn't like which was
nothing because my a mule I didn't know
what answer they give it from this point
I need to build a kernel driver that
runs on real hardware and the kernel
driver can talk to the 64 bit or 32 bit
high areas of memory that the a CPI
tables point to I have the wrong
motherboard I have a spare ThinkPad
motherboard but it's the wrong one for
the laptop I actually need to work on
but it's still kind of dangerous to
start trying to talk to the firmware and
asking it to flash itself so I haven't
done much further on that I haven't
written the kernel driver but I did
wonder how this would be applicable to
newer models the various laptops that
I've replaced this on have all been 2012
laptops what if I actually wanted a
modern laptop I've been an upgrade my
laptop by one year so I looked at the
other ones and the newer models from the
same kind of think bad range and they
all have the same kind of firmware
layout so they all have the same kind of
tables if I could physically shoehorn
the keyboard in there I could probably
apply the same patch the 250 I don't
know how the encryption works but I
assume that I could reverse it the same
way that Matt did for the X 230 the
latest model at the time I wrote this
slide was the ex 260 I had a look at its
firmware it's not encrypted at all but
it does have another 256 bytes worth of
stuff added to the end so I assume it's
actually going to be harder to work out
because they've
probably moved up their there their game
and cryptographically signing it so it's
harder for some random person to replace
your hardware your firmware they've
subsequently announced an ex 270 laptop
they haven't released any firmware for
it so I haven't looked at it and what
are my next steps obviously I should
actually start using the laptop that
I've hacked with this I'm still using
the old laptop this hasn't broken yet
I'm worried that I'm gonna run out of
laptops I've got a stockpile at home of
two or three of these laptops because
that way when I break one I can move on
to the next least oldest one they're all
old though now I know that I'm gonna
have to replace them at some point so I
can't just enjoy using the laptop that
has this I do intend to write the kernel
driver that allow me to try and continue
tracing the system management mode
protocol and I'll probably dream doing
that on my old x2 20 laptop motherboard
but I don't know if it'll go anywhere
and I don't know if it's applicable to
modern hardware so it may not actually
help me another idea I had was to take
the same physical hardware that I like
and build an adapter you can see it on
the screen here the adapter you plugged
the hardware in keyboard into and it's
got its own micro controller and
presents as a USB keyboard lenovo used
to sell this they used to have a
keyboard you can buy with a USB dongle
on the end of it that would do all that
they don't sell it anymore
they sell a newer one it has options
with Bluetooth that's a smaller case and
it's the wrong keyboard so I can't buy
them anymore are used to better buy them
and if I get that small enough I could
probably fit it inside the laptop in one
of the gaps the newer keyboards on the
newer laptops they have a different
connector on them but they're still
probably a very similar electrical
layout so if I actually got one
I would try and pull it apart which also
leads me to why I haven't got one
because it's a $1,500 expense that I
know I'm going to attack with a dremel
as soon as I get it I can't justify that
so I'll keep using my old laptops until
they all break but crossing my fingers
that I'll be able to solve that problem
when they do all break and obviously
look for alternate laptops there are a
number of open laptop alternatives that
are showing up
I mentioned the the prism and there
libram laptops earlier I also don't have
a keyboard that I want I can't easily
replace the keyboard on their laptop
physically it's got the exactly the same
problem I'd have to attack it with a
dremel there are things like the PI top
that are available
it has a Raspberry Pi inside it and a
battery theoretically it's a cheaper
thing that I could replace the keyboard
on using something like this adapter I'd
be able to put the keyboard I want into
their laptop so I'm hoping that there
are more alternatives like that in the
future there's actually a guy wandering
around with a PI top here this week he's
standing it he's sitting at the back of
the room there I promised him that I'm
going to go and measure his laptop so I
can work out whether I can put my um fit
my keyboard in it later on hopefully
he'll be around and won't be running
away and then maybe I'll buy one of them
but again I've talked to those people
they can't sell me the keyboard part by
itself I'd have to buy the entire laptop
and then the first thing I'd do to it
was attack it with a dremel it's a
cheaper laptop so maybe I should do that
but I know that it's a worse laptop
whereas I was hoping to get a better
laptop so that leaves me with a question
for you that what hardware have you got
that you could improve that you would
like to improve and hopefully do you
feel like you can improve and with some
effort Bo to actually change the things
that aren't built the way you want them
to be built without just relying on the
camera
show enterprise to provide you with a
new toy later that's the end of my talk</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>