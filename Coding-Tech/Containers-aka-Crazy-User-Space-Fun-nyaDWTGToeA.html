<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Containers aka Crazy User Space Fun | Coder Coacher - Coaching Coders</title><meta content="Containers aka Crazy User Space Fun - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Coding-Tech/">Coding Tech</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Containers aka Crazy User Space Fun</b></h2><h5 class="post__date">2018-04-04</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/nyaDWTGToeA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so I'm gonna be talking about containers
from user space mostly where I live is
user space I'm not sure if any of you
are familiar with the movie play and 9
from outer space
but it's a terrible movie and actually
play a nine the OS I think is based off
that name but this is gonna be
containers from user space so we can
only hope that it's so bad that it's
good this talk just like the movie yeah
so Who am I I work at Microsoft selling
out has been amazing if you have any
questions about that I'm happy to answer
them I work on open sourcing containers
and specifically now on kubernetes I
kind of live between the layers of
abstraction and I really like it there
because it's fun and like I get a joy
from pulling features out of one layer
and into the other so this talk is going
to be a lot about like how we took
features from the kernel made containers
and then pulling them back into
kubernetes and orchestrators as well so
i'm gonna cover a lot of things but
we're gonna run through a lot of them
very fast because I think people kind of
have some pre-existing knowledge here so
it's I'm gonna go over what are
containers and then a little bit of
Linux container history because docker
obviously wasn't the first and we didn't
even come up with the container name it
was already there our containers secure
and then is it the year of Linux
containers on the desktop and then a
bunch of experiments kind of outside
containers that relate so that I'm not
just like containers containers
containers because that's intense
and then the future is kind of where
we're gonna spend a lot of the time
everything else is kind of just like a
very brief touch on it sweet so we'll
start with like what is a container
because I think there's some confusion
it's not a real thing they're made up of
Linux primitives mostly like the
differences between zones jails and VMs
a lot of people will ask me this and I
think it's because they're like trying
to get me all over
I yelled up or they think that I like
love containers the most actually I love
zones first so and if you never read the
zone design doc it's a great read it's
really cool but zones jails and BMS are
all first class concepts and then
containers are made up of cgroups
namespaces LSMs and blah blah blah
there's a bunch we'll go over it so yeah
real things and then there's not a real
thing so this is a feature and not a bug
and I'll also touch on that too it's
really cool like what you can do since
there are so many pieces that you can
put together but just real fast
namespaces control what a process can
see and there's a whole bunch of those
and then see groups control what a
process can use so this is where you get
your you know resource management from
and there's a whole bunch of those too
so if we kind of just start from the
very base of what I consider a container
it would be namespaces and see groups so
it looks like that and then I took away
the words so just imagine they're still
there so on top of that we actually
layer a bunch of other things so one of
them is a primer which is an LSM and we
have same defaults for that so when
you're running a docker container at
least you're getting these same defaults
that I'm gonna mention for all these out
of the box so we prevent writing to like
obvious places where you would not want
to write things in proc things insists
we also prevent mounting which is also
gated obviously by like caps this
administra layer or protection you never
know so another one would be selinux
you can't run me side by side currently
so they're both blue but this is another
LS I'm and this one's a label base so
the defaults here are that docker gets
asked us access to everything and user
and Etsy and then you can actually relay
Yuval contents on the host to make it
have access or you can read label things
and user or Etsy to say no you can't
have access so set comp is another cool
one and this was a feature that I worked
on a lot in docker so these are Cisco
filters so you can kind of define what
is allowed and denied in a container
and what we have in docker is a white
list of syscalls that are allowed and it
took a really long time to kind of build
this white list because at the point
where I was adding this feature docker
was already like insanely popular so the
fear was that if we make a weightless
like we're gonna break all the
containers in the world by missing one
Cisco I lost sleep for like weeks over
it and actually like the day before the
release
I was running Skype in a container
supernormal and that's a 32-bit
application running on a 64-bit machine
so I realized that we were missing send
and receive like really comments as
calls so then I was like oh my god this
is really scary but in our testing face
and Skype was obviously super uncommon I
went through all the public docker files
on github and I pulled them all and I
ran them on this huge cluster with the
patches and kind of collected all the
like all the EPIRBs though that were
being thrown and if they were like an e
perm that was bad I would fix it and
then if it was one where it should have
eat permed then it was fine so that was
kind of a cool way to test things but
yeah so our whitelist
just specifies what's allowed and it
blocks like a bunch of bad stuff not
what it's the following but all like
just touch on a few so anything that is
with the kernel hearing it's not
actually namespace yet so we just don't
allow that clone we have specific masks
so that you cannot clone a new user name
space inside a container and this is
mostly just so that people don't get
into those really weird situations where
user name spaces allow you to kind of
like escalate your privileges or you
know break out and all the other clone
flags are gated by capsid min which we
don't allow and containers to begin with
and then same fun chair we just don't
allow people to create a new username
space or ensure a new user name stays so
then there's no new proofs which is a
linux flag for fork exec and
clone and it prevents new privileges
from being added to a process so this
one was cool in that in kubernetes we
kind of reversed the naming so it's like
allow privilege escalation so you're
kind of implicitly denying privilege
escalation and then you have to say like
I was like privilege escalation so then
we don't add the flag and then
capabilities are super basic these are
the ones that we allow by default and
none of these are really all that bad I
wish we could get rid of captain it raw
but if people want to ping inside a
container you need it so that kind of
sucks and I guess people ping inside
containers and so actually just a fun
fact not all these defaults carry to all
the runtime so rocket and systemd and
spawn they actually add caps aside min
to all containers which I have an issue
with but yeah I just think it's a bit
unnecessary so yeah that's what I
container is this is made up of all
these parts with all this other stuff on
top you can kind of consider it just
like a bunch of duct tape but then what
about those like Intel clear containers
which are now formally known as cat
containers those are actually VMs right
it's KVM and QE mu they're like these
really cool fast booting containers but
they call them well they're fast muting
VMs what they call them containers like
I'm not really sure what is happening
there actually I don't know if it's
continuing mostly because it is actually
a virtual machine like I definitely like
it though because from a technical
perspective it's really cool what
they're doing crazy food fast booting
vm's like I would totally use those all
the time and I do I'm actually on their
technical architecture board too but
yeah they're really cool if you've never
played with them I personally would have
called them glass houses though I don't
know seems more fitting naming things is
super hard obviously it's like one of
the hardest problems in computer science
I mean we could have just called them
all boxes instead of containers
I mean who knows it could have been
called like anything that was possible
and then we would have been having this
like whole box bad we could have even
said little boxes on the hillside like
in weeds and everyone would have done
that like song stuck in their head and
it would have been really funny
instead of like all these like
Tupperware jokes so yeah so the history
of Linux containers is kind of cool
because they've been around a long time
like way before docker and dr. kind of
just I guess made it more usable or you
know maybe it was all the hype around
docker that people got like really
excited about it so this is gonna be the
history of containers that use a Linux
primitives not to be confused with the
glasshouse ones that are actually VMs so
there was openvz which was twelve years
ago and I'm not actually sure that's
still maintained but I think people
still use it so that's a really long
time ago and even before that I think
was when Google added C groups to the
kernel I meant to put that data in here
and then I forgot but then after that
shortly
what's Linux key server which I do not
think is still maintained because I
haven't heard about it a long time then
Alexei was nine years ago and this was
actually my first kind of interaction
with containers and I think that if
anyone is to assign blame for the whole
container wording it would be Alexi but
don't tell them I said that but yeah I
mean Alexi Stanford stands for literally
Linux containers so Alexi was cool like
I ran in production a cluster of a bunch
of Alexi containers and then when docker
was showed at PyCon when they first like
showed kind of what docker was even
though it didn't necessarily like work
like it did today there I switched over
our environment to be docker and that
was like pre 1.0 and there was a bunch
of bugs and that's kind of how I started
like contributing and stuff but yeah so
Dockers initial release was almost five
years ago and initially even in that
pack on demo and stuff the back end was
L
see and we carried that as a back-end
option for a long time but it was
replaced as the default back-end pre 1.0
in B 0.7 and I do remember like when we
were using docker at that time for this
production cluster it started working a
lot better mostly because it's really
hard to kind of like write code on top
of other people's
binaries when you're just executing
arbitrary binaries it's not like there
was an API like you're just exacting
another binary so kind of capturing you
know the output there is hard to have a
good debugging but yeah that back-end
was carried into like docker one point
forward when I think we finally killed
it it was hard to maintain so then there
was also let me contain that for you and
this was like right around the same time
as docker if you look and I really liked
actually the name of this project like I
still think that super dope name let me
continue that for you
and this was by a bunch of Google people
and then they started contributing to
Lib container which was Dockers go
library that replaced the LXE back-end
and I remember on my first day a doctor
we actually met with these guys and it
was really cool because I was like oh
there let me contain that for you and
they have this really cool project and
this was definitely before I think
containers were cool and then there was
rocket which is core OSS kind of
container runtime this was what I would
like to say was the start of the
container wars but there's a bit more on
that later or the container wars over I
don't know I don't know
so Runcie came as like trying to end the
container wars and this is this was
donated to a foundation which is like
spawned as a child foundation I guess of
Linux Foundation so it's the open
container initiative so it was kind of
just like we'll give this away so that
everyone stops you know saying that were
you know only having the best interests
of docker you know which is good like
there should be governments around this
if it's gonna be like this huge world of
containers so yeah run C's really cool
and that project is really cool if
you're interested in helping out
so container runtimes are kind of like
the new JavaScript frameworks there's so
many and if I went over them all we'd be
here all day but that's kind of like the
the base frame of like what containers
are and like where they started from so
moving on to our next topic
our containers secure I get this a lot
and even like in the beginning days of
docker there was like so much shade
thrown which like yes was very um it
made sense then but then after we
started adding all those layers of LSMs
and seconds and stuff it kind of changed
a story so yes they definitely are
secure and I can prove it and we're
gonna do that right now so I like to
think about containers kind of as Legos
okay so people get mad whenever I add
the s there so just deal with it like I
put the s in parentheses and I can't
just like stop a habit okay so the end
zones in jails they're all like if you
bought the Legos already put together
and glued which is no fun by the way but
yeah so you kind of just already get
this like art work in the form of pieces
but it's already glued so you can't take
it apart or anything it's not really all
that cool there the Deathstar like you
don't have to do any work it's just
there they come free assembled of the
box right so containers they just come
with the pieces and like the box says
you know build the Deathstar
but you're not tied to building the
Deathstar you have all the pieces you
can put them together in any way you
want right like you could build a boat
like you are the master builder here you
can do whatever you want which is really
cool like you could even do this where
you don't have the pieces for the right
thing but you build it which is a little
backwards but cool so you can turn on
and off certain namespaces which is
super dope so like say that you want to
have you know better networking like
lower latency and you have like all
these patches for your kernel for really
really low latency you think like stock
trading right so if you just run in the
host name space that's kind of how we
call it even though it's just host
networking you know you don't turn on
the network namespace then you can
actually
just use all those low-latency kind of
Network features that you had and you
can do the same for like all the other
name spaces as well which is really cool
you can also share name spaces between
containers and this is actually the part
that I really love because actually this
like numerous other talks okay so what I
like to do is say like an application is
Rehavia poorly in a container and I want
to let's trace it right so you could
likes trace it from your hosts like the
actual pit of the thing running in the
container obviously but like where's the
fun in that when you could share the pin
namespace and then run strace in a
container which is kind of cool and then
also you can do the same with like
network namespaces so say application
misbehaving and you want to start
looking at all the packets right so you
can run like Wireshark or something like
that in a container with a shared
network namespace and debug that
container and it's just really cool the
combination so you can get into and a
lot of people have like really crazy
things that they have done with this and
like one of the most common use cases
that people don't necessarily know about
but kubernetes when you're splitting up
these pods that they have which is just
a kind of grouping of containers they
all share a pit and net new space and
this is because the network one is for
convenience
obviously pit is so that they can send
signals to the other things running and
the pod and also so that they can know
like what is happening which is really
cool so like every kubernetes pod
actually starts as this pause container
which kind of just makes sets up these
namespaces then they're all spawned from
there so everything is a tunable knob
which is really cool but obviously you
can like shoot yourself in the foot
really easily when you start tuning
these knobs in ways that you were like
unfamiliar with or you're not really
sure what the consequences of these
actions are so that's why we made docker
was saying do you fault so that people
don't do this but you can also like even
see unbox applications even further than
like the docker second default profile
and not like the default you know app
armor
selinux stuff you can go like way beyond
what we did mostly we did what we did
because it had to work for a 99% of the
containers out there so to pretty much
stop people from ever annoying me about
if containers were secure I made this
website called contained AF and this was
like almost two years ago now but it's
pretty cool there's like this terminal
so first it was kind of just meant as a
game because I love like kind of
teaching people from the standpoint of
putting them into a weird environment
and then being like what do you have
access to what capabilities you have so
it will ask you a series of questions
like do you have access to happen at raw
so kind of like the thing you're
supposed to do is try to ping and then
when ping fails you're like no I don't
have access to kind of know raw so
there's a bunch of questions like that
but and it is kind of like a learning
exercise and it's pretty cool and a lot
of people I've actually added questions
this is all open source on github so if
you have cool things that you want to
put in there I would obviously weren't
it but there's a hidden game here as
well and that like I obviously opened
this terminal up to the world and if
you're were to capture a flag that is
actually on the underlying VM that is
running these you would have to bring
out the container to capture the flag
and if you email me then I will give you
like ultimate praise for the rest of my
entire life because I don't have money
to give away but like I would definitely
like make sure that everyone knew that
you were the coolest person on earth so
yeah there's like a flag with ASCII art
on these VMs and you know a lot of
people don't play the actual game that
is like learning about containers and
caps and stuff like that they're just
like no I want to capture the flag so no
one has managed to break out of the Qing
tainer and it's not because they haven't
tried they've definitely tried I've
talked to like a lot of security
researchers who have just tried putting
you know the latest hip proof of concept
of a vulnerability in there and I'm like
it's not gonna work like you have to try
harder than that like
anything that is just like off someone's
you know script on github is not gonna
work I mean I'm not obtuse but yeah so
why is it that no one has actually been
able to do it well it's because I took
the default icon profile and then I took
a lot of things out of that so basically
if you're going to have to kind of you
know bypass this like first layer of
security you need to use something like
ROP which is return oriented programming
so you'd have to gain control of the
call stack and then execute machine
instructions from memory there which is
a lot kind of similar to the stuff
inspector where you know he calls VPS
even though it's not enabled which is
really cool by the way
so yeah you'd have to do that and no
one's gonna waste their time you know
writing return-oriented programming for
my shitty web app like it's just not
worth the time especially when all you
get is my eternal praise and I don't
have anything on that machine that's
cool other than this flag event ASCII
art which I assure you the ASCII art is
more of a joke than anything cool so it
is totally a shitty web app like I wrote
the actual app itself in one day and I
never looked back like the action the
container it took a long time but that
was like years of work on docker and
stuff like that but the app itself that
is spitting up those terminals is really
bad there's probably race conditions
galore so what I tell all of them like
when these security researchers come to
me I'm like you'd be better off
attacking the app but obviously like
that's not as fun as like this terminal
that you have in front of you but even
if you were to you know find some race
condition which I'm sure there's a
plenty you'd still be running in this
container you know with at least the
default set comm filters like I didn't
really restrict them all that much
further but the default is really good
so they'd still have to then bypass that
which you'd need some sort of kernel
O'Dea for and I'm not sure anyone's
going to waste a kernel a day on my
stupid thing and I update my kernels all
the time so yeah
so a sandbox is kind of defined as
providing a net reduction in attack
surface and inside a container less
things are possible than on the posts on
the host machine so that is a sandbox so
containers are sand boxes as long as you
are using these really nice defaults so
if you want to do all the same things
that you can do on your house like I
personally use VMs for that mostly
because I love that container sourcing
boxes and I don't really like you know
changing that but or you could use you
know a privileged container which is
what we named it when you add all your
devices and stuff like that but just
know like that's not this sandbox
anymore because you just turned off all
the like really nice security features
that you got out of the box so yeah
moving on container icing in the desktop
which is like one of my favorite things
so at first when I containerized my best
stop like I showed a doctor from like a
few years ago I use docker for
everything obviously was docker falling
so then I ended up switching everything
to run see later on because docker has
this daemon and I was just like I really
like super minimal which is why I put
everything into containers like I hate
when arbitrary files are on my hosts or
like I install a package from apt and
then I don't know where all the files
might like I know that I can look it up
obviously but like I just it like hurts
my soul for some reason because I'm like
an insane me free so I would not
consider this for anyone else who is not
like OCD about weird files on their
house like I am but yeah so I ended up
switching everything to run C which was
cool and a lot of this was thanks to
Alexa who is here or has been at this
conference all week and he you know
merged a patch to make currency have a
rootless containers which took a really
long time to marriage but it's awesome
so you can spawn containers as a you
know non privileged user which obviously
you could do with unshare when you enter
a user name space and all this stuff
there is a lot of stuff that we were
doing with containers that made this
hard but now it's easy so previously I
use docker so I had to like convert all
my config
into these like run COC I specs right
it's just a JSON file but I made this
kind of tool which works sometimes works
doesn't so if you're actually gonna use
this I'm sorry I made a tool to do that
which was cool and then as far as
networking goes because run see doesn't
really provide any networking it leaves
it up to like a lot of other things I
made a tool for that too so docker has
this like default bridge networking that
kind of just works out of the box so I
basically just made a hook for run seed
that does the same thing it sets up for
bridge grabs and IP then in the ultimate
unix way it puts your IP in this file on
your host so you can go look at it later
or you know program around that so
that's pretty cool so at that point on
my computer like I had sandbox desktop
applications running in containers and
none of them were running as root so
they're all rootless containers and I
had all the sack comp profiles around
them and so I felt like pretty great
like my computer is clean it's super
nice so then I started at that point I
was still using Debian as a base I
thought a little bit OCD and I was like
I want even more minimal like I want to
use one of these like hipster container
linux's and core OS is really cool their
container for Linux because it's based
off Chrome OS so all kind of the
security things that you get from Chrome
OS you're also getting from core OS
container Linux so that would be like
read-only user and then stateful
readwrite for the rest so since it's a
read-only user you're like forced to use
containers because you can't like just
have arbitrary binaries on your hosts
and execute them right so that's kind of
cool because I was already doing that I
had everything running in containers and
you could also have auto updates I'm not
that insane yet I thought about it I've
started and then I've stopped and that
I've worked on actual work so that's
pretty much what's stopping me
but yeah there are like a few projects
that do like open source Omaha server
things that I've been looking into and
like one of these days I'm gonna get
around to doing it and then all you know
hate myself a little bit more for
creating this really weird world for
myself so the cool thing about like out
of the box from you know Korres
container linux is that you can verify
the integrity of the OS and a lot of
this work was done by a matthew garrett
it was also here so you get TVM support
and DM Verity which is super dope so you
can verify that like the root hash of
your OS is right and all I had to do was
add graphics drivers to the OS and since
it's also based on you know Chrome OS
which is built from gen 2 I just had to
like emerge the world which was hard in
the beginning but now I've gotten used
to it I actually also really like Gen 2
I don't think there's a Linux OS that I
do not like there's a lot of other OSS
that I do not like but Linux I love them
all so this is kind of what it ends up
looking like you have your secure base
and then your containers my comp it's
just like this very pretty world and
everything's in little boxes there are
little boxes on the hillside so yeah has
been a lot about containers so I thought
I'd take a break to talk about something
else cool and then there's all kind of
ties together in the end and like a nice
little bow so all these kind of same
like defaults that we applied to
containers to make them secure and all
that that was just bringing up features
from the kernel to user space right
like it wasn't novel at all like those
things were already there and you just
have to figure out how to use them and
then apply it to whatever you're doing
so like if you could almost do that with
programming languages as well it would
be really cool so as far as the layers
of abstraction go here is just like
kernel programming languages and like
what it's exposing the girl obviously
system calls and what programming
languages are exposing is like the
compiler and here standard Lib so the
idea I had here was to take a some go
code and as you're compiling it build
out these second filters based on the
code itself for the binary so that
you're using instead of using at like
run-time you know trying to figure out
what you need and what to lock down like
you're doing it at bill time based on
the code and go is really good for this
and I'll explain why because it made it
insanely simple for me to add this so
why even generates icon filters at Build
time right like you could probably you
know use P trace try to collect all the
SIS calls all that stuff I've heard
literally every single way to do it from
people and people have built things and
it I'm just not exactly sold on them
mostly because like generating these
security profiles and filters at runtime
it's been done in the past and it's
failed like over and over again it's not
because of technical ability you know
like you can pete ray something you know
run unit tests and then collect all the
things right but do your unit tests
actually like cover a hundred percent of
your code no so like something's always
missed right and this like profiling
phase so then everything breaks and then
the person is just like I'm trying to
get off because I like just can't even
live anymore
broke everything like nobody ever really
looks into the problem after that
they're just like nope
so yeah just as like to really drive the
point home it looks like this like a
user will start profiling chrome they'll
open some tabs you know maybe do a few
things go on Facebook whatever and
they're like okay that's good I'm bored
of this right you're then you apply your
generated profile or whatever and you
reopen chrome like maybe weeks later and
you're doing something else you're on
YouTube or something you're trying to
play a video and then like it's trying
to use maybe a graphics driver or
something that wasn't necessarily done
before I'm not sure chrome was the best
example for this but whatever you get
the point so then everything stops
working they can't like you know watch
their youtubes or whatever and they're
like eff this I'm turning it off so
that's kind of like the problem that I
have with runtime profiling which is why
I was like build time you can actually
ensure all the code is included in the
filter like even dead code which we
could rule out like you could include
that to you if you want which is kind of
neat at least you're like over killing
it versus under killing it so the go
compiler is really cool and that like
instead of relying on something like
Lipsy or something for the sis calls
they just write the assembly for all the
SIS calls
and you can just look at this in the
open-source co-project under this is
called package they have all this like
generation of assembly and you can just
like see exactly how they're laid out
and actually the assembly forgo binary
is I think it looks pretty clean if you
just look at it and one of my co-workers
and I are trying to write a disassembler
which will be cool so if you hijack the
part where it assembles the Siskel's and
just kind of collect them into an array
or something then you can get all the
ones that you are using and then you can
then go ahead and you know apply that to
a second filter on Rutan which is cool
then like your binary is basically only
allowed to do the things that's trusted
so yeah that sounds really cool
to begin with but there are a few
problems obviously so here's what
happened when I tried this there are
like definitely three problems that are
written into and some of them are minor
and some of them are okay so here's an
example of go code which even if you
don't know go you can probably read this
so I'm executive and imbibe I recalled
my program so I don't know what my
program is gonna do actually that's
already built that's already binary so
if I like lock down the syscalls for
this go app like it's not going to
include this as calls for my program
which really sucks and that one's hard
to solve unless you did some sort of you
know reversing a binary is but that just
goes down a really intense rabbit hole
so another one is go just added support
for plugins the initial support for
plugins is kind of so people don't
really use them so this doesn't make
that as much of a problem as well as
like the go compiler actually builds the
plug-in so we probably could add some
sort of like set comp header to them or
something like that so it's easily
solvable but still if you're you know
executing something else almost like a
DL open it's hard to also get what that
one's doing so opening plugins was a set
point and then this so this is called
package and go you can obviously execute
any sort of random syscall so if you're
passing in arguments to this like Ross
is call and it's not like an actual
call that we can parse that's problem
because I don't know what it's gonna be
and if it's up to even on run time where
you know you're passing it in through
the command line which this is a weird
example I don't know anyone who would
ever do that
you know it's really up to the user as
to what's going to be called and there's
really no way to solve that one which
kind of sucks but you know there are
ways that like I was even thinking of
just like if you see that one of these
kind of circumstances is happening you
just turn it off entirely and stuff like
that but I also didn't feel like adding
a bunch of code upstream and like trying
to get that in and doing the whole like
open-source politics song and dance over
this thing that didn't like work
perfectly but it is cool and I think
that there's like something here and
that like there are way there will be
better ways to do this in the future
that do not have these problems
necessarily or there will be ways to
solve these problems so that we can do
this because I think it would be dope
but yeah right now it's just like great
but rome wasn't built in a day
so yeah we could probably find ways I'm
still thinking about it like I'm
definitely trying to make fetch happen
and that will be it yeah so kind of
another place where I saw to kind of put
this same type of thinking of generating
perfect you know filters is if we come
back to our original layers of
abstraction right my coworker Brendan
Burns who is also one of the cofounders
of Cooper nice to begin with he just
built another layer of abstraction on
top of Coover nice and it's a it's the
standard library for cloud native
applications and it's just running them
on top of kubernetes so these this is
just a library that you can include in
your code and then it will self deploy
your code from from the code itself it's
really cool it's like self deploying
binaries if you think about it but the
cool thing is that library is in your
code so it's like a cool kind of point
where I think that we could also parse
the SIS calls and then create the
perfect those are and then applied that
to the orchestrator that was running in
the background so that's something I'm
looking into but yeah so still trying to
make fetch happen just elsewhere
yeah should be interesting so some other
crazy things and look into the future
here since we already have started
talking about the future I saw this
paper from a little bit ago where
they're running Linux containers
insecure enclaves so with Intel SGX so a
secure Enclave is kind of like in
isolation of separate memory and the
threat model for secure enclaves and why
you would want to use it I think
personally is for if you don't trust the
cloud but I think there's a lot of other
use cases as well but that's the one I
like most feel with I think so yeah I'll
just kind of draw this out for you so
most programs and container runtimes the
way they work today is like if someone
has super user access to your house like
it's game over obviously they can like
shut down all your containers they can
take all your like they have access
to your computer right so that's how
things work today and then like with
scone or you know running things from
secure enclaves if someone has super
user access it's not game over or so
that's the promise so scone assumes that
like an attacker has super user access
they have access to your physical
Hardware still if you think in terms of
the cloud it makes the lessons they
control the entire software stack right
and you can also run privilege code like
you can switch out kernels you can you
know do anything with the container
engine and blah blah blah you can do
whatever you want like you're on the
host it's basically a computer so what
this does not cover is daus's obviously
but also hey side-channel attacks of
timing or page faults which like that's
precious we all know that now that's
kind of sad because there's really not
much you can do but I'll still go over
like why this is cool or just like that
there's some interesting designs that
they come up with for this but kind of
teach about containers I guess or why
this is a really scary idea so they had
a few designs that they were looking at
and they wanted to keep the code small
so anything that's running inside this
you know secure Enclave needs to be
small
so that like if one of their
dependencies inside the Enclave has a
vulnerability it's not game over because
if you're already inside the Enclave
like and there's a Valle you're done
right so it's kind of like if everything
is in the sandbox then there is no
sandbox which is also why you should
keep your containers small and then
their second constraint was performance
in that there was there's just really
bad performance with all of this and
I'll go over that so the thread has to
copy the memory arguments and leave the
Enclave before a system call you can't
execute the system calls inside the
Enclave you have to do it outside so you
have to like pass all this back and
then pass it back over so obviously
that's gonna be super slow and then
memory pages for an enclave live inside
the Enclave page cache and then after
write cache mat miss the cache lines
have to be decrypted and then fetched
from memory so there's like a lot of
things that have to happen so there were
a few trade-offs in their design and
I'll go over kind of what they came up
with so the first one is based on
Microsoft's Haven paper and Microsoft
actually deployed SGX
you know integrations into the cloud
based on this paper but since
Microsoft's OS is built differently than
Linux you know this works well for them
and not necessarily for Linux or
containers mostly because if you look at
this there's a lot of things inside that
trusted layer and if you remember like
if everything's inside the sandbox there
is no sandbox this just like is way
outside the scope of what you should be
doing for you know Linux or containers
in general inside enclaves
so the second one they came up with this
kind of like the exact opposite where
you know the seed library is also
untrusted but then you're passing the
SIS calls right from this like shim C
code outside to untrusted and any IO
call like read or write you could
compromise the data from that call and
then it's just like game over as well
great so that super sucks
so you can't have it too small inside
the base it's really just like trade
offs little lower here so the kind of
compromise they come up with is kind of
the same as the other one but they made
this shielding layer so that whenever
syscalls are kind of passed into this
untrusted house OS they get like
encrypted and stuff so this shielding
layer is just a ton of code that
like encrypts you know IO calls like
read writes and receive they're all
shielded but you're placing a lot of
trust into this shielding layer and
honestly I think the main trade-off here
is like do you trust the code you write
or you know someone in your company
writes this shielding later do you trust
that or do you trust the cloud and I
mean I work for a cloud provider so I
think you know who I trust but yeah it's
just an interesting set of trade-offs
and when they did this they also didn't
support things like for cos ecker clone
which seems insanely hard to run in the
application without those but maybe I
just run really weird applications
because the threading model inside SGX
just like it just wouldn't work with
like the architectural limitations that
they had so you're really really like
shoved inside this box of what you're
allowed to do and it's just interesting
so when they looked at like kind of what
happened when they ran applications in
this because they were in like in
genetics memcache D and a few others
sequel I think so system calls being
performed outside the Enclave are
expensive like no you're passing it
back and forth and then you're also
having to do this whole like shielding
layer on it so any service that you have
that is very like hi system call you
know heavy is gonna be bad
surprisingly memcache D is not so it
performed really well which was really
cool but all the other ones that they
tested it was just a show so then
memory page vaults have a significant
overhead and then l3 cache misses were
really bad - there were 12 times as slow
and it almost makes me think like if you
are trying to do like a side channel
attack it's like if it's moving like
Flintstones speed
might be a lot easier but yeah so what
does this mean for the future like
Wallace is technically really cool I'm
not entirely sold on it and just because
of the amount of like code that you have
to write to actually get these sis calls
to work is insane that shielding layer
for one and then putting all that inside
you know the Enclave just makes me feel
not great about it and it's just like
this weird song and dance of passing
syscalls and like threading and it just
yeah if you if you're interested in this
read the paper because it's like it goes
into depth but I sure did turn it on
based on their Haven paper which is a
different one and it's cool you can play
with it in the cloud on Linux or Windows
the other OS so yeah that's kind of cool
but is it even worth it I I don't think
so it's such a performance pain you have
to write all that code and then you also
have to trust that code versus trusting
you know your OS or cloud provider or I
mean and honestly if you have so many
trust issues maybe you don't use the
cloud in the first place I'm not sure so
and it also won't protect against
meltdown or Specter
so that's funny back when I read this
paper that was not even like a concern
to me but I just thought it was funny
that they liked one of the one things
that it doesn't protect against our side
channels okay so yeah moving on to our
last topic and this is what I'm
currently working on at Microsoft for
like the open source kubernetes project
and if you're interested in this at all
we have a working group for the open
source project and we meet like every
other Wednesday and we have bazoom calls
and we're super nice I swear yeah so
multi-tenancy is a thing that a lot of
people want so we thought that like as
part of this working group we would
define kind of the levels of
multi-tenancy because right now like
there is no guarantee with kubernetes
that we support any sort of
multi-tenancy model like we could which
is the point of this but we need to
define it and then have some sort of
guarantee around like what you get and
what you don't get and then testing as
far as making sure your cluster is
configured
so that you aren't you know accidentally
setting one flag that you shouldn't be
or something like that so soft
multi-tenancy is the first type and this
is more like if you have multiple users
inside the same orc and and you trust
them you know you trust them not to be
malicious you could have bad actors like
someone you know leaving the company and
they're like you know I'm gonna go
delete Donald Trump's container but yeah
it's not necessarily the same threat
model as others you know and like users
aren't really actively malicious at all
it's mostly for like preventing
accidents right like you're not going to
delete your co-workers container
hypothetically or you know try to hack
it from your container by breaking out
so hard multi-tenancy is kind of the
more interesting one and this is where
you have multiple users from various
places or places in the same cluster and
none of them are really trusted right it
seems everyone in the class cluster is
potentially malicious like you're just
running Bad Dudes containers all day and
you don't know what to do about it so in
the case of kubernetes and a lot of
orchestrators like you have to think
about a lot of things and it's not just
the orchestrator that you are thinking
about you're thinking about everything
under that as far as what could happen
mostly because we build on all those
things so when I was laying out like my
design for what I thought hypothetically
we should do and this is all in a design
talk that I linked in the first slide
and I'll link to these you start with
like the base layer right so that would
be the host OS I mean technically you
should start with the hardware and maybe
do something without speculative
execution but yeah we're confined to
what we have so the hosts of us you
you're gonna want to use something like
one of the really nice container OS is
like I did on my desktop where you know
you're forced to run everything in
containers it's a really minimal base
and they have like really nice security
features there as far as Auto updates
and stuff like that and then as far as
the container runtime goes depending on
your threat model there's two ways to go
about this right so if you're just
executing any arbitrary code and you
have
no idea what they're running I would
consider using the glasshouse VMs and
only because like if they want to run
something privileged right that we don't
allow in our defaults like you're gonna
want a VM for that done but if it's
something where you can you know sandbox
it in ways that you feel great about it
then go right ahead I personally would
do that too
I think it's fine so network there's a
lot to do here mostly like the tools
that kubernetes gives you are really
nice so you can just set a default deny
all policy for ingress and egress so you
start from literally shutting off the
world to everything and then from there
you build up explicitly what network
communication you want between
containers and pods and all that so you
like just start from no and then go
slowly - yes base off actual code being
validated that allows these things and
make sure it's make sure that it's not
malicious DNS is interesting mostly
because if you're familiar with
kubernetes we have this thing called
cube DNS and it's like service discovery
and it's really cool but like you want
to make sure that your dns is actually
namespaces just like everything else so
each tenant inside your multi tenant
cluster needs its own kind of service
discovery DNS cool or just turn it
off entirely because I'm not sure those
features necessarily even come into play
here depending on like what type of sass
or like platform as-a-service you're
building on top of this but one way to
do it with kubernetes if you're familiar
is that you can run cube DNS that thing
has a sidecar and a sidecar is just a
container that runs in a pod with
everything else so it should share is
that same network namespace you know pin
namespace and then you're making sure
that you know no other tenant can you
know just yes maybe one of your services
so authentication and authorization come
into play too and we have a lot of
things for that in four days the best
one is our back
and depending on what you're building
like the main use case that we were
seeing for this internally was for a SAS
so we were running a trusted API on top
of kubernetes api on top of other things
you just need to know like what exactly
your requirements are here to know what
you need and what you don't need but
there are tools for going about this so
that's nice and then you want to make
sure that your master and system nodes
are isolated so like things that are
running these containers with
potentially malicious code needs to be
separated from your master which also
needs to be separated from your system
services so like Etsy D is our key value
store for kubernetes like run that on
machines that are not the ones obviously
running malicious code and isolate all
these from each other so that just the
agents running the code have only that
and that ensures that like the means of
communication from master to agent are
also not compromised so then you also
want to restrict access to host
resources obviously but so out of the
box with kubernetes like you can do
things like use a host path for volumes
and stuff like that so and there are
tools for locking that down via a pod
security policy these are all just
obstructions but they just like deny you
know mounting anything on the host and
you can also even shut down
you know containers from saying I want
to use the hosts Network instead of
using a network namespace or I want to
use the host pit instead of using the
pit namespace or I want to use the host
IPC instead of using the IPC namespace
you shut down all of that because you
don't want them to have access to
anything on the house and you can also
define in those policies like whether
you want the pasta run as privileged or
not so if you are doing obviously
sandboxing of containers you would want
to say no privileged anywhere so yeah
there's also a bunch of tools for that
and then everything else is just making
everything dumb to its surrounding so
like back in the day like when I worked
at docker there were a bunch of like
features requested to make containers
more aware of themselves like inside the
container and I was always against them
because I like my containers to be
like I just don't want them to know
about themselves I don't want them to
know about other things I just I would
love it if they were just like the
things and nobody knew what was
happening like I don't want a container
ID inside the container that people
could then maybe use for other things I
don't know you never know so I just I
just like to think that making sure that
inside that container everything is dumb
is good because then it can't get
knowledge about anything else in the
cluster and then you can't accidentally
you know shoot yourself in the foot and
not turn off something like that
so right now containers are dumb and I
like it so yeah to sum this all up
because that was a lot like containers
are not real things maybe they should
have been called boxes I mean I kind of
have a family of that now
definitely the VM containers should have
been called glass houses trying to make
that a thing naming things is super hard
but at least like you can't blame us for
serverless that one's super stupid but
like in all seriousness containers with
same defaults are sand boxes and when
you turn those defaults off you are
getting what you asked for so just be
aware of that and securing containers by
default was just like one piece of like
a brighter future so like if we were to
apply these same principles from
sandboxing containers like I tried with
programming languages and other layers
of abstractions and user space then
we'll have a more secure user space so I
think like learning from the past and
applying it to the future would be
really good here so hopefully this lived
up to so bad that it's good and that's
all</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>