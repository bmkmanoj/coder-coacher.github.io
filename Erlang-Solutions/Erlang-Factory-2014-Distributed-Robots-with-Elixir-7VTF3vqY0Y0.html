<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Erlang Factory 2014 -- Distributed Robots with Elixir | Coder Coacher - Coaching Coders</title><meta content="Erlang Factory 2014 -- Distributed Robots with Elixir - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Erlang Factory 2014 -- Distributed Robots with Elixir</b></h2><h5 class="post__date">2014-03-24</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/7VTF3vqY0Y0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">alright so hey everybody I'm Josh Adams
as he said in I'm Robbie Clement and
we're both from ice tub 11 it's a
software development consultancy out of
Birmingham Alabama we do a lot of ruby
in javascript and ideally we're going to
get into our leg and elixir going
forward alright so here's how you can
find us on twitter and github i've also
linked to elixir sips which is the video
series that you reference so if you want
to learn elixir i do that also here's
where you can find the code for today's
talk so just remember Erlang factory
robots anyway today we're going to talk
about writing robots and elixirs so
let's get to it alright so by the end of
this talk you'll be able to build an
embedded a pin elixir that controls
things in the physical world and connect
your app up to an Android interface
you'll feel comfortable building these
sorts of applications at least you'll
have a good feel for it you'll have some
example code that you can look at to
help get ever thomps also you'll save a
lot of frustration and missteps that
you'd have to deal with if you were
trying to figure this out alone we ran
into all the problems that you're likely
to face and we overcame them and
documented them all right so the talk
has a couple of parts the first parts
really just a brain dump lots of good
information on the library landscape
focusing on easy wins after that we dig
into building a project together and
we'll get a bit more complex all right
so let's go ahead and dive in the
surveys you got so first off what is the
robot well a robot is a force multiplier
it lets you take a simple action in
cause a cascade of more complexes lame
we're not going to have definition
slides in this talk we're gonna have
robots so let's start with hobby
robotics hobby robotics gets to take
advantage of what Chris Anderson from
wire dubbed the peace dividend of the
smartphone wars which i think is an
awesome quote we all know that
processors and sensors such as GPS and
Bluetooth have gotten incredibly cheap
and this quote gets to the heart of why
that happened and mass production of
sensors fallen maid javi robotics really
affordable
while the maker movement has made it
approachable and these are just some of
the great resources available I think
father personally there are arms many
client libraries for various robotics
tools as other languages I have for
instance we had to write the libraries
for the Sphero and the AR alright so if
the libraries aren't really there then
why is it looks or such a great choice
well not really any good reason we just
didn't find but seriously all the normal
reasons concurrency dsl's meta
programming and you can have fun riding
your robots not just playable so where
should you start well don't start with a
giant project it's really easy to get
bogged down in a simple hardware
problems such as resistor values like
when should I learn Ohm's law right so
we you know make sure to get some easy
wins up front to keep yourself motivated
and it's just need to find a sphere or
they are drawn and you just play with
them so this right here is a spirit
basically to fall of motor inside of
them and rigid control the Assyrians
resemble and are great for someone just
Barnett program they're really good for
teaching kids
you can see here then start our client
we call bowls roll square five times
call stop the stop function and then
makes our process and as our next
function is of course doesn't code
better but just so you can actually see
how easy it is to use these devices next
we have a whole square function and it
calls for all and sleep and that takes
this state the name lastly we have the
rolling sleep function and that calls
roll best eats take a seat of an angle
and give a teacher nice so
forward
now he's not in frame that's not
actually happening alright so that was
awesome so it was really straightforward
to port tinder loves Sphero library from
Ruby to elixir and I thought it'd be fun
to show some of it off so the Sphero
library very basically consists of a
piece that knows the commands a sphere
of cereal protocol responds to and a gin
server they can represent an actual ball
connected to a given serial port and
provide easy methods to issue those
commands on the ball so your request is
a module representing a given request to
be sent down the serial port we use a
struct which is based on the new Erling
maps to represent a given request it
comprises the necessary fields to fully
define the parameters for a request and
then the module contains functions that
know how to turn those structs into the
appropriate bit streams for the serial
protocol and then we build a gem server
its sphere a client you initialize it
with a serial port attached to the
Sphero and then you can just send it
basic commands it'll turn those commands
of their corresponding request structs
generate the bitstream and then send the
bitstream down the serial port and then
the rest of the code this is basically
all of the code for this Bureau library
the rest of it's just convenience
methods for building the various
commands at sports the other easy toy is
then he just didn't feed back to control
he's got a couple of video cameras
attached
there you go
alright so this is another one of the
libraries we had to build and so for
both of these we poured it from Ruby so
for this one we chose to port Jim yrx
Argus ruby gem because its design is
really good it's very object oriented so
I thought it would provide a more
interesting challenge as far as boarding
something from Ruby do elixir goes so
let's have a look at it it's a bit more
involved in the sphere library was so
the core of X drone consists of the
drone server that represents a given
parrot ar.drone instance so here you can
see the broad layout of the drone it
just uses a UDP cinder an 80 commander
and a controller and kind of connects
them together the UDP sender is the part
of extra on that's responsible for
actually sending UDP packets to the
ar.drone and so here you can see it's
just a thin veneer around gin UDP the
next piece is called the 80 commander
and it's called this because the air
drones protocol looks like 80 commands
from like a haze modem our huge modem
sorry and so this is a server that gets
ticked once every 30 milliseconds and he
sends his his current state via the UDP
sender and then the controller is just a
gin server that interacts with the 80
commander so it ultimately provides a
relatively nice interface for
manipulating the pitch the role in the
all which is then basically delegated to
from the drone server and there are more
like gin servers here than I would ever
use if I were building this straight up
in the lick sir but this is a port from
Ruby and so basically replaced object
instances with servers just to do the
port anyway so that's what we had to do
to make that work so now you've got your
easy wins assuming that use the
libraries and it right them and so
you're still interested in playing with
this stuff so what's next
microcontrollers so microcontrollers are
essentially tiny computers what makes
them special is there on a single board
and they have GPIO so let's talk about
them the Arduino showed up right around
the same time that make magazine did and
it had a huge impact on hobbyists
although everybody that was already
doing stuff with microcontrollers gets
really mad if you say that anyway it's
only a 16 megahertz device it has no
storage no networking and it has to be
programmed in c so now we have a whole
range of options from the BeagleBone
black to the pea seed we know which
offers a 1 gigahertz chip a gig of ram a
Mallee 400 GPU and an arduino compatible
pin out so you can take advantage
of existing arduino shields so both of
those are really cool but they're far
more expensive and power-hungry than the
almighty Raspberry Pi so with a
raspberry pi you get 700 megahertz of
compute 512 megs of ram and networking
for thirty-five dollars as well as lots
of gpio you can hook into so it's a
really sweet spot yeah and if I has
several features such as video audio USB
but gpio set up this loaded with wrath
in Linux so it's ready to go have the
box and you shut the power lambda links
are so getting her langham pi is easy
enough just fashion sources build
hardware modulation has a box really
going to get around loans
gyroscope or so longer us
the ribbon cable that attaches roots you
got me into a grand
oh yes since we're on the subject of
microcontrollers
in a way to control hardware you have
seen reports you just write to like
you're getting to a text file is have a
bluetooth USB or gpio but this is Erlang
so why would you do anything other than
use our length distribution to control a
thing and so that's what we're pushing
for and yeah so we'll get to it alright
so we're going to move on to the second
part so we're actually going to build
something neat alright so we've got some
easy wins with the toys earlier and we
showed you how to get micro controller
in LED blink but we can do better than
that going forward we have a lot of
quick code our goals i'm going to be to
provide code examples we hadn't repos if
you guys want code you can do these
projects yourself we're should indeed
mystify there's no bad
alright so blinking an LED from elixir
was cool but how can we get into some
more direct control of robots so
typically you might expect to provide
your own cereal protocol like the sphere
or the ar.drone offer but as I mentioned
one of the beams big selling points is
built in distribution so what I really
want is to be able to communicate from
an Android device directly to a remote
Erlang process and of course this is
possible thanks to Jay interface which
ships with early so there are quite a
few hurdles in the way of just running
Jay interface from within Android
luckily we vaulted all those hurdles and
we have lots of code that's useful when
you find yourself wanting to do
something like this the first hurdle we
run into and the biggest is the J
interface it just doesn't work if you
don't have EPMD running on the host so
we read like the docs and we built this
thing and we ran it and nothing crashed
but it just didn't send any messages at
all and so then we actually read the
docs and realized oh EPMD anyway so that
means figuring out a ship and start
Erlang on an android host so I'd love to
talk about how we did this because it
wasn't very clear at all going in so our
application our android application had
to launch the EPMD and the Erlang
processes due to Android sandboxing
before we could launch the processes we
have to get them onto the Android file
system in a location that are in that
our application has permission to do
stuff with so we're going to walk
through the process really quickly I
know you came to this conference looking
for java code and so you're going to get
it all right so here you can see the
code we attached to a couple of buttons
in our app copies are laying on to the
file system and it launches EPMD as well
as an erlang node and here you can see
the Android device having early and
copied out of a zip so we packaged a zip
with the Android app and then we have to
read it out of the apk and then push it
onto the Linux file system and you have
to do this once for each application
that use this method on it takes a long
time by the way like I don't know on the
order of seven minutes or so to copy
full on Erlang anyway so ultimately you
just don't end up with an Android app
that contains a button right that
triggers some j interface calls and so
each of these button presses is going to
send a gen cast to a toggle function on
a remote gen server running on the
Raspberry Pi
so here you can see what one of those
gen server casts looks like from Jay
interface so we just send the gen cast
tuple sorry we send a tuple containing
gen cast as the first element of the
tuple has an atom to the remote node and
then the second element is the actual
message you want to send and so we've
registered the remote node as LED and so
anyway to actually do this on Android
you have to request the internet
permission in your Android manifest
because somehow that's the same thing as
local network so otherwise you aren't
permitted to send packets over the
network interface at all anyway now that
we're sending messages let's see what
the server we're sending messages to
looks like so here it's a lick sir we
just used X actor to build a basic gen
server this is responsible for toggling
a pin it's the same code you saw before
basically but wrapped in a server so our
initial states a tuple representing the
state of the pin and it starts out off
and then each toggle cast will write the
new state to the GPIO pin using hurling
ale and then it'll update the server
state all right so next we actually run
one of these servers we register it with
the atom LED and with that we basically
closed the loop so in theory Android can
talk to elixir around the pie nail so
enough of the theory let's see if it
works
alright so it works so what's the next
obvious passed a single red LED and I
think that's a single RGB LED so let's
make that happen so a problem here is
early al only supports the hardware
pulse width modulation we'll get to that
later so anyway if you wonder why we
abandon it alright so you can use pulse
width modulation to simulate analog
levels all you're really doing a
switching a pin on and off but if an
output pin is switched on for ten
percent of the time and it's evenly
distributed then it looks identical to
like a ten percent analog signal coming
out of the pen so you can use that to
change intensity later will actually use
pulse width modulation for what it's
meant for which is logic level stuff but
for now we're treating it like fake
analog and on the Raspberry Pi you only
get one I want to give EMP N and we need
at least three for artbeat project so we
ate software
alright so here's a really basic elixir
module representing our RGB LED so it's
a normal stateless module it uses a
couple of Records to represent a single
pin and the full RGB LED component and
then the anit function generates one of
those component records representing the
LED it also supports asset value
function and a PI biased function when
we pie blast if you look over here we
actually invert the value you can sort
of barely see it we have the inverted
value and that's because our LED has a
common cathode and so we actually have
to send like the inverse of what we want
to send and then hook it up to power
instead of ground like it anyway anyway
we then wrap that with a basic gen
server and we expose this via Erlang
distribution and then on the Android
device we have a basic color picker
there's nothing fancy here as you change
the slider we want the LED to be
updating in real time so here's some
code from the Android app so what we do
is we have a timer task that runs once
our sorry 10 times per second and it
samples the interface and then it fires
a message using J interface based on the
current state of the app and so here is
preparing yourself to talk to a remote
node so you can see we create a mailbox
for ourselves and then we just ping the
remote node and that sets up the early
distribution and then here's how you can
cast a message to a gen surface from J
interface we talked about it a bit
before but so here we're casting for
different cast so we cast a value update
for red green and blue and then we cast
the blast which actually triggers the
pie blaster commands so a value update
looks like this it's just a tuple that
whose first Adam whose first element is
the atom representing the color and the
second element is flow number
representing the value and so while this
is Java it's very clear what we're doing
from an erlang perspective here and then
actually casting just wrapped it in
another two point anyway so let's see
how it works
you
alright so we have poked with modulation
controller can relieve some process from
Android now so what's next well this is
the bad tube and you can get twin just
like him source about two dollars and
was once loved by a child to be thrown
away can be yours to love again only
it'll be waiting Ross let's finish up
and build a RC tank alright so what
you're going to do is you take a
sabertooth to buy 12 RC motor controller
costs you 65 bucks you get a raspberry
pi you get a 12 volt battery you take a
syrah go Wi-Fi Bluetooth thong when we
talked about you take a mutilated USB
micro cable you put it all together and
you end up with this so yep that's
roughly that guy anyway so the
saber-tooth is the motor controller that
we use in this project so let me just
explain a little bit about how pulse
width modulation works so 1500 these are
micro second pulse widths means it's
idle 2000 means go all the way forward
1000 means go all the way in reverse and
obviously there's a gradient between
these and then you have two signals one
for each motor so it's not very
difficult here's the interface it's just
two sliders map from negative 1 to 1
this is your standard tank steering
interface controls alright so here more
Java code this is very similar to before
it just generates a different cast right
so this sends a cast to say update the
left and the right values anyway you
hook it all together and we end up with
an Android remote control interface for
a tank so let's look at the elixir code
that is going to be running the server
this guy tries to talk to ok so here
we've got a motor module it represents a
single motor it takes the motors pin
when you initialize it it supports a set
speed function so this maps the value it
was given to the appropriate PWM level
so you can give them values from
negative 1 to 1 and he'll map it to that
1015 to 2,000 micro second pulses and
then mapping the value as i said just
can consist of some pretty basic math
here we have a tank module so it
it controls two motors it's not very
hard to follow it creates to motor data
structures wraps them in a tuple and
then delegates to motor to set the speed
for each of them right up I blast each
of them so finally you can see a quick
server that we wrapped around the tank
modules so this is what our J interface
calls are sending messages to so it uses
a tank that we just saw as at state and
then it just delegates the update and
the blast functions to them and so
here's how we run it we spent up an
erlang node running our IEX console we
launched the tank server we gave it pins
23 and 24 which is obviously what we've
hooked up the motors to and then we
register it as a raspy tank and so here
with the code you saw we have a remote
controllable tank running on a Raspberry
Pi written an elixir so I'm going to go
ahead and show you a demo of it and I
what I mentioned that after we had a
repair on the tank and one of the motors
was wired up backwards so instead of
getting a sweet and have a screwdriver
to fix it so instead of changing it by
rewiring it we just changed in the code
oops
nope oh my god he actually died Nana I
think my android node my early node went
away an Android hold on woohoo maybe
maybe not oh no he's fell off the
network all right then well we can show
ya won't be in a video yeah that's kind
of miserable will show it to you later
anyway we'll hook him up after we get
done um anyway this is for rom anyway so
thanks for being attentive this mostly
wraps it up although we will hook it up
and show you a driving and as a generous
thanks for attending our talk I still
blevin provided free iPads under
everyone seats no one ever looks did he
look alright so this is of course we
didn't do that
I'm gonna hook him up again yeah I don't
know why he just lost the actually I
don't know whatever
it's going to take a little bit
oh goodness
I was for you guys is enough for
we didn't I don't know that we had an
infrared LED ever made LED marks be led
he's registered I think his batteries
could put we charge his battery all
night but literally using the motor made
him drop off the network sweet no I mean
it's all oh did he come loose no that's
not that's not what happened because he
would at least be getting as messages
over here oh we oh god that's a meat
you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>