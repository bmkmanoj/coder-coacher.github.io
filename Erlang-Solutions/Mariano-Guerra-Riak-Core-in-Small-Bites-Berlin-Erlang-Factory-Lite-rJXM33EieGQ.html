<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Mariano Guerra - Riak Core in Small Bites - Berlin Erlang Factory Lite | Coder Coacher - Coaching Coders</title><meta content="Mariano Guerra - Riak Core in Small Bites - Berlin Erlang Factory Lite - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Mariano Guerra - Riak Core in Small Bites - Berlin Erlang Factory Lite</b></h2><h5 class="post__date">2015-01-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/rJXM33EieGQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so we better match the functional don't
comment to to match all the comments
that we support by default we only
support the pink comment and we reply
punk and the partition of these of these
Vinod and the state if we updated it in
this case we didn't and a default
catch-all and uncommon to to diagnose if
someone is doing something weird so now
the Erlang is about scalability and
things so let's do a cluster for pink
handling so we instead of make rail we
don't make Deborah when you run on a
real quest placer when you have four
computers and you want to deploy a
record cluster you will do use this make
rail result and deploy it or copied to
the four nodes and run it but since we
are this I have only one computer we
want to run all the notes in one
computer to do that we have to make
little changes to each node so they
don't collide with each other because
they have to have a different name a
different if they have to use different
parts when you deploy on different
machines all can use the same part
because there are different machines but
in this case this terrell a helper it
does all the hard work of offsetting the
parts and creating different
configuration for each one with these
chains so it will create my default for
releases with these different changes
and we can now start we say it great
under the tape holder by default that 1
the 2 the 3 to 4 which are four releases
so we iterate over them and start them
and now we can with the same comment do
ping and we will get long if it works
but we say ok yeah we have a craft
cluster let's say let's see the member
step status this is the other comment
the real core template provides a is
that mean and so we ask show me the
information about the members of the
cluster and it says just one and did
after the name do you have the number
which it will be one two three and four
and say there's only one and say that's
where I just started four nodes and you
ask the dev for so we have the fourth
note it tell me your cluster state so
let me say one node cluster only myself
this is because you just started the
notes you didn't tell them about the
other ones they they have to discover
themselves so to actually cluster in the
nose you have to send a with the flabby
up in common the cluster join suit
comments and tell them one note of the
cluster so we tell the notes two three
and four about the first node and they
will stage a joint request that means
they won't join at the beginning they
will say ok there's a test to be run and
it's about joining a cluster so we have
to do a two-step thing we can see if we
see the status of the cluster alien it's
a form of classroom now so we actually
have a crosser and but three are joining
and if you wait and wait and wait and
keep doing member status they will be
keep still be in joining so what you
have to do is ask the cluster after day
yeah as one of the nodes of the cluster
what's the cluster plan what changes are
staged to be actually run in the future
and it's not that I just want to have an
exercise you cannot commit you cannot
commit a change without looking at what
the touching movie if you run directly
cluster commit it will say no just look
first at what's going to be committed so
you have to run this cluster plan before
class will commit and it's a healthy
thing to do so it says the change the
stage of changes is three nodes will be
joining and
and after the cluster transitioning you
will have this cluster state and it will
result in transferring a V notes from
the one node to the others so we will do
the transfer 16v notes to number 43 into
this is because when you join a new node
it will from this 64 virtual nodes it
will take some of them and give to the
new node and it will also meet that it
will require if you have some data that
now you will have to transfer it we will
see later how it that it's done so we
commit the change and well if I ran the
comment faster these numbers will
convert to twenty-five percent but they
start a 0-100 and day when the notes are
being transferred it converges to
twenty-five percent and let's try a
cluster so now we say since we already
have the notes running we don't say
console we say attached and it will
attach to their running out and give us
a console in this case we are attaching
to the known number one we can attach to
any node Widow ping and we get a number
and we now we attach to the node 3 and
run ping and we get pump back so it's
working or this it looks like so now we
have a cluster replying pings which is
interesting when you start but it's not
you cannot go out for funding or
something with that so let's add a
comment let's start simple so we will
add a comment that will do some
calculation basically add two numbers
and still won't be something really
interesting but at the end we will have
something useful actually so we add a
new function
the flower that our module which
receives two arguments this is the API
you would just wrap the internals so
this is you have to do it as easily to
use as possible and we do the same
basically but now they were the key that
we hash is on the first hitting add or
comment that tends to be done like that
the first item is the comment you want
to run and I said second eaten we
convert the total of the two numbers
that we are adding as Twitter double and
we convert it to binary that means that
why we are doing that because now if you
had the same numbers twice you will get
this thing double here which will get
the same document ID which will result
in the same index so every time we add
the same numbers we will go to the same
virtual mode that's like distributing
the load you have to decide how you want
this video in this case we're
distributing accordingly to the numbers
yours addy so we do the same we say okay
give me a preference list of notes to
ask for this for this test for this
comment to be executed and we hear what
it changes is the comment we're passing
here before we pass being here now we
pass at AMD because we need to pass all
the information it needs to execute it
so and now on Flavio vinod we add a
extra utter match where we match the
comment we pass and we replay reply a
plus B and the partition just to see the
number just for instructional purposes
but now we have to build the release
again because we have called changes of
course with our line you can do hold
call loading and stuff like that but I
didn't reach that part so and I don't
know it's easier to just remove you
remove the release and make the release
again and connect again
so now we play with the console we are
two and five and we get the result
hopefully okay and if we add the number
again we get the same virtual note but
if we had a different number we get a
different vinod and it's consistent
that's called consistent fashion so for
the same hash key you will get the same
vinod so now we are adding numbers this
in a distributed fashion we may want to
keep some state on the beam out because
right now the Vino the say doesn't
change with the things you'll the
comments you said so it for to start
simply we will keep a count of how many
operations that we note handled you can
imagine they extrapolate these to keep
metrics well introduce XO meter
something else but you could keep some
counts fear of internal operations or
something like that so we add a new
field to the state record and now we
match the ops count on the state when we
get the earth comment calculate the new
count set the new come to the state and
when we reply with the addition we and
the third place we return the new state
you get a state on the call and you
return the state that you want to use on
the next call to the v note so that's
how you keep state this is really
similar to change server stuff like that
if you already know what to be and now
that we have this account we may want to
ask all the v notes how many operations
have you handled already so on a
traveller we add a new function called
stats that will do something different
we will call coverage fsm start stats
and a timeout you can get ID here it's a
finite state machine I don't remember if
it's provided by the play
or just copy and paste it from project
to project because it's a just a PFS em
he said as a generic behavior it just
asked all the we note for a comment gets
the results and if it gets all the
results for Moby notes before time out
did returns that and if not it times out
I will cover this code here because it's
a finite state machine and it just does
just that and I started by copying it
and pasting it and you can keep doing
that for a while until you have time to
wait to go but what we have to do is we
have to add the fsm declaration on the
supervision kirky here if I'm not really
good at all I'm OTP able to be a part so
if you see that something is from here
please tell me after because if you
don't add these to the supermajority you
will get an error something about the
whole process or something like that
it's documented somewhere so now we want
to handle this stutz call because for HP
note the coverage Cole will ask for give
me the result of this comment but is a
coverage call is a call that's done on
all the windows not on one or a set but
on all of them it's useful to for
example ask for example statistics or
how much disk space are you using or how
busy you are something like that so it's
handled on a different place it's not
handle comedies handle coverage but it's
the same you pattern match the comment
you get a different set of arguments the
interesting one is here a ref ID on a
three-team topple you have to return it
because the fsm will send you a call to
handle coverage with the red a rough
idea it will wait for the for the same
RFID to know who asked because there
will be many be not answering that so we
reply with the top with the ref ID and
the second
place we can return whatever we want in
this case we're in return a prop list
with up count and apps on and the value
and we return this data as we have it
and we also have a catch-all 22 at this
log when we are doing something wrong
now let's queried well in now every time
I ask some new functionality you have to
build a release again I want displayed
in the following slides so now we call
value stats and will return ok and a
list of a lot of output that output is
c64 or the number of V notes times this
really what HP no replied so we will do
some operations so the upscale changes
for some Reno's and we get the in this
case we will get Audrey results with 0
because we just started cluster all the
windows are clean they didn't handle any
operation but after after we do some
operations we call it again and some of
them will have the ops come to bigger
than 0 we just filter only for the ones
that have outcome bigger than 0 and we
get that this be no handle three
requests this we note handled one and
this one due to in this case I'm running
because make r l will create create am
one release and it will be a one node
cluster but if I have made lake ariel
here the number of the node may be
different because different nodes in the
cluster would handle the request now we
need to tolerate false inner additions
because i know maybe sometimes its face
so we will do a quorum base what will be
quorum based reads and writes in this
case where it not really
writing but just calculating and for
this we also use a finite state machine
to handle the request and response this
finite state machine is a little bit
more complex so i did a highly advanced
diagram it starts the fsm certainly need
prepare execute it sends the common to
all the nodes that must handle it and it
waits until the remaining ones we have
to tell the these finite state machine I
want to run this comment on five notes
and I want you to reply me when at least
three of them reply to you so you can
say okay if it's a write operation i
said i want to i want to write these two
three different v notes and whenever one
of them replies i consider it a success
success or you can say three and three
that's a configuration thing on your
system when there are no more remaining
it finishes but if a timeout if the
timeout happens before all the ravine
oats reply you will get timeout so we do
the same thing we changed a little bit
here they Mac what we are matching on
the comment we match a ref ID as before
because since we will be sending the
comment to more than one know what we
want to know which not replied back so
we do the same here but we will play
with the ref ID and add will change a
little bit we had em and w you will find
him I use the names that people tend to
use for those and is how many note we
want to send a comment no W is how many
note we want to set the comment and n is
how many we are waiting for replies in
this case we are sending the addition to
three notes and we are waiting free to
reply to consider it success and we are
timing out if it lasts more than five
seconds to do so we did a pretty generic
if I set forth at that can I use it in
this project for all the comments so we
said sent MW and the comment and were
wait for the as a reply we would get a
request ID and we have to wait for it
they tell you take the function is just
received a waiting for that directly to
come back or timeout so we add some
numbers and you see now we get ok and a
list of three items because we are
adding the element 3 times we get the
result for each I'm the partition ID in
this case if you're doing something more
complex in addition you may want to
check like I think recalls read repair
right prepare a if you read and you get
results back you can check that the 31
they treat not all of them the notes
that reply to reply with the same
content and if not then you have to
decide what to do about it that's a
that's not a real car because that's
something that is it belongs to your
altercation so let's do it more
interesting because I think numbers and
ping is not like something really
exciting so we will do some kind of well
I have a problem that's a I i live in
here in Germany I'm Argentinian and I
work in software so that means that i
write in spanish english and german and
my Argentinian friends don't care about
my German writing and a lot of my
friends don't care about a lot of stuff
that I posed for example my programming
friends don't care about that my other
things that I post so that is to build a
distributed a message a store with
channels so basically is like Twitter
but you have different channels you can
say send this message to this channel to
this channel to this channel and it will
have you will have multiple stream not
just one so this carrying on a mega RAM
did a library that does exactly that it
just persists the messages to disk and
allows you to read it so we will just
use it
and the interesting thing is that he did
the same at the same days as this
presentation was being written so what
we will do here we will have a new
command called post message with a
username a stream ID and the message you
want to post and we will do the same as
before n3w three-time out 5,000 and we
the operation will be postmessage
username stream message and here is in
an extra parameter which is what will be
used to hash the comment in this case
all the all the messages posted to the
same username and stream will go to the
same V nodes we want that because when
we want to read from a stream we want to
know that all the messages that we send
it to that stream are in the same node
so that means that for a given user you
may have some strings on samba notes and
substitute some other he knows and we
wait as before so now the comment is
even more complex and it has some
interesting properties we match ref ID
post message username stream message and
the partition and we create a path with
the partition string username three men
message we ensure that the directory
exists we've opened the stream we create
a message and we append it to the stream
and we get the ID and we return the
entry with the ID of course an
optimization is not to open and close
the stream for each message we it's not
how you scalable but you can see we use
partitions to build a directory tree we
use the partition I did because I keep a
note a given physical node will help it
theoretically or normally more than one
vinod if you have a one node cluster
with 64 vinos which is a default you
will have 64 vinos running on your
and if you are for real notes you have
no 64 divided by four so when you're
writing you have to ensure that each
vinodh rights to a place / fix it with
the partition that itself has otherwise
all the v notes on the same physical
note will be writing to the same place
and that's something you don't want oh
you may want I don't know it's easier if
you just be fix all the directories with
the partition ID so we will post a
message my user in English and I get a
reply with the it's a record it has
other fields but by default you can just
provide the message it has a time stamp
and ID you can provide it to your
location and we post again in Spanish
and to ensure that it's actually written
of course we build it again and we learn
the console and we're at the comment we
do see d2l klavier which is the base
folder of the release and we look for
files that contain messages the name
messages and we can see that it's three
times for English and three times from
Spanish that means that the this the
fact that we asked 3v notes who write
the messages is working because we have
three folders with the message we wrote
and three folders with the English one
how am I two minutes left whoa well I'm
not the father and we want to read what
we wrote so we basically implement a
common cold get messages which is does
the same but instead of writing we read
and we tried and works yeah and now we
use coverage for something more useful
instead of asking
how many operation you handle you can we
can ask which are the strings for this
user existing streams or which are the
users of the system which is the same
basically oh I won't cover handle you're
lucky about that but you can ask me
later handoff is the hardest part the
process is like this is the process you
have to do to transfer information from
one node to the other when I we know
this trumpery so you have to impregnate
the end of call back and you have to
implement how to encode and decode the
items as they're transferred this is I
have written a lot and read about this
so you can read it there and to try to
build a node you starve on caster right
into it and then join the other clusters
and confirm that the data moved and all
has log so you can see the process going
out and you can confirm that the data
mode by listing the directories in the
nodes and I'm out of time but you can
provide a nice HTTP API for your
messaging thing and of course you can
leave that well next steps is to catch
the stream handles to do pops up over
Cabo with ballot and to use Reaper
security participation and permissions
and I love you I this is an ongoing
project the project is there each step
on each slide each step of slides is a
comment on the project and it has the
biggest readme ever is 32 pages framing
explaining everything I did for its
commit and link to the committee and
this is the real story developing for
storing stream of events and you can ask
me outside whatever you want
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>