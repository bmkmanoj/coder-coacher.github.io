<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Cuttlefish  Easing the Pain of Configuration | Coder Coacher - Coaching Coders</title><meta content="Cuttlefish  Easing the Pain of Configuration - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Cuttlefish  Easing the Pain of Configuration</b></h2><h5 class="post__date">2014-03-07</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/rJmYoPvppRE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">alright i'm joe devivo I man erlanger
bash oh and i'm here to talk to you
about cuttlefish and eating the pain of
Erlang application configuration so um
if you got an erlang application you
probably know we probably can figure out
with a config says config via Marz you
know dash config comes for free with our
lying and that's all easy so we use that
and great you're writing an application
because you want to solve some problem
and configuration isn't it so use these
guys and you get to the real work you
want to get to that's what happened with
react what we got here is a this the
react config I used to deploy my first
react at this is 0 dot 10 dot too and
what we're looking at here is about 10
to 12 lines of configuration that you
actually need to change so so great you
know you're a couple inline comments
here tell you what to do so great you
turn your knobs and good we got to get
on to writing databases anyway well
almost because here we got the vm ours
file may or may not be familiar with it
but i guess i guess most of you are
because you've got to configure this
name thing that's not you know that's
not something you can skip so yeah we
got to touch two files we got two
different syntaxes here that's great
because um cuz why because you know what
kind of file you're editing and I don't
know it's not that great but it's fine
because I mean it's small font but you
can see this is really all you had to
deal with you change these couple of
things you look at all the configuration
files you close them you know it's right
once and forget so we're moving on and
we don't really have time to deal config
files anyway I mean our job is to add
features and make real react more robust
and these files take care of themselves
+ OTP says to do it that way and I don't
want to make this little guy angry so
great that's one less thing for us to
decide we'll just go back to writing
database so the problem with this
approach is that configuration is a part
of your applications user experience and
deserves a little bit more than that bit
OTP gives you for free I my purple izing
a bit here but I take the reapplication
API for example we've got HTTP interface
we got a protocol buffer interface we've
got client libraries but what are we
really doing we're really writing keys
and values to data store so why do we
need all the syntactic sugar when RPC
call will work just fine from any Erlang
vm yeah well it's you know it's not
enough because we don't want have to
force users of react to use the airline
vm and you know even more generally you
shouldn't have to know Erlang to use
react so why do we feel it's ok for for
you have to know Erlang to configure
react well it's easy it's not so welcome
welcome to react to 0 we completely
changed how you configure react for a 20
release what we've done is we've taken
the app.config taking the vm ours bed a
little love and we've taken out a bit of
the complexity and what I'm giving you
today is react off what do you know
about real cops just been looking at
this one slide there's only one file see
it just one to look at it only has one
syntax so they should even have to say
this but the fact of the matter is that
we had two syntaxes before and so it's
great now there's one everything you
need to know about a single
configuration setting it was on a single
line in this file which which is great
because you can actually use you know
command line fun like grep and so like
that's actually find out what a thing is
set to and within our lab config you
actually you know it's a propolis of
propolis so you have to have context for
where the setting is before you actually
take a look at it so this is good it's
you know it's very clear it's very
simple another thing I really like about
this is that line can be anywhere in the
file because you know you don't have to
be aware of what module you're
configuring what / what library you're
configuring you don't have to wear be
worried about like bliss syntax that
line doesn't change if it's in a
different place you don't have to worry
about Trent like commas or like anything
like oh my god you know I set this thing
and then commented it out and I'll show
you an example later but you know these
little things where you want to change
one thing you should only have to change
one line and so you know I got thinking
key values pretty good idea started
writing a lot of sis cuddle less about
any because any saw is that causative
groups which doesn't give us that whole
everything on one line thing and it
looks like this now what we're looking
at here is a lot of comments because
comments are still important
documentation in your configuration you
know what people are doing when you open
up this default config file for react
what you end up with is settings that
you under
what they're doing because they kind of
tell you so on this slide we've got to
actual settings in all this on all this
comments are these two down here and
it's just you know key equals value if
you set something more than once the
last one wins this means you're going to
pend to a configuration file and effect
change it's great for testing it's great
for you know developer testing it's
great for automated configuration and
deployment tools there's built-in
documentation in the configuration you
can use this command react config
describe and then talk about a config
setting let's give you documentation
it's going to give you the data type
what's that you don't know yet default
values what you've said it too if it's
different even if it's the same it will
tell you you're still using the default
and then this little line down here this
one little call back to our days of your
with Erlang app configs you know this
used to be that and if you're an ER line
developer that may still be important to
you and will tell you about that so yeah
configuration values have data types we
can actually specify something like the
search solar start time out is a
duration in seconds and you can specify
the default value is 30 seconds but the
Baathists we've set it to 45 you can set
that in minutes hours days weeks
fortnight's but nothing bigger than that
because everything else is you know
variable time durations try and tell me
how many milliseconds is in a year it's
noxious but I don't want users doing
math about milliseconds now they don't
have to so this is all this little
artifact of what's happening here and
i'll get to that remind me i'll get
don't run me over my myself so
configuration values can be validated
what that means is you know you're
actually we're actually reading these
values and not only saying like you know
is this a valid term in Erlang you know
we're saying is this the thing that
we've accepted for this value and you
know we'll get to that more in a little
bit too but when you validating config
if there's an error in the configuration
you'll get a decent explanation you know
log messages for humans it's not a dream
it's here take a look at unknown key
this is when you try and set something
that you shouldn't be able to set you
know anti entropy we've got active and
passive and entropy and react
choose between them I wanted to choose
passive but I spelt it wrong i typed
anti and trophy because i thought i
would want a trophy today and had that
in the brain so what happens while I try
and start react and it tells me no you
can't because there's no setting called
anti in trophy did you mean one of these
it does some Levenstein string math and
tells me oh yeah these are the three
things that are closest to that error
and that's it so now I know yeah that
that didn't that didn't do what I wanted
I let me go back and fix it same thing
works for value we have complex
validators for value and what we can say
here is that the ring size for react
must be a power of two 42 is not a power
of two so I tried to start it up and you
know a complaint about it so what
happens after it complains well if
there's an error in the configuration
react won't start and we talked about
whether or not to actually do this and
we landed on doing it because what
happens if you're in the situation when
you try to configure a reactant owed to
do something and then you think that
you've succeeded but you've actually
haven't because you you know your fat
finger and anti in trophy before well
you start up your node you think it's
doing something it's doing something
else that's an inconsistent user
experience to me and so I what I want to
do is on start time just tell you hey
you know you your your impression about
what this note is about to do is
incorrect you can view the effective
configuration of Iraq node you can say
at any time I mean there are a lot of
default values that are set and
everything should have an explicit
default and I'll get to that in a little
bit but when when you don't set
something there are still value that's
usually associated with it sometimes
people like under the hood or using like
the application module and you use set
get m3 and that's how the default is set
I don't like having people having to dig
through code to find out what the
defaults are so cuddle fish like
provides a default syntax and well we'll
get to that but anti entropy active is
the only thing that's actually in the
comp file all these other anti entropy
settings are things that are defaults
but you can see them with the effective
config yeah I got the idea from Haven
it's not all bad so yeah there is a
definitive place to look for default
configuration settings for for humans
it's the documentation described command
that we were talking about before
for programmers it's it's something else
that we'll talk about a little bit but
most importantly there's no Erlang
required we haven't talked about any
Erlang yet nobody's done any airline to
configure this react node and I think
that's really important and why is I'll
tell you later but as far as react to
elbows you can upgrade from react 20
from react 14 and you can use your app
config and vm args as they exist
cuttlefish is smart enough to say oh
you've got an app config Envy mrs
already just use those and you can
migrate your settings to react conf at
your convenience and when you delete app
config and vm market will just start
using those now caveat there is
sometimes like in a big release like 20
we introduce new settings and when we
introduce new settings obviously there
are no defaults in 1444 settings that
are introduced in 20 so we'll actually
just use the defaults not from
cuddlefish but from the application so
just you know use react conference
better new cool command-line food with
config files that work like this you can
you know cat I don't know if you can
read that but I'm cutting the comp file
for and searching for lines to start
with anti entropy but then I can also
cat the effective config file and see
all the lines with anti entropy and see
all the different settings that are
actually in place here and then my
favorite you know this example here
where I look at the effect of config for
the anti entropy cartoon limit it's too
I want to echo anti entry concurrency
limit equals 4 into react conf well now
the effective config says it's for so
you know this is just this is just the
last right wins thing again but I think
it's cool so there it isn't much lied so
what is cuttlefish cuttlefish is this
configuration tooling it's available for
everyone for every airline app you can
use this it's it's not just for react
and if you want to use it I'm going to
try and convince you now you should it's
pretty easy so cuttlefish is in lighter
Lang library for human readable
configuration files it's a pun on sis
cuddle in battle and Babel Fish not
battle finish that's ridiculous so why
use it well if you don't know Erlang you
probably don't like the syntax you know
the Erlang syntax debate rages on it's
it's terrible but you know bottom line
is it isn't a great syntax for
configuring things and it's not that
it's a bad ending I like it
um but configuration files are your
applications first impression on the
user and what airline configuration
files are going to do is tell a user
your application is harder than they
think it's not hard to configure things
especially when you're writing or line
config files and you know or lying it's
easier for you guys to configure these
things but it's not easy for them and
they get scared don't spook them you are
not your applications average user if
you've written this Erlang application
we're talking about and you have users
in mind you're probably no longer
qualified to answer the question would
my user mind interline config file I
mean you've written an erlang app at
this point so you've fallen in love with
the syntax and it makes perfect sense to
you and you you can't put on your
outsider hat anymore it's fine you know
I've done it myself if your user doesn't
know about your app config your ops team
is your user so you know make life easy
on them too it's a bachelor we ship
react to customers and they deploy it so
we have to worry about what our config
file looks like but if you don't
somebody's deploying it maybe they see
the next s to you but be nice to them so
cuttlefish generates all the app to figs
vm args that growing or lying bm's love
what this means to you as a developer of
early applications is that you can still
use the application set get and
functions to pull configuration out of
this thing you know use this syntax as
easy for humans and then it converts it
to a syntax is easy for early you're bad
configuration should fail fast with an
erlang app config and the application
module some of these settings don't
actually get read until when a services
starting or you know at some point not
necessarily start time and if you have
some sort of invalid config value that's
a valid or lying term but maybe you're
expecting an integer or something like
that it's not something that um that may
be obvious right away at start time so
you know we're talking about let it
crash a lot here today but I'm talking
about don't even let it start you know
if there's a problem tell people and let
them get it right from the beginning a
validated configuration is an easy way
to prevent like early user errors you
know people that are starting to use
your product and they get complete
ripped up early in the configuration you
know you might be handling support
tickets for them you have a you know
handling developer resources on these
problems that that should be something
that we can programmatically explain to
people so simple configuration errors
can be avoided and avoid you know a bad
you know bad first taste in the mouth
for this application product upgrades
can be smoother when when people upgrade
from react open-source to react ee there
are a couple extra config settings in
the app config that they need to add the
boilerplate config if you don't add it
your node won't start and it will be
kind of cryptic as to why because
they're lying so we wouldn't be are
lying if we weren't cryptic as to why
something happened but yeah this with
the explicit defaults that cuttlefish
provides if you switch from react to
react EE and use the same comp file any
explicit settings in a in neee modules
that you might need are going to be
provided by default so same comp file
works for both it's not that hard to add
cuttlefish to your application and that
work is mostly in our language I know
you love and time spent integrating
cuttlefish is time saved and customer
support you know just that example of
upgrading from open source to EE that's
customer support tickets that our
customers where engineers won't be
working it's things like that cuddlefish
lets you unit test your configuration
interface you can write unit tests to
say is this is this comp file going to
read in and parse these app in figs
correctly are we going to get the same
variable set are the depot if there is
no comp file are the default is going to
be something that I'm satisfied with and
of course there is Erlang when you need
it we've preserved the app config and it
lives on in the form of this advanced
config file that lives right next to
react off we don't ship with it because
you shouldn't need it but if you do need
it if you're a developer working on the
product and you want to turn some knobs
that aren't exposed to customers or
you're a Support Engineer you want to
war and you're working some product
production of emergency or what have you
you want to be able to tune things that
we don't necessarily advertise and
that's where the advanced config comes
in and it looks pretty much like an app
config and it just overlays certain
sections that you provide so if it's
empty it just does nothing fazed error
handling I love this one how many times
you run something finds one error and
the whole thing bombs you get one
message you fix that error and you run
it again and you get another error
message you know wash wings rinse repeat
and basically you know two hours later
you you don't know how far you're
actually in because there are still more
air message to go well what I've done
here is I've created five errors in a
config file you know we have this log
console on it can be off file console or
both but I chose that it should be
penguin because I love penguins and we
should log the penguin I also don't
think you should be room in your logging
so I set the level too polite I think
that I kilobytes are way too big for
message size so I created like a deca
bite we're going to use that and you
know the ring size 42 seems good and I
don't know just some port you should
bind to I don't care which one well when
I run that I get a whole bunch of errors
all in the data type transformation
phase now you'll notice here it says you
know you can't no pork can't be a word
port you know deca bites aren't a thing
you know polites not a valid email value
here they are but you notice there's no
log message about 42 42 is in the
validation phase and it comes later and
there are certain concessions I had to
make there but you get a pretty big dump
of here's the problems and you should
fix all these before moving on i think
is only like four phases so you're only
going to do this loop four times instead
of potentially forever so that's nice
you know what he is nice and you know
I'm charming you about configuration and
you know you've bid I've sold you we've
done it and you're in you want to do it
well here's how the schema you got to
define this stuff somewhere you got to
make the rules there are rules for these
configurations otherwise would be no
different than an app config and here's
how the application kind of works what
we've got is this East grip down in the
bottom left corner here and he does all
the work he does all the processing all
the converting all that's all the
generating and stuff and what he really
does is two things the first thing he
does is you packages a default comp file
with the rebar plug in if you're into
that kind of thing but what it does is
it takes the schema reads all the
default and spits out a package
configuration file this is the react
comp that ships with react to 0 it is
generated from nothing but the schema
the other thing it does is it reads in
the user's comp file at start time
it reason the schema and it converts
that into an app config and vm arm is
that we're going to use to start your
application so fun fact about scheme is
they're written in Erlang each schema
element is a tuple and the first element
is that in each tuple is the type of
scheme element it is well what even are
types of schema elements well there are
three there AR mappings translations and
Vala hitters and we're going to talk
about them all so what's a mapping well
it's easy it's fun and they're the most
options so we're just going to dig into
it first it's a four tuple in the first
element is mapping like I said the
second is the name of the mapping this
is going to be the left-hand side of the
key value in the comp file the third
element here is where it ends up in the
app config this this first guy here is
the Erlang app the second guy you know
it's the propolis of propolis so these
are just a you know dot separated list
of keys for for that and then the prop
was down there number four is a bunch of
other options and we'll get them to
those in a bit take this off hot up here
all right so here's the most simple
mapping you can get it's the one we just
looked at and what it does it taste the
line my dots setting equals foo and it
turns it into this prop list of propolis
Erlang app setting the string foo all
right that's that's not crazy um so
strings really yep wouldn't be a talk
about Erlang syntax and how it puts
people off without talking about strings
but really what we are here for is is
say that anything that could be in a
file could be a string so if we say it's
things are strings by default then we're
playing it safe and saying you know
we're not paying any parse errors and
like that a string as a string as a
string but if you need more we can use
these data types and we got lots of them
we got strings and integers and atoms
and IPS and directories and files and
flags and IPS and enums and dated
durations and bite sizes and extended
data types and why didn't you see that
oh you do so let's say I don't like that
string let's say I want this thing to be
an atom because my app config wants an
atom well all I do is add data type Adam
here and then we look at that conversion
again and now everything is the same
about it only foo is an atom it's not a
string anymore we do the conversion for
you for free so there are more
interesting ones you know enum becomes
an atom and when that Adam is parsed if
the atom is not valid this is that
penguin example we did
for you know if it's not one of these
explicit atoms and it's not going to
work flag is cool too it's for bullion's
basically if you use flag than the atom
or stringing on equals true and all
peoples false the second syntax for flag
is you can actually specify the things
you want to equal true and false there
so use a little bit more flexibility
duration it this is my favorite so you
call something a duration and you give
it a unit that is the base unit it wants
to convert this thing too so the value
is a string and it's got these units in
there like 1h 30 M it's an hour and 30
minutes and it uses that unit variable
up there to figure out what it's
converting that to so if you want to do
1h 30 m in minutes you're going to get
90 you want to do it in millisecond
you're going to get 5.4 million
bite-sized it's kind of the same works
for megabytes kilobytes and gigabytes
and it does 1024 you know power of two
math for you so you don't have to
because you're human and you know that
you want 12 megabytes so just type it in
we'll deal with it then extended data
types are good too right we've got a
list of data types and it can be any one
of them or specific instances of them
like this guy down here we're saying it
could be either be a duration in
milliseconds or it can be the atom never
so let's look a bit cask expert because
that's why we design that feature
actually it can be of two types of
things it can be the atom off or a
duration in seconds and you see how in
in Erlang the field name is actually
called expertise X and we're making it
clear this is seconds but you know
that's that's not for people you know
that's for programmers and what we do
here two of the times is we're able to
say because this is duration set s we
can actually use a smaller unit like
milliseconds and it's going to round up
to the smallest number in seconds so if
you say one millisecond it's going to be
a second second is the smallest thing
you do with bit cask exbury that's just
what it is but we do that for you and
then the thing and it could also be the
atom off and the default is off so XP is
off by default and then that that's so
speaking of default default another
property for for a mapping and it's the
default for the duration key if you
don't provide it it's going to be this
it's included for the most part in the
packaged comp file which is the thing
you're going to ship
with ya if you don't use if you don't
including the users comp file this is
going to be used and almost everything
should have a default what shouldn't
have a default okay guys your if you've
done anything with propolis you're going
to grow when you see this next slide but
anybody seen this before so I have a
propolis with X in an X is to Adam
undefined I am literally explicitly
saying this is undefined but if I ask
propolis if it's defined it says yeah it
is defined because you put it there you
define something it just happen to be
undefined well sometimes something not
being there and something being
undefined actually have specific
meanings that are different from each
other from a configuration point of view
and if that's the case then you're
cuddlefish mapping should not have a
default you can also add commented
values it's pretty much like default
only when you generate your config your
comp file at package time for the for
shipping this value is going to appear
in it as a comment it's like when you
when you want to include an ssl
configuration but you don't want to
with ssl on by default you can say this
is how you do it you know just uncomment
these lines to enable ssl so that's what
commented is for hidden is the same kind
of thing only it's basically saying this
is an advanced knob for your
configuration and you don't want it to
be in your default package top you want
users to read the documentation on your
website figure out that they need this
go and turn it on but you don't want it
say hey guys just turn this knob if
you're feeling lucky you can document
your stuff here that riac config
describe stuff it all lives in the
schema as well uses at doc multi-line
comments that that airline loves gets
included in the default comp it gets
included at the command the command line
tool for the react comp describe and
yeah that's that's it we've also got see
because I wrote a bunch of documentation
realized I was gonna have to cut and
paste it to other settings because the
documentation for two settings was
exactly the same because they both refer
to each other so i just added see
instead so and what that does it pulls
in the documentation for the other when
you want to display it it from that
console tool but it also just points
puts a reference like a pointer to to
this documentation in the actual
generated config file and yeah if it has
its own doc
there's a doc embassy it shows the doc
and then it says see the other one for
more details doesn't double doc you so
that's kind of it for mappings you know
they're they're kind of basic and
they're just all one to one thing so
what happens when it's more complicated
when you need to turn these values still
even further and something it's not just
a data type conversion or when you have
multiple settings that converge into one
actual app setting well here we are
translations of three tuple it's the
atom translation the second thing is the
destination this is where it ends up in
the app config the propolis necropolis
and the third one is a function that
takes in the entire config and this
function is a terrible one that always
outputs the same thing so don't do this
do this instead it's harder to read so I
put up the real example after we did the
trivial one we got this mapping for anti
entropy it's an enum and there's three
choices however those three choices are
not the values that end up in our app
config because we're lame programmers so
we make the make the actual
configuration values terrible they're on
and let's see these guys they're on an
empty list on and list with the atom
debug and often empty list these three
tuples are the things that we configure
the values that are acceptable for an
tantra p well we wanted to be active
passive and active debug so when that
comes in here we use cuddlefish can't
forget to read the setting then just do
a case statement say okay convert these
to whatever we're expecting the app
config and in the end it just looks like
this right aunt is reactive runs through
the mapping runs to the translation and
what we get is react avian HP on and
square braces there's another kind we
have two settings here anti HP tree
build limit number and anti need to be
tree limit build limit per time span and
if you see that's the third element in
these two bowls they both map to the
same place in the app config react kv
anti entropy build limit so um what we
do here is we write a translation for
those and what we really want is a tuple
of these two values and so that's what
we create with this function down here
at tuple of these two values and of
course the second value is actually a
timestamp so what we wind up doing is we
put a default in at one hour but of
course when we actually run the whole
thing through we get this tuple of 1 and
3.6 million milliseconds
so we talked about big cash exbury
before and of course the way big cats
expert is actually written what it does
is it looks for the integer negative one
to determine whether or not it's on or
off so you know Erlang wants negative 1
i'm a human and want to say turn this
thing off so we just wrote this simple
translation that says okay well if this
thing is off for in the config then map
it to negative ones that's what we want
in the app config otherwise if it's an
integer great use that integer that's
what we want if it's neither of those
things throw this cuttlefish invalid
error and then this thing is going to
bubble this bad value for big cats
exbury all the way up to the top and
your reacts not going to start it's
going to say bad value for vidcast
expert explain to you why because we
want to explain to you why you can
include io formats in here do like say
what the bad value was wouldn't fit on a
slide so I didn't do it so here's how
the translation works right if it's set
to OFF then just negative 1 winds up in
the app config and if it's set to a an
actual duration then you're going to get
the actual integer gets more complicated
of course we've got this idea of a name
and what a name does we like to find
lists and maps of things and say like oh
this this dollar sign name can be
anything so listener HTTP blank you
could have as many of them as you want
and react so how do we handle that well
what we do is we filter to take the Conn
filter by this prefix listener HTTP and
then we do a list comprehension on these
values get all the ip's back and we
create this list of ips we actually just
wants to let's my piece doesn't want
cute names for them we gave them cute
names because we're humans and we like
to name things and it makes things
easier to reference when we're talking
about them but this thing is going to
take those two IP addresses and it's
going to map them to that so how the
default even work here well we don't
want you know listen or not HTTP dollar
sign name to be in our packaged config
file so what we did was we created this
thing called include the default with a
substitution and what we're gonna do is
be able to say as part of the mapping
say oh this thing has a default and it
has a dollar sign variable substitution
well just put this in there instead and
so what we do is we throw up include
default internal up there the
translation doesn't change at all
everything still happens in the ryokan
for the same way and what we end up with
is this in the pack
each time cough this HTTP internal but
we have this documentation that says you
can put anything in there that was for a
list we do it with maps to right we got
control off users with dollar sign
username so whatever username this is
going to be their password and then we
do the same thing here we do some cool
pattern matching here on the actual key
for the user list to get the username
because we know it some as part of the
parsing of the mapping and the comp file
we separate on the dot for string tokens
so we can do pattern matching and say ok
the fourth element in this and this key
is going to be the username and so great
this list and if the list is the empty
list we throw cuttlefish unset and this
is take advantage of that difference
between undefined and unset so we just
use that but we're going to end up here
is got to users Joe and Mickey and here
are our passwords and this maps to this
list of user name password combinations
but you know you know Mickey's my wife
and she says I don't need access to
react control I don't know what you're
talking about it's why I'm not here
right now so we commented out comment
out one line we have to worry about the
comma between the user list and the
thing that gets generated is going to
not have the user name its then you know
it's going to create the list right it's
gonna take care of the lewis structure
for you it's just going to be you know
one user now and these are lists and of
course we don't want the we don't want
any users ship with react by default
it's a security hole if you want to add
you there's no Scott Tiger here you know
if you want a user here you have to add
it yourself so we ship it with the
commented value also there plenty of
support functions for providing
translations we use like four of these
there a couple more fun ones of variable
variable is the most fun because it's
the most complicated so now there are
validators and these guys are real easy
so just bear with me here for tuple
first ones validator because it's
validator and we need to know that
second one is the name of the validator
third one is the error message when it
fails and then there's a function its
true or false taixing the value you're
validating and says you know whether or
not it's valid if it's true everything's
fine if it's false this error message in
element three bubbles all the way up to
the top and tells you can't start react
because reasons so here's a new mapping
element that I forgot to add little tag
line at the bottom but this is also a
mapping it's just a list of validators
for this mapping
and that later is actually now as I
moved to slide around so here it is ring
sighs it's easy default is 64 it's an
integer it's got three validators ring
size power of two rings sighs max ring
size men ring size max you know take our
42 example before ring size Maxwell it's
less than or equal to 1024 so that
passes ring size min you know it's
greater than or equal to 8 so that
passes ring size complicated bitwise and
for determining power of two well that
fails this thing 42 does not pass that
so we get that now not a power of 2
message that we saw before so great you
now know everything you need to know
about running a schema if you forgot
like all of it that's fine it's all in
the cuttlefish boogie that you can see
on github but what even do you do with
these schemas well the first thing I to
do is drop it like it's proof proof
directories great place for these things
to live this way we can represent from
other projects every project that riac
includes includes its own schema for the
settings for that particular project and
they're all aggregated at the top level
top level projects can also have schemas
that override these things you can twist
your mustache we do mustache
substitutions with rebar so you can have
a mapping like this that says you know
at package time we're going to
substitute this platform data directory
in here and by the time we generate this
thing we're going to have platform data
directory be you know like slash var
slash data whatever for some people and
you know dot slash data for Mac users or
whatever so it's good it's a good
package time way to do things you can
read a unit test for your schema how do
you do that well cuddlefish unit is a
it's a good module a plus plus plus I
would write it again what it does here
is it reason a schema file and then this
is testing default so the second element
in the function here is actually just a
what the effective config coming into
the application would have been in this
case it's nothing this is zero Kumpf
notice configure anything and then
context i'll get to in a little bit but
it's just the mustache substitutions so
what I do here I'm just checking to see
ok if you don't do anything to your comp
file is what's the react or in creation
sides going to be well it's gonna be 64
so this assertion passes what about ssl
i told you we like to ship that
commented well there's going to be no
configuration to be sure that it's not
config and so there's the con
it's just a list it's just a prop list
of substitutions that must I should do
and we did them for you in the unit test
framework so you don't have to worry
about that unfortunately you still need
to be running the JUnit test via rebar
for this particular bit to work so you
want to test custom overrides what
happens if you set a conf to these
values will they all get over it
incorrectly in the app config well you
see here these are the way that
cuttlefish actually understands these
keys these are the set blum the dot
separated tokens that are better how we
do pattern matching and stuff from
before but what we've done if you've set
ring size 28 and we set the ssl cert
file to this and we just run the same
function again only this time instead of
an empty list we've got comp in there in
the second argument and then we can test
to make sure all these things got over
written correctly and like in the
reactor core module that I lifted this
from it's actually like you know 20
lines of comp and a whole bunch of
assertion is to make sure that
everything gets over it incorrectly so
how about a nice cup of rel tool well
you know these things got to get in your
app somehow so what we do here up here
first is we copy the cuttlefish escript
into your Erlang runtime and what that's
going to do is get you a you know the
cuttlefish executable for us to work
with I mean without it you can't do
anything it runs in a separate vm before
your app starts so it's able to figure
out it's been able to ask p.m. the
questions about itself before setting
the app.config do which is actually
really cool then down here we've got a
bunch of templates that are running
through mustache making sure they all
get to the right place where reacts
going to look for them when it starts if
you notice there are some numbers in the
in destinations too that's because these
things are read in in order and you can
override things so the lower the number
the higher priority in the react schema
we can actually override a setting that
came in from the Erlang vm schema and
say okay you know what the Erlang vm
schema says our cookie should be cookie
but we had our default cookie to be
reacts we can override that and if you
don't want to override everything just
one thing like the default but you don't
want to change any documentation or
anything we've added this property the
mappings is just called merge and what
that does it says you know what yeah we
only wanted to change a little bit we
don't want completely blow away the old
one they good things about it but you
didn't like the defaults we're going to
change it so what do you do well if your
if your release has a rebar config yeah
these guys to it just says you know use
the cuddlefish rebar plugin you can name
your comp file so when you
use cuttlefish you don't have to have a
real comp you can have a whatever your
app name is you want comp which is great
because we're only us want to react off
and if you use node package it's even
easier because you can just turn
cuttlefish on and specify that same comp
file name in here and it knows what to
look for so what does note package give
you it gives you a present it gives you
all of these flags already set to the
cuddlefish escript you know command-line
arguments and here's they actually do so
e is for the etsy directory it's you
know where you wind up writing these
things d-des dear that's where the
generated app configs actually go as is
schema dear where you look for the
schema files and see is the comp I
you're loading in in this case react off
wherever it actually lives one thing I
didn't show you on that last lie because
it's not included by default with node
package is this dash L log level and if
you have a problem with your configured
all you just do dash L debug and you do
that in the reactant regenerate and
you're going to actually see all the
output not just the error messages in
case you try to do that so where does it
all end up well generating config files
that appear in your data directory and
the generated config folder they have a
timestamp in them that is by descending
order so they actually sort nice in a
directory which you know seems nice to
me it gives you an audit of the configs
you've started with the bin directory is
where the cuttlefish escript lines up
going other stuff in there too but I
took it out because made slide too big
the react conf file ends up in your etsy
directory and the Lib file is chock-full
of schemas in a priority order what does
that give you well it generates this
it's not pretty but it gets the job done
it's the kind of thing that our Lang
allocations love and humans don't so you
don't actually see if you don't want to
there's another thing there's generated
vm args and that's weird where did that
all comfort we've talked about half
configs all day well there's a special
prop list in my vm are in my in
cuddlefish here called vm args I've used
it in the third element there what it's
going to do is wind up generating vm
ours and you see all sides of examples
for this in the ER line vm schema that
is in the where is it it's in cuttlefish
cuttlefish gives you an airline vm
schema for free because i figured any
airline
would need an erlang vm schema if what
you want is missing from it pull
requests send it to me just ask me open
an issue even I will add it because you
know I want to make this complete for
anybody who wants to packaging Erlang
apps just have these things available to
them so that's special propolis that
Earl of that cuttlefish knows what to do
with and then what happens well also as
an added bonus here we generate these
command-line arguments that you need for
Erlang vm so the output of cuddlefish
everything that we've seen so far
especially in the generation parts of
this thing all outputs to standard error
why so the only thing that comes out on
standard out is this one line about
config and ours file so you can just
take the output of that command and slap
it on the end of your euro command to
start up your vm but you're looking at
this thing and going why did I put the
vm ours file in there twice I've got
ours file i got vm arjun it's the same
file well the answer is because
sometimes you want to ask the vm r or
like vm what did you start with what was
the Ark's file that you started with
what does the config you started with
when you ask you what configured started
with it's like cool man this was the
config i started with if you asked what
args file starts for the win hey man I
threw that information away because i
only needed it to one time however you
can pass in anything else you want and
it's going to save that so this guy here
vm ours is just there for you to query
you're running vm and ask a what via
Marz file did i start with but we don't
actually need that we just need that you
know for front i'm analysis so that's it
you can find all this coded uh you know
github com slash bash show / cuddle fish
is a wiki they're all sorts of
information that I didn't get to if you
want to read it and I'm here you know to
answer any questions you might have so
thank you
oh great um yes so there was a slide of
there about the at dot multi-line
comment so mappings themselves have
comments and those comments anything you
annotate with a doc will make it into
the generated config file and also be
the output for the described command
okay yeah that's actually a great point
um so one thing that I did while writing
the schemas and it didn't occur to me to
bring this up here but it's it's great
is because of the way we're parsing in
the schema files as a developer for
applications working with these schemas
when you have a mistake I am gaining
enough information from the processor to
say you know what you have a problem
with this mapping and it is in this file
at this line so I am actually there is
actually debug output this most of what
i was talking about here in the talk
assumes that that work is already done
and you are working with the deployment
and what happens in a working system but
as you are developing a schema there is
tons of output in the rebar plugin that
tells you exactly what's happening there
that answer your question
alright so the file that you're editing
yeah let's see so when you when you want
to do run time debugging the first thing
you want to do is use that riac config
effective tool which is going to tell
you this is this is exactly what we what
we built and what all the defaults
actually are set to any changes you want
to make are just in your real cop file
if you're debugging any deeper than that
it's because you have an understanding
of the app config and so as a developer
of your application that could get
trigger but that's why in the described
command we sort of included that little
bit of information like this is the
thing in the app config that this
actually has an effect on you nope I'll
do you first yeah so the question the
question is did I show the errors in the
wrong or a reverse order on purpose and
the answer is no there's probably a fold
are where I should have full dealt this
basically there was a lot of that in
this because unfortunately there's um
there's a lot of iterating through the
Lich phase you sort of have to start
again and iterate through and you know
there are a lot of I won't say a lot
because how much performance you really
need with party and config file but
there were a lot of places where I said
you know what I'm going to do this again
and add another like order magnitude as
I'm going through this whole scheme
again but what I'm going to do here is
be able to give you better error
messages for it that thing with the
levenshtein distance where it gives you
suggestions about what's what's kima you
element you were trying to set that
thing has to it feels like order N
squared or something like that but if
you do that it's a rare enough
occurrence where you want to do that
extra processing work and help the user
out think you add one to do
yeah so what we we did we use that with
mustache as well and what happened was
like in our react top-level schema
there's actually a block of code that
doesn't get executed unless you're doing
a developer release which is that thing
where we run like six nodes on one
machine so that we can test things but
that's not something that production
user want so in that we want to set the
amount of memory that leveldb uses to be
a much smaller number because otherwise
you divide your laptop to a halt and you
can't use it cuz you're running six
react notes at once and they all want
eight gigabytes of RAM so we have this
block called dev rel and moustache a
moustache she's that set it adds his
extra setting which creates an override
schema element for leveldb memory size
and changes the default to a smaller
number that's manageable I'm not sure
I'm sorry not so much me okay so yeah
that's that's that same example I mean
it works the same as the fat finger
example with like anti entropy right I
put something in there that shouldn't be
there it happens to be close to
something that should be there so the
thing tells me this thing is still going
to try and guess what he meant and he
might have it might just guess wrong
because you meant something that doesn't
exist at all but that's that's the same
kind of thing that'll happen pretty way
many more time oh yeah yeah I'll be I'll
be here I'll stay around if I think
lunch is now but yeah
okay so um yeah let's that I haven't
built that in yet because the validators
all on the way the validator works is it
takes in a value and does the math on
that particular thing say like is this
thing it doesn't say relative to each
other but the translate probably could
be done in a translation right because
we have oh I'm sorry well the
translation has that has that cuttlefish
invalid function that it can throw and
that's that essentially throws an error
up to the processor that says okay we
got to a point in this setting where we
know we can't set it because somebody
set something else to on and it can't
this can't be set if that thing's on so
I'm gonna complain I'm gonna have a
detailed message about that so you can't
actually do that yeah and yeah but
you'll have to actually write that
message in the translation because it
seems like a specific things you'd
actually want to take the time to you
know craft words and not have us figure
it out for you but I'm if you have a
specific example I'm happy to take it
offline just you know tweet me or
whatever that awesome I love talking
about this stuff
thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>