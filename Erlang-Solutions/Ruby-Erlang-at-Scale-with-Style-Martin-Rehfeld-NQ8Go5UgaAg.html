<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Ruby &amp; Erlang - at Scale with Style: Martin Rehfeld | Coder Coacher - Coaching Coders</title><meta content="Ruby &amp; Erlang - at Scale with Style: Martin Rehfeld - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Ruby &amp; Erlang - at Scale with Style: Martin Rehfeld</b></h2><h5 class="post__date">2012-07-13</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/NQ8Go5UgaAg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so
I guess not everybody knows us yet so
give us social games as we're very most
be published on the facebook platform of
one of our games that's called monster
roll looks like I suppose all cute and
colorful which might be the reason why
women actually are playing the games as
well actually a majority two percenters
talk about today so I want to talk more
about what powers these games user a
typical architecture overview so the
game itself is usually implemented as a
separate application when it's published
on Facebook believe you your flash
application my house we are native iOS
ms really talks through HTTP API through
to some back-end location so this vacuum
TARDIS is for our focus on today and
actually that's just a bit of a
glorified transfers so it provides
something like Android API our functions
for two different days definable you
Jesus jana cova so as you promised way
because no one tries to wait for a
response so we care more about the
overall throughput of the system than
the actual likely see which is also nice
to be over so what this is what are the
responsibilities notice back end
basically it will keep the game state
through the API calls
cool change the stable off its state but
also for validate if a certain
transformation is valid at a given time
so we don't want to play everybody by
its own rules actually by the game's
rules so we need to make sure that it's
all an extent the wagon wheels of course
persist again your stead the scales are
actually pretty interesting so that's
just a high number for this wonderful
game we're getting about 40 million
these API requests everybody has healing
process there's one website that kindly
publishes its its back in polls and
that's what we do here maybe some of you
heard of it so that is an example but
they also have like 14 to 15 don't H
useful well that's the only way I'm
going to compare us to Wikipedia
possibly they do this this great stuff
for Humanity and which is up in fact if
you give us has it a bit easier than us
because what they can do they can catch
these pages do change but they compared
to the people use its percentages across
the some walls down to about a hundred
database operations per second of which
half hour actually updates so special is
not really yeah so that's what we're up
against and how do we deal with it I
think this is pretty unique the other
company because usually you have pretty
small teams and these are independent as
in really independent so what we got to
do last summer and we're thinking about
how we want to do our system is what
every team gets to so we can choose your
weapons freely but whatever you choose
you're also responsible for the
operations system you build afterwards
and as the people believe the back and I
usually also just a small part of this
or a small team so maybe two or three
back-end developers I think we choose
wisely what you can run in support
afterwards oh so this yeah everybody
does what he likes kind of thing he I
lead to total chaos but combine this
with a culture of sharing and the need
to take responsibility afterwards for
what you produce really works so really
a very open culture so we promised you
wouldn't have access to so you can
always
what other teams did and you can also
pay can't we use stuff but it won't be
forced to the rainbow library's full
works what was yeah so instead of having
total chaos instance actually produce
this landscape of games that are like
early so you teaser gains levels on top
and then the dominant programming
language for the backend and below that
the storage solutions main storage
solutions of games use so as you can see
we are a lot of success with movie also
early gets a lot reduction ranking and
see as you can see to the right it can
also meet this a bit as the timeline so
connected up right so the most recent
one is actually the running one and
there's the stream or type II there are
two very different basic architectures
in this landscape so throughout varies
so one is this state support stateless
application server approach which is
very commonly will do web applications
so if you have a suburb but ancestry
request only has some stories or
database would be when responds in
little van kind of read everything it
needs to process request from database
as updates on school and then finally
generate an ounce
for the next three for us to get so as
if nothing happened before and I really
load everything it needs to process we
pass again and again again as you can
see this looks a lot of load on database
which is also visible in the numbers
like I said earlier this is 50,000
updates so the database can quickly
become a bottom end yeah when Vegas
becomes walking like that of course you
be charting Rite just have no pants on
top couple of observers behind that and
then shared database then one is not
enough you just use the second one more
should have trouble with sharding then
you're just not using enough of it and
us as according to my other which would
be put into that stainless application
service basically go in one pane and
this debate was never very needed but
there's hope I mean if you really look
into the pattern efforts in the action
is a user what it looks like then we
will see loads as strong session pattern
so if you're actually useful starts
playing at a different fine then we will
play for a while usually will help do
many transformations of the second at
the same stones available in the game
state about 100 index is super special
music plays I know we will just stop I'm
playing hopefully come back lightly next
day or make our space so this is
something you could
also approach like this so eventually at
the server is in the common request and
we just load the whole game state when
it kind of spawns up and then it just
keeps running and just keeps the whole
game state in memory and will happily
answer over and I choose all the
requests that the user generates which
comprises one game session of the usual
and once he's done with that then you
just don't think back to this and also
done ariat periodically in between but
you can't apply to this definitely lot
less stressful Davis so this one process
corrective user be a steak for games
over with that whole entire game single
game state in memory and it's the only
one that can impact this is so you have
a story of transformation and as this is
one process and if you mentally map this
sterling and you will know that this one
process whatever mailbox and process all
incoming emails it receives one after
the other sweet I've been very nice for
principle we need not fear them to
applications various what kind of access
the same same thing going modify the
same thing at the same time immunity
protect yourself against that is lobster
anything nice concurrency control to
their come all and as a sedative it
loads the games they face points and
writes practice periodically
first user has an impactor for a while
I'm just done activism and that
definitely salsa all the problems dayley
so if you now gain this time so you
second day of its operations so I think
this is capable that they less
approached the state whole approach
within your brain so tired and this is
actually the architecture in the price
for there for there are any back-end we
have life I guess a couple of you might
have seen me the awesome presentation
that killed and a little line to this
year ago presenting last a user
conference so it is also available
online if you want a little bit more
about so architecture on source
especially running well dig into it so
that was kind of a found when I when I
came to lure the question was absolutely
right now put yourself in my shoes um I
think it's pretty obvious of the
stateful approach very superior to do
the stateless one so that was clearly to
keep this all so early
improving system make sense to continue
down this path but yeah you know first
of all problems really go away I'm still
some movie as I did before it also felt
good like giving up a lot so we set out
to maybe come back early entry so well
ra is always be great for concurrency
robust so grateful or sings operational
ruby is also great it is much more
concise and expressively sometimes i
think and it's also super flexible so
you can easily come molded in whatever
dsl like saying you want to express your
program and that's something that's
really great for development we are this
guy also kept haunting us a bit so how I
will say certainly a guy in jail movie
would also be here something to take
very close look usage in the envelope
right and I'm sure if you should team
what we're going to do exactly that at
the time being I wasn't entirely sure
than anyone want to put up this
new stack post-development wise some
people at who knew that helped a bit of
commentary on experience but still I
mean especially for our team agreement
for you and also for operation so there
was no real operational experience
system so that's why we want as
unscientifically your disruption and
just try out this hybrid approach of
earning a movie and have just went
forward visit and said yeah we will do
this until you get a roadblock 13 I just
start opposite so yeah break the two
worlds together and as I said the
earning art which would be the one that
has these processes 12 a game station
only mistake so how do you hook this up
now to to Ruby we were imagining is to
just send it out to some workers running
the Ruby code so these will then do the
state transformation in game state and
sound like the new game state soil yeah
we wanted to couple this most flexibly
and we ended up with cereal cube in
between 0 and Q specialty I think there
that claim with sockets on steroids so
they what they actually out there AQ
like properties on top of TCP or are you
s domain suburbs
process topology supported so it's
really awesome hearing a progress and
lightweight and easy-to-use format super
power I don't know anybody of you at her
off for no product of montville to
Wrexham so um the mongrel tool it's a
web application server that has a
similar idea and it would also be kind
of language agnostic in hooking up
inside the patience to 0 and Q so as
this was already so it's true quite well
we just adapted the exact same q layout
so the message format she uses which gen
was just no brainer
oh we're inside indeed indeed it is a
way it is stateless upside down as the w
workers are still status right but
instead of having a shared database
between behind them they would get
everything they need to know right this
is a request so kind of duty I've ever
taken sharding to the max s now every
single user kind of has its own charge
namely this regarding so that kind of
eliminates the bottleneck but it also
introduces a new partner so the amount
of data you have to pass into the to the
worker to be exported to be able to do
with this transformation is something
you have to keep an eye on my state of
course back and forth so jib just for
your friends well as probably I can be
connected to our steps SI said we use
the model to protocol and you set up and
we have some early encode that which
help us generate messages compliant
westamerica also has setting up the 0
and Q support system it's also people
and then by adapting the model to set up
we could we use quite a bit of stuff
that was available in moving out so
there's a project for math normal to the
interface along with two messages to the
right people enjoy this the de facto
standard or you've got applications to
observe a movie night so we just use the
common Ruby framework in Indianapolis so
essentially we were speaking HTTP / 0 Q
Q's and could have hooked up basically
and movie-based that's real yeah this is
what you trying to make out in my head
so you have the state of each player in
an atom processor yep then you set this
state was an operation your Ruby work on
that dozen hot a magic and then it sends
back in newsday the allen process yeah
and more or less a smaller population
yeah so we set out to be easy and it was
mostly the coat so let's look at some
code gives them an example controller as
you can see it specifies a game actually
connects the game exit when your pattern
and in this case is what you write from
me we're talking about a game where you
can shake fruity and it goes always a
lady as a 13 cell is extraneous of loops
or this connection master for calling it
looks almost native to the language
amazing so it's something you will and
it accepts a lot of parameter stone ms
people configure and this also gives a
pretty nice of your patient we actually
do generate orientation on this so that
the code is basically just just
parameter parsing and to some model so
it's skinny as controllers should be
rails motor and can't get mesh gosh yes
code and model in turn also benefits
in a way so you have sense that
inheritance so brutally yo can happily
inherit from a tree objects or fu class
on top of the property so that we might
already have also define new property
uses are also going to try to play
gathered looks almost native language
but it's just us hooking up these
properties to the message early
acceptance and panics over we find it
whether the state of this feeling slap
and the action itself is also understand
what's going on just increment the
counter here to remain calm down some
attributes yeah so this is like really
easy easily testable right I think it's
wrong as minimal but you could write to
do it to address a bit the thing with
how much data to you sent I can force
let me say the game state is split in
multiple parts not every action I state
so it might be fun part is the user
wanna see the map set up on this graph
Fugees so while our leg does not really
care about the content of this section
of these parts which I who arranges some
binary and in reality they are super
nice truly objects and it does need to
know what actually
switch parts as sending the right parts
to enable Ruby to the process edge but
that's also actually pretty easy so if
you look back to the sub or colorful
then you're right you have attracted
right there so actually tell says which
parts and needs to do its work so this
is really work those anarcho a reaction
I can just push this information yeah
you can say that for this code that's
true that's true encinitas something we
were starting with it on how to do the
encapsulation right there and
alternative approaches like passing the
users around so we disappear at Point
single through the session object it
will get a bit too little bit and it
what's also possible of course is just
to providing as I actually learned about
running to query this mapping and give
the kite so imagine that you would help
restart in the morning server place
being uploaded the matter that's afraid
that's all three please yeah it is
really nice to you about the tree
beautiful coat also deployment Weiss's
really and I seem to just have to fly
business logic is not having to think
about touching the sexual container they
subpoena storage it was also nice to
scale so you could just more more of the
workers basically on one works ready to
go he would also and give you the option
to Arizona separate wish you would like
to do that you can also just scale the
whole early plus movie with a couple
workers on what you know sir its just oh
yeah performance is also good honestly
actually there that would be a penalty
course finances heading this is not to
scale so you could just kind of put more
awkward unless you have another phone
yeah so so while we were while we were
exploring these weeks and Beckham
concept also then the game itself took
shape more and more and if it can't
became apparent that this this
particular game that we were tasked to
support rather gravitate to two large
chunks of game states that you will need
for each actually
conceptualize against them so we look at
the performance impact more closely for
especially pornography notes like
payload parts in the back we compared to
where we look like if you didn't pure
name implementation of energy versus a
moody so we kind of measure the system
how much repressed per second if you
support and we also test series with
different numbers and workers source
whole thing is running late for machines
varied among workers so one and eight
that's what it looked like boiling so we
could even this is larger payload to
completely support such an airport point
more thousands per second and the cost
for doing the same thing in our kind of
dream architecture the scenario is
indeed one order of magnitude so they
approached movie only 400 press per
second segments which was like eight
volunteers but it's quite sounds more
powerful and your sports virtual thing
actually is so it was like at in the
Amazon fell but still for me or going to
tough to spot so and anomalous thing I
was a larger payload it is no longer cpu
part so while one is a smaller pillow we
could easily separate course not
nice but only how utilized twenty-five
percent so it looked I dig too deep into
it but it looks like kind of fixed
bandwidth limits and might be even our
event who's the man we get there at
about 300 megabytes per second story
writing force between two steps and
that's not so nice to have such an end
to me scalability f also we kind of burn
because something similar has happened
before also explain months ago at
Bardonia the team like them a lot what
was the database technology about
500,000 alien computers and while they
were already life is kind of successful
and growing it was really helpful to
them we sing major part of your picture
who is change and running system so back
to the be happiness well i think that
the happiness lies and even working
product here and you can know if it
would have been super nice to do the
whole system in this developer friendly
we work out we still in the light of
peace and facts of game progress about
the actual product will comply
aromatisse wizard we actually decided to
go for an early novia culture this point
in time so this can be considered also
happy ending for this problem yes sir
I'm not an easy decision at this stage
then we tried points as well they
perform a bit better than the 02
approach with a large payload about
twice as good but we would lose a lot of
the other properties that you would like
to have because you have parts then
suddenly la has to kind of control we're
detection stew and it will also need to
distribute the work load onto the
different ports we push in five state
different architecture into the cookie
board understand the operation
the current dating is so you say miss
the people kind of application the only
thing yagi we spot about similar things
with something like say various as an
intermediate storage in between is the
properties that we didn't like so much
because of a brighter in cancellation
and stores also trade to me so the same
thing is the best decision that we could
come up with was you two to explore this
purely approach we just did this here's
some some code you do the same action
based be a bit like an animal so you see
a larger size once again as you can see
here it's still the same pattern so you
have some stayed in may be sending state
mccollester it's nicely diesel
functional approach in the beam that
there's a bit more on that word i can
say so extracting documents getting the
right better structures were wrong and
also building the whole thing it's a bit
more nice place agent if you just write
more stuff to get the job done but still
and as you see this this video talked
about earlier in this case here we have
the controller also being a mediator so
does not actually delegate the user
education started with this shape model
shhh you a lot of getting this reason
why patients under control while the
model bangus as children houses can be
so just also have to shake stained and
put three and get a new tree very hard
what so that's just a traitor young
instead of having the properties on the
simpler mall so we could be nice in
salsa music running records which map
quite nicely dealers problem from for
more complex models would lose other
formulas but still for simpler models so
happiness will not rule out say in
inside yes second expansion so at this
point there might be a bit less detail
for comfort zone but on the other hand
we will now confident that you will be
able to deliver product that is really
reliable and perform brain just grateful
so that's where we draw our happiness
for money I get what do you think about
some smart questions let me briefly
mention that
well also is always looking for
developers if you want to follow down
this past week of the URL right there
and also you can hook us up so yeah I
have two colleagues this movie as a
person to answer any questions regarding
this property or so later so but other
yes are you just actually incoming EDI
parts to the corresponding process yeah
so in this state full approach that's
obviously something that is very needed
because you really need to identify
their know that once the user session so
you will have some sort of
infrastructure kind of a global registry
that knows about what user lives on
whatsoever and we can just router you
press to that who probably optimize it
in a way that following the press can be
not directly and we're just to be near a
bunch of the client do something wrong
probably not in the magic and external
it's a single reticence and it's
basically and we're looking into ways to
swap that out from a distributed
approach but probably they are either
just a custom some personally
between which processes when it gets
this light into in in the hybrid
approach in the pure olive yeah this
will just be in the same node basic you
so you have the session session stake in
the database before welcome okay are
there are no workers in this sense it's
just basic country's process are we
operating on their data structures and
when you spawn up in the user special
movie starts playing then we will
initially based you mentioned a user's
data stored in the parent process yeah
and do you consider replicating this
straightaway for example to amnesia for
high availability those are freely while
we could do this we were also thinking
about things using something like real
or Picasso but in reality I mean the
worst thing that could happen if we kind
of persist this stuff too infrequently
and
the server process will crash all that
will happen is that the user will then
lose a bit of progress in the game so as
you don't be banking on using this is
totally acceptable right just as easier
systems approach so that's very personal
yeah so what algorithm do you use for
pushing the information we are usually
walks away they get bored or whatever it
is at some point what I do so I speed to
detect this this fact it's just a simple
title so anyway LP this is Susan use a
special process will be against over and
just as a climber and whenever really
does time on and just dump its own stage
you know say Jason serialization to this
so we actually don't use a database to
store the against an email that is
really spotty Bingley are controlling
you just amazon s3 so just this be the
screen persistently dump this tree will
need to split up extract the user
crashes they you preserve their
spectacles if the client would crash
then yeah it just it will just be
another time on or maybe it is leave no
time on when it restarts quickly enough
I noticed something interesting in the
arming code that you showed like how
like your core like the delphos reducer
state example like you have a go back
now you have a loser affect his
experience his energy and does this
mention propagate back to the client or
is it like it's like dual simulations
wrong in power yes it is so that's one
of the challenges in this so picture the
client Google's feel so logically
mississauga code but you need to do that
because you the client will not wait for
us for an answer from the server it will
just assume that it was okay yeah
continue planning so these can be
doesn't need to stop enjoy killing it
just eats to apply the same facts thanks
miss one because how do you like you
managed to leverage this in some way
because I find it a little bit
interesting that now you have kind of
separated you know the state change and
the state are two separate things now so
I mean those are kind of events which
could be used to trigger under self are
using or doing something like that at
the moment or the events of her
this is features of course this event
screams also i was thinking just I've
been thinking about this exact same
approach when doing like non distributed
functional programming games right just
one time that's it no because I mean
give an infinite bandwidth and like get
Siri latency I mean you just put all the
game Datuk on the server and then the
flight can get these messages like oh I
increased my experience I can make the
experience boardwalk or like to rinse
the energy and then you could have it
like the true model view controller
setup where the client is actually just
the right thing type interview all the
input but you're in a perfect world yes
the internet ventures is committed
makes really not watching youtube but
the same time thank you that's true in a
way but still that you again or you know
my sintered in the face and just
continue typically take then it was
still a noticeable delay when you just
wait for the responsibility in your
promise in the fact that it's not yeah
we actually have experimented with
solvents as they are kind of awful a
they just
all sorts of wrong bags or this narrow
so they use more problems than they
solve for us but we are using our
service and events so thats basically
just chunk transfer communication back
but we still have requests separate us
for the way to you running out of time
so if you don't know a person is a smart
team after the dog Thank You Marty</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>