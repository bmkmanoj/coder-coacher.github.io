<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Tech Mesh 2012 - Eventual Consistency ftw. - David Craelius | Coder Coacher - Coaching Coders</title><meta content="Tech Mesh 2012 - Eventual Consistency ftw. - David Craelius - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Tech Mesh 2012 - Eventual Consistency ftw. - David Craelius</b></h2><h5 class="post__date">2013-08-09</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/lHrMctZhEHA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">I'm going to be traveling yeah I'm going
to be speaking a bit about our migration
strategy at a black hole and kind of the
next generation on the stuff that we've
been doing so is this working no
apparently not so let's look at corner
and George how many in here know what
toner dust okay then on this it goes
really really fast we kind of
independent we don't want to build a
payment solution on top of the normal
credit cards we need to double each year
we have over 100 million euros in
turnover after six years always being
profitable where 800 with doubling each
year this bit of a pain we got Sequoia
Capital DST generate lantic and sounds
from joined on the spring with the
tomiko most importantly we love
functional programming and engineering
economy around a hundred and seventy at
moment that's 100 dialing developers we
have about 20 Ruby guys and the rest is
operations and kind of overhead trash
like myself and the rest of us trying to
be adding it the vision of clonic trade
zero frictions on the consumer base and
this is really about us removing some of
the key friction basis of pain points
with in finance and if you look at the
whole financial ecosystem is a lot about
building around identification and it
how many in here uses paypal all of you
good because the whole thing with paypal
is that they identify you by first
getting your credit card and then
verifying it by sending a four-digit
code to your critical and once that loop
is done you're free to go clonise just
said no that's too much pressure if you
go real in real life and do shopping you
don't have to do that you don't have to
register because we kind of see
registration as the root of all evil so
we can't create this is in Swedish but
this
is our latest i'm in a store I've
got some pumps I got a croak machine i'm
good to go for a really nice evening we
offer for my email address and then we
do this is this is a identical I
incremental identification is call it we
kind of look what store is it what are
you buying and then we gather enough
data points that we feel it's good
enough for us to do a real-time credit
assessment so in this case we just lost
my zip number and I'm good to go I click
that's I'm up in three clicks now and
you're actually done this is in Swedish
I'm sorry for it but you got a receipt
you can actually change the payment
options we like using a voice so people
actually don't have to prepay but if you
ask us may want to use one of the
classic cards this is it laughs that
we've been working on this year so this
means that we take about one hundred
percent of the instead of just being an
invoice option we take one hundred
percent of our customers purchases but
this means that we nearly need to have a
very very high availability and this is
actually a real pain because I've been
working my whole life within the finance
industry and as a bank you normally have
the weekends to do all the Maquis ship
that you didn't have time to do during
the normal bank days and we're 24 7
shops so we don't have the option so
that carrom we had a completely
different challenge that we want is to
solve than the ones that we were having
and most of all I'm so very firm
believer that the SLA or your
availability of your services is going
to be the only thing that really
differentiates us and it's going to be
the game-changer for the services
regardless of how good the product is
your consumers are not going to be using
it if it doesn't work and this comes
back to kind of user experience kind of
hipster stuff to be honest this is my
view on it I live in Sweden and if you
in the north of Sweden and there's a
power outage kind of lift up this phone
and if my god
this is I'm not alone it works you have
a tone everything else is dead your cell
is dead here I don't have electricity
don't have any heat but the phone works
and this is kind of the what X on the
guys had to solve and ability sector and
the finite hope societies that guy's
your part of our infrastructure
society's infrastructure and this is
what I've had in on web but nobody has
really put that the mold on them so we
needed to just acknowledge the
availability it's not optional anymore
and given the fact that our system today
or was it we arguing is a big monolith
we needed to create a migration study
out of the third pit of hell as we call
it internally and that is what the
technical depth that comes with doubling
accompany each year and not being able
to scale really so how did we do that or
target four nines utilizing very lean no
moisture environment both when it comes
to individual machines clusters or sites
and giving the fact of our business who
can behavior of our businesses this is a
bit of challenge so kind of in short we
wanted to build this is that okay this
is not something unique this is pretty
standardized two sides to side firewalls
load balancers clusters of front-end
machines taking applications spread on
two locations but most importantly here
we only have one back in half we're not
replicating the whole structure between
all the notes because in our world being
able to be up is really in this part is
being able to accept these purchases and
this is ok if you take no no this is a
routing point of it if you look at how
we have built one of these from ted's
machines if you dissect that we are
strong believers of having side effects
functions that if this would be a
purchase something comes into here goes
to identification those stuff that i
showed before okay
giving these data points they might go
and gather some data on the net if they
want to they they get a data set the
country line and other services the add
data to that data set and just pass it
on to the next level and then the whole
purchase goes through these different
silos and then are either gonna go and
you the customers has a payment option
provided to them we are using react here
but we wanted to create an abstraction
lay between the database and the service
is running on top of it that was paid
that is pain I'm not sure if that was
the right thing to do in the face just
listen to Garrett Smith drunken stumble
and this was one of these theoretical
stuff that we did it's good that we've
done it but was it the fastest way to
get going I don't know so we're using
react we use saying we have this service
orchestration engine we have an
abstraction we have an mq broker that's
separating the front this is just one
machine and of course we can we have
minimum of three notes in each cluster
and then we can add as many clusters on
the site as we feel like it given the
fact that I solve some due diligence
stuff with Amazon I can scale on the
cloud I cannot do that as a financial
player today but I'm hoping to do that
in future and then we have the back end
which is I'm not going to talk that much
about it this is the molar lift that we
as soon as we've moved everything into
this one we're doing this step by step
I'm just going to start change sewing
through that one the stack is we using a
line OTP react and RabbitMQ is really
the what we're trying to using if you
look on it on an infrastructure point of
view we have the xml RPC describe little
stuff we have a best resource engine we
have a soap box we use a mash-up stuff
it can go through service services you
can go to these internal side effects
free services and we have the whole
abstraction layer and it put once the
purchase is down a post a message to the
backend for processing in a queue
because this hasn't a state it doesn't
want to have state we don't want to have
the whole purpose of this being totally
independent on the front and back end so
that back and kept me down in the front
and can act on their owns to a as large
degree as possible and just to simulate
a service like this how many guys in
your PCI DSS anybody's seen these kind
of evilness good this is how one service
could look like this is our payment
gateway we're in the payment industry if
you want to create a DPS idss hope it's
pain and I wouldn't recommend anybody to
do it unless you really have a good
business case so this is one of these
nodes okay thus all these ship you have
firewalls you have robbed us you have
storage you have edss you have logs and
you have all the that comes with
being compliant and most of all you
can't access this information obsessed
you need specified machines to do this
it's a very segregated environment but
we built this and well we're doing it
with a leg music really is gravity's
we're trying to use the same tech stack
on regardless what we're doing on the
stuff that we feel has any interaction
with the user this is so important when
the back and offline processing we use
whatever not that we're using postgres
SQL limiting is your living cadence Ruby
not that important when it comes to the
transaction stuff we want things that
work none of it's the bleeding edge sad
to say so I'm not the leading edge kind
of guy but it's not that old as well but
we can look on the forefront see
everybody see where Q I was looking at
it was a bit too bloody two bonus Oh
rabbit was kind of the safe choice so if
you look on this one from kind of
conceptual business point of view we do
not have a master we do real-time credit
scoring and we do real-time credit card
processing and this concept doesn't
really work well what you described it
to a risk department in the first pitch
that we're going to be spreading out the
purchases they're going to be
happening in the back yet it's going to
be
happening in the in front them but we
want to be able to do this because it
creates a very high availability and of
course they're going to say it's not
going to be synchronized yeah because if
a customer comes of course we're going
to use sticky sessions we're not going
to be stupid so okay we're going to use
try to use so you have one cluster here
called the user is going to get directed
to the adjuster but to be honest if that
cluster is gone yes he's going to get
somewhere else and if this whole site is
gone is going to get roti somewhere else
and if you look on it on any perspective
yes we say that okay because it's in the
behavior of the information because what
we have I come from the trading industry
where you have machines and if you look
at risk risk is more in definition that
you how what's the odds of you was the
probability of you making a bad decision
within a certain timeframe due to
missing data that's kind of risk when
you're doing all the validation trading
power calculations and these kind of
things when you do credit to scoring and
if you have machines that do multiple of
thousands transactions or seconds is you
need a certain kind of technology to
solve that but if you don't and have
human beings on the other hand they
click and as soon as somebody starts
clicking on things they may be very fast
but they're not sub-second they can be
but it's you know you have to be using
stuff like seconds instead of micro
milliseconds when you have that you have
a totally different problem to solve
because then you can have these multiple
sites using actually the good parts of
eventual consistency because then you
could have like yeah say that we put up
a data center in Brazil we have 400
milliseconds round trip Sweden to Brazil
it doesn't really matter say they takes
three seconds worst case we of course we
think it's going to be some second but
say it takes three seconds due to some
whatever congestion in the system
doesn't need a matter because the human
behavior is that if I'm shopping I click
or should I forget something I need to
go and fetch it i'll go into i want to
add this one or i want to change and
will abort one pair of socks i'm going
back to whatever you're doing the
interaction when your computer or your
mobile is on a second level and this is
kind of how we wanted to be utilizing
this yes we want to create
high availability and actually lowering
your credit risk because we're not we're
having human beings around so we don't
have to be that fast and this is very
important when you're designing system
and looking what kind of tool box you
want to be using is that what is the
problem that we need to solve it's so
easy saying that everything needs to be
so bloody fast it doesn't it's like
react why do we choose react it's a very
slow data storage but it is master
master it doesn't master three it
doesn't have a monster and this is the
point with it because this is what I
wanted to achieve I didn't want to have
the very very fast stuff I could have
gone with Mon boarded but Mongo does
have this old canim to be honest 80's
90's approach to master slave and that's
I don't want to build a system like that
because I want to build something that
scales in a totally different manner and
what's this puff there it's not very
hard to realize but what happened is the
mother dies yeah what does okay what
does the offline processing in the
trading in financial industry you have
interest calculations you have fees you
have certain those transactions that you
do on a night batch or if you're more
modern you don't have a bash you do it
but you think that you can do it and to
be honest if we're solving payment sir
so if we're missing an interest of one
crown or two crowned and this somebody
wants to buy something for either dollar
or three four hundred dollars is that
missing part of the data is that so very
important it is important but it's not
that important for this for us to be
able to make a go no-go decision so of
course okay mommy can die oh come on II
can not be dead forever that would be a
certain issue for us but it can be done
for a pretty long time for us to be
actually be accepting the purchases and
of course the next thing if you
understand work is that ok what happens
if the whole routing entry dies of
course then we have to route the
traffic's amount of base that's how we
integrate it pretty simple and then the
dogs case okay what is our primary site
dies we can continue with life but of
course we need to get mummy up in some
day but
you know we have days now we don't have
the normal operating stuff that we need
to solve stuff very very quickly so it's
just creating this resilience in the
system and this is where the this is on
a kind of wrote in perspective let's
look on that on a service more into the
codebase kind of structure and how many
guys are familiar with credit card
system how they how they work on a
national academy yeah the resilience
that if you look at crib bored my market
or the corn market this is this global
entity of entry points of data that
needs to be sink rise and they need to
find a way home how did they actually
make that happen and they're so
fastening I built Deborah Kotz process
and stuff back in two thousand and i was
just fascinated by how easily they've
sold this because as an issuing bank you
can actually go into one of these
network is you repay your mouth Scott
and say that okay for these card series
if the if it's below 1000 euros say yes
to it if you can't you try and also as
we're down just say yes to it because we
want to keep the consumer happy he's
there shopping he doesn't want to be
neglected or you have any kind of get
his card he's purchase rejected so just
keep them happy and I want to create
exactly the same kind of structure here
using graceful degradation of services
so that ok say that we have a purchase
comes in the hole ID service is down God
knows why but it's not giving the rest
of the guys a level of identification
okay well it then the risk bubble
there go since I say yeah well I don't
know who this guy is but I have a pretty
good idea of what he's trying to buy and
I have a pretty good idea on if he has
history uses first time customers okay I
gives you some data more but then the
next guy might be dead and this might
continue down so when we come down to it
okay say that Rudy service is a bit we
then we just enter it okay it's a flip a
coin decision go now go and then you can
work with totally different way of
modeling your risk because that is about
visualize visualization this
market risk okay just as long as you're
visualizing worst-case scenario say that
we say yes to all the purchases without
doing any kind of assessment at all okay
Bush case is that these all these are
default we just lose all the money there
is okay how much is it worth for the
company to have that time then it's
marketing money yeah chef's below three
million crowns go with it yes may give
us a panic button so we can just we can
start saying no and this is where I
really really really love the way you
can build giving the stack that you have
you have our line you have this very
good technology to encounter kind of
scaling stuff and if you have these very
good principles of creating side effects
3 and if you combine that with some just
common sense you have this ability to be
creating really really robust structures
and this is something that I think is it
it will be a big game changer when you
start doing it is and now this isn't a
high-performance it's not a low
frequency high frequency system is if
you're that kind of this is a human
system this is solving the interaction
we're having humans when I did some
other kind of issues been training I
couldn't build a system like this but I
wanted to demonstrate this this first
will share how we are looking upon it
and looking upon how he chose a tech
stack with regards to what kind of
problems you want to be solving and this
is how we're doing it and we're shipping
it half of its line now and we're just
taking it gradually graduating a bit
hold up before because of Christmas this
is our peak moment in life this but this
is the kind of migration strategy but
chosen that actually allows us to be
scaling giving it that we go one hundred
percent fully live with it that's going
to be this spring operational scaling
the operations when it comes to
accepting purchases and the ability to
put up data centers wherever we want in
the world it's sold and it wasn't that
much job is a hard thing to achieve
migrating out of the hole you were in
but we comes to an architectural point
of view
just saying that this is what we should
be creating it was pretty easy as long
as you start understanding fundamentals
of the problems you want to be solving
cool that was actually a familiar pretty
fast questions yes
I think the as long as you can have
buffers you can just let me kind of use
to having these very small services that
you can just pull the brake and they say
as long as you can put a buffer saying
that okay don't put ship into the empty
broker for now and then you can just let
the older everything in the queue get
processed and then you need to change it
but to be honest I have you worked a lot
with I'm umq I pms mq series and their
big heavy weight of my god ID I never
really changed it i did we got once
these things are stable you kind of they
just work it's very very seldom but
having the possibility to be putting
kind of having yes i can throw that i
can create a queue just buffering the
information here i can in the same
direction here i can just start
buffering this part so you have the
problem and this is what i think i like
with use and I like the fact that nobody
nobody the guy who puts in the message
here has really no idea what's who's
going to pick it up and it could be
anybody and that's kind of the idea
behind it yes so it seems to me that
klarna sort of accepts technical
realities and let some sort of bubble up
to the business level of things and do
you think that it is correct that your
title is CTL I mean you seem to have a
lot of impact on the actual business by
making decisions on a technical side no
I think there I'm a good bridge between
it but since the reason for I've been
spent my whole life within the finest
industry I thought there's a web monkey
back in 94 stumbled into online trading
in 99 so I have a very good
understanding about risk and audit
validation I spent most my time doing
the derivatives in these kind of things
so that of course helps me because but
it's also about having an engineering
business settings buying each other
having the risk guys understand
eventually of course there is a initial
you have to be some categories you have
to be good when you explain stuff like
this that this isn't a risk but at the
same time we still have the founders of
the company very active in it and they
understand these things totally they
don't understand the technical style
they're from the sales guys to be honest
but they want to understand the
technical and of course they have a bit
of frustration of how long this takes
why does it have to be certain types of
engineers are working on this and
certain aspects p but we have a very
good co-op on it and we sit side by side
and I think that's the much and this
isn't my work this is actually the teams
and as you saw here i put the tags of
the guys if you put it here can't
primate to the last minute those are the
guys will actually been doing it they
are the who should get all the credit
when it comes to okay implementing this
idea of selling it on a general
structure and the kind of very very good
at them good more questions yes with the
eventual consistency model that you've
adopted for example using react and
you've obviously got you know you aren't
completely consistent across all your
data centers for example do you take
some of the risk decisions in there as
well so do you have any idea of what's
our exposure if you lose a data center
so how many transactions are not yet
replicated across to the to another site
you tracking you those sorts of no but
given the fact that data centers
normally have five nines on them in
their up time it's one of these issues
that let's solve it when it happens to
be honest I just wanted to when we
decided to have the possibility to lose
the data center without standing they
were having this massive you know what
we will plug let's go into face be your
def con 6 and we have this hot standby
site but we never used it so and I just
didn't want to have that one but how we
actually would handle a full failure of
a site that also contains
mother I don't know be creative to be
honest but I the yesterday on this setup
is lower than most of the data centers
that we have that we're putting into so
it creates that they really up if
this way to be honest so I know I don't
have a good idea about it I think it's
about collecting having good
visualization of the flows we're working
shitloads of the metrics collecting it
and we have this here so to speak and we
have it every week trying to collect lot
more metrics and since we're using
erlangen we have some very very good a
line these guys or collecting all the
amex stats that we we're trying to
utilize so I didn't have a good answer
that I'm sorry yes yeah me again so in
the previous talk you had a point that
things are basically up most of the time
so how often are you down can you can
you say so here with that today we have
actually what we have a really
yesterday to be honest we have I can
measure it really strictly as well but
since our system is built like a Mona
list today so in memory application it's
been it worse to a certain degree very
well but once it starts not working that
well it has real issue then you have
time out issues you get this bit of
civilization and it's a bit of
processing they've creates that
something that happens in back-end
system is exposed to the purchase so
where I would say a pretty bad 99.7
normal financial yesterday at the moment
which is correct be honest and the whole
reason why we chose this migration
strategy out of it is once we once we
have the front end and have the
availability the customers like we can
just put a chainsaw and start chopping
up the rest of it so it's more a
practical approach to it okay so today
we're just normal just due to the simple
fact that they were working so clone has
been growing so very very rapidly and
we've never had a product this is also
the kind of uniqueness we just sell
invoicing to the company however they
would like to have it so
when I arrived the corners like yeah so
how does product of that we don't have
one we have like six thousand different
ways of tailor-made solutions or speak
with zero documentation it's just adds
flavor to your job makes it fun yes so
you said use sticky sessions it's all
right yeah the general idea is to reuse
take your sessions here the old man says
yes so would that mean if you did you
look if you lost one data center than
the user would have to restart your
action and it's not actually the user
that got you have a customer who goes
through merchant and virgin the
integration with these libraries that
they load from us they have a back-up
plan to go to this one but the
effectiveness of that one depends of
course on a lot of the infrastructure at
the merchant site how well that is
utilized so it's but the case at area
that we lose one data center totally
well I think we're going to we're going
to lose some purchases on it but on the
same time it's human beings they click
even if they get hoops something went
wrong like your gmail is reduced contact
with you can click it and then you just
try to refresh it and again so you you
have depending on what the customers
doing we're trying to make it as
resilient as possible but it's very hard
to be that when you have these totally
outage anyone
yeah not to the back end so we're using
our bit for the back end communication
between the between the threads the Fred
clusters would speak and to the back end
let's rabbit I've been looking at having
it between the database as well for
certain aspects also abstraction layer
but we don't know how well if that's
really efficient but it's just one of
these yeah but yeah maybe haven't gone
that down that buff yet and we're very
like it a lot the products good we kind
of like the VX tough as well it's been
working out pretty well it's not fast
you shouldn't be using it if you need
something that's really fast but it's
for my point of view of the only
database postgres early yet was the kind
of the key value store and you need some
kind of sequin environments for the kind
of reports and the business part of it
and those were the only two I found over
50 that was actually before or a
keyboard my screen but was synthesized I
was guessing it was going to go in that
direction anyway i'll be working with
oracle ms SQL postgis and most of them
and and I good please don't question
because I'm really here to just share
and what we're doing so and I'm for
banking part and that exact opposite i
want to share all of it and i also want
to this is something we'll work on with
the league i want to open source this is
ken primates is jacob's work the whole
mashup orchestra once that's gone
through some of the legal stuff i want
to be outsourcing all of it so hopefully
in the spring in q1 i'm going to see a
lot more open source code coming from us
guys yes just curious
I didn't actually bring that up but we
do have a GUI and so I have an office in
Tel Aviv who's there using Ruby on the
new marker because we the merchants are
primary customers and they of course
need back office tools to be looking at
purchase to be changing goods and all
these kind of stairs looking at the
reports and how the revenue is going and
we're migrating at that bump because we
build those things in airline as well
and this was kind of a me being one
hundred percent Alan Shope not really
efficient I kind of believe in using the
right tool for the job and that's what
me and I think over a dimension we got
he got to chose my only restriction was
that okay we have one script language
you either pick Python will rule bill
pole of whatever you want to use but we
don't have to and I'm trying to stick to
that one not to get too fragmented on it
Elaine chose Ruby which is working
really fine for them I didn't actually
bring you up because they give me when
it comes to do because the transaction
ending is really where is the heart of
the businesses but nothing else good</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>