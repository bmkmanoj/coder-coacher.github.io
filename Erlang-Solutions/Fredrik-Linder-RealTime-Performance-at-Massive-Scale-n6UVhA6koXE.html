<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Fredrik Linder - Real-Time Performance at Massive Scale | Coder Coacher - Coaching Coders</title><meta content="Fredrik Linder - Real-Time Performance at Massive Scale - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Fredrik Linder - Real-Time Performance at Massive Scale</b></h2><h5 class="post__date">2014-08-18</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/n6UVhA6koXE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello my name is Frederick lender and i
am the island lead at machine zone which
is the whiting green thing down there
machine sewn delivers highly engaging
social real-time multiplayer games for
the mobile market and we have a few top
grossing games in the eye I US market
okay picture this that you are having a
game night with some of your friends you
get over there you pack up the board
game put it on the table and add your
favorite beverages and snacks and you
just about you we start playing and then
the doorbell rings so you're going to
fetch it open it up and there's a crowd
of people coming in takes down the board
is when you start playing and after a
while the doorbell rings again and other
people bunch of people come in and you
extend the board game again and
eventually the whole house is crowded
with people the whole house and yard
whatever is covered with a berth with
this one huge board game and as you play
this game it's so fun so you don't want
to stop so you a day out day in year
round I guess this is what our CEO had
in mind when he was thinking about our
latest game so say we have a hundred to
five hundred thousand players at the
same time in this game different
platforms different versions
yeah and I having this many people in
the same room in the same house you
won't be able to understand what they
are saying at least most of them because
they will be speaking Japanese or French
or some other language you didn't learn
in school so we need to fix that so we
need to have some something to fix the
language barrier make sure the people
can talk to each other in our case that
was translation and after we released
our game I have seen other big companies
develop heard of started introduced this
as well so we hit when have this can't
let this kind of game with tons of
people playing it all over the world and
it starts out small you want to start
out small because you want to see that
you don't have you you didn't do
anything strange or going to fix some
bugs that you had or some behavior
leading that enters anticipate but you
want to scale out and so either can add
new machines or big machines whatever
Atlee but you need to be able to scale
out you need to be distributed and it's
a bit partitioned because all of a
sudden one of the hosts goes down or the
network for that site goes down but you
want the game to still be up and be able
to play it and you prefer don't want to
do that manually you wanted to
automatically scale stuff so what are we
using airline for in earth machine zone
using for real-time world updates
real-time events real-time timers
real-time 121 chats real-time group chat
real-time translations real-time event
processing real-time notifications you
see the theme here real-time
so this is a chat client that we're
using again they have some of those you
can see there's an original text that's
what the the person who actually sent it
so the one who sent it with typical
savings on the English and the device is
in French because the translation is to
French here's another one the big the
big seat there is that's the crown jewel
for everyone that's the one the thing
that everybody in the game wants to sit
on that's the main ruler seat right and
they have in the middle one picture you
see there was a wallet with this city
and when the the fight is over
apparently he won because the city
doesn't burn they're all dispersed home
back a bacterium so imagine you're in
this column is a place you found your
corner in in the in the game apparently
very close to the wonder which is we
have the one big world and we divided up
up in kingdoms so to spread out the
action and all of a sudden people start
teleporting in and there are bombarding
the the one they're trying to take it so
from calm to really really busy and
during this period we can't have any lag
or anything if someone isn't acting that
they need to be resolved in the order as
the game sees it not orders and that the
way the game ceases that's the way you
need to see it as a player to fix that
okay i have a little demo how do i play
this supposed to be playing okay back up
plan oh damn it you don't see anything
ah just come off that's right
are perfect
thank you
so in this picture we have lined up a
few iPads and I'm going to see a scout
going 0 for 12 noon to the other one and
they are pretty nicely synced right all
the way over there son and here's a sing
for the chat system with the
translations
okay so back to our side of the of this
so the challenges we face when we need
to do this we need to have the
architecture support to be able to scale
out and fit failover and all that kind
of stuff and having everybody the same
room everybody getting the same you
everybody being able to communicate no
language barriers this is nice but all
of these things need to feel natural to
you when you when you play me if you
have a chat system and it takes it
two-second delay for the other person to
send a message to you it won't be a
natural dialogue right the same thing if
this famous if your device is showing
something that the server doesn't think
that you think your device was the first
one to this resource tile and apparently
were the second one if you if the game
resolves it in a way that you don't that
doesn't match what you see you're going
to be irritated in this game I know you
wouldn't like to play it so we need to
fix this another thing is having
downtown means lost revenue this is a
free-to-play game everybody can download
it all of you sure down on it and but if
you want to get ahead of the game you're
able to do so you can play the whole
game without spending a dime if you look
if you like to but if you want to get
ahead and yeah then you can do so by
paying us money so that means i will get
some revenue if you have downtown this
also means the people get a little bit
irritated by the game it's not available
when they want to play it so they want
to switch game play something else and
maybe they get hooked on that
instead we don't want that right and and
also when it comes to translations if
you want to use any of those translation
system out there like being or Google or
something else although so those
translation based on we can say when
you've read the book where we read the
paper the the translation for that is
pretty good but in our case we have a
good chat system and having Google being
or whatever translate chat systems it's
it's not really their ballpark but it's
our ball parking we need to solve this
you need to fix this so the approach we
have taken for all pieces of our game is
that if it doesn't scale we can't use it
that means that the first thing we sold
you don't if we have food in my case I
had a work quite early on in machines
own I was developing this this thing and
I had a few bugs in the functionality
but I haven't solved the scalability yet
and after a while one hour had had had
people there came and asked me how
Freddie what's the what's up why don't
you fix these bugs and since we need to
fix scalability first that's what I told
him he was okay with that and next week
I do have sold it and we also fixed
those bags it was really really good and
if you want if one wanted to have a nice
performance you need to know what you're
aiming for because you can sit there and
make optimization after optimization and
after a while you do more optimization
that is actually needed at least at this
stage of the game so you need to have
the goals you need to set and also you
can scale away those things that are
unnecessary another thing for more like
an operation case always have a fallback
we had one time we had the game was down
we were doing maintenance and as I said
in the earlier slide you you don't want
maintenance right you want to get out of
the downtown as fast as you can but our
main plan didn't work it started to
extend the time out the time for this
day downtown and we really didn't want
that so luckily we had a fallback plan
so when we saw that things weren't
working out we care we were able to
switch your fallback plan and get the
game up again and then analyze you see
whether it was that and wrong after we
got to game up if you don't only fix
those things during down time you want
to fix this afterwards and another thing
we also had was during our development
phase you need to see if since we need
to fix the scalability thing first we
need to be able to see what the game is
doing how the game is performing in
different aspects so we need to measure
and need to benchmark at the stress
associated failover test to find all
those bottlenecks as and an operational
issues that we that our game was having
so in yeah and one we do that we iterate
improve see the scale did work etc it's
not going to give you a short example so
you see this is going away fast now I
was thinking huh okay so this is one of
our services the event processing
service if you if we take this and boil
it down to the minimum core part of this
for
scalability point of view they have some
typical district distribution pattern
you get some payload to distributor and
it takes a worker and it forwards over
okay pretty standard right so at the
point that i was starting working this
we had a third party like a pool library
to do this and the way it was set up we
had the distribution distributor and it
set the workers and when the police
really got the message did I as soon as
fast as I could it was sending that over
to the worker regardless if the worker
had anything to do or not so you can see
that there the queue for things being
worked on live both in the distributor
and in the inbox of each worker this
means that this way yes is the password
set let's let it crash we want to have
the workers crashing in case there is
something bad because you wanted with
cleanup and you want to start over
setting up the new state connections or
whatever it is that the workers need to
do its job but you don't want that the
cost message loss right list if you put
the fake stuff in the inbox and the work
to die so although that is lost and
there's also another thing since we're
having a distributed system the
information that the work has died
there's a there's a slight time period
until the worker until the distributed
knows this and that can be the reason
for that is the distributor may have
stuff in mailbox already so it might
process a few messages before it it
feels that the other process down and
then as in this case the way we're using
pins to send for the workers instead of
name
so it meant you can send a message to a
dead kid and you wouldn't know that it
was lost right so that was one of the
goals for this iteration make sure we
don't have a message loss and with
push-based and want to think the workers
to crush in case of failures I need to
be fast and we wanted line near
scalability up to number of course and
there was also demand to okay say that
the worker dies that's one thing and
then we can wish to be able to say us
all that so that we don't get a message
loss but if the null goes too long we
known don't want to lose all those
messages especially not those message
that have a dollar sign attached to them
so we did this iteration a few times and
what we realized was that we wanted to
separate control messages from traffic
messages so that said you have a worker
that set up the connection to some
service is that of a socket wants some
service and you want to listen to you
get this tcp closed message then you
wanted that you want to prioritize that
message in front of all the traffic
messages so you can kill warrants being
restarted instead of a new connection
and then we want to put a pop the work
they work right you don't want to lose
any message because you don't have the
ability to work on them so what we ended
up doing was implementing a new cue
actually adding in your queue so it was
a lot less multi producer multi consumer
queue with the option to a map that to a
file that will harvest or the
persistence thing and i must say work
with nifs in this regard was can
nice because you don't need to except
for the a mapping thing you don't need
to do any special things to store the
store you're a long-term into some
structure of yours and we were using if
resources so we had a separate process
to own these those resources so the
distributor and the workers would ask
the owner for which cue to use and then
that's the setup we can have to work to
pop one my third time and if it failed
we could have a try after close to try
catch close to log if failed messages
and do something else with them later on
and some number they're implementing
this nifty oh we were able to get half
the performance of an alien message
passing and we could probably improve
this a bit but that time it wasn't
necessary the contention among all
process were pretty low basically using
atomic operations so it's not zero but
it's low really low and the scales
linearly another thing we we tried first
was also to have the NIF cubing
implemented in a separate thread new
thread but we saw that we got 10 for 10
times better perform as if the execution
was actually done in the schedules read
so that's what we did
yeah another thing we didn't have any
timer timeouts in the the caltrain if so
that means mantha we could have received
statement to see that we have if we have
any control messages in the inbox and we
could use the f2 close to pop things
from the traffic you and so if you pop
something and they tried to pop
something but they make queue is empty a
try mediately again that would just over
flood the Skandar especially since you
didn't have this County thing for lift
course yeah so when you pop the q when
needed to have a timeout before try
again if it was empty okay and then we
were done we doing other things so time
for iteration 2 we need a similar
solution in different project we saw
that so having no message loss and and
push based system me basically means
that when when the system gets
overloaded you either need to drop
messages which we don't want or we need
to add back pressure to tell the user
that they need to tell someone else
right if you pair back pressure with the
ability to outer scale like set up a new
node if you need to do that really quick
we have on standby or whatever solution
what I have then you wouldn't get any
performance degradation either from the
client side
we also had requirements to put the
bleep be able to predict cube the
persistence of the queue off the host
that is running on but sometimes the
host goes down and you don't want to
having to go there manually to try to
pick them up and then set them up yeah
because you want to have this you want
to write code right anyone have
operational things you want to solve
that have that automatic we also needed
some more quality of service options
like for a fire forget or and best offer
guaranteed so guarantee would mean you
need to resend in case of errors at
least a couple of times and we also had
since our systems growing we saw that we
needed we had application a running of
these hosts these notes and we have
application be running on these notes
yeah and if one of those nodes running
application be were going down we will
want the application aight automatically
stop using that for a while and try try
once it connects back again so that
meant would having an if Q and then the
simple worker solution that we had in
the beginning it didn't really match so
we were initially starting to reuse what
we had and see that if that worked so we
broke out the NIF queue and the pulley
stuff in two separate library and but as
you know using a knife is always a risk
if you have some bug or anything
and you also have the new requirements
to supersede the old ones so that having
breakfast back pressure it was more
important than having speedy
distribution yeah till that and we still
don't want the worker to have any mess
any traffic message in its in books at
least never more than one the one that
is there supposed to work with so it
turned out that with AQ was actually
better that it was living in the on the
other side and in the seaside and this
was the solution that we came up with I
have the client the user or whatever you
want to call it do a a synchronous call
to the dispatcher and the dispatcher
with the sickness call to the queue to
get it's cute so it would select one of
the queue let's say that you have in the
messages it's saying that what quality
of service you want and so and what how
much you want to pay for the service or
much yeah so forth and so then they
dispatch ii can choose which q2 to send
to they will all do the same work but
they would have different number of
workers then the dispatcher would do a
synchronous call to the queue and then
you get the message back and there's a
point here to having the synchronous
called mechanism it's a provided the
clients with some some level of back
pressure because their dispatch in the
queue take taking they can't float those
mess those in boxes so the same client
would have to wait a while until it can
do another one and then when they once
the message is killed the queue can
assign the work to one available worker
and once that's done
if once the work is done it sends the
message back okay so we see that there's
the NIF queue with the nifty solution
using that assist send mechanism we had
have to put performance of a line stand
and at the time when I was testing this
I could do for remember right three
million requests a second so that means
every Daleks and so with nifty oh it was
one and a half and with the new
solutions we could have yeah man my test
out the income 100,000 something a
second and depending on the number of
workers the actual were to distribute
the messages is increased it it's this
message this measures only the amount of
work it takes just to send a message to
dispatch to the queue and therefore the
queue to how to work done in a worker
and the reason why the times go up it is
not what you want right you want it to
go down right so but in this case that
the workload the work is the Ling is
zero we just received the messages as it
done it's done so it's only measures the
scheduling the message passing part and
the reason it is increasing in time is
because we're having reusing list key
search let's kick so when the worker
turns
so I see where I'm how do I point in
this anyway so when the oil gets a queue
it just pops from the from q thank you
yeah thanks so when the queue get some
work it just uses reusing a Q the Q
model module to pop some work and that's
that's pretty fast but when the work is
done reporting all those that pc work in
a in the list so we're using it when the
work is done using key take and with an
increasing number of workers that is
african ongoing work you get an
increased time there see
okay this went way faster than most
anticipated and yeah so we know what we
needed to build when you know that we
need to solve the scaling first and
measuring branch parkings post a big
part or development process and so any
questions yes
ok so you switch from NYX to ordinary
Allen see you you switch from NYX to
ordinary Allen messages yes yeah and how
did you solve persistence then you can
dem up the alignment that's true yes
well so it yeah actually we had
implemented at port yet sorry yes but so
in since we're having that in that long
process where the idea is that we should
have a persistent connection to some
external service that does this for us
and the reason we haven't solved this
because we have needed it yet or if we
want to we can have some a mapped
featured for the astro file storage
thing but we yeah it's not so soon
ok so we've no more questions thanks
very much indeed thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>