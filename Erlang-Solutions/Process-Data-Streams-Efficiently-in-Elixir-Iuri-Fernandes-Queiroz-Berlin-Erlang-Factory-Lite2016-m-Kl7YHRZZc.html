<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Process Data Streams Efficiently in Elixir - Iuri Fernandes Queiroz (Berlin Erlang Factory Lite2016) | Coder Coacher - Coaching Coders</title><meta content="Process Data Streams Efficiently in Elixir - Iuri Fernandes Queiroz (Berlin Erlang Factory Lite2016) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Process Data Streams Efficiently in Elixir - Iuri Fernandes Queiroz (Berlin Erlang Factory Lite2016)</b></h2><h5 class="post__date">2016-12-15</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/m-Kl7YHRZZc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">and the first of all what our data
streams and what are we really talking
about here let's first get a small
definition what is that so in computer
science today is the string is a
sequence of data elements made available
over time so the important thing here is
really time so not always you get all
the data in advance and you have to
compute it step by step so this was wise
wikipedia who told us that and it's very
like kind of a defined knowledge is very
cool so here let's take a look at this
equal to 5 view of a system I bro
terribly please forgive me but bear with
me it will be better better and so what
happens as soon as we put some load on
this in the system one that has two tabs
like that goal each one to think I can
okay so that has two tubs and these go
always to the same synced to the same
like destination what happens is like if
you put on one side wall depending on
the speed of that law that's coming it
can give a break on one side of the
system I dearly
system which is processing on this side
shouldn't influence on the other so this
is kind of an ideal case and that's what
we want to achieve chance that things
don't influence in each other if they
don't have but not always that's the
case and depending on the load that you
put things can be equilibrated things
can be stable or they can evolve in a
different way so if you put a bit more
gold like maybe from a different side of
your application you get like an
increased overload in the system that
goes to the same thing again but like
things tend to accumulate if you don't
handle them carefully and like
accumulating like in terms of erlangen
elixir process is something more like
having a mailbox getting full and full
and nobody collecting events or messages
there and until you reach a moment that
if this world is sustained and the sea
air box keeps growing and you don't have
anyone collecting them the thing just
disasters and that was a great time
aspect of our signal so what I want to
point out here is that the size of the
vibes also don't really matter if the
size of the sink the final sink is the
same so even if our vets were they here
or our pipes were bigger it wouldn't
matter in the end
because we will reach the same same
destination so how to solve this so
let's go back a bit and see what was in
the beginning just they simplified you
like how can we avoid this load to be
sustained and book to overload our
system so let's let's install some IOT
devices that we have called red diamond
regulators head over there and they will
be in the points that the system kind of
makes some action makes some work so and
in the point that pipes drawing or
interesting things happened so what this
thing will have this small device will
have is one sensor and walk through
Smith the sensor will say like if it can
handle more data that can handle her
load or in like it will transmit to its
helpers if it can take more goal from
them so the rules the phone if the
following pipe if the pipe that is after
that small device is free you see that
you can think more load then you say to
your predecessor that hey sending work
and that's what we have and as soon as
we as you the first in the bottom
realizes that it can handle more load if
you let the previous know this is just a
message
symbolizing the color just to say hey
this guy sent this message so this will
propagate up like in the system we
propagate to the boundary of the system
and hopefully in the end like your vets
turn oh no sir so your vessel so also
that's what's a couple of hours there
but that's that's important thing that
after you get some load in the initial
boundary of the system the important
thing is to share it to shut it up so
the producers of that load do not keep
put involved in the system so you can
actually work without being alone and we
kind of push the the problem elsewhere
someone else has to handle this load
which is accumulated but the important
thing is that it's not in this system so
we get to this idea of demand driven
communication which what we are using
here so the consumers then
work instead of receiving work they just
didn't the s4 even stay ask for me and
this demand is pushed like to the
boundary of the system as it's
propagating up is bubbling up and in the
end you achieve back pressure with that
so you are not your year previous
producers have a idea of what they are
putting in the system so this pressure
is on so let's talk about how elixir is
bringing this to the language which is
with Jen stage as measurable so in in
gen stage you have producers and
consumers and other types of another
type of stage the domain not talk now
but you have to producer and the
consumer and the consumer ask for load
as for work and then the producer
realize paid my concern is ready to get
more more work and cents at most the
thing that the consumer a sperm this is
the important thing because even if the
consumer is very fast and the producer
cannot catch up with that we are fine
but if the consumer is very slow and the
producer respects the contract respects
that it will send at most this amount of
work it will be fine again we will not
in that cloth situation as we saw in the
beginning so that was the main that's
the main revolution of gin stage to
bring this in normal behavior which is
like this behavior is an abstraction
over data streams it is demand driven so
you don't have just this idea of
receiving load and receiving work
without knowing where it comes from you
actually know when you you acknowledge
that you can that you can accept that
and you become to be over it in the end
this we will see me more details later
and another important point here is that
gin stage being a behavior and the
boating in here it fits very nicely in
supervision tree so you can have this
very nice chrome the processes handling
work supervised in an easy way so let's
go about flow now which is an
abstraction which is maple top of gin
stage which we provide an familiar API
for people who are used to work within a
morbid string never kind of see the same
old and they were can they can even
think it works the same way but
importance get things done and it
provides this clean neat guy while still
being lazy and why are you being very
important so flow it's it's something
like that it sees it looks like that so
you get a fire straight for example
and the first ring just reminding that
this stream is just a representation
just an abstraction from this file and
you turn that in from a new your book
this will be a flow now I knew it wasn't
a numeral because it was just the street
and like you can flood map split things
by words partition them and then reduced
here we are computing a word count which
is very similar way of computing workout
and the important thing is here be
stealing for it and no matter the size
of the file will still be efficient and
in the end of another important thing is
that Indian just when you say give me a
list in them to list is that the work
will start to to follow it will start at
the moment so let's see how this kind of
is mapped into process behind the scenes
like all these bubbles that are seen
there will be stages so that's something
that flow could generate and here is
what I mentioned in the beginning that
there is a producer than the consumer
and this intermediate step which is the
producer also at the same time as Y B
and C it will receive work receive data
and you produce to further further
transformations so the important step
here did a nice step here for examples
from me to see that you have this
partition step of the flow so you are
still being while reading from the file
rename while you were reading from the
fire
you are also computing and also reducing
here so it's a small MapReduce in your
machine very very behave over the answer
so let's show a more realistic example
with like processing Twitter handles
just a very simple stuff it's building
up what we did before so given a list of
Twitter handles get the most use
hashtags and we will solve the same
problem with three more two models in on
stream and flow in on the traditional
eager way of doing processing list
string being a bit more lazy and flowing
lazy and at the same so first we will
define some small functions which would
be like the handles elixir line near
bank factory Chris McCord EVP and west
winds will just use the library to go to
twitter's api search product from that
end oh and return the recent ones it's
kind of it will return what these people
are talking about that's that's the
point so let's see first within now we
are being eager here so remember that we
will take the Twitter and
mother here is just like five no matter
if these are minions or thousands we
take all of them we have a flat map over
open taking the last weeks then we will
split take the hashtags and then we will
split into the same as we did before we
count them so we regroup them and in the
industry essentially the same goal it's
almost the same for just changing two
models two modules and but we are being
lazy here so instead of going for all
the last weeks in advance we will go
step-by-step element by element however
we are still bound to one process
working we are still in the same process
and this guy is the only one with flow
it's a bit different but not so much we
will show just some special things here
just to make it more spicy and we will
first bill to the flow from an
innumerable the same as you saw before
flap flap flap over at them the same as
you saw before with the number and
strength sorry and and then take the
hashtags partition them because we want
multiple Jen stages working here we are
giving
option which is saying the amount of
stages so we have many options at mccann
pasion so this produce root word to five
stages and here we have to say how the
hash tags which are like objects let's
say which are struts in the sky in this
case how they are going to be identified
they need to be identified by their text
so what it has the Sun because it's a
bit more complex data structure so then
we need to reduce them the same way as
we did before the functions almost the
same and turn into an engl remember like
they work only against being begins when
we turn this into an inner meaning we
need the value we need the result so
yeah cool so let's see what this
generates if I don't pass further in
if I don't ask for the result what would
be the what what do we get like we get
this representation of the data
structure of the flow so here you can
see the stages that at last name here's
the operation is going to do the way to
reduce here the flows the producers and
here for example you can see our our in
wood and here are some interesting
options that I'm going to say that bit
more with details before which is the
window here we are not using any window
but you can also say like every 100
every thousand give me some result but
here is the global window toy for every
element give me the result of accounting
accounting up like grouping them up
together so everything Frank so far any
questions ok so let's talk about this
fashion event so one important concept
of jet stage and flow is how do we
actually send work how do we actually
send events data to our consumers so
there are some implemented dispatchers
which are the women dispatcher broadcast
spectrum partition inspector and you can
also customize your so if you have a
custom use case that your consumers are
somehow special and you have to send
information to them
as for some special business rules or
something like that you can always
customize you can define some callbacks
and everything so what you will need to
do is buy how to do subscribe how to
cancel and as for events and some others
so how does that reflect in real life
let's say so you have one producer and
let's say you are using first the
partition is better so you have to have
a partition key and based on that key
you will route this to be CRT broadcast
spectrum it's like instead of choosing
which one you will send to you will send
to all of them and you will that's an
important thing of the broadcast
dispatcher if we regulate if the
consumers have different speeds so if
you for example be the super fast and it
finishes its work very fast compared to
see if we work in to see finishes its
batch to get together the new budget so
you kind of keep this notion mass of
speed between all your consumers which
can be very useful for some use cases
and the diamond dispatcher is like kind
of the first one who demands more gets
more so let's see first like how this we
are talking about events and how
nothing's we do even processing with
Jenkins that comes from your life for
example you have some process and this
process sent some event to
manager this event manager has several
handlers potentially and they have to
process this event according to some
rules but it will do that to all the
functions that it that are defined in
the handler so to F G and H so this is a
defaulting a behavior there's no change
here as more like a comparison and there
are some drawbacks from Geneva that Jen
station tries to route to improve which
first is like the manager runs handling
everything in one person so every cool
that runs against the event data is
Randy it's ran in process and this way
we don't really leverage is that the
beam can provide and it has some strange
error semantics if you ever use Jen
stage or Chinese and sorry if you're
ever usage elegant you will notice that
when you have an error in the handler
somehow all the handlers are out out of
the manager this kind of the manager
says assess well I don't really
tenders are airing out and I just pushed
them which is a bit strange for for a
brush which shouldn't be so a back so
widely the system so how does Jenny then
try to solve it so you will have the
same idea of producers and consumers but
now the load the world would be events
that must be sent like in the list here
and a few inches long but with a
broadcasting broadcast dispatcher you
could have the handlers that the code of
the emphasis in each consumer so this
consumers will would work differently
according to their needs and still like
if there have problems like with ours if
they crush a supervisor can restart them
individually without affecting the
others and as well we leverage the
controversial to me so that's very good
that's very nice but how do we use that
in real life in real life you could
think like this dispatchers that this
consumers and make them do different
stuff written if you create let's say a
product or a user in a database and you
have to send notifications and
to do some kind of data analysis you can
separate this into different models that
will work independently of each other
and can achieve their preference and the
idea is that in the future when Jen
snake is more mature this will also be
possible to do like possible to be done
distribute so so let's see another thing
that is coming with the same batch of
improvements to it sir which is when you
have for example you have a producer and
the consumer and the consumer is somehow
very slow yeah it's nice that we don't
overload our system so we don't put more
alone it but it's also nice if you can
be faster and if we know that this
consumer is kind of sitting around we
could actually run this verb in parallel
what I very brands in be in England's 40
so for that you have a dynamic
supervisor the dynamic supervisor is not
only for that so it's the idea is that
they can be
too many other things but it also
complies with to the same mantra of gin
stage so the idea is that when you get
some even you fire off one child that
will process only that event and as long
as events come you you will work this
according to them children so this
children will be just spun off doing its
work and die and here I could be in the
same letters before but it's important
that these things don't need to be
chance dangers there they just have to
be have the same logic and the dynamic
supervisor will know all about asking
more they have providing more sorry it
will ask more work and also like knowing
how to dispatch so the dynamic
supervisor is can be as i said the
consumer ultimate end stage pipeline and
it has like one condition which is like
it them only has one charm specification
so in advance you provide this childhood
specification and it will of every child
that it has it will use that same
specification however it only supports
the one for one strategy so if your
child eyes only this child will be
restarted ok so far any pushes ok so
let's give some more real examples
say about the structure of to go but
let's process like at windstream the
same as before did it not in the same
example as before but with some more
work going which will be getting tweets
from a specific term and compute the
most use hashtags of the moment so for
that you have to have an idea of
streaming of the moment the moments
what's coming from Twitter aerator we
will use some tools product we use X
Twitter as I mentioned before Jen stage
and flow so you don't need to use Jen
station flow together but here is kind
of a showcase of how they can work
together and since some things are
already very easily implemented in flow
why don't we just using for that we will
implement three modules one producer
which will talk to kind of receive this
tweets from Twitter one analyzer we're
going to all the data processing
gathering the information and multiple
simmer which will just walk just say hey
those are the things that people are
talking about so let's see a bit of the
school so the producer is the first one
is the jet stage it will just fire off
one process
that will be hearing the string and send
it to itself the stream it's important
here that this just for the sake of
simplicity I did it this way but they
work the idea is that your producer
reigns from persistent data store from a
message queue from a database fire woman
so even if it is in this way it will be
not overloaded with it but in this
example Twitter it guides quite slow 22
to the speed of the of the processes so
it's fun but the principles are the same
so we will handle the man that comes
that comes from our consumers and this
demand will be a number here and some
tweets which are like our our safe we
are stories this is no stick so this is
what I'm information with the message
queue that can go very very long if the
consumers are not fast enough and here
what we are doing we are trying to push
just what the just what the consumers
are demanding so we split this this list
of foods that we have in our state by
the demand so we keep the demand we keep
the remaining ones that we send it in
there and even when we have kind of a
long queue waiting when when it's more
than 500 cleats we just push them and
what's important is that risk can still
keep the idea of flushing and sending
events to our consumers and they will
still pick up it's not that they will
work only when they us if the producers
is sending more it will also pick it up
so
here is pushing and here is like didn't
receive a tweet &amp;amp; that's fine you can
gather it in this is in this state and
we will keep it in the state and not
send anything to the consumers that's
important here is what will be
dispatched to the consumers the same way
as we sent the race here here we are
just keeping it so the analyzer the
analyzers whether the otherwise is where
we are going to process do the important
work which in this point we will start
this is just a helper function just to
start this off and it will receive its
producer and its consumers it will take
that producer make a flow out of it and
then turn it in in two stages so in the
end we are just working with stages so
take that in the main flow what we are
going to do take the producer say it's
from stage because our previous previous
module was a gen stage make a flat map
the same way as we saw before partition
it and here I wanted to show off this
this nice nice
from flow which is having windows so you
can say as I mentioned before take that
we know that blue oviedo instead of
waiting for the whole window to finish
just dispatch every 100 elit and the
sign of the key the restaurant has to be
identified by its text so let's reduce
it it will do the same way as before
take these tweets and put them together
and then emit its state that's important
because when you have a consumer later
and this the consumer will take whatever
because should we use us so far here and
on this in it actually go so the final
one which is very simple as more like
out booty it's a gem state as well it's
a consumer and what's important is that
it doesn't need to have any state so we
can put whatever there and and what we
are going to do is like for the
aggregates that come up stream we are
going to sort them take the top 10 and
then display in here the final
aggregates for the book and here the top
hashtags that we could find and I
decided to do here just everything in
one function just like for the sake of
simplicity but you can also put this in
the supervision tree has an it's working
why we consume things love it so start
all of them saying which one is
this is the producer the consumer and
then start analyzer and remember
remember that the analyzer needs both
access to its producer and its consumers
that here are just a list and just sleep
forever and wet sometimes so let's try
this out so first thing that I wanted to
show my people who talk about it later
maybe are talking about l very next
let's do that my legs are sales I got
silence absolutely nothing because
essentially you get one tweeter being
untied an 11 hour and to test that was
not really great the same with the lakes
Erlang kind of a bit more it lasts any
other time but then I decided what are
people talking about in this moment what
is about something that we will get a
lot of things from man everybody's
talking about you and that's what I got
curious and like I receive that Donald
reason okay less processed it was
working fine in the end I separate of
its or something caveats and that's what
I got like a bunch of hashtags are some
somehow funny I mean like I was at some
more messes watching what people are
pretty funny and like this Indian this
is a very simple there is no black magic
involved here but it provides a powerful
solution with which shows how flexible
is all these models and here I didn't
show some other options that you can
configure like what is the next in
that pure except what is the mean dinner
but this thing is like depending on the
use case you do find this in the
documentation so as a conclusion it's a
powerful abstraction it's full of
potential it's experimental just
remember I omitted the any less
experimental stuff here because yeah it
was something some part of the code and
it's coming the future releases of the
mixture the idea is quite stable i have
been playing with this for some time now
and flight minerals and shrink repairing
for the top it's almost nothing changed
and if you want to learn more just go
there with the dogs they are pretty very
accessible there is super showing with
many details with many examples with
drawings with pictures and the code is
also very very nice to read not
difficult and learning one learning
summer-like is like the book what is
also learned in it it's a very important
thing that we have to keep in mind that
we can only achieve this because of the
view so thank you if you have any
questions on here this is my Twitter as
yourself
suzette distribution was yet to come yep
do you have any make sure and white
distribution we different notes in the
meaning that you let's assume that you
already have that meaning that you can
have stages in different notes so you
say that now my consumer is not here but
it's in another note and like we will
still use the real life and distribution
for that so there's no change on the
underlying concepts back any other
questions this is usable capacity Alex
EU or yeah yeah like Indian mixer end
oh Jenny you can use one set of the
other with some caveats but you produce
it is theoretically yes I don't know how
far someone tried to do it especially
with Jen stage which is very
experimental but like with other
libraries like in the winter you can use
your like libraries and the other way
the other question okay very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>