<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Tech Mesh 2012 - Eden: An F#/WPF Framework for building GUI Tools - Tobias Gedell | Coder Coacher - Coaching Coders</title><meta content="Tech Mesh 2012 - Eden: An F#/WPF Framework for building GUI Tools - Tobias Gedell - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Tech Mesh 2012 - Eden: An F#/WPF Framework for building GUI Tools - Tobias Gedell</b></h2><h5 class="post__date">2013-08-12</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/BsOtAXV_URI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so as well said I worked for groceries
and I work in a quantitative strategist
group and what I'm going to talk about
today is a new framework that we use to
create the next generation graphical
tools that we are delivering to all of
our users and this framework is based on
both F sharp and WPF but I will spend
most my time talking about the F sharp
art and I have really few slides I don't
have seven slides I don't have
information for them and the rest of the
time i will actually spend writing code
I like writing code that I hope that you
will like it as well and but before I
start talking about the framework itself
in writing code I thought that it might
be good to give a little bit of
background to who I am and what I'm
doing so as I said I work in the
quantitative strategies a group and what
we are is a modeling and analysis team
at credit suisse and the things that we
do is that we build all of their
official models and tools that are being
used to value traits so that would be to
look at the traits that we have on our
books and then trying to figure out how
much we have lost on these traits or how
much money we made we also may make all
the tools and models for doing pricing
so that is something that the trader
would use when a client calls up and
says that i want to buy this or I want
to sell this then they would use our
prices to figure out how much H you
charge for it and we also produce all
the models and tools for evaluating risk
and also doing analysis of the market
and the way that we work is both that we
implement all the models for all the
existing trades but walsenburg work very
closely with the trading desk so it
could be that one a customer calls
arbitrator says at all I have this great
idea of the product that i would like to
buy from you and we have no way of
valuating these then the trader would
come with us and I would work that would
get our help and then we would create a
new model and we would also help them
journalize things like with risk
exposure so
the way we do it is that we use the
number of programming languages so
traditionally we've used a lot of C++
and nowadays we tend to mostly you c
plus pass for the more low-level
components where performance is really
crucial so that would be if you have
like equation solver or monticola a
simulator or something like that then
that would most likely be implemented in
C++ then we'll have a quite big layer of
F sharp code that lives on top of the HD
Plus passcode and and that is really if
you would go away and bright a model for
some kind of product then you would use
already exists in C++ components but all
the new logic that kind of captures the
new details about this trade would be
implemented in F York and F sharp is
really great for that so I'm i really
love Haskell and has feels really good
because you have all these nice things
would rank to polymorphism and we have
type classes and everything else at that
doesn't exist in f-sharp but F sharp
still has a lot of good features so it's
a function language you can write things
in a function way it has get has a
debate data types it has polymorphism it
has a lot of nice things and anyway you
can almost say that F sharp is like it's
likely poor but also grown up and
brother of Haskell so you lose a lot of
things but it's a real language you have
support for it in Visual Studio you have
a good debugger you have intel says you
have all these tools that don't will
exist for Haskell and also you have
access to all of their libraries that
exits on a.net the platform so f sharp
is really great we also use excel as our
main UI platform so we've right
analytics in c++ when a pitcher but then
the tool that the traders are actually
using will most likely be in Excel
spreadsheet and there is some C sharp
code floating around as well so we don't
tend to use a lot of C sharp but some of
the IT groups are using C sharp D
interface with our code and that is
another great benefit of F sharp so you
can write a piece of a pure code you can
call from C sharp they don't really know
that we are using a short and you can do
it in the other way as well and then we
have some legacy use of some proprietary
and languages something called paradise
that the length was part of
is now deprecated we have some other
languages like PDC to that is a language
for writing multicolored scripts so we
also let their floating around so and
back to Eden so what kind of started
Eden was that we had a product that was
running before it and I was called
Paradise and the name paradise in need
and they're quite similar so what we did
was that we use excel as the UI platform
but it's very difficult to write
complicated spreadsheets so therefore we
wanted to have a more high-level
language where it could kind of describe
the prices that you wanted to have and
then it would automatically generate let
spreadsheet for you and that was
essentially what paradise was in
paradise was a dsl embedded in haskell
and paradise was really great and his
great idea and it was implemented really
good way the problem with paradise is
that Excel isn't really a good platform
for creating user interfaces and it is
not a very good calculation ending it's
a little bit slow and there are a lot of
problems with it so we want to move away
from Excel and two of the reasons is
that we want to be able to create much
richer user interfaces and one of the
problem and especially more dynamic and
one of the problems with excel is that
it's actually a two-dimensional grid you
can lay out some controls it work quite
well and it's good with excel as well
because all the spreadsheets they look
the same but if you want to have
something like a tabcontrol you won't
have document window so we have
something like that then is extremely
difficult to do it it and not to say
impossible to do it in Excel and even
though you can have some things that are
dynamic you can insert a new row so you
can insert new columns then excel is
very slow at doing that so it just
hasn't really worked it has worked for a
surprisingly long time and I couldn't
really believe it or not John Curtis is
five years ago and to kind of see that
the scale at which we use Excel it's
it's amazing but now we've cannot reach
the limit and then the second reason
that we want to move away from Excel is
that even though you can do things and
it was held yesterday by some opinions I
think saying that Excel it's really
functional programming language it's a
quite simple program language but still
it
the program language and it's functional
but it doesn't have any support for
structuring the code and you can't
really create functions with extended
excels you can actually write lambda
functions inside the spreadsheet but
still you don't will have any strategy
you can only use kind of convention
saying that maybe the input should be in
the top left corner the calculation
should happen on a different tab and so
on but if you've seen a spreadsheet with
thousands and thousands of cells spread
everywhere and you have strange formulas
so you have a lot of data dependencies
and it's very difficult to debug it it's
very difficult to understand how it's
working and hence it's very very
difficult to maintain it it was very
difficult to share functionality between
different spreadsheets so this is
essentially what their we wanted to do
then we kind of we said that we need to
start on scratch now and we need to kind
of look at what requirements we had and
we came up with a list and we can group
them in in three parts the first part is
around what kind of calculations that we
need to do and how we need to be able to
do it so first we want this engine to be
lazy and we want to have support for
partial recalculation so that would be
that you have a price of that has a that
is evaluated a trade then the market
changes a little bit then we need to go
away and rip that reevaluate the price
but we don't want to change the things
that didn't depend on the change in the
market so we want to be clever we also
want to have support for caching and
it's really important that we can
produce things asynchronously so we want
to use this engine to create new user
interfaces and you should never lock the
user interface so traders they are quite
vocal if a trader doesn't like anything
then they're going to complain about it
and the UI blocking they will definitely
complain about it and since the traders
are one making money that means that you
need to actually fix it as well then
another thing that is a bit unusual
about our bark and I would guess most
banks in general is that the mothers who
are actually the ones writing the code
there are not computer scientist I don't
they're not really programmers they are
more they tend to have a PhD in math
during physics and they're really math
guys they know how to write the model
kind of the math model and cannot figure
how to evaluate the price but the
cultural write code and we are in
situation now where we helped a lot of
machines that are very fast and a
typical trader machine it has like a
course or so a lot of memory and we want
to make use of all these course but we
can't tell and our model is to go away
figure out how to write multi-threaded
code so we want the framework to do it
as much as possible for them and the
manual calculation so and that is so
what we want to have is that we won't
ever use interface where values are just
ticking so as the market is changing
then you get new prices and things are
just flashing traders like that but
sometimes if the calculation is really
slow then we won't have some way for the
trader to say that don't evaluate this
result automatically but only do it when
I tell you to like pressing your buttons
so so you won't have a difference
between things that are council it
constantly flowing through the system
and things that are evaluated more by
demand and finally we also want to have
support for translation so imagine that
the trader is entering some data yes a
client on the phone he sorts evaluation
and then the client says that all know I
actually want to do d do this instead
that we don't want to trade to be forced
to wait for a minute or so and to get
the result and then start another
calculation we want to be able to
instantly abort everything that is
happening make a change and then we
started so all these together let us
here to base their framework on a
dependency growth and I will just draw a
small picture here to show you what I
mean so I'm not sure if you can all see
this but what we have your reset we
don't have notes and we might have some
notes that are input nodes and I will
see
is it better yes perfect so what have a
few input nodes then we're going to have
some notes that are going to depend on
these inputs so it might look at
something like that then we're going to
have other nodes that depend on these in
turn and then finally we might have some
output node so it's almost like you can
imagine that these are if you take a
function then darkness to the patient
that would be turning to impotence the
result of the function that would be a
final output node and all the
intermediate calculation will be
captured inside notre so each node here
is going to contain a function that
takes a value of the dependencies
applies the function produces some
results which will then be consumed by
the notes and further down so we won't
have we want to be able to express all
of our calculations in terms of a graph
and now what we want to do on the UI
site is that we want to for example have
a text box here connected to an input
node another text box here connected to
thank you but no and then some box down
here that is connected to this one so
then the idea is that inside the user
interface the user or the trader enters
a value here it's going to change your
Valjean put note you will kind of flow
through the calculation growth and then
we're going to get any result that will
just pop up in the user interface so
this is what we want to do and another
requirement and also one of the the kind
of bad things with the previous
framework that was based on haskell is
that it was very clever you've wrote
acid code it generated some other has to
code you ran that and he generated some
vba code and the spreadsheet and then
you ran the vba code and then you go to
the spreadsheet and it was working
really beautifully the problem though is
that when you had a bug in the generated
spreadsheet and it had like hundreds of
thousands of cells with random things
then you had no way of kind of
connecting this broken phone in a
particular settings / g back to align in
a hospital that was extremely difficult
to do so it was more or less impossible
to debug these spreadsheets so in way
this is a counteraction to that so we
want to make sure that the code that
of writing in the new framework is
exactly the code that gets executed when
they run the model and for that reason
we decided to base everything on shore
and have a kind of direct F sharp
implementation so that means that a
molar that writes a model in the new
framework can use all the normal tools
that are available in wishes to do you
can use the debugger and and it just
works in the normal way and and I'm
finally we want you to have access to a
wide selection of UI controls and we
also want to tap a separation between
the logic that were in formatting and
the view and the reason for that is that
we can implement the logic once and then
we can have a view that is like normal
windows application we have something
that is web-based or we could have
another system that is consuming our
logic and and then in order to to
achieve that we decided to use WPF which
is a windows presentation framework a
thing and then we're making sense the
use of the model view viewmodel pattern
and what this pattern is giving us is
essentially that the way that you can
connect a text box to no gir it's almost
like using message passing so if you
change the value in the user interface
language send a message to this node
then it's going to kind of flow through
the value and then Lisa back end or the
view model is going to send a message to
the I saying that now you need to go
away and update yourself so you can kind
of think about this s message passing
and I will come back to that a little
bit later so time for a demo and now I
have only one more slide that contains
information and i'm going to write code
instead so and what i will do is that i
will implement and a simple version of
the calculation grove so you won't have
all of the features that we have in our
real production growth but then i'm
going to do this in half an hour man it
took like a year to right there the
realtor dashing grove so that would be a
bit strange if i could reproduce it and
but most of the important features are
going to cover today so there will be a
lot of kind of slightly boring technical
things that will not be covered
so let's get started oh and by the way
if you don't know if sure and then this
might be a good introduction as well and
I really like f sharp so hopefully you
will do as soon as well so the first
thing I will do is that I will create a
type for a node and I'm going to say
that the note is either an input node
and if it's an input node then is going
to consist of an integer reference and
you can think about a reference as a
container of something that is mutable
so that means that you can kind of you
can look inside the container you can
extract the value but you can also
change the value so like Haskell F sharp
is image by image by date by default so
if I would just say that in infinite as
an integer then that's it we can never
change it but we actually want to change
things here and then I'm also going to
say that a note could be an output node
and to simplify things here I'm going to
say that each output node always depends
or always have two nodes as it said
dependencies and and then finally it's
also going to have a function and that
takes two integers and then is going to
produce the result so I'm very very
simple and data type so I'm going to
select it and I'm going to send it to F
sharp interactive just down here so this
is a bit like a ghd I see it's a ripple
and compared to c sharp so and this is
going to come for see shopper as well in
the new version of visual studio but you
don't have it yet 4Â°c shop and this is
really good for your productivity so
compared to having to write all the code
than executing it or compiler than
executing it that is very very slow and
it's also very difficult to run exactly
the new code that you written compared
to u.s. writing the code copying down
here then immediately it gets
interpreted that's really great so we
also want to have an evaluate method
that takes a note and then it's going to
return the value of the node so what I'm
going to do is that I'm going to inspect
the note to see what kind of note it is
and it's either an input node and if
it's an equal note that i'm going to
bind are there to the referee
we already know that we don't really
need to do anything in order to evaluate
this note so I asked immediately return
the value of the reference so and this
is not a great thing with F sharp m and
the integration of issues to this so you
already see here that I get these
squiggly mugs here and then the
intellisense he is able to tell me that
oh I know that the no type is either an
apron odor and I put note and you
haven't covered all of the cases so it's
really good anything even tells me which
case i missed as well so if it's an
output node then I'm going to bind to
the two nodes and one + M two I'm going
to evaluate them and then finally I'm
going to apply the function to the
values v1 and v2 and now you notice here
that we get these red squiggles here and
you're saying that the evaluate similes
and define and the reason for that is
that by default functions are not
recursive in f-sharp so if you want to
be able to call it recursively you need
to also put the red key border so let's
take this and copy 2 episode so you see
that it compiled file and evil is now a
function that takes a note and returns
an integer so I also want to have a
function that allows me to change the
value of the node and so it's going to
take a note and a valley as arguments as
before we are going to inspect this node
so if they if it's an input node here
then we're going to get the reference
and now we're going to update the
reference and you do that with a colon
equal so that will overwrite the
previous value and and otherwise is
going to be an output node I don't
really care about the components i just
use underscore pad match and then what
we'll do here is that we're going to
fail cannot set value of output node so
like that and we can send this to
everyone and work so now I'm very soon
down with the first version of this
calculation graph so I need to have ways
of constructing these input nodes oh
well I don't really need you because I
could come
strike the notes directly by using the
input and output case but I will make
some changes to these later so i will
create i will create an API that kind of
abstract so release so input your is
going to take an initial value and it's
going to create an input node that
contains a reference within with the
initial value I so let's send that and
you can see that it takes an integer and
returns a note for functionals or output
nodes are going to take that you know
that I depend on and I'm going to take
the function so that emphasized and it
seems to work perfect so let's create
some notes so I'm going to create a few
impotence so I 1 I 2 and I 3 like that
so you can see they're whole notes I'm
going to create chief function notes so
this is going to depend on the first two
and here are you see lambda abstraction
so the function is going to take the two
values it's given and then it's just
going to return the sum of the two
functions but before it does that i'm
also going to make sure that it prints
something out on the console so we can
actually see that it's evaluating so
it's going to evaluate and one and then
make another one let's call it m 2 and
select that and some send these tips I
and now we can go away and we can
evaluate and one and as you see here it
printed out eval and one so it has
actually run this function and we get
back the result three which is indeed
what we were expecting and we can do the
same for and two here and you see that
it applies the function and we can
change the value of i 1 to 100 and then
we can evaluate and one again and you
can see that we get the new value so
this is already quite good so we have
something that we can almost connect to
use interface now we
use whenever the user changes something
in the yard we can call this a value
function and that will change the input
node and we already have lazy evaluation
because nothing is actually evaluating
in the growth before or until the you I
actually asked for the value but we have
two problems so the first is that how
does the you I know that it has to
request a new value we could set up in
such a way that as soon as the user
makes exchange then we go away and we
evaluate all of the nodes that are being
bound in the UI but that might be quite
slow so we won't have some way of kind
of tracking the changes and notify the
ious some of the results might have
changed and another thing that we don't
have support for either which will be
apparent if i evaluate and two here is
that none of the dependencies of m2 has
changed but if i evaluate the until
again then you can see here that is
still going to apply the function so
it's not keeping track of what needs to
be recalculated and what doesn't and in
order to solve both of these problems
I'm going to track dirtiness and by
dirtiness and I mean that if the value
of this input node is changed then it is
going to trigger an event and that will
make sure that all notes the due penalty
snowed will be flagged as being dirty
and dirty means that they might
potentially change a value and I'm going
to do this recursively so the entire
kind of transitive closure of all of the
forward dependencies of input will now
be flagged as dirty and whenever a node
is being flooded dirty this will then
send a message to the I saying that
there might be a new value and you might
be interested in requesting that value
then the UI can go away and see if if
the text box that is connected to this
node is visible then the user might care
about the new value and then it can
request the new value so let's make that
change so I'm going to add an event to
the input node so it's just going to be
a normal event and this is the event i
will get triggered as soon as the value
changes for an output node and we need
to do a little bit more we need to
remember the previous value otherwise
because every time we evaluate no we
need to return the result
but previously we never remembered at
the results so we're going to add a
reference that is the last value we also
need to have a reference for bullion
that tells whether the note is dirty or
not and then finally and we need to have
the dirty event so let's send this to
everything and that works so now in the
evaluate function here we need to add
the event to the path match for the
input node but we don't really care
about the event so we're not going to do
anything here though we need to bind to
the last value we want to bind to dirty
I don't really care about the event
we're then going to see if if the node
is dirty and if the node is dirty then
we will go away and we will evaluate the
two nodes we are going to apply the
function and we're going to update the
last value and we also need to remember
that we should set the dirty flag to
false and then finally we are going to
return the value of the last value so
you can see here that if the node is not
dirty one mentor the eval function then
we will immediately jump down to that
line and then we're just going to return
the current value of the note so let's
go police and traffic sign so when we
set the value for an instant know then
we need to make sure that not only do
you update the reference but also that
would trigger beware the dirty event so
we just do that by calling the trigger
method on the event itself where you can
sign that Jefferson so I when
constructing input node we need to
construct the event we don't really need
to do anything special here because um
it's always the listeners that need to
set up the event so we just need to
create one here we can send this step
aside for a functional though it gets a
little bit more difficult so first we
need to create the reference that holds
on to the current value and no way I was
going to say that all nodes are going to
be created with CRFs as in
a value that doesn't really matter
because as soon as you ask for the value
then it will immediately go away and
re-evaluate it and I'm also going to
have the dirty flag and we need to make
sure that all the album notes are dirty
when they are created and also we need
to create our event here so like that so
now I can stick these things in here
dirty and the event and this shirt
perfect so I can even send this to FSI
as well but now I've forgotten something
and that is that i need to make sure
that the darkness of this functional is
linked to the dirtiness of the
dependencies and in order to do so i
first need to write a function called
get event that will take a node and this
is going to be the dependencies and then
is going to return the dirty event of
these nodes so I'm going to match a note
if it's an input node then I want to
return the second component if it's an
up note then I want to skip the first
two that are dependencies of puncture a
less value the dirty flag and then the
event so if i move the mouse over get
venture you can see that it takes a note
then is going to return the event and
this is event that we need to listen to
you so I'm going to call get event on
and one in order to listen to the event
we need to first publish it then we can
add a hammer and what we're going to do
in here is that we're going to set our
dirty flag to true and then we need to
make sure that every every node that
depends on this note is also dirty and
we do that by Ashley triggering our own
and dirty event so like that and I need
to copy this and do the same for the
second dependency and this should be so
let's send this to Travis I'll so that
seems to work
and I can now re creating the notes
recreate the function notes I'm going to
do the same about like this you can see
that they are evaluating again the right
results are you evaluate and one here
and now the moment of truth ah it didn't
work I will sir be let's evaluate it
that I can oh okay I guess forgot the
valley so the first time we evaluate
then two then is going to be durkee the
second time we evaluated nothing will
happen so you will just return the
previous value unless we of course
change your value of one of the bed
dependencies so if we would set this to
44 for example and then we would
evaluate and to then you will see that
it actually goes away in evaluates the
note so this is actually quite cool so
how many lines of code do we have not we
have 36 lines of code and in 36 lines of
code will have something that you can
actually use to write a rather modern UI
using WPF and you can connect more or
less directly to the graph so one thing
that is still a bit bad with this is
that you can change your value here it
will change the value of the info note
is going to propagate dirtiness and it's
going to notify the UI that there is a
new value you might be interesting
request me but as soon as the UI is
going to request the value then it will
be blocked because it will then go away
and evaluate all the dirty dependencies
until it gets back and in this example
it's quite quickly do so because we have
a very shallow graph and also the
functions that were executing inside the
notes that are very quick but imagine
that one of these is going off to farm
and doing crazy stuff for intakes like
minutes then the eye is going to be
blocked for a long time so we want to
make sure that all of these is happening
asynchronously so the way that we want
to lease to work is that these notre is
going to send a message saying that i'm
dirty then these sir text box here if
it's interesting in the value then we
wanted to send back a message saying
evaluate then this will just go away in
evaluating the background and then when
it has a new value it will send a new
stitch to the UI control saying okay I'm
done and here is the value and this can
be a bit difficult to do so um it was
one of the people in their own
presentation today saying that if you
have something that is asynchronous is
very easy to make a synchronous but if
you have something that you think no son
is very very difficult to make it a
synchronous and everything so far in our
code is synchronous so now we need to
somehow make it a synchronous and that
isn't at all as difficult as you might
think it is and the reason for that is
that f-sharp has something that is
called workflows and a workflow or a
computation builder or a computation
expression that is also known as is very
similar to Mona in Haskell and that kind
of allows you to write code that looks
like normal code but they will kind of
be lifted into some other domain and
there will be magic happening and in the
async workflow the magic that is
happening is that all of the code will
always wanna be asynchronous so that is
what I'm going to do now so we don't
need to make any changes to the node
type itself it's perfectly fine the only
thing that we need to change is a
evaluate the function so what I'm going
to say here is that it's instead of
returning an integer it's now going to
return something of type a sink in and
async is a computation or a calculation
that can be executed in an asynchronous
way and when it's done it's going to
give you an integer the way that you
turn a piece of normal synchronous code
into a synchronous code is by using the
async keyword and then everything that
it is within the curly braces will
automatically be turning to something
asynchronous now in the case of the
input now there is nothing really to do
so what we're going to do is that we're
just going to return the value and if
you wonder then this return here is the
same as the returning and has them on it
so I'm going to do the same with this
guy down here
Let Me In sent it so we know that down
here instead of just having the value we
need to return it and and now you can
see here that we have a tie problem and
here you're saying that the function f
here it expects something of type in
here but instead is being given in a
sink in which is a computation that
would give you an integer if you were to
executed and and that is a bit of a
problem and we don't really want to so
we can certainly take that evil and
Wonder and then we could start running
it but the problem is that if we start
running it and we do it in a blocking
passion then this code will still be
blocking even though we are running this
thing is synchronously the rest of the
code is kind of sitting there waiting
and is blocking the thread but that is
where we can use some of the magic in
the async work club so instead we're
going to you something that is called
left bang and what let bang will do is
that it will look at all the code after
the right hand side here eval and wha
will turn all of these code into a
continuation and then it's going to
evaluate and one and it will do that on
the background and it's going to give
the compression to the evaluate and one
function so that means that there is
actually nothing blocking here if you
would call this then it would
immediately return but you would have
something that is in the background
evaluating and one and as soon as it's
done with that is going to continue
running this code which will again do
the same trick for this evaluate and two
so with very little changes to this code
we have been able to make it completely
asynchronous so now eyes on that you
have a sign i'm going to okay i'm
slightly running out of time so i'm
going to recreate these notes now if i
evaluate a no now you see that i get
back something that is asynchronous it's
not an integer that we were expecting so
i need to create a new function evolve a
sink we are going to take a note here
and what I'm going to do is that I'm
going to evaluate the dough and then I'm
going to print up go to value V here
select that and then finally what I'm
going to do is that i'm going to start
this on the background thread so let's
send these to the side so he will have
evil they think here and now what you
should be able to see is that I may I
made the call here it immediately return
unit so that means that the thread of
FSI is not being blocked and then after
a while it went away and it start
evaluating the note and then finally it
got the value three so this is pretty
cool so now we can using this
implementation we can actually support
this interface here that it tells the UI
whether some when something is dirty
that you I can request the value and a
little bit later you will then get an
update saying that I've gotten a new
value and so this is all good but I also
said that we wanted to have support for
running things in parallel and one of
the great things with having a calcium
growth and in this way is that if we
make sure that all of the functions
inside the note are free from side
effects then it means that we can
actually evaluate all of the notes in
parallel so these known here can start
evaluating these two children in
parallel and nothing can go wrong the
only thing that can go wrong if you are
not to be careful is that if if these
two notes would have a common and
dependency then you don't want to start
evaluating these twice you want to be
able to actually share computation and
that is one of the things that are a
little bit tricky to get right and and
that web in the wheel karajan growth but
i'm going to show you how to do that
today so i'm just going to create an eye
evening and i will update these things
to print after and the thread and that
should be system with ranting red
Karen thread and the manage I ding
perfect so I'm going to recreate these
let's recreate that one yeah and I'm
going to create another node and three
here that depends on and one and two yes
so we can see the things doing its magic
so senator and and then I'm going to
evaluate and three year and as you can
see everything is running synchronously
and it's running on the same thread so
but this is very very simple to address
so the f-sharp acing workflow has
something that allows you to give you a
synchronous computation and it will
automatically run them in parallel and
you do that by using something called a
sink parallel so as you can see it on
paper it takes a sequence of acing stuff
and it will get give you back a single a
sink that has an array with all of the
results so what i will do here is that i
will tell it to evaluate and 1 and n 2
in peril it's going to return an array
with the values instead of using v1 and
v2 i'm going to extract the values from
the array and that is all the change we
need to do in order to run all of these
in parallel and if you wonder where
they're going to be run then the async
clear workflow is using the.net thread
pool so all of these will be wrong in
the background and it's going to manage
all the threads for you so we can change
these things and now evaluate and three
and as you can see here they're clearly
being run in parallel so we saw to
Valerie and one here you started writing
out the thread ID but then in the middle
of the second note I started running it
was running thread seven so the first
note was being evaluating thread six and
then the third note i got evaluated on
Fred six so here we have it and how many
lines do we have now so we have 37 lines
of code and now we have something that
you can you can just take this you can
connect it to WPF and you have a very
good and being freshly running these
calculations and so that is actually
very very cool i will ask found minute
to show you a small demo so i'm just
going to add some stuff to FSI then all
of this code is essentially what I've
just shown you but it's actually
implements the protocol that you need in
order to drive a WPF then I'm going to
crack had some AP notes some function
notes I have an object that can
visualize these graphs I will add it to
window and then i will start an
application so let me see so we probably
want to maybe so okay so whatever I
communicate a little bit bigger so what
we have here is that all of these things
they are input nodes these things are
Cassation notes or function notes and
they are read now because they are dirty
and you can see that the initial value
is zero when I press the calculate
button here you can see that how it goes
away and it starts evaluating all of
these nodes in parallel and just to show
you that it actually does work i will
change the value of here and now you can
see how they are getting turkey i will
change in this as well i will start
catholic and i will move the window to
show you that it's not blocking so there
you go it can't easily be done and now
back to my slides so i have only one
more slide here so and i thought that i
should tell you a little bit of what
works with this framework and what
doesn't really work and we'll be using
this framework for two two and a half
years now and we have actually use it to
implement some pretty big applications
so we have one application that we have
been around four to six people working
on it for up to two years so that is a
lot of menus that are gone into that
application and that application is
replacing some of the biggest and most
nasty and horrible spreadsheets that
will have at the bank that were just too
big so in Excel is difficult to use more
than three gigabytes of memory and this
very often
indeed sir so we we have really
implemented that in the new framework
the UI is very well received by the
users that is actually a bit of a
problem because once now when we can do
everything that means that they will ask
for everything as well the
responsiveness and the performance have
generally been very very good and when
you run one of our applications you have
these eight cores and you see how it
just goes up to one hundred percent on
the cpu any uses all of the course
that's actually quite cool and you don't
need to do anything in order to to get
something that runs in palace you don't
need to think about anything there are
no locks or nothing that can go wrong if
you're a model and it's also quite cool
because it means that we can essentially
get features like undo/redo so unlimited
under you redo we essentially get for
free because we just have a growth fair
so if the user makes any difference we
just need to keep a log of all the
changes that have been made you an input
node and if you want to undo something
then we just unroll that log and it also
works with having a button that runs
some arbitrary command because we just
record the changes that come on is doing
to the growth and then we just unroll it
we also have automatic support for
persistence so you can run our tool and
at any point you can you save down the
state to your file so essentially what
we do is that we ask need to save all
the values for the input nodes we're
actually saving down some of the output
nodes as well so we can use it for
regression testing but essentially yes
save down all the values of the input
nodes to file the new clothes
application Europe with application you
load back the state and everything is
exactly and like it was when you close
application so that is pretty cool so
the things that could be improved so the
first thing is that everything would
break if you start having functions that
have side effects so that means that you
really need to program without having as
side effects and that can be a little
bit difficult for some people it's a
little bit difficult in the beginning
but then you start getting a little bit
more used to it but then the second
point unfortunately sometimes you need
to have side effects it could be that
you have two notes that are kind of
giving you different views of the same
thing or you have something that is a
bit like an equation so changing the
value of in one node should have the
effect that you change the develop
another input node so what we're done
there is that we can realize that we do
have some need for side effects and then
we have added support for it in our in
our
groff so we kind of give you a little
bit of freedom to have some side effects
but it's strictly control and you can
only do it in the way that will allow
you to do it and then another problem is
that I'm and this is not really anything
that is specific to our framework but
once you start writing a synchronous and
heavily paralyzed code then it's very
difficult to debug it seen though you
can use the debugger then most likely
will not be situation where you have 500
calculations running at the same time on
different threats and you're not really
sure how exactly they relate to each
other and and the final point is that as
long as you kind of stay inside our
framework and use of a graph and use the
controls in WPF and use our kind of
protocol for sending values back and
forth then everything is really great
and beautiful if you try to do something
that we don't really support and that
will be a little bit painful am and I
was really the end so any questions so a
new question to be honest um I know I'm
not one of those microsoft posters but
I'm not married to Microsoft yet I drew
so how easy would it be to run something
like this on mano on another platform
windows and so if you ask me that a
couple of weeks ago I would say that was
extremely difficult because Mona seem to
be dead but I know that they just
released a new version and to be honest
I don't really know we are quite heavily
married to Microsoft so I've never
looked at mon or so but there is nothing
there's nothing in here that is really i
would say dotnet specific or even F
sharp specific anyway that is in
workflow you can easily write it in
haskell you could do it in most other
languages I think we rely on the thread
pool being quite good at carrick rating
and destroying threats but otherwise you
can you can take this idea and implement
in your favorite language quite easily i
would think and it works as well
my thanks to Tobias they're clearly the
gate the demo gods were with you I mean
it's a brave man who not only demos but
codes on the fly and roars so thanks
very much for a real interesting second
again folks if you could register your
feedback on the way out greatly
appreciated thank you I don't</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>