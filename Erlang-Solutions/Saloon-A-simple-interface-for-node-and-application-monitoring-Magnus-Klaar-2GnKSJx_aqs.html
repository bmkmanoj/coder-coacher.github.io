<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Saloon - A simple interface for node and application monitoring: Magnus Klaar | Coder Coacher - Coaching Coders</title><meta content="Saloon - A simple interface for node and application monitoring: Magnus Klaar - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Saloon - A simple interface for node and application monitoring: Magnus Klaar</b></h2><h5 class="post__date">2012-05-21</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/2GnKSJx_aqs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so talk today intended to be a pair of
applications so the gold rush is sn1 was
sorry I need some context here did
anyone go to the far west talk okay so
two persons either way the forest talk
was about this more or less web
framework for airline that Louis is
developing and in order to make it sort
of user-friendly you want to export
stats information about vm and events
that happen when you execute the
applications and this is basically the
two components that we were intended to
use to sort of make that available to
users and does this one work yeah so me
and
and because this is not going to work
yeah miss movin here instead yeah I used
to be the IT guy the small internet
service provider in Gothenburg and no
one likes being gai TI so I sort of quit
my job decided to go back to school and
parental learn airline did actually
while I was working but sort of my point
the Allison work on e turn and cowboy
and I think I probably answered your
question on the airline IRC channel
because it's usually where I'm at
so basically while being I think I get
really bad experience with systems
usually custom systems that were
developed in-house you almost have no
blogging and no stats or whatever sort
of depends on how good your in-house
systems are but general my impression is
of them is that they're worse than more
established isn't like routers or
databases and all those things
yeah so did anyone go to the falls and
talked earlier everyone so it's kind of
a spread but that was basically about
data like collection from airline and I
heard on the pub yesterday song was
raving about how annoying it is to not
have any information about what the
system is doing and how it's doing and
so how can we sort of fix this and I
think it's especially important we're
talking open source pairing applications
because to me you usually have the
source code available but that's only
friendly to developers and often not
them either
so we want to collect data and
information from running our language
applications and that includes the
airline vm itself and we want to do
during development the testing and
deployment so we get better
understanding of what's going on and so
one way to do this is logging and that's
usual down as human readable text
messages so you get really ill defined
data format and usually have to add
parsing parsers in order to process it
after the fact and often they don't even
include the context of where this
happened so we see if we say we get an
error in a process and we're basically
two others were set there is a modular
and some argument or for you say e
torrent we received a block request
basically send me data from one pair to
another I think I had a message there
were the process ID the container
prosody and the parameters and that
doesn't really help if you're trying to
correlate this with seiya Wireshark dump
doesn't
so we kind of want that provided at
runtime for each thing that we collect
and another problem log levels is as
well as yet bug error and info and when
you have a problem you yes you switch to
the debug log level and then you have
100 megabyte file afterwards and that's
not very helpful either and logger has a
really nice feature for sort of
augmenting these two levels is you're
allowed to add tags to a log statement
and they were able to select on those
tags to create a log file containing
only the entries that match that and you
think that's kind of a good way to do it
you also have Jen event built-in toe TP
to do this and the single process and
you add handler modules to that and it's
a check executed one by one as the
events come in and kind of slow and you
have no filtering of the events so you
always need to send the events to this
process and filter it in each handler
and which is kind of inconvenient as
well and then there's a row logger which
is sort of where OTP sense it's its log
messages by default so somewhat have
have to use that but I like one thing
about like about arrow logger even
though it uses gentleman is the report
functions when you base us supply a
property list of values
and usually helps because I know you at
least you get our Erlang terms out of
the whole whole history there there's
also tracing built-in and I was actually
planning to use this at a much greater
extent but it doesn't really work if you
want to do this like systematically
during the whole runtime of the system
partly because you can only have one at
a time and there is no flow control and
it doesn't work very well in the
distributed systems so in the case of
say running CD tests you want to log
something and have it included in the
common test log that made no sense sorry
yeah so basically the only safe way to
do try singing in our line is use choice
portraits were relatively safe but it
doesn't work on with distributor darling
and you still have the annoying
limitation that you can only have one
tracer
dtrace I was sort of trying out that one
I'm a linux user so i had to install
system tab and it made me feel like an
idiot so i don't really want to impose
that on anyone else tried t trace on
freebsd as well and that's or addresses
all my garage with aren't racing is you
can have multiple tracers and it's more
or less safe and
it's called
and you also get the sis calls but it's
sort of you do it outside Airlines you
still need to sort of integrate against
that and even then it's not available to
everyone so sort of waiting for that one
to mature a bit and then there was the
folsom talk earlier as well it's mostly
focused on numerical metrics and we
don't want to pipe we don't want to
replace Folsom with this thing it's
better to use that as a sort of back-end
to analyze events
okay so most of these things that you
can do in our long if you sort of get
something out of it our running program
is really your you have in a run time
event but you're only choosing to apply
one specific function which is sort of
to log over to analyze it as metric and
it's fixed at compile time as well so
you can't sort of insert it while you're
running a program or while you're having
an issue and so if we instead say that
we want to apply one or more functions
for each thing that happens sort of gets
more interesting because then you can
choose to count how many requests you
get in and so on or yes yeah the idea
was to see go through the others to save
why you could log them or do whatever
and sort of the characteristics of what
we want to do here is everyone output
invent for each certain input and output
or condition in the code or action we
take and should be high level event so
it's not for replacing function tracing
that's a little bit too low level to use
like systematically as well and it's
want to focus on out-of-band information
as well so we're not really relying on
any specific outcome of the handling of
an event so you're already relying on
the side effect of applying the
functions like sending it to someone
else or like that
and and the most important thing is you
want to dynamically change how the
events are handled while running the
program so it's kind of like event the
event you can install and remove them
and so on so if you want to do this we
kind of imply that we want to have a
node or cluster level service because
events usually happen in really
inconvenient places sort of yet within
some function five levels down and then
you want to print and that you can't
really rely on propagating in process ID
or something to that point so and also
if your spawn processes you can't rely
on the process dictionary it's kind of
an obvious thing so you don't want code
to behave differently if you start
spawning processes and evaluate
something there instead so some around a
global state on the note and currently
I'm using in ETS table for that
restrictions so as I said it's only for
our band events so it's not a general
public subscribe service to use because
you don't really want to mix that and
ideally would be side-effect free as
having no effect on the running system
but doing ok
okay so solution to all problems in
computer science is adding my level of
indirection and so the basic idea is
instead of saying error logger error
report you emit an event using the gold
rush amid function and you specify how
events emitted using that function
should be handled using the with
function and the idea was well is that
event should be self-describing so if
you don't have to add as much
information to them so if we we know
that an event was emitted from a process
in a specific application you shouldn't
have to declare that
so that's the runtime context to
basically have three components for each
event so its current time when this
happened the current node and current
application and current processing
basically I've for things so it's easier
to correlate with other things that
happen and I think this is actually more
important than saying we're in the
program something happens like we're in
the program text doesn't really matter
if it's on line 10 or 5 okay so it can
augment this with identifier so it's a
property list of key value pairs and so
say that the identifier name should
always be nothing but the value may be
any term so this is an example I've
fallout 4 e turrent it's very similar to
some logging I made there and we can
specify which torrent and went is
related to and which pier address
and then you can associate the value
with that so we say that is for specific
piece of certain lines and buts has
anyone written a bit torrent okay that
basically says which data you want so we
put this together you have a triplet
with the context and they have been
firing the values and this kind of shows
there so we'll take the context from the
currently executing process and I just
specify these there and fires and the
values and the intention of these data
and fires is as if we were able to sort
of Greg in when you when you select the
events to handle so it should actually
say display their right to the right of
our line and it's kind of silly example
if you just debugging something we say I
won't go broke a quest from a torrent
why is running and just print them to
stand out and
there and the idea of using the
identifiers and selecting based on them
is that you can filter as early as
possible so and that's especially
important for distributed along because
you don't want to overload the disport
with the bug output so you want to say
be able to copy the those definitions to
the notes where we expect them to happen
and currently I'm storing this in an EDS
table but will be possible to generate
the displayed module sort of lower the
runtime impact of this but the as I said
it's not a replacement for function call
tracing so Donna doesn't have to be
insanely fast since you're not going to
do it in like inner loops orphans like
that
now I drop as early as possible as well
so if you had be regenerated a high
rating used want instead of glimpse at
what's happening currently it's good to
sort of sample inside of fists logging
everything and if you look at what sort
of other industry systems like get
towards google doing and those things to
basically saying like at the second
sentence to make it relevant to say that
they're sampling to reduce the impact
that's pretty really common requirement
for production systems as far as i can
tell if only to produce to protect you
from overloading things like that then
we added status as well so the idea
behind that is to export the value based
on the application state so whatever the
current state offer process is so things
like that to make that reachable that's
usually problem as well to gain access
to that so cover it would be how many
connection open or the current state of
a process and we want to associate that
with the function call so we don't want
sort of impose on users to skim through
the manual and look really carefully for
the magic function that returns how many
connections are open i think that's
actually the case right now you can't
even access it
where you can drive that from
application events as well some count
because it's sort of in the wrong order
so one example this is the proper file
system on Linux and so it's file orient
this instead of plotting function us
reading writing two files and now you
get to process information there as well
as of kind of like the processing for
function in airline and it's also export
solid ground information so that's in
one example of doings like on the kernel
level and you're using a tree data
structure to sort of make it exportable
and possible to clients you have SNMP as
well she's both a good and a bad example
I guess I like that routers have it but
i don't really like using it and it's
also got a tree structure and get read
write access and i guess the killer
feature at least for me is SNMP walk
because then you can lead lists what's
happening or what's available is really
useful if you get this some obscure
piece of equipment and to see what it
actually does not what the manual says
it does and then unspecified she's sort
of more in general really depends on the
type of service that we want to read the
statues of one thing I kind of encounter
quite often is that you're using the
service protocol to also export the
status of the service so in Redis I
think you're using the info command to
read it as well so and the same with the
postgres as far as I can remember so I
guess it makes sense on some level to
use SQL to
sister stats of an SQL server but I'm
sure if it's always a good thing and so
we basically wanted to use distributor a
line to do this and at least airline is
like less custom than doing your own TCP
based protocol or bang around UDP
packages is no sense and the idea here
is to reuse click context and identifies
who say what you provide information for
and what the keys for those are that
would be the name this is an essentially
one component in the path of say proc
and so even your reading it you just
attach the time and the value see you
should be able to reuse the same thing
to do that so status API is so we're
calling this from calling provide from
the function or from the process that
sort of has the state
so we did this in cowboy calls from the
listener server to export the number of
connections and which pool they were
allocated to and so on I can also it's
also possible to do it using an
anonymous function as well so you don't
need to add extra code to like export
and I pair API for that and the idea is
that you get the value by applying the
function and then you can find value so
we want to get everything associated
from one application you just use the
same one as I used in example for
handling events from a torrent and you
could read the values as well so this is
just listing the full context and
identifiers and this is also called a
function to get the value and then sort
of guess my personal preferences here
for the doing this is to push data
instead of pulling from say morning or
nagios or something because I usually
end up with the really shitty bash
script and a lot of configuration files
that lay there and rot and
it also has a nice side effect that when
a system start and starts outputting you
essentially registering yourself in the
service some reflections from sort of
prototyping this is that instead of
doing it really need adding a lot of
setup code you can do quite all our work
in the supervisor itself to generate
such a child specifications so you don't
need a de loops to start child just do
have a list comprehensions and which you
work I also sort of found one for all to
yield much less error handling code than
using one for one which is kind of
defaulted to before because you don't
need to monitor and it's much closer to
link which is rare alani and I after
spending some time this I'd kind of fell
back on using prop lists for passing
parameters to processes like the initial
state and data because it's especially
easier to read in crash reports because
you don't need to remember we to
memorize the argument order and what
you're expecting to be and so on it's
also much easier to propagate parameters
down the supervisor tree because if I
want to add an option and I have two
levels of Supervisors I need to add it
on each level plus the worker and to
make that work and
yes that's kind of the one I guess now
it's questions did I make any sense yeah
so we're deferring the actual web
interface since I sort of spent too much
time making a really bad one and our web
guys guess is almost already done with
our webpage and it's looking beautiful
so just going to wait for him to sort of
fix that and I should be done in no time
questions
yeah that is to pass that to a function
so that would be like in that case it
was hour-long display so the work they
would be counting and yeah exactly yeah
there was actually one of the things
that I found most annoying because most
useful event hazards have some type of
state so what I did for that one was
just add okay that's confusing that's
why I do the one for all supervisor or
with to run the actual handle code and
currently it's sort of at the bottom
it's implemented as the module that
looks almost exactly like the cowboy
HTTP hundred module seven any function
you have a handle function on your
return a function and and that's where
you would sort of create tds tables or
something like that did that answer the
question
okay salut in this web interface it's
basically to browse this and to show
graphs and so on and it's kind of the
sort of exists for other things I know
react has one as well but as far as I
can tell is react specific and we really
great to have one that's more more
general they could bundle with
applications as well so that's where so
we're going for here it was nice that
you so you can have these emits
statements in the code and then tweak
the way that they they're rather talk to
specific functions okay yeah it's
basically gentlement but a little bit
slightly different I don't think out
anyone would use or would like having to
implement it genuine handler when
they're in a hurry just do that yeah
my event yep and then as you mentioned
lager does something similar with having
yeah does it make sense to integrate
those so that as blog and also so so if
you're longing a specific thing every
time X happened does it make sense to
cook I'm just because I'm not require
obviously um I'm just curious because it
does
overlap yeah I got a lot of inspiration
from blogger for that and I'll sort of
trying to argue at the beginning that
blogger and other things is more or less
a special case of of connecting those
two things as much as we love messages
and stuff in Airlines sometimes not
always the right thing somebody just
want to call back
I would doing Tyler's don't like a
witness and Teddy mistake type checking
static type checking where style Iser
require monuments and focuses on is
required in their argument was required
anyway yep so after using protest or
optional arguments that are rarely used
a good function appealing preferring
episode always more argument lists of
the sort of
okay I can see what you mean I use
usually just useless ski find so it
crashes if requirement quite argument
isn't there but that doesn't really work
with four dialyzer in that case because
it can't see which one is which of the
types in the of the entries in that
types more questions awesome thank you
very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>