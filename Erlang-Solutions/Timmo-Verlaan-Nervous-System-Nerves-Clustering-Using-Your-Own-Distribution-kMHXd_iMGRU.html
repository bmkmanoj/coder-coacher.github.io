<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Timmo Verlaan | Nervous System - Nerves Clustering Using Your Own Distribution | Coder Coacher - Coaching Coders</title><meta content="Timmo Verlaan | Nervous System - Nerves Clustering Using Your Own Distribution - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Timmo Verlaan | Nervous System - Nerves Clustering Using Your Own Distribution</b></h2><h5 class="post__date">2017-06-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/kMHXd_iMGRU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hi my name is Tim oh very happy to be R
thanks all for showing up I'm going to
talk about nurse and Erlang distribution
we'll already did some did something
with nurse like that okay that's pretty
much it's more than last year
that's great so how many of you are
using Erlang distribution like really
like connecting to nodes like okay okay
well that's like almost equal to the
amount of people are using nerves so I'm
going to talk about clustering nerves
devices using your own distribution
there are some caveats in general which
I'm going to cover but first I'm going
to tell you how it all started
because so I work at a company word
where I do stuff in in elixir but um
when I started juicing I started using
nerves like in the beginning it was just
like getting the LAT to blink which is
really cool but I wanted to do something
more with it but I didn't really have
like production use case so I have a
brother-in-law and it was his birthday
and he really liked beer so I got it I
gave him home brewing equipment we
decided to do it together like start
brewing beer which is cool like
everything every every like good idea
start with beer I guess at least in my
book like some ideas are not that good
the next day but like last night it
seemed like a pretty good idea so we we
created our first batch of beer and look
like brewing beer is it's like some
things in brewing beer are kind of hard
yes you clean everything really well
like you don't want any bacteria near
your beer needs to be the right
temperature or like and it's only like
the the fermenting part which is if you
master that then you can like that that
that's actually a requirement
you can move to the next step so we
decided we wanted to improve our setup
to brew more beer and for that we needed
a fermentation chamber so that's like
some like isolated room where you can
put your beer when it's going to be a
consistent temperature so you get like a
better quality beer so it seemed like a
good use case to like put an embedded
device there that would read the
temperature and then when it would get
too cool or too warm it would adjust the
temperature accordingly so the thing is
I get creating a fermentation chamber is
already you need something that isolates
really well and there are multiple
guides in the internet you can follow
but one suggestion that keeps coming up
is using an old fridge so I didn't have
an old fridge so one night a Wednesday
night actually I remember like the day
of the week you guess Wednesday night I
live in Amsterdam on Wednesday night a
lot of you put their garbage on the
street and then the next morning it's
being picked up really convenient if you
have like a lot of like big stuff you
want to get rid of so somebody wanted to
get rid of a fridge so I was like
walking there with my dog and I walk
into this fridge I'm like god this is
crazy
like it all like fell together so I
called my friend or my brother-in-law
and I told him like you need to come out
for right now we need to pick up a
fridge from the street we like the
Commission was pretty good so he had
people over for dinner yeah so they had
to wait
real story so he came over like it was
not that far away but anyway so like we
guarded the fridge because I like I was
with a dog and like were two people and
a dog and carrying a fridge was not that
convenient so I had to bring back my dog
to the house like he guarded the fridge
because we weren't sure likes maybe
somebody else is going to pick it up
like stuff like this really going quick
so we picked up yeah well I told my wife
like okay I'm gonna bring Annie I'm
gonna bring in an extra fridge she's
like why are you gonna put it I'm like I
don't know but we'll find a spot I'll
make sure that it will fit so we brought
in the fridge and then we thought okay
we need to check if the cooling of the
fridge still works because it was put in
the street so maybe it was broken so it
wasn't which was really like good for us
and then I put it in my shed because
that was place I didn't have any power
there so that was like the next
adventure and that's really how you know
how this is all started and we started
brewing more and more and more bears as
you as you can see on the picture and of
course was was getting better so I had
the fridge I had no power
I had had a Raspberry Pi but like I only
played with blinky so I played with
blinky again because hey things change
the nervous project team is doing a
great job
like a lot of updates were coming out
still there are a lot of updates are
coming out recently a new new Raspberry
Pi is added to the family verse berry
pies which is the zero with wireless
it's like so tiny I'm afraid to lose it
somewhere by accident so and like every
time a new device gets added they have
to do a lot of stuff and they're really
quick in getting every everything ready
so yeah I use this again to blink a lot
and I worked and then I was going to
brew some elixir or brew with like using
elixir or some combination of this to
get the next beer out so I bought like
some equipment like a relay to be able
to control the fridge you turn it on
enough to cool a simple temperature
sensor and I needed to heat inside
because when it would get to like it's
in my shed my shed is not isolated so I
needed to make sure that I could heat it
so I bought an old Bible they are
perfect for heating they do it like it
creates some light but you can work with
that you can chill it off your beer so
it doesn't like affect the bear in in
any way so III but this setup worked and
I had like attach two diodes to see if
the Bell was on or the fridge was on
like you know you have this problem
there's a light in your fridge and you
don't really know if it turns off when
you close the fridge so I add a solution
for that I just checked like on the
outside if the fridge was honored or the
Bell person I didn't have any clue what
a temperature was because back then
nurse networking only offered like wired
connections I put a power cable there
but I didn't have any Ethernet there
because that would be too much trouble
so I would like walk to my like walk all
the way over to my shed check the
temperature and order to check what it's
doing and every time it seemed oh right
I even sometimes when I when I wasn't
home I said I still want to know like
does it work this is a so I called my
wife like how I'm at work called my wife
like can you okay like we just want to
know what it's doing
can you maybe like take a look and tell
me what it's doing she didn't mind good
for me and then I decided I need to I
want to check
temperature aside from like if it's
heating or cooling because heating and
cooling at school but you want to know
like is this a steady line or am i like
overshooting undershooting effort
everything so first I started just like
enabling the networking part so walking
with my laptop to the shed connecting it
with UTP and logging in and seeing
what's what and how it would work that
kind of worked
luckily soon after that nervous Wi-Fi so
it's still a long range but it kind of
it kind of worked I bought a new router
though but it's kind of kind of worked
so I could enable this because like the
nerve seemed gand it like this excellent
job of adding a new feature which made
it very easy to configure your your
Wi-Fi and make it work so then I did
some stuff to try to see how to connect
to it so I created an SH wrapper for for
language H so I could F the elixir shell
because like when you're coding in
elixir is easier to be in the elixir
shell and not in the Erlang shell then I
added like a simple webpage like to see
like what's the temperature what's it
doing like very simple I create some
forwarding so I could even like login to
my domain and see what my beer was doing
which for me like it's a great victory
my wife liked it as well so then I added
some more networking stuff because as
soon as you as soon as you're connected
right you can get all the data out of it
and you can have it somewhere else so
that's really really convenient but it's
all good but if you're if you're
thinking about earning distribution and
fault tolerance and you want to get like
two Erlang notes talking to each other
in a fairly easy way I think if you're
creating something on your Raspberry Pi
and you want to know to talk to each
other you just actually you just want it
to work like okay I'm gonna say this
once so if you're doing something in
like IOT you just want it like to
connect them like oh wow
so I think it's time that like this is
some background where I came from and
made a really good use case for me to
start actually using it and I think
that's the most important reason to
start or it's the easiest reason to
really start using nerves instead of
doing that the tutorials or the examples
or basic stuff but I was really
interested in distribution and I thought
okay a nurse example hello distribution
come on let's let's do it so the ID was
when when I when I started trying to get
it up and running to have like a lad on
one device and when you have a lad on
the second device and when they talk to
each other you can take turns so so that
would be like a distributed blinking lad
which I which I coined distributed
blinky because like they are taking
turns so it's it's very simple I have a
small like example of it which is I hope
it works
it works so it's really not sure if
everybody can see it because the let's
really tiny you cannot turn off the oil
I'll do it once more like it's it's like
this one you see and then it's I think
somewhere this one so they're taking
turns talking to each other very basic
strategy by using Phoenix pops up which
is just broadcasting like hey who's the
next guy wants to blink a lot and the
next guy shows up and thinks the lab and
then he says it was the next guy oh
there's no next guy oh then the first
guy respirate by their deer no sorry I
like them so sometimes so how did I do
it it was if it still works
cool how did I do it i created a
configuration step is this readable for
everyone alright
i'd like I shorten it to make sure it
would fit on the slide and wouldn't have
like any so there are some things that
are missing but you will get to general
ID so it I gave each host or each rest
or each nerves now basically a host ID
and I would generate like this static IP
address and static node name so I would
know up front like oh these are the
notes I have and actually the first node
with like ID two would only know about
itself but then any higher note would
know about all the previous notes so I
would create the the node name here I
create the initial nodes list and I I
peer the rest of the ethernet interface
so those were very biased you saw were
just connected like straight but you
could put it on a switch and then they
would all collaborate however this
doesn't work in every network
definitely not a minor
work works in an isolated Network so
aside from the interface configuration
and the initial notes I templated the
via marks that were installed on the
within the nerves node and I used named
because that's at the time that was the
easiest way to to make sure that the
first part of the node name and the
second personal aim were entirely static
and we're just like if you try to
resolve an address to an IP address it
works and this was templated so I really
need to make sure that during compile
time I would set the right environment
variables so every host would have its
own ID and its own name so this this
worked but you cannot like you cannot
install resurrect by and say here you go
it will auto connect to whatever like
never suffice you have in your room and
there there are some other
considerations for for naming so for
naming you have two options the the name
is for full equality fully qualified
domain name and the last name is for
short names as name you usually use just
give it a name and let the main part be
decided by the host it's being run on so
the name technically it should be a full
equality fully qualified domain name so
that's I I don't see the recommended
ever actually maybe there are like very
good reasons if you have like a very
specific cluster but most most at times
people recommend short names extent it's
fairly easy and you're usually like
solve your own domain issue
but both both solutions still depend on
DNS so you need to have the innocent if
your router at home supports like when
you register with the GP that you get a
domain name assigned to your device then
it works but still that's that doesn't
work in all cases and the other solution
is add host to your host file but then
you need to know the IP address up front
so you can you rule out the HP so that
was kind of an an issue I wanted to I
wanted to solve because when you're at
least for like the hobbyist when you
when you want to nurse devices in your
network you just want them to connect
you and once you set up the unis or
whatever solution then there's another
thing IBM the Erlang port mapper daemon
it it listens on a on a default port
which you can configure by the way and
it talks to a PMD talks whether EPM DS
to get information about the nodes
running on a specific host but it's it's
not within the airline PMF for that
reason
multiple rolling nodes can register to
the same Erlang port mapper daemon and
it means you need to manage a process
outside of the Erlang via which gets
more tricky on an embedded device and
preferably you would do this in in
Erlang as well and for nurse you're only
running one airline via on one Raspberry
Pi so there's really no need to have a
PMD or like similar similar tools you
can solve that in other ways so EPMD can
be replaced you can write your own EPMD
module for for quite some time i've seen
various solutions and yeah it only
returns the port that
note is running on so for the address or
the IP address of the node that's part
of the distribution protocol which
resolves domain names to IP addresses
and that is I net TCP dist
so this is the default Erlang
distribution you can also use the cell
one if you if you like to have secure
connection and I think starting with
Erlang 19 you you can write your own
distribution module until I like to use
that instead of this and the downside of
this all the nesting I tried various
solutions to to map the dns request to
something internally or like Erlang can
do DNS via the host like a normal call
to loot to the system or you can do it
within Erlang are multiple multiple
solutions but I wanted to create a
custom distribution because then I can I
have complete flexibility of how to get
the address and how to get the port and
how to get all that information just
based on a node name or based on like
maybe a key value store I have somewhere
so you can do this by with Erlang you
can give startup arguments so you can do
this by specifying a proto list sorry
that nevermind so you can do it by
specified per list and of course if
you're doing this with with elixir you
have to prefix the module with elixir
dot because otherwise that's actually
all elixir modules are in that namespace
and you need to name your module like
this I don't really know why so then you
the argument you give to produce this
name of module it's really just module
and then the module is actually name of
module and the score
so this kind of turkey took me a while
to figure it out I thought why it
doesn't work so that's that's a kind of
funny I think and by using this module I
could skip doing DNS requests so the
module kind of like looks like this you
get like a setup a request from from the
net kernel and I'm only doing this for
short names because I wanted to have
like a quick solution for my use case
and I still ask for the EPMD module
since you're writing your own
distribution module you're writing your
own EPMD module you can just
short-circuit everything but this gives
me the option to have different
solutions for solving ports and
addresses because I can now ask the EPMD
module for the address and the port so
you have to implement a few callbacks in
the EPMD module and I just think that
like if I add another one which is
useful for me I can let a PMD the EPMD
module find out where the node is and
connect to it so EPMD module you can
reference it like this with startup
arguments and you also I think have to
flag to not start EPMD I'm not pretty
sure though I haven't really tried
there's not a flag up start and score
EPMD and when you tell it to not start a
PMP it won't start by default and there
I in flamenco back I've described
because I rewrote it this morning I see
it doesn't fit on the slide okay so I
extracted the actual logic
here with the extract IP port from from
the state so let's say you would keep in
your state a list of nodes that you know
the address import off doesn't really
matter how you how you get that state or
how you generate it or get it from from
some database or store and then you
return the IP port so the distribution
module knows where to connect so I was I
was trying to kind of make this work but
for the further four so I looked at the
the original Erlang unity speed this
module to see okay how does it work how
where can I reuse already written code
because that's way easier actually it's
quite a lot you can reuse so I only have
to change a little bit and so yesterday
I was able to connect to notes but there
was some timeout going on which was
really weird referencing the wrong bit
didn't help there but I think I'm gonna
show real quick with a big of Buddha bit
of a hack I unfortunately I dared
there's like I couldn't get my verse
varied by to work so I'm gonna try if I
can
let me see
I'm going to try and do a quick demo
alright alright
cool
all right maybe I should create two
screens straightaway
oh that's here and I'm going to do some
magic because the thing I ended is
multicast DNS to get two notes discover
each other and then I would add them to
to the state of my of my process and
then so I'm running this locally which
is a bit sad actually
but that's the thing yeah I will better
well sorry my
okay so I need to make sure because
there are some you cannot use multicast
DNS on on a Mac because it's already in
use so you cannot listen on the same
port so I'm I'm cheating a little bit
with with specifying on which ports I
run so I can let you notes talking on
the same machine now let me see if this
somewhere sorry for letting you all wait
okay
so this should be the first node so here
you can is it readable out should be
there yeah I can make a bigger but I'm
going to show the other one as well
because there will be two nodes so I
need to I can gesture I don't know
what's up with this oh this is what
happens when you do demos it's not that
good at it so I have to increase this
one as well so it's readable
it's ysus Vick evident I don't know I'm
sorry for the people in the back maybe
the thing I sign it gets too small right
all right so I bet some extra Erlang
arguments right here it's not really
important it was in the slides but I'm
also specifying the path where the
libraries are because that's necessary
I'm not starting mix here and the
modules are started by met colonel so
you don't really control when your
module got started so it needs to you
need to make sure that your code is in
there in the path so this is starting
OneNote and it crashes of course this is
so much fun all right
try again that still doesn't work
all right all right cool
so IIF Anna ee8 PMD mdns module and I
need to configure the IP because usually
you don't know that upfront right now
I'm going to specify my local IP and
that that works it doesn't see any other
nodes because there are not yet any
other nodes so right here I'm gonna
so now I need to cheat with the portal
is none
which I should have made more favorable
also I thought I'd lost all the other
this is kind of funny
all right this is sad I was really
hoping to to show how it worked all
right cool
set and yes
so if you're better in live demos you
should sign up for next year select
circle so now you see I set IP it makes
a dns request which or multicast DNS
requests it it's received there which
sends a response to the other node
multicast DNS is really not that that
much rocket science but it's like pretty
cool
that you can set it up like this now we
need to make sure that on the other node
I should learn about oh thank God I
thought it was crushing already I need
to make sure I know both notes as well
and now if I want to connect to another
I can just use the normal elixir tooling
like node connect seeing a bar at my
local host and it's connected
all right how am i doing in time pretty
good actually so the basics are I
created the basics I was running into a
book where when I would enter a node
connect I would just hang my entire VM
said something was myself but I'm glad
it's fixed right now I haven't been able
to to get my Raspberry Pi on the Wi-Fi
year which is of course what happens so
I'm not going to try that because then I
would study even longer so let's get
back to
the real thing so I would like to thank
everyone I'm gonna die so I brought a
couple of beers I brought two bottles to
Barcelona one survived so if you're if
you're quick after the talk I'm like
right there we can talk about beer
you only get a sip because there's a 1
liter of beer and please don't like
don't like push people away it's just
going to be first come first serve are
there are there any questions give them
another round of applause
we have a short time for questions
before we move over to the next stop so
let's see some hands hi a question about
timing because see you use an interim
Wi-Fi yeah so the IP address doesn't
come up immediately how how does that
work
so I register for a release offense you
get with the registry process that's
been yep okay yeah and I haven't really
been able to try it - like really give
it a good shot but I hope it works maybe
you know but okay I've a slight approach
but I could be better and the multicast
DNS sorry two questions that's sorry
yeah the multi-cut that works just just
great does it because I've tried another
one before and I'm going to get into why
sorry the multiple-- mdns yeah um what's
a library it's I I first I was using a
library written by Christopher from I
think I'm on slack II Santo okay from
yeah realtor sir yep but it didn't
really suit because like he was doing a
lot of fancy stuff and I just needed to
get this up and I'm to publish the DNS
library for this and but it's set up in
a way that like you're not tied to mdns
you can use another discovery protocol
on which you just expose like the right
information but I will publish it for
sure and then the link I will I wait
thank you
somewhere right any more question right
so that will be I need to like enter the
repo story on my slide and then slides
will be shared otherwise you can also
send me an email or in Twitter
no more questions
nobody alright as we all know live
coding demonstrations often make
excellent case studies of Murphy's Law
so takes a very brave person to give one
so give them one last line round of
applause
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>