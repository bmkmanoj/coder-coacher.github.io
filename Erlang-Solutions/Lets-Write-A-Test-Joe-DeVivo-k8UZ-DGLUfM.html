<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Let's Write A Test! - Joe DeVivo | Coder Coacher - Coaching Coders</title><meta content="Let's Write A Test! - Joe DeVivo - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Let's Write A Test! - Joe DeVivo</b></h2><h5 class="post__date">2014-06-03</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/k8UZ-DGLUfM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so I don't do this a little differently
i think i got a lot of code slides and i
wasn't sure how well they're in a show
up on here I did the best that I could
but we can you guys can open up your
laptops and go to this URL here if you
want and what that's going to do is take
you to a page that looks like some code
that you can actually read I'll put
snippets on the slides as we go the code
on the HTML will be in in context so you
can kind of cooperate there but you know
that's cool and everything but you know
now we're entering like this circle of
trust right where you're not going to be
like on Twitter or do whatever your own
stuff you're gonna pay attention to me
we're gonna have a lot of fun today but
I guess legally here in Sweden if you do
straight from my tongue like more than
once you have to vote for me a green
card that's just I don't make the rules
here any of you from Sweden you've any
actual sweets here a couple of calls be
it's great so I'm good so I love Sweden
I am the standard of the audience right
so I got here on Monday morning 7am and
Jared and I are on the same flight and
we decided we're just going to go all
night all day beat jet lag and then we
did it we saw like everything you know
you guys are great the food is great
that people are great I really enjoyed
butchering your language you know I try
to read the sign I know I know hope but
you guys have been really cool about
that too so you know just everything's
great so I ask people when I was coming
to Sweden what I see and they said there
are two things you really need to do in
stock you need to see the vasa and you
need to go on the archipelago tour so
I'm gonna do the archipelago toward
tomorrow but um yesterday I went
silvassa and that it looks terrible in
here but this thing is huge i used the
iphone panoramic camera to get the whole
thing and this a great story for you
don't know it King Gustavus Adolphus one
anybody no no to all right so he
basically his uh was it uncle or cousin
was the king and then he was catholic so
he had to go pee king of Poland instead
because he had that fall back job which
is great for him but Gustavus is like
well I bet have to fight this guy
because he's gonna want to come back
used to be seeing as we thought it was
pretty sweet gig so he's going to come
back I got to build this awesome huge
ship to go fight if it was like for some
reason might have my fleet just
disappeared so he built this huge ship
is beautiful on our Nate and it's ready
to fight he's got 75 cannons on it now
I'll have the same ammunition which is
apparently like a big deal because back
then they just hodgepodge cannons and
that was fine so he's getting ready to
go it puts it in the water thing gets
like 30 feet and done sunk so i'm
talking to tori i'm like Bo wouldn't be
great if they tested this thing before
they put in the water and you know what
you said you said they did they said
they had 10 tests that they do on the
ballast and if they all pass then the
thing goes in the water so they did
three tests they all failed so they
aborted the test cycle because the tests
were all failing and then okay we're
gonna keep going so so that's what
happened i don't know i don't know we
have a test run that fails when you fix
the test or fix the product depending on
what the problem is but they decided
they would just keep going so um that's
at this picture of the back here and i
don't know if you guys know what like in
America like one of the things we
associate with Sweden is uh see this guy
here so I don't know we can simply chef
back here and I'm like is this this guy
is this like a real thing I don't know
but you know we also go we also like
these so Sweden to go to America in age
from 3 to meld actually feel like the
fish that's good like the chef excuse me
boss ikea that's it that's all we know
but this place is a lot better than that
so i'm going to go spread the word when
i get home so is my wife she dropped me
off the airport we're in phoenix so you
see like all the bright just lots of
bright everything's like 50 degrees
fahrenheit warmer than here all the time
all year she fitted right here she's
actually norwegian to say so don't hold
that against her and she's dropping me
off at the airport in this picture
because this thing this this train that
the airport is running you see it going
but there's no people on it because for
six months they're running this thing
without people on it why well because if
there were people on it something went
wrong they would die and be
terrible so now we're at least we're
testing things before we put people on
its progress you know we're getting
there so you've got this like
engineering paradigms it's like forever
where you build a thing and then you
test a thing and they you use the thing
it's sometimes you test the thing you
don't care the test fails sometimes you
do so that's great but this um now we
sort of get this software engineering
thing and it's great because now we have
options and the option we have which is
like the first time in engineering
history we've been engineering as humans
for like thousands of years and like now
we can actually test the thing before we
build the thing we can say hey you know
let's this this is what we're going to
do to make sure the thing works that
let's build it and make sure it does
that so that's what little introduction
and I'm not going to sort of going to
some administrivia about this and this
is how we're gonna watch this talk so I
told you to go this URL which is great
and I'm proud of it and what you're
going to do is you can see these code
numbers up at the bottom of top of this
line that's the piece of HTML that you
should be on if you want to so when you
look at that and you see that you're not
on that page advanced I'm gonna try to
remind you as we go but I might forget
so when you see that you know it's going
to look like this click on this guy to
move to the next that's easy enough
right you don't typing new URLs or
anything you hyperlinks how do they work
and you know just to make sure I haven't
put the number in enough places so you
always sort of know where you are I
don't want to get lost so so that's how
to navigate to talk so you know why are
we here we're going to hurt my stories
but now let's say let's get to work so
we're here to add a feature to react
with react test using test-driven
development that's seemed pretty good
let's talk about react for a second
because maybe you don't know what it is
it's fashos open source available
fault-tolerant operationally simple
scalable so you can rest database and we
can talk all day about our react is and
we better just move on otherwise we will
so what is react at react test is bashes
a framework for function with testing
distributed systems most of those happen
to be react or react related products
but it's open source anybody can use it
you can go to Bajor github and get up
the comp sci fi show so that's react
test and check it out there's link later
in the slide deck drink here so um
another cool thing about wreck test is I
kind of made it so that's why I'm using
it so react text does our release
validation but its roots are test-driven
development framework which seems like
perfect for the stocks so we're gonna do
is we're going to add a feature to react
test and it's not it's not above a
little actually find some bugs along the
way but let's talk about what that
feature is and that feature is Java
management extensions for react now it
sort of went back and forth on like what
I should choose as the feature to attest
for this thing and so why I chose jmx is
that it is pretty isolated feature it
doesn't cross cut a lot of repositories
that we sort of used to build react it's
very straightforward it doesn't involve
us knowing the in Turkey intricacies of
react so we don't have to like worry
about cap theorem or like you know
probably network partitions we can talk
about testing and speaking of tones just
talking about testing its closed source
so we can't even talk about the
implementation we don't have to I can
just wave my hands say I a little bit
did it and then we move on but i'll show
you implementation as needed and i
worked on the jmx extension so it seemed
like a great thing for me to talk about
I actually did it with desert in
development as we'll see right now so
you might be thinking probably not
because you know it's not a very popular
feature react but hasn't react jmx been
around for a while and the answer is yes
it has what we're doing here is we're
retooling it making it more like the
other statistical interfaces to react
that um you know it might have fallen
behind in parity and just making the
codebase more robust so that's the
feature it's making a jmx extensions for
reactive a robust and giving sort of
parity to statistics so yeah that's what
react AMX is it's the stats URL exposed
but that's only in theory because
there's a lot of missing connection
so let's talk about that what's the
statue Ariel the statue RL something
when you started reacting on you can see
here by going to your node and the
statue airs live stats show you a bunch
of stuff which you're probably already
looking at the first coat slide if
you're looking at that by now I'll show
you in a minute you get the same afraid
you from the reactant status command and
really it's just general information and
statistics about the node that is all
right so what does that look like here's
code slide 1 here's a bunch of
information I tried to make it somewhat
legible if if you don't have a laptop or
anything it goes down like forever so
just just know this is a very large
number of things and this statue RL
outputs a JSON object and here's once
your information and some of it will be
relevant to us as we go if you go we
click the next button to go to coach
line two you can see this this is the
jmx extension it does not scroll down
this is where it ends there is less
these things are all camelcase instead
of like early terms so things look kind
of different and these are them side by
side you really can't see this but this
is the entirety of the statue RL and
this is the entirety of jmaxxx m1 is
itty bitty
so quick history lesson react gmx
predates react s like I said been around
for a while so why does that matter to
us means we can't go full TDD on it we
just we have a rehab feature that
already exists and we have to start with
test somewhere so back when we did react
13 release we moved everything to react
test from our previous framework and
what we got was this thing we reset the
you know portes one by one and we had
this jmx des we kind of decided well
should report it well not really because
in theory what it's supposed to be doing
is the same thing as stats and we
already wrote this stat test for the
same project let's reuse that just
change the parts as needed so that's
we're gonna do we're going to reuse the
stats test and first thing to do is walk
you through sort of what the stat test
did and then how we changed it so code
slide 3 is the stats test in its
entirety and we're going to go through
sort of logical chunk biological chunk
here so the first thing we do here is a
every react test has to confirm zero
function and that runs the test we have
this arty deploy know this function
which so RT is the helper module that
has all sorts of like helper react
functions in it this one is deploying a
single node and it returns a list of
nodes in this case just happens to be a
list of one and then we make the
assertion that we wait until those are
ready and wait until is the school react
utility records utility which is sort of
like you know sleeps for a little while
and it goes check some sort of you know
function that you pass in and say you
know test this if it's ready then you
know who exit otherwise sleeping in so
usually we do stuff like this where we
just deploy many nodes and then just
build them into a cluster together but
this test is very simple so I'm just
going to use one so now we want to get
stats we start out the node it's fresh
we wanted to see what the stats are like
so what do we do well we pass the note
into the get stats function that we just
have at the bottom of the stairs to
helper function for this one test we do
this curl that will create the URL based
on this other helper function that gets
URL from a node and then the code into
Jason's Dakota Jason string into a
provost so now we return this province
of stats everything you should on the
adjacent string now a prop list
available to us why did I use sleep
what's up sorry yeah I was going to talk
to you about that actually a lot of
silly framework there but um know what
happened here was it had something to do
with curl I can't honestly remember
sorry about that I do have another sleep
in there which I explained very well
look at that in a minute but this sleep
I don't honestly remember why we did it
sorry yeah we what was that it we wanted
to make sure the stats were there I
guess part of the story but would that
should have been wait until I can't get
distracted here we gotta keep going I'm
happy to talk about it afterwards
although do keep asking questions
because I don't want to lose anybody
along the way so we had this propolis
it's a list of all those stats up there
so now we have this list and it bounced
to stats one which is great so the first
we want to do when we start up a node we
have this tassel is to say hey are some
of these stats not 0 if you see this
enumeration stats here it's like CPU end
products and mem total and all this
stuff these things shouldn't be 0 I mean
they shouldn't be we don't know what
they should be because every system is
different and we don't know what you're
testing on but we know that you're going
to have some amount of memory so just
sort of a sanity check to make sure the
stats are working and that what that
looks like is this right just take a
list of keys which are the static uses
of keys to the provost and do a list
comprehension over it and just to serve
through the rot 0 and now that you've
seen that know how that works then that
function again sort of makes more sense
to you if it didn't before so now what
exactly interesting length I actually
poke react and then make numbers go up
because that's what we do here so first
thing we do is going to perform five
puts and five gets to increment these
stats and the stats only aggregate and
above numbers of 5 so
that's why we have to do five so what we
do here is we create the the react HTTP
client here then we do this you know
this we create this list of five items
and then we write five them then we read
file so we've done our 55 years in our
fire rights now it's time to compare
stats well you remember this guy right
he's still bound right to that initial
set of stats so it's cool because now we
can get stats again and what we're going
to do is compare them and we have this
verify Inc function which is like the
verify NC only it takes two sets of
stats takes a list of tuples and number
tools of keys and values and basically
says this statute have incremented by
this much this one should increment by
that much and we just keep going and
you'll notice some of these numbers
might seem counterintuitive to you
especially if you don't know how I react
works and I can dip into a really quick
the react put operation doesn't get also
so we did five puts we did five gets
also and then we did five gets that
means every get stat is going to be
twice the number of put stats and then
the vinodh versions are actually three
times as many for both because we store
three replicas or your data by default
so these are expected values we expect
that's what the case to be so that's
great so now I'll verify inks or it
looks like the same thing only at
pitches values out of the propolis and
then does a comparison to them it does
some cool output by the way so you can
actually see what the test is doing is
you're running so and you know this is
the same function call again but now you
know what that does and we're back to
verifying out 0 I mean now that we've
actually done some things with react
operations we can see these operations
all we're supposed to take some amount
of time so we just make sure that it did
take something out of time but gets took
some time to post took some time than
average is all working but will work
again we don't know how Patrick system
is we don't know how fast we expect
these operations to be in a functional
test but we know we expect to have taken
some amount of time so we take for that
then here we check for protobuf
connections what we do is we create a
program of connection
and we then call the status make sure
that's incremented by one on that
particular Staten need a five
requirement so great for us the next one
is the best one and then we're done with
the stats test so this one is reef or
Sandry prepare to increment three repair
status what's a reed repair well by the
time I talk you through the slide you'll
know first thing we do here is we create
a single object in this new test bucket
when we create that object put in the
database like I told you react to my
default rights three copies of your data
so now we have three copies of this
object in the database then we say hey
for this bucket store for copies your
data okay great I'm gonna store for
copies of data but I just know that for
the future I'm not actually doing if you
brought it right now so then we go as
the stats again hey what's the rear
appearance status and they're like zero
we've never done a Reaper pair before
okay great now I want you to read that
one object that we put in before and it
goes okay great here's your object I go
thank you very much and then we call the
stats again because behind the scenes he
goes well after I give you the object it
was cool i found in everything but i
know it is we only have three so i'm
going to go ahead and make a fourth copy
and put it over there and then it's
going to be safe we're gonna have four
that's a read repair so we check the
read repair stats and they're
implemented by one after this is all
done we return that up and the atom is
pass because it has passed you can't
force it test to fail by returning fail
but we don't usually want that there are
some reasons to so what's different
about jmx than the stat sense we have
this stat test it illustrates the
statues case jmac should do the same
thing in theory that's that's why we
like it so it's easy right we just plug
in like like jmx Earl and we just use
that instead of instead of curl and
we're done there's no jmx Earl you know
there's uh there's no Jane makes
anything not java it's just this thing
that
they didn't find anything so we needed
to do something to be able to get that
and what we did was we wrote this little
job utility you know what to read it
it's only javis allowed me to give you
its Coast life for you can see it if you
want but basically just excuse the beans
exposed properties and dumps Jason and
what does that remind you of what
reminds u the statue are all the dumps
Jason so now I have some JSON object of
all my stats from JM x which is perfect
exactly what I need so if you go to
Coates life I just see the first version
of the jmx verified test and what we do
is we take this stats function that we
all know and love from the previous test
and we replace it with this guy and so
what does that guy do well we have this
James don't command thing which creates
the command line syntax for calling that
jmx tool and then we actually execute it
with the following command and that
looks like this and it's not so great I
mean it's all right this thing this jmx
jar path finds a jmx jar which lives in
the react team x project and this is
just some class path of you know module
library path funkiness to find it this
thing actually creates the command line
syntax its Java command your class name
and this thing actually calls it does
the JSON output most Jason to code and
all that and the timer is sleeping and
that's that's important because the jmx
thing actually only updates stats every
30 seconds reacts that's actually update
leg continuously but jmx is like a poll
it pulls from react over j interface so
yeah i put this into review and the
reviewers like why you're stopping for
40 seconds that makes no sense so I've
made in this awesome ascii timeline it
was so great i went found in the floor
request and brought it back for you guys
so what happens is here is where the
stat inducing operation occurs so now
these stats that we live in the memory
catch flight one minute so when you do
that Reid repair that repair just sits
there in one minute and then when women
it's up it bounces off the end of the
queue and it's back to zero repairs so
we have one minute window to see this
stack out ring jmx updates every 30
seconds which means it could update
right here or could update right here
anywhere in between so we know at some
point after jmx updates but before the
stat expires here the read repair that
we want to see is in the jmx beam so we
go look here
we go some one time longer than 30
seconds sometimes shorter than 60 I
chose 40 so how do we run this test well
the first thing we have to do is make a
dev rel of react and what a Deverell of
react is is basically like six copies of
react on one computer with different
ports assigned to it in different
stupider lying noo tidies and stuff like
that so we wind up getting a way that
bill they react closed or locally on one
machine so we build that then we want
this awesome script that copies it into
a local git repo why do we do that so
that we can always reset the real
cluster back to an initial state to make
sure the test results are always the
same and this script is actually part of
reality because that's where jmx lives
but there's an open source version of it
in the reactor evil and the only
difference in his environment variables
pointing to the correct path because I
just react developers of a show we want
to make sure that we have we can have
two versions like concurrently on the
same disk and not worry about what we're
running them and oh my gosh I was
testing e when it should have been
testing react so it's more convenient
for us so then we go into the rack test
directory making clean it we make it and
then we run the test with the syntax
react test is a nice script always has
been always will be maybe not I don't
know this is the configuration can be
blank was just defaults to default crazy
right then he happens to be the
configuration I've chosen I should be
touching this and then T is the test
that I want to run so great we should
run this image at all work because we're
great when you write tests we never fail
isn't that wonderful this tension work
but it doesn't and that's because we
have the lack of parity and what that
test result output looks like is this
and you'll see it on coat slide 6 most
of these tests output should be like a
full stack of the output of the test but
I'm just going to show these stack
traces on the failure you can go these
tights are going to live on github repo
forever so don't worry about missing out
on them so this is the stack trace and
my trained react esta i tells me that
the real problem is right here which i
can show you better by doing this it's
looking for cpu n products and i don't
know if you guys remember but the cpu
emma rocks thing
this camelcase mess and java and you
know there are no cpu n props but you
wind up with is these lists of Erlang
terms of like this and java variables
method names that look like this and
they just don't match and it makes sense
why you would do that if you're a Java
developer but we really want these
things to look the same so um yeah it
was looking for this it found this so
what I'm going to do that was on codes
line 7 by the way next it coats lat
eight you see a version of jmx verify
that has this um this function here this
process key thing which basically
compensates for the lack of parity it's
saying you know if you see the JSON
object returned CPU end products along
these capital letters that don't belong
there just transform into this and we're
fine so we do that and then we run our
test again because we fixed it and you
know what we did actually fix it this
thing passes and see these output
messages from the verify ink and you see
that you expected vino gets to go from 0
to 30 and it sure did so great we've got
a past love passes time passes so
finally this time passes and somebody
wants to add features as people tend to
do eventually and the first thing I
figured as a recovering java developer
you know what's my instinct right i'm
working on a java project now what we
need to do matt maven so I did that and
you know a we used to use make files for
this project literally like went through
the Java source directory and did Java
Sea on start on Java but it's stored now
that we're using maybe because all we
did was change the build tool we didn't
actually change any functionality so we
just run the test again because we
already have it and we know it works and
it does work look it looks exactly the
same what a time steps are different
because I didn't run them at the same
time as am I crazy so we have this thing
now where we have this thing that's
building with maven and I was about to
start working on the actual problem i
came to solve which is this mess of
parity and I heard this nasty rumor that
if the Java process died the reactant
would die too well that's nasty so how
do we reproduce this if it really
happens well we're gonna have to kill
some processes
and the thing is that I'm you know we
could just kill hind like random
processes see what happens but that
seems like counterproductive so we
figured we find out what the process is
actually look like if you defy them that
we know what to kill so the great way to
do that is just throw in a cert fail
right after startup and react test and
what it's going to do is give you this
awesome output you know here we find
ourselves in a situation where a single
test failed would you like to leave the
cluster up so you can debug it yes I
would if somebody asks you that you say
yes that's how horse so now that it's
running and everything's up and fine we
say listen one of these processes look
like well you know I filtered out what
everything except the one I was curious
about you know I found there's a lot of
these in there and so we're going to
just based on that we're going to just
kill them all so I wrote this like
really library function that does PS
grab and kill nines and hope all this
stuff out and I was really pleased with
myself and so then I added this test
supervision thing to the test you can
see that in quotes like 13 wow we really
skipped a bunch on what happened it's
fine so this thing is great right we
just deploy the node we kill react JM x
10 x why we choose 10 because we did
peek at the jmx supervisor and see that
you know it had a restart policy of 10
reach were 10 restarts in 10 seconds
triggers a supervisor so we're going to
test what that does so we did that and
what happened it has passed anyway
because it's too slow I was resized
killing prostitue two seconds to kill
the jvm you know 2 times 10 is 20
seconds I need 10 deaths and 10 seconds
couldn't get so what do I do well it's
react test so I cheat I so when gmx on
port 80 and that thing fails right away
because I am NOT roof so I did that and
you know I just this that I set a config
which looks like a subset of the react
app config you can deploy nodes with
that argument and your
overlay the config for what you need
sleep for 20 seconds why because this
thing takes you know 10 seconds or so to
crash completely so let's wait if it
hasn't crashed 20 seconds it's not going
to crash so then it doesn't it hadn't
been paying and either it pangs and it
broke or it does something else that
were happy whoa we did it we totally got
that thing to fail react jmx crash able
to crash node so great we actually have
a test case for this isn't that cool so
that we know what it shouldn't do which
coincidentally happens to be what it
does tragedy so what should it do we
want to let the Java process crash if it
does we want to do 10 times retry like
we did the thing is we want to leave the
gin server that's sort of wrapping this
ports the Java process up so that if if
the thing fails then what's going to
happen is 10 minutes later we'll try
again maybe it was some port that was
already bound and you know you as an IT
administrator fixed it and jmx will come
back up again in 10 minutes and we'll
all work suddenly that will be great but
we don't want jmx as an add-on to be the
thing that broke your rehab note so
let's build a test that actually test
this functionality and we'll do it
before we even write the code and that's
what this looks like this is code slide
16 and that's really hard to read but
basically what it does up there is it
calls react jmx stop so that it resets
any retry counter that exists then it
loads this cool thing this react has
lager background back in on to the react
node remotely it's going to say that
thing okay I'm going to enable these
logs on react on this rib node to live
in memory and then in memory the things
are just going to like these these three
struck messages that react jam X is
generating are going to start are going
to be you know kept for posterity so we
do that we start we have jmx again it's
still set to port 80 so it should fail
10 times and then afterwards we just
rang X basically through the log
messages and count how many times we see
this message which is JM x server
monitor exited with code white so we do
that what's happening well my trained
eye sees bad RVC node down that's really
bad because I can't I can't do anything
if you track this line number down with
the
happened you're going to see the RPC
call to react jmx stop is where the
error was we couldn't actually we were
stopping wrong so I dig in to react jmx
top and does anybody see the problem
with this line of code now the locker
the lever longer line seems fine but
anyone in its top react jmx stop to stop
the application of react jmx stop the
entire note gone no more testing because
the note is gone I think I may be the
first person who ever have called react
jmx top so that's why I found it so we
changed its application stop let me run
the test again and now this test output
looks a lot better because they're
actually assertions being checked
everything like that and again things
start bouncing out of me and yo dude
you'll be able to see the orange too
when you do this long enough but the
retry count is off 10 verses 15 should
have been 10 it's 15 that's a problem so
let's look at our lager messages are
actually this is in the jmx server
monitor and what you're going to see is
this lawyer message I said you know what
this is this probably some counter thing
I'm going to output the counter
increment so I just changed the longer
message a little bit to have an extra
variable in it and we do it again and
the test fails again same thing 10
children 10 but it's actually 15 so then
I look in the logs and I see this lager
message look at that oh I'm in a way
call the zeros it's not right it's wrong
because I did that programmer think that
one plus thing i forgot to increment the
counter so you know I go back and I wave
my hands and I fix the cove and i
literally just go back to the gym server
and put a plus one and then run the
thing again you know same alpha message
and look at that 0 1 2 3 4 5 6 7 8 9
that it's 10 messages we did it guys the
thing does not crack anymore so that's
cool I still haven't even done what I
set out to do which is to bring parity
to jmx all I did was fix bugs that
people have sort of been like telling
stories about four years so let's bring
parity how are you do that well let's
review our problem my problem is that we
have these we're expecting these cool
things we get them in stats we actually
get these things from
eggs and we don't want that so that's
the same problem we have there so you
guys remember this code we added it
specifically to the test to compensate
for the fact that these things were
wrong so if these things are here to
make the test pass when the code is
wrong we take this out then when we get
back now the test should actually fail
because it's not doing what we wanted to
do which is before what we did want it
to do that makes them it's probably not
basically now this test should only pass
if the thing was like stats and great
yes look at the same error remember see
if you n prox the error well now it's
back but this time this is what we want
because when this test passes in this
form we have parody so this is um you
know this is our line user conference
not job user conference so it's gonna
wave my hands about some Java that I did
here but jmx beans are there like the
poster child for like the ceremony of
Java right there's you need a class and
an interface for being and you need to
get incentives for every attribute you
want to expose via jmx and you need a
property for those and you need to get
incentives to work properly against them
and that was really annoying and then
when you open up the code you see oh
this is why this parody exists the
disparity exists because people made
these getters to look like Java getters
and they only made them one at a time
there was a manual process so we decided
we do with better program we use this
think javis is to actually build the
beans at runtime which was great because
then nobody ever has to go back and like
add a property manually again we also
over there realize we were using curls
we just change in her face and that was
cleaner except my pet peeve with Jane
her face by the way if anybody does Jay
in her face why does an OTP erlang
string extend OT peter lang list should
write strings or lists another fine so
that's me thing was crashing and it was
designed to let the job for us his crash
and had the ER like jen server handle it
so it does great we're going to let it
crash and not worry
trapping you know catching every
exception in Java land but with this
like dynamic reach recompilation of Java
classes also you run out of this thing
called permgen space which is like class
loader like runtime done a good job with
a goop um so if we let this thing crash
every time it has a problem with
compilation it'll just restart and not
worry about that and that's great
because when a new stat is introduced
via react stats like everyone just
appears it wasn't there before and the
introspection tries to set the stat in
JM x and the getter setter isn't their
whole thing crashes and that's fine
because it crashes then it restarts it
goes get stats again this time that
stats there for the first time and it
builds the class dynamic way to include
it that's great so we did that and it
won't because we were good i guess i
don't know no because of it took a while
this took days but this is days of java
that you guys don't care about so after
this you know we're sitting there we're
all happy with ourselves for actually
having a jam egg with parity that
actually works and you know it occurs to
us that this is like an overcomplicated
solution and we've read up on this thing
and what happens is there's this thing
called dynamic and beat and it's
basically the hash map of jmx beans you
just say just stuck as sick attributes
in there and they'll be exposed to jmx
no problem you don't need to calm polite
and compile compile anything you don't
need to you know have a bean you need to
have an interface to put the hash map
and they'll be exposed so we did that
and that took some days but you know
what we already knew we had this thing
working the way we wanted so we had to
do let's run the test again it works we
actually have jmx parody coming in react
14 so what I learned from this you know
I learned this tried-and-true lesson
that I learned throughout my career
which is test driven development site
going to gym you know it's uh it's good
for me I feel better when I do it but if
you forget to go like one day that it's
like harder to go the next day
like by a week you know you just don't
go anymore and you were that guy you
just go to the gym but it's workable I
was when the real test is a better at CI
that it is a test or and development it
is uh you know there's a lot of waiting
around for react test you got to make
the Deverell every time you make a
change to react you've got a copy the
thing into the git repository you got to
rebuild the test you know it's just it's
a it has a workflow that kind of slows
slows you down sometimes and if I get
the time I'd like to add a like a test
driven more rapid iteration by mode I
guess it would have been hard to
manually test that process killing stuff
especially the process kill any stuff
that then I was trying to do with PS you
know eggs like once I started on port 80
that thing became like trivially easy
but I didn't expect that to be the way I
was going to go and you know when you're
trying to like trying to kill a process
10 times in 10 seconds that's not
something that like a a person can
actually do so you can find out more and
see so this give up URLs where all the
coats lines are for this talk if you
actually reply if you yeah i'll give you
the slides later the repositories here
including the jmx s.oliver all of our
react ee tests are actually open source
and react test as well so you can see
how we test that and that's really it i
can take some questions that i can go on
to some also some greatest hits of
reactive if you want
all right um see so what I got here I
got no green folks I'm awesome you guys
are awesome too i'd love to have any
here but we can talk about reacts grade
tests greatest hits if you want do you
want to you want to hear a little bit
more about like something like fun sort
of light functions that I can do you can
leave if you don't it's fine now but you
know but Greymon you do so this RT
console top function is how we test a
Cosmo direction react you guys may or
may not know but you can you start you
can attach the running reactor no with
react at all and where you started
reacting node if the Earl in the airline
Council basically say okay now I've got
this node running and I got an erlang
interpreter is supposed to it so how do
you test it that works we created this
cool thing that actually goes through
this list of tuples here and the first
element the tools either expect or send
and so you either expect to get this
output back on the back on the pill or
you expect or you send this output and
then wait around for this response or
response containing this thing so this
thing is easy right we're just attaching
rear console we expect that you know
classic aboard with ctrl G message if we
get that then we send this react core
ring manager get my ring we expected to
return some kind of dick again we don't
know what kind what the exact values of
it are we know it should be addicting
send it you know the Q function and then
we expected to say okay and then so we
basically we just hold it to quit so we
hang around here Wade's all the nodes
unpayable if it stays pingable 45
minutes which is the timeout value on
this thing then it's like hey you know
you told this thing to shut down and
totally
I want to fail your test now throw an
assertion this thing is chock full of
assertions in there Russell Brad did
this cool thing which is the react crdt
counter convergence test and what's
really cool about this is this art for
this partition stuff so up here in part
part in for what he did was he said
you've got this for node cluster you
don't know n 1 2 3 &amp;amp; 4 partition the
cluster in you know so that one and two
can still communicate and three and four
so can still communicate and we do that
by basically taking the second pair and
reversing the cookie on it and then
doing like a RPC to layer like
disconnect and so now these guys like
aren't aware of each other but the react
test node which is another one in this
whole family like still knows about both
of them so he can be like hey you know
what's going on over there and then we
can try and do some operations and then
basically down here we can heal the
cluster and then make sure those offer
the the data type counter actually
converged so that's the sum this ability
the test partitions behavior is pretty
cool and then see the last one is is my
favorite this is loaded upgrade this is
the test we actually check to see if
some there's some function that some
functionality actually is maintained
under load and we upgrade an entire four
node cluster from the previous version
of react to the current version that
we're testing we do all sorts of react
operations on it while we do and that
thing basically spins up this supervisor
that that says you know what just um
this is test loose through its what it
does is it this artsy upgrade node
actually will take a node variable and
upgrade it to the current version so it
can be any other version and then we
start this worker which physically says
do all these things it has to know what
back-end were test
because it does different things based
on different backgrounds and features
they support then we check to make sure
the thing is upgrading then we started
this loop which way so just listens for
errors from the upgrade threads and
they'll say like oh you know I've looked
up a two I query and was totally wrong
and then we'll get a search and will
fail it out here and then that's the
list comprehension over the nose that
about our running so this thing
basically just loose through every node
upgrades you know we spend five minutes
pounding on it that upgrades the next
node doesn't rolling upgrade there's a
really really fun test to write and what
that looks like in you know like
architecture speed is this thing where
it's just you have react test and its
bonds these four nodes and then it
spawns these worker threads you know ten
per node so we're talking about like
running 48 threads and each 40 thread
spawns one of these tests threats to hit
these features so you've got 40 threads
each bonding a thread to do kv list keys
search MapReduce and 2i against each
node in the Rio cluster and any one of
them that fails functionally during this
like half hour 35 minute test is going
to kill the whole thing and this thing
past is quite a bit actually it
surprised next you shouldn't be it's
awesome so that's it those are sort of
my favorite like snippets of reactants
that weren't really relevant to the test
driven path that i did but i thought i'd
share them anyway so that's it come find
me if you want to talk more about it
you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>