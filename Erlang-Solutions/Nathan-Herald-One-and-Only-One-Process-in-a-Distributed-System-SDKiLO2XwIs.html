<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Nathan Herald | One and Only One Process in a Distributed System | Coder Coacher - Coaching Coders</title><meta content="Nathan Herald | One and Only One Process in a Distributed System - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Nathan Herald | One and Only One Process in a Distributed System</b></h2><h5 class="post__date">2017-06-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/SDKiLO2XwIs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello I'm Nathan I goodbye my OB a lot
of times almost everywhere I have a lot
of slides so they're going to go about
the speed but everything good is at the
end so don't worry about their bqa at
the end so I'm actually going to try to
get done while early because I want to
hear your question because I have idea
and I want to convey the idea and then
you can tell me how bad it is
I do this for living I design
distributed systems I didn't used to but
I accidentally have a career and it's
spiraling out of control so what I do
and I made my own presentation software
which is a really bad idea and you
should never do it unless you really
wanna be stressed out like 40 tall I use
this for a JavaScript I just like it I
want to tell you it's a great javascript
framework but five kilobytes is what my
side looks like again I'm just telling
you how stressed out I am
there's no speaker notes because I
couldn't get that future finished you
know don't do your own yeah this talk is
actually interactive the website has
been working fine added the slides in
case the Wi-Fi didn't work fine but I
think the life size fine there's a
website you can go to and you can
actually do something and it will affect
well we'll see actually it will affect
the screen you can actually rate how you
feel that line is actually the current
average rating of me I moved it a little
bit you see so if you start rating
up-and-down of the line might update I
don't know we'll find out there's a
scenic server running somewhere
hopefully who knows you can also submit
an emoji and they should appear in the
corner they do at most one over ten
seconds and I have good validation you
can listen one emoji I found a good
regex
matches all the Unicode code points it
doesn't matter so have a good time with
that hopefully yep great Phoenix pretty
good web sockets so distributed
applications are hard that's basically
the beginning of my story to get to the
idea that then you can ask questions
about these this is why it's hard
because everything is terrible
networks are terrible with like et -
right you I get ec2 instances that just
don't have
network you know concurrences hard
although we go like Alex Turner laying
but like concurrency in a system I mean
you have two computers to like you know
managing concurrency on one computer is
easier than two locking is basically
most people don't even try they just let
their database linearize their whole
system like use Postgres you're probably
just using transactions and then you're
like hey I don't have to do any more and
then stale data a lot of people don't
realize that they probably have problems
with stale data that's how I feel about
it I found this awesome painting as how
I feel about distributed systems it's
very fun but I'm dead
yeah so I just wanted I want to bring
this topic up guys it's not when I
talked about but I just feel like I
don't know I like talking about this you
probably have sale reads and your system
depending on how you've implemented it
you probably like I use Telegraph it's
consistent yeah but you know PCP is
problematic and you can do a get and
then before you get returns if someone
else does opposed or even if you do a
post because you're probably on a
request pool you might get the get later
it may have returned it before the post
but you may not receive it until after
and this actually I used to work on
wonder live and if you've ever seen a
task disappear that's why because we
could download the array of tasks and if
it's not in the array it just goes away
it literally comes all the time you'd be
very surprised how often networks are
terrible and now we have lots of emojis
cool scaling is also hard right we're
getting we're getting somewhere I come
and this is why load balancing is great
right and so it's not parallelism is
great until it's not and databases are
just like I mean have you do you know
how often you're Auto vacuums running
because if you don't you're going to
find out like you're going to have a bad
day probably a bad few days on
politically yeah I've been awake for
like 48 hours of time time six Auto
vacuum running on RDS and you still have
to vacuum like I know people some people
you know it's Auto vacuum they're like
different they don't do the same thing
terrible how I feel about it
so then you're like well then why do we
do why I'm not even gonna do it like I
just have one computer and that's fine I
just fine actually
but this is probably why you probably
want to do some scaling you probably
want to have in quotes billions of users
right you probably like 5000 and that's
great actually
I like systems I have like thousand
users cuz in Italy you don't optimize
anything you know it's great you just
ship all the time and like like you
thousand people have no idea slow you
probably want your app to work offline
and network so bad like network here bad
cellular networks are bad although
they're better than like coffee shops
and hotels now let's talk to you about
that I wants to talk by Joe Armstrong
recently it's the name John I don't know
I just watch the talk like this is the
URL that you'll never be able to
remember but he was talking about this
great analogy which is if you had a
container and you tried to fill it with
bowling ball right you would have also
empty space and he's kind of talking
about the computer and like the compute
capacity of it and so if you write these
monolithic algorithms or monolithic
applications it becomes harder to scale
on one computer becomes harder to scale
across many computers instead if you
pour sand into a container you don't
have any United wasted space and so this
is what it meant to me is that the more
granular you are the more scalable you
are yeah we're getting our Thomas mr.
lagana so we had a crazy idea a few of
my friends we've been talking about it
forever and so I submitted a talk about
it and then it got accepted and then I
had to make a library to do it so having
a central database like I said make some
things easier you can linearize you can
use transactions fantastic you know but
it's hard to scale we're on like one of
us is on like the biggest Amazon RDS and
if they come out with a bigger one we'll
do it like please so it's pretty
annoying so this is what we think what
if everybody had their own database
right and what if it was just a file
wouldn't it be great like that'd be so
easy yeah sounds awesome picture he's
like whoa okay so the reason most people
don't do stuff like that is because time
which is interesting because though they
mention that this morning time and
system
- impossible to understand because human
time cannot be trusted right we all know
that well hopefully and if you don't
like you learn it the hard way like I
did when they're like hey design the
sink of an app and you're like ipz yeah
yeah this is the cool picture this guy
does like the standards of art I just
searched for words to find pictures from
my presentation and I searched for time
but it was actually he built like this
plotter and I had a pen and I liked you
know so it generates the art and memory
and then the pen like profit that has
nothing with anything I'd like I mean
like it's really cool named Anders Hoff
and he has a Twitter account there and
he posts like his new generative
algorithms post the code to the rights
that enclose her Python stuff like that
yes I believe that all working
distributed system are just an
implementation of how that organization
understands time and I think when you
look at any kind of think algorithm or
whatever that's basically let's talk
about some more concepts because we
don't need to go anywhere uh actors are
great this is what I thought Erling was
about until I learned about processes
right which is just an actor with a
funny name that's very then you have to
always say not OS processes and like
yeah this is this photographer guy and
he takes pictures of his daughter acting
different scene so this was what I found
with the word actor and I also just
think it's hilarious like the samurai
sword
so wonder lives we actually use actors
to wrap each WebSocket connection we've
scholar and akka and that's been great
it's a great way to like contain state
linearize access to things make sure
everything captain's in order and oh my
goodness that sounds very interesting
right so elixir has processes so then we
thought well what if every user had
their own process in system right and
then we get all the benefits of you know
that but the problem is how can we know
that that one process is that one user
you know I mean we really need to know
that can't be too like if there's - my
obese right in the system and we're load
balancing because that was already on
the slide like which one am I talking to
I don't know
so of course you're just going to global
right yeah well it turns out Global's
not consistent all the time and you're
probably thinking lying
it's called global yeah but if you look
at the dock there's three interesting
parts of this sentence in the dock the
first thing that jumps out to me is name
clashes like how's that possible
and then discovered so it's like name
clashes at the time and then there is a
function called resolve that you can
implement and you would not have that
function if you didn't have conflicts so
how I feel about that so then you're
like management other things I promise
there's other things yeah but that's not
completely and you're like are you sure
and it's great because it I love it it
replicates all of them information in a
way that doesn't require consistency
which is great it's very fast but it's
obvious literally like the opposite of
being consistent so like that's good and
you know like there are a lot of
applications that that is like the best
look if you don't like IOT stuff and
like it doesn't really matter if you
like it can identify this one light bulb
like blue in a tent I'm like who cares
right and if I think in like gee Prague
I liked it it's like I found this on
webpage and it's like it just as gen
leader is problematic and I'm like what
does that mean does that I don't know
I've never used it
I just Lisa I've never read a good
article about Jenna leader have you like
I've never I've read I've read bad
articles and I've never I don't I want
to use it because I'm like what could it
have done to these people so like that's
how I feel about that and then you're
like I had seen on hex tile it looks or
has a registry for possible and that is
true it runs on one VM and it's
consistent because it's on one VM
because in quotes that's easy right and
so you're like we're gonna be clever
we're just going to run one computer
that's the registry right the problem is
that VM stops then everything's gone all
your days gone and machines stop they do
I promise
so you know there's actually worse than
that like how do you know that you're
never going to make - because we
actually have a thing that one do list
it does like this email thing it
actually compacts events down so you get
like one email for like maybe six things
that happen
but we can only ever run one but believe
me we have ran
and it's very difficult yeah they play
like that talk about that yeah so how do
you do it how you do it the only way I
know you just watch someone else do it
looky looky fur is consistent it's
pretty label and it's partition tolerant
because of some papers that apparently
is good but the best part actually about
zookeeper because it doesn't matter like
zookeeper is great except that like I
don't know how to use it right but they
have recipes actually document it like
they have a whole page in the docs they
keep out today and then I got interested
okay okay I can it's like baking a cake
it's like amazing I may not succeed but
I could follow the recipe right and I
have recipe first riveted law which that
sounds interesting
so people getting some I promise like
this well maybe and I just wanted to
reference a dj khaled
good piece great so he always says like
that the major key or whatever and so
the distributed locks is the major key
to get in where I want to be either way
zookeeper is a battle-tested system
right that'll test it like Netflix use
it although there are two Netflix repos
for monitoring and like launching
zookeepers so apparently like they run
it but they've built like all the
pooling around that which makes me think
like maybe it's not that easy
if you want to cheat just go to Heroku
and like pay for Costco and then just
don't use Costco just use the zookeeper
they gave you because they give you the
URL for an admin tasks as on each piece
of your other stuff I need to feel like
you're in the same data center and like
that's how you could do it like if you
want to run like on another like like
dissolution or something then you gotta
like you gotta like figure out how
installer yeah either way with zookeeper
we can know if one thing has happened
before another that's really big if that
it gets us it can know that you can't
know if you're the first when you
happens but you can look back and say
was that first so that I know that's
weird but that's how did so i mazing
called highlander have URL and github
like everything else yeah I named it
that because it enforces that there can
only be one and some of you laughing
because that is a reference
ninety thousand shrimp and the name
actually took the longest like not
writing the library's except finding the
perfect name the best part I think about
this show is that somehow they got Queen
to make the song for the beginning which
is like how did that happen and like you
know people in that's a Duncan MacLeod
of the clan MacLeod so in my library
objects in quotes right they actually
persist their state that's something
else I want right I want I want these
things to like if the machine was to
crash I wanted to get them back and so
it just takes its gen server state and
puts it on at three every now and then
I'm going to boot inside in it it just
reads the file named after itself so it
does but when you ask it for things it
just responds from memory we don't have
to actually ever go to f3 unless
something changes because it's the only
one we know that we have most up-to-date
information and we're just going to
assume that there are no other
applications that use that bucket
thank you but whatever and this is a
feature that I I don't even know if I
actually implemented this I made this
slide but you know I want this to be a
thing so I didn't already do it I may
have a branch I didn't post do it it
should timeout that'd be great because
then the system would really just
reflect like the actual people that are
using it I don't that'd be really cool
so it puts process registry and
zookeeper and you can do that I don't
know if you know how so I was going to
show you some code now Jen server has
this thing called via I don't if you
ever used it I found it like really
confusing at first but it does work you
can do stuff like this
so the instead of the name of your
process you have to give a tuple couple
and like via and in the registry and
then whatever information you want to
hand your registry as an argument and
then you put them on more like function
that you want to run or whatever you
want to handle and this is how you make
a registry you only have to do four
things you have to be able to send a
message you got to figure out where it's
sender you got to go to add and remove
things and that's it it's actually
really simple so that's what happens
inside the Highlander library zookeepers
just a simple key value store so the key
is going to be the object ID which is
just the concatenation of you
and their ID right or whatever the name
of thing is whatever idea the things and
then the values what's the name of the
note because once you know what computer
something's running on with Erlang it's
pretty easy and to talk to it this is
some I copied that's pretty much
straight out of the Highlander stuff so
the wear is part of it it just goes to
zookeeper and gets the value as I know
with that name if it doesn't exist and
obviously just returns I don't know what
you've returned but there's a thing a
special I think it's like : error or
something you know that you return when
you don't find something when you want
to register a new one we just create a
new node and then this is where the
distributed lock thing comes in so you
it's better to actually make a process
to kind of be the mode like to
encapsulate the idea of the middle so we
do that we start link a node we note I
made V node like I'll be on the next
slide and then you just look at three of
you were first I guess that you can't
know if you're first like when you start
that you can look back and so if you
were the first London that means that
you're allowed to booth if you weren't
the first one then you should not write
and I returned and I already do and then
this was the magic it would zookeeper
you can create a key value thank you
I think they call it a node I think
that's why I called it that I generate a
UID just because that's what they
recommend with this recipe but I put the
UID like after the object name it's just
a way to make them more unique I
remember what is some race condition
here that takes care of yeah and then
the value like I said is just the name
of where I'm at right now note that self
you do make path true because I think I
have some splashes in there and they
consider slashes like a nested path and
their keys but the real magic is that is
the fact that it's extra Merrill and
sequential and sequential is the key
word right
it's zookeeper will enforce that
anything created in this key area like
this path is in order right so it will
actually panned on the end of the name
the UID and in a number right that's
what it does and it'll be like 1 2 3 or
4 and it enforces that and make sure
it's consistent about this little
cluster so that's how come you can then
go look and see if you're the first one
in that path
right and at some Aroldis means that if
we drop the zookeeper connection all the
keys that we have created will be
deleted immediately because if we drop a
zookeeper connection then there must be
something wrong with our server and so
there's no reason that those processes
won't be running at that point so
zookeeper keeps time in order but it's
important that we help OTP out so they
can keep our processors running
I like this rest for one strategy
because what this means is if anything
happens with zookeeper then it kills
everything after it and it starts over
at the top right so it's like or
something happens with the server it
kills everything after that it goes bad
and starts at the top and so that way
like I said if our connection drops of
zookeepers and every single object that
I've created object and course will get
terminated and you know you just
wouldn't find it after that so it's
great but I care about the developer
experience so I provide some macros my
library and this is an example from my
test file it's create a task or - do you
give that pipe and that's like the first
part of that tuple and then it just
assumes there will be an ID and then I
am in a very deaf object macro because I
thought that was funny
it just does deaf struck for you so if
you don't do the deaf object and it just
returns a map every time as like the
thing that is kind of serialize and
deserialize from s3 but if you do deaf
object it just takes that map and put
the dinner struck for you is how you use
it you can get stuff if you right now
for some reason I decided that if you
get an ID that doesn't exist I returned
an empty object instead of returning nil
I don't remember why I did that
it's probably not a good idea either way
that's what it would look like and then
you can update things and it will when
you do the update owes their life step 3
and then later or another machine or
whatever you can just get it and it'll
be there yep so at that point you can
start just creating everything users and
what my biggest thing was though is
every user has this database but like we
share like a document or something like
how do we model that because the you own
document do I own it I say just make it
its own object so in Wunderlist like you
can share a list so this is kind of what
we would create a list object that might
have some taboos in it and then we just
have to set up some permissions around
that but then each list would be like a
collaborative object and system that you
can talk to directly using that this
passing and it'll keep it state you know
serialize and all in time yeah I don't
know why I repeat myself good if you
want to do permissions this is like
something that's what I did I have it is
like the user can just have some list
they've heard of and then the list can
actually do the enforcement of who's
allowed I'm still working on like what
updates look like a thing about doing
this like handle update at first I was
going to do like agent where you do like
get an update you pass a function but I
figured like maybe it's better to have
like a handler at the and I think I
actually forgot the state arguments in
there Liam but you get some sort of
thing modified state returned it just
like a gen server
yeah and then it would handle put it on
s3 and everything right after that a
good thing about this for scalability
purposes it's like if one list or
document or whatever was like super
active like it wouldn't slow anyone else
down it only slows down the people that
are involved in that activity and that
would be great because you know if you
have this month like baby basically like
everything I've ever worked on when I
think a little down it affects every
customer and it's super family just a
quick side right test I had to boot
multiple or lengthy em and that's really
interesting it turns out Phoenix does
this for the pub/sub stops I just copied
what they do that's just some really
gnarly Erlang type stuff yeah I don't
know I thought that was interesting
either way there's a file inside of
Highlander support cluster and has all
that stuff we have to boot this thing
and I donno if this does but someone
needs to tell me that so I don't lose
that doesn't work and that's how about
that yeah but it's like scaling right so
this comes back to what Joe said that's
reason I mentioned it when you really
did model everything as a process it
will be like pouring sand into your
cluster right you would just you get
scaling in quotes so you're probably
thinking how many Lots kind of smaller I
don't know I have no idea you could
start zookeeper or you could do what
other people do
I'm not the first person to think of
this idea most people would actually
just use
zoo keeper to set up shards and then put
processes based on the ID on the machine
that doesn't needed for like all the
ones that began with zero though here
and all that stuff I thought halo does
actually believe it or not for
multiplayer they create object for every
game object every person and they
collaborate using message passing if you
don't know what halo it was a game they
use this thing called Orlean which is a
dotnet or C sharp or something actor or
framework I think it's modeled after
Erlang a little bit and but it does the
basically what I told you which it keeps
state kind of on disk and make sure
there's only one and they do the peeper
shorted thingy and that's the URL you'll
never remember about where it is there's
another thing that Microsoft called
service fabric which I'm always really
excited about but I can never find use
for but it lets you create stateful
actors stateful services and know that
like you know something happens in one
place and they do the same thing they
use the keeper actually to set up
partition and in a partition stuff based
on that to keeper registry so I think
that's really interesting and I would
love to have a really good production
library to do this
your pricing like with binocs how you
said you that's fine yeah be great I
don't know I don't really want to
anymore Scala but um octaves great
library there's a thing called react
core and I think that's great I just
don't trust myself to implement like oh
here's all the zookeeper stuff I don't
even know of like the way I use the
keepers quick you know what I mean like
just because I they have this recipe
doesn't mean I baked cake correctly so
that's how I feel about that so this is
the point I think you should have fun
because you have crazy ideas you should
build stuff and you should or you should
apply for a talk for something you wish
you would make and then when it gets
accepted then you're little stressed
about it okay that's pretty much it like
I said I was going to finish pretty
quickly I can go back to hanging that
code so I would like to ask questions no
matter what I just don't want you to
make like a long statement that's not a
question
good
all right the way we're going to do this
is if you're in hard-to-reach place
please pass the microphone down the road
it's a hand back here awesome
hiya
great talk kids so sort of maybe a
double question are the s3 documents a
mutual themselves where they append Oni
with events that have post of the day
Thunder just a document to you yeah okay
change that but it would be great to do
something like event post thing right
that would make it really cool okay yeah
so the second part was do you keep any
sort of logical time stamping for how
far each actor is step through I started
on that I haven't pushed it yet we do
that one rule is we keep a clock on
every object and I would do the same
thing I would just put a number in in a
minute yeah I think I've been useful for
a lot of reasons
yeah Oh something I forgot to mention is
you're probably thinking like how do you
like do a query across the database like
this but you can actually just have a
trigger on any change in s3 bucket it
goes to SNF and you can just put that in
red shift and then you would actually
have mozilla database that's mostly up
state of all the data in the system and
you could do your course there for like
analytics purposes and stuff I should
have made a slide too that makes it so
much fun as 155 just in case you're
wondering have you run into any
performance issues with s3 along
rate-limiting because they support like
something something along the lines of
100 requests per second on gets I am NOT
but if that happened I would just be
upset I mean you could use Postgres as a
store you don't I mean and you wouldn't
be hitting it for yet other than that
initial load so it would reduce your
queries per second by huge percentage so
I think that would actually be a very
good strategy as well and what's most
important with global libraries sorry
what was the problem with local library
global allow winners a network partition
you might end up with two processors
with the same name but it's a little
when you try to write a welder the
network part
you don't know that that process already
exists that's the problem that's what I
mean
and so the zookeeper does like a you
know like this crazy paxos thing to try
to ride out of network partition and
make decisions correctly right which is
apparently the hardest thing to your
science or something I don't know
there's evidence behind yeah it's normal
like most most applications don't handle
network partition as well but it's just
normal number questions all right keep
it up one more time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>