<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>High Availability Erlang from the Trenches | Coder Coacher - Coaching Coders</title><meta content="High Availability Erlang from the Trenches - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>High Availability Erlang from the Trenches</b></h2><h5 class="post__date">2012-11-21</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Uszng-mJO8M" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so I was first quite pleased to have
this early slot get this ordeal over
with relax enjoy the rest of the day
that was quite realize you'll be
speaking to stop so micra Williams move
so my name is dominique williams i'm a
reason whistle and we're going to be
talking about some of the things we've
learned from twenty big high
availability systems we're from extreme
Forge actually fought is a team of
experienced software developers we we
design craft maintainence reliable
internet and telecom systems we use
choice when I and for once I didn't have
to explain why we also use extreme
programming which is a set of simple and
effective work practices will these
needs help us to build oh the clothes
trusting relationship with our customers
and our goal is to build instr to
deliver a usable new features each week
with such high quality that support is
free learning developing for 15 years
mostly critical to the system for
telecom company where ways i'm going to
redmond we were different at we give a
lot of development we also we manage
team and bring your instituting
critical systems we also provide
training in down and external program so
over the years some of the systems where
we worked on this a critical hybrid
resistance which shell I've given us
some of the experience we want to share
this morning ah these ones so the
Silesia myriad ussd gateway the ussd is
sliger the telnet of SMS is a text base
telecom interface it with the connected
section into interactive stuff it's like
a technics bases kind of walk and this
system was sold to over 30 m toca
operators around the world and it's some
of them had very had very large user
base is some 20 million users and the
highest capacity systems we were having
a up to 5000 messages per second and
despite having to have monthly upgrades
with new features improvements we could
keep these systems with a lap time of a
flight nine point nine percent we also
worked on the mission architecture of
the week SMS gateway which was a
relented and factory couple of years ago
along with some web pediment before
profit opcom website is inside valentina
lang and recently we went another french
center operator in the call center we re
doing in i like a web service within
critical web service which is in java
first and difficulties with the upgrades
so they experimenting with or nine
it's hot upgrade baymax's so this is the
first thing sir I think you all know
that there is true way to removal ye for
a musical vibrant the the first way is
to use an English diver with an
underscore and then the way is to
graphics a diagram is an underscore this
is it two different thing in this
example if you are the Scott in module
way to hurt to this year but we found
available on the store artisan and later
on understand i sees you in another
button and our career so so much van
coming from this behavior without the
underscore diagur in afghan and we
propose to to help develop propose a
faction the compiler action 12 an
additional warning when the underscore
bible is you
okay so that was just a kind of it to
get started on something simple now
another thing we've we noticed is
there's something which is often
necessary to perform a regular action
especially when I get server is idle and
we've seen many designers to try and
achieve this which are really
complicated and so we realized that
there's a a little night featuring yet
server which sure lots of people don't
know about which is the time out in
handle call and in handle info within
the topple that you return from those
functions they can optionally provide a
timeout and what this time out does is
that the gem server if nothing happens
before the timeout expires then it'll
send you a timeout they have a little oh
so you can do this and have a call or an
apple cast and it's very useful for lots
of different kind of thing so this
example we use the timeout to just to
stop the process this would be used
Waylon server which you want to stop if
it doesn't get used after a while and
just automatically stop it it's useful
for lots of other things like keeping a
connection alive which can save your
time once you get a message if you want
to use the connection and you can use it
to close a shared resource when it's not
being used anymore use it to re-register
their workers and they can register
themselves and if they stop being used
for some reason they saying something
must be wrong I'm going to reregister
myself so like getting some work
again okay so after those just to kind
of little web coding tips we're going to
start talking bit more specifically
about something like a ability stuff so
there's this some thing in there like
about betting it crash now the cross so
name is right loss of powerful features
to allow you to supervise processes when
they crash and to restart them and this
is why the most elegant way to program
in their name is not to write lots of
detailed error handling code and just
instead just write as if the code was
going to work and then you let you crash
and that's fine because there are lots
of ways to get to keep the system
running but in a wider sense if you're
writing a higher bid of each system
there are lots of things that you have
to be very careful about that you don't
want to let crack the vm for example can
crash and although there is a heart neat
system to get it restarted when the vm
crashes most systems will go into pretty
disturbed state the operating system as
well things can go wrong there you can
fill up there when I was disk space or
fios printers so progressive the total
we're going to see some of the things to
me recommend in order to avoid these
kinds of risks so let's go to beer so
they are to me now long it's a legal way
to programming but to you you're no the
hot on java item is not garbage
collected and there is a limit and if
you wish to limit the red BAM crash you
can present and this is a small example
cruncher there in less than one minute
so you see that the add some tables
Maxwell's by the default about medium
you can change that the phone it's still
limited now if you're just writing atoms
my hand in your code that's what you
should be doing that's fine you're very
unlikely to reach that limit so the
danger comes from the atoms that can be
created it helps other ways than just
when you're actually typing them in your
code some of these ways are if you're
using generated code for example with
sn1 compiler or yank generation if
you're reading files with data
configuration data or templates and if
you convert some of the stuff you're
reading into atoms then you have to be
careful if those files can come from us
from increasing number of sources
passing also if you're passing an XML or
passing Jason most libraries generate
atoms from what they pass now that's
okay if you're just using you know a
limited number of XML schemas and things
but if you're writing an XML accelerate
or you're writing a compiled farm
something which is going to keep
accepting or ball and stuff and
generating items from it then at some
point we'll run out of the Bantams so
our recommendation is just not to use
this to Adam there there is another they
introduced after a while and other live
which is list to existing Adam as we
should be using to convert stuff from
the outside files or messages into atoms
which you already have in your code is
our other reason
but don't use this to Adam to invent
answers from the gist without in neutral
okay so on another another topic they
use its importantly another way to crash
the vm is to run out of memory and this
is quite a key you don't get it's not
something you can handle in your code
there's no exception if you catch
there's no way to recover at the end
we'll just keep grabbing memory until it
works out mmm crash so it's important to
avoid this and also if they're just
either before it crashes if you just
keep having lots of processes then the
system will become overloaded and they
lots of other things can start going
wrong because you have increased latency
and various messages and so so hungry
things will start happening so use a
fixed number of processes house in your
design you probably have some importance
you gents servers or gin events or
whatever and then they're you know
they're unique the problem comes from
when you spawn processes to handle high
volumes of stuff like incoming
connections which is for process system
before work in are now so that's where
you have to also be careful and use a
fixed number of processes
now there's a frequently seen program
region or something you seem quite often
is this process that gets ported before
work there's a tendency to reuse them is
might come from the contrary to the
process pool Olympia with thread pulls
the ideas you have a fixed number of
threads and so with early processes you
have a fixed number of processes and you
keep recycling them and reusing them and
giving them Hugh work then things idea
things can start happening and we've
seen a number of those with this now
we've seen systems where over a period
of a couple of months the memory just
kept me going up it looked like a memory
leak and after investigating this we
realized that he wasn't actually a
memory leak is just it mean by reciting
worker processes the garbage collection
was just taking a gun I have not exactly
sure why but it was just using more and
more memory as they kind of remember the
needed memory in the past and it just
kept getting allocating bigger blocks of
memory that we really needed to and this
was sold by just not reusing processes
component of spawning and terminating
processes in la is very cheap so always
for fresh processes and use them once
throw the way using the style you once
threw a job a lot of other things apart
from the memory allocation you can have
unplugged messages link use instant if
the code is using the process dictionary
this
involuted for one job to the next so
forth throw them out and start with the
French process so if you think about
those two previous recommendations and
the one about using a fixed number of
processes the one about a spawning prep
process of all the time this leads to a
design patent that we now use very very
often in high value systems in order to
control the load on the system now which
is to have a q oq jobs and then spawn
fresh-frozen worker processes and they
come and ask the queue for the next job
so it's not exactly like a process pool
it's when you're drunk you and then new
workers to come and ask for jobs that
you need to control the number of those
workers put an upper bound on the number
of workers in you create now the details
of how you implement this apart from
having the Q and a part of keeping track
of how many processes you created will
depend on the requirements for those
worker processes in some systems it's
acceptable for a job to crash and then
just in case you know you've lost your
message we lost a connector then it's
not serious so in that case the simplest
thing is just to use as blame Erlang's
for and even the driver that if that
crashes to men if you need to supervise
those kind of processes because they
might have a session which means to be
care they might have stage which need to
keep or because it's unacceptable for
you know for one
request not to be answered then you
probably need to use simple one for one
supervised some processes and the nice
thing about this design with a job cumin
it fixed number of processors have come
and ask for jobs is that it's very easy
to load that if you need to if you're
using the multi node cluster
now another thing which is a bit
controversial is we it's funny feel you
should avoid records as much as possible
records are candy some people think
they're a nice great program that you'd
like like atoms and they have problems
especially for hot code reloading when
you have different versions of records
in your current those are incompatible
so a lot of care needs to be taken when
you do them are going reloading and you
have a new version of a record now if
you're using gen server then server
provides ways to do this but it is
multiplicative is error prone every time
you operate the code you have to write
specific code to handle the migration
from one way from going on to the next
and so in practice we've seen that if
you get it right sometimes you getting
it wrong other times and so we shall
it's much in general try to use tips or
all niggas or protests which are much
more flexible than compatible you can
add new items of those dictionaries and
the old welsh pistol work so they're
much easier to too hot hot item upgrades
no hourly needs without computers and
pies because it was really difficult to
the upgrade code online but today with
alan is not true anymore and we have to
change a web programming and to put
controversial bite in the car because if
you want to add a find a branding sister
the code and the data should follow the
same national strategy there is only one
solution to achieve this it's good all
the data in your hair own coin it's very
important for funds were they good
okay just to finish off there are lots
of other things which are important for
highly busy which we don't have time to
go into this short talk i will just
mention them quickly the main one
certainty is that really must have very
serious performance load testing
endurance testing and this is a huge
undertaking if you really really want to
hi Billy Billy system you're going to
need a specific platform which is
pre-production representative of the Rio
Grande home alone she perform really
serious stress load testing where you
want to use that platform to test every
upgrade and I guess all right all this
great stuff for hot up raining but every
time you know you're writing but release
up great script your writing let's keep
a migration stuff for an easier or your
writing stuff to upgrade records it is
every time it's it's you upgrade so you
have to test it you have to run load
tests on your original there on the old
version upgraded to make sure our
business is awaiting you have to do that
before you do it in production nothing
we've seen quite often these people may
be you know within the habits that come
from other programming languages using
my prefer to many doing much too much
lobbying especially the debugging in
post up when logging in erlang should
really only be used for when your
customer needs the auditing in traction
history of what's happening system but
for your all your debugging needs as
much better much better stuff in their
language all the tracing facilities
get familiar with those the gvg module
or VTE or observer one more tools now
they're great but you get familiar with
them they're also with great power comes
great responsibility they can be
dangerous but they're very precious
tools if you're maintaining a high
valued assistant and it says you're
overloading your system with endless
debug messages in the box so we talked
about you know one of the limits which
was the atom table grow some other
system limits read the law protection
engineering those think about some of
the operating system things like not
filling up disk space so do a lot
rotation that can be done with some
there are libraries their language help
you do that you can also use stuff like
logrotate of the linux or any way to do
also things to consider and just try to
give you some of the most important best
practices that's it any questions
yeah yeah yeah
there we have until the point so far we
haven't done it lately valium you had
our own our own systems and we write the
release upgrade scripts my hand we
observe what we generally automate all
the special all the testing the testing
of the upgrades are fishing while
special using me but it can be done with
with real arms well we have any idea
about the performance given if you stop
losing records or state and local to
prom places or digits no not really I
mean I don't have any idea but I think
members behind feeling about that is
that the like most of these things it
doesn't usually doesn't matter because
of the performance I kind of things the
difference is going to be very small if
you do have some performance problem
like my whole like this is just usual
recommendation you should really
measuring that providing it's finding
where your real problems up if they
happen to be in the thickness and that
might be the reason to go back to
records then in title percent of the
curve that's not really the case there
is one inconvenience which is a dick
records can be nice in some cases that
do simplify their own especially when
you're using the best matching one cific
items or very cool so there is a kind of
a potential fit you can actually learn
different ways of programming which just
as elegant sir using records is still
okay if their privates to a module that
the not included viral volumes
and also as preferably pure functions
that's my problem end of Part great
upload everything's in a jet service
state or yeah well at citizen of the
u.s. sdd 74 years didn't build releases
at all we actually often just so just
patched assessing complain module and
latter that was fine the problem is with
we one of the props people we would run
into it was exactly what we described
about configuration data we had lots of
xml files that really had an impact on
the behavior of the system because those
were like hard as I handle between you
so we moved to me dis start using leases
I'll be while and you cuz there's a lot
you can do without using racism at its
ok it's just that we're kind of working
without the safety net nice things of
our releases is roll back and come back
to the previous version and that works
cleaning releases oh you know there are
complicated it's harder work that do
have some advantages for years we need a
lot without
wake up
yeah that's right at the very facility
is to do it just like new facilities to
migration and use your steamer it's just
that every if every time you do an
upgrade you have sinned careful about
getting it right then you know where we
will show years of working with a hybrid
system there are good in times when you
get it wrong and that's going to bring
your percentage of time down we don't
use any particular tools we really is
it's just a whole other project of Anna
code that we write it's that the ussd
server in particular was complicated
because it was connected to about 10 or
15 external systems so we have time when
simulators for all of those so it's
really opening up today we did nearly
any particular tools for that's what I
line is easy to those for clients for
the simulators so we really just broke
what's important is the most complicated
thing is really having an actual
platform to do it the hard way to enter
that's right out of the code does all
the simulation and testing and measuring
are really different particular schools
how do you recall Peter
yeah we have this we have twins with
that Lee University with sea systems so
the main recommendation for high-value
assistance is not too light linkedin
riders on each time until to start by
writing a monthly wonderful astir they
yeah Paul to start out writing abroad
and then once the port has been working
for couple years and you're pretty sure
it's it's it's solid that maybe if you
really need the performance improvement
that can be converted into a religious
one linked to drivers just increase the
risk of the crash okay thanks
I</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>