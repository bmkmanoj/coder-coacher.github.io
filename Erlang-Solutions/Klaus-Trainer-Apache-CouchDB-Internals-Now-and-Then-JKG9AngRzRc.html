<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Klaus Trainer - Apache CouchDB Internals, Now and Then | Coder Coacher - Coaching Coders</title><meta content="Klaus Trainer - Apache CouchDB Internals, Now and Then - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Klaus Trainer - Apache CouchDB Internals, Now and Then</b></h2><h5 class="post__date">2014-01-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/JKG9AngRzRc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">I thought
about the very
details or like
Johnson Works in Kashi be but then I
decided to do it on a bit more higher
level like covering internist but more
like these like different internals play
together so but if you still have like
specific questions on some specific
technical details for example out a few
engine very six likely i know a bit
about that and just ask me so well last
year there were some questions by some
people like but I cos review with that
would be that so great use from my
community like the number of commands
has been increasing this year and
especially what's more way more
important like the number of
contributors it's grew quite a lot
recently and here the summary it it
looks pretty intriguing so we got like
fifty percent increase in new
contributors during the last year and
this year basically and yeah the
committed activity has been increasing
as well obviously
there's also they also has been a great
confusion mostly last year or like like
last year and the year before like it
was first of a scholarship e then never
say company oh I'm sorry can see it that
good can you see it actually okay so
first they were scarcely be and then the
original creators of kashi be they found
it a start-up they get some money and
the fundage couch are you and then it
was re-named like not only one time but
at least twice couch one then couchbase
like after those had a merciful man base
and so they release different products
for example couchbase single server
couchbase server and then touch to be a
couch peace light big couch pause yeah
and then like their other like projects
like big house from different company
also a couch TP startup so okay let me
briefly explain like different or
products like couch i owe a couch one
couchbase these are I've been like
basically the same company just
couchbase has been like a merge between
couch one and my base so these are
companies and they did like couchbase
single server which was basically couch
TPA just a bundle together and couchbase
server is now the product of the main
product they selling and it's bad
unfortunate because it's got the name
card in it and then there's CouchDB and
now there's two different things that
have previously been almost like the
same just bit like different packaging
they now becoming quite different and i
will also talk about this in a bed
okay and then this like has to be a
cash-based light as now also basically
the same like the rebranding touch DB as
couchbase light okay i don't think i
don't know if that's a good idea but the
the product is is quite nice because
it's a version of kashi be that that's
running in smartphones and iOS and
Android and which can replicate with
Apache couchdb which is nice then
there's a big heart which is being
created by Cloudant which is another
couchdb startup and they do like Amazon
dynamic version of kashi be so that the
point is you can scale it was big couch
you got sharding replicate and like
clustering features and and yeah you can
have it to it do this by your own by
using the couch or you can just use the
service like the creators of big house
cloud and are offering a kashi be
hosting service and they will do the
scaling for you and then which is kind
of like it's being worked on it for
quite a while but it's good a lot a lot
more traction recently and it's getting
to a nest just stayed where it gets
really usable its pouch DB it same
platoon of couchdb like i will talk
about like implementation of college to
be like what this actually means in a
bit so partially BSA implementation
javascript else it runs in the browser
so you can have like hell she be in your
browser and and create a web application
that talks to the database but the
database is just in the browser so you
don't have basically you have like me
the users won't feel a light latency
because the requests will go local and
then you can do
replication in the background are
synchronously and this can increase user
experience tremendously of course and
then you can run portugee on the server
which is also kind of interesting like
you run in an OTS and it's good to have
different applications of the same thing
if you think of it in terms of a
protocol because it can test these
different implementations against each
other and then like it will increase
quality of course because you will find
you will much more likely find a small
boxing misuse okay so just about the
major difference between couchbase
server and couchdb i I'm just doing this
to clarify because there's so there's
been so much confusion and its really
heard the Apache couchdb project that's
why I'm doing that I'm hope I hope I
don't bore you too much with that but
just just that like yeah it's only got a
partial HTTP rest api own just for like
stats and fuse and noah peer-to-peer
replication now change his feet which is
like a feed of the current updates and
which you also can use for replication
and it's now like it's open so I soft
very bad that I it's got no like it
doesn't you can't it's not free software
okay so i would talk a bit about how
should be philosophy because this will
also like satellite of like make it more
clear how will explain how why things
are the way they are so there's this
famous quote is kinda old but it's like
still very valid triangle might be
before for the web but Kotzebue is built
off the map I've never seen software
that's
completely embraces the philosophies
behind HTTP cache DB makes Django look
at school in the same that angle makes a
SP look out I did and this I should have
noted that the squad is by Jacob couple
mass and he's one of the creators of
jungle actually so this guy says but
like it makes coffee be made such a look
old school so here here are the core
ideas so this is where car CB is kind of
different to other databases link like
it makes it pretty unique and sandstone
stand out from from others there are
also like other databases for example
restful HTTP API but not combined for
example incremental replication that's
one of the most interesting features at
least me and a thing also to lots of
other people like this peer-to-peer
replication oky a restful HTTP IP i'm i
mean at cash payday at car space they
made the decision to implement to dish
like the HTTP API and implement the
memcache the protocol instead like it's
more efficient and I mean why do we talk
HTTP when we could use more efficient
protocols HTTP is scalable and that's
composable it's been here for quite some
while and there's lots of existing
infrastructure and I mean if you want to
optimize that you really have to know
what you're doing you have to have
numbers and to compare you have to
measure and you also have to at least
partially have infrastructure for this
kind of things like you have to solve
naming problems name resolution you want
to have some caching because then
without it your performance or won't be
the good year probably want to like
some security and when you're using
veneer tears as a cpu got lots of
different components and connectors for
that like rest connectors like you get
components like our origin server
gateway for example engineer's proxy
server is a chance are you all kinds of
process you got client library several
libraries you got caches like for
example varnish you get resolve alike
bind like dns resolver and you got tall
like totals like for example if you want
to forward your HTTP connection through
a socks proxy it's not big of a deal you
can just do it because there's software
for that and if you do your own
optimized binary or like version of pro
you'll call you that might be point
where uses way you would are going to
want like some something like that like
some component that's already there for
a CP but you have to implement it
yourself so yeah you better know what
you're doing okay eventual consistency
it works they say I like I the squad
have found years ago and unfortunately
the link i got the link but the website
a stone unfortunately so i can say who
did squat but I kind of like it like
it's just an in comparison or analogy d
like he describes teen eight he says dns
was the first note no sequel multi
mastered poor replication distributed
document database that was created over
20 years ago and it works like it's it
has proved itself so at least for some
use cases this eventual consistency
thing is kind of sensible and I
boobs okay so what's so great about
Costa verification the nice thing is
that you get more more enjoyable
implementations that do different
trade-offs between with regard to
portability performance memory footprint
and those are basically implementing the
same protocol also this product kyle is
kind of like only defined basically
there's this rough documentation for
idat can use it but the actual
definition is in the reference
implementation of apache couchdb and
this should be improved and there's
their efforts on a way to do that like
writing something RC like for like an
rce or that i described the couch TV
replication protocol to have something
like that would be totally awesome
because then it might encourage to like
more people to write comfortable
implementations so here like the
different like yes I'm different like
comfortable car CP implementations touch
to be partially be baked out and our
couch it doesn't I mean it's basically
couchdb but it's been a big refactoring
by mainly done by Ben watch the snow and
he's a party core committer and what
he's done is a very interesting who a
few knows a bit about ella ella no TP so
the point is that one of problems we
have encouraged to be that makes it more
difficult to make it more like pluggable
and modular is that coffee is not and
many places is not as OTP edges as it
could be like OTPs
set of basically design patterns and if
you write any along program you should
use a ot p and which OTP allows you to
split up your software in different
applications that are like standalone in
you can create releases and standalone
really releases that allow you to bundle
you different applications with some
certain configuration together even like
a airline runtime included and you can
so the there are many advantages of
doing an L an application the LTP way so
they're like Francesca for example is
make maybe you should hear hear talk
about like he I'm talking about that
like if you if you haven't been so far
like he can explain to them like what it
HP is and what are what the advances of
it he can explain that in a very good
way and if you're into a Ellen should
okay so there was this in famous quote
or like there's a out in every couch or
TB implementation okay that's all we're
here that right now oh CouchDB is
becoming the couch or vice versa so the
current state of integrations that they
did all this IP intellectual property I
don't like this term with clearance
thing so it was basically some
bureaucratic SEOs Apache couchdb sa
obviously a project of the Apache
foundation and so they manage to do all
this formal stuff and then and that
means but now they have bought
Picard into the Apache cos to be a
repository it's in the Browns and they
like a few kilometers have done I've
even done some efforts to just to merge
that like they they started efforts and
most test cases are running through so
it looks pretty good but there's some
details um yeah for example there are
some problems and limitations for
example and how she be as most features
car CBS are are no big don't make it
hard to scale couchdb but there are some
tiny things like that are make it bit
difficult but it's only a few points and
it can be solved obviously they have
done that with big college but there has
to be a new major release because the
API will definitely change it well it
won't change it probably won't change
like usually but it will change so that
backwards compatibility will be broken
and so for example sequence numbers
imply a total ordering of events and oh
listen to like whoever everybody has
been into distributed systems knows that
total ordering that's kind of you
actually you don't want to have that
because that would mean that you have to
synchronize clocks and this this becomes
very different if you could for example
ikea does something like factor clocks
in order to have like a logical ordering
instead which means you don't have like
one central clock
that determines the order of events so
you can make your system more d central
and not that centralized which would
mean like centralized symbol of course
mean like less reliability so in vikash
they replaced this entire sequence
numbers just with strings and basically
most of the in still work there for
example a small detail of you using
attachments and you can look how
currently not like if you retrieve a
document in CouchDB you get an a stub
for attachments and that will say bitch
reversion this attachment has been
created and there it's like you daddy in
a sequence number which is the integer
and they could you could use it for
example to see like to look how long ago
like how many revisions have been
between the time when the attachment has
been created and now which is I don't
have any use case for that but there
might be people using that so it
definitely and also it's a like change
type for my internship now it's a string
so let's be a break backwards
compatibility but it's now a huge issue
so you don't have it doesn't have to be
that way and I think most people just
don't know why it has been like that in
the first place probably because it was
it seemed to be like the easiest then
there are also some features kalobios
where it breaks rest constraints one
rest constraint is for example
statelessness and statelessness mix like
enables caching mix enables you to scale
your system
and if you're using cookie
authentication because of the way how
the cookie is computed it means like a
means or implies that you have some
state and in the car CB instance that
created this cookie which means yeah so
this is state fall and you would have
either like get rid of this day fulness
oral you would have to synchronize the
state between your cluster nodes and I
don't know if there is going to be
something like I don't think they will
change the way our cookies or maybe the
goal but it might have some security
implications so and I don't think you
want to do like synchronizing like
sessions you could do it but more much
more simple solutions to just use a and
ossification and method that's not
stateful for example you could use just
basic authentication a few and encrypt
over at least you can do it for you on
like non browser clients and if you talk
about over a year TLS encrypted
connection this should be fine or you
could use some orbit whatever this is
just one issue you might run when
clustering multiple instances okay car
CBS get a pre pluggable architecture
it's like there's some a lot of things
where this can be and should be improved
but it's already like you can write a
like your own replicator and people have
started to doing that like
one guy from Berlin his name is Johannes
you just created a javascript
implementation of only a replicator so
he created as a replicator code is the
implementations called Roy it's just a
retina note yes and we'll just do like I
can just trigger replication and
management location between different
CouchDB instances and it doesn't matter
where these couchdb instances are
instances are as long as the replicator
can talk to them so this kind of nice
and you of course you can like for
example you could create a replicator
that just pulls out attachments and
stores them on local file system and
then I knew like if you happen to FA for
example and engine aches a web server
like a reverse proxy some for CouchDB it
could create a rewrite rule that that
will make your requests at local like
the recurs to attach attachments I hit
your local file system instead of kashi
be and then you which will allow you to
get load of your database if that's a
problem for you if you get like less
flow do for example you could also just
use it to upload large files to some CDN
or whatever and or some back up there
the might there some like use cases for
that and it just depends on like
sometimes this might be really useful
you could just write a small replicator
for your mobile calcd implementation and
which has a like less features but you
still want to replicate the data and so
you don't need to have you probably
don't need to have the full akashi bapi
in you
mobile phone implementation of couchdb
however it is called like but you won a
prop you might want to replicate data
with some other cop CBN Stinson you can
do some filtering and whatever it's nice
what's also nice that he can create your
own custom indexing service and their
say one nice example of this is teo
coach and but it's created by mainly by
bonchon guy who works for couchbase and
it's like two coaches like a plugin for
couch B which works for couchbase as
well as for CouchDB and what they say is
that well to coach will always work for
both implementations and the thing is
the nice thing is that to coach was like
a plugged in right from the beginning so
they could just hang it on like this
there's a nice config like configuration
for cars to be I will show it to you a
moment so if you go to the admin console
you get lots of different handlers for
example this is the Putin like admin
interface and a few it's under
underscore you to slash HTML file and I
will show you how it works so you have
some HTTP global handlers so under
school when when you pass starts with a
slash underscore it means an cos to be
mean it means that it's some like
special handler some internal handler
for example you can have a lock handler
which also has a REST API but which also
does does like likes you likes to the
file system or whatever and notice for
example it's like culture the
configuration works like this you get a
module along module you got a function
and then you get an argument so let's
see how where this is I got the Apache
Kashi be a source tree I'm in the source
directory and here we see um can you see
that actually okay so you see it's
already split up a bit this will become
a more modular but yeah this were on
this you can find us in the couch she be
a directory and it's like the module
name was cow H tpms handlers and if if
you open it and and search for handle
Utah's dear request
you see here the function where this
requests going to be handled so it's
just like a like a handler this function
and that's it's got a ring it always
gets a request and some argument and the
argument is the document root in this
case and if you look for the argument if
you look or what's there as like lots of
HTML assets and like scripts and it's
basically the interface and you can even
use it for yourself to create your own
so there's also not only like this
global handlers there's also like okay
yeah there are all kinds of different
handlers for example design handlers or
let's do like some special on which have
some special functionality specific to a
certain database for example you want to
come compact a database and you get a
compactor like this could be really a
whole like its own a line application so
depending on you what do you need and
like you could have a compactor that you
trigger manually or like by some cron
job or you could write you or they
easier to use compactor that come back
to your database automatically and all
that for example you can configure so it
will only compact the database when you
don't have so much load for example
during late at night this will run and
so you can like this is already what you
can do you can replace all these default
implementations in Kashi be you by your
own service I mean you have to know some
Ellen
but in some cases it doesn't even have
has to be Allen for example the fiercer
the fears of a protocol of works over
standard input/output so the default few
server is a JavaScript server currently
or via spider monkey it might be no
chance sometime there are various
reasons why we want to get rid of spider
monkey and have only a runtime
dependency of no chess instead or v8 but
probably it's going to be no chest
because many people have no tears
installed and you it's easier to get
that installed properly and test that
okay so for example what you can do is
write your own few server or in Haskell
for example and somebody even done that
and that has owned their own indexer
which I guess it was it was some physics
stuff I I don't even remember what it
was but it was very interesting in there
you really had a use case so he had
really had some reason to do that in SQL
because I think of because of some
libraries they had and sadie is a very
protocol it's pretty simple that's even
documented at least you got tests and
some raw documentation so if you want to
implement but a it shouldn't be too hard
to do that okay some short demo I've got
like this picture sharing service and
the investor asked me to do like a live
stream of all gifts but they just want
to have like animated gifts in the live
stream I know the sound and the strange
example but
it tells me to like I would just use it
to show on how it works oh how you can
extend a kashi be by yourself so it
should look something like this year in
esli you should have like five or like a
small number of items and your stream
and it should automatically update if
you upload some gift for example I
create a new document save that and now
I upload some some gift for example
there are enough cats now I want to have
a duck and so here it is and it's
basically what I've done is a very
simple like static application vanilla
tea yes it's like 68 lines only and it
uses eventsource protocols out the
server would push it automatically on
the updates to the client at the browser
and it uses the changes feed feature and
as a filter so here's a very costly be
becomes powerful should make this bigger
you get this changes feed where we can
listen to life updates and then he can
filter that and he already have a few
for example i feel that gets you all
gifts all attachments letter gifts but
the result would look like something
like that this is he a few as a key i
used like a timestamp converted to an
integer susto in order so you're able to
sort by it and value is just the name of
the gif and you can like construct the
path by the ID / value
anyway you already get that and you now
you can combine the sphere with the
changes filter I need to say like filter
is underscore few so you say like as a
few you don't use a existing fit car CB
filter function but I I an existing few
and industry me when I include documents
because you want to look at the
attachments like descending chose out
you will only get the most recent five
phones so this is the initial request
this will be time and I get a handler
function here which is called duck
handler and it will handle like the
updates and after this the events or
stream will be initial do you know all
about service side events service and
events you can source so what it does
basically it's a simple text based
protocol very and service can poor dumb
events updates to the client browsers
and browsers will always just keep a
socket open and listen this events and
if there is a listener like if you have
registered a listener for example a load
listener you can do something like that
and you don't have to Paul so let's say
a push like it's like that suck as much
way more simple because it's just say
it's just a very simple text protocol
and it's it's easier to implement with
existing libraries that circuits are
kind of more low-level and therefore
they are harder to implement not only
like in process and browse they're
already pretty big hitters but on server
side it's kind of harder to implement
any way this could be a map circuit
basically spell however I could she be
still doesn't have flap circuits but
it's going to
at some point in the future okay so this
is my energy source stream function and
I just wanna have the most recent
updates like I get the last sequence
number from the previous in a group
request why i neutralized the stream and
so the stream kind of look like that but
it's just with the difference that it
will be like real-time here we say like
a feed type like the fetus event source
it could be for example like continuous
then it will be justly chunked like
streaming a simple HTTP requests that
just streams and however like it's kind
of hard to do that in I to parse listen
I 86 currently but there's for example
as a long holding that supported when
polling or salsa called comment so like
a browser a dick client always waits for
the response and the the server will
just send a response when there's update
and then declined to say another request
and so and so after each update the
client has to do a new request which is
kinda inefficient we don't have that
with event source so that's more
efficient so how does so now a test case
i will upload a gift that's not animated
and see what's happening
I've got the static cap oops I've called
it static at cat so that everybody so
it's the file ends with gif so here is
he in mime type kashti be automatically
detects in line type and it got it here
and a few results so it should be in the
filter but here I've to I've done some
something II like where I sorry very i
extended couchdb by adding IE handler so
this handler is just say dtt CIA handler
which is a acronym for does the skiff
contain an animation and it's just a
small web service that just runs locally
here on my host and which I've
configured here and which way got all
requests that go to this domain and if
you append like here some name like your
I'll encoded name of a gift
so after you your i encoded oh I guess
I just wanted to do it manually but I'm
failing for some reason so the
documentation is basically like this
that's running on some domain and Kashi
be will forward the request and the
script will we'll check it against the
database and and just tell whether it's
animated or not so here we get a
response handler within like flag
contains animation and if it's contains
an animation would appear in the stream
and if not then it won't be displayed
which is exactly the thing we wanted to
achieve now to just test it again like
ever upload another gift
and it really merely appear here in the
stream so I mean this is probably not
the most useful example to you but the
idea and the concept it's kind of neat
because you can just use it as a reverse
proxy endless service like this proxy
handler are you register here so you can
do all that during run time and it will
automatically cut that you don't have to
restart couchdb for example for doing
that and you can do that by your rest
api so you can change configurations
during runtime your class for example
and and do like change your
infrastructure without having any
downtime for example and this could be
for example i've created a which is
probably a bit more useful like another
service which does a handle salsa or
like request for attachments but for
images and then it was kale images
vanets cuts like a size as your IP I
repeat just like this in the haight and
like you say like here's my attachment
and here's like dig this entice I want
to have and then it will scale like it
first of all look if it's already scared
like if the attachment is already
available in a version with exactly this
geometry and if it's if that's the case
it will serve it and if that's not it
will just scale it immediately and then
cash it or you could do like a IES email
double and sign up service or whatever
and and the nice thing is you don't have
to care about or you don't have to
expose like another port so this service
will only run locally and which also has
like nice implications regarding
security because you don't have to like
the the surface the like what do you
expose the service of like it was very
smaller and
and you can have many lots of these
services for example you can also create
just a HTTP proxy and loaded forward so
the request to some other like HT API
for example twat Leo or Google like the
the example from the documentation of
its google so you can create a google
handler which will like you say CouchDB
blah blah blah and like underscore
google / and then the search term and
then a you know like the search result
will come like appears it comes from
kashi be and yeah so this is how like
cash bees um like it makes makes it easy
for you to create like service-oriented
architecture like icarus orchestrate
different services for example yeah you
could call like orchestrate a yellow
from Kashi be over when you do some
funny like some certain things and any
questions</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>