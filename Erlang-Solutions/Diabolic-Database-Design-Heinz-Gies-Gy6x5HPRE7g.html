<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Diabolic Database Design - Heinz Gies | Coder Coacher - Coaching Coders</title><meta content="Diabolic Database Design - Heinz Gies - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Diabolic Database Design - Heinz Gies</b></h2><h5 class="post__date">2015-12-10</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Gy6x5HPRE7g" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello everyone I'm going to talk about a
database today namely to meditate of
this cold dammit enemy and I'm doing a
lot of stuff different implement in LED
Robert like it may be here and so I'm
till now so first up queer mine that's a
good question if you find out tell me
other than i'm writing a club of a
stretchy software called Project 50
which manages smaller scales I have to
public loves running it by now and Mpho
private clubs and I'm a big fan of solid
technology like early and illumise so
that is where my stuff is bill that's
where i built on so i'm standing on the
shoulders of giants and please by all
means do not take everything i'm going
to say today too serious i'm going to
employ a time-honored tradition of humor
and I'm not taking myself seriously so
she not neither should you and also
everything I say is my opinion not
people to the truce while it would be
very handy of my opinion working the
ultimate truth you might be of a
different opinion of course you would be
wrong so what why would I build another
negative sound like five million of them
around and so the lead main problem is
that i'm looking at a very different
scale I love monitoring and application
I'm monitoring the whole club which
means the biggest culprit now runs the
three data centers there are a lot of
computers involved there are a lot of
machines involved and ideally when you
run that big of a system you want to
have a general idea of what's going on
in each movie part and it's a very nice
thing next service to your customers i
call provided if you can give them an
insight in their machines smarter s or
illumise general makes this very nice
there's a tool called
stat which gives you literally tens of
health of magnets on each machine and
what you don't want the money to all but
there are a few dozens which are really
nice to have and you can collect them
they are very cheap to get Bucky me to
store them and process it so I tried
Cassandra I tried graphite I tribe in
flux TB let's talk about that part em
and they all had their problems now then
really fit the whole thing of what I
wanted what I need so what do we build
we really want to have like an operation
and scale like react rick is wonderful
to add a note remove the note the
operations part of real is simply
amazing i have never used any database
that's at good at this part is reactive
on the other hand greg has some really
amazing and ears because they do they
don't do stupid they do very basic
stuff and they do it well they
understand what metrics are but
operating graphite is a bit of a pain
and so bit of reactor on a bit of
graphite and wells want to keep it
simple we don't want to fit database
that does it all because usually that
blows up in your face because it does
not be really well just as little of
everything and it gets complicated and
oh my god you have a lot of trouble and
you want the data to be there kind of
lightly so when you query a metric you
don't want to know what your servant did
15 years ago but kind of sucks i mean
it's like yeah oh yeah it's problem yes
we are the support and can we call me
back in 15 minutes because of a matter
anime still needs to load the lens
doesn't work you wanted in a second that
Rob's right perhaps it is two seconds
walls you can deal with that but that's
what we want them the last thing and now
i'm going off on a rant you want to be
open about date of us
and okay there's this great blog series
by Kyle about at called Jackson which
analyzes all the database and how they
move data and I but they are all worried
about it and I found out why because I
when I start tomatina to be I was very
open and the web page reads this will
probably lose some of your data because
it will and everyone go like oh my god
and hey let's be honest whose things in
metric database candles data okay oh
that little snot people in the room who
disagrees no one a one person okay you
have to tell me why eventually but and
we send us only one who's indifferent
about it okay you don't have to deal
with operations right that makes sense
and so the truth is nearly every
database has some edge conditions
whereas will this data and then we go a
step further and losing data is a bit
like a pregnancy you can't not lose in
the data either you lose they know you
don't so if you play not to lose day to
get to go through your entire sick you
can't just say okay my database does it
lose data that still means all of your s
can lose they behead them if you don't
run a DC file system uses data if you're
on vacation does not catch any possible
corner kids you lose data if your front
end doesn't retry use data right so blue
today is it sucks but it's part of life
so let's just be all hard and decide Oh
windows data hey it's okay and if you go
into that mindset you can do some
amazing stuff which gets you really
really go through though so
let's first talk about what symmetric
and because there's memek I guarantee in
this room are about 80 people and I'm
very show me about 90 definitions of
metrics in here and so for the sake of
this talk we will stick with this
definition because that's what a metric
means to me and we established i'm
always right so their measurements and
they happen on a pivot periodic and
times them so we have t0 and t1 2 and so
on and they always have the same type
your data doesn't randomly change
between the number industry it's not
like your CPU goes really well I'm on I
love now we're not going to have
represent anymore now it will stay a
hundred percent bahay whatever it was in
the beginning it is not an event there's
a very big difference between metric and
the bed if you're talking about the best
please just forget it they're talking of
metrics today and the next thing and
it's usually do just abacus at least if
we have a high enough resolution back if
you look at any of those dashboards
you're using for your metrics nearly
every curry has something like p99 or
average or max or min in it you really
look at the raw data so the last part is
they're mostly stable your your CPU will
vary but most of the time it has a yes
pedantic question when you say periodic
do you really mean periodic or you just
mean but give my mother native speaker I
need the right thing
constant time interval between different
things there is the unit in metric you
measure every second or every 10 seconds
for every unit in theory otic okay that
mean he really blended three so I
believe this in here and I don't have to
change it thank you and i don't mean the
other thing whatever that is so in the
metric is mostly stable so the europe
memory usage yes at the very spot
usually over a minute the variance is
not that big I mean there are spikes
occasionally and changes but through
over the big scale of things is pleased
day so I want to okay have anyone here
heard of dommatina DB okay you're
excluded from the next question so we
have said we have five cells with a good
eye on through but they have 60
gigabytes of memory aid cpu course a
turbine of disk run on ZFS without
compression the applications built on
react or we have an army values of one
we are sending metrics every second and
with any more metrics that the system
can handle and we have five notes with
the ring size of 64 I would rather like
general guess here how many metrics do
you take a system like that cameos every
site so do we have any pets oh come on
make it interesting 5e none well about
zero yes I hope actually did that so you
won but let's talk about the pilot
project from God and not all the fingers
like them so we have a million we have
1010 and it's not typed in by pigeons
right it's going over TCP so anyone else
want to wager billion in billion 50k
50,000 okay I actually have a few USB
sticks left and i will give two USB
stick to the person was closest see
there yesterday I put in a coke bottle
from the back okay no one likes code
okay so we're not going to be a thousand
we have 50 thousand five hundred
thousands somewhere there and we have up
I don't know if sorry and you remember
your bet you don't change it afterwards
we don't have a good memory which is a
lie so let's see how in real core
usually something like this works so you
have the TCP end point where it starts
and metric arrives it goes to either
spawns on your process for right or
takes the XM from the super wet at from
a pool then this worker gets all the
data a test for the current rig and
react that goes back to the worker that
goes to the vineyard proxy that goes to
the beam out that goes to the worker and
then goes the pyro reply finally to the
TC p.m. point so we have happening this
happening a million times second we have
been happening a hundred thousand times
a second we have heaven 10 times a
second and we had happening is I think
50,000 times a second and that's a lot
so but we can do something about that if
not now people will hate me because we
don't do
you're anything and use process we get
rid of as many of them as we can and so
this is where I fear violence so we send
the data to the be your proxy second and
I don't want to rewrite react or because
it's really huge and really amazing I
just want to like abuse it a bit and so
we sent directly from the TCP to the
minohd proxima don't start I fsm we
don't let all the goodies of it but we
don't care and we wouldn't connect your
back pressure on that because we don't
like centralize it on one supervisor
spawning all the processes of one pool
distributed have it all in this one
connection we remove the bottleneck of
the pool or the supervisor which is
really nice and it gets slow if you
spawn a few million process as a second
right that happens over over again and
it starts to be problematic and we don't
spawn you process the TCP connections
long limit so we have all in one process
known processes everywhere so the next
thing is we are going to cash the ring
so Rhea has the ring which is like how
the data is distributed and on which
notice which and instead of asking for
every metric hey what's a ring oh great
let's use it hey muscle ring okay we
just ask it once every second or once
every few seconds so that saves a lot of
time so we have now killed by three
message stands and at least two
processes which is which is a good win
and and yes the ring changes eventually
but we open up they don't so we don't
care right yes if the ring changes and
for that second things are different you
lose your data
and this up it's cool it works it's
a very small time frame it's not like
this ring is cached for all eternity
it's a second it was a second of data so
what most people measure in 10 second
increments anyway so we still have nine
times what they better them and also
remove the Rings job as a bottle because
it was so I guess I'll give me the ring
yeah 3 below and so all of this we can
combine into one and here it's called
back of dictionary because all the
status quo stored in packets in react
and it catches the ring and there's a
dictionary and it also groups the
messages / veena so instead of sending
since we're already casting and we are
always ready open about losing some data
changes we can just go and collect a
second of data per TCP connection put it
all together and now instead of sending
a message per metric of that arrives
which would be a million or ten or a
hundred thousand or 50 0 and we only
send as many messages as we RV notes
every socket which is the model s at
least a million yes or 10 or higher
dollar fifty thousand s which is a
decent thing so we went from this
horrible looking complex ping pong to
very simple one so ever chicity
prevention which asked for every now
then and since big log data to the binos
it'll be no proxy to be note and then
cats answer back that's wonderful so
this is a huge improvement so no I'm
telling you how we can losing more data
we catch everything I who thinks cashed
our area
they're not they're horrible and but we
don't care and I mean you don't catch
the results you don't have a problem of
cash validity because you cash for right
now for it so everything is to go
through the process anyway so it
serialize there is no problems with cash
religion casual always bound because you
don't have concurrent access to the cash
you don't have the cash in the
background changing because in other
works and so we catch on the Vino level
we use a mutable memory oh yeah there we
go there is a mutable man we think about
we are just writing somewhere in memory
without creating something you without
the wonderful and beautiful stuff so we
get over right stuff that can happen and
but we get away with the requirement of
total or we don't need to say that
metric for t0 arrives before the method
for t1 they can swap it works the
governor mutant we kept we don't need to
write in water if you write in the cache
and one of the catcher's fall we just
flush no more cash and with full it's
justified that it wants to right behind
the end of the cash so we flush the
cache and rigor if the data pint is
before the cash you just write it
directly because it doesn't have no
usually time progresses forward unless
use a time machine which case that
materiality might not be for you but
please can see and so am I said there
are some bagels with cash again we come
and say yeah we made over in something
that happens and that's okay we
lose a second or two again who looks at
every second in their metrics no I'm
like and but no you're done and you'll
get the equity the 10
one minute angle of the one hour and the
only really happens after he starts so
the time from where that can happen is
really small hey I want to be open or
losing data there's follow Jamaica and
it has some memory consumption so that
is a slight problem with a cash with a
memory cache so it grows it doesn't grow
unbounded gross based on the number of
methods yet because you're one cache per
metric but it grows and last part is
when no crashes your cash is lost that
is kind of bad but now those day that's
a lot and see what you can get away was
when you say to those day that's amazing
isn't it like oh oh it will say that's a
lot oh you'll say that sucks to be you
know the truth is the other systems due
to if use graphite they do then use a
cash I just don't tell you if it makes
you feel better I have to be like won't
you lose data use a place no letter was
ever and so that's a bit of a problem
but you can loosen that up there and
actually you can lose depending on your
cache size a minute or two of theta not
great but if you have an N value of two
it's unlikely so it's going through some
a key parts of the Earl Indian so this
is how is your mattress 65 bit of data i
see i see the i hearing oh what's this
guy doing here like what was 65 it looks
much better right 64 it's a line 164
binary it's a bind it's nice you know
what's going on right yes you know
what's going on because no no no no no
no no no you don't want to do you don't
want to use 64 bytes 64 bytes are evil
64 bytes are wait for it a big end
stop mention a magnetic in charge
anymore you're on a 64-bit system in
early we'll treat this as a bit integer
which is really slow compared to normal
energy because suddenly you have to
carry about in terms of any size and not
just one register on the CPU so you can
use up to 60 bytes but I'm kind of I
like the bite alignment I'm not sure
actually it's a difference by the
lineman but I feel just much better
knowing it's by the way so this is like
optimization for a program Thank You 60
this actually is about ten to fifty
percent performance increase sounds
crazy but it's true next we take the
cash mpio and split it apart so instead
of blocking the whole vino when you do I
hope because they own sake slow behavior
we don't want to do I oh that's why we
go caching and you just put it in our
own process you don't spawn the stepping
out there but it doesn't keep it running
as an i/o process and send the data
which ends up really horrible if you do
it I synchronously so I learned and
because the moment where stuff that will
come in order at all because well let's
say a queuing system got filled and then
the q decided to deliver out of order
and everything is horrible and I spend a
weekend trying to figure out what the
hell is going on you have an unbounded
if you and it takes a lot of memory when
you want you more I or than assistant k
so we just do 20 messages as I fell
asleep one synchronously check how many
are there if you go over 22 starts in
kronos you create that treasure
everything is well works doesn't lose
data for once that's a lonely part of a
system that doesn't those data better
then I will admit at us and we only a
synchronous calls we don't do the cold
chain we free up the V note as much as
possible because there
getting all the cash Kaiba it's a lot so
we just stand around it and use the gems
to ever reply works next I'm going off
on a rant about storage data because
this is how your metrics there's a lot
of is you can read the numbers it's
great so the number in there represents
love the value of the tag right so they
come in and that's your metrics and you
have nine metrics in here and so they've
how would I saw my metrics and you go
like oh well it's called the time tree
serious and and you put in a tree and
that's what's reasonable who thinks that
looks reasonable do you know that the
button to people you're wrong well as
it's wrong and he is wrong you're wrong
too and because to get every heard of
time tree databases yeah so you not just
our networks in a dream and I'm actually
going to say I'm right here like about
everything else but I'm all right here
because it for a time series or a metric
you know your data is sequential you
know that one two three four you know
that the excess Patrick is sequential
you know that the read fatalistic
sequential so let's imagine we had a
data structure which is good for
sequential reads and writes I mean
that's something I that exists grabs
very fancy stuff someone has idea what
we can use all right an array all right
there they write if I cuz yes it is an
array if you start in order on the disk
it's getting stupid simple to read and
write I mean you literally just him to
reach other pipes and it turns out just
a good everything chunks of ice much
better than jumping around and build me
a drink and Kunis not bad hi this is
thing sorry by the way yes but not on
that block the block as a block as a
block so much still three inside
not inside the block inside block it's a
block it's a sequential range of data in
a block if you across the size of blow
the infantry yes then get better do you
read more than 4,000 points depending
from requirement sometimes you do
sometimes it don't but usually don't
often you down I mean if you read your
huge amounts it gets spread over
multiple windows anyway but they have
pretty much nice in a serious trustee
because unless you're the tree in a tree
gets worse and file systems are smart
they try to allocate next to each other
if they care right unless they are
running on minnows in which case you're
screwed and so I want to answer the
question on the benchmark you all are
horribly wrong which I predicted and the
five notes do about 9 million make it's
a second on a single note to get about
15 to 2 million a second it scares
literally little it's minimally literal
even read and so you're the closest with
one billing a billion was a bit off but
I tried that but that's I all not in yet
that's not blocked on early that's not
blocked on cpu or memory this is I don't
want so all they can be wicked fast are
you writing with or line with the file
mode yes because it's equations how many
of they sink threads 64 I think Britain
but it's running CFS so I made in case
for CFS if you have noticed if you're
not run yet as you really need to run
ZFS because we're going to go back to
data loss if you're not read running z s
no matter what database you
US data and so now that we have the ovx
place are used an SSD drive this was i
am not one hundred percent sure on the
benchmark boxes because they were in the
cloud and I was not allowed to go to the
data center and given they only have a
terabyte of storage my guess is yes they
are using SSD but shared with other
users so I run in production this system
runs on spinning disks the cloud I'm on
it on and that works exceptionally well
and what about like real application I
mean this is only for batteries you are
ready making lots of I offered what
about application you you have on top of
this machines which you are already you
mean and I try can set your question do
you mean the application running in the
cloud yes it's okay the metric database
collects not metric well it collects
headed on whatever you want and what I
personally am using it for is monitoring
the club so you can't cpu usage excuse
me memory usage I o Network metrics true
but I'm paying for gps and I wonder how
much of this course is going for like
pay for your measurements but also your
measurement I dealing I'm not that I'm
fighting for it but for sure if you're
paying for it
and why I don't know if you're paying
for it depends on which come from either
you also think if you're on Amazon
you're not paying for it could use and
you're paying for other stuff like
drowning them which is much nicer a bit
back just anger and that it is like
lately forward if one day percent of
their three boxes hosting this which
also hose a storage system and a some
other databases because they are I are
having three boxes so database go there
and in the whole scheme message if
you're if you think about it if you
collect if it was this five boxes costs
it's in the website of the documentation
what it costs exactly those boxes where
on test fo protesting I don't run it
from the joint public cloud so it is
which is really nice and and a word of
advice if you have a pension or
something on a public cloud make sure to
use internal IP addresses for the
traffic of a load no external IP
addresses because god damn traffic is
expensive and but like why do you need
nine million for five months hmm why
whether you get this one om so there's a
program called header which is a load
generator for graphite and which I
adopted to send metrics in da Martinez
protocol and I started as many header
notes as I need it until the database
could not handle more so this test was
driven an overall it was not at maximum
load it was born so hey I was producing
I will get you in a second haga was
producing about 15 million netflix a
second and they got better so the
database itself keeps a lot of how many
methods appoints so monitors its apps so
it's technically nightly network okay
there are some additional they are so
we didn't go to say yes do not now yes
yes right okay good thank you
yeah we have this time for few more few
pigeons yeah like what's your problem
that's a problem we have wars which is a
problem and yeah you right back Gordon
so last night playing that you write
with an RN w equals one and then you
send something out so what application
in there and so the implication of em
children replication of the replica it's
configurable if you want n 15 you can
run over there 15 if you want n 1 you
can run into anyone the higher end
issues the more node failures you can
accept Letson so for the test I really
wanted to see where the throughput of a
note how to scale so I selected and what
do to be more than one who does the
tunnel this effect you should be making
process for some mills so the TCP
connection does the panel yes but I
thought it then you get to the w value
and depends on how many get rights and
periodically have just cleans up the
incoming messages and go up to talk so
thank you do it on so you need to be
using something the beautiful state what
was it add a century
we know it's called mk6 byte array which
i found on google and which just really
allocates a chunk of memory and you have
functions to modify that so three it's
an if that is an envelope lazim yeah i'm
using the car yeah like what's your
problem with kisame and what's the
problem is Cassandra let's start with
the fact that on a 500 gigabytes of
memory notes it managed to claim it all
and now I'm sure after half a year of
study or hiring someone who is a Sarah
expert I would have gotten down to 200
gigabytes memory and it's not pleasant
to use and then yet I found the
clustering of cassandra is not very much
I'm sure the worse most of the time but
I try to send I did not ignore this and
I tried x reduction if not yes and at
the last but not least the query times
in Cassandra for below I have we're
about 16 seconds for say a day of data
the query times of the day of data and
the matina they be is about 50
milliseconds which is slight difference
and I like to get my data fast so that
by the problem was the same oh and it
didn't build clean up on us because they
don't ship the snappy binaries force
Nautilus so you had to manually compile
them which was
liampayne hanging out so your query time
is a millisecond using yes because it
sequential makes me I wanted to know if
you knew Percy be because that is the
anatomy what purge TV which is also
mentioned it that amazing now no I did
not know that sorry little bit I hope
it's not your project I have lovely
vegetables and walk over your project
but give me much of this database is
here I'm seriously sorry but I already
have your time and so the database
itself mom what's wrong and the database
itself is as the first I state as soon
as possible you can write a few just
signatures there is a query engine a
front end which lets you do averages
maximums minimums percentiles
yes yes but no no not fetch all the data
first it uses a streaming courage so it
goes to fetches a chance and in parallel
if there are multiple series of looking
at it once okay last question are you
open mind it also to damage data damage
data no not really that's might happen
kill Worf is neutral bearings and your
writing so it would not happen because
no since I don't wipe partial data it's
always a full metric value of your right
so there is no pockets it's an atomic
update in that sense and there is no
parallel access to it and sequential
access to a mutable data we don't be
well I'm sure that given cosmic rays and
memory corruption you can have made it
when story yeah and I'd like to get was
mom uses of data to but I cannot come up
with a scenario where that can happen
I'm happy to be convinced there is one
and please show me L our faces okay okay
that's all we have time for thank you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>