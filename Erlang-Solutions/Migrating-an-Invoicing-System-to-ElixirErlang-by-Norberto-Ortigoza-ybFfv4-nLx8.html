<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Migrating an Invoicing System to Elixir/Erlang by Norberto Ortigoza | Coder Coacher - Coaching Coders</title><meta content="Migrating an Invoicing System to Elixir/Erlang by Norberto Ortigoza - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Migrating an Invoicing System to Elixir/Erlang by Norberto Ortigoza</b></h2><h5 class="post__date">2016-09-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ybFfv4-nLx8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay well this was the original title
for my for my talk that was a migrating
the imposition system but I was I was
really thinking about about about the
about the talkin I think that a better
one is how to survive i right okay yeah
because was I was a really really great
experience but also very painful so
today I'm going to try to to talk about
more about that experience and hope that
it can be helpful for you so first we're
okay let me tell you something about
about about Mexico and well that's
that's the place yeah this is where I'm
from Mexico and maybe some of you know
more about Mexico because of the food
that's why it put some map about the
kind of tacos that you can you can find
all over the place maybe some of you
know more about a chinampas that's a
place in I did the name is Xochimilco
you can be you can have fun a lot of
over there we also have a place that the
name is Oaxaca that's done we're also
very nice nice place maybe some of you
know about the the pyramids so that's
very close from mexico city in the north
in fact and well also in mexico city you
can find a lot of nice places we also
sometimes we do crazy things for example
putting a baseball playground in the in
the in midtown it's is crazy well we
also have more kind of different
architectures but further these days the
most important thing is that we are
right now running one of the largest
elixir an airline groups in the world
and and for us but it is really really
great to know about that the community
is growing very fast there we are as you
can see more or less like 11 thousand
people right now in the group and more
or less than they we have meet meetups
there every month and we have an
assistance of more or less like 50 or 60
people so it is really nice it really
really nice and what also I want to to
promote of course that we we are running
with the help of land Evelyn solutions
this is this is going to be the second
time the second elixir factory like
they're so hope that of course you can
you can be there in fact last day the
last year we sold out in just three
weeks the complete venue so that's also
very very amazing this year is going to
be also great and in a great place and
of course as I told you everyone is
invited so hope that maybe you can you
can go to Mexico and you can also have a
great food and a lot of things over
there so okay well what is happening in
Mexico and that is related to to a
lecture on edline first there we have
some very specific requirements about
electronic invoices around like almost
ten years ago we start doing some
progress about doing everything in in
electronic electronic documentation and
in in in fact two years two years ago
the government said that the electronic
voices were were mandatory for every
transaction in the country so we have
more Lestat kind at that amount of
people that needs to do every every
transaction and using electronic voices
and the most important the other
important thing is that the government
is pushing a lot about doing more and
more and more documents jus seein
everything in electronic so we I have
these statistics for example the status
the company where we are we were doing
this project and this is from the one
year ago at the end so we were molested
at the third place of all the companies
in Mexico doing an electronic invoices
and for the end of this year will be
there yeah so we are getting a very very
fast grow the company is handling more
or less like 700 million transactions by
the end of this year and well if you
look at the at the end the last one we
are more or less like 44 transactions
per second so thinking about here above
this place maybe didn't say what really
just that because i really i really
understand that here especially everyone
that is doing some airline and elixir
stuff almost all the time talk about and
maybe hundreds thousands of transactions
per second so when i say well we are you
just need to handle 44 it's like well
it's not a big deal so why why we
decided to start using airline and
elixir of course it was not about
performance or throughput yeah because
this what you can chicken to that using
java or PHP so that's not really the big
thing yeah in our case it was more about
availability and cost reduction yeah
that's those were the reasons why we
decided to start using airline league
and these are where our requirements for
this for this system for example we have
clients that had critical business
processes that depend a lot about the
electron and invoices yeah they can lose
a lot of money if we if we don't deliver
the invoices a time yeah because we need
to we need to creating boys the
electronic boys send to the authority in
Mexico and also to the clients so we
need to do that online and need I need
to be very very reliable so the system
is to be available all the time yeah and
the last one we when we are when we
start checking the legacy system we we
thought that we were paying a lot of
pony for the infrastructure is it was
crazy that yeah because when I when I
saw the statistics and I thought that we
were handling at that time like 20
transactions per second and when I I
start to see the infrastructure and all
the servers I say oh my god it's I can't
believe it now why we have a lot of
infrastructure and servers in and we
just have so that a little amount of of
transactions so I really was scared
about that and especially because we are
start to see in these this graph now
that's the that's the grow we when we
start the project we were there yeah so
and when we we finished we finish the
project we were we were there so we were
wearing a very worried about the knee
deep road and how to handle that with a
with a with a with a previous system
just to that you can understand a little
bit more about the process is very
straightforward
we we have a just we receive a request
for the client we do some validations
about the schema the structure of the of
the information the data that we
received we also have a lot of rules
about how what is valid in the in the
data and so we need to believe a lot of
things that may be more but one of the
most complex part of the of the of the
system and then we create a document
because we we have a specific format
that we need to we need to follow and
then we do a digital signature using a
special a special appliance and then we
when we have everything everything done
then we deliver that document to the
authority to the tech security and our
clients that that scene is it looks very
very simple okay well so let's start
talking about the doesn't the legacy
system so once upon a time this was more
or less day very simple diagram to see
to see the system is you see for example
in the upper hand wow yeah we have 15
servers just to handle that amount of of
transactions and everything was I was in
we also have a client a java client this
one they want appears here is for was
for a batch processing we we need to
have a client and install in the in with
our clients in the in their
infrastructure so they can put the
documents in their servers so and within
the program's reads all the data and
start to send that information to to
desert to the service to the central
service yeah and well we have a java
servers we have as a database sequel
sequel server yeah and we have the
hardware security module that that was a
requirement for the authority
because we need to have the to cancel in
that Intel appliance the the private
keys that we use in order to do the
certification yeah so that that was very
important to have a all the time these
are the characteristic is the
characteristics for the servers so you
can see that we're we're huge thinking
in the intercom that they the amount of
transactions are very very low honestly
and these are the physical servers and
this is the specification for the Java
servers yeah so I love the special they
normally consume a lot a lot of of
memory and that was really also really
funny at the beginning because we say
that Windows Windows Server and then you
can see that they are juicing Apache and
on top of windows so West res was it was
really weird that we found we we found
that I don't know it's wes and then we
start to doing some testing so we start
to stress the system in order to know
more about well okay we can handle the
Delos or the future load with a with it
with the system and then we start to do
this and of course it crashed yeah so it
was like a okay oh my god well it's I
think that we have a really really big
problem so what was this tattoo scene at
that moment well we have a lot of dumb
times because of memory leaks why
because in a lot of places in the code
base we have for example a lot of very
very old version of the libraries yeah
and they on those libraries have a lot
of memory leaks they never never update
those libraries for some of them were
like
eight years seven years so you can
imagine that because of the first then
you start to doing some copies of the
system yeah so for something we have one
version of the day of day of the
completest certain services and they
then copy the complete stack into
another servers in order just to have to
manage more or less de clap de crashes
and try to insulate the problems because
they it may be some cry so then they can
switch to the other one and you can
imagine that and then you can start to
understand why we need to a lot of
servers for for doing that of course the
the copies weren't synchronized so maybe
in one servers we have version one and
the other one we have both shown seven
and another one we have version 6 so
what's also a nightmare and of course it
consumes a lot I love resources knobs
memory especially memory because we we
were running those own application
servers so just for the application
servers Eugene you just needed at least
two gigabytes more or less of RAM so so
more or less you need like five six
gigabytes just for running one service
zone it was pass a lot and we have other
problems for example that fixing simply
box takes too long really really decides
us for for doing something yet fixing
bugs adding new futures everything takes
a long a long time yeah because
everything all of course was manual also
especially for the testing so if we try
for example to test more or less a
complete test suite by hand takes like
more or less like two months so because
of the complexity of the logic the
complicity of the all the cases so in
practice was starting possible to do
right we will just do some smoke testing
and
in maybe two weeks or something like
that and okay I just try to hope that
everything will be fine in production so
we also have a problem with their where
we have some rules that were in general
today to the process but mix it with
specific rules from clients so the
typical case when you start to see in
the code and you find if client one then
do these if client to then do this and
mix it everything so a we were just in a
very old library java library for PDF
generation it's an engine name is pop
maybe one some of you know about the
above the library where you can generate
pdfs and you use an XML templates and
and we have a lot of them yeah and and
some of those templates were very very
complex yeah we're not just yet we're
not just documents to translate but also
includes our cause and and formulas and
I love of things there so some of them
were like Latin in the order or to two
thousand lines of code in size of just
one template so and and the problem is
that they obey they are very specific to
the for the clients because one client
Wednesday the invoice to be in a
specific structure with a with a low
hole with a lot of things that they want
so that's why they the templates were
very very complex so well as you can see
a lot of problem so when we've finished
to see everything yeah so we didn't say
okay what please please
a we start that's what we feel what we
were really really worried about about
what well what we can do about the above
the system because we were more or less
like at the middle of the chiller so we
have more or less like six months in
order to do something because we were
expecting a lot of growth at the end of
the year yeah because it's especially at
the end of the year we we we have a
spike of requests so when we leave okay
of course we we ask for the rewrite
right that's it that's the only way now
so when we when we find something like
this we all the time say okay let me let
me drink right no but we say okay wait
wait wait no it's not that easy Oh while
because we we we know about that no we
have here about stories about the
rewrites and the consequences each you
don't do that with very carefully so
also we know about this one yeah because
yeah yeah you find and say oh yeah this
is crap yeah it's that is very easy no
and you can just say that and then let
me let me do this because I really now
have to do this now I am the only one
that can really know how to do this fine
but you are at the end you will just you
you you have just allowed you have two
systems no with the same maybe with the
same problems so we started thinking
okay do we really need to rewrite
everything so we were thinking a lot of
and finally we we agree in this strategy
okay so safe okay first yeah fix as much
as possible in the old system yeah so we
say okay let's let's try to see if we
can fix this mess yeah in Java right so
and jealous Jose in case they start to
to train people in the inside of the
team to know about Evelyn and know about
an elixir yeah so we start to do those
things at the beginning next replace the
java client yeah the job at line that if
you remember in the M in the diagram in
a in the left what I was a java client
and was also a nightmare in especially
for for support because you can imagine
do you have different clients with
different servers different
configurations so for troubleshooting
was also very very difficult because
sometimes sometimes called you and say
okay I have a problem because I the
problem doesn't run so I think I mean I
didn't need to understand why and you
start to see okay well but what's your
what's your server it's windows windows
95 is this the windows XP is the winter
server is Linux which version of Linux
do you have a which version of the Java
Virtual Machine so what's very very
difficult because they see the program
the client has a lot of dependency
external dependencies so so once very
difficult to try to to do this
troubleshooting that's why we decide to
do so just go I'm going to spray more
about that and we start to do in soma
small projects in our land and elixir
yeah no critical no critical ones but
just to start to understand for the team
to know more about the platform
yeah and then at the end if we see that
we still need to rewrite then maybe
we'll be ready make yeah for that moment
yeah and if not of course get fired for
incompetence right so okay now sounds
like a good plan okay let's try it how
long can it take right it will be phase
I don't know wait snow and of course
where can go go croc okay so we'll start
fixing the old system mm-hmm we made
some changes to the Java system in order
to support the the new the new load that
we were expecting at the end of the year
we updated most of the library's the
operating systems the application
servers I love that was a lot of work we
we select some parts of the of the
system in order to rewrite those parts
and Joel and replacement in some cases
replace a complete modules yeah but we
we try more or less to maintain the same
the same code base we also improve
improve the deployment system because
that was also very very painful because
at the beginning when when you want to
deploy something they they the team in
the infrastructure team Nia need to copy
the class files not know we we were not
using jars so George when Judy when you
try to do the deployment you go to the
tool in the in the file system copy
their cluttered deduct the dot class
files and put in the production server
yep by hand
so I that's why it was I was crying that
done woman we also have a problem
because we change data center don't do
that whenever a specialist visually in
the middle of that kind of changes we
take well it will be easy no but no it
was not easy so yeah really please
please don't do this is yeah just try to
do some just one thing at the time not
trying to do all the things we will able
we we were able to remove some copies of
the system also we tried more or less to
since we changed some services and try
to centralize on some parts in order to
just have one version of the of the of
one of the services and well at 40 at
the end of the year we were able to
manage reload so we we were safe at
least for that year yeah and and of
course we we were fine for more or less
like two years I think more recent than
that at the time so okay that was today
that was a certain day the services what
about the client well we started doing
during the day rig right of the client
using go and what why go because it
eliminates dependencies yeah and that's
fine that's very very fun and good for
us because we just you just can create a
a binary in fact we we we include a
sequel light and we embedded sequel life
inside of the binary and the binary was
more or less like a eight megabytes or
less and was everything inside so we
just need to copy the the the go program
the binary to their machine clients and
and everything was was perfect no a it
also gold also supports multiple
platforms so first was also very very
good at because some of our clients
needs so Larry's linux windows etc know
and and and go supports very old
versions of Windows yeah so that was was
very important and well it has also good
support for concurrency and it's fast
yeah yeah so yeah but why go well wait
for that part we really we don't really
need high availability so go it's okay
for that no I don't have any problem
with that next we will start to train in
the team so we start creating a two-day
today's tutorial where we try to teach
more about the beam the Erlang and
elixir we start giving that curse for
free for one and a half year and we
start to receive a lot of feedback about
about that no about okay not that part
is is not clear we need to change these
we need to add more exercise we need to
change the order window so a lot of
things and what's great really really
great and and in that period of time we
we train more or less like 100 people
yeah what was really fun and yeah and at
the end we finished with a seven day a
class so so today when we want to add
more people at the team we can we can
start doing the day the class and we
have Melissa sex seven days for that and
then we create the Mexico City elixir
group yeah and also was was very good
that
now we start doing small projects we we
create a proxy using dynamo that was a
web web framework that Jose volim create
but I remember that was like one week we
can like a Saturday that we deployed in
the new proxy and then next week her
siblings announced that it was going to
be deprecated huh so they okay well but
wow wait the good part is that that that
piece of code was not critical okay so
we were later we were able to replace
that white with Phoenix and takes just
like three days or something like that
just to do that so no big deal in
practice the other one that we we create
a hardware security model emulator and
and well that I think that that is
really a really great piece of code
because for us because for example when
you when you want to try to test the
complete system that and do a an
end-to-end testing the problem is that
you need to do need the d d sh h sm
appliance but that piece of hardware is
very gots a lot of money and it's
difficult that maybe the infrastructure
team gives you access to them using a
from from from the servers that you have
ad for for development so for us was a
was a big deal to create an emulator in
a league in a in that line of course so
and what's great at implementing the
binary protocol was like 20 20 lines of
course so so that's what's right because
now for example the development team
just have everything in there in in in
the machine in the local machine you can
start the the complete application and
you have become the complete dependence
since running at the same time so you
don't need to connect to other
other services to other hardware so you
can find that one in github and we we
did a lot of proofs of concept also
during that time okay now the big
rewrite honestly we had a lot of lock
yeah because the government announced a
new version of the stander yeah so they
say okay we are going to implement we we
are going to have a new a new a new
standard the comp is very good a lot of
things change so we say okay is the
perfect time because our clients needs
to do a lot of things yeah in their
systems because they need to do they
need also to implement the new standard
so that's the perfect time yeah and the
good part is that at that moment we were
ready because we were doing we we are
doing a lot of the training and the the
projects etc so and we still have
problems with a quick coast now and of
course the development cycle that still
was very very painful so we we create a
team of five people to do indeed the
development one person help me help us
with a with the deployment and two more
doing the test yeah so dot the the last
the last ones were people that didn't
know anything about programming because
they do in a day where Joe's people
doing a test cases doing the design but
there you start to learn alexina levlen
and they were the ones that right the
complete state sweets yeah and was I
think that was what's good for us so we
did it we wrote the first version in six
months yeah and we start with just one
Phoenix up yeah kind of monolithic
Phoenix up that would you say clucky
when I when you finished application and
we start doing everything just inside of
that but that was wrong so we rewrote
the system one time in three months
juicy no TP ya doing some changes to so
in order to create OTP applications and
I think that was a much better way to do
the things and we also restructure the
complete system also using the umbrella
project but that takes just one took
just one week for do that so so okay
that was the previous system yeah we
have needed to support soap by the way
we have the 15 15 servers and this is
the new the new diagram with just four
servers yeah so we finish using just for
Severson and the reason that we have
four is because we have redundancy in
hardware because it's not will be just
enough with two servers yeah but the
only reason to have four was because we
we have just like a copy of the system
and be ready if anything goes wrong but
if not will be enough just with two so
we have now digo client in the in the
left and we have now the D server
running along elixir we need to maintain
the job a service that creates the pdfs
why because of the the templates we have
allayed evaluate the time in order to
move the templates to another another
options to in order to generate a the
PDF was not it was a no it was
another an option because it will take a
lot of time and will be a lot of risk to
try to move everything and two will be a
will be a difficult to do the migration
of the clients so that's why we say okay
that part we are going to maintain in
Java and we are going to call that
services from a lecture and our line
yeah we also use C library just in
Python and we we use port in order to
create a pool a pool of of processes and
then sending the documents for
validation yeah the reason is that for
execs ml library that we have in our
land maybe I'm wrong about that but when
we try to use that light library the
problem was that it did it the library
doesn't give you a detail information
when you have errors about the structure
or about the content of the xml file and
for us that was very important because
you need to that to send that report to
the client in order that declining can
fix the problem in the document so in
some cases they the xml library for
validation that is in ireland it's fine
because they can say ok the structure of
the xml is is wrong and this is the nose
and ok but sometimes you say the exam
else has a problem and that's it so so
that's not that's not good so that's why
we find another library and and we we
find that library but we use ports in
order to do the request in order to
validate the the XML structure and then
return the perfect errors to the client
yeah that's why we we start we use that
Python and C program and we start using
in production the the eh
some emulator in order to do some Sun
signatures do the other signatures so
this is the the new version if you see
inside of the service we have that one
that structure Phoenix is just one a
little later yeah justjust is the one in
blue yeah that's the only one that is
Israeli Phoenix and everything L is just
OTP yeah OTP applications or modules
that note that doesn't depend at all of
you know about Phoenix so for example we
have a router for the documents because
we are going to when we received a
request we are going to be able to check
the title of the document that we need
to create and then define which which
was going to be the flow yeah for that
for that document because has a
different day they are going to have
different a stages so we have the
validations the creation of the boys
they seek the digital signature and then
we have all day also the the ones that
are in the right some of them are
processed at our in background yeah that
they run so for some periods of time in
order to send for example in document to
the authority or sending that
information to the client by email or
other other or other forms this is the
day the characteristics of the server
yeah and okay this model is it define a
timeline yeah and it just took treasures
so take a little more time while we were
spec so the finish
so the new system juice a PDF generation
juice in a java but no longer juices
application servers that's also great
yeah you we just just greedy the jar jar
and then ruin the jar and touch it and
perfect perfect for infrastructure the
disk immobilization using Python depict
on library we have better performance
and latency and for development we use
postgres um when we put the system in
production we way still juicing sequel
server that because we we need we have
to maintain that day hey that was not an
option to change the the database
manager the deployment for the plumbing
we use ansible and evelyn releases the
test suite is more or less like 11
thousand tests more or less and it takes
more less like five minutes to run yeah
and it's awesome really really awesome
that we can really feel comfortable when
we are going to really want release a
new version or fixing some bug it feels
better you can develop and test
everything without any external
dependency and we also include a single
sign-on service in our line yeah that
also works for fine and no more leaks of
course we centralize the management of
errors and we we can reduce the code
base from more or less dead amount of
Linus Cove in Java to that one in elixir
yeah so just to finish this was when the
graph for for the for the java version
this one is for the for the new one yeah
for the transactions per seconds in the
case remember that rough and the system
crash okay yeah this is the new one
yeah so for CP for 4 CPU well and we're
doing the doing doing doing the testing
of course our language is using down the
course and right now less than 1 jika
byte of memory yeah so final words it
can take a long time and so be prepared
for that yeah you will need support yeah
for from the CEO of course because yeah
it is going to be more difficult you
need to define a training pad definitely
yeah I found that the team really loves
our land and elixir when when they when
they understand the concept they
understand about how to use everything
related to OT PE and supervisors and
they when they they understand the
benefits they really love the platform
yeah that's that's nice be patient
sometimes you need to wait for the right
time you're going to support your system
also for a long period yeah and evan is
awesome for binary protocols yeah that's
for sure that's for sure you know you
don't need to trash everything from the
old system right so be open to reduce
like the legacy code sometimes you can
trash everything yeah and that's fine
but airline is good to orchestrate other
systems yeah so for us is working don't
be afraid of changing direction yeah and
make big changes especially when you are
doing I'm the complete new one and first
that that last point is is important it
like it takes like four months more or
less to have someone to understand and
use OTP OTP yeah
of course if you can you can give the
right training and the mentoring to
enter that process we think that for
months is ok so they can really
understand why when to use OTP in which
parts and the supervisors everything
yeah I think that that's a good time to
do that yeah so so thanks and well see
you in Mexico thanks thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>