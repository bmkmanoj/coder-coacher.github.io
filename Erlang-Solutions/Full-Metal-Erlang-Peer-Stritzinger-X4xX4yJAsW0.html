<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Full Metal Erlang - Peer Stritzinger | Coder Coacher - Coaching Coders</title><meta content="Full Metal Erlang - Peer Stritzinger - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Full Metal Erlang - Peer Stritzinger</b></h2><h5 class="post__date">2014-05-30</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/X4xX4yJAsW0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">yeah introduction already made we we
will look at the following points first
of all I want to introduce you to two
items the operating system because you
probably don't know it it's not it's not
very much known outside of our certain
embedded circle and then i will show you
some hardware which I brought and then I
explained some details of the pot and
give you the status and future and stuff
so that's right I've taken just the
slides from my friends of better and
better brain so two atoms teaching in
Europe so they had the convenient slides
and I could use atoms is a is a is a
almost model operating system it's
actually the e.r x stands for executed
because what you do with items is you
write your application usually in z or
in a de or n c++ and you link it with
the operating system when you have one
image and you load it and it's just one
memory image so but it gives you all the
obstructions but not processes it's like
basically if you think it's if you think
a unix process a single UNIX process
that's how your whole thing looks except
that you can get it the hardware it has
relied several reliable real-time
schedulers hard real-time so if it's not
in time it's wrong stuff blows are
cheaper died and more important what it
isn't it it has no very sophisticated mm
you support there is some stuff to make
some protection for security stuff but
not like we are used to it in now or not
on unix-like system and there's also no
multi-user and nothing is protected from
everything everything is running the
same memory image and everybody can just
point
into the other tasks memory and do stuff
so it can sometimes a little bit hard to
debug yeah some real-world applications
where atoms is actually used it's an
industrial robotic wave that moves
around and the factory floor it's used
for the bmv Superbike it's a racing bike
from BMW it's actually embedded brains
did this those who did this light so by
accident they put it in and it's also
used in several space applications for
one example they have to space telescope
but it's also it's in the Mars rover I
think in their radio because usually
have several components it doesn't you
don't have there's lots of weeks works
there but there are certain stuff that
is done with autumns and it's used by
NASA and iza both yeah the ranges are
quite big you can get from 696 kill
about kilobytes to up to 64 megabytes
wrong actually I have more wrong but
that's an end flesh so that's not
actually wrong I'm not running from it
ram usage I mean if you want to run
element you need a little bit of ram but
it's the footprint of atoms itself is
very scalable it basically why you build
it and while it's in do you have a
configuration header then then it pulls
in all the other stuff you need and only
the stuff units they take very much care
that the footprint of the system you
produce doesn't contain stuff you don't
use so if you don't use a tcp/ip stick
it won't be linked it's not there then
what's interesting for along is the
context which time for 10 microseconds
so that's also pretty fast like Ellen
and but that's a thread context switch
these are threats but since we don't
have to go into a kernel across there is
no colonel you can very fast to do the
context which very fast and you can like
if I if you have floating point
registers if your CPU have some in this
task so you don't have to need to save
and you can optimize it like hell if it
needs to be really fast it's ported to
almost everywhere that's the main
hardware architectures normally you you
will run it on 32-bit systems there are
some ports to 16-bit systems and special
systems but yeah that's not interesting
for us because this world this won't run
Ellen never and with with embedded
systems since it's all linked together
and you don't have like Lo liberal
drivers or stuff like this you usually
end the hard way is very much different
from each other so usually you have like
a custom board where you run it on which
is just built for this one project and
so what the embedded board has is a
thing that's called PSP bought support
packages that's basically a piece of
library where you have a little bit
basic stuff to like help the interrupt
handler you're very specific stuff and
but you can like plugging into if you
have a PowerPC you can use the library
for powerpc exceptions so it's it's
helped so these can be pretty small and
this is actually there it's from 2010 so
they are much more now especially in the
arm area arm is also in the various arm
is coming and lots of arm parts being
done so it lasts in the introduction let
us look at this structure let's start
from the bottom we have the hardware and
on top of the hardware you have the
actual executed the thing that runs
their schedules and in the executor if
it so these blocks everything is linked
together it's one image it's the blocks
are not like running separately or
having some separation so this could
point over there and whatever so the SCP
is peace and
you have hardware interface basically
the interrupt driver if the interrupt
occur if there's a small test the ticket
asked if the ticket asked runs you
basically have your port done and then
you need to add all the devices because
these are then not included there is a
chip level driver support so for some
standard chips you can just use
something out of this library so if you
have for example some i square c block
that that is supported by this library
you can just use it but very often what
what you do is you write your drivers in
the application so actually on top and
the green one because you can just
access the hardware and it's so
convenient that you just grab in and
fill their registers add up one way of
through handling threads like when the
interrupt calms you just parcel when I
went to to one of your threads and the
thread we'd see data from the from the
machine and and so you can get really
really close to the hardware there's a
networking system it has tcp/ip
optionally it spotted from freebsd and
there's also file system support IMF s
means in memory file system it's
basically a ramdisk there's a fat file
system that you could use and for
example in this project we have also a
part of of Yaffe's that's a flash file
system to directly use the nand flash
without without all the block management
stuff but does the block management
stuff for you so you can you have a
layer for porting file system so you can
quite easy put your own file system and
if you want and then you have the
supercorps the yellow thing that's
basically in the internal api and on top
of this of this you build the actual a
api's on their success yet api there one
on the on the Left that's actually built
by a very old
embedded operating system standard the
arte ID standard I I think I don't know
if it still can be found it was I think
it was be done by the military they're
back then and there have been commercial
operating system like Pacers who also
did implement this standard pesos
doesn't exist anymore it was bought by
wind river and code and then for me most
interesting the POSIX I API is pretty
complete so basically it looks like
yonex so for the other part I just
basically used the unix port I didn't
have to like like weeks works as a known
directory we are lots of stuff vicksburg
specific is in adams is actually smaller
than weeks works a small operating
system but the projects api is more
closely to the other standard and the
other ones are not important so that was
introduction some further examples what
I have built those items that's actually
the stuff of me that's a device my my
company builds its for automatic
flashing and where atoms is running is
on these that the bots that sit behind
these these big connectors and it's also
using Ellen but on this Cylon unit is
running on a unix on a freebsd on a like
mini ITX industrial pc board and
attempts is only running on the gateways
to talk to all the automotive standards
which are plenty and getting more and
more and the airline is talking to their
to the gateways via USB so that's where
we started basically with element atoms
that's just what i said if you want to
see what i gave a talk about the system
like how is it built and how the
experience using Ellen for the
automotive flexion system a telling
factory Munich the slides up and I think
even the video reflashing oh it's
basically in the in the autumn in the
automotive is user control unit sits in
the car making you soft when since
there's flash in there everybody's
calling this reflashing or flashing so
and the devices are basically for
manufacturers of the off take control
units when they need to reflash a lot a
lot of pieces like like a big stock lots
of boxes of them thousands of them so
they need lots of terrible stuff and you
can you can connect the box and get much
channels in parallel like so into
channels in parallel and then you can
have great flashing capacity to so you
get the High Peace numbers another thing
that's filled with the atoms is from
bosch rexroth that's an rfid system and
industrial rfid system using custom rfid
blocks so they built their the actual
texts themselves it's a proprietary
system but it has very neat properties
and that's basically the antenna and and
then hen is pretty intelligent it has a
caching layer you need and all the oil
stuff and it got pretty complicated it's
like yeah you could say wordings rule
applies it contains a bug written I
don't know how many percent of our vm
that we want to replace basically for
one of the successes of the project
their posture excellence is paying for
their further for a port it's for one of
the app projects so far we only did a
prototype so so this is a few persons
connected and with a few passes what's
new they are moving to internet more and
more that still many are using profibus
and stuff like this but more and more
ethernet based protocols and in the in
the ethernet industrial based protocols
area there are lots of protocols so many
standards to choose
from and so we wanted to be very
flexible and that's one of the reasons
we wanted to use atoms so demo time I
hope it works it's actual hardware so I
switch over on the camera because it's
actually quite small I try to show it to
you I try this should work this was this
was longer before set hitch oh yeah fell
down thank you I think that should be
enough so let me see my hand is in front
of the camera right this way around so
try not to let sexual whoops let it work
better in there when I was less nervous
so that's actually bored it's a little
bit dark what you see up updated
cylinders that's actually they connect
us on the top that's it's quite boring
it Sonja ethernet switch and that's
power connector you see there and these
are industrial m12 connectors so you
screw on things so you have like
connectors connectors looking like this
that's hard no I shouldn't oh this is
des better I shouldn't look at the
screen so that's a connector that goes
on on these things multi-purpose mark
pijl ahead I need to look at the ipad
here so this is the boring side and the
interesting side is this the big black
one that's actually the CPU I think
that's the flesh and n flush and that's
the SDRAM that's a connector for the
actual actuators which is actually
electric but it's not connected
what what we have here that's only a
temporary attached serial adapter
because normally it we don't have a
serial line on the bond on the board
it's only for ya for development and the
wires are for me put my scope on look
what's going on if it's not working so
let's move this back here on the way
around it's over there oops
unfortunately I don't have anything
moving like an actuator or something
like this because we don't have this yet
so it's small i show you how it boots
and do a little bit things to sit on the
right that's basically the serial line
here why start screen to talk to the
sewer line and what I then do is I let's
power it and this goes pretty quick
that's the boot in the boot loader which
is also atoms actually so atoms
splitting atoms and that's already a
line that's the surface top so this
meant by a little bit quick
so I know now I hate screen
so this is the usual stuff you see G
proc staffing so let's go to the top so
let's take the bootloader autumns where
it is it mounted it and that's basically
our name that's I also from the main of
the of ltp of the L nvm already and
let's go down okay so let's let's do
something I wanted to have distribution
working before the conference but you're
my customers were thinking otherwise i'm
heading having requests so I show you
something else that works because
network works oops
it's almost done it's almost done I will
talk about it later what what's still
missing oh yeah thanks fortunately big
space is working didn't it didn't work
in the beginning and it was really you
can't imagine like working Michelle like
this never do this
okay that seemed to have worked oh I
forgot something
need to capture the pot
no one was okay it worked
oops I forgot something you are not
connected yet might help let's problem
is a big connectors here it's like the
tail wagging with the dog
oh thanks so we need to talk to it it's
not a new version of tenant I think it's
93 and five six seven eight yeah and
let's see if it works hey
no other direction works also so let's
be tightly okay so now i put again and i
press the service mode key so now i'm in
the boot loader and there's a little
sheldon in our times where you can look
at the file system if you like then our
ftp server would be running and you
could like load stuff on there on the
nand flash so we have devices and ffs
that's a flash file system where it is
mounted and there we have any file and
in if you look into boot let's beam and
which we look into OTP that should look
familiar but still are 15 and in abscess
you know I put my own apps okay and aft
mo
um we will get a bit plenty rammus cheap
nowadays we broke it I mean yellow is
also nice hmm probably stepped on it add
it's this one cut five going went out ok
so now my time is gone what's the time
good so on the board we have a PowerPC
embedded controller MPC 8309 that's one
of the communication controllers it has
a quick engine which is you can like run
ethernet with it or all kinds of
loadable and protocol engine stuff and
since we want to communicate a lot so we
picked one of these with the flash I
mean 128 megabytes of NAND flash was one
once you don't take nor flash why not 20
megabyte is 20 it's the smallest I can
get like 45 years because if you if
you're building you need to be make sure
you can buy it i can buy smaller one now
but they will run next year so let's
plenty of room for fitting the files on
and since the the controller itself as a
sdram interface yeah well 10 256
megabytes is also about the SDRAM you
that you buy normally it's a smaller
system we could like like spare like ten
cents with human buy a smaller one and
so that's not not limiting anymore at
least not for these 32 bits controllers
I on the board there is a ethernet
switch because you have seen several of
these connectors you
have three external internet because
industrial users there they like daisy
chaining the cables like this so you
need two and one for debugging because
the console will be gone this this is
just solid on let's not destroy this
yeah good Laura thoughts and atoms are
already said so what what did I have to
do to put this basically atoms comes you
build the atoms build tools comes with
an own version of GCC and if you build
something with the build tools and link
it then the atoms will get linked to it
that's it so I didn't have to do much
that's it's actually all all the cross
compile support is already in OTP very
very well done it's really nice it
wasn't easier than I thought the first
that's basically what I changed in the
config file from like the template the
first stuff is just should guess if it's
the libraries there that's just being
lazy the host name I want to call it
this powerpc items for dot11 because
it's a convention how the the atoms
naming is and I did configured with our
term cap because I was not that
interested in term cap there is actually
a cursors implementation for atoms but
that's just one way has learned since
the serial line interface is going away
anyway I don't need it so I could figure
this out term cap and so the longest
thing is the GCC configuration because
there you have to do all kinds of stuff
you have to use items that GCC you built
for atoms and you use a special GCC spec
directory and the spec is there was the
PSP and its light the PSP
these piece bags or the PSP is selected
by using that's a PSP name that's the
name of the project so the PSP is
selected by by going this in this
directory and the no stricter lies is
actually a preference of mine because I
I was I had to search a bug in Adam
scheduler because it was not no strict
aliasing proof but they sought and they
switched it on and since then I switch
it off because I didn't want to have to
explain what it does look it up it's
it's just hot by itself and we don't
have Paul we have only select and see
flex is nominal and this is lips there
there we link whatever we need and it's
a demo lip where which I use to build
demos and I have an NTFS service linked
also for development it's quite native
because you don't need to upload your
beam file all the time you just mountain
by universe and then you can just build
them and rerun well load and lets the
creek library that's for the
communication coprocessor that I think
that's supporting library that the file
system needs and that's a filesystem yup
that's it and there was there was some
stuff to do to make files like basically
on many places where there's a if the
target is weeks works then I had have to
add a branch like and if the target
contains items then do something a
little bit different so this is oil
this should have been come out darker at
the moment which is not where I want to
stay at the moment when I like want to
add a driver i copy my stuff into the
OTP tree because i have no con I five no
support for like building the
application and an OTP it has to be one
thing and I don't I was too lazy to make
Ellen billed as a lip it could probably
be done but yeah so I copy everything in
I have a script that patches make fries
in Newton an OTP and copy in my drivers
and my application see files and that's
one example for for such a patch that's
for the the SPI driver to talk to the
spi interface it's a talking to chips 0l
interface I just fetch in into yet a
simulator make file dot in when I mean
atoms driver objects and I had my own
object and if i do it like this i get
added to the aesthetic travel travel
let's actually a linkedin driver now and
i do this like this because i can't do
dynamic linking yet but this driver
disturb actually talks to the order from
Elam so Ellen is calling a linkedin
driver the LinkedIn driver directly
calls the hardware right stuffin into
registers and handles interrupts back so
you have a very I did measured yet get
very short latency from actually
something happening on their Hardware up
to the to the island vm until something
happens so and after I do this patching
up it's basically there than the normal
cross compilation process that's built
into OTP so that's that just works you
ought to conf it and you have the the
cross compiler configuration I have can
also do this you have the cross
compilation support a configuration file
that's the configuration file i showed
you before and yeah i just what for this
build a i disable threads still because
i had some bug in and
it didn't put up and cerritos enabled
and there you say the prefix where it's
on the target it's actually in the wrong
prefix well and then I just do OTP will
put means minus a that's what everybody
does who builds yeah LM for himself and
then I install it where you can give the
destination directly that's actually
where he puts the files on the host so
that's where it goes on a target and
that's where it goes on your host that's
that's my NFS mount where I put it in
from there I copied on the on the on the
flash file system with ftp then
sometimes and for booting you have seen
there was a file called pimp in because
the bootloader just wants a raw file one
once the raw file that put that it puts
on a special that's speciality of the
booting process of this hardware that
could be different I just use object
copy n this is the elf file and that's
just the raw image so that was easy as I
already said EPMD is missing what I
started with already at the main problem
distribution needs EPMD so the first
airline process that started looks if
EPMD is running and starts it if it
doesn't and then everybody talks to this
one EPMD process EPMD but you can use a
unix program so if i want to if i want
to report it to our Terms I need to make
sure it runs inside there and vm so i
decided to actually build a EPMD
replacement a very simple one in yellow
I mean it's just the protocol and I have
I have quite it's quite a ion have one
note sorry it's only one node running so
it doesn't have
kinds of multi-node functionality the
only thing you have to make sure is you
have to start before an elliptical
starts because it wants to talk to em
PMD so you need to put it in the boot
script before this comes I think after
the holiday after the user conference
next thing I will do is this so three
weeks four weeks
that would be also possible but I I
thought will was having a EPMD written
and Ellen I need I I don't need to
change as much existing code so i just
need to add some code that's only called
in a special I I thought I could get it
better submitted back if I do it like
this actually I talked to Patrick last
year about this and he recommended this
also there I think they're em santos
Michael Santos is doing something to
like to hack the protocol to like get
into between the between EPMD and their
day alan to disturb it so I'm looking at
this examples but it's i'm basically
looking at at a client code in in
erlangen writing the opposite part so
for the future we also would like to
have dynamic linking because as it is
now you need dynamic linking for nifs at
least to fake it so initially I thought
I need to fake it because it's like you
have all kinds of dynamic linking calls
in the newest thing it would be
convenient for LinkedIn drivers but not
necessary because you can have
statically linked in drivers you can
link it this result OTP like I shot
before but it would be convenient if you
could just load them and it would be
also what I would like to do is like
that you have a build of Aaron with
their atoms tools and your own atoms
application with your C code and all
other kinds of tasks and stuff like this
and the PSP and to be able to link this
together so you could like Bill de el
nvm for powerpc and not IL nvm for
powerpc on this board because that
doing now now when I build it if you
haven't shipped with i will distributed
the image nobody could use anything
except users of this board which i think
at the moment there are three existing
of these boards it's a custom-built
board so that's a small user group so i
would like to separate it and
fortunately there's a new project in
atoms which which just showed up that's
our team's linker that's a way of kind
of dynamic linking in atoms it so it has
all the normal dynamic linking dynamic
linker calls and you can like separate
stuff like the separate application of
stuff like this but actually built for
something like adding applies in the m22
atoms and i will miss use it for doing
with a if it works but i think it will
work and then and then all this will be
easy so just by not doing anything about
it it was solved from me from by
somebody else in the futures we have
looked at k qs at the moment we have a
selected in atoms and the implementation
of select is pretty bad it's slow
because it's like nobody uses it because
it is its own mechanisms for for
signaling and what what we are looking
at and we have already done some initial
work to port the freebsd cake use to
autumns and then the allen could use k
qs and so we could have a very efficient
signaling over cake is just five minutes
ten questions otherwise I overruns much
what I'm also looking into is I want to
make a c-note in the atoms for smaller
hardware for hardware that's too small
for having a complete vm because then
you could have like a few larger nodes
and a few very small nodes and you can
have distribution between them and have
a more more scalable system for this
there's also as at the moment as i speak
basically there's SMP support built for
arm into atoms and when this is stable I
certainly will try to follow along to
the SMP thing because even in embedded
even in small embedded systems you are
guessing we were getting multicolored at
the moment mainly are symmetric
multiprocessing that they have a small
slave CPU but it's coming and that's
also like atoms has a kind of limited
message queue and it would be neat if I
could just send a message to one of my
atoms processes so to wrap it up I need
your name along on atoms is a little bit
long so when I i plan to to do more
supporting libraries for for the
splatter my try to build a platform out
of it for this size of of of devices so
let's colleague wrist that's a name from
new project and it's basically alimony
atoms are some supporting libraries I
after I finished this port I want to do
a port to be bound so there will be
probably just a SD card image to
download and so everybody can use it
easily and i also have then tested it is
armed different architecture yeah more
to come and there's a website and the
website is pretty argued yet but it will
it will have content and it will get my
son i also want to thank both directions
will basically paid for the pot and also
thank for embedded brains who to the
autumn support who support me with
autumns for free it's actually a they're
pretty gross they're friends of mine and
they also for example do this Hardware
their hardware developers questions you
were first yeah
one events built into the already yeah
straight were easy is it yeah so is it
possible to go through a like a
low-level library for first before
yelling I oh it could be done but the
event mechanism in our terms is very low
level so you have like maximum 32 user
events per task it's basically a bit
mask like you said it's basically a
software interrupt you can send to a
certain task so you would be very
limited on the amount of events that we
can send to the vm because that's one
process and we have only 32 events but
maybe we will add this also but KQ what
we also need addition to the event we
can dismiss in atoms because what's
missing is a global event mechanism
something I like like I can like publish
my events and somebody's listens to it
these commercial support for it but it's
open source it is GP Elvis exception for
some historical reason it went it
started as GPL when it was open source
but there's a linking exception so you
can link your code to it without showing
your code because otherwise be embedded
developers wouldn't like there was one
question ok so and every everything will
be contributed back so I try to minimize
my I try to get rid of my patches like
into the respective project so you can
just build sorry you can just build
along with atoms with the standard tools
with Wells any additional stuff
are there any other questions so this
seems like it's getting close to the
dream of erling on bare metal pretty
close so okay if there no other
questions then we'll thank you pairs
pair will have a short break while we
set up for the next speaker</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>