<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Lambda Days -  Jakub Oboza - Design, building and handling in production a messaging system | Coder Coacher - Coaching Coders</title><meta content="Lambda Days -  Jakub Oboza - Design, building and handling in production a messaging system - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Lambda Days -  Jakub Oboza - Design, building and handling in production a messaging system</b></h2><h5 class="post__date">2014-04-28</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/MelyMg7qKt8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so my name's Generosa and canaima cool
so this is this most rude but this will
be the story that we have while we were
building an SMS gateway which obviously
is a messaging system to there were
messages between the people so what I'm
good talk is everything what we have the
problems that we have the language
scalability issues for tolerance see how
it impacted our choices and what did we
choose and actually the most fun is at
the end where we were I'm going to be
talking about the operational costs and
operational maybe not cost but stuff
that you have to be aware and you're not
always aware about so yeah the project
is an SMS gateway I'm working for a
company in London and I think that's one
of the biggest gateways that are out
there and so basically what is an SMS
gateway but well before this talk about
us in this gateway I'm we need to be
like a tow communication specialist yeah
so first of all we have three times that
we need to learn MP is mobile community
that's the message that is delivered to
a handset for a person and then we have
mo that's the message that is sent from
a handset to your from hands it to the
operator or to a different different
person and we have dr which is a
delivery report which is directed by the
operator to the client or by the gateway
to declines that Tim message was
delivered or the message was received so
basically the project started in 2009
and we have to be aware that all the
decisions were done in the context of
2009 at was not 2014 no 2013 and
requirements for the projects was it was
time constraint projects initially we
have nine months but later on it was
reduced to six because the competition
actually got the rest
that the company is working an SMS
gateway and they were not happy about it
and it was not really a start-up
environment because companies already
established a they knew what they want
and they have to build it and so what is
the SMS gateway like in this complex
basically it's delivering api's because
operators work in a certain certain way
and by operators I mean for example like
orange or tmobile the work in a certain
way so for example they're not going to
be like dealing with you if you send
less than 2 million messages per month
for something something ridiculous like
this so even big stations like BBC time
for ITV they are not sending this kind
of volume or not every month usual I
it's something close to this but they
cannot guarantee two million SMSs for
like every single operator and SMS
gateways basically say yeah we can do it
we're going to handle the traffic and
we're going to handle the operators and
you are our client so why not first
decision that was made was programming
language and that's actually was hard an
easy decision because the initial
requirement was it needs to be fought
stole around and at that time when
you're going to think about languages
it's not really going to be hard to to
choose you know to decide what was that
the final decision but initially team
had the experience in Ruby so they know
how to big stuff and will be a
previously beat stuff in Ruby so you
know that definitely was not the right
choice because even if the Gateway would
be built in Ruby where there was some
attempts to build the Gateway affair and
quite successful they were not able to
handle the volume of traffic so we have
the second thing that was working with
Java and they were building a different
product so there was not really anything
that would be
an incentive to like move the damn to
this project because they were occupied
and asked me as we know actually getting
developers it's not so easy task so
Skyland goer actually kinda out of scope
because at 2009 nobody had like tons of
tons of the experience with it hospital
was there and you know everyone
considers always has care but we did not
have like stuff like a song like MySQL
simple or even third Haskell which even
today if you would think about class 12
hospital you'll be not super sure if
it's if it's the right choice for your
for your business application and those
airline 20 20 years of experience in OT
in telecommunication like relationships
ready libraries fold over and see almost
out of the box so the decision was
really simple yeah we're going to go in
fair line because it's awesome the
second thing that we have to think about
this database and there was like a
really those two really big things so
the business knew that we cannot lose
any mo or mt that's like a message so
basically we cannot lose anything and we
have to be consistent which is kind of a
lot you can lose some stuff but you
should not everyone is unhappy when you
when you lose stuff so at that point we
thought okay first think mysql but my
school is kind of like a think that if
it's going to go wrong then you have a
problem because your muscles down you
had the money while you started you have
to have a failover to slave it's tedious
yeah and there is react react was
actually out of the box the solution
that we were dreaming about so it seemed
it's been really good yeah it's only
version 0 points 12 but you know what
can go wrong and so what we did is yeah
like let's go with react and react was
kind of like I suggested by the
consultancy that we have because what
you do when you're starting start to
build the Gateway you
consultants obviously so what is the
architecture ended and the design of
this particular thing so because we were
expert in doing stuff in Ruby and we
know that we cannot have a client site
which is a place where clients go and
configure that their API and we have
back end which is the gateway we thought
okay you can build one thing in Ruby and
that's going to be fast because it's
only like few forms and the main the
main part of the of the development can
go into air lankan to the Gateway so
basically that's what we did and the
front end application is in is Andreas
and that's actually pretty good but
interesting is the back end so basically
we have like many nodes many outs and
every every consultant that goes into
this project says well you have like
many hours because for for everything
almost you have like a separate note
work for every like a logical part of
the application basically that's a
simplest flow that you can have one ml
that is centered the Gateway so when we
have this user done and he text text to
there and he's taking part of the lesser
itd competition and they say like text
us one and we're going to win something
so what we do is what he does is it
takes to the operator one the shortcode
like six six six and operator sends us
smtp for example SMP smtp requests or
HTTP requests if it's t-mobile and we
get it on the operator node and then
it's rooted than the message is
acknowledged and routed through their
node then we do some some checks using
the counter note because we have a
separate note that is checking if this
user is actually not spending more than
he should and that's another requirement
if you're working with operators you
have to you have to comply to like
thousands amounts of requirements for
example
cannot spend more than 1,000 pounds a
day yeah using the term over and if you
will not comply operators will be
unhappy with you and if you are an SMS
gateway and operators are unhappy you
are well your business is in danger and
so what happens now when from Rueter
there the message goes to client node
and the client sends the request to D
the application yeah but what's going to
next what's going to happen next is the
application that is handing like outside
of the gateway the traffic's going to do
some stuff and maybe trigger a request
to send a 92 this user and so how do we
handle the communication between the
nodes well everyone everyone's going to
use queues yeah that's the simplest
solution and we did we use the cues but
the consultant that we had was kind of
like against rabbitmq I don't know why
so we decided to run we decided to run
with our own pues yo exists them and the
argument was like you know the rabbit
and Q is not reliable can like drop
messages you can have time out you know
what happened when we when you alter our
own queuing system we have timeouts like
drops of messages everything yeah but in
the end you know we managed to do
everything correctly operator notes so
basically because we want to have a
fault-tolerant system for every single
operator we have at least three nodes
and because when you work with the
telecommunication operators they're
going to say to you for example we will
give you only two barns and parent is
the the like kind of like a connection
to the operators but there's also
something which is called a connection
and basically they're going to say we
can give you only two barns and most of
the operators will work with the smtp or
HTTP protocols and if this happens you
are limited you actually can have seven
operator notes but you're limited to two
barns and that limits how you can be how
false torrent you can really be in terms
of
physical box is going down we have
clients note so we have plenty of
clients notes and most of the API is
delivered by HTTP some of the API is
delivered by smtp because you know some
of the people wants to implement smtp in
their applications and the other type
types of the notes that we have our
counter nodes and callback node so cal
bak note is the note that is sending the
dr's to be clients that they dilute the
delivery reports basically whenever we
get whenever we send the mmt of the
message so the client scheduled are in
our API to send them a message to a
particular phone when the phone receives
the the message the operator sends the
delivery report to us and we sent the
delivery report to the client that's
actually pretty important because we
deal on successful message the message
that we successfully delivered
deployment and distribution so how we do
it is I know it's going to sound scary
but I'm going to say it we use
Capistrano for deployment and it worked
really well for us we offer many
physical boxes and the problem here is
that if you're working with operators
with this kind of scenario you cannot
ever have probably continuous deployment
because you cannot lose any single
message and that's that's a really big
risk if you're going to say to anyone
well just going to lose like one message
they're going to freak out because you
know if somebody if somebody especially
premium is it premium message it
messages if somebody's going to lose
money then they don't they just don't
want to do it they're going to go to
competition and competition is going to
lie that they gonna deliver all the
messages so then early life of the of
the Gateway was brilliant we deployed it
and it was working nothing really broke
we had some problems in style but
actually that was a lie a lot of stuff
bro
and first because we were first
initially we thought okay we are using
like early version of react and the time
also okay but and we did not have any
notion of throttle q so the concurrency
was unbound react well Airlines going to
go going to give you the tools to build
best concurrent software but will not
save you from doing bad stuff yeah so
even if people who say that you can have
unlimited number of processes that
that's a lie every team has a limit and
if you're going to reach this limit he's
going to start to swap and you will have
problems so you have to be aware that
there are some limit and what we what we
did next was like you know we really
have this scenario of vector clubs well
we can disable them it's going to go
faster yeah so we disabled so we disable
vector coxon react and that actually I'd
like to corrupt the data and vector
clocks with react works in a way that
and when you have a data that is
possibly corrupted you need to resolve
the conflict on reading so why to
resolve the conflict well if we can just
use the most most recent data in real
well that that is a problem and we have
to reenable later on vector clocks and
first we start to do the big plan and we
wanted to have a multi data center
replication and multi data center
application can really go nuts
especially in react you have two ways of
doing it one is it's going to do it
every chunk of time by default is every
three hours I here and one is the
continuous continuous continuous
replication so both of them will include
introduced latency at some stages and
what we would what we have in SMS
gateway is quite specific because we get
a lot of messages and they're like
estimated time to live in inside of the
gate I usually like very very short but
that said without react we would not be
able to deliver this product react is
really
amazing but you have to be aware that
there are some problems so well how do
you tackle the problems initially you
think you think okay so we have the time
out so what we're going to do by in
react well the button for the reactant
we used was called bit cast and boot
cast is using is simply writing to a
file line by line in every now and then
he's doing a merit and so what we
thought yeah if you are using normal
disks if you're going to swap them
versus these then match would be faster
you have many files it will be faster
and we use the numa known unified access
memory well it was like you know those
cool because it felt that it solved the
problem but it really masked the problem
for some time we we had we had it
running and nothing broke but later on
when we got a bigger volume the problem
return so what we what we have to do is
we have to drop our idea of round
repeating the connections to react and
having many cues to simply have a 1 q
and develop something which is called a
throttle q which will simply fossil the
amount of messages that's going to go
through it and that's really cool
because that actually sold everything so
another problem that we had was smtp is
the protocol that operators love and
well it's not reliable so sometimes take
on it sometimes you will have to do p
case sometimes you will have drops and
this is this is the education you have
to like you know you have to draw a line
and you have to decide what i'm going to
do in edge cases if i'm going to do if
i'm going to have duplicate messages or
if i'm going to drop the messages so
what do you prefer to be double billed
or triple build or not being built so
this is open like you can even today so
in each case is where you're not going
to get a knack but you actually are you
going to get like some sort of like
thing that looks a Mac like like a knack
well you have to like drop the message
and you know somebody would call the
customer support and there will be like
okay who don't wasn't pregnant those
those that problem yeah the bigger
problem is because the operators gets
angry when you double view people so we
were at the point at this stage we were
at the point that we still have reacted
zero point 12 and everything felt like
you know it's it's going great so so
let's try some different stuff to solve
the problems and let's upgrade the
reaction will happen this happen so we
upgraded react from one point to a phone
from zero points 12 to 1 point 1 point 2
and and we started to see a strange
behavior because you have like because
the Gateway works in a way that you have
spikes of traffic yeah between between
8am and 10 10pm you're going to have
really big spikes of traffic and then
you can going to have four or six hours
of almost nothing happening we well at
night we have only Australia working but
they're they're not generating like a
lot of traffic but in Europe you have
like amazing amount of tracking during
the day so what happens is ellen has a
scheduler and I think this problem was
not existing in the previous versions
then there are 15 but in our 15th for in
react he was like going so basically we
had 12 12 12 cores for every machine so
he was like maintaining 12 threads in
beam and then when at night the traffic
was like shaping in a much smaller
manner it was not like vanishing and she
was dropping to one thread and when in
the morning we had like another wave of
really really high traffic scenarios he
was not waking up properly so
we had some like false about it and we
were like looking looking how we can fix
it and what's happening and that was
like that was really crazy but we found
out that there is that flag and there's
like somebody internet if this this pics
which is is Z dnf gpic which is like
never go to sleep and then when
everything was set up and everything was
running yeah you were happy and yoga is
running you're adding features
integrating international operators
everything is super you love this
situation but then after like two or
three years you actually are asked to go
to a backup books and dig out something
and then you realize that you have a
other folder where you were backing up
all the logs and you generate a building
block every a second and you do LS in
this folder and you just crush the box
yes that does does the things that
you're going to have regarding the
maintenance of of your applications and
this is actually the last last part of
the the top that I want to give but in
my opinion it's the most important
things that you should happen enlarge
we're in your in your application
because we would be able to skip a lot
of a lot of problems like not knowing
the size of the cues like properly and
knowing that having like many q's is not
only the best idea for the same thing if
we would have like proper locks so
initially if you're going to look at the
like reyes logs where we were used to it
if you're looking at Ray's logs as a
race developer you see you see this yeah
and when you're a developer it's quite
nice because you'll make different
learns everything is there but if you're
having like six seven gigs of logs a day
looking at this for every request
gripping this it's not really what's
really possible so what we almost done
in buzzer was that every every
singsing every single event in log is a
log is alarm yeah so you have a time
stamp you have a type of the event and
then you have the params and this
enables enabled us to use different
tools to aggregate the logs yeah so we
have this like great experiment because
if you have logs in your application you
want to have like them in one place yeah
let's say you have like 11 boxes and you
want to have you want to have all the
operator logs from all the boxes all the
Rooter loads or the only counter notes
everything in one box so you can like us
search it and it's it's it's searchable
so what we did we installed the log
stuff in every box and then we started
to accumulate them and generate looks
like basically generating indexes
program so after one day we have 12
gigabytes of indexes for our logs I was
roughly that the number of the log that
we had was not really the best and the
log stash was eating all the CPUs on
every box it was not the best if you're
if you're trying to keep up with the
load on your gateway but it has a
recognized tool that you can use which
is called Qabbani and see the stuff well
it's going to kill your gateway but the
logs will look pretty amazing so we have
to we have to have it we have to have
something that will enable us to to see
the traffic to see I would stroke so
what we did is we used hecka d or hecka
and graphite and that actually worked
amazing for us so basically hecka is
like we r it is a demon which is written
in go and when we deployed this to what
we parse the logs and send them to
graphite that was like no almost no
footprint on the system just actually
does actually a really big surprise and
graphite so we deployed graphite because
we thought okay let's let's try it out
and previously previously before we did
it we went to a meeting in London where
the guy was talking about like mega
those I think partial meeting mega d
comments or graphite with the rear
parking and we were like okay let's
let's try it out in small scale first so
we deployed two instances instances of
graphite and started to string our logs
parts to graphite and that actually that
actually one box was actually enough to
do it and then we started to generate
statistics traffic statistics based on
on the traffic that we can see in
graphite and in graphite you can see
stuff like you know we can say okay last
15 minutes last hour so what we started
to do we started the generals alarms
based on this we started to do statistic
based on this and that's actually really
also really important to her so they
conclusion from from the talk is that a
light is actually pretty amazing and if
you're building anything that is that is
like requiring you to have like a big
traffic I think alike currently is
probably the only solution to go well if
you want to have something that is out
of the box react is also amazing but you
know you always can face the problems
that that you're not aware like out of
out of out of the box that it can have
and what we did at start with what was
like AB idea is to keep react nodes and
application notes on the same physical
box that's not the best idea because
when because in inside of the gateway we
use a bit gassed to start the study data
some local data like a local read
reviews and stuff like this and react is
using vidcast on the on the on the box
so when they both start to merge you can
have a lot of descriptive descriptive
you stand some problems
thank you very much yes so we have we
have the support we bought the support
in Labasa and we are using a partial
patches and we again surprised how
problems or a well well for us for a
free hudson proper from some problems
with the initial implementation so
because they're the main cluster so
currently how this set up now is we have
two clusters to react clusters and we
have their application going on but
let's start the first the main cluster
was having timeouts so that that was
leading to replication being slow and
replication being slow was leading to
latency like in the main cluster so we
we have to disable the replication and
start because we fear that it's going to
be a problem that it could cause a
problem yeah well initially we were
trying to use different stuff to
actually find out what is the problem
yet the program will stop we have
unbound concurrency and you cannot you
know generate insane amount of processes
in airline and just leave them to to do
stuff you have to have some way of
scheduling it and doing it on your own
so basically on the on the on the
Gateway side we had a way that Esther
and this which was like a physical
person testing functional if the Gateway
is the gate is okay and we have the
unique tests for the Gateway written in
EU need for alarm and that was it so
basically we we had a comparison that
was checking checking the Gateway
like so yeah we did we did the
performance testing and the performance
testing was done but the performance
testing they behave differently than
production environment so basically you
can say okay we do a performance testing
and we can we can eat 20 million
messages per second yeah and that's fine
you go into production you have 5
million messages per second 48 hours and
then you're like okay if something is
going wrong or you have like spiky
traffic yeah so maybe maybe our stress
test we're not super perfect but
initially we we did not thought that
this is a problem and if if I can speak
like today today I think the Gator is in
a state that there are no performance
problems more problems that we have is
is that there is a complexity in terms
of implementation of the rules behind
the what operators wants from us and
this sometimes implies that you need to
have some extra data in the places that
you don't want to do and you can have
messages that goes around the system and
are in a really bad stint well we have
we had this issue where and one of the
operators had our client with a broken
with a broken hand set like physically
broken hands on some of the our client
was trying to send well it was different
it was broke it was a physically broken
hand sent but he was trying to send a
memo from it and this operator was
trying trying to retry this mo to
sending this the same MO the same mobile
originated message to the Gateway every
second even if we act that we got it so
he was trying to like repeat the process
like all the time so that was putting
the stress
on the Gateway well not a lot but that
was a problem that you cannot really
find if you have a even even if you have
a test area and this kind of problems
happens all the time recently we had a
situation with an empty empty where the
clients would kind was trying to send an
empty and that was to a ported number
that ported many times and none of the
operators were actually saying that it's
us yeah so empty was like circling
inside of the gateway because every
operator that we support said like it's
not us and we support all the operators
in UK and it was sent to a UK UK number</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>