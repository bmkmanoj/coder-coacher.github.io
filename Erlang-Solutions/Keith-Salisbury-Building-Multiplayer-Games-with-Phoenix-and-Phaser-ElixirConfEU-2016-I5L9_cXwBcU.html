<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Keith Salisbury - Building Multiplayer Games with Phoenix and Phaser (ElixirConfEU 2016) | Coder Coacher - Coaching Coders</title><meta content="Keith Salisbury - Building Multiplayer Games with Phoenix and Phaser (ElixirConfEU 2016) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Keith Salisbury - Building Multiplayer Games with Phoenix and Phaser (ElixirConfEU 2016)</b></h2><h5 class="post__date">2016-05-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/I5L9_cXwBcU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hi thanks very much so I'd like to play
just a quick game with you for a few
seconds just at the beginning to get
your minds thinking about play so I'm
going to show you a picture and if you
know what the pictures from shout out
the name of the game so if you start
here is anyone know someone over here
CityVille what oh okay yeah okay yeah
you guys are good this one it must be
some older Q yeah Mary oh yeah
easy easy one last one clash of clans oh
one more sorry
please playing this yeah okay so I'm
here to talk to you about building games
multiplayer games using Phoenix and
phaser my name - Keith okay tech on
Twitter so if you want to I've just
published the URL of the github
repository that I'm gonna be talking
about through the talk so if you want to
find the link you can download that and
follow through so I've called this lot
the fun step because it's actually good
fun to play with to build social games
so I just quickly presumably you all
know what Phoenix is we're here at the
elixir conference so what makes it what
makes Phoenix powerful is the fact that
it sits on top of the shoulders of some
joints one of those sorry
so Phoenix does come with really great
documentation and tutorials so that
really makes it easy and quick to get up
and running with it and it's very fast
so it sits on the shoulders of elixir
and we're all here for Alexia so we know
what that is and on top of that we've
got Erlang so that gives Felix that
power phaser has a similar kind of story
it stands on the shoulders of some
joints it doesn't do all the work itself
and it comes with again amazing
tutorials and great documentation which
makes it really easy
fun to get up and running so it uses it
sits on top of the pixie JavaScript
rendering engine which is super fast
and then that sits on top of html5 which
has been a long time in the coming but
it's it's finally really here in the
browser support and stuff so and what
we're going to focus on a lot today is
WebSockets so I just quickly run through
some of the features that make this
really what I wanted to play with so
obviously Phoenix is very fast and
scalable it comes with channels built in
and it comes es6 ready so you just
install it and it's ready to you can
start writing ef6
which is a lot nicer than writing es5
obviously on top of that we've got
Alexia we've got the meta programming
we've got the toolings around Alexia
which make the whole journey really fun
and then on top of that Wieck we're
deploying to the Erlang VM which makes
the system straightaway scalable so just
to quickly show you about pixie so pixie
is super fast and I'll give you a quick
demo here hopefully here so here's a
couple of bunnies this is a this is
running in the browser here here's a
couple of bunnies running around here's
a few more and a few more and a few more
and we're still running it like 60
frames a second you can't really see it
there but there's a lot of bunnies there
and we can just go so I didn't like that
so there's no need to applause me it
also comes with spritesheet support so
spritesheet enables you to demo I don't
know whether it's going to load if not
well that's gonna be really slow so
sprite C enables you to have a bunch of
graphics and then it will rap that it
might note everyone's use everyone stop
using the internet for a second
now Afghan texting them oh don't worry
about it I'll show you some cool stuff
anyway sir
moving on so fader sits on top of that
and phase it gives you a bunch of game
kind of stuff that you want it gives you
pre loading so you can preload a lunge
about a bunch of assets and it will
manage that for you it gives you
multiple physics engines we'll see with
any of these are gonna load blanks not
looking good
so these are all of the all of the
examples on phaser it gives you the coat
down here and then the example it's just
running up there so that makes it really
easy so here I can run my little
character around and this is using ninja
physics which is a cool name in itself
it will support tile map scale managing
it's it's aimed at delivering to mobile
platform as well so if you want to build
a game that's going to work on on iPads
with multi-touch and stuff like that
it's quite a big challenge but it's
designed for that so I'm just going to
show you some pointless social status
just for a bit of fun so if you look at
github on their showcases page phaser
comes out as number one JavaScript
gaming engine if we look at Richard
Davey who created it
he's got nearly 16,000 followers if we
compare that to Jersey
it's got 25 thousand followers but as we
all know JJ's not on Twitter anymore so
that doesn't count
so if we get hub instead base has got
like twenty twelve thousand stars if we
look at Lexia it's doing very well for a
small you know a new project we're
already up to seven thousand but if we
add to that the Phoenix project of
another six thousand and if we add OTP
as well we're actually doing really well
and if you compare that to html5 spec
anyway so so I'm going to show you some
code so be warned I'm using a Java
Script oo library so I can't really do
this talk without showing you but a Java
Script if you really hate Java Script
which a lot of people do just look away
so what we're going to do we're going to
build a hello world just simple starting
HelloWorld will create a Phoenix project
will install phaser will create a game
will update the HTML to put the game in
the page will start the server will
create the state to put the game in to
put the hello world to text in we'll add
the text and then we'll make it
draggable sound good
okay so if anyone who's used Phoenix
hands up yes
loads of people okay so we just create a
new Phoenix project new demo will
install phaser so to install phaser will
download the Java Script library and put
it in the vendor folder so we'll put it
in there so that brunch doesn't try to
compile es6 so then we need to create a
game class which is going to contain our
our game it's got a width and a height
and a container which is the HTML
container we in the app deus file we're
going to import our game class we're
going to instantiate it create a new one
with a width and a height and then the
ID which is the element ID and then we
will go into the templates that phaser
phoenix provides you and update the
index page get rid of everything that's
there and just put in a single div tag
with an ID of phaser then we start
server and bang we've got a blank page
bo wait it's okay if you open up the
console you'll see that phase there is
absolutely IMing and it will tell you a
little bit about the capabilities of
your browser that it's managed to detect
so it will show you your running phase
it will also show you what version it
will show you what version of pixie and
also if you have web audio or any other
forces features html5 features it will
show you that so where's the hello world
obviously that's what we've promised
okay so before we jump into that we're
just break step back and look at how
phaser works in terms of building a game
it breaks it up into state so it's like
a state machine so it enables you to
have like a loading state a menu state
level one state for example and it just
enables you to compartmentalize your
code so we're going to create a
directory for that and then we're just
going to create a lobby state that's
going to be where we're going to render
our hello world text so we'll create a
label and I like to use modules external
modules I've fought really hard to make
JavaScript declarative as much as
possible it's been a real struggle to
learn about that but I'll talk to you
more about that later
the so we'll create a label and then
setting the anchor just puts the
registration point in the middle so we
can move it we can move it around so
that's our lobby state this is the
create label function which is basically
just going to create the text in the
center you'll see we're extracting the
center X and one so here in our game we
need to import the lobby state we need
to add it to the game and then we'll
start it so straight away banging there
we go hello world that was easy
but wait we can do a bit better than
that let's make it draggable so to make
it draggable we literally add imput
enabled on this on the label and enable
drag on the input and there we go boom
got a while to go yet okay so what about
what can we do next
well the reason we're here is the plug
Phoenix together with phasor so let's
make it synchronized text so this is
where we get into Phoenix channels this
is where the fun really starts
so Phoenix builds its channels on top of
HTML x2 mol file WebSockets and their
multiplexer you can have multiple
channels they come built in ready to go
really easy chris has done an amazing
job making it easy for us and they're a
synchronous you can send communications
back and forth in the same direction so
if we use the generators that Phoenix
gives us will create a new lobby general
and then Phoenix will suggest that we
should add that to our web sockets so
this is the code that Phoenix will
create for us and things I want to point
out that arrow should be live at home is
the topic so it's called games lobby if
we authorize okay it'll return us and ok
and then finally just to keep in your
minds we've got a handler called shout
which we're going to use and all that
does it's a broadcast whatever comes in
to everyone so in the user socket we're
going to add our channel as as Felix
told us to do and then in our update
we're going to import the socket from
Phoenix which is the socket class that
Phoenix provides us we're going to
create an instance and then when assign
our game to an instance and then pull
games start and pass it the socket so
now the game we need to update it so
that it can accept that socket and the
first thing we're going to do is connect
the socket so as soon as the game loads
and starts it's going to connect the
socket we actually want to do a little
bit more than that we want to create a
channel so we'll use the socket to
create a new channel called games lobby
we'll import another helper function
called joint channel joint channel is
going to give it the channel and then if
we successfully join we can start the
state so we won't actually go into the
game state until the channels
connected and then finally we're going
to pass the channel into the state so
that it's got access to that state so -
sorry - the channel so that it's got
access to the channel so it can
communicate so first off we're just
going to in our lobby state we're just
going to log out the channel just to
make sure that we've got it
and then my joint channel a helper
function here is literally just
providing me with some some default
which will log out constantly
logout errors and stuff like that so
here you'll see we're all up and running
we've got the state loaded and we've
actually got the channel connected down
here so we know that we're in the state
and we've got the channel this and now
we can talk to the server this is great
so we're nearly there
what we want to do now is when we drag
the text and drop it let go we want to
send that message somewhere or a send a
message somewhere so first off instead
of logging the channel we're actually
going to store it in the class and then
we're going to make the label that we
created we're going to make it a
sinkable label so we'll create a helper
function and pass it the channel there
and inside this sync label we're going
to create the label as we did before
with the enable drag and we're going to
call another function which is going to
enable us to seat the position and we'll
pass it in the event that we want which
is on the drag stop
so phaser gives us a lot of events which
we can use so in the sync position we're
just going to add the event which is
there on drag stop we're going to call a
function called send position and right
in same position we're just going to log
out a serialized version of the sprite
so we don't want to send the whole
sprite we just want to send the x and y
so inside our serialized position we're
just plucking out the x and y and
creating an object that just contains
the X and one so here we go
so you'll see here we're now logging out
the X and y so it's obviously not
getting sent across because I'm not
actually sending anything so we're ready
to save
so rather than just logging that message
let's assign it to a variable we can
then still log it out but we can now
push it up a channel and we're going to
use the Scheldt Handler that I mentioned
earlier on so here we go and you see
nothing happened
so what that means is we haven't
received the message so we've sent it
but nobody's listening so to receive the
message in our seat position we're going
to add another function received
position and here we'll use the Phoenix
Channel helper to when we receive a
message on shouts will receive a shout
message we'll just log it out so we'll
try that again here now you'll see that
we're receiving but interesting me we're
receiving it on both sides so what that
means is that in here if you remember
this we're using the shout function and
it's using broadcast so that broadcast
will send it to everyone and that
includes you because you're you're in
the room as well we've got another
function called broadcast from which
we'll send it to everyone else which is
a nice really nice useful thing so what
we'll do is we'll create our own handle
this time call it position and we'll use
broadcast from rather than broadcast so
now we need to update our
synchronization stuff so that we're
pushing rather than pushing shout and
channel on receive shout will push
position and then we'll so here you'll
see it's jumping back to the thing which
we keep joining the channel what happens
there that I've done this quite a few
times so this is why I've left it in
here is what's actually happened is that
the the server is crashing and it's
because we've updated the code but it
hasn't reloaded so if you just restart
the server you'll see that we're sending
the message there we go so we've sent
and received so now it's just a case of
updating our codes so that rather than
just logging out the message we pluck
out the x and y-coordinates and set the
sprite position
x and y so here we go boom this is good
okay but wait we can take better than
that let's let's change it to the on
drag event that's a bit more fun so
sorry so here we just changed the drug
stop to drag update and there we go a
bit more fun okay we're starting to get
a bit more interactive and here you can
see it's sending bucket loads of
messages backwards and forwards so let's
just add some juice to that so here is
this it's just me playing around with
some ideas and here you can see I've got
unrolled over there and multiple things
and they were all synchronized when we
get in so the performance as soon as I
plugged this together I was like wow
this actually works really well it's
really nice okay so there's a problem
with what we've just designed here so I
call it the client-side state problems
so if you see here on the right hand
side we've logged in and we've moved the
hello world and we just logged in as
another client on them on the left hand
side but he didn't get the update until
the until until somebody moved it again
and we actually synchronized to
synchronize the position of the hello
world so what's actually happening is
that the state is being stored inside
the client and not on the server so when
you've login you don't know what the
state is until somebody updates it
so being good Alixe theorists we know
that we can use a gen server to store
state on the server but this is our Lang
and OTP say we could probably do better
and use it as supervision trees I have
created Felix
fazer demo which is up on github and you
can go and check it out and I don't have
enough time to run through building up
to supervision trees and stuff but this
is all here so where we got to with
synchronized text and I've created
branches which walk you through building
up to having
Supervision trees working so first step
is creating an identifier for each user
so I've created a branch that will will
identify them and create a token for
each user and then we want to enable
multiple channels so that when we're in
the lobby we have one channel when we're
in the game we have another channel so
then you don't get messages for the game
when you're only sitting in the lobby
and then we want to use dynamic
processes and supervision trees so we
can support more characters on the
screen so this is the the next level up
and then finally what I ended up
building just as I was preparing for
this tool was a little version of
rock-paper-scissors which looks
something like this so we're in the
lobby now and how here this guy's has
moved into the game so he's now
connected to the game Channel now
they're both in the game channel and so
the triangle beats the circle so here
we've got physics and each character is
sending his position to the server each
character is actually a process so when
you log in it creates a new process and
then that when you move around you're
sending messages which get updated in
the process where your position is so
any other users will see your position
so that's available on github K Tech
Phoenix pays that demo so if you if you
want to play with it play with it go for
it gets that you know cracking with it
and give me feedback if you find
anything difficult whatever so we've
still got a bit of a problem here
and I kind of call it a message flow
problem so here I've got one I've got a
server this node here as a server and
then I've got one client connected so
when the client sends a message to the
server if you imagine we're not using
broadcast from we're just using
broadcast soliciting
when I send a message it will send a
message back if I have two clients
connected when when they each send a
message to the server and the server is
going to send out two messages now if
I've got three it's gonna send out three
messages if I've got five it's gonna
send out five messages can you see
what's going to happen here and I kept
going with this because it's quite fun
so here so that is a hundred but wait I
didn't stop there and this is 500 so
here this really highlights exactly
what's going to happen which is this
green stuff is that is the flood of the
network so with 500 connected clients
that's it bang we've we've flooded the
network so there is a problem there so
even Alexi and Ola and Erlang is not
it's not fast enough to cope with that
so we need to change our architecture so
and obviously using broadcasts from it's
just going to remove one of those
messages so however I have some ideas
about this but it's still sort of
research at the moment which is to
basically make the server pulse so that
so it will collect data coming in from
the clients and that will update its
state and then and then based it on a
specific frame rate it will broadcast a
single message to the to the clients
with all of the state that it knows
about so I haven't haven't really
developed this yet but that's what I'm
thinking about so I've got a few demos
to show you that I've been messing up
and messing around this for like six or
seven months now
so the first one and if you've got
laptops feel free to grab your laptop
and go to Rox global peace calm I don't
know how stable this one is because I
built it those No
so this is the rock-paper-scissors game
so here you can see people are on there
already and if I click here will it even
let me in okay so you can see it's
struggling to cope with the message load
if we can eat that you I yeah so anyway
that's that one that's that's really to
play with but I'll keep up great I'll
keep updating that the next one is if
you get a dots global Keith calm this is
another one that built and hopefully
it'll load
I didn't realize the the Wi-Fi would be
safe has anyone got it loaded up okay
but so get a load so this basically is
those building I didn't really know what
I was doing I didn't really know phaser
and I'm I'm not like an expert with
elixir I didn't even know elixir like a
year ago so so this should hopefully
load a character here we go so this is
me I'm the little floating character
each one of those guys is a process
running on the server and then somewhere
around here is some little elixir drops
and those are those are all processes as
well and if I go over and pick that up
it should so the collision detection
isn't working so I'm trying to requite
as many people but yeah it's not working
yeah it's just not very poufy but yeah
that's like that's up there anyway and
then the final one which
see I love it yeah we need better Wi-Fi
whoever may be good so I'll load it for
anyone else right so this one's called
snake doc global peace calm talk about
yourself or say okay
yeah no they're not working
no well this should be multiplayer snake
but feel free to try in your own time I
would persevere with this because it's
clearly not working very well but you
can try it on your own time so anyway
let me just talk about what I'd like to
do in the future so this has been kind
of an ongoing experiment that I started
back in September last year and then I
just I keep uncovering things and then
realizing that the mountain goes higher
and there's more things to learn and
more stuff and whatever so it's a it's
an ongoing journey one of the things
that I've done recently Brian Joseph has
been writing a project called elixir
script and we got together and did a bit
of pairing and basically knocked up a
little demo using elixir script 2 so
rather than writing the JavaScript in
JavaScript are used it we used ellipsis
script and he's done a lot of work
implementing things like agents and the
full alexia stack he's really you know
done some amazing stuff so we kind of
played around with that I haven't spent
a lot of time that was literally only a
week ago but we got a hello world which
is great we're really pleased about that
so when I get to the time I can I want
to focus on that one of the other things
that I've spent a lot of time learning
this year is how to write declarative
JavaScript rather than imperative so
rather than having state inside all your
objects and using classes there's a lot
of really amazing work being done to
make JavaScript functional and if you
can bring those ideas in that's really
what I what I want to be able to do it
is use those ideas so two of those is
RAM to j/s and kefir and then there's
also elm which and there are a few
people have been looking into of no idea
I mean that's another thing I have to go
and learn to be able to work out how it
all fits together and then something
else to have in mind is to once a
formalized these ideas about what makes
sense and what's useful is to create a
hex package with some generators to be
able to get you up and running really
quickly and then obviously Phoenix
presence is the new thing so I've done
little demo but it didn't work very well
moment because it's I'm still trying to
understand presence and then work out
how that fits into into this but one of
the ideas is to create a high school
board using presents so and then on top
of that there's loads of stuff to do
with gamification so those games that I
showed you at the beginning they're
flooded with using gamification
techniques using challenges and virtual
goods and leaderboards power energy or
stuff like this so I really haven't
focused on any of that because I've been
trying to get the fundamentals to to
plug together and then obviously things
like authentication signing up using
Twitter and then suddenly you can play
with all your you know Twitter Facebook
friends or whatever and then as soon as
I started this project Richard decided
he's going to upgrade phaser and call it
laser so I mean that's still a long time
in there in the future he's done a lot
of work with it but so who knows who
knows and then there's lots of other
JavaScript libraries that kind of give
you you know this kind of thing so it's
so I started I was telling Lerner here I
started writing a book back as I was
doing this and as the journeys gone on
I've come a long way from where I
started writing the book so a lot of the
research that I've done over the last
couple of months I need to go back and
re upgrade the book and get that to a
shape but I'm it's in the works and it
will come at some point I'm quite slow
at writing books so anyway that's me
thank you very much for watching
okay yes that's great that's really good
it's something that I've been learning
about like I didn't when I started this
I didn't anticipate needing to learn all
these different things but as you kind
of find a problem you need to go and
find out how other people have solved it
and so yes definitely that's something
thank you for the suggestion
yeah so I took a little bit of
background on that when I went to Austin
Texas for the Alexia conf I stood up and
said right I want to be doing a lick see
a full time I pledge that I will be
doing a literally a full time by Berlin
which didn't happen but I am a hundred
percent remote now so in between jobs I
said I'm only going to work behind
percent remote and in between those two
jobs I was able to do a lot of progress
with this and I'm now working at my new
job I've agreed only four days a week so
I've got a fight so I've got an extra
day to work on my own stuff which is
great
so I've constrained because there's so
many things to learn
I've constrained my view of the world
down to this right now just because I'm
trying to get that is a bit like they
were saying with credo I'm just trying
to get this up and running to a state
that I'm happy with and then I can look
at you know outside of outside of that
ecosystem because if you if you lose if
you're brook focus is too broad you
can't really achieve so that's what I'm
trying to do at the moment
possibly and that's yeah it's something
I haven't even considered so I've been a
long fan of Java so yes all will check
afterwards and all them I'll see if I
could add that to my list of things to
look at Thanks</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>