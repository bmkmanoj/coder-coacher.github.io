<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Random choice: Bob Ippolito | Coder Coacher - Coaching Coders</title><meta content="Random choice: Bob Ippolito - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Random choice: Bob Ippolito</b></h2><h5 class="post__date">2012-07-31</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/g4JR2JwGYmA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">nobody feature
and yes the boot Bobby Pulido that's all
the Russian I know the rest of the talk
will be in English if I'm going too fast
please let me know the slides are
published online so you'll be able to
look at them later on if there's
something thank you Miss
so why I talk on random choice well to
be honest I was rewriting an IRC bot we
had an IRC bot and mochi media who would
just sit there and he would learn from
what other people said in the chat and
so his brain was based on this
statistical model on Park off James
and these these Markov chains would be
based on all of the words that that have
ever been set so based on the frequency
that the words occurred he could build
sentences that that looks almost like
real English but of course it was
gibberish because the machine was
choosing words randomly
and so random choice is essential to
this application but also many other
applications
and Markov models were developed by a
Russian mathematician Andrei Markov
and the basics behind a Markov chain is
it's a map of state transitions so in
this diagram you can see from from the
state II there's a thirty percent chance
of returning again and a seventy percent
chance of returning a and there's also
the state transition from from a I I
don't really have time to go any deeper
into this i just thought i would show it
because it's it's interesting and so
really well what is this well it's not
just for IRC box well most ad servers
also use random choice and i'm very
familiar with with ad servers at least
one of them the the one that we built at
OG media and the most interesting part
of my research for this talk was to come
up with an efficient way to do it
there's there's many different ways to
do it and but it is tricky to find a way
that is efficient it doesn't use a lot
of memory and and doesn't use a lot of
CPU
and just a quick aside here i will be
using Erlang's random module i as a
demonstration for this talk but the
random module is built on a very old
algorithm and it's actually not very
good at all it was designed for 16-bit
computers in the early 80s and it has
bad results so if you're if you're
writing your own application that
depends on random numbers i would
suggest using the random number
generator in the crypto module which
generates cryptographically secure
random numbers although slowly but there
are third-party libraries such as a
Mersenne twister library that is
actually quite fast and relatively
competitive with this very old algorithm
speed wise but of course much better
quality
despite all this i'm going to use random
for the examples because it's built in
and it's it has a simple API
and so the the basic uses of this random
module are to generate uniformly random
numbers and and that is a number between
0 and 1 uniformly throughout the whole
distribution
and you can use this to simulate things
like flipping a coin so in this example
when when I generate a number less than
one-half I'll show heads and when it's
more than that I'll show tails
and this is just a quick demonstration
of what it what it would look like the X
at the top is the number that was
generated from the uniform random number
generator in this case it's actually
implemented in in JavaScript this isn't
using an erlang but it demonstrates the
technique
so you can see about half the time it's
heads and half the time its tails
the other thing that you would do with
the random number generator is to
simulate the role of a diet so in this
case I'll roll a six sided die very
typical that you'd find in any any
casino game or something like that
and to generate a random die roll you
simply multiply this uniform loading
point by the number of sides of the die
and truncated and you can see a simple
implementation here the the random
module does implement this
and this is just an example of what that
looks like you can see maybe that
there's somewhat an even distribution of
the different roles
and to get a little more complicated
let's say you have a set of things maybe
not seidler to die but some set of any
elements one of the basic algorithms you
would do is random selection random
selection without replacement means that
once you choose the item you remove it
from the list so let's say like names in
a hat or something like that and then
this is a simple version of that
algorithm in Erlang the the code is very
simple not too interesting
and here's an example of how that might
look
and so at the at the bottom you have the
list of elements that it's choosing from
and at the top the selections that that
were made you can see that
each each element of the list is chosen
only once so essentially what we're
doing by choosing all the elements is
shuffling the list
and the other thing that you would do
that's very similar is random selection
without replacements
and what what you do here is are they
this sorry this is random waited random
selection without replacement this is
just an example of the algorithm I'm not
going to go into it but basically you
take for each element of the set you
also give it a wait and then you lock
the list until you find the element that
is that part down the list
and so
an even simpler algorithm is a random
selection with replacement so this means
given the original list you simply
choose an element from it without a
mutating the list at all if this is the
same as rolling a die
and here's an example of what that looks
like we have our list with six elements
here each time I select one the list
remains unchanged and so I'm selecting
them randomly you can see that i'm
getting the same results more than once
and so to implement this algorithm this
is the algorithm that that is used for
things like Markov chains and post often
in ad servers so with with replacement
the weight can be implemented very
simply the this version you just add the
item to the list multiple times so in
this list I have a three times B once
see once and D ones
and this means that half the time a will
be chosen and about seventeen percent of
the time each of the other elements will
be chosen
and this is what that looks like you can
see I have three snowmen so they'll show
up about half the time
okay maybe maybe a little more than half
the time but that's that's what random
numbers are so this time we see it's
more more like what we would expect but
because it's random you you can never
know what the results are going to be
only that if you generate a huge number
of results than you expect it to look
very close to the probabilities that you
gave it to be given
the problem with this solution is that
it's not very memory efficient so you
can see in in the previous slide I have
the Snowman there are three times so if
you imagine a million snowmen in there
you have a very big list so you can do
better by Counting each key uniquely so
this is a representation of the same
data but I have as the first element the
the total the total count so a was there
three times b1 c1 S&amp;amp;D ones so the total
is six and then you can see each element
with the number of times that it
occurred
the trade-off with this model is that
it's harder to seek to the nth choice
with the previous algorithm we can just
simply go to that that index in the in
the list or the array which can be very
fast but in this case we have to walk
through the the whole array too or at
least some subset that could be as large
as the whole array to find it
and one one clever way to do this is
called the alias method and the alias
method combines the technique of rolling
a die and then flipping a coin
the interesting thing here is that it
uses a only o n memory but it also has a
one selection so you can generate a
selection using this kind of data
structure with with only one step it
completely independent of how many
elements you have
and here's an example of what that looks
like so first first you you roll the die
to see which element in in your table
you you look for and then you flip a
coin to see if it's the the left or the
right
so first we we see that that the the die
roll was the first row and then the coin
flip was was to the head the way that
this data structure is built the the
first entry is typically going to do not
have any data in the tail because the
probability is 1 if you add up all the
probabilities you'll see that they're
the same as they were originally half
half of the total belongs to a and
the
the 116 belongs to each of the other
elements
but the problem with this data structure
is that it's not efficient to handle
updates for our IRC bot the choices
update for every word of text and that
the alias method is 0 n update so when
when you update this this table you have
to go through the the whole data set and
sort it in a specific way to come up
with these probabilities
so the problem with this method is
although it's very very efficient if
your list of things to choose from is
fixed it's not very efficient if it
changes frequently because it creates
garbage of the whole set so you'll run
into problems where your process is
garbage collecting frequently
and you can work around this by using a
tree to represent your choices which
provides you with fast updates a low
amount of garbage but the problem with
with the tree is it has very slow seeps
because your tree when you walk it and
sorted by key but really you want the
most frequently chosen items to be in
first in your search so that you can
seek faster than
and the the solution that I ended up
implementing was basically a maxi how it
seems to be a pretty good compromise
between speed and memory essentially
this is just a list where the highest
weights are first on the list and the
the trick here is that the highest
weights are most likely to be updated so
when you update something near the
beginning of a list you generate very
little garbage the the problem is of
course the worst case is 0 n basically
you recreate the entire data structure
or an infrequent easy work but it has a
very good common case and it's much
better where than the alias method where
you have to recreate the entire data
structure every time
and this is a simple example of what
that might look like so I have the
character a that happened once
be that happened once I put it on the
top to minimize the amount of garbage
point
and if i if i enter a again it will move
to the top of the year so basically this
this as you generate lots and lots of
examples it'll move the most popular
samples to the top and you'll be able to
choose them very quickly
and so did to choose it you can see the
pink ones are all of the elements that
it had to look through and the darker
one the red one is the one that was
chosen this is an example of the worst
case
but if I put in a lot more times will
see that
that often it doesn't have to look very
far and in our in our data set it looked
like this most of the time
and that that's pretty much it I have a
lot of time and I have been enjoying
Moscow the past few days so I wasn't
able to put in as much effort as I
wanted to but I'm happy to answer any
questions about this talk or Ho Chi web
or anything else for you thank you
any questions
instead of random uniform here we
consider using airline behesh of ruining
my craft I mean the microwave pretty
always produces unique results and
earlyish guarantees you the limit you
want to have you need to do not float
across
well the hash algorithm actually
generates relatively few bits it may be
32 bits so in this case it's actually
even worse than the ancient random
number generator well yeah babe in that
that one I combining 33 16 bit numbers
it has about 48 bits a little less
because of the numbers that are chosen
and the other thing about using a hash
is that it's not a uniform so in order
to accurately represent these
probabilities you really do need a
uniform random number generator
better enough thanks
hi hope so my question is well at you if
you speak about showing advertisement
you also need some storage for it you
need to track each to check how many how
many times you have shown idea at in a
advert so speaking about ere long
structures there there may be some other
problems we wish you can meet during the
Rings so solving this problem so maybe
use other structures example ETS or DTS
amnesia or some other the database so
what can you say about it maybe maybe
maybe you need to adopt a Ã©tÃ© t to use
ETS structure for the place tasks and
also if we speak about advertisement you
have a lot of clients you that you want
to show in this place and so changing a
big big list may be too expensive
bye-bye memory consumption so what what
what will what can you say well say
about this problem so well with this for
a large ad network of course you would
use some sort of probably key value
stores such as pets or maybe something
more persistent with with a a memory
cache but in order to choose the
advertisement that's shown you you need
to find one randomly and if you have 10
10,000 10,000 possible ads iterating
through the mall in ed's client might be
slow and also generates a lot of garbage
in in our case it and mochi we had some
in-memory data structures that
represented this list of possible acts
although of course it's it's slow up you
updated for every client but if you
match the operation for updates its it's
not as slow
and that the size of the data structure
is based on the number of ads in the
system not the number of multiple
clients so that that's usually much
smaller
so but uh under clients i meant though i
meant that those people who pay you for
showing mine and not by visitors okay
yeah okay okay
to go to be able to chat bot here yes
the goal was to emulate a feature that
this chat but had and as far as I know
Markov assumption to evoke well for
English and not for any other language
for samsung for Russian for example he
betrayed someone some other language
models like pancreas or I have not it
was just a an old IRC bot that was built
for amusement not not for research in in
this case the the choice of Markov
chains was already chosen because we had
a old version that i was simply
rewriting for performance and education
reasons so we have years worth of data
stored in the this Markov model
second
and was that all the version make a hill
or something other old version of the
bot I wouldn't mega hill I am sorry I
don't understand that is the name of
some air support that brought uses
markov chains places actually oh no no
this this was just the off period
equation for your cutest okay this is it
was a custom IRC bot written back in two
thousand seven in python by one of an
early mochi employee thank you welcome a
significant me and other question for
example if you want to make a weighted
distribution between different choices i
currently you have shown problems with
with simple random uniform of a function
which is a known to be a vulnerable to
to a text for example but if we use a
creepy around bites we can we can get a
very very big number of data which is a
which is rather good we it is really
random and you can you can you can think
about some some mapping function from
these data for example from the from
from each four bytes of these data or
each age x 222 of this data to to some
space of your weight of your weighted
distribution and for example modular
division of some some some other
function and use creeps around bytes to
find which which which choice do you
want to you to use next have you have
you thought about it heavy some i some
ideas
yeah so the the most simple way to
convert random bytes to a uniform float
between zero and one is to simply
generate maybe 64 bits and take the low
53 bits and use that in a floating point
number and that's that's equivalent to
any uniform random number generator that
returns a double so that that's a very
simple transform their there are other
transforms that you could do that maybe
a void floating point map but the using
a double is typically the easiest unless
you do need to generate a choice out of
a list it that actually has much more
than
at at mochi we used crypto ran bites and
we generated a very big number and then
worked with it I in fixed point like
maybe we regenerate 128 bits and then
divide
by some number well actually we'd
multiply all the weights by some number
so that the weights would all be
integers
ok and now we have a short break i think
it
uh okay um thank you Bob
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>