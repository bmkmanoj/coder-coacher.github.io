<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Ruby &amp; Erlang: at Scale with Style | Coder Coacher - Coaching Coders</title><meta content="Ruby &amp; Erlang: at Scale with Style - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Ruby &amp; Erlang: at Scale with Style</b></h2><h5 class="post__date">2013-03-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/_DlTf8AhDag" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">some we have extra time before we asked
to deliver an actual system so we use a
time to fly a viet experiment prototype
stuff and really think about how we want
to build our next system we definitely
had a great time doing that and i hope
it can get a bit of us across for this
talk so that's being of who i guess not
everybody knows us yet so goodness
social games as we're going mostly
published on the facebook platform yeah
this is so one of our games that's all
monster all looks like as you can see
it's all cute and colorful which might
be the reason why women actually are
playing the video games as well actually
the majority seventy percent or
something yeah but i want to talk about
today so I want to talk more about what
powers these games user a typical
architecture overview so the game itself
is usually implemented as a separate
application when it's published on
Facebook believe you your flash
application photographs we are native
iOS ms really talks through HTTP API
through
back-end patient so this back in part is
what I focus on today and actually
that's just a bit of a glorified crap
service if you look so it provides sent
me right android api functions for to be
per game define value Jesus Jana Colson
as you Consuela because no ties to wait
for a response so we care more about the
old boards throughput of the system than
the actual likely see which is also nice
to be low so what this is what are the
responsibilities like this back-end
basically it will keep the game state
and smooth via the API calls it gets it
will change the stable object state but
also for validate if a certain
transformation is valid at the given
time so we all want to play everybody by
its own rules or actually by the game's
rules so you need to make sure that this
morning sense the wagon will also of
course persist to get your step the
scale is actually pretty interesting so
yeah that's just a high number for this
one's about a game we're getting about
40 million these api requests ones
as reading process we much a lot but
there's one website that kindly
accomplishes its its back and poles and
that's what wikipedia man you saw part
of it so that is an insane ballpark they
also have like 14 to 15 double page use
well that's the only way I'm going to
compare us to be because of this great
stuff for Humanity and we just suffocate
up in fact if you get as has a bit
easier than us because what I can do
they can catch these pages do change but
they compared to the reviews its lower
percentages and force the some walls
down to about a hundred thousand
database operations per second of which
half are actually updates so special is
not really that's what ever time yeah so
that's what we're up against and how we
only deal with it I think this is pretty
unique
candy because usually you have pretty
small teams and these are independent as
a really intended so what we got to do
last summer and we're thinking about how
we want to do our system is what every
team gets to it we can choose your
weapons freely but whatever you choose
you're also responsible for the
operations system you build afterwards
and as people will be back and I usually
also just a small part of this already
small team so maybe two or three back
and developers I think you better choose
wisely what you can run in support
afterwards this yeah everybody does what
he likes kind of thing key I lead to
total chaos but combine this with a
culture of sharing and the need to take
responsibility afterwards for what you
produce really works so it's a really
very open culture so there are no no
recourse you wouldn't have access to so
you can always
what other teams did and you can also
pay can't we use stuff but it won't be
forced to it anyway so no company night
reads favors what loss yeah so instead
of having total chaos incest actually
produce this landscape of games that are
live apparently so your teaser their
gains numbers on top and then the
dominant programming language for the
backend and be like that the storage
solutions or the main storage solutions
of games use so as you can see we had a
lot of success with Judy also Elaine
gets a lot of duction rightly see as you
can see to the right you can also meet
this a bit as the timelines are
connected up right so the most recent
one is actually they're running low and
there's this be more of my strategy type
II there are two very different basic
architectures in this landscape so
throughout varies so one is this space
up on stateless application server
approach which is very commonly all do
applications so if you have a suburb but
Lance's your request some has some
stores or database it would be responds
in until then kind of read everything it
needs to process requests from database
almost update some stuff and then
finally generate and as for the next
repress to get so as if nothing happened
before and I've really load everything
it needs to process request again and
again and again as you can see this puts
a lot of load on the database which is
also visible in the numbers like I said
earlier this is 50,000 updates so the
database can quickly become a bottleneck
and yeah when baileys becomes water like
that of course you to charting right
just load balanced on top of the rack
servers behind that and then the shared
database then one is not enough you just
use the second one that's enough a
little more should have trouble with
sharding then you're just not using
enough of it and as according to mine is
we put it famous application server
space
one pain and as the data is never very
needed but there's hope I mean if you
really look into the pattern that this
interaction is a user what it looks like
then we wrote sealers has my strong
session pattern so if you're actually
news or starts playing at a given time
then we'll play for a while usually will
help do many transformations of the sale
at the same service available in the
game state about 180 processional music
plays and then we will just stop and
play hopefully convert lightly next day
or in eight hours so this is something
you could also approach like this so
imagine you're at the server there's an
incoming request and we just load the
whole game state when it kind of spawns
up and then just keeps running and just
keeps the whole game state in memory and
will happily answer all the interactions
on the basis of the user generates which
comprises one-day session of the user
and once he's done is that let me just
don't hang back to this also done ariat
periodically in between but you can't
apply to this definitely lot less
stressful Davis so this one process
corrective user of being a stateful game
server with that whole entire game
single game state in memory and it's
the only one that can interact this is
so you have a story of transformation
and as this is one process and if you
map this dwelling and will know that
this one process will have a mailbox and
will process all incoming announced it
receives one after the other we have
been very nice concurrency control you
need not fear that to application
service would kind of access the same
same day knowing modifying the same data
at the same time to protect yourself
against that as a lobster anything we
have a nice concurrency control select
them all and as I said of did it loads
the game state based ones and rights
practice periodic VAR been entitled the
first so the user hasn't impacted for a
while and just done activism and that
definitely sorcerer overlap Foreman's
daily so if you now gain this time so
you cycle day of this operation silent
this estate all those they left purge
the stateful approach within your play
700 I guess we can handle that and this
is actually the architectural advice for
their for the Erlang back end we have
life and
you might have seen me the awesome
presentation that killed and a little
flying through this year ago presented
in the last a user preference so there's
also available online if you want a
little bit more about so architecture
and console worse especially on the
other world dig into it so that was kind
of a found when I when I came to do it
question was about to invade them put
yourself in my shoes I think it's pretty
obvious at the staple approach very
superior to the stainless this system
make sense to continue down this path
but yeah you know for small problems
really all the way and if them some
movie as I did before it also felt a bit
like giving up what so we set out to
maybe come by
well ral is obviously great for
concurrency service ungrateful or
thing's operational ruby is also great
it is much more concise expressively
sometimes I think and it's also super
flexible so you can easily molded in
whatever dsl like thing you want to to
express your program and that's
something that's really grateful
involved oh yeah this guy also kept
haunting us a bit so i'll say certainly
a kind je would also be here something
to take very close look yousa jamie
anneka right and i'm sure if you should
team what we're gonna do exactly that I
thought the time being I wasn't entirely
sure that I won't want to put up
business it would have been an entirely
new stack was development why some
people have you know that have a bit of
John weren't avionics period but still I
mean especially for our team
and also for operation so there was no
real operational experience system so
that's why we want as unscientifically
nor dislodge cheap and just try it out
this hybrid approach to growing and
movie and have just went forward
preserved and we will do this until we
get a roadblock that's just start
opposite so yeah bring two two balls
together and as I said to beat the
earning heartwood would be the one that
has these processes one pro game session
only the state so how do you hook this
up now to to Ruby you were imagining is
to just send it out to some workers
running the Ruby code so these would
then do the state transformation in a
state like the new gate estates or yeah
we wanted to couple this most flexibly
and we ended up with cereal cube in
between 0 and Q specially I think there
that claim is sockets on steroids so
what they actually out there AQ light
properties on top of TCP are on your
domain suburbs in process topologies
supported so it's really awesome hearing
a vocalist and lightweight
does anybody of you / 04 no protocol
mongrel to so the more gratuits a web
application server that has similar idea
and it would also be kind of language
agnostic in hooking up inside patient 0
cube so as this was already sorts
through quite well we just adapted the
exact same q layout so the message
format that she uses which was just
Oh inside indeed indeed it is a way has
Staters upside down as the movie workers
are still status right but instead of
having a database between behind them
they would get everything they need to
know where itís a request so good
hahaha taken sharding to the max as now
every single user kind of has its own
charm so that how eliminates the
bottleneck but it also introduces a new
muffler so the amount of data you have
to pass into the worker to be for it to
be able to do this transformation is
something you have to keep an eye on our
state of course fighting force so just
word for your friends wellness party I
could be connected to our sex SI said we
use a motor to front 0 and Q set up and
we have some early encode that would
help us generate messages compliant this
message format also help setting up as
your own huge swords and stuff it's also
given and then I adapting the Mogul to
serve we could the leaves quite a bit of
stuff that was available in Ruby nod so
there's a project for rap mogul to go to
face the modern two messages to the
right of all internists the
Oh standard or all you've got
applications to wrap survey so we just
use the common moving up framework
communities in our twenties so
essentially we were speaking HTTP / 0 Q
Q's and put a up face p and
movie-based frame that's like well so
yeah this working try to make it out in
my head so you had this estate of each
player in an atom processor yep then he
said the state was an operation the Ruby
worker that person haha a magic and then
it sends back in newsday the Alan
process yeah and Lorna's responder
automation optimization erection
medication yeah so we set out to Keaton
and it was mostly the coat so let's look
at some code gives them an example
controller as you can see it it
specifies a game actually connects the
game action to an URL pattern and in
this case as what you derive from naming
we're talking about the game where
can Shane fruity and it was always kind
of lady as a 13 say ol big strength of
groups of this talking nation massive
the corner it looks almost native to the
language but isn't so it's something
evil and it accepts a lot of parameter
stories people configured and this also
gives a pretty nice of mutation we
actually do generate orientation form
this yeah and it's the code it's
basically just just parameter parsing
and to some model so it's skinny as
controllers should be whales motor and
can't get much washing yes code and the
model in turn also benefits from a movie
in a way so you can have things like
inheritance so fruit veo can happily
inherit from a tree object or a few
class on top of their property so that
we might already have also define new
properties are also willing a
declarative fray it gathered looks
almost made it to language but it's just
us hooking up these properties
to the message that will be exceptions
and baths or defining whether it's a
spate of this real example and the
action itself is also ya understand
what's going on just incremental counter
here you can come there said some
attributes yeah so this is like really
easy easily testable right I think it's
more or less a minimal a lot pretty good
right to do it to address a bit the
thing with the how much data you sent I
can force let me say the game state is
split in multiple parts so not my
reaction I mean it's okay of state so it
might be that one part is the user want
to see the map actions that are and this
guy like Pujols so while our line does
not really care about the content of
these extra of these parts which I to
earning just some binary and in reality
they are super nice truly objects Alan
does need to know what actually needs
which part ascending the right artistry
in a ruby through the process ID but
that's also actually pretty easy so if
you look back to the follicle that
you're right you have
it's right there so actually tell says
which parts and needs to do this work so
this is really work no senaka for a
reaction I can just push this
information and Starla always darling
but the effector you need to know
operation activex useful young because
you can see that from this boat that's
true that's true that's an eagle's
something you were starting with it on
our to kind of do their and cancellation
right there also alternative approaches
i'm passing the users around so
implicitly referencing or through the
session object will get them to their
way and it what's also possible of
course is just to providing as actually
learned about running took very this
snapping at any of the kind so imagine
that you would have for a restart in the
roaring server try to be not loaded
donaga just as afraid as what we please
yeah it is really nice about their
pretty beautiful coat also deployment
weiss is really a nice thing to just
have to try the business logic is not
having to think about touching the
recession container
in storage it was also nice to scale so
you could just more more of the workers
basically and one works right there if
you would also give you the opportunity
to develop rosanna separately if you
would like to you can also just scale
from home early class movie with a cup
of workers or not no services oh yeah
the performance is also good honestly
actually there that would be a penalty
force 1 SS headedness his notes to scale
so you could just kind of put more
awkward one unless you have not wrong
yeah so so while we while we were
exploring these you still battle concept
also there the game itself to say more
and more and it kind of became apparent
that this this particular game that we
were tasked to to support rather
gravitate to two large chunks of game
states that you will need for each
action and
conceptualize against so we looked at
the performance impact more closely for
especially for larger payloads like
payload us in their back he compared to
what it would look like if you did a
pure name termination for game logic vs
alluvial so we measure the system how
much we press second if we support and
we also test series with different
numbers of workers so this whole thing
is run on an 84 machines only marry the
long were cursor between one and eight
tell us what it look like falling so we
could even this is larger payload to the
DZ support something at one point more
thousands per second and cost for doing
the same thing in our country
architecture this scenario is indeed one
order of magnitude so the approach or a
movie we're only 400 requests per second
segments which is like it volunteers but
its network sounds more powerful and
this false virtual thing actually is so
it was
in the Amazon child but still I mean 1
or 0 ring to it tough to smoke that so
and another thing was a larger payload
it is no longer cpu-bound so while well
this is small availabe could easily
saturated boss was not far but really
really nice but this will are ok but
only time utilized twenty-five percent
so is looked in deep too deep into it
but it looks like kind of fixed rent
this limit it might be that you will
never again this remote we get there at
about 300 megabytes per second during
that enforce for you to start and that's
not so nice to have such a end to me
scalability yet and also we have burn
because something similar has happened
before also experienced about earlier
the team like them he'll elope what was
the database technology about 500,000
alien computers and while they were
already life is kind of successful and
growing it was really powerful to then
we sing major part of l'architecture do
this change and running system so our
back to be be happiness I think that the
happiness lies and even working product
here and even though it would
super nice to do the whole system in
this developer friendly easy muy loco
doctor to work out we still in the light
of decent facts of the game progressed
on hardwood the actual product will
comply parameters for a visit we
actually decided to go for running over
your culture at this point in time so
this can be kind of considered also
happy ending for this crowd I guess what
sir I'm not an easy decision so this day
yummy tried points as well they perform
a bit better than the zero you approach
with a large payload about twice as well
but we would lose a lot of the other
properties that you would like to have
because when you have ports then
suddenly earning has to kind of control
we're detection too and it will also
need to distribute the work load onto
the different ports yeah I push in five
state down to the Ruby 10 different
architecture would you push the entire
state to the boogie board and just send
the operator
the current dating ioc so you're saying
this the kind of application of the
whole thing yeah we we sought about
similar things with something like say
various as an immediate storage in the
cleaning stuff properties that we didn't
like so much because of a brighter in
cancellation and stove I was like
traitor so the same thing is that the
best decision that we could come up with
was ready to explore this purely
approach we just did this and here's
some some code I would be the same
action based being hit like in LA so you
see us once the large side of things
again as you can see here it's still the
same pattern so you had some stadium
maybe the sense send out a mistake by
golly it's nice easy modular approach in
the beam that there's a bit more on that
word I say so extracting documents
getting the right data structures also
building where the whole thing it's a
bit more more explicit let me just write
more stuff to get the job done but still
and as you see this recipe we talked
about earlier in this case here we have
the controller also being a mediator
school does not actually
delegate the user modifications down to
the the shape model of nature long also
feeding the user notification suitable
for while the model banos as chilly as
can be so just also have to shake things
and put three and a new tree very much
sugar what's so that's just a traitor
yeah instead of having the properties on
the simple animals be good for instance
also using records which meant quite
nicely dealers are going for more
complex models we would use other
dictionaries esta forma to this but
still for four syllables so 1030
happiness will not really yes second be
happy so at this point there might be a
bit less develop or comfort zone but on
the other hand we will now confident
that you will be able to deliver a
product that is really reliable and the
forebrain just grateful so that's where
we draw our happiness for mine I get
what do you think about some smart
questions if you mention that
well also is always looking for
developers if you want to follow down
this past week of the oil right there
and also you can hook us up so we have
to polish this media so Kristen to
answer any questions regarding just hope
I also thank you so but other yes are
you actually incoming any ipods to the
corresponding yeah so in this state full
approach that's obviously something that
is very needed because you really need
to identify the note that once the user
session so you will have some sort of
infrastructure a kind of global registry
that knows about what user lives on
whatsoever just rather impressed too
that we probably optimize it in a way
that all when we press can be not
directly and it'll just be me rubbish at
the client do something wrong probably
not in the media magic and things over
it's a soda medicine since basically and
we are looking into ways to swap that
out for more distributed approach but
for me either just
between between which parts of the
system totally when it gets this bike
and puts into the use of weather in the
in the hybrid approach yeah new purely
yeah this will just be in the same basic
you so you have the session but I wonder
that small in the sessions back in the
database before work or are there are no
workers in this sense it's just basic
conscious process are we operating on
the data structures and when you spawn
up in your user special movie starts
playing then we will initially load you
mentioned a user's data stored in the
parent process yeah and do you consider
replicating this state away for example
to amnesia or high availability not
really while we could do this we were
also thinking about things using
something like we are all replicas
answer but in reality I mean the worst
thing that could happen if we kind of
persist this stuff too infrequently and
the server process will crash all in
happiness that the user will then lose a
bit of progress in the game so and as we
don't do biking and you saying this is
totally acceptable just as easy a
systems approach so that's going on soon
yeah so what algorithm do you use for
pushing the information package today we
unusual walks away they get bored or
whatever it is at some point what I do
so I speed to detect this this fact is
just a simple timeout so anyway I'll do
this user session process will be
against over and it just has a timer and
whenever it does time off and just dump
its own stage in a sale Jason
serialization to this recipe so we
actually don't use a database to store
the case that email is really spotted in
the architecture with justice on s3 so
just based be discrete parts to greatly
dump this too will need to split up go
to the user crashes they you preserve
that state across if the client would
crush them if yeah it just what it will
just be another time or maybe it isn't
even a time of going to three stars if
you know what I noticed something
interesting in the arming code that you
showed like how you like your core like
the delphos the reducer State example
like you have a go back now you have a
loser effective his experience the kids
energy and does this
asian propagate back to the client or is
it like is it like dual simulations
wrong in power yes if it is so that's
one of the cello music missile internet
the client open to being so logically
mr. server code but you need to do that
because you the client will not wait for
us for an answer from the server it will
just assume that it was okay yeah
continued planning so these can doesn't
need to stop any activities don't just
eat soup lighting effects thanks miss
one but how do you like you managed to
leverage this in some way because I find
a little bit interesting that now we
have kind of separated you know the
state change and the state or two
separate things now so I mean those are
kind of events which could be used to
trigger of yourself re using or doing
something like that at the moment or a
meanie pti been said of her are also
used for say
this features of course series of events
feels also yeah what did you know I was
thinking just I've been thinking about
this exact same approach when doing like
non distributed functional programming
games like just one time does it all
because I mean give an infinite
bandwidth and like get Sarah latency I
mean it just took all the game don't
even the server and then the time can
get these messages like oh I increased
my experience like make the experience
or go up or like to rinse the energy and
then you could have it like the true
model view controller setup where the
client is actually just the right thing
cited of you and all the interesting
stuff but you're in a perfect world yeah
could the internet and uses community
and everyone you playing carefully cause
this nice infrastructure to another
world I think you have nicely not
watching YouTube at the same time that
you find you're already done yeah that's
true in a way but but still if you are
again where you are nice interred in the
face and just continue typically and
then it is still a noticeable delay when
you just wait for the response just like
so filling your promise in the fabric
that's not the issue yeah exactly good
maybe that's because out quiet we
actually have exploded this is Paris
office they are kind of a they just work
in
and are all sorts of wrong bags for this
level so they to use more problems and
assault for us but we are actually using
a service and events so that case if we
just chunk transfer for the
communication back of it we still have
requests central purpose but the way to
you running out of time so if you're on
occasion is a small team after the talk
Thank You Marty</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>