<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Migrating a C++ team to using Erlang to deliver a real-time bidding ad system: Ken Wilson | Coder Coacher - Coaching Coders</title><meta content="Migrating a C++ team to using Erlang to deliver a real-time bidding ad system: Ken Wilson - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Migrating a C++ team to using Erlang to deliver a real-time bidding ad system: Ken Wilson</b></h2><h5 class="post__date">2012-06-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/m2zNhdZwQMw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">ken wilson I'm 42 I'm from Dublin
Ireland I've worked in ITV last 22 years
I've worked with multiple different
languages Java C C++ and I worked in a
UK India Ireland US and Germany so I've
traveled around I've seen lots of
different languages and have a lot of
great great experiences with IT it's a
great industry and last week my kid was
doing a project in washing joj
Washington and he said you know let's
check it out on the web when I was his
age I'd have to go down to the library
to figure this stuff out so things have
changed radically and they're always
changing in our industry so I think
we're very lucky to be working in it who
we are I work for a well which is a
country as a company which is constantly
transforming and it has been a wonderful
privilege to work for it I've worked for
a well for the last 12 years I've worked
in search I've worked in personalization
and networking at personal finance and
for the last four years I've been
focusing on advertisement so work on the
AOL advertising group four years ago we
bought a company in Germany called ad
tech and I work closely with those with
those folks so we have a team in Germany
and we have a team in the UK in aren't
which I work with and attack what they
do is they build large scale and
advertising delivery systems so we
deliver billions of ads per day we're
kind of hosted in the US and a UK a
European region over four different data
centers and and you know it's a it's a
great system and we've been a very
blessed but the type of growth our
product has had a will is one of our
customers but one of many customs that
we have so this where does this story
starts every presentation has a story
and this story starts about two years
ago where our new CTO came over to
Dublin and I was given a presentation
about a current product and how was
built and how we use C++ and so forth
and he suggested to me hey have you ever
heard a language color line why don't
you use our line and I thought he was
talking about a beer but eventually
figured I'd
no it's something else there's something
to really have a look at so about two
years ago we started investigating it
but that was in the middle of a kind of
a large development cycle which were on
and we couldn't incorporate some of
these changes but the seeds were planted
about this about the language and it may
be some of the benefits in which you
could we could gain from it so our
current system I don't want to go too
much into this but to know where we came
from you have to see where the current
system is to see where we got to so this
is a very high level diagram here
unthink on your right you got the user
interface so you got the ad tech you
wine that's built in struts its use Java
struts it's got a business layer it's
got a persistent player and it talks to
my sequel database in Europe and an
Oracle database in the US initially we
were just built out in Europe and we
built out a solution in the u.s. when a
web orders over and bush and the Oracle
installations didn't really work out in
the US and we're probably going to
migrate off that we also have a web
service and this is built using a
technology called sister net which wraps
Java around and it grabs Java classes
and expose it into soap messages so
handles authentication security and it
just expose that soap api switch you can
access and configure so the user goes
into the system configures up the
campaign configuration information
either access it through the api's or to
DUI and creates campaigns and also tags
which those campaigns can run off the
mid-tier is that they the band where it
joins the front end today to the
back-end infrastructure and a core
component that we have there is the
attacker a 80s system and what it does
is that it drinks of the campaign
configuration information pushes it into
our back end and then allows that to go
live now we've roughly about a hundred
thousand campaigns live at any one time
delivering billions of ads so there's a
lot of information being pushed and
pulled tried the system it pushes it to
the back-end infrastructure which is
built in in C++ so there's a push web
web s which you
is G soap and it exposes an API which
the 80s sends soap messages to and it
stores that into proprietary format
which is push documents in system these
push documents are sent out to our
selectors which are is the brain of our
system and does the decisioning for
online advertisement these
configurations as I said it is about
100,000 campaigns live in a selector and
instructor you'd have IP configuration
and you'd have user information and you
have a lot of different types of
criteria switch helps you decide which
campaign is suitable to display for that
user that particular time an add request
comes in from iah a javascript HTML tag
that's on a page it hits our ad service
it forwards that on to a Pacific
selector it then decides to make the
decision e ad decides which is the best
advert and then sends it back a lot of
part of our date our system is about
handling the reporting so a user wants
baby configure their campaigns make
those campaigns go live and then
understand what's been happening with
the data and then change how those
campaigns are running so we create we
send off or we use Avram flume send it
off to HDFS system and then use pig
scripts to aggregate up these logs and
we aggregating per hour per day per
month and throw them into a database and
this allows us to argue this some this
is the summary data of our reporting
system it counts as clicks impressions
views and all that good stuff and all
this information is stored into a my
sequel database and it's accessible by
the UI by the reporting engine so what
happens a user can go into you i click
on hey I want to see report it shadows
off a report and the reporting engine
generates that report in XML format PDF
or whatever it's apart and displays it
back to the user also a when we
aggregate aggregate upper data and we
take samples of how placements are
behaving
we take one percent samples of how
placement behaves in relation the
keywords tracking and we use that which
predictive models to forecast wash ave
ability of these placements can happen
over the next 30 days and this is
important that when you're scheduling
campaigns up and you want to have
guaranteed campaigns that you can figure
out that dash what's availability of a
placement and use that and we also built
a mobile solution as well which
leverages which sit on top of our ad
server and it takes in a request for ads
and figures out what device add request
comes in on and it also figures out
where the i key came from the carrier
and so forth and it sends a request on
to add server as well so this is the
kind of infrastructure that we currently
have on the far left its Java middle
tier is Java the back end the C++ and
this is a mixture of Java and C++ so
this is where we are today and back to
where the story began and there are
problems with this system we we do scale
we do rollout features but we do things
very slowly it's very hard to get some
of our future saj so and wonder things
up after a large project that we worked
on we worked on a mobile solution for
doing mobile ads we first initially had
a third party do enough for us but for
reasons that we're not going to go into
now that that company went away and we
had to remove them quickly from our
solution and build a homegrown solution
or self so we did that in about four or
five weeks what we did was that we
suspended our usual process of how we
developed we got a team it's located in
one place put them into a room and we
worked really really hard and in four to
five weeks we rolled out our first home
built mobile solution for ad tech it's
been in production for last but six
months and we've been adding to it
slowly and slowly and over the last six
months we've increased
our usage by three thousand percent last
month we signed or 40 customers just
because of our mobile solution so
definitely just let it go there's a lot
of growth in mobile we can see that in
the devices proliferations that we have
and thinking about California had the
big gold rush air mobile is that gold
rush in the IT terms and it's the people
who make the shovel setter actually make
money in a gold rush so definitely
providing tools second display ads or do
stuff on mobile on a mobile
infrastructure is a massive benefit so
with all this information about changing
our process thinking about and maybe
using airline but the timing wasn't
right and in October I got a phone call
from my boss in Germany and he said hey
real-time bidding this is something
which is really important for our
company we need to get involved in here
so we had a chat about it and I said
this is great real-time bidding what it
is is it's a publisher's have the
opportunity instead of scheduling
campaigns against their own infantry
taking settled out to utter dsps and
have them bid on a real-time what did
you use that the find out but user to
find out about the placement the content
send a request I to these very stiff and
DSPs and get the best price at that
moment in time and display that Pacific
advert so understanding what real-time
bidding was and understanding that we
probably change our system overall and I
we decided to try be a little bit more
innovative now this picture here is a
picture of CERN where you've got actions
being shot at each other at it almost at
speed of light and then creating black
holes that's not the innovation I'm
talking about but I think innovation is
just trying to do something different
and always trying to do it differently
and so that's kind of the philosophy
which we are trying to foster in our
team and the Tooting is that we try to
do differently a4 ad tech was that we
want to change our process we want to
change technology stocks which we're
working on
so the process that we had for the last
three or four years of a strong base
which gives power to the teams but can
haz constraints so we had a lot of
backlog grooming forward log grooming it
seems like we're meetings more times
than actually cutting code so we had to
try to optimize that solution so we went
to a Kanban solution and said what we do
is that and we said we do a demo on
Monday and with your planning all in the
base of one hour and that's all the
missions that we have everything out
step is orally spoken and we have think
we have the team directly in Dublin so
we don't need to kind of go cross
boundaries and it works very very well
on a Friday evening we have a half an
hour mission figure out what the demo
will be looking like for the for the
next next monday and that's all that's
amount of planning planning that we need
to do people need to communicate offline
to figure out what needs to be done and
and that's that works out very very well
and problems that we have with our
system I have the picture of this big
old cake here which looks very tasty but
it kind of reminds me of our system that
we have if you have one feature kind of
exposed in the front end you have to go
through every single layer to get it in
the back end so we can actually do
something interesting with it and there
are just way too many layers it's very
very hard it's very inflexible to change
also in the back end for us in our C++
environment it's not a very natural
language use to build distributed fault
tolerant solutions so we have a lot of
problems it was like when we worked on a
feature to roll a feature out would take
us two weeks so getting stuff out to our
customers was very very hard and then
when we got to marriage c++ ever crashed
it would actually cause major problems
as well that would impact our revenue so
we knew we had problems we decided to do
something new decided to try and user
line and it was a lot of resistance
which is from C++ developers this it's
like Assam tea to wrong baby or
something it's
it's very strange so and we had
different options we kind of talked to
what our options were one option was
maybe hire an accompanying and get some
trainers in and and see how that option
would work out and we didn't really know
airline that much and we weren't sure it
was definitely cost to you know involved
in doing something like that another
option was tried a World War adore
airline teams as well to try and build
bridges with those guys and get involved
with them and we had initial
conversations when and that's all it was
very hard because they weren't on site
to really leave which a lot of that
expertise so what we decided to do is do
a two-week investigation spike we get to
got get three or four guys put into the
room and I went through about two months
beforehand and identify the biggest
naysayers so there are the guys I wanted
to actually do the investigation spike I
felt if you got the biggest naysayers in
to do it and see how they respond to use
an airline and they may become the
biggest advocatus so we had in two weeks
a put into room investigation spike we
gave him a few books whatever Hardware
de needed and we gave a schedule first
surgery was kind of get familiar with
the basics of the language and the
second week was to build a prototype
using real-time bidding and by the end
of the two weeks you know they just
found it was like Paul and road to
Damascus the K Maj kind of showering us
with all sorts of amazing things and it
was a transformation completely for the
team and these guys went out in Sartell
and lots of other guys is what this
really can work this is the way to go
and and they find out you know very
simple obvious thing is that when you
reach you through the airline and when
you get very familiar with the language
that C C++ is definitely not suitable
you don't have to worry about memory
allocation you don't have to worry about
proprietary protocols between systems
all that stuff is the language channel
handles herself you don't have to worry
about and and worry about false and
errors you're always programming along
the line that will succeed if it fails
it just disappears let it crash it does
matter so romantic we notice that when
we worked on the prototype the amount of
code was seriously compressed it was
only 20 or 30 or 40 lines of code to
actually build a prototype for rtb so it
was very very good also another thing
that we notice is that on one of the
guys laptops we've seen like 60,000 air
transactions per second now our current
web service handles about two and a half
thousand HTTP requests and on this guy's
laptop you could get sixty thousand
messages or transactions running so it
was it was a massive boost for the team
less code more scalable easy-to-learn
was only two weeks for the guys to learn
this stuff so it was it was it was
pretty good so the changes that we
incurred on our system on the backend
was that we decided to split out you'll
notice that of changed terminology if he
looked at the diagrams we use the Select
was the brain I kept on calling it the
classic selector I wanted guys to think
about this was the past this is not how
we're going to build the system gone
going forward in the future so we still
have the classic selector it handles the
the video and handles the display
business but the rtb businesses come
it's going to be ran from use an airline
in the selector codebase a request comes
in a forwards run if it's for real-time
bidding at the center on to the selector
it will find that information and it
will then return and out hopefully and
make some money for our publishers and
the code base for our RGB selector is it
looks something along this I don't know
can you see this ok so the really thick
rings are the processes that live for a
long time so we have our ad server here
which is written in C++ it makes a
connection to a trip list add to a trip
listener it den spawns opposed us to
handle the processing for doing or TB
connecting C++ to to ER line was a bit
problematic what we initially try to use
with a afro and
it's not very well maintained in the
airline community so we tried to use a
drift and that works that's that's
pretty well maintained but the problem
with Tritt with was that was a remote
procedure calls and that would block the
ant server so we have all these threads
in the ad server and we'll block until
we get a response back we found it was
quite a large bottle neck there so what
we decided to do is to use zeromq and
compare use a trip over zeromq that
worked great dasha distribute the
messages across at the very safe in our
TV select processes and it also didn't
block the treads on the c++ side which
was tuned up we were very concerned
about and when we get a request in the
turf process then creates up a
short-lived process a bid process it
takes information from the user info
which is a long-lived process takes
information about the placement and also
about the context of the page so at some
point we're going to integrate with
third-party content analyzers which will
analyze the pages which this information
will be stored on and that information
will be accessible for us to use and
make bids off to very stiff and DSPs
whether it's AppNexus data is ooh media
math and so forth and by providing more
information to these guys it means that
the bid could either more value for them
and so this is the kind of solution that
we've all that tour alpha we started
working on this in October we roll
decide at the end of January so we've
done enough for one of our customers
integrating with a DSPs to edit a
AppNexus and our next can a step or
milestone is to try and have a be sure
but all of our customers using it and we
hopefully have that scheduled for June
and that will incur changes in the front
end getting that information pushing it
down to the back end and exposing that
functionality ultimately the goal of
this year for us is to completely change
that back and delivery system we use
so we're taking a piece by piece as
features are required for using RGB to
redevelop it in Erlang and then roll it
out into production and use its benefits
of that solution and so for us it's been
a learning curve over the last few
months we've only started in October we
rolled an alpha H in January we have
we're going to do bj in June and then
probably go fully live in the third
quarter of the year and add the thing
about our line is it's like swimming you
know you can read as many books as you
want but the only way you can learn how
to students by getting into the water
and this year's for us is but get me
into water and learn how to do the
doggie paddle and so forth and so it's
been a pleasure to show you a bit about
our system to show you some of the
things that that what we're trying to do
in the online advertising arian in a
well and if anyone has any questions at
this point yep yep
okay was like this like I got one guy
and I dragged him anyone and the
resistant level level was amazing I just
couldn't really believe it I am it was
just like it was alien these guys were
serious hardcore C++ developers to ask
them to to kind of shift into a
different paradigm you just just
resistance was was pretty hard so I sat
down and said to one particular guys
that you're being paid just to play if
two weeks to play just just have fun and
see what what what what you can do so we
we got them into the room we get we gave
him a whiteboard we every day we talked
about the stuff that we did we did a
schedule wrote down the tasks of what we
expected first week of of the learning
curve with the language they did a small
charge a room example and that was fine
I think we use them icq API which is a
public API which we used which was good
and then the second week was well here's
our TB just courageous very simple
service that does a socket connection
and let's see how it scaled and by the
end on second week they didn't want to
develop in C++ anymore it was completely
shift
it's a flowing with books and that was
easier I think I think do you know what
I think from books does you have to be
very pragmatic I think a course to get
you learn everything you won't be
fragmented you won't be thinking about I
just need this for my problem or a need
that I think ultimately a course are you
know maybe working so what we also tried
after the two weeks we try to hire
someone in in in Dublin data airline
experience we thought hey you know get a
guy that's got a learning experience it
and let you know let let them work with
the team and that'd be brilliant we
couldn't find any there is none actually
in the marketplace so what we have to
use get guys in and train them up and
but as I was saying to the guys before
the two-week Jones say you know if you
end up learning Erlang it's it's another
tool in the box it doesn't mean every
problem has to be solved at airline but
it's another tune the box that you will
be able to use in your career much
further down line as well if ur learning
developers are die hard to come by
you're very very valuable good ones here
yep
yep so basically what we do there is
that at the moment it causes an alpha we
load more files but probably hopefully
to do and what we're working on at the
moment is getting a push from a front
end to the back end and how that's going
to work is that that's from Java we're
going to use a probably ZM q2 sending
messages into a into an erlang
distributor it'll send metal dense turn
these JSON objects into top 'let's into
Erlang tablets and then send it off to
the airline processes themselves which
will stay in memory now we're thinking
about whether will store them or not and
we haven't we haven't decided what
persistence method w's at that point we
still can in flight yep no good so what
airline the books are pretty good and
secondly what we did is that we got the
code base that we wrote and we kind of
reviewed it with some of these other
airline guys over and over neri well so
we were we're kind of learning to swim
while instructors looking at us as we
dabbled so I think definitely I'm what
the strategy has been now is that we've
got these bunch of airline kind of
advocates and what we decided to do in
dublin is that we have an open one air
once a week we have a earning class
where anyone in the company in dublin
can come along to learn airline so I
think the best method is that if you can
get people into Z astok about something
they become the greatest advocatus if
these guys are known in the company and
are very smart guys it becomes self
propelling itself so in these classes
open classes that we have we've got
about 20 people turning up and they're
learning we give examples we're talking
about it the reason why we're doing it
is because I want more resources on my
team
so if more people know we're lying then
we could try and put put him in there
and get working on them yeah yeah they
love us day low but I can't stop talking
about it now so we M we also did it in
January we did a kind of as a faceoff or
kind of sync up with a company that was
based in Dublin and there were scanner
house so what we did is four days that
we did a problem built in Schuyler
compared to built-in in airline and
detains that we noticed in scarlet you
know both systems got the job done King
we noticed in scale is that a lot of the
Scarlet developers were always fallen
back to java so if it kind of works in
Schuyler that's fine but if not they
will drop back to Java which isn't a
very pure clean wave of trying to solve
problems and I guess Scala's is still a
very new technology stack so we have to
kind of think about what's going to
happen in that space bush the way look
at scale is like a C or C++ you know you
can write C++ but just put seen it and
that's what I was seen in so many skyla
examples that there was being produced
on on the day that the folks are working
on so it was interesting to have that
experience and again that helped to add
to the picture to the team you know the
importance of working with airline and
how it works as a distributed solution
yeah
that's a very good question yep so we've
decided to become an advocate of open
our TV so we're trying to work with the
day standards the a I a B standards and
what we're trying to do is to get the
DSPs to talk open our TV so very few
them due date is udo's and meaty math
kind of does but it's a very it's a very
big it's a very big API just a lot going
on there you can do bidding you can do
blocking of advertisers a upass user
information long there you can decide to
do mobile companion ad so there's a lot
in that spec it's a big spec but sure
what we've done is that we sat down
further for our first be deterred side
what feature set we we're going to work
on and we've done a subset of of that
API and we've done a working document
which we send out to our DSPs that were
working with and we're trying to get
those guys to implement that now I don't
know we'll all them implement it and
there's certain things that the open rtb
standard doesn't talk about whether
sharing keys and handling kind of users
in in this system that's third party
compared to the system that's that that
you have as well but is a great starting
point I mean there should be
standardization in this area so we're
big advocate resolves in the next few
months will know how benefit you know
how far the pushing has gone to try and
get people to use it
sit again please and no day I ranked the
one that we worked we were kind of
talking with we're based in Baltimore
but we do have a Palo Alto team as well
i believe so this is our CTO and this is
the guy that told me to use their lang
and I told us that Alex was talking
about a beer at the time but it was
really good it was a really good idea
and it's something that we've been
fermenting in our in our organization
for the last two years and it's only now
the road the rubber is hitting the road
and it's only known the next year that
will actually bring this into into a
reality for our company so it's been a
really exciting journey and on that
bombshell I think we weave a bad time so
time so much was a pleasure talking
talking to you and maybe tonight we can
have a few beers and talk a bit more
take take your tanks</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>