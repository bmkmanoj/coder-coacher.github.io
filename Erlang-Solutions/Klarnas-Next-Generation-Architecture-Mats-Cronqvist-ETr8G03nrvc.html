<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Klarna's Next Generation Architecture - Mats Cronqvist | Coder Coacher - Coaching Coders</title><meta content="Klarna's Next Generation Architecture - Mats Cronqvist - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Klarna's Next Generation Architecture - Mats Cronqvist</b></h2><h5 class="post__date">2013-07-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ETr8G03nrvc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thank you all right
so I never remember what the title I'm
supposed to use so i changed it this is
a monolith so nice why would you want to
crush it yeah problems of course if
you're standing down here and the wind
starts blowing which is certain kind of
the situation we're having a clone
enough this is the this is the title
that my boss wanted me to use with his
speech I thought it was a bit bit long
it was actually longer in the speech but
I only way this what I'm going to talk
about so i was told her I was supposed
to introduce myself because John handler
here can't really be trusted and so yeah
that's it 10 years at ericsson i came at
the two ericsson 1997 i was working on
the egg XD 31 that the terrible trio
were talking about order today
interesting experience now i'm just an
architect so then i have to make these
really simple diagrams so this is klaar
now where i work now so what's at all
but then it's a kind of a mission
impossible are you we want to make it
fun to pay money to us it should be safe
and simple and fun of course you can
also get stuff for your money that's
kind of draw back there but anyways so
the business idea is to work together
with e-stores people selling stuff on
internet and handle their payments or
the payments so that consumer can buy
stuff from the east or and then
they pay us money and we pay the the
east or emulsions and and what's in it
for them since we're specialized in
taking risk credit risks we can do much
better job than the merchants in
assessing the risk that the consumer
doesn't pay us and that means we can
make it simpler to pay if you go to
checkout you don't have to deal with
credit card numbers or bank transfer so
stuff like that you can just fill in
typically your email address and some
address info and then we'll make sure
that you get this stuff and then when
you get your goods you then you pay this
makes people want to buy more stuff so
typically when we get an eStore on board
they increase their revenue by twenty
percent and which makes it easy for our
sales people to get their bonuses so
what does that mean in technical terms
yeah so the kicker is the killer feature
is this real time risk assessment so
what we can do is to make a pretty good
guess at how likely it is you pay us
money and we can do that we in three
seconds and only with stuff information
that you sell send us normally so it
sounds kind of impressive
of course yeah I'll get to that later we
have a lot of the settlement options
that means when you get your goods you
can pay us money in several different
ways we have a pretty big customer care
department so if there's a problem you
can call us in call in to us and there's
a bunch of the people that take care of
your problem phones we have the fraud
anti-fraud measures both automatic and
with people and we're highly available
maybe I should strike at some words we
have a new product they did chlorinate
check out so in our traditional solution
there's just it's just an API with a
wonderful technology xml-rpc and so that
no chance integrate against us with it
over HTTP pretty much now there are new
product is that we have a check out
which is hosted by us so it's our
checkout page is embedded in the east
doors purchase flow and since we are
good at assessing risk that makes it
much simpler to check out from your
basket whatever it's called and so that
puts a lot more stress on our
availability and responsiveness because
now we're dealing directly with end
customers yeah so yes I really already
went through this bit so how's this done
then so this is our current architecture
yeah I guess it is an architecture it's
so this picture here illustrates our
inter interactions with the world right
to this all these bubbles are stuff that
we do towards customers or internal or
external customers we we send paper
invoices with and emails as mess this we
talked to the banks we talk to customers
we talk to the stores we do we buy
credit information from information
vendors the NSA a CIA Facebook and then
we have hundreds of customer care agency
also work against our system there's all
these arrows and stuff and everything is
handled by the big blue blob here which
is called Craig this is essentially a
big huge Erlang program and run some two
machines master and slave and that's all
of this and its most of its implemented
as transactions in Asia so for example
if you want to use our GUI the customer
care agent must use the GUI to to fix
some problem we have an olin program
that generates that HTML and runs it in
media transaction essentially this is
has a lot of advantages it's it's all
the data is always there it's it's a
pretty simple model to work in but it
also has some some drawbacks of course
and they being kind of exposed by our
incredible success would so this is when
I started working at claw
we were okay so this is purchase a
sponsor so that every time we buy any
invoice from a nice tour this is where I
started working I don't know i can't
even extra pal i interpolate down to
that but it was like one purchase per
minute maybe yeah maybe a little bit
more than that so now we're quite a bit
more and successful and the peaks you
see here is that's annual cycle so the
big cakes are christmas or three weeks
before christmas so when we pick on
people buy Christmas gifts yeah so this
is of course a good problem because our
our business model means that the
revenue is linearly proportional to
number of the purchases so money is
flowing in that at a high rate that
which is good of course but what's not
so great is that we've increased our
vote so this is the logarithm 10
logarithm of the previous plot so you
can see that since 2000 New Year's 2007
William increased volume by about the
factor of a hundred so our system we've
been doing our scaling by buying bigger
machines which is of course great until
you already bought a biggest one there
is when you have to go to plan B so this
is a snapshot of the system this is just
like top unix top but inside emulator so
you can see here it says 530 GG there
that's how much
memory we ram memory allocated for this
emulator such as beta we have these two
machines they have two terabytes of ram
and they each run one instance of the
erlang p.m. and they typically use of
use up about half a half a terabyte each
where they're identical we have 1600
along processes which is not bad it's
mostly web server processes and adds the
in-memory database uses up most of it
5-4 470 gigabytes so we've run into some
interesting bugs we found a bug in the
garbage collector for example you
couldn't have a single along processor
used up more than 32 gigabytes of memory
apparently they they haven't tested at
Ericsson it's pathetic but yeah this was
an hour 14 so it's fixed now is there is
another interesting point is that the
this is one process here you're saw a
process that's that's a gooey process
that's one of those processes that
generate the web page it's using up 17
gigabytes of memory in and two cores
worth of CPU so that turned out to be a
bug some somebody who is actually in the
room now had written some code that had
an infinite loop in it and was not
tail-recursive so like 10 seconds after
this snapshot the machine went down and
since we're using 500 gigabytes of
memory takes over an hour for the system
to waste also failed over to the slave
but
had some downtime so that of course
illustrates the problem here that we
don't have a lot of failure is isolation
if some process takes down the emulator
then everything is gone yeah sure it's
we've gone for the time it takes for the
failure would happen which is typically
about a minute and in this particular
instance that the slave also went down
so in an unrelated bug it was always
totally weird but so did the
architecture has some drawbacks and we
of course thought about this it's it's
pretty obvious there if you if you break
it the system down in all the
functionality down into ver domains like
this that the one at the top there is
software that one is different from the
others in the sense that it but that's
the thing that has to be very available
and very responsive and other ones we
can do except for the GUI as we can do
it in batch so a nominal idea here
brilliant insight was that we could to
separate the system in the front and
back end and also to decouple the the
database from the business logic it's
it's very intimately tied to our system
functioning of the system is very
intimately tied to NAC on how that works
for example the master-slave replication
is done by hooking in under the hood on
in Asia yeah so to get horizontal
scaling we we needed to decouple we also
had problems with the poor have problems
with the productivity of the developer
since system is pretty complicated now
and everything is connected to
everything else it takes a very long
time for the developers to to get up to
speed
in working with the system they create
its it doesn't typically take very long
for them to learn Oh Lange but to
normally it takes about two years until
they're really self going self-propelled
they have their skills to actually do
serious working system yeah it's also a
good word to use if you talk to
management decoupling hey fancy all
right so this is what our back-end is
going to be so yeah so frightened vendor
like a little humorous words Fred just a
front end and Bender is the back end so
this is what bender is going to look
like so the front and top there is solve
the system Fred and less connected to
the back and back in front and
connections to be message queues then
that goes into another broker and then
we store everything Hadoop and we have a
bunch of services put one on top of the
message popular and that's this slide
it's the services so the the interesting
thing about this are interesting one one
observation can make bear is that most
of this stuff is nothing special for
chlorine all right everybody needs to
give bookkeeping blah blah the dunning
is a bit special for us and for those
who don't know that's when you so each
each time we taken and purchase from the
store we basically start a timer and
after so in so many days we supposed to
send out a reminder or an invoice or
send them to the I don't know send for
the guys with lead pipes to go collect
our money stuff like
it's called cause she had swedish that's
a bit special for us but most of this we
can buy products from Microsoft reiben
of course originally when the system was
created they didn't have any money they
couldn't pay million bucks to Microsoft
for a business intelligence systems
whoop all right fred is the front end
service its software time so we have
contractual obligations with some of our
merchants to if we don't answer we in 35
seconds something of that means we take
the risk for this this purchase so it's
important that we actually answer
something sensible otherwise we stuck
with that piece of business so it needs
to be responsive and available we also
wanted to to port most of the approaches
logic from from cred whole system
because so the migration here is kind of
tricky that we can't just take the
system down and start up the new one
three weeks later it has to be the
migration has to happen in real in
operation and we want to be able to
switch back and forth and run purchases
through those systems stuff like that so
also we didn't want to lose all the
knowledge that's in the old code so the
scope here for fred is so I'm talking
about the API we have against merchants
we want to handle some of the API
methods there but not all of them only
the ones that actually create purchases
we want to host our check out there the
ID service and risk service and the risk
service is broken up into pieces here so
the three stages of the risk assessment
I can handle different kinds of failure
scenarios so a fred has no cow two units
great word along the direction so
there's four levels of knockout units we
have Fred clusters on several data
centers a cluster has a number of
machines five to ten and each machine
runs the same code as all of them
there's no master they're all identical
told wise and function wise and and the
business logic is broken up into these
services and that's partly so that a
service can fail and we still reply but
also so that the teams are not so
tightly coupled order the function of
the teams that mean the teams can
function more individual and not don't
have to take all the other code into
account when they do change so this is
what that looks like in I had my
five-year-old draw this picture with
little boxes and stuff it's five years
ago it looks like it's made by crayons
but it's actually highly professional
graphical designers done this so there's
a load balancer this is a one fried
machine has a database abstraction layer
and the service orchestrator which is an
engine that calls these services in
special order and passes a context
between them so this thing also
dominates the HP and make sure that we
answer time
the fashion even if some of the services
go down the SSL is terminated in the
load balancer some of our stores
actually send all the traffic over HTTP
which is annoying yeah okay yes so the
it's based on reactor distributed key
value store and so each each of these
Fred machines have a running react
instance and each Fred cluster is a ring
Brylcreem that's what now is our tech
stack for Fred we've been through
various Linux variants when I started
Clara now we had gin too I think then we
went to debian now it's red hat next
flavor is going to be same thing though
we use the web machine mochi web and by
react from Basho rabbitmq along of
course get jeffrey Barbara some pretty
heavily tilted Wars open source software
pay for some of this but most of it this
so from github the Red Hat we were
pretty happy with debian but because of
our memory requirements we we bought
some fancy hardware that was certified
for red hat only so we had to go to Red
Hat for that piece so react is
it's a basis of the Fred so why why is
that is that because we're hipsters
clearly not standing here looking
incredibly unhip we wanted to distribute
a database and the use case is such that
we didn't need transactions and Fred so
distribute key values or sounded good
they Dave very the Brio guys put a lot
of effort into making it easy to run the
database it has all kinds of metrics and
dashboards and stuff that's that's nice
they're good good coders and I have
something called react so this is
something based on losing that we wanted
to use for our identification engine in
the old suits that we build our only
indexes for a dress matching and stuff
like that and that's some limiting it's
kind of hard to get it right easier to
to use we wanted to have the ability to
use leucine anyways this was said two
years ago when we drew this up and I
wasn't really any good competition we
were looking at Cassandra I wasn't very
stable back then and the data center
replication is interesting we don't use
that but now we probably will in the
future so the drawback with the react
isn't well back it's it's a feature of
reacted and you can create siblings so
if there is some sort of split and just
just because we have a network split we
can't stop the system of course
we have to be available anyways so we
can create siblings and that means we
have to be able to resolve those and
some strategies there you can merge them
you have to you have to sibling of an
object that only difference is that they
have a list of goods for example it
might be sensible is demolished those
lists do a unique salt on them something
you can just pick one or the original
idea where fred was that the use case
was such a we would never get sibling so
we would create an order never mutated
and we would make sure that the keys we
make so that's pretty much holding up so
that's actually worked out fine but yeah
I'll get to it later the big problem
here that we had this whole deployment
of this new gorkha tech chure is not to
actually to to create this system well
that's of course non-trivial task but
what's really complicating it is that we
have all these other existing audience
so that's where all the money's coming
from 15,000 in eight seven seven
different countries and the API is
pretty old now I think the first one was
from 2005 this I don't know how many
versions of it are we still supporting
we never deprecated any of them I think
so it's like 40 phocians of the API 10
November soda pre still used and there's
a lot of quirks and strange legacy stuff
in the code that some of the merchants
to rely on and we don't really know who
is using what it's hard to see so that's
of course one of the reason why we're
backported most of the business logic
here
we don't really understand everything it
does so this is what our migration looks
like so we have the Fred the new system
Fred and so we terminate all the API
requests on Fred we look at it we unpack
it look at the case is something that we
handle in the Fred then we handle it and
reply otherwise you just proxied back to
to cred so the credit has all the
functionality already of course then we
flip in more and more functionality like
this and every time it eventually we're
going to have all the stuff here and
Fred and we can get rid of the these
beats of the great so this is there the
RPC API we're still going to do all the
backend stuff for time being this is
where we are now we're sort of friends
allied they're taking one of the API
calls proxying everything else so by
this fall we're going to roll out the
rest of it and the check cap as well
which is not on this slide so I thought
I'd say something about the resistance
to change when we do a big huge
transformation like this well I had the
fear that people would be would be a lot
of internal strife but not really there
was some some not invented here so we're
doing more with we're not building
everything ourselves from scratch
anymore and so there's been some
conflicts but arguing about pulling in
more external components but it's not
that's not really been a problem though
but what has been a problem is this new
model of programming that you can't
assume that all the data is always there
you just look in easy and find out
whatever if you need some data utility
read doesn't work anymore the did
spaghetti's has been I don't know how
many was several hundred people have
committed code to to this code base not
all not all of them has been have been
excellent programmers and but most of
them of course virtually all of them but
not all of them has really understood
how the system works so there's a lot of
lot of strange stuff there there's been
a lot of infrastructure work for getting
on the logging basic stuff like that
compatibility with the old behaviors and
old bugs or in some cases we have to be
backwards bug compatible pain in the ass
and of course we don't have any specs
there's been some some obstacles there
but conclusion I start from the end with
my title here we're actually almost
deployed is now so yay
thank you for listening right now it's
it's cred right we're implementing how
to use that as a date of Alton and blow
out now it's being phased out right so
right now creddies bender yes exactly
but we r we gonna hook up cred to this
infrastructure as one of the soul sister
and then move more and more
functionality attack read that this is
something called camel so this message
bus enterprise service bus cam camel is
open source it's Apache Hadoop is free
of course and we're also using
post-crisis so we materialized views
from a you pop in will into the sources
but the bookkeeping system for examples
from Microsoft the business intelligence
system is from IBM Business Intelligence
so when you when you take data from your
data vault and turn it into a form that
the business analysts can use I can't I
can't explain that any better I don't
understand it myself but for example if
we if we hypothetically start business
in a new country the
like literally a hundred people that
want to figure out exactly how it's
going and how my what segments of the
business is doing the best and so they
they have traditionally with in the
olden days we just write every time they
need ISM some information we write a
report which is an online program that
working in Asia and generated a CSV file
that we mailed to these people they
could read it into Excel and since they
were unhappy with this way of working
and so now we're exporting and we're
hooking into the Messiah replication KTB
replication and exporting a large subset
of late time to postgres missions and
sort of business intelligence people
work against that no kidding hundred
people I don't know if answer your
question all right thank you I don't
know what that is but it sounds good so
that's what are we doing hellas yes I
think I've noticed that every time I
come up with good idea it was already
invented by some German guy a hundred
years ago so and if it's not already
invented is probably a bad idea we
haven't made so much progress on the
back end yet and I mean this is what
we're building we have an instance of a
dupe it's not getting all the data yet
we're working and hooking up cred to
this message broker which is in place we
have one service that's live that's the
PDF generation that you guys might know
about
there's an anecdote thing is that we
send out like I think it's like 10
million pieces of paper per month yeah
something like that this millions
millions and millions of pieces of paper
we mail out to invoices and reminders
and stuff like that and many of them
have little machine readable forms on
them and up until the year ago every
single one of those documents were
generated by an o-line program so it was
for each document type we had an o-line
program that would draw little lines in
a PDF document which made it a two-week
tasks to move in a line five millimeters
to left or move the logo to the right
instead of left yeah also our graphical
designers were not super happy with this
solution they had to do everything in
folk to show up or something and then
print it out and then give it to a
programmer and he would sit with a ruler
and figure out how many millimeters I
should move the pen but we have a now we
have a real the system but that there
where the designers can work in a GUI to
make the graphical stuff it's brilliant
it's actually using your old guten in
work 3d fine except for the fact that
you needed to be like have a PhD in a
line programming to design the document
and yeah sure if you if you can look at
the five thousand page along five
thousand line rolling programme you
figure out exactly where which line of
code moved which line in the paper yeah
it's easy in principle yes we didn't
think of that yes yeah this is I think
the experience is so if we have a whiff
we can buy something that does exactly
what we want then that's great then we
need great against it if we have to go
into this if you buy something from
Microsoft saying we have to customize it
that then it's a problem but I mean for
the bookkeeping system for example I be
a Microsoft has 800 people working on it
and it's 10 years old so it's eight
thousand nine years or something and
most of it is exactly what we want so
there's no way we can re implemented
better so depends I guess meant but for
the front end stuff which is pretty much
more unusual thing we need to be
customized a lot and there's not a lot
of people it does exactly this so then
it doesn't make sense to try to buy
something but for example a printing PDF
generating PDF documents from templates
is not something that we need to be a
world class or even particularly good at
and we can buy something that does that
well makes a lot of sense
so the business logic is all those green
bubbles their services so that's like
the risk assessment ID matching stuff
the actual business logic of making
approaches specifying payment options
and stuff like that and so each one of
those who most of the the code here is
in the green bubbles all the business
logic sir except for the actual flows
where you define which old are you going
to call this and stuff like that
depending yes that's right so the
logically the Fred the machines are all
identical that's the we wanted to get
away from the master-slave failover
scenario so any one of them can take
approaches it's a maybe there's second
systems in from in action air but I
think that makes scaling it a lot easier
they're identical we can slot in more
machines essentially yes so we we stole
the one we once we've accepted
approaches we make something called an
older blog which is a bunch of data
described side purchase and that's
that's cashed in in rijeka now it's
moved to the back end over the message
queue but if the back end is down we are
stored there and then we also store
enough the information to run this risk
an idea assessment stuff but all of that
t cells are available in the back end or
the other react machines so we don't
have to restore anything to
it's pushed it's pushed up from from the
back end if for example if somebody pays
bill a customer pays a building we push
some information up to old friends so
even if the Fred's get disconnected from
the back and they they keep working face
pal
the second question yes I can certainly
see that so the Hadoop acer is more like
a eunice push stuff in there and then
you can materialize use it but it's
pretty slow I could see that we could
use react as well or instead maybe it's
depends thank you react is more useful
lesson so caching style operation not as
a to archive many terabytes although it
might work or not to and I forgot the
default question
I think Misha is great if you have a
system maybe if it if the task is such
that you need one or two machines the
distribution is not great amnesia or
some people say is not even usable write
their own layer on top of it but if you
if the use cases such as you have a one
machine or a few machines and you don't
need to do very fast replication and you
want transactions and nice ace is
actually great and I've loved showing
this yeah we always piss and moan about
the system of course but how suck it is
but if you look at this this this is
here it's essentially it's exactly the
same thing as clucky and those guys
wrote back in 2005 it's freaking amazing
it still works well and we've done a lot
of tweaks and stuff on it but it's still
fundamentally running in Asia and it's
pretty awesome but it's not going to
scale up to multi data center tank of
environment and then there's no way you
can go I mean sure you could probably
reinvent something some sort of a
distribution layer on top of it it was
really great but especially in our use
case where we don't for the older
creations we don't need transactions so
I don't know of just babbling there I
didn't
no no that's there it's amazing yeah
release and it's always every year since
I started a head down here we thought
that wow this is going really tough this
Christmas and then we bought bigger
machines with optimized and tweak the
system and you could probably probably
go on for a little bit longer but it's
it's actually getting more and more
difficult to death the business is
growing faster we can make the system
slicker ah sorry shouldn't keep you from
thank you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>