<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Step by Step - Implementing Redis In Erlang: Chad DePue | Coder Coacher - Coaching Coders</title><meta content="Step by Step - Implementing Redis In Erlang: Chad DePue - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Erlang-Solutions/">Erlang Solutions</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>Step by Step - Implementing Redis In Erlang: Chad DePue</b></h2><h5 class="post__date">2012-05-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/cqY7b877gxQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">alright so we're going to talk today
about a reddit implementing reticent
Erlang we're going to drop off you are
there at us implementing a reticent
Erlang step-by-step walkthrough so I'll
tell you a bit about myself my
background I have a back on a Microsoft
worked at a start-up here in the bay
area called visto and moved to argentina
in 2008 and started a consulting company
there we both basically focus on iphone
and android apps Erlang systems and
rails I would say right now we're about
thirty percent each but erling is
growing fast for us so we have about a
17 developers so we're we're really
seeing a lot of uptake in Erlang our
vision is basically to be a remote
startup incubator so we work with
early-stage startups that usually have
angel funding or have a small venture
round due end in if if the client
doesn't care will use Erlang for the
server piece sometimes they are a little
wary of functional languages so they'll
you know
thing else
the iphone piece and the in the server
Erlang and and then actually our most
common scenario as we do the you know
not an iOS app an erlang server and then
a rails admin and it's kind of a
combination we found works really well
for our clients we've done a few big
apps work with mtv and done a couple of
social networking apps and so our focus
is often on sort of media type
applications which is a good fit for
messaging in Erlang so my go to a talker
basically for you guys to see a server
that you know in Erlang to kind of walk
through Jen TCP age in fsm which are the
tools we used to build it see how we
implemented the Redis API and then see
how to extend it so actually I'm case
does everybody here know what read it
says or anybody here not know probably
not a good idea to ask who doesn't know
because no one wants to raise their hand
but so we're this is a really fast in
memory with a disk back key value
database Redis is uh if if you don't
know it's very similar to what i would
say is like a much more capable
functional min pack so if you use an in
cash you're familiar with that i think
it was kind of a spiritual foundation of
Redis but it actually does a lot more
than as we'll see and then this is
essentially an early base level d be
back currently key value store that
speaks the reddest protocol so you know
going a little bit deeper it's basically
Erling server that uses gen TCP and
janetta some reasoning leveldb although
you don't have to we implement the full
gratis command set and we respect the
reddish algorithms in terms of accessing
data so if you will talk about that
later but you know if Redis performs in
a certain amount of time we
theoretically are going to perform in a
slower amount of time but the same big o
notation so I guess the first question
is what's the point of Redis what makes
it work cloning I think in the course of
writing is talk I thought about a lot of
things that make reddit
something really unique and I thought
that it's a why I think that I came up
with three things that really make it
special the set feed backing a lot you
just name it up it'll be better bad up
is bad down is better yeah battery swamp
urology
alright cool alright sounds good so yeah
basically thought a lot about us and
what is it it's interesting about it and
I think they're sort of three things
that are really cool all right one is
it's incredibly fast too is it's very
expressive and then three is it's really
easy to employ so these are the things
that are sort of rightfully the the
freedoms I think so great essentially
the issue Salvatori who the crater
credit said it you know I'll you just
read this quote but he basically saying
that it's incredibly important if you're
worried about energy consumption to be
really fast faster you're less server to
me whatsoever you need you know if
you're running thousands of notes or
whatever you're going to save money
right I think that's true and i think
that like it's sort of an alternate
approach sort of the early model so he's
really focused on raw speed on a single
thread i think that he's right and i
think that there's a reason race is
really fast and i'm often seen with
article because we can get away with one
right of server i talk to clients a lot
one red server with a number of the web
servers because rights is so fast i
think to the command said so these are
some of my favorite command so regs
allows you to do p value sort would set
and get it allows hash tables as well
you can set and operate on those it
allows you to operate a list and you can
also subscribe to transaction so if
you're not familiar it's a very simple
way of doing publish-subscribe i think
that connects a client i can start
publishing out any client and subscribe
basically using a regular expression to
an arbitrary number of cues and and it's
just really incredibly simple as an
example my favorite command this is
called our pop out push i don't know if
you guys can use this command before or
seen this no one okay great this is this
is really good it's a good example so if
you think about you have a run if you
imagine these are sort of like work
items like
you know job I need and you got me
stored somewhere else maybe a postgres
or you know whatever some other database
so you got this this key and read it's
called work you now you guys other q
called the run maybe you're going to do
something to that q well and that has
one running job so what you do is you
can call our pop I'll push on work queue
and run queue and it's actually going to
pop the right no side mount another cue
stick it into the wrong key atomically
and just in turn results so any
connected clients going to see this in a
comic operation and if they did you know
in early community there's kind of a
sense in which it's like you can do this
kind of stuff in your sleep and early
but I think you think about a lot of
other environments where you're updating
Ruby and some of the other other
languages where you don't have a sort of
active process running where you can
kind of do things later you can kinda
feel fantastic and timeout after 10
seconds about her you know a few
milliseconds whatever um this kind of
thing is really powerful so you can kind
of build on top of it you can you know
sort of have this queuing system for
instance if you guys are familiar with
they get a party rescue rescue is a very
popular Ruby queuing system and the jobs
and the workers are all running in Ruby
but the queuing algorithm to make sure
that you don't do dumps twice and it
thinks it taking care of his all in red
and then the third thing is it's really
easy to employ you just type reddit
server and you're running server or
right sea lions you know running the
client you can do essentially operations
on the console will be trading 94 so the
thing is ritas is really really fast and
it's incredibly powerful but it doesn't
do everything there's a couple of things
it's not so great at the first thing is
it's not the best disks back database so
it does have to file formats and
actually there's a long article that
i'll post at the end by the author of
reddits on sort of options a 25 point
there's a
and only file at work salt lake caption
be so the transaction is written to disk
and you just you know goes out as long
as is the files open and then the node
we starting to have to replay an entire
file like a my sequel you know command
mom and then there's another platform at
which is more of a database it's not a
pen only so it's more like a compact
database on but both of these are
essentially not your never committee
when something goes in red so something
goes in heretic you sort key in
arbitrary number of seconds later and
get ready to dish so if you're really
worried about recoverability its you've
got some issues there and then the other
names that data has to fit in memory so
if you're working with a loud people or
deploying reddits in there like you know
we haven't deployed 96k 158 servers
because they've got to have enough RAM
keep their the entire with these other
data in memory so it's kind of issue
Rams keeper these days but it's not that
cheap right so it's a convenient shoot
so um the second of you trade for its
lack of availability so the thing about
right since you can do these really cool
commands you can you know excessive
powerful stuff but we can't add your own
commands you can't sort of say you know
I love our pop I'll push but I wish I
could do that you get the number of
items back at the same time is all over
the habits in another command request
that and that is not a comic I need to
know that you know so i can make some
decision there's a lot of things you
can't do and it's unless you're going to
crack up in the code i talked to someone
who's here just the other day that
they're doing that and they have their
own sort of four credits for that reason
which is really cool but you know it's
not super expandable so then there any
two dot 60 just coming out I'm know in a
few days practically Lewis support
you can actually push Lua into rattus by
studying certain key and you can execute
that inside right which is cool but the
thing is reading is a single-threaded
really tight event loop server and if
you're in this single thread loop and
you're you know everything's great
you're responding it like 200,000
operation a second and then also you're
running a little code Louise really fast
too and I love little but it's like
you're sort of getting away from some of
the predictability of the response times
there's a lot of issues there too so um
I guess what I'm saying is you know
what's just do a quick comparison here
so I guess I hesitate to show this slide
because I it's somewhat i would say
itís is not worthy to be put on the
same flight as rightist yet but you know
so i don't want this to seem like I'm
making claims where I make me I really
respect that but we're trying to do
something a little different and you
know I guess this is aspirational so
maybe one day you know someone else
didn't create it but will generally
compare us in the same breath tonight is
they basically fast we're actually quite
close to see it's going to remain set
which we've implemented um it has a
little bit of a nonspecific guarantee
around you know dis right whereas you'll
see we're trying to sort of guarantee
that using leveldb you can extend we'll
see you later and then really the
biggest thing is your data didn't see
the size of brand because we're using a
disc back store we don't actually need
to have all the keys in memory so we're
going about three things we talked about
how we included the protocol how we miss
the performance
kind of how you can send it and then at
the end to can talk about how you've
deployed it in our environment so suck
on the protocol so this is actually a
quick walk through of if you guys can
see that okay this is a sort of how you
learn I'm afraid so you can tell it into
res and you can you want to do this set
man you want to set the key Lang to be
the value early if you do that you're
going to basically send in your going to
send in the number of parameters and I
would call this a text-based by any
court also every parameter has a link
that's a stranger so you can essentially
easy to sort of read the protocol but
you can send binary data right so you
can what we'll do is we'll split walk
through this you can send in the more
parameters the length of each parameter
the action parameter and then repeat
until you get to the end and then when
you're done representing the turn back
or you'll return okay so this is an ugly
stage this is this is what's going on
when you set command so and we're going
to come back in these states in a bit
we're going to see how these states are
important for how many the early piece
of this so what's we'll go back to this
in a second so we'll talk about the AB
structure of it so we have a typical
early application structure it's a has a
supervisor tree it has a set of 141
supervisors with the exception of our
client supervisor we have essentially if
you're familiar with Redis it has by to
call 12 databases you can change that we
have a process for database it's managed
under a database supervisor we have a
listener supervisor which is going to
handle the listeners which are listening
for such connections once the socket is
great a ring can inaudible client
supervisor and then there's a
publish-subscribe to devise
we're implementing the read command that
allows you to subscribe to events or
subscribe to publish data and so that is
unsupervised all right I get with me so
far so when we're done I starting up a
server this is what if things look like
we have a couple of we have our DD
supervisors we have our client listener
we have our client manager supervisor
which is actually a supervisor itself
we'll talk about that and then we'll
going to quickly talk about the listener
so here we are inside the listener code
so when we started the listener we are
going to essentially create a new edits
listener chart link here that takes us
into the Edit solicitor knit and then
you can see what we're going to do is
we're actually going to talk about this
Cobra here for a second so this is how
to get down in very part of it so now
we're actually the point we're going to
actually listen to the socket
connections so this is a gen server uses
gent easy peasy how many put here at the
apt or use it before awesome okay that's
great so I'm going to talk a bit about a
couple of things that we and you guys
know this that's great I blow it up I'm
going to tell you kind of what we've
done in terms of researching how to use
it um we're using this trick that Sanjay
a lady cop out on the DA's note save j
he's not here thing yeah well he's up he
done some really cool stuff with Jenny
ze so he essentially is using this this
is a little bit verboten i guess but
he's a using the call to the inet driver
that accepting inside fascia dynamic
driver we made this call the method
rectory
right so it's an on document property
which means that the OPP team could
theoretically change it but he sort of
open the code said hey why don't we just
use this in our gym tcp oh sorry in our
gym server and then we get a synchronous
offense when they come in over the wire
so essentially we're taking this sort of
internal comms at OPP and we're taking
our Jane server so the religion part
here that the async except call and
message that is sent to the tents ever
so once we get a client connection we're
going to get this I have a sink all here
and a new request comes in we get that
message passed in and then we've you a
little bit of work to set up a new
socket and kind of set up all the
options and get it hooked up so this
code is actually inside setsockopt and
we're we're kind of doing a couple of
things when I kind of hook things up so
a client connects can get an inet a
state message and we basically want to
do a couple things to it we want to kind
of mary these things together we've got
a right here online that 95 gonna
actually tell the jenti CP that hey you
know we have a new process that we start
here that's going to be our client we
want to tell you tcp to the controlling
process for the socket is now that
process then we're going to say hey a
client process here's your socket so
we're going to put these things up
together and then down here 1012 say
okay great that's done and we're going
to actually now tell the async priming a
group and more connections right so one
of the things here I've done just to be
clear to is I pulled out all of the
air-handling pay statements mostly
because I just wanted to be simpler for
you guys to kind of see what we're doing
so if you actually go look at the code
the liner's a little off there's more
error handling but
totally for the purposes of explaining
this online just doesn't matter okay so
once we've established a connection the
quantum manager is now going to have
tuna processes under it so the quantum
manager is going to have this edit
client process and it's going to have
the edits command runner so the idea is
that with the we create two processes
the TCP day is going to come into the
edits client and then the edits command
runner is basically going to take all
the commands and actually deal with the
fans once we have something wrong okay
so we've got this quantum connected head
socket and then now we're actually in
the sort of key part system okay so in
this point we're in the genetic ascend
we created it's now I'm going to
basically sit and process all the data
until it has expanded can run now has
anybody actually use jeppesen before
attention pretty good number i'm
impressed even our coffers that's
actually this is truly one of the most
Kiki conferences i love it
so essentially the theme school so I
don't know if you guys are familiar with
early in action which is a great book
it's really funny because I'm those guys
essentially wrote about all the OTP hey
Rick except genetics em and how those
writings talk I see why because it's
incredibly difficult to explain how it
works in a way it makes sense of people
and then you get OTP and you know as the
keynote speaker just said like you can
learn early in two days you can learn
OPP comfortably in a couple months and
then you know again I could sense one of
those like extra kind of things I think
that you learn down the road as you as
you need it and you really don't need it
their argument in the book was you can
do everything you need to do with states
instead of jind server so it's not
explicitly required and so in that sense
it's a little bit against the sort of
spirit of opp which is like the most
mammals set of these four things but
it's pretty cool so we're going to do a
couple of things here really quick so
before we talk about that we actually
need to set some socket options on on
our sockets let me handle the data right
so we do a couple of things here we see
this giant set off line we're going to
set a couple options in the socket I'm
gonna talk about these very quick to
talk about our active ones and packet
line so when you see the socket and
early you want to actually set if you
want to handle data a bit at a time
these are seeing a deal if you've done
socket programming and just with the
low-level Linux system functions you can
do the same thing this is sort of
wrapping that you wouldn't say active
once is that way you can receive a chunk
of data and you will not get another
chunk until you told the saga of you
want more so the key today is not going
to get overwhelmed with data and then
we're actually going to essentially get
some flow control here right so we want
to process a packet but the question is
what come up
and the thing with Redis it's kind of
cool it's packet it's always terminated
by a command so I character 90 so
essentially we can say it's okay we want
one packet of date at first and that
pack is going to be lying committed so
with these two options essentially it's
going to magically send us exactly what
we won ok so let's take a deep breath
can talk about the genesis in so right
here we've got the client stablished
it's talking to the socket and this is
the gen Edison here we are so we are in
the client code and we received a socket
ready message it says hey you own this
socket I cut out a couple of things here
just to don't relevant but essentially
we get a socket ready event we set the
options on there now we're done and now
we have this concept of state ok now
with genetic assumes you know the way I
described it is there's couple things
that happens so we we have this response
the response can be next state or can be
a reply with this extra safe and you
have to stay home state name you're the
same old state so what are those so the
way I would describe these is state name
right here it's going to get replaced
with the name of this response here 172
command start so if you think about it
like this when data comes in this is
technically what's habit does feel ready
what's happening it's not exactly what's
happening but the idea is that when our
client code gets called instead of
calling a general gen server call it's
actually going to call the call that
matches our statement right so instead
of a gen server handle Paul or dents /
Pass we're going to get a command start
all ok and the message to be our data so
let's talk about to this state machine
here for a second so Fernando who
actually is works with me Tanaka and
we'll be getting talk as well he's one
of the he is the major code river to
ed's he and i were talking over beers
and he was like you know i was talking
to him about there was just arguing on
early mailing list about Jenna has since
recently and kind of describe the state
he's like you know the best way I've
ever described it is it's like a
backpacker who's sort of walking around
inside a state diagram and the state
name is the actual places at in the in
the nma right well the worry about here
and the subs in his backpack session
stage it's actually passed around engine
service if you think about the backpack
shells stuff we need the building up in
our command and as we move around to
this tree the state getting exchange
match that so I don't know I never heard
a better analogy so I just copy that and
so we're going to do is we're actually
going to do a trace here so i hit a
trace backing up really quick on these
two guys at its client is my honor and
then I actually mapped that to the state
diagram we can actually see as a trace
last time and where we at in our little
stay back all right ok so we've started
the man's start and we're going to pass
in the same p value vein set llangollen
right okay so what we get up here we got
tcp data we get a star three and the
sacrum and start and then we switch to
the State Arts eyes great now we had a
dollar sign three here and say dark
sides and we're going to switch the
stage i'm at a name ok so then be the
same thing we get to command the command
set so we're going to switch back to art
sighs now in state art sighs we know
waiting for
Thanks argument so we're going to go to
argument and we're going to keep going
through here I'm going to kind of skip
through this to the lane get the last
argument here and then we switch to we
get Erlang's our last date as our data
so for the key in state argument once we
have the data we know we didn't have any
more commands coming so we go back to
clean start now what's interesting here
is on this debug you see we're actually
not talking to the other process the
other process says whoa I gotta run
command set Langer lang and I can now go
do something with that so what's
essentially happening here is the
clients now sending the command list to
the runner and now I actually do
something with so we've got this command
monitor it's now that ain't all and it's
getting all hey here's your man okay so
there's your man runner it's a runt
aeronca man it has its own internal
state it upper cases the command and
then it this is quite the client starts
calling a man runner and it's going bad
command start alright so does that make
sense so far great so basically we're
right now which we've got a couple of
things going on here we've got the state
machine for the runner had a couple of
things going on too so the runner is
essentially they can do a few different
things so ready swimming is really cool
accredits is you can actually compact a
bunch of commands together and just in
this mango multi so if I want to send in
like you know a bunch of sets and I want
to do some operations I can sit in a
multi-state I want to command signal
this man's in finish it by going exactly
instead of one LS command so essentially
there a couple of things I could be in a
multi-state I could be subscribing which
in that case I'm just only looking for
published events I give you an
unsubscribe which means I'm good
my mainstay or I just be handling all in
that so the the runner needs do a couple
of different things so let's look a bit
at the command run our code so the
command water here now has a man to run
and we're going to grab that command
which is an erlang record and we're
going to parse it so there are a couple
of things that we have to do or departs
the command so the way command Part C
works is essentially with the different
types of rice commands you might need to
return data you might need to justify
I'm okay etc so we actually have to take
apart the command look for the
additional things we need check that
were in the right state we can actually
at that point the side of their going to
be need folks they're going to come and
then we're ready to execute man so I
won't show on the parcel in code that's
a bit gnarly to read on a slide but it's
it's also relatively simple in other
words we're just kind of making sure
we're in the right state to handle it
man okay in that point we now this is
sort of the the decision point are we in
the multi you stay are we hope subscribe
at 49 case might do certain things if
not we actually do run
we're going talk a bit about now or
anything so we've got a run command the
commander you remember back to our
original diagram is a separate gen
server it's going to actually send that
message over the TV so the database is
its own gen server and the database will
receive that command and then actually
you know do whatever it needs to do it
right way now we're gonna call it Eenie
here we're going to actually send the
command and then now it's up to you now
one thing to note is essentially what
happens in parts commanders does not
actually set command is only an insect
because registries ability to set
multiple keys at once and in this case
we just have our study of key with only
one value right so we're going to do the
insect man and at this point we're
actually going to take our database has
if the page will have different backends
so we can swap out which back and we're
using depending on the environment we're
going to talk about that in the next
section so at this point you say okay
tell the back end module to write here's
your reference that back any module to
the instance of it or the process and
then we're going to send in this tuple
which says put this key and actually you
know here's the data now you can see
here online 219 this is essentially list
comprehension because we may have
multiple key or key value kooples right
so for all the key values here we're
going to loop through this list
comprehension sending a tuple which is
our command the database put with this
key light hair or set if you got a pair
that make sense
alright so at this point we're going to
look a bit at leveldb so this point
leveldb is going to get a write command
and it's going to call the a-level DV
code which is a wrapper for the Google
Ltd code and it's going to write back at
this so at this point you know we've
actually we're popping stack all the
back of the man whether commander says
I've got a command I want to run that
command I call the database I tell it to
run I get a result great I've got a
result and in this case now we can
decide what are we going to do it so
right here we can say all right give you
a couple of think of it if it's just a
ok response breaks and ok down the wire
and the other cases Redis has a constant
of typed basic set of types it has
strange support as integer support and
one of the nice things about that is you
know if you're usually in a client
language like Python or Ruby or or
anything really you can often store your
native type in you know the driver for
red acceptable you convert your type and
send it in to reddit reddit will send
back the proper type so it gives you the
ability not to do a lot of sort of
marshaling and face today as you as you
work with friends this is where we send
response back and there we go so what
really briefly about what's happening in
the dating this level so who's curious
to my rebuttal TV show feed people ok if
you used react the react The Bachelor
guys actually had really sort of started
to migrate using a lot of level TV it's
um it's written by google it allows you
to arbitrary data it does some really
basic stuff where you put sorting and
the way the bachelor guys have started
is it's more like Google
that is like you know v.v know there's a
little bit more of a whole column story
that's been a typical relational data
store but it has some really nice things
about it it gives you a tonic operation
it's a very simple interface it does a
lot of data compression sorting for you
so it's just kind of really simple and
powerful the other thing is we can pull
a lot of data so you can actually just
really load data into it doesn't have
any problem responding and performing
and the bachelor guys did some pretty
good sort of early performance stuff and
you can see if you look at the react
homepage and reactors pluggable buying
as well so you don't have to but people
really on see you like it so at this
point we've done a couple of things
we've taken these register managed we
stored a key in there we value for our
key we've walk all the way through from
the top of the shack down and we
actually have sorted in leveldb so
essentially the question is how does it
perform now to be clear we we've
implemented all the commands for res in
two dots to drop for you have you been
in new commands in a while so we're kind
of joked it works it ready to keep that
a management would be a little bit like
the mono guys at sea chart where they're
constantly kind of running keep up with
the latest changes to the runtime in the
language but in this case it's really
not the case Redis is pretty stable API
so we can put in all of those and one of
the key things is um Liam we really want
to go when we built edit of performing
basically the same way that register
forms with regard to the big ol time the
algorithm perform
of operations so we did a bunch of tests
we did testing with reddish benchmark
and we wrote a series of custom bench
smart erlang code to test all the
different functions in the server we
don't want a physical servers and try to
isolate the environment and we use
decent servers we surely are 14 and yeah
it's really important to remember that
essentially we try to respect the
algorithm Alexa t except for one thing
which is with Z sets and he said come on
if you guys are familiar with Z sets
it's as ordered set sort so I was like
you put items in my set I can set a
score on items and the items will
filtering the step in order in order
fashion and ready is a really cool stuff
needs a skip list if you guys are
familiar with skip lists it's a really
cool construct its kind of halfway
between a tree and a linked list and hit
your sort of a highway a fast highway
between nodes and a linked list so he
does this thing where he sort of use a
skip list and he also uses a hash table
and he allows you to address items by
looking for a certain score or dress i'm
going to add item itself really cool and
it's really hard to do in early because
of the nature of the data structure
available so we have yet to figure out
how can i implement that in a way that's
performing all right let's order some
numbers so essentially in operations per
second we're going to talk really quick
about sort of the best case if you will
and I wouldn't exactly call the best
case but I'll explain so we have an
in-memory to gave store as well in heads
and then reactions is a process
dictionary really really basic and our
idea was no one's ever going to want to
use edit as an any memory sore because
race is better and faster so why would
we do that so when Fernando came up this
idea how to use a process dictionary
no oil here and so in night since I
think it's actually not very optimizes
in and restore but particularly with the
basic commands to give you a sense of
kind of overhead of Earl Angus right in
other words like a ping command the
thinkpad actually has to go all the way
out of the database layer just by virtue
of the way commands are implemented so
you can kind of see okay if I'm just
going to go today later the Davis your
turn okay I'm basically about three
times slower than then rest and on say
that's actually not that bad consider
here itís is a very you know highly
tuned piece of C code with man years of
focus on performance and s is a project
for a couple of people for three months
so it gives you a sense that just the
raw Erlang missing is actually pretty
good when you get a little bit lower
here in any of these commands are good
um we're going to go on a little bit we
talked about the level DB performance so
we get a well even performance we have
some issues you can see here that
essentially when you look at the elbow
Chanel pop operations we're massively
slower just absolutely massive its lower
and I reminder that analogy of this guy
talked about recently and if you guys
have heard it's kind of interesting but
it's got ya like how fast is you know
registered memory verses l1 cache tours
ltd cash versus ram versus disk writing
idea was you know register memories like
I've got you know a cupcake in my hand
I'm gonna put it my mouth to eat it it's
right here you know and then l1 cache
light doesn't some you know food on the
table over here l2 cache is like this
goodnight you know pantry go Ram is like
a drive to the store and buy something
to eat and go home I might make it and
then you know this is there's food in
the new world i'm gonna go i'm going to
build a boat i'm going to like you know
they'll hire the bunch of price and gold
higher team we're going to sail across
there get the
come back and then theoretically ready
you know five years from now and then a
relative term that's actually this sort
of what's really going on you think
about disc first memory and I didn't
really believe that kind of thing until
I look at this and it's that it's
obvious right so I need it's actually
really good analogy to kind of make you
think well we're doing something really
different we're guaranteeing the days
are two diff by the time returns and
honestly I think these numbers are not
very good evening too much better we do
think there are some issues with how
we've tuned leveldb to make it so bad
but my god was this is a kind of
experimental project so it doesn't
really matter um just a quick anecdote
the reason why we have decided to build
it is and this is something I probably
should have said at the beginning when
we were doing an app for a client and
needed a lot of nodes and four none most
pop is going to be on something related
to what we were doing but it's the idea
it you know you've got this massive
number of humans coming in to watch some
sort of sporting event type activity all
the same 20 seconds has the games on
they all want to watch and what ends up
happening is you kind of need more than
one reddit server to do that and you
don't really go to the architecture know
which know you want and idea was wow
you're really great we had essentially
multimaster you just write any one of
these servers and they would just share
all this data together any memory spine
we want them to all be we don't want
master slave away reticence they'd right
now we really wanted to sort of
clustered support so that was the
original impetus and then get ended up
deciding on to use it we just change our
our protection or the base will work
around this problem but we really like
the project management kind of this
ongoing investment so the idea is that
you know over time it will improve
performance but it at this point it's
not a huge urge a goal for us to sneak
out perform so we're
like to know a place where you know
we're we're okay with it right now it's
a very interesting project um so then
the last really quick thing on top of it
is you know there's some things that you
can do know that this is an early you
just can't do it see you can extend it
for one hooked and that is that when a
command comes in if you really nice to
say you know I want to like run this
command but I want to do something
afterwards and so we greatest kinds of
hooks and we haven't push this into the
main code yet but we can think about it
for a while and we have a prototype on a
different branch and that is that you
can essentially set a hook it will run
on a regular expression set of your keys
so in other words if I have a whole set
of keys and I want to have an operation
runs on those I can set up in a config
file and I can run all this on those
teeth one of the ideas is going all the
way back to our original concept of our
push L pop art I'll push I the thing
about that's so cool about that is um
you know you might want to like do that
but you might want to do something else
you might wanna say wait before I take
this thing I put it in a secondary q I
really like to check and see if somebody
else all you put it into rabbit or if
maybe there's a resource of ailment I
need to go run this on a workers no
doubt somewhere I don't have access to
whether that knows available so I'm
going to pull this thing out and before
I return it I'm going to go check that
that third resource and it's not
available then undoing you know sit back
and just pretending a bit of happy so
that's the kind of you can do with edits
hooks and even is right in Erlang and
they're really simple to write so give
you some flexibility so then the
question is to what's next well we
obviously have some performance issues
there's stuff that just not quite right
yet on we really love that master
Master massive support and we don't have
master slave yet so we are not
supporting the slave of command and
gratis and that's actually quite easy to
implement it just hasn't happened yet
with multi master we're thinking about
either using the react core code because
it's really well tested reliable we also
thought about using g proc and gym
leader and doing some stuff around our
own but i reminded of one of the talks
from last year it's like you know
anybody that tries to do that it's just
making pork limitation of react or so
we're we're still think about using we
at core want to do custom command honors
we just add your own commands and then
we basically want to say you know we
want to add some clips or the rabbit
guys basically are all kind of excited
about this because they also work very
closely with red they're both supported
by vmware or owned by vmware so they've
talked to us and said hey here you do
some rabbit bindings and kind of connect
you know addison trout together in a
cool way I know we've also thought why
don't we just actually allow people when
you push these integers right directly
to react there can be some legal stuff
there so that's pretty much it
traditional fun to go to the source you
can feel the benchmarks in there we do a
bunch of cool ascii art benchmarks if
you run them to animate you can see some
of those that we're doing we're using
some very interesting sort of things
about our land we decided to kind of
really think about different ways to the
user length the reasoning extends the
record you guys are aware of that
reading on to prioritize modules you
bring this amount of our own behaviors
and yeah you can check out the estuary
alright thanks a lot
okay yeah we have time for questions or
why you get one or two questions sure
yeah so the question was reticent
building the concept of a single thread
server so how do we overcome that so
there are a couple of things one is rest
kind of already has a concept of
transactions they aren't sure exactly
traditional sense because you can't hold
them back if something goes wrong in the
middle you're in an unknown sake so we
just input all the commands so really
anyone that's really worried about
authenticity and the command is already
am using the raddest constructs and then
all of our databases are because their
gym server that's operating on these
commands are going to be essentially
like you know singles reading writing
all the operations in the disk so I
couldn't guarantee that the patient
exactly the same but I close up yeah I'm
curious why you use cream is Magic
directly
wrapped all that away or you better is
Cowboys acceptor pool which will
actually go crazy and document attacks
and it gives you transparency if you're
using SSL or TCP directly you can build
a service that get when you don't have
to think about the underlying transport
directly yeah yeah um the answer of both
of those is I didn't know about them
alright that's uh that sounds great
actually yeah serious about the year
because I mean this is a definitely an
experimental project and really think
about how to do it the best way their
school library up their buddies that we
had much luck it doesn't want to add we
actually unigine non-blocking stuff yeah
it looks pretty neat what's that sorry
Jen and be somewhat oh you usually
generating server yeah okay yeah we
should take a look at that it sounded
good it would be a good fit alright
thanks a lot guys appreciated</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>