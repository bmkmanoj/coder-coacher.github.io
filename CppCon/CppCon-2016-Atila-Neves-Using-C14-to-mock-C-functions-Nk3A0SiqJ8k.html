<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>CppCon 2016: Atila Neves “Using C++14 to mock C functions&quot; | Coder Coacher - Coaching Coders</title><meta content="CppCon 2016: Atila Neves “Using C++14 to mock C functions&quot; - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/CppCon/">CppCon</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>CppCon 2016: Atila Neves “Using C++14 to mock C functions&quot;</b></h2><h5 class="post__date">2016-10-07</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/Nk3A0SiqJ8k" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right cool so that's my name my
contact details and I'll be telling you
how you can mark C functions from C
poses 14 for testing now why would we
want to do this well first of us some of
us have to maintain like a CC code basis
sucks to be us but what you gonna do not
testings not an option at least not for
me
legacy code is usually not written with
testability in mind which means the side
effects everywhere
modern sequel sauce I think everybody
here is gonna agree with me is a lot
better than C so how can we write our
tests in C++ a test and legacy C goes
over there now there's a library to
Kamakshi function CPU tests but I don't
really like it too much because they
have design constraints that I don't I
use a singleton which is a global
variable although that entails
it requires linking multiple binary cuz
it uses the linker to actually link to
different implementations that means you
have a bunch of tiny little unit tests
by and race running all of them as a
pain the interface is string we typed
you basically put a string in a hash
table somewhere saying I expect this to
be called and then somebody else on the
other side has to say actually this was
called and puts the string in there and
you actually manually have to implement
the mark which kind of defeats the
purpose and I thought I could do better
with macros and template madness so I
called it pre mark is uses the
preprocessor to mark stuff instead and
it's up there and gear alright so what
is it imagine you have a production
function called foo in a file called foo
dot C now this function is calling sand
and you don't want to do that because
side-effects and where you're testing
your bad because you want determinism
and all the good stuff so contrived
example but lightning talk it just calls
sands which returns the same thing send
does passes the file descriptor doesn't
actually really do anything because it's
no etc now in your test file you're
gonna have a block there the blocks
there on purpose because of rei i and
that's because if you use the replace
macro from my library you can say
replace sand and then replace it with
this lambda until the end of scope but
only until then now this has good
benefits because you don't something any
other unit tests to come afterwards that
might not care if you send packets or
not or actually do so only replace the
implementation until then so if i
replace and with the altered or because
i'm lazy don't care where you passing me
in return seven i can assert like if i
call foo was zero I get back the number
seven because all it's doing is
returning the return volley from said
now the block ends I call foo zero again
now returns -1 why because it's calling
San Francisco kit and zero isn't a valid
file descriptor so you have to go look
at Erin or the other thing you can do
with this if you don't want to pass in a
lambda is
actually mark it with programmability
mind so you go Auto M equals Mach the
macro sent as a function you want to
mock out you set the return value to
five if I call food with three I get
five back because that's what return
volley was I can also certainly expect
called with values and then three and
then the other stuff you saw and the
slide just there because I passed three
to it yeah I can also do this for
multiple return values and then I can
expect called with values there should
be a two in expect called there actually
so I expect to call twice with values
and now I have to pass tuples so I can
have multiple parameter lists the past
of this thing now all of this is type
safe right I can't pass in the wrong
number of arguments and I can't pass in
the wrong types either that won't
compile how do I do this well first you
need to actually include the header file
because this is a header only library
and what you need to do for every
function that you want to be able to
mark is three different things one you
need to use this macro deckle mark on
send I'm including so socket to actually
know what send is that's not a string
that's a symbol and then you need to
actually implement this needs runtime
support obviously but you don't need to
write the code because I have a macro to
do it for you so you include the
previous header you have now you use
this different macro called implement
default with the send function in there
and then you have to compile your
production code with either - G switch
every single instance of Santa you T
underscore sent or you can put that in a
header file then - include that so you
can so you have you need some build
system support for this but this is
literally all you have to do and
everything I just showed you just works
now notice also what's not here I'm not
telling the system or the framework in
this case anything about sin I'm not
there's no return type anywhere there's
no argument list the only thing I can
get rid of is that 4 and that 4 is the
number of parameters that sin takes and
I'd literally can't see any other way of
doing this but you do this your
functions are marked
everything's nice and the worlds
beautiful again thanks</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>