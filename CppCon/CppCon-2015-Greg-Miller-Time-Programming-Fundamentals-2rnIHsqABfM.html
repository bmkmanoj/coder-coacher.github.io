<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>CppCon 2015: Greg Miller “Time Programming Fundamentals&quot; | Coder Coacher - Coaching Coders</title><meta content="CppCon 2015: Greg Miller “Time Programming Fundamentals&quot; - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/CppCon/">CppCon</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>CppCon 2015: Greg Miller “Time Programming Fundamentals&quot;</b></h2><h5 class="post__date">2015-10-11</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/2rnIHsqABfM" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">my name is Greg Miller and I'd like to
thank you for showing up to this early 9
a.m. talk about time programming
fundamentals happily this isn't doesn't
feel very early for me since I'm from
the East Coast where it's already about
lunchtime
however despite that time difference if
an East Coaster we're watching this talk
right now we would still agree that the
talk is happening now and these are the
aspects of time and time programming
that I'm going to be talking about today
you might call it human scale time very
briefly I'm not going to be talking
about clocks or timekeeping or a time
synchronization and since there's always
some comedian in the room we're not
going to be talking about space time or
relativistic effects either I've worked
at Google for about 10 years and I've
watched Google's C++ code base grow to
well over a hundred million lines of
code some non-trivial fraction of that
deals with time now Google's time code
is no better or worse than anywhere else
we think it's pretty typical and what we
see is some of this code is very
complicated some of it's obviously wrong
some of it's subtly wrong and every once
in a while some of it looks good and
some of the reasons for this are that
time zones are complicated calendars are
complicated daylight savings time is
very complicated it seems almost every
six months there's some news article
about some piece of technology that did
the wrong thing during a daylight
savings time transition we can probably
look forward to that again in about a
month and a half and programmers don't
have a good workable mental model for
how to think about and how to reason
about time in their code and time
programming libraries historically have
been lacking in some areas so for the
past couple years my colleague Bradley
white and I have been working to fix
these problems within Google and since
we don't believe our problems are unique
to Google we think our solutions might
be useful to others outside of Google as
well so before any meaningful
communication can take place we need to
agree on the vocabulary we're going to
be using
and then I'd like to move on and talk
about some of the classic time
programming api's that we've all used
and have shaped most of the time
programming code that we see today and
then I want to give you a simple mental
model that will help you reason about
your code and think about time concepts
and then I'd like to leave you with a
handful of pro tips that you can start
using today in your existing code to
help improve and simplify your time
programming so let's get started talking
about a book at the vocabulary I'd like
to talk about civil time UTC a boot time
and time zone a civil time you can think
of as just normal human time it's when
someone asks you what time it is you
look at your watch and you tell them
it's 904 and that's a civil time a civil
time is fundamentally six individual
fields that represent the Year month day
hour minute and second we typically use
the Gregorian calendar and in programs
civil times are typically represented by
you know a type like a struck TM or a
stood TM here or even a civil time could
be six separate integers representing
your month day hour minute second even a
string like right here this string is
still a civil time it's year month day
hour minute second that brings us to UTC
UTC is the predominant international
time standard used throughout the world
UTC is basically the the time the clock
that we all synchronize our watches to
and we use this to agree on what time it
is it's the basis for all the local
times around the world and UTC there is
no daylight savings time there are no
transitions every day has exactly 24
hours and the UTC clock ticks si seconds
so a second and UTC every second is
exactly a fixed length defined by an
atomic clock and UTC uses leap seconds
so that the UTC clock kind of stays in
sync with the solar clock where the Sun
actually is
and then I'd like now I'd like to talk
about absolute time an absolute time
uniquely and universally represents a
specific instant in time this instant is
something that everybody would agree on
when the particular instant is the fact
that this talk is happening right now it
doesn't matter where you are where you
may be watching this absolute x or x own
independent absolute times are typically
represented as account of some unit sent
some epoch and classic examples that
we're all familiar with are time T
there's a great example of an absolute
time in C++ did Chronos system clock
time point is there a another good
example or really you can have any
integer counting something since some
when would be a fine example of an
absolute time and just to show the
relationship between absolute and civil
time if you think about when Neil
Armstrong first took the very first step
onto the moon that first step happened
at some specific instant in time
everybody would agree on when that
happened but we're you or your parents
were sitting in your living room and
looking at the calendar on your wall and
the clock on your wall this that's the
civil time of for you when you saw that
happen the civil times for where you
work may be different for people all
around the world but he didn't take this
his first step again an hour later for
the people one timezone over that
happened exactly once and then this
brings us to time zones
time zones are how we relate absolute
times in civil times time zones give us
the rules for converting between
absolute and civil times these rules are
defined as offsets from UTC these rules
can change over time so this notion of a
time zone includes a whole history of
potentially different time zone rules
for different periods of time these time
zone rules are established by local
governments so sometimes they can be
quite complicated and many time zones
use daylight savings time rules so they
staged their offset throughout the year
and these strings in green down here are
examples of Val
good timezone identifier x' they're
typically represented like a continent
and a major city in a certain area so
America New York the timezone we're
currently in right now is called America
Los Angeles Australia Sydney is another
one PST we typically think of this
Pacific Standard Time that's not a
timezone identifier it's not a valid
timezone identifier now some interesting
time transitions so we'd like to think
that time transitions happen like
daylight savings time is like an hour
you know spring forward fall back that's
not really not how it's not how it
always works for instance in the United
States even you know the Arizona Phoenix
timezone doesn't use daylight savings
time Asia Katmandu jumped 15 minutes in
1986 and that was not because of
daylight savings time so you can have
time transitions that are not because of
daylight savings time and Australia Lord
Howe uses a 30 minute daylight savings
time offset so even if you think that
daylight savings time is in effect it's
not always 60 minutes and Pacific a Pia
in 2011 they skipped the whole day of
December 30th it just doesn't exist
there and in that particular case they
were switching sides of the
International Dateline and Africa Cairo
used to skip the midnight hour during
their springtime daylight savings time
transition as actually as of this year
they no longer do that they no longer
observed daylight savings time but
previously before last year
they're before this year there was no
midnight on this day there was no you
know 0 hours 0 minutes 0 seconds on this
during this transition and African
Monrovia used to use an offset of 44
minutes and 30 seconds so transitions
aren't always a nice round number
so the takeaway I'd like you to remember
here is don't try to special case time
zone transitions
don't try to like write code to say ok I
know there's a transition let me figure
out what I'm supposed to do there's over
500 time zones there is updates to time
zone data maybe about 8 times a year so
it's way too complicated to try to write
that special case code yourself and now
that we have a vocabulary let's look at
a very common way we represent times in
computer programs
as a string and let's just kind of
figure out what's in this string let's
diagram it so these first three fields
here give us a date and here's a time
and together we know that's a civil time
it's six fields your month day hour
minute second and this green number here
is a minus seven hours here this
represents an offset from UTC so this
kind of tape takes the you know place of
like a time zone and this whole thing
together a civil time with this offset
gives me an absolute time so this whole
string here represents a specific
instant in time it doesn't matter what
time zone you're in this string
represents a specific instant in time so
now I'd like to talk about some of the
classic time programming AP is not a
whole lot here hopefully most of this
will be review review for people but
these are the classic time AP eyes
they're still with us today
these api's have shaped most of the
modern time in timezone libraries that
exist today and lots of the time code
that exists today and fundamentally
they're based around this type called
time T and a time T is a count of
non-leap seconds since January 1st 1970
0 hours 0 minutes 0 seconds in UTC so a
time T value of zero represents this
date and time right up here that date
and time we typically refer to as the
UNIX epoch so you may hear me say that
and a stood TM or a struck TM this
represents a broken down year month day
hour minute second there's a handful of
other fields in there as well but
fundamentally a time T is an absolute
time and a struck TM is a simple time
and we're also given two time zones with
which we can work we can work in the UTC
time zone or the local time zone and the
functions we have are to go from a time
T to a TM we have this GM time function
and in the if we want to do that in the
local time zone we have a local time
function that will map from a time T to
a TM if we want to go the other
direction in the local time zone we can
call Mick time to go from a TM to a time
T and in UTC there's really no
corresponding function for us but that's
B
because in UTC since there's no offset
transitions you can actually just do
arithmetic with the fields of the TM in
order to get the absolute time so I just
want to look at a quick example of these
using these classic api's there's
nothing new or fancy here so there
shouldn't be anything too surprising I'm
assuming some format function that just
takes some format string and a stood
struck TM you could imagine this is
implemented with stir f time or put time
but this example here let's just look
again we're gonna be creating a time T
called now that represents the current
time that the current absolute time in
this first block here I'm gonna use this
GM time underscore R function that takes
the current time and fills in the struck
TM with the year-month-day fields the
civil time fields that represent the
correspond to this current time and I'm
just gonna format it for this percent F
is shorthand for a year month day
separated by hyphens and % T here is
shorthand for our minute second
separated by colons down here this last
block here we just you do the same thing
but we use the local time function and
we'll just break down the current time
in the local time zone and we'll fill in
this truck TM and we'll just go ahead
and print that as well and now this is
all fine it works works perfectly well
the problem is the fact that there's
only support for two time zones yet many
time zones exist and the fact that many
times does exist has led to many
potentially complicated workarounds to
support all these different time zones
and most of these workarounds boil down
to a technique that we call epoch
shifting and we're going to go ahead and
look at that now so let's see how we can
add support for arbitrary time zones
most examples of epoch shifting boiled
down to a function that looks like this
one right here I'm calling it get offset
they're typically named something like
get offset they take it takes a time in
absolute time and some indicator of a
time zone in this case I'll be Pett
we're passing a string to indicate the
time zone name and it says in this time
zone at this time what's the offset so
that's the fun
get off set function now let's see what
we're doing again we get the current
time now this first block here I want to
say I could call get off set in America
New York at now at the current time give
me the current offset then I'm going to
take that offset and I'm gonna add it to
now and I'm gonna store it in another
variable here I'm calling now NYC and
then I call this GM time function this
these three lines here just like they
were in the previous slide I break down
at now NYC and I fill in the struck TM
and I'm gonna go ahead and format the
time the year month day hour minute
second in New York City now I want to go
back the other direction so given my now
NYC my local time T I say get off set
for this time now NYC again in America
New York and since previously I added
the offset here I'm gonna go ahead and
subtract the off stick so I'm trying to
undo this operation and I get now UTC
and so the question here is are these
two guaranteed to be equal that's one of
my questions well let's go ahead and
take a look at some of the other
problems that we see with this code I'm
gonna say the most fundamental problem
here is that now NYC is not really a
time T you let me explain there's two
ways I can think about what I'm doing
here I'm taking now and I'm adding an
offset to it so either now NYC doesn't
represent now it represents some other
time some other time that's you know
offset seconds or whatever away from now
so it doesn't represent now or I could
say well I'm gonna pretend it actually
does represent now and I've just shifted
the epoch instead of the actual instant
in time and so if we look at how this
code is being used it's named now NYC
these clearly the intent of this code is
that this point represents now just in
some other time zone so what's happened
here is I've shifted the epoch but at
time T is defined to have an epoch from
a specific a specific epoch so if I
shift that epoch it's not really a time
T this should be a different type I
should call this a my time T or
NYC time T for example is what perhaps
is what I should call that but I don't I
call it time T because this function I'm
calling right here GM time expects the
time T so I put it in the time T anyway
and then what's another problem what is
this offset so as the person writing
this code I have to be somewhat of a
time expert because I have to understand
what is this offset is this an offset
from UTC to me or from me to UTC and I
need to know that because I need to
figure out whether I add or subtract
here we've seen lots of code that you
know it looks right except this sign is
wrong so it's not immediately clear
whether you're supposed to add or
subtract this thing additionally when I
break down this now NYC using this
function GM time are some of the fields
in the struct e/m aren't correct for
example is DST will always be false
since UTC doesn't have any daylight
savings time and another big problem is
this block down here doesn't actually
work so what we're doing here is we're
calling get offset but we and we're
passing in now NYC we previously just
said up top here that now and YC isn't
really a time T we're calling it a time
T but it's not really a time T but get
offset expects a time T so if I pass
something that's not really a time T get
offset may not return the right value
and in fact four times that are near
discontinuity some type of you know
offset transition it actually will give
you the wrong answer and so I'll say
that this the you know answering my
question before was is is this
guaranteed to always be equal and the
answer is no it's not it will sometimes
and maybe when you're writing the code
and you're testing the code it's the
same but then when you deploy and run
the code whoops it's wrong sometimes so
the takeaway here is I want you to
remember that there's really no such
thing as a local time T there's a time T
that's a valid actual time T and there's
really not a local time T so now I'd
like to give you a simplified mental
model for that will help you think about
time concepts and reason about your code
and I
hope that when you see this model that
I'm gonna show you here you look at it
and say oh that's it well duh that's so
obvious and hopefully it's unsurprising
that it only has the same vocabulary
that we've already been talking about
and what this is here is this is just
showing the relationship between these
things and formalizing the relationship
between these concepts there's the
concept of an absolute time which we've
already been talking about there's the
concept of a civil time which we've been
talking about and the time zone is all
the rules to relate these things you can
imagine for some function f of an
absolute time in a time zone you can
compute a civil time and for some other
function f of a civil time at a time
zone you can compute an absolute time
the domain of all the absolute times our
time zone independent same with civil
times the whole domain of all the civil
times are themselves time zone
independent time zones are only
important when you want to map between
the two and so this model actually
applies to any programming language in
any date time library you may be using
and now since I said this is simple I
should probably point out what's missing
it's probably simple because it's
missing a few things so what it's
missing are the fact that these time
zones are opaque you can't take these
time zones and say give me the offset at
some point in time because we don't want
you to do any Epoque shifting you
shouldn't have to take that offset and
add it to anything or do any arithmetic
to it that's what a time zone library is
supposed to do for you so there's no
access to offsets no local seconds
there's no access to the future and past
transitions and when I think about these
missing features you know this is Ken
Thompson one of the principal inventors
of UNIX that you know he was once asked
about the UNIX file API and the question
was about you know well where's this
feature and how do you do this and
where's all this you know record support
and where how come it's missing all
these things and his response was these
concepts fill a much needed gap and so
let's take a look and see how these
classic api's fit into this model so
I've written some of the some of the
types and functions here green I think
these are pretty good fit a time T is a
is a fine absolute time then it only has
you know second granularity but that
might be fine in some cases stood front
a system clock time point it's another
that's great fits very well the things I
wrote in red here I'll say you know
there they fit but they could be
improved so for time zones
there's only support for UTC and local
time so we could probably improve that
and for civil time there's the struck TM
which works for a civil time it leaves a
little bit to be desired the years or
offsets from 1900 the months or zero
index so it's not the easiest thing to
work with and for again for going from
absolute to civil we have this local
time function and civil to absolute we
have make time and again those work just
in the civil or I'm sorry the local time
zone and so to try to fix these problems
within Google we tried we built a new
time zone library that very closely
matches this model we call it CCTV for
the C++ time zone library and in blue
here here's some of the types and how we
this library maps it into this model for
absolute times we have the CCT Z time
point now this is pretty much just a
system clock time point is defined only
for the system clock it just has a wider
range as 128 bits of range to avoid the
292 Year issue because within Google we
wanted actually one time type but it
implicitly converts from a system clock
time point timezone is represented by
the CCT z time zone class all these
things are in this namespace so time
zone can represent any timezone a civil
time is represented by a c c TZ break
down you can think of it just kind of
like I want to say a better struck TM it
has the civil time components your month
day hour minute second and a few other
fields that we'll see in a moment and to
go from an absolute time to a civil time
there is the break time function and to
go the other direction from civil to
absolute there's the make time function
and we're going to
look and take a look and see how these
things work in some examples and let's
starting off with a hello cc TZ example
yes I'm not assuming daylight savings
time is on so the question is about
conversions with daylight savings time
and I have a slide in about two slides
we will definitely cover that so just
hold tight please
so hello CCT Z's so this I just want to
show to give you kind of a feel for the
API you know we did this in Google's
programming style conventions you may or
may not like that please don't crucify
me but that's how it's done here so most
of this code is going to start off
looking the same
we're going to do we want to time zone
I'm going to declare a time zone for
Sydney Australia I declare this variable
I call the function load time zone
I tell it Australia Sydney I pass in a
pointer to the time zone object load
time zone will return bull if it you
know indicating success or failure it
will load the file it will load the time
zone from the time zone data on disk
usually on Linux that's like user share
zone info
it'll also then cache it so subsequent
calls to this are very fast then here
we're going to call make time and I'm
gonna to make time I'm gonna pass six
fields and we probably know what these
six fields are they're a simple time so
I'm gonna say 1969 July 21st
12:56 in the afternoon zero seconds in
Sydney Australia and we know that from
our model when we think back to the
mental model a civil time and a time
zone gives me an absolute time and
that's what make time is doing right
here so this gives me the absolute time
for when Neil Armstrong first walked on
the moon that's the absolute time when
that happened and then I'm just going to
come down here and I'm going to call
CCTV format again this is just this is
very similar to stir f time except
there's a few extended format specifiers
that i won't be talking about but are
documented and format takes an absolute
time and a time zone and it's going to
go ahead and format this a
timepoint yes which is an absolute time
yes it takes a time point and a time
zone and down here I'm gonna go ahead
and load up another time zone I'm gonna
load up the time zone for America New
York now I'm not checking the return
value here for two reasons one is
because checking the return value on the
slides kind of takes a bunch of space
and also the definition of load time
zone is defined that if it fails to load
the time zone it sets the argument here
to UTC which a lot of people have said
is the default behavior they want so
your that's why that's not being done
here and here we're going to call make
time again and I'm going to pass in a
different civil time so here I'm passing
July 20th at 10:56
in the evening in New York and that
gives me another absolute time but these
two time points are guaranteed to be
identical these are the you know this
civil time in New York and this civil
time in Sidney correspond to the exact
same absolute time now let me mention a
couple things briefly about the
implementation of the CCT z library one
is it mostly follows POSIX conventions
in that it ignores leap seconds and it
uses the proleptic Gregorian calendar
which is the standard calendar we all
use today it just extends it forward and
backward in time it uses the eyes Ayana
timezone data from the local system for
example you know in user share zone info
and fields when you call make time and
you pass in a year month day hour minute
second field any fields that are out of
range will automatically be normalized
to be in range so if you pass in october
32nd for example it will normalize that
to be november 1st and we'll see in an
example coming up here about how that
can be very useful it's faster than the
Lib C equivalents now we have run a
bunch of benchmarks it's hard to tell
you know it's hard to say for certain
that every machine every compiler every
hardware thing it's you know faster so
I'm gonna say in every benchmark we have
it's faster I don't think speed is the
reason to use this or something like
this
but it shouldn't be a reason not to use
it and the implementation gives us some
very nice default handling of
discontinuities for example daylight
savings time so we're going to go ahead
and talk about that now we're going to
talk about the daylight savings time
transitions and how that how that works
because these are the real complicated
things that end up in pages and pages of
comments followed by like one line of
code so first of all daylight savings
time is in quotes here because what
we're talking about here are skipped and
repeated civil times and whether that is
because of daylight savings time or not
is immaterial so we always think of
these is because of daylight savings
time but they're not always because of
daylight savings time and let's just
start off here looking just at this
graph here on the Left this vertical
axis here is absolute time this
horizontal axis here is the civil times
like 1 a.m. 2 a.m. 3 a.m. 4 a.m.
etc in the case of spring let's in this
example let's say it's America Los
Angeles in the case of the spring time
we skip the 2 o'clock hour so we we go
from like 159 and we jump over to 3 a.m.
this diagonal you know the blue line
here is time it increases that you know
one second per second so the question is
what happens if you ask for give me the
absolute time that corresponds to 2:30
a.m. on this day so this is the question
is what happens then well what we could
do there is first of all we could just
give an error we could say oh there is
no 2:30 and you know you're done you
can't do that pardon
you could you could throw an exception
you could return some type of there
but we'd like to try to do better than
that
so what could we do well we could say
that 2:30 if this line here were
extended down it would intersect about
here so we could give you this absolute
time that kind of corresponds to this
first intersection or we could maybe say
well of this line extended up here it
would intersect here and we could give
you this absolute time or we could also
say well the time discontinuity happened
right here so we could just give you
that time right there and so the default
behavior that we picked for CC TZ is
that it follows the as if rule it says
that is what time would we give you if
there was no discontinuity if there
wasn't no discontinuity there would this
line would just be extended up and we
would give you this point right here
that corresponds over there and in fact
that's what we do it ends up that we end
up using the pre transition offset is
the way that works and we think that
really matches with people's just
intuition if you think about waking up
you know after there was a daylight
savings time changed that evening and in
the afternoon someone asks you what time
is it you look at your watch you say oh
it's 5 p.m. well it's really 4 p.m. we
tend to do that for about a day yes the
question is if that happens where
someone asked for a time that doesn't
exist is it usually a programming error
or a user input error it could be those
it could just be that you're trying to
write a write a code to you know bucket
log data you know in two hours and you
know presented on the screen and you
just happen to be presenting data on a
day where there's you know 23 hours in
that day so you might be you know
iterating the hours in that day so
there's very legitimate cases where you
might want to ask for say 2 a.m. on this
day that's not always because of an
error so it depends on the case now let
me say the fall case is very similar you
know in this case the one o'clock hour
is repeated so there's two points in
time that court that have the label of
1:30 a.m. in the fall and so again when
you ask for 1:30 which one do we give
you do we give you this one or do we
give you this one and again we just
follow the as if rule if there was no
transition what point what time would
you get well you would get this one
right here and that's what we give you
now we think this is a very good default
behavior it's what our make time
function return'
yes yeah yeah weed yes well if you're
talking about difference between abs I
mean if you're doing difference between
absolute times you know you're in that
question you're a little bit mixing the
question is if I tried it if I take the
difference between 259 and 3:00 a.m.
don't I couldn't I get something that's
you know maybe negative or or funny and
I'd say in that case you'd probably want
to rethink a little bit about what
you're doing because you're mixing the
notions of civil times and absolute
times you're thinking of civil times but
taking a difference in absolute times so
I think if you clear that up a little
bit I think you're gonna find that you
don't actually want to do the
computation exactly as you described so
like I said this is the default behavior
we give but and we think this is good in
most cases however we do understand that
there may be cases where you need to
have some special handling for when some
time doesn't exist or when it's repeated
and so we have another function and that
I'm showing here these we have two
versions of make time we have make time
down here on the bottom this is the one
I was just describing this is the one
that does the as if behavior it uses the
pre-transition offset and I think that's
typically the one you would want to use
the arguments to make time are six
fields a civil time and a time zone so
you past year month day hour minute
second and it's going to give you a time
point there's no error case here in the
case of repeated or skipped transition
transitions it's going to pick something
sensible now if that does
work for you there's this other version
called make time info it takes the exact
same arguments your month day hour
minute second in a time zone and it
returns this time info struct and the
time info struct tells you everything
you need to know about that conversion
it tells you whether that conversion
whether that simple time you asked for
was unique and existed or whether it was
skipped and didn't exist or whether it
was repeated those are the three
possibilities it also tells you if we
think back to the graph those
intersection points it tells you what
would the time point have been if we use
the pre transition offset what was the
transition point itself and what was the
time if we had used the post transition
offset and from these three fields here
these three values you should be able to
compute any reasonable time point you
could possibly want including just give
an error yes because we needed the
question is why use in 64 for years and
the reason is because internal to Google
we ended up wanting one time point that
could represent all of the times for for
every for all the applications and we
ended up using basically a 128-bit
representation of nanoseconds and that
ended up being able to produce more than
32 bits of years so it does it's not a
full 64 bits of years you know it and
also it gives you this boolean
indicating whether or not it normalized
any of these fields because again by
default that always normalizes the
fields if you ask for October 32nd it
will give you November 1st but if you
want to treat that as an error you can
that people tell you if it had to do
that so mostly I would say generally
make time that just returns the time
point is probably what you want in going
the other direction break time this is
going from an absolute time a time point
to the broken-down civil time so we call
call it break time you give it a time
point
in a time zone and it returns this
breakdown structure again breakdown is a
lot like a struck TM it has the year
month day hour minute second those are
the main civil time components there's
additionally a handful of other fields
in here that you might need like weekday
and sub-second and year day there's also
these three down here this offset is DST
and a burr like the time zone
abbreviation I think you should probably
not be using those last three fields you
should probably ignore them the reason
they exist is for backward compatibility
with some old AP is that might need to
use these things but if you're using a
time zone library properly you don't
care what the offset is you don't care
whether it's daylight savings time or
not because your code is generic and it
works for all time zones at any time
point and so you don't care about these
so I would say try not to use them
pretty much ignore them if possible now
I'd like to look at some examples of
real programming examples that show that
are common and what they look like
using the CCT z library so again this in
this case translating civil time so
translating it civil time from one time
zone to an equivalent civil time in
another time zone all of our examples
are going to start off pretty much the
same we're gonna declare a time zone
we're gonna load up that time zone so
here's all the data for America Los
Angeles now this time zone object is
actually really really small it's about
it's about one word and you can pass it
around by value all the types in here
are little value types so we're gonna
just load it load this up then we're
going to call make time we're going to
get the absolute time for when this talk
started I want to say make time 2015
september 22nd at 9:00 a.m. that's when
this talk started in this time zone down
here i'm going to go ahead and load up
the time zone for America New York and
then I'm just going to go ahead and use
CC T Z format and I'm going to format
this same time the exact same absolute
time in two different time zones so the
only thing that's changing there is the
time zone this percent little Z here
gives me the numeric offset for the time
zone at that in
and this big Z here gives me like the
string abbreviation I'm including these
here just so it's kind of easy to see
read in the output and so the output of
this program well it the output of this
program is talk starts at 9:00 a.m. and
a minus seven
that's PDT Pacific Daylight Time was
where we are right now and the talk
starts at 12 noon in Eastern Daylight
Time so it's very easy to translate a
civil time from one time zone to another
and the things to note here are there's
no mention of offset I mean other than
the fact that I'm printing it just so we
can read here but there's no I don't use
an offset
I don't compute with an offset all I'm
doing here is just calling a couple of
functions and you know perhaps you know
converting types so we just saw what
formatting looks like let's see the
other side what does parsing look like
so the string I'm going to parse here
I've defined up here it's a civil time i
name it civil string it's 2015 922 at
9:35 a.m. so that's the string I want to
parse and then we're going to go ahead
and load up the America Los Angeles
timezone I'm gonna this time I'm gonna
call CC TZ parse and that takes a format
string the same type it like just like
aster p time format string so you're
probably pretty familiar with this I'm
gonna parse out a year month day hour
minute second from this data here from
this time string I'm going to say parse
that with respect to the LA Times own
and then this is going to give me the
absolute time that I parsed out of there
and it returns bool indicating whether
it was able to parse or not and then
down here I'm just this isn't really
about parsing but I'm just going to call
stood chrono system clock now to get the
current time and I'm gonna see if now is
after this time I parsed then this talk
is running long otherwise it's on time
and that when I ran this many days ago I
was definitely on time I don't know
where I am now okay so I'm running long
thank you alright so now let's look at
an interesting example of adding months
so this is fundamentally a civil
time computation you can't add months in
the absolute time domain there's no you
know stood chrono months duration that
doesn't really even make sense it's not
the right question to ask so if you want
to think about adding months you really
need to be doing that in this civil time
domain and I'm going to show how you can
do that with CCTV again we're gonna
start off unsurprisingly load up a time
zone get the LAX time zone since that's
where we are today
I'm going to get stood chrono system
clock now to get the current time and
I'm going to call break time I'm going
to break down the current instant in the
LA Times own and I'm going to get this
breakdown structure remember breakdown
is a Sybil time it has your month day
hour minute second and then I'm it down
here I'm going to call make time again
so I want to go from some civil time to
an absolute time and I want to say from
this break down give me break down the
year the current month plus six and I
want the first of the month I want six
months from now the first day of the
month I'm just picking and 0 hours 0
minutes 0 seconds in LA then I'll go
ahead and format this I I saw I'm
initializing the absolute time then and
I'm gonna go ahead and format both of
these now when I ran this the other day
was 917 at 9:02 a.m. and the output for
six months from now is well September
October November December January
February March so six months three and
that's what we get here March 1st and so
the thing to note here is that this
arithmetic right here is done in the
civil time domain I'm adding six civil
months and the fact that this may become
larger than twelve and need to be
normalized is fine because make time
always normalizes it will take that
month and it will normalize it roll over
into the year's field or roll under as
necessary and it does this computation
completely in the civil time domain yes
yes yes all it it picked up the fact
that we went from you know daylight time
to standard time and went printing yes
yeah so the question is can there be two
results and yes this is you know if you
remember the graphs for spring and you
know fall daylight savings time
transitions when you're going from a
civil time to an absolute time there can
be cases where times are repeated or
skipped and that's what I was saying
about make time picks one we think a
sensible one but there's a different
version if you want to know that there
are two possibilities or multiple past
possibilities you would call the make
time info function which would give you
all those details if you care about them
in many cases if you're computing you
know six months from now you probably
don't care about that yes Jeff okay okay
so the question is what happens if here
it's July 31st and you want to add six
months and you want to keep the day what
would happen is if you end up you know
saying all right thank you
the question is fundamentally we always
think about this is you know is January
31st and you add one month and you want
to keep the same day well you know
February 31st doesn't exist so what
would happen it would end up normalizing
that day as well
so you would end up getting like March
3rd or something so it would normalized
the day as well it doesn't cap the day
to the end of the remaining month if you
want that behavior you'd have to
implement that but all the fields just
get normalized okay so for the one more
example here I want to this is a very
common one this is the case where you
want to floor to midnight this code
exists all over the place and I have
midnight in quotes here because I think
midnight is a bit of a bad term it's
somewhat of an ambiguous term when you
just colloquially speaking when you say
midnight you tend to mean tomorrow's
midnight you don't mean really
today's minute if you say I'm gonna be
home Friday at midnight you actually
means Saturday morning at midnight is
typically what people mean additionally
midnight can you think about 0 hours 0
minutes 0 second zero when you say
midnight you think of those zeros and as
we saw with Africa Cairo that doesn't
always exist sometimes midnight doesn't
exist so instead I would encourage you
to use terms like in this case I'm
saying floor today we could say that
every day has a first moment a first
instant that instant might not be
midnight so we'll call it floor day day
start startup day any of those things
would be fine so in this case we have a
function floor day and I'm going to
actually skip down here to main and just
look at using this real quick and then
we'll talk about how we implemented it
so again we simply load up the America
Los Angeles time zone I'm going to get
the current time Stood Corona system
clock now I'm gonna call floor day so
I'm gonna floor now in the LA Times own
and I'm gonna get another absolute time
I called it day and I'm just going to go
ahead and format both of those both of
those in the LA Times zone now and day
and when I ran this the other day was 9
12 a.m. and the beginning of the day is
unsurprisingly 0 0 0 so let's see how we
implemented floor day so the arguments
are it's given a time point in a time
zone and it returns it's supposed to
return the time zone are I'm sorry the
time point for the first instant of that
day so we start off we just say break
down or break time and we get a break
down so we get all the civil time
components of that time and then
fundamentally what I want to do is I
want to just take that civil time and I
want to ask for the midnight hour and
have it give me turn that midnight hour
into the real civil real absolute time a
real time point now since the definition
of this function is that it must give
the first instant of the day the default
behavior that as if rule that make time
would give us is not really what we want
because the one special case there is if
you think about the graph the spring
time graph where a time might be skipped
the first instant of that day is the
transition point if the time was skipped
the transition point would be the first
dense
so what we're doing here is we're just
using time info so we would say make
time info of this guy of this times year
month and day hours 0 minutes 0 seconds
0 and I get the time info and I say if
that time was skipped then returned the
transition point because that would be
the first instant of the day otherwise
return pre-pre would always be the first
time instant then and so that this
function will work for any timezone
anywhere in the world given any funny
daylight savings or other transitions
forward back skips repeats anything like
that this should work anywhere yes yes
yes yes the question was the transition
point is the was the filled in circle on
those previous graphs and the answer was
yes okay now again we built this library
we built this library to fix real
problems at Google and so we end up
doing a lot of refactoring of old code
so I want to just look at one quick
example of a refactoring of old code of
real refactoring that we did and what I
like to do when looking at these api's
is old API is and refactoring them is
just look at this function signature
and then think about this mental model
and think does it even make sense what
they're asking what they're claiming
they're gonna do a lot of times it
doesn't in this case where this function
get local time and it's given a time T
and a time zone so an absolute time and
a time zone so I know from the mental
model given those two things I can
compute a civil time the corresponding
civil time and the output I want here is
our a minute second so okay whew this
one passes the sanity test it's possible
so let's see how they did it well just
with a couple seconds of looking here
it's going to jump out that again this
is the epoch shifting solution this is
very common instead of in my example
earlier I called it get offset here they
called it calc offset but it's the same
thing calculate offset in this zone at
this time and give me the offset then I
take that offset I add it to the time
and I get what's called adjusted time
and then I break it down with
gM time just like we saw in the earlier
example and then I just assigned the
hour minute and second fields so nothing
too complicated here nothing too
surprising here but let's see how we can
improve this let's say we want to
refactor this but maybe there is a whole
bunch of collars to this function we
don't want to change the signature we
just want to change the implementation
to improve the code so using c c TZ
here's what the code would look like
since i'm given a timezone string I
would just declare a timezone and load
up the timezone that I was given but I
was that was passed here then I'll take
this time T I was given and I'll use
stood chrono system clock from time T
and I'll make a time point that
corresponds to that argument then the
real work comes by just calling this one
function break time I break down that
that absolute time in the time zone and
I get a breakdown then I just assign the
hour minute second here so the thing I
want you to notice about the difference
between this implementation and this new
implementation is that there's no
mention of offsets there's no logic
there's no arithmetic I'm not adding
something I don't have to think am I
supposed to add that offset or subtract
that offset I'm pretty much just
converting types so this is pretty close
to if it compiles it works now let's say
there's actually not too many callers to
this function so updating the function
signature is maybe that's okay let's see
what we could do if we could maybe
improve this a little bit more what I
might do is I might say well instead of
passing a time T I'll just pass in the
time point it could be a c c TZ time
point or even a stood chrono system
clock time point would be just just as
good and instead of passing in the time
zone as a string all the colleges pass
the time zone as the CCT z time zone
object the benefit here is now the
caller can load up any time zone they
want they can also handle any handling
the errors of loading the time zone if
they want previously both versions of
the code just ignored any load failures
on the time zone so this is an
improvement and then the body of this
function basically boils down to one
call to see ctz break time and then we
just assign the output so really there's
really no need to have this function at
all the real refactoring here is just to
delete the whole thing and just have the
caller call cCTC break
time and we see that happens a lot with
a lot of time utility code now that we
have si si TZ a lot of it you know
hundreds and hundreds of lines of code
are just kind of saying oh this is
redundant it's not needed anymore yes do
we do you ever have to identify the time
point with the time zone it was with
with the time zone it was created with
with the time zone that the time point
was created with you you can I could say
there's there's no need to it depends on
what you're trying to do whether or not
that's necessary the question was could
the timezone have been a member of the
time point class what you mentioned is
actually very similar to how they do it
and go so there is some precedent for
what you're saying there but we didn't
do that primarily because we want to
reuse the stood chrono time point
concept which doesn't really have that
baked in additionally the notion of an
absolute time is really time zone
independent it's a times on independent
concept so some final thoughts I'd like
to leave you with here are one remember
this mental model it's real simple
absolute time civil time time zone the
relationship absolute time plus a civil
time gives you a sorry absolute time and
at time zone give you a civil time and
civil time and the time zone give you an
absolute time when you're talking about
these concepts in coding with these
concepts and adding comments use a clear
vocabulary try to use these terms civil
time absolute time just saying time is
kind of ambiguous it's not really clear
what you mean
and your format strings prefer to use
this percent little Z that's the thing
that puts the numeric offset in your
format string and what that does that
ends up letting your format string
represent an absolute instant in time
it's that moment is unambiguous and
anybody could parse it
never compute with UTC offset s--
there's no need for you to do that it's
never necessary
don't add don't do arithmetic with time
tease unless you're implementing a time
zone library I would say that's probably
the only the only exception for this
breakdown cCTC breakdown compute it when
you need it don't really pass it around
represent points in time as time points
as absolute time points and if you need
to pass in this notion of a time in some
time zone pass in a time in a time zone
and this thing can be computed as
necessary and do calendar like
calculations in the civil time domain
don't try to do things like adding
months with stood chrono time points
directly do those calculations in the
civil time domain and a brief note on
terminology use the term UTC instead of
GMT when you mean UTC say UTC you know
UTC you know superseded GMT in the early
60s we can start saying UTC now and also
this cCTC library is available today on
github you know feel free to take a look
at it right now it works on Linux and
almost works on Mac other than if anyone
works at Apple come talk to me we have a
couple of questions but so it is
available today you can take a look at
it and any questions yes I use it how
does this stuff relate to the Olsen
database it uses all the time zone data
from the Olsen database that I Anna time
zone data is all from the Olsen database
and that's the data this works with yes
yes right
yeah yeah so - absolutely time zones do
change that like I said you know there's
roughly you know eight to ten the
question is you know do time zones
change if you compute six months
difference in 2030 might that change and
the answer is absolutely yes that might
change I would say you know be careful
if you're computing things that depend
on time zones that far in the future and
in general for something that from the
future I would say if you're storing
data store you're your first order your
primary data if the thing you need is to
come to add six months to some time in
2030 store the absolute time that you
know for sure in 2030 and store this
concept of I need to add six months and
then compute that as you need it when
it's close to twenty thirty okay okay
sorry
this is Bradley white my colleague here
he said it won't change during the
execution of your program so that that
is true that is true yes mm-hmm free
functions for adding what oh yes you
know that was just actually in an
abstract you know mathematical
representation it wasn't that wasn't the
code the question was when we add
offsets did we consider instead of using
free functions operator overloading I
would say we in the CCT Z we don't
really add offsets anywhere I think the
the adding of offsets was all in the old
code that we I I see I see the question
was could we have made absolute like a
time point plus a time zone give you a
breakdown instead of break time and I
think we probably
could of it would have been a little bit
harder because in the make time
direction we want to versions make time
and make time info so we just thought it
was clear to have function names instead
of operators thank you
yes yeah okay so two questions first one
was are am i aware of any work toward
updating Lib C with something like this
and no I'm not aware of any work like
that happening sure right so so you know
I'm not aware of any existing work on
that and okay I see a session is over
but I'd be happy to answer that after
thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>