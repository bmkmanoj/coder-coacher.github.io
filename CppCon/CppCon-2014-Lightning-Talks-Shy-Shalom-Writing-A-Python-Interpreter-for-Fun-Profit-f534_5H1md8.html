<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>CppCon 2014: Lightning Talks - Shy Shalom &quot;Writing A Python Interpreter for Fun &amp; Profit&quot; | Coder Coacher - Coaching Coders</title><meta content="CppCon 2014: Lightning Talks - Shy Shalom &quot;Writing A Python Interpreter for Fun &amp; Profit&quot; - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/CppCon/">CppCon</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>CppCon 2014: Lightning Talks - Shy Shalom &quot;Writing A Python Interpreter for Fun &amp; Profit&quot;</b></h2><h5 class="post__date">2014-10-22</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/f534_5H1md8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">next we have Shai Shalem the one thing
he loves more than C++ is Python whoa
okay I got the room where you want them
now
Shai is a software engineer from Israel
in his spare time he teaches high
schoolers assembly as a first language
five minutes
writing your own Python interpreter five
minutes so five minutes English is not
my first language so I'll try to make
this brief so what do we need to know
about Python it's a interpreted language
dynamically typed scripting and
reference implementation is called C
Python it has a boost Python wrapper
nice nice wrapper and when you run
Python scripts it's basically a
completely compiled into bytecode and
then the battle is being grounded on
interpreter so the bicycle is there
pretty simple it's a very simple stack
machine so if you take the the first
statement there C equals a plus B and
then it it's translated into push and be
binary add pops and B as them and pushes
the result back into the stack and then
pop C pops the result back into
variability so pretty simple bytecode
another key concept is that Python has
an object model everything is an object
we have a string end and even functions
classes modules everything is an object
everything is also reference counted so
if you have a variable it's actually a
reference to an object every object
holds the number of references it has
similar to shirt PAPR um so that's
basically it what everything you need to
know about Python so
so what I wanted to do is to take some
Python code and use the Python compiler
to compile it into bytecode and use my
interpreter to run this bytecode so what
happened hmm give it a second
yeah back table
this one works okay yeah
No
so this tutor not to be quit a pretty
simple after about five days of work I
had something working about two
thousands of lines of code so let's see
what it looks like we have an
interpreter instead instance there and I
can import some Python code into it the
Python code is being compiled by the c
python compiler and then executed into
the interpreter so next thing i can do
once that's done I can call into Python
via C++ using disco methods and then
extract the results from the return
objects into C++ again so I can also add
an wrapper for us a C++ function and
define it into the interpreter and then
cocoa I can call from C++ into Python
and then back to C++ again so this is
pretty nice
there's also syntax for wrapping a C++
class with a Python class and defining
some methods on it on it and then
wrapping C++ instance with a with a
Python instance and then calling these
methods on on the instance so so yeah
that's nice so you can already imagine
what this call at the bottom does so
here it is very straightforward very
thick stem plates syntax for unwrapping
the arguments and then calling this very
distinctively named function run code so
run code is pretty much the heart of the
implementation this is the actual
interpreter it has a while loop that
goes over the stream of the bytecode the
opcode by up code and for every opcode
it executes it with a big switch
statement so we have there here a few a
few of the op codes you can see pop and
push which manage the stack machine I
mentioned and when Python code code
calls a function it actually calls this
run code recursively so it uses the C++
a call stack as the Python call stack so
this is as opposed to a stackless python
implementation which doesn't do that
next thing we need to do is implement
the object models we have an object base
class and we have string int list and
dictionary objects each is implemented
by their corresponding c++ types and we
also have a ref class that's used as a
as a reference where every reference is
needed so it's basically a boost
intrinsic PTR which manages the the ref
count in in the object class if we want
to extract a value from such an object
we do a dynamic cast and then access the
object so this is where the dynamic
typing of Python comes into a very
literal sense yeah so why would you
actually want to do that why would you
want to to write such an interpreter
first if your application needs a
scripting language it's much easier to
write interpreter than write a compiler
second it can be extremely lightweight
like two thousand lines of code can
actually do quite a bit and it can have
multiple instances as opposed to C
Python which has a single instance with
gobu state and you can have any kind of
customizations added to it like you can
have a multi-threaded
interpreter while C Python is basically
single threaded and you can have any
kind of memory management that you can
think of
be as simple or as complex as you want
and for myself that that object was to
simply experiment a bit with syphilis 11
and have fun so here's the gratuitous
photo of a white animal and thank you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>