<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>GOTO 2016 • Cloud Native Java • Josh Long | Coder Coacher - Coaching Coders</title><meta content="GOTO 2016 • Cloud Native Java • Josh Long - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/GOTO-Conferences/">GOTO Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>GOTO 2016 • Cloud Native Java • Josh Long</b></h2><h5 class="post__date">2016-08-16</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/sOP3x6ODQWQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right whatever you're doing remember
I believe that code is the single most
important thing we can do if we're on
the if we're among the four or so
billion people on the internet connected
to the Internet or the forest well
billion people on the planet connected
to the Internet for us code is a single
most impactful thing you can do to make
a change to make a difference to to
change the world there's still three or
so billion people not yet connected to
the Internet so of course we have a long
ways to go but if you're connected to
the Internet code is the most powerful
thing you can do that's why I start with
code
I believe code is the essence of what
we're trying to do here so note that for
your own reference I'm also on the
internet I'm happy to carry this
discussion forward above and beyond our
humble time together here today so
please note that Twitter handle how many
of you on twitter twitter it's 2016
twitter twitter okay that's a little
awkward what about email email e-mail
anybody no okay well if you're on email
you should probably consider your life
choices friend Twitter great if not get
on it it's the new IRC it's hot stuff
good stuff a little bit about me my name
is Josh long I'm the spring developer
advocate in the spring team the I'm the
book author the latest and greatest book
which is not yet finished but we're
working on it it's called cloud native
Java it's sort of the long-form version
of what we're about to talk about in the
next 50 minutes that bird for those of
you are wondering is the blue eared
Kingfisher from the javanese an island
so so it's a bird you see that that
flies from Java so bird native bird John
oh okay it'll come it'll come don't
worry about it you'll get it it'll be
fine
also I've done video training so the
latest and greatest of which is called
building spring boot live lessons with
spring boot co-founder and my friend and
everybody's friend really Phil Webb so
there's that I'm also an open-source
contributor an engineer I am the number
one top ranked No kidding
number one seven years running seven
years more bugs per commit than any
other committer number one number one
for projects like spring boot spring
cloud spree negation Baudin spring batch
time leaf activity etc more bugs per
commit and I work at pivotal in a
pivotal weekend
very much about open source you can see
that because I have the they cute icons
on my slide but that is not our guys on
that it's not the reason we're here it's
not the reason we're excited to go to
work in the morning we're excited
because we want to help customers
community members and organizations at
large move quickly and safely from
concept to production and we see that a
lot of them struggle with this they
don't know how to do this because they
are lucky enough to have been around for
more than ten years longer than the era
of cloud computing that we know about
right now the one we're in right now
these organizations have existing
applications that were written in
yesteryear before the economics and
before the benefits of cloud computing
were so obvious and so apparent these
applications while they were well
designed for the time in which they were
conceived now present a bit of an
obstacle you see speed is a
differentiator it is the secret sauce
that helps us get to market quickly and
I don't need to look too far for
supporting evidence of this right what
are what is the largest taxi company in
the world right now
uber right what is the largest hotel
brand in the world right now what is the
largest in terms of a year-over-year
growth car company in the world right
now and what is the largest video rental
service in the world right now
no exactly see it's so ironically it's
so bad that it's it's ironic and it's
funny it's not blockbuster it's Netflix
and that proves my point these companies
when they were started didn't have more
money didn't have more resources didn't
even necessarily have smarter people
they had the advantage of speed they had
the ability to make a mistake to
course-correct and then to fix it to
constantly ask themselves to pivot or
persevere and they had this ability
because they they used agile processes
and they realized that they have the
ability to go faster because they worked
on small batches so now we are in a good
position we understand what helps people
go fast and what helps them rise the
ranks of the market speed is very
important even if you're making more
mistakes faster you can fix them faster
right it's not necessarily about being
better it's about making the same
mistakes as every else does and then
fixing and fixing them faster reducing
the turnaround time and organizations
understand this but the problem is that
a typical organization has a lot of
places in the value chain where time is
lost when moving concepts from concept
to
reduction so for example if you have a
large organization you'll typically
could have typically have queuing
between product management developers
you know user experience people testers
administrators at etc that queueing is a
big problem because you have to wait for
people to handle the work the other
problem is that you have large existing
applications and it's very hard to to
move the Titanic so to speak it takes a
lot of people to make changes to test it
to integrate it to stabilize it and then
finally to deploy it so small batches of
work are what we need and we can use you
know guidance from the good doctor sorry
the good Eric Evans and his amazing tome
domain-driven design in which he talks
about something called a bounded context
a bounded context is a part of the
application that when extracted from the
larger hole stands unto itself
internally consistent and reusable a
bounded context is a crisp definition of
part of the domain model you get rid of
the ambiguity ambiguity between this and
some other parts of it and you make it
crisp and you extract it if you can
identify bounded contexts you have a
candidate for a small batch of work a
small batch of work on which a small
group of people who don't have to spend
a lot of time in meetings talking about
what they're doing they can actually
just do it a small batch of work for a
small group of people that can be
evolved and in deployed independent of
each other
a small singly focused independently
deployable internally consistent
reusable batch of work this is a micro
service a micro service is a unit of
organizational agility it happens to be
the best architecture for scaling out
horizontally but don't think you need to
move to this architecture for that that
is not the goal if you move to micro
services because you're trying to scale
you're crazy you're not Google you're
not Netflix solve the real problem first
solve your organizational bottlenecks
and you can do that with micro services
micro services are a hack on Conway's
law which says that software reflects
the organizational structure that it
serves it mirrors it so if your
organization has a crappy organizational
structure you're gonna have crappy
software fix that by building teams that
you that want that you want to reflect
the software in the software so when you
move to this architecture you have two
problems we've looked at we've looked at
spring boots spring boots solves the
first problem the first problem is how
do I quickly stand up a new service
consists a flea consistently in it
usefully how do I do that because I'm
going to have to do that a lot right if
it
sucks to stand up one service one
organization one application in your
organization you're gonna be in complete
hell when you move to microservices
that's the first problem you have to
solve right most organizations I've seen
have this nightmarish wiki page 500 easy
steps to production that wiki page is
the enemy of velocity and you need to
get past that it has to be quick to
stand up in your service spring boot
makes it quick to stand up a new service
and do so with production readiness in
mind to support security and
observability and consistency and all
these are the things that you need for
every service that don't directly
contribute to the value chain that's the
first problem the second problem you're
gonna have is now that you've got these
independently deployed things that
implies network partitions that
employees implies distribution you have
now built a distributed system and if
there's anything upon which I'm sure we
can all agree it says building
distributed systems is hard and so for
that today we're gonna look at something
called spring cloud how many of you've
heard of Spring cloud good stuff how
many of you have used it in anger which
means you know in production basically
okay so for the rest of you this is
gonna be a kitchen sink if you have a
phone or a computer I would close it and
then open your eyes and we're gonna
we're gonna go pretty quickly because we
don't have a lot of time so remember my
smite this is my second favorite place
on the internet right here start spring
Nanao my first favorite place on the
Internet is production
I love production you should love
production you should go as often as you
can the weather's great it's the
happiest place on earth it's better than
Disneyland
I love production and you should too but
if you're not already in production then
begin your journey here let's start that
spring that I oh this is my second
favorite place so again bookmark it keep
it under your pillow keep it close to
your heart if you're if your children
are having trouble sleeping start that
spring that i/o if you find yourself
suffering from indigestion and seek
relief start that spring that I Oh
and if you want for inspiration in the
early morning before a cup of coffee or
tea start that spring today oh we're
gonna go ahead and build a very simple
service and I don't have all that much
time to explain the service itself so
we're gonna build this we're gonna call
this the reservation service I'm gonna
use Springs web support I'll use h2
which is an in-memory embedded sequel
database it's in memory so it's gonna
lose all of its state after each restart
very much like MongoDB so there's that
we're gonna use the config client which
is very useful for centralized
configuration we're gonna use Eureka for
service registration and discovery I'm
gonna use JP the Java persistence API
because I make poor life decisions so JP
a I'm gonna bring an actuator for
operational concerns or bringing Zipkin
for distributed tracing and random cue
for stream processing and that I think
will do it for now oh we won't rest
repository support as well now I could
elect to go down here and switch to the
full version whereupon I'll be given a
veritable ocean of options check boxes
that represent all different types of
workloads and technologies I could
select any other you know option here
but we don't have enough time not nearly
enough time we also have some discretion
about which language would like to use
any language on the JVM that supports
annotations and objects will work just
fine so Scala groovy Kotlin and and Java
of course right that's just fine here we
have non choices and people get very
confused about this they don't know when
and where to choose which so I'm gonna
do my level-headed best here and now to
explain
don't use these ever that's as simple as
that these are non choices these are
choices in the same way that stripping
naked running in traffic is a choice you
could but don't just don't and then here
we have the choice of packaging if by
some freak fluke of physics you find
yourself stuck in the very very very
very distant past far far beyond modern
help then choose dot waar but if you're
here with me in 2016 then choose dot jar
this is a big part of my overarching
guiding personal philosophy of make jar
not warren again you have options you
have choices you should do what works
which in this case corresponds to doing
what I said to do so that's convenient
we're gonna go ahead and hit generate
and that'll give us a new zip file I'm
gonna open up the zip file in my ID and
it doesn't really matter which IDE so
long as you have one NetBeans IntelliJ
and Eclipse all work great spring boot
tools for NetBeans spring tool suite 4
for eclipse of course and then IntelliJ
ultimate have extra plugins but they're
not necessary you just need Java and
annotation support and made them support
or a Gradle support now what I'm gonna
do is I'm gonna build a nonsensically
trivial domain model can you all see
this in the back is that big enough
should I make it a little bit less big
because it's almost too big for me I was
given the same presentation yesterday
and I was using my more bigger profile
but it's it's almost too more bigger so
we're gonna say 222 ok
hey where's that ever okay with that
faboo so I'm gonna say I've got a Joe
made model of type reservation I'm gonna
give it a primary key which I'll signal
by using the anti d annotation at
generated value okay and I'll say
private string reservation name this is
gonna be a JP field that'll be mapped to
a column called reservation or score
name in the database and I'll signal
that this is a JP annotation by using
end to you either by using you add into
the annotation now this my friends is
the purest most concise most pristine
most clear expression of my domain model
it's beautiful absolutely beautiful but
this is Java so that won't even be close
to enough so we'll add this constructor
will add another constructor this just
in just for JPA and JP alone will add a
two string method will add some getters
and there we go and what I want to do is
I want to save records of that type to
the database and I could create a manual
repository object if again turning to
Eric Evans in the amazing book
domain-driven design it's an object that
is going to handle the underlying
persistence the reading the writing etc
but that's not business differentiating
functionality so instead I'll defer to
declarative interface based repositories
from Spring data I want to make this a
REST API so I'll say at rest repository
resource I'm gonna use spring data there
and then I want to set up some sample
data so I'll say sample CLR implements
command line Runner there we are and
what I'm gonna do in the sea
face is just override the callback
method called void run and I'll tell
spring whenever it starts up to call
this method because it's got that
interface and I'm gonna use dependency
injection here I'm gonna tell spring to
provide a reference to this repository
which I'm going to satisfy through the
constructor this is the correct way to
do this by the way never ever use the
field injection ever every single time
you do that a unit test dies
don't do that never not even when you're
all by yourself at home
all alone and no one is looking ever
okay
so goodbye to this now I've got a simple
record and I'm gonna just insert some
data so my name is Josh it's lovely to
meet you my friend yours how you doing
buddy Arion he's over there uragan just
left of course
Stephan and Brian that's a that's six
that's almost a good number what's your
name buddy how do you spell it like this
okay
and what about you boss if our hang in k
lovely to meet you that's eight that's a
nice even round number I'll sleep fine
tonight it's gonna be great and so what
I'm gonna do is I'm gonna pass in a
consumer this is a Java eight ism right
this is one of those new features that
only very modern languages have
languages like C COBOL PHP Ruby pearl
Lisp small talk C++ objective-c Visual
Basic basic visual basicnet Ruby go Lua
Haskell COBOL right so as a Java
champion I'm very happy to talk about
something called a lambda which is new
in Java 8 where we introduced two years
ago and I'm gonna then visit every
record I'm gonna say for every record
let's call the print line method I'm
gonna print it out now what that's going
to do is it's going to spin up and it's
going to write all the records to the
database and then we'll see those
records reflected in the output on the
command line okay I've got just all
sorts of stuff on my class paths so
let's see how this goes I'm not even
sure if I should have deleted some of it
okay good there it is it worked of
course it worked it was a demo what were
you expecting it was always going to
work instead what I really wanted to
talk about was this this is something
that's near and dear to my heart it's
basically
here this is a big problem what the hell
why is this here see what I really
wanted to talk about was this this is
the spring boot ASCII art work and this
ASCII art work took a long time to get
right we on the spring team have several
phd's doctors people who worked in
nuclear physics who worked very hard to
make this work for you
and so I consider this particular
feature a very serious deficiency in the
JetBrains product what the hell why is
that there and so I did what all people
do when confronted with a you know
challenge and struggle on the Internet I
went on the internet and I cried and I
was greeted by a message of hope from my
friend Yan tebron who's a software
developer by passionate intelligent
brains and he responded with this
message which I share with you here now
don't worry my friends we're gonna make
intelligent great again anyway so we've
got an hour a REST API we can visit the
arrest API by going to reservations and
we can see here that I've got a
collection of resources this blue box so
much if you can see it there's a tiny
little screen there but that blue box is
a resource it's an envelope object with
a payload and a collection of links
about the payload it's hyper media it's
built on spring hot cos hypermedia as
the engine of application of state which
is a design pattern now if you followed
any of the earlier talks about spring
booth then you know you can change all
manner of different things for example
by going to application app properties
and changing for example the port but
this is gonna betray some of the things
that we want in a continuous delivery
style or agile style app you know
environment I want to be able to move my
build from one environment to another or
than having to recompile it so while I
could change things in application of
properties and override them I would
have to recompile each time if I did
that I can instead we defer to Springs
good support for 12 factor style
configuration here right so if I go here
to my my build where my coat is like
this and I do may even clean install
Ono's thank you and then maven - d skip
tests because Yolo okay and C D target
there we are you can see I've got a
so-called fat char that contains
everything I need to run the application
and I can say Java - D server dot port
equals 80 10 - char reservation shows -
arm that'll spit up the application on
port 80 10 instead of the default 8080
where's the others
so there's 80 10 right I can also use
environment variable so I can say export
server underscore port equals 80 30 and
then just do Java - jar preservation
serves that jar will see that spin up on
port 80 30 instead there we are
right oh come back son-of-a-gun I mean
I've lost it I blame you yours
there we are 80 30 okay so that works
and this is certainly very powerful but
it's not enough there's several use
cases for which this isn't sufficient
suppose I want to change the
configuration while the service is
running suppose I want to
support sensitive passwords encrypted
information on the on the filesystem how
do I support that suppose I want to
centralize all this information instead
of copying and pasting configuration
from one data from one startup script or
manifest or docker file or whatever to
another and then suppose I want to
change things well the service is
running live for all of these use cases
and more while this is a good basis it's
not nearly enough and we need to do a
little bit better so what I'm gonna do
is I'm gonna build a spring cloud config
server now that can fix our oh yeah all
right good stuff the config server the
config server is an API that we're gonna
stand up that knows how to manage a
directory full of configuration and that
directory is gonna be based on git and
I'm gonna clone it from my github
repository here now this is one approach
you can also use zookeeper or console to
centralize your configuration and again
I would refer you to my good friend
yours this talk later on but we have a
config server so I'm going to move this
directory here to just you know config
it's on my directory to my on my home
directory in my desktop and I've now
created this new module called the
config service I'm gonna open this up
and I'm gonna configure it to be a
config server it's going to manage our
directory full of configuration on
behalf of the micro services so config
service that enable config server we're
gonna go here to the property file we're
gonna say spring cloud cloud config
server get URI equals and I'm gonna say
home Desktop config and I'm also going
to point my application to port 8080 888
okay and I'll spin that up now suppose I
am a micro service what I want to do is
I want to have my micro services call
the config server on port 8888 and then
they're gonna ask for their sets of
configuration so instead of having to
keep all that stuff in property files in
each application I have just one service
and it has one directory so what if I am
a micro service I'm gonna name myself
the reservation service reservation -
service what configuration would I see I
would see this 8888 reservation -
service default ok default is the
profile this is the property you know
the service name and I'll see two
property sources one from application
sorry one from application of properties
and another one from reservation service
type prop
there are keys in values in each of
these property files if there's a
conflict like here server port and
server port then the more specific file
overrides the default fallback file so
every micro service will see the values
in application app properties only the
micro service called reservation -
service will see the values in
reservation service type properties I
also have a message here so let's go
back to our little REST API with
reservations and change it to be called
the reservation service and to get its
configuration from the config server so
here we are we're gonna change a few
things we're gonna say spring cloud
config URI equals HTTP localhost 8888
now it turns out that the default value
for this is actually exactly what I just
put in I just want you to see how it's
done so the other thing you need to do
is give it a name you have to tell it we
know how to identify itself and it calls
the config server now these two values
are understandably and necessarily we
used by the config server before it
loads the configuration for everything
else it's used in the bootstrap phase so
you have to rename this file to
bootstrap top properties so that spring
cloud can find it so here's bootstrap
dot properties and we're gonna finally
go ahead and use a that message that we
had just created a simple hello world
message we're gonna add an end point
here will say risk controller class
message rest controller okay and we'll
say private final string message and
I'll create a constructor and I'll
automatically okay message and I'll say
I want to quit an endpoint that simply
returns that value whenever asked so
I'll say msg string read and I'll return
the collection this dot message okay
there we are so now we want this value
to be available and it will now that
we've connected to the config server I
also want to be able to change the value
live and the service is running so I'll
make the bean refreshable now to confirm
that that everything is working as
expected we should be able to go to port
8000 not 8080 but 8000 that's the new
port on which we launched the service
and we should see the result posthaste
come on computer time is a-wastin there
we are so that worked array what about
the message
there's our message or not no I did a
msg to
there we are there's our message it
works but it's not great we can do a
better job so let's let's revisit this
directory full of configuration on the
configure and then in the file system
here and remember it's using git that's
very important I'm using git to manage
this or subversion but it's gotta be
some sort of you know thing that
supports auditing and journaling so I'll
say hello Amsterdam extra exclamation
marks for reddit okay git commit - a - M
Yolo now if I go to the config server it
sees the value immediately but this has
no idea and I can change it a few
different ways I can use the spring
cloud event bus or I can trigger an
actuator endpoint which is an endpoint
that is set up by spring boots for you
to operate or visit or get observability
about the application so I'm gonna go
ahead and hit empty - I'm gonna send an
empty post and then refresh and I can
see the value immediately this supports
things like feature flags which helps me
decouple the release of software from
the launch of that software from the
deployment of software this helps me
support branch by abstraction and
continuous delivery pipelines there's a
lot of power here that can fix server
because it's between my configuration
directory and my micro services can also
do symmetric encryption and decryption
of values in the property files so
there's a lot of power but we have to
move on the next thing we're gonna look
at is service registration and discovery
the thing that we care about now is for
the ability of services to talk to each
other without knowing about each host
import and there's a lot of good reasons
why you'd want to do this and at first
blush at first look this may seem like a
use case for DNS but it's actually a
poor fit inside of a cloud-based
environment first of all DNS adds
latency you have to resolve the DNS
entry and then hop back in if you're in
a convent it usually involves a hop
outside of the router and back end which
is even worse
and then third of all DNS is by
definition routable sometimes I don't
want my services to be writable I wanna
be able to talk to them but not expose
them via some sort of DNS entry I can do
the multi-home thing where I have
private DNS versus public but that gets
very confusing the other problem is that
I want to be able to handle load
balancing custom load balancing your
average f5 router for example will have
a checkbox that says do round-robin load
balancing but what about more specific
business case semantics specific use
cases like if I have a need to do
sharding are on a route a client to a
specific node or
I have multi-tenancy or if I want to do
an OAuth client I'm gonna lock it to a
specific node or something stateful has
happened happening some load balancers
have a dumb notion of stateful or
session affinity or sticky sessions but
that doesn't apply to non-standard
things like a off token for example so
how do you support all of these use
cases we don't want to use DNS and your
average big dumb load on tour instead
let's use something called a service
registry a service registry is like a
phonebook for the cloud it's a logical
mapping from a service ID to hosts
imports and there are many different
implementations again you can talk to my
friend yours a little bit later for his
talk but there are many different
implementations out there
Apache zookeeper hash it Corp console at
CD Cloud Foundry we have abstractions we
have an abstraction that has
implementations for all of them but I'm
gonna use Eureka because it was
developed by Netflix it's very very very
very proven it's been used at scale for
years and it's dead simple to set up and
I'm very very lazy very lazy I mean you
would not believe so I'm gonna say
config client eureka service i'm going
to build my own eureka registry here and
we're gonna do the same thing as before
we're gonna tell you rica where to find
the config so spring cloud configure a
equals HTTP localhost 8888 i'm gonna
give it a name so we're gonna say spring
application name equals eureka service
and we're gonna rename this property
file to be bootstrap top properties as
before and then we're gonna open up your
reco service application I'm gonna say
abracadabra you're a Eureka and that'll
spin up if everything goes to plan on
port 87-61 now we don't know this could
all go south in a minute yeah
son-of-a-gun why oh good okay so first
thing you need to notice is that we have
good quality animated gifs very very
well done now the other thing you need
to notice is that we don't have any
applications registered yet so let's go
back to our reservation service and
teach it how to raise its hand how to
say listen if anybody needs me I'm right
here this is my host this is my port on
the client in the build we have spring
cloud starter Eureka somewhere
ba-ba-ba-ba don't we
there it is that's the discovery client
abstraction implementation for spring
cloud so all I need to do is to enable
that abstraction by saying at enable or
at enable discovery client and then all
restart and that's going to raise its
hand and call home to the registry and
say listen if anybody needs me find me
here if you have ten instances that are
all going to call the registry now what
we're gonna do is we're gonna build a
client to use this service a edge
service okay there an edge client so
we're gonna call this the reservation
client we're gonna use the config server
it will use your week of service
registers and discovery will use the
Zipkin for distributed tracing we use
RabbitMQ for stream processing when use
Zul for micro proxies we're gonna use
hystrix for circuit breakers we're gonna
use the rest repository support web
support actuator support and then we're
gonna go ahead and hit generate okay now
this is the same as before I'm gonna
open it up I'm gonna configure it and
point it to my application on my config
server rather so there's this so spring
cloud config URI equals HTTP localhost
8888 spring application name equals
reservation - client and I'm gonna
rename this property file to be
bootstrapped up properties will open up
the code and at enable a discovery
client abstraction implementation now
think about what we're gonna do here and
the edge service is our logical
component it lives at the edge of the
architecture responding to requests from
outside from your html5 devices from
your iPhones your androids your
Playstations your Roku's your Xbox as
your test was in the internet of things
it could be your microwave write
anything these days has an IP so each of
these clients have specific payload
protocol and security concerns and if
you have to change every single micro
service to accommodate all of these new
clients you're gonna be redeploying
stuff all year long it's insane so don't
bother centralize those concerns at the
edge the edge service is going to be
exposed via DNS but then when the edge
service looks for other services in the
architecture in the cloud in the cluster
it's going to use service registration
to discovery your iPhone isn't going to
use Eureka for example right it'll use a
DNS endpoint but then from there it'll
be using service registers and discovery
so what we want to do for example is to
build an edge service that handles
client specific concerns you may have an
html5 edge service an iPhone edge
service and Android edge service etc
think about html5 html5 is ridiculously
powerful today in html5 browser
can do all sorts of interesting things I
think this guy is actually from here
maybe
have you seen jeaious latex this is
insane so this is uh yeah that that is
actually a browser completely in memory
booting Linux so don't tell me you want
you need to build the native desktop
application for Windows anymore it's
just ridiculous we just booted Linux
entirely in JavaScript the point is you
can do a lot of stuff in the browser
today that you wouldn't think possible
so you don't really need to hold its
hand and babysit it for computational
stuff but you do have to understand that
it lives in a sandbox it cannot make
requests outside of that same host
import you can add a policy to every
micro service but then you'd be changing
every micro service to accommodate the
new client we want to avoid that one way
to avoid that is to proxy all of my
services that are registered in Eureka
through a single host and port and we
can do this using the micro proxy a
micro proxy is a design pattern that
blindly proxies things back and forth
we're gonna use something called Zul now
Zul is a micro proxy from netflix i'm
not sure if you keep abreast of your
Greek and Ghostbusters mythology but
this is Zuul now Zul is the gatekeeper
to the underworld to Hades to hell or at
least that's what I thought but then I
then my friend said you know Josh that's
not fair we don't know that in the movie
they don't say that he might come from a
very nice place he might come from
Hawaii we can't judge and so you know
what he's right I'm sorry
that's what I thought it was you know I
don't know anyway he's the proxy to
wherever to Hawaii okay and now spring
cloud and Zul have already set up an
edge service for me at reservation I
$9.99 forward slash reservation and -
service for slash reservation so this is
the edge service port this is the
service ID in Eureka and that's the
actual path remember I actually have a
real service here on port 8000 so real
service edge service real service edge
service real service edge to real sir
it's a proxy my friends it's prompting
it you can see that the proxy sends a
header to the downstream service the
downstream service uses that header to
rewrite these URLs so that from the
perspective of the client it doesn't
know that that JSON didn't come from
that node I
this is very very powerful so maybe I'm
done you know all of my services that
are in Eureka I can access them by using
them as the service ID as the context
path then I'm done maybe for my html5
developers assuming all of my services
are homogeneous rest in JSON maybe I go
home I should probably add HTTP or
actually certainly at HTTP I should
probably add it should be basic our
OAuth kind of authentication but maybe
I'm done otherwise right maybe I've done
everything I need to empower them to be
done sometimes however it's useful to
have a subset of the data or a view of
the data or transformed you know
endpoint that has a composition of other
services this is a different kind of
edge service called an API gateway and
micro proxy is a dumb proxy back and
forth it's an edge service an API
gateway does some sort of translation or
transformation of the request or the
reply or both they're both edge services
so we're gonna build a very simple API
gateway that simply takes the downstream
reservation service and gets only the
names we're gonna strip away the strata
of all the surrounding JSON we want just
the names now in order to understand how
this is gonna work we need to first
think about how this worked
how come it's able to route that request
how does it know it's making the request
by going to Eureka and it's using that
service ID and then Eureka is saying
I've got you know ten instances of that
service how does it pick which instance
it's making this decision on the client
using something called Netflix ribon
ribon is a client-side load balancer
right so we've got that already in play
ribbon gives you the ability to by
plugging in an object do different kinds
of load balancing you can do round-robin
which is the default or sticky or data
center aware load balancing or sharding
away or load balancing or whatever you
want right so we're gonna build a very
simple edge service here we're gonna say
class reservation API gateway rest
controller and that's you know very
succinct I know and I'm gonna route this
endpoint at reservations I'm going to
make it a rest controller and I'm going
to take advantage and create an endpoint
here that just returns the string names
okay just the names so whenever somebody
goes to localhost 9999 forward slash
reservations forward slash names this
endpoints gonna be called and I'm gonna
use
a rest template from Spring Framework to
make this call as quickly and concisely
as possible but the problem is my rest
template doesn't know about Eureka yet I
need to make it aware so I'm going to
configure a Eureka aware a load balanced
and ribbon aware rest template here
can't return new rest template and I'll
then make sure that I qualify that
injected version here with an ax look
qualifier annotation and I'm gonna say
call the rest template exchange method
call the reservation - service it
doesn't matter which one remember this
is not DNS that's going to be
intercepted by the load balancer it's
going to find an instance it's going to
pick it and then substitute it for this
string I'm gonna say make an HTTP GET
call nooo-body and I'm gonna say I want
the data to be returned as a collection
of spring hot EOS resource objects whose
payload is of type reservation right so
I'm using the type token hack sorry
design pattern here to do this work the
type token hack gets around the fact
that Java doesn't have good generic so a
good generic type system so here's my
get er I'm making the request and now
when the rest of it returns the risk
template will return a envelope object
called a response entity and the
response to entity has a payload of type
of resources of reservation so I'm gonna
say response entity get body get content
dot stream dot map I'm gonna map from
reservation to reservation name and I'm
gonna collect it all in a list so there
my friends is a very very simple edge
service it's two lines - admittedly
terrifyingly crazy lines but still just
two lines right and those lines are
going to do what we expect they're gonna
take the data and turn them in to a
collection of resources whose payload is
of type reservation and then dereference
the reservation name and collect all
that in a string so we can see that here
localhost 9999 forward slash
reservations for such names and that's
working just fine but what happens in
the case of a failure I need to degrade
gracefully high-performing organizations
understand that failure is a fact of
life it's an inevitability Netflix have
a suite of software component called the
simian army
this
in army are basically little software
terrorists they run around in production
during office hours kill - dining
processes blocking ports are em are
effing database and disk partitions they
even have something called chaos Kong
that even as I talk to you about it
right now gives me goosebumps it kills a
whole data center availability zone on
purpose they do this because they'd
rather find out during office hours when
engineers are on call that it's going to
work
then to wait until 4:00 in the morning
when it's an actual emergency and
nobody's awake so we need to understand
that same fact as well in a sufficiently
cloud native system high availability of
a single node as an illusion it'll never
happen instead you need to optimize for
time to remediation a cloud native
architecture is one that is built to
survive and thrive at scale and
horizontal scale a cloud native
architecture is also one that is built
to understand and we do the right thing
in case of a failure we need to optimize
for time the remediation how quickly
from the perspective of the client can
we get up a new service or load bounced
to another and the endpoint or do
something so that it looks like it's
still working if you build your
application for with time the
remediation in mind instead of high
availability of a single node then from
the perspective of the client you'll
have the same result but this has
profound implications on how you build
your systems and how you architect it so
in this case we already have 80% of this
working just fine if we call that
downstream service and there's one or
more instances of that service in the
registry this will work it's just it's
not gonna work if there are zero right
if there are zero instances this is
gonna blow chunks and our poor iPhone
users are getting get a big fat Java
stack trace in their phone that's no way
to run a railroad my friends we need to
do better so we're gonna introduce
graceful degradation high-performing
websites do this kind of thing all the
time they'll say oh well you wanted the
search engine results but those aren't
available right now so here are some
machined learned recommendations from
across the web we're gonna use something
called the hysterics circuit breaker and
the circuit breaker is gonna be a
stateful component that we're gonna add
to our potentially shaky service to
service call so if there's a failure if
there's an exception in this method
we're gonna have it call another method
of the same signature and inform called
fallback and we're just going to return
an empty ArrayList
so there's that now this circuit breaker
is stateful it's going to see that
there's enough exceptions and it's gonna
stop the traffic and go directly to the
fallback after a while this gives our
downstream service time to come back to
life if you're using something like a
cloud platform like Cloud Foundry Cloud
Foundry will move heaven and earth all
day and all night to restart services if
you need it to if you say there's got to
be ten instances or 100 instances it
will make sure that that is true all the
time
but it's up to us as architects and
developers to do the right thing in the
software in the face of topology and
architecture changes like this so this
is what we're doing we're accounting for
the possibility of failure which is a
real thing so okay good I'm making
requests happy path things are working
great now let's go back to our
reservation - service and then kill the
poor poor reservation service there we
are that's sucking isn't it look at that
it's hesitating eventually is gonna
timeout but I can force it to timeout
and force it to go directly in the
fallback by hitting command R there we
go so now each time I do that it just
goes straight to the fallback it doesn't
even try to call the downstream service
we're giving our downstream service time
to recover time to breathe we all know
that if a service isn't responding you
should hit refresh in the browser right
does that work well it doesn't work for
distributed systems either this dates
that effect this gets rid of that effect
okay now my friends we've only got how
long seven minutes eight minutes so
we're gonna be a little late probably
eight minutes we're gonna use we get we
need to now care about observability
right so I a cloud native architecture
is one that is observable it's one that
scales out correctly and it's one that
undoes the right thing in the case of
failure it optimizes for time to
remediation that's the three tenants of
a cloud native system we've looked at
ever so briefly how to build a system
that does the right thing it centralizes
configuration use the service residence
and discovery we've induced graceful
degradation in case over the read if I
had a few more minutes I might show you
how to do a bit of graceful degradation
in the case of a write when you post
data right if you post data you want to
deliver the message eventually and for
that you can use something called spring
cloud stream this gives you a ventral
consistency there's a lot of ways to get
to different services to agree on the
state of something
one is to use eventual consistency which
is messaging basically that's what we're
implying another one is to use the saga
pattern which describes a set of
interleave Abul that is you can switch
the order transactions that each have
semantic compensatory transactions
another way is to use a more
sophisticated version of messaging
called CTRs and event sourcing right but
we will skip all that for now because
that could be another five hours so
instead let's talk about observability
there's in my system on each of my nodes
I have the actuator endpoints the
actuator endpoints give me information
about what the application is doing so
if I go to my edge service here 99999
for such metrics I can see information
about this host in this node right
memory uptime heap non-ape code cache
etc this is all pretty standard stuff
now I've also got Ian's ve it shows me
in my environment beans which shows me
the objects in the graph etcetera but
these are host and node specific
information I want to see the emergent
behavior of the system remember the map
is not the terrain my architecture
diagram is not the architecture it's not
the system there's emergent behavior
that your system has that your your your
architecture diagram will never
understand or never be able to
encapsulate so we need to capture that
we need to have the observability we're
gonna use a few different things we want
to look at the flow of traffic in that
circuit that circuit represents a
connective tissue from a consumer and a
service a producer and a certain a
consumer a client and a service that
service may be down right if it's a
third-party service especially we have
no way to instrument that third-party
service so we can use the circuit
breaker to add a connective tissue that
looks at the transit of data through
that endpoint so one thing you should
notice is that I went to my you know a
few seconds ago I restarted the
reservation service and nothing else and
now the circuit breaker is working it's
reintroduced traffic so it it saw that
traffic is working and it came back it
healed itself but it may fail again so I
wanna be able to see what's happening I
can do this with the history dashboard
I'll say hystrix dashboard config client
eureka service resident discovery i'll
hit generate i'll open this up and i'm
gonna open this up in my IDE and I'll do
the same normal kind of thing as I'd
done before application of properties
spring cloud config
you're AI HTTP localhost 8888 spring
that application name hystrix
- bow properties dot bootstrapped up
properties hystrix dashboard application
and i'm gonna say an able discovery
client and finally i'm gonna say at
enable hystrix dashboard now this is
gonna spin up on port 80 10 and what its
going to expect is a server sent event
stream a heartbeat stream that each of
the nodes that has a circuit breaker
will emit automatically this server sent
events stream can be multiplexed you can
take all of the streams from all the
service instances and put them into one
big stream using spring cloud turbine
but that's a demo for another day my
friend so for now let's look at the
simple case of this one node and this
one heartbeat stream so localhost 9999
hystrix dot stream now this stream is
never-ending it's infinite it's always
being updated there's always new data it
is endless like the bugs in my code it's
gonna keep going forever so whatever you
do whatever you do do not curl this
endpoint okay I'm gonna take that URL
I'm gonna go to a t10 for such hystrix
tight HTML I'm gonna put this in the
dashboard that we just created paste
monitor open this up localhost
reservation names now I'm gonna drive
traffic on the left and we'll see that
reflected in the moving average that
trends ever upward on the right you can
see that traffic is going through the
circuit breaker just fine there's 30 36
42 whenever requests everything is green
though there's the circuit is closed
life is great ok if I were to kill the
service then this cert we'd eventually
see the circuit would be open and I'm
going to go to the fallback method
directly so that's one way to get a
visibility into the emergent behavior of
the application the other way to get
that visibility is to use distributed
tracing distributed tracing is actually
in theory very very simple but in
practice very very painful what we want
to do my friends is to instrument every
ingress and egress point that is to say
every place where a message can arrive
or leave a spring cloud application
spring MVC the rest template spring
cloud stream the feign declarative rest
based clients the micro proxy based on
Zul all these places where messages
arrive or exit we want to make sure that
we intercept
them or filter them and see if there's a
unique ID a unique ID that we can use to
correlate the flow of a single message
through the entire system in distributed
tracing parlance we talk about a trace
and a span a trace represents the whole
journey from A to Z of a request from a
to Zed a span is each leg in the journey
a to B B to C C to D D to E etc and we
have a framework called
spring cloud sleuth so I'm gonna say zip
conserver Zipkin UI eureka service
registers and discovery config client
we're gonna hit generate now spring cut
sooth is already working on our
applications I've got this on the class
path and you can see it's already doing
something useful it's logging
information here this is the service ID
the trace ID and the span ID so if you
have a log analysis tool like you know
elasticsearch or paper trail or Splunk
you can already see some of the
information as it flows through the
system but I believe that a an image a
graphic a picture is worth a thousand
traces so we're gonna use Twitter's
Zipkin service we're gonna build a
Zipkin service here well say at enable
Zipkin server come on computer what are
we having trouble with
did I do something wrong
come on computer
okay no reason to cry yet there might be
though there might be come on computer
so Zipkin service application somebody
yeah
I don't even understand what happened
that's the thing you uh can we have two
minutes three three minutes gonna have
three minutes we're gonna do the the
nuclear option and then I'm gonna stick
the dismount I'm gonna restart all the
intelligence and intellij we're gonna
have a big talk after this okay
Terminal P kill it's a good thing we
don't build distribute systems on
intelligent okay
so couldn't figs ever open Eureka
service open reservation service open
so I went huh
okay that sounds like a nuclear nuclear
option yeah bad intellij bad okay hold
on yeah it'll take forever he's got a
point my friend it's scanning files to
index it looks like it's already doing
something to that effect already
reservation service son somebody yeah
kind of fig service I just want to know
it's gonna be all right
I just wanna feel secure in my life
choices should I have used IntelliJ
should I have used it clips Phoenix
every talk I go to there's always that
one person who uses Emacs I always ask
who uses this fat in the rest and
there's always the same guy I use Emacs
he says and then he leaves the room and
I think he's just going to the next
country or continent where I am he's a
troll so config service what about you
why are you so upset
zip can you I well
Santa Maria
so the reservation service and wait
config service is running eureka
reservations service okay
come on Zipkin
okay so I fixed the build problem I'm
gonna say that enable discovery client
at name yeah Zipkin server
okay so reservation service is up and
running
Eureka's up and running reservation
client not so much let's see that
everything is working happily localhost
9999 for such reservation names and then
my Zipkin server I need to point that to
the right things so we say application
of properties spring that cloud that
config that your I equals localhost 8888
spring that application name is Afghan -
service we need this to be bootstrap top
properties strapped up properties okay
and go go go
come on
that's the service config service Eureka
service client is now springing up to
load come on
yeah here we go reservation names Reed
Reed Reed Reed come on come on come with
one okay failure good it's working now
zip c'n so we've already got the the
tracing on the command line that's
useful but I want to visualize it so I'm
gonna open up the zip gun which is where
I just set up Zipkin is a distributed
server just read a tracing server from
Twitter it was open sourced in 2010 and
we have people on the spring Cod team
from both Netflix and from Twitter who
contribute often so they helped us make
this stuff really great so here we have
visibility into two services that are
already registered I'm gonna go to
visible reservation service for example
I'll hit find traces and it'll show me
that I made a request less than a minute
ago I'm gonna click on that request here
and I'll see a waterfall graph that said
I made eighty eight milliseconds good
gravy that's not the average one let's
try a different one that makes me feel
better
six something's wrong anyway 67
milliseconds the request entered here at
HTTP reservation names then it flowed
out of the reservation client to the
HTTP reservations endpoint and then
finally that arrived at the 8:00
reservation service here I can click on
this information to get details about
the flow of the message in the system I
can click on this for example to see
tags and show the actual log of the
message now this is information that you
can use to correlate transactions with
requests make no mistake however this is
not for not for customer service you're
not supposed to use this to find out
what Jane did in the website two years
ago you're gonna keep at most a couple
of days worth of logs this is about
online telemetry right now how much
money did we make last quarter I don't
know but I can tell you what the average
latency on the website is right now this
is for that okay it's observability of
the online system right now you will
trace at most maybe ten percent that's
the default we retrace for you
automatically I have it at 100% because
I do a demo you're gonna get by default
10% Twitter for example keeps 1 out of
every 6 million requests 1 out of 6
million they don't need it all
so my friends I'm sorry that we didn't
get to cover much this time maybe next
time we could actually get into the
details if I just had a little more time
and if I just would stop sucking with
the code now thank you very much for
your time I want you to pee oh I I hope
you appreciate that while I am wearing a
spring t-shirt and spring underwear and
I'm a big fan you don't have take my
word for it there are small
organizations out there that are doing
amazing things with this so several
world government
Alibaba and China made 14 billion
dollars in a single day last year
they're using spring cloud loud and
proud Netflix is using spring cloud loud
and proud
Baidu is using spring cloud loud and
proud right these are organizations that
have the money
the people the motivation and the
resources to solve this problem
themselves and they still choose spring
cloud because it represents the most
powerful way to build these kinds of
systems the most cohesive way to build
these kinds of systems thank you very
much your time I'm sorry right / Thank
You Bell I appreciate it Cheers</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>