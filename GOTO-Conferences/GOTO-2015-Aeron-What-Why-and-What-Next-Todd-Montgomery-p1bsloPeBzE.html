<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>GOTO 2015 • Aeron: What, Why and What Next? • Todd Montgomery | Coder Coacher - Coaching Coders</title><meta content="GOTO 2015 • Aeron: What, Why and What Next? • Todd Montgomery - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/GOTO-Conferences/">GOTO Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>GOTO 2015 • Aeron: What, Why and What Next? • Todd Montgomery</b></h2><h5 class="post__date">2015-04-02</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/p1bsloPeBzE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">thanks guys for coming out welcome to go
to Chicago night we're really happy to
have time on separate here as dinner he
is one of our keynotes this year go to
Chicago and this is a great opportunity
for you to see the quality of sessions
that we will have at the conference this
year we have he knows Chad Fowler and
need to sync with Marvin Thompson Kyle
Kingsbury and Todd McHenry this year we
have a new venue it will be hosted at
the Westin River North which is close by
beat central for everyone and the dates
are May 11th through the 14th if you
know anyone who is interested in doing
crew you can contact me directly we are
looking for new developers to come and
lend a helping hand I guess that's
pretty much it for me so I'm gonna pass
it off to Todd and I hope you guys enjoy
your night thank you
so you'll notice that you know Morgan
and I are talking you'll see Morton's
picture a little later as well he's been
involved in this work as well a very key
part of that we're actually in our
keynote brands a lot about several
things software development
a lot of different things so I think you
probably enjoyed it don't have been due
please let us know because actually job
so I'm going to talk about is uh a
source project that mark and I have been
involved in about what it is why we've
done things helping them along and sort
of what we're planning on doing next
along with it but before we get into it
I want to you know say thank you
personal setting up here who is you know
basically funded this effort for the
Chicago market exchange very announcer
so what is there well Aaron is a
messaging system how many of you use
messaging systems okay good so that
takes care of about half my prisoners
brief that a lot of what we wanna cover
if you've seen Martin talk about this
we're going to cover a very similar
things because there's a lot of things
that are very relevant but we're going
to think a little bit deeper guide and
sort of talk about how things have
evolved how the evolution of things have
compound so it's kind of a
sausage-making patna we're going to talk
about how the sausage was actually made
instead of just the end result so the
first thing is you know messages this
has been around for a long time why
would you actually think about it you
know building another one in fact myself
have been involved in building quite a
few so why would I want to put myself in
the trial in turmoil of building
well you look around what's there now we
have a lot of things which are feature
below it there's a lot of features but
one of complexity that's been added for
very little bit you know in my mind so
the key part of making these things
efficient
one well is kind of been lost so kind of
wanted to look at that with all the
different fight with that but not faster
if you look at finance specifically
latency and throughput you know these
things are just not they're out there
they work but they don't work well kind
of another thing is it's not just about
you know having a low latency system
it's about having a low latency and
predictable system and this is what
happens when it's not as predictable and
not a little basil and you really live
in a different world
you know these systems even you know
most recent systems are still five and
six years old so you live in a world
where digit or it's multi socket it's
flat it's not just that it's also that
we have many different types of media
that we have to go Steinke its IPC if
anything it's our DMA PCIe lots of
different options so we fundamentally
kind of look went in with the idea of
trying a new approach with them getting
rid of all the you know kind of
preconceptions that we had about how
things had to work and how they can
active function you know which was I
gotta be honest was not easy for me
since I didn't lot of these before but I
was really look very willing to look
these things in a very different light
this of a team is actually three people
Marvel
Richard and myself and we kind of all
Richard in with the font of we wanted to
use a lot of different Java 8 features
only one
who is very familiar with Java to give
us an idea about how things could be
functioning there will set a different
you know sort of goal in mind we also
thought that it would get someone who
was it Jamie hate bitter we can actually
show them some of the pain in yourself
and hopefully get something that change
so we'll talk a little bit about that so
you start looking at this you start
basically building things from you know
first principles what features are
really right you just cut out on the
crap and you start thinking things fresh
what do you need well when you're
thinking about messaging you have
subscribers you have closure you need to
connect them you know to one another and
you have to have a couple different
things which are abstractions that you
hang your hat on the first thing was we
decided to be one of the channel the
idea of a communication channel or did
it then multiplexing across different
streams so that gave us you know the
idea of how you wanted to connect
subscribers you know to publishers as
well we also noticed we didn't order for
anyone right and the JavaScript space we
have so many frameworks and so many
things which are very you know they're
not really providing much value so we
didn't
a framework that had work gravitation
into we want such a much easier to sort
of work in to an existing framework or
an existing application so we looked at
it was more of a library or framework
which kind of met we wanted something
more composable so we narrowed it down
to bare metal we looked at things like
we wanted it to be a full end to another
solid layer 4 transport for message or
any constraints so to break that down
what that means is you have to set up
five things that you have to actually
happen first is the connectional ring
and communication it just means is that
you have a the concept of connection
from a publisher to a subscriber you
have reliability and this means best
effort reliability not where our
receiver goes you have to come back up
and everything descent would slow the
flow control as well we wanted to be
able to slow the sender down if the
receiver was too slow but we wanted it
to be wide enough that there was a lot
more variance in that a lot of you know
ability to sort of handle worse and
things like that congestion avoidance
and control is another aspect that you
know when different things are competing
on a network how do you handle a
congestion and so if we dive a little
bit deeper you know connection already
then communication basically means this
connection and there's some water
associated with that reliability means
is that you know you're trying to
recover it
if you can't or those many circumstances
hands what what's whole meaning that you
really want to try and slow down but if
things are too bad you're willing to
eject in congestion avoidance and
control if there is congestion in the
network it turns out that in trading
you're willing to get rid of this you're
not really as willing to get rid of lo
control but you're willing to get rid of
congestion avoidance it makes it because
it's fun necessarily slows you down
because it's more conservative and
multiplexing being the ability to have a
communication channel do some live in a
world you know which is monthly
everything you know we have multiple
cores windows services we have a you
know sort of a world where you know we
have to be able to stay and that really
means that there's a large number of
publishers so as we sort of started this
process we actually asked ourselves a
couple of things how do we design this
we have sort of music idea would be very
different from how all these things
before but we decided that we needed to
have a set of guiding principles so we
came up with a set and that's not the
same okay our set of guiding principles
is different in this there was a few
that we did the first thing is we needed
to be garbage free instead of statement
we were going to use Java as our
platform to sort of try out new things
we can iterate much faster with this and
so but to be able to do this and really
have something we
to think that this is one of the garbage
brief all the way from US Senator into a
subscriber you know had to be garbage
free there was no other choice we wanted
to take advantage of the idea of smart
battery in other words you shouldn't
have to trade off latency for batch and
fruit but you should be able to this
should be smart enough to realize how to
do that this next one the third one is
not an original set because we didn't
think we could do it so we kind of did
not kind of as our concept now I'm
walking I oh and the message path no
exceptional cases these are things that
we knew and cost if they were in there
and they would cause out much purpose of
things and applying the single rider
principle that means that we didn't want
to have a lot of shared state that had
to be dug deep and so we wanted
something which was very simple from the
from the sharing of state perspective
and we wanted to avoid unnecessary
colonies a lot of these things are you
know but they the same things that you
see over and over again in training apps
you see anyone who's doing Java and very
concerned about latency they look at a
lot of these two computers as we were
doing this
the wait three algos and then later on
release came into play of something we
could do but that wasn't until September
up until September we didn't know them
and then it wasn't supported not working
then you know in Denmark at a conference
where we looked at it and said we can
make this way through all the ways but
it took us a long time actually give
that poor world
so it wasn't a suspenseful story it
really comes down to three things and
this doesn't matter they're what what
kind of software you're free first is
architecture second is the data
structures that are used within and the
third is protocol contraction seeing
this over and over again with micro
services and other things like that
where these three things matter
tremendously so let's talk first about
the architecture of way out of Dallas
Aaron's pretty simple
yeah Rico sure yes subscriber publish
first thing to subscribe
it is simplex there is no high
dimensionality in that arrangement if
you want that we do it on a separate ok
so right now that means that we can just
have publishers into subscribable
interaction and a separate connection
going the opposite direction if we need
that so it kind of makes
and it would be great if that's all you
had dude put some choosing from the
publisher sort of control worse than
everything else but the world wasn't
warm up what's the matter so we had to
break things a little bit we knew that
we wanted different types of medians
gold memory as well as PCI iii/iv
networks and infinity we had before you
we had to have something which was
setting between the publisher and the
subscriber handle that differently so
then the publisher itself didn't have to
know how to us we came up with the idea
of you know publishers senders receivers
and subscribers you know mark and I are
very big fans of actually having
terminology that matches what we think
so that amazing is one thing that we
obsess over so we'll argue about certain
terms and this is one of them so these
these terms to us have specific
definitions and they reflect in the code
you look at the code on github you'll
see sender receiver publication
subscription these are those terms that
we use and they vary for such meetings
but what this means is that there is an
IPC we call them long offer we're going
to that setting between the publisher
the sender and between a sender and
attending subscriber they have very
specific roles
but that's not good enough because you'd
be set this to help that you need some
way of actually coordinating all of this
we have something called a conductor
that handles the creation and all the
administration of things so once you
have all everything set up things when
you're going fast but you have to have
something so it automatically dr. but
that's not even that's not good enough
we had to sort of put things in place
where we had the concept of quiet and so
the media driver is responsible for all
the protocol interaction and it's on one
side on the sender and receiver and in
the client writes with needy privately
with a set of different things this
right here you know the actually all the
different communication is done in this
system it's really a micro services
architecture with very defined roles
so the newbie driver itself is separated
from the actual applications you may be
thinking if you have them in a previous
life you know is the media driver a
broker in its own application with some
eminent sense there and much like
Facebook and a relationship status it's
kind of complicated it's complicated for
a couple different reasons but it's
complicated the fact that in can be
ranked standalone it can also be
embedded
but essentially at its heart what it's
doing is a quarter core being a few more
hand off network okay so it's ending off
the memory itself on the cache memory
that's on another cache doesn't matter
that it's in a processor this is very
different than a standard state of
growth which is usually going through
the operating system and get to each
side in this case where I don't know
recovering system actually going through
just a memory subsystem it's also about
the isolation of the protocol logic once
you've isolate the protocol logic away
from the application then occasion can
do whatever it needs to do that means at
least applause for some reason or so
it's a little bit complicated in terms
of how the relationship this is coming
back to it so that's the architecture
the data structures we actually have a
settlement when you have some maps some
primitive maps and some other things
which isn't currently that don't in our
garbage in the Java world and we also
have some ring buffers of what we call
broadcast buffer which is something
which can draw messages and we have some
inner thread communication
Hughes and they're pretty fast there are
different we also have a dynamic set of
arrays which are kind of useful have
certain properties that we needed but
the last thing is the thing that has
really just very much influenced the
protocol design as well as the data
structures and that's something we call
log buffer so what are the long a buffer
well it goes to the heart of what Aaron
is what Aaron is trying to do is not
trying to send messages and send a
stream of messages it's actually doing
something much more all-encompassing
it's trying to replicate a lot of
messages from one place to the sentences
that's a very different approach so that
this is what we follow you wanted to be
able to do something like this
so the question is how would you
actually do this well let's think about
this percentage if you were to pick a
file let's say we think about it like
you would think about it - you got a
pointer to a tail and you're going to
add a message so you go and you
increment the tail you put the message
in there maybe the message has some sort
of head of attention and if you want to
do something like just in that on the
camel the networks and send all of that
right and just send it down on the
network you know the signs that they
receive it and now you've got a problem
you can send another message looks just
like this let's break this down because
those log buffers are actually locked
reawaken structures and this is where
things get complex great and with the
components of the steps that we would
have to go to the first thing is you
increment the tail what this does is
sort of if you've ever been to a deli
ticket you know and then someone later
on said hey
you know come attend what's your order
that's kind of the concept implement
grab that that slot that whole region
now you can do with it what you want at
your own pace so the first thing is you
write the message into it and now the
message is there but you now have to
send I basically tell the other part of
the system that there is ready to be
consumed like we actually at that point
rank the header
once that headers been many that's been
a order you know memory access and then
you'd be seen by somewhere else it's
down visit so till that headers written
that message is not there just tails
that's a very basic but this means is
that you know it's a persistent data
structure in the functional sense not
persistent about model it which means
that it's safe to read without loss you
can actually read that structure as long
as you read the header course to make
sure it's there and then you can read
that and you can read that it's 123
seconds so a couple questions right if
you look at this we go okay so the log
of messages then written like this it's
the same thing that set on the network
okay all right that seems free you know
but does that mean that you have one big
file that goes on forever well you're
you're thinking about this is a real
system you can't think about you know
all the different things that would have
a very really large file right the ORS
would have ones where
subsystem so you know this is just a few
of the things you have to think about
okay so we can't have one big file lots
of stones well it turns out and have
same problems well wouldn't if you were
to reuse these things okay we came up
with something that was you know pretty
simple the idea of you know having an
active one that dirty one opportunity in
other words wants one where one right so
if you've ever traveled a lot you
eventually get to the point where it's
like okay omit a few pieces of clothing
can I put in my suitcase right can I can
I get away with just you know a couple
shirts can I get away with just a pair
of these right it's kind of the same
thing here how few of these can we get
away it turns out that three and you can
figure out how to work this two is
harder because there's a lot of
education you have to worry about it's
kind of like you're going for seven days
take two pairs of underwear take three
babies so the idea is you know that
there's what I have to one it's been
fulfilled and then there's one it's been
fun it's been improvements
how do we stay wait okay so lock-free is
there's no logs and lock-free than the
condition in a very specific standpoint
that at least one threatening promise in
other words you can have one friend
knowing
that's the key to being with our lockers
what does wait for me wait remains at
your locker you can always make fog rest
but it means that every other thread
that is involved in that operation will
complete in a certain number of
operations that's a very hard thing to
do so and go to Chicago the presentation
apartment is how to design wait three
algorithms and you know working with him
for you know there a couple years now
I've seen how some of these things work
we'll go into how this what's here but
there's some some of these there's a lot
of subtleties about these things
this presentation is fantastic so if
you're not planning to go so how does
this project handle so the first thing
is let's look at it as if we had two
different threads trying to add a
message at the same time okay so they
each have to complete and they may not
have to complete successfully but they
have to complete a certain number of
authorizations in other words they can't
set their own wait for something right
so the first thing that happens is that
the first one increments the take this
is an atomic operation on an x86
architecture
Lock Exide which isn't on the
cooperation supported by the sea most
CPUs adness as well it means that if
there's two different you know threads
or even processors trying to do that
same use of data it's a shirt at the
comic operation it will complete with
certain number of cycles so the first
one tries to act before anything else
can be done the second one increment
there's a reason why at that point
either one of them fill in what they
want to do let's just say that the first
one bills in its message and its head at
that point it filled it in quite fine
and basically grabbed its ticket from
the deli counter instinct on its horn
and now it's the fixed set of operations
the second one he could have been you
know very simple you could have written
it just within them and I still would
have been fun but that's kind of a boy
really is one where it actually
implemented past the end it's the call
that's it at this point he does not
complete successfully because he can't
put a lot of all its stuff in there so
what we do we pad that out in other
words unused space within rolls to the
next one even tries again these are two
different operations the first one
putting the pen again they didn't you
know within a very short period of time
he then goes back and tries again which
then he's successful that's why this is
what we don't have complete put that in
so what does this seem like from you
know that way if someone who's setting
out from outside they've written the
first piece of data and trying to run
right one is
they then try again could they be Timon
asana and a loop
yes they could and they would fail if
they were you know doing this over and
over getting kept in there that edge but
that's not the weight free for the
weight free part is each other's
operations will come complete very very
important distinction that's how much
weight why those operations are the way
they are at the counter so you know
that's that's the basics of filling
employers we've talked about headers
what's actually in a header and I call
this protocol for its you know basically
girl'd hath GART you know where I've
seized from the NTFS asperger c'mon guys
we can't get away from this at some
point I just wanted things out so that
we break them down this did not look
like it does today when you start this
is actually very simple you have a
version field you have two little bits
in an end so you can support for
education has some flags which are
unused they have a title field which
tells you there's a piece of data or in
some other groups of protocol negative
between this NFC verb you have a link
which is the this header plus the data
and the term offset which is where in
that sort of that file it is or the term
we call the term a session IDs bring my
these are things that we use to identify
strengths in a special event such that
the higher level and terminal which one
of those radiations we have and then the
message itself what blows us to come up
with this well the first thing is we
look at all kinds of different ways that
we didn't code this and we wanted
something which was the same header on
the wider and that was we could send
just everything out and then what we had
in memories one of the same thing which
meant that the data structure itself and
actually understand this header
originally the funnelling was sickening
that's it was squashed and we had the
concept of a bit familiar with ipv6 the
sort of concept of chaining headers
together before you have data and we
didn't send alignment and padding and
everything else and we also had a
fragmentation center well the things
that happen were as we started to think
about these data structures themselves
how they had to read memory memory
access and everything else 16 bits was
too small was a pregnant 32 this is what
we needed with architecture to work 16
misjudgment that we were you ever heard
of worked
was tearing it apart and it was just
slowing it down on the curb we ditched
it and they just made a friendly finger
we got rid of the interchange because we
didn't actually need all that complexity
it's great it allows us to add headers
and different things like that all it
did was make us event that header was a
variable thing structure so look that
only to just simplify this we don't need
all that additional stuff and if we need
that later we'll figure out how to add
because we just relentlessly tried to
simplify it into what does it need to do
and get rid of stuff that doesn't what
else it figured out that we actually
don't suffer a problem by sending
padding right it returned to replicate
that structure if we're sending padding
it's fine you know we don't have to send
all the zeros but we can send the
information that tells us that they're
padding there so sending panic and even
aligning you know in other words adding
things out to another to another cache
line or another padding down just
sitting that alignment it's only a match
you know you know like eight bytes this
is not a big deal when you're going it
like I've heard this percent problem so
it's kind of just annoying
so we relentlessly just looked at it and
said okay this is lick for high
performance it's you know it's not bad
thing that goes in sickness we're
replicating is this long web still it's
a fragmentation you're if you've never
looked at like you know protocols like
like ppm or included like IP
these six looking for fragmentation come
fragment piece in this time no ipv4 not
even v6 delivers that there's a lot of
information within our the maximum
length offset other other things yes
they don't mean that they're just
replicating that long and something
that's reading it just these two nowhere
that you start a fragment which again
defect or arguing no that's all the
needs so we've got about thirty days and
the last thing is as we were developing
this we're playing around with that we
came up with this concept of what we
call a position and it was something
that started out as a simplification for
flow control and it's now been something
that has influenced the everything all
the way from the sender to the receiver
and monitoring and everything else so
what is a position what does it mean we
inadvertently by doing this just this
replication found out that we could
uniquely identify a byte within each
strain across time by apollo street 1970
ten by the term offset intelligent a
bike that's actually 32 bits 64 bits you
know all the way up to this information
that's enough you know that you can
identify each individual by the process
string within the front so we're
position is is is taking two of those
pieces the term Adina's perm all set
it's just going mad it's thinking to
term Ivy I'm playing it by the size of
the term and adding an offset in other
words which cover you in plus the offset
within that term that comes your
position in the string doesn't tell you
which stream it just tells you with any
string and because you know we're not a
chef you're not we're not afraid of
wasting memory we decided that the term
side was always a factor of two we could
get rid of that actual multiplying who's
making the shift so that second things
actual population we do so what that
means is you know you can easily come up
with the position and by definition if
you're in a position you can also get
the termite damage from offset you know
in other words the diverse just because
it's math very simple it took us a long
time to realize this we're working on it
we're basically working around the fact
that we have different terms and
different bottles and how to actually
map it and then we realize we've all it
took us a while to bring it down so it's
kind of sending and we saw about you
know adding things it's just sending
what's there in law it's a very
different kind of protocol if you look
at it from a standpoint of something
like teaching or SCTP or any other part
of the type of protocol it worked on
before none of them do this they're
always sending data and then there's
reconstructing for some ways this does
not need to forever sin on the network
can be replicated you know in memory and
it uses the exact same structure the
exact same header i don't we have any
other protocol that doesn't maybe they
exist but how do you replicate it right
how do you actually take it from one
site to another well you can send the
data these are just pieces they have to
have a protocol around
and it's a protocol right has the same
in semantics that you would normally see
me any other type of furlong so what a
quickly run through what the protocol
looks like you have a sender receiver
data is sent but before you do that you
have to actually set up a commission
this is like your TTP's and except setup
actually has all the different pieces of
data but you need like term size and the
initial term like some other things
it's literally set everything up let the
other side have all the data it needs so
they can just string then you can't just
have a center that goes you know simply
set up and then you just slams data
right you know first that's read and you
know protocols are about etiquette as
much as they are about you know the
actual exchange of messages and so you
do this by saying first set up here's
what I'm going to be doing the other
side says that's cool
we can do that status is okay so since a
status message back basically says
you're good to go
go ahead he said and there you just
start sending data then you send it as
fast as profitable one so as you're
sending there has to be some amount of
data that's being sent back to telling
the statuses or how much you can send
them letting you keep going
and that speed the truth at some point
you may stop so there has to be some
sort of harmony to do couple things the
first thing it has to tell you that the
source is still alive second tell you
where in the string or the position that
the sender has sent up to so that the
last events were requested and by
definition if you have missed it there
has to be someone every customer that's
call the negative acknowledgment on that
and then a retransmission
that's it there is no other types of
messages yeah we're done she's 17
yes but not that much it did not start
this something we actually used to use
zero in data frames for setup and
heartbeats we thought this was simple we
thought really very clever and
intelligent things
okay so elements base for a variety of
reasons primarily because the inner
structures will not set up to have a
zero offensive followed by a non zero it
comes in the same position so we've had
to adjust we also had negative
acknowledgment that had a range of
things that they missed like a
scoreboard right I missed this range in
this rating history it turns out that
you just match our age range of this
different things that I missed for this
warming we originally didn't send patty
our own family we decided to go ahead
and send it because it is small one and
besides it actually caused us to easily
you know some kind of gymnastics we
actually had to comport ourselves in
various ways to be able to do that what
you're slowing us down so we decided you
know that thing Senate conditioners we
can just get rid of them we go faster
and all we revolve around actually
taking out the special pieces so as we
look at the protocol and it started with
something which looked pretty primarily
like an ipv6 and like normal protocols
you might be might see the idea we
quickly just started to get rid of
certain things because it just what
needed you know if you're trying to do
this simple thing of replicating this
data and having the data structures also
via the things that you're processing in
it required us to actually eliminate
so you know this is this is pretty much
how we kind of thought about things we
just kept simplifying and getting rid
through the special cases and we came
about was you know something with
reassembling messages is really really
simple and normally when you're having
to even in TCP and you're having
messages come in and they come in in
different places you have to keep track
of what is going on the complexity of
that can get a little overwhelming
you look at some problems you'll see the
gymnastics tent even TCP goes through
the track all this we actually figured
out a way that's a little bit simpler if
you're on the receiving side and you're
receiving them yours you have two things
you keep track of first is the completed
awards and continuous up to this point
the second is the high watermark they
work a little bit like this this piece
of data comes in if it's complete
complete is removed and high water
markets move what happens if the piece
of data comes in but it's not complete
other words is a gap like that well I'm
more marketing for the completely can
you can't move until it gets built in
just keeping these allows you to
basically know when there's a gap and
actually so this actually is a
simplification it actually turns out to
be a very simple part it's simplified a
lot of our processing just think about
these things like that and the only have
to keep track of an integer or actually
to
you know so as you send through you've
got a subscriber who is reading these
structures he can only move once he has
everything but he may not be consuming
everything up to City Hall he may be
back somewhere he may have just
processed message one and getting ready
to get message to andressa Street comes
to his exact so the question is how
would you do something if you know that
you have to keep track of the
consumption or that by a receiver
separately so we thought about this and
originally we've had it as part of the
data structure receiver be kind of you
know keep track of account of where and
adversity consume
there's no why's that was kind of a very
eminent way profitability so we actually
broke it out we actually that's when we
came up with the concept of the position
and broke it out so that it's not part
of the data structure when you think
about it it's not property of the kid
structure it's a property of the
consumer itself and we thought about
this they realize that it's actually
more than that those different currents
that I list publishers senators
receivers subscribers they all keep
position counts in other words where net
street are they in one time so if we
look at that third thing where you look
at a publisher a sender you send me on
the network and receiver who's receiving
off the network
into the locker and his subscriber they
all have position information where they
have architecture this actually
simplified a lot of stuff it simplifies
flow control is implied you know aren't
the way that we actually implement it
totally changes the way that we thought
about it in fact are lazy to drop
dramatically once we have we have one
small place where we don't do this thing
that's changed as we speak and it's
really these founders deserve really
counters are just then all of them right
there key to flow control monitor you
know you can read you know you can just
sit there and read the memory where they
are and you can tell where our publisher
is where our centers in other words how
much was made about the network where
our receivers other was or did that
received on to remember what it's not
one of them right as well as where it is
completed and where a consumer has been
all these are their goal for modern is
it tells you exactly where every
component in the systems in the whole
thing where they are in that stream flow
control that actually is not just one
portfolio because there is one control
between a public data center there is
boto between a sender and receiver and
there's both the total servlets we never
see where a subscriber and they use
decrement
counter is used between the publisher
and center as well as the community when
subscriber but from the network that has
to be Status Messages
that
Status Messages are just the completed
position of the subscriber and the
Wyndham other words how much is the labs
exactly like you would think the PCP in
other words I have acknowledged up to
this point past that I'm willing to take
this amount of data sent to me at any
one time it and beyond that I join okay
anything before this panel I only looked
that one you and as I acknowledge data I
can send more that sliding-window
principle to say it works very very well
for the status messages are sent back
periodically to basically move this one
go alone so which triggers the sending
of these it turns out that you'll need
three things you really need to know an
autonomous rollover only need to know as
you progressed to the term and that
quarter of a car that's something that
we just basically picked out of the air
it seems to work fairly well or if you
stop sending other words you sailor them
stop at some point the time I tell you
you know because something may have got
dropped you have a payment this is a
status message which means that flow
control was actually clocked by Senator
David those special handling is required
kinds of things it just sort of works by
the way why it was a porter chosen
because it's a power to in it's easy
math just works out so that seems
interesting in order to say nice a
single sender or single receiver what
happens if you were to do it right
well there is political strategies and
we've done a simple one which is
basically the one that moves the fastest
is what Fox everything but you know we
basically broken it out as a strategy
that you can then do a composition of
statuses for the whole series
we started we've been looking at these
off and on of different types of
strategies right now what's committed is
the simplest max strategy but we also
have preferred in other words you can
ignore certain people and only look at
certain other ones you can also look at
the plural in other words the point that
the majority has reached and another one
which is based in detail so once we get
them stabilized but these are you know
are guesses about what you know but
there also has to be a safety part if a
receiver totally goes away you shouldn't
have a senator that just keep keeps
blabbering on right you know you guys
all up left I may stand here and he's
talking or I may stop okay I don't see
people nodding her head or laughing you
know I'm probably going to stop at
something it may not be till three yeah
but you know
so there has to be the protocol has to
work in such a way to get there so no
feedback things stop okay they don't
progress
so you'll notice there's no Status
Messages
there's no definitive progression other
words does batik movement and if this
stops you may cut a little bit of buffer
where you'll send a little bit more man
it's important they'll eventually
congestion for congestion control is
less rating systems one of those things
you're willing to trade off and here
you really don't care it's a control you
know environment
you're really not that concerned about
these competing flows that being fair to
one another and you know teaching piece
of the done control is extremely
conservative so the facts all really
really far would it notices that there's
some walls the reason why it does that
so that it can come to analyze
equilibrium or everything is licensed
chair it's a sturdy table engineering
and so you're willing to give that up so
this is one of the reasons why Aaron is
about major congestion control but if
you wanted to do it just to control how
would you do it
welcome to my dissertation topic which
I've never done like most academics the
piece of information that is Status
Messages first is how far you've gotten
the next in the window in other words
how much and willing to accept with PCP
it has the same concept the congestion
window casing
and on the cinder he basically kind of
justice and what that capacity is the
receiver actually knows what the
capacity is from business perspective so
be connection manager so all that
happens with congestion control here
that window is dynamically adjusted
based on us if you want to be friendly
to TCP as long as you receive data you
increment it when you have launched
decrement in other words in one clip and
typically come in that will make it so
that you're fair to all over the traffic
very well understood part of TCP is just
flipping it so that now is all
controlled by the receiver so again
that's not something we've done but that
actually should work it would be
interesting to play with the play with
some before but that's not doing sweet
spot the differences over the things
that we have knew we knew that lost
throughput buffer size they're all
really strongly related almost
impossible to be comfortable right you
have lost your through post on their
game how much well very low controller
you're not going to just install it's
going to go down a certain amount and
only just control is going to get a lot
more assignments how big Tom's on
different things like that they do have
you know an impact on everything so it's
that interplay between these different
things they do have
the tests we have run we've been able to
do some extremely high school play but
to do that we've had the nice thing is
we have had to do that for late his
legacy is pretty much static there's no
additional tuning it's only when you
want to do them really high - looks like
I'm gonna launch a second then you have
to actually make the bomb the reason why
we don't just make this bunker figure
all painted is because you know some
systems well really so a tip that I've
been talking about this for years you
know
Nigar Nigar networking parameters for
the OS and how to what they do right if
you're using TCP there's a lot of things
that you can do to actually increased
ECP's behavior by tuning those
parameters it also has impact here so
I've kind of mentioned how things work
and you know what we kind of started
with and different you know anecdotes
about different things what else did we
discover this is the ranting part of
this so we chose Java right because you
know when Martin and Richard and I are
very familiar with Java we can do a lot
of different things with Java very
quickly there's great tool link we
thought we could enter it you know try
things out really quickly and that we
could but there's a lot of parts of
Jonathan really loose so the first thing
is do you want to tell me one of us you
know what a sign like this what are you
know the magic
I have no idea I don't know what
assigned bite means right
the lack of us like types makes parsing
a little bit further and wash away
another part you know that's not the
biggest Senator John had how many amused
niño really and husbands like it
probably it is really bad the locks
within it or cause a lot of contention
that cause a lot of outliers I have a
little talk that that goes into part of
this one of the pieces is within
Datagram Channel there is three
different locks are we there lock or
writer and you would think it really
should be find anybody should be fired
they shouldn't contend out one another
but there's something called a state law
and that is taken by both the reader and
the writer so if you have something
reads and writes it contends on the
state law
all King paws signals different things
like this we want to go really fast and
very close to what they can give you
have to go into different parts you
don't have access to the x86 clause
instruction which would be really really
nice if you're doing something which is
going and said and they're just polling
which doesn't get rid of that even if
system signals kind of string encoder
how many of you've done like grabbing a
string from a flight bumper you have to
create a character array to do this so
you create a lot of garbage strings yeah
you're gonna already the big parties
with the string but actually having an
intermediate thing that has to get
created is just less than less than
desirable it was very funny to watch
Richard as as he actually needed to get
a story to not have it there and then
realized this is kind of stupid so he
found a bug enus dadk about their
shipping this amendment even worth
amended put in there and they said
managing external resources since you
know Aaron does a lot of things where is
talking about a point on that platform
on its maps Thank You files there is an
easy way to map which a gala meant the
garbage collector on that so we do some
things were reflecting where we grab
there's actually an unmapped function we
grab it out we actually run them
underneath which means that you know but
you know there's no way to actually
manage that exponent resource in
chocolate you can close a file you can't
close a memory that's file they can
close the Bauman's can't close the back
selectors it's the like there's creating
a lot of garbage no matter what you do
they're also not Java eat friendly so
you can't actually do much nice stream
online it's one of those things that
when you look at it's just in Java EE it
seems like it's missing and it creates
garbage amount of what you do so we
borrow that thing from anywhere we went
in for a bit and then was able to do
with reflection so exchanged the
selected key set and with with our other
than a generic oh yes we borrowed a play
there's things that are bad and you had
to work around it to be honest every
language has this I mean I've been
working with a lot of secrecy
plus four years there's a lot of things
driving absolutely crazy and there's you
know and they're just as bad as there's
lots of things in the Java that over
everybody else totally tooling is
fantastic you've got everybody's graded
everything from Eclipse to IntelliJ
these are this is why we choose Java as
the first thing we wanted to in order to
be able to change these things quickly
and have the tooling that made it easy
and it did we try breathable I've used
then I used and this was a chance for us
to use Braille Martin has a roll hatred
for maven so we were not going to use it
I was fine with that
so we got you know cradle is actually a
really good build system has a lot of
different things it's very powerful and
it's actually very easy to use and
what's a fascist developers HDR
histogram gilts today is work from this
little you know we use engineering
histogram because we need to have this
percent cost related great told no
that's that's across languages his death
histograms a bunch of different ideas
JMC you know for profiling these jeans
being very heavily to really understand
what was actually going on what was hot
what wasn't my you know where should we
look
you know where what we're selling up in
the profiles very important for us white
clear district education thanks we
decided to do not use a lot of this
there's some of it but we actually have
it actually allows us to do some things
that you know we would like to be my
wrong or that
yeah probably unsafe some additional
things is unsafe you know primarily you
have getting add which are lights which
are just access to lock except which is
a core part of our management really
really good the optimizer it's probably
one of the things that Java has that is
underrated it can do an awful lot of
stuff there but Hannah's is pretty
painful as hierarchy some of the other
things if you know how to take advantage
of it which means that we actually have
allocated relationship with the
optimizer the optimizer does things well
we look at it and we say that's my point
we need to hold optimize and inline
stuff we look at you absolutely
important to do secret so it is
literally a locator is not a middleware
which is pretty much how most optimizers
whether they the last thing is garbage
collection some of the data structures
that we use we actually defer that
garbage collection it makes our lives
simpler from his eyes so it actually is
kind of Handy certain structures really
would so what is next
what are we what are we looking at and
so I know I've done a lot actually
a lot of those but what's there give you
an idea of where was it
we've done several passes of profiling
to me you just actually know sometimes
daily basis we've we've done a lot of
different things where what the
different profiles along the way
concentrate on certain places that's
really pulling it out you know where
where we should change them um where we
stand is it's really really easy even on
just this laptop to get twenty million
forty five messages per second and you
don't have to ten it for free you have
to adjust buffers but notice the same
settings what we're flying when you just
want to see what the latency and you
know this is just making the buffers
bigger there's no perfect size you can
just keep increasing them and that's
something we kind of increase the max
and you can keep going
it just needs it you're now using more
memory than you actually you never turn
on martin that has done at this point
five I've done work on this laptop so it
can go very very fast and we're not
stopping
we still have a lot of stuff the second
part is really done you know growing
some distribution ladies not a single
number is a distribution so you know
this is sort of a gives you a kind of a
share history of style this is a few
months of them now it actually is better
than you know where you know sort of up
to 90% you're very very flat once you go
into the a couple nine even of the
prevention of growing them and even when
you start getting up into the higher
ones you're still not growing back any
system that has locks in its path will
start each other and probably in the or
nine and five
and this is job you know we've had
various reports you know how this
compares to other messaging systems
Martin and I don't have access to any of
them so we haven't we know friends who
have done it you sent us the results in
Java there's nothing to consciousness
and even in C we know that C were just a
little bit higher at it but as things go
the C part even though the ones that we
know they they exert on tracing
automatically as locks start to dominate
some of the time so we've had really
good reports day this things are even
even with accuracy
we have a lot of things were you know
here's just a list we sort of look in
and things that changed the quarter
there and things that are persistence or
persisting at the instruction from one
place to another you can build all kinds
of archival and pre-planning and that's
some of the things that we're looking at
we're looking at what we need to add
replication cue stream quick there's
lots
where we're looking at you know we'll
see how how much of this we get to it
and there's other other interests as
well as there's there's people who are
looking at building different things
ideas when they're in the core layer
we're still hitting on performance we're
still improving things as well
Bosch cinema C is just a simple thing
that you would take prevent just sitting
in a loop and sending as long as you
have data we actually try to send a
group of data that's there we submit and
we go around we do something else
we're thinking of adding some very
simple lose you know that you would
think why did you do that already right
grab the data send it out there activist
end without any connectors well it's
kind of a tease like they're going dead
trading it off for something else so we
came up with a way where we don't have
to trade it off as much so doing those
how many have they used it is dropping I
mean is Martin like Parker the authors
we think that most of the destructor
cases can actually be used actually be
emulated with the longer core structure
which means that a lot of IPC mechanisms
to only think about the long harvest
so a lot of the disruptor cases could
flow into this or at least the majority
of we're working on you know C++ API we
would actually love to be able to do the
C++ to be driver we think there's lots
of different things we can use white guy
like people internally and send a
message receive a message on Linux
lots different things I could have
dramatically fruit were going to be
working on anything so that you can use
that as well as PCIe as well as we have
meeting has to multitask we don't have
any coolant for like the father format
where we can't use memcache
so those are the things that we push the
worse than attitude with this Marcus
actually
but anyway that's the kind of things
that we need to be seated
so in closing we took a really ambitious
tennis team we wanted to do something
that was very different than what we've
done before because we thought that it
would be work than we have any
differences and so I tell you that don't
be afraid to do that think about it like
this yeah do that big shift drive by
those things you know
and what's the worst that can happen
okay it doesn't work out quite like you
have so we have to work on work with
someone else but you'll learn a lot like
yeah baby
and with that
so they've got some questions in the
boat all the way down through the
colonel and back so that was IVC but not
just I can see for core it is also going
through so it was actually pulling UDP
out those numbers are actually raised oh
those are his peerless
ah interesting the ietf have been
involved with and done different things
at whist and standards organizations are
you've got to be nothing we're going
into the standards battle right battles
is too strong you have to be up for
actually spending the effort to go
through you I'm up for doing that but it
means we need some more experience to
make sure that it's nothing to lose so
there's so that's the first thing that's
been mature to a point where you're
pretty sure that this protocol has
something behind not just the data
structures but the protocol itself right
second thing is you have to find a
working group that it pertains to and
that's the hard work there is no one
working group that it pertains to I
don't know so if there were working
group didn't worked you know that it
would be perfect for yes
but it's kind of in the in the camp that
it doesn't have certain semantics that
you would think I'd like loves me so
it's not like a quick write it's not
code right or a constraint application
protocol it's it's it doesn't have a
whole from a working perspective but we
think in the stand it is the protocol is
over we specify we have a doc with the
specification when I'm trying to hide it
so you know it's central to what we do
and so if there were work improving
enough interest in that sure all four
foot I don't I just don't know work with
it maybe those but maybe there's a work
with your buddies
yeah
I had latency and throughput we we have
not actually done the latency at three
foot numbers yet but we anticipate there
one of them pretty pretty decent latency
it super is one of those things that
motifs isn't I mean you see this
trade-off you can't go to sort of point
where the latency is good and then the
link to skyrockets
we know that this legacy doesn't do that
but we just haven't done numbers and
that's just been because of time we
we've literally been spending our time
trying to find where we can improve it
just with you know just with you know
you know lazy ping pong test where
you're sending threads or order and but
yes we do want to do a latency at
throughput test because that actually
we're doing performance testing on a low
latency application do you typically
prefer to write your tests inside the
JVM review run something from the
outside to kind of generate and capture
we mostly because one thing is we want
to be able to profile it if you have
multiple processes that's right the
profile is just kind of painful James he
actually makes that is here you can
actually have multiple processes data to
report but in general we try to do is
one process we actually have embedded
who protested and invented ping-pong
tests that have the driver and the two
pieces of sin that was even better
within the same process so that we can
look at equity and we did that
specifically to just make our lives now
so we tend to do an applet it would
impossible
yeah so you for your call from the react
conference
yes
I have some experience with good model
check
sort of that style of analysis and yes
actually if there is things that we
could learn about the protocols that way
even more than we could learn about the
data structures that way because the
data structures themselves could lend
themselves to being able to specify that
behavior and look at invariance on that
baby and see everything whether we get
to that or not I don't know but I
actually think that it would it would be
it was a firm masters topic that would
be awesome
you could do an awful lot
what would you say is the performance
end and we were the structure in terms
of scaling the size of messages you
mentioned 45 payloads
how does that work so we literally
picked 40 bytes or culpability is the
primary one is the smaller messages is a
portrait test for any in you shifted
from the group of them to be immediately
CPM the smaller do you think because
there's more work that's not per message
so the reason why we pick 40 is because
it's it's small the other reason we pick
40 is because the header is 24 bytes and
40 means that now the message that's
just within a cache so there's a certain
artifacts that go away right everything
is on a cache line it's all nice and you
know everything should be really nice
you don't have to worry about certain
types of let's you it kind of clears the
fog it's so it also turns out that
that's going to be your sweet spot if
you wanted to stand and be the fastest
that's kind of where you're going it's
somewhere in there and also you lose
market data messages are small and they
don't leave before the byte small but
they're they're small they're not so
would you say it's a unsuited for
personally larger holes another
announcement it's totally certain we can
totally saturate at in Haiti you know by
sending even even 45 messages we get
really close to the
you don't have to go much further and
you're totally or completely
you can't you know if you're seated
you're here as you increase the lay the
size of the messages you're a cpu you
start withdrawing from that because
you're actually doing less work because
your improvement we do fragmentation of
the assembly
so you fragment messages as they are
sent and then they can be optionally you
know reassemble on the receiver side
you're not gonna be an homage to we do
there
we do have a max message length which is
approached up at the wrong size and
that's again that's kind of a number we
threw out of there but if you want to
you can increase in homicides that you
can have bigger vessels so there's no
real restriction you can send very large
messages and you can in a very efficient
yeah as far as the profile of the device
that'll be suited to run this protocols
is something that would scale down to an
embedded device potentially there
actually is a little bit of interest in
it you know using it
the short answer is there's nothing that
stops it you can you can totally run an
errand within any JVM that supports on
this day there shouldn't be any
restriction I have not but I don't see
why others can't and we said that you
may want to think about different Idol
strategies and things like that because
they would have a big impact on things
like that or you like if you were to try
to run the low latency test which is a
busy spin on multiple threads on
something like an ARM processor attached
to a battery that batteries may get
sucked dry really really fast so that
may not be the best use case but you can
do a lot of things to prolong that
matter and because you have a little bit
more about what you can control there
and I don't know what the battery life
but that's what I would be more
concerned about is finding the right way
that you're going to do the duty cycles
of falling apart you know pieces that
are there but yes prettier than an
invented devices perfectly fine
I hate feels but when is the
use case squid from an antique
after
possible play
so something kaka kaka is sort of a
clustered solution brokered solution
that's persistent huh you know medical
ops potentially any kind of scales with
it doesn't scale linearly independent of
scales to a certain point I don't know
enough about where it would start to not
scale as well the so it has talkin has
certain advantages it has a really nice
architecture you know from a burger
cluster model it's a very nice piece
it does have some contention within it
just because the way it's designed the
persistence aspects of Aaron since I
said it's a persistent in the terms of a
functional language persistence in the
instruction what we're looking at
persistence in terms of striking is
based on terms so that's stream much
better and have lower conceit contention
they have something like octave does
with the clustered solution which means
that as Kaka as you add things to it at
some point it's going to be kind of tail
off right just just you know on Magua
and universal scalability law it's so
important kicking right we've
intentionally designed parents of that
we don't think that will happen now
whether we've done that or not and
whether that actually is true you have
to prepare out but we think that there
shouldn't be anything that stops the
persistent and I mean in a volatile
storage way like a common being you from
here and be using these cases it should
still scale we just don't know what you
and it will take us until we actually
get to them but so that that's that it
could be being a different topic
topic is Club subsystem the only
difference being that first thing an emu
key message is not a simple thing it's
another staple parsing you know things
within it it can be done fast but it
can't be done like these days so it's
yeah it has a variable length header it
has a variable message that will be
tough hard to put into this data
structure developers Arabic instruction
and I'm sitting that's bill first
I think they kill actually free openness
but it it into something like that would
be a much better question for them III
think pause would be a really good one
because what pause does is it feeds
speculative execution it makes some of
these things better
from from many different angles it's
also friendlier you know to the CPU but
actually I actually like personally
there's a lot of things I'd like to do
to send the instruction so I'd actually
like to see a whole bunch of attributes
that it opens you can pause just being
one of them
you know first thing I did is kind of
working with C++ line API was to
actually go yes I could do pod and you
know put it into the into the duty cycle
and then I was strategy since I had
access to you know so yeah I don't know
it's been very disappointing to see sort
of the action if you were on Twitter a
couple days ago you know Martin had
brought up the fact that there's still
these things that are there and the
reaction from the open JDK community was
you know well okay why bother
well that was rejected why you know
around stringing coding things like
that's I mean there's you know it's it's
I don't know it feels a little weird you
know with the Jake I don't spend enough
time there so I love the sea you know
additional things
but I think the progression is towards
getting rid of unsafe or at least
deprecating it or pointing people did
not use it which you know it's kind of
it being a lot of what what some people
want to do they really want to take that
because they like the rest of work you
know the change it gives them the jvm
against them so that's it
the other question stop
yeah I have to apologize I haven't
gotten to as much as I thought what I
wanted to you know the state of it is is
that the saw you know with the help of
people the reorder instructions are the
same as what you get from Tbk so then
would access ordering everything else is
equivalent and some of the base data
structures are there we have also some
of you being able to send the commands
to the driver the next step is is to be
able to send so thanks
that actually isn't that hard it's just
something anytime to do it and
unfortunately you know I just haven't
had the kind of so the state is is that
I really really want to work on it but
reality is I just don't get to work on
it as much as everybody but the goal is
is that you get sleep on us before our
goal is actually viable the end of the
C++ port is usable start playing with
blocks that's that's actually better
home you know for a little while it
actually would be large that stuff
happen so we're thinking at least by
today and trying to set that
on that same token do you know of any
interest until go client at least on the
consumer side
I would love how to go quite in fact one
of the reasons why I want to ask all
possible you know work is cement there
is a way to integrate in with go in our
life I actually have a fondness for
Erlang and so I really loved that I see
this being the first step there actually
works I don't know the details but I
have heard that Google has been making
an additive every moment ago which means
that at some point there may be
impossible to have any direct client
that Toscanini drug and the better works
in its best
so I kind of like
and I'd really like an excuse just to
fight
this is sharp no one wants to know about
c-sharp so good source
oh yeah
let's go with 16 16 is dominate great so
I have your information and I can email
you your free registration so also jump
to let everyone know just like being
here you guys get $100 off registration
for go to Chicago using the code I love
go to so if you want to go to our heart
page and register you will get $100 off
registration I also wanted to point out
that dean wembler is here he is another
speaker he's right in the back throw I
he's another speaker I go to Chicago and
we really appreciate him coming out
tonight
Thank You Todd for coming all the way
from San Francisco and thank you guys
for coming out tonight and also thank
you to trading technologies for
publishing this bed with us</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>