<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>GOTO 2013 • Knock Knock: Understanding Who is Using Your Web Applications • Aaron Bedra | Coder Coacher - Coaching Coders</title><meta content="GOTO 2013 • Knock Knock: Understanding Who is Using Your Web Applications • Aaron Bedra - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/GOTO-Conferences/">GOTO Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>GOTO 2013 • Knock Knock: Understanding Who is Using Your Web Applications • Aaron Bedra</b></h2><h5 class="post__date">2014-04-08</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/CGC0ajOBV_M" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">good morning so I changed the title of
my talk from the title advertised in
particular I wanted to emphasize
behavior based approach to security and
actually talk about how we get there and
what behavior tells us so I think this
will be interesting because i think this
talk will focus more on defending and
the other talk following would focus on
attacking i think it's a really great
combination because you really need to
have both sides of the story to be
effective but i'll talk about rap sheet
kind of towards the end of my talk what
this really is about is that you know if
you have a web application in pub in
public right now it's being attacked
that's no secret right that's not that's
no surprise if any of you are surprised
get ready for more surprises it's gonna
happen right it's gonna happen again and
again and again all day long every
single day and not because you're the
target of an attack but somebody's
looking for a crime of opportunity it's
a drive-by essentially they're going to
look for an opportunity to try to
infiltrate or just exploit your system
for for what they can get out of it and
I want to talk about ways you might not
think somebody can take advantage of
your system in order to kind of get
there I'm going to start with some very
simple ideas and then we're going to
build on them as we go and create kind
of a holistic approach to web defense so
I'm gonna start with the drawing and
this is a pretty simple drawing it is
the default stack right you have some
user land stuff that comes in you have
what is essentially a web server really
a reverse proxy to your application and
then your application itself obviously
you'll have load balancers and all kinds
of other fun things in front of it but
this is the 10,000 or 15,000 foot view
and our default response to protecting
our web apps is this right how many of
you stop there it's okay to raise your
hand yeah sure I mean the reasonable
approach is we protect this by putting a
login in front of it we have a username
and a password and there's lots of ways
to manage that incorrectly but we'll
focus on that for just a minute and
hopefully have a better designer than
so what happens right you come in with a
username and password and you provide
that via request the request comes in it
validates whether or not the request was
good or bad and then we go on with our
day right and that's where the security
stops Billy actually seriously consider
this when you're when you're thinking
about security of your applications how
many of you actually do stop there
where's the various additional controls
at how many of you ask a second question
later on maybe somebody logs in and they
come back how do you verify that they're
the same person that their session
wasn't hijacked how do you validate that
if you're over SSL their ssl session
wasn't hijacked which is a very much
more interesting topic that we're not
gonna get into in this talk but it's
really about asking more questions um
there's a lot of data that comes in and
we ignore most of it and data that helps
us decide whether or not something is
actually good or bad and getting back to
behavior it's not the behavior that I'm
after it's the intense and and the way
to get there is to derive the intent
through the behavior but I want to make
kind of a caveat here and this is a
really important point and I think this
is got is this is wrong and security
over and over and over again is that I
don't want to ever impact user
experience in fact I'm gonna make it
better right there's just weird little
balance where security and usability
seem to be kind of on the opposing their
opposing forces right the kind of butt
heads I I think that's terrible right i
think one of my favorite models for
security is a casino how many of you
ever seen the security in a casino
really seen the security right you don't
actually see the security agency now you
see some some shows subscription show of
authority or some show of attention that
makes it makes you think it's not you
know feasible to steal from a casino
what's going on behind the scenes it's
just just monumentally complicated and
and really really intelligent
sophisticated and that model think is
interesting because you're there to
enjoy yourself and they allow you to
enjoy yourself and do whatever you want
and then one you're suspicious they at
on you and I think that's a really
really interesting idea so that's
different right that's a different
approach than kind of a standard
textbook approach to security so I want
to talk about the kind of ideas that get
us there and then some pieces on maybe
how we can then can change the game for
ourselves I'm going to start with
signature-based detection it'll be some
pretty simple ideas the ideas that I
think are really important here is
anomalies how do we find anomalies and
how do we plan to figure out what
they're worth right whether they are
showing a tenth of malicious behavior or
just somebody being confused or maybe
even a bot that's that's harmless I
wasn't and that's what we're going to
start to collect store and kind of
propagate information about what we
learn about activity of actors on our
sites and then for really how to act on
them like what do you do when you find
out somebody's being malicious there's
lots of different things to do then just
stop them from coming in there's
actually some really interesting ideas
there and then finally a tool that I've
created to kind of help manage this
whole infrastructure called rap sheet
it's an open source projects and I'll
talk about kind of where it fits in and
why I kind of motivated to start
building those tools so we'll start with
signatures and this is going to be the
kind of the easy part of this
conversation because it's very
straightforward just to get a kind of
idea of where we're at how many of you
have not heard of mod secured it before
ok cool so many hands great month
security is something we call a web
application firewall layer 7 firewall
it's an oversized project it's a
rule-based so you give it a bunch of
rules and it will what they really are
is a bunch of really nasty long regular
expressions that match patterns on data
it's an interesting project interesting
idea and I'll talk about kind of some of
the downfalls of it as well but the the
kind of basic ideas allows you to block
traffic or kind of alerts when it sees
an attack let's let's say you have a
form and somebody puts script alert
script and script and posts it mall
security will see that and go that's
that's a cross-site scripting attack i'm
going to stop that I'm gonna let you
know that that was an attack I mean
obviously gets much much more
sophisticated than that but that's the
basic idea modsecurity by itself as a
framework it's kind of bare and then it
has
this kind of cool rule set and the olas
project kind of provides this court rule
set along with mud security and it's all
covering the top ten and some of the
kind of basic attacks you'll see
although with some of the more advanced
next to you and honestly it's a really
great tool to add your stack because it
provides data it works well in most
modern web servers so apache engine axe
is it was really designed to work with
Apache works well with Apache the other
two web servers are you know it's it's
interesting so if you're an Apache this
is a very simple install if you're a
ninja next I asked it's a little bit
different but it still does work but it
requires lots of tuning the problem with
rule based detection is that tuning is
super important because the way your
site operates the way people interact
with your site the way you've written
your code to interact with your servers
it all can trip these rules right and so
there has a high possibility of false
positives so that's not good right false
positives are really terrible especially
when you start to block traffic and so
you can kind of operate not secure in a
couple different ways it's the passive
and active versions and I tend to
operate in the passive version by
default because I'd actually don't want
to block the traffic on just a rule
match I want to be a little bit more
intelligence about what I'm doing but
there's a class of attack so this is
really good with and that's a zero-day
attacks how many of you remember the
Ruby on Rails remote code exploit from a
couple few months back right so apolis
was published very recently or very
significant within a few hours
modsecurity rules were also published to
block this attack because the signature
was very simple that it detects so folks
that had a long patch cycle or couldn't
quite get the release out the window
when you know there's this giant gaping
hole in your railed application we're
able to install this rule in mouth
security they had it running and stop
the attack while I patch their servers
so we'll buy you some time while you're
fixing your software for instances like
that I think it's actually incredibly
useful that's kind of effective in just
isolated situations not day to day day
today what I'm looking for is the data
right did something smell weird here for
this request right normally I wouldn't
see these kind of things but what
modsecurity will tell you is this
request was unique it was different
something's wrong I want to investigate
further and
I think for the power here so we update
our model and what changes is we add
mods security to our stack right it's
still get in kind of inside the web
server it's um it's a modular you load
into your web server with the patchy
saglam dynamic object with engine axis
compiled in with with is it just a dll
gets loaded and we kind of go on with
our day there's not much to really
consider in the world of static firewall
rules it's it's pretty simple where we
will not focus more as on anomalies so I
want to stop for a minute i'm gonna i'm
going to show you a series of requests
for requests i want you to try to figure
out what's going on and this is what i
mean by kind of driving intent what I'm
talking about it so the first request so
you post a slash log in here and then we
see you know other information about
their quest give your user agent so we
have an IP address size of a request
that's the internal IP nothing in
particular but this is the first request
this machine ever made now i'm going to
show you the next three requests so
here's the next one it's a post to users
user name and credit cards this in
particular is another user agent IP
address etc the next request and finally
the last request what's going on here
trying to look for Beth over the why
there's something much much more obvious
happening I'll replay them one more time
just to get us in the right place so
post a login request number two number
three and number four so what do you see
here sorry yeah the request rate is a
one second in between imagery intervals
the first request was a post request to
a forum what always follow what should
precede a post request to a form a get
request right you should get the form
before you post it there's some other
things too let's actually take a look
right I see website getting carded so
the industry that I work in is credit
cards right Braintree process credit
card information in particular there's
an event in if you take credit cards
called carding which raises the question
of what what in the world is karting how
many of you take credit cards on on your
websites all of you are being carted I
can pretty much guarantee that if you
take credit cards on the internet you're
going to be the victim of carting what
this means is that in order to provide
good service to your customers you're
validating the credit card when they
enter it so you have a profile page on
that profile page you enter a credit
card number and what happens is that
credit card is verified as valid before
you then try to purchase with it that
may be that way they purchase experience
which I got experience is good right you
don't have to worry about this weird
little situation where they're trying to
check out and your credit card
information isn't right so they can't
make the sale and then they just go away
right and you lose a sale that way so
you try to reload this this negotiation
with a credit card company and make sure
the credit card is good and so what
you're doing that was offering a free
service to anybody who wants to validate
stolen credit cards
and this is very mechanical there are
very large criminal organizations that
this is all they do they steal credit
card numbers they generate credit card
numbers the space of valid credit card
numbers is very small it's 13 to 19
digit numbers there's a algorithm called
blunt n that validates credit card
numbers the space of lund 10 valid
credit card numbers is very small you
just generate them there are known
quantities of information about that
credit card number the first four is a
you know it back identifiers as a pin
number that's a bank identifier there's
lots of different things that show you
exactly who is backing this card and
what type of card it is the actual
unique numbers are various even even
smaller part of that so the amount of
stuff you could generate just test
whether or not a card exists is really
tiny and and a lot of us will give you
that information back and forth it's
like oh yeah the car's value but the
address is wrong and so let just keep
going until they try to figure out you
know valid cards and they'll go on and
on the sevens in the black market for
actually lots of money and the way they
do this the test is they hijack servers
they have scripts that run around the
the internet just basically taking
control of machines put putting them in
charge of a command control network and
then distributing scripts for each one
of your sites to go in test stolen
credit cards won hundreds of thousands
of servers there for lease essentially
what they end up doing is it's easy to
44 bad stuff you could you can rent time
on these servers that are that are
hacked to do whatever you want right and
what's interesting about that is that
doing it a lot I worked at a company
where we saw upwards of you know maybe
almost a million a month requests you're
not trying to validate credit cards and
now what they'll do is they're smart
they'll fly on the radar they know based
on how big you are how much traffic you
do they'll try to not be too aggressive
but the script fails in time the time so
enough aside that's the idea of carting
that play by play the things that are
interesting about this requests right
and this is what I said we ignore the
data a lot are a couple of things right
the first thing I already pointed out
there's no get request before the post
happened something is wrong here now
maybe their IP flipped in between they
were making or making requests I don't
know rights like it's not enough to say
that's bad
it's just different also there's a
one-second delay between every request I
don't know about you guys but I cannot
type my credit card information in in
one second and tight and hit enter and
then do it again in one second and hit
enter I know my number in my head but I
still can't type it that fast and all my
other information and so something else
is different here right the request rate
is just too uniform third how many of
you remember when Windows 7 was released
and what version of Firefox was out when
Windows 7 was released so let's say you
install Firefox the very first day
windows 7 was released what version of
Firefox did you get yeah not eight right
maybe three because Firefox of some
weird versions but it was definitely not
eight right it was already out so this
is an older version of Firefox something
doesn't match up here but more
importantly Firefox seven and Firefox
eight are associated with what very
common tool as user agents what headless
tool selenium webdriver 'he's right this
is a very common user agent to have on
web drivers from selenium etc so we
doing headless testing you'll say this
user in quite a bit as well also windows
NT 61 will tell you the version of
Windows the revision number or service
pack will tell you kind of what patch
level of what others are running so a
lot of times you'll see msi six NT 51
sv1 that's saying that this is windows
XP service pack 1 running ie6 that's
usually a lie most people running XP or
at least patched beyond that so user
agents can be spoofed not really a big
deal but something to consider right
foot things are starting to add up right
things are beginning more and more
suspicious and finally I'm going to tell
you that this was a US company doing US
based business so the blast thing here
is that the request came from Bulgaria
so now we have four things in four
requests that all don't add up right you
can see the story is not more compelling
now than it was that first time when I
have this post let it get right that's
it's interesting but it's not
offensive in any way but now we see this
is building a story we're building a
tail and we can be pretty sure here that
something is is bad enough you might
want to take action against it now the
other thing is that this continues
10,000 more times so we're pretty sure
it's a carding attack but the thing is
we don't want to wait ten thousand times
before we do this because you can make
10,000 requests pretty quickly what we
really want to do is do this in four
requests or less right i mean obviously
there's other ways to deal with this but
we want to do this as fast as possible
to prevent those carting attacks because
if all we have is blocking the IP it's
like playing whack-a-mole and it's worse
because you have to play like
multi-threaded whack-a-mole because
they're coming at you with tons of
servers as soon as you block them five
more pop up because I realize you to the
action against him so the first thing
I'll do is just hit you with one server
until you stop them and they'll get more
aggressive the strategy changes these
bots are actually really sophisticated
as soon as you change they change too
and this game is cat and mouse this goes
back and forth so you want it to be
really easy to detect really easy to
block and kind of automate itself so I
tell you that for that particular IP
address that was the only request that
ever made it never appeared again just
disappeared forever right this this is
part of these attacks right there there
there fraud attacks but at the same time
there they cost you money right there's
operational costs but all of those
transactions back to validate credit
cards cost you money right some services
don't charge for that some do it depends
on your deal but at the end of the day
most cases actually cost you money so at
the very least they're costing you I
mean maybe pennies but millions of
pennies add up over time so there's
something else that gives it away now
this is kind of playing into more that
more of the anomaly side of the world
there's something that's very simple
about the nature of what will happen in
this request it's very very obvious but
we tend to ignore it anybody think of
about what else might have given it away
think back to that at first comment a
maid
so what was in common across all four of
those requests so that we had IP we had
user agents and what else we had to be
have in common all four of those
requests for what type of requests post
requests yeah we never had any guess
that follow the three RC right so be
also there was that 302 that was
responded on that was never followed
right that's another huge indicator but
we've seen an anomaly I can guarantee
that because how many of you have
websites where the distribution of HTTP
verbs is post one hundred percent
actually um at braintree we have one
that's almost that way our gateway API
is almost all posts or cuz we have put
some delays as well but it's it's
legitimately almost always posts but
that's not common right most of the time
you have a distribution of traffic that
looks something like well maybe not like
this I made a bunch of numbers and I
think they add up to a hundred percent
but you get the idea right there's a
distribution of requests and if you
sample your traffic any point in time
you can calculate this distribution and
then you can take a single actor and
calculate their distribution and there's
this wonderful thing called statistical
significance right have a deviated is
this different enough to be an anomaly
it's really simple but it's incredibly
powerful because when you design an
interaction on your website you intend
people to follow your design user
experiences about leading somebody down
a path and if you've created a path that
everybody follows the distribution on
request is gonna be the same for
everybody else and when it's not there's
intent there something is wrong right
maybe it's a confused user maybe they
don't know what's going on maybe they're
a Luddite I just use a computer for the
river ferry first time and don't know
how to click on things right there's
there's lots of different things maybe
you made a mistake maybe had a be
testing that went wrong there's lots of
things that could have happened but the
interesting part here is that there's an
anomaly and that is the first part to
figuring out that maybe you want to
closer look so this distribution of HTTP
methods super easy to do and actually
becomes really important so getting back
to behavior right when somebody deviates
from the standard pattern the standard
actions there has to be a reason we want
to find that reason that's that's kind
of driving me towards my point here
let's kind of take a tangent for a
minute though about behavior and I'm
gonna talk about gip because i remember
i talked about bulgaria being the
request and be having a US based
business i'm going to talk about a
behavior change that you can that's
actually probably affected some of you
in this room and geoip can help you it's
a really simple idea to add right about
mon security was simple plugin geoip is
also a simple plugin this is just look
at data act so it's generically useful
to have g.i.b data if you want to know
where your best your travels coming from
and maybe you're looking to expand your
business and you want to add locales
more languages maybe look in geoip and
say where's everybody coming from I'm go
to that language next right it's easy to
have some business intelligence but in
the face of an attack it actually helps
as well it helps you protect your users
that might not be obvious how yet but
i'll paint a scenario for you remember
very early i had you know king Roland
logging in let's like king Roland gets
his gmail account hacked this is a
pretty common thing what is the first
thing somebody does when they hack your
gmail account if they're really going
after information what are they going to
do many guesses they might change your
password and that's that's cool what
else are they going to do yes absolutely
so how many of you use your email
address for every social network every
thing you you buy with or you have a
digital footprint it's an enormous right
it's all linked back to that one email
account maybe a couple of my accounts if
you're you know tricky about how you do
things but generally it's tied to one
email account they're gonna go and
they're going to try to basically steal
stuff from you that's really what
they're trying to do when they hack your
gmail in the most cases just steal stuff
right buy stuff on the web sites under
your information creature credit cards
there you're already authenticated but
the magic thing how do they hijack the
account what do they do they say I
forgot my password right and they send a
password reset request back we're really
nice oh you want to have got customer
experience when you boot your password
we want to send you your password or
maybe not your password you shouldn't do
that you send the password reset request
link and they click on that may change
the password but now that they own your
email account they
click the link and typing their your
email address and now they can take over
your account it's really easy right this
is super simple this is effectively how
we deal with forgotten passwords right
but there's a loophole because once I
own your email account that's that's
kind of game over for you so this in the
past additional cost normally respond
with the password reset because that's
what we do we want to be you know a lot
of customers to use our sites so maybe
you don't write maybe don't quite just
send the password reset request maybe
you keep track of the gip region that
that person always loves in from or
maybe they'd last ten requests so we can
know from history that king Roland
always loves in from druidia that's
going to be true across the board but
all of a sudden for the very first time
ever we see a request for this passive
reset coming from spaceballs city right
it's never happened before but it
happened just now and it's not like it's
a login attempt which would be
interesting or just a simple attempt to
access our website it's this particular
past reset request i'll count
modification request coming from a
previously unknown gip region something
is wrong here right this is that anomaly
thing this is the behavior thing
something is wrong so instead of sending
the reset you ask questions and this is
where security controls and usability
actually start to the line blurs right
because you can change the experience
now instead of sending the past 30 set
requests maybe they have to answer some
questions before you let them reset
their password right normally say
passwords that request you hit the link
you change the password you go on that
experience is fun for everybody who
seems like a normal user when they're
not you change your controls you dial it
up you make it harder or maybe you don't
send it at all maybe you say please
contact customer service and you have a
script that you run through with them
and you have some questions there's
plenty of ways to approach this but the
point is that you stop and the end
result is hopefully you protect that
user from bad actions from having
everything else compromised and you owe
it to your customers to do that right if
if you are holding their credit card and
charging it you have a responsibility to
them to protect those those assets
because in their gmail contacts
and somebody buy stuff on your website
they're their accounts guess who's guess
who's at fault it's not gmail it's your
crappy security that made this happen
right people react to this it's not
rational they don't realize that they
got hacked they got the gmail hat and
they logged into your account and they
hacked your account and got the password
and or not the password but the credit
card and charged something right the
problem is your site charge them money
what it shouldn't have so it's your
fault and that's powerful something you
have to remember because you do have a
responsibility so I mean there's also
that kind of big large large brush kind
of approach where you could say well I
only do business in these three
countries so any other requests many
other countries just turn them off I
don't care about them right that
actually is a whole class of problems it
disappears now it creates a how the
classic problem if somebody's traveling
to get one of those other countries then
I can't use your site so you want to be
careful about this but maybe there's a
country particular where you just never
do business at that is always bothering
you you could just kind of like turn
them off if the hidden up inside you
just go away right and sure they can
come from a different IP from a
different place there's tour there's
lots of things but eighty percent
solution works really well most of the
time it definitely helps out and so you
just kind of turn the volume off for
certain countries and so now our model
looks different right we've changed it
one more time but we're still in the web
server space the gip stuff is modules
everywhere every major web server has a
muzzle for geoip there's stuff you can
do in code as well but it's slower the
database is actually the same for all of
them pushing it up to the web server
level is actually nice because now it's
in the headers the request it's done
really fast really done in C or
something quick and the headers come
down you can just access them and use
them that's what you're after in the
first place so so other anomalies that
exist I don't want to go into too much
detail but all of them we won't have
enough time request rate is really
simple how fast are they making requests
a normal user makes requests at you know
a human user right I'm every 30 seconds
a minute to minute something like that
right sometimes you have mechanical
interfaces that are different but it's
important to kind of understand what
that is really really interesting is a
thing called head order right how what
are the order the
sent down your server and you never look
at that it's just data it's noise right
you might look at the headers themselves
but they tell you something every
browser has a unique head order it's a
fingerprint of that browser if somebody
says I'm ms ie6 on Mt 51 service pack 1
there's ahead order and you can look at
that and then you can decide that the
headers come into that same order or not
cuz if not they're not msi 6 XP service
pack 1 something is wrong here it's a
really easy thing to follow but it's
also a clue is maybe this is not who the
san diego's maybe there's an imposter
here and if somebody's impersonating
themselves or being an imposter they
probably don't have good intent now
maybe they're running a at on that's
just doing something like that to you
know maybe they're really conscious
about privacy they're trying to do
something different i don't know right
but what it says is there's an anomaly
here something is wrong something is not
what it says it is TCP fingerprinting
passive TCP fingerprinting when they
passed you packets you can sometimes not
with a super high degree of accuracy but
in a lot of cases detect what the OS is
that's coming in you match that up with
the user agents and if they lie but now
you have another point of data so it
could say the header or is off tcp
fingerprints lying it's that it's like
it's basic building a case you're
building a story on whether or not you
want to act on somebody if you have
users if there's a high volume of
account activity creating deleting
subscribing on subscribing from single
actor something is may be wrong maybe
there's lots of users being accessed
from a single IP address something's
something's fishy something's wrong here
really your business is unique your
snowflake anything can happen you have
to build the case around how your
business functions and decide what's
good and what's bad this is an open end
of story but there's a common place here
or common theme I should say and that's
does the behavior fit in equation can I
actually say this greater than this is
bad something along those lines you can
basically look at data apply a formula
and get an answer that's step one right
your detection is super simple if that's
the case so examples of this are things
like is there
qwest rate greater than the threshold
does the CCP fingerprint not match the
user agent head order include a same
thing but that whole thing about
deviation of HTTP verbs is actually a
little bit trickier I could say it's
deviated but that doesn't mean that it's
got mal intent for example the Googlebot
we love the Googlebot it makes the makes
us popular in search engines or being
yahoo whatever right we want that to
succeed we don't want to block that but
it's different its behavior is not the
same as everybody else's it's basically
a bunch of get requests but you can look
at the user agent it says Googlebot you
look at the header order of the
Googlebot which is very important and
make sure it matches those kind of
things are important in the request as
well but you want to make sure that
you're not blocking things that are
actually there deviated but for a good
reason right there there they're just
they're done anomalies with good intent
100% post requests usually isn't as a
sign of bad behavior but like it's not
always that simple right there's this
great areas in how you would judge good
or bad or intent in general right next
scenario right you have a higher equate
request rain people signing up for your
service it's all coming from a single IP
address is that good or bad yeah so now
you have to decide whether it's an added
IP or whether or not it's a fraud is
it's spam whatever bought of some kind
it could be that you just rent a deal
and everybody came into the office and
there's an obvious emailed everybody
saying hey this company is selling out
something for half off go sign up and
buy it right now and everybody the
office at once just goes to signs up and
buy something that's actually good you
want that traffic you don't want to dock
you don't want to dock it or deny it on
the other side this gets harder so there
are things you can do to determine
whether or not there's possible fraud or
possible bought activity or basically
mechanical activity obviously that
request rate thing all this that I
talked about is there but there's other
formulas how many of you familiar with
the levenshtein distance function what's
it really really good at
if you give it an email address or chew
em addresses it's going to tell you how
different they are so the user going to
sign up with an email address I'm
assuming your side has users so if it
doesn't then this doesn't actually apply
but other ways of course but this
scenario is you have users you just have
emails if this is legitimate activity
you're gonna see the emails be very
different right they may all be at you
know company domain com and that's fine
but that first part matters right if
it's you know John Smith at company calm
and Irene Sanders at company calm and
you know multiple different names the
distance function the score on that
function is going to be high these these
emails don't they're not there's nothing
in common with them right but now the
other scenario is we have Joe Smith +1
at gmail com Joe Smith plus 2 at gmail
com Joe Smith plus 3 at gmail com the
distance function the score on that is
very low and so now you have this other
metric you can use to kind of score
activity and decide whether or not it's
a mechanical in nature I'm super simple
trick works really really well also if
they come from hotmail com you just did
I am because they're probably fraud joke
all hotmail is bad but the majority that
I see a spam accounts created a link
back to hotmail accounts but it's
usually some big long nonsense gibberish
at hotmail com you know undecidable
generated like almost like a uuid but i
actually do when i see email from
hotmail i actually are flagged
automatically not that they're
automatically bad cuz i don't want to i
don't want to suggest that it's that
they tend to have a higher risk
associated with them because more
fraudulent 70 associated with hotmail so
which is something to consider right its
data and this is all about data this
really is and i'll get to that in a
minute right we have these patterns and
we have these this data and we have but
we can't fit it to an equation so what's
the next step here we have a formula we
haven't quite fitted yet we can't we
can't we can't apply any meaningful
thing what do we do with it what's
what's our next logical step
so it's time for quantitative analysis
right we have data we have a pattern one
of the things here is you you could use
this to try to use statistics to try to
fit a pattern but I really can't call it
quantitative analysis because that's
time to get me 100 million dollars in DC
so I'm going to call it security as a
data science problem what this really is
is that I'm going to turn around and
apply some machine learning and basic
try to classify data I'm starting to
develop all these routines for
collecting points of interest or
information if I can't decide whether
that's good or bad by just looking at it
which is tough because a lot of traffic
maybe I can find a way to classify him
and tag it scoring is good scoring
hell's but like I maybe I want to cost
by the traffic right up front I'm using
some different mechanisms this is
interesting and we're talk about more
this more in a little bit but I want
update a model again now that we're you
know we're kind of interesting we're
changing some stuff right so there's a
problem that immediately exists when we
add a classification mechanism and
that's it that's low some of them are
fast but in general I things going to
run are slow and everything I've talked
about so far has been in line in the
request in the web server I can't put my
classifier here and expect it not to
impacts performance it is significant
way it's gonna have to go off to the
side I'm not sure where yet but Snuffy
law from the side so just a side note is
that we've taken a detour on throwing
everything a web server and making it
work but I do want to tell you that it a
lot of value from this so we're going to
throw that problem on the side for a
minute and come back to it because we
can combine the signature detection that
we did earlier and some of the points of
data and then start to kind of really
turn it and figure out whether or not
things are good or bad and over many web
servers because most of us have more
than one web server we want to have to
collect some state and maybe see all the
requests that a single actor made across
all of our environment and maybe make
some choices right it's about state we
have to keep track of all this that's
how we manage this across environments
and that's where the idea reputation
comes in its intelligence that we
provide based on how somebody's acted on
our site
and across all of our environment we
might have more than one app we simply
have more than one web server probably
more than one application as well we
read this across everything and put it
all back to one centrally stored state
and then that's how we divide throughout
his reputation and really it's like
who's bad and who's really bad we're
trying to figure out our naughty list
it's it's what's one who are the list of
people who are currently just
misbehaving and it's built up from the
tools and techniques and models i've
been talking about all along but it
provides one solution it's a local
reputation right it's only reputation
based on how they've acted against you
but this is not a new idea this has
actually been around for quite a while
there are companies who have honey pots
all over the internet and they actually
sell feed so you actually purchased
these external rotation feeds and you
can merge them together so let's say you
flag somebody and then you file also
find them in that external feed list is
being malicious so it's really easy to
say oh yeah they're definitely bad right
they match they hit here I had some
suspicions they match on this list to
let's just block them so this is
important and they're actually pretty
cheap some of our free I think the
company alienvault has a free one they
publish and it gives you a really good
idea of kind of what's happening in the
rest of the world it's kind of a
temperature and this cup this
combination gives you this really solid
awareness of kind of who's who's doing
what who to keep an eye on and but we've
actually calls it a bigger problem so
now we have this whole idea of
rotational intelligence or our state's
we also have these external feeds and
we're starting to build this thing these
are all detached from our web server so
now we're building themselves into this
kind of weird little corner where things
don't quite match we don't know what to
do but i don't wanna solve that problem
quite yet because i want to introduce
one more problem before we solve it and
that's how we act when we decide
somebody's bad we want to know what to
do with them there's a lot of things you
can do we have almost new information
actually it's not new at all we actually
had it all along which never looked at
it it's new to us right we're looking at
it now we're trying to figure out what
to do now I want to know what to do with
the information once we have it once we
decided yes this person is bad I want to
act on them there are many things you
can do
it's not always obvious which one is
right here are a few examples we can
block the traffic that's the obvious one
we can honey pot of the traffic this is
interesting and I'll talk about in a
minute we can modify our response back
to them maybe we change our controls
when we change what we respond with to
them because we're not sure whether
they're good or bad yet we're trying to
figure it out maybe you talk back I'm
not gonna talk about that one there's
some gray area there and if it's really
bad maybe you just contact the
authorities maybe you need to actually
like call in somebody to help you out
and maybe it's really bad it's affecting
your business it's a big deal be careful
of that one that one actually has a lot
of implications realize when you make a
crush to the authorities they're going
to ask you lots of questions back and
prepared to spend a lot of time
answering questions and not always in
questions you hope they would ask right
so it's very much opening of the kimono
they're going to give them a lot of
information gonna be very taxing so
reserve that last one for when you
actually need it sometimes it's
necessary but be prepared for what
happens when the time comes so blocking
the traffic super straightforward in
most cases when you're talking about the
web server you're returning a fourthly
response you're saying no I'm sorry that
request is forbidden you can't have it
the other obvious thing is going to
block in the firewall level this is
trickier because some of you have
upstream providers how many of you have
like an Akha meijer Prolexic or
cloudflare some kind of option provided
it's a CDN termination an ssl etc well
they're doing this after sending you
down not the actual request gonna
terminate the request and make a new
request back based on the information
that was given to them now that request
is coming from an IP of the upstream
provider not from the other one then you
get this thing called x-forwarded-for
the headers comes in there and you and
you have to kind of determine now your
fire will have to do is extra packet
inspection and pulling out that header
and blocking the traffic and it gets
kind of weird so there's advantage and
disadvantages to both of them right have
to be careful on how you work and it's
really about your infrastructure and how
you operate your business that's where
you decide where to block and maybe both
but honey pots are actually way more
interesting than this there's a really
cool story here you can take care
environments and you modify it so in
this case we set boxes engine imagine
that's this whole
thing I've just talked to you about this
whole reputation an action model it's
gonna sit in front of your kind of
frontline load balancer and it's going
to decide whether travers good or bad
and if it's good you get rattled off to
the normal place right your standard
site they interact if it's bad they get
routed to the fake sites what the fakes
that is just another instance of your
site with all the production then
replicated over but the back end is
connected no charging money no shipping
goods no actual action but what you're
doing is allowing them to just keep
doing what they're doing now you can
study them right when you honey pot an
attacker the goal is they don't know
they've been caught so they're just
gonna keep doing what they're doing and
they exhibit all the behavior that they
would have had they successfully
attacked your site or if they were
trying to attack what they would have
done to attack and what it does is
allowed you study their behavior it
allows you to figure out what they're
trying to do and when you see that then
maybe you start updating your approach
right maybe they actually get in but
it's a fake site and you're it's fine
you update your approach and how you
prevent attacks or maybe you're just
your understanding of what people are
really after because you can it will
help you because you see the signal oyes
level is super awesome that put in that
case like you see all the signal because
it's a raw attack but then the day we
can't get away from this whole
out-of-band state management weird
little problem that we've come into is
we have this nice little solution in the
web environment and then it detaches and
now everything it's really weird right
there to figure out where did we do the
acting at where do we hold the state if
do we if we wait to the application
environment before we act that we have
we waited too long there's lots of
questions to answer here and this is
kind of where I was at well I started us
all these problems I saw this pattern
this pattern kept coming up over and
over again of how do we do this other
weird out of band stuff and that's what
brings me to rep see this is why I made
it and it's essentially reputation
engine that's all it is it changes the
model a little bit what happens is it's
a module for the web server it's also a
back in environments and a user Edison
femoral cash basically it doesn't matter
of storage what it does is a few things
it's right it reads and writes back from
Redis but what
record activity every time requests come
in and record certain pieces about that
activity timestamp user agent method you
query string simple stuff what it also
does is managed that state for you and
that state can be available to all your
web servers so you know how does have
this nice globally managed state that
all your web servers can access you also
have something that will act what rap
sheet really is at the very very core
the very basic primal functionality is
it looks up in Redis to find out whether
or not you flag somebody and if it does
it will either block them or notify it's
a really simple model and finally you
have that book out of band processing
it's that back end that will churn run
the models and it will update Redis and
when it figures out that somebody's been
bad so it's out of band updating wanted
to see the aggregate data across to
everything and also will integrate the
external feeds so the other piece here
is visualization really what I built
this for was to understand what was
going on I want to know what's happening
I've built a very small visualization
tool I suck at you I so it's just a
little Twitter bootstrap thing but it's
super helpful lets me know what's been
blacklisted and the top 10 offenders all
right the people who are currently
suspects that haven't blacklisted yet
automatically or manually right you see
the buttons that automatically let you
do it what you see is a bunch of
information it might be hard to be on
this screen but all these here in this
case our mod security rules that that
person has triggered they've tripped all
of those modsecurity rules and they've
done it twenty 3567 times they're
probably not good right this one's a
really obvious case of an offender
somebody in this case right they were
just running a scanner against our site
backing out and that's marker I mean no
one of those those tools free tools and
just scan sites the other thing is
humans are really good at patterns and
recognizing patterns so i added a
visualization of the world and pins on a
map let's say here's where your threats
are coming from the interesting part is
this was 20 this is 24 hours average 24
hours of braintree there's a lot of pins
we're a big target we move money you
know our latest numbers are about 12
billion dollars in transactions a year
it's a lot of money flowing through us
you want to steal it seeing this is
interesting seeing all this noise
doesn't
how much so you know it gets better as
time goes on and you start to identify
and block legitimate traffic but it has
helped to spot botnets in the making we
saw about that pop up in France that
started with small and got bigger and
bigger it was isolated to France though
we sought more and more every day would
grow and grow and grow and grow and we
saw it hit critical mass and then but we
saw the details the whole time we knew
what the user agent was it was a very
simple botnet but what it actually
turned on the fire hose we knew was a
deal it was really simple we just we
call up our upstream Vidant said hey
this user agent just block it it was
over in five minutes so what would have
been a pretty catastrophic denial
service attack which would have probably
hit us i didn't i didn't hit it they
tried to hit about 10 gigs which is not
huge but still a pretty significant
amount of data it would have been
disruptive would have taken a while to
figure it out we already knew was coming
we already had the alerts on so once it
happened it was like it was a five
minute deal it was over so it helped
those patterns are really really useful
so what rubber sheet really does is put
everything together you know like i said
the web server model records activity
and it looks for fighters in the cache
the overhead of this is anywhere between
5 and 10 milliseconds or less depending
on how local reticence really that's the
key so it doesn't really impact
performance to eyeball time right 10
milliseconds is still a long time but to
http which is slow in general and humans
which are perceiving that data its
nominal it listens to mod security right
so what it does is it listens to the
information of autistic security sending
down in the headers and picks it up and
records it so if somebody trips that
it's going to say you hate modsecurity i
figured that i found out you alerted me
here the rules i triggered it will keep
count and then it provides that idea
where you will you can block a notify so
it's going to help you build that case
in this particular example blocking
happens to the web server level right
the ref sheet module will block inside
the web server and that's the 403
instead of the actual firewall but since
thats database is open you've actually
been a small script there are plenty of
tools like IP set that help you update
IP tables on the fly you can read a
little script it just looks in Redis at
the people you blacklisted and paste
your firewall to block them really easy
couple line script the difference is
notification versus blocking so
notification sends the headers
downstream it actually adds additional
header X rap sheet and says this person
is on the ref sheet so the application
that's downstream can say I'm gonna
change my behavior I'm they've been
flagged as bad I'm gonna act differently
which gives you the power to choose how
you're going to respond for instance
show CAPTCHA right this is simple but
CAPTCHAs suck we all hate them they're
terrible and when you're a legitimate
user it's pain this is that whole cross
section of usability and security right
so I say turn it off until you know that
they're acting bad then turn it back on
again make it better make a better
experience of people who legitimate and
turn it on for the people who are bad
the back and looked at the recorded data
for bad behavior and that's just to make
a case and when it figures out something
legitimate it updates the cash and then
you benefit from that the good part is
this is a plug-in play model it's a
sorting hat without a brain you give it
the brain you hookin up the splunk
logstash and other things and produce
that data it's a project with bunch of
repositories the visualizer the module
everything's kind of buys in its own
place for logical reasons github.com /
rap sheet is the organization so summary
is simple there are lots of indicators
of attack they're everywhere and the
data isn't that you have to fabricate
it's in every request it's better how
you look at it you want to build up a
system that can capture the data and
sort the good from the bad understanding
what's going on is like critical
importance so being able to protect
yourself from attacks the tools we
covered our modsecurity gip generically
the custom rules the way your business
works behavior classification and find
the rap sheet the one thing to remember
though is that bass lines are important
and they're getting attacked every day
at some points your bar and the other
bar are going to be honest with each
other right if your bar is too low the
scripts it's you I they're going to get
you so this is step two step one is do
all the things you're going to hear
about in the next talk look at the ls
top 10 defend your code make sure it's
solid make sure your defense in your
codes just as good as your defense in
the perimeter
and I think I'm just about out of time
so I'm gonna do questions we'll have to
you uh all right one quick question so
interesting question here is why lie
about which browser is being used this
is interesting and there have been a lot
of reasons a lot of things that come up
around this for instance there were some
travels there was a travel site at one
point who if you came from a Macintosh
computer the rates you got were higher
than the rates or a windows computer
don't know why but it was it was it was
category sure you could change your user
agent and you had lower prices so that's
one reason to lie right some sites say
well I only I only work with these
browsers so go okay fine I'm this
browser stop blocking me let me go
through right another reason right so
the actually the legitimate reasons why
you would change your user agent most
the time when the user ID is lying it's
bad but remember that it's not always
bad so there's kind of some gray area
there time for one more what's the
bridge between modsecurity and rap sheet
the bridge is very simple modsecurity
has an option to the enable headers so
what it does when it sees attack come
through is it adds headers to the
request that says here are the things I
found here the rules that trigger all
rep she does look at those headers
because they're in the environment in
Apache or in the web server module and
pulls them out partials them really
quickly and then put some in the inside
the application so if you have mall
security turned on rap sheet benefit
from that by just parsing the data from
on security in the headers that's all it
is it's very simple otherwise I had a
question we're out of time thank you
very much
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>