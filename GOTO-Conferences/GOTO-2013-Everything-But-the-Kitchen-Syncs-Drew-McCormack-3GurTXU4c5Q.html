<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>GOTO 2013 • Everything - But the Kitchen - Syncs • Drew McCormack | Coder Coacher - Coaching Coders</title><meta content="GOTO 2013 • Everything - But the Kitchen - Syncs • Drew McCormack - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/GOTO-Conferences/">GOTO Conferences</a></li><li class="active">⤵</li></ol></div></div><h2 class="post__title"><b>GOTO 2013 • Everything - But the Kitchen - Syncs • Drew McCormack</b></h2><h5 class="post__date">2015-10-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/3GurTXU4c5Q" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">okay can everyone hear me so yeah okay
so who knows who this is two people in
the audience know who this is and quite
a few people not everyone this is not an
iOS developers conference this is a this
is craig federighi and great fielder
Ricky is an important person at Apple
these days he said executive top
executive at Apple he's actually that
the soft the senior vice president of
software engineering basically he's in
charge of all software for the mac for
iOS and
so I think everyone here probably
already knew that already almost most
people but maybe what you didn't know is
that Craig is actually a really good
engineer and he's actually been doing it
for a long time and he was actually
before he was at Apple he's actually at
next with steve jobs at next and he
worked on a framework called the
enterprise objects framework which is
it's basically an o RN and its really
the predecessor of I guess core data
which is what if you use iOS these days
you know what core data is and he
actually developed in 1995 he develops a
class the chordate of people correlated
developers know really well and that's
the ns-managed object context so he
actually came up with the idea for this
thing to actually develop as well so
that was an important it's an important
distinct point class in core data and
it's actually quite makes it quite
different from other o our ends I guess
you could say about 20 years later now
so you could that in 1995 20 years later
we've got a different problems right
we've got the we got complicating
situation that is now we have the clout
we have got multiple devices multiple
stores and we've got to figure out ways
of keeping basically two or more managed
object context in sync right across a
very shaky network without basically
without any direct communication lines
and this is a difficult problem and this
is a basically what I want to talk about
today
so what is my interest in sync I develop
an app called a mental case it's an app
for students basically it's a flashcard
study out and I started developing this
app in 2006 I think yeah and was for the
mac right so it's a mac app 2006 it
started off as a hobby slowly grew into
business and then the iphone came along
and the later the ipad and i developed
an iOS app in about 2008-2009 and it was
clear from the start that these two
should sync up right it would be pretty
crazy if you had the mac up you made
some study cards on the mac and it
didn't sync up to your iOS device so
right from the beginning I had sync but
I was kind of an old-fashioned type sink
that you had with itunes and ipod swear
you know itunes would basically get
anything new from the ipod and then
replaced the stuff on the ipod and that
that was how i did it not fear USB but
fear Wi-Fi connection so it was a direct
type of sync where the two the two
devices were talking directly to one
another and send exchanging information
so i've had this all along right this is
this sink and after a few years about
two or three years ago I started to see
more and more feedback one more reviews
along these lines you know what why is
there no cloud sync in this app you know
why we asked it why don't we got this is
Wi-Fi sync you know why do I have to
connect to the same Wi-Fi network that's
ridiculous in this day and age and the
perennial know what year is this right
so so in other words customers started
to demand cloud sync people expected
cloud sync and that's been the case for
the last few years and so I started to
think about it and at the time there was
a sort of an elephant in the room in
terms of sync for core data and that was
apple's solution right Apple had just
announced iCloud
and I cloud came with a core data
syncing component basically the idea was
with very few lines of code your core
data app could sync up across devices it
was it sounded great right I thought I
spend a couple of months on this I'll
have a beautifully sinking cloud app and
and everything will be solved and of
course I spent about six months on it
and I never got to the point where I was
satisfied that i could ship ship ship
the product and during that time
actually blogged quite extensively about
it there's about five or six blog posts
about how core data I cloud sync
actually works because Apple has written
very little documentation about it so
there's if you if you are interested in
core data set I cloud called out of sync
these blog posts are still pretty useful
even though the a few years old now they
do detail going quite a lot of detail
about how it's working under the covers
and what you should change in your code
and things like that but as I said even
with all that that effort I never got to
the point where I thought this I can
ship this thing to the public and so I
did eventually solve the problem and
I'll talk a bit that a bit later at
least for the time being and so first I
want to talk about sink in general I
want to go back a little bit and say
okay where are we with with
synchronization and a lot of people
would like to think I think that we're
in in the what's what's known as the
ubiquitous error right where your data
is everywhere on every device it all
syncs up beautifully and so some devices
that's that's absolutely true some songs
on apps that's true things that you
female for example works very well
Twitter anything that google makes tends
to work really well in terms of
synchronization but for a lot of apps
it's not true at all and if you take a
general app any app in the App Store and
you can you look and see whether it
seems I think there's a good chance that
it doesn't unless it's a web app or
something
and frankly I think we're in the pre
ubiquitous air at the moment we're just
in that bit before everything is
ubiquitous and we haven't quite got
there yet and just stop worrying about
it will require to worry a lot about it
to begin with right this is a great
quote from jen arnold but I stole from
the cultured code with our blog and it
describes a lot of things in engineering
but I think it's really describes sync
at the moment right for a lot of us it's
a headache it's something that keeps us
awake at night and as certainly may be
the last couple of years of my life are
pretty horrible and I'm not the only one
there are some pretty big names that
have been struggling with sync
synchronization cloud synchronization
cultured code is quite well-known name
they make an app called things it's a
to-do list they have blogged about it
and and and they made they were at least
two years over over schedule with that
cloud seeking had promised it for years
and years and it was just a difficult
problem and everything they try just
didn't quite work the way they expected
and eventually they did come up with a
solution but it was it was a long time
coming barebones has an app called
Yojimbo and they also have just released
CEO Jim before but that was again more
than a year over schedule and the reason
they tried to use iCloud Core Data Sync
and they didn't get it working saving
the same as the piss me and black pixel
development these days they still
haven't shipped cod version of net use
wire with a sync option which I've been
promising for a long time so it may also
we're trying to use core data like that
so a lot of people having trouble a lot
of people having trouble with this this
problem
so let's have a look to see if a nap and
you in it's a core data app and for iOS
and you want to have this thing sync up
what are your options as of today well
you can write a complete web app right
you can write basically a server a smart
server let's call that call it a smart
server which you know it holds all the
data in the cloud and that your clients
talk to the sort of technologies you can
use their you know just any server side
technology PHP Java rails Django nodejs
Google App Engine take your pick there's
a lot of technologies there you can use
now this is a perfectly legitimate
solution plenty of companies go this
route there are plenty of pros as well
the very good thing in terms of sinkers
and it's a cent you've got a central
truth okay so so if it's very unlikely
that your client apps will get out of
sync they can always just say okay
server tell me what the latest data is
and it means that you're very unlikely
to ever get really far out of sync you
can always it's stabilizing so that
central truth is important it's
cross-platform if you're running an
Android app and you're writing an iOS
app and also a web web app then you can
even this is a perfect way to solve that
problem right and there's no lock in you
can take your rails app off of Amazon
and put it on rackspace if you're not
happy with amazon right so there's no no
real locking you're not you know forced
to stay with a particular company or
provider there are a few cons and this
is more for I guess smaller smaller
companies it can be reasonably expensive
depends on your app of course but you
have to host everyone's data right and
if you've got if your app happens to be
an app that used quite a bit of data
you're going to be hosting a lot of that
every every every single user is going
to have the data in your in your account
and there's also some duplicated effort
there's a good chance you'll be an iOS
developer if you're an iOS developer
there's a good chance you're not that
good at rails or you know a web
developer as well they're not that many
people that can do
really well so you'll get probably going
to need to be in a small team at least
you can't probably can't do that on your
own okay so you don't want to you don't
want to go that route you don't want to
go the route of a complete web app well
there's these days you've got something
that's sort of in between this is what I
call a restful store or a structured
store and sort of services i'm talking
about past calm asia winter microsoft's
solution for mobile services dropbox
have just released a new api called the
datastore API and that is basically this
a restful store just a structured store
of data there are a few smaller ones
wasabi sink is a core data only solution
simpy reham from the people that make
simple note that's a chordate also as a
core data aspect and Helios is from
Heroku that allows you to use heroku as
your mobile backend so these are all
solutions that sort of simplify you know
that server component it just just
basically puts a store in the in the
cloud and you can just write things to
the store so it's not particularly
intelligent survey it's kind of just a
simple server
and there are pros and cons of this
right so you've still got your central
truth that's that's that's useful the
server is really simple so anyone can do
it you don't have to be an expert web
developer and it should scale as well
and you know you have got this
duplicated effort of having to be a ruby
on rails developer as well as an iOS
developer still kind of expensive you
have to store all that data you still
have to store that data you've if you've
got a bit of a vendor lock-in here
because it's very difficult to move from
one to another if you've committed to as
you they've got a different API to up to
another company like Dropbox so you'd
have to rewrite your code quite a bit to
move between them so you sort of stuck
with who you choose and some of them
don't have core data integration right
so you'd have to bridge with core data
now the one I want to concentrate on is
actually neither of these it's it's this
one here file syncing services okay
these we're all familiar with file
syncing services i think the type of
service i'm talking about here is iCloud
Dropbox is one from omni grid put
omnipresence Google Drive Amazon Cloud
Drive everyone's got one of these right
Microsoft cloud SkyDrive and even hit
torrent do it these days right
BitTorrent allow you to sync up a folder
anything you put in the folder will go
through the BitTorrent network to your
other devices so these things are
everywhere everyone's got one of these
you know it's I think we all know how
they work you put stuff in one folder
and it ends up crossing crossing through
the server to the other folder on the
other device it's very simple basically
you're sending data back and forth and
so it's actually the most simple sort of
server you can think of
so the pros these are different pros I
guess to the others pro-one pro for a
developer like me as just a small
company is that these things are
effectively for me free right the the
user or the developer consumer might end
up paying Dropbox for the service or or
Apple but I don't have to process any
any fees or anything to provide syncing
all right so that's that for me is an
impediment bank I don't have to host
anyone's data it's hosted by Apple or
Dropbox or Microsoft or whoever's
providing the service there's no real
locking because these things just sync
up folders of that of files so so it'd
be pretty easy to move from from Dropbox
to iCloud or or whatever and there's no
server side code or this the server is
just shifting around rounder data now
there were some cons of course as well
there is no central truth anymore right
so no there's nowhere you can't talk to
any server and say okay tell me at this
point in time what the the current files
are right you can't do that you can look
locally and say okay I've got these
files but I don't know locally I didn't
know what's happening on other devices
right so if I might have a compliant
incomplete picture of all the data and
that means it's a big risk of divergence
if you go this way you have to be very
careful how you process the data
otherwise you'll get small changes on
each device and though the verge and
that's that's bad when you're sinking
right and there's no well established
framework in terms of seeking to core
data for doing this there are few
options i'll talk about those but i
would say none of them really well
established and solve the problem well
now what I want to do is I want to say
these file syncing services I want you
to stop thinking in the most file
syncing services and think of them as
peer-to-peer networks and actually
peer-to-peer communications devices
right communications networks and that's
the way we're going to think about it
from here on in think about it as its
fine wanting to send Mac
a message and sends a message to the mac
in the form of a file that it puts in
its file and the Mac wants to send
something back it sends five what's a
filing as a message so I think of it in
that way it's probably the best way to
think of it from here on its a
peer-to-peer network ok so we want to
use these file syncing services to sync
up core data right by coordinator uses a
database right it's basically a sequel
like database underneath and this is a
tricky problem actually to sync up
databases fear files or fear kids pin at
work the first thing you're probably
thinking is I just put the database into
dropbox right problem solved right
unfortunately this is a square peg round
hole slit situation you can't actually
really do that and get away with it for
very long you're very likely to get some
sort of data corruption but you know a
database will right over your database
while you're using the app or you're
going to just simply lose data but
there's no merging of the data the
database will come in and replace any
changes you've just made so this is
really a bad way to approach the
situation you can't just take your
database and put it into dropbox or into
iCloud what you have to do and all the
solutions that I've seen basically
handle it this way is to split your
database into that transaction logs or
the deltas that make up that database so
imagine this this cup here is a database
it's made up of matches in this case and
each match represents a little operation
on the database that builds up the cup
so in an update for an insertion or
deletion right just like on a standard
database what we do is we take the
database and we split it into these
matches we split it we decompose it into
all the changes that went into building
the database all the deltas or
transactions that did that and so what
are these these matches that I'm talking
about just to give you a more concrete
idea
what they are here's some some JSON that
represents maybe could represent sup one
of these these changes in a movie app so
we're writing in an app for movies the
entity here is called movie it's got a
global ID so we can recognize it on all
the devices that's the same object it's
going to type in this case it's an
insertion there could also be an update
or a deletion of course and then we've
got a bunch of properties the name of
the movie in this case twister the cast
would probably be a relationship to a
bunch of actors so we've got some actor
IDs there right so this is the I this is
the idea of of these deltas what we do
is we send these deltas we put them in a
file or multiple files they go across to
the other device and then we rebuild our
database with these deltas all right so
we replay them and build up a clone of
the database on the other machine okay
so this is how how you do it how do you
could do it with that with with files
syncing your databases with files now as
I said there are actually a couple of
solutions to all this already and I've
mentioned one of them already that is
Apple solution iCloud Core Data Sync it
does exactly what I just described right
it's breaking things into transactions
sending them across and then rebuilding
the database
but as I also mentioned there's some
problems with iCloud core data and
plenty of people have been having
trouble with it it was for the first two
years at least very buggy which is a
real problem when you're talking about
data it's not it's not a glitch in their
user interface which you can sort of
work around this is people's data and
when when they lose data people get
angry right so it's something you really
it's it's not something you want to have
bugs in something that deals with data
so it was buggy and that was it that was
a big problem but there are other
problems and some of them are really
unavoidable ah it's a black box right
its proprietary proprietary software
it's Apple software you can't see what
they're doing they don't tell you what
they're doing they don't tell you how it
works how it's supposed to work what to
expect but I tell you any of that right
so you're guessing all the time as to
whether the page is correct or what
happens when there's a conflict it's not
not documented right whatever Z
validation fails not documented does it
call into your code at any point not
documented right none of this was
documented I figured at some of the bear
out on my blog if you can find on my
blog but it's not documented by Apple
they just say you know it works and
unfortunately it's not not usually good
enough the package the black box makes
it very difficult to test you can't
basically testing involves two devices
and then waiting for things to transfer
and this makes your debug cycles very
long right you make a change on one
device you wait for a few minutes like
that transfers to another device and
then you see what happens and and then
you try to reproduce that so your your
debug cycle is minutes long if you're
lucky if you throw too much data at
iCloud it'll actually throttle back your
transfers and you can forget it for the
rest of the day you can go home so
you're not going to get any more syncing
done that day
it's a pretty horrible experience I've
never had such a horrible debug
experience now some of these things
yearly release schedules are so Apple if
Apple do find a bug and they do fix
these bugs of course they're stuck on a
yearly release schedule most of the time
they you know they put away for the next
OS upgrade they sometimes are allowed to
if you're a very important route fix in
an intimate intermediate release but
that's quite actually pretty hard I've
talked to people in apple and that's
actually not easy to do you have to
convince people that it's really that
important to put in a you know a
seven-point what or whatever so actually
usually you're waiting for a year if
there is a bug you're waiting for a year
to see that fixed and of course it's
lucky myth none of this is documented
it's not open source if you decide
you're not happy with iCloud the iCloud
solution you're gonna have to rewatch a
code completely because you can't use
any of it it only works with Apple's
iCloud back-end basically so if you
decide I want to use Dropbox too bad
there's one more problem with iCloud
core data and that's again something
that Apple can't really control that is
when a company like Apple or Google one
of these big companies they move into a
space like in this case of syncing up
core data databases they create a vacuum
right because no one is going to compete
with that no one's going to try to
compete with Apple doing a solution for
syncing core data right so when Apple
issue it when Apple came with a solution
they have to get it I don't have to get
it completely right if they don't do
that we've got a problem because there's
no one else is going to do an open
source project to solve the problem or
make a competing commercial offering or
anything like that so that's actually
the situation we've been in for about
two or three years but nobody has come
up with anything new
there is one other framework I just said
that we did we don't have anything new
that's still true there is one other
framework you can try and that is an
open source framework the reason that
we've got this framework is simply that
it was written before I cloud was
announced okay I'm sure if if I claire
had been announced before they started
they would have stopped immediately it's
called T icds it stands for Tim y usted
call data sync Tim's the guy that wrote
it it's an open source project MIT
license first developed by T missed it
is these days it's maintained by NOFA
software no first of the the guys that
right did this money well product
perhaps you might have heard off there
that the owner of the company is is
Kevin hotter and he's often on on
podcasts and things as well
this this has support from both iCloud
and Dropbox as backends and it is
actually out there shipping and ships in
my app this is what I eventually used to
ship my app mental case and also in
Kevin doctors appt money well so it is
actually in the wild but it's not all
roses here either the Creator team
instead is no longer involved he works
now for Apple he's not allowed to
contribute so that's a pretty serious
problem already right there the code was
as I said written before I cloud was
around it's probably four or five years
old some of the objective-c is old some
of the design decisions you know because
it was a sort of pioneering work some of
the decisions probably could have been
made better now but with hindsight the
benefit of hindsight but um so yeah the
design it has a few problems one of the
problems is for example that it uploads
a complete copy of your store for every
single device right so so if you've got
three devices sinking it's uploading
three complete copies of your store and
that could be quite a bit of data
depending on your app can be quite slow
uses core data internally which is okay
but it's not using it very efficiently
it's doing single object fetches and
things like that the worst thing is that
there's no there's no real guarantee
that your stores will stay in sync that
the algorithm use is not is not quite
sophisticated enough to guarantee make
the guarantee so in various in certain
circumstances it's possible that things
will get out of sync and that's not a
good thing
so that's where we're at the moment
we've got two solutions iCloud and T
icds and neither of them are
particularly inviting I would say so
whether we go from here well I I sort of
hoped for a while that someone else
would do a library like black pixel
black pixel complaining so I thought
maybe they'll do something and I've
waited quite a while and I decided
earlier in the year that I that no one
else was going to fix this problem so I
would have to go into the vacuum of
Apple Apple space and yeah contribute
something so I've got a little bit of
history with open source I founded this
open source project called plot which is
a potting framework for iOS and that's
still going quite well I'm not that
involved these days but it's still
actively developed so I want you today
introduce you to a new a new open source
project for solving this problem which I
call in ensembles and a short for core
data ensemble that's only for
coordinator it's a metonym MIT license
open source framework possibly later
i'll add commercial licenses with with
better with you increased functionality
and source code and things like extra
source code and things but for now just
open source and it will always be an
open source component the idea of course
is to sync coredata sequel lights doors
and should work on mac and iOS and the
most important concept in this framework
is the idea of a persistent store
ensemble if you know core data you've
heard of a persistent store and the idea
is to add one more concept to that it
matters a persistent store ensemble
which couples together assistant stores
and those persistence doors could be on
different devices but they could also be
on the same device isn't isn't it they
can be any stores right there's no
requirement that they be on different
devices or anything like that so it's a
coupling mechanism basically that's
that's a component but I'm trying to
write so I had a few design restrict
constraints i said on myself effectively
when i started doing this i started in
april it's just I've just been doing it
in my spare time so haven't been doing a
full time and I want to go through a few
of those design constraints first the
first was that it should be non-invasive
what I mean by that is you shouldn't
have to modify your model you shouldn't
have to subclass and it's managed to be
public context shouldn't have to
subclass in its managed object you
shouldn't have to change your object
your staff at all really right your core
data stack you should have to tear it
down and build it up and this is what
you have to do with the iCloud seeking
you have to make a it's quite invasive
you have to change a lot of things the
idea here was to make it as non invasive
as possible so I should just latch on to
your existing structure and and just
work hopefully
it should be back end agnostic it should
work with any sort of file transfer
mechanism file syncing Dropbox high
cloud if you want to make your own s3
back end because for maybe you're a
company you're not allowed to make you
better public just write your own s3
back in it's not a big deal it's a
couple hundred lines at most of code
omnipresence and you want from Omni
group webdav an older one but still
around right ftp any of these should
work I'm not saying I'm going to support
them all that box but anything that move
around file should work in fact it
should also work with just Wi-Fi seeking
a direct connection with Wi-Fi where you
exchange files just the same way itunes
might do that should also be possible
it's just another way of syncing up
files
and in fact I've already built-in
support for a local file system I know
that sounds pretty crazy right why would
you sink fear the local file system why
we just want to do that well that makes
it much much more testable right your
app and the framework I'm much much more
testable when you don't have this debug
cycle that is minutes long you can debug
in real time right you can sell two
copies your app on the one machine they
can seek fear the local file system and
you can be testing in real time right
this is a big this was a real sticking
point for me all that pain led me to
this and it is actually pretty pretty
important and I wish you could do it
with iCloud for example okay so say you
want to add one of these file systems
what do you have to do so you want to
add s3 back-end custom s3 back in well
it's basically just a question of
implementing a bunch of protocol budget
methods these methods look a lot like
the methods of in his file manager okay
the big distinction though is that
they're all asynchronous right because
we've usually got networking involved so
it's quite it's quite straightforward
you just implement it for whatever you
want to need to do file exist a path you
need to be able to answer that and you
answer by calling a completion block
contents of directory of path completion
it's create a good path so there's a
bunch of these you implement those and
you're back you practically done it's
about 200 lines I think 100 to 200 lines
for you know like Dropbox or iCloud I
think I did I cloud the other day it was
maybe now at work and it was probably on
here to hunt lions
the other thing is I said it was
testable it's also tested right I
developed the whole thing with with unit
testing so I right from the not actually
from the beginning I started without it
I realized this is going to get real bad
and less less that unit testing and so
since then I've uh I've been unit
testing the whole way and that's how
I've been developing each component
basically unit testing as I go so the
moment is there's better enough thousand
lines of unit tests I want to mention ah
how you go about merging because merging
is actually pretty tricky in a
decentralized peer-to-peer situation
like this see so let's let's treat the
first let's trust reit the centralized
case okay so you've got you've got a
central server somewhere right and you
can lock that server so one client talks
to the server each time so you go
central truth right this is the case
most people are dealing with so what
happens then you've got so you've got a
device one and a device to and they're
doing saves and each block here is all
the changes in one save okay so you can
see device one's done three save
operations device to has done two and
time is going so we're going to make a
new save on each device and these are
going to be concurrent but happen
basically the same time right these are
two new saves concurrent changes and
imagine now that both of these find
their way through the network and
they're both now and device one and
device one now has to look at these new
changes and decide what to do with them
what is a conflict for example what is
in conflict what has changed
and it will think it's okay what do I
need to consider I need to consider what
I've done since the last merge and what
the other systems done since the last
bridge in other words just a new stuff I
just need to look at the new blocks and
I need to see which ones are in conflict
and fix them in the term deterministic
way right this is a standard procedure
this is the way that for example t ICDs
works it works great as long as you've
got a centralized locking server right
let's take the decentralized case now
things are a bit more tricky we've got
different states on different devices
right so now device one is on the left
here and the right one has got all the
data and device to is missing a block
missing that third block from device one
right it's maybe still in transit it's
on the server it's still coming over
hasn't arrived yet and they both do the
same say they did before right device
one does it's a device to does it save
concurrently same time devices to device
tues block finds its way to device one
now device one is ready too sick to do a
merge okay device one looks at what it's
got now what is it going to have to
include in this merge which blocks right
it looks like it's the same situation we
had before it looks like it looks like
the same situation but is it the same
situation I can't just take those new
two blocks and say we're going to merge
those two well no it has to actually
take those blocks those three blocks and
the reason is that this second block
this block from device to has never been
compared with the block from the third
block from device 1 right sciatic you
have to include some old data in in the
in the comparison so this is to do this
when you something called a vector clock
you have to basically snapshot the whole
system every time you do a save so the
later on you can you can rebuild that
state and figure out okay this one was
concurrent with this one you can figure
out what has to be included in the in
the merge all right so it's actually a
step more difficult better standard
seeking server
I should say I got a lot of ideas for
this from this great blog post from from
Millen jumera from from clear here eat
what they write this great apple clear
to-do list app that's very popular and
they did a great blog post about how
they do syncing with clear and this gave
me a lot of ideas about these vector
clocks and a lot of pointers to wear to
learn more because I actually never
worked and that sort of stuff before so
yeah big thanks for for that and that's
a great blog post if you're interested
in in how to do these decentralized
concurrency basically okay how do you
use what you know won't wear some source
code how do you use this how difficult
is it to use this framework well here's
a bit of source code to show a to show
how you set it up basically there are
two things you'll need to set up your
leave that files just like what i call
cloud file system in this case I'm using
iCloud so I just set up an iCloud file
system object I pass the ubiquity
container identifier which is just
standard I clowder identifier I didn't
make it ensemble and for that ensemble i
give this file system i also need to
pass in the managed object model and the
path of the sequel lights tour map and
there's also a global identify their
globally unique identifier for this
ensemble I set the delegate
now which that's all the setup you need
basically now the quick now that now
that the ensemble can be in a couple of
different states but when it when you
first make it and you haven't done
anything it's in and what I call a deal
each state right so it's not leached to
the other stores so you have this so you
can ask the ensemble are you leech if
you're not leached okay start the
bleaching process and you have to do
this once right the first time that you
start sinking and this will set up a
bunch of local files do some stuff on
the server if there's a server or
whatever mostly the initialization of
the hole and later on once you already
are leached all you have to do to do a
merge just called merge with completion
right and that will do that look at the
new staff murdered together and update
your database that's effectively the
synchronization method the only other
thing you might want to consider are
these two methods here these are these
are delegate methods whenever you have a
background save of a managed object
context with core data you have to merge
those those results so you have to call
this to make sure that your managed
object context knows about those new
changes so yeah you want you'll
definitely want to do this one right and
this one's optional this one allows you
to provide global identifies four
objects and effectively that means that
the framework an automatically import
your your library without you doing
anything as long as it's got its global
IDs
that's it that's all the code there's 20
lines of code and you've got sinking out
right let's talk about something done
it's that easy really so at the current
status got about six thousand lines of
our pretense framework code three half
thousand lines of unit tests so it's
about 10,000 ones I guess all together I
only got the first full sync done about
a week ago so it's pretty new right i
was really pushing to hit this deadline
but i had lots of components but they
weren't quite working together but but
it's it's done at least the first stage
is done is sinking at least so where's
the code well actually gave a talk
similar to this about a month ago and at
that time i just had to say well this is
vapor where you stay tuned but today I
actually do have it's actually important
day but because i actually do have a
code now and so what I'd like to do is
if I have network I would like to try to
push this to get her so what does it get
a push origin master
Master
to any car you got ok so it's done well
I'll hitch pretty much so there it is
target it now you guys lock you are kids
now for the old fashioned in the
audience is a URL so if you're
interested that should be where it is
now unless I actually push it somewhere
it's not a different so yeah my username
critical back at github in some balls
yeah so that's that's actually all I've
got to talk about this might take home
it's still quite early days really for
decentralized database thinking is it's
a difficult problem there are a few
solutions already out there iCloud from
apple and T icds but neither really
satisfactory in my opinion TR ce d s is
probably the best option you've got at
the moment and I'm hoping that the
chordate ensembles will be the next step
basically learning I learned a lot of
things from T icds I learn a lot of
things from Apple solution and I've
tried to get the best things from both
and and fix things that I thought went
right and hopefully that's the next step
coredata on something so check that out
if you're interested and some
attribution sets all so thanks a lot
what about security issues with sinking
services government looking over your
shoulder are only suitable for
non-sensitive that someone from the NSA
is here right now that's a good question
and as I said this whole thing is a
back-end agnostic right so you can write
a secure server as you like in fact it
would be very easy I was just thinking
about this exact point this morning it'd
be very easy to make it used to decorate
a design pattern if it's like you guys
should all know that one to take say I
clouds file system and and simply wrap
it in an encryption system that takes
the file encrypts it before putting in
an iPad but that should be literally 50
lines of code it depends on your
encryption system maybe but he's calling
out to a library or something it should
be very easy to do that so you can add
any encryption you like to the dot it
doesn't care it as long as it comes back
into the library when it reads it back
in and it comes back in an encrypted of
course right you it's still going to be
core data so yeah so I don't see you
really any problem if you want to
encrypt this decimal point really if you
want to do a custom back in your wedding
your own server you want your own
encryption whatever it should be really
easy to do with with this self and you
can't do that without that right it's
just not that's another problem with I
that you don't have that option so that
was a first question
could we switch up the very cold air
conditioning okay alternatives just
called out a sequel light yeah well of
course yeah I've got a coordinator app
so i wanted to write i wanted something
for core data and i think is it there is
an advantage to using coordinator and
that is even if you don't like
everything about core data you think
it's a bit slow or whatever there's an
advantage to all two people working on
the same thing right i can write a
sinking framework for core data and you
can use the sinking favorite for core
data whereas for other solutions if
you're going to make your own stuff your
own model layer on a single life for
example which a lot of people do i think
makes their own version of core data
then you're gonna have to write the
sinking yourself as well right so
there's an advantage to being together
on you know having a standard in this
case on iOS I think Cordain is a good
room static example solution so yeah of
course you could take all the things
that I've put into this framework and
and apply them to a sinking frameworks
equal light and there is actually there
is actually one there is actually a
sequel like a company that does sequel
light sinking like anyone know that the
name no the darts I heard about them a
few months ago and that they look like
they're good but they're there one
company right so you have to trust that
that company but yet so the same the
same techniques that I used are
basically general database techniques
and you could apply it same things to a
sequel light sinking framework if you
want to do that
what algorithms and data structures are
are you using for sinking i use core
data internally that's because i know it
and i figure people that come to it will
also know it right if people that when
i'm looking for code probably no core
data because they're using Core Data
right so internally i use core data in
terms of algorithms i mentioned that
briefly the main problem with the
algorithms is just figuring out this
problem of causality right things would
happen concurrently you know what's
first when two things happen almost the
same time you can take your time to
dampen do you trust the timestamp so I
don't I don't trust the time step that's
the dancer that I use a vector clock to
ensure that things on every device
happening exactly the same order right
that's important and I don't trust time
stamps but timestamps used for sorting
certain things but they're not um
they're not the main sorting mechanism I
use a different system for that which is
taken from distributed systems computer
science so it's called a better blocker
basically but yes it's quite interesting
area of computer science and I've never
heard up to be honest with you figuring
out what time first is it she's a true
pieces
how does your head is like we handle
change made offline perfectly fine
there's no server here right it's it
just it will save changes locally and
then it will try to contact your cloud
syncing service and if your class
thinking service is not contactable
it'll just have an error and next time
it'll try again Matt so just take
basically paste local either the changes
and then when it does get a connection
he will load them up so yeah there's no
problem with offline that's that's
that's it very important of course right
one more i think is there how does your
library handle changes made same
question exactly the same as a minute
ago yeah so yeah but that's it yeah so
any more questions um cocoapods yeah
yeah I thought you write code i might
get that question after this one it's
more easy talk yeah now I'm going to
definitely add that it just this is so
fresh it's it's own get than that's a
Betty yeah I should be too i assume it's
not that difficult right you just write
a spec something yeah i've used ipods a
bit as a user but never actually made a
pod so and for the encryption part we've
got a next talk right God should be busy
on the file system stuff right now yeah
we got time for a last question I think
or weaker than his head so remember to
vote and thank you thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>