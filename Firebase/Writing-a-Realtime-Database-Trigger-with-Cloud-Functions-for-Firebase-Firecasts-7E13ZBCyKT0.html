<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Writing a Realtime Database Trigger with Cloud Functions for Firebase - Firecasts | Coder Coacher - Coaching Coders</title><meta content="Writing a Realtime Database Trigger with Cloud Functions for Firebase - Firecasts - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Firebase/">Firebase</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Writing a Realtime Database Trigger with Cloud Functions for Firebase - Firecasts</b></h2><h5 class="post__date">2017-04-18</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/7E13ZBCyKT0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey thanks for joining me for the spire
cast my name is Jen person and today I'm
going to use cloud functions for
firebase to help make my app more
family-friendly by automatically
moderating the content that people add
to it if you're just starting with cloud
functions you should watch this other
video first to get set up then come back
here to follow along so I have this app
that lets people post messages to a
discussion group and to make it more
suitable for families I need to make
sure messages are okay by removing an
appropriate content I don't want to
duplicate all the same logic in my
android iOS and web apps I rather have
it all in one place and I'd like to be
able to update it without having to
publish new apps to all my users I can
solve this problem with cloud functions
for firebase by writing a function in
JavaScript that triggers whenever a new
post is added to my real-time database
that function will run in Google's cloud
and not inside the app itself what I
want to do in that function is look at
the contents of a new post make changes
if necessary and write the updated posts
back into the database the way my app
works is like this uses firebase real
time database to push an object
containing the details of a post under
slash posts so what I can do is
configure my function to respond to the
data written at that location here's
what that looks like I'll go to the
functions folder for my project which I
already created with the firebase
command line and I'll start VF code here
to edit the index.js file I'll define
and export a new function called
sanitized post then specify the event I
want to trigger on this one is a
database trigger and it's looking at the
path slash posts it's also using
wildcard in curly braces to match the
push ID of the post in that path I'm
interested in write events so I'm going
to use the on write method which
receives an event object that describes
what changed to fill in the body of this
function we need to understand the event
that gets delivered here an event object
has a bunch of properties but there are
two in particular that are the most
interesting the params property contains
an object with key value pairs of all
the wildcards from this path in this
case Prahran
we'll have an entry for the push ID that
was generated by the client f ck the
events data property contains an object
with a description of everything that
changed when the write happened there's
a lot of things in it so only talk about
the most important ones the type of this
object is a delta snapshot and it's
similar to a regular database snapshot
you're already been using to read data
out of your real time database it has a
property called key which is the name of
the location where the write happened in
this case it's the push ID
there are also properties called rest
and admin ref these are database
reference objects just like the ones you
already know there are methods you can
call them the delta snapshot as well you
have a few for navigating and iterating
the data at the location of the change
but the one you'll use the most is
called Val this returns all the data
inside the Delta snapshot as a
JavaScript object for example if I call
Val on the Delta snapshot for my
function that sanitizes new post it will
look something like this express those
JSON so I need to write some code to
reach into those title and body strings
to make sure they're safe for families
so I'll write that now inside my
function the first thing I'll do is use
fennel to get that JavaScript object
with the post data then I'll call a
function called sanitized but take a
string and returns a modified string
overwriting the previous value in the
object and finally I'll write the post
back to the location where it came from
also paste in a sanitized function here
that changes the word stupid to the word
wonderful of course this should be more
sophisticated when doing this for real
but you get the idea and that's the main
logic of the function pretty easy right
but we're not done yet there are two
very important parts to this function
that are missing first of all we don't
want this function to return before the
write back to the database is complete
it turns out that the set method is
asynchronous meaning it returns right
away while the write happens in the
background however it returns an object
called a promise which is used to track
the completion of that write cloud
functions can use this promise to wait
until the work is complete without this
promise there is a risk that the write
may not fully complete and you lose your
data you can use it like this all I need
to do here is return this promise for my
function and we can be sure
that it'll wait for the right to
complete in the sample code we provide
on github we usually just return the
promise directly like this learning how
to use promises effectively is a really
important part of programming with cloud
functions I'll say a lot more about this
in the next episode but for today it's
enough to know that returning the
promise from the set method is the right
thing to do there's still one other
subtle problem with this function
remember that it triggers any time of
post is written to the database and that
includes the update that happens right
here in the function so what do you
think will happen if I trigger it once
by writing a post in my app it'll run
make changes to the post and then write
it which then triggers the function
again which then writes the post to the
database again and so on that's right
it's an infinite loop and of course
that's very bad because you could
exhaust your functions quota or pay way
too much money so how do we prevent that
well there are several ways you can do
this but the critical task is making
sure that when the function triggers a
second time after the sanitized values
are written you have a way to determine
if the function should stop without
writing the data again for my function
that means I need a way to determine if
the text is already sanitized an easy
way to do this is with a flag that I'll
set when I write the post back to the
database what I'll do here is add a
boolean property into the records the
post then the next time the function
triggers I'll check to see if that's set
and simply quit before writing again
while I'm here also log some stuff to
see in the console later console dot log
works just like it does if you were
writing JavaScript for a web app in a
browser now I think this function is
ready to go
I'll run firebase deploy at the command
line to send this code to the Google
cloud then I'll switch over to the
database console and manually add a post
I've already got one here ready to go
I'm going to click the Add button and
pay close attention here because the
data is going to get updated quickly
when the function triggers in response
suite now I'll switch to the functions
console and choose to view the logs for
my function and you can see here the
stuff it logged you'll probably want to
log a fair amount as you're learning and
experimenting with clouds functions so
now I have a simple function that
sanitizes posts as I get updated in the
database your functions could get a lot
more complicated so be sure to read the
commentation to learn all about the
things that you can do with the database
trigger and also take a look at the
sample code on github as well the links
are in the description below
and be sure to subscribe right here the
firebase channel on youtube to get
notified of new fire cats about cloud
functions and other firebase features
I'll see you next time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>