<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>BigQuery for Analytics (Firebase Dev Summit 2017) | Coder Coacher - Coaching Coders</title><meta content="BigQuery for Analytics (Firebase Dev Summit 2017) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Firebase/">Firebase</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>BigQuery for Analytics (Firebase Dev Summit 2017)</b></h2><h5 class="post__date">2017-10-31</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/pxNrkjBeHpw" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hi everybody so uh I understand that I'm
the last talk in between you and the
beer which is not really a good position
to be in so I'm just gonna get right
into the talk so that we can get through
it so we can all get into drinking our
beer so I'm actually not going to spend
a lot of time this afternoon talking
about Google Analytics for firebase I'm
assuming that if you are in this talk
and at this conference you kind of have
a general understanding of how analytics
works like you know you're recording
these events and these user properties
on your device and then these get sent
down into the analytic server which kind
of uses up all that data to generate all
of the lovely reports that you see on
the firebase dashboard and you may need
to update this because we now have a new
dashboard and while these reports are
great and they answer a lot of
interesting questions at some point
you're going to run up against the
limits of the reports that we're able to
generate for you and you're gonna need
to basically run some ad hoc queries
against this historical data to get very
specific questions that are very
specific to your app and that's where
bigquery comes in bigquery as as you may
know is a service designed to run very
fast queries over very large amounts of
data like for example all that analytics
data that your app is generating so the
idea is that when all this data gets
sent to Google Analytics for firebase a
copy of it is also sent to bigquery and
analytics will still go ahead use up
that data to generate all the reports
that you see in the dashboard but all
that raw data sticks around in bigquery
for you to query as much as you want and
so whenever a developer has a question
about hey how can I get at this obscure
little report in analytics our answer is
usually oak just go into bigquery and
and you know you can answer it there the
problem is that you know you have to use
sequel to do it and I'm guessing you
know probably a lot of you I certainly
am like mobile developer or web
developer and maybe you haven't used a
whole lot of sequel since like 2008 and
I know back back when I did it I like
added one join and thought it was a big
you know sequel hacker and put that on
my LinkedIn profile and so like I hadn't
touched sequel in many years and you
know when it came to sort of figuring
out
how to analyze all the firebase
analytics data it was a little tough at
first so I'm going to show you a few
things that I learned when I first tried
to analyze my data in bigquery that that
made this a whole lot easier and we're
going to start with the data structure
because it's probably not what you are
expecting if you've played around with
any of the public data that we have
available for bigquery like for instance
here's sort of some sample data from the
World Health Organization all of our
sample data generally kind of looks like
this sort of these nice little tables
that you might see in any old my sequel
database or something with like sort of
strings and integers and these
individual columns all nicely lined up
in these rows like this but it turns out
that bigquery can actually be much more
sophisticated than that like what these
rows in bigquery don't necessarily have
to be single rows of like you know
nicely organized tabular data they're
sort of more like this sort of
individual JSON trees each of which can
contain key value pairs or arrays or
objects or like arrays of objects and
that's important to understand when
you're looking at analytics events in
bigquery because the first thing you're
going to assume and certainly the first
thing I assumed is that every row in
bigquery corresponds to one analytics
event and it turns out that's not the
case you can actually have two or three
different analytics events all in the
same row in bigquery when you're trying
to analyze that data sort of all bundle
together for the same user so to better
explain this let me show you what our
actual data schema looks like so this is
basically one row of analytics data in
bigquery so you know just memorize this
and you're all set
actually yeah so yes it's a little
complicated at first but let's get to
know it a little better because it's
probably not quite as bad as you think
so first we have this user info section
and this contains a few straightforward
key value pairs like sort of the first
time the user opened the app and a an
optional user ID parameter but then this
also contains a number of nested objects
like the device info or their geographic
location or the traffic source
information what you know what brought
them to your app in the first place and
so on we also store user properties and
as you probably know since you can store
many user properties for the same user
in firebase analytics or Google
for firebase these are basically stored
as an array of objects now these objects
contain the name of user property stored
in this key and then the value now the
value itself is an object that contains
a couple of properties that honestly I
almost never use and then another
smaller value object and this value
object contains an int value float value
double value and string value entry and
you'll find that in practice most of
these will be no except for the value
that you're actually looking to store
and the reason we sort of have this
structure is that for multiple user
properties or you know as you'll see
soon event properties we can basically
store any type of data in basically the
same format right and we don't have to
kind of change the way this data is
stored and then basically the nice thing
about keeping all of this inside an
array and user properties is that you'll
find that in practice there's there's
not a lot of joins you have to do like I
don't need to like grab some other data
from some other table to grab user
properties for a specific user and join
that up with an event it's all sort of
nicely contained in bigquery for me and
you'll see that in the demo in a little
bit so then in addition to all this user
information we have some event
information and as I mentioned earlier
events can be an array of like three or
four different events all bundled
together and these contain a few
straightforward key value pairs like the
name of the event and a timestamp but
then they can also contain an array of
event parameters because you can store
multiple event parameters for any
particular event and similar to user
properties these parameters are objects
that contain the name of the event
parameter as well as a value which is
you know in value float value double
value and so on and so this holds true
for every event parameter for that
specific event
and then this whole structure holds true
for every event within the event array
and so that's what you get here and so
you know that's our basically our entire
data structure so I know it kind of
looks like a lot but once you kind of
get to know it it's not so bad it's it's
just big
so with that under our belt I want to
take a look at our bingo blast game this
is a game that's that's really out there
in the App Store maybe you've seen us
use it in demos in the past like this
morning and this because it's an actual
you know it's an actual
app that's out there we have some nice
data that we can query in bigquery and
it has this round completed event this
is an event that happens at the end of
every round and this event contains a
number of parameters associated with it
including the overall score what type of
game it was was it solo or social and
and so on along with sort of another of
a number of other events or event
properties and then we also store a
number of different user properties
including is the user signed in have
they spent money in the game in the past
and what's there but how many experience
points they have that's that thing we
have labeled as XP which is a good
indicator of how long your user has been
using this app so with this in mind
there are a number of questions that I
want to get answered that I can't
necessarily get answered from the
firebase console and so let's take a
look at how we can use bigquery to maybe
answer some of these I'm going to start
with this first one which is what is the
average and the standard deviation of
our score in a typical bingo around
basically how can we get at some more
data about an event parameter so that
I'm gonna jump over to the demo I think
my laptops asleep so let me wake up my
laptop alright so we can switch over can
you all read that should I make it a
little bigger I'm seeing a couple thumbs
up all right if just shout out you know
too small if you can't read it so this
is basically what you would get if you
were to just sort of get any data from
an app events table this is the the
analytics data that you'll get from
bigquery so you'll see you know here we
have a couple of user properties sorry
some some stuff's associated with our
user here our user properties here you
can see you know it's essentially an
array we have all these different user
properties and we have the key and then
the value dot value dot string value and
int value and so on scroll over here we
can see some of this nested data
including like you know here's where the
user is located when they were using
this app you know what platform they
were on scroll over a little bit more
here we can see our events so it looks
like we know we have a session start in
a tutorial begin event sort of bundled
together in the same row in firebase
analytics so I'm interested in the round
completed events so let's start by
selecting just our event in
so I'm gonna run this query and you know
this is basically here's one row in our
table which basically just has in this
case it just happens to have one event
it's our around completed event and if I
look down here I can see oh look there's
that score parameter that I'm going to
be interested in analyzing so let's
start by just getting our round
completed events and so I'm going to do
is I'm going to say let's select event
dim from this thing where event dim dot
name equals round completed and we'll
run this query and I will get this very
clear error that says oh you can't
access field name on a value with type
array struct string names parade
instructor array whatever so what does
that mean good question let's go back to
the slides so the issue here is that
event dim is an array right it's an
array of like you know one two five
different events all bundle together and
while it might contain objects that have
a name property event dim itself doesn't
have a name property right it's just an
array so how do we get at this data well
we're gonna get to our first tip which
is using unnecessary data that we have
stored in an array so let's start with a
simpler example let's say I have a
starships table right and I want to
basically find every starship that has a
crew member named Zoe well
this statement does not work right I
cannot select starships where crew
equals Zoe because crew does not equal
Zoe crew equals an array and yes that
array might contain a string name Zoe
but crew equals Zoe does not work so
instead what I have to do is I'm going
to slay
let's select from starships cross join
unnecessary array and move them into
their own individual entries in a column
we're going to call crew member now as
we do that we're also going to duplicate
our original row in the database as many
times as needed to basically sort of you
know make sure we've sort of filled out
all of our crew members well once we've
done that and in practice we tend to
just replace that cross join with a
comma because it's a lot nicer looking
well now we can query this right now
it's very easy to say let's select from
this table where
crew member equals Zoe and sure enough
we can find all of our starships that
have a crew member named Zoe and so
that's basically what we're gonna do
with our event array so here we have
this event dim that might contain a few
events in it
I'm gonna say let's select from app
events unnecessary as
so that basically we have each event now
in its own row in its own column and
then once we do that we can basically
query the individual record now we can
say all right now let's look for the
round completed events and we'll just
get those and I find that it's a little
confusing sometimes to see sort of your
original event dim array right next to
the event you're actually interested in
in your results so you'll find in
practice people don't do select star
they might just say you know what let's
select event and so that will get you
just the event you need so let's take a
look at doing that in my in my demo so
we're gonna jump back to bigquery here
and so now I'm going to say alright so
we're going to select from this on nest
event dim as event and so now I'm going
to do is I'm going to select just the
event and I'm gonna say we're event dot
name equals round completed and so now
if I were to run this you can see that I
now have just the individual round
completed events each one in its own row
in this table which is which is great so
now to get at the score parameter well
gee kind of looks like our event params
are also being stored in an array so
it's very easy to get at that as well so
what I'm going to do is let's select our
event will gets just get our event name
and what I'll do is else on nest event
params as per am and so we'll select
that and print
and I forgot to add a comma so I run
this and now I can see I have my event
with every individual parameter in its
own row in the database or in the in my
results table and so once I've done that
it's very easy to get it just the ones
that have that have the score so I'm
going to say we're event name is round
completed and Bram key equals score and
I run this and now you can see I've got
my parameter and I've got my you know
pram value object that has string value
in value float value and double value
and well now getting the results
actually pretty easy I'm just going to
go up to the top here I'm gonna ask for
pram value dot int value escort run that
and now I have my event and my event
parameter nicely organized in its own
little table and you know now I can do
stuff with it right and so let's get our
average of this thing and we'll call
that average score right and we'll copy
that paste this whoops let's actually
spell average right and we'll get our
standard deviation as our standard
deviation score run this thing and sure
enough we get our score and our standard
deviation and yes apparently it is o
normal to have a standard deviation
that's greater than your average it just
happens I guess in games like bingo
where you can end up with a very wide
range of scores so there you go so let's
jump back to the slides and basically it
looks like we now have our first
question answered so we now know the the
average and standard deviation of a
score in a bingo around and in general
how to query specific event parameters
so let's look at this next one
how does our score correlate with a
player's experience level so what we're
doing is we're trying to find a
correlation between an event parameter
and a user property so let's jump back
into our demo and see how we can get
that one going
so let's just jump over to this is
basically the query we were at a little
while ago we've got our the name of our
event and we've got our value our score
value and so I need to grab user
properties as well and as you recall
user properties are also being stored as
an array and so just the same way we can
extract events and event parameters it's
very easy to unnecessary
select this and we'll select our user
prop and what this is going to do is
basically now for this round completed
event you can see I now have expanded it
out to have one row for every user
property right here's our API version
how many power-ups they have when they
first opened it and so on and so forth
and somewhere here like on row 11 here's
the here's the XP so again sort of the
same way we're able to you know filter
for our specific event parameter it's
very easy to then say and user prop key
equals XP and sure enough we're gonna
end up with a table we've got our name
our score and then just our user
property all nicely arranged in one
table and then you know extracting the
value of our user property is pretty
easy you might be wondering hey why is
this being stored as a string value and
the answer is that basically in the
analytics client API and the lay quietly
Barry basically all your user properties
are stored as strings but you know
turning this into an integer is pretty
easy let's just here we'll cast our user
prop dot value dot value dot string
value man I can't type today as in 64
and we'll call that XP and we'll run
this and here's our score in our XP all
nicely arranged in a table for us and
you know then I could probably kind of
you know muck with this select statement
to get the correlation between these two
by you know sort of doing this but I
actually don't want to do that because I
want to show you one other technique
that is very calm
in when you sort of get to more complex
bigquery queries let's jump back to the
slides and that is using sub queries to
make your life easier so you might have
noticed serve up till now we've had sort
of this giant bigquery table that's got
all this stuff and then we run a select
statement on it and then we end up with
sort of this nice results table and you
might be thinking hey that table kind of
looks like a sequel table to I wonder if
I could query that as well and so you
can't basically using sub queries and
the way this works is generally you're
going to make a select statement the way
you would any other it's just that
instead of specifying a specific table
you're going to use your results from
another query and that basically sort of
allows you to sort of yeah basically you
know do this as many times as you'd like
if you if you're used to other sequel
databases I think this is commonly done
as a view I've noticed in bigquery land
people seem to do sub queries a lot more
I'm not quite sure why maybe it's just
sort of what happened but it might also
be that I think in big query land
doing this is actually fairly efficient
and so I think that's why you see a lot
of developers who like doing this but it
also means if you check out any of our
documentation you might start to come
across queries like this and you're like
ah what is all this it's a giant mess
but actually if you start to notice that
its sub queries it's not really that bad
all you do is start by just looking at
sort of the innermost query and once you
just focus on this you realize oh this
actually isn't so bad I understand this
and I understand what results it's going
to give me and then once you understand
that and you know in most cases you can
actually just cut and paste this
innermost query and run it yourself
then it's easier to understand sort of
the next outermost query what this does
can you see those highlights you can
barely see those highlights I don't know
make them darker next time and then you
know once you understand how that next
outermost query goes well then you can
kind of understand the next most
outermost query and so on and so forth
so next time you come across a giant
statement like this you know don't freak
out realize that they're probably using
sub queries and that if you break it
into pieces it's actually pretty easy to
understand
so let's go back to my demo and I'll
kind of show you that so we're going to
do here
is I've got sort of my results table or
we've got scorn XP so it's very easy to
select the correlation between score and
XP from this thing we'll run this and if
everything goes well I find out that I
have a slightly positive score elation
between score and the players experience
which you kind of expect in a game like
bingo which is mostly luck but there's a
little bit of skill so let's go back to
the slides because they think we've
finished up task two let's see yes all
right we got a checkmark all right so
let's look at this next one which is can
we break out our score by our game type
this sounds kind of similar to the last
one but this is a little trickier
because what we want to do is break down
one event parameter by essentially
another event parameter and I'll kind of
show you why this is tricky when I go
back into the demo all right so let's
run this query here here I've got
basically sort of my round completed
event and I've unnecessaries
now type of game this is the event we're
interested in grouping our score by we
want to see you know there's two types
of games solo and social how does our
average score change if we break it up
by type of game and yeah oh somewhere
over here is score and the thing you've
probably noticed is that XP and score
are in two entirely different rows in
the database and you know unlike when we
sort of unnecessary ammeter and our user
property these are on different rows and
it's kind of hard to get him together I
think the way I did this at one point
was to add on the app instance ID and
the event time stamp which lets you
essentially figure out which event
parameters belong to the same event and
then group them and do all sorts of sub
queries on them but I don't do that
anymore because I actually found out
that there's a much easier way of
handling this so let's jump back to the
slides and I'll show you real quick
which is our select from a nest tip so
this is basically sort of a combination
of our first two tips so let's imagine
you we're selecting our event name from
our app events where we
uh nested our event dim right so the so
far this should probably look familiar
so let's look at this next line select
value from unnecessary amps what this
basically does is this creates sort of
you can think of it like a temporary
table we take our parameters in that
event and sort of expand them out and
then we say okay well let's just grab
where key equals score and so now we
just have one entry from our from our
parameters array and then we can do is
select the value of that and that will
be in a new object or a new column in
our database called score and that works
for basically every every row in our
table and the nice thing about doing
this is I can basically do this multiple
times for multiple event parameters so I
can run this whole line again select
value for minus event params where key
equals type of game and I can then take
just the type of game entry from
parameters and that will then become its
own entry in a new column so this is
nice because I can then do these
different event parameters side by side
I think it's also probably a bit more
performant because you know you don't
have the you know X times y times the
number of rows that you would get if you
do too many unnecessary of doing it if
you can so and yes this goes out to all
different types of games and then
there's a keynote error so we'll just
jump to the next slide all right so
let's go back to the demo and I'll show
you that in action so let's select our
event name and instead of unnecessary
mand I'm going to select value from I'm
nesting
where key equals score and when I run
this yr you give me an error what's up
oh because they need a comma there we go
by the way this little validator super
helpful if you turn this on it'll tell
you before you run the query what errors
it sees it's kind of nice also helpful
when you're doing live demos so what we
have here now is we have our event name
still and then we have this unnecessary
and our end value and our float value
and our double value and as we know all
these that are going to be null except
for the in value and so now I'm gonna do
the same thing let's copy and paste this
thing and we're gonna get not just score
but type of game and when I run this
you'll now see I have these two value
objects side-by-side right here's my end
value for the score and then here's the
string value for the type of game and
then you know let's just make sure we
get the relevant values so let's select
valued end value and that will be as
score and we'll get our value dot string
value and that will be as type of game
and I'll run this and if all has gone
well there we go we have our score and
type of game all next to each other and
one nice little table now there's some
social games and then you know basically
being able to break this down by what
game type is as simple as doing a
sub-query so let's we'll select our
average score and our max type of game
from this table and we will group by
type of game and I'll run this and it
falls gone well sure of it looks like
people that play our social game earn
like what like four thousand thirty four
hundred points on average more than
people who play our solo game and that's
information maybe we want to bring back
to our game designer but you know maybe
they like that maybe they want more
people to play the social game so with
that let's go back to the slides
so that basically answers our third
question of can we break out our score
by game type yes we can good thing I put
that up there alright let's look at the
next few questions so these next two are
basically making use of techniques we've
already learned
so I'm not going to show you you know
the demo but let's show you how we would
answer these in the slide first can I
filter results for a range of user
property values so basically what we
want to do is you know in the firebase
console you can filter results by a you
know specific user property value you
know language equals English what if you
wanted multiple user property values
language equals English German Dutch
what-have-you
so basically we can do that by this is
essentially the same query as before
here I'm selecting you know the score
the event name and it looks like I'm
grabbing the yeah here I'm looking at
the players experience points as well
right and so this this should look like
a fairly familiar query but now just in
my sub query all I have to do is say hey
you know what let's just look at these
results for when our XP is in between
1500 and you know 25 sorry 15,000 and
25,000 right and that's it that's all
you have to do once you sort of learn to
to deal with your looking at user
properties and events this way and you
know we end up with a result that I
think is right I actually don't know but
sounds right to me so that answers the
fourth question the fifth question can I
filter results by to different user
properties at once in other words if you
were to go to the firebase console you
could filter your results by like are
they a spender or not and you know do
they have a lot of power-ups and or not
but what if you wanted to filter by both
of those at once you know currently not
something you can do in the firebase
console but it is something you can do
in bigquery and basically we do this
just by sort of making liberal use of
the select from unnecessary can see I'm
selecting where you use like yeah the
highlight sorry if you can see the
highlight there I'm highlighting that
second line where I'm grabbing the score
parameter right the the in value from
from the score and then I'm also
grabbing you know are they a spender or
not and then you know how many power-ups
do they have both of which are being
stored as a user property and I end up
with results that look something like
this
I can see their score you know are they
a spender how many power-ups do they
have and then once I have that you know
it's fairly easy to do a sub query based
on this this case statement at the top
all this is really saying is since since
basically our number of powers is kind
of this
giant range I'm just saying hey let's
break it into two values you know few
power-ups if you don't have a lot and
many power-ups if you do have a lot and
then by grouping by you know are they a
spender and you know how many power-ups
do they have I'm able to get a result
that looks like this and I can then say
okay well it looks like being a spending
money in my app it doesn't necessarily
get you a better score but very clearly
that looks like having a lot of
power-ups does so that's good to know
and that basically answers our fifth
question all right so this sixth
question what's causing our users to
spend virtual currency so this is like a
super interesting one so let's take a
look at it so I'm going to jump into
this query and this here is my spend
virtual currency event and this is
something that as a game designer I'd be
super interested in because you know
this is probably where I'm making money
so or as a game designer that maybe
wants to make a profit this is something
I'd be interested in right like this is
where my users spending the virtual
currency maybe after some point they
want to buy more gems or what-have-you
in the game so I want to find out what
sort of leading up to this so let's take
a look here let's I'm going to start by
just selecting all our events and we'll
look at our event name and then I'm
gonna look at two other things first I'm
gonna look at app info app instance ID
and we'll call that as app instance so
app instance ID this gets assigned for
you automatically by analytics and it's
essentially a unique number assigned to
any instance of your app that is
happening on any specific device I have
sort of a good way of basically grouping
all your events together that you know
are happening for one user on their
device you know if I play bingo blast on
my iPhone all those events will have the
same app instance ID but none of you
will have that app instance ID because
you're all different people with
different devices so I'm gonna grab that
and I'm also going to grab the time
stamp
and then we will order by these so we'll
order I you know I'm just going to copy
and paste app instance and event
timestamp and when I run this what
you're gonna see is I basically kind of
have like a nice little journey of my
user as they've sort of worked their way
through the app so I can see for this
particular app instanceid this
particular user like they initialize the
API they logged in they spun the slots
they spent virtual currency and so on
and so forth until we get to sort of row
twelve it looks like and then on row
thirteen we have a different user right
the different app instance ID and so we
can see this user they open the app for
the first time they triggered a user
engagement call they initialize the API
and so on and so forth and kind of just
by browsing through all of these you
might be able to get sort of a nice
qualitative sense of how our users are
interacting with our app and that's kind
of neat right but you know we want data
so this isn't good enough we need to
find a way to kind of group these and
more importantly we kind of want to find
out sort of when I defined a way within
the same row of our table to kind of
look at any event say hey here's what's
going to happen next and so to do that
we basically need sort of a better way
of looking ahead in the table and for
that I'm gonna use one more technique
let's jump over to the slides here
called using the lead to peek ahead so
here's how this works imagine I have
this table where I've got name and age
right hopefully by now this should not
confuse you nice little table but I'm
gonna add this line lead name one over
order by age as next oldest what does
that mean this means let's pretend we
have a copy of this table okay and this
order by age means let's sort this table
by age and then this lead name one
basically says alright for every row in
the table let's find where it would be
in this imaginary table and let's peek
ahead one row and then we're gonna grab
the name value we're gonna grab you know
in this case summer and that will be
stored in our original table as next
oldest and we do that for every row in
our table and you'll notice here Rick's
next oldest is no
because he's the the oldest person in
our table but this essentially allows
you to peek ahead and your result set
and so let's show you how we would do
that in the demo all right so I'm going
to keep everything I have before but now
I'm going to lead event name one over
order by and we're gonna grab our app
instance ID
unfortunately I can't use the little as
I have to use the full thing and our
event time stamp micros and when I run
this what you're gonna see is now I have
essentially sort of the next event that
happened for this thing so initialized
API user logged in logged in slot spun
slot spun spend virtual currency and so
on and so forth and this works fine
right up until we get to row twelve
where it says ah the next thing that
happened after user engagement is first
open and that's because it's basically
just sort of looking at the next row in
this sorted table so the way we fixed
that is we say okay let's partition by
app instance ID which basically says
let's take that imaginary table and
break it up into lots of mini tables
based on their app instance ID but we'll
still order by the time stamp so I run
this you're gonna see I basically get
the exact same results as before but if
I jump over to row 12 you'll see the
next thing that happens after user
engagement is null because we've sort of
reached the end of that little mini
partition table and so now you know I'm
gonna say let's do this one more time
here I'm gonna move let's move Avent
name down here and I'm gonna call this
step zero zero because we're engineers
and we're zero-based and this will be s
one and let's do it one more time this
will be s two and we run this we're
gonna get nice little Triplets of events
that our user sort of went through in
our app and then to say well okay let's
just find the ones that end with them
spending virtual currency well gosh we
know how to do that that's a sub-query
so let's select you know s0 s1 and s2
from this whole thing
we're s2 equals spend virtual currency
someone run this and if all's gone well
sure enough we get just the Triplets of
events that end with in spending virtual
currency and then once i've done that
you know it's super easy to like group
them and order them and stuff so that's
um here we'll group by s0 s1 and s2 will
add an account as count and we will
order by count descending and when I run
this sure enough I can see the most
common triplet of events that ended with
our users are spending virtual currency
right and I can start to dig into this
more if I want it okay you know it looks
like a round completed event what
actually happened there you know they
win did they lose what's happening that
it's causing them to say yeah I think
I'll spend some virtual currency once
that round is over
right so yeah let's go back to the
slides here because I think we basically
answered that question and by the way
you can basically use essentially this
very same technique for the screen view
event that analytics has started adding
my sample date is a little too old but I
think you know a few months ago maybe
earlier than that we started adding this
screen view event that sort of
automatically records what screen your
user is on and so basically by sort of
running the same kind of thing you can
kind of get a sense of like how your
user is progressing throughout your app
and you can kind of get a sense of you
know what paths are they taking more
often than others and so that basically
answers our second last question
now I'm running very low on time so I'm
going to quickly breeze through this
last one which is what percentage of our
users who start their tutorial finish it
within four hours so this is basically a
closed funnel in right now in the
firebase console you have an open funnel
but I want a closed funnel of let's see
how many users who started the tutorial
and then finished it we encounter and
then you know just to be extra fancy
let's add a time limit on to that so
it's got to happen within four hours so
we're not going back to the demo all
right solo we'll start by just taking a
look at these two events that I want to
build a fun a lot of like our tutorial
begin and our tour
real complete and we have them here all
right not very exciting yet it'll get
better
now I'm going to use the same trick I
added before where I'm basically going
to add the app instance ID and the event
time you know get the timestamp and
we'll order by those and so now we kind
of have individual user journeys
focusing on just these two events and we
can start to see okay you know here's a
couple of users who started the tutorial
and then completed the tutorial now I'm
basically we're gonna add my own little
two special columns called funnel start
time and funnel end time so we'll see
the funnel start time event if they
began the tutorial in the funnel end
time if they didn't and I could count
these up and that would essentially get
me an open funnel right this would get
me how many you know start events I had
how many end events I had but for a
closed funnel we want to say how many
end events happened after the start
event and for that we need to peek ahead
in the database and oh my gosh how do we
peek ahead in the database oh that's
right I remember we're gonna bring back
lead so we're gonna select our funnel
start time and then we're going to lead
basically sort of one row ahead in their
database to say let's grab the end time
if that exists partition by app instance
ID order by event time and what we end
up with is our start time and if there
was an event time right after it get
those bundled together in the same row
in the database and then you know we
actually can't count these up right I
can basically just say all right you
know if they're not null will count them
up and that gives us the number of
basically funnel begin events and funnel
end events and this is basically how you
would calculate a closed funnel but
since we wanted to be extra fancy and
add in a little time restraint to it
what I'm going to do is I'm going to
just look instead of is you know the the
funnel end time not know did it is this
funnel end time less than four hours
after the funnel start time and if so
we'll count it up and it turns out in
this case the results were the same
because you know doesn't take four hours
to complete a tutorial but if I decrease
this to like one hour or two hours you
do start to see a different value and I
guess our last tip which I didn't have
time to put in a separate slide is you
can also do this across multiple tables
so right now I've been doing all this
against app events you know 2016 oh six
oh six but if I
replaced that with a little asterisk a
little wild card then I can add this
very special parameter table suffix
between and then I can basically specify
any two dates that I want and that would
give me the same result but now I'm
looking at it over the course of seven
days and with that I believe we have
answered our last question so if you've
been watching all this and you're like
wait I've been trying to take pictures
of all that code and you went too fast
and everything don't worry so we have a
short link and we have a QR code and I
promise I will not be rickrolling you
just take a take a picture of this I'll
wait for everyone to kind of oh yeah
trying shaking I don't want to block the
QR code that would be awkward all right
I think everyone's got it and if not
it's also going to be probably in the
live stream video and all that and so
with that I know I am at a time Q&amp;amp;A will
not be in the ask firebase lounge
because right after this we're having
the party so if you have questions find
me and buy me a drink or I guess drinks
are free give me a drink and as the
course of the night goes on my answers
will get worse and worse and with that
I'm gonna say thank you very much I'm
hearing puck back on stage</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>