<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Second Part (Common to Full and Para) - Georgia Tech - Advanced Operating Systems | Coder Coacher - Coaching Coders</title><meta content="Second Part (Common to Full and Para) - Georgia Tech - Advanced Operating Systems - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Udacity/">Udacity</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Second Part (Common to Full and Para) - Georgia Tech - Advanced Operating Systems</b></h2><h5 class="post__date">2015-02-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/MLq3tXiLsA8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">the second part of CPU virtualization
which is common to both full and para
virtualized environments is being able
to deliver events to the parent guest
operating system and these events are
events that are generated by a process
that belongs to the guest operating
system currently executing on the CPU
let's see what is happening to this
process when it is executing on the CPU
once this process has been scheduled on
the CPU during its normal program
execution everything should be happening
and Hardware speaks what does that mean
well the process is going to generate
virtual addresses that has to be
translated to Machine page addresses and
we talked at length about how the
hypervisor can ensure that the virtual
address translation to the Machine page
address can be done and hardware speeds
by clever tricks in the hypervisor
and/or the guest operating system in a
fully virtualized environment the
hypervisor is responsible for ensuring
that the virtual address gets translated
directly to the Machine address without
the intervention of the guest operating
system and in a para virtualized
environment once again with cooperation
between the guest and the hypervisor we
can ensure that the page table that is
used for translating virtual address to
physical address is something that have
been installed on behalf of the guest
operating system by the hypervisor so
that the translation can happen at
Hardware speeds and this is the most
crucial part of ensuring good
performance for the currently executing
process in a virtualized environment how
address translations are dealt with
that's why I kept harping on the fact
that virtual memory managing the virtual
memory is the thorny issue in
virtualized setting so we know that this
is in good hands we know how to handle
that let's look at other things that can
happen to the
process during the course of its
execution one thing that this process
may do is execute a system code for
instance it might want to open a file
and that's really a call into the guest
operating system that's something that
this process may do another thing that
can happen to this process is that it
can incur a page fault not all of the
virtual address space of the process is
going to be in the machine memory and
therefore if some virtual page cannot be
translated then it's going to result in
a page fault or the process may throw an
exception for instance it might do
something silly like divide by zero
which can result in an exception and
lastly do no fault of this process there
could be an external interrupt when this
process is executing so these are the
kind of discontinuities these are called
program discontinuities that is
affecting the normal execution of this
process and the first three things that
I mentioned is called page fault and
exceptions are due to this process in
some shape or form but the fourth one
the external interrupt is something that
is happening asynchronously and
unbeknownst to what this process
intended to do while running on the
processor and all of these
discontinuities have to be passed up by
the hypervisor to the guest operating
system so the common issue to both full
and para virtualized environment is that
all such program discontinuities for the
currently running process have to be
passed up to the parent guest operating
system by the hypervisor whether it is a
para virtualized or a fully virtualized
operating system
nothing special needs to be done in the
guest operating system for fielding
these events from the hypervisor because
all of these events are going to be
packaged as software interrupts by the
hypervisor and delivered to the guest
operating system any operating system
knows how to handle interrupts so all
that the hypervisor has to do is to
package these events as software
interrupts and pass it up to
guest operating-system there are some
quirks of the architecture that may get
in the way and the hypervisor may have
to deal with that
recall that syscalls and page faults and
exceptions
are all things that need to be handled
by the guest operating system so it
probably has entry points in it for
leading with all these kinds of program
discontinuities now some of the things
that the guest operating system may have
to do to deal with these program
discontinuities may require the guest
operating system to have privileged
access to the CPU that is certain
instructions of the processor can only
be executed in the kernel more the
privileged mode but recall that the
guest operating system itself is not
running in a privileged mode it is above
the red line which means it has no more
privileged than a normal user level
process this is a problem especially in
a fully virtualized environment because
the fully virtualized environment the
guest operating system has no knowledge
that it does not have the privileges so
when it tries to execute some
instruction that can be executed only in
privileged mode the expectation is that
it will trap get into the hypervisor and
the hypervisor will then do the work
that the fully virtualized guest
operating system was intending to do but
here is where the quirks of the
architecture come into play because
unfortunately some privileged
instructions failed silently in some
architectures when they are executed at
the user level and this is a problem for
the fully virtualized environment where
the binary is unchanged in the para
virtualized environment because we know
that the para virtualized guest is not
running on bare metal we know that it
does not have the same privilege as the
hypervisor and therefore we can
collaboratively make sure that anything
that the guest has to do in privileged
mode it can take the help of the
hypervisor to do it
but in the fully virtualized setting the
guest has no knowledge so the only
mechanism that'll save the day is if the
guest tries to execute a privileged
instruction it'll trap into the
hypervisor and the hypervisor can do the
necessary thing
however because some instructions when
executed in the user level even though
they have privileged instructions they
don't trap but fail silently and that
can be a problem
this happens in older versions of x86
architecture for privileged instructions
executed in user mode
therefore the hypervisor has to be
intimately aware of the quirks of the
hardware and ensure that there is work
around such quirks specifically in a
fully virtualized setting the hypervisor
has to look at the unchanged binary of
the operating system and look for places
where these quirks may surface and do
binary rewriting in order to catch those
instructions when and if they are
executed on the CPU having said that I
should mention that newer versions of
Intel's architecture and AMD
architecture for the x86 instructions
have included virtualization support so
that these kinds of problems don't occur
as a result of servicing the events that
are delivered by the hypervisor the
guest may have to do certain things
which may result in communication back
to the hypervisor in the case of a fully
virtualized environment communication
from the guest to the hypervisor is
always implicit via traps
for example as a result of page fault
servicing the guest may try to install a
new entry into the page table when it
tries to do that that's a trap that will
come into the hypervisor and the
hypervisor will take the appropriate
action in a para virtualized environment
the communication from the guest to the
hypervisor is explicit so there are
api's that the hypervisor supports for
the guest OS to communicate back to the
hypervisor what may be reasons for that
well
we talked about memory management done
by the guest operating system in a para
virtualized environment such as Zen
where the guest operating system may
have to tell the hypervisor here is a
page table entry please install it in
the page table for me so that is the
kind of communication that we have to
come back from the guest operating
system down to the hypervisor</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>