<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Lock Contention - Web Development | Coder Coacher - Coaching Coders</title><meta content="Lock Contention - Web Development - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Udacity/">Udacity</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Lock Contention - Web Development</b></h2><h5 class="post__date">2012-05-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/3obkA7w5qwE" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">anything else so locking oh yeah lock
contention is a big thing for us right
now so as I was saying with this
Cassandra stuff whenever you vote on a
link in a popular subreddit it has to
lock on that whole subreddits listing
and so an example of that biting us
recently we have we have these luck I
have these vote queue processors and all
they do is they get that queue item that
says that somebody's cast a vote so you
basically have a set of machines that
are reading from this right so all these
app servers are writing you know a vote
happen to the queue right and then you
got a bunch of machines that are reading
from the queue and what they do is they
sit there they pull that out and then
they say okay that means I have to
update these listings and they have to
record the vote in Postgres and
cassandra and and they go through all
this stuff and that involves a lot of
the locking in here right now and so we
had we had a lot of these queue
processors up for votes and we get a lot
of votes simultaneously so we need a lot
of them but we had too many it turned
out and they were all fighting each
other for those logs and just having the
number of those queue processors
actually sped up queue processing in
general you need enough queue process
actually handle depth of the queue but
if you have too many they spend too much
time fighting each other right and one
of the ways we're working on that is
we're getting rid of the locking in the
Cassandra stuff and we're trying to get
rid of locks as much as possible in
general locking is it's it's a common
theme you know in Python itself when we
first switch to Amazon we have this
weird issue or pythons multi-threading
you know I'm doing two running two
threads at once doing two running two
pieces so they're probably at the same
time is not state-of-the-art would be a
nice way of putting it and python was
spending so much time locking its data
structures so two threads could access
the same data structure at the same time
that it was actually slowing down
the the computers ability to read
traffic over the network which was
causing it to spend more time switching
between threads it created this weird
Network CPU thrashing issue where the
way we solve that at the time was we
just made Python single thread and we
only had a one request at the same time
all right I think you guys are probably
still doing it yeah yeah we we very
rarely use threaded processes the add
servers use threads but otherwise other
than that we just have lots of separate
processes you guys run lots of processes
on one machine yeah and then the OS then
can do the task switching for you and
the OSS you know Linux these days is
pretty good at it yeah and and they
spend a lot of their time waiting for
something in the backend so well this is
really great thank you so much for
coming
absolutely one thing I'd like to point
out is that everything we've talked
about here the main things memcache
zookeeper Cassandra padieu AMQP nginx
HF proxy this is all free software it's
pretty wild how far you can get without
paying for anything like the thing that
you have to pay for is are the computers
to run this stuff but all the software
and all the code behind all the software
is online and free also the vast
majority of Redis code is also open
source and online so if you want to look
at this stuff
what's that URL for that github.com
slash reddit yeah I'm gonna make a hole
right in the middle of our container if
you go into this code they switch to get
oh we switch to get at some point and my
name isn't on a lot of this code anymore
but if you go in there you will see a
lot of the code we've written in this
class we're like hashing and passwords
and and all of that stuff actually like
it exists in reddit somewhere it's
really common it's really common stuff
that's cool and then you can see I guess
all of a sudden is also reddit mailing
list where people discuss you know these
architecture changes that's nothing
thanks again you know good job it's been
watching you guys girl reddit has been
really cool you know there were some
dark days you guys have really done an
amazing job growing that side it's
really impressive well it wouldn't be
where it is without you so thank you so
all right guys thanks very much for
watching and we'll see you in the next
one</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>