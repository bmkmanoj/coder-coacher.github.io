<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Sending, Verifying, and Refreshing JWT Tokens in Node.js | Coder Coacher - Coaching Coders</title><meta content="Sending, Verifying, and Refreshing JWT Tokens in Node.js - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Sending, Verifying, and Refreshing JWT Tokens in Node.js</b></h2><h5 class="post__date">2017-10-18</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/sK9SjEjlz6U" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey guys we're gonna be creating another
forum today to create teams and we're
also done deal with some authentication
because you need to be a logged in user
to create a team so the first thing
we're gonna do is set up a new route and
set up the form and then we're gonna
protect it with authentication so first
thing first like I said we're gonna
create a new route here and I'm gonna
call it create team Jas
oops and I'm pretty much just gonna copy
the login so if you preferred how we did
it with the register you can use state
I'm just gonna use mob X cuz that was
pretty easy a little less boilerplate
code I felt so we're gonna set up
another form here and I'm just gonna
copy over the login and I'm gonna call
this guy great team oops create team
and for this we only have one field the
name of the team and we're also gonna
have Aires so we can keep this here
we'll come back to when we submit the
form and our on change is good so this
we don't know I guess we'll have a name
error and we'll keep this a we could
just show one air in this but it's
possible we have more fields we want to
add later in our application so it's
good to keep it like this for now why
not so this will be named and then our
errors list we're really just gonna
check for name air and I'm gonna get rid
of this field right here
we're gonna only have one which is a
name
and then we're going to keep the on
change and the value is going to be the
name placeholder it's gonna be named
fluid submit is good there was an air
with your submission we're showing that
air here we have a login mutation we
want to change this to a creatine
mutation so I'm gonna call this creatine
because that's our new component and
create Team mutation alright so we need
to actually write the code for this or
the graph QL code for this and then once
we do that we can call our on submit so
here is what our schema looks like on
the backend for creating a team you pass
in the name of our team and it returns a
boolean I really I want to return
something like this where I can return a
list of errors as well so I'm gonna copy
this paste it over here I don't really
care about these things and really I I
don't really need to return anything
when I'm creating a team so I'm gonna
call this team response I don't want to
say create a team response because we
might have other responses where we with
teams so create team response and so
just an okay and then if they get any
errors so then in our resolver over here
we need to change that turf like this so
here we're gonna say okay is true
otherwise we're console.log in air and
we're gonna say okay is false
and then our heirs and now we want to
call that format errors function passing
in error and for my heirs is not in here
but is in oops on our schema but our
user resolver so what I'm gonna do is I
think I'm just going to create a file
over here called format heirs and I'll
just move that guy over there
so change and I'll just export defaults
and this guy needs a lo - shell and por
lo - and that looks good so our user
over here now we're gonna import that
and we don't need either of these
libraries anymore
so import format errors from up a file
format Aires alright and we're gonna
copy this paste it in our team up here
alright so now our team mutation looks
pretty good and I don't see errors so
that looks nice as well so I'm gonna
come over here just go look host 8080
one slash graphical and we're gonna type
up our mutation so mutation we walk
around the name which is a string and
we're gonna create a team passing in her
name string and pass in our name object
and here we want to see okay and then
any errors that we get the path and the
message are helpful so copy that and
we're gonna put that down here
so instead of this stuff and let's tab
this over okay so now when we submit the
form here there's really only one
variable we're feeding in the name so
when I come up here I only care about
the name and so we're gonna feed the
name in here as a variable and then
response there's only gonna be two
things okay and errors and response that
data dot log in the name of ours is
called create team so that's what's
gonna be called right here so I'm gonna
call this creative team and then if this
was okay we can just push to the home
page that's fine if we create the team
later well you might want to go to a
different page but this is fine for now
and then else if we get any errors we're
just gonna loop through add the errors
then show the errors so this looks
pretty nice but there's one last thing
we're forgetting we only want to allow
people to fill out this form that are
logged in users okay we're not getting
here is I just want to make sure the
form resolves and then we'll fix that
error so let's make this a route - I
forgot about that so let's make this the
I guess we can call it create team
and create team
all right so now I can take a look at
our component we just made token and
refresh token I got rid of those I think
all right so we see our form here it
says login let's change that to create a
team all right no errors in our console
so when I had a team like team one if I
were to submit this right now what would
happen is it would work I believe let's
see yep it worked ok and the reason for
that is we I think we are logged in and
we actually hard-code the value on our
server so here we are saying the user ID
- 1 now we don't want to do that we want
to take the user by whoever is logged in
and by looking at their token right here
so now we want to pass the token to our
server every time we make a craft ql'
request and then our server can look at
that token and then do stuff with it
what it's gonna do is it's going to
decode it and it's actually gonna put it
in the context for our resolvers to use
so how do we pass this token to our
graphical server one way to do it is
actually to change our resolver so here
what I could do is say token which is a
string and pass it in here but this is
not the only thing that I want to make
you know have users logged in to do
right for example for my channels
creating a channel you need to be logged
in to do so I don't want to pass in the
token on every mutation that I need to
be logged in to because that's a lot of
ways so another way to do this is to
pass it as a
and then what do you do is you read that
header in your server and you pass it in
and that's actually what Apollo
recommends so what we can do is take
advantage of some middleware so before
every request what we're gonna do is
we're going to check local storage and
add a header so we're gonna copy this
and I'll show you how this works
so this is gonna be in our index page
not that one this one so where we set up
the client so our network interface
deals with making requests to the server
to our graph QL server or Lok host so
every time we were making a request what
we're gonna do is we're gonna apply
middleware and this is gonna run so we
hear rid of these comments so first
thing we're doing is just creating an
object for the headers if it's not there
then what we're gonna do is we're gonna
grab the token here from local storage
and then set that as a header now what I
like to do is call it request options
headers X - token and X is a prefixing
the tokens like this is just saying X -
is a kind of something people do to say
this is a custom header that I am adding
so it's kind of like a standard that
I've noticed so I do it as well so
refresh - token refresh token so we
don't need to do any of that so this
will send to our server every time we
make a mutation or a query for that
matter it's gonna grab it from local
storage put it in the header and this is
gonna be shipped off to our server so
now on the server side we want to read
these tokens in so what we're gonna do
is add some middleware here
and this is a middleware that I've been
using for a while now that I really like
I call it add user so we're gonna copy
this in here and I'll explain how this
guy works so here's our add user
function and all I'm gonna do is say app
use add user and what that will do is
now it will use this middleware and what
this middleware does is it looks at the
X token header which we sent along and
it just checks if there was a token
given to us if not that's okay we don't
do anything right they don't send us a
token we don't have to do anything we
don't decide any values and I'm just
going to import JWT so import a dirty
from JSON web token but if they do give
us a token we know they are possibly a
user so what we do is we first have a
try-catch block we verify their token
using the secret and we're knows we're
using the same secret that we use to
sign the token so if I come over here to
off you'll notice I'm using a secret guy
here and this secret guy here is used up
here when I'm creating the tokens we
pass it to this guy and he's signing the
token with that so it's that same secret
we verify and what's verifying is that
the token has not expired and it was
signed with the secret and if it is we
have a user so notice how we pass the ID
in here so now we know the ID of the
user so what we do is we say request dot
user is equal to user so then down here
in our context what we can do is notice
how app dot used here we don't have
access to our request object but graph
key will Express we can just add a
little guy right here
he can be a function so save that and
now instead of user here as a hard-coded
value we're going to say a request out
user so if we don't have a token this is
going to be undefined so our user is
going to be undefined so no resolve err
we know they are an undefined user and
we don't care about them
basically otherwise we're setting the
user based on this user token or this
user that we have in their token now you
notice there's a bunch of stuff right
here in the catch block this is if the
user at the tokens not valid it's
possible that they give us an expired
token and that's why we have a refresh
token so we read in the Refresh token
from our headers and then we refresh the
tokens or at least we attempt to refresh
the tokens so this is where we call
refresh tokens and I'm just gonna import
that in import refresh tokens from dot
slash off passing in our token our
refresh token our models are secret and
we're also going to pass in secret to
for this because we have a secret for
our regular token and secret for our
refresh token then what's gonna give us
is new tokens so notice you notice I'm
actually checking whether the tokens are
good because if they give us a bad
refresh token we don't actually give
them new tokens and then new tokens also
passes back a user so what we will do is
set the request user to that so we'll
see what's happening in this function in
a second but notice how I also have this
chunk right here I just created new
tokens so I need to tell my client that
I just created him new tokens so what I
do is I set a next Oken and X token
refresh token back as headers so when I
send the response back I send to the
client the new tokens where they can set
it in local storage so right now we're
not handling this but that's something
we will add in a
and I have to expose these headers right
here so they have access to them okay so
how am i refreshing tokens so this isn't
off and here's our Refresh tokens and I
want to grab a secret too
all right so we're just setting user ID
to negative one and then here we are
decoding the Refresh token so notice
here I'm not looking at the secret or
anything all I'm doing is trying to grab
the token I just want us to get the user
ID from the token and then I set that to
the ID if I get an EIR I just returned
this because they didn't give me a valid
token we're done so if you're not too
familiar with JWT tokens you can
actually see the payload or the value of
them without knowing the secret so we
don't even because if you know if you
remember how we signed the Refresh token
we actually signed it with the password
plus the secret so down here user that
password plus secret so to verify this
which you notice we do down here below
we actually need to pass in the password
and secret to so but we first have to
get the user to get their password to
verify it so we did a code it look at
the payload we have the user we make
sure that there is a good user ID if not
we return and we can just set this this
makes more sense let's set this to zero
right so if we don't get a good user
token here then we return nothing
all right so conce user is equal to so
here's where we actually fetch the user
where we're just saying the user ID here
you know so I just say raw that's just
so we don't get a sequel eyes object
back and if we don't get to use they
return nothing so now we know that we
have the user associated with this so
what we can do is we can verify the
refresh token and if it's valid it
hasn't expired - and here's where we
pass in the secret so we know the secret
is
user password plus secret - and we can
just say Const refresh secret is equal
to user duck password because we're
gonna use this twice all right and then
also when we create tokens we pass in
the Refresh secret so you guys have seen
what create tokens does and then we
create the new tokens and we just pass
them back so that's how refresh is
working so that's all well and good
so in our team if you remember we're
already grabbing the user and staying
the user IDs so we're good here nothing
we have to change there that's just how
we are actually grabbing the user now so
next what I want to do real quick is
handle this on the client-side so the
way we can do this is we are using
middle wire here which is run before we
make a request we're gonna use after
we're which is run after request so copy
this paste it in here so apply
middleware or apply after where what
does is we get a response object back
and we can actually look at the headers
and what we can do is we can say conch
token is equal to headers get reefer X
token and then here refresh token is
equal to X - refresh token and then we
need to check cuz we're not always
sending back these tokens right notice
how we're only doing this if we get an
error so we need to make sure that we
actually had token back then we say
local storage set item token is equal to
token
and same thing here
alright so we're now covered on
authentication here now we're not
checking whether the user can even
access this page yet and we're not
stopping the user from like basically if
I log out and I try to access this page
it'll work just fine so that's a problem
we'll fix in a second but first let's
come over to team and see now cuz I want
to show you guys we hard-coded the value
two so if I go to PC equal and I select
connect to slack and I select all from
teams ok actually maybe it was is the
owner was one so I don't know who I'm
logged in as right now but we should see
a different value than one to verify
this does work ok oh yeah this is called
creatine
so actually I'm gonna just log in make
sure this is legit and I forgot what my
user is so I'm just gonna create a new
new one email I'm gonna say Bob at Bob
15.com now I'm gonna use the same thing
for my password alright that work
correctly we'll go to login all right so
now our credentials are set in local
storage and this is create team now and
I'm going to create a team here it
should create it under the user Bob 15
so Bob Bob team hit submit
looks like it worked okay now when I
come over here and I select we have an
owner of the ID 16 so let's select all
from users where ID is equal to 16 and
see who the user is and sure enough the
user is Bob at Bob 15 so that's the user
we just created so just to show you guys
this is truly working we could create
another guy so register won't call this
guy that this will be Bob 16 and now we
can login with Bob 16 whoops
and now I come over to my crate team the
team created it good now we have owners
number 17 because we logged in with a
new user and we see Bob 16 so now we're
able to depending on who's logged in we
know who the user is and create a team
with the correct owner and so now we can
replicate this across all our mutations
whenever we're doing creating a channel
creating a message all that we know who
the user is easy so that's really nice
and that is where I'm gonna stop this
video but what's coming up next is if I
log out for example I come over here to
create team I do not currently have any
credentials but I kind of feel like I
can create a team maybe ok that's really
good it doesn't let me but notice we
don't get like an air that says hey you
can't create a team because you're not
authenticated please login because
that's what we'd like to do if you are
not logged in and we know this guy's not
logged in because he has no credentials
here so that's how we're gonna handle
what we're gonna handle the next video
thank you guys for watching and as
always the code is up on github
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>