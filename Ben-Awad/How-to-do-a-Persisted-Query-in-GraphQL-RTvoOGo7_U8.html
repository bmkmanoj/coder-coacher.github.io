<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>How to do a Persisted Query in GraphQL | Coder Coacher - Coaching Coders</title><meta content="How to do a Persisted Query in GraphQL - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>How to do a Persisted Query in GraphQL</b></h2><h5 class="post__date">2017-06-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/RTvoOGo7_U8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">what's up guys I'll be showing you a new
library called persist graph QL that
helps protect your graphical server now
it does this by white listing queries
and that way your client is the only one
that knows what queries are being sent
so you can't have a malicious attacker
for example do some really long message
query where they're doing this for
forever right I can just keep typing
suggestions and creator's additions and
Creator not only this it actually speeds
up the request because you're not
sitting as much data over so that's nice
so bonus it's doing two things speeding
up and protecting your graph you'll
server so how does it do this right what
we're going to be doing and I'll walk
you through this is we're an exploding
basically a command line tool and we're
going to go to our client code and we're
going to look at all the graph QL
queries mutations that we have and
create a big JSON file that basically is
a list of all the queries and then we
give that list to our servers or server
knows what queries we expect the client
to do so let's jump into it and do
exactly that so if you do not have a
graphical server that you can play with
the follow along and a client I'll
starter code in the description below
that you can use in download all right
so first thing we're going to do is
we're going to install this tool I
already have it installed on my computer
so I don't need to run it but I'm just
gonna it's going to finish super quick
now so I'm going to be starting with the
client side so my client side project
folder I'm in and it also I'm going to
need to install this guy in the code
itself is going to use it oops spelled
it wrong
it's persist and then once that's done
we're going to just going to run the
command line tool and grab our queries
but I've actually had a little trouble
with the command line tool it does not
work as nicely as you would think
so first thing
you give it to the directory that you
have all your files this crash is on me
right but that's fine they expect your
files to be in the doc rack QL format
and mine are have the extension I think
it's I think it's double they have it
here they have down here you can change
the extension so mine are in the
extension of gql so then if you run that
it then runs successfully but I want to
add a few more things to that on the
first is I want to add type names you
may or may not need that so I would add
it because I did need it you might not
but I would go ahead and try it first
but if it doesn't work you can remove
this but as this underscore underscore
type name to your queries all right oops
so run again with ADD type name and it's
giving us what what this outputs that
JSON file I was talking about so I have
two queries or I have one query one
mutation write these two but for
whatever reason if we open up I can
actually open up over here our extracted
underscore queries you'll notice it's
missing one we see the type name added
that's good and you don't for example
you don't see the type name here but you
see the type name here that's what the
you know adding that command line flag
does for you so we want that that's good
but you notice our mutation here create
user was not added I'm not sure why it
just for whatever reason not grabbing it
so if you guys know why it's happening I
would love to know why to get around
this I basically had to do a little bit
of manual labor we're going to go into
mutations and just come back over here
we're going to rename this real quick so
it doesn't conflict and then we're just
going to run it again so I'm just
running it on my mutations folder it
should recursively go through source and
grab everything you'll notice even says
looking at mutation plus whatever
doesn't grab it so now see it guys are
just fine here
so what I'm going to do is I'm going to
copy it over here come back here just
paste it in and I can go ahead and
delete this because I don't need it and
also my server can we're going to have
to use this on the server and my server
does not have like web pack to bundle
JSON and so I'm going to actually
convert this ball mat to a j/s file but
if your server can handle JSON you can
keep it as a JSON file okay so I'm going
to do export default and this is just an
object right and it pastes in this other
object and I'm just going to let this
format real quick and you want to make
sure these numbers are different because
that's important what this is right you
lose what I told you this is all your
queries all your mutations all your
graph QL things and then those are the
keys in this object and then the value
is just an increment number that goes
down and this is a map so what's going
to be sent to our server now is we're
actually going to send the number 1 to
our server and our server is going to
use this extracted query and it's going
to basically we're going to actually
invert it and we're going to no one
matches up to this query so the server
is going to receive a 1 it's going to
know this is what we need to run all
right so I'm going to put this right
inside of Lib because that's where we're
going to be using it and I'm also going
to rename it so it's using good
convention so uppercase Q so if you're
following along with me and you're using
the same project structure it's inside
kit Lib and then Apollo is the next
thing we're going to be doing stuff
inside of all right and I put extracted
queries in the same thing so we're going
to import persistent Network a lit I'm
not going to type this out they have it
they have this nice little article that
explains how to do it we're going to be
creating a interface instead of the
regular interface so we can just copy
these
now I'm going to also put the links to
all that inscription below so you can
follow along if you want to copy and
paste as well or if you would like to
just take use these as a reference as
well so we can actually get rid of that
and just put here new persistent query
networks all right cool and then I just
need to replace those so here I named it
differently so we have a query map we
need to pass our query map as a
parameter and we don't need create
interface anymore so just recap what we
just did we import persisted network
interface from the library that we just
added with yarn you could also follow I
do NPM install and then we just create a
new object of that passing in our query
map along with our URL which we already
had there and looks like we're having a
little bit of an error here file
extension oh just need to remove that
and that's cool our client is all set up
now we're going to set the server now
you can either use the article they both
show it or the readme for a reason the
readme does not show the how to do it on
the client side I'm not sure why but you
can see it's actually very basic on the
server - this is actually very fast to
set up so I already have low - on my
server so we're not through installing
that and we just need this file extract
and queries our map as you can see this
makes a ton of sense how this is working
we're just inverting this map so invert
and lo - we don't know that does we're
going to add middleware that's what this
is doing by the way we're going to add
some middleware to our server and what
we're going to do is every time they
were query is sent to us we're now need
to invert this number so inverting it's
going to take it and it's going to be
like this right it just looks this
object around so one would be the key
and the string would be the value if
we're an invert on this dictionary or
this object so
but we're going to get one from the
client and then we just map it to this
that's all our server needs to do all
right so I'm going to go to the command
line real quick I'm in my server code
and I'm just going to open visual studio
code up in there alright and now we can
go to our index file and just going to
import lo - I already have lodash
installed here and you know what you can
just go ahead and grab invert like they
do because we know that's the only thing
we're going to be using at least for now
and I just need to do from and I also
need to import query map from extracted
query we actually need that so we need
this extracted query is this file that I
had over here that we created so I
actually need to copy that over now it'd
be a good idea to actually make like a
you know a tool or something that
automatically adds it up to adds it to
your server so you don't have to come
over here and copy from your client this
extracted queries file that you just
created so something that auto copies is
over it'd be nice if you don't to keep
doing this every time you make a change
so we have this mount copied over here
we are importing it here and let's spell
it correctly and now we can add our
middleware
so our Millah where is going to run on
graph QL so app dot use because it only
makes sense to run it on the graph QL
route we're going to request now also
important to note I'm not going to do it
here but it's important to add a config
file for persistent queries because you
only want persistent queries really in
production because in development they
break stuff for example graphical will
not work we'll get a big-air and I'll
show you that
because graphical doesn't use business
in the numbers since the actual query
all right so if we come back sorry and
we can come back over here we can see at
the bottom the code that we're supposed
to write so we can just copy this and
we're actually not really going to use
this at all but this is kind of just
like a template of how we want to work
now you'll also notice they're running
invert every time on every query that's
slow it's better to make the inverted
inverted query map up here outside of
the actual middleware so you not to keep
running it so invert is only run once
that'll speed up your code just a little
bit alright and now we're going to do is
we're going to do an if statement we're
going to check if it has a body and if
it has a body we're going to check if it
has a body and an ID if it does we're
good to go and we can check we can
actually check our map for this ID so we
can get the query we can do inverted
query map passing in the request I'll
body that ID and then we need to
actually check if it's like the ID you
might be passed might not even be in the
map so we need to check that we're not
getting undefined back if we get
undefined back we want to throw an error
right and we also want to throw an error
if the body or ID are not still so throw
new air and we'll just say not allowed
so if they're doing something that does
not have an ID they're not allowed to
you know run that query but if this is
working here Const query and verdict
query map we just say request stop body
dot query just like they're doing here
we set equal to query that's it oh and
we also need to run next at the bottom
here so our middleware works request
thought next and here this
and we did everything correctly here it
should be working so I'm going to fire
up both the front-end server and the
back or sorry the front-end code the
react code and the backend code our
server so let's make sure everything
starts up okay I should have made sure
the client started up okay - looks like
server we got this big output that's
what we expect looks like this is up
okay Oh wrong way so now if I come to I
think it will host 8,000 you can see our
application and Mayo's 8080 yep now say
80 and oops looks like something's not
working and internal server ear all
right let's see what our internal server
error is it's spitting out a bunch of
junks what we can do is we can pipe this
to a file so I'm going to do two and
then log and then we're going to read
run this and see what our air is why
we're going to internal air so there's
something wrong looks like with what
we're doing right here we're checking
maybe the request the request should
exist we're checking if body exists and
if it exists
checking has an ID what's all good query
map extract good queries the spelled
right I hope this looks good everything
looks pretty good to me so okay this
started up okay so now I'm going to
refresh and send the query over and
we're getting an air
all right guys figure out what was going
wrong I just need to add body parser
before my middleware so I had body
parser down here and this nowhere was
running before this one was you need to
parse the body first then this little
where will run then finally this little
layer down here so now we're all good
and we're working just need to add
ani parser in there before you as your
middleware here okay so just to show you
this is working now Kurush fresh the
page bob seven shows up we get no errors
here also something I just realized and
made me think while persistent queries
are actually not useful at all you can't
do mutation weird right like doesn't
work which it shouldn't work I didn't
think about it it shouldn't work because
you know extracted query this is a
variable you can't know what they're
going to put in that so you don't you
like that seems for passing numbers you
shouldn't be able to mutation so if you
can't really do mutations and you can
only do queries that don't have s
queries and mutations and all variables
that's actually not that useful making
precision queries not that useful
so just found that out maybe you just
want to use them personally now that
makes me wanna not use any of my project
so I'm probably going to remove it from
this project but it's good to know how
to do them anyway I guess and maybe this
will get more useful in the future
yeah so that's it for this video guys
I'm sorry for the ending of this because
like I'm super disappointed now too
I'm going to go ahead and release the
video anyway because it's good to know
how to do it but this library just got a
lot this is I feel like there must be
missing something here let me know what
you guys use this library for if it's
good maybe I'm just missing a key point
I just just hit me it only does queries
I just I thought they meant mutations -
I mean it's them it can't even do
queries with variables I didn't think
about it now I'm thinking about it it
sucks a lot more than I thought it did
that was way better but yeah it's not
that good unless I'm missing something
let me know if I am but yeah that's it
for this video guys thanks for watching
we'll see in the next one
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>