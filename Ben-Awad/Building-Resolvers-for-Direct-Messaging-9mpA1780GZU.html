<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Building Resolvers for Direct Messaging | Coder Coacher - Coaching Coders</title><meta content="Building Resolvers for Direct Messaging - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Building Resolvers for Direct Messaging</b></h2><h5 class="post__date">2017-11-13</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/9mpA1780GZU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey guys so we're gonna continue working
on sending direct messages now so if we
hop back where we left off we had just
created our schema for direct messages
and I made a quick little typo here
that's nice but receiver ie before I
write there so now that matches up with
how I spell it the rest of the way so
we're good and we were working on this
direct messages route here now right now
we have currently have our create
message mutation in here and we want to
replace this with our create direct
message mutation so we're just gonna
come over here to graphical and create
that so it's gonna be a mutation let me
create a direct message and here we're
gonna have a receiver ID and we're gonna
have to put in variables receiver ID and
what is the other one text text and then
it's gonna return whether it's okay or
not this is an up here when add our
variables
receiver ID which is gonna be an int and
text which is gonna be a string and both
are not null all right so copy that
paste it in here and we're gonna call
this create direct message mutation
all right and so we're passing this in
and let's format that nicely area so now
we're passing in direct message mutation
into our a view team so we can grab the
mutate up here and then we're just gonna
call mutate on our on submit here so
we're gonna be given text and I make
this an async function so text and what
we're gonna do is we're gonna call a
weight and we're just gonna call mutate
and the variables for this is text which
we're getting from right here from our
on submit whenever they send a message
and then our receiver ID so the receiver
ID we're actually getting passed in as a
parameter to our URL so up here we're
gonna be like you team slash user slash
1/4 so user 4 is to use it we're trying
to message so then here we're just gonna
say receiver ID I almost know spelled
out again oh don't misspell it here if i
refresh it looks like um it remembered
my bad one because I didn't refresh
since we renamed it there we go see how
we get a before I hide there alright
we're gonna reverse these right here to
Ariel
so now it says receiver receiver
receiver all that looks good and then
we're gonna pass in the user ID we got
up there give it a save so cool so now
when I send a message what we're going
to do is we're going to create that
message based on the user we pass in and
the text we get from this send message
so next after we like create the message
and we actually haven't even made the
resolve or freak redirect message and
are back and yet so we need to do that
but we'll finish up on our front-end we
also need to call the create a message
container and we're gonna create a new
one so I'm gonna call this direct
message container and I'm just gonna
copy what's going on here because it's
gonna be similar ish and I'm going to
uncomment these guys and for now I'm
just gonna put someone's someone's user
name because usually there's some one
users name when we pass in this channel
ID to the header okay let's go ahead and
import this so instead of using a
message container we're gonna use direct
message container and we're gonna call
it here
and really to get the direct messages we
just need to pass in the receiver ID
which is user ID and then also the team
ID and then we already know who the user
is the current user based on the JWT
tokens we don't need to pass that in so
let's go to our direct message container
over here so this is going to get if we
come over here we're gonna call this
direct messages okay we actually we
don't even need to I forgot
we don't even need to pass any
parameters to direct message container
I'm gonna get rid of this we're gonna
get rid of the subscription because we
don't need that so this is gonna be
direct message container oh it's gonna
definitely need the team ID though so we
need to change that so passing the team
ID so in our guy right here a lab team
ID because I don't want to grab all my
direct messages across all my team's I
only want to get the direct messages for
the current team moment okay so direct
message container passing the team ID
and so here now we're gonna just comment
out this jazz for now because we're
gonna be adding subscriptions in a
little bit so comment to you you know
what we could just comment everything
we'll keep that subscription there we're
gonna probably use a different
subscription I'm guessing but we'll see
so comment that a direct message
container it's common out the amount
come it doesn't like that it should be
pure cuz we're only rendering right now
so when we add these functions later for
subscribing it'll be good so for now I'm
just going to comment this out the the
warning so you just went disabled
disabled next line there and okay so
direct message containers never used
let's add that direct message container
and so alright so they want to run the
messages query we're gonna run the
direct messages query instead direct
messages query I set in here
direct messages query and the only thing
we're passing in is a team ID which we
get from the props alright neck work
Network only for this is good
and then let's change what our query is
so I'm just gonna rewrite the query here
so this is going to be dollar sign team
ID
which is gonna be an integer and our
query is direct messages and I just need
to refresh so we can get the changes
that we just made
Mario so now we got the team ID there so
the team ID and what do we want to see
with direct messages the ID you want to
see the sender username oops and we want
to see the text if we come over here we
really just want to see the sender and
we also want to see the created app so
let's come back over here and I'm just
say created at this will be a string
and refresh let's grab that - alright
and we can add more fields their query
more fields if we need them later but I
think this is a good start
paste that in get rid of the old stuff
so now we're gonna be querying these
direct messages and to show the message
it's instead of m dot user we're gonna
do m dot sender that username I'm going
to show they created at and we're gonna
show the text which all looks good and
I'm gonna call this direct message for
the key and this looks pretty good I
think our front-end is looking good for
this let's finish our backend now so
let's make a resolver for this so this
is direct message dot yes and we can
copy a message because it's gonna have a
lot of the same components oops it's
down here up not models resolvers here
we go we don't need pub/sub right now
I'm gonna get rid of it so and we don't
need subscription we will need to have a
direct message here because the sender
we need to grab all right
so our query this is gonna be direct
messages and oh we want to do pagination
on this as well that would be a good
thing to do you know we have a done
pagination yet I don't think that'll be
a good thing to add but we'll worry
about that in a little bit so direct
messages requires off the Creator result
or we're gonna pass in here a team ID
and we're gonna grab direct message dot
find all we're gonna order by created at
which is good and here this is gonna be
an interesting way so user so we want to
find it where the team ID is equal to
the team ID we have here and if we just
look at our model real quick notice how
we have a team ID receiver ID and sender
ID to look at so we want to see where
the user is either the receiver or the
sender of a message and actually I was
wrong I think we also need to pass in
the receiver so we know which person
that we want because I could send
messages to multiple people we need to
know who the receiver is so receiver ID
actually it might even receiver idea
just like a other user that you're
communicating with so other user ID
we'll call it
and so on our direct messages here well
it's actually pass in the user ID and
then a direct message container we'll
come back down here and add this up
let's our messages here's their charge
messages so instead of just getting the
team ID we were also going to get the
other user ID which is gonna be an int
and I'll just put that here other user
ID other user ID and we get that from
the props again so other user ID there's
gonna be props user ID cool down our
back-end what we want to do is this
other user ID their user ID we're gonna
do where so we're we're in the team and
we're gonna do it in or which I believe
you just do it like this we'll find out
if this does work actually let's just
real quick sequel eyes or so don't mess
up the ESN tax of this and let's search
for or operations alright so we want to
do an or operator this is how it
recommends doing ORS now it's kind of
interesting so we do Const op and we do
op or okay let's try that okay so we're
gonna have our clause which we do it
like this now so models das equalize to
get this equalized instance and then
operator and we're gonna do an or
operation and then we're gonna have our
little right here and then an array
we're gonna have two things and just
drop this down
so here's gonna be our first condition
he was gonna be here a second and
basically what we're looking for is all
the messages where other users the
sender and user is the receiver or vice
versa so here we're actually gonna do an
and so we're gonna say models dots
equalized op dot and and in there we're
gonna say receiver ID is equal to other
user ID and then the sender ID is equal
to user ID all right so now the other
condition is just the inverse of this so
copy that
and we want to say the reciever idea was
user to ID and the sender ID was you was
the other user ID and what this will do
is this will just grab all the messages
that were sent between these two users
and then we're sorting by created at and
we're getting raw so this looks good
there's a lot going on here so there's
room for error so I'll have to run this
in C let's go ahead and in our mutation
over here make our create direct message
so when I do requires off on this as
well
let's do direct message the sender ID is
going to be the user to ID call this
direct message so we create the message
and then here we're gonna pub/sub and do
our subscription which we're gonna do
this in a little bit and we'll just say
true there so let's take a look and our
terminal real quick and see if we're
crashing at all or not so let's come
over here and see if we get any problems
okay I'm just gonna refresh there's no
other users let's make sure I have the
route right to get this so this we
should see an empty page with no errors
we'll see what we end up getting because
if I go to index I go to route team ID
and then user ID so the team is one and
the is it slash user
yeah slash user and let's say the user
is 2 okay so we get an error the
operation data wrapping direct message
container is expecting a variable other
user ID but it was not found in props
past okay so we got something wrong with
our container so our direct message
container we're passing in a team ID and
a
your ID and then in the container itself
we're expecting an other user ID other
user ID which were grabbing from the
props this looks fine it's possible I
know we're getting a bad user ID let's
see if we're querying hitting the server
does it look like we're select all from
teams nope actually don't know why this
would be having a problem it looks fine
Bob rationed data wrapping Direct
Message expecting a variable other user
ID did I spell it wrong no so what if I
hard code this to be 5 let's see if that
works we should see no messages because
this user doesn't exist it's expecting
variable other user ID okay it must be
doing something super silly we're
passing the team ID Oh Matt this is
should not be called messages that's the
other thing this should be direct
messages
I don't think that's causing the problem
though because it looks like it's having
a problem before that yeah alright so
what if I get rid of the requirement of
this variable just to test this and
we'll say five there okay awesome so we
get hashtag someone's username and we
get this little message thing so for
whatever reason this variable is not
getting passed in other user ID was I
just spelling it wrong other user ID I'm
just gonna copy this it looks just fine
it's getting the team ID fine I'm gonna
say props dot user ID so this crap this
is when it crashes I just want to make
sure this does this works over here okay
so we're still crashing so I'm gonna
come over here and I'm gonna say refresh
make sure it works in graphical so other
user ID other user ID pass it in here
other user ID that's gonna be an int
and we're gonna pass so we can pass on
our variables here I'll be five another
use of these four alright so not
indicated that's good I'm just gonna
copy this over it should be what this
looks like and I could just call this
another name too maybe it's the name of
strung it off let's see refresh same a
here okay instead of other user ID I'm
gonna call this just user ID which were
you ready are calling it from the
prompts it's a user ID and let's see if
it likes that better and it does
interesting not sure what's going on
with that
I guess it's automatically reading the
variables from the props or something
possibly alright but let's continue so
now I want to be able to create a
message and we should be getting an
error when I create this message because
this user does not exist so ABC hit
enter
we're not even consoling the result of
this so that would be a good thing to do
so that would be in our direct message
container so the containers direct
messages area that's gonna be in our
route so miss a const response
and we're just gonna log it
I mean people should not even be able to
really get to this page so a B C D and
we get false so it doesn't work good so
now let's create a user add them to our
team and try messaging them okay so
let's go over here to register we're
gonna say Bob - at Bob calm and let's
see what their user ID is every passing
that we're not login actually we don't
need to login as then we just created
them that's fine view team invite people
let's invite Bob - so now that user is
part of our team so we can message him
so I'm going to slash user and now I
need to get the user ID of that guy so
I'm gonna come over here and go to P
sequel so we can see what the value of
heat him in the databases so slack
select all from users all right he is
user number two so I'm gonna say a two
here so here we should see all messages
between me and Bob - now when I say ABC
hopefully it says true it does and if i
refresh all right so we're having triple
fetching the from the user so let's just
see this is the query it made so I'm
gonna copy this copy this and I'm gonna
put this into piece equal over here and
run it okay so we don't even get it it's
empty so let's look at what's happening
here so we're saying and actually before
we even look at the query and analyze it
let's select all from
direct messages okay so there is a
direct message here Oh looks like the
team ID is not getting set so that could
be the problem so let's come over here
to our resolver and we're passing in all
the arcs so are we not passing in a team
ID as an argument to our direct message
we are not so let's do that
team ID which is team ID so a pasta has
a variable so let's create that as a
variable in our actual graph QL now and
team ID and oh that was wrong that
should be dollar sign team ID and this
should not have a dollar sign there okay
so now in our schema on our server we
need to update that to to accept a team
ID when we create the message all right
team ID it
all right so let's create another
message now that merit that message is
gonna just get lost
um were you fresh because the server was
still restarting so I'm gonna say hi it
got created okay I'm gonna refresh and
now we get a map of undefined so let's
see what's going on there
that's our direct messages over here our
container so I'm just gonna do a console
log of direct messages and should it be
called something else nope
should be called direct messages so for
whatever reason it's returning null and
I I think I think I know what some
possible problems could be yep it's our
cinder so it's not on our front-end
we're gonna go back to our back-end this
is with our resolver or direct message
resolver so here's our direct message so
our user here we want to grab the just
the ID I believe so okay so we're
getting all the direct messages and we'd
like to also send the the person who
sent it so that's gonna be the sender ID
and we're also I'm gonna grab a sender
so if the sender's already there we're
just gonna return a sender
otherwise we're gonna find the sender
based on its ID they're real
let's see if that works still the server
was still restarting ah nice I shut up
man we got a lot of errors today so hey
be fresh and hey shows up here now I
should be able to send this also from
Bob too so let's try that real quick so
for him he's gonna come to the same URL
but it's gonna be a 1 up here but he can
also chat with himself which is
something we need to add as well so
let's log in as Bob - Bob - at Bob calm
and make sure this functionality works
I'm gonna come over here to my view
teams alright I see my one team that
I've joined and now I'm gonna go message
with the first user and hey I see these
messages you sent to me hello from Bob -
and we see our Bob - user here cool and
we can refresh actually what the heck oh
cuz we're in general I was like well
thank is it going on we shouldn't see it
pop up right away it's like good slash
user and we're gonna go to one is the
channel or the team ID and then one is
the ID of Bob so here we are so hello
from Bob - it got created okay i refresh
we see Bob - here cool so it looks like
we're able to create messages okay
so there's a lot we still need to do
with this though we need to be able to
make these clickable here and I
shouldn't have to go change the URL I
should just be able to click buttons
here to chat with users and I should get
subscriptions to work so that's what
we're going to be working on
in the next video that's it for now as
always a cool up on github thanks for
watching guys
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>