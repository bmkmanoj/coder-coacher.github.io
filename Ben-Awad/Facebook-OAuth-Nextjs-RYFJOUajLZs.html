<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Facebook OAuth Next.js | Coder Coacher - Coaching Coders</title><meta content="Facebook OAuth Next.js - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Facebook OAuth Next.js</b></h2><h5 class="post__date">2017-07-07</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/RYFJOUajLZs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">what's up guys so I'm going to show you
how to login with Facebook a loss from
next yes now I'm going to be starting
from my next shift template basically
hello world application I've been using
a pull and Conscription below if you
want to use it to on the front page
there's an error to worry about that
we've been messing with it back in the
law and messing things up and we don't
need it but I'm not really doing
anything grass QL related I just wanted
to go based off this template because
and I want to do more things this later
but you could follow along with a fresh
next shift
install and BA okay we're going to be
doesn't matter what you have set up on
this server or if you have a separate
server not server I shouldn't be saying
next to the server next you has
application anyway let's get right into
this so I'm assuming you have a server
set up and follow along using OAuth if
not always video to get the setup or the
source code you can just grab both and
start running emesis so what I want to
do is I want to create a slash login
page here I can go to and I can click on
a link and maybe they'll log in with
Facebook so look do that so under pages
I'm going to create a new one called
login bas now you're going to want to
use a pretty-pretty button and stuff
we're just going to copy actually we
don't even need this you're going to
want to put a pretty button and stuff
using Facebook's logo but for now we're
just going to use a plain and simple
link for us that'll work just fine so
login with Facebook we're just going to
use this guy and the href is going to be
your URL here for how you log in so I
have mine comma and rock instance still
running here and you feel I'm talking
about watch the view before I get this
set up
and we're going to go to slash F login
and now that's all we really need to set
up for now for this page we can do here
is also create another page to like
receive the auth so here I'm going to
call this page maybe home page home Jas
and on the home page we're going to
export default and I'm just going to say
hey home page home page now we're going
to need to do one thing with our server
code when we create a user here we just
said off was good right now we want to
actually redirect we want to redirect
them to our local o site and it's going
to be home so it's going to happen we're
going to click on that link we're going
to bounce over to our server Ralph's
indicate with Facebook and then they're
going to redirect this back to our home
page so let's see this in action so we
got the login page here I'm going to
click that link in a second it's good a
note after you've already accepted the
terms of Facebook you don't have to do
that like this is going to be in to like
see how we just instantly popped back
here
not sure why I have this underscore
equal underscore thingy and but you know
so we successfully authenticated with
Facebook and it redirected me back here
but I don't know who the user is and
stuff so what I really want to do is do
like pass in a token here a JWT token
with a user actually so put that here
and we can just see if that pops here
all right so we see our token here
that's good and we need to actually
create a real token now we just want to
test that this query was working and now
on our home page what we're going to do
is we're actually create a react class
and poor
want to import react from the axis
because we're going to say home extends
react component and there's a function
called get initial prop this is static
and render okay so if you're familiar
with react this class it looks pretty
normal going different one is get
initial crops this is an XJS thing and
and we're going to console.log this i
believe it tells us what's the default
export it's not explore default here I
believe that this tells us what the
query parameters here because what we
want to do is we want to grab it here
and store it and local storage must have
a return undefined export default class
this looks all good may doesn't like
this maybe add something else all right
cool is it that that was causing there
the initial prop should result to an
object of I'm guessing after return
props here and I wasn't before the intro
is all but undefined instead okay let's
just go to next yes real quick anxious
get initial prop no way we can actually
do this correctly get initial oh it's
static a think that the only thing I was
doing wrong because I didn't have a sink
get initial props get initial problem
converting circular structure to JSON
not sure what that even means I'm
guessing it doesn't like that I was
returning okay cool so now if we go in
the console will it print that guy out
okay it's not even printing props on so
that log drops I'm wondering if it's
just executed on the server and I think
it is because we don't even see props
here so this is probably executed on the
server what we're going to do is we're
going to say state token is going to be
a string I guess we can do component
wheel mount know we should be component
did mount because this is called on the
client-side so state is equal to this
we're going to say this dots state oh
sorry this dot said state I don't even
know if we can set State and get initial
props actually so this dot set state and
we're going to say token here and grants
a Const query equal props we're going to
say query token will return this here
and then component amount we're in a
console dot log this thoughts state
token I actually need to research how
the heck
next just handles this I'm taking a
guess that it works something like this
this set state is not a function doesn't
like it so it looks like to set the
props here maybe I have to do crude
token here
just fine with me actually the notice
I'm doing to unmount was rendered by
another copy
oh sorry shouldn't be doing sub-state
and actually we don't need we don't need
to put the toca in the state all we
actually need to do is a store it and
local storage so actually we need
component did mount to do that so cannot
read properly OpenAL so maybe
so I'm guessing query is no okay don't
know how to do this don't know what's
going on here okay so assuming this
would work we want to get this token
here store it in local stores so local
storage dot set item token and then
query dock token that's what I like to
do I know this is not going to work this
is not getting the props here it should
be but not someone research figure out
how that works and for now let's
actually pass the prop in correctly so
that's going to be from we're creating
the user here we get access to we're
going to refresh token but that's from
Facebook we don't actually care about
those I think you want to I don't know
if we're getting the user I think this
is probably setting the user here so I'm
going to test something here so hello
it's going to be equal to high and what
I'm thinking is in the requests got
response requests that user I'm guessing
also a lot long I'm guessing
this is going to be whatever we do this
callback so just call back hello hi
thing I'm guessing is going to be what
this user is and if it is we can
actually use this to sign the token so
let's confirm if it is or isn't so to do
that I'm going to clear the logs here
and we're going to log record so click
good internal air oh that's fine that's
from this so I'm going to I'm going to
comment this stuff out so we don't just
get errors I want to see oh this would
have come to the okay cool so this has
what we want so here's the pass back the
user we're going to say comp user so
whether or not we're either going to
find the Facebook user here or we're
going to create the user here so
constant user SB user and we can say
Facebook users dot push SB user and then
here we can say FB users so we're going
to get the first set for Facebook user
right that's going to be our user I'm
just trying to think of I guess we're
going to call this user know it's an
object we can just pass this back a time
and then so we're going to pass back our
Facebook user we're going to get our
user here so normally to create a token
we go into my resolvers by the way
resolvers is not working right now we
did some changes we're going to fix this
later and actually this should be a
knock so we create tokens rights when we
login we try to login then we create
tokens we're going to copy this because
we're going to create tokens
right here and we're going to pass in
our user right here user being rekt user
and then we can pass back our tokens so
need to make this an async function
create tokens this is create oaken's we
need to import from off all right so
we're grabbing these and then the token
here we're going to substitute in our
tokens refresh token and this should be
an and and then here we pass in our
token and here we pass in our token but
is it going to be a refresh token all
right so just to recap what we did here
is we're calling back our user that
we're getting from Facebook that we're
finding in our database we're passing it
here then we're going to save that user
and create a rock saving user we're
creating our token and resource token
for that user they were going to pass it
back to our client and they would store
it in their local storage but I don't
actually know how to store things in
local storage and this framework so I'm
not look that up but if I logged in here
assuming we didn't do anything on a
server wrong which turning ok so is it
only a network call that's just like
hangs like this we can do if you can
come over here and see what's loading 17
seconds on the web pack underscore next
so something for whatever is is hanging
on getting this so this
okay our server looks fine we're going
to restart okay now click on this should
go to anger och I think we're coming
back from in rock I'm trying to see
where we're getting stuck look at this
network camera we're just like getting
stuck here we're going to so you can see
the network calls when we click on this
link it should take us so notice I like
look right here as anga rocks / f login
we go to f login we go to Facebook after
that which is good then we get our
callback and then on demand entries oh
did we not call maybe await and we did I
don't know why res dot I don't not sure
if it's a redirect here that's not
working or if it's we did something
wrong with next J s so I'm going to do
res da redirect HP localhost:8080
slash home so we're not going to use any
of those fancy a tunnel just baroque oh
there's our server down maybe it's not
next yes so this will tell us whether
it's next year is causing the problem or
if it's our server so now go into locos
3000 slash login sorry it's on port 8080
slash login click on my link here and we
are just spinning trying to connect
cannot read property token of null oh
maybe this is doing something wrong too
all right try this again click on this
all right we redirected to the home page
that looks nice and dandy so I think it
didn't like us passing in the token here
so I'm going to just console.log see if
it's I'm curious if it's hanging when we
create tokens or what so I'm going to
say ok and we're just going to see if
hey goes it to the console and just for
kicks we're going to do this for the
user as well but we're going to do it up
here so we can see what the user and
we're going to try redirecting again to
local codes aad slash home passing in
our tokens all right that looks good so
go back to the login page click login
and now if I come over here to the
console we can see what's happening so
this is a user right here and we're
getting an unhandled promise rejection
so we have an ID a facebook ID and a
user ID and it still hangs so I think
create tokens here is actually causing a
world of problem for some reason so if I
go into off we can see what create
tokens is doing wrong and it looks like
it's just yeah we're just signing too so
what I'm going to do here is going to
say about to create first token I mean
one thing I see can see that we're not
doing as you can notice how we have
we're just putting in the ID here I'm
going to get rid of the is admin part
here maybe that's throwing it off
because we do not have an admin I wonder
if a underscore pick is causing a
problem if lodash is lagging because
we're passing a whole sequel eyes object
all right
so coming back here let's go to 8080
slash login and see this guy so long on
Facebook and we're hanging which is what
we expect so we come back over here and
we so there so there's this I should
have mentioned this unhandled promise
rejection oh create token this is not a
function oh that's just straight-up what
the problem is sorry guys I should just
read that more closely I kind of like
scanned over and thought it was
something else
so create tokens is not a thing create
tokens and that's because we need to
actually export it it's really mistake
now if we get a little closed 8080 slash
login and I click on this okay cool this
move I wanted to show you guys sorry it
took so long to get here but notice in
the URL we have token here and then over
here we have refresh token so normally
what I would do is I would store token
and refresh token and local storage and
then I can just use that when I call the
server I can pass those in and use those
to authenticate that's all I wanted to
show in this video guys sorry it took so
long to get here I'll make a new video
on how that I'll actually look up how to
do local storage and show you guys how
that works so I can complete this get
rid of we don't need these console logs
but this shows you how you can do full
circle we're sending the tokens to the
client so the client can now handle
those and deal you know do their call
we're all dedicated so thanks for
watching guys I'll see you in the next
video
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>