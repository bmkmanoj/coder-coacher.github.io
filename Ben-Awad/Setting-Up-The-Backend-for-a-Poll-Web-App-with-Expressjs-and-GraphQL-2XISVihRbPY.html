<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Setting Up The Backend for a Poll Web App with Expressjs and GraphQL | Coder Coacher - Coaching Coders</title><meta content="Setting Up The Backend for a Poll Web App with Expressjs and GraphQL - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Setting Up The Backend for a Poll Web App with Expressjs and GraphQL</b></h2><h5 class="post__date">2017-08-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/2XISVihRbPY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">alright hey guys so today what I want to
do is work on an application using kind
of all the things that I've been working
on so I've been doing a lot with graph
QL react and here are some of the things
I'm gonna be using flow I'm about to
build so what I'm gonna code up here is
the today I'm going to be back-end for a
pols application and here it's kind of
just an outline of the project and it's
basically gonna take all the concepts
that I've been showing you and then
actually use them in an application so
what this application is gonna be is and
kind of an online poll polling
application where you can go on polls
and create polls and here is kind of the
rundown of how it's gonna work
so here is what kind of the things that
I'm going to be using in this poll
application so I'm going to be using ant
design which is a UI framework to make
it look nice here I'm going to be using
Postgres sequel database and then the
sequel eyes arm and we're gonna be using
graph QL on the back end we're gonna be
setting up a graph QL server I'm gonna
be using query batching thanks to join
monster
so our queries are really fast I'm gonna
show you how to do authentication so the
users can log in this is all gonna be
real time using graph QL subscriptions
so when someone hits a poll everyone
sees it update on their screen and then
also we have at the end I'd like to
deploy it to production so you guys can
see it I'm probably gonna put on Roku's
but I'm thinking right now might change
this up later not sure and oh yeah also
pagination not sure how exactly one do
the pagination yet but I know I want to
add that in there so here are the pages
of the poll web app that I'm gonna be
building we're gonna have a login page
which is going to just be a form with
the email and a password and when we're
done we'll talk about the redirects and
we're done
because it will make more sense so then
I also have a register page where the
user it's gonna be a forum their user
name email password they type in to
create users and then they can use the
email and password that they create here
in this login ok and then also I have
these in a create a kind of a page kind
of a home page or you can see all the
polls all the users have created and so
that's the page that's gonna have
pagination on it well you can look
through and maybe I'll do infinite
scrolling on that so you can just scroll
through and see all the different polls
that people have created and oh yeah so
authentication will be here with our
login and creating of users and then all
this is all gonna be stored in a
Postgres siegel database the polls the
users so that's where that comes in and
then we're gonna be able to create polls
now i'm gonna block its own the
authenticated users can create polls so
you have to register so you'll learn how
to basically only have authenticated
users be able to access a page and
create polls and then we're gonna have
voting on polls and our polls are gonna
have just two things options which is
all the different things you can vote on
and then a name which is just a name for
the poll or maybe you know the title or
whatever so and you'll be able to vote
on the poll and the vote when i click on
it it's gonna be send out a WebSocket
push notification basically to everyone
else has the website open and you'll see
the vote happening in real time so
that's it and then also you can see the
poll results for a single poll alright
so that is kind of all the pages and how
they correlate with what's going to be
used and then here I just kind of made
it real quick what I thought I would use
for the database model so I'm thinking
just three tables a user table a poll
table and a pull option so user regular
stuff username email password an ID ID
on all of these of course and then we
have polls so here I can get rid of this
because I thought I was gonna maybe just
like limit it to whoever
is a you know authenticated to be able
to vote but we can get rid of that I
didn't think I don't want to do this
anymore
it's only just pop over here this is
what I'm using right now something
called grip which what it does is it
takes this readme MD and this does it
locally and makes it look like github
just pretty sweet so get rid of that
okay and you see how it updates real
time to pretty Quan anyway that's a side
topic so here so we have our poll here
so that I've named options so this is
gonna be a one-to-many relationship so a
poll can have many options and option is
correlated to a single poll and then
we're our Creator which is going to be
connected to a user here of the poll and
then we'll have a text for the poll
option and the number votes that option
got in that poll all right and that's
pretty much it so we can go ahead and
get started on the backend for this
today so for the backend we're going to
use is this graphic you express template
that I have created before in previous
videos so if you do not have this you
can come clone it here that's what I'm
gonna be doing and if you want to see
how this is made I have a link right
here to the YouTube playlist that I use
for it so alright we can shut this down
we don't need this anymore so I'm just
in a blank folder here with a readme so
I'm going to get clone this and I don't
want to put my graph I want to like put
all the stuff that's here into this
folder so I'm just gonna move all the
graph kill Express stuff into this
folder okay and I'm gonna say remove
dirt
Graff kilo Express and that's just so my
Oh actually I think I just over I did my
readme file yeah I did
that's sad okay so I took what I just
did is I just moved all the files that
were in my graph QL folder up one and
when doing so it over I did my read B
and I didn't create a github yet so it's
not get or anything so I just lost it
forever but luckily I'll just go back
and look at the recording and recreate
it but anyway so I could have just get
cloned this because I messed it up
anyway I wanted to trap so the reason I
was doing that is I just wanted to keep
the readme but I effed up the readme
anyway so let's go ahead and just remove
back end I'll remove RF so delete all
the stuff and back end now I'm gonna get
cloned to stall over and I'm gonna call
back end so forget what I just did I
basically just what I did was pointless
so I'm gonna open up this project in
Visual Studio code and okay I guess it
already has it up here so I'm gonna put
it here and let's just get started with
this I think I have yes lint all set up
nicely we're gonna have to go ahead and
do yarn on this just to install all the
dependencies so I'll let those run in
the background and then I'm just gonna
come in here and remove any of the stuff
I'm not gonna using and also I'm gonna
go to a later version so how I did this
project is I did it by let's move it
over here okay so here I am I just split
the screen I have it running here so how
I did this repository right here is I
have on the master branch but later
branches in this so if I do get branch
we can see all the branches
okay I guess you have to check them out
before T so you can see the ranch anyway
how do you get check out 20 there we go
okay now you can see all the branches it
just my tab completed it shows them so
these are all the branches of this get
project and I coded it kind of in the
order so the master branch has the least
in it one has the least in it going up
all the way to 2020 has the most stuff
in it so if I get checkout 20 this has
basically the latest version of the
project so now you can see there's a lot
more stuff in here okay so I'm going to
remove some of this stuff I don't need
because I'm not going to be doing
anything with Facebook Roth or using
passport or data loader so get rid of
that we might be using lodash for stuff
so I'll keep low - joy monster is gonna
allow us to do some like I was saying
some query batching so we'll keep that
subscriptions are good and the rest of
this looks really good so we can keep it
so stuff we can get rid of is this
Passport get rid of this guy and get rid
of this and get rid of this so now we
have just an ad user that's good we can
keep that of a console log there that's
fine Korres is good graphical is good we
don't need bash suggestions because
that's what I was using with data loader
and we're not using that anymore and I
can get rid of this - that's not our day
loader thing and okay so I'm happy with
the index page now we have set up the
subscription server we have the graph
kills server graphical as well and then
we have some middleware for
authentication but we'll be coming back
over this what I can't want to start
with is creating the database models
right so like I said I want to use their
model and I also want to pull model and
a pull option so pull so just three and
so here I have the database and then
username password for the I think I
don't actually think I created a
username and I didn't actually create
this I forget how you create a username
and password for a specific database so
we'll have to look this up but we'll
call this pull left why not we can just
call this poll why not here's the
username password for that database I
need to create that and create this
database but we'll do that in a minute
well create will keep user here so user
name we don't have admins in this
project so we can give her this so but
we're gonna create a user table here and
shrike I think we want to make this a
lowercase I think I like lowercase
better with the Postgres so user here
I'm fine keeping the variable uppercase
but on the table itself to be lowercase
so one user can have multiple polls so
we'll say one-to-many with polls and
we'll call this poll and we're gonna
call it creator
and let's get rid of this suggestion all
right so that's good and now we can
create the poll in the pull option model
okay so I'm gonna get rid of this and
this and just clear these guys out oops
command delete okay I could just do
command delete that'll be faster there
we go
okay command delete did not work I just
deleted the whole folder on accident I
did ctrl Z but only refresh this okay
that's nice
so I just accidentally deleted the whole
folder nice thing is is that it's in git
so what I can do if we do get status we
cancel II see that I just delete all
these right so I can say you get check
out models I believe and it should come
back yeah all right so now everything's
back of course now I have to redo this
real quick because I messed it up so a
pull option sorry about that guys I'm
just gonna go to the command line and
delete this because it'll be faster
and pull option and then same thing with
the user that I change before I'll just
going to change that real quick and
lowercase that okay so we're back and
then from the command line here I don't
need to switch back to one CD and two
models and so I'm gonna remove
everything that starts with the B we
don't need and we don't need remove
local off suggestions at B off and then
we can rename author to Polje s and then
we can get started okay so this is gonna
be a pull and it's gonna have a name and
that's it and the name is gonna be a
string that's good and then the pole is
gonna associate and remember I said
we're gonna have a one-to-many
relationship with pole options so we can
create that here I'm gonna get rid of
this
we want the same relationship user has
two poles so we can copy that and so
here we have pull and our model it's
gonna be pull option I'm just gonna copy
that paste it in and I'm gonna keep that
for pull option so cool option here
actually it's better to name it I can't
remember if I had any trouble with doing
snake case with this we may rename the
database later so I'm using this is
what's known as snake case with the
underscore here you can also name it
like this but things seem to work better
in Postgres when you name it like that
but I can't remember if I gives me any
problems with sequel eyes I'm gonna go
ahead and keep it like this and if I
have problems I might switch it back
later because it's relatively easy so
here we'll have text well I pulled out
associate and this this doesn't need
anything at all so pull option yeah this
so this doesn't mean associated anything
it literally just needs text and oh yeah
it needs a votes to so votes and this is
gonna be an integer type
I think it's integer not and I use int
anywhere
I think it's integer I always forget
what the types it should be good okay oh
yeah and we should also rename that to
pool okay so I have my DB all set up
there and a nice format I believe that I
like actually so I want to like kind of
get started up see if it works but
before I can do that I need to set up
the schema so let's do that so I'm gonna
get rid of all of the stuff we have in
here and just start from the beginning
actually we don't need to get rid of all
all the queries we don't need all the
mutations we can get rid of except for
login register and then schema okay so
this looks good to start off slow
subscription we're gonna have one
subscription we're gonna listen for when
I vote happens so we're gonna call this
vote happened and what we're gonna
return is we basically want to say which
poll was updated so the ID would be
helpful actually what we can do is we
can just say return the poll poll value
so okay so this is well this might
change later depending on what of it
there information we have available to
send back to the user when we're
actually doing this I'm thinking the
vote happened what we return is either
like an integer which we need to send
like the ID for now I'm just gonna leave
as a poll
and type whole visible say so this will
have an ID which is an int and I'm doing
a bang sign because it can't be null
it's gonna have a name which is a string
we don't want that to be know either and
then options which is an array of pull
option and actually okay so we're we're
making a one-to-many relationship with
Pearl options the foreign key should be
pole ID so then our pull option here
will have three things text which is a
string votes which should be sent an ID
and the pole ID which is this which
isn't it so this ID here will match an
ID to the pole that's matched up with we
have the options here which will be an
array of these and so when a vote has
happened what is really happening is a
pull option has been updated so maybe we
return here a pull option instead of a
pole that seems pretty good to me and we
want to have a type user
and he's gonna have an ID he's gonna
have a username email and password
actually we don't want to show the
password for the schema though so just
email and username we could also show
have like poll and get the polls for him
like the polls that the user has but we
don't really have anything in our pages
that we need for that so I'm not gonna
worry about that okay so this looks
pretty good so we have a poll option
user and I can always come back and add
stuff if I think I'm forgetting it this
seems like a decent start
so here permutation for register this is
going to create a user off payload let's
create that type real quick I have off
payload that's just gonna have a token
which is a string and a refresh token
which is the string and is admin here we
can get rid of oops
think I bump something one second
I think did I mess something up let me
just check my OBS real quick no
everything looks in order okay yeah
sorry guys I thought I'd mess something
up but I think it's okay I guess we'll
find out later
uh-huh so okay so we have the type the
mutation let's do this fill out the
mutations first so this is gonna but we
need to create users why don't we do
create pull so when we create a pool we
need to have a name which is a string
and type pull options so the other thing
was when we creating a pool we want to
pass in what the options are and we
actually need to create an input type I
forget what that's called I don't know
if it's a type or if you do input input
type of graph QL forget the syntax for
it
because you can't just like have a type
that you pass back okay it is input
because what we want is to have the
options and we'll pass a pull back
actually so pull response is there okay
let's first fill let's first fill out
what we need here before I think of what
the outputs going to be so for options
what we want to pass is really just a
list of names here so a list of strings
will be the options we actually don't
need an input type I was thinking we
need an object here but the votes is
always going to be 0 and the pole ID
really just you need text so options is
gonna be a string and I'm gonna return
the type of poll response and the reason
for that is in case there's an error
creating the poll I want to pass back
the error to the form and that way you
can render them so here I'm going to
save poll response and that's gonna be
not null so in the poll response I'm
gonna have Ayers
so type air I'm gonna say field which is
gonna be a string and a message which is
this string - so this is Aires is gonna
be an array of air and this can be null
so the idea here is if we get any errors
with poll response we want to pass them
here and we're gonna have with each air
I want to know what field so like maybe
been name is invalid for some reason or
the option is invalid and a message that
I should show on the UI and then I also
want to be able to get the poll right so
I should also return the poll that's
created so poll and that should be this
can be both of these can be null so if
there's an error this is true right if
there's not and also what I can put here
is okay which is a boolean so this is
what we can check right here is if
there's any well like okay as well we
can use the say if there's any errors or
if we got a pull back okay
and so this will be a non null and if so
if there's errors poll will be null if
there's no errors poll be okay and
errors will be null and this will make
more sense we actually do it and maybe I
will change this if it's messed up but I
believe this is correct so we return to
pull response when we create a poll and
that's really only the only create to
creates that we need the other mutation
is gonna be a vote mutation and to vote
we need a couple things so we really a
vote means where is really just an
update of this poll option and
incrementing votes so
we need basically just the ID of the
pull option and then yeah so ID so pull
option ID which isn't it and then when
we vote is there anything else I need to
increment or update I don't think so
so what do I want to return back from
this maybe just a boolean of whether it
worked or not
so when we vote we were going to turn
boolean of whether a succeeded or not
and we're passing in the pull option of
what we want to vote on and what we're
gonna do is we're actually just gonna
update this table in our database and
increment the votes value okay
I think that's everything for the
mutations so for queries definitely want
to view a poll don't want called bu poll
why don't we just say a poll and you
pass and the ID of the poll you want to
see so that'll be an int and that will
return a poll and I had a nominal at
first but we should pass back null in
case they give us a bad ID and we can
calculate the results from the poll so
we don't need a separate one for poll
results I think the only other one is
all polls which returns an array of
polls that's pretty good I'm trying to
remember if there's any other pages that
we need to support I think it was
creating a poll all the polls viewing a
poll like the results of it yeah I can
always come back and add these later if
I miss anything so this looks pretty
good for our schema now so I should add
the resolvers for these I think I'm
gonna add some stub or resolvers for now
we can come back and add stuff later
unable to resolve module oh I don't
think we did yarn yet I think I did yarn
oh no we did do yarn I thought I did
yarn on the master branch but we must
have done it here all right so why is it
my neighborhood was all paths module
enjoy monster so usually this happens in
ES lint when you don't have it in your
note modules oh yeah we don't huh look
what I was on ie a yarn nothing gets
installed if I do an LS and my new
modules it's empty so I'm gonna move
there
Oh what oh oh I'm in models no wonder so
I'm gonna get rid of yarn lock so see
how I was in the models directory there
remove node modules that's why we were
having a problem with yarn all right now
yarn we'll go ahead and download all the
packages we need alright we're not
really gonna be using permissions for
this so I'm gonna get rid of that and
I'm gonna just go ahead and delete that
file
all right so our subscription here it's
gonna be vote happened and pub/sub async
iterator is good and we're just gonna
rename this vote happened so our user
don't have to worry about that don't
have to worry about that or that any of
that stuff because if we're gonna do
that all enjoy monster see this joy
monster stuff that's happening here this
is what we're gonna do so all polls I
believe is what we called it yep so here
we're gonna take the regular parameters
for resolver we're gonna call join
monster and yep that looks good this one
we'll get we'll call pull that one will
have to pass we have the args there
that's good that's all our queries right
there was only two yep so I'm gonna get
rid of the rest of this stuff
and then just our mutations here so
register so I just want to make sure
this is right so we have an async
function here the arguments we want to
just pick out the user name argument and
do local off oh yeah my user here I did
not do this right this should have more
stuff in it I was doing off a little
different differently to support also
Facebook off but we don't need to worry
about that since we're not doing
Facebook off so password mmm so when we
actually register and login we should
also do that similar thing with the
responses and the schema so we'll fix
that in a second so email password so we
have all the arguments that we need and
we're not going to add any other ones so
we can get rid of both of those and we
get rid of that I believe and that
okay I think this is all we need to do
so when we were creating a user is just
hash the promise
sorry not hash the promise hash the
password so args dot password and so
Const password so we're gonna create the
or we're gonna say hashed we can call a
hash password hash password so first
we're gonna hash the password and then
next what we want to do is just create
the user so and what we want to do here
oops we want to do here is return with
the okay which is true heirs which is
gonna be an empty array and then user
which is going to be models die user
create and actually you know that we can
just put the user here so Const and then
what we're gonna do is we're going to
say everything from args
but the password is not going to be a
regular because you don't wanna store
the password as plain text you want to
hash it so we hash the password that we
create this guy and we're gonna need to
await the response and then if there's
no heirs we return okay is good and
errors is good know otherwise what we
can say is do a try-catch here
so I'm not really sure what type in air
can happen that would we need to show to
the user per se so if everything worked
we want to return this but if it didn't
go okay we want to return false
and we want to we want to show I don't
know if I have to explicitly do this I
might need to we'll go ahead and do it
why not and there no we're just gonna
pass back field the field that's getting
messed up we don't know if it's the user
name password or whatnot one so if the
user name or so here we said unique
right so one possible problem is the
user name or the emails not unique so
we're gonna have to somehow parse out
this what the air for there it's the
user name or the email that's not unique
so for now I'm just gonna say generic
it's always the email and message
something went wrong well the debug this
guy later because I'm not sure what this
is gonna be so I'm just gonna console
dot log E and then we'll parse out a
later and do the correct field message
this will be some trial trial and error
later so now I want this how I'm doing
register here to match in my schema so
like I did a poll response I'm gonna do
a register response
and a user so same thing for login oops
and off payload yeah we'll just return
off payload which is an auth payload so
instead of just returning the user here
we're gonna say register response and
the login login responds now those
should not be null
so our register looks good what about
our login we're doing that and try login
let's go look at that what that is
I'm gonna go ahead and delete all those
we'll come back to them that's an off
okay all right so try login so here
we're looking at the local off but
really we should be looking at the user
so first we're gonna look for the email
if not we have a problem so we can throw
an error
so here the emails not found here's a
bad password okay otherwise it get down
to the bottom so instead of throwing an
error here what I want to do is similar
to here where I'm returning an error I
want to do that so if we're not able to
find a user so a user it does not exist
we're gonna return false for okay and
then Ayers is gonna be email cannot find
user with email and then off payload is
gonna be null and then we'll say here
this is going to be the password field
wrong password otherwise okay is true
errors is an empty array and off payload
has the token and the Refresh token oh
we just need to put a comma here and we
don't have to get that I was something
different that I was doing so okay it's
a bit user so let's just run through
this function make sure it's working so
first we the email that is passed we
check to see if it is there the database
we search for a user if we're able if
we're not able to find a user we throw
an error we then check the password we
got where is this password okay the
password the user typed in this is a
patched password we're comparing them
it's not valid we tell you I pad
password then we create new tokens
because they're logging in give them a
refresh
token and a regular token send that back
cool that's good
so a couple more resolved two more vote
and create poll let's copy you and do
create poll
so this is something we actually need
the permissions file for that would be
actually kind of helpful here because it
occurred a poll I'm saying you need to
be logged in so I'm gonna come over here
I do get status it says I deleted the
permissions I'm just gonna say get
checkout permissions now the permission
that I want is just logged in so cray
resolver yeah so I think it's just read
because I'm exporting yeah once in a
default so export default
and what we're gonna do is just check
for the user ID that looks good
Oh what I'm creating tokens I need to do
stuff that's gonna be an auth
when I create a token we don't want to
do is admin because that does not exist
there anything else what was I just
doing I actually forgot I have
permissions so we have this guy will say
not log and or will say you need to be
logged and - you need yeah you need to
be logged in so we're checking if
there's not a user there so in my
resolvers here for create poll what I'm
going to do and we don't need refresh so
import quire off from permissions and
then here we say require all create
resolver
so then it'll check to make sure you're
logged in oral thorough and air before
it even gets to this point so in
creating a poll what are we given the
name and the options
all right so models is defined if it
never used so let's go ahead and use
them we actually need to do something so
what we're gonna do here is do models
dot pull dot create and we want to pass
in args right that's how we want to
create the poll but notice what we want
to do here
so for poll where's poll so poll has
poll options we need to take those pull
options create votes for them and set
votes equal to 0 there in the text and
make it into an object so say Const pull
options is equal to and I'm gonna say
args there's two arcs we get right name
and options let me say options dot map
and we're gonna return an object so here
we're gonna say text is equal to X and
votes is 0 oh you know what no this is
fine yeah we could just set the default
so those things you can set the default
value in the database to zero but this
is fine so that's gonna be that and then
here when we're creating we'll pass in
the name and then pull options and name
pull options
I know you also need to include so
sequel eyes yeah we just need to go
check out the sequel eyes Docs I know
when you're creating this this is a
one-to-many relationship you have to
include it but I forget the syntax for
it so if we go to associations creating
alright so we just need to include like
that
so comma include model stop pull option
oh and the other thing is this is going
to have a creator which is gonna be the
user so user ID okay
and so the same thing we'll do a
try-catch let's say Const hole is equal
to the weight of that and we return okay
it's true errors is nothing and then we
return pool and we catch any errors that
happen and this is another one where I
actually don't know what errors all
right no areas but we're gonna have to
parse it out and so we'll leave that for
later so I'm gonna say okay is false and
then same thing with I read it up here
or I said something area but we don't
have an email we'll just say name field
for now and then pole will set to null
all right let's do vote
so it's a copy I'll be this so for vote
there's two things we need to do first
we actually update the database and then
we actually push the value up here to
our pub/sub guy so lote is going to be a
pull option so it's going to be models
dot pull option I believe it's update
it's double check we have the docs up
right here where would it be
big instances yep update is what we want
to do and we're just gonna say votes we
want to say votes is plus equal current
votes in the database so I'm not sure
how we do that so sequel eyes increment
value as what we want to do basically
oh so I want to do it in a way where I
don't have to query it first I want to
be able to update it in like one swoop
so fields equalize the literal field
plus - alright that looks like how we
want to do it so we're gonna say models
dots equalize what was it dot little dot
literal plus one so that's going to be
votes plus one and we want to update
this where the ID so that's the second
one
pull option IDs what I called it and
we'll pass it here all right I think
this is everything we just did a lot of
work well let's see how that works but
before let's we don't need lodash let's
make sure everything is working and all
that jazz I'm gonna turn the light on so
I'm gonna create the database for this
just kind of want to see what I changed
there before so piece equal create
database pull okay do an NPM start see
what happens
I'm not surprised if we have to do a lot
of debugging okay
so type off payload not found a document
I know exactly what the problem that is
so that should be a capital A yeah
so restart get booked not found Oh join
monster let's do that real quick so here
look at these nice joins that I have
here let's get rid of that okay so these
want to match up with the types that I
have so I have a pole type with a table
name pole that it might get changed two
poles
I believe want the double check that the
new unique field is ID we do have to do
a join the Warlock that later
and they also have pull options I should
just be like that and this I have to do
in double quotes and the reason for that
is because the table has an uppercase
letter in it alright so none of our
queries will work cuz we need to like
configure this but I just want to make
sure everything else builds okay it
looks like it does that's nice and I'm
just gonna split this off see if we can
switch this screen let me put this one
on top I want to do a swap but okay
well let's see so I'm gonna connect a
pole and I'm gonna select all from hit
tab so we have poles see how it added a
nested in their poles and the the other
one so we got name and creator alright
I totally forgot I didn't name the table
like that
I didn't understood did not have the
underscore there then I would need it
pull options text votes pole ID
that looks good
okay let's set up join monster now it
looks like a server started up okay um
and then we can start testing graphical
to some stuff and see how it's working
and graphical works for subscriptions
now so we can even test out
subscriptions are working when we vote
Oh totally forgot about that actually I
said that we needed to do subscription
after vote oh I didn't even finish this
why did I just stop here I have no idea
why he just stopped here guys
so let's actually finish this
yeah okay so we're gonna do a try-catch
returning true if it works false if it
doesn't and we just need to wait for it
then when it's done we want to return
yeah we'll just return pull option ID
and then we'll increment it on the UI so
what we'll do is pub/sub dot publish the
trigger name is what happened and then
the payload is an object the object here
is going to be vote happened and then
what we're going to return is an integer
here and it's just going to be the POE
option ID
so we need to change it on our schema
that's just gonna be an end
I think this is all good now so we're
pub subbing if it works did okay let's
do let's finish this now I don't think
I'm using user anywhere so I don't know
I'm gonna worry about creating the user
let's see if I can do yeah I should just
put this back I don't know why I got rid
of it cuz I'm gonna be doing this stuff
right here okay so we'll do pagination
next time so I'm not gonna worry about
that cuz that's more I mean it's not too
hard to set out it's extra I just want
to get the bare-bones
actually we're gonna get most of it done
today I'm just looking I need to go back
for the query that's what I was doing
all poles actually only pole is gonna
have something so here we're gonna say
so we need to know which pole to grab
we're gonna pass in the args
what are we passing the ID I think if I
D so table name ID args ID that's good
so pull name poles unique field the only
thing here that's going to be weird to
get is gonna be poles or pull options
and to that to do that we need to do a
join we we just need to do one join
though so I'm not go to join monster and
look up these syntax
and we can put pull option back down
here oops
nothing weird for pull options so we'll
we can leave it for that in the field
here we're just going to have to do a
joint so joining objects and that's it
so here this is gonna be pull options
table and this is gonna be pull table we
don't worry about arguments so the way
we're gonna join is we're gonna say pull
table and the ID there and then we're
gonna look at the pull options table on
the pull options table we have something
called the pole ID which matches up and
you'll notice since we have a capital I
I'm doing double quotes there alright
let's give this baby a try so let's go
to graphical and do a mutation ya
suppose we have to create a pole first
before we can do stuff and I don't
really feel like trying on
authentication cuz that's a little bit
harder to do from graphical so I'm just
gonna connect to pole and I'm gonna say
insert into poles and I forgot that's
gonna be annoying so check out poles
select all from poles okay I just need
to set these guys
I don't think created that and updated
at are automatically given to me so what
I want to do is I want to do insert into
polls and then values actually I want to
do name and creator actually first after
create a user that we can do so register
email Bob password username oops
Bob as well okay something crashed let's
see what happened
pull options not found I think I just
call that options
if not I'll check the schema but I think
that's what it was yeah okay so create
that red shirt response might have
signage did you mean register oh so okay
airs user let's go ahead and select
everything right not to make sure
everything's working do what Oh Aires
might must have
filled message all right
everything worked ok we have an idea of
one now in our database so now I can say
values name my first poll and I think
I've to do single quotes here and the
Creator is gonna have an ID of one okay
that's what I thought
I need to do created at and I think I
can pass just an integer in oops don't
know if that worked
okay I need to go like that there we go
so I when I did that back slash of
messed up stuff you will need to rewrite
or cast expression this is the type time
Sam with time zone but expression is a
type integer
all right let's look up a Postgres
insert timestamp now
current timestamp and let's do that
twice for updated out as well
all right let's select it alright so all
I did was create a poll the reason I did
that is just to get around the
authentication that we have set up
because notice if I try to actually we
should test this this would be good
great a poll
you need to be logged in and it's
annoying to try to login with this so
let's query all pols name options text
votes ID all right so my first pull is
an ID of 3 it's got no options should I
created one with options yeah I should
have which means I just need to create
options which means I need to do this
for options and we don't
well actually I need to create an option
that way can test what their voting
works so let's create an option real
quick
so this will have an idea of three we'll
call this Oh one for option one this
will have a pole ID and text and oh it
also also gonna have votes I forgot
about that votes is gonna be serial oh
crap okay good I thought I just totally
forgot all of them I forgot them on my
PC cool let's make this faster okay so
instead of poles we're gonna do pull
options wonderful now when I pull this
you'll notice I have the options for
that poll so volts votes is zero and
what I'm going to try now is to grab the
pole with ID three now instead of a ray
back we should just see that one object
and we do awesome I'm gonna save this do
a mutation and I'm gonna save vote and
I'm gonna say vote option or vote pull
options gonna be one get the boolean
back
and we don't need a selection field for
this and what I'm gonna do the tests
whether subscriptions is working let's
copy this go into another tab and say
subscription vote happened and get the
ID can't return null for a non null
field or subscription vote happened okay
so we messed up the subscription so
let's see where we messed up that what
happened int don't think that's the
problem
what happened pub/sub
huh camera turn no for non all will feel
subscription dot that happened what if I
make that noble so something's returning
null for that
now when I vote so vote successfully
happened does anything pop here
no nothing pops here so let's go to
Apollo so it's good to see how they do
it and see if I'm doing anything
different I also just got subscriptions
working on different web applications so
we can compare it against that and go to
the server that's peculiar
yep
yep
so publish comment added yeah we're
doing that so down here our resolver oh
I know we're doing around guys he this
is my bed I just need to do the
subscription here out here and it's at
slash subscriptions area so nothing
wrong in my code just forgot to add that
come on did we crash it nope it was just
being slow but what happened is still no
that's interesting
anything no okay I really thought that
was what the problem was subscriptions
yep matches up correctly
so vote happens returns ID okay get a
copy this and reload the page because I
would have thought that would have fix
everything and well we broke something I
also want to check and make sure we're
out we're actually updating the database
okay that's weird so what I want to do
now is just double check that I passed
in the right parameter to graphical
because we just broke graphical
subscriptions graphic so index so doing
that has literally owners I have all my
stuff right here
or all sigh let's reload the page and
see if it's still gone it is I'm
guessing I mean this is the only thing
we added so that must be what's messing
it up
so if I get rid of that see if it's
reloading over there you can see it here
alright so it comes back and works okay
okay how do you use subscriptions in
graphical that's the one I want okay
so we're gonna come back to that so go
back to all poles here we're gonna get
the ID options here I want the text
votes and the ID all right so we have
two votes so the mutation looks like
it's working good because we're
incrementing so let's just get the
subscription working
oh that's right either on I wasn't
supplying the whole URL and we're on
port 3000 yep
so now I'm going to switch this back to
the mutation we just had and now let's
see if we get vote happened all right go
ahead do our vote we vote BAM awesome do
it again I guess and it won't show cuz
we did the same one but that's cool so
let's see if there's anything else I'm
gonna saying we tested pull all polls
mutation wise we did these we can try
log in to make sure log in is working
create poll we'll have to test another
time and subscription working let's just
make sure logins working email Bob
password Bob okay errors fields was the
other thing message certify that and
then we also want off payload
get that token and that refresh token
and awesome logging works good so cool
we got a bunch of our back-end done
today I think next video what our next
stream I will do pagination and then get
started on the UI so that's it for the
stream guys thanks for watching and I'll
you putting this code on github if you
want to check it out so I'll see you
guys next time</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>