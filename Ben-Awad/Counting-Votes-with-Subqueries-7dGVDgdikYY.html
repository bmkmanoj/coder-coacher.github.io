<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Counting Votes with Subqueries | Coder Coacher - Coaching Coders</title><meta content="Counting Votes with Subqueries - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Counting Votes with Subqueries</b></h2><h5 class="post__date">2017-08-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/7dGVDgdikYY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right hey guys so I left off last
and this is what our app is looking like
we have suggestions that we can add to
boards we can create more boards what I
want to do today is to be able to have a
voting button right here so you can
click on this and you can vote on
different suggestions so the first thing
I think I want to do to get that started
is I wanted to do something like this
where there's a little icon on the right
so I'm gonna try to set that up so I'm
just going to look at the documentation
for this looks like they're using left
check box want to write toggle though
the only thing is they're using there's
an actual thing called right toggle I'm
not sure if I can do a right icon and
more so I don't know if I can do a right
icon and do an on click with that right
so let's see how they're specifying the
icons here like this one has a little
icon see how they're specifying it so
left icon maybe I can actually set an
icon so I'm going to try this and maybe
I can set an on click for one so I'm
gonna give that a try so if I go this is
if this is front-end code suggestion
this is just a list item let's go ahead
and add a write icon
now we want a different icon it's good
to the material icons and then we can go
ahead and pick the one we want and
doesn't look like this is loading so
let's just Google material icons and see
if we can pick out the one we want such
as icon button oh there's no thing I can
be used or included as a child further
two icons such as I complain I let you
see icon button
so I come button and you wrap it with
that so I'm gonna just actually copy
this we can change the icon out later so
paste that here and it's gonna try so
icon button and let's move this to the
next line and then in the middle action
home so say that no trailing space ru
cellent usually just like Auto fixes
that not sure what's going on there
let's see
alright so it's off center but it's
there see how it's like at the bottom
right well let's test whether we could
put like an on click on it because
that's what's important and let's see
untouched F on touch tap is equal to
console.log high area so open up
consoles and see if we get it
all right now if I click over here
shouldn't pop up good I actually think
it's working the only thing is I'm
worried this might you know trigger like
notice when I click here the whole thing
is getting clicked so if I want a
different on click for this I'm afraid
it's gonna trigger so I'll show you what
I mean by that so if we want a different
one here so on touch tap for that for
the list item itself so on so alot log
touch list item
alright so notice even though no matter
what I'm touching a list item even if
I'm touching here so that might need to
get reworked with the I continent anyway
so maybe for now we you only have to
click on the list item it doesn't matter
so let's just render the home icon I
guess see what that looks like I wonder
if it'll actually fit in the middle yep
so that looks better actually and then
maybe we just have to vote on this and
so we have the suggestion text there
should be an ID here as well go to react
we can check and make sure and what
we'll do is we'll pass the ID in there
to vote so come over here to react we
see list item yeah okay so we have an ID
that we're getting from suggestion so
what I think I'm going to do is wrap
this component in a graph QL tag so I'm
gonna say schema it's creating mutation
so we're gonna have to actually go and
do all the backend work for this but the
fronton work is super simple so we're
going to export const vote mutation and
we'll just call this mutation we really
just have to pass the ID right so we're
going to say vote on discussion and then
just pass an ID that we want and we can
just do a boolean back whether the vote
succeeded or not so we don't need to get
anything
so let's actually create this on the
back
and but first we can go ahead and call
this I suppose here so import import
graph QL the act Apollo and then here we
want to import the mutations created so
uh the mutations that the mutation
called it was both mutation or say Const
suggestion is equal to and that's our
export people so vote mutation and now
we also want to add this to what's it
called
a subscription to this so I actually
updates live so that'll be really cool
too so here we now have a mutate prop
and then whenever we touch tap we'll
just go ahead and say this thought we
don't even have to do this thought
because we have mutate here and then
variables passing in the ID that's good
so let's actually support this on the
back end so I've back in all the way
over here so first I want to actually
just get this working without
subscriptions and I want to go in and
add subscriptions to this so all right
type mutation so vote on suggestion
passing in the ID which is an integer
and we'll just pass back a boolean I
whether the vote succeeded or with like
they can't even vote right if they've
already voted once so there's a chance
it fails now let's go to the resolvers
and actually i don't even think i think
what we need to do is to create a new
database model and we make a
many-to-many relationship
in this so we know who is voting on this
yeah let's do that
so I'm gonna say vote and let's go ahead
and copy this actually yeah okay
so I was wondering if I need to make
this a many-to-many relationship and I
don't think so so vote
I call it vote actually I don't think
vote needs to have any fields all
actually I think so a user can vote on
many suggestions can a suggestion be
pointed yep actually it's a vote just a
main tomato soup with the user so get
rid of that we don't need to create a
separate one we just need to create a
mini to many relationship so I'm just
gonna come over here and go to sequel
Isis website and I believe I forget the
exact mac that we have to call to do a
many-to-many relationship I think it's
yeah actually I don't remember at all I
know it's not as many
I think it's belongs to many if I
remember correctly yeah I belongs to
many and do this so many too many with
suggestion so this is going to be user
belongs to models dot suggestion through
and we're gonna call through table call
vote I don't do i I forget if I have to
create the table or if I can just give
it a string
does it say like here's it's passing a
model I think I didn't just pass it a
stream though we'll see if it breaks I
can come back and create an actual model
but I think you can just say I want to
call it vote and the foreign key here
I'll say user ID and we can copy this
new the same thing on suggestion and we
actually need to do an association so
copy you suggestion dot associate you
don't need these two we just need that
Minnie - Minnie you're gonna say
suggestion that belongs to many user and
in here it's gonna be suggestion ID okay
so all right so we create that
Association let's go ahead and rebuild
our database so come over here to index
and we'll just say force is true now if
it goes ahead and builds okay then that
means we're good and I actually just
want to go into peace equal real quick
and what I call this boxing I thank you
and I just want to see if we have a
votes table IRA vote table and we do so
perfect so we're good so gonna get rid
of the force they recreated restarted
now I'm gonna go to the schema nope I
mean the resolver now so you can just go
ahead and make that so copy you it's
going to be a vote on suggestion and
from here we need models ever made user
I think I set up authentication for this
but I can't remember if not what setup
off so we automatically get the user I
think we have it though and then we're
gonna get the ID this is going to be
the ID of what is this ID for oh yeah
this is for the suggestion and now I
know why we need to make a sipper model
we do need to make a boat model that way
we can call it here to create a new one
so we're gonna go ahead and say vote
here and we can just copy this paste it
here this actually doesn't need any
props whatsoever or not props but it
doesn't have anything in it the only
reason I'm putting it here is that way
and we can hear it at this I suppose now
so now my user we're actually gonna be
through models dog vote and the
suggestion it's gonna be models dog vote
here so we have to force the database
again
oops but now what this will let us do
one too many so now that I have a vote
table in a resolver I can say models dog
vote create and then the suggestion ID
is equal to ID and then the user ID is
equal to the ID that we have from the
user and then and we're gonna return a
boolean here so I'm just going to say
make this an async function and I'm
gonna wait this if we didn't get an
error you return true let's put a comma
here yeah this should be spaced there we
go also we need to go ahead and import
this so this is called vote all right
might be a before go ahead and put force
and then that goes ahead and runs again
we're good so now we need to update
though our hmm what do we need to do in
our schema for suggestion we shout our
votes in the votes what this is going to
be is a count of how many votes there
are so this is going to be a joy monster
we're gonna have to join on a field so
let's see what is this suggestion fields
of votes so for this we're after a
sequel join suggestion table and this
table here
what is the table that's gonna be this
one so how does it know what to join
with this actually how was it getting
this so suggestions I guess it knows the
type votes is an end so I don't think
it's gonna know the other table that
this needs to join on so I'm just going
to go ahead and put this here and the
table we need to join with is the vote
table so we want to do this on
suggestion ID didn't you wrap that with
double quotes because there's an
uppercase I and we're gonna say
suggestion table so we're gonna join on
the vote table here where the suggestion
ID is equal to the ID of this suggestion
and then basically we just want to count
all the votes that it has and actually
don't know how to do that with drawing
monsters let's go ahead and look it up I
think there's like an aggregation
section in their documentation where
they talk about it
I'll go to the docks because basically
what we just need to do is call count so
okay the wrong kind of variation sure
let's see if we can just search for the
word count up none okay I know it's in
here somewhere I feel like I've seen it
before maybe miss Prague geez no Irish
version of joining weird cause calling
Joe a monster all right we'll just
google it then join monster count see if
we can find anything with this
yeah this is exactly what we want to do
so
sequel column count
oh this is a short saying this guy might
be have a weird query though it looks
like count and then he's doing sequel
column count star I think this guy's
just doing that weird away let's look at
a different thing here we go maybe under
aggregation I was right okay so sequel
expression actually yeah let's just go
ahead and write our expression like this
I like this
actually now cuz we don't really need to
do a sub query I like to just I'd like
to count as well I mean this would work
so instead of doing a join ok did not
copy that correctly
all right so instead of doing a join
what we can do is we can just do a
regular suggestion table we can just do
a regular query here what we're just
gonna say select cow from suggestion
table actually no this is gonna be from
boat comma suggestion table and then the
where clause for us is going to be ID
this is going to be vote dot suggestion
ID is equal to sedition table
dot ID and there should be some
arguments we passed to this to write I
can know for each suggestion we get this
a deletion table know if this looks good
I think I think this is good let's go
ahead and try to run the query and see
what happens so our servers start up we
can just go to graphical over here
actually no this won't work because we
need to be authenticated well okay so we
need authentication to vote but we
actually can go ahead and call the query
I suppose so
let's get all boards and then from there
it's go to suggestions all right we just
dropped all the boards all right let's
just start from let's just do it from
here and in our code here in our query
oh we should make this a fragment by the
way all boards query get bored I'll show
you guys how to make fragments that's a
good way to do it votes you notice how
we're copying like the same graph QL
here
I'd eat name suggestions okay just go
ahead and do that real quick actually so
we can say Kant's board fragment that's
what I'm going to call it
equals u ql and we're gonna say gourd
fragment will say all all fields Gorge
fragment will say all fields board now
let's call it all board fields fragment
on actually I think it's okay that gets
fragment all boards on the type of board
and then you put it here and then what
we want is this and then here we do dot
dot dot all board fields and then here
we're gonna put our board fragment and
we put that same thing here
yeah we do it outside do dot all work
fields okay make sure it doesn't crash
now that we're getting the board's
syntax at and here select okay so we
wrote our query wrong so oh maybe
because we needed to put it in
parentheses like I saw in that so for
the end parentheses
quiet refresh relation relation
suggestions I exist where are we
referencing suggestion not here because
I'm using suggestion table graph QL
relation R let's do our database is
saying here rocking any air is here
let's just refresh your rerun
area so left joint suggestions
suggestion on did we break the Davies we
should we should have select all from
suggestions boards they're there all
right let's just try running this see
what happens
copy this is what I usually do if it's
acting weird so a baklava so while we
were as the that should be suggestions
right here okay for whatever reason so
we're here suggestion table is wrong
this should be suggestions all right and
we don't need this anymore by the way
I'm starting to think that this query
over there is wrong everything for
counting but let's wait and see I'll be
patient all right so let's say word one
can I read ID of undefined well we need
sir you messed up something alright the
boards will not even get created are not
getting created oh we're not logged in
and we have no user so we need to sign
up actually did I create a sign-up page
to call register me
hey as what I did so Bob Bob Bob login I
know how to get these pages redirected
should not have to manually switch go
ahead and submit cool see how that
switched over here that's what I wanted
to happen
call it a s one missing votes so the
reason for that is on our update here
where's our update it's not here I don't
see an update yeah odd suggestions here
there should be another update we're
recreating the suggestion look for
update
I was just by source of that junk all
right here the two updates so which one
do we care about this one so votes is
gonna be equal to this thought props
okay so that when we create a new
suggestion the vote should actually be
zero so it's busy right here all right
refresh cs2 a break still so what field
are we missing missing votes but when
we're writing this I'm putting it here
could it be oh it's probably our
mutation so the reason why is we are not
using let's go ahead and use our
fragment thought that all fields or
whatever so import from I want to import
this guy its fragment cuz I want to use
it over there export a board fragment
and port board fragment wrong queries
and then we're gonna do the same thing
we did over there is add the board
fragment and then do all board fields I
think that was what I called it
yeah
and now hopefully it should update
correctly now we're still missing it
this is why when we create the board
yeah that's good we need to grab the
votes here that's what I was doing wrong
now this didn't actually do anything I
mean it's good to have uses the same
fragment across but that didn't do
anything that's fine okay s4 go a can't
return null for non-noble field
suggestion doc codes I did it return
null so I guess in our mutation over
here we need to actually return the zero
for votes so they'll be creates addition
so we're gonna say Kant's suggestion
it's gonna be a weight make this a sink
and then we're gonna return dot dot s
dot data values three you've already got
data values because sequel eyes clipped
some other metadata we don't need and
then we're to save votes 0y is returned
oh this should be a
okay cool you can finally create a
suggestion we added a change code a lot
of places for that all right so now if I
click on this I should vote so we should
have just voted on s4 to see whether
this actually happens since we don't
have anything showing I'm gonna select
all from vote and it did not work so I'm
not sure if the suggestion just did not
oh it devotes even though it's called
vote so called votes maybe it's all
votes I'm not sure why we have a vote
and a votes now probably because when I
did force it didn't draw so let's draw
table vote since we should not have that
anymore okay all right but this looks
good right
so in votes here we have user ID
suggestion ID so now if I come over here
to graphical now I want to test and make
sure that query that we made earlier
works for counting those Oh should be 30
30 should be my server not my client so
all boards all I care about is these
suggestions and then the votes
let's do also the ID so we know what
voted this a relation vote does not
exist so that our metadata over here we
need to save both
we're on it
okay so everything has a votes of 1 and
the reason why is we're just joining on
the table right oh this is actually
really bad what we're doing it I just
realized what we need to do right so
what's gonna happen is when we do we're
gonna do a rest sub-query for each
suggestion so when we run this we're
gonna do five suggestions here that's
really bad we don't want that also like
the queries wrong right because we're
getting one for everything what I think
we need to do is pass the ID so sequel
expression we want to get the ID of this
suggestion so here we're just straight
getting all the votes in the world right
we need get the votes for suggestion ID
that we care about
I'm just going to see what all the
values of these parameters are if one of
them is like so what we need one of them
to be is the current suggestions ID this
thingy maybe it'll give it to us and
then we can actually get this to work
but either way if we can get it to work
its complete trash right so undefined
there's this thing I don't think this
helps us alright this is not what I want
to do anyway here's the query that I'd
like to run so something like select
text from suggestion comma ID also count
we can count like that I think yeah
actually
so that does
my superior bylaws I don't know if I can
count and select at the same time let's
see if that's possible so count and
select
so will count and select rose yeah
that's what I want to do
you know somebody want to do I don't
think that's possible kaguro the big
table is known to be slow to get a
precise number it has to do a full
calendar rows due to the nature there's
not as sub dramatically if the cap does
not have to be exact
like it seems to be in your case looks
like we have to do a two separate
queries better yet
okay here's what we're gonna do instead
speed this up
because I think I have an idea let's
just speed this up reading this it looks
like we can't do what I want to do I
don't think I should I don't think you
can select and count at the same time
right that doesn't make any sense so
what we're going to do yeah so what
we're gonna do come back over here to
our and let's swap since we're gonna be
doing a lot of database stuff right now
I'm going to swap these two for easy
access all right so we don't want to do
this I want to go back to the inner join
I want to join on this so the suggestion
table and now was not even working well
I'm just gonna write my own query here
so should we need to pass it the ID
don't I know we have the where clause in
there anyway okay so suggestions the ID
is equal to votes dot suggestion ID
right so this will not be correct out of
the gate because we're not counting the
votes right votes now is gonna be this
this thing I know I want to see what
happens when we run this I don't think
it's gonna work but I think it's in
Italy just wherever you want to go and
so calm suggestion dot boats just exist
what that's fine all right
so eight column suggestion oh because
I told you the sequel joint and if
should know to get the votes I want to
basically do a custom resolver for this
so we have the votes I want to do that
this is tricky to get with joint monster
actually this particular field we'd like
to just resolve okay so you want to do
it joint on it we need to we need to
join on this table and then we need to
count how many exists I don't know what
the best way to do this is I don't want
to select here's my idea so we do
something like this right a copy yeah
here's the sequel I really like to run
so something like text from suggestion
and all so let's get the so text comma
user ID from suggestion comma au and
that should be wrapped in double so
they're gonna be votes
we're both suggestion I was seeing if it
got please suggest I need the clean with
it I think I ever did something wrong
because we're not all you're completing
anything so suggestions naughty okay so
that worked cool so we're joining on
this table yeah did not work how I
thought I would this is only getting
suggestions with votes not only do we
need the votes
we need everything I guess there's outer
joins
what's a lateral joint I've seen them do
lateral joints to basically I have to do
this fancy sequel statement to get this
to work I think I was a lot of trying
keyword can reseed sub-select
i just want to see example of this left
lateral yeah it's something like this
actually
I think all right they're doing
sub-queries I don't actually I don't
think I think maybe so Cruz is the only
way we can get this to work all right
I'm gonna do some queries for now but I
think a sub-query is just the worst
thing in the world
it just performance-wise I think it's
gonna kill us okay so we're gonna select
text and call the SP
okay so we're gonna select the text from
suggestions and then for each suggestion
what I'd like to do is select count star
oh let's get the ID too so select star
from loads where ID which we grab here
loads dot sedition ID okay cool so this
gives us back what we want so we get
every text and then the votes counted so
let's go ahead and copy this and we can
put this back
so this this is the sub who you wanna
run yeah let's see if that works
yeah how long ID is ambiguous so let's
see the sequel that it runs back here so
we want this way oops there we go run
that voila and we're working so now we
get that bullet to count what we like
so now instead of putting a stupid house
here let's see if we can put the number
so okay now we have the DB setup how we
like you can give back to our client and
let's go to know this is the right place
and grab loads and then here I want to
show what the value of boats is so see
if there's a way to just like put a
write something on the right okay put it
like the right side right toggle right
out of tar
this is exactly what I want
I didn't know they could do a right icon
button okay I need a add this this is
how we're gonna vote in the future all
that a second though okay well for now
for the primary text will say this and
it'll just put a space and it will put
the votes for each one
all right so now if I vote on this one
nothing happens because we're not
updating the query so you do that but if
i refresh we should see a 1 there and we
do cool now if I click it again cool we
get a validation error because you can
only vote on it once
um I hate how many times we're doing sub
queries I don't know if there's a cool
elegant way to do this without sub
queries though not to think about it but
let's go ahead and fix this with a write
icon button
grab this import on touch tab will do a
mutation so I'd like to mutate the boat
now there so actually I'd like to just
kill this guy put him here nice let's
see this in action
wait I was like why had this and add it
this should not be his I don't know why
this popped up
so clicking this should be do nothing so
if i refresh that should still be a zero
on s3 nice but if I hit the home shoot a
validation error yeah perfect
love it and we get a nice ripple effect
too cool now I'll be voting on this all
right now let's see if we can make it to
where we update this right away so soon
update copy the syntax here and I think
that's it's what a key next to props are
not props a key next two variables yeah
actually look we can copy this whole
thing because optimistic UI would be
handy for this as well actually ah here
I was about to update this but we're
gonna be using subscriptions so I'm
actually not even don't worry about
updating this creating an update because
what's gonna happen is when you click
this first subscribe to updates for when
it is incremented so we'll just pop get
a new one in there alright this looks
pretty good the voting is well underway
I just think I figure out how the heck
I'm I do this this count thang
let me know if you guys have any
suggestions on how to do this to grab
the votes maybe I need to rearrange my
schema a better way to support this not
sure but yeah alright I think I'm gonna
stop here for now next week I will do
subscriptions for sure I said I was
gonna descriptions now but a voting took
a lot longer to get set up so
next week subscriptions for sure that's
what's next to do so thank you guys for
watching and I'll see you next week</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>