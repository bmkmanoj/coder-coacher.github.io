<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Couldn't get cookies working with Slack clone | Coder Coacher - Coaching Coders</title><meta content="Couldn't get cookies working with Slack clone - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Couldn't get cookies working with Slack clone</b></h2><h5 class="post__date">2018-04-10</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/24riuhr3Hmo" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey guys so I was working on updating
the slack clone to use Express session
and I didn't realize until about 15
minutes and that there would be a kind
of big problem so I use create file link
this is one of the files in the project
and what this thing does is it creates
our own link and the reason why we
created this was to send files to all
our Apollo server and this worked great
for that but it costs it's for whatever
reason has trouble sending we're not
sending but a cookie has been ate being
sent to us but we are not storing it and
and I had this exact same problem with
Apollo boost for some reason the exact
same code would work with a CP link but
it would not work with Apollo boost and
it will not work with this I'm not quite
sure I would did have to dig quite
through the code and I don't really want
to do that so I'm not unable to really
try to convert the slack clone over to
using Express session but I kind of
started it and my plan is to do I'm I'm
working on how to do cookies and
authentication and when I finished that
I'm gonna be doing a new series and with
that I'll be showing how to do
authentication with that so I'm sorry I
cannot get the slack working but we will
be doing some a new project in the
future with how to do it basically there
would be too much code that I would need
to uproot from this project that I think
it's better off to just start fresh
because we'd be basically just
destroying a lot of code and I think
actually I think creating a slack clone
from fresh would be easier than trying
to go in and fix this because now I
would have to remove this piece and it's
kind of like a chain effect of removing
pieces but anyway yeah so sorry I
couldn't get this work we will be
getting this soon but I did actually
record like the first 15 minutes of me
trying to get this to
work if you'd like to watch that after
I'm done here I'll cut to that and you
guys can watch that if you want to but
do note nothing works I don't get it
into a working state but you can see how
we fail if you'd like to and what I want
to do tomorrow also is show you what I'm
talking about with if I can show you
with Apollo boost and issue P link why
for some reason cookies will be set with
one but not the other so that's it guys
you can either stop watching here or if
you want to see basically the project
not work you can continue watching from
here that's it see you next time
hey guys so I have gotten multiple
suggestions to see how expressed session
would work with the slack clone that I
made so today that's what we're going to
take a look at so I haven't actually
looked at the code for the slack clone
in quite a bit so this is gonna be
interesting
basically they're just gonna do some
live coding I thought that'd be more
interesting give a different perspective
than just already having it all coated
up so with this I'm currently on branch
52 on the front end
52 underscore ec2 so here I'm going to
just create a new branch called cookies
and I'm gonna just work from here on the
front end and I have it up and running
and then here's the back end we're gonna
do the same thing so I'm on branch 56
underscore auto deploys and then we're
gonna do check out cookies so I'm on new
branch and we're gonna start from here
start from this point and haven't really
prepared anything or looked at the code
so the first thing that I want to do is
I have it opened on the Left here's the
slack server
I have index J s
just to add an express session so I
guess I'm just gonna say are an ad
express session and if I come over here
I have the github open for the Prisma
tutorial that I did with cookies so I'm
just gonna copy the settings that I used
for the session because it's gonna be
the exact same so I'm just import
session from Express session and then if
we come down here I'm just gonna add it
right here so app use session
now ideally we have this in the
environment file but I'm just gonna go
ahead and make my secret like that and
alright this is pretty much set up for
our session now the other thing is cores
so with that we need to set credentials
to true and then the origin
and if I come over here I think the app
yep app is running on low close 3000 so
we're good keeping it on that origin
there I could add another one if I want
to test this in graphical but we'll
leave that for now okay so now we should
be able to send cookies down at least
and one way to test this I guess would
be to make this true but I'm pretty
happy with this what it is right now so
what we did before
is we had this add user which would read
in a token from the header and then we'd
set the user based on req dot user so
I'm basically gonna do the exact same
thing but with sessions so we're gonna
add add user here we go I'm surprised
didn't add the user right here I guess
that doesn't matter so instead of this
I'm basically going to add user two and
we're gonna create this function right
here so add user two and this is going
to take same arguments as usual so
request/response next because this is
gonna be Express middleware right here
and so all we really want to do in this
is to get the user and set it on the
request so request that user so to do
this I'm going to say request I user is
equal to request dot session that user
and that's it so after that I'm going to
return next and we're good now
guess I just need semicolon there so I'm
not gonna worry about any of this
refreshing stuff because I'm just going
to basically have it last for seven days
or you know what if if I'm doing it like
this I'd rather just have the cookie
last a long time so we'll say 365 days
time 7 so what is that seven years now
okay so we have our cookie lasting for a
long time and I'm not going to store
anything that would change in the cookie
or at least in the session so I think
we're good
and what else do I want to do with this
it's not happy cuz we're not using it
that's fine I'm not even bother
commenting it out so we have that set up
we have our add user and we need to
actually add the user when they log in
or what not I don't think we're gonna
have to change any of our permissions
because with permissions what I would
look for is the user in the context
which it gets passed in the same way as
before I think it's just what off is
what I had it in so here's all this
refresh token stuff and in my index I
now just need to pass another thing into
my context and that other thing is the
request object so now that I have the
request object in my context and off yes
when I try to log in cool
what I can do now is instead of setting
tokens and what I think I'm gonna do is
at first make this not delete any code
that is here so maybe in that case well
you know what we are a deleted that code
might as well start harvesting so now
we're only going to return basically
true or false here which means we're
gonna have to change our graph QL and I
don't need to worry about creating
tokens so we fetched our user and
actually I guess let's do okay is true
we fetched our user up here so we can
say request dot session dot user is
equal to and I think we just stored the
user ID in here so I'm going to say user
ID now we now need to pass in the
request and I don't think I'm using the
secret anywhere we are using models so
I'm going to get rid of the two secrets
and so now we're just gonna pass and
request when we try to login so this is
gonna be our resolvers the user resolver
so here I'm now gonna pass in your class
project
and we want to basically do the same
thing for register actually no we don't
I forgot with this one we're not
actually giving a token back and they
register which is okay okay so I think
we're good at least a cookie should be
set when they login so I'm sure we're
gonna be causing errors left and right I
was about to run it but what I want to
do is update my graph QL and I forgot
where I put that schema user so now I'm
login the log in response it's just
gonna be okay and airs which I want to
say I call made something called void
response maybe you know I didn't so this
is fine but I also need to update this
on the front end because now I'm
expecting two tokens back when I login
so that's over here in the client and
routes login that looks like the right
place
and so now I'm setting these tokens so
not gonna do that anymore now this might
break subscriptions though because I
believe I'm setting the token and
subscriptions will have to worry about
subscriptions I think at a later time
oops okay so now we're not getting or
setting the tokens when we login so now
I need to change the actual graph QL
which is down here and now I'm not
expecting a any of those tokens okay so
I'm gonna leave these windows up and
let's just see what kind of errors we
get so I guess sign up or maybe I call
it register
okay so I'm gonna call this tonk I'm at
town calm all right looks like we got
data back no problem and let's open up
the application and now I'm about to add
this and we expect to get a cookie back
but I don't think we will and the reason
for that is I forgot to make one change
so an Apollo now what we need to do is
in our HTTP link which where is you here
we go we just need to say credentials
and I think it's me is it fetch options
I don't even remember what it's called
and we're gonna say include I don't know
if that is the right thing won't tell me
oh this is create file link oh we coded
this I forgot we made our own file link
so we should be able to just see all
right so we're expecting credentials yep
so we actually are using credentials so
that is fine to pass in so this is
actually going to be the the deal
breaker right here so whether or not
this works is that file link so let's go
ahead and let me click on it
these fields are just like not
accessible for oh that's interesting
none of these things will let me click
on it I'm not sure if my computer is
there we go I think I was just focused
on that other Visual Studio code instead
of the Chrome for some reason okay so
nothing happened I'm assuming an error
occurred no it's it okay true and let's
look at the network so I want to see so
we got set cookie back here but we don't
see a cookie here which is unfortunate
and what else I don't know why we didn't
change pages actually I do know why we
change pages we didn't change page pages
I think we changed pages but change back
right away and let me show you what I
mean by that so we have this thing
called a private route
and in the private route we call it
authenticated all right so this is an
authenticated function checks whether we
have a token and we don't have a token
so that's why I revert it back so this
is something we'll need to fix because
we no longer will have the local storage
tokens but before we fix that what we
really need to fix is the cookies not
being saved and that's gonna be because
we're sending the token back there's
three things that could cause this
problem one the cores aren't working
correctly but I think we're fine with
this and the session cookie is being
sent back my guess is it's not working
here
so create file link is not working for
some reason so I'm passing in
contentions include this part is what we
could be having problems with so if I
look at my create file link code it is
called credentials so I am passing that
incorrectly and we're setting fetcher
options credentials in there I guess I
can look at the my request header
whether it has credentials include or
not and it does not look like it does
and I think it should so what I'm gonna
do is I'm gonna try hard coding this so
I'm gonna say so notice how we did if
credentials we have this I am passing it
in so I'm not sure quite sure why that's
I don't really want to debug it right
now so I'm gonna say put your options
doc credentials is equal to and include
now I could be wrong but I think we
should see I guess we're not saying
fetch your options header we actually
might not be seeing this holds out
another console.log bet your options
so we'll see if it's getting the
credentials before we set it right here
it looks like it actually might be I was
thinking we would see that value in the
header so submit wait this coats not
even getting around that's interesting
okay so response headers allow
credentials is true network tab still
doesn't have it and I see nothing here
I'll honestly have no idea with this and
we never console.log to this I mean this
is never being run I mean we can just do
a nice little console log of it and see
we should be seeing something I would
imagine there we go that's better
so here my fetch options so before I
wasn't getting it so okay officially
credentials is include which is correct
and I guess Apollo
graph QL what we can double check that
that's what we need to do which I
believe it is if you go to client react
and authentication okay so you can
either do same origin or include so
we're not on the same origin so include
is the right thing for us and just make
sure yep cookies still not being set and
my guess is
it's buried somewhere in this code right
here so it's in the create file link
somewhere it's not being correctly used
which I'll just
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>