<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>I try to do a Login page in Next.js | Coder Coacher - Coaching Coders</title><meta content="I try to do a Login page in Next.js - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>I try to do a Login page in Next.js</b></h2><h5 class="post__date">2017-07-10</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/HmwEGkBKb2s" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">what's up guys so we have a register
form right here in next GS and we're
going to create a login form this one's
to be cool when a store credentials and
local storage that way we can save them
and persist a login session so what
we're doing today if you don't have this
next j/s server and the graph QL server
setup that I am using I have links in
the description below to set you guys up
so other than that let's just get
started
so here's the code for the front end
there's the one small thing we have
changed in the backend really quickly
and then we'll hop into front-end code
and do some react and that is in our off
folder so or off file so we're doing try
login here and we are doing it with the
user model but we do not have that
anymore what we do have that but to
check at someone's blog then we needed
to get their you email and password
which is in local off now so local local
off and then we're going to find where
email all that stays the same we're just
literally replacing it with local auth
pass in a little cloth here so this is
kind of interesting what are we going to
store in our tokens here all right
so I actually don't know so right now
the biggest thing is the store whether
the person is an admin so that would
involve giving the user ok so to get the
user we are going to do comp user oh
wait I'll think we didn't have to add
the stuff but I actually want to so we
can pass the user and store the user and
create tokens so model user dot find one
where ID is equal to the user ID that we
have from local law the user ID and this
will be overall query two
so we save some data and I just want to
point out there is one thing we could do
to speed things up
and as the put this user up here right
or to do it here and run in parallel
either these but I'm actually just going
to put it down here I think because I
don't want to call it try to get the
user and let's see actually well first
off we have to fetch it here the only
time we would have to do it is have the
opportunity so so what I'm thinking is
we could parallel when we're doing users
as you've seen before run do promise
that all you can run two things at once
I was thinking you can parallel this and
this but you can't because we need local
off to know which user to get but we
could parallel the checking of the
password and getting the user but I
don't think it's worth because there's
going to be times when getting the user
is wasted because they put a bad
password so for that at times we're not
going to worry about it
so we're just gonna put it down here all
right so get the user and then up here
make sure that we are grabbing the ID
and is admin alright and the backends
good to go alright so we have a register
form and we actually have a login on the
front end and you can see this is doing
Oh auth before but I officer my off will
not work right now because I do not have
in grok up and running but what I will
do is go ahead and copy register and
paste it here and basically just
override our login page so we could add
a link to Facebook so awesome I can't
worry about it because it's not I'm
going to work I'm just gonna do a
regular log in here and for regular
login we just need user name and it's
admin for the email error for the
state's here we are just going to be log
in with data we're going to need we're
not going to need a checkbox we need
input fields need button need head we
need react this we can we don't need
this we don't need to do checked it's
just going to be value because we're not
during a checkbox on submit this looks
good we got the head being the style
sheet for our aunt to be here we only
need a couple input fields email and
password
don't worry about checkbox and then down
here we need to create a login mutation
and so let's go to locos 3000 slash
graphical and if you can actually build
our mutation here so we want a email to
the string and that is required on a
password which is a required string as
well and then what we want to do is
login email dollar sign email password
password and then we want to get our
tokens here so token and refresh token
and let's prettify and we can paste this
guy in here and getting rid of our
register logic all right here we're
going to use our login mutation and then
here is going to be log in and we're
actually going to bust through this
really fast we already have our login
form done guys alright we're not quite
done because in our mutation here we
actually want to save it and local
storage like I was saying I think I
created a bob user I cannot remember um
we are loading a little slow alright so
I think it was Bob at Bob calm if not
that's cool too so we can expect to see
if we're getting and looks like it
worked
otherwise we would have gotten something
here right so what we can do is we can
see what the response is so calm sponsz
and we're going to wait the mutation
and we can cause without log response
I'm not sure why this stop crops oh yeah
why is this read my pious Lent is
picking this up as an air for some
reason , is expected contra sponsz I
might have like a small area missing I
do
Oh cuz it's on a sinc function there we
go
those are recognizing the await command
all right another cool thing is we're
using Apollo Apollo actually has a some
dev tools that you can use for Chrome
this is a extension and you can actually
see the mutations that are fired off it
looks like we have some area so - it's
happening here cannot read properly call
of undefined can either you call um I
actually have no idea what that's from
I'm actually just going to reload the
page and okay so email here we're going
to flip dog calm and we're going to
submit and we can see what it is and
nice so we get the data logger and
refresh tokens here so what we can do is
we can say local storage set item and we
can set the token that's going to be see
what this was response dot data login so
you get Kant's token refresh token -
refresh token is equal to response data
log in and grab the token store it there
and refresh token stores here
so now refresh our page here and if I
log back in with the user that I've
created um nothing happened nothing is
happening so if we click on the network
tab we can see if we fired off something
to graph QL and not sure why the clock
will stay here come over here the
network click on that and it looks like
webpack is taking a really long time
it looks like graph QL was actually
fired off if you go to Apollo here I'll
tell us mutations it looks like there's
two and I have a feeling I just need to
refresh next you have two acting a
little janky right now all right submit
nothing I wonder if this is us this
could be enough problem this might not
be Oh
I'm no longer printing this out I'm just
a newb we're good I wasn't printing this
I thought I thought it was going to come
up here with opinion okay but it's a
good application we see refresh token
and token awesome all right so now what
we can do is we can actually redirect
them I'm going to create a page called
off let's say new file off and this is
going to be just a page that requires
you to have authentication to see what
is here so we're going to export default
and we're going to have some stuff here
and actually we're going to make this a
function called off because we're going
to wrap it with some graph QL stuff so
we can get data once you know this looks
fine log in I'm going to grab the head
piece here so we can get some
ant design on this page and I'm going to
grab the imports here
we don't need react I don't think I need
those we will use these guys I'm going
to wrap everything there div and let's
just make sure this renders okay so it
doesn't see the path oh we weren't
exporting it we need to export it down
here
explore its default ah all right cool
so we need to call some kind of graphic
elph so let's come over here to our
schema and let's call user user has a
username and email let's forget about
email because that's harder to get
boards and then we have all users so
let's make all users have to be
authenticated to see all the users so in
my resolvers here let's just make sure
all users looks good
and user board suggestion query all
users awesome
so all users here models dot user dot
find all okay looks good I think we do
have an error just in the database with
a field others know the username and a
schema cannot be null so we have to
change this because basically a username
in our database is null so you need to
be able to return null back these all
good is admin you will always see - ok
so all users like I said I wanted to
require authentication and for our
server to require authentication we can
use this require off acquires off dot
create resolver and we pass our resolver
in and that's it
and here this model that user got find
all looks good okie-dokie and in our
index here you can see this is our
passport stuff this is for Facebook
we're still checking the user here
and passing them in right here so we
should be checking whether the user and
if we go to permissions and requires off
we are checking whether there's a user
and a user ID all right cool
all right hop over back to the front-end
let's actually execute that query so the
query I wanted to do was all users and
let's just look at their ID and their
user names and if I run this here I
should get a problem not authenticated
cool because we're not an authenticated
user here but now that we can login here
we are good to go so we're going to
paste in our query and we're gonna say
with data so let's grab with data here
as well if you guys were not watching
the video when we hooked up graph QL
with data you need to do every time you
want to you need to wrap with data over
your graph QL object every time you want
to do a query of mutation anything with
graph QL that's how we set up with next
yes and am I just missing it don't think
I'm missing one Oh what it once is a
line at the bottom I think no expected a
but I review excuse me guys expects
another print see from what though
okay went away sometimes this one is a
little buggy I guess with this editor so
here we can actually grab data right and
we can
let's just see what the data we're
getting right so if I come over here to
slash off if we did this correctly it
doesn't look like we did with data graph
QL query ah I'm not sure what it doesn't
like we did it exactly here um I mean I
concur Oh hehe there we go I was not
calling graph QL correctly it's not two
parameters it's call function like that
okay so now when our off now
authenticate it interesting so let's fix
this bug that we have so we have our
refresh token and our token here so we
should be authenticated right I don't
know why we're getting that maybe it's
just because this is throwing an error
and that's why but let's debug this on
the server so here is my terminal I have
server up and running we are going to
see the problem that we're getting for
our index so is the problem that the
token is not being passed actually
that's exactly what the problem is the
token is not being passed I forgot about
that part let's do that right now so we
were not passing the token automatically
so we can actually do this pretty easily
we added subscriptions here this is
something called middleware that we need
to add so graph QL middleware and this
is Apollo
and this just intercepts basically your
request and adds in authentication so if
we go to for example react here and we
come to authentic Asian notice this is
the recommended way to do authentication
we're going to follow it to
authentication
you can do it through a cookie header
and we do it through header here we go
so as exactly how they say we're going
to do it through local storage and it's
going to look just like this so we're
going to copy this notice how this is
our network interface that we're going
to add stuff to so in Apollo in it is
where we set up our network interface
and the a client side also called if
it's not the client we're building it
here and this is what this is basically
the meet
it was setting it up on the client side
so we want to do it here and so we're
going to paste it here and we're giving
it I don't know if you need to put this
before we actually create the network
interface advanced subscriptions but I
think it's probably a good call to do
that so here like it says we're checking
if there is a header already if not
we're creating headers then there we're
passing our token in now we called our
thing our two things are called X token
which is local storage kit item token
and we get rid of those maybe or this
comics it's self-explanatory and X
refresh token I believe and if we hop
over to the server we can see I put
another dash here so let's put the dash
here so what's going to happen is every
time we do any type of query or mutation
it's going to run this middleware and
this middleware is going to say look in
local storage actually we're making this
on the server side so I actually I
actually don't know if this will work
we're about to find out if apply
middleware is run on the client side it
will work because it will get the local
storage so they might actually need to
console this out to see if if something
doesn't work we're gonna do some console
logging here figure it out and here we
need to get refresh
and we're calling you a refresh token
right we're gonna login yeah so I'm this
is my assumption I'm actually not sure
how it works in XJS I I think this runs
on the client side the supply middleware
every time we make a request and it's
going to grab the token refresh token
from local storage pass it to the header
and then we're going to grab that header
with this middleware we have in the
backend
alright let's check this guy out and see
if it works not authenticated so nothing
happened so I'm going to say console dot
log middleware called
so we can see when this is called and
then on the client side I want to do
some logging too and just say console
logs token so we can see if a token is
being passed to the server all right so
we run off we're not seeing any console
logs statements here so I'm not thinking
this got run and if I come over here to
the server code I don't even see where
the token is I just see a bunch of
select l3 so let's run it one more time
to make sure not authenticated good here
yeah undefined
okay so token is not being passed so
that means we need to figure out how to
get this thing working we're creating a
network interface here if we're not
getting one I'm curious if we need to
add it here as well so we're going to
say if and I Const
network interface is equal to NI we're
going to say let so now we can do that
cases here so I'm moving up here so we
can do that middleware on this guy as
well so I'm going to say network
interface is equal to network interface
and we're gonna that's what we're going
to actually create here and then I'm
going to create a function for this
middleware that we can use let's
actually just I'm going to copy and
paste it this for speed and then we'll
refactor it if it does work okay so now
if I rerun this local storage is not
defined Network here so it looks like
this is being called so we only want to
do this if local storage
like this is where we want to add it
possibly middleware called and I think
that's actually working now I think okay
we need to put in both places I think
and let's do if the local storage down
here as well this is going to be
middleware called - this is going to be
middleware called one and now if we run
that local storage is not defined okay
why is that air happening right because
we're checking if local storage here and
we're checking if local storage here
that actually should not happen Network
air local storage not defined it
possible it's happening somewhere else
no it can't be
it was working a second ago like we saw
it work for just one time I'm going to
try commenting out this middleware see
if that does anything local storage is
still not defined um here's what I'll do
I'm assuming this is what's crashing it
here so just to check to make sure this
is what's crashing it we're going to
comment oh I think it's possibly this
statement that's messing things up
because I'm doing if local storage and
local storage is not a thing I think
there should be a way to check if we're
on the client or the server side so what
I can do is
we need to somehow know from the client
or the server side and I don't know off
the top of my head where it tells us in
here let's just try doing Apollo client
here
so if Apollo client exists then we run
all right we're getting not
authenticated interesting middleware is
never called well this is fun I have no
idea where to add this let's just
instead of debugging this forever next
j/s middleware Apollo middleware to add
this guy in add log in slash
authentication example this is not
exactly what I want at all actually
going Emira not not even a look at that
I want to look at this one more time
actually so the problem we're having is
the tokens not getting set okay the
problem we're having here is middlewares
not even being called like forget
setting it we're have to console log
statements right actually we have a
bigger problem guys I'm pretty sure the
middleware is being called on okay so
the reason why graph QL is so fast and
okay so the one reason my server
rendering is cool and why it's a thing
you should do is it does part of the
render on the server side I actually
might do a whole rendering on much for
sure and then it comes here right so
it's actually doing the graph QL query
on the server side so we actually can't
store this in the local storage we need
to actually store this in like this
server somewhere so let's look look this
up and see if there is anything so there
needs to be like a local storage for the
next year server so just literally
explain one more time what's going on so
the reason why this is not working and
I've just realised this will never work
is because we're doing graph QL query
from the next j/s server then we're
rendering it right so what's going to
happen is we're checking for local
storage right to go out in vacation
that's not going to be there because
local storage is only client when we're
making these calls on the server yeah
authentication token storage this is
exactly the problem we're having
let's see basic check I think it should
be putting a cookie as well I actually
have another question okay so maybe you
need to do a cookie for this reusable
authentication helper across pages ok
we're here we're just getting back ok
let's see how they do this thing has got
a lot of both I think to make sure it
did yeah get token utils handle submit
all right I actually don't know I don't
see anything here that persistent
storage like set token there saying
stuff in local storage how are they
getting that though because we're not
even going to be able to get the token
and get these things until they're on a
client-side I guess we should look here
you also ervice and let's see where
they're using off service so they should
be calling get token wherever they're
calling get token yeah look at that
they're not even call and get token
anywhere as I say because I don't think
getting the tip you can't really get
tokens and next yes not that I know of
what's this guy doing violators as a
result and auth0 okay we don't need to
use on zero the cookie brush media
services I'm probably doing the firings
fairly trivial maybe we just have to use
cookies guys I haven't eat cookies
before for this I always like doing
local storage from play-doh so I'm
learning a lot actually a starter kit
all right I'm done with this all right
guys we're just going to rage quit this
so the next guess is not working for us
at all it's being a little bit annoying
here so local storage we can't get set
up to show you guys this I think I'm
actually just going to rate whit next
yes I'm not liking it at all these all
these annoying little things that keep
popping up what I think I'm going to do
is just pivot we're going to do I want
to show you guys how to store this stuff
in the local storage and create a login
page and that sort of thing how I like
to do things and I'm just going to use
the create reaction work
create create react app framework or not
framework starter kit
I really like this one it is not server
rendered and that's why you'll see
there's a lot of differences right here
so I'm going to be using this I'm just
going to start from scratch the front
end and create a login page register and
login page they'll be really fast
because I've done this a ton before next
yes is being annoying I am kind of like
done with next yes I'm not happy with it
right now there's so many quirks I don't
like so thank you guys for watching I'll
see you guys in the next video
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>