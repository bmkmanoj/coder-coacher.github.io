<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>GraphQL Subscriptions with Prisma - Part 21 | Coder Coacher - Coaching Coders</title><meta content="GraphQL Subscriptions with Prisma - Part 21 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>GraphQL Subscriptions with Prisma - Part 21</b></h2><h5 class="post__date">2018-02-20</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/lvuN_dqyk88" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey guys I want to give Prisma
subscriptions a try and to do this what
I'm going to do is when we click on a
number here it's going to increase the
price by five kind of like bidding and
you can bid as many times as you want so
gonna be very simple you just click and
then I want this to be all the phone
clients that are connected to be able to
see the price increment as I click the
button so I was going to create like a
separate mutation for this but then I
was like there's really no need to write
we could just use the update function we
already have so what I'm gonna do is
make this basically create an on-click
for the price by creating a touchable
opacity and this is something that comes
from react native so touchable opacity
and we can just import this from react
native so touchable opacity and then
down here we can say on press we want to
do something so when we press this guy
on press we would like to increase the
price of this right so I'm gonna say
increase it by 5 every time so to do
this we're gonna call a mutation and we
need to know what the item is so it's
alright that I'm creating a function
here cuz we need to pass the item as a
parameter so we're gonna have to create
a new function one way or another here
so I want to call mutate or this dot
props that mutate but right now we don't
have a mutation on this well I guess we
have one mutation deleting a product we
also want to add a update similar to
what we do for the egg product over here
so I'm gonna copy this and paste it here
and now for this one I only really care
about one thing and that's the price
changing so I can get rid of all these
other things and just pass the price
event so now I'm gonna use the mutation
here so edit graph or edit product
mutation and now you can have multiple
mutations added to a component like
we're doing here but notice how this the
delete is using the keyword mutate and
this would also be using the keyword
mutate to call it so we need to give it
a name so that way it's not called
mutate so I'm going to say edit product
and we can just say edit product mutate
so it's very clear so then this is what
we're gonna call enter function here
alright and are we getting this from our
poops we're getting this from our props
and so we can say edit product mutation
or not mutation mutate is what I called
it and so we're just gonna call that
down here they're real
edit product mutate and so for the
variables we're gonna pass in is the ID
so the ID is item by ID and the price is
gonna be item dot price plus five and
we'll give that a save so now when I
click this hopefully the price goes up
eighteen dollars and oh interesting it
there was a little bit of a delay and
then it did go ahead and update I was
expecting we needed to refresh like that
to see the price so I'm really surprised
that it actually update updated like
that I don't know why I don't know if I
the products query is just like
occasionally polling because it
shouldn't be I'm just gonna format this
real quick okay so now I want to make it
instantaneous whenever I click on this I
want to see it update right away and
holy crap it is I wonder if
subscriptions are like
automatically or something I didn't
think they were cuz like look how fast
that's updating that's pretty cool if it
is let's go ahead and add subscriptions
and see what changes so right now we can
come over here to our database and we
can check out this is our application so
I ran this with NPM run dev we don't
have subscriptions set up yet in our
database though you'll notice we
actually do have subscriptions right so
I can subscribe to products so I can
over here so okay it doesn't like it
let's just refresh there you go
subscription and then I'm gonna just
subscribe to products right now and I'm
gonna say where and I'm going to say if
we click on this we can see what our
options are what we want to say is
mutation in patient in and then update
it so whenever this is updated I would
like to give the name so I guess the
node which is the name and the price so
run that so I think over here we should
be able to get any subscriptions that
come in so now when I hit that and pumps
up to 16 we see it pop up over here and
these two are unrelated right so that's
what subscriptions are gonna give us so
we can stop that so I want to be able to
access this so this is our database
right so how do I bring this
subscription over here to my application
well if we come on over here to our
schema I actually like the subscription
exactly how it is so similar how we're
able to say query dot products
connection I can say
description dot product right so this is
the outer one so if we come over here to
set how I knew to type that is because
it's called subscriptions here so just
kill the s and then product is the name
of it so now if I hit save and I come
back over here and i refresh this can't
be reached we need to give it a second
to restart and I can pull it up and see
all right it looks like it finished
looks like it's still pulling there we
go so subscriptions is now added to the
app took a second but we are there so
nice so I'm pretty much done with back
end all I needed to add was this because
we want to get the exact subscription
that's already in the back end so now
with Apollo to actually add
subscriptions what you do is you first
and here's a little page on it so we
need to install the Apollo link and
setup a new link so we can copy this and
I'm gonna come over here to my client
and on the yarn add Apollo link and then
where we set up Apollo so in our app to
s oops not an app index such as I mean
we set up an auth link right so now
we're also going to set up a WebSocket
link so we can copy this and copy all of
that and paste it in here
so this is gonna be our WebSocket link
and then here the same URL that we use
here we can also use for WebSockets a
little close four thousand but notice
the difference instead of HTTP we put WS
in front we're gonna say we want to
reconnect and then here is where we need
to change up this is how you add the
split or add the WebSocket to your HTTP
link cuz right now we add just this link
to our client but we also need to
somehow incorporate the WebSocket link
and as you saw we're gonna be using the
split and that comes from I think
hopefully our preset has it
I guess it's lower case split yep lower
case split and then we can do this so
you can just copy that so this is gonna
be the link that we're going to use and
I want to put this below off link okay
so this get main definition we need to
import it looks like too but here's
where we pass our HTTP link and our HTTP
link is this thank you
and then that's our WebSocket link and
now we can just pass our link in here so
the get main definition where is that
coming from Apollo utilities not sure if
that comes with our preset let's see we
might need to install that get main
definitions okay that can't come with
our Apollo preset too so now we're good
so the reason why we need to add this
split is what this does is it's actually
checking whether a query is a
subscription or a mutation or query we
broke something
it looks like we also need to install
subscriptions transport so yarn add
subscriptions transport and I'm just
gonna install latest one so this is yeah
we need to know whether to send the
request through a WebSocket or through
our regular HTTP link so that's this guy
so that's what this check is doing here
and once that's installed cool we can
refresh and hopefully we're good to go
now so our request should work the same
but now in our products over here we can
actually write a subscription and we're
not logged in which makes me think we
broke stuff and that maybe we're having
trouble connecting so let's just refresh
at least we're not crashing anymore did
I set it to the right thing so HTTP link
is on the bottom so let's take a look at
what's going on so this is our products
and let's just come over here to our
check token so I'm going to console.log
my token and see if it's there and
and we can also console.log any air that
we get okay so we have a token so we
should be able to here is the problem
get main definition is not a function
okay so it doesn't look like this was
able to this is not part of this I was
thinking it was so let's go ahead and
install Apollo utilities so give main
definition from and then Apollo forget
the name there we go so I guess this
does not come with the preset
automatically and we'll come back over
here yarn add paste that in so Apollo
you and I could just paste it now so now
when this reloads I'm hoping we should
be able or we should be logged in and
cool we are so now what that allows us
to do is now that we set up all this
stuff we have the subscribe to more
function that we can call so what we do
is we pass and and doesn't show it here
we can pass in our subscription so in
our playground over here you see how we
able to write that we want to do the
same thing over here so in my products I
can come up here and we have queries all
over the place it's probably a good idea
to write these in a separate file you
are doing a real project so we're going
to say Const
subscribe we'll say products
subscription is equal to gql and I'll
paste it in
now I would like to get the same fields
here as I do over here that way when I
merge them we don't have any conflicts
that were missing for example the ID or
something
all right cool so we're good with that
and I think we're just having spacing
there so now we can call subscribe to
more and similar to how we might use
like refetch we have this update query
and that's how we update we are gonna
get data from our subscription show I'll
show you that so over here in our data
we'll have a subscribe to you more and
what when do I want to subscribe right
actually we want to subscribe component
did mount here so after we get that and
we update the state we can subscribe to
more so let's do that
so this drops that beta dot subscribe
subscribe to more and I think it's what
our query that we pass in let's see what
we need at document is the name so
document is the name of the subscription
that we have which is products
subscription and then here we can copy
this update query and now for now I'm
just going to console dot log so we can
see what this looks like
and I'm just gonna return the data that
we had before so the previous data and
console dot log subscription data so
let's give this a save and let's format
this unhandled graphical subscription
err must return a sync iterable received
undefined all right looks like our
back-end is not good to go it does not
set up the right way so off I was
thinking it would be auto setup but it
looks like we need to actually set it up
I don't know why I went to off but we
can come into product I think how our
index is set up here is yeah so this is
the mutation the queries I'm just gonna
add the subscription here so description
so the name of our subscription is
product
yep product and inside of product we're
gonna say subscribe and then this is
going to be an async function and it's
gonna take whatever parameters a regular
SUBSCRIBE function gets and from this
and I believe it gets what parent our
context and context is the one we care
about because then we can get our DB and
let's save that it doesn't like it
dB and this is where we can say I
believe it's subscription I don't think
it's subscribe
I want my Otto's auto completion so how
do they do it over here oh that's how
you do it I need to specify the type so
type grab the context and let's copy
this paste it over here and the utils is
not this deep in the folder structure
okay so now DB dot dot product and I can
just call that and it doesn't like it
I'll see what's wrong expected arguments
and we can just pass in to impel all
right so this is me just filling out the
subscription I was hoping kind of like
with the query it would do it for me by
default but that's okay I wonder also if
we can use forward to here I let's see
now
so we're able to now actually create the
subscription it looks like I'll - come
on over here now and check token we no
longer need these so let's get rid of
them don't clutter
okay so hello I click it and this looks
like our data objects it looks like we
got three of them
that's really weird I think
subscriptions is like already turned on
it feels like but we can see it indeed
gets called and connected I think maybe
Apollo is auto-updating for us is
another possible thing but uh anyway
what we can do here is now map over
alright so now that we received the
product where were we you're in
component did mount so now that we have
this we can do data product node and
then we can replace this node so let's
grab that so conce node is equal to
subscription data and data product node
data dot product and we're gonna get the
node from that and then what we're gonna
do is previous and I guess let me
console.log previous I think previous is
gonna be the same as I think we're gonna
do the same update we did over here like
this I think we're gonna do procs
connection edges and update that but to
make sure I want to just console log
previous and see what that looks like
so Plus that we increment and yep page
info looks like it's exactly how I think
it is so I can do dot doc Rev
and then I can say edges is oh this is
all and actually you know what I'm just
going to mutate I was gonna create a new
one but I think it'll be easiest if I
just say Rev dot products connection got
edges and then we'll just map over it
all right so each one of the map here is
a node so similar to how I did it in the
other one I'm gonna check for the ID so
it's gonna be X dot node ID is equal to
node ID if they're equal I just passed
the node in otherwise we're gonna pass
and X and to pass in the note of what I
have to do is also give it the cursor
which is gonna be the node ID and then
also the type name and the type name is
node so save that let's format that so
it's easier to see and do I just have an
error I don't have an air I was hoping
is to drop it to another line so it's
easier to see
there we go okay so I'm doing a
condition here where I'm checking the
nodes and again I'm replacing the note
if it's equal to this otherwise not so
26 and like we can't really tell if it's
working or not because it was working
before I guess the best way to do this
is to open up another emulator and then
see if it works so I guess I can try
running this on my phone and seeing if
it works or on my Android device but
this will require some code changes cuz
Android can not access the server but
this is how you do subscriptions I'm
gonna test this using my Android phone
and see if this works and I do success
we get it but it looks like it's working
but again it was working before and I'm
curious if you guys know why this works
off the bat without even having to add
subscriptions I'm curious to know I I'm
guessing Apollo client auto-updates the
cash for us for some reason
which is pretty interesting I haven't
seen it do that before and it wasn't
doing that for new product for some
reason but yep that's it for this video
guys thanks for watching
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>