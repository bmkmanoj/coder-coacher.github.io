<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Testing a GraphQL Server | Coder Coacher - Coaching Coders</title><meta content="Testing a GraphQL Server - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Testing a GraphQL Server</b></h2><h5 class="post__date">2017-11-18</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/j9NZ6SlJfp0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey guys so I've shown you how to test a
react application but I haven't gone
over how to test a graph QL server and
since we just set up a nice big one with
our slack application I thought it'd be
a nice time to show you guys how to test
this guy and how I would go about doing
it so to test this I'm going to be using
just this is basically just the test
runner we're gonna use because I like it
but you'd be fine to use a different one
if you prefer a different test runner
it's not as important and then we're
gonna be using babel jest that way we
can use async you know wait and the test
because i prefer using that versus dot
bin and then we're gonna be doing some
requests to our server so we're gonna be
using
Axios for that but again each one of
these parts is kind of interchangeable
if you have different preferences it's
very easy to do this so right now I have
my server up and running here you can
see it and we're just gonna run some
tests on it now some people what they do
is they'll test the types of the graph
QL server and lots of different stuff
but what I prefer to do is that actually
just test the resolvers that we made and
we that we get the responses that we're
expecting and kind of do it that way so
what we're gonna be doing is usually how
just recommends is to put the tests like
right in here so creating like a channel
dot SJS or channel dot spec j/s but the
way we're doing this right now if we
look at our index we are actually just
like joining loading all the files in
here and so I'm afraid will actually
load tests and instead of just resolvers
so what I'm gonna do is just create an
outside folder here that's gonna house
our tests so in here I'm okay a new
folder called user spec jeaious and so
here I'm gonna put in the tests for our
user resolver and then go from there so
the setup for this is we're going to
install a few things I'm going to do
yarn add
and I'm gonna do Axios babble jest and
jest so I'm currently in the folder
slack clone server this is where my
servers located and we'll install those
dependencies and then in our
package.json we're gonna add a new
script here and we're just gonna say
test and what test is gonna do is it's
gonna run just now the cool thing about
jest is that's all we need to do
oops close this I accidentally just
overridden this so give that a save yeah
I'm gonna close this file
there we go so create a test script and
this is just gonna call jest and just
automatically knows where your tests are
so you don't have to tell it you just
tell it to run just you know run your
tests so now in here we're going to
import Axios from Axios so what I like
to do is actually just make requests to
our resolvers into our server so I have
my server up and running like I said and
we're just gonna say described and how
tests work is at least with Jess this
will use this oops
described keyword and this describes
basically a group of tests so testing
maybe risk user resolvers and then
inside of this you'll use the test
keyword to test individual ones in us
the second parameter is a function where
you actually put your stuff so describe
and test they're actually global
keywords that we're getting from jest
and they're automatically in there just
has just like has them globally when we
run tests jest they'll be there so for
tests here I'm going to say we'll graph
all users here
we're just gonna put this here now it's
kind of annoying that this is read all
the time
so what I can do is just go to my do to
do is Lent and say rules are key not
rules global society by this and I can
list any global variables my application
has so we have described and test and
give a save and we put a common air and
hopefully now we shouldn't see yep and
we don't see those airs anymore so to
test this I'm just gonna say comments
response is equal to AK Co stat and
we're gonna wait so I'm gonna make this
an async function Axios post and we're
just literally gonna make a post request
to our server so I'm on 80 81 localhost
HTTP slash and do / graphic UL graphic
you all and then here you put in the
body and we're just gonna put in a query
here
now the query you wanna run is we're
gonna be testing the all users query so
if I pop over here to graphical I can
see this is all users I can run it now I
can grab more things if I want like the
username email whatever I want to test
out right I can run that and we get all
this data back so I can copy this query
place it here
and now actually this response will get
run and in the response object there's
gonna be a data back and data is gonna
hold the response from the server so
what we can do now is use the expect
keyword and I'm gonna add this to a
global this is another keyword coming
from just so we can say expect our data
object and if we come over here we can
see all the different things we can use
for expect with Jes so this is basically
a test and we're basically want to test
are we getting the object that we expect
to get so we can say I believe there's
an object one let's search object to
match object is the one we want to run
and basically we're saying we're getting
back the object we expect to get and
what object are we expecting you back
well we just ran this query we expect to
get this so we can copy that paste it in
here alright give that a save so we
expect when we make this query to this
endpoint that we get this data back now
to run this I'm just gonna say NPM run
test and it's gonna go ahead and run up
test or just look it found our test user
dot spec and it passed and just to show
you this is working how we expect if I
put a 4 here we should get a test did
not pass and see if we get an error here
saying we did not pass the test anymore
it's saying hey IDs for when we expect
an ID of 1 and we can put that back so
okay this is well and good we can test
all our endpoints this way and make sure
they all fit but a lot of times we're
currently messing with the production
database so well this is considered our
production database anyway our main
database and so what if I want to create
objects like create users to test and
whatnot I don't want to affect the
database them using here so a lot of
times what people will do is they'll
create separate databases
they use for testing and we're gonna
follow that practice as well so in my
package that JSON I'm in instead of
creating this starting just regularly
we're going to start this for testing
and to start this for testing we're just
going to basically pass in we go to the
index of our models so here is where we
say what are databases so for testing I
want to create a new database called
test slack that I want to come in here
and change every time so we're gonna say
process dot m dot test DB or so
basically I'm saying if we pass in this
variable called test DB use that as the
name otherwise use the slack database so
now in my package of JSON I'm gonna
create a new one called
test server or something or I don't know
what even to call it we'll call it t
start very basically now we'll do test -
server and for this we're just gonna say
test DB is equal to test equal to test
slack so we need to make a server called
test slack and if you've seen this
before what this is doing is this is
just making environment variable for
this command so when this command is run
it's gonna be grabbing this variable
right here called test DB and it's gonna
set equal to slack just for this but
notice how this variable is not getting
run here so when we run start we're
gonna use our slack database when we run
test server we're not in this database
but right now that database doesn't
exist so we can create that database by
running create DB so with create DB I'm
just gonna create test slack
and it should create it now this can
create DB comes with P sequel I believe
so if you have P sequel you should have
that and we can connect a test slack and
see what it looks like
and can you backslash D there's nothing
in there right now but you could have
came in here and said create database
test slack - that's the same thing as
using create DB this is just a command
line shortcut alright so now I want to
run this test server so I'm gonna come
over here and this is where I'm running
my application and I'm just going to say
npm run test server instead of running
the regular one alright so it's up and
running and now when this runs it should
go ahead and populate our test slack
with all the tables so if we describe
this now cool we see all the tables that
we would expect now so now and we're
connecting this and writing the tests we
should get no users back so we can
change our tests over here user dot spec
we expect no users now so that's what we
expect to get back and we can run our
npm run just IBM run test and now run
just and we can see we get nothing back
cool so now we can continue to do this
and we can do this for creating users
and so on so now I could say test create
user and then we're just gonna create
our user in here
so we can copy what we're doing here
paste that in and make this an async
function as before and now we're going
to do a mutation here so mutation and
I'm gonna create or we call it register
so I don't call just instead create user
will call register register and we're
gonna pass in username as test user
email test user at test user calm and
password tester and okay we just select
some fields are we doing okay yeah
errors and we're with the path back path
and message and from our user it lets
get an ID we actually don't care about
the ID let's just get email because the
ID is like whatever cool so let's copy
this or run that mutation
and we'll copy this is what we expect
the response to be right so we can come
down here and that should be a there
semicolon and I could say con Stata is
equal to response and then I'm gonna say
expect data to match object and we can
paste our object in here give that a
safe so now right now this is not gonna
work at least I don't think it's gonna
work let's see MPM run tests because we
just created that user and now we're
gonna try to create it again all right
and cool we see this area let's see what
we get so username is not unique so we
get an error back we're expecting no
error the reason for that is we just
created this user here now oops
I'm trying to create him again so our
database already has a user in it so
it's starting with state basically and
every time when we start a test we'd
like the database to be either clean or
maybe it starts with some seed data so
I'll show you how I like to do that so I
like to create like a little shell
script so we'll come back we'll come
over here and in my server when I say
reset DB Sh and all this does and I'll
say reset testdb reset tests TV is it's
gonna reset the database so I do hash
dollar sign slash bin slash bash I
believe is where tap we'll see if that
actually works
I always forget it and we're gonna say
drop dB so this is a special command
like create DB so drop DB test slack
and then we're gonna create DB test
slack so we're just gonna recreate that
and over here I'm going to change mod
this plus X so it's executable so what I
nameless reset test and so if I run
reset testdb we have a connection
running so I'm gonna have to come over
here shut down the server reset the
database what other what else has a
connection to it this doesn't shock TV
aired test slack already exists Oh drop
TV and job DB no drop TV works test
slack there we go
drop TV command not found oh I just
misspell it I was like it worked right
here why is it not working
oops was clear so make sure to spell it
right and now let's run this again so
drop DB oops our reset so we dropped it
then created it so now we can come back
over here do npm run test server and now
i'm gonna do npm run test and now
hopefully the test passes and we notice
our register pass works ok so now here I
would want to reset the database again
so now I can run the test again oh it
didn't work I'm guessing it's because
I'm connected still so a nice little
we should automate this so we run reset
before so in my package JSON here I'm
gonna run dot slash reset test DB SH and
then just a semicolon so we're gonna run
this command and then we're gonna run
this so we're gonna reset the database
then start up the server and we
shouldn't really be making changes when
we're working with the test database per
se so you could get rid of known daemon
if you want to just use babel node but
if you want to keep no demon that's okay
too so we're gonna reset the database
and restart it so let's give that a try
also some some Linux you have to do the
ampersand like that to run two commands
in a row so NPM run test server cool and
now we can run our test here and our
test works so every time we wanted to
restart this we come over here restart
the server rerun our tests you could
probably morph this into one command
where it starts the server then runs
just so you could like run this in
another process or something but we're
just gonna keep it like this for now cuz
I think this makes sense alright so
let's do one more test so we can pretty
much go infinite with the number of
tests we have we have a lot of resolvers
over here but one thing I think that
would be helpful is to show a multi-step
one so for example actually let's just
this register one let's work off of that
so we just registered a user now I want
to log in with the user and make an
authenticated request that's like
something I like to test so first we're
gonna expect that that's well and good
then over here I'm going to make another
request to login so save and let's try
it out that mutation so login email what
email job used test user got a copy and
make sure quotes and a password tester
and then we can grab the Refresh token
another token so here we're not gonna
expect anything because we're gonna get
a new token every time we could expect
these fields if we wanted to but I'm
just gonna grab the token and refresh
token from this query and we're gonna
use it for the next thing alright so do
that will say response to and say Const
we can't actually get the data for this
one either so here we're just gonna get
it counts and we're gonna say data login
data login token refresh token this is
going to be equal to response to data
and then here we can now use these
tokens and another request so let's
create another request down here so
we're cluster 3 so now maybe we wanted
to make a team which requires you know
to login so that might be our whole
purpose of doing this this tests like
create team is what we'd like to test I
know we're in the user spec so you
probably don't wanna put this here but
this is just an example of how you would
do it so with our create team let's go
ahead and just run make that and
graphical
so oops create team name team one and
then okay and then our team and then our
name so we could copy that mutation put
that here so we'd like to create team
one and see if that works
now we need authenticate for this we
need to add headers how do you that an
acci OS is just a stick them here so I'm
going to say X token is equal to token
and then X refresh token is equal to
refresh token okay
so we're making a third response to
graph QL creating a team passing in the
tokens that we got from over here
and so with our response back we could
expect what we expect to get back from
this guy so expect response three dot
data dot to be object to it was a to
object to match object there we go
so here we expect there to be a data
field and then here the create team and
then in our create team we expect it to
be an okay of true and then there to be
a team inside team to have a name and
the names gonna be team one which we put
right here alright so let's see if all
that worked I have no idea if it will
I'll to restart our server
and we can just fix any areas we get
with this okay send out run our tests
and you could grab more fields from this
if you wanted to and whatnot so let's
see alright so this is what we expected
what we actually received is an error
not authenticated so it looks like our
tokens did not get passed in okay so
here's how you add headers and Axios I
just need to add this little headers
object above here so now we're all good
and let's give this a run so now when I
run the npm run test we are still
getting an error but it no longer has to
do with headers but this weird network
air and i actually don't know what is
going on here I haven't really seen this
before I did some googling about it and
the fix was to install this xml
httprequest and run this I have no idea
what this does or what this means if you
know why this is happening I'd love to
know in the comments but I just went
ahead and installed that with yarn ad
dev xmlhttprequest putting that guy at
the top here there it now works so we
can rerun get rid of it and PM run test
server and then give this a run and
we'll go ahead and fetch this pass our
headers okay create the team and our
object will match so run our tests and
cool all of a sudden now everything
works so that's how I'd be doing login
now you could want to make like this bit
here where we login to like a function
because I'm sure there's lots of
resolvers where you want to login now a
few of you may be thinking why the heck
are we creating this reset test DB when
in our index here we could just write
here we could just do force true
right and that's a great way actually to
do that and if you want to you could
just do process dot and dot testdb
and if you get a test DB you want to
firt you want to force true otherwise
false
so what oh there we go we can just turn
this into a boolean expression so if we
get a test DB we want to force restart
the database otherwise we don't
basically force we'll just dump the
database and restart it and I think this
is actually a really good way to do it
if you wanna every time you test wipe
your database from scratch
now a lot of you though are gonna want
to not you know dump it all the way from
scratch but maybe right now in our
database we have a user for example so
I'm gonna stop the server real quick so
we have one user in our database right
now let's say we wanted to like keep the
database there in its current state and
use that every time so when I reset the
database I don't want to reset to
scratch the way I like to do that is
just take a dump of the database so test
slack and I'm just gonna dump and say
dump sequel so what the heck is this
doing well this is a command utility
that comes with P sequel I believe also
it's called Postgres dump and it
basically just takes your database this
dumps it into a file so if we've them
dump the sequel we actually see our
whole database here and I think if we do
a search we'd be able to see where we're
inserting see how we're inserting this
test user so now here I can add a
separate one piece equal and then our
database name test slack
and then dump sequel so what that will
do is it actually will copy what's in
dump seek will run it in test slack so
now our test slack has a user in it so
for example now in my test suite I can
actually expect an error so if I do npm
run test server there's actually still
gonna be one user in it and you notice
how we did this thing where we run all
the users so if I come over here I can
query it all users there's gonna be one
in there because we just created that
user cool so now if I were to run do the
run test we will get an error as
expected so that's how I would save the
database and then load the database back
in if you wanted to so we get an error
as expected because we need the user
name to be unique so if you wanted to
basically see the database this is how I
would do it I'm sure there's a way you
could do it with sequel eyes too but I
don't really care for seek wise that
much and this is so simple I love it
otherwise if you just want to drop the
database every time I recommend using
force right here that'll work nicely for
you so this is how I would test the
database let me know if you have test
the resolvers and graph QL server all of
that that's how I would test it let me
know if you have any other questions
about testing in general I don't like
testing too much I won't spend too much
time with it but that's how I'd go about
doing the resolvers so that's it for
this video guys thanks for watching and
as always the code will be up on github
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>