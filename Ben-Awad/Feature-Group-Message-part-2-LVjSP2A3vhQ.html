<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Feature: Group Message part 2 | Coder Coacher - Coaching Coders</title><meta content="Feature: Group Message part 2 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Feature: Group Message part 2</b></h2><h5 class="post__date">2017-12-04</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/LVjSP2A3vhQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey guys we're gonna be wrapping up how
we set up direct messages and group
messaging now the first thing we're
gonna work on is this the naming of
actual direct message channels because
right now I just have it hard coded as
hello but how it works in slack is the
person you're editing your messaging and
if it's multiple people each one of them
you see their names here so what we're
going to do is take our members list
ignoring ourselves so maybe we keep cons
original members list is equal to
members or maybe we just say you know
what Const all members is equal to Delta
thought members and then add our user ID
at the end so now anyway we're using
members we really should be using all
members and come down here all members
and now hopefully we're not using
members anywhere else
okay we're using it down here use all
members and we're good so now here what
I can do as I can get Const usernames
and just we're just gonna grab all the
users basically and we're gonna say a
wait models dot user find all and here
we just want to find all the usernames
associated with our members because that
is just an array of user IDs so I'm
gonna make this our all query and then
we're going to say we're we're gonna say
user ID and we're gonna say
this over here so we're gonna use the in
operator and we're gonna be doing off
that end because that's how they want
seek wise wants us to use it now so
we're gonna be fine and doing all the
user IDs that are in our list so we're
gonna say models that sequel eyes op n
and then our members list so give that a
save so then what would be returned is a
list of our users that match that are
inside of here so with that what we want
to do is create the name so how we want
to do that is just do a join statement
so we're gonna say users dot map you you
would username so we really just care
about the usernames so we I now have a
list of strings which we can call it
joint on and just add commas in between
and then that's the name we'll use so
let's see this in action now oops
well let this refresh while the server
is cool so I'm gonna invite just Bob to
start messaging column user dot user ID
does not exist
oh right user ID it's just called ID on
the user all right let's try this again
okay so - Bob - oops I clicked out for
there we go now we don't have it
automatically putting it there that's
the next thing so nice I see Bob show up
here
I think hello is our channel that has
both users and so I don't think adding
both users like that does anything but
let's create a new user real quick so we
can make sure group naming works so I'm
gonna register a new user and he's gonna
be Bob before and all by him to my team
and now I can select all of them say
start messaging are you fresh and nice
now I see my group with Bob two three
and four so next we're gonna do is while
we have the resolver of let's make sure
we are actually authenticated before we
do stuff in our method so we I mean we
are authenticated or we have a token but
let's make sure we actually are a member
of the team so here what we're doing is
we're before we create a channel we're
finding the member and making sure they
are an admin now we don't have to know
if they're an admin but we do need to
grab one of the members so let's copy
that paste it up here
oops so we'll have the team ID here user
ID here I'm gonna say if not member
throw new air I'll just say not
authorized so if someone's trying to
access this mutation and they are not a
member of the team
meaning they we've checked the team ID
and the user ID their member status and
it's not there
they're trying to do something fishy
we're just gonna throw an error for them
so now we're protected let's make sure
this didn't break any messaging
capability you're creating the messages
oops
so who haven't I messaged with Bob
before I haven't so let's just talk to
Bob for Cole Bob for shows up good so
awesome so now it's annoying that I have
to keep refreshing the page right every
time to see these pop up we don't have
to refresh what we can do is we can
actually update the cache so in our
direct message modal now we have our
mutation and we can do a update query so
just like how we're doing it for our
other modal are not our invite people
but our channel one or is that here you
we're gonna use both this update copy
now we're not going to be using
optimistic UI because we actually don't
know the ID of the channel always so
that will cause problem or the username
too so with this artists is not called
create channel this is where you want
the name of the chain of your mutation
awesome called get or create
and then from getter create channel this
should be an integer but I think I have
changed my mind about how to do this and
the reason for that is I not only need
the channel ID but I also need the
channel name that way I can push on the
name and ID over here
so ID and name so we need to change our
back-end to support this but we'll fix
that in a second because right now we're
only returning the ID so this me query
what is that that is we already have
this query on our team so we can just
copy that paste it in here and fine
index is from lodash import fine index
from lo - slash fine index
oops okay so we're finding the current
alright data dot meetup teams so we're
finding the current channel or the
current team I mean we're grabbing the
current team and now for us we don't
know whether we created the channel or
we got the team so the way we're going
to do this is we're just going to check
if the ID is already in here so we're
going to say
Const not and channel list and we're
just going to say every and we're gonna
say team actually we want to loop
through the channel so dot channels so
every channel the channel idea is not
equal to ID so if this is true for every
single item and channels that is the
channels ID does not match the ID other
the one we just got or created that
means it's not in the channel list so if
it's not in the channel list we're gonna
push it on
so there this otherwise we do nothing
so you only write to the store if this
is the case okay so here not if it's not
in channel list then we're going to set
up every we're gonna say push the ID the
name TM is true and you know what we
should really just pass a channel back
that makes the most sense and now you
know what we won't because that will
make it more difficult we'll just say
diem is true okay so we're getting the
by D in the name we're pushing it on to
our list here sit down our back end over
here
we can't just return the name or is it
up here there's ID I mean we need to
return both so here we'll just say
channel data and we'll return channel
data and what that'll be is ID is equal
to C ID and the name is equal to name
actually we already have the name of
that you know what you don't even need
to rework this
the spit can stay we can just say ID is
equal to a channel ID and then the name
which we already have created good so
now we're passing that back we need to
update our schema as well so this is
going to be type d-m d-m channel
response and it's gonna have an ID which
is an int and a name which is a string
so DM channel response and now actually
in our query over here we have to
actually select that we want this so we
want the ID and the name okay but
there's two cases right either this
happens or coming up here we find the
channel ID and right now we're only
returning the channel ID
let's also return channel dot name that
way we have both of them and we can just
return the first element of data but
because how group-by works ran off a
group by also c dot name because you can
only select the fields up here that are
grouped by or that use aggregate in for
but this shouldn't change anything
because our ID and name are unique so
are there a unique pair I mean so we're
good and and they're always going to
match up to with the same ID here so
let's see this in action now I'll
refresh
and I'm gonna open up my console to see
if we get any kind of errors so trying
this with for example Bob too should
yield no changes over here so we get Bob
to as the name and the ID is three and
we don't see anything update over here
perfect but for example if I saw Bob -
and Bob for that should see an update
over here and we have a problem so let's
see what's going on okay guys so I debug
that problem for a little bit longer so
I went ahead and cut the video and I
couldn't actually find what the root of
the problem was but I found a little
workaround that seems to fix everything
so I just came over here to multi select
users and I just set the default value
forget team members to an array because
for whatever reason just for a
microsecond get team members changes to
undefined and then it changes back to
what it originally was so I'm not sure
why it does that but this does fix it so
now if I go them over here I invite my
guys to the team I start messaging I see
them pop up here and now if I open this
again I still see can't get rid of these
I still see stuff here all right it's
not broken anymore so not sure what
caused that but there you go and I want
to be resetting the form so come over
here so instead of set submitting to
false we can just reset form by default
reset form wall will cover staying
submitting to false so we can just reset
form here this will also clear
everything for us
so now when I invite someone and oh and
also I wanted to right now we have ad
channel for the header here just change
that too
direct messaging direct messaging okay
let that refresh now I want to come chat
with Bob - Bob three start messaging and
awesome
now next thing I want to do is get the
links working cuz right now if I click
on a link it does not work how our
channel links work it actually takes us
to direct messaging and that breaks
because we don't have it set up yet or
we we're not doing direct messaging
right now okay
so that is going to be in our channels
where are you channels here you are so
we've literally just need to copy how we
do it for channels and our DM channels
so here we do slash view team slash team
ID we just need to get rid of user and
that should be good
so refresh so click on that we see our
people are chatting with here and I
looks good so let's actually start and
not start let's try chatting with these
guys make sure that was work so create
an incognito and I'm just gonna log in
as one of the Bob's so login Bob at Stu
Bob 3 at Bob calm
oops no all right so I'm currently in
this team down here and let's chat with
these two users hey guys all right so
that's broken hopefully actually you
know I think I were just WebSocket broke
this is this is a problem I know about
actually it says we're authenticated or
not authenticated I know about this
error this is something we may or may
not fix in a little bit
now abscess should work hey yep
WebSockets works fine it's just the
first time if you're not authenticated
okay so hey dude
and we see it we can chat back and forth
and now only these three users can see
it so if I were to log in as Bob for for
example I should only see this one let's
make sure that what is the case Bob
before I pop calm oops or and sure
enough he only sees this one and I need
to refresh if I want to chat with him
hey Bob and we see it here
okay so now we have group messaging and
direct messaging working fine and very
nicely just using private channels as
the backend so we can get rid of this
and we can come over to our code base
and just actually ravage it a little bit
because we don't need a lot of stuff now
I don't need this direct message
container by let's see anything related
direct messages we don't need I think
that was the big one
routes we don't need direct messages
page our index over here we don't need
direct messages we don't need this route
anymore
oh there might be other stuff we could
delete the direct message modal we're
gonna keep this is one of my favorite
parts when we refactor something can
just kill the code okay this still looks
good and then our back in we can just
kill the direct message schema and the
direct message resolvers so we just
straight don't need them anymore so we
just just killed a ton of code which is
really nice because we didn't lose any
functionality right this now works fine
and now this is this works even better
right I can chat with up to more people
and I think there's one last thing we
need to do to make this fully working so
let's say I am on Bob 2 and Bob 3 and I
come over here and I select all three I
say start messaging we should redirect
to that page that we just or the channel
that we just created so let's do that so
kind of like how our channels over here
we are doing this you can copy that
we're gonna redirect just like that in
our
modal Direct Message Moodle down here so
this is when I was talking about we have
a history prompt in here history and
once we reset the form close this guy we
can now do a history dot push and we'll
push this on so the ID here is the ID of
our channel so really we have to put
this in the our update function because
we don't have the ID of our channel till
it's complete give that a save and let's
see this in action see if that works
okay so Bob to about three I want to
chat with all three of them now start
messaging
nope does not work so is it because we
put the wrong idea up here refresh no
it's not why does pushing this break it
then if it's the right ID all right
let's try that again
so let's move over to this channel and
let's chat with all these guys start
messaging and what is the problem is our
ID No okay so view team cannot read
property ID of undefined
not sure what it's talking about can
only update monitor usually when you
called set state I'm thinking we don't
have to close on clothes or maybe reset
the form because we're already changing
the page and I'll do that by default but
that shouldn't be causing our problem
that should just cause the warning
probably so this is view team line 14 so
let's see what that we do there that's
literally just this I'm just gonna save
this like so oh it doesn't like that we
commented okay I must be missing
something
what about let's just try a different
one maybe it's just that one Bob - Bob 3
star messaging no breaks on everything
so invalid checkbox that's an error that
you know about cannot read property ID
of undefined that doesn't mean anything
to me there's not even an ID here I'm
guessing it's our data prop here that's
gonna be view team I'm guessing it's
down here
so me query running the me query every
time but that doesn't take any
parameters
right let's double check
no no parameters whatsoever okay I have
I have no idea what it is the problem
with this I'm gonna stop the video here
and I'll try debugging this and we will
at the beginning of the next video
fix this but for the most part we have
everything done with how we want to do
direct channels and I'll go ahead and
comment this part out where we push
because everything else is working right
now and we'll get this guy working in
the next video but let's make sure we
didn't break anything else it should
still work good and then we can chat Hey
okay cool
all right thank you guys for watching
sorry with all the problems we had I was
surprised
none of these things I thought we would
have trouble with but weird things are
popping up but thank you for watching
and as always I'll push this up to
github if you want to check out the code
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>