<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Sequelize Migration | Coder Coacher - Coaching Coders</title><meta content="Sequelize Migration - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Ben-Awad/">Ben Awad</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Sequelize Migration</b></h2><h5 class="post__date">2017-09-23</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/a5Wh_LDXtLc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey guys so I'm going to show you how to
do migrations and sequel eyes now I'm
talking about database migration so you
may be asking yourself what are they or
why do you need them so let me explain
so I have an application right here that
uses a Postgres database and this is a
node server and I'm using the sequel
eyes arm to basically have mine ojs make
database queries and if I type P sequel
I can check out my this allows me to
basically query stuff in my post-arrest
database I'm just gonna connect to my
database which is test graph QL DV and
then I'm gonna show you guys one of my
tables
so select all from students so we can
see I have this table here in my
database with some test scores so these
are my students and let's say I no
longer want to call these test scores
maybe they're quizzes and I want to
change them but I don't want to get rid
of the data I have two students here I
don't want to get rid of their scores I
just want to change these from test
scores to quiz scores and so what you
would do is what's called a migration so
a migration is just changing the
database now you might have seen me in
past videos or have done this yourself
where you just drop the database and
recreate it again and then you're able
to you know rename these to quiz scores
or you know maybe I only want two
quizzes or two tests you know change the
data in anyway but really when you want
to use migrations is when you want to
keep your data and migrate it over to a
new structure a new form if you will so
that's what I'm gonna be showing you how
to do is using sequel eyes take this and
we're just gonna rename these two
quizzes I want this to be quiz score one
quiz score two quiz score three and then
we're gonna do a little bit of an
advanced migration so I can show you
some other cooler things you can do with
it
so let's get started so like I said
we're gonna be using sequel eyes here's
my little model over here I have this up
in Visual Studio code and I have here's
my data data model right here and my
project and as we can see I just have
data a test score one test scores two
test scores three and I have my integers
so really what I want is to just change
this to quiz 1 and quiz 1 through 3 so
now I've changed in my data model but
this doesn't change anything if I were
to migrate you know if I were to restart
the server rerun it we would still see
these values here so I actually need to
make do the actual migration here I'm
only changing the model so this is my
database model I'm only changing it that
doesn't really affect the database
assuming we're not dropping it so over
here I'm doing down here at the bottom
I'm doing sequel eyes sync force so this
would actually drop the database but I'm
gonna go ahead and get rid of that that
way we do not drop the database and we
can migrate so the first thing you want
to do is get the sequel I CLI now you
can see I just typed the word sequel
eyes and I can see all the commands for
sequel eyes if you don't have this you
can try typing it to see if this if this
works for you if you don't have it you
can install it using NPM so I can do NPM
I - gee let me clear this so it's at the
top NPM I - JEE sequel I COI and then
you can go ahead and install it so then
once you have that installed you should
be able to type this and it should pop
out here and get all the commands now
the first thing we want to do is
actually an it our project so I'm gonna
be a sequel eyes done it and now what
this will do is will actually go ahead
and create a config slash config JSON
file now I already have one here but if
you didn't it should create it for you
it looks like it's not gonna override it
and so now we have this and what this
does is basically you have
your username/password your database
your host all this stuff so basically
this is your credentials to login to
your database that way sequel eyes can
login and affect it so here's my
username password the database to log
into this database and actually affect
things now if you already have sequel I
setup which I do you'll notice how these
right here match what I have in my
config so my config I have this data and
hosted localhost when you're using this
locally and the dialect is Postgres now
you can change this to my sequel or
anything else and also if you are
looking to do something in production
you can have you see Alice's development
you can have another one called
production and then change the values of
that right or you can set these to
actually just do so this is a JSON file
but you can make a config J's file and
pass in process by m dot DB username so
you can actually do environment
variables as well so whichever you
prefer but anyway so this is you want to
put in your information for your local
setup and then I can come over here and
I can actually like it says I can
initialize migrations which is what we
want to do so we can start migrating
stuff so sequel eyes emit migrations and
this is successfully made a folder and
we can go ahead and clear this come over
here we can see we have a new folder
created called migrations and that's
actually all it did it didn't do
anything else
we can see our other options the next
thing we want to do is you can do
multiple migrations right so I might
want to change it once and change it
back or do something else so you
actually create a new migration file
every time you want to make a change but
you can make multiple changes in a
single migration file which is what
we'll see so I'm gonna say sequel eyes
and I'm gonna go ahead and create a new
migration file so migrate this is how
you actually migrate DB migrate but we
just want to create a new migration file
which is what we're gonna do right here
so migration generate and we can give it
a name I'm gonna say name is quiz or it
could say rename to quiz you know
anything you want I'm just gonna say
quiz that's enough of a reminder to
myself to know and then we should get a
file in here called - quiz and you'll
notice that also time and dates it for
your own use then you should see
something that looks like this you have
an up and a down so here you're gonna
put all your logic that you want to
basically do the migration so I'm gonna
go ahead and get rid of this comment and
then let's say you want to revert this
come and get rid of that we'll say you
want to revert this migration something
went wrong you would put the logic to
revert it and the down column so I'm
gonna come over here and I wanna like I
said I want to rename my database
columns so we'll use this query
interface to do this now if I come over
here
this is query interface this is where
you do all your migration stuff so they
have this nice documentation on sequel
eyes where you can see all the commands
the particular one we're going to be
starting out with is rename column which
we can see is right here we can see we
want to put the table name so for us
it's gonna be students and then we
basically just those houses remove index
we want rename column so the table name
and then the name before and the name
after so I'm gonna come back over here
and I'm just gonna say query interface
dot rename column
and I would like to do this on the
students table and I'm gonna call this
instead of test score one I want to call
it test sorry
quiz score one and I want to do this
three times and but these guys are gonna
be oops - this is gonna be three cool so
I'm renaming three different tables test
score one two and three - quiz score one
two three now these are promises and the
return value of up is a promise so what
you do is you say return and you return
an array of promises just like that
oops and make sure you do commas not
semicolons at the end and cool so now
we're returning an array of promises
so what's equalized is gonna do is go
ahead and run all these commands when we
tell it to migrate and what its gonna do
is it's gonna rename all these columns
so let's go ahead and do the down as
well so down is four reverting so let's
say something went wrong we want to
revert this what we could do is say quiz
score one and now we change this name to
test score one so we're just flipping it
right so I can delete both of those copy
and put them down here
so now if something goes wrong and we're
gonna rename these of course I can call
basically undo migration right and what
it will do is it'll rename the column
for quiz score to test score one and it
will successfully revert it back I don't
really do the down as much but it is a
good practice to do this a lot of times
I will only implement up so I don't
actually end up running down really at
all but it's good in practice in case
something goes wrong with your database
you can revert it back if you need to
both go ahead and see how you actually
go ahead and run this so again I'm just
going to go into P sequel so we can see
the change before and after connect to
my database and then we're gonna select
all from students so we see our scores
right here and I'm just opening a new
tab my terminal and I'm gonna go ahead
and say sequel eyes and what we want to
run is this DB migrate which just runs
the pending migrations so sequel eyes DB
migrate and if we do everything
correctly which we did we should see
migrating and then it migrated you can
see which one's it ran and how long it
took and if I come back over here you
can go ahead and do a select and we can
see we still get test scores so what the
heck went wrong okay so I figured out
what was wrong with my migration right
here I did promise I need to put promise
at all so I was under the impression
that you could just pass an array of
promises but it looks like the return
value of this they want it to be a
promise itself so the way you do that is
you just say promise dot all and so when
I do that we can see that when I run the
migration we get the change from quiz
scores from test scores to quiz scores
and everything is working nicely now
okay sweet so now I want to show you one
more migration that's a little bit more
advanced so right now I have quiz score
one quiz score two quiz score three but
what if I wanted to actually
change the way the data is stored so I
right now have three columns but what if
I just wanted like a quiz quizzes column
or a quiz column or he's having an array
of quiz scores instead of doing this so
that's what we're gonna migrate this to
next so I'm gonna go ahead and change
the model for a first so instead of quiz
score one quiz score two and so on we're
gonna have a quiz is it quizzes I don't
even know how to spell it will just say
quiz quiz scores will say and so I'm
going to say data types dot array so
this is something specific to Postgres
so if you're not using Postgres you
cannot use arrays but you could you know
same principles apply when doing
migrations if you want to see how I'm
doing that but we're gonna use the array
data type and I'm gonna say data types
integer okay so we're gonna score all
store all the quiz scores in our array
of integers and then let's go ahead and
make a new migration here so this
migration is all done so I'm gonna go
ahead and close it and I'm gonna come
back over here and then what I'm gonna
do is I'm going to do the same thing as
I did before to create a new migration
oops
which I think it was migration generate
yep so you go eyes migration generate
name and the name I'm gonna give this is
quiz scores okay so we see your quiz
scores here so here's how I would go
about doing this migration so
I'm gonna do a promise that all again so
the first thing I would do is and I
actually don't even need to use promises
so that's the one other thing I dislike
about this equalised migration is I have
to use this crappy dot Vincent acts
which you're about to see me do I'd much
rather do async/await
but for this because we're using the
sequel eyes coming in mind I maybe
there's a way to get it that don't know
how to so here's what we're gonna start
off with so the first thing I want to do
is actually create a basically quiz so
instead of quiz score one two and three
I want to create a quiz scores column so
I'm gonna say quiz our query interface
dot quiz dot I want to create a column I
believe it's just create column nope
it's called add column with the table
key attribute and the rest of it okay so
I'm gonna say add column so the table I
want to add it to is the students table
and then the name of it I want to call
it with scores and then I'm gonna pass
an object and the object here is
basically the type so if I come back
here student I can just copy because I
know this is the data type that I want
and then I just use this equalized
object right there and instead of data
types and I could rename this the data
types if I want do too okay so I'm gonna
do say that dot then so after we add the
column what I would like to do is
basically transfer this data so that
you're these three columns into that one
column so I'm gonna say query interface
so of course we'll say
and then this is the result of that so
we're chaining right so after this is
created we're doing dot then and then
query interface and I can say query
interface dots equalize and then I can
say query so I here's what I can
basically run an arbitrary query on D
and I don't wanna put a comma there I
can run an arbitrary query on the
database so what I want to run is
basically an update function that takes
these three scores puts them into that
array so we're gonna say update students
and we're gonna be setting three columns
and we'll go ahead and make this a back
tick using back tick you can do a
multi-line string and JavaScript so
update students we're gonna set the
student or the quiz scores so the first
value of the array is going to be equal
to quiz score one and we're gonna UPS
three of those don't get rid of that
okay
and that looks pretty good to me so
sequel eyes dot query and we're gonna
update the students table we're gonna
for each row what we're gonna do is
we're gonna put the quiz score 1 2 &amp;amp; 3
into quiz score 0 1 &amp;amp; 2 so that looks
nice so the last thing to do and I
normally won't do this but this is kind
of like a complete migration is to kill
these tables but if I'm practicing and
I'm not used to migrating yet what I'll
do is I will what's it called and I
would recommend for you guys as well is
to don't delete these columns yet delete
the columns afterwards you can fix the
migration when you're done but let's go
ahead and run this migration and see if
we this column gets added and the data
gets filled like we expect so let's go
ahead and select from students we see
these columns now let's go ahead and
clear this get our sequel eyes query
that we want to run we want to do the DB
migrate C equalize da migrate go ahead
and run it
okay so unexpected token oh it's just
this little comma I believe right here
oh that's annoying so my formatter is
automatically adding that let's see if
we can and it doesn't like the comma and
I could believe because I think
everything else lines up yep all my
parentheses line up except for this guy
so what I can do is I'm gonna just so
you guys can see this is nicely
formatted
how am I gonna get the comma not to show
up basically I need sequel eyes not your
pretty prettier not to run for a second
see it'll autoformat every single time
the only way I can think of it not to
auto formats for me to do a regular
string so turn this into regular string
and if I turn that into the regular
string I'm gonna have to have one long
string so let's bring that up here there
we go and close it is it actually adding
this common it really is okay so I'm
gonna come over here and just able my
plugin real quick so prettier disabled
just for this workspace I'm gonna reload
and then we should be able to I'm gonna
actually undo actually won't let me undo
let's go ahead and drop this to a new
line oops
so set quiz score one quiz score to
score three
I think this is just my es link
complaining
yep just es lint let's go ahead and run
it should now get okay cool so now I
think we just get a regular air so that
we did something wrong type undefined
does not exist so this is what an error
looks like I don't know why we're
getting a type undefined update student
set oh I put a comma right there and a
little single quote that messed things
up so let's read on that this is what
the error looks like it'll tell you
what's kind of wrong and you can scroll
down to the bottom to see what the
sequel is that it's messing it up
and also it didn't like I think this was
actually what was messing it up actually
the add column not actually the solution
on this again we can see actually
doesn't like the add column itself type
undefined so add column I think what I'm
doing wrong let's see we can click on it
yeah see I'm notice how I didn't put the
type right there that's what I was doing
wrong so I just copy and paste this
directly from students notice how I said
the quiz scores but since this is
already a column we put the name here
also this should be an S that's a typo
there too this should be type so type
give that a save rerun
my great and cool quiz scores migrated
successfully let's see what this looks
like okay so we can see here's quiz
scores on the end you can't really see
it that well so I'm gonna just select
quiz scores by itself from students so
we can see we successfully migrated over
so we see 89 94 72 and 13 442 16 and we
notice how if you look here and match up
it all looks nice so what we can go
ahead and do is rerun this migration and
I'm gonna say dot then so after we
successfully create this query I'm gonna
do one more so X and we're gonna do quit
interphase one more time and here we
wanted to just delete a column so let's
see there should be removed column and
just give the table name so remove
column the column you want to remove is
from students and we wanted to remove
quiz score one and we want to do that
three times right so like before we want
to create a little bit of an array so
oops so we're gonna do this three times
to delete each column and I'm just gonna
say promise dot all pass in that array
area and I think this is just the eslint
warnings yep so from our dot then we're
calling promised at all
killing all these scores because we
don't need them so our final little
cleanup so now I'd like to rerun this
migration but usually what happens when
I do this is it says you're all up to
date right and the reason for that is I
just ran this migration once you run the
migration you can't just spam run it so
what you do is you have two choices you
can create a new migration here and just
like copy and paste what you want over
there but since I was really supposed to
just run this migration like this the
first time what I usually do is I delete
from sequel eyes metadata and that's
where it stores where the migrations you
have run but since I just deleted that
we're actually gonna run two migrations
we're gonna run the quiz the quiz score
here as well so that's not good I'm
gonna go ahead and just like actually
comment this out so that way this
doesn't run so return that and I'm gonna
comment you out so you don't run but
it's gonna it's gonna run both of these
because I just deleted them so this is
not an ideal way to do it you shouldn't
really be deleting from sequel eyes meta
you should just write your migration
correctly like this beforehand or create
a totally new one and so what I'm gonna
do is I'm actually just going to also
alter table students drop column quiz
scores that way we can just rerun the
migration so select all
from students so we noticed our table I
basically just reset our table right I
just dropped the column and I can come
over here and see hey we're gonna take
we're gonna create a new column here
we're gonna move the data over then
we're gonna remove these last three
columns so when we write around the
Select statement we should see one
column here all our score is stored in
an array let's see if that happens so go
ahead and migrate down oh I forgot to
put a comma there rerun and cool looks
like everything migrated come over here
select all awesome we see quiz scores
pop up and of course this is a nice
little transition so as you can see
migrations are great for when you want
to move your data over change it the
format of way it's structured we change
this from three columns to an array and
there's lots of other different things
you can do with this take a look at
query interfacing and see all your
different options of things you can run
also this is a great way of basically
doing version control on your database
theoretically if I did this properly
what I could do is I could basically
populate this down statement to
basically reconvert my data from an
array back to three quiz scores and then
I could go back to how my database was
previously so it's like version control
for your database personally especially
when I'm developing I like to just go
straight for the up but definitely when
you start getting up into production
you're going to start you know clean the
down in case you have to revert your
database so that's it for this video
guys I'm gonna go ahead and save this
code commit it and push it up to github
so you can check it out if you want to
see the migrations here I'm gonna go
ahead and comment this back out again
because it works fine so thank you guys
for watching and I'll see you in the
next
you
you</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>