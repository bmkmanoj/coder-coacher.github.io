<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>OAuth (Passport.js) Tutorial #12 - Saving User to MongoDB | Coder Coacher - Coaching Coders</title><meta content="OAuth (Passport.js) Tutorial #12 - Saving User to MongoDB - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/The-Net-Ninja/">The Net Ninja</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>OAuth (Passport.js) Tutorial #12 - Saving User to MongoDB</b></h2><h5 class="post__date">2017-10-22</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/KRCh6mSSsb8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey gang welcome to your 12th a worth
tutorial and in this video we're gonna
take our users and save them to MongoDB
alright then so back to this trusty
diagram once again right now we're in
the passport callback function and we
want to take the user from Google their
information and we want to save that at
our own database that's the whole point
of this right so we've now created our
database using M lab and we've also
created our user model and schema using
Mongoose so that we can easily save new
user records to that database okay so
this is the kind of zone that we're in
at the minute so let's go ahead and
start saving these users once they've
logged in so we're going to be doing
that right down here in the passport
callback function remember Google has
come back with this profile for us the
person that's logged in and that's got
loads of different information about
that person so we're going to take some
of that information store it in our own
database right so to do that we're going
to need access inside this function
because this is where we're going to
save new users we're going to need
access to this user model that we
created so we're already exporting it
right here but we need to import it over
here so let's do that first of all const
preferably not in capitals and we're
going to call this constant use of the
capital u again that's equal to a
require and then the first thing we need
to do is double dot forward slash that
means go up a directory because right
now this passport setup file is inside
the config folder and we want to get
inside the models folder so we need to
jump out of the config folder first of
all so that's what this does then we
want to go into the models folder then
we want to look for the user - model
file so we've imported that user model
now and we can use that in here to
interact with our user collection okay
so we can save files to a user
collection and retrieve them update them
all that kind of jazz now inside this
function so before we do any of that
let's just log this to the console this
profile and see what information is
actually coming back to us that we can
use to save in our database so over here
I'm going to go to log in and log in
with Google Plus
this is just gonna kind of hang and by
the way the reason it's not redirecting
me to Google to say look which account
do you want to log in with is because I
literally just did that a minute ago and
so it remembers that okay so I don't
need to do it again so it kind of jumped
that step but the same thing has
happened it's locked me in using my net
ninja account all right and so right now
we're in this position right here we've
come back with the profile information
and we're logging that to the console so
let's have a little nosey at the console
to see what was retrieved so we just go
back up here a little bit we can see
first of all we have an ID so this is
the ID to my profile on Google right
that's their ID form it
and remember we're going to save this to
our record right we also have a display
name and we said that we wanted a user
name so I suppose that could be our user
name as well make sense so we can take
these two properties from the profile
this return to us and we can then store
them in our database which is what we're
going to do and by the way there's loads
more different things we could access if
we wanted to photos different stuff down
here in the JSON object that's returned
to us etc but we're going to keep it
simple to begin with and what we're
going to do is just use these two
properties right here the ID and display
name alright so how are we going to take
these two things and save them well
first of all we need to create a new
user right we've recognized that someone
has come to us and they said okay I want
to login using Google to your website
we've got that profile information now
we want to take that profile information
and make a new user out of it in our
database so the way we're going to do
that is use this model up here
this user model and we say new user okay
so inside here we can pass through this
function and this is where we're going
to define the data that we want to store
in this new user now remember we defined
the data structure inside this schema so
we need to provide a username and a
Google ID so let's do that username
first of all and what that's going to be
is profile dot display name remember
that is this property right here display
name so this object is the profile
object that's returned to us I'm
accessing the display name off it right
I also want to access the ID of it
because that's going to be our Google ID
for this user so Google ID is going to
be profile to ID so the profile function
is coming back we're taking that and
we're getting these properties from that
profile we're creating a new user based
on this information and then what we
want to do is we want to save this user
to the database so I can just say dot
Save and that's going to set this user
to our database now it knows to do that
because this user model right here is
created using Mongoose remember and
Mongoose helped us connect to our
database before in fjs so if we look
right here we can see Mongoose doc
connect and were connecting to this
database right which is stored in our
keys file so we're connecting to that so
our user model is connected behind the
scenes to this database so when we say
we want to create a new user using that
user model right which is what we're
doing and then save it it knows to save
it to our database that we have
connected to make sense cool so this
right here this is an asynchronous task
this save function right meaning it
takes a bit of time to do it's not
instantaneous right so we need to wait
for that task to finish before we move
on and do something so what this does is
return a promise so a promise means that
basically at some point in time this is
going to finish right and when it does I
can tell you so the weight tells us is
by allowing us to tack on a dot then
method and this dot then method can take
a callback function inside here which is
going to fire when this action is
complete okay so only when this is
successfully saved to the database will
this function fire inside the then
method I hope that makes sense and this
function is going to take a parameter
and the parameter is going to take is
the record that we've just saved so
we'll call this record new user make
sense right
and using federal function inside this
function what we're going to do is love
this new user to the console so console
dot log and will log out new user
created and will tack on the new user
that was created new user all right so
we automatically retrieve this but from
our database to say okay this is the
user that you have just saved and we're
logging that to the console alright so
then let's just preview this all out see
it's worked I'm going to go back over
here did I save that then nope I'm going
to go back over here and I'm gonna go
back to the login page then refresh then
I'm going to log in using Google so now
hopefully this will have retrieved the
information from our Google profile
created a new user assigned this data to
my record saved it to our database then
log this to the console so let's just
cross our fingers now and hope that
nothing has kind of buggered up to put
it nicely so down here at the bottom of
the console we can see new user created
that's the message we logged right here
we can see the user name is the net
ninja and by the way this is the object
from our Mongo DB instance now okay so
this is the object the record that was
created we see we have a user name the
net ninja which is what we retrieved our
Google ID which is what we retrieved but
we also have this other property ID or
underscore ID so I don't want you to get
these two things confused here one of
them is the Google ID and that's the ID
that Google gives to my profile my
Google profile right so that's their ID
and we're just storing it to make sure
we know when a user returns to us so we
can look it up later on this down here
if this underscore ID is something that
MongoDB is automatically creating for us
and that's the ID of our user on our
database right so this is the Google ID
from Google profiles and this is our ID
for our record this particular record in
our own database okay does that make
sense
cool
alright then so what I'm going to do now
is go through this process one more time
so I'm gonna go back I'm gonna go to the
hop in fact what I'm gonna do first of
all is show you this over here so this
is M lab this is the database we created
just refreshing right now to show you
now we have a user's collection and
inside here we have one document and we
can see that document the net ninja and
the Google ID and this ID up here as
well oh it's creating this record based
on my Google profile but what happens if
I do this again if I go to login and
then login using Google again well all
this is gonna fire the same code over
here it's going to take that information
and save it to the database again so we
get exactly the same thing logged to the
console and also if i refresh over here
we're gonna see that now I have two
records right even though the
information is the same and not any
we're saying to MongoDB look if the
information is the same don't create a
new record I'm not doing that so it's
taking the information again and
creating a brand new record in this
collection so you can see they both have
the same username and Google ID however
they both have a different ID for our
database okay now we don't want this to
happen because like I said if a user
comes back to us a second time to login
then what I'd like to do is say okay
this person's come from Google again
let's take their Google ID and let's see
if we already have that person with that
Google ID inside our database because if
we do I don't want to create a new
record I'll just retrieve that current
one and then use that for that session
make sense so that's what we're going to
take a look at how to do that in the
very next video</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>