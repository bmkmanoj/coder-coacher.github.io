<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>OAuth (Passport.js) Tutorial #9 - Passport Callback Function | Coder Coacher - Coaching Coders</title><meta content="OAuth (Passport.js) Tutorial #9 - Passport Callback Function - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/The-Net-Ninja/">The Net Ninja</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>OAuth (Passport.js) Tutorial #9 - Passport Callback Function</b></h2><h5 class="post__date">2017-10-19</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/nK6fkNShhGc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey gang welcome to your ninth a worth
tutorial and in this video I'm going to
talk about the passport callback
function okay so in the last tutorial we
set it up so that passport now is
ticking control when a user goes to
forward slash or /l and it interacts
with Google redirects them to this
permission screen right here so I can
log in with an account and when I do
that I get called back to the redirect
URI which is at full slash auth /ql for
slash redirect and we get this code
right here so I said in the last
tutorial that when this happens that
this right here wasn't technically true
we don't get information when we come
back to this redirect URI so we don't
have that information yet we just have
this code in the query parameter in the
URL right so this code then allows us
passport to go out and get the
information from the profile for us so
this diagram I've just updated and it
looks something a bit more like this now
so after passport takes control here
when it goes to forward slash auth
forward slash goggle when a user clicks
that they want to sign up with Google or
sign-in with Google then we go to the
consent screen which we did do we
clicked on signing with the net ninja or
whoever you may be
- grandpa mission and we go back to the
redirect URI with the code in a query
parameter at the top right the query
string so now we have that code and
marine this combat URI which is forward
slash forward slash goggle four slash
redirect we can then tell passport in
this call back or redirect URI that we
then want to interact with Google and
exchange the code for some profile
information so we can tell passport in
this route right here to do that to go
out and grab that and we're going to do
that in a second
then once you've got that information it
comes back and what happens when it gets
the information is it fires the passport
callback function alright so this is
kind of the route it's take
now I've changed this a little bit so
we're going to auth Google then we're
granting permission
come into the callback route on the
redirect URI then we're grabbing that
code that comes with it
exchanging that for profile information
using passport it comes back with the
profile information and fires the
passport callback function and remember
that passport callback function is right
here so this is the thing that fires
when it comes back with the actual
information about the profile but first
of all we need to tell passport to take
this code and exchange it for the
profile information right and we do that
in the callback URI right down here so
remember it's coming back here at the
end when we have that code that's where
it's redirecting to and it's bringing
that code with it right so before this
function fires right here what we need
to do is pass in passport authenticate
again so I say passports dots
authenticate and inside we're using
Google again and then we place a comma
so that's an extra piece of middleware
in this route so when they first get
redirected to this route before it sends
this message and fires this function so
before we see this it fires passport to
authenticate Google now this is a little
bit confusing because right here we
already fired that where we want to sign
in so what's the difference well the
difference is that this time around we
have a code in the URL right here right
so passport can see that we have that
code now and instead of redirecting us
to the consent screen again like it did
up here it sees the code so it says okay
well this person has already been to the
consent screen now obviously what the
developer wants me to do is take the
code that it's come back with and
exchange that code for profile
information so it's going to go out to
Google on the fly and exchange that code
say look I have this code this user said
we can authenticate them using their
Google profile so I'm here with my code
to get their profile information so it
grabs that and it comes back and then
what happens before this fires right
here
for even gets in this comes back with
the profile information and let's just
save this this callback function is
fight right right here so that marries
up with this diagram we're granting
permission we go to the readout you read
our at URI then that piece of middleware
it says passport authenticate is inside
this redirect URI this Handler and it
goes out grabs the info comes back and
about this point here fire is the
passport callback function right fires
that first before it executes the rest
of this stuff right here okay so now
what I'd like to do is fire this
callback function so first of all let's
just lock something to the console and
see what happens we'll say console dot
log and we'll say passport callback
function fired okay
so let's save this and check this out in
the browser I'm just going to go back
one so we can all think skate again and
if we see in the browser we right to the
bottom down here you see we're now
listening for requests so let's keep
that open and I'm gonna go and say I
want to authenticate with the net ninja
so we do that and we're going back and
we can see right here the passport
callback function fire it
so we're firing this function right here
now right it's gone out is grab the data
right here it's done this gun out
exchange that code grab the data and
it's fired this callback function but if
you look at this it's kind of handing
that it's not doing anything so it's
done that it's five the callback
function bots at the minute it's not got
on to this bit right we're not sending a
response to the browser so the callback
function what does that do well it takes
in a number of parameters right and the
first parameter is the access token so
we're just gonna fill these out one at a
time so I'll say access token the second
is going to be a refresh token and I'll
tell you what these are in a minute the
third one is going to be the profile
information that we bring back
and the last one is going to be a
function called done all right
so first of all the access token this is
a token that we receive from Google so
that if we want to go back and say alter
the users profile you know going to
their mailbox read their emails we can
use that access token to do that because
we've got it from Google right and
initially we said that we wanted to do
that on the use of granting us
permission now we've not done that in
this case so we don't really need the
access token but that's what it's for
the Refresh token is to kind of refresh
the access token because this expires
after a certain amount of time so that's
what this is for and again we're not
really going to be using these two in
this tutorial however this thing right
here this profile this is the
information that passbook comes back
with when it takes that code to Google
remember that code that we get back it
takes that code to Google and it brings
back the profile information so this is
what it's bringing back right here okay
and this is a function called dawn which
we need to call when we're done with
this callback function so for now let's
just log out the profile information
that it brings back I'll say console dot
log and will log out the profile
all right so save that let's go back now
and bring up in our console there let's
sign in with the Met ninja again and
this time we can see it's brought back
the profile and we're logging that to
the console so we can see all kinds of
information in this profile we can see a
unique ID so that's the Google ID
associated with this profile the display
name the name family name etc any photos
associated with it gender the provider
and we also get a JSON object down here
with more information as well such as
the nickname etc okay so it's bringing
back all that profile information now to
our application and we're logging it
here in the callback function so hope
this kind of all makes sense in terms of
where we are at the meeting yeah it's
hanging at the minute and we're going to
sort that out over the next couple of
tutorials but I hope you understand
where we roughly are in the whole kind
of process so just a dead quick
refresher we've said we want to sign-in
with Google we go to this
orthe focus google Thunder we hand it
over to passport that says okay you want
to sign a me Google will send you to the
Google permission screen we granted
permission comes back to the read a
redirect URI with the code we call
passport authenticate again you see that
we have a code in the URL and it says
okay I've got the code I'm gonna
exchange that for profile info so it
interacts with Google with that code
brings back the profile info then we
fire the passport callback function with
that profile information which is where
we are up to so far so I guess the next
step is to take that profile information
and to do something with it
in our application and we're going to
take a look at that over the next few
videos</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>