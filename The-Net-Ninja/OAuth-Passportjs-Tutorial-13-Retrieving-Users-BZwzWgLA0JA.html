<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>OAuth (Passport.js) Tutorial #13 - Retrieving Users | Coder Coacher - Coaching Coders</title><meta content="OAuth (Passport.js) Tutorial #13 - Retrieving Users - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/The-Net-Ninja/">The Net Ninja</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>OAuth (Passport.js) Tutorial #13 - Retrieving Users</b></h2><h5 class="post__date">2017-10-24</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/BZwzWgLA0JA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hey guys welcome to your 13th ooofff to
toriel and in this video i'm going to
show you how it can retrieve uses from
our database so then in the last video
we went ahead and created a new user
record and saved that to our database
and the problem with this was if we
logged in twice it just created two
records and we didn't want that so what
we'd like to do is when a user logs in a
second time we want to perform a check
on our database we want to see if that
user already has been to us before and
we have their Google profile ID stored
so the first thing I'm going to do is
delete one of these bad boys so we only
have one record for me for my profile
inside this database I'm just going to
refresh because it doesn't seem to have
updated okay let's just delete that
again
there we go we only have one record
inside this collection now for me which
is good so now when I log in a second
time so if I go back over here if I log
in here a second time what I'd like to
do before I create a new user I'd like
to perform a check to say okay well I've
got their profile information and I'm
going to take their Google ID now what
I'm going to do is search my database
MongoDB to see if a user exists with
that Google ID if it does I'm just going
to retrieve that record from MongoDB if
it doesn't then yeah go ahead and create
a new one because that person obviously
hasn't been to us before so let's first
of all get rid of this junk up here we
don't really need to log these to the
console anymore so and we'll get rid of
that comment and the first thing I want
to do is check if user already exists
in our database okay so how are we going
to do that well I said we could use the
user model to interact with our
collection we did that in the last
tutorial by saying okay I want to save a
user this time I want to search for a
user
so again we're going to use this user
model and we're going to use a method
called find one okay so this is going to
allow us to find one record inside our
database based on certain criteria and
the criteria we want to base it on we
pass through here in an object now we
wanna look for the Google ID property
stored in our database so that's what we
pass through as the property we want to
look for and we want to see if it
matches the profile ID that comes back
from Google so I can save profile ID all
right so this again is an asynchronous
task much like this down here this save
function so it takes some time to do and
returns a promise which means we can
check on dot then which will take a
callback function that will fire when
this has completed so when it's
performed this search after that's
completed it will fire this callback
function and if it finds this record
that matches the Google ID then it's
going to return that to us inside this
callback function so record this one
down here new user but if it's found one
in our database already then we'll call
this one current user because they
already exist they've been to us before
so I'll say current user is retrieved
from the database okay so down here if
user and I'll explain this in a minute
we're gonna do something so this right
here if it finds the record and it
returns its it was then this right here
is going to be an object it's gonna be
that record and it's also going to be a
true T value if you like okay so this
will equate to true and it means we
already have a user so I'll just pop a
comment here saying already have the
user if it doesn't find this and it says
okay I can't find a profile inside your
user collection which matches this
profile ID returned to us from Google
then it returns something to us but it's
not that record and it evaluates as
false so this will fail therefore we can
assume if it fails then we don't have
that user right so we can say an else
statement if we don't have that user
then it will do something else we'll
create a new user
so we'll say if not create user in our
DB so were performing a check it to see
if that user already exists so at this
point right here we can be pretty sure
that that user has not been towards
before therefore we want to take their
information and save it to the database
so we can grab all this junk that we
created in the last tutorial and just
paste it all right there so we're
creating that new user and saving it
if we can't already find one in our
database that matches that Google ID
hope this makes sense if we do find one
in the database that matches that Google
ID it's going to return it to us and we
have access to that profile so I'll log
that to the console I'll say console dot
log and I'll say user is and then we'll
tack on the current user
like so alright so either way at this
point once this has all finished here
either way we have a record either a
current user if they've already been to
us before or a new user right so by the
end of this combat function we have a
user ready and available to us
so let's give this a whirl let's save it
now and let me try logging in using
Google Plus again so remember we already
have one record so right now because
I've already created a record and I've
logged in before then when it performs
this check hopefully it will find my
profile in MongoDB and come back and say
hey we have a current user therefore
we'll just log that user to the console
and we don't need to create a new one
all right so let's save it and go to log
in with Google+ gonna kind of hang there
again but if we go over here now and
refresh then hopefully there will still
only be one record note we have to
that's strange so let's just take a look
inside here and we can see user is this
so it shouldn't have saved that so else
I've definitely saved this okay let's
just delete these again and try it again
because it could just be that this
didn't pick up the the changes so I'll
delete both of them in fact and start
again
so we have no records whatsoever now
let's login it with Google so the first
time around we should create a new
record so let's refresh over here
get that record cool there's one at the
minute now if I stop this process go to
the homepage then I'll go to log in
again and try logging in again this time
if i refresh over here
fingers crossed now the will not be tea
records cool
now there's only one record so it's
obviously just an issue with it didn't
pick up the the Save Changes okay so if
we now view our console we can see that
the new user was created the first time
around we're logged in when there wasn't
already a record in the database the
next time around
it says the user is and it retrieves
that instead of creating a new one okay
so the record we created right here it
retrieved the second time around and you
can tell that because the IDS are the
same that's with five nine ends in f8
that's with five nine ends in f8 alright
so there we go that's how we perform a
check to see if the users been to us
before and how we distinguish new users
from existing users so in the next video
we're going to move on and I'm going to
explain the next step that we need to
take in this authentication process</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>