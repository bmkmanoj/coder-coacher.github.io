<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Amazon S3 with PHP: Tokenising Download URLs (5/6) | Coder Coacher - Coaching Coders</title><meta content="Amazon S3 with PHP: Tokenising Download URLs (5/6) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Amazon S3 with PHP: Tokenising Download URLs (5/6)</b></h2><h5 class="post__date">2014-11-28</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/8s2vvKqybms" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so we've looked at how to upload files
list files and grab the URL for objects
in a bucket but what happens if we want
to protect files so they can't be
publicly read without a token now this
is a really good idea for about some
kind of membership system if for example
you were only allowing users that had
some kind of membership access to your
website to be able to download files
what you're going to need to do is
tokenize the URL so it can't be given
away to anyone else there needs to be a
valid token and we can do this really
really easily with the get object URL
method that we saw when we were actually
listing files instead of having a public
file that we can just click download on
and download that file it will append a
token which will expire after a certain
amount of time so what we're actually
going to do then is inside of our bucket
here we're going to change the
permission for this upload me txt file
so as we can see in our permissions this
link is publicly available to anyone
anyone with this URL can download this
file what I'm going to do over in my
permissions area here is I'm just going
to remove all of the permissions for
this and just hit save now what that's
going to do is when i refresh and click
on this again it shows a lock near here
so when I click on this file you can see
that we get an access denied method
message now you can set this up so you
can have access to it from here but you
know you can do that from this add more
permissions button just down here now
what we're going to do then is from
within our application we're going to
tokenize this so we have access to it
with our token so let's do this now
we're going to create a new file and
we'll just call this token dot PHP and
again we'll set this up in the same way
as we did before by just requiring in
our start file so we've just got fresh
file to work with so the object that
we're going to be pulling down this
again will maybe be stored in your
database when you allow your users to
upload the files or you might just have
a list of private files that are
available to
on your website this is in uploads and
it's called upload me txt so we've got
the name of the object what we now want
to do is create the URL so we do a
similar thing as we did when we were
listing we use get object URL we pass in
the bucket name that we want to pull
this from remember this that's inside of
our config in the s3 key and the archit
then we pass in the object as we want to
pull it down then this is pretty much
similar to how we did it before but
we're going to add an additional
argument to this method in just a moment
so I'll just call this token and let's
create an anchor on the page here with a
download label and in here let's just
echo out the URL so similar to what you
would do inside of your application so
obviously now what's going to happen is
when we head over to token dot PHP I'm
going to hit download and I get my
access denied message so what we're now
going to do is when we pass in a third
argument this is going to tokenize this
URL and give it an expiry time the token
will expire after a certain amount of
time and not allow access to that so the
situation is a user lands on this page
and let's say we want to give them one
minute to download this file so our
token is going to expire after one
minute after one minute that file will
be inaccessible so if a user copies and
pastes the link that we output here then
it's not going to be available to anyone
else because the token would have
changed now notice once I've given this
plus one minute you can do anything else
like plus two days however you want to
deal with this we can actually download
this file and that's going to give us
access so taking a look at the URL you
can see how this is changed we've got an
AWS access key ID and then we've got an
expires time and then we have a
signature here so this is what's
appended onto the URL now while I've
been talking ten seconds has probably
just part well we can change this to ten
seconds to just test it because one
minute's a little bit too long so let's
go back and
fresh we click on this file and as you'd
expect that I'll now allows me access to
that file I can download it and access
it as normal as an authenticated user
but now what's going to happen is when i
refresh once ten seconds has passed you
can see that again we get an access
denied message and we can see that the
messages request has expired
so if I'd have given this link copied in
copy and pasted this link to someone or
somewhere else and someone was trying to
access it they would no longer be able
to access this file because the token is
expired so it just goes to show how easy
it is to actually tokenize a URL private
access given the time that you want this
to expire</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>