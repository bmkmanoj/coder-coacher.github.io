<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Laravel Subscription with Card Payments (7/11) | Coder Coacher - Coaching Coders</title><meta content="Laravel Subscription with Card Payments (7/11) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Laravel Subscription with Card Payments (7/11)</b></h2><h5 class="post__date">2014-07-15</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/XIFBJiAWdUc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so now that we've subscribed we know
that all of the information in our
database will have been updated as we
saw earlier we've got a stripe active
but we want to be able to cancel our
subscription now as I mentioned at the
start of the series when you cancel a
subscription the stripe active field in
your database won't be set to zero
that's because you've paid for a month
upfront so what will happen is the
unsubscribe process will basically mean
that you still remain a Premium Member
or subscribe to member but only up until
the date a month from now basically off
a month from when you first subscribed
so let's take a look at a couple more
pieces of cashier functionality that we
can use to check if the user has
canceled so I'm gonna create an if
statement just here I'm gonna say if
user cancelled and I'm gonna end that if
there and I'm gonna say here you are not
subscribed or something like that we'll
change this a bit later to tell the user
when their subscription does actually
end let's look at the actual
unsubscription process this is extremely
simple I'm gonna create an unordered
list here just with a few links in so
this link is going to be to unsubscribe
so cancel my subscription and we want to
link through here to a route so inside
of routes let's create that now so
before a user can cancel we want to make
sure they are unsubscribed so we need a
route here or a route group and in here
we're gonna say before we want to make
the user make sure the user is actually
subscribed cool so now inside of here we
want to say route yet and this will be
say cancel and we'll give this a name
so we'll call this subscription cancel
and again we're gonna use this
subscription controller and this time it
will be get to cancel so we want to make
sure this is really important that
before we do anything here we want
cross-site request forgery protection
and the reason for that is anyone could
either give someone the link or embed
the link in an image resource this would
count all the users account you can set
up a form and use post here all I'm
going to do is on this link that I
generate here and we know the route now
so we can say URL action subscription
cancel I think that's what we called it
yeah what we can do is on the end of
here we can say token equals and then we
can generate a token here cross-site
request forgery so can help her so now
when I hit enter on here we've got the
cancel my subscription link which if we
inspect we have the token on here so if
this token isn't modified it won't let
us go through to this link so it's
important that we do have that
protection so when I click cancel my
subscription we obviously don't have
this method so let's go ahead and create
this now on the subscription controller
so down here we create this down here it
cancel and this is extremely easy all we
need to do is say this user subscription
cancel easy as that and then we
obviously want to redirect the user and
we're going to go back to the main
subscription page and we're gonna pass a
notice in here saying sorry to see you
go so we've now got the ability to count
so let's just check that this works so
I'm gonna go back and I'm gonna hit
cancel my subscription that should
cancel the user subscription
and redirect us back so it says here
you're subscribed Thanks and then we've
got this message saying you are not
subscribed that's the message I put in
there earlier now that this is returning
true so I'm gonna say your subscription
will end on and then I'm going to output
the date that the users subscription
ends on now because we now have carbon
available for these dates we can say
user subscription ends at and then we
can format that however we want so I'll
do something like add a month a year and
we can check there we go so your
subscription will end up then so that's
how we cancel a subscription but we've
got a problem we've still got this
cancel my subscription link here and
when I click that you'll notice that
that will return us straight back to
this page and it says sorry to see you
go so we basically perform the same
action again so we need to do something
to stop this so what we want to do is we
want to create another filter that
basically says that the user has not
cancelled so under filters let's create
a not cancelled so we've got a not
subscribed but let's do not cancelled
now so what we want to do is we want to
basically apply before to this we want
to say not cancelled and then now what's
going to happen is when we click cancel
my subscription we just redirected and
we don't actually hit that controller
but we want to hide this anyway so let's
do that now so under here we can just
create an if statement and we can say if
user cancelled and just nagae that and
then we can end that if there there we
go so now we won't see that oops
just check and there we go cool so let's
just refresh here and then we go
so we're subscribed our subscription
will end in the next video we need to
look at how the user can resume their
subscription if they still want to
continue to have a subscription after
this date shown here</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>