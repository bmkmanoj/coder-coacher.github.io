<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>PHP URL Shortener: Build (Part 3/3) | Coder Coacher - Coaching Coders</title><meta content="PHP URL Shortener: Build (Part 3/3) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>PHP URL Shortener: Build (Part 3/3)</b></h2><h5 class="post__date">2014-04-24</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/QN2VXBNujRs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so now it's time to actually build the
application this URL shortening
application but before we write any code
we can look at the database schema and
we're also going to talk about the
directory structure and file structure
of this as well so for the database
we're going to need to build up a scheme
of this to store links so I'm using a
database called website at the moment
but obviously depending on your
application this might be different we
might just choose to call it if
something different let's do a show
tables command and you can see that
we've got no tables at all so let's
build up this database table that's
going to store our links for us so we
issue the create table command and we
will choose where we've got four fields
here so it's ID URL code and created so
the ID is just going to be the auto
incrementing ID this is extremely
important because we're going to be
using this to base convert this number
to give us our unique code that's going
to identify the shortened URL so this is
going to be an integer it's going to be
not null and it's also going to be the
primary key of this table and we also
want this to be an auto increment that's
extremely important for every record
that we create we want this to increment
up and this will start one so the URL is
going to be a VAR char and that's going
to be 255 characters and the code is
also going to be a varchar' that's just
a variable character and that's gonna be
12
now the created app will be a date/time
field which will store the value using
the now function so oops let's just
change this because we didn't supply a
table name so we're going to call this
links and there we go
so let's now issue the show tables
command that says now we've got this
links table in here and let's describe
this table just to make sure we've got
everything set up as we want so we've
got our ID URL code created looks like
the types all fine and we've also got
the primary key and the auto increment
in there so now what we can actually do
is talk about our directory structure
we've already built out in it
stop PHP in global dot CSS files the
star sheets not important anymore what's
going to happen then is we're going to
submit through this shortened dot PHP
file which we've got created here
obviously no code in that's then going
to make use of the shortener PHP class
within the classes directory so that
we're going to be building the actual
class inside of here that's going to
handle making and getting the URL as
well as connecting to our database so
inside of the root directory we've also
got redirect to PHP which is going to
actually redirect based on a URL that's
passed through and we're also going to
be creating an HT access file which will
handle that as well so that won't that
will be the part where we have the nice
short URL now before we start building
any of the shortener dot PHP class I'm
going to be connecting to my database
within this class and it's obviously
important to know that you wouldn't
really do this in a real life situation
you'd probably be connecting to your
database somewhere else so we're just
going to be doing it inside of here for
demonstration purposes but ideally you
would have some kind of database handle
a class something like that that you
would use here but we'll just do this
because it's you know the tutorials
about just building this application and
we don't waste too much time building
something we don't need to so let's
define this shortener dot PHP class and
look at what we need in here so the
class is going to be called shortener
and inside of here we're going to have a
database property which is going to
store our database connection so we'll
look at doing this now so this will be a
protected property and we'll call this
DB so when we instantiate this class
when we go to use this functionality
we're going to have a constructor
function which is run when this class is
instantiated if you're not sure what
this means don't worry we'll look at
doing this later with the new keyword
but the job of the construct in this
case is to connect to the database so
we'll say for demo purposes and like I
said you probably have
some other way to connect to your
database inside of here we will say this
DB equals and this is going to be a new
MySQL I object and connect to our
database so at this point we're actually
connecting to our database via the
server that we choose we provide the
username for the MySQL server the
password and then also the database name
in our case it's website so this will
now connect about database we're not
doing any error handling here or
anything like that we can ignore that
we're just going to do this for demo
purposes now we'll go ahead and outline
the functions that we need in here the
first one is going to be make and this
is the job of this or we can call it
something like make code the job of this
is basically going to be to actually
pass in a URL and return the code that's
been generated and also store this as
well now we also going to have a get URL
so we have public function get URL and
this is going to have a code passed into
it in actual fact this is going to have
a URL passed into it as well so we may
as well define that now so get URL it's
going to have a code passed into it and
that's going to return the URL that we
need to redirect to now we're going to
have a private or protected function
whichever makes sense if you can extend
this class protected function called
generate code and the job of this is
going to be to actually generate a code
based on a number and that number will
be the auto increment ID in our database
table so that's how that's how our class
is going to look
let's though focus on submitting this
form and passing the content through to
shortened PHP to make use of this
functionality that we haven't quite
built yet and this will sort of
demonstrate the workflow that we're
going to be using so inside of here
we're actually going to be setting a
session later on to redirect and show a
message on the index page so we need to
use sessions start to allow sessions to
be used so we initialize that and
because we have our shortener class we
need to require this in to be able to
make use of its functionality
so this is in classes slash shortener
but PHP and we can instantiate this and
test everything works actually so we can
say s is a new shortener so once we run
this line what's actually going to
happen is we're actually going to run
this block of code here and connect to
our database and then we'll have DB as
our MySQL I instance so in this case we
can use our database functionality
throughout now short in a class so we
need to check here that a URL has been
passed through to this file from our
form so we use is set and we check post
URL and then inside of here we can go
ahead and store that in a variable just
so it's easier to use like so so let's
echo this out just so we can test that
this works so what we should see now is
we shouldn't see any errors through
connecting to here and from our form we
should then go through to here and we
should see the URL that we submitted out
there so let's enter a URL in here and
it's shortened and there we are we can
see that so we know that's working we're
not seeing any errors from this so we
can assume that we've connected to our
database so instead of doing this what
we want to do is we actually want to
make use of our mate code method which
remember we haven't built yet so I'm
going to say if code equals we're
assigning at the same time checking that
a boolean value returned from the make
code method is true so we use them we
use mate code and pass in URL we can
echo out the code and that's it so
otherwise there was a problem but we'll
deal with that later so what's happening
here is we are calling the make code
method that we defined here this is
going to return a code remember it's not
actually going to return a variable en
it's going to return an empty string or
a string with contents in and if it
turns an empty string then
we'll assume there's a problem otherwise
there'll be a code here which is you
know valid code it's not an empty string
so let's focus now on building this make
code function or method so what we need
to do here is first of all well we don't
need to do this but I'm going to trim
the URL that was passed through and what
I want to do is check that this was a
valid URL remember we're doing front-end
validation but this means that people
can change the type of field that we're
working with and they can bypass that
validation particularly if the browser
doesn't support front-end validation via
the html5 URL input type so we're going
to use the filter VAR function passing
in the URL and we're going to filter
this making sure it's a valid URL so if
that's false e then we are going to
return false from this function or we
can just return an empty string that
would keep more consistent with the fact
we're returning a string and at the end
of this anyway so this will return this
will validate as false in an if
statement so what we now want to do is
once that is out the way and we haven't
returned at this point we can escape the
URL we're going to do this first of all
before we start using it in queries
because obviously we have the potential
for SQL injection if we don't escape so
we can access this DB that we've already
seen up here we've already set that to
the MySQL instance I mean you could we
can use the escape string method or the
real escape string method they do the
exactly the same thing this is just an
alias of real escape string and we pass
in the URL so let's echo out the URL
just to make think that or return the
URL just to make sure everything's okay
we're not out checking and doing this
but in this case it should just echo out
the URL so just purely for testing this
works it's shortened there we are so we
know that everything works now okay so
in
instead of returning the URL we want to
first of all check if URL already exists
so that's what we're doing here and we
need to issue a query but we're going to
store this inside of a variable called
exists so we say this DB query and the
query will be selecting the code from
the links table and that is where the
URL is equal to the URL that we've
already escaped and passed through so if
the URL does already exist then we can
just return the code so returned code
otherwise we need to generate and store
URL and code so we'll do this in a
moment so how do we check if this
actually exists well this presumably
would return a positive integer it
should always be 1 because we're never
storing more than one of the same URL so
in this case we can say if exists num
rows and if that's the case we obviously
just want to return the code so from the
function or from the method we return
exists which is this up here fetch
object this will return us with the
first result code so we're returning the
code so let's check that this actually
works by inserting a record at the
moment nothing's going to happen because
when we type in a URL here click shorten
this doesn't exist so we're not
returning anything from this method but
let's insert a record just to test this
so I'm going to insert into links and I
want to provide a URL a code and a
created value so the values for these
are going to be google doc code at UK
the code we'll just put as goog 1 2 3 or
something and the created that value
will be the now function so now when we
select everything from the links table
you can see that we've got your out and
a code
so what should happen now is when I go
ahead and enter the BW Google Code at UK
here we should be returned with the code
which we are so that's in the case that
you a user enters a URL that already
exists therefore we don't need to
actually generate or insert anything in
the database or generate any codes
otherwise let's get a little bit more
specific what we need to do we need to
insert a record without and without a
code the reason we do this is we insert
a record and then from the ID that of
the inserted ID we then generate the
code then we go back when we update the
record with the code so let's um do this
now we'll just capitalize this I to keep
all our comments consistent we'll say
and we'll also pull this down insert is
and this is going to be another query so
DB query we are inserting into the links
table and we are inserting a URL and a
created value then the values for this
are going to be a URL we know this
it's just URL and created out which is
going to be the now function so once
that's created and we haven't actually
stored a code alongside of it so when we
look inside of our database we haven't
actually run this but we'll have a URL
and code will be null so now we want to
generate a code so generate code based
on inserted ID so we're going to create
or we already have defined up here
another method for this so the code is
going to be this generate code and that
will be based on the insert ID so the
number that we're passing through to
this method which we discussed earlier
it's going to be this DB not this insert
remember the insert ID property is
available from the actual database
object itself
last inserted ID then we go ahead and
update the record with the generated
code in any problem is we haven't
actually generated if a code yet because
the functionality in here doesn't exist
so let's do that now this is extremely
simple
it's just returning what's returned from
the base convert method or function in
PHP now this will obviously just change
the base so we have a number in this
case if it's one we want to convert from
base-10 to base-2 six now what's going
to happen here is if the ID of the
record is one converting that to base 36
is just one so we might consider setting
the auto increment at an extremely high
value initially so we can do that by
saying alter table links and we're
setting the auto increment to and I'll
just choose a hundred million now I'm
not saying this is the best idea there
are probably better ways to actually
generate unique codes but in this case
we always know that the value is going
to be unique because it's just changing
the base of a unique auto incrementing
number so although if you don't set your
auto increment value in your database to
something like 100 million you'll get
stuff like 1 2 3 4 coming back as your
unique URL which really if you think
about it is still a short URL so it
shouldn't be a problem
so we've generated the code we can now
go ahead and update the record that we
just created with this new code so let's
perform the update query now and we'll
say this DB and in fact we don't
actually need to store this in a
variable that will get rid of that so we
say this DB query so the query this time
is updating the links table setting the
code equal to the code that we've just
generated so you can plug that in there
and this is where the ID is the oops
let's just get rid of that single quote
there
back there so we're updating where the
ID is the last inserted ID or we can
update where the URL is the URL so we'll
go with that option because it's easier
we've already escaped this value not
that we need to escape an insult ID but
anyway this is how we'd end up having it
look so we're updating the code value
where the URL is the same as the URL
we've just generated so now what we can
do is inside of here would turn the code
so that's pretty much it we will get a
code back for a newly inserted record
now so if we select everything from
links you'll notice that we only have
one in here let's go and generate a new
one so we'll choose google.com this time
click shorten and that's the unique code
will be forwarding the user back to the
index page in a moment but let's take a
look inside of our database and we can
see here we've got an idea of 100
million the URL is Google comm and the
code is this let's also check that this
works in the same way as we saw before
so google.com should return the same ID
and that hasn't inserted another record
it's just returned the same code perfect
so now on to the shortened PHP file
again let's head back over to that so
instead of occurring the code that isn't
useful I'm going to set a session value
here with feedback and this is going to
be generated or generated and I'll say
your short URL is and we need to output
a URL here so in this case I'll just say
an anchor and the short URL is going to
be the same as the path we're currently
working in so if I just copy this and
paste that into both here and into here
let's just do a little bit of escaping
because we've got some double quotes
here so let's
scape this let's escape this now after
this we want to insert the actual code
that's been generated we know that we
have that it's here so we can insert
that to there and we can insert that
here as well so let's just get rid of
make sure this is all okay perfect so if
not we've got a problem
so either the well no the only problem
really we've got at the moment is if
that the URL doesn't isn't valid or if a
value hasn't been supplied that also
equals about invalid URL so we're sort
of doing two validation pieces at once
so I'll just say there was a problem in
valid URL perhaps so let's test this out
just to make sure we haven't done
anything wrong so let's enter okay cool
so that looks like there were no errors
so let's make this a little bit more
useful the reason that we're storing
this in a session is because inside of
index.php we're going to make use of
these sessions to output this to the
user and then remove the session the
sort of placeholder of just telling the
user what's happened so I'm going to
start sessions up here because down here
I'm going to want to check if these
sessions actually exist
so here I'm going to create an if
statement and use is set to check if
this feedback session exists now if it
does exist down here I want to actually
unset this so the next time the user
refreshes the page we don't see the same
feedback or visits another page and
comes back that would be a little bit
annoying but before we unset the session
we want to output a paragraph and this
is going to be basically what's in
session so session feedback and that's
it so let's test this out as we did
before but we didn't get any feedback
where you can see that the session now
has been brought to us let's do this one
from the beginning so let's enter a URL
it does exist so Google calm and oh of
course right so if we just
go back over to shortened up PHP we're
not actually redirecting anywhere which
isn't useful at all so down here what
we're going to do is redirect back to
the index page just using the header
function so now what's going to happen
is when we enter a URL that already
exists we click shorten that session
that we created is now going to go
through here when we refresh that will
go so now we enter a site that doesn't
exist in the database we click short and
that generates it for us and we can
click through and go through to it so
this works perfectly now everything is
actually working let's just head back to
the Google example so when we click this
now we're going through to URL shortner
slash and then the code this is not
useful because we haven't actually built
the functionality that deals with
redirecting the user so what we need to
do is inside of redirect dot PHP build
the functionality that's first of all
going to grab this value and then
redirect to the actual URL that's going
to pull that from the database so we
want to make use of the short and a
class so inside of classes this is
shortened PHP and we are first of all
going to check if the code value inside
of the get super global is is exists you
might be thinking well where's this
coming from because what we're actually
doing is when we are entering a URL
we're seeing this well yeah we are
seeing this but in htaccess far what
we're going to do is we're going to use
a rewrite to send something like this
through to redirect PHP code equals and
then the actual code so in this case if
we chose goo 1 2 3 that will then go
through to Google based on this get here
so we'll do that later after we finish
this functionality we'll make sure it
works first then we'll do the URL
rewriting but now what we want is
instantiate a new shortener object and
we also want to store the code from the
sessions this is going to be get code
and down here
we're doing the same sort of thing
accessing the yet URL method of the
shortener class or object now but we'll
also then assigning the value return
value of that as a URL so we say s yet
URL and then we type in the code so
we're getting a URL from a code if that
is the case let's echo out the URL so
the aim of this part of the class is to
take this code do a database lookup for
this code in this case we know it exists
here and we want to return this value
and then we're going to echo out the
page so over to shortener PHP again we
are going to fill in the get URL method
this is fairly straightforward there's
not much to this a few lines of code so
we're going to say the code is equal to
this DB query so we're doing a query on
the database again and we're obviously
selecting the URL from the links table
where the code is the code now we
obviously need to escape this value so
let's say code equals this DB escape
string code extremely important to make
sure that that's escaped before we do it
you could of course put this down here
in here but let's keep it separate so
now that we've done that we want to
check if this has returned any values or
any rows so we say if code num rows just
to make sure that that's a positive
integer then we want to return the URL
so we use fetch object as we did above
for the the method here so we fetch the
object and return the URL but by default
we want to return an empty string in
case this doesn't work we could put an
else on here but there's no not not much
point so here this should then escape
code which will place it into a query
returning the URL where the code matches
this column and if a value has been
found that will then return that you
to us so now what we should see is that
return the correct code let's test it
with another one so entering this code
should return google.com
there we go does so now that we've got
this working we can actually make this
useful so on the redirect we want to do
a header location two index dot PHP no
we don't we want to redirect to let's
double quote this so we can let your
that URL found in there so we know that
we've got the URL let's pop that in
there and we'll also kill the page as
well and then by default will redirect
through to index dot PHP this is
important because if this satis this
wasn't satisfied then we just redirect
index so if we type load of rubbish in
here we'll just go straight back to this
page otherwise we'll go through to the
URL so now that we've got this working
let's set up the htaccess file obviously
I'm using a patch if you're using a
different web server this will differ
but the concept is the same we want to
take any alphanumeric string after the
URL here after this root directory where
the htaccess sits and we want to
redirect this value into the redirect
PHP file so let's now create the HT
access file that's going to allow us to
take a value like this and then redirect
it through to our redirect PHP page so
I'm going to create a new file and I'm
going to save this inside this directory
as HT access now this is going to vary
depending on which web server you're
using I'm using Apache but the concept
is the same here we want to rewrite the
URL to pass an alphanumeric character
through to redirect PHP and make use of
the code in the query string so this
isn't difficult to do we're going to
turn the rewrite engine on and then
we're going to set a rewrite rule and
the rewrite rule
is going to be any alphanumeric
characters that's lowercase a to Z and
not to 9 we're only dealing with
lowercase here remember base 36 and
we're going to redirect this through to
redirect PHP code equals in the
placeholder so for example if we use
Google on 2 3 and we paste this in here
that's what it looks like if we supply
that value so when we hit enter now that
goes through to Google very very very
straightforward with URL rewriting so
let's just quickly test this out for one
last time type in up dub-dub and let's
choose google.de and hit shorten there's
our shortened URL we can check that this
exists in our database and it does
indeed with a new unique code when we
click on this we go through to Google
and you can go ahead and paste that link
elsewhere and it will work in the same
way so we built a URL shortener with PHP</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>