<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Passwordless Authentication with Laravel: Flushing expired tokens (6/6) | Coder Coacher - Coaching Coders</title><meta content="Passwordless Authentication with Laravel: Flushing expired tokens (6/6) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Passwordless Authentication with Laravel: Flushing expired tokens (6/6)</b></h2><h5 class="post__date">2016-10-13</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/YS9B-mseQLI" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">all right so let's look at an optional
command that we can create to basically
flush out any expired authentication
tokens from our database obviously if
users are requesting these tokens but
then actually not using them we may want
to just flush them out so we're gonna
create a console command for this so we
can do this on the command line so we're
gonna say PHP artisan make command and
we're just gonna call this clear expired
user login tokens and we can go ahead
and start to implement this so over in
our console under commands let's go
ahead and give this a name and
description and then go ahead and fill
it in so we're gonna call this off or
it's good least gonna be under the auth
namespace and we're gonna call this
clear tokens and we can just give this a
description and we'll just say flush
expired authentication tokens and now
down here and a handle we don't want to
write too much code we can really create
go for this so if we just pull in our
app user login token name space at the
top what we ideally want to do is
something like user login token expired
and then just call the delete method
just to get rid of them so we know that
over on our user login token model we
already have the token expiry so this is
really the perfect place because
creating a scope here means we can make
use of this expiry and if we want to
update the expiry and future it will
just work so let's create this scope
then so it's gonna be scope expired and
into this obviously we receive out query
builder and we just want to return query
where the created app date of that
particular token is less than carbon now
so pretty similar to what we did with
the is expired method but obviously now
we are doing this within a we're course
but obviously this just doesn't work
because what we need to do is take away
the expiry so we need to do a sub
seconds on self token expiry so imagine
the Creator that date was he 50 seconds
ago
if this is less than the current day -
30 seconds then or this is greater than
the current date - 30 seconds then we're
going to end up with this so this will
give us back all of the tokens that are
technically expired so now this will
just work so we can go ahead and run
this after we attach it in our console
so under commands let's go ahead and add
this in now so this is app console
commands and it's clear expired user
login tokens we can just pull each full
class name in so now if we go ahead army
run PHP artisan we have under or
hopefully there we go so we've got clear
token so auth clear tokens so PHP arts
and auth clear tokens and there we go
now obviously we don't have any tokens
at the moment but we can very easily
test this to test this I'm just
literally going to reduce the token
expiry so we don't have to wait around
for too long and let's go ahead and
initiate the login link go over to the
database give that a refresh that's sat
in there we can basically just wait now
10 seconds and we can go ahead and run
this command so let's go ahead and set
this up ready to go that should have
been about 10 seconds so if I go ahead
and run this that should have deleted
that just there great now we can
obviously test this out by requesting
one and then going ahead and immediately
running this which shouldn't have
deleted that token great so let's just
go ahead and put that back to say 30
seconds in fact I'm gonna put this to
120 because that makes a little bit more
sense so what you could do now is go
ahead and schedule this for once a day
you could schedule it for every minute
if you wanted to be really ruthless
about how you are going ahead and you
know doing this and all you need to do
is say scheduled command or clear tokens
and then maybe you could say daily and
as long as you have your cron job set up
to run PHP artisan arts and scheduled
run so PHP artisan scheduled run then
this will go ahead and it will just work
that is pretty much it just a tiny
little bit of advice about clearing up
tokens you obviously don't need to do
this but it may make sense in some
circumstances if you find this table
getting full with tokens that really
just aren't gonna be used anymore
because obviously we have that expiry in
place anyway no one's gonna be able to
use them so we might as well just flush
them out so there we go that is pretty
much it how to clear our expired tokens
with a artisan console command</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>