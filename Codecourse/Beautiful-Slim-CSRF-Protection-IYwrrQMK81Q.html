<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Beautiful Slim CSRF Protection | Coder Coacher - Coaching Coders</title><meta content="Beautiful Slim CSRF Protection - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Beautiful Slim CSRF Protection</b></h2><h5 class="post__date">2017-02-21</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/IYwrrQMK81Q" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">now because cross-site request forgery
protection is so important to implement
in anything that you build we want to
make this as quick and easy and as
beautiful as possible and that's exactly
what we're going to be doing today with
the slim framework now if you've worked
with the cross-site request forgery
package with slim before you'll know
that it works something like this we
attach it to our container and then we
go ahead and either add it globally or
we can add it to any of the routes that
we want to protect so we may wish to not
protect some routes which is fine like
web hooks and all that and then what we
have to do quite strangely is extract
all of these items directly out of the
container using that cross-site request
forgery container item and then go ahead
pass it down to our view and then output
them now this is absolutely fine if you
are just very quickly creating maybe one
or two routes but going forward this
actually gets really really annoying now
what we're going to be doing is creating
a really simple form this is just an
upgrade button so just imagine that it's
to upgrade a subscription when I click
on this I expect to have cross-site
request forgery protection so I'm not
vulnerable to this being submitted not
on my behalf or rather on my behalf by
someone else now the way that we're
gonna be doing this if we just take a
look at the source of this page is
exactly how we're supposed to so we
still have the cross-site request
forgery name and value fields in here
but the difference is if we just head
over to our text area and look at this
view you can see here that we're just
using a helper function and this is as
simple as it gets so this is all you
need to include once you've set up what
we're about to learn and you are done
that's all you need to do so if I get
rid of this just to demonstrate you can
see that we get a failed cross-site
request forgery check so with that out
the way and done with and looked at
let's go and start to set up a simple
slim app if you are new to stim and then
we'll go ahead and get this working time
to set up a simple slim application if
you already know what you're doing is
slim feel free to skip this part if you
want to download the code for what I'm
about to do you'll find that as always
in the course downloads
so let's get started then I have just
have an empty directory here and I'm
gonna do a composer require on slim slim
as always and just wait for this to
finish and now that's done what I
usually do is go ahead and create a
public folder in this case I'm not going
to just because it's a little bit more
setup so I'm going to go ahead and just
create an index.php file in the root
here but of course it's always a good
idea to have a public directory where
you can keep knowingly your index file
but all of your compiled CSS and
JavaScript as well so just inside of
here then obviously we need to require
in vendor autoload just so all of our
composer dependencies are in there and
ready to go and we can create a new slim
app instance so slim app and just for
the purpose of this I'm going to as I
usually do just turn on error reporting
just in case we see any problems we'll
see the errors in the stack trace so
within here within this array we're just
gonna say display error details and
we're going to turn this on there we go
so now let's just grab out our container
so I'm gonna say container and this is
going to be app get container we're
gonna need that later and then finally
we will run our app now for any other
URIs we need to make sure that we have
an HT access file in here or if using
nginx you'll need to set this up you can
find all of this information on the slim
documentation what I'm just going to do
for now though is copy and paste exactly
what is on the slim documentation if you
do need to find any more information you
can find that just over here in the web
service section okay so now that we've
done this then let's just head straight
over to the index here and we get a page
not found which is absolutely fine
because we don't have any routes set up
so before we do anything else I want to
set up views so again we're just going
to head straight over to the slim
documentation we're going to come all
the way down here to the add-on section
under templates and we want to install
slim Twigg view because we need to be
able to work with views and this is
really fundamental as well to the way
that we're gonna be setting this up
because we're gonna be creating an
extension for our cross-site request
forgery helper function so now that
that's installed we just need to bind
this
into the container so register it and we
can do that simply pretty mess Li but
we're only messing around here by just
pasting this in here so what we need to
do now is just go ahead and create some
kind of views folder I'm gonna create
this under a resources folder and I'm
gonna then create a views folder here
and in here why don't we just create a
simple view so I'm gonna call this home
twig and we can go ahead and just write
home in here just to test things out so
really importantly when we do register
this now container we need to point to
our resources views folder so we just go
ahead and do that
and for the cache I'm just gonna disable
it for the purpose of this video but you
can of course create a cache directory
just to speed things up a bit okay so
what we're gonna do now is just very
quickly return a template within a very
simple route here and then we'll go
ahead and move on so in here we get our
request our response and our args if we
need them and here we're just gonna
return this view render passing in our
response and of course pointing to that
home little twig file so now on the home
page we should see that home template
rendered perfect
okay so last thing before we move on
we're gonna be storing everything inside
of an app directory just here so what I
want to do is make sure that this is
Auto loaded so over in composers JSON
let's just set up Auto loading so we're
gonna auto load using psr-4 like so and
we are going to in here give out vendor
name space of app and we're gonna point
to the app directory so one thing to do
composer dump auto load and we're done
so that is our simple slim application
set up like I said if you are new to
slim if you're having any problems with
setting things like this up head
straight over to the course download
section on this lesson and you can go
ahead and download all of this code as
you see here so in this part we're going
to look at installing the cross-site
request forgery protection package with
slim and we're going to take a look at
how the
traditionally works and hopefully this
will convince you otherwise that you
want to move on to the next part and
make this a little bit easier so the
first thing we need to do is just head
over to the github page for this I'll
leave a link in the course links as
always for this and we're just going to
go ahead and pull in the package of
course using composer so let's do this
first and that should download pretty
quickly there we go and this is pretty
much how we use it so like I said in the
introduction we can either bind this
onto all routes so this will basically
add middleware or I would actually
suggest you do is take a look through
this guard class just to kind of
familiarize yourself with it and we can
do that now actually if we just come
over to this this is essentially just
middleware that's bound to either all
routes or the routes that you provide
and you can see here that we've got our
basic constructor passing in storage so
you can change around your storage
and/or your prefix if you want and all
that kind of stuff and we have these
methods like get token key name or name
key and get token value key and
basically we need to manually extract
these out and then insert them now the
reason it works like this and I
completely understand this is that you
may wish to change around your name key
and your value key and then the actual
name of value so this makes things a lot
more flexible and honestly this is
absolutely fine but doing this and
passing this down to every view gets
very annoying so let's first of all just
go ahead and grab this code here we're
gonna attach this to our container so we
can do this anywhere and all this is
doing is just binding on cross-site
request forgery using a new instance of
that guard class that we've just looked
at it's as simple as that same as what
we did without views so you would take
this and you would bind it somewhere
before your routes and after you've to
find this out in your container so
something like app add and then using
your container you would just grab that
out of the container and this would add
to all routes so if you were to post
something through to another route then
this would have protection enabled
immediately so really what we want to do
is very quickly create a form over here
and post it through to a new route so
we'll do that we'll take
that it fails because we have this on
here but we're not including that hidden
input and then we'll go ahead and move
over to the next bar so over in home
let's just create a really basic form
kind of like something that we would
want to protect with cross-site request
forgery of course it's a good practice
to protect everything with cross-site
request forgery so it's always a good
idea to do this so what I'm gonna do is
actually just create a layout if you are
new to tweak this will kind of help you
out with how this works we're going to
extend a base layout so I'm going to
call this app dot twig and into here I'm
just going to create a rough document
layout like so so we're just going to
call this cross-site request forgery and
inside of here we want to basically
define out a block where anything will
be inserted so we're going to call this
block content and then we immediately
end the block just here so we're gonna
say and block and now what we can do is
over on our home we can extend this and
place whatever we want in here so not
necessary really but it's good to go
through these things so we're going to
extend that layout so layout slash apt
Wiig and then down here we define out
that block that we want to insert and
that's called content so down here we
end the block and we just place anything
inside of here that we need so let's go
ahead and do that now so the form then
is going to have an action of a path so
we're going to actually define this out
as a path in a moment so we need to give
our post route a name and the method is
obviously can we post now in here I'm
just gonna have a button with a type of
submit and this is going to be some kind
of subscription upgrade or cancellation
or something like that so over in index
let's just create a new route this is
going to upgrade a subscription and
we're just going to say slash upgrade
and in here we'll just create a closure
and we'll go ahead and return
subscription
upgraded just to make things a little
bit easier and this should be just
enough to see that this works so we need
to set a name for this so if we just set
a name on this particular route to
upgrade what we can now do and this kind
of leads us into what we're going to be
doing is use
a kind of helper function so we can say
path for and then just give the name and
this is exactly the kind of thing that
we're going to be creating to make the
cross-site request forgery field
insertion a lot easier so now that we
have this then what we should have is a
button that goes through if we actually
enable sessions so by default cross-site
request forgery middle and we're for
slim released this package will use
sessions so that's the default storage
and again we can check that by coming
over to the guard just here and if we
come down we can see that the storage
here by default if it's not being
defined out will use sessions so all we
need to do in this case then is over an
index dot PHP or somewhere in a
bootstrap file start sessions within PHP
that's all we need to do so now we have
this button I click it we get a failed
cross-site request forgery check because
we're not including them inputs so let's
do that really now and completely bore
ourselves with how annoying this is by
default and then we'll go ahead and fix
this up in the next part so over in home
then we need these two hidden inputs so
let's create these now and we're going
to have a name and a value for each of
these but we need to pass these through
to our view because we actually have the
name and the value contained as we've
already seen within that guard class we
have their methods so what we would have
to do then and I'm just going to copy
this over from here is do all of this so
we just basically take all of this paste
it in there and then we have to send
this through to our view so we can do
this now and see how it looks so name
key we're gonna set to name key we're
gonna have a value key and again change
all this over and a name and a value so
name is name and value is value now
there's a couple of problems with this
the first one is that do we really want
to be doing this every single time we
are creating a route that potentially
needs cross-site request forgery
protection of course we don't the other
problem is we these are kind of generic
names so we're gonna have to kind of
prefix them anyway which kind of avoids
the point of having to pull out our name
key because then we have to again
a convention to actually pass these
through to our view it's more to think
about and we may want to again change
the name from cross-site request forgery
name key to something else in the future
really this is just a headache now let's
go ahead and implement this and we'll
take a look so in here we have our name
key so let's go ahead and say name key
and then this is the name value and I
think we just called that value I don't
know sorry this is the name of course
and then we have even this is confusing
to be honest and then we have value key
and then we have the value like so so
now if we just go over here we need to
very quickly fix this up because what
happens is when we add this middleware
in it will modify our requests because
obviously this is middleware and then
we'll have access to this attribute in
here so it's actually you know a little
bit of a challenge to get this working
any best than it does here but we of
course going to look at in the next
video
so we have our update button we click it
and it works brilliant but we're left
with the problem that this is a complete
and utter mess we really need to make
this a lot easier and ideally we don't
have to do any of this at all and we
want to be able to not have to define
these inputs out manually for every
single form we create so let's jump over
to the last part and implement this and
finish up before we look at how we're
gonna do this let's just clear all of
this out and pretty much start from
scratch so we're not going to be sending
anything through to our views whatsoever
and of course over in here we can get
rid of these two as well so this is back
to the state where it is not gonna work
so if we just go ahead and submit this
it's failed so our goal is to get this
working but using the extension we saw
earlier so the next thing I'm going to
do is just demonstrate a simple twig
extension so by this I mean that when we
registered the view component over on
our container you can see here that we
are adding an extension called twig
extension and this is part of the slim
views package so if we just open this up
and take a look at it this will kind of
give us a clue as to how we can improve
the cross-site request forgery
protection so in here we take in any
dependencies that we need so we can pass
anything
through to here and in this case we are
passing through our router and we're
passing through the base path just here
now the reason for that is that over
here when we use things like path for
this actually generates a complete path
for us so again if we just take a look
at this we have slim cross-site request
forgery update so this will generate all
of that for us now the key to this is
then being able to define out these twig
simple functions and this will call the
current class and it will call a method
that you've defined like so
so essentially path four and base URL
the functionality from this comes from
these two functions now if we think
about this if we were to create our own
extension and then go ahead and use it
over here we can pass through the
cross-site request forgery package or
dependency on our container and we can
pass through anything else that we need
as well and then we will have a function
that we can use inside of views which is
exactly what we want to do so what we're
gonna do is just create a very simple
one just to kind of demonstrate this and
then we're going to implement the actual
full thing because I always like to kind
of play around with this before I get
going so in actual fact we can create
the kind of class that we're going to
create now and then we can just test
this this work so it makes sense to do
this so inside of that because we're
already also loading here I'm just gonna
create a views folder and inside of here
I'm gonna create a cross-site request
forgery extension like so and to be
honest what we could probably do is just
copy most of this over it's kind of just
like boilerplate so let's go ahead and
just paste this into here nothing wrong
with doing that and then we can go ahead
and just tidy this up so obviously we
don't need the commenting at the top the
namespace will be different it will be
app views now and this is our cross-site
request forgery extension now it still
extends twig extension so we can leave
that as it is but let's get rid of these
dependencies because we don't quite know
at the moment what we are passing
through and we're gonna go ahead and get
rid of get name as well and we need our
get functions but what I'm gonna do is
get rid of one of these and I'm just
going to define out a test function so
I'm just gonna say test and I'm gonna
call a test match
so once again we can get rid of these
two we really don't need these and we
also don't need this set base URL either
so let's define out a test function here
and let's literally just return let's
say your name so in my case Alex
so now that we have this as long as we
add this into here we should be able to
use a test function within our views so
let's go ahead and do this so it's under
app views and it's our cross-site
request forgery extension and at the
moment we're not passing any
dependencies through so we'll just get
rid of that so as long as we've done
everything correctly what we should be
able to do now is somewhere on this page
use that function so let's just come
anywhere on here and go ahead and say
test like so and then we see that works
so this is the kind of basis of getting
this working now what we can do is
actually make this work to output some
markup for us just to make our lives a
lot easier so over in our extension what
do we need to pass into this in order to
extract the information from our
cross-site request forgery package well
of course we need to send through that
guard class so let's go ahead and do
this it's as simple as saying container
cross-site request forgery or container
get to cross-site request forgery
whatever you want to do and now over in
our extension we can accept this in so
let's bring back our constructor just in
here and I'm going to type in this so at
the top I'm going to use slim cross-site
request forgery and guard and let's just
fix that up and now I can type int this
here bring this in and go ahead and set
it to a property and then we can use
anything we want on that so this guard
equals God go ahead and create our
property up here like so brilliant so
now what we can do is create a
cross-site request forgery field
function which is exactly what we want
to do and we're gonna call cross-site
request forgery field method but of
course we're gonna keep convention with
function names we're gonna have
underscores with our method names within
this class
we're going to use camel casing so all
we need to do in here now and really you
can separate this out into multiple
methods if you want to tidy it up is
literally here just return to markup so
what I've chosen to do is just in single
quotes because we are outputting markup
literally just write all my markup in
here and then we can use at the guard
class here to go ahead and extract out
the token name key the token name and
the value key and the value
so pretty simple so all we really need
to do in here then is just create some
hidden inputs and I can't use my macros
here so I'm gonna have to manually hurt
type all of these out so type is hidden
and we have a name of course and we have
a value let's duplicate this down and
this is going to be our other one so we
pretty much now do exactly what we did
before but this time we're not passing
it down to our views so for the name
let's go ahead and concatenate on this
god get token name key so just as we saw
before and the same for our value as
well let's go ahead and concatenate on
this guard get token name and like I was
saying earlier you can separate each of
these fields out into separate methods
if you want there's not really much
point because we're always gonna you
know we're always going to need both of
them so it's entirely up to you what you
want to do so for our last one then it's
get token value key and for the value
it's this guard get token value and we
are done so that really is as simple as
it gets we now have our extension we are
registering this extension passing
through our cross-site request forgery
package on our container we're adding it
to all ropes and in a minute I'm gonna
show you how to add this to individual
routes if you don't want it on all of
your routes and we should be good to go
so what we can do now is just make sure
we didn't break anything come over to
home and instead of using that silly
function we created a minute ago we're
actually going to use the cross site
request for tree field function now at
the moment this isn't going to work
because by default twig will escape all
output which is exactly what you want so
you're going to get the following but
this is good to see that it works so
we've got cross-site request forgery
name value and it looks like all of this
is okay so there we go so now to
actually get this working we just need
to use the raw filter within twig and
this will go ahead and actually add it
to our form we click update and it works
so there we go that is as simple as it
gets you can include this on every form
and by default we have it enabled or at
least cross-site request forgery
protection enabled for all routes now if
you wanted to add it say to just the
upgrading of a subscription what you're
going to need to do is not only add it
to your post route just here so this is
how we add a middleware for individual
routes you are of course gonna need to
add it for this one as well because this
is actually generating the token so when
we land on this view this is generating
the token so we need the middleware in
there for it to be able to actually
generate it show it on the form and then
go ahead and check it here so this will
work in exactly the same way but it just
means you have a little bit more
flexibility if you wanted to exclude
certain routes from this so you could
just add it to any way you wanted but
for most purposes all routes protected
by cross-site request forgery is a good
idea and you can see now that this works
as normal so there we go a simple twig
extension to go ahead and output all of
the cross-site request forgery
information that we need so it is super
convenient to include in our views</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>