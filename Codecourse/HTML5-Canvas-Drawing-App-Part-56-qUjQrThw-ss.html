<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>HTML5 Canvas Drawing App (Part 5/6) | Coder Coacher - Coaching Coders</title><meta content="HTML5 Canvas Drawing App (Part 5/6) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>HTML5 Canvas Drawing App (Part 5/6)</b></h2><h5 class="post__date">2013-10-22</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/qUjQrThw-ss" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">hello and welcome back to this
development of an html5 canvas drawing
application so last time we added this
color palette which made the image is a
whole lot more interesting by adding
some color and today we're going to look
at how we can go about saving these
images so you can see here we have a
pretty much photorealistic drawing of
one of the Navi from Avatar and so let's
see what happens when we click the Save
button as you can see our beautiful
image comes up gets downloaded let's see
how I can go about doing that so so far
we've only used one method of the canvas
element itself and that was the get
context method and everything else has
been done within that context but there
is one other method of the canvas
element itself and that is to date a URL
this picks up all of the image data
inside the canvas and spits out in the
form of a data URL otherwise known as a
data URI and this can be used just like
a normal URL but you can see it's not
actually pointing to an external
resource that's actually the resource
itself has encoded into the URL so here
you can see it starts data colon then
the content types are here by default
it's a PNG image
it says base64 and this is a base64
encoded string now what does that mean
well there's 64 possible characters for
every little bit you see here so this
uses the locator alphabet the uppercase
alphabet the numbers 0 to 9 a plus
symbol and a forward slash if you want
to see how these strings are determined
and what these equal signs mean just do
a quick google search for base64
encoding and there is a great Wikipedia
Arkell Arkell article on this topic so
this two data URL method is how we're
going to go about saving our pictures so
let's jump into our code and we're going
to do the same thing we've been doing
for our other controls so we're going to
say we can add another div to our
toolbar I'm going to just call this save
inside here
just going to say the word save and I'm
going to style this a little bit I'm
going to give it a height of 30 pixels a
little bit of padding and a background
color oh my goodness
background color for did a good building
and that should do it and then I'm also
going to style the hover state so that's
also going to be background color I'm
going to use coders lovely little color
picker interface here and hopefully now
we close this fresh air that's not at
all I wanted what have I done
and I want to float this element left so
it's very right on that and in fact I'll
add the padding as well so now I have a
Save button going on and I know I rushed
through that a little bit but we've
added enough controls that I think you
should understand how that all works now
now we're going to do again very similar
thing to what we can do I'm going to add
this script tag with save j/s and then
we're going to create that file just
going to say new file save j/s open that
up and this is fairly common practice to
you guys now but we're going to say save
button equals document dot get element
by ID using the idea of save and then
we're going to add an event listener to
that button remember my capital L as per
usual we're using the yeah the clock
event not the click event and we're
going to create a function called save
image so we're going to say save image
it's going to take no for ammeter z' but
we're going to use that to data URL
method that we talked about before so
going to say VAR data equals canvas dot
two data you are remember your capital
URL open close parenthesis finish the
line so now we've got our data our data
URL inside this variable beta and there
are a lot of things we can do with this
first one is we can just open it up in a
new window we do that by saying window
dot open this is a function that
obviously just opens a new window the
first parameter takes is the URL and the
next is the name of the window and then
there's some other options
that you can add so the URL we're just
going to say data so as I say we can use
these data URIs interchangeably with
URLs for the most part the name now if
if you've done sort of anchor tags and
use that target --blank this is
essentially what's going on here
w3schools has a great reference for this
method so you can see what each value of
the name parameter will do it also gives
you a really good rundown on the specs
that you can add so for us quite a few
of these will be lit useful because we
want this just to be as simple as
possible all we're doing in this window
is displaying an image so we can do this
we can say don't display the address
field don't display the menu bar and you
know that'll probably do for now so
let's say location equals zero to get
rid of the address bar a new bar equals
zero equals zero to get rid of a menu
bar let's see how that looks so let's go
back to our application draw something
on the canvas click Save and you will
see our image pops up with no sort of
chrome to the to the browser really it's
just a window so that's one really
simple thing we can do with our our data
that we pick up from this canvas top two
data URL method and from here I mean the
users can save image to downloads or
whatever but they sort of difficult it's
not very user friendly because they have
to right-click and and it's got this
massive window you can use the specs
parameter to change the width and height
if you want to then you get a little
picture it's clearly not the best
solution but it's certainly something
you can do it's also a great
demonstration of the fact that this can
be used interchangeably
with URLs because of that fact you could
use it in like an anger tag or even you
can even use it as the source of an
image tag we're going to comment that
out for now because the next thing we're
going to do is quite a lot more
complicated we're going to save this
image to our server now to do this we're
going to be using Ajax and PHP so off
until now in this project you may have
been able to get away with just opening
the files in your browser without a web
server because we're about to use PHP
you are going to need a web server
running on your machine so we're going
to set up an ajax request and if you
haven't done this before the way we do
this is we create a new XML HTML HTTP
request object so we do that just by
saying the the reference that we want to
use then we say equals new XML HTTP
request now we also want to open close
our parentheses there so this gives us a
new object an XML HTTP request object
still quite hard to say and there are
some things we want to do with this so
we're going to say request dot open this
is how we tell our xhr where to send
requests and how to do it so the first
parameter is how to do it so if you've
ever used forms with PHP hopefully
you'll recognize the post and get
methods here we're going to use post
because get in some circumstances has
size limits and we're going to be
sending quite a lot of data because
obviously we're sending an image so
we're going to say post and then the
next one is where to send it so we're
going to create a file called save dot
PHP and that's where we're going to send
this the final one is whether or not
this request should be asynchronous
we're going to say true if a request is
synchronous it means it will pause any
scripts running on on the current page
until it gets the response if it's
asynchronous it means it will go away
and do its thing
independently of the current thing that
you're doing so you can continue working
on the page without having to worry
about you what your requests doing and
typically you will always want this
to be true when you're using an xhr so
the next thing we're going to do is set
our request header so we're going to say
request dot set request header and this
method takes the header name and the
content so the header name we're going
to be using is content type and the
content type we want to use is really
awkward it's called it you say
application slash X - WWE - form
- URL encoded and that's quite a
mouthful but what that basically means
is that again if you're used to working
with forms in PHP and you've used the
get method you'll be familiar with this
sort of form so you'll have
www.sap.com/learnbi for and then there
will be a bunch of key value pairs so
this could be like name equals John for
example and so basically what this is
saying is that our data is going to be
encoded like this it's just going to be
the name of the variable that we want to
use and then an equal sign and then are
the data that's in going to be in that
variable so this is exactly how we're
going to send our data we're going to
say request dot send I'm going to say
we're going to call this variable image
and we're going to add the equal sign
and then we're going to concatenate our
data which we've got from our two data
URL so if we use that what that's
basically doing is sending the request
for us now we need to tell it what to do
with the response so to handle responses
we use the on ready state
change event so say request
onreadystatechange
and the ready state is basically the
sort of the status of the request so is
it as it started yet as it not started
is it partially loaded or is it fully
loaded and fully loaded is the final
ready state and the state that we want
to find so onreadystatechange if the
ready state is four which is the the
final ready state the fully loaded ready
state and pull request and the request
dot status equals 200 so that's an HTTP
status so you will have seen when you're
browsing the web things like error 404
or 500 there HTTP status is and so 404
is a page not found in a 500 internal
server error 200 is one that you won't
normally see because it basically means
okay everything's good to go and so what
we're doing here is checking if it's
fully loaded and checking if what we got
back is all okay and if that's true we
can do our stuff so in here we can use
the response and we get that just by
saying response text and we're going to
store that in a variable so we're gonna
save our response equals just request
dot response text so we can use that so
what can we do this well let's let's um
well for now let's just console.log it
console.log response
okay so now the xhr setup but we'll see
at the moment we're not going to get any
response because save dot PHP doesn't
exist
so let's remedy that let's go new file
save dot PHP and open this up so as I
say it's going to be just like having a
form submitted so if you've ever done
that it you should recognize this so
we're going to open up our PHP tags
going to say our data equals the post
array so dollar underscore post is an
associative array of all the variables
that this page got sent via the HTTP
POST method and we're going to look for
image so that's going to find what we've
sent it here and that's going to be
equal to our data now remember that's
encoded in base64 and PHP gives us a
really handy feature called base64
decode so we can just say base64 decode
data unfortunately that's not the end of
the story because base64 decode doesn't
expect any of this stuff that we see on
the front here so we want to get rid of
that so we can just use this like a
string so we can say data equals SCR
replace we're going to look for that
first bit that we want to chop off so we
say data : and image slash ping
semicolon base64 , I can replace that
with nothing and we're doing that inside
the data string so that gets rid of that
sort of prefix to our to our actual the
actual meet of our data the other thing
is remember we have the plus and the
slash now plus is when you use that when
you include that into a URL it's
interpreted
the space and we really don't want that
so at the moment PHP is going to see all
these spaces in this string will be just
have no idea what to do with it
so what we want to do is do a similar
thing to what I've just done STR replace
and we want to get our spaces back our
pluses back sorry so we want to get rid
of the spaces and replace down with
pluses and again we're doing that inside
the data string so now we can use this
base64 decode on data and now we have
this file this is our image file so
let's create a file path somewhere to
put this i'm using this folder images so
you want to create a folder on your
server called whatever you want it to be
called and then i'm going to append to
that i'm going to use this function of
PHP unique ID now this is really handy
because it basically gives you a unique
number based on the time in microseconds
so it's really handy if you're going to
have some sort of if you're building
some sort of system where you know
you're going to have a lot of stuff
uploaded to one place and you just need
unique names for all of it this is a
really good starting point for those
unique names so we're going to say
images slash this unique number and then
we're going to append dot PNG on the end
of it so remember because we've stripped
all this from our data at the moment PHP
has no idea that it's a PNG to PHP it's
just a whole lot of data so what we want
to do is put it give it a PNG file
extension so that it will be opened as a
PNG and now we can say file put contents
content Nets contents and we want to put
it at our path want to put our image
yeah so that that's going to put our
image file at this path that we've just
defined but let's not end the line there
because what we want to do is say
this works if this succeeds then want to
output something and I'm going to output
the path because I feel like this is
going to be useful for our JavaScript to
have but else we want the JavaScript to
know that it's failed like we don't want
we don't want this to seem like it
succeeded if it's failed so if you're
setting up something in PHP to respond
to an ajax request and something's gone
wrong what do you do well we're going to
use this header function and then we're
going to set this to that 500 state that
HTTP status 500 that internal server
area error I was talking about so here
we're looking for the status of okay but
now it's not okay at all so we're going
to say HTTP using version 1.1 and we
want to just say 500 internal server
error remember if you're using the
header function you can't have outputted
anything beforehand so if you are
handling errors like this make sure that
it's done before you've outputs to
anything else
okay so perfect note so now our PHP it
should respond to our Ajax request by
uploading the image and then spitting
out the file path and if that fails is
going to give a 500 internal server
error so now so instead of console
logging let's use window open that
method that we looked at earlier and
we're just going to use our response as
the URL and that's how look at if that
works so hopefully if we draw a
masterpiece here and save that we get
this image and this is no longer coming
straight from the data URI this is
coming from the server and to prove that
to you if we go if I go into my file
system here open up my images
that's embarrassing there you go right
so yeah that's being uploaded to our
server and then we're spitting it back
out with the window open method but we
do still have this problem because the
moment when the user clicks save they
get this image back and it is saved to
the server but if they want to download
it they still have to right-click and do
their save images whatever how can we
get around that how can we make the
browser download it automatically I'm
sure you've all seen cases where the
browser downloads files automatically a
lot of time if you open a try and open
like a movie file or an audio file it's
not supported by the browser it will
download automatically simply because it
can't open it up itself but you may also
have seen situations where the browser
does get forced to download files that
it could easily open itself so how can
we do that well let's create a new file
we're gonna create a file called
download PHP we're going to open this
off and this is going to be basically a
wrapper that we send files to to force
the browser to download a file so we're
just going to use the get method this
time I'm not going to use post so it's
going to be get dollar underscore
underscore get again this is just going
to be an associative array of all the
variables that got passed this page
using the get method yes a file
obviously we haven't made this request
yet so I'll talk you through that in a
moment so we're going to use another
header function here and this is going
to be this is not going to be an HTTP
status this time this is going to be
first of all going to do the content
type so content type we know it's going
to be an image PNG image another header
we want is something called the
content-disposition and
my typing today is beautiful okay
content-disposition i'm going to set
that to attachment now all this does is
basically it basically forces the
browser to download to the file we can
also suggest a file name so if we say
file name equals let's say canvas output
dot ping now actually I think that's
supposed to be in quotes so I'm going to
use double quotes out here and single
quotes in there so now we've got the
file tol PHP it's an image tol PHP it's
an attachment also left now is to spit
out the file so all we need to do this
is say read file now we're going to just
really read and follow it gets in and
that's it for that so now we just need
to make a request to this page with this
file path encoded in the URL so we're
going to say window door open we're
going to go to down load dot PHP we're
going to use this question mark and then
file equals and then add the response
which is the the path to the file so
with any luck that should we make a
little masterpiece that should and
that's not working and CY
let's go back to download I haven't put
a semicolon sure most of you spotted
that okay so now if we press save there
we go so it's down I did that for us
and it looks like actually this wasn't
supposed to have the quotes around it
because now we can see this is this
looks really stupid so if we close that
go back to our thing here file name
equals counts output dot ping and go
back press save there we go so now we
have our canvas output dot ping and
being downloaded we do still have this
window open that blank window that we
open to download the file I'll leave it
to you to figure out how to close that
so now you've seen a few possibilities
for saving files from the canvas and
even some things that can be useful with
any type of file next time we'll be
going over what we've achieved with this
application and thinking about what more
we can do with it</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>