<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>JavaScript Tutorials: AJAX File Upload with Progress Indicator (Part 4/5) | Coder Coacher - Coaching Coders</title><meta content="JavaScript Tutorials: AJAX File Upload with Progress Indicator (Part 4/5) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>JavaScript Tutorials: AJAX File Upload with Progress Indicator (Part 4/5)</b></h2><h5 class="post__date">2012-08-26</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/ImIIHXRlL4k" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">right so now that we've created our
function to display the percentage what
we need to do is well something we
should do is probably handle this error
condition so I don't know you maybe want
to just show alerts or something a bit
nicer but some load failed just so they
know what's happened and they know their
files haven't actually been uploaded but
yeah I guess normally you'd show like a
nice lil pop up or something book about
whatever okay so next thing we want to
do is actually send a request so what we
need to do is once we defined our
various listeners which are these things
here we want to call the request open
method this takes two parameters the
first one being the method you want to
use views which is either get post or
well view other HTTP methods so if this
put amusing posts and the next one is
the URL you want to submit to so for us
this is just upload dot PHP and then
there is one more thing we want to do we
want to set a request header we're going
to be setting the cache control header
because we don't want any sort of page
caching to get in the way of the
information being returned correctly so
yeah so just here what we'll do is add
well we'll set a request header and this
is a header that is being sent to the
server not received and when we're
setting the cache control header without
that I in it when we're setting it to no
cache
okay and then all you have to do is send
the request so request send takes one
parameter which is the data you want to
send and this is our form data object
that we created up here so this is the
reason why it's so easy because you can
just send the actual form they dropped
it now to worry about reading in the
files or binary decoding or anything
like used to have to so anyway data okay
and that's that dump so now I think
maybe we shall be able to test this out
there's one more problem because the
upload progress default display non but
you need to set it to be displayed
somewhere and I think the best place to
do that is just here just before you
send the request so we're going to copy
this line so here instead of non we're
gonna have block so I think we should be
ready to test this out and the files
should upload we haven't dealt with the
response yet so that's okay
let's go to our browser hit refresh and
we'll pick just two files
actually mentally the files in the files
folder so we can see if they upload so
let's go to our file hit upload and that
broke so files input is null because
that's the type oh that should be file
ok I'm sure he was screaming at me well
that was being done try again
upload descent is not defined okay good
well that means the progress method was
being called which is good so let's go
to here and
percent
try it one more time not going too badly
so far
okay good no errors or you can see that
the progress thing hasn't appeared which
is odd but we'll look at that in a
moment so let's go to our thing looking
the files folder no files interesting
okay
oh okay scientists bail upload correctly
that's quite an easy fix that's lucky so
now we should be able to give this a
final test so just go back to my browser
I'll hit refresh and upload the images
no errors which is good progress bar
didn't show which is interesting but
we'll look at that in a moment let's go
to the files folder hit refresh and you
can see we have three files which is
because I accidentally selected one
mixture so we have these two files here
and they've been uploaded without the
page reloading which is soft appoint so
in a way we're kind of done although
obviously we need to create the links to
show on the page and because we're not
reloading the page that PHP bit we did
in the first part doesn't get executed
so that's what it does but you don't see
it so that's not what we want so you
need to create a response that we can
use to create the links in JavaScript so
let's go back to our browser and we'll
just test a large file to see if the
percentage thing actually works which it
should do
let's hit upload and you can see we have
the percentage uploading and then it's
done and the link well block disappears
so that's good that's all working so the
next thing needs to do is just work out
how to sort of get a response from the
server so what we're going to do is
we're going to add an extra field to the
form if it's submitted by a JavaScript
so just up here when we create our form
later object what we're going to do is
add a sort of flag which is going to
indicate that this was submitted from
the JavaScript not from the actual HTML
form so we're data
upend just say Ajax is true or maybe
JavaScript well whatever you can pick
your in flag and what this will do was
add an extra post field to the form that
we can check in our scripts so for
example if we come here say if we wanted
to know if this was caused by the
JavaScript or the form what we could do
is add say if not empty post Ajax and if
this is true so here we know that the
form has been submitted by JavaScript so
what we need to do now is worry about
how to get response so let's go back to
our script and then what we're going to
do is add a new event listener to our
request object just underneath here
that's going to be fired or called when
the state is changed so this happens
when the request fails or when it
completes and it gives you the HTTP
status but don't worry too much about
what that is let's just get on with
adding the listener first so request
and event listener I think that's right
and notice that we're not adding it to
the upload because we want the response
and we want to add an event to the ready
state change event a listener to that
event even so we're adding a function
which takes the event as its parameter
and then inside of here we need to check
to see if the request is completed
because this is fired and forth on four
occasions and I remember two of them one
is when it's opened which is zero and
one is when it's completed which is four
so we'll check if this ready state is
equal to four and if it is that means
the request has completed and then we'll
check the status or say if this status
is equal to 200 which is the HTTP status
code for okay as in everything went fine
then otherwise we're just going to show
an error or maybe we'll log an error
who knows so inside of here this is
where we know that the request is
complete successfully the files have all
been uploaded and we can process the
response and add our links
okay and then down here we'll just do a
simple console lot I guess because it's
like an error log type thing serve
replied with HTTP status and then the
status code except the ops you need to
be quoted so let's add a quote
this status and that should be used for
debugging purposes right so once we've
got well once we've got this what we
need to do is get what we told the side
where we're going to put our links so we
look at HTML the links go in this
uploaded box so send us your what I'm
going to do is create this same sort of
echo with JavaScript let's go back to
our script and we'll get that upload box
so create a new variable called links
this is gonna be equal to document get
element by ID and the element name was
uploaded there we go so then what we
need to do is get our response and for
the sake of testing let's just do
console.log this response
like so this response is just the raw
response that the request has retrieved
so if we just go back to our browser we
can test this out so let's hit refresh
and we'll upload our file again just
keep all I on the log and I'll pick the
big file ok and there you can see our
response has been printed out and this
is actually the raw HTML makes up this
upload dot PHP page which is what you'd
expect really we don't want this for our
Java Script though we want something
that we can easily process so if we go
back to our well PHP code what we can do
is use that Ajax flag to do something
else and we want this array in
JavaScript so we can use the file names
as we do down here in the way we can
transfer it is using the JSON or how you
mean to say that in code function and
what this does is it creates what
converts the variable you pass it data
structure into something that javascript
can understand so we're just gonna pass
in the uploaded array like so and we're
just going to die with die instead
because we don't want to process any of
the rest of this script generally you
wouldn't really use die like this but
this is the most convenient way to do
this so I'm going with it right so let's
just do this again and we'll look at
what the responses so you need to do
that but that's it upload again and I've
left a big file which is annoying and
you can see that what we've got is
something a lot simpler it's two square
brackets with a string in between it if
I just pick a few files to show you what
it looks like for a lot of files it'll
make a bit more sense you can see we've
got a comma separated list of file names
and we can convert this into actual
array in JavaScript simply by evaluating
it because this is actually valid
JavaScript code so say if I just copied
this
I went to script what I could do is
define a variable called well uploaded
like so obviously not with that bit
there and that would be valid however we
don't want to have to copy and paste it
we want to just process it based on the
response so what we can do is instead of
doing it manually we can just use eval
like so note that using eval to convert
JSON or Jason a now you say it doesn't
matter
convert one of those to an array or
object is not really encouraged because
it's possible that someone injects
malicious code so for example if you had
a file name that was specially crafted
in some way to do some JavaScript that
could sort of produce security from your
vulnerability however pH peas and code
function we avoid saying it now is one
of the trusted sources so you'll see
around online and set people saying
don't use the file from untrusted
sources which is obviously quite a good
idea however the this function is a
trusted source so that's why it's okay
in this situation okay so now we've got
our response already and available I'm
going to well I'm gonna leave it here
for this part because I've got to a nice
breakpoint
so in the next part we'll worry about
adding the links okay so thank you
watching and come back for the next bit</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>