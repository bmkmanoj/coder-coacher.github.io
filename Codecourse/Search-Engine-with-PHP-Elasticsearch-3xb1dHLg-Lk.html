<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Search Engine with PHP &amp; Elasticsearch | Coder Coacher - Coaching Coders</title><meta content="Search Engine with PHP &amp; Elasticsearch - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Search Engine with PHP &amp; Elasticsearch</b></h2><h5 class="post__date">2014-07-28</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/3xb1dHLg-Lk" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">in this video we're going to be creating
a basic search engine with elastic
search so we're going to store some
records now this could be absolutely
anything if your records that you want
to store aren't title body and keywords
that just doesn't matter until the
concept is exactly the same this will
work for any data that you want to store
and search on now if you don't know what
lastik search is then I'd go ahead and
just look up some basics about it
because I'm not going to be covering the
theory behind how things are stored
things like node shards and all that it
does sound more complicated than it is
but we're basically just going to be
running a an elastic search node and
we're going to be indexing documents and
then we're going to be searching on them
now the indexing doesn't have to be done
as part of a form it could be done just
as you create say a forum topic or an
article on your admin area or anything
like that and then you can just go ahead
and on the front-end perhaps where your
users are searching for things you can
go ahead and search for things and that
will give you results now in this case
I've just searched for a you'll notice
how quick this actually is if we look
inside of our of our index up called
articles this has 3 records and you can
see how much data is here now this is
obviously not a lot of records but
elasticsearch is extremely fast at
searching we're going to be looking at a
very very basic search but you can go
ahead and use this tutorial to then
extend and do perhaps more complex
searches and if you don't understand
what this is or what any of this means
don't worry we'll be doing this from
start to finish the only thing that you
can need to do is to go ahead and
install elastic search now I have an
elastic search node running at the
moment now it's literally as easy as
just heading over to the website so you
can head over to a stick search to Org
hitting download downloading it and then
just running it on the command line it
is as easy as that if you do run into
any trouble with it just go ahead and
have a search and get it
up and running but as soon as you've got
something like this up and running you
should be able to either go to a rest
client like this one or to your browser
just using this URL here so it's usually
running on port 9 201 27.9 or that one
or localhost and then you want to send a
get request eg just copy and paste this
euro into your browser and hit send and
you should get something like the
following up and that will then give you
a little bit of information and you know
that your elasticsearch node is running
so once you've got all that started we
can go ahead and we can look at the PHP
clients and this is specifically working
with PHP to index a document and then go
ahead and search the index so let's go
ahead and start doing that now so we're
going to start off with a very basic
interface for both searching and adding
now you don't have to have these you can
work without these it doesn't really
make a difference if you want to get the
fear of how you can combine this up with
forms particularly the front and search
then you might want to do this now at
the moment this is just HTML there's no
PHP here at all I've just removed all
that and we in this case can add the
title of body and keywords through this
interface and then this would most
likely be the front insert for your
users they would go ahead and type
something hit search and the query is
sent through for us to pick up in PHP
search our elastic search index and then
return the results so you don't have to
do these like I said but we do have
these two forms we've got a form here
for searching with the input of type a
text input with the name of Q just for
query and the same for ad we've got
title we've got a body and we've got
keywords here so what we want to do now
is just get things set up we've got an
initialization file inside of this app
directory in the folder that I'm working
in and that's where we're going to
initialize elastic set the elastic
search PHP client so this is what we're
going to use to interact with our
elastic search node
and we can install this with composure
so if you don't have compose it
installed already go ahead and stall
that it's a dependency manager for PHP
if you do have it installed you're just
going to want to install version one of
elasticsearch elasticsearch so let's
quickly do that now I will create a new
composer JSON file in here
like that and let's go ahead and just
require this in if you don't have
composure and for some reason you don't
want to use it or you can't use it I'd
highly recommend you do you probably
could get away with just go ahead and
downloading the zip but elasticsearch
sorry composure makes this so easy to
get started with so it would probably be
a good time spin so now that we've done
that let's go ahead and install this
let's do a composer install wait for
that to finish okay so that gives us our
vendor folder with all of the
dependencies for elasticsearch you can
see it's quite heavy on dependencies but
doesn't necessarily matter so inside of
init dot PHP let's go ahead and just
require in composers also load assets in
the vendor folder that's been created
for us and also load dot PHP and we're
going to create a new instance of our
elasticsearch client so this is names
based on the elastic search and the
class name is client and what we can do
is we can pass in variety of options to
this but we just want to pass in the
hosts key and specifically define where
we're connecting to this is a comma
separated list of hosts
you can choose because obviously elastic
search is an extremely scalable and it
works really well across multiple
machines you can just define these here
so for example in my case I'm just doing
one that said one to seventh or not but
one important 9 200 and I've already got
that that married up and running just
here so we have chosen this again like I
said you can come a separate connector
more if you need to but this should be
enough just to get you started if you're
running it locally so let's include that
file on both our index and our add file
files just so we can make use of that
functionality we're going to be doing
this all in these files it messy but we
want to stay focused on elasticsearch so
let's require in app init dot PHP and
we'll do that for
add file as well there we go we just
make sure that we don't get any errors
here perfect so we're now ready to
actually start indexing documents now
you can have postman or a similar rest
client open if you want we saw this a
moment ago I'm just doing a get to one
sent or not done not the one ninety two
hundred and that's just giving me
information about my elasticsearch node
and we can do things like post data to
elastic search but first let's just take
a moment to understand how we're storing
data because if you've not worked with
elastic search before it's sometimes a
little bit difficult to understand how
data is stored if you're used to working
with say a MySQL database or another
database you typically have a database
and then you will have tables within
your database now elastic search can
work as a database you can absolutely
use it just as your database solution or
you can sync this up with MySQL and to
do that typically I mean there are
solutions available but you could just
store in MySQL and store in
elasticsearch then you have a searchable
solution with elastic search but let's
take a look at how we store things so
try to ignore this history here I want
to store articles so I'm going to store
within articles article now this could
be log article but I'm going to just
choose a plural here so articles is
effectively our database if you think
about it we've got articles here and
then article is now our tight so this is
our index and this is our tight and then
after this you can have one two three
four or five whatever you can have
anything now if we don't automatically
give a number here this is the idea of
the record by the way elastic search
will generate one for us now if we do a
get request to this it says here index
missing exception articles that's
because we don't have an
next called articles and we certainly
don't have a type in here called article
either so let's actually create a new
record hit just to test things out and
then we'll go ahead and delete it and
I'll show you how to do that as well so
let's do a put or a post it doesn't
really matter to be honest
so we're doing a put or a post sorry on
this URL now the data that you send
through to elasticsearch is in JSON
format which makes it really easy to
structure this it's very readable so
we're going to send a basic piece of
data here and all we're going to do is
we're going to say title and we're going
to choose a title for our article so I'm
going to say this is a test article and
then down here we're going to say body
and I'm going to say this is the body of
my article I hope you like it or
something like that so now when we
insert this or or send this request to
our client here that's going to store
that under the articles index the type
of article and at position one so let's
send that and then we get back created
true and we get back this version as
well this version basically keeps a
track of what version you're on so if
you were to replace this at the same
record you would get a version two in
fact if we just send that again you can
see that we get version two and it has
not been created because it already
exists it's still a tidy one though and
it's still at this index and at this
type so now if we want to get that data
we just do get a articles article one
and then we go we get it back so we get
the version we get whether it was found
and this source contains all of the
fields that we've already stored so
let's for example look at something a
little bit more complex so let's look at
say some keywords and we are going to be
storing keywords with PHP and I'm going
to do this as an array so I'm going to
say test.php
there we go we get version 3 it hasn't
been created because we already exists
let's go ahead and get this and there we
go so we've got now got this array
stored in here as well and this is also
searchable so we can do that if you
wanted to create another article another
article you would just do it at position
2 now what we're going to be doing
within PHP is storing this with randomly
generated keywords at sorry randomly
generated IDs for us if you want to see
all of the records that have already
been stored we can actually do this a
test I'm going to do a post on article
and I'm going to store this is another
test article this is the body of my
article I hope you like it
it is another article and let's say I
know yes or something like that so I'm
going to send this and that's worked it
says it's created at version 1 and it's
given me this ID back so it's randomly
generated me this ID so if you don't
mind
IDs being randomly generated this is
fine so if I want to look at all
articles what do I do
well I need to return back to sending a
get request instead and this time what
I'm going to do is I'm going to get rid
of the tight I'm going to keep in the
index and I'm going to do underscore
search now this you you can do opposed
to request on this to send sorry you can
send data along with this to get back
lots of different you know use different
options to search but I'm just going to
do a plain search on that you can see
here that we get things like the amount
of shards and which shards successful
and very rarely if any shards failed and
we get this hit which is what we're
interested in it says total a max score
your articles will be or your records
rather will be given a score based on
how they match the search in this case
because we've just done a plain search
they all score one in relevancy because
they'll you know we haven't specified
any keywords or anything like that so we
get our results back now I'm not going
to go any I'm not gonna go much further
than this
cause it'll sort of ruin the idea of the
video which is to integrate this PHP if
you did already know this my apologies
but what I'm going to first do is just
head over to articles like this and I'm
going to do a delete on this index we
can just send that request and it says
acknowledge true if we try and search
this now you can see that we get nothing
back we get that index missing again so
we can start afresh from PHP now so we
already have our elasticsearch client
installed we can actually start to build
this up now and make it work and it's
very it's going to be very similar to
what we've just looked at so let's take
a look at actually adding documents here
so when we submit this form we're going
to have a title or body and keywords so
let's just do a quick if statement up
here to say if not empty post and in
here let's do a quick check just to see
if all that underscore post title has
been set check that the bodies been set
and check that the keywords have been
set so I have they been included in the
form we're not going to do any
validation here because it just doesn't
make sense
so instead what we'll do is we'll say
and let's just pull this down a little
bit actually we'll see the title is that
submitted through the body is obviously
the body and then we have some key words
here as well and we will be exploding
these Maya comma not great for real-life
use but in our case it's just going to
take that string of keywords separated
by a comma and it's going to split that
up so we won't want to now once we've
submitted this form we can check this is
working just I guess by echoing out a
title so test or something like that
there we go looks like everything works
we can now actually index this and we're
going to be using obviously
Our client to do this so we already have
this included in index we've already got
a saurian in it here we've already got
in it included here now we're going to
be doing exactly what we've just done
within postman what we're going to be
doing it with our client so I'm going to
store an a variable called indexed and
this is going to be using the index
method of our elastic search client that
we've created here so we just send an
array through with a similar data that
we would send as a normal request that
we've already looked at in this case I'm
going to be specifying the index though
so I'm going to specify an index
specifying the type and then specifying
the body of the request so it's not
quite what we've looked in in a postman
but it gives us you give all the data
that you need
so obviously the indexes articles the
type here is going to be article and the
body is then going to be a JSON string
now it's not going to be a JSON string
it's going to be an array but it's going
to it's going to work the same as the
JSON string because we have a mode
multi-dimensional array here so it just
it just works the same way basically so
for the title we add the title in for
the body we had the body in now when we
added keywords before all we did was we
added an array into the request so in
this case all we do is we add in the
keywords which are now an array because
we exploded them so down here what we
can then do is just check if that's been
indexed properly so we can just say if
indexed would've print are on this just
to see what we get back which is quite
interesting remember when we created
some data here we got an output back
from elasticsearch telling us the ID of
the record telling us the version
whether it was created on up so let's
send some or let's send a couple of
articles here and then we can check them
inside a postman and that's the beauty
of using a rest client like this so
let's just copy and paste a load
article content this might take a little
bit of a while but it will be worth it
trust me so let's take all of this data
I mean if you're doing this as an
example try and include as much data as
you can so I'm going to do net magazine
and I'm going to type generate ad there
we go so we get this array back here
which is the exactly the same as what we
saw when we added articles here a moment
ago
the version that whether it was created
which is 1 or 0 true or false the ID
which we're automatically generating
here because we're not specifically
defining an ID if you wanted to do that
all you need to do is say ID like that
pretty straightforward and yeah that's
it so let's just create some more
articles here
so let's copy and paste these
that's our net magazine as well here
remember these key words are going to be
searchable even though they're in an
array this is what makes elasticsearch
so great that we have really good
searching ability obviously so let's
grab one more article we'll just have
one more so we don't or ourselves to
death and let's grab as much as we can
from this one like I said if you're
doing this just so if you want to grab
as much data as you can and as many
articles as you can you could even use
something like faker which is a sort of
fake generation library of PHP this
would basically just mean that you'd be
inserting loads of lorem ipsum you could
just test how fast things are so net
magazine and UX for the keywords and add
that in cool so we've now got three
articles in there we can't search
because we've not added the ability
that's just as easy but let's head over
to postman and actually do a search on
this articles like we did before and
here we go so we've got a total of three
hits a maximum score of one obviously
because there's no relevancy because we
haven't fried any keywords and we've got
all of the data in here including the
keywords that we stored against these so
we've got an M magazine
we've got a space here because we didn't
do it properly in PHP but you know we're
only testing things out here that won't
matter to elasticsearch anyway so we've
got all the data in here everything
looks good and that's it that's it
pretty much we've we've got all we need
so we can specifically look at an
article if we use its ID so I can do a
copy on that so I can say articles
article paste that in and that just
gives me back that one article you get
the idea so now we want to actually
search which is obviously the heart of
elasticsearch we actually want to search
how the data that we already have so
inside of index.php we have this as a
get request so when we actually do type
in something so say we were searching
for net magazine we get this as a as a
query up here so we know that that's in
the get superglobals
so let's do an if statement here much
like we did on the other
age and let's say if yet oops sorry if
yeah we could say if is set yet queue
just test that out there we go and when
it's not set you shouldn't see it cool
so we are checking if that's been set
now we can just store that in a variable
just so we can quickly use it later on
and now we actually want to use our
elasticsearch instance again to actually
search our index so I'm going to call
this variable query and we're going to
use the search method on the elastic
search library and again we pass in an
array now the body now this we did we
don't sort of typically well we don't at
all if we're doing say search on
oops sorry get if you're doing a search
on this when we do send over a body if
we if we want to we wouldn't say
something like
body body is just what you use within
the library so here this is the body of
the request so inside of the body we're
going to have another array remember we
use multi-dimensional arrays to sort of
simulate the json nature of this we're
going to send over a query now the query
is going to be a boolean type query so
we say ball now there's so many
different ways that you can search on
elastic search but in this case I'm
saying multiple query strings so
basically what we're doing is we're
saying we have this query remember we're
doing it yet to underscore search in
this case we're doing a post so we can
send some data along there we are
defining that this is a query we're
saying we have a bull query a bull type
query which you can read about if you
head over to site the elastic search
site and we're saying it should so
resign should match the title should
match war and peace and another match
the author should match someone so in
this case we can use this for our own
fields now depending on your data
depending on how you want to return data
ending if you want to really speed it up
if you've got lots of data to search you
may not want to use this you may want to
use something else within elastic search
so you might want to use filters which
are you should generally use over
queries but we're just sort of exactly
you know doing an example here we're
getting a feel for the library and in
this case with this small amount of data
generally there's not not much wrong
with doing this so under here we're
going to pretty much just replicate what
we've just seen over on elastic search
here so our next is should so we're
going to say should and then we're going
to say in here this is an array
match
then we have an array there and then we
have match here again and we have an
array there so the first is the title
and in this case we want this to match
the query that's passed through
basically with our get request here to
this page and we want to search the body
as well now what we can do here then is
under here I'm going to do a quick if
statement and I'm going to say if query
hits
total is greater than or equal to one
then down here I'm going to say results
is query
hits
it's now in actual fact before we do any
of that let's just do a quick print our
on the query that we get back just so we
can see what data that we work we're
working with it and let's wrap that in
pre tags just so it looks a little bit
neater okay so under search we're then
going to search for say a hit search and
there we go almost we're in fact three
of our three records have a in it
unsurprisingly and either the title or
the body and you can see here that we've
got array hits total which is what we
looked at just here it's total obviously
if there are no hits you'll get
something like if we just change this
here we get hits total at zero and in
this case it's three we've got a max
score here and we have a relevancy which
is actually now working so we've got
this score here and I think this
automatically orders by relevancy which
is obviously handy you can change this
we're not going to be going into that
just now so we've now got our hits so
these this is an array obviously with a
numerical array and in here we can just
iterate through these and then output
the results basically we can give the
score if we really want to there
probably wouldn't be any need but we've
got the title in here we've got the body
in here and we've got the keywords in
here which are again come back in an
array again which is Ryu SFIL is then we
can output the keywords so that's the
results set we get so we can do we can
sort of work with that as it comes back
from the elasticsearch PHP client so
we've now got the results down here so
let's just be a little bit messy and
just output them down here by breaking
out of PHP and coming back into it you
will obviously have a more elegant
solution but in my case I'm just going
to be doing this very roughly so PHP
tags down here let's check if not that
sorry if is set results now if the
results are set we can go ahead and loop
through them so I'm just going to break
out of PHP here
and in fact now I'm not I'm going to do
four each
we're going to say for each results as
are and then we're going to break out
and here we are going to just create a
you know an element with a class it
doesn't it's not really relevant to what
we're looking at so we've got a result
here we'll create an anchor for this and
we'll then down here for each result
have perhaps some key words so we'll
just say result key words some inside of
here we want the title so this is going
to be the title this is going to be a
hash and then the ID and then in here
they're going to be the key words so as
you can imagine if we search now all we
get is three of these with hamid coded
title and key words and an ID which
isn't very useful
remember I'm querying for a which means
we get three results which is what we
expect we'll take a look at changing
this to search keywords and then we'll
search for specific keywords in just a
moment now for the ID this is pretty
straightforward all it basically is is
if we open some PHP tags here is our and
then underscore ID we saw this in the
output so if you are struggling just do
print our results again and that will
give you more information about what you
can pick out this array that's been
returned in here we want to echo our but
this time we're looking under that
source key and that's title so we now
get this we get the three titles out and
for the keywords what I'm going to do is
I'm going to do an implode so totally
the opposite of what we did to put the
data in we're going to do an implode on
this remember this is an array so we're
going to implode this we're going to
join it by a comma and this is our
remember it's under source again and
this time it's under keywords there we
go so now we should get out
if we actually echo that we get the
keyword perfect so let's do a search now
for something that doesn't exist in all
of these so you X for example if I type
you act and hit search we get first of
all this because it's recognized on
there our keywords and it's also in the
title it's probably in the body as well
so we could do generate as well if we
wanted to hit search and that gives us
that back as well and html5 as well
would do the same obviously this is a
very small data set so it's hard to
first of all test the speed of the query
it's hard to test
you know the relevancy because really if
we search for html5 the only relevant
result will generate the only relevant
result is this one so that's a very
basic introduction to using the
elasticsearch PHP client we've learned a
little bit of theory about elasticsearch
itself which always helps you can go
ahead and introduce more complex queries
more so than I've done here so things
like filters but the main thing is
getting your data in there and giving it
a search oh and actually let's quickly
add this match in for keywords because
I've just realized but I haven't
actually added that in so when we were
searching for them keywords it wasn't
looking in the keywords so if we just do
a search for say generate we get this up
if we were to say I really want to
search on keywords we can do that and it
will work just the same so there's our
basic introduction how to play around
with the data and see what you can do
with elasticsearch</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>