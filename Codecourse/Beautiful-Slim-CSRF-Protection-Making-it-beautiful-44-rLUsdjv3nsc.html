<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Beautiful Slim CSRF Protection: Making it beautiful (4/4) | Coder Coacher - Coaching Coders</title><meta content="Beautiful Slim CSRF Protection: Making it beautiful (4/4) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Beautiful Slim CSRF Protection: Making it beautiful (4/4)</b></h2><h5 class="post__date">2017-02-21</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/rLUsdjv3nsc" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">before we look at how we're gonna do
this let's just clear all of this out
and pretty much start from scratch so
we're not going to be sending anything
through to our views whatsoever and of
course over in here we can get rid of
these two as well so this is back to the
state where it is not gonna work so if
we just go ahead and submit this it's
failed so our goal is to get this
working but using the extension we saw
earlier so the next thing I'm going to
do is just demonstrate a simple twig
extension so by this I mean that when we
registered the view component over on
our container you can see here that we
are adding an extension called twig
extension and this is part of the slim
views package so if we just open this up
and take a look at it this will kind of
give us a clue as to how we can improve
the cross-site request forgery
protection so in here we take in any
dependencies that we need so we can pass
anything through to here and in this
case we are passing through our router
and we're passing through the base path
just here now the reason for that is
that over here when we use things like
path for this actually generates a
complete path for us so again if we just
take a look at this we have slim
cross-site request forgery update so
this will generate all of that for us
now the key to this is then being able
to define out these twig simple
functions and this will call the current
class and it will call a method that
you've defined like so so essentially
path for and base URL the functionality
from this comes from these two functions
now if we think about this if we were to
create our own extension and then go
ahead and use it over here we can pass
through the cross-site request forgery
package or dependency on our container
and we can pass through anything else
that we need as well and then we will
have a function that we can use inside
of views which is exactly what we want
to do so what we're gonna do is just
create a very simple one just to kind of
demonstrate this and then we're going to
implement the actual full thing because
I always like to kind of play around
with this before I get going so in
actual fact we can create the kind of
class that we're going to create now and
then we can just test this this work so
make sense to do this so inside of that
because we're already also loading here
I'm just gonna create a views folder and
inside of here I'm gonna create a
cross-site request forgery extension
like so and to be honest what we could
probably do is just copy most of this
over it's kind of just like boilerplate
so let's go ahead and just paste this
into here nothing wrong with doing that
and then we can go ahead and just tidy
this up so obviously we don't need the
commenting at the top the namespace will
be different it will be app views now
and this is our cross-site request
forgery extension now it still extends
twig extension so we can leave that as
it is but let's get rid of these
dependencies because we don't quite know
at the moment what we are passing
through and we're gonna go ahead and get
rid of get name as well and we need our
get functions but what I'm gonna do is
get rid of one of these and I'm just
going to define out a test function so
I'm just gonna say test and I'm gonna
call a test method so once again we can
get rid of these two we really don't
need these and we also don't need this
set base URL either so let's define out
a test function here and let's literally
just return let's say your name so in my
case Alex
so now that we have this as long as we
add this into here we should be able to
use a test function within our views so
let's go ahead and do this so it's under
app views and it's our cross-site
request forgery extension and at the
moment we're not passing any
dependencies through so we'll just get
rid of that so as long as we've done
everything correctly what we should be
able to do now is somewhere on this page
use that function so let's just come
anywhere on here and go ahead and say
test like so and then we see that works
so this is the kind of basis of getting
this working now what we can do is
actually make this work to output some
markup for us just to make our lives a
lot easier so over in our extension what
do we need to pass in to this in order
to extract the information from our
cross-site request forgery package well
of course we need to send through that
guard class so let's go ahead and do
this it's as simple as saying container
cross-site request forgery or container
get cross-site request forgery whatever
you want to do and now over in our
extension we can accept this in so let's
bring back our constructor just in here
and I'm going to type hint this so at
the top I'm going to use slim cross-site
request forgery and guard and it's just
fixed that up and now I can type hint
this here bring this in and go ahead and
set it to a property and then we can use
anything we want on that so this guard
equals God go ahead and create our
property up here like so brilliant so
now what we can do is create a
cross-site request forgery field
function which is exactly what we want
to do and we're going to call cross-site
request forgery field method but of
course we're gonna keep convention with
function names we're gonna have
underscores with our method names within
this class we're gonna use camel casing
so all we need to do in here now and
really you can separate this out into
multiple methods if you want to tidy it
up is literally here just return to
markup so what I've chosen to do is just
in single quotes because we are
outputting markup literally just write
all my markup in here and then we can
use at the guard class here to go ahead
and extract out the token name key the
token name and the value key and the
value so pretty simple so all we really
need to do in here then is just create
some hidden inputs and I can't use my
macros here so I'm gonna have to
manually hurt type all of these out so
type is hidden and we have a name of
course and we have a value let's
duplicate this down and this is going to
be our other one so we pretty much now
do exactly what we did before but this
time I'm not passing it down to our
views so for the name let's go ahead and
concatenate on this guard get token name
key so just as we saw before and the
same for our value as well let's go
ahead and concatenate on this god
touken name and like I was saying
earlier you can separate each of these
fields out into separate methods if you
want there's not really much point
because we're always gonna you know
we're always going to need both of them
so it's entirely up to you what you want
to do so for our last one then it's get
token value key and for the value it's
this guard gets token value and we are
done so that really is as simple as it
gets we now have our extension we are
registering this extension passing
through our cross-site request forgery
package on our container we're adding it
to all ropes and in a minute I'm gonna
show you how to add this to individual
routes if you don't want it on all of
your routes and we should be good to go
so what we can do now is just make sure
we didn't break anything come over to
home and instead of using that silly
function we created a minute ago we're
actually going to use the cross-site
request for tree field function now at
the moment this isn't going to work
because by default twig will escape all
output which is exactly what you want so
you're gonna get the following but this
is good to see that it works so we've
got cross-site request forgery name
value and it looks like all of this is
ok so there we go
so now to actually get this working we
just need to use the raw filter within
twig and this will go ahead and actually
add it to our form we click update and
it works so there we go that is as
simple as it gets you can include this
on every form and by default we have it
enabled or at least cross-site request
forgery protection enabled for all
routes now if you wanted to add it say
to just the upgrading of a subscription
what you're going to need to do is not
only add it to your post route just here
so this is how we add middleware for
individual routes you are of course
gonna need to add it for this one as
well because this is actually generating
the token so when we land on this view
this is generating the token so we need
the middleware in there for it to be
able to actually generate it show it on
the form and then go ahead and check it
here so this will work in exactly the
same way but it
just means you have a little bit more
flexibility if you wanted to exclude
certain routes from this so you could
just add it to any way you wanted but
for most purposes all routes protected
by cross-site request forgery is a good
idea and you can see now that this works
as normal so there we go
a simple twig extension to go ahead and
output all of the cross-site request
forgery information that we need so it
is super convenient to include in our
views</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>