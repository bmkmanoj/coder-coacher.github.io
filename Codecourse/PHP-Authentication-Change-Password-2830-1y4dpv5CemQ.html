<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>PHP Authentication: Change Password (28/30) | Coder Coacher - Coaching Coders</title><meta content="PHP Authentication: Change Password (28/30) - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Codecourse/">Codecourse</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>PHP Authentication: Change Password (28/30)</b></h2><h5 class="post__date">2015-05-28</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/1y4dpv5CemQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">right so when I'm gonna build in the
functionality to allow the user to
change their password so there's a few
things that we need to do here we
obviously need to create the routes to
be able to show the form then allow the
user to enter them and submit it through
to another routes so post it through to
a route we obviously need our views
which include our form and we also need
to update our validation because we need
to validate or add a validation rule to
check if the users password that they
supply is the same as the current
password they have and this is mainly
for security reasons so if anyone comes
to a computer and sees you logged in
they can change your own password so you
need to know your password before they
can change it so let's start off then
with just the usual staff we're already
logged in as a user here and what gonna
do is going to add a link to our menu to
be able to change our password we'll
create both our routes and we'll take it
from there
so let's open up our navigator so we'll
close all of this stuff off let's open
up our or navigation view and if the
user is authenticated we want to create
a new link here so we create a link but
hash in there for now call this change
password and let's go and create these
routes so under routes under auth we
want to create a new folder called
password and under here we're gonna have
a route called change dot PHP this is
where the user is going to land to
change their password so we'll deal with
the page with the form first of all and
then we'll look at posting it so we have
app yet and the route we are going to
choose is just change password you can
obviously you can call this whatever you
want and we're gonna use okay so to
render the view we just want to say app
render or password change dot PHP let's
create that view now under views and
auth will create a new folder for our
password stuff remember this is going to
include resetting the password and
forgotten passwords as well
so we will change PHP so change password
and we've got all this hooked up now we
just need to add it to our main routes
file so let's just add this here like so
and then in our navigation we will
update out your r4 we obviously need to
give this route a name so let's say or
dot password dot change and under our
navigation now we can say URL for
Orthodox word not change we can
obviously prefix these with author if we
want or we could just get rid of this
all together it's nice to keep them
under one kind of namespace type thing
but we'll just keep consistency for now
and you can change this around to what
you want so now that we've got that then
we have changed password we can click
that and we see change password so let's
build out our form under the change
password view we need to pull in our
kind of ace that we use so we can again
steal that from home let's paste that in
there so change password and in here
change password we've got one thing at
the moment you don't need to be
authenticated to change your password
because what we're not doing is taking
advantage of the authenticated filter
that we created earlier in the series so
here what we're going to do is we're
going to say we want the user to be
authenticated before they change their
password and that's going to be the same
for the post root as well so inside of
our view we'll create a form this is
gonna go through two password change dot
post so we'll just quickly define this
out here so app post
change passwords this also needs to be
an authenticated route we have our
callback there use app so I'll just echo
posted and we're going to set the method
to post obviously I'm going to turn
autocomplete off so inside of our forum
what do we need well we need to take the
users old password we need to take a new
password and we need to take a password
confirmation so we'll be checking the
old password against the password they
currently have we'll be taking the
password in the password confirm and
comparing them and we'll do all this
through the validation class so the
first field then is going to be for the
old password so we'll create a label
here for password old will say old
password and we'll create an input type
of P here so a type of password so no
one can see this we'll give it the name
password old that's the name you pick up
within PHP and then we'll give this an
ID so that's hooked up to the label so
and again we'll copy and paste this just
to save a bit of time the next field is
the new password so you just get rid of
password old like that and then we want
a repeat or a confirmation of that
password so we say password underscore
confirm password let's go confirm and
the same here and then we here we say
confirm new password and then last but
not least we have our submit button
which is going to equal change now
remember all of our forms that we post
our cross-site request forgery protected
now so if I was to change my password we
don't have a password change post root
name so let's just add this on password
change post so let's go back and submit
that here so cross-site
forgery token mismatch so em we're
forced to implement a change here so
we're going to put an input type of
hidden we're gonna pull through for the
name our cross-site request forgery key
which remember is in all of our use now
and the value is the cross-site request
forgery token so that's fixed that we
can now submit it and do whatever we
need to change the user's password so we
can type in our old password new and we
can confirm our new password now how do
we process this well we're going to do
the same as we've always done we're
gonna grab our request object it's an
app quest and we're now going to pull in
the old password the new password in the
confirmation so password old that is app
request post password old we have the
same trow new password which is just
called password and we have our password
confirm which is our password confirm
like that so we need to validate this so
we're going to be adding another custom
validation method in our validation
class much like we did when we were
checking if the user had a unique email
or username so again we say V equals app
validation that's our validation class
and we start to validate this data so we
need to validate the old password and
that's password old now the rules for
this are that it's required all of these
fields are required and the other rule
is that it matches the current password
that's the only other rule we can't
implement that yet we haven't created
the method but we'll do that in a moment
so the next is for the password this is
password variable is required and we can
also define the same rule as we did when
we registered so we want this to be a
minimum of 6 characters so the password
confirmation or password underscore
confirm has the rules required and it
must match the password here that we've
passed in okay so if this validation
passes what we want to do is update the
user's password by hashing the new
password they've given I want to save
that and then we want to send them an
email to say that their password has
changed we want a flash of global
message to tell them that their password
has changed and redirect them to the
home page otherwise we want to show the
form with any errors so if V passes this
is where we're gonna update the user's
password otherwise what we want to do is
we want to show the page with errors so
we just say app render we render the
same template which is auth password
change dot PHP and we send through here
the errors we don't need to send through
the request like we've done in previous
parts because we're not actually going
to be showing any of the form data
that's been entered we're not going to
pre-fill them fields if they've not been
entered properly just for security
reasons so let's check and see how this
works so I'm going to click Change now
we have errors because we've had haven't
entered any of these and they are all
required so we now need to actually
update our form to display them errors
so under each of these we can do the
usual check that we do to output errors
we can say if errors has password old
and and if there I think previously
we've not used has so for example in our
login form we've used if errors first so
we can go and just update them like so
for the registration as well so we have
a has method which checks if any errors
exist on this either one will work fine
it doesn't really matter too much but
what we can do is just keep consistency
here and then this should be left at
first because that will just show the
first error so if errors has password
old we want to output that error so here
we just say errors dot first password
old so we can submit the form through
again and we see password old is
required so we can copy this paste this
down here and do the same for just the
new password and we can paste this in
for the password confirmation as well
it's a password underscore confirm and
password underscore confirm and there we
go that's how validation done to a
certain extent
so let's actually update the user's
password and then we'll tackle adding
that validation rule into actually check
the previous password which is really
important otherwise we wouldn't bother
having the field there so to update the
user's password what we want to do is
say user password equals app hash we
were gonna hash a password and this
password is going to be the password
that they provided so the new password
remember we have that in a variable
called password and I'm gonna say user
safe now there's another way to do this
we can do user update and then we can
pass through password as this here so
either way you want to do it I
personally prefer update but it doesn't
really matter which way you do it then
we want to send an email we'll tackle
that in just a minute but before that
we're gonna flash a message to tell they
use their passwords been updated it's up
in a flash global
you've changed your password and then
we're gonna redirect so app responds
redirect and we're redirecting to the
URL for the home page so again we're
just doing the same thing we're just
flashing this but the reason we're gonna
send an email is it's a security
consideration if someone does have their
account compromised and their password
is changed it's good to just send them
an email just to tell them that their
password has been updated so they know
so when I hit change now we obviously
get all these validation errors let me
enter just password here and then I'll
enter a new password I'll go ahead and
click change and we've got under five
variable user in change so let's just
have a look here okay so when we say
user update obviously this is app auth
update it's not user we don't have a
user variable there so it's just
resubmit that form and there we go you
changed your password so now if we just
go back to our database table this value
would have changed so what you could do
is bring it up and just check that the
hashes changed well if I go and well
let's do it again I suppose this make
another update and change and there we
go when i refresh now you see that that
hash has changed and we can logout and
log in with our new password so now
let's tackle the problem of checking the
old password so we need to create a new
validation rule here and this is going
to be something like matches current
password like so so we need to update
our validation class to be able to check
that the password that's been sent into
the validator matches the users password
that they currently have so how are we
gonna do this well first of all what we
need is we need to be able to get access
to our hash class from this validator so
we need another dependency injected
here that's hash hash and we also need
auth which remember can be null so we're
going to set it by now to default there
so let's add these as properties up here
so hash and off
so remember user just represents the
user object which can be any user this
isn't necessarily the current user hash
we know what it does it hashes and
checks passwords and other things and
auth is the currently logged in user so
let's set these down here and we
obviously need to pass these two in
because they're currently not being
passed in at the moment
so if we open up how start PHP file and
come to the point where we are defining
our validator here we can pass in app
hash and app Earth and that's it so now
we obviously don't have a rule the
reason we're getting this error though
is because what we're doing is it's
expecting an instance of poke or
validation hash which isn't right and so
what we need to do is just use the name
spacing in validator for hash so up here
let's say use code course helpers hash
and we should be all good to go
so now when we refresh we see class
violin rules matches current password
ruling not found that's basically
because we haven't implemented a custom
rule for checking a user's password so
this matches current password raw so
let's implement this now we're gonna say
public function validate underscore and
then matches current password the same
as we gave and we need to pass in the
value that's given in that form any
previous input in any arguments which
we're not going to be using and let's
just return false here for now just so
we can test this out so what we now want
to do is add a rule message so we're
going to say this add rule messages
and we're gonna add a rule message for
matches current password I'm here we're
gonna say that does not match your
current password simple as that
so because we're returning false from
this we'll always get this error if we
just fill this in rubbish that does not
match your current password password
must be a minimum of 6 and password
confirm must match password so
everything looks like it's working we
just need to work out how we check the
couple users current password matches
and this is really straightforward all
we need to do is an if statement within
this role to say if this both so
basically is the user signed in and is
this hash check password remember we
have that check password method on our
helpers hash class so check password or
password check that just verify as a
password and what we can do here is we
can pass in the value given from the
validator and then we can pass in the
user's password this auth password so
that's the password hash and that's the
password that's given by the user in
that validation so if that is the case
it means that the password does match we
can return true otherwise we can return
false so there are other ways of
structuring this but I'll leave it as
this just so it looks a little bit
simpler okay so now my current password
is just password just a string password
so I'm gonna type in my old password as
something else and I'm gonna type in
just password as my new password so I'm
going to keep it the same I'm going to
hit change and we have hash check
password so have a look at this it's
that password check as we already saw so
let's try this again so I type in a
random old password and I'll type in a
sensible new password and click Change
that does not match your current
password so as I mentioned my current
password is password so I'm going to
type that in and when I type in a new
password
and there we go my password has been
changed and we can check that in the
database we see the hash change like
that so we've not only updated the
user's password we've checked the old
password matches but now let's quickly
send an email to the user when they do
update their password just so they know
we're going to send an email just here
so as we know we have our custom wrapper
for being able to send email so we need
to do is say app mail send and we can
say email or password change dot PHP is
the view we're not going to send any
data along with this request we have our
call back here with our message argument
in the message is going to be sent to
app or email
in fact what we can do is we can say
user equals app off and then we can just
switch this out for user it just looks a
little bit more readable so user email
and here we need to use user for it to
be available in this scope here and
we're gonna say message subject you
changed your password so we need to
create this view now because we haven't
created it already so let's go under
views email or create a new folder
password and then create a new file
called changed PHP and let's just update
this to changed and inside of here we're
gonna do exactly the same as we've done
for any other email so we're going to
copy and paste the contents from the
registered email paste it in there and
in here we can just say you changed your
password you can just warn the user that
if they didn't they can contact you or
whatever you want to do in here
so we now have our email setup to alert
the user password has been changed or
actually changing the password let's
give it a go
let's type in my old password let's type
in a new password and hit change that
will go ahead and change my password as
we've seen and it should send us an
email to tell us that we changed our
password so there we go that's how we
update our user's password within our
authentication system</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>