<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>NodeJS / Express / MongoDB - Build a Shopping Cart - #12 Cart Model | Coder Coacher - Coaching Coders</title><meta content="NodeJS / Express / MongoDB - Build a Shopping Cart - #12 Cart Model - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Academind/">Academind</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>NodeJS / Express / MongoDB - Build a Shopping Cart - #12 Cart Model</b></h2><h5 class="post__date">2016-06-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/_pVKGCzbMwg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so I want to add new items to the card
so a great place to start probably is my
shopping page where I have this add to
shopping cart link here I want you let's
say Target a route which I'll name Add
to Cart of course named is however you
want to name it and I also have to
create this route I'll do it in my index
chess file for now so in here I'll
configure a new route I get routed ubi
and I'll give it the same path as in my
view add to cart and I'll expect the
idea of the product I want to add to my
card here this of course has the default
middleware function here and as a side
note you can always leave out the next
part if you are not using it since it
gets passed a seafood argument so I'm
just writing it too well kind of a
convention I adapted but you don't have
to you can all just call this function
like this and it should still work
unless I'll leave next year so in here
basically what I want to do is I want
you push my product DoD product I want
to add to my card kind of into my
session but I also want to store it in a
card object of course I don't want to
push it into my session like a list of
products just like that now I want you
have a card object in my session so I'll
come back to this card object in a
second
for now I'll first retrieve my ID so
product ID will just be retrieved from
the parents this request has the ID
parameter here of course and with that
as I said I want to create a new card
for that I'll create a new model in my
models folder here I'll name it
cartouches now for now i won't create a
mongoose model since i'm not restoring
this card in database at least for now i
might add this later when i want to
store cards for logged in users maybe
but right now I don't want you so I'll
just write well a classical JavaScript
constructor function here and of course
export it with module exports to make it
available outside of this fall too and
this card constructor function of which
I'll be able to create card objects
later on is now very important to get
right and on the other hand there are a
thousand of ways to do it so here's my
suggestion on how to implement it this
card here should have some items in it
and I'll change this later for now I'll
set it to an empty array just to the so
that we have something to work with I
also want to store the total quantity
I'll set this to zero by default for a
newly created card and total price of my
card items or yeah what all the items
together cost now I want to be able to
add new items to my card so I'll add
this add function here which allows me
to do just that and now here this one is
an important one if I add a new item I
won of course I want to get the item and
let's say I also want to get the ID of
this item because I will well of course
always expand my card with each new item
I'll add and you add a but here is an
important thing I also want to group my
items i if i add harry potter harry
potter book here if over at videogames
here okay so if I add a cough cutie
three times then I don't want to have
just three items in my card free times
Call of Duty but I want to group them
because it's one and the same product so
I want to have called cutie quantity
three times I still want to have the
individual game informations only priced
title and so on but I also want to have
the aggregated information therefore I
can't just push items on an array and
then what list is arraigned I could do
this but this will lead to a shopping
cart where we might have such a list of
well chess
the same game for example instead of one
row where we have game title and then
quantity 10 or whatever so this is an
important thing to get right
therefore what I'll do is whenever I
access my card so whenever I add a new
item I'll take my old card and create a
new card off this old card and I want to
be able to check if a certain product ID
like from the Call of Duty game for
example already exists in this card and
if yes then I will only well update the
quantity and so on so that I will not
push a new product in there so to make
this bit less theoretical if I add an
item here I'll first create a new
variable name it store item and this
should be mic system in items where I
want to see if this ID already exists
now rightfully you would say well this
items is an array how the ID here
probably won't exist since the array
index probably won't be matching any
MongoDB D ID and you would be right so
items here shouldn't be an empty array
but as I said I always want to recreate
my card so items will indeed be an
object or more specifically it will be
my old cards items so I'll name this
init items and I'll pass those items to
my constructor so with that whenever I
create my card I pass my old card into
it this old cards items will be while
assigned here to my items and with that
I'm able to check if my items which is
an object in the end where the key is
the product ID if they already have this
key this product ID if yes I know the
product already was added to the card
and I'll then work with that so here are
basically retrieving this and of course
I don't know if I'll get a stored item
because the item might not not have been
added to the card yet in this case it
would have to be added newly so I'll
check if I'm able to get this if not
this is this case here if I'm not
retrieving the stored item I'll create a
new one so then I'll set it equal to
items ID still but both will be assigned
to a new object where I'll have my item
to be my item the one I add here the
quantity it should be Cyril because I'll
increment it in the next step and the
price should also be zero because I'll
also increment or add deeper eyes in the
next step so with that I'm creating a
new entry I'll give it a key to be the
product ID here in this step I'm also
assigning it to the stored items sub
chest to involve in one step here so in
the next step here I'll then increase
the quantity by one and I'll of course
also change my price to be equal to my
items price and then of course times my
quantity just to make sure that the
price of the screw and that is referring
to the group here is the price of the
individual item times D well quantity of
the this individual item of course I
also have to go to my total quantity and
increase this by one and the same is
true for the total price which should be
stored item price so D prior or which
gets added the aggregated price of this
product group so hope this is clear how
this works that I'm even adding a new
product group if the product hasn't been
added to the cart before or if it has
been added then I'm skipping this step
here and I'm only increasing quantity
and price this is all I'm doing here in
this ad function now back to the top
here since I'm adding my old cart
currently I'm only adding the old items
however I can improve this I can change
this to be old card and then access the
items of my old card and here of course
the total quantity and then here the
total price and as I explained this is I
only needed because I'm recreating the
card whenever I do something with it
whenever I add new items so therefore
I'm passing the old card I'm well
basically fetching all the old data
fetching all the items already in the
car total quantity a price of course
and then I am able to call my ad
function here to add a new item to my
card here that's all I'm doing here now
I want to add another function here I'll
name it generate array and what this
function will allow me to do is it will
give me my card items as an array
because remember currently items will be
an object it needs to be an object
because my arm my items here are stored
with a key B of being the product ID so
I need to be able to have kind of well a
JavaScript object because anion area
would not allow me to do this I can't
set my own key in an array so therefore
I only to be able to transform it into
an array if I want to output it in a
list or something like this so I'll
write a helper function for this I'll
write my rule the empty array which I
will return in the end and then I will
have a simple for loop where I'll loop
through my items for the keys in my
items here specifically and I will push
an element on my array and the element I
want to push of course is the value of
each of my item so D individual item
itself and then I will return my array
and remember this is just needed to be
able to then output a list of my product
groups later on so that's the card
constructor and
to sum it up what it does is it
basically gets the old card when we
created every creator the first time
this will be an empty JavaScript object
we will then assign the values of the
old cards so items quantity and price we
have a function to be able to add a new
item to the card and here we have to
check if this item already or this item
group this product group already exists
in the card if not we create a new one
if yes what we don't we then just access
to the old one existing group in both
ways after this first step we increase
the quantity by one and we will adjust
the price and of course we also update
the total quantity in price so with all
that done I'll head over to the index
chess routes file here where I will have
my Add to Cart route here and here I'll
create my chart as explained a new card
will be created each time we add a new
item but of course I want to pass my old
card if I do have this
so I'll access my session and here our
latest or even a card property so I
check if this card property exists with
a ternary expression here and if it does
exist then I will pass my old card
otherwise as explained I'll pass an
empty JavaScript object so that's all
I'm doing here just making sure that if
I already have a card in a session I'm
passing that otherwise well empty object
with that all next use Mongoose to find
my product here find it by ID I'm
getting the product ID through the
parameter here and of course I'll also
specify my callback here and inside this
callback here you would of course also
check if we have an error and in this
case you want to return a response let's
simply say we return a redirect to the
root page of course in a real
application you probably
wanted to a little bit more show some
error message and so on but I want to
focus on the other part here so if we
don't have an error and that's the case
I'm assuming here then I will add
approach product product to my card here
so call the add method on my card object
which I created here and of course I
need to pass my product the one I just
fetched from the database and the
product ID to identify it or to create
the identifier and yes of course you
could only pass the product and extract
the ID in the add method but this way
it's written a bit more generic and you
could also use it if the product you
passed doesn't have the ID itself so
here I'm next storing this in my card
object in my session just like that and
the Express session will automatically
save with each response we sent back so
we don't have to save this it will be
saved as soon as the response has been
sent and therefore our session is safe
and then I'll also redirect duty let's
say product page so with all that um
would probably have a working session
and card but you wouldn't be able to see
this right so in order to see this what
I'll do is I'll just log my session card
here and increase the size of my console
restart the server and then just have a
look I wanted to say but we don't have
to have a look because I forget forgot
one thing I just remember that of course
also need to import my card here at the
top so require models cart that's of
course important otherwise we will would
get an error for sure so now with that
I'll restart the server
reload this page and I'll click on add
to shopping cart to get a not found page
now the reason for that is that I forgot
something in my shop your Add to Cart of
course also expects to get the parameter
so here when I access my Add to Cart
route I should probably add this so
enter handlebars here to simply access
the ID of my product so with that I
don't even need to restart the server
because I only changed my template I'll
navigate back to the product page and
I'll try this again now at least you get
a real error so let's see what happened
you probably got here is maybe a bit
hard to spot you could think that this
line would be the errors the problem
since we try to access something on an
undefined object however this items only
undefined because if I pass old-car to
be an empty java script object then of
course old card items is undefined
instead of an old in instead of an empty
JavaScript object because items doesn't
exist on that empty object
so when fix would be to not pass an
empty object but instead to set the
items key here like this and make this
an empty object as well and this should
work but another way of course is to fix
it in here to basically check if old
card is an empty object and then assign
it so I'll go with the first fix here by
setting items equal to an empty
javascript object and now if I rerun my
server here and I can just refresh here
to try to re add this this kind of
seemed to work so let's have a look if I
can see it and you can see the console
that we printed our card here however
till quantity until
don't look necessarily right the
individual object here looks fine though
we got the object quantity and the price
but total quantity and price weren't
updated so if you have a look at our
card these two functions here where
these two lines failed now we have this
failure for the same reason as why the
items had problems when we pass an empty
object to create this new card or as an
old card then we set the total quantity
and price to these fields in the old
card which is undefined at the beginning
now then we would try to increment and
you find an add a new price to undefined
them that of course won't work so in
order to fix this we also need to change
this here and now I'm going to show you
the other way I was mentioning before
currently I'm passing this empty card
with the empty items and I could do the
same for passing quantity and price to
be equal to zero but I don't really like
that approach I don't want to have the
logic in this fall so but go back to
passing an empty object here instead
I'll go back to my cart and I'll use
another operator I'll use the boolean
over here to say either do this but this
if this is undefined use an empty object
and I'll do the same here if the Sun you
find well then use zero and the same for
the price and with that I'm giving my
card to flexibility to assign the right
values depending on whether it's brand
new and an old card isn't existing or
not so that is certainly a great way to
solve this issue now with that I'm
saving this and I'll restart my server
now the issue you'll probably have is
you already have a session because it
was created but it's kind of broken it
does have this not a number quantity or
stuff like that so in order to easily
reset it you may open up your developer
tools and
Chrome for example go-to cookies
localhost and simply delete this cookie
here does connect Mongo cookie that's
the cookie of the session and now if you
load your page your session will be gone
so now if I add a new shopping cart item
and I'll go back to my project let's
have a look now this looks much better
we got this item we got a quantity of 1
a price of 40 and this matches the
overall quantity and price now if I add
the second time and I go back well that
looks almost good
we got quantity to price 80 total
quantity and till Bryce is wrong and the
reason for that is of course that we
have an error here when we increase the
total price we take it the old total
price plus the store title price now
that is of course not correctly because
the store item price is also quantity
times price so therefore I'm adding too
much but of course a very easy fix is to
simply take the item price so now I'm
not taking the aggregate price but only
the price of the single item which was
added so now if i restart this and of
course i'll also reset my session again
by deleting this cookie if i now reload
i'll add this to shopping cart we'll
have a look this looks good if i added a
second time this now also looks good now
if i add another item let's say well the
for craft you see we now get two items
quantity two price 80 thank you and the
overall also looks great
so that has been quite some work but i
hope you saw how we got there and i hope
these little errors helped you to
understand where the difficult parts
here are and how to get them right and
how to also well think about this
process of while creating this card
brand new each time and having to
consider
the aspect of ever having an empty cart
or existing items adding the price
correctly and so on it's more difficult
than you think but in the end also not
that difficult if you look at that code
here so that has been the creation of
the cart the next step of course is to
also well see it somewhere on the page
and not only here in our console</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>