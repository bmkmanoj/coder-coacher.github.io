<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Laravel 5.2 PHP - Build a Shopping Cart - #14 Forcing User Login | Coder Coacher - Coaching Coders</title><meta content="Laravel 5.2 PHP - Build a Shopping Cart - #14 Forcing User Login - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Academind/">Academind</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Laravel 5.2 PHP - Build a Shopping Cart - #14 Forcing User Login</b></h2><h5 class="post__date">2016-07-27</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/9VxiFhl6e8o" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so time to continue with this
application and time to work on do you
fact that currently every user is able
to check out but I want to restrict that
to locked in users only so that
certainly as something I'll work on next
a quick and easy way a level to make
sure that only locked end users can
reach the checkout page of course is to
go to the routes file then here which
you have this check out route and then
add a middleware to it add D off
middleware remember we're already using
the off malware it the user routes here
for example here where we want to
protect the profile and the logout route
so here I'm balls of protecting slash
check out and I'll also protect the post
route so that no user is able to somehow
issue a post check out requests through
the terminal or something like that
however if I do it like this and while I
reload this page
I'm redirected so I can go through a
shopping cart click checkout and I
redirect it to the sign-in page which is
great which is what I want but if I do
is sign in here I'm taken to the user
profile that and again I have to click
on shopping cart before I can actually
go to the checkout page if I click log
out while I'm redirected but it would be
nice if after signing in I would
automatically be sent to the checkout
page if that is where I wanted to go so
that this sign in it's not actually
redirecting me somewhere else thereafter
it would also be nice if I had some kind
of don't have an account yet sign up
link at the bottom and then again be
redirected to the check out page after
signing up so a bit of a more user
friendly process in this place here so
I'll first add a link here which is
pretty easy I'll go to my sign-in page
here this one and below the form I'm
adding text I just said don't have an
account
and then simply a link which says sign
up instead or something like that and
here of course this link should point to
my sign up route which is user I'll have
to look it up to be honest user user dot
sign up well that was easy
so here who's here I'll just link to
that page so now I at least have the
possibility of going to design up page
instead but still I don't have the
chance of or I don't get redirected to
the checkout page after doing so so in
order to implement that I'll need to go
to my middle aware file which I can full
find an email aware folder and here the
authenticate middleware is Tamila we're
responsible for protecting my routes
here and redirecting me and here I'm
setting up that I want to get redirected
to a user or sign in and that is of
course the correct behavior because I
want to redirect to this sign-in page if
the user is not logged in but I also
want to store the URL the user tried to
access previously to signing in so here
I will store this in my session put and
I'll just name it old URL of course you
name it whatever you want and then I'm
going to retrieve the old URL on my
request where a half does URL method
which just gives me the URL the user
wanted to access so with that I making
sure that I will actually not redirect
the user instantly but before doing so I
will at least store which URL he wanted
to access and I can also do it and here
because it's not relevant for dhx case
so with that I'm making sure that I at
least have that URL the next of course
is to use that and the place to
implement this is the user controller
here in the post sign-in method for
example I'm handling the case that the
user well is successfully logged in and
here is the place where I always
redirect to the user profile which is OK
normal sign-in process but if I wanted
to go to the checkout page then I don't
want to redirect there instead I want to
redirect to the old URL right therefore
in this off attempt check here where I
will check if the user was successfully
logged in I'll add another if block
inside of it where I just check if my
session has this old URL field because
if it doesn't have this field well then
I'm coming from somewhere else and well
I don't want to redirect there in this
case that I do have it I want to return
a redirect which then should lead to
well to does URL right so get old URL
like this I could do it like this but
actually all won't make one extra step
I'll extract the old URL here and
thereafter I'm going to forget this key
like so and then of course down here
I'll just use the old URL variable with
that I'm going to clear that old URL so
that upon futures sign-in requests I'm
not always getting redirected to
checkout page with that I set up the
redirection when signing in I'm going to
copy this code and of course I want to
do the same thing after signing up so
here in the post-synaptic out after
logging the user in here I'm also
checking if I have the over URL if I do
so I'll redirect there and if I don't
have it well then this KO here is
skipped and instead I'm just redirecting
to the user profile like that and with
that I'm making sure that I got this
well more convenient sign-in process
when I need to sign in for checking out
so with that change in place if I go
back to the application go to my
shopping cart and click on checkout then
I get this error because well first in
your controller we need to import these
sessions assayed certainly important and
I need to do this
in the authentic eight classier Soyuz
session like this okay with that if I go
back click on checkout again I redirect
it to the sign-in page and here if I
sign in with my dummy account click on
sign in now you see I'm getting to the
checkout page however one thing you'll
notice is if I lock out them I'm going
to the sign in page if I log in again
well I'm back on a checkout page and
that certainly is not to behavior one
right I want to go to the user profile
page now because checkout no longer is
my old old URL so something's going
wrong here and actually that's really
tricky if we have a look at our code we
do forget the old URL here after logging
in and that works I can tell you that so
somehow it seems to get set again at
some other place but the only place
where I do set it is here in my
authenticate Villa where here right so
it looks like we're getting to this
middle aware again and we actually do in
the user controller if I log out I'm
redirecting back now what does back mean
well if I log out here whilst only
checkout page well then back means back
to the checkout and the reason why I see
the sign-in page is just because the
checkout pages protected so here instead
of redirecting back which would lead to
old URL being set again I could simply
redirect to let's say user dot sign-in
directly doing it this way if I sign in
again you see that debugger was talking
about but if I now hit logout I'm taking
to the sign-in form and if I now log in
again we're at the user profile so now
this bug is fixed so that's definitely
an important one to keep in mind since
this is really tricky to find and it
well kind of destroys our whole work for
we set up there with that well out of
the way I can go back to
let's say logging out here then I can go
back to the you shopping cart let's say
I want to create a new user or some
quickly doing this with some dummy data
here and I'm going to be checkout page
as well with that I'm then able to
actually do the checkout I'll use this
dummy credit card number again some date
in the future some dummy CBC code here
don't save this purchase was successful
and if we have a look at the database
the orders table we get a new order now
related to user free which makes sense
because data ste user I just created
with this test free email address here
and yeah so all the orders are stored
here that's great
the very last thing is I wanna do is I
wanna take my user profile here and list
all the orders of a user so I'll be back
with that</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>