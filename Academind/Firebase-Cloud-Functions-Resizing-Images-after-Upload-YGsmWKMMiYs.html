<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Firebase Cloud Functions - Resizing Images after Upload | Coder Coacher - Coaching Coders</title><meta content="Firebase Cloud Functions - Resizing Images after Upload - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Academind/">Academind</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Firebase Cloud Functions - Resizing Images after Upload</b></h2><h5 class="post__date">2018-02-01</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/YGsmWKMMiYs" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">welcome to this video great to have you
on board in the last video of this
series I explained what firebase cloud
functions are about in this video I want
to get started with writing a firebase
cloud function and we will write a
function that takes an image we put into
the cloud storage that automatically
runs whenever we put an image there I
should say and that then simply resizes
the image into different format let's
have a look at how this works in this
video
so here I am in the firebase console I'm
creating a new project here so let me
quickly do that and in that project I
want to add this firebase cloud function
that will run whenever a file is
uploaded so with that let's wait for
this to finish
whence a dead finish you can go to
functions but here at least at the point
of time I'm recording this you can't
write your function we have to do that
locally with the help of firebase CLI
it's super simple to do though so let's
quickly install that Here I am in the
terminal of the Mac or open the command
prompt on Windows and then we need to
install a global package through NPM for
that you need to have NPM nodes package
manager installed which you do install
by going to note J s doric and simply
installing the latest version of node J
s with that installed you can run NPM
install - G firebase - tools this is the
tool set DC live firebase offers now on
Mac and Linux you might need to add a
sudo in front of this to get the right
permissions thereafter you might also be
prompted to enter your password and once
you did that it will install this
firebase toolset which you can use to
well run your firebase projects or
actually create a firebase project
create a environment where you can write
firebase cloud functions so I'll be back
once this installation finished once it
finished you first of all have to sign
into your firebase account for that you
can simply type firebase this command
should now be available since you
installed the firebase tools global
globally login once you type this you
are asked whether you want to allow the
collection of data and thereafter a new
tab should open where you have to
authenticate now you will have to copy
that URL it shows you there and simply
log in to your firebase account in that
new tab that opened once you get off
that it should successfully complete
here in the terminal and thereafter you
can create a new firebase project with
the CLI for that I'll first of all
create a new folder I navigated into
that new folder and in there the folder
which you want to turn into your
firebase project and as a side note this
could be your angular view or a react
project where you want to add some
firebase functionality so this can also
be a folder where you have another
project already but in this folder which
is an empty folder I'll run firebase in
it and this will now initialize this as
a firebase project now you're then asked
which features you want to use in this
project and I want to use functions so
I'll navigate there in the command line
and hit space to enable this you could
also turn on hosting if you want to use
firebase hosting for your single page
application let's say but I won't do
that here so I want you just have my
functions here with that I'll hit enter
and then you have to choose one of your
project so I'll choose the project I
just created in the firebase console can
then choose the language you want to use
your cloud functions you could use
Chavez at typescript but I'll stick to
JavaScript and with that you're almost
done you can then opt to automatically
install or require that we could require
dependencies and I want to do that here
so let's wait for this to finish
thereafter can write our function code
these set about the project finished and
I opened it in Visual Studio code it's
your normal web project editor which
ever editor you use there you'll find a
configuration file which holds the ID of
your project this of course should be
well your project ID firebase Jason
doesn't hold any configuration and then
we got this functions folder there we
also get a node modules and a
package.json fault these are now the
dependencies of the function we're
writing and in the index.js file here we
can write our function our firebase
function here this commented out part if
we commented in actually already is a
firebase cloud function this would be
one that listens to incoming HTTP
requests you remember that slide I
showed you in the last video
that would be the case or this would be
an example for how you can create your
own HTTP endpoint now I'm not interested
in creating my own HTTP endpoint here I
want to create a function that reacts to
files being uploaded or file events in
general in my cloud storage so let's see
how we can write such a function do you
react to storage events I actually won't
use the HTTP area on my functions
package here which is coming from
firebase functions which is made
available by default but instead here I
want to use the storage area
now on storage we got the object or
bucket property or method to be precise
this simply means do you want to specify
a specific bucket for which you want to
listen to events or if you directly
specify object and execute this as a
method without passing any arguments
then you will say I want to use the
default bucket the default bucket your
firebase Project chips well I will use
that bucket there you then have one
method on change and this now is exactly
doing what it sounds like it will give
you the information or it will trigger
whenever something changes on change
therefore requires a function you pass
as an argument and this function will
get some event data so this argument
will be passed into the function
automatically by firebase and then in
there we don't send a response because
we're not creating a HTTP endpoint in
there instead in the end we will return
to tell firebase that we're done if
you're writing some async code in there
which we eventually will you should
return a promise by the way but I'll see
all of that for now let's simply return
here and besides returning or before
returning i want to simply console.log
my event object to see what's inside of
it and with that we got our first basic
function created as a side note if you
want to have multiple functions you
would simply export another function
here which you also set up in the same
and that would then be treated
separately and I will rename this to on
file change whatever you want to use
with that we got our cloud function set
up now let's simply test it and for that
I'll open up the terminal it's the
normal terminal just integrated into
this IDE and you push this function into
the cloud so that we can test it
I'll run firebase deploy and this will
now take my function code bundle it up
upload it to firebase and set it up
there so that we can then well basically
use that function on firebase so let's
wait for this to finish and let's then
try it out the deployment process can
take a while it finished for me let's
now have a look at it in our firebase
project console you can click on
functions or refresh that page of your
own reor or on it and there you should
now see your newly deployed function on
file change the function we just created
you also see the attached event that
it's on object change events you can
also see the amount of executions and
you can access the locks here that will
become important to see what console
lock actually wrote now let's try it out
and let's go to storage and there we got
our default bucket if we click on get
started yeah we want to take these
default settings this is our default
bucket which will be used and let's now
simply upload a file to it here I got a
demo image which I will simply upload
pick any image you want or can and can
be any default doesn't have to be an
image I'll use that image and it's now
uploading and now this should have
actually triggered our function so let's
click on functions here and the
executions amount might still show zero
because it takes a little while to
update this but if we view the logs here
we should see the locks showing this
execution of the function we we just
encountered and this might also take a
second and simply reload if it takes a
bit longer now here you see we got an
error that the function return undefined
or a warning but we also see the
console.log statement with the function
where with this event object we output
now there you see this event object
actually had a data property which holds
information about the bucket that issued
this the content type of the file that
changed and if we have a look through
all of that we also see some additional
like infrared digital information like
the link to the file if you want to view
it some metadata attached to the file
and also the event type that it was a
change event now let's see if does all
the triggers for deleting so if we go
back to storage let's now select this
file and simply delete it and let's then
again have a look at functions and view
the locks let's see if this also
triggered a function execution
now thus far it doesn't look like it but
here we go so as I said it might take a
little while so this year this is the
function that just executed here if we
expand this here you see it's almost the
same data but there's one important
difference for the data here we get this
resource state property which in this
case is not exists if we have a look at
the last function execution where we
added this file there you see that the
resource state was exists so this gives
us an idea about which specific type of
event we had here that in this case the
file was deleted for example we could
determine this by checking for the
resource state here it doesn't exist
anymore so if we want to run some
function only upon the deletion of files
this would be how we could well check
for that so if there we can see how that
function runs now let's do something
more useful let's maybe start with
renaming the file so we got this event
object and we can see what's inside of
it here it has a data property with some
useful information and why don't we now
take that file rename it and then put it
back into the storage wouldn't that be
an idea let's first of all retrieve the
object by accessing event
data because that essentially is our
object data we got now here we can find
out the bucket by accessing object
bucket so I'm accessing this first
property here we can also get the
content type by accessing object content
type and let's also get the file path
here by accessing object name so fall
path essentially is just the name here
which will be not just a file name but
also the path in this bucket now I'll
add a console.log statement here and
simply output file change detected
function execution started just to have
some locks happen in between so we can
see where we are at and now I want you
to take that file and basically put it
back into the pocket with a changed name
before that I need to install an
additional package so navigate into the
functions folder in your project folder
and there i'll run npm install - - save
and now it's at google - cloud slash
storage which is a collection of good
cloud storage on which firebase storage
is built on functions and and methods we
can use and one of them is basically
putting data into a bucket and we need
that functionality here
so with that installed all imported as a
dependency at the top GCS is require at
Google Cloud slash storage and you
execute this as a function and the cool
thing is if you're in a cloud function a
firebase cloud function that happens or
is triggered upon a file change event
you can use the Google Cloud search
package here without having to
initialize it with any credentials you
can just start putting data into that
bucket without any special setup
required
so what I'll now do is I will first of
all create a new pocket I want to put it
- so dist bucket maybe or destination
pockets or something like that
and I will use GCS and there we have a
bucket method you set up a reference to
a bucket and it will pass the bucket
this fall was in because I want to keep
it in the same bucket I just want to
rename it as a next step I want to
download that file which we uploaded
which triggered this event so that I can
then manipulate it and put it back into
the bucket so I'll create a temp file
path so this is just where I want to
temporarily download it because and
that's important to know in firebase
cloud functions you got a small
temporary storage which will be cleaned
up whenever the function execution is
done essentially but which you can use
during the function execution now to
find out the path for this we can use a
node.js package which is called OS
giving us X some operating system
specific functions and I also want to
construct the path so I'll use the path
package node.js provides and with these
two packages we can construct our
temporary path by calling path join here
and I want to join the temporary path
off the operating system the function
runs on which I can get with the temp
tear function with the filename we got
so the file name of our uploaded fault
fault path is what I named it here now
this path however is the full path Arjun
what I just want to get the name I can
do this with the path package and there
with the base name method which I passed
the file path to this will then just
give me the file name part of the path
so if that would constructed this
temporary file path I want to store my
file whilst the function here executes
I'll then also create a metadata
constant where I will essentially set up
a JavaScript object where I set the
content type q content types or the
content type of god from the file so
that we keep that and then I will no
longer return nothing but I will return
deaths bucket using that Cloud Storage
package file which allows me to execute
operation on a file the file here is my
file path so the path we got
the event that's triggered here and then
I can call download now to download I
need to pass some configuration here I
had the configuration as to where I want
to download it you do this by adding the
destination key and here I want to set
it to my temp file path of course to
make sure that I download the file from
my bucket into the temporary folder now
this will return as a promise and of
course I want to do something when this
finishes so here in the den block I will
know that the file has been downloaded
now I can rename it and re-upload it or
do whatever I wanted to it of course not
just rename it we will do more to it
later here however I will just rename it
now renaming is simple I can just return
desc bucket and call upload and put the
file from the temp file path back onto
the server and if this doesn't make too
much sense here well it's a trivial
operation we will soon add more logic
than just downloading and uploading but
these are the core building blocks you
have to know so I will upload that file
again it hasn't been renamed but I can
rename it now I pass a configuration to
the upload method where I also set up a
destination and here I can just change
the filename so here what I could do is
I could add a renamed prefix plus my old
file name maybe so I could use path base
name of file path to again get dead to
again get this original file name and
now it would be the same file name with
renamed sidenote if it was in a
different path before it now isn't
anymore because I dropped the path I
could riad it in front of it but I don't
want you there here and that is my
destination
now also setup the metadata key here to
pass my metadata which essentially sets
up the content type of the new file
which should be the same content type as
before and now with that I got my upload
functionality here which eventually will
finish and should put in a rename fall
back onto the storage now before we
tried it out let me add more code I want
to add a if check here to make sure we
don't enter an infinite loop I want to
check if the Apple
uploaded fall puffs the file name starts
with renamed already so that I don't
reach rigor the function for that
renamed file so I will check if path
base name for the fall path so for the
path of the fall that triggered this
cloud function if that starts with
renamed so what we put to the fall here
so that I don't reach rigor this if
that's the case I simply want to return
here I don't want to continue execution
because now I know the file that changed
is the file we just renamed I don't want
to trigger a function again or otherwise
we would enter an infinite loop which we
certainly don't want you I will also log
something here we already renamed that
file now with all of that in place let's
save this and let's see if that works by
going out of the function folder in the
terminal and rerun in firebase deploy to
again push this updated version of the
function back on to firebase cloud
functions and this will simply replace
the old version off that function will
not be created as a new one will replace
the old one instead now let's wait for
this to finish and let's then try it
again
the deployment finished let's go back to
our functions console here on firebase
and we will still see the same function
as before now we see the execution all
is updated and I'll go to storage and I
again will upload a file to it so let's
click upload file and pick that same
file as before put it there
it's uploading here
and here it is and now let's have a look
at our functions log here so for the
function let's view the locks and as
always this can take a second before the
logs show up here for the current
function execution here it is however
and you see we've got two executions
here one at 9:27 15 and a couple of
milliseconds and then a couple of
milliseconds later now we all see we
already renamed the file here so good
thing we implemented the safe check
because this was dysfunction running the
second time for the updated file this is
the function running the first time now
let's have a look at storage and we
should see two files in there now and we
do
that's the renamed winter and as you can
see it has the same file size if we do
it it's also the same image as you can
see here on the right
that's the original one and with that
you'll learn how you can use that to do
something with the incoming files you
all learned that it's quite important to
make sure you don't enter an infinite
loop now let's do more useful stuff to
the image though than just renaming it
in this way I want to also resize it for
this I'll use a library named image
magic which contains a lot of
functionalities we can use to change
images in all different kinds of ways
you'll find a link in the video
description with more detail I'll just
use it to resize that the cool thing is
image magic already is pre-installed in
the environment the cloud function runs
in all we have to do is use a package
that allows us to run basically tools
binaries that are installed on the
server the cloud function runs in the
end it's a package called spawn which I
require from a package I have to install
and this will be called child process
promise there we can then access the
spawn property now let's install that in
the functions folder so navigate in
there and run NPM install - - save child
process promise it's essentially a
package that allows us to run any
processes on the operating system of
this function and get back a promise
we'll never get out of the folder
they're after and with that we can use
that spawn here as a function to run
well native programs installed on that
server so to say I want to run such a
program here when we downloaded the file
there I want to return spawn and due to
it coming from that child processes
promise package this will give us back a
promise I want to return spawn here and
now pass con word that is a command we
can execute on this system the firebase
function random and it's coming from
image magic so I want to run con word
and then I has an array of arguments
here to that convert command and that
are simply commands the convert command
or these are arguments to convert
command understands like the input the
filename basically so temp file path so
the file we stored on the cloud base on
the cloud function storage then the
second argument is that I want to resize
it we do this by - resize and third
argument are the dimensions and the
dimensions will keep the aspect ratio
and we'll use the smaller of the two
relevant sizes so let's say I want to
resize this to 500 by 500 and again this
will not necessarily spit out an image
of size 500 by 500 it will simply try to
fit the existing image into this format
by keeping the aspect ratio and then I
will specify where to store it well this
will simply be the same file name so I
will overwrite that local file I still
want to upload that but this has to
happen anew then call because again
spawn returns a promise so I chained
another then call and in this then call
I know that the file will have been
resized so I'll also name this resized
and then simply upload it again just as
before now since I named is too resized
here I also have to update my check here
resized and I will add a second check
what if we actually deleted a file then
we would fail here because we try to
download a file we don't have so what
I'll actually do first is I'll add
another check here and simply check if
object resource state equals not exists
remember this was one value we could see
here in the cloud function lock for one
of our first executions where we could
see that if we triggered a delete event
that resource state would it be not
exists so this is what I'm checking for
here if that's the case we deleted a
foul
so I'll cool lock we deleted a file come
on exit and there Arthur L also just
returned because upon file deletion I
don't want to do anything so these are
two useful checks with then we should
now resize the file and then upload it
again
so let's save everything here and let's
again run firebase deploy to see this
changed function in action deployment
finished now let's try it out
let's go to storage again let me first
of all delete both files here both
commands will now trigger our cloud
function so it should execute here but
it also should simply quit because we
specified that we don't want to do
anything if we have a delete event so
let's simply wait for this and actually
just didn't work as expected so let's
have a look at the code here object
resource state and actually it should be
alright let's try this again later
maybe the function just wasn't updated
yet when I deleted this so let's try
uploading a file now let's take the same
file as before and actually we don't
even have to go to the functions log
here we could simply reload this page
and we should see the resized file set
next to our original file now and there
we have it resized winter you see the
file size is much smaller and if you
access it there you see they file again
now if we quickly download that file to
inspect it locally you will see that the
dimensions are 500 by 281 which simply
means it took T 500 and adjusted e I
don't want to keep the aspect ratio now
let's simply see if that check here with
not exists as really not work so back in
our storage console here let's delete
both files again
let's see if again it just fails because
it should now really not fail but simply
exit because we well already deleted the
files we deleted a file exit so this
works fine so it wasn't updated to where
time before this actually is it for this
video you learned how to react to file
changes how to make sure you react to
the right changes and how you can then
download that file manipulate it in
which ever way you want it and put it
back onto the pocket or not put it back
just download it and do something here
which doesn't make too much sense though
because this local storage in the cloud
function gets cleaned up once the
function execution is done anyway so you
learned a lot you can do with this file
change event here now in the next video
I want to have a look at creating a
restful endpoint with the HTTP event</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>