<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Paul Dowman talks Meteor and DDP - Spacecamp 2015 | Coder Coacher - Coaching Coders</title><meta content="Paul Dowman talks Meteor and DDP - Spacecamp 2015 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Josh-Owens/">Josh Owens</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Paul Dowman talks Meteor and DDP - Spacecamp 2015</b></h2><h5 class="post__date">2015-11-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/f5QMLXwscIA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">welcome to the meteor Space Camp 2015
video series these were a series of
videos recorded in the mountains of
gatlinburg tennessee during the meteor
Space Camp 2015 event that was held in
October if you're interested in more
information please check out meteor
Space Camp also big thank you to our
sponsors our gold sponsors were modulus
you can find them at modulus I 0 for all
your hosting needs whether that be
meteor or node or PHP they can handle
all that for you easily modulus taio and
also okay grow calm if you need to have
an application built okay grow is the
place to get it done give them give them
a shout over it okay grow calm and also
a meteor club you can sign up and join
me to club at meteor jas club it's a
weekly email you get tips and tricks
about meteor and other relevant news so
if you're interested in that check it
out meteor jazz club and also compose
our Silver Sponsor composed I oh they're
a great place to host your database and
take care of any database needs you may
have whether that's Mongo or
elasticsearch or any number of platforms
that they're supporting now I use them
for all my production stuff so I highly
recommend it composed on Io all right so
uh yeah again I'm Paul down man from
okay grow I'm really glad to be here so
really I think we're all going to great
time this weekend and I'm going to talk
a little bit about how DDP works and how
and how live getting live updates from
the database or anything else get over
to the browser via DDP so i think i'm
going to take a kind of a like a little
bit of a walk through some stuff that's
in the docs that a lot of people i'm
sure know about i think also it's
something that a lot of people haven't
really seen or used because most of what
you do
is just pulling data from Mongo most of
the time but you can also you can also
publish data that didn't come out of the
database that came from any data source
or that you just totally made up and I
think it's kind of a neat thing and I
just want to show how easy it is to do
so what i've done here is i've started i
just created a new app this is just a
to-do list meteor create example simple
to do's and I've started it up with by
running meteor debug so that starts up a
node inspector so if you if you've never
done that just running your app with
meteor debug instead of just meteor
gives you it will print out it on the
console what what URL you can connect to
so localhost colon 8080 anyway just
paste that URL into your browser and
then there you go you're going to have
something looks a lot like the chrome
inspector that you usually use to do
servers to do client-side debugging and
whatever but this is a view into what's
happening on the server so just to speed
things up I I put a breakpoint already
in here and I've got it turned off for
for a minute and I'm gonna where's the
oats in this tab so I'm going to okay
I'm already signed in so I'm going to
create let's start that break point
let's turn that break point on ok so now
oh yeah and before I before I do this
I'm just going to show you where this
where this stuff exists in the
documentation so in in the meteor docs
if you look at publish and subscribe go
to meet your public I got a little bit
bigger and this is what you normally do
publish functions can return a
collection cursor in which
meteor will publish that cursors
documents to each subscribed client so
this is what we normally do with meteor
and just going to show you another thing
you can do if you read on a little bit
further it says alternatively a
published function can directly control
its published record set by calling the
functions added changed and removed so
that's what I'm going to show you today
and I'm also going to show you that when
you when you publish a cursor from among
go collection then it's actually just
going to be doing this ad to change your
move stuff for you so let's try that
let's go back to our node inspector
let's make that a little bigger okay so
here you can see we're inside published
cursor from the Mongo this is inside the
mongol package I can see that I they
think they're basically calling sub
added sub here will be the subscription
they're calling added changed and
removed so I put a breakpoint here for
added just so that we can take a look at
what happens so let's go over to the
console and make this a little bit
bigger so you can so you can see it and
i'm going to type meteor shell and just
so that i know what to do what to insert
i'm going to do one from from the UI
first so i'm going to say new task put
that in here now let's make that a
little bigger so you can see it so if i
say so i have a collection called tasks
Oh capital T tasks
lego tasks find out fetch let's see what
we get we have a task that looks like
that it's got a night it's got an ID and
an owner and anyway that most important
thing is here we've got text so if i
were to insert one of these from
somewhere else say a new tab or say the
meteor show oh I'm in my wrong I made my
wrong show here so i just bear with me
for a minute I want to be in this one
ok
so oh yeah it is thank you yeah so let's
um let's actually just let it go through
the air until it's okay alright so now
your show all right probably should have
set some of this up a little bit more
before that so i can insert a task and
i'm going to i'm going to i'm going to
say tasks insert i shall just take the
one that i already have but i'm going to
cop i'm going to need to change the the
owner ID so the owner is going to be fat
so this is going to be the ID of the of
the owner okay so now it's pausing for a
minute it's probably it's stopped on the
breakpoint actually it's not yet for
some reason it's really slow doing this
in a second we should see note inspector
being stopped there goes so i got i got
an ID back it's been inserted into the
database into MongoDB but it still
hasn't showed up in the UI over here
right and that's because notice is
stopped on this breakpoint so if i take
a look at the object here i've got the
ID and events something called something
called fields now if i go in to the if i
go into the console i can type fields
and it will show me what the object
looks like there's the text i entered so
let's do it that's the name of the task
use your name doesn't matter what's in
there now i'm going to sew but you can
see is that it's calling sub added and
it's giving a 3 3 parameters collection
so that's the name of the collection
that it's going to go into
and I've I can see that Oh looking at
fields but if I if I look at at those
things anyway that's going to be the
name of the collection it's going to
tasks the ID is going to be an ID of the
object and fields is this thing that i'm
showing you down here which is the
object that that got inserted all right
let's let that breakpoint continue and
it's going to add this going to happen a
couple times going to continue and now
at this point it appeared in the browser
okay so that's doing it the normal way
that's putting it into Mongo and
allowing meteor to to publish this since
the mongrel cursor is being published
that ended up calling chain or at
calling the added function from the
Mongo package but I can do something
else here so here's my here's my
published function in the in a simple to
do's example out and you can see here it
is a return what it returns is tasks
fine so a cursor I could make a new
published function and I can say meteor
publish fake tasks and I can say
actually what I'll do an even better
than doing something directly in here is
i'll i will save a i'll save a reference
to to this because let's go back to the
docks and i can see that it's talking
about the added function so it's
actually this dot added so when i'm
inside this oh I'm sorry that's not very
visible let's make my bigger so when I'm
inside this this publish function what I
can do here is I can call this dot added
all right and I can I can give it this
I can give it collection ID and fields
name is what we just saw okay so rather
than doing that directly in here I'm
going to I'm going to actually store a
reference to it I'm going to make a
global variable let's call it I don't
know subscription handle equals this
okay so I input I didn't put VAR at the
front here so that's going to make it
global oops okay let's save that let's
let meteor restart itself I'm going to
probably have to turn off that break
point now just so that it doesn't get
too annoying oh and also you know what I
want to add a breakpoint in my new in my
new published function so let's just say
actually no let's not do it alright so
if it has there we go presumably it has
reloaded yep it's working alright so now
I can go back into node inspector and
down here I should have something called
subscription handle and I don't so I'm
going to reload
let's go back in the console now
remember this is this is no one
inspector this is not my browsers
console this is this is a console that
left to be execute stuff on the server
so subscription Oh actually I'm sorry
subscription handle isn't going to exist
yet because nobody has subscribed to
this publication so let's go in here and
I'm going to say meteor dot subscribe
it's called fake tasks there so now if I
go back here I've got something called
subscription handle good there it exists
it's an object so subscription handle is
just a reference to the this variable
from inside my published function
remember the published thing is it's a
long-lived it's a long-lived thing
inside meteor so at any point you can
call those added changed and removed on
it so i can go subscription handle dot
added and i can say the collection first
argument let's go back to the docks
first argument is collection second one
is ID and field so collection is going
to be called tasks then the ID is going
to be anything one two three and fields
is an object that is going to describe
the task now this app is expecting that
object to be a certain format so let's
do tasks that find on fetch and see what
just remind ourselves with that format
is supposed to look like and it's going
to have an ID it's going to have a sorry
the ideas added but created a donor text
etc so let's say we could probably just
ignore some of those things let's say
actually that's not let's do created at
date owner and that's going to have to
be my user ID so let's say
I would be the same owner from this one
so that's my user ID owner text so text
this is going to be this is going to be
the thing that shows up alright that's
just going to be any thought and the
last thing we need is user name I'm not
sure if that's even used anywhere but
let's do it ok so I'm this does not
exist in the database anywhere I'm just
calling the added function and that is
going to cause meteor server to pass
that down over the DDP connection to the
client so I call it added nothing
happens over here but there it is so
that's the thing that I just called
added on it exists in the collection
alright so now if I go tasks find fetch
I've got three objects the one called do
it is the one I added from the UI the
one called the new task was added from
the UI and here it is the last one look
the ID is just one two three that's just
the fake ID that I gave it created I was
just a new date I gave it in the console
and the text is what I want to give you
so that's the one it doesn't exist in
the database at all if I if I reload the
client it will not be there so this is
how you this is how you can like do live
updates of all kinds of stuff doesn't
have to be out of the database so for
the hackathon Ben and Carl and another
guy who's not here and I we we built a
little thing and this is this is pretty
much how it works so it's called rest to
DDP rest too DDP and it makes basically
what it does is it takes you to fetch
data from a REST API anybody's API and
convert that into a live update
sort of live because it's actually
polling the rest api convert it into a
live updating DDP subscription and what
I just show there was calling this added
inside the publication that's that's how
it works so I'll just give you a little
quick demo without as well that's right
nothing's being saved to the database
this is all just a way of long as that
publication function is running it'll
fit concerns so in actually yeah you
know what I this this might help answer
that when i was what i should show is
that in the in the web inspector if i go
to the network tab and i go to web
sockets here there will be a web socket
and this is showing what happens over
that over that DDP connection so so
basically the client is receiving
messages over the DDP remember it's a
persistent connection over web sockets
two-way communication and so it can
receive events received messages over
there and some of those messages look
like lady can are these ignore these
ping and pong there's just keep alive
but there's things like okay ready this
says the subscription was ready that
came from the server a little bit before
that we had one about subscribing but
the stuff that i'm showing here is these
added ones so let's say added yeah
that's right thanks and so if i expand
this can I
figure there you can see we've got a
message that came from the server it
says added oh and actually i refreshed
this browser so you won't see the one
that i added any but let's show it let's
add another one so if i go in fact i can
go change i can keep all that same info
that's called change this time so
subscription handle that changed so the
collection name that's the collection
that it'll end up being in on the on the
client side and the client must have
already created a collection with with
that name so you'll have to exist here's
the ID so because I'm calling changed I
need to give it the idea of something
that already exists and I can change one
of these things so instead of oh sorry i
have to call add it first because i
refresh the browser so let's call it
added and then if i go back to my other
tab in our WebSocket connection i should
see it did not work get a break point
oh yeah thanks so I have to resubscribe
yeah so let's do meet your death
subscribe fake tasks again and now i can
do that on the server alright so now i
can go subscription handle that added Oh
should work yeah there it is right so
now if I look at my network tab go to
web sockets now here I see a message
that says added the collection was tasks
the ID was one two three and the fields
are so you can see how that came over
the WebSocket connection if I go back
here and let's say I make that instead
of added I make that changed and let's
change this text i change the text to
say this is not in the DB and i'll go
back over here and i can see here came a
message it says the message type has
changed the collection is tasks same ID
of course so that it knows which one and
then in the fields it's going to have
that new text and i can see that it's up
updated here in the UI as well good
question I don't know yeah I assume it
would ignore it seems like an error but
probably won't
yeah I haven't tried it I don't know how
it would handle it but yeah you mean in
the server it's big yeah it's because
this added it doesn't return anything
and we don't need to use their we don't
care about the rich on the server side
where we call this code we don't care
about the return value of this of the
added function so I think it doesn't
return anything that's no this is this
here it's on this it's on the server
side so this is inside node and the the
added function is is yeah the when we
call when we call this added which is
which is from the DDP package the added
function that we call it take some
parameters it has a side effect does
things which which is sending that
making that DDP message happen but that
function there does not return over it
returns undefined which is fine because
we're not looking to get anything back
from it we're not going to use so yeah
and so then ends up being logged on in
the console here from node inspector so
so that shows how how the message ends
up going through to the browser it shows
that it doesn't have to be something
that came from the database if it was
something that came from the database
it's actually the meteors of angle
package is transparently doing a similar
kind of thing this added change and
removed Colin goes on the publication
for you and then so so i'm going to show
you quickly how what we did for for rest
to dtp to make that work so look at too
many browsers open
okay there we go okay so let's make this
a little bigger so basically what we did
here is as we allowed there's a little
bit of you I here to like let you create
some configuration about what your API
call is going to look like so you can
have multiple so we give it a name so
now you define the name of the
collection that's the thing that's going
to end up as the first parameter in that
call to to add it or change or whatever
and then we also have like a rest
endpoint URL so this is something that's
going to return some data and inside
that data somewhere there is going to be
an array of objects and that array of
objects what what what rest to DDP does
is it parses that array of object it's
it stores it and then when it pulls it
again in a few minutes it looks for the
differences so the first time we do it
every single object in that array is
going to be sent down to the client
using this dot added the way the way i
just showed then it will pull again
after a period of time that we can
figure here so it looks scroll on that
so five every five seconds and then the
response here's here's the headers it
shows us live as we updated there this
is the raw content that came out
remember this was a 24 hour thing we
didn't have time to format it really
nicely I think we could improve this UI
a lot and then there's a thing called
JSON path so this is an expression that
says in all of the in this like big JSON
document that came back how do I find
the thing in there that's an array
because most API is rest api is that
return JSON the array is not usually the
like a root object it's got
it could be anywhere nested down and so
in this case there's something so dollar
is the root then in here and this
response there's there's an object
called query so here I got query and
inside query there's something called
results which has a nested thing called
channel item forecast forecasts is an
array that's the thing we want so this
expression here with dot star says give
me all of the all of the elements in
that array that's the thing we care
about and so but rest to DDP does is it
makes that API called pulls out array
and the very first time it says okay
I've got an array of stuff these are all
this is the first time I've done it so
these are all new so I'm going to call
this dot added because it's inside the
publication let's take a quick look at
that so it's actually a really simple
thing it's basically just one big
published command one big one published
function so media to publish this is
where the configuration that we define
Danny you I got passed in and
essentially we make the make the call
here with HTTP get a little bit error
handling probably not enough and then
and then we do it diff now I think
actually we could probably do way better
with this diff thing I think meteor has
stuff in the guts probably knows all
about that and then and so after the
diff the first time through we just say
like this is the first time so all of
them are new we just say to read over it
and we call self i added which is the
thing this this dot added on each one of
those things that's basically it and
then the net then what we do is we pull
we pull every in this case five seconds
but it's configurable whole every five
seconds and so the next time you make
that request
do the dip and if you see that something
got changed well then you call this dot
change so I'm going to do a little one
more demo of it and then then we'll just
have questions so here is here's a
here's what here's one that I just set
up using Trello so now charlo is kind of
a bad example because trell actually
have they don't have just they have more
than a REST API they actually do have a
WebSocket real-time API but a lot of
sites that don't and a lot of times you
just you need to do a rest api for
various reasons latrella was a good one
to use their rest api to show this
because i can easily create something
that is in a list and move it around
quickly and just see the results happen
right away so at the bottom of our oh
and i just want to show one more thing
because so here's my hard coded URL this
this is expected you actually have to
have 0 op authentication that you've
already done so you need to have like
you can't just use the Trello API
without like you know this is a private
board with a private list you need to be
authenticated so there's some parameters
here we have a key and a token is the
application key this is the token so and
of course there's a list ID so if we
want to make this thing really general
we need to parameterize these so I'll
take that out and I'll go dollar
brackets list and that added a new item
here so i'll paste the value in there
and pull the key out the key and add
coming here called key and i'm going to
pull out the token and let's put that
value here and now it works again so
somebody can subscribe to this using
using them using those
okay so here's here's generated code
that you can use in your in your app
that wants to subscribe to this
subscription as you can see that on the
subscribe call it takes some some
parameters so let's do this we can go to
another app we happen to have that to-do
list app already running so might as
well do it in there close our giant
window there ok so I go to the console
if I pasted all that in I have to change
this yeah because now I've got
parameters for the the list and
everything so let's pull those
parameters back out because now remember
this is like a kind of a runtime thing
so the list is going to be that the key
is going to be that and the token oh
whoops face it around place token is
that the key is that ok so this could be
anybody else subscribing with their own
credentials now we've got a subscription
handle back if I everyone to stop it i
would have saved a reference to that and
now the next thing i can do is i can do
something like see this trouble cards
that's the name of the collection i
created that collection here by saying
new among without collection Trello
cards and that has to match what the
server is going to send as as a
collection name parameter ok let's try
it so now to all the cards that find
such now i have three objects there we
go the first one is got a lot of stuff
in it but the one that you want to look
at is named so name is first card and he
read it so it matches that so that's the
last three objects so in fact let's
actually put that inside an autorun so
chocolate autorun and we're going to say
console.log this is just so that it'll
change change automatically for us and
I'm going to sit inside the console log
I'm going to say Trello cards find dots
fetch have a broken key on my keyboard
there we go draw the cards that find out
fetch okay so now when this changes that
will just be printed out to the console
for us automatically again let's go back
here and going to add another card so do
that we need to wait a couple seconds
every five seconds of polls I'm also
tethering over a very slow edge
connection right now so I hope this
works there it is the wood so if I look
at the last object it should be fourth
card works and it also works when I when
I move these around so if I move fourth
card up to the third position wait a
minute I should get a new update there
there it is I look at the third position
there it is 45 so that's it so just to
just to recap the important thing is
inside inside your meteor publish you
can call this thought added
instead of instead of doing a find and
returning that cursor you can simply
call this added this dot changed and
this dot removed you give it a
collection name you give it an ID and
you give it the fields in the case of
added it'll be the whole object in the
case of changed it'll be just whatever
fields changed cool thanks</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>