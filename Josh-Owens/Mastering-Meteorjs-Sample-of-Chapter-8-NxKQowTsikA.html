<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Mastering Meteor.js - Sample of Chapter 8 | Coder Coacher - Coaching Coders</title><meta content="Mastering Meteor.js - Sample of Chapter 8 - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/Josh-Owens/">Josh Owens</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Mastering Meteor.js - Sample of Chapter 8</b></h2><h5 class="post__date">2015-10-06</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/NxKQowTsikA" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">welcome meteor fans to the mastering
meteor sample chapter i am josh owens
and i created this course because I
wanted people to be able to take a
deeper dive into media and how I build
applications and I also wanted to build
something that was more comprehensive
than what some of the online tutorials
cover so this course has over eight
hours of video in it and you know this
is this is half of chapter eight that
I've put up here for you to watch this
is a pretty advanced story we're talking
about how to do join publications and
the kinds of problems you might run into
in creating those publications and how
you might solve that so the the sample
again is only half so we won't get all
the way through the solution but you
know at the end we're building a Twitter
clone we've put some time and effort
into building the UI up front so we're
taking a static you I'm making it
dynamic it looks like Twitter we want to
feel like Twitter and we've got about 14
or 15 stories that we go through and we
cover all kinds of topics including you
know we dabble a little bit and just
showing you how to boot up Cordova
running the iOS simulator and hosting
and you know building with blaze and
iron-router and all that kind of stuff
so feel free to you know just watch this
video and if you're interested you can
go back to mastering meteor jazz club
and you can get the rest of the course
for 249 so thanks for watching
as a tweeter I want to see a tailored
chronological list of tweets from people
i follow so that I can learn what my
friends are doing so this is basically
us wiring up the tweet page right so
technically I'm following Alice so this
page right now looks relatively correct
right we're missing Alice's data here so
we'll have to publish that but we're not
really checking so if i if i added a bob
account and bob logged in and you know
he he tweeted something it would show up
here as well right because we're naively
looking at all the tweets and so we need
to start scoping this to be the tailored
you know users i care about because I
followed them type of tweets
and so a lot of this work is going to
happen in the publication itself because
we already have the tweets hooked up
properly you know we just we need to
expose all the tweet data correctly so
what we need to do here is we're going
to look up the user because we need to
find our user coming to meteor user here
let's look at the docks yeah okay so in
the docks by the way I don't I don't
know if I mentioned this before but
it'll tell you where you can use things
and clearly we can use meteor user in
the client or the server we just can't
use them in published function so won't
walk I wasn't quite what we wanted but
what we can do instead is just say users
dot find one ID is this dot user ID
that's a special bit of context we get
there that is set to the logged-in users
user ID on the server so we can use that
will find the user and then what we need
to do is
we need to grab some following ID so
we'll start to use something like
underscore here Thanks so we don't know
need to use underscore here users equals
users dot find right because we're
looking up all those users and we'll do
like ID and then we can do dollar sign
in which is an array match operator for
us and we can say user dot profile
following IDs and that'll give us our
users back the other thing
we want to expose here are the tweets so
we want user ID in user that profile up
following IDs and then from a
publication we can actually return
anything we want so even though we're
calling this my tweet we can actually
return use our comma tweets here right
because we're returning cursors so we
can return an array of cursors with
different kind of data and it's just
going to push all that data that we need
across the wire and so that becomes
interesting because we're essentially
like this is this is a very basic join
kind of thing that we're doing here but
it is going to have some bugs in it
matter of fact I have some kind of bug
now turns an array of non cursors what
did I return I return user instead of
users I did so you always have to return
that cursor from the publication
there we go and now you can see we're
getting Alice's information now right
here but again whoops we've exposed to
much of Alice's data we've exposed all
her stuff again so we need to make sure
on our query for users let's see right
here we just do fields it would be nice
if you could just like globally do this
somehow there we go and now we've got
Alice's data back down where it needs to
be and so this is interesting let's
login Firefox is Alice and in Chrome as
Josh and let's see what happens
are we throwing an air cuz oh yes yes we
are we did need the following IDs
basically we need to put our own ID into
the following IDs because we want to see
our own tweets
because we can just make an array and
push into it
so we'll just push our ID in there and
then we'll change all the east to be
following IDs so always at least return
our own tweets I'm just looking in the
air somewhere
Alice doesn't have any following IDs
anywhere so what we need to do is
initialize this as an empty array then
Mongo won't give us an heir and then
we'll just push up both those trouble
type in there we go now alice is seeing
her own tweet over here and interesting
do we do we lose Alice's tweet wonder
why we did that because I'm pushing into
arrays we need to flatten this guy
you
mmm
still not quite right triple console dot
log here he's going to save it all
there we go so now we're seeing alice
again basically we were getting in a
race structure that looked like this you
know one two three and then your own ID
was being in sorted inserted in there
but instead what we really need for
Mongo lookups is something like that so
that's what flattened is doing for us
all right testing reactive tweets so
again on the right we're logged in and
firefox is Alice on the left elgin is
josh and chrome you can see boom now
let's got the new tweet Josh got the new
tweet bingo everything works great just
like we expect right but now we're
starting to get into the problem of
reactive joins so let's say Matt besides
hey I want to try this thing out and
let's see we'd signed up just give up
Matt really know em huh I guess I put
that in there Matty
so we get registered logged in as Matt
and now we can put a tweet hey guys I
met and so over here like I'm not
following that so that was as I expected
right but what happens is I don't think
we need Firefox anymore um Oh guess is
gonna be fun see if we get these windows
to come up the way I want here we go
so now if I go look at matts profile
Matt d and I follow Matt I'm actually
one would think you're going to get
those tweets to show up in your timeline
right but that's actually not the case
so we click follow nothing happen we
refresh the page over here suddenly
we're getting Matt's tweet and so the
problem is we are making two calls right
here and we're driving those two calls
off of a non-reactive data source right
here these following IDs and there's no
way in the server for us to like there's
no such thing as a tracker autorun right
so if we did this on the client we could
just do you know tracker dot autorun and
it would track this code you know
something like this and we just wrap
this guy down here and it would watch
all this code and if something changed
it would then rerun it but that's just
that's that's totally not the case
because there is no such thing as
tracker on a run in the server I just
deleted all that could and so
what we need to think about when I would
I want you guys to play around with
tonight kind of as homework is you know
you need to use observe changes and
watch our user for the following IDs
field and when that changes you do some
math to see who was added who was
removed and then you actually have to
push down each record over the DVP pipe
using self added or self dot removed and
I'll show you where that's at in the
docs this is this is a complex topic and
I don't expect you to get it right like
it took me three classes before we
actually got it functioning so no
worries there but I think the important
thing is really just kind of like look
over these docs and try to understand
what I'm talking about so what what
we're really messing with here is live
query and this is how the server is
doing everything under the covers it's
running these observed changes for you
so watch a query receive callbacks as a
result chat result set changes only the
difference between the old and new Doc's
our past is that right is that the one
we want yeah and so you know it's
similar to how media method was where
you just give it a map of you know added
and it's going to run a function if
something and the query has been added
or removed and so what we're going to do
is we need to actually save off this
user find here and this will be our user
cursor and then user equals
he's a cursor fetch zero we just care
about that first record and so our code
should still work here but then what
you're going to do down here is use our
cursor dot observe changes and then
you're just you're going to have a whole
lot of code i'll tell you right now like
it's it's probably like 50 two lines of
code to get it all working correctly
because what you have to do is you watch
each you watch your user cursor and when
those following IDs change you then need
to use underscore to do a little bit of
math to see what's been added and
removed and then for each array of added
people you need to go through and find
their users and then we're going to make
a what is it that I did you make this
subscription added call and basically
you give it a collection name and ID and
then you pass it the object in question
right all the fields for the object and
that's actually what pushes it across
the pipe using d2p so that's going to
get the data from you know point A to
point B from the from the server to the
client and you know that's that's kind
of how it works but again like i'll be
around on email i'll push this code up
make sure it still works it still works
that's the works good
alright so this is uh this is a big
topic and I know it's a little bit of
mind-bending that's why I try to
actually end the day on it kind of let
you think about it overnight tomorrow
we'll get back at it and think about it
and talk about it and work through it
but if you want to take on the challenge
like try to write that publication to
work using your own observed changes</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>