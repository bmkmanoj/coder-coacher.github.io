<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Christopher Small - How Clojure Saved My Chickens | Coder Coacher - Coaching Coders</title><meta content="Christopher Small - How Clojure Saved My Chickens - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/ClojureTV/">ClojureTV</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Christopher Small - How Clojure Saved My Chickens</b></h2><h5 class="post__date">2015-04-22</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/0EQMrpZb7-Y" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so today I'm going to be talking about a
strange coupe how closure saved my
chickens from the evil raccoons and
figured this would be an appropriate
talk for Portland crimp from Seattle
where we also have lots of chickens and
yeah this is the thing so it's a little
bit about me I did a start-up or I have
a startup called polis and we use data
visualization and machine learning to
make large-scale conversations make
sense and this is a free tool now and
you can you can check it out at pol is
and this is kind of how I got into
closure and it's it's a really cool
project definitely recommend you check
it out I'm not gonna be talking about it
too much more than that but I should
also add that right now we're
bootstrapping and so I'm looking for a
consulting work so anyone who is
interested in working with me just um
you don't give me up afterwards or you
know get in touch with me on github or
whatever so first let's just establish
some basic facts raise your hands if you
think raccoons are cute yeah okay okay
so this is a common misconception there
in fact evil on the other hand chickens
are awesome they are hilarious they're
like the trailer park boys of the
Zoological world because they're just so
stupid and hilarious like if you just
watch them for hours sobha sadly
raccoons eat chickens and this is a big
problem so last summer I moved into a
new house with my wife and the they had
a chicken run there but it wasn't fully
fenced in so we had to lock the chickens
in the coop every night and let them out
in the morning and this was going to be
a problem you know I couldn't go out and
like just not worry about the chickens
and I had to wake up early every morning
and let them out and so like any good
programmer I sought to automate this so
the rough plan was to have a light
sensor that would detect the time of day
and have a motor that would lift a door
up and down and that this motor would
sorry that this door would have some
kind of locking mechanism that would
hold it in place and keep the raccoons
from open the door because raccoons are
kind of surprisingly thrifty and my plan
was to run all of this are using closure
on a BeagleBone black so here's the
photoresistor that I used for the light
sensor
this is like kind of Arduino 101 so it's
really easy to go and find out how these
things work and how to set them up I
went to an old hardware store in town
and they had a old used drill pile and
found this old electric drill for ten
dollars nine volt drill and so use this
for the motor the pulley system is
pretty hacky as you can see there's some
glue some plastic some string and so
yeah so I tied I tied the the string
that goes to the door onto this little
loop there that's glued into the drill
not how I do it again but you know it
definitely worked so the door design I
you know I thought about this a lot and
it they're all these sort of complicated
things I was thinking at all i'm going
to need a servo to like stick a pin in
that's going to lock it and ultimately i
searching around and found something on
youtube from this guy named clint fisher
who did an automatic door and he had
this brilliant locking system which I'll
kind of clarify a little more later but
I went ahead and stole this because it
was really elegant solution to the
problem so here's my adaptation to the
door I changes things a little bit so
that the the weight would would would
would try to make it a little more
effective but basically this little this
round block here in the center pulls up
and that pulls these two pins on the
side in which kind of releases this
locking mechanism and I'll show you this
actually in installation and a little
bit here so also one of the things I
didn't really think about when I started
this project was oh I'm going to need to
have some way of being able to tell when
the door is hit the bottom and when it's
at the top otherwise the drills you know
I want to make sure it gets down and not
not keep pulling any more than I need to
and so a simple solution with this was
just put buttons at the bottom and the
top of you know where the door is going
to hit and have those hooked up via
wires so that's kind of the physical
setup of the system but the preparation
of the BeagleBone black was seemed like
he was going to be straight forward and
actually there was some kind of floor
any things I had to deal with and there
are ways to dodge these but installing
the jvm and a line again was pretty
simple
that line again doesn't like running as
a root user and sadly the default
installation difficult ass on the
BeagleBone black only has a root user
and so you know adding a you new user is
not a big deal but you don't get
permissions on all the pins and so
there's basically the way these things
work is there's this sort of virtual
file system representation of the pin
States and you can just write to these
files to activate the pins and read from
the pins and so on but if you don't have
permissions to do that then you can't do
that so the it this is a relatively
simple fix i just i'd add some you dev
rules and stuff but it took a little
more work than i thought it would so
that's just something to kind of be
aware of in this landscape debian the
debian installation for b1 black might
not have this problem study something to
look at but um and the last kind of
thing that I did for setup well actually
did at the end but the kind of system
level stuff was setting up you know
startup startup scripts and stuff to get
this thing running when when the board
booted up so it if it crashed everything
should come back up so now it's time for
some code and uh you know I won't be I
don't have a lot of time to go into a
lot of detail but just kind of some
broad strokes or some of the things that
I set up and some of the things i'd have
thought or interesting so one of the
first things before I even started
playing with the physical sort of side
of the board that I was that was
interested in was thinking about how to
keep track of the time of day and you
know it's the sort of naive thing of
just having a thrush a single threshold
for night and day doesn't quite work
because you know these signals are a
little bit jittery and so if you just
had a single threshold for night versus
day you'd sort of get the door like
opening and shutting rapidly right as
sunrise was coming and you might hit a
chicken and that wouldn't be good so um
so yeah what I said up here is is a
little state machine that it is kind of
simple data right you know this is the
kind of very data centric approach and
you know you just keep track of a state
and you have transition functions these
two different transition functions
depending on what what the current state
is so if you know if it's day time then
you use this transition function and if
it's night time you use this transition
function to get the new state and so
this is pretty simple and
and works great and was kind of fun to
think about soap in reading and writing
there are two kinds of pins that we die
had to deal with for this project
digital i/o pins which used to turn
things on or off or read buttons that's
that type of thing binary but then also
the analog input pins which which have
yeah which have a range of values and I
wanted to abstract this it's also kind
of thinking you know that I wasn't able
to find a lot that was very general
purpose on on the internet and so I
thought it'd be fun to try to abstract
this stuff and make a library out of it
so so I went ahead and did protocols for
this because you know I wanted something
that was kind of contractual so that you
could play around with different
implementations and so I won't actually
show you the implementations because
it's basically just a bunch of file
system junk like your writing two files
and there's this whole kind of pattern
on how to do that and if you want to see
the code there'll be a link up later
here that you can check out but
basically we have a read and a right and
an initialize and a close so you can
open and close ports and read and write
from them sew buttons I this is one
thing that actually would have done just
as pure data but again I was kind of
thinking about what what my something
kind of contractual look like for a
generalized library and here I had this
issue where one of the buttons was
active when it was closed and the other
was active when it was open and so just
abstract this away i did i did a
protocol and some and some record
implementations but again i think i
would have done this actually just using
hash maps and in death multi the last
kind of component here that that was
required is the h-bridge and an h-bridge
is a special kind of circuit that you
can use to turn a motor in forward or
reverse and I should have put a picture
up here how works is it's actually not
that hard to explain but basically you
just you have four gates and if you open
two of the gates a certain way then
current goes through one way if you open
the other two gates the current goes the
other way and that's what enables you to
turn the motor forward in reverse and
and I say that there are a number of
different ways you can set this up
some of the kind of switches or relays
that you have and so so this was
actually a good a good choice for for
protocols so the control routines I
thought to dispel a simpler then it
turned out to be to get it right the
world is not perfect things don't work
sometimes you have to deal with that but
so is this sort of the night you go open
an open door routine reverse the motor
pull it up wait till the roof button is
closed then stop the motor pretty simple
closing the door just almost the same
the only difference is really that when
when it hits the bottom button you want
that little block to give just enough
time to go to lower and let those pins
slide out into the locking position so
so again pretty simple but yeah if if a
button mrs. for whatever reason because
the door gets a little slightly jammed
it doesn't press the button all the way
you can get various problems such as
drain batteries grumpy chickens and not
so hungry raccoons none of which are
good so the solution to this was to have
a retry mechanism and the basic idea
being that if it goes down it doesn't
hit its going to eventually pull back up
as the motor spins around the other way
and that's going to trigger the roof
button so we detect for that and sort of
deal with the cases cordingley half a
max number retries because we don't want
to drain the battery if things just
aren't working and so this is this is
kind of what this looks like in broad
strokes there's a bunch of setup crap
here then oh whoops my bad mmm here we
go where is it okay yeah so there's a
bunch of setup here kind of just
configuring configuring things we start
lowering the door if it closes great if
not there's all these sort of i'm not
going to go over this into too much
detail ixia and not too much time but
just give you a sense it's like the kind
of messiness of some of the edge cases
here this is what this ended up looking
like and I'll talk a little bit about
how I think this might be able to be
made cleaner future based on some of the
stuff that I'm working on but um but
that's how it stands right now so
putting all the pieces together we just
do some setup and initialize some of
these pins in buttons and the analog
input the h-bridge or the motor control
and the timer I guess we should call
that time state machine or whatever but
then we we spin off a thread that's
that's a status LED and there's somebody
in relay described earlier but it's
basically just you know controlling an
LED pin turning it on and off based on a
certain pattern and so I was I needed at
some point I realized they needed a way
of knowing whether something had gone
wrong and or even just like when the
board had finished booting up because
the program kind of takes a while to
start and so this is one way to do that
just have this separate thread running
and I'll talk about this a little bit
more later oops and then the main loop
here in this main function just kind of
spins around has the state machine
updates it based on the current light
level and that state machine actually
has the state full opened or closed or
functions in it so as this goes when
when state changes it executes those
functions so that's the system so just
to prove that this actually worked here
i'm simulating night by taking off the
light sensor and so I'm not pushing the
duration that kind of looks like it yeah
see there you guys going to and so I
your I'm pulling up to show that it's
actually locked and here's here's the
locking measurement mechanism here that
pin going off to the side holding
holding it down so you can't lift it up
and yeah here i'm putting now it's
daytime and I'm definitely not faking
this and now the daughter goes up and
yay everything works the chickens are
Joyce you're safe and I get to sleep in
so it's kind of take a step back and
just talk a little bit more generally
about hardware and closure first of all
hardware programming is really fun like
this was some of the first program that
actually did with LabVIEW back when you
know I got out of college and started
working in a lab and not I'd recommend
you use LabVIEW of your at actual coder
but but it was really fun just to be
able to kind of learn the logic of
programming and have things in the
physical world move like there's this
real joy there when you know it's not
just some test passes or something in
the repple works the way you thought it
would but like an arm moves or whatever
right like this is really it's visceral
and
something just really joyful about it so
but with respect to closure you know I
think there's a strong story here
physical systems are inherently
asynchronous and concurrent like things
happen at the same time you have to deal
with them this is one of the reasons why
people have been going to JavaScript for
a lot of this kind of Internet of Things
buzz that's been happening but I think
closure has a strong story here so also
you know high level capabilities for
dealing with complex systems obviously
you know this is something that closure
excels at another big thing data is
important in the internet of things
right like we've got all these devices
they're collecting data they're dealing
with data they're talking to each other
closure is great for this kind of stuff
and so again i think you know it's a
strong case for here and of course we
all love it so if you're going to play
with this stuff which is fun why not use
a language that you love that's
important too so some of the cons though
are that the JVM is not light and you
know closure has a long boot up time and
you need a full operating system so you
can't just run this on Arduino you have
to actually you know you have to
actually use the fermata protocol where
you're doing going over a wire and and
that's fine but but it does sort of make
it a little it had some barrier but I
think that these are solvable problems
you know boards are getting more and
more powerful they're using less and
less power and there's I've seen dad
maybe someone knows about this but I've
seen a comp a project to compile closure
to gambit scheme to see so maybe you
know down the roads native compilation
targets is another option for doing
things like Arduino but ultimately in
synchrony and currency are not going
away like these are problems which I
think in particular as your systems get
bigger are going to be more and more
yeah conducive to programming with
languages like closure so unfortunately
though there's not a lot of cohesion in
the ecosystem around doing device
programming of closure there's some
folks have done some really cool things
and we're lucky that we have Karen Meyer
here who did some really great stuff
with a drone or know where she is but
yeah awesome and peter schwartz and
narula akaya have some really great
libraries out there and horse Boris who
is also with us
was doing some really great stuff with
sensors and so is really cool stuff
happening but there's no this number a
library out there for dealing with a lot
of these things abstractly kind of a
unified a unified API and so I started
this project closure box which you can
go check out on github get over comm /
closure BOTS and we've got a chat here
to close your bot / chat on git er if
you're interested in participating or
want help setting something up or want
to contribute and I built this I set
this up as a group instead of just my
own project cuz I think this is really
something that would be great for the
community own as a whole and so I really
do encourage you to come and join us
participate it's think this is going to
be a lot of fun so some of the goals are
to have a unified API as i said to to
deal with these things to serve as an
educational resource for people who are
interested in doing hardware programming
or who already do hardware programming
but are interesting closure to have a
sort of repository for higher level
constructs or abstractions like like the
h-bridge or the buttons or more
complicated things than that even and
also to have a simulator implementation
of this of this API one of the things I
found again just because things are kind
of slow sometimes compiling him whatever
it was really helpful just to build
things on my laptop and then move them
over and hope that they would work and
then debug them but if you had a
simulator where you could control inputs
from some other process or thread and
and see how things work and visualize
them then now be really helpful in
development so this is something that um
that that I'd like to work on so the
heart of this is this library called pin
control and this is this is the
abstraction library so the idea is you
would you know program your little
programs around pin control and the only
thing you'd have to do to switch from
one device to another you know again
like hearin grant thing that you know
you have the right kind of pins and
stuff the limitations the hardware is
just change configuration specify which
pins are going to this and so on and the
a lot of the implementation here is
really inspired by cord matrix if you're
familiar with that it's a great it
brilliantly set up so that you can write
matrix algebra and change with literally
a single line of
the default kind of the implementation
of the math going on so you're not wed
to trying this one thing and then having
to switch to another being all this work
you can just write it and try out
different applications and see how the
performances and so that's that's I
stole a lot of the implementation code
here and that's that's worked out pretty
well so just go this kind of briefly
here this something is a little more
structured that I did is actually
there's something that you you reify or
you know implement this protocol pink
control implantation that tells you how
to create new board and configuration
with the configuration that board is
that you can simulate it and then you
have a red registration function which
registers that implementation under a
given keyword name and so that way when
you create a new board you pass that
keyword name it or knows to create the
right the right kind of bored yeah so
here we have the great board function we
have a pin abstraction around boards
just basically just a it might be
technically a lens or a cursor but
basically it just it sort of wraps the
board and a specific pin number and all
the functions work either on a pin or a
board and pin number and so you know we
have a bunch of sort of standard
functions like how to set the mode of
pin read the value write the value
toggle it and also some funk oh is this
a fitted yeah I guess it is anyway we
also have some some edge detection and
this is something I was talking about
earlier edge detection is really cool it
allows you to instead of having a tight
loop where you're checking the value of
a button constantly you can just get
sort of an interrupt an asynchronous
message that gets passed when when that
button press happens and so this this
again is I think something that's really
cool with closure you know we can use
channels for this and you know you can
set something up that just waits for
message on the channel and boom execute
some code when you press the button or
when it releases or when some signal
happens so this is pretty cool and I'd
also I'm thinking it might make sense to
build kind of a more streaming API for
these things but there's a lot of ideas
going on right behind its gonna change
my idea about things but kind of
frequently so are these have new ideas
kind of frequently so you know having
feedback from folks to be great but some
of the challenges or how to treat the
boards abstract the word abstraction
state because it needs to know what mode
each pin is in and that sort of thing
and the way of sort of approach this is
just to have a rapper that keeps track
of the state but I'm thinking it might
be nice to have some different kinds of
rappers based on different kind of
transactional needs or different you
know if you wanted to do this somewhat
more purely maybe you could just kind of
keep things as data and things would
sync up to the board almost like the
reactive of a beagle bone or whatever
but I'm also you know I'm also concerned
with whether or not there's the
potential for this being a leaky
abstraction in particular with the
differences between onboard programming
as in beaglebone black or raspberry pi
versus Arduino over fremada because with
with Arduino you're running over a
network and you know without having
played with it too much yet it's it's
it's hard to see where you might come
come into some weird issues with with
the inherent asynchrony of dealing with
that that that dealing with the wire and
so you know something we have to think
about but ultimately I think that this
is still still a win to to create this
abstraction layer so the current status
is that just the other night before yeah
not last night night before finished
getting kind of an initial thing that
people could look at fleshed out the pin
control library and none of the
implementations are working yet but I do
have a well except for the simulator
implementation which main beam doesn't
all work but I have at least a little
bit of it working and if we have time
maybe I'll show that to you so I
probably would have done more but this
guy that I just hired he's kind of
needing a lot of attention getting
getting up to speed so he's pretty cute
though so I think we're going to keep
him around but um yeah it's been kind of
busy so yeah please join us play with it
you know work on some implementations
build components that you know that sort
of built on top of the API contribute
documentation anything you'd want to do
to contribute
right again you know I think that
there's a lot to offer here foreclosures
and hardware it's really fun you know we
have the a synchronicity and concurrency
story and the Internet of Things is big
with data and and you know closures
powerful so these are these are all
great reasons to kind of start checking
this stuff out and like I said there's
been a lot of great stuff that's already
been happening but I think if we all
sort of pooled together our resources we
can we can be even stronger with it so
just the really quickly the future of
the coop maybe next talk will be an
Internet of chickens I want to get a
ethernet cable out there so that i can
get notifications if something goes
wrong you know autumn OOP clean up a
collection robot scratch dispenser
raccoon rat turret someone actually did
a project I think with with closure with
opencv and water gun and squirrels that
we're getting at the bird feeders so
maybe this can be adapted with the
paintball or something but also of
course live chicken cam I think we can
all agree would be pretty awesome and
yeah finally thanks to my wife Patricia
for putting up with me and and this
whole project Peter Schwartz for kind of
helping me think through some of the
things with them pin control and I might
be using some of his libraries wrapping
them for the abstract API been process
for the strange coupon because that was
awesome and cognate X for setting up the
conference obviously and for all the
great things that they've done and with
that I'd leave you with some dancing
chickens</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>