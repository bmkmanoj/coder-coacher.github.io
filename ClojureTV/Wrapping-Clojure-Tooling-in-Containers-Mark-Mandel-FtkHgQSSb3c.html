<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Wrapping Clojure Tooling in Containers - Mark Mandel | Coder Coacher - Coaching Coders</title><meta content="Wrapping Clojure Tooling in Containers - Mark Mandel - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/ClojureTV/">ClojureTV</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Wrapping Clojure Tooling in Containers - Mark Mandel</b></h2><h5 class="post__date">2015-11-17</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/FtkHgQSSb3c" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">so what you should be seeing on screen
is a title that says wrapping closure
tooling in containers or how to show up
for or what this mic okay can you hear
me just fine
good so what you should see is a type of
it says wrapping closure tooling in
containers my name is mark Mandalore
mark Mandal depending on how much of my
Australian accent comes through
sometimes I say funny words like caching
rather than caching so if I do so my
accent isn't quite as thick as Colin's
but um it comes through sometimes I am a
developer advocate for Google cloud
platform they pay me to do things like
this which is wonderful so thank you
very much for having me today
and I'm actually gonna skip slide so I
can see it and I know where our Matt but
you won't be able to see anything okay
so this'll work so to set some
expectation on what you should be seeing
today except you want so we're gonna
close your conference and that's fair
enough and we've been hearing a lot of
good stuff about closure and all that
sort of stuff today we are not gonna
actually talk too much about closure
code in fact you're gonna see very
little of it
oh you'll might see some if we get a
demo up if nothing else this is going to
be hilarious for all of you but what we
are going to talk about is two
particular things this is where you
would see images of docker and new make
so we're going to talk really about
these two particular technologies and
why I think they're really important you
want to see if displays are gonna work
okay so hands up here the people who
have worked with docker lovely okay so
some of you haven't that's fair enough
at the very least I'm going to assume
you've probably heard the name somewhere
superlight virtualization environment
spins up inside inside machines super
super fast you can do resource
constraints you can mount volumes inside
it to share hard drives and that sort of
stuff really useful things
the other thing that I'm talking about
today is make make who here is written
make files more people than I expected
okay cool so that's great so make if
you've never touched it a really
old-school build tool where you can set
up targets if anyone wrote ant back in
the day or very similar things that's
great
still nothing so we're gonna be talking
about these two technologies in regards
to how we want to use it to set up our
tooling within containers so onto my
next slide why would we want to do this
what is this actually useful so before I
get into that Oh exerci let me backtrack
for a second what why is this useful why
is it whenever I start a brand new
project regardless of what it is that
I'm doing the first two things I do is I
create a docker file and I create a make
file before I've touched anything so a
backtrack for a second I'll kind of
argue with myself why why wouldn't I
want to do this why wouldn't I want to
go through this extra complexity oh my
god we have something and the good
reason for not doing this is actually
tools like Lanigan are really good if
you want to look comparatively to other
languages if you want to switch between
say language versions in other languages
it's actually kind of tricky
propositions line again is really nice
you just change a dependency and you're
suddenly using the closure 1.6 rather
than 1.7 that's actually really sweet oh
my god yes
I have both HDMI and VGA plugs in I'm
not unplugging anything cuz for fear of
I don't know what you did but you're a
genius
okay so if I all right
brilliant oh we see stuff all right hold
on let me set this up properly and now I
actually need to boot up things but
that's fine that's all good we can do
this let's send that to five eight five
and okay perfect
can someone remind what time we finish
I've lost track of my higher brain
functions with the stress okay brilliant
so why do we want to do this why do we
want to go through this and why are you
sitting here in front of me today
watching me flamed up okay so like I
said lining is pretty cool it does a
really good job we don't need to worry
about libraries interacting with each
other accidentally the Java class path
is really nice these are all really good
things so why do we want to do this well
for me the biggest reason is it's a
really simple installation right I can
download a doc or a major build myself a
nice docker image that has all the
dependencies that I need for this
project that I'm working on regardless
of what those are I don't need to worry
about multiple steps that I need to
install all the things yeah about every
six months I go I should write some
closure script that sounds like fun and
then I go oh yeah I have to install node
I don't have to do that necessarily
anytime now I go back to a project I was
working on before and I say oh I want to
work on this project again I will just
log into my taco container which has all
the tools I has has node in it all that
sort of fun stuff and I'm ready to go I
can continue working from there it's got
the version of lying again on it that I
want the version of Java I want on it
which is actually much trickier to
change
it's pretty awesome the other thing that
makes this really nice is this docker
image is shareable all right I can take
that docker image that I have for this
project I can share it with multiple
people in my team they don't need to go
through 14 different steps to set
anything up it's all there I'm ready to
go maybe you're working on something
would say ffmpeg or maybe image magic
they don't need to worry about what
version of that they're running any of
that sort of cool stuff
and when I say team I also mean your
local team but this could be open source
contributing teams as well you know you
want to have a a standard build
environment that runs all your tests
without them having to go through four
steps to install all the things this is
actually kind of cool finally you know
we're functional programmers so things
that are immutable are good darker
environments and of themselves are
relatively immutable we can control what
part of those change we can mount a
volume into them and say that's where
our source code lives and that's the bit
that changes but all the other stuff
around it that stuff stays relatively
the same which provides us with a nice
environment where we have a little less
of oh that works for me but it doesn't
work for me because I'm running maybe a
slightly older slightly newer version of
something else we have to makes it much
easier to coordinate a lot of stuff so
since I have a screen who would like to
see a demo alright so we're gonna have
to do this from scratch because I
haven't actually just anything up so let
me wear a control shift make that a
little bigger and just in that 2 5
that's better okay so we'll do this over
my shoulder which is fine okay so here
we have my local machine I don't have
line again installed and if I have a
look I have Java 1.7 because reasons so
what I want to do is I want to come into
a shell where I have line again
installed and I have Java 8 installed so
let's do that let's go to make shell
make it quiet because I don't want to
show off my secret sauce just yet I'll
hit enter and that should spin my docker
container brilliant cool that should be
fun and now if I have a look at my Java
version I'm now running Java version 1.0
so that's kind of cool I also have
access to line again so let's actually
create a whole new app let's bring that
back up to the top we'll create
ourselves a composer app okay hello
world and we're gonna do it in this
local directory because I've got it all
set up and ready to go if we have a look
right now let me hold on let me create a
new thing if I go back to my hosts have
a look I've got some setup there let's
run that
that should take a second or so and then
once it's done we have a look I've got a
whole compression project I can have a
look at Mike up there if I come back to
my host that's also there as well so
I've gone from having the wrong Java
version that what I actually want not
having line again at all to suddenly
having all my tools available and ready
to go for this project without having to
install anything locally which is kind
of cool if we want to actually we can
run this - so let's go line where are we
line ringing is server headless that
should fire up in a sec thank you and we
come back to host now darker will if
you're not familiar we'll take those
local ports that we've got and forward
them on to other ports I will I actually
make a nice little make thing that those
dots that sent it to the wrong one do
there we go and so we have hello world
and it works great okay let's move
forward because we have limited time and
I have so many cool things to show okay
so how do we actually do this right so
that was kind of cool that was neat
lovely how does that actually work so
the first thing that you do is you
create a docker file I'm gonna guess min
many people here have written dr.
Powell's mostly all of you okay cool so
we'll work walk through it this is
generally what you sort of start with
it's a sort of how it would work so that
from line across the top is what you
normally do is like that's your base
image that's where you build from right
and we're basically gonna say give me
the standard Java JDK give me that and
I'm gonna build from there and add some
stuff on top from there I'm going to
install line again pretty much as you
would do normally the interesting thing
to note here is we need an environment
called line root equals one
docker when it's installing everything
does everything by root line again tends
to complain at you if you do things by
root so if you don't set that
environment variable it will say no I
will not do that we've run it this is
important because when you first run
line it downloads a bunch of stuff for
you and we'd like that inside our
container rather than have it run every
time I have a convention of everything I
write tends to run in a slash project
and I set an environment variable down
the bottom of port so that my composure
app knows which port I want to run it to
and we're able to build a docker image
from this docker build and it creates an
image and we can do stuff with it
so that works pretty well what I then do
is I create this make shell target I
like make as well especially because it
outputs exactly what it runs super easy
to debug so this is basically just runs
the image there's a few cute things in
here worth noting - V is a
volume mount so basically says I'm gonna
take what's local to my machine and I'm
gonna push it into the container
important ones to note there we're
volume mounting m2 which is our maven
repository we don't want to keep
downloading the internet every single
time we want to install something so
that's good
I've actually also got a profile stats
elj for my user profile for line again I
mount that in as well so I can change
that locally and each project can have
its own user profile coj which is kind
of nice as well again we could do that a
slightly different way but this is kind
of nice that current path variable you
see there is something I've set up in my
make file this is all on github so you
can see how it all works
I tell it - IT to make it interactive
terminal and I tell it to run zsh inside
my shell because zsh is awesome
this is pretty good so for those of you
who run OS X which is probably most of
you this probably gets you 99% of the
way there for people like me where you
will have to pry my Linux out of my cold
dead hands you'll run into some small
issues here and I just want to cover
those really quickly the issue you run
into here is that docker by default or
docker runs as root on your host system
as well as deep by default runs as root
inside the container we can debate
whether that's a good idea security wise
later but that means that anything that
docker really touches means it's owned
by root this can be kind of frustrating
when you're writing code say you do a
line new composure and then suddenly all
your source files are owned by root and
that's not so much fun because you have
to see a Jeremy if you think all the
time then it's awesome
okay so how do we solve that problem I
will give you one solution very quickly
I'm gonna kind of skip through it
because of time there's a variety ways
of solving this the way I like to solve
this is rather than immediately firing
up zsh I create myself a nice startup
script and I fire that off itself
instead what I then do within that
startup script is I basically make a
whole new user that mimics my user on my
host exactly
if anyone's played with Linux
permissions your user name and your
group have a unique ID behind them as
long as those unique IDs line up
everything is golden and thinks they're
all the same so we do exactly that
I will show you how to create these
environment variables and
but I create a group and a user with
exactly the same IDs I can do some extra
work here because we're actually going
to be working as the same user as we
have on the host so I copy on my mold
aligning and stuff we downloaded
previously into the right spot icho unit
so it's all good and Sue switches users
from what was route into a actual user
that we're set up this is also a little
bit more secure which is nice
not that were worried too much about
local development for that we add the
startup type SH there's an add line
inside our docker file so when we build
it that's included and then we run it we
change things just a little bit so that
you can see - e those are our
environment variables those passed
through the unique IDs for group and
user we now mount the m2 directory
slightly differently but everything else
stays relatively the same other than we
run startup does SH so great now we've
solved our permission issues that's
awesome we can continue on our merry way
we can also attach shells I just want to
bring this up real quick
I went demo it because of time you saw
me bring up a single terminal and if you
saw that I was being I had something
running in there I can actually go to
another terminal and say oh I want
another terminal here and I can continue
on my merry way docker exec is a really
handy tool that basically says in a
running container I'd like you to run
this please so in this case we're saying
in the running container please run
another version of zsh under my user and
it just creates a whole new whole new
one okay so I finished at is it 40 past
nobody knows somebody's gonna know
crowdsource this thing 45 so I got 10
minutes all right cool let's run through
this real quick because this is the cool
stuff this is very good fun all right so
we've got us we've got a shell that's
awesome I really like it but this is
where we hit a bit of an interesting
roadblock which is we need tooling like
we need to go to edit our code and
suddenly we've shifted all that stuff
off our local machine into a container
what do we do then so we have a couple
of interesting options here and I want
to go through a couple of them the first
one is stick your editor inside your
container that works it's actually kind
of cool because it means then you can
have a stand-in config that lives inside
a container it
be project specific - which is kind of
interesting and then again that's
shareable you can hand it around so
let's do that - yes brilliant
so let's come back to my show will
cancel back because we don't really care
um and we could just say Emacs oops I
can't spell over my shoulder
Emacs project does eject okay so we have
you max that's boring so let's kill that
because gooeys are way better than good
ways a way better than running it inside
a terminal because then I can have now
support in a bunch of other stuff so
let's do that instead so let's do that
let's go over here and I have a make
command strangely enough called make
Emacs and what's it gonna do is I am
gonna tell it to connect to my container
via SSH and fire up Emacs please there
we go that's a little small but now we
have Emacs and I'm gonna do this over my
shoulder because I don't not in Emacs
guy so I don't know any of the shortcut
keys
there we go project and pick a file I
can't see it it'll say anyone doesn't
matter
yeah look nope
and it doesn't to do it okay we'll
ignore that we'll pretend like it worked
because the demo gods are not with me
today but that's okay so we have a GUI
running from inside a container now you
may have seen some other demos where
people run gooeys inside containers but
I will tell you that this will work
cross-platform when it works apparently
so anyone heard of this tool Wow
a few people way more than I thought
okay so this is really interesting and
this is something I started playing with
her and I started saying okay can we
really run a GUI inside a container I've
played with a whole bunch of different
ways of doing this because I went way
down the docker rabbit hole
and while expert can be a little bit
finicky and I'm running a bit of an old
build of this because reasons which it
hopefully should fix the bug we saw
there it's really interesting so who
here uses like screening or Tmax lots of
people right so the nice thing about
screen dirty marks right is it runs with
the server you can run things inside it
and if you disconnect from that session
you can then reconnect which is really
cool and those things are still running
extra is that for x11 applications over
a socket which is pretty slick so it can
run over SSH you can run over directly
over a socket but the other cool thing
is it runs on Linux it runs on Windows
and it runs on OSX so yes it is a little
bit finicky but if you want to be able
to run GUI applications inside a
container I find this is actually a
reasonably reliable way of doing it and
it's kind of cool sort of looks like
that extra start starts a little session
inside the inside the container the cute
thing in here is to note I would say is
exit with children says that any running
processes that are running inside that
extra session then kill them if
everything does so in this case we shut
down Emacs the whole thing shuts down
doesn't leave it hanging around the
other nice thing is that has a variety
of encoding format so you can use I've
said it to PNG because I found that
worked best with text it's got some ones
that are more like sort of what is it
vp9 or vm9 there were more video based
codecs they kind of get blurry when you
scroll
I find that works pretty well okay five
minutes
perfect we have just enough time for
this crazy stuff so this is all well and
good when you run your can your editor
inside a container but I'm not an Amex
guy I'm an intelligent guy I love
cursive I think it's amazing thank you :
and I don't want to run it inside my
container because I don't know reasons
maybe I could maybe it doesn't work very
well I actually haven't tried it yet I
probably should at some point but this
is a nifty trick that I worked out works
really well especially on Linux I'll be
interested to know if it works on OSX
because the way darker machine works but
what I want to be able to do is take the
Java version that I have inside my
container and any other resources I want
and be able to basically pick them up
and put them outside my container all
right volume mounts don't work here
inside docker for this because volume
mounts only go from host to inside the
container so the way we can do this is
actually through sshfs so if you don't
know what that is it's a fuse mount that
lets me basically mount anything I want
that I can connect to via SSH which is
really really powerful so how does that
work so I can recreate myself a little I
have a make target strangely enough that
runs sshfs and goes and points itself at
the directory that hosts the JVM inside
my container and I decide to mount it
nicely somewhere inside my temp
directory and it's works really well the
only really cute thing I found here is
that I need to write - with full of
siblings reason being that the SDK has a
bunch of similar links in it and unless
you tell it to follow them they point to
completely the wrong places if you do
that then they point to the right places
and everything works really really well
so let's have a look at that and I'm
actually gonna have to fire up IntelliJ
because I think that's the right command
yes because I haven't got it burned
before
they have three minutes for me to show
you a ripple using a JDK that runs
inside my container oh and this is gonna
be hilarious to hear mashallah
okay which case I will do that mistake
lovely okay let's switch into
presentation mode so you can see what's
going on okay
so the first thing we'll need I've got
this project already set up it's ready
to go I need an SDK so let's actually do
that if we go into our project structure
if you're familiar with it all I had one
before it's dead so let's create a new
on hold create a new JDK will go into
temp oh I need to mount it my bad
pink mount cool safe password that's
better
there we go no it's mounted JVM job
right all right cool okay
it seems pretty happy so that's good
let's hit okay let's fire up line my
line we know there are no line of good
projects
yeah eyes are not seeing my line project
that let's add the project all stuff I
would have done beforehand okay so this
is gonna index it'll take a little bit
while it's going lovely done right click
run rebel this is where the magic
happens spinning spinning spinning okay
so if you can see that top line there
you can see the JVM that's being used is
actually Java right all right that's not
my local Java 7 that's running from
inside my container and it works
perfectly if I have my handler
yeah let's drink thank you let's load
that and switched its namespace normally
I spin things up but I'm not gonna do
that here and I run it then I can
actually see that my apps there and I
can do stuff normally what I do here is
I actually spin up I install a LF and
then I spin up the actual server and run
the code and edit it and do that stuff
but you can you can trust that it works
okay so very quickly in conclusion
because I know we need to finish up okay
so what we did here very very quickly in
a much shorter time that I wanted to we
were able to containerize all the
developer tools that we had for this
project that I set up here and we were
able to go from an environment where we
didn't have Lonnegan installed we didn't
have the Java version we want install we
could download an image or install an
image and we could get up and running
pretty quickly we could also install
either editors inside our container or
we can have editors outside our
container depending on your environment
what you're doing and this is something
we can share around with either a team
that's local a team that's remote a team
it's open source we can actually do some
really cool things finally very quickly
just like to thank my employer Google
and Google cloud platform they pay me to
come out and do fun stuff like this and
hang out with all you awesome people if
you want to reach out to me a compound
Theory comm please feel free I'm more
than happy to take any questions on any
of this stuff all this source code is up
on github as well there is the URL up
there once more I will be here for the
rest the conference and thank you once
again to the conference for putting on
this event and putting up with my
machine that didn't want to work in the
time that was allotted I open up the
floor to absolutely no questions because
we don't have time but I will hang
around and I will be just outside the
door if you want to ask me anything
thank you very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>