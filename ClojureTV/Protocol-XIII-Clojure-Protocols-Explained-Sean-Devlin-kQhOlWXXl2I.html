<!DOCTYPE html><html lang="en"><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-114897551-4"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114897551-4');
</script><script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5ac2443d1fff98001395ab6c&amp;product=sticky-share-buttons" async="async"></script><title>Protocol XIII: Clojure Protocols Explained - Sean Devlin | Coder Coacher - Coaching Coders</title><meta content="Protocol XIII: Clojure Protocols Explained - Sean Devlin - All technical stuff in one place" name="description"><meta name="keywords" content="education, coding, programming, technology, nodejs, mongodb, software, computer science, engineering, teaching, coaching, coder, learning, java, kotlin, machine learning, AI, ML, tech talks, angular, javascript, js, typescript"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/bootstrap.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/coder-coacher.css"></head><body><div class="container-fluid"><h1 class="site-title"><a href="/">Coder Coacher</a></h1><hr><h4 class="site-subtitle text-right">Coaching Coders</h4></div><div id="amzn-assoc-ad-99d6751e-2392-4004-ad16-73aa8385d9d0"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=99d6751e-2392-4004-ad16-73aa8385d9d0"></script><div class="post__breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">Coder Coacher</a></li><li><a href="/ClojureTV/">ClojureTV</a></li><li class="active">â¤µ</li></ol></div></div><h2 class="post__title"><b>Protocol XIII: Clojure Protocols Explained - Sean Devlin</b></h2><h5 class="post__date">2012-12-16</h5><div class="container"><div class="video-responsive"><iframe width="560" height="315" src="https://www.youtube.com/embed/kQhOlWXXl2I" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div><div class="post__text">good afternoon everybody all right it's
after lunch thank you it's after lunch
is around two o'clock digestion is
kicking in we're all starting to fall
asleep so we're going to start some
audience participation so real quick
learn a thing or two about my audience
right now so if anybody here has played
through a final fantasy game sit down I
don't all right anybody here play diablo
2 huh Dungeons and Dragons fans anybody
whoa yes all right okay to medicine
anything else some popular ones are okay
yeah stratego Stratego all right there
we go so okay la tuya the basis for that
so he does it's addressed you can
actually now make you stand for the next
40 minutes if I gotta stand you gotta
stand so now feel free to sit down thank
you all for playing along alright so
starting off with explaining protocols
and what the heck why am I using a video
game analogy here any of you played any
of these games you're very familiar with
a job system sometimes you want to place
a theme sometimes you want to place a
mage or a warrior all right and it's
this kind of abstract idea that oh I'm a
thief that's what I do I steal things
but your individual character thieves
very differently than somebody else's
thief or your mage is very different
than somebody else's mage you know it is
a very customizable individual
experience but you still refer to this
abstractly as the same thing so the
general idea here with protocols is
we've got this abstract thing we want to
talk about you know it's but a different
implementations each time you know so
you want to think of straggly because I
don't know about you guys I can only if
it's so many ideas in my head at once
you know that's not that much room and
once I hit that I'm done so
more abstract that can be the more stuff
I can think about effectively and
simultaneously when I'm dealing with a
specific implementation I have time to
get it right you know I'm thinking about
okay how do I solve this particular
problem at this particular time test it
make sure it's good and once I figure it
out I don't want to think about it ever
again ever because like I said I'm lazy
alright so one thing we're all used to
is closer developers is brings a lot of
abstractions to the table for us already
who here revolutionized how they program
once I got to bring around the Sikh
abstraction in a Sikh abstraction
changed our program all right so rich
thank you for the Sikh abstraction all
right and when I first started working
with closure said okay seek it's an
interface and everything implements the
interface so I started saying oh it's
just an interface than that you know I
found out on the mailing list no no it's
it's not an interface that's the wrong
way to think about it there's any of
things that seek will work on that don't
implement the sea cabool interface so we
got this abstract function seek that
turns all these things you can think
about as a sequence into but aren't
sequences into a lazy seek and we all
love that you know for example string
right so straight you can call seek on
and you can do sequin sequence like
stuff but the implementation of string
is final so what this lets us do is
define our way we want to abstract stuff
without relying too much on excuse me we
can define our way of extracting stuff
where son has said nope I'm not going to
let you add anymore so it's a way to get
around some of the limitations somebody
else might put on your coat all right
you know one of the first things I
noticed once I started doing this is a
conducive multi methods and they were
too slow all right and
going with us oh yes okay so start
playing with dates because anybody here
who's worked with the job of dates in
Java man is this painful all right the
worst abstractions in there without a
doubt and you know it's just none of it
plays nice with each other and
constructors are a pain in the ass
there's no real reason about kingdom of
nouns your date systems in Java our
kingdom announced furthermore to make it
worse you're always trying to get dates
to work with other people's stuff you
know and that's a pain but anybody's you
know roll with java so you're used to
giant erp vendors saying this is what i
call a date and it almost works like a
date but not quite you know you got to
figure how to put it together so one of
the first episodes i did some of you can
see it seemed part of this before is you
know about how to write a multi-method
to work on these different date types
and in order to make it in a centralized
the abstraction so we write our date
code once and it just kind of works
everywhere so all right get more
audience participation what type of
stuff is dateable in java you know what
are things you want to extend date on
anybody timestamp okay but no you're
getting other stuff loud another one sub
sighs timestamp calendar good what type
of calendar
all of that exactly what else do we need
to treat it as some kind of dateable a
date time what was that Joe two-time
along should be datable okay happy
nobody said strength thank you I would
fix it updatable the Cooper net at the
private repair shop no okay all right
anyway so we always think they're data
but we want to have date work on it but
a lot of them are closed like strings
closed dates close timestamps closed
it's a royal pain in the butt all right
now fortunately we kind of could if we
had to figure how to turn each one of
these into alone we're going to pick
along because it's easiest one to
demonstrate not quite correct one if
you're going to design a library around
it but a lot easier to demonstrate all
right so we're good to find this
abstraction dateable all right we're
gonna get the two milliseconds method so
that's what gives us along yes sorta
front larger ok awesome 20 it's not
large enough apparently all right doot
is that no not that one all right we're
going to go for a 24
alright so what finally it's protocol
dateable because we want this method two
milliseconds and we just wanted to kind
of work you know the same we seek just
kind of works and we don't want to think
about it once we get it working so we're
going to start like okay if I want to
turn something into how do i turn a
given object into a log alright the lung
since 1970 all right so going to start
with given a number which it's an
abstract class so first thing else we
can extend a protocol on an abstract
class so it gets us all numbers so
that's good for extending dateable right
here and so just gonna have to be the
identity pass through so you know bag
I'm getting along or getting an int okay
we're good to go so that's easy enough
the next one we're going to look at here
is date alright so dates got this nice
little one get time alright so you read
through the javadocs get time returns
the number of milliseconds since 1970 so
similar we're going through and just for
unit just this dispatch how we want it
to work on each one and now we look at a
calendar alright due to the wonderful
wonderful way the Java API is designed
get time on a calendar returns a date
object alright so yeah so this is a
perfect example anybody here a Python
guy or a ruby guy or thin at one point
okay so a Python you've got the under
other method under under convention this
wouldn't work alright this would be
exactly how you would break under other
method alright so it works most of the
time but you get collisions once in a
while and it's a royal pain so what
we're doing here then is recursively
calling our protocol in order to get
around that because we know returning a
date and say AHA once I know I have
how to turn that back into milliseconds
so a lot of this is we're going to be
used the recursion to do the work for us
again because we're lazy all right here
we got sequel timestamp we're extending
it on bit of trivia this is not really
required because timestamp doesn't hear
it from dates all right but here we can
have it anyway all right and we're
extending it on nil so if it's nils pass
we're just going to return nil so it's a
good way to defined behavior across the
board all right and date time this is
the Jota version of date time so for
those who haven't used that jota is an
amazing amazing time library it just
kind of does everything right for you
here we've got string where we're
parsing it so these are creating a
broader and broader method so it
different ways of talking about string
and time this make more sense admit it
when I show you a little demo all right
again vectors and maps all sorts of
different ways of talking about time
because you never really know what
you're going to expect all right but you
know it is a time construct and just
kind of want to think about it that way
hey we could probably do this a bit
better and make that associative but
well as cross that bridge when we get to
it all right so we have all these
protocols to find so that if we have to
do here a collection of heterogeneous
date types all right you can see we got
our string we got our choda type or map
are you today and we have a long so all
of this same data structure as being
passed in and what we're going to want
to do is treat these heterogeneous you
no items in this vector homogeneous Lee
and again we want to think once and then
that our abstraction do the work for us
all right so
evaluating the sky over here you can see
yep dates are different alright so we're
start just demonstrating calling the
protocol still good okay yeah alright so
a simple map all right
and of course so as you can see it just
kind of mapped everything too long for
us so it's nice heterogeneous simple map
operation all right not really much
thinking about it I will calling the
protocol just like a normal function so
again you know once it's written you
really don't think about it you just
treat it like a normal function from as
to consume it but under the hood it's
doing all this dispatch stuff for us all
right so we got the dispatch going and
it's mapping just fine so then what you
do is to take this abstraction as
developers what we do we build on top of
the abstractions all right so we're
going to do a couple we're going to in a
long time which is very similar just
it's renaming the protocol right there I
like having this wrapper just because
you know I like doing this is personal
style thing like you know defining a
protocol once with a singularity and
then with the multiple arity stuff be
handled specifically you know probably
other ways I could do that but just in a
quick demo gelati is here this way so
here we've got this one that converts a
long time in anything too long so again
long so just work simple wrapper and now
we got this other one dates so
converting it to a bunch of date objects
all right so this way whatever comes in
it spits out a date so it takes a whole
lot of different styles or input and
provides a known type for an output all
right so this is really nice when you
want to interact with child ja the land
and make your java libraries a lot nicer
because whoever gave you the java
library is expecting a very specific
instance of their class and they didn't
think of the 20 different ways you could
represent that
nation they thought about their class
you know and for various reasons so what
you got to do is you got to get somebody
else that you know all this data into
somebody else's class and Marshall it
there somehow you know there's an amine
how many people here have spent days
writing glue code to get you know Class
A in the class bit is that yes yes what
would you call this reg the expression
problem yes the okay the expression
problem yeah it's so getting vendors to
play nice with each other like SI p to
play nice with oracle you know or
something like that yeah so many other
tears tried so so similarly we can do
the right ones for Jota a Gregorian
calendar to sequel so these all take
very broad inputs and spit out very
specific output it's like for example
you can write no RM later all right that
just has this to sequel method anywhere
our time should go so that way you could
provide in 20 different implementations
to it and your RM is just going to do
the work for you all right and we get
down here similar map you guys have seen
all this type of stuff before alright so
this is all your stuff to walk around
the type system and make the type system
super flexible into the casting for you
like so what does guess really cool is
when you start consuming this stuff
alright so we're going to write a
compare method or functions gives me
compare time all right and it's just we
would compare two implementations so we
got our heterogeneous implementation up
here we want to sort it so we're gonna
all right screwin
and
Oh
what'd I do wrong thank you so see when
I make the videos i get to edit all this
out so here you see all this stuff this
heterogeneous list we just sorted it and
we got our hair genius list back alright
so we got our one comparator we're using
the built-in sort and you know to work
on a sequence so we're really not
amaizing the amount of use of built-ins
we're doing in minimizing the amount of
custom code we have to write because we
these centralized abstractions that make
our life easier all right so so we can
define all these other functions earlier
later is it within a range are these
dates overlapping you know so obviously
you know days earlier than they'd be
something you'd use a lot given lots of
different implementations one thing that
gets start to fund it starts to get fun
is when you have custom predicates
because you know once you get into your
specific app there are all sorts of
different custom predicates that you're
interested in for example is it during
the cottage all right so during the cons
will just sense it's built on top of all
this stuff will just work so we get a
filter during cons do
and I did something huh thank you see
bodies participation so okay we got one
of these it's going on during the conch
awesome alright any of these going on
during my talk and serious during my
debts huh yeah whatever all right names
now should I move the namespace did this
earlier insane anyway all right you know
should I be working all right the
question is given a certain time should
I be working and what this lets us do
now is we can mix and match different
representations of time depending on the
use of it you know depending on what the
job needs to happen so if the day of the
week is one through five that's how
jodha would represent during the week
Monday through Friday so we just say is
the Java time here version for that
because Jonah works really well and down
here we're going to use the map version
because it's really easy to get at the
hour this way and you know we can
compose everything nice and easy we can
combine these two different
representations for time in the same
predicate so you know use the right tool
for the job to make it a lot easier to
read a lot easier to get your head
around and is it my birthday that be the
other one not be interested in so that's
one example of protocol using it for
dates in order to kind of make it easier
to think about and say in order to get
to the right type for the job here we're
using a lot of note planning as well so
any questions on the date stuff because
i have another protocol i'm going to use
switch gears on your real quick once
twice to
alright so that's one protocol with the
dates all right got another one I use a
fair bit because we all use sequence
stuff all the time right so again we
used to the sequence abstraction and
it's nice it returns a sequence but
every once in a while you don't want it
to return a sequence you kind of wish it
turn the original type most noticeably
we and you're working with a map
and here we get a list of keys but you
know a lot of times you know we'd have
to do this and turn it back into a map
like if you're doing a man you know how
often do you have to map over a map at
least I have to do that a lot and it
returns back a sequence and it's like
okay this is good it works but I have to
have this extra step now free Martian we
get back to a map and it's just tedious
to put this in over and over again so
you know it's what you'll see a lot is
something like this right ease into a
lot and an empty version so and that is
okay great so you'll see this pattern on
into my empty sequence some sequence
operation the original sequence as a
pattern that kind of shows up again and
again so I work in upset themself okay
how do we abstract this in order to make
it all work easily you know so started
working on a particular protocol for
function i call it same the ideas that
returns the same type so let me show you
how it gets consumed here so what we do
is you know the pattern is ok so you've
got f of some sequel and then you want
an empty version of that and you want to
into that so this is kind of the pattern
that shows up again and again and again
all right so you know what it let you do
is something like this
so it's just a simple higher-order
function that you can do in order to
snag it all the sequence stuff you're
used to so you don't have to think about
writing you know a map utils for you
know string utils I mean granted there
are trade-offs to doing it this way but
you know just kind of works that do it
weren't that didn't work what I drop huh
oh yeah thank you thank you but okay so
you know this way you just get all the
set of functionality for free you still
think and sequence thoughts like we're
all used to you know but here we're
going to let the protocol and do the
work for us all right because part of
the problem it's not really problem I
guess it's a feature is that the each
one of these will conch differently you
know we like vectors kanji the way they
do unless konchem the way they do etc
etc and that's good most of the time but
when you want to get you know same
representation back like with string you
know when you want string and string out
you don't want things unintentionally
reversed so what you got to do is you
know custom say okay I'm a slightly
different version into or I'm a slightly
different version of empty actually we
string it doesn't even implement these
two you know you gotta I don't think so
anyway so you kind of put your own stuff
on there crafting it so this way you
know your stray will into one way you're
lazy seek we'll do it another way you
know persistent listen all that in us
sometimes they get reversed you just
don't let that happen so you put the
protocol up here in this way everything
all the heavy lifting is done in the
protocol you know one which one does it
one data type at a time and you focus on
getting your persistent lists right you
focus on getting your empty list right
etc and once you get each one right you
can extend it another thing you can do
is
your own implementations for this so you
know sometimes I find I need the keyword
utils basically or a symbol from you
till something behaves just like string
only with key words and symbols so what
you can do then is extend your protocol
just like you can yeah let's just like a
multi-method that's right so you put
your own custom extension here so okay
so we're going to make it possible to
work on a keyword or symbol dirt Oh
so it works on a symbol so if we did
so you keyword utils or simply entails
and so you don't have to maintain
anything you just get what the protocol
do the work so that Charlie's just use a
protocol whenever you want homogeneous
behavior over heterogeneous types you
know so yeah this is kind of the main
theme you prove you mention it a dozen
times because that's the one thing I
want you to take away from this so any
questions so far my loosen up yes okay
extend vs roy fi extend is when you want
to do it on every type and right faiz
when you want to do it anonymously
similar to the proxy you dudes proxy to
create an anonymous version of an
abstract class or an interface so right
if I would use for anonymous one as well
so anybody else yeah no no it's not not
at this point now
right
absolutely not today nabol you can there
are wrong ideas you don't extend
protocols on a protocol used in
protocols on a type so you know protocol
so it's similar to Java interfaces and
this is the most abstract way we want to
think about it and you know somebody
correct me if I screwed up royally but
yes this is most abstract way you want
to do about it you're thinking about a
verb where's when you're extending your
saying this is how i do this verb for
that noun so yeah
right yeah right because one thing you
want to do and I forgot to point the app
point this out in order to get default
behavior too yeah you'll see right here
I extended on object so good
that question you get
right
right
right
so on an object you're saying try okay
if it you know we've got your birthdate
and galactic data all right so we want
to extend on galactic there we go Star
Trek premiered oh so you want extend on
stardate some you know so I guess an
object you say okay if the input extents
stardate use my convert start a function
ok
then what you would do is you'd have a
factory function or something that wraps
that get an independent function so you
know you got this independent convert
function that's your you know that's the
one function to rule them all alright
and if first tries ok can i convert it
using a dateable if this works great if
it doesn't work move on to the next one
so this way you wouldn't extend it on
the protocols per say this would belong
in your one function to rule them all
yes I msi sony you can't think of
protocols as an object that's one thing
that's hardest need to get around a
little bit it sounds like you're
suggesting and maybe i'm misinterpreting
it
and
yeah no I don't think so I mean I can't
quite explain it yet can you help me
with the disconnected
yeah okay so you would use the side of
the satisfies method to see if the pro
the object extends the protocol for the
other protocol great
okay yeah okay well you into coming I
think I think I see we're talking about
is
other protocol
right for me right that's the general
flood right so this would be not out of
its 10th no maybe okay this is why you
don't code we're doing presentations
alright so you should bet it satisfies
it that means we know what to do right
if I know what to do just do what I know
how to do what did but this is the way I
want to do it all right yes hand the fur
and now you've lost me
ok
I think it only happened one way that I
think sutures
yeah yeah see if it means that think the
question is what's the real use case
this shows up animal isn't designed in
up front I mean either that or it's like
you know you consider so you're
consuming the other guys library take a
couple minutes to read his stocks read
through his code and I just figure out
which you know what you're going to play
either because what's going to happen is
you know I don't really care about
what's extended why care about this is
why I don't think this is gonna happen
in practice very much all right and it
could be totally wrong on this I'm
interested in a set of functions like
earlier and compared to all right you
know you've got the protocol so you can
use a common set of behavior and you
know you want compare time to work a
certain way and you're just used to
think I want to use this you know
version of Chronos compare time and this
version of earlier and later so I'm
interested in using this library so
that's what you're really getting out of
this so you want you know you're going
to centralize on one of the libraries so
there might be a little bit of overhead
with setting up a few converters to you
know what the Galactic time work with my
time but I'm interested in my time
because it's my library and I'm
consuming my library so that's where i
think you know hunt
absolutely right right and then once you
get these broad functions set up you
know like okay I took a deliberate
approach with this and so I'm designing
this library to do to provide a few key
predicates and a few key iterators and
then I made the decision you know what
I'm going to let this closure sequence
library do the rest of the work for me
yeah that was the decision I made
somebody else might want to say no no no
I want a really heavy weight built-in
you know iterators and adding else and
they want something really happy like
they want their own sort you know like
they want a short time function you know
sighs someone I think you'd run into in
practice as people decide they want
different levels of functionality so
look it's important to notice too is
that the extension for all these this
namespace qualified so here you know
we've extended everything on keyword and
symbol in demo we go to demo demo 2 and
a 1 minutes all right so
you'll notice here what did I do ok we
just throw an a in front of everything
here so you just put the a in front you
see a different behavior in different
namespaces let's get a big thing out of
the silver multi methods so that
performance so I think I got one minute
I'm going to get out of here before I
get into too much more trouble so thank
you all very much</div></div><div class="container-fluid bottom-ad"><div id="amzn-assoc-ad-6a809dda-347a-4187-8a86-91faf94575da"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=6a809dda-347a-4187-8a86-91faf94575da"></script></div><div class="text-center">We are a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for us to earn fees by linking to Amazon.com and affiliated sites.</div><script>(function(w, d){
    var b = d.getElementsByTagName('body')[0];
    var s = d.createElement("script"); s.async = true;
    var v = !("IntersectionObserver" in w) ? "8.6.0" : "10.4.2";
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/" + v + "/lazyload.min.js";
    w.lazyLoadOptions = {};
    b.appendChild(s);
}(window, document));</script></body></html>